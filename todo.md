# HEYS MVP ‚Äî –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏

> –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2025-01-03

---

## ‚úÖ –¢—Ä–∏–∞–ª-–º–∞—à–∏–Ω–∞ ‚Äî –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï

### üé´ Backend (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ 2025-12-26/27)

- [x] –¢–∞–±–ª–∏—Ü–∞ `subscriptions` (client_id, status computed, trial_started_at,
      trial_ends_at, active_until)
- [x] –¢–∞–±–ª–∏—Ü–∞ `client_sessions` (session_token, client_id, expires_at)
- [x] RPC: `get_subscription_status_by_session(token)` ‚Äî —Å—Ç–∞—Ç—É—Å –ø–æ —Å–µ—Å—Å–∏–∏
- [x] RPC: `start_trial_by_session(token, days)` ‚Äî —Å—Ç–∞—Ä—Ç —Ç—Ä–∏–∞–ª–∞ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
- [x] RPC: `subscription_can_write(client_id)` ‚Äî write guard –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [x] Write guard –Ω–∞ `save_client_kv`, `upsert_client_kv`,
      `batch_upsert_client_kv`, `delete_client_kv`
- [x] Trial Queue: `get_public_trial_capacity`, `request_trial`,
      `claim_trial_offer`
- [x] GRANT –¥–ª—è heys_rpc —Ä–æ–ª–∏
- [x] **KV Session Functions Fixed** (Bug #6, 2025-12-27):
  - [x] TYPE_HINTS `::jsonb` –¥–ª—è JSONB –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - [x] JSON.stringify() –¥–ª—è pg driver JSONB
  - [x] –ö–æ–ª–æ–Ω–∫–∏ `k`/`v` –≤–º–µ—Å—Ç–æ `key`/`value` –≤ 4 —Ñ—É–Ω–∫—Ü–∏—è—Ö
  - [x] PRIMARY KEY `(client_id, k)` –≤–º–µ—Å—Ç–æ `(user_id, client_id, k)`
- [x] **Auth Bugfixes** (Bug #7-8, 2025-01-03):
  - [x] Curator login 500 ‚Üí `on_conflict: 'client_id,k'` (–±—ã–ª
        'user_id,client_id,k')
  - [x] PIN auth infinite loop ‚Üí session_token preservation + retry guard
  - [x] Database migration: `client_kv_store` PK —Ç–µ–ø–µ—Ä—å `(client_id, k)`

### üñ•Ô∏è Frontend (–≥–æ—Ç–æ–≤, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω)

- [x] `heys_subscription_v1.js` ‚Äî `HEYS.Subscription` (getStatus, startTrial,
      useSubscription)
- [x] `heys_paywall_v1.js` ‚Äî `HEYS.Paywall` (ReadOnlyBanner, showPaywall,
      canWriteSync)
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `heys_morning_checkin_v1.js` ‚Äî –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Ç—Ä–∏–∞–ª–∞ –ø—Ä–∏
      —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `heys_day_v12.js` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ add water/meal/product

### üß™ E2E Tests (–≤—Å–µ –ø—Ä–æ–π–¥–µ–Ω—ã)

```bash
‚úÖ verify_client_pin_v3 ‚Äî Login —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç session_token
‚úÖ get_subscription_status_by_session ‚Äî "trial", days_left: 6
‚úÖ batch_upsert_client_kv_by_session ‚Äî {"saved": 1, "success": true}
‚úÖ get_client_kv_by_session ‚Äî {"found": true, "value": {...}}
‚úÖ upsert_client_kv_by_session ‚Äî {"success": true}
‚úÖ delete_client_kv_by_session ‚Äî {"deleted": true/false}
‚úÖ Curator sync (REST upsert) ‚Äî 200 OK (Bug #7 fixed)
‚úÖ PIN sync (RPC batch_upsert) ‚Äî success (Bug #8 fixed)
‚úÖ Read-only —Ä–µ–∂–∏–º ‚Äî subscription_required –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏
```

---

## üî• –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–Ω–æ–ª–∏—Ç–æ–≤

> –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥. –í—ã–ø–æ–ª–Ω—è—Ç—å –î–û –Ω–æ–≤—ã—Ö —Ñ–∏—á.

### 1. Refactor heys_day_v12.js ‚Äî –ì–ª–∞–≤–Ω—ã–π –¥–µ–Ω—å-—Ç–∞–±

**–§–∞–π–ª**:
[2026-01-10-heys-day-v12-refactoring.md](./docs/tasks/2026-01-10-heys-day-v12-refactoring.md)  
**–û–ø–∏—Å–∞–Ω–∏–µ**: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –º–æ–Ω–æ–ª–∏—Ç–∞ 23,645 —Å—Ç—Ä–æ–∫ ‚Üí 45-50 –º–æ–¥—É–ª–µ–π. 57 useEffects,
23 useState, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏. –°–∞–º—ã–π –∫—Ä–∏—Ç–∏—á–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞.  
**–í—Ä–µ–º—è**: ~16-24 —á–∞—Å–∞ (3 —Ñ–∞–∑—ã)

### 2. Refactor heys_predictive_insights_v1.js ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

**–§–∞–π–ª**:
[2026-01-10-refactor-predictive-insights.md](./docs/tasks/2026-01-10-refactor-predictive-insights.md)  
**–û–ø–∏—Å–∞–Ω–∏–µ**: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è 10,410 —Å—Ç—Ä–æ–∫ ‚Üí 10-12 –º–æ–¥—É–ª–µ–π. ~72 React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞,
—Å–∏—Å—Ç–µ–º–∞ —Å–æ–≤–µ—Ç–æ–≤, —Ä–∏—Å–∫–æ–≤, –ø—Ä–æ–≥–Ω–æ–∑–æ–≤.  
**–í—Ä–µ–º—è**: ~12-16 —á–∞—Å–æ–≤

### 3. Refactor heys_storage_supabase_v1.js ‚Äî Storage Layer

**–§–∞–π–ª**:
[2026-01-10-refactor-storage-supabase.md](./docs/tasks/2026-01-10-refactor-storage-supabase.md)  
**–û–ø–∏—Å–∞–Ω–∏–µ**: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è 6,010 —Å—Ç—Ä–æ–∫ ‚Üí 8 –º–æ–¥—É–ª–µ–π (auth, sync, products, kv,
sessions, cloud, utils, main).  
**–í—Ä–µ–º—è**: ~8-10 —á–∞—Å–æ–≤

### 4. Refactor heys_insulin_wave_v1.js ‚Äî –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞

**–§–∞–π–ª**:
[2026-01-10-refactor-insulin-wave.md](./docs/tasks/2026-01-10-refactor-insulin-wave.md)  
**–û–ø–∏—Å–∞–Ω–∏–µ**: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –º–æ–¥—É–ª—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã. 37 —Ñ–∞–∫—Ç–æ—Ä–æ–≤, —Å–ª–æ–∂–Ω—ã–µ
—Ä–∞—Å—á—ë—Ç—ã, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è.  
**–í—Ä–µ–º—è**: ~6-8 —á–∞—Å–æ–≤

---

## üü¢ –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏

### 1. Onboarding Tutorial ‚Äî –û–±—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–π–ª**:
[2025-01-06-onboarding-tutorial.md](./docs/tasks/2025-01-06-onboarding-tutorial.md)  
**–û–ø–∏—Å–∞–Ω–∏–µ**:
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç—É—Ä –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
Spotlight-—ç—Ñ—Ñ–µ–∫—Ç + –ø–æ—à–∞–≥–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ Hero-–∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–ª–æ—Ä–∏–π.  
**–í—Ä–µ–º—è**: ~4-6 —á–∞—Å–æ–≤

---

### –†–∞–Ω–µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ

–°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∏–∞–ª-–º–∞—à–∏–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞:

- ‚úÖ –ö—É—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –ø–æ PIN –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- ‚úÖ –¢—Ä–∏–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ Read-only —Ä–µ–∂–∏–º –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –∏—Å—Ç—ë–∫—à–µ–º —Ç—Ä–∏–∞–ª–µ
- ‚úÖ Trial Queue —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ–∂–∏–¥–∞–Ω–∏–µ –º–µ—Å—Ç)

---

## üî¥ –ë–ª–æ–∫–µ—Ä—ã (–∂–¥—É—Ç –±–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏–π)

### üí≥ –ÆKassa + –ù–∞–ª–æ–≥–∏

**–°—Ç–∞—Ç—É—Å**: ‚è∏Ô∏è –û–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º–µ

**–ë–ª–æ–∫–µ—Ä—ã (–Ω–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ!):**

- [ ] –†–µ—à–µ–Ω–∏–µ –ø–æ —é—Ä.—Å—Ö–µ–º–µ: –ò–ü (–ü–°–ù+–£–°–ù) –∏–ª–∏ —Ç–æ–ª—å–∫–æ –£–°–ù
- [ ] –û–ö–í–≠–î: 63.11 (SaaS), 62.01, 62.09, 63.99.1 ‚Äî –ù–ï –º–µ–¥–∏—Ü–∏–Ω–∞
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa (shopId + secretKey)
- [ ] –§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è: –æ–±–ª–∞—á–Ω–∞—è –∫–∞—Å—Å–∞ + –û–§–î –∏–ª–∏ "–ß–µ–∫–∏ –æ—Ç –ÆKassa"

**–ö–æ–¥ –≥–æ—Ç–æ–≤:**

- [x] Cloud Function `heys-api-payments`
- [x] Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (handlePayment, checkPendingPayment)
- [x] API Gateway —Ä–æ—É—Ç—ã

**–ü–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å ~2-4 —á–∞—Å–∞):**

- [ ] –î–µ–ø–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
- [ ] Webhook –≤ –ÆKassa
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ sandbox
- [ ] –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ `payment_succeeded`

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

- [x] **üîê Auth Bugfixes** ‚Äî curator 500 + PIN infinite loop (2025-01-03)
- [x] **üé´ –¢—Ä–∏–∞–ª-–º–∞—à–∏–Ω–∞** ‚Äî backend + frontend + smoke tests (2025-12-26/27)
- [x] **üîí Read-only —Ä–µ–∂–∏–º** ‚Äî write guard + paywall UI (2025-12-26)
- [x] SMS.ru –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å "HEYS" —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] SMS –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ API server (CORS bypass)
- [x] –Æ—Ä–∏–¥–∏–∫–∞ ‚Äî —Å–æ–≥–ª–∞—Å–∏—è, –ü–≠–ü, SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
- [x] Landing page ‚Äî —Ñ–æ—Ä–º–∞, Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [x] Yandex Cloud PostgreSQL ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- [x] Cloud Functions ‚Äî RPC, REST, SMS, Leads, Health, Auth
- [x] **–ü–ª–∞—Ç–µ–∂–∏ –∫–æ–¥** ‚Äî Cloud Function + Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [x] **Consents RPC** ‚Äî 4 —Ñ—É–Ω–∫—Ü–∏–∏ (log, check, revoke, get) —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] **RU –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (152-–§–ó)** ‚Äî PostgreSQL –Ω–∞ Yandex.Cloud

---

## üìã –ß—Ç–æ –¥–∞–ª—å—à–µ?

### üî¨ –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –í–æ–ª–Ω–∞ v2.0 (Science Upgrade)

**–§–∞–π–ª**:
[2026-01-08-insulin-wave-v2.md](./docs/tasks/2026-01-08-insulin-wave-v2.md)
**–û–ø–∏—Å–∞–Ω–∏–µ**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –Ω–∞—É—á–Ω–æ–π –º–æ–¥–µ–ª–∏ Insuline Wave v2.0 (GL, II,
Multi-component curve, AUC scoring). **–í—Ä–µ–º—è**: ~8-12 —á–∞—Å–æ–≤

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞!** üéâ

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –±–ª–æ–∫–µ—Ä ‚Äî **–±–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏—è –ø–æ –æ–ø–ª–∞—Ç–∞–º:**

1. **–†–µ—à–∏—Ç—å —é—Ä.—Å—Ö–µ–º—É** (—Å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º): –ü–°–ù+–£–°–ù –∏–ª–∏ —Ç–æ–ª—å–∫–æ –£–°–ù
2. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ÆKassa** ‚Üí –ø–æ–ª—É—á–∏—Ç—å shopId + secretKey
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—é** ‚Üí –æ–±–ª–∞—á–Ω–∞—è –∫–∞—Å—Å–∞ –∏–ª–∏ "–ß–µ–∫–∏ –æ—Ç –ÆKassa"

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ ‚Äî –¥–µ–ø–ª–æ–π –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞–π–º—ë—Ç **~2-4 —á–∞—Å–∞**.
