-- =====================================================
-- BACKFILL: NOVA Classification for Existing Products
-- Date: 2026-01-18
-- Description: Auto-assign NOVA groups based on product name patterns
-- =====================================================

-- Technique: Case-insensitive regex matching on name_norm (lowercase normalized name)

-- =====================================================
-- NOVA 1: Unprocessed or minimally processed foods
-- =====================================================
-- Fresh/frozen fruits, vegetables, meat, fish, eggs, milk, grains, nuts

UPDATE shared_products SET nova_group = 1
WHERE nova_group IS NULL
  AND (
    -- –ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞
    name_norm ~* '(–∫—É—Ä–∏–Ω|–∫—É—Ä–∏—Ü|–≥–æ–≤—è–¥–∏–Ω|–≥–æ–≤—è–∂|—Å–≤–∏–Ω–∏–Ω|—Å–≤–∏–Ω–æ|–∏–Ω–¥–µ–π–∫|–∏–Ω–¥—é—à|—É—Ç–∏–Ω|—É—Ç–∫–∞|–≥—É—Å–∏–Ω|–±–∞—Ä–∞–Ω–∏–Ω|—Ç–µ–ª—è—Ç–∏–Ω|–∫—Ä–æ–ª–∏–∫|–ø–µ—á–µ–Ω[—å–∏]|—Å–µ—Ä–¥—Ü|—è–∑—ã–∫|—Ñ–∞—Ä—à)'
    -- –†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã
    OR name_norm ~* '(—Ä—ã–±[–∞—ã]|–ª–æ—Å–æ—Å|—Å—ë–º–≥|—Å–µ–º–≥|—Ñ–æ—Ä–µ–ª|—Ç—Ä–µ—Å–∫|–º–∏–Ω—Ç–∞–π|—Å–∫—É–º–±—Ä–∏|—Å–µ–ª—å–¥|—Ç—É–Ω–µ—Ü|–∫—Ä–µ–≤–µ—Ç–∫|–∫–∞–ª—å–º–∞—Ä|–º–∏–¥–∏–∏|—É—Å—Ç—Ä–∏—Ü)'
    -- –Ø–π—Ü–∞
    OR name_norm ~* '(—è–π—Ü[–æ–∞]|—è–∏—á–Ω|–±–µ–ª–æ–∫ –∫—É—Ä–∏–Ω—ã–π|–∂–µ–ª—Ç–æ–∫)'
    -- –ú–æ–ª–æ–∫–æ —Å–≤–µ–∂–µ–µ (–Ω–µ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ)
    OR name_norm ~* '(–º–æ–ª–æ–∫–æ\s|–º–æ–ª–æ–∫–æ$|–º–æ–ª–æ—á–∫–æ)'
    -- –û–≤–æ—â–∏
    OR name_norm ~* '(–∫–∞—Ä—Ç–æ—Ñ–µ–ª|–∫–∞—Ä—Ç–æ—à–∫|–º–æ—Ä–∫–æ–≤|—Å–≤–µ–∫–ª|–∫–∞–ø—É—Å—Ç|–æ–≥—É—Ä—Ü|–ø–æ–º–∏–¥–æ—Ä|—Ç–æ–º–∞—Ç|–ø–µ—Ä–µ—Ü|–ª—É–∫\s|—á–µ—Å–Ω–æ–∫|–±–∞–∫–ª–∞–∂–∞–Ω|–∫–∞–±–∞—á–æ–∫|—Ç—ã–∫–≤|–±—Ä–æ–∫–∫–æ–ª–∏|—à–ø–∏–Ω–∞—Ç|—Å–∞–ª–∞—Ç\s|–∑–µ–ª–µ–Ω)'
    -- –§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã
    OR name_norm ~* '(—è–±–ª–æ–∫|–≥—Ä—É—à|–±–∞–Ω–∞–Ω|–∞–ø–µ–ª—å—Å–∏–Ω|–º–∞–Ω–¥–∞—Ä–∏–Ω|–ª–∏–º–æ–Ω|–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç|–≤–∏–Ω–æ–≥—Ä–∞–¥|–∫–ª—É–±–Ω–∏–∫|–º–∞–ª–∏–Ω|—á–µ—Ä–Ω–∏–∫|–≥–æ–ª—É–±–∏–∫|—Å–º–æ—Ä–æ–¥–∏–Ω|–≤–∏—à–Ω|—á–µ—Ä–µ—à–Ω|—Å–ª–∏–≤|–ø–µ—Ä—Å–∏–∫|–∞–±—Ä–∏–∫–æ—Å|–∞—Ä–±—É–∑|–¥—ã–Ω|–º–∞–Ω–≥–æ|–∞–Ω–∞–Ω–∞—Å|–∫–∏–≤–∏|–∞–≤–æ–∫–∞–¥–æ|–≥—Ä–∞–Ω–∞—Ç)'
    -- –ö—Ä—É–ø—ã –∏ –∑–µ—Ä–Ω–æ
    OR name_norm ~* '(—Ä–∏—Å\s|—Ä–∏—Å$|–≥—Ä–µ—á–∫|–æ–≤—Å—è–Ω|–ø—à–µ–Ω|–ø–µ—Ä–ª–æ–≤|—è—á–Ω–µ–≤|–∫—É–∫—É—Ä—É–∑[–∞—ã]|–∫–∏–Ω–æ–∞|–±—É–ª–≥—É—Ä|–∫—É—Å.–∫—É—Å|–ø–æ–ª–±)'
    -- –ë–æ–±–æ–≤—ã–µ
    OR name_norm ~* '(–≥–æ—Ä–æ—Ö|—Ñ–∞—Å–æ–ª|—á–µ—á–µ–≤–∏—Ü|–Ω—É—Ç|—Å–æ—è|–±–æ–±—ã)'
    -- –û—Ä–µ—Ö–∏ –∏ —Å–µ–º–µ–Ω–∞
    OR name_norm ~* '(–æ—Ä–µ—Ö|–º–∏–Ω–¥–∞–ª|–≥—Ä–µ—Ü–∫–∏|—Ñ—É–Ω–¥—É–∫|–∫–µ—à—å—é|—Ñ–∏—Å—Ç–∞—à–∫|–∞—Ä–∞—Ö–∏—Å|—Å–µ–º–µ—á–∫|—Å–µ–º–µ–Ω–∞|–ª—ë–Ω|—á–∏–∞|–∫—É–Ω–∂—É—Ç)'
    -- –ì—Ä–∏–±—ã
    OR name_norm ~* '(–≥—Ä–∏–±|—à–∞–º–ø–∏–Ω—å–æ–Ω|–≤—ë—à–µ–Ω–∫|–≤–µ—à–µ–Ω–∫|–±–µ–ª—ã–π –≥—Ä–∏–±|–ª–∏—Å–∏—á–∫|–æ–ø—è—Ç)'
  );

-- =====================================================
-- NOVA 2: Processed culinary ingredients
-- =====================================================
-- Oils, butter, sugar, salt, flour, starches

UPDATE shared_products SET nova_group = 2
WHERE nova_group IS NULL
  AND (
    -- –ú–∞—Å–ª–∞
    name_norm ~* '(–º–∞—Å–ª–æ\s|–º–∞—Å–ª–æ$|–æ–ª–∏–≤–∫–æ–≤|–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω|—Ä–∞–ø—Å–æ–≤|–∫–æ–∫–æ—Å–æ–≤|–ª—å–Ω—è–Ω–æ|–∫—É–Ω–∂—É—Ç–Ω)'
    -- –°–∞—Ö–∞—Ä –∏ –ø–æ–¥—Å–ª–∞—Å—Ç–∏—Ç–µ–ª–∏
    OR name_norm ~* '(—Å–∞—Ö–∞—Ä|–º—ë–¥|–º–µ–¥\s|–ø–∞—Ç–æ–∫–∞|—Å–∏—Ä–æ–ø\s|—Ñ—Ä—É–∫—Ç–æ–∑–∞|–≥–ª—é–∫–æ–∑–∞)'
    -- –°–æ–ª—å
    OR name_norm ~* '(—Å–æ–ª—å\s|—Å–æ–ª—å$|–º–æ—Ä—Å–∫–∞—è —Å–æ–ª—å)'
    -- –ú—É–∫–∞ –∏ –∫—Ä–∞—Ö–º–∞–ª
    OR name_norm ~* '(–º—É–∫–∞\s|–º—É–∫–∞$|–∫—Ä–∞—Ö–º–∞–ª)'
    -- –£–∫—Å—É—Å
    OR name_norm ~* '(—É–∫—Å—É—Å)'
  );

-- =====================================================
-- NOVA 3: Processed foods
-- =====================================================
-- Canned vegetables, cheese, bread, simple processed foods

UPDATE shared_products SET nova_group = 3
WHERE nova_group IS NULL
  AND (
    -- –ö–æ–Ω—Å–µ—Ä–≤—ã
    name_norm ~* '(–∫–æ–Ω—Å–µ—Ä–≤|–∫–æ–Ω—Å–µ—Ä–≤–∞|–≤ —Å–æ–±—Å—Ç–≤|–≤ —Ç–æ–º–∞—Ç)'
    -- –°—ã—Ä—ã
    OR name_norm ~* '(—Å—ã—Ä\s|—Å—ã—Ä$|—Ç–≤–æ—Ä–æ–≥|–º–æ—Ü–∞—Ä–µ–ª|–ø–∞—Ä–º–µ–∑–∞–Ω|—á–µ–¥–¥–µ—Ä|—Ñ–µ—Ç–∞|–±—Ä—ã–Ω–∑|—Ä–∏–∫–æ—Ç—Ç|–º–∞—Å–∫–∞—Ä–ø–æ–Ω–µ)'
    -- –•–ª–µ–± –ø—Ä–æ—Å—Ç–æ–π
    OR name_norm ~* '(—Ö–ª–µ–±\s|—Ö–ª–µ–±$|–±–∞—Ç–æ–Ω|–±–∞–≥–µ—Ç|–ª–∞–≤–∞—à|–ª–µ–ø—ë—à–∫|–ª–µ–ø–µ—à–∫)'
    -- –°–æ–∫–∏ –∏ –∫–æ–º–ø–æ—Ç—ã
    OR name_norm ~* '(—Å–æ–∫\s|—Å–æ–∫$|–∫–æ–º–ø–æ—Ç|–º–æ—Ä—Å)'
    -- –ü–∏–≤–æ –∏ –≤–∏–Ω–æ (–Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ)
    OR name_norm ~* '(–ø–∏–≤–æ\s|–ø–∏–≤–æ$|–≤–∏–Ω–æ\s|–≤–∏–Ω–æ$)'
    -- –°–º–µ—Ç–∞–Ω–∞, –∫–µ—Ñ–∏—Ä, –π–æ–≥—É—Ä—Ç –±–µ–∑ –¥–æ–±–∞–≤–æ–∫
    OR name_norm ~* '(—Å–º–µ—Ç–∞–Ω|–∫–µ—Ñ–∏—Ä|–π–æ–≥—É—Ä—Ç|—Ä—è–∂–µ–Ω–∫|–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à|–∞–π—Ä–∞–Ω)'
    -- –ö–æ–ø—á—ë–Ω–æ–µ –º—è—Å–æ/—Ä—ã–±–∞
    OR name_norm ~* '(–∫–æ–ø—á—ë–Ω|–∫–æ–ø—á–µ–Ω)'
  );

-- =====================================================
-- NOVA 4: Ultra-processed foods
-- =====================================================
-- Industrial formulations with additives

UPDATE shared_products SET nova_group = 4
WHERE nova_group IS NULL
  AND (
    -- –ß–∏–ø—Å—ã –∏ —Å–Ω–µ–∫–∏
    name_norm ~* '(—á–∏–ø—Å|—Å–Ω–µ–∫|—Å—É—Ö–∞—Ä–∏–∫|–∫—Ä–µ–∫–µ—Ä|–ø–æ–ø–∫–æ—Ä–Ω)'
    -- –ö–æ–ª–±–∞—Å–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è
    OR name_norm ~* '(–∫–æ–ª–±–∞—Å|—Å–æ—Å–∏—Å–∫|—Å–∞—Ä–¥–µ–ª—å–∫|–≤–µ—Ç—á–∏–Ω|–±–µ–∫–æ–Ω|—Å–∞–ª—è–º–∏|—à–ø–∏–∫–∞—á–∫|–∫—É–ø–∞—Ç)'
    -- –°–ª–∞–¥–æ—Å—Ç–∏
    OR name_norm ~* '(–∫–æ–Ω—Ñ–µ—Ç|—à–æ–∫–æ–ª–∞–¥|–ø–µ—á–µ–Ω—å[–µ–∏]|–≤–∞—Ñ–ª|–ø—Ä—è–Ω–∏–∫|—Ç–æ—Ä—Ç|–ø–∏—Ä–æ–∂–Ω|–∫–µ–∫—Å|–º–∞—Ñ—Ñ–∏–Ω|–∫—Ä—É–∞—Å—Å–∞–Ω|—ç–∫–ª–µ—Ä|–∑–µ—Ñ–∏—Ä|–º–∞—Ä–º–µ–ª–∞–¥|—Ö–∞–ª–≤–∞|–ø–∞—Å—Ç–∏–ª|–¥—Ä–∞–∂–µ|–±–∞—Ç–æ–Ω—á–∏–∫)'
    -- –ì–∞–∑–∏—Ä–æ–≤–∫–∞ –∏ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏
    OR name_norm ~* '(–∫–æ–ª–∞|–ø–µ–ø—Å–∏|—Ñ–∞–Ω—Ç|—Å–ø—Ä–∞–π—Ç|–≥–∞–∑–∏—Ä–æ–≤–∫|–ª–∏–º–æ–Ω–∞–¥|—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫|–Ω–µ–∫—Ç–∞—Ä)'
    -- –°–æ—É—Å—ã –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ
    OR name_norm ~* '(–º–∞–π–æ–Ω–µ–∑|–∫–µ—Ç—á—É–ø|—Å–æ—É—Å\s|—Å–æ—É—Å$)'
    -- –§–∞—Å—Ç—Ñ—É–¥
    OR name_norm ~* '(–±—É—Ä–≥–µ—Ä|–≥–∞–º–±—É—Ä–≥–µ—Ä|—á–∏–∑–±—É—Ä–≥–µ—Ä|—Ö–æ—Ç.?–¥–æ–≥|–ø–∏—Ü—Ü–∞|–Ω–∞–≥–≥–µ—Ç—Å|–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏)'
    -- –ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã
    OR name_norm ~* '(–ø–µ–ª—å–º–µ–Ω|–≤–∞—Ä–µ–Ω–∏–∫|–±–ª–∏–Ω—á–∏–∫|–∫–æ—Ç–ª–µ—Ç|–Ω–∞–≥–≥–µ—Ç—Å|–ø–∞–ª–æ—á–∫|–∫—Ä–∞–±–æ–≤)'
    -- –°—É—Ö–∏–µ –∑–∞–≤—Ç—Ä–∞–∫–∏
    OR name_norm ~* '(—Ö–ª–æ–ø—å—è|–º—é—Å–ª–∏|–≥—Ä–∞–Ω–æ–ª–∞|–∫–∞—à–∞ –±—ã—Å—Ç—Ä)'
    -- –ú–∞—Ä–≥–∞—Ä–∏–Ω –∏ —Å–ø—Ä–µ–¥—ã
    OR name_norm ~* '(–º–∞—Ä–≥–∞—Ä–∏–Ω|—Å–ø—Ä–µ–¥)'
    -- –ú–æ—Ä–æ–∂–µ–Ω–æ–µ
    OR name_norm ~* '(–º–æ—Ä–æ–∂–µ–Ω–æ–µ|–ø–ª–æ–º–±–∏—Ä|—ç—Å–∫–∏–º–æ)'
    -- –õ–∞–ø—à–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
    OR name_norm ~* '(–¥–æ—à–∏—Ä–∞–∫|—Ä–æ–ª–ª—Ç–æ–Ω|–ª–∞–ø—à–∞ –±—ã—Å—Ç—Ä)'
    -- –ü–ª–∞–≤–ª–µ–Ω—ã–π —Å—ã—Ä
    OR name_norm ~* '(–ø–ª–∞–≤–ª–µ–Ω)'
  );

-- =====================================================
-- VERIFICATION
-- =====================================================

-- Count results
SELECT 
    COALESCE(nova_group::text, 'NULL') AS nova,
    COUNT(*) AS count,
    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER(), 1) AS pct
FROM shared_products
GROUP BY nova_group
ORDER BY nova_group NULLS LAST;

-- Show products still without NOVA (for manual review)
SELECT id, name, name_norm
FROM shared_products
WHERE nova_group IS NULL
ORDER BY name
LIMIT 50;

-- Summary
DO $$
DECLARE
    total_count INTEGER;
    filled_count INTEGER;
    null_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO total_count FROM shared_products;
    SELECT COUNT(*) INTO filled_count FROM shared_products WHERE nova_group IS NOT NULL;
    null_count := total_count - filled_count;
    
    RAISE NOTICE 'üìä NOVA Backfill Results:';
    RAISE NOTICE '   Total products: %', total_count;
    RAISE NOTICE '   NOVA assigned:  % (%.1f%%)', filled_count, (100.0 * filled_count / NULLIF(total_count, 0));
    RAISE NOTICE '   Still NULL:     % (manual review needed)', null_count;
END $$;
