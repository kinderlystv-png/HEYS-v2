-- Cleanup Legacy Tables Script
-- Удаляет устаревшие таблицы, которые не используются в HEYS v2
-- Дата: 2025-11-10
-- Безопасно: данные уже мигрированы в client_kv_store

-- =============================================================================
-- ПРОВЕРКА: Убедитесь, что данные действительно не используются
-- =============================================================================

-- Проверить количество записей в легаси таблицах (ЗАПУСТИТЕ СНАЧАЛА):
-- SELECT 'heys_day_stats' as table_name, COUNT(*) as rows FROM heys_day_stats
-- UNION ALL
-- SELECT 'heys_ration', COUNT(*) FROM heys_ration
-- UNION ALL
-- SELECT 'heys_user_params', COUNT(*) FROM heys_user_params;

-- =============================================================================
-- УДАЛЕНИЕ ЛЕГАСИ ТАБЛИЦ
-- =============================================================================

-- 1. Удалить таблицу heys_day_stats (статистика дней)
--    Данные теперь в: client_kv_store с ключом "dayv2_YYYY-MM-DD"
DROP TABLE IF EXISTS public.heys_day_stats CASCADE;

-- 2. Удалить таблицу heys_ration (рационы по дням)
--    Данные теперь в: client_kv_store с ключом "dayv2_YYYY-MM-DD"
DROP TABLE IF EXISTS public.heys_ration CASCADE;

-- 3. Удалить таблицу heys_user_params (параметры пользователей)
--    Данные теперь в: client_kv_store с ключом "heys_profile"
DROP TABLE IF EXISTS public.heys_user_params CASCADE;

-- =============================================================================
-- ОЧИСТКА ИНДЕКСОВ (если остались сироты)
-- =============================================================================

-- Индексы удалятся автоматически с CASCADE, но на всякий случай:
DROP INDEX IF EXISTS public.heys_day_stats_user_client_idx;
DROP INDEX IF EXISTS public.heys_ration_user_client_date_idx;
DROP INDEX IF EXISTS public.heys_user_params_user_client_idx;

-- =============================================================================
-- ПРОВЕРКА РЕЗУЛЬТАТА
-- =============================================================================

-- Проверить, что таблицы удалены:
-- SELECT table_name 
-- FROM information_schema.tables 
-- WHERE table_schema = 'public' 
--   AND table_name IN ('heys_day_stats', 'heys_ration', 'heys_user_params');
-- 
-- Ожидаемый результат: 0 строк

-- =============================================================================
-- ROLLBACK ПЛАН (если что-то пошло не так)
-- =============================================================================

-- Если нужно восстановить структуру таблиц (БЕЗ данных):
-- Смотрите файл: supabase_full_setup.sql (там есть старые CREATE TABLE)

-- =============================================================================
-- ИТОГИ
-- =============================================================================

-- ✅ Удалены 3 легаси таблицы
-- ✅ Освобождено место в БД
-- ✅ Упрощена схема базы данных
-- ✅ Нет риска потери данных (всё в client_kv_store)

SELECT '✅ Cleanup completed! Legacy tables removed.' AS status;
