-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” P2 Security: Phone Enumeration Fix
-- Ğ”Ğ°Ñ‚Ğ°: 2025-12-25
-- Ğ’ĞµÑ€ÑĞ¸Ñ: 1.0.0
-- 
-- ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ:
--   verify_client_pin_v3 Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ 'client_not_found' Ğ´Ğ»Ñ Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ…
--   Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ², Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‰ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ‡Ğ¸ÑĞ»ÑÑ‚ÑŒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°.
--
-- Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ•:
--   1. Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ 'invalid_credentials' Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞ»ÑƒÑ‡Ğ°ĞµĞ² Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ¸
--   2. Rate-limit Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ°Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ²
--   3. Timing-Ğ°Ñ‚Ğ°ĞºĞ° Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· pg_sleep
--   4. Fallback IP '0.0.0.0' ĞµÑĞ»Ğ¸ IP Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Drop existing function to recreate with fixes
DROP FUNCTION IF EXISTS public.verify_client_pin_v3(text, text, text, text);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” verify_client_pin_v3 â€” FIXED (no phone enumeration)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE OR REPLACE FUNCTION public.verify_client_pin_v3(
  p_phone TEXT,
  p_pin TEXT,
  p_ip TEXT DEFAULT NULL,
  p_user_agent TEXT DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_client RECORD;
  v_ip INET;
  v_phone_normalized TEXT;
  v_session_token UUID;
  v_session_expires TIMESTAMPTZ;
  v_client_found BOOLEAN := FALSE;
  v_pin_correct BOOLEAN := FALSE;
BEGIN
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 1) ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  -- ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹)
  v_phone_normalized := regexp_replace(COALESCE(p_phone, ''), '[^0-9]', '', 'g');
  
  -- Fallback IP Ğ´Ğ»Ñ rate-limit (ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½)
  -- '0.0.0.0' Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ĞºĞ°Ğº placeholder Ğ´Ğ»Ñ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº
  BEGIN
    v_ip := COALESCE(NULLIF(TRIM(p_ip), '')::INET, '0.0.0.0'::INET);
  EXCEPTION WHEN OTHERS THEN
    v_ip := '0.0.0.0'::INET;
  END;
  
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 2) Rate-limit Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ (Ğ´Ğ°Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ²)
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  BEGIN
    PERFORM public.check_pin_rate_limit(v_phone_normalized, v_ip);
  EXCEPTION WHEN OTHERS THEN
    -- Rate-limit exceeded
    PERFORM public.log_security_event(
      'pin_rate_limited',
      v_phone_normalized,
      NULL,  -- no client_id yet
      v_ip::TEXT,
      p_user_agent,
      jsonb_build_object('error', SQLERRM)
    );
    RAISE;  -- Re-raise the exception
  END;
  
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 3) ĞŸĞ¾Ğ¸ÑĞº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° (Ğ±ĞµĞ· Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‰ĞµĞ¼Ñƒ)
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  SELECT id, pin_hash, name
  INTO v_client
  FROM public.clients
  WHERE phone_normalized = v_phone_normalized
    AND pin_hash IS NOT NULL;
  
  v_client_found := FOUND;
  
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 4) ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° PIN (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½)
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  IF v_client_found THEN
    -- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ PIN Ñ‡ĞµÑ€ĞµĞ· bcrypt
    v_pin_correct := (v_client.pin_hash = crypt(p_pin, v_client.pin_hash));
  END IF;
  
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 5) Timing-Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  -- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‰Ğ¸Ğ¹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ
  -- "ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½" Ğ¾Ñ‚ "Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ PIN" Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
  PERFORM pg_sleep(0.08 + random() * 0.04);  -- 80-120ms
  
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 6) ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  IF NOT v_client_found OR NOT v_pin_correct THEN
    -- Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ (Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½)
    -- âš ï¸ Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ”Ğ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ°ÑÑŒ!
    PERFORM public.increment_pin_attempt(v_phone_normalized, v_ip);
    
    -- Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ñƒ
    PERFORM public.log_security_event(
      'pin_failed',
      v_phone_normalized,
      CASE WHEN v_client_found THEN v_client.id ELSE NULL END,
      v_ip::TEXT,
      p_user_agent,
      jsonb_build_object(
        'reason', 'invalid_credentials',  -- Ğ£Ğ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°
        'client_exists', v_client_found   -- Ğ”Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸
      )
    );
    
    -- âš ï¸ Ğ’ĞĞ–ĞĞ: Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ JSON Ğ²Ğ¼ĞµÑÑ‚Ğ¾ RAISE Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ—ĞĞšĞĞœĞœĞ˜Ğ¢Ğ˜Ğ›ĞĞ¡Ğ¬
    -- Ğ¸ rate-limit Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ»ÑÑ Ğ² Ğ‘Ğ”!
    RETURN jsonb_build_object(
      'success', FALSE,
      'error', 'invalid_credentials'
    );
  END IF;
  
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -- 7) Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
  -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  -- Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº
  PERFORM public.reset_pin_attempts(v_phone_normalized, v_ip);
  
  -- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑĞµÑÑĞ¸Ñ
  v_session_token := gen_random_uuid();
  v_session_expires := NOW() + INTERVAL '30 days';
  
  INSERT INTO public.client_sessions (
    session_token,
    client_id,
    ip_address,
    user_agent,
    expires_at
  ) VALUES (
    v_session_token,
    v_client.id,
    v_ip,
    p_user_agent,
    v_session_expires
  );
  
  -- Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒÑĞ¿ĞµÑ…
  PERFORM public.log_security_event(
    'pin_success',
    v_phone_normalized,
    v_client.id,
    v_ip::TEXT,
    p_user_agent,
    jsonb_build_object('session_id', v_session_token)
  );
  
  -- Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  RETURN jsonb_build_object(
    'success', TRUE,
    'session_token', v_session_token,
    'client_id', v_client.id,
    'name', v_client.name,
    'session_expires_at', v_session_expires
  );
  
END;
$$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”’ ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ĞÑ‚Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñƒ PUBLIC
REVOKE ALL ON FUNCTION public.verify_client_pin_v3(text, text, text, text) FROM PUBLIC;

-- Ğ”Ğ°Ñ‘Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ heys_rpc
GRANT EXECUTE ON FUNCTION public.verify_client_pin_v3(text, text, text, text) TO heys_rpc;

COMMENT ON FUNCTION public.verify_client_pin_v3(text, text, text, text) IS 
'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° PIN ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° v3 Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¾Ğ¹ Ğ¾Ñ‚ phone enumeration. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ unified "invalid_credentials" Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
