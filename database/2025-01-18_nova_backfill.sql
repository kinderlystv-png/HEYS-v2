-- ============================================================================
-- HEYS NOVA Backfill Script
-- Version: 1.0.0
-- Date: 2025-01-18
-- Description: Автоматическое заполнение nova_group по паттернам названий
-- ============================================================================

-- Temporary function for NOVA detection
CREATE OR REPLACE FUNCTION detect_nova_group(product_name TEXT) 
RETURNS SMALLINT AS $$
DECLARE
  name_lower TEXT := lower(product_name);
BEGIN
  -- NOVA 1: Unprocessed or minimally processed foods
  IF name_lower ~ '(свежий|свежая|свежее|сырой|сырая|сырое|яблок|банан|апельсин|мандарин|груш|виноград|клубник|черник|малин|смородин|вишн|черешн|персик|абрикос|слив|нектарин|киви|манго|ананас|арбуз|дын|гранат|хурм|инжир|помидор|огурец|морков|капуст|брокколи|цветная капуста|шпинат|салат|руккол|укроп|петрушк|сельдер|лук|чеснок|перец болгар|кабачок|баклажан|тыкв|свекл|редис|редьк|репа|картофель|картошка|батат|кукуруза|горох|фасоль|чечевиц|нут|бобы|соя|грибы|шампиньон|белые грибы|лисичк|яйц|курин|куриц|индейк|говядин|телятин|свинин|баранин|кролик|утк|гус|рыба|форель|лосось|семга|тунец|треска|окунь|карп|щука|судак|скумбри|сельдь|сардин|анчоус|минтай|дорадо|сибас|камбал|палтус|морепродукт|креветк|мидии|устриц|кальмар|осьминог|краб|омар|лангуст|молоко цельное|сливки натуральные|орех|миндал|грецкий|фундук|кешью|фисташк|кедров|бразильск|макадами|пекан|арахис|семечк|семена|лён|чиа|кунжут|подсолнеч|тыквенн|мёд натуральный|рис нешлифован|гречк|овёс|овсянк|пшен|полба|киноа|булгур|кускус|ячмень|перловк|пшениц|ржан)' THEN
    RETURN 1;
  END IF;
  
  -- NOVA 4: Ultra-processed foods (check first as it's most specific)
  IF name_lower ~ '(чипс|кола|пепси|фант|спрайт|газировк|энергетик|ред булл|монстр|сникерс|марс|твикс|баунти|милки вей|кит-кат|m&m|skittles|орео|принглс|лейс|дорито|начос|поп-корн|кукурузные палочк|сухарик|крутон|бекон|ветчин|колбас|сосиск|сардельк|шпикачк|копчён|вяленый|салями|пепперони|мортаделл|хот-дог|бургер|гамбургер|чизбургер|биг-мак|наггетс|стрипс|крылышк|картофель фри|фри|пицц|роллы|суши|шаурм|шаверм|донер|кебаб|люля|чебурек|беляш|хачапури|пирожок|самса|пельмен|вареник|манты|хинкали|равиоли|тортеллини|лазанья|карбонар|болоньез|паста готов|лапша быстр|доширак|роллтон|мивина|instant|готовый обед|полуфабрикат|замороженн|пирог|торт|пирожн|эклер|профитроль|круассан|маффин|кекс|капкейк|брауни|тирамису|чизкейк|панна котта|мусс|желе|пудинг|мороженое|пломбир|сорбет|фруктовый лёд|молочный коктейль|смузи готов|йогурт питьев|актимель|данон|активиа|чудо|имунеле|нео|биобаланс|снэк|батончик|гранола готов|мюсли готов|хлопья готов|кукурузные хлопья|шоколадные шарики|подушечк|звёздочк|колечк|печенье|крекер|вафл|зефир|пастил|мармелад|конфет|шоколад молочн|шоколад белый|драже|ирис|карамель|леденец|жвачк|кетчуп|майонез|соус готов|тартар|барбекю|терияки|сырный соус|чесночный соус|спред|маргарин|плавленый сыр|сырный продукт)' THEN
    RETURN 4;
  END IF;
  
  -- NOVA 3: Processed foods
  IF name_lower ~ '(консерв|маринован|солён|квашен|копчён|вялен|сыр твёрд|сыр полутвёрд|пармезан|чеддер|гауда|эдам|маасдам|эмменталь|грюйер|бри|камамбер|дор блю|рокфор|горгонзол|фета|брынза|сулугуни|адыгейск|моцарел|рикотт|маскарпон|творог|сметан|кефир|ряженк|простокваш|варенец|йогурт натуральн|хлеб|батон|багет|чиабатт|булк|лаваш|пита|лепёшк|тортилья|макарон|спагетти|пенне|фузилли|феттучин|паппарделл|ригатони|каннеллони|ньокк|масло сливочн|масло топлён|вино|пиво|водк|коньяк|виски|джин|ром|текил|ликёр|настойк|наливк|бренд|сидр|шампанск|просекко|сок|нектар|компот|морс|кисель|варенье|джем|повидло|мармелад|желе|сироп|патока|сахар|соль|уксус|горчиц|хрен|васаби|соевый соус|рыбный соус|устричный соус|вустерский|табаско|шрирача|самбал|харисс|аджик|ткемали|сацебели|песто|гуакамоле|хумус|тахин|урбеч|паста ореховая|шоколад тёмн|шоколад горьк|какао|кофе молот|чай)' THEN
    RETURN 3;
  END IF;
  
  -- NOVA 2: Processed culinary ingredients
  IF name_lower ~ '(масло растительн|масло оливков|масло подсолнечн|масло кукурузн|масло рапсов|масло льнян|масло кунжутн|масло кокосов|масло пальмов|масло арахисов|масло авокадо|масло виноградн|жир|смалец|сало|мука|крахмал|сахар|соль|мёд|уксус|дрожж|разрыхлитель|сода|желатин|агар|пектин|специ|пряност|перец чёрн|перец красн|перец белый|корица|гвоздик|мускатный|кардамон|куркума|имбирь|паприк|тмин|кориандр|зира|анис|бадьян|фенхель|укроп сушён|петрушка сушён|базилик|орегано|тимьян|розмарин|шалфей|майоран|эстрагон|лавров|ваниль|шафран)' THEN
    RETURN 2;
  END IF;
  
  -- Default: check if it looks like a whole food (NOVA 1)
  IF name_lower ~ '^[а-яё\s]+$' AND length(name_lower) < 25 THEN
    -- Short, simple Russian name - likely NOVA 1
    RETURN 1;
  END IF;
  
  RETURN NULL; -- Unknown
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ============================================================================
-- BACKFILL NOVA GROUPS
-- ============================================================================

-- Update all products that don't have nova_group set
UPDATE shared_products
SET 
  nova_group = detect_nova_group(name),
  updated_at = NOW()
WHERE nova_group IS NULL;

-- Report results
DO $$
DECLARE
  total_count INT;
  updated_count INT;
  nova1_count INT;
  nova2_count INT;
  nova3_count INT;
  nova4_count INT;
  null_count INT;
BEGIN
  SELECT COUNT(*) INTO total_count FROM shared_products;
  SELECT COUNT(*) INTO nova1_count FROM shared_products WHERE nova_group = 1;
  SELECT COUNT(*) INTO nova2_count FROM shared_products WHERE nova_group = 2;
  SELECT COUNT(*) INTO nova3_count FROM shared_products WHERE nova_group = 3;
  SELECT COUNT(*) INTO nova4_count FROM shared_products WHERE nova_group = 4;
  SELECT COUNT(*) INTO null_count FROM shared_products WHERE nova_group IS NULL;
  
  updated_count := nova1_count + nova2_count + nova3_count + nova4_count;
  
  RAISE NOTICE '=== NOVA Backfill Results ===';
  RAISE NOTICE 'Total products: %', total_count;
  RAISE NOTICE 'Updated with NOVA: %', updated_count;
  RAISE NOTICE '  NOVA 1 (Unprocessed): %', nova1_count;
  RAISE NOTICE '  NOVA 2 (Culinary ingredients): %', nova2_count;
  RAISE NOTICE '  NOVA 3 (Processed): %', nova3_count;
  RAISE NOTICE '  NOVA 4 (Ultra-processed): %', nova4_count;
  RAISE NOTICE '  Unknown (NULL): %', null_count;
END $$;

-- Keep the function for future use
COMMENT ON FUNCTION detect_nova_group(TEXT) IS 'Detect NOVA group (1-4) from Russian product name using regex patterns';

-- ============================================================================
-- DONE
-- ============================================================================
