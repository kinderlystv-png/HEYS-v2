name: API Health Monitor

# –†–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è production API
# –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö endpoints –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç –≤ Telegram

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç 24/7 (—É–≤–µ–ª–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏)
    - cron: "*/15 * * * *" # –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  push:
    branches: [main]
    paths:
      - "yandex-cloud-functions/**"
      - ".github/workflows/api-health-monitor.yml"

env:
  API_BASE_URL: https://api.heyslab.ru

jobs:
  health-check:
    name: Check API Health
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Test Health Endpoint
        id: health
        run: |
          echo "üè• Testing /health endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "${{ env.API_BASE_URL }}/health")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Health check failed with HTTP $HTTP_CODE"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ë–î
          DB_STATUS=$(echo "$BODY" | jq -r '.checks.database.status // "unknown"')
          if [ "$DB_STATUS" != "ok" ]; then
            echo "::warning::Database status: $DB_STATUS"
          fi

          echo "‚úÖ Health check passed"

      - name: Test RPC Endpoint
        id: rpc
        run: |
          echo "üîå Testing RPC endpoint (get_shared_products)..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 15 \
            -X POST "${{ env.API_BASE_URL }}/rpc?fn=get_shared_products" \
            -H "Content-Type: application/json" \
            -H "Origin: https://app.heyslab.ru" \
            -d '{"p_limit": 1}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::RPC endpoint failed with HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
          ITEM_COUNT=$(echo "$BODY" | jq 'length // 0')
          if [ "$ITEM_COUNT" -lt 1 ]; then
            echo "::error::RPC returned empty array"
            exit 1
          fi

          echo "‚úÖ RPC endpoint passed ($ITEM_COUNT products)"

      - name: Test REST Endpoint
        id: rest
        run: |
          echo "üìä Testing REST endpoint (shared_products)..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 15 \
            "${{ env.API_BASE_URL }}/rest/shared_products?limit=1" \
            -H "Origin: https://app.heyslab.ru")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::REST endpoint failed with HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          echo "‚úÖ REST endpoint passed"

      - name: Test Auth Endpoint
        id: auth
        run: |
          echo "üîê Testing Auth endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 \
            -X POST "${{ env.API_BASE_URL }}/auth/login" \
            -H "Content-Type: application/json" \
            -H "Origin: https://app.heyslab.ru" \
            -d '{"email":"test@test.com","password":"wrong"}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          # Auth –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 401 –∏–ª–∏ 400 —Å JSON (–Ω–µ 502!)
          if [ "$HTTP_CODE" = "502" ] || [ "$HTTP_CODE" = "503" ]; then
            echo "::error::Auth endpoint down (HTTP $HTTP_CODE)"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–µ—Ä–Ω—É–ª—Å—è JSON —Å –æ—à–∏–±–∫–æ–π
          if ! echo "$BODY" | jq -e '.message or .error' > /dev/null 2>&1; then
            echo "::error::Auth returned invalid JSON"
            exit 1
          fi

          echo "‚úÖ Auth endpoint passed"

      # Auto-redeploy –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º
      - name: Auto-redeploy on API failure
        if: failure() && (steps.rest.outcome == 'failure' || steps.rpc.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üîÑ Triggering auto-redeploy workflow...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cloud-functions-deploy.yml',
              ref: 'main',
              inputs: { function_name: 'all' }
            });

      # –ê–ª–µ—Ä—Ç –≤ Telegram –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è schedule/push, –Ω–µ –¥–ª—è manual)
      - name: Send Telegram Alert on Failure
        if: failure() && (github.event_name == 'schedule' || github.event_name == 'push')
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üö® *HEYS API Health Check Failed*%0A%0A"
          MESSAGE="${MESSAGE}‚ùå One or more endpoints down%0A"
          MESSAGE="${MESSAGE}üïê Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')%0A"
          MESSAGE="${MESSAGE}üîó [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A%0A"
          MESSAGE="${MESSAGE}*Health*: ${{ steps.health.outputs.http_code || 'N/A' }}%0A"
          MESSAGE="${MESSAGE}*RPC*: ${{ steps.rpc.outputs.http_code || 'N/A' }}%0A"
          MESSAGE="${MESSAGE}*REST*: ${{ steps.rest.outputs.http_code || 'N/A' }}%0A"
          MESSAGE="${MESSAGE}*Auth*: ${{ steps.auth.outputs.http_code || 'N/A' }}%0A%0A"
          MESSAGE="${MESSAGE}üîÑ Auto-redeploy: TRIGGERED%0A"
          MESSAGE="${MESSAGE}üìù Action: Monitor workflow or run \`./deploy-all.sh\` manually if redeploy fails"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"

      # –£—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî silent (–Ω–µ —Å–ø–∞–º–∏–º –≤ Telegram –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
      - name: Summary
        if: success()
        run: |
          echo "‚úÖ All API endpoints healthy"
          echo "  - Health: ${{ steps.health.outputs.http_code }}"
          echo "  - RPC: ${{ steps.rpc.outputs.http_code }}"
          echo "  - REST: ${{ steps.rest.outputs.http_code }}"
          echo "  - Auth: ${{ steps.auth.outputs.http_code }}"
