# GitHub Actions Workflow Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
# Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ SAST (Static Application Security Testing) Ğ² CI/CD Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½
# 
# @created ĞšĞ¢4 - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸  
# @author HEYS Security Team

name: ğŸ›¡ï¸ Security Scan & SAST

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - '**/package.json'
      - '**/pnpm-lock.yaml'
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  schedule:
    # Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² 2:00 UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18.x'
  PNPM_VERSION: '8.x'

jobs:
  # ==================== Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ ĞĞĞĞ›Ğ˜Ğ— Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ˜ ====================
  sast-analysis:
    name: ğŸ” SAST Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ”½ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run Custom SAST Scanner
        run: |
          echo "ğŸ” Running custom SAST security scanner..."
          node scripts/security/sast-scan.js

      - name: ğŸ” ESLint Security Scan
        run: |
          echo "ğŸ” Running ESLint security analysis..."
          pnpm run lint:security || echo "ESLint security issues found"

      - name: ğŸ›¡ï¸ Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/typescript
            p/react
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  # ==================== ĞĞĞĞ›Ğ˜Ğ— Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ•Ğ™ ====================
  dependency-security:
    name: ğŸ“¦ Dependency Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ”½ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run Custom Dependency Scanner
        run: |
          echo "ğŸ” Running custom dependency security scanner..."
          node scripts/security/dependency-check.js

      - name: ğŸ” Audit Dependencies
        run: |
          echo "ğŸ” Running dependency security audit..."
          pnpm audit --audit-level high

  # ==================== Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ ĞĞ¢Ğ§Ğ•Ğ¢Ğ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ˜ ====================
  security-report:
    name: ğŸ“Š Security Report
    needs: [sast-analysis, dependency-security]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ”½ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“Š Generate Security Report
        run: |
          echo "ğŸ“Š Generating consolidated security report..."
          node scripts/security/security-report.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SECURITY_SCAN_RESULTS: ${{ needs.sast-analysis.result }}
          DEPENDENCY_SCAN_RESULTS: ${{ needs.dependency-security.result }}

      - name: ğŸ“‹ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ github.run_id }}
          path: |
            security-reports/
          retention-days: 30
