name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8"
  # Yandex Cloud Object Storage
  YC_BUCKET_PWA: heys-app # PWA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí app.heyslab.ru
  YC_BUCKET_LANDING: heys-static # –õ–µ–Ω–¥–∏–Ω–≥ ‚Üí heyslab.ru
  YC_ENDPOINT: https://storage.yandexcloud.net

jobs:
  build-and-deploy:
    name: Build & Deploy to Yandex Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # TODO: Fix CI test environment (tests pass locally but fail in CI)
      # - name: Run critical tests
      #   run: |
      #     cd apps/web && pnpm run test -- \
      #       "__tests__/sync-race-condition.test.js" \
      #       "__tests__/merge-day-data.test.js" \
      #       "__tests__/auth-session.test.js" \
      #       "__tests__/storage-layer.test.js" \
      #       "__tests__/products-protection.test.js" \
      #       "__tests__/data-models.test.js"

      - name: Build web app (PWA)
        run: pnpm --filter @heys/web run build
        env:
          VITE_API_URL: https://api.heyslab.ru

      - name: Build landing page
        run: pnpm --filter @heys/landing run build

      - name: Generate build version
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M).${{ github.run_number }}
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Build version: $VERSION"
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –≤ —Ñ–∞–π–ª –¥–ª—è PWA
          echo "{\"version\":\"$VERSION\",\"buildTime\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"${{ github.sha }}\"}" > apps/web/dist/version.json

      - name: Install AWS CLI (S3-compatible)
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update

      - name: Configure AWS CLI for Yandex Cloud
        run: |
          aws configure set aws_access_key_id ${{ secrets.YC_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.YC_SECRET_ACCESS_KEY }}
          aws configure set default.region ru-central1

      - name: Deploy PWA to Yandex Object Storage
        run: |
          # === PWA Application ‚Üí heys-app bucket ===

          # –ë–µ—Ä—ë–º –≤–µ—Ä—Å–∏—é —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
          DOCS_VERSION=$(node -e "const fs=require('fs'); const s=fs.readFileSync('apps/web/heys_consents_v1.js','utf8'); const m=s.match(/user_agreement:\\s*'([^']+)'/); process.stdout.write(m?m[1]:'');")
          if [ -z "$DOCS_VERSION" ]; then
            echo "‚ùå Failed to detect docs version from apps/web/heys_consents_v1.js"
            exit 1
          fi
          echo "Legal docs version: $DOCS_VERSION"

          # 1. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å—Å–µ—Ç—ã —Å –¥–æ–ª–≥–∏–º –∫—ç—à–µ–º (CSS, —à—Ä–∏—Ñ—Ç—ã, –∫–∞—Ä—Ç–∏–Ω–∫–∏)
          #    –ù–û –∏—Å–∫–ª—é—á–∞–µ–º JS —Ñ–∞–π–ª—ã (–æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤–µ—Ä—Å–∏—é –∏ –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è)
          #    –ò –∏—Å–∫–ª—é—á–∞–µ–º docs/*.md (—é—Ä–∏–¥–∏–∫–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è)
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.js" \
            --exclude "sw.js" \
            --exclude "version.json" \
            --exclude "manifest.json" \
            --exclude "docs/*" \
            --exclude "*.md"

          # 2. JS —Ñ–∞–π–ª—ã —Å –∫–æ—Ä–æ—Ç–∫–∏–º –∫—ç—à–µ–º (10 –º–∏–Ω) ‚Äî —Å–æ–¥–µ—Ä–∂–∞—Ç APP_VERSION
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "public, max-age=600" \
            --exclude "*" \
            --include "*.js" \
            --exclude "sw.js"

          # 3. –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–¥–≤–æ–π–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è):
          #   3.1) –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å: /docs/v<version>/...  (–º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å "–≤–µ—á–Ω–æ", —Ç.–∫. immutable)
          #   3.2) Latest –ø—É—Ç—å: /docs/...  (–±–µ–∑ –∫—ç—à–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É)
          # –í–∞–∂–Ω–æ: UI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç /docs/v<version>/... –∫–∞–∫ "–Ω–µ—É–±–∏–≤–∞–µ–º—É—é" –∑–∞—â–∏—Ç—É –æ—Ç CDN-—Å—Ç–∞—Ä—å—è.

          # 3.1 Versioned (immutable)
          aws s3 cp apps/web/dist/docs/ s3://${{ env.YC_BUCKET_PWA }}/docs/v${DOCS_VERSION}/ \
            --recursive \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "public, max-age=31536000, immutable" \
            --content-type "text/markdown; charset=utf-8" \
            --metadata-directive REPLACE

          # 3.2 Latest (no-cache)
          aws s3 cp apps/web/dist/docs/ s3://${{ env.YC_BUCKET_PWA }}/docs/ \
            --recursive \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/markdown; charset=utf-8" \
            --metadata-directive REPLACE

          # 4. HTML —Ñ–∞–π–ª—ã –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π PWA)
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --exclude "*" \
            --include "*.html"

          # Service Worker –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
          aws s3 cp apps/web/dist/sw.js s3://${{ env.YC_BUCKET_PWA }}/sw.js \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/javascript"

          # Manifest –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (manifest.json ‚Üí —Ç–∞–∫–∂–µ –∫–æ–ø–∏—Ä—É–µ–º –∫–∞–∫ .webmanifest –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json"

          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.webmanifest \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json"

          # Version file –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
          aws s3 cp apps/web/dist/version.json s3://${{ env.YC_BUCKET_PWA }}/version.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json"

      - name: Deploy Landing to Yandex Object Storage
        run: |
          # === Landing Page ‚Üí heys-static bucket ===
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã (–±–µ–∑ --delete, —Ç.–∫. –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –≤ IAM)
          aws s3 sync apps/landing/out/ s3://${{ env.YC_BUCKET_LANDING }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html"

          # HTML —Ñ–∞–π–ª—ã –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
          aws s3 sync apps/landing/out/ s3://${{ env.YC_BUCKET_LANDING }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CDN cache (optional)
        continue-on-error: true
        env:
          YC_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_FOLDER: ${{ secrets.YC_FOLDER_ID }}
          # CDN Resource IDs (–∏–∑ infra/README.md)
          CDN_PWA_ID: bc8rvrvenqslkmti5yts
          CDN_LANDING_ID: bc8rk3pnqppsfime3nth
        run: |
          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
          if [ -z "$YC_TOKEN" ]; then
            echo "‚è≠Ô∏è Skipping CDN invalidation (no YC_OAUTH_TOKEN)"
            exit 0
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º YC CLI
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º
          yc config set token "$YC_TOKEN"
          yc config set folder-id "$YC_FOLDER"

          # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—É—Ç–∏ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã, –ù–ï wildcards - –æ–Ω–∏ –Ω–µ–Ω–∞–¥—ë–∂–Ω—ã)
          echo "üîÑ Purging CDN cache for PWA..."
          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/" --path "/index.html" --path "/sw.js" --path "/manifest.webmanifest" --path "/version.json" --path "/heys_app_v12.js" || true

          # –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî –í–°–ï–ì–î–ê –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º (152-–§–ó compliance)
          echo "üîÑ Purging legal docs from CDN cache..."
          DOCS_VERSION=$(node -e "const fs=require('fs'); const s=fs.readFileSync('apps/web/heys_consents_v1.js','utf8'); const m=s.match(/user_agreement:\\s*'([^']+)'/); process.stdout.write(m?m[1]:'');")
          echo "Legal docs version for purge: ${DOCS_VERSION:-unknown}"

          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/docs/user-agreement.md" \
            --path "/docs/privacy-policy.md" \
            --path "/docs/consent-forms.md" \
            --path "/docs/chat-rules.md" || true

          # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É—Ç–∏ (–µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ø—Ä–∏ –ø—Ä–∞–≤–∫–∞—Ö)
          if [ -n "$DOCS_VERSION" ]; then
            yc cdn cache purge --resource-id "$CDN_PWA_ID" \
              --path "/docs/v${DOCS_VERSION}/user-agreement.md" \
              --path "/docs/v${DOCS_VERSION}/privacy-policy.md" \
              --path "/docs/v${DOCS_VERSION}/consent-forms.md" \
              --path "/docs/v${DOCS_VERSION}/chat-rules.md" || true
          fi

          echo "üîÑ Purging CDN cache for Landing..."
          yc cdn cache purge --resource-id "$CDN_LANDING_ID" \
            --path "/" --path "/index.html" || true

          echo "‚úÖ CDN cache purged for critical paths"

      - name: Health check
        run: |
          echo "üè• Running health checks..."
          sleep 10

          PWA_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app.heyslab.ru/)
          LANDING_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://heyslab.ru/)
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.heyslab.ru/health)

          echo "PWA: $PWA_STATUS | Landing: $LANDING_STATUS | API: $API_STATUS"

          if [ "$PWA_STATUS" != "200" ]; then
            echo "‚ùå PWA health check failed"
            exit 1
          fi

          echo "‚úÖ Health checks passed"

      - name: Deployment summary
        run: |
          echo "## üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.BUILD_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Deployed URLs" >> $GITHUB_STEP_SUMMARY
          echo "| Site | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| PWA | https://app.heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | https://heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api.heyslab.ru |" >> $GITHUB_STEP_SUMMARY

  # –î–µ–ø–ª–æ–π Cloud Functions (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Ö —Ñ–∞–π–ª–æ–≤)
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç build-and-deploy
    if: ${{ github.event_name == 'workflow_dispatch' || contains(toJSON(github.event.commits.*.modified), 'yandex-cloud-functions/') || contains(toJSON(github.event.commits.*.added), 'yandex-cloud-functions/') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Check which functions changed
        id: changes
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files: $CHANGED"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ñ—É–Ω–∫—Ü–∏—é
          echo "rpc_changed=$([[ "$CHANGED" == *"heys-api-rpc"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "rest_changed=$([[ "$CHANGED" == *"heys-api-rest"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "sms_changed=$([[ "$CHANGED" == *"heys-api-sms"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "leads_changed=$([[ "$CHANGED" == *"heys-api-leads"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "auth_changed=$([[ "$CHANGED" == *"heys-api-auth"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Deploy heys-api-rpc
        if: steps.changes.outputs.rpc_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rpc
          yc serverless function version create \
            --function-name heys-api-rpc \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-rest
        if: steps.changes.outputs.rest_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rest
          yc serverless function version create \
            --function-name heys-api-rest \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-sms
        if: steps.changes.outputs.sms_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-sms
          yc serverless function version create \
            --function-name heys-api-sms \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path . \
            --environment "SMS_API_KEY=${{ secrets.SMS_API_KEY }}"

      - name: Deploy heys-api-leads
        if: steps.changes.outputs.leads_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-leads
          yc serverless function version create \
            --function-name heys-api-leads \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Deploy heys-api-auth
        if: steps.changes.outputs.auth_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-auth
          yc serverless function version create \
            --function-name heys-api-auth \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,JWT_SECRET=${{ secrets.JWT_SECRET }}"
