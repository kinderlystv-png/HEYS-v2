name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8"
  # Yandex Cloud Object Storage
  YC_BUCKET_PWA: heys-app # PWA Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ â†’ app.heyslab.ru
  YC_BUCKET_LANDING: heys-static # Ð›ÐµÐ½Ð´Ð¸Ð½Ð³ â†’ heyslab.ru
  YC_ENDPOINT: https://storage.yandexcloud.net

jobs:
  build-and-deploy:
    name: Build & Deploy to Yandex Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git commands
          submodules: false

      - name: Fix git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # TODO: Fix CI test environment (tests pass locally but fail in CI)
      # - name: Run critical tests
      #   run: |
      #     cd apps/web && pnpm run test -- \
      #       "__tests__/sync-race-condition.test.js" \
      #       "__tests__/merge-day-data.test.js" \
      #       "__tests__/auth-session.test.js" \
      #       "__tests__/storage-layer.test.js" \
      #       "__tests__/products-protection.test.js" \
      #       "__tests__/data-models.test.js"

      - name: Build web app (PWA)
        run: pnpm --filter @heys/web run build
        env:
          VITE_API_URL: https://api.heyslab.ru

      - name: Build landing page
        run: pnpm --filter @heys/landing run build

      - name: Generate build version
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M).${{ github.run_number }}
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Build version: $VERSION"
          # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ PWA
          echo "{\"version\":\"$VERSION\",\"buildTime\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"${{ github.sha }}\"}" > apps/web/dist/version.json

      - name: Configure AWS CLI for Yandex Cloud
        # AWS CLI ÑƒÐ¶Ðµ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð° ubuntu-latest!
        run: |
          aws configure set aws_access_key_id ${{ secrets.YC_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.YC_SECRET_ACCESS_KEY }}
          aws configure set default.region ru-central1

      - name: Deploy PWA to Yandex Object Storage
        run: |
          # === PWA Application â†’ heys-app bucket ===
          # GOLDEN STANDARD CACHING STRATEGY

          DOCS_VERSION=$(node -e "const fs=require('fs'); const s=fs.readFileSync('apps/web/heys_consents_v1.js','utf8'); const m=s.match(/user_agreement:\\s*'([^']+)'/); process.stdout.write(m?m[1]:'');")
          echo "ðŸ“œ Legal docs version: ${DOCS_VERSION:-unknown}"

          # === STEP 1: Immutable Assets (1 year cache) ===
          # Images, fonts, hashed assets in assets/ folder
          echo "ðŸ“¦ Uploading immutable assets..."
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --exclude "index.html" \
            --exclude "sw.js" \
            --exclude "version.json" \
            --exclude "manifest.json" \
            --exclude "manifest.webmanifest" \
            --exclude "heys_*.js" \
            --cache-control "public, max-age=31536000, immutable"

          # === STEP 2: Mutable JS Files (0 cache, must-revalidate) ===
          # These files change often but keep the same name
          echo "ðŸ“œ Updating mutable JS files (max-age=0)..."
          for jsfile in apps/web/dist/heys_*.js; do
            if [ -f "$jsfile" ]; then
              filename=$(basename "$jsfile")
              aws s3 cp "$jsfile" s3://${{ env.YC_BUCKET_PWA }}/$filename \
                --endpoint-url=${{ env.YC_ENDPOINT }} \
                --cache-control "public, max-age=0, must-revalidate" \
                --content-type "application/javascript" &
            fi
          done
          wait

          # === STEP 2.5: Widgets folder ===
          if [ -d "apps/web/dist/widgets" ]; then
            echo "ðŸ§© Uploading widgets folder..."
            aws s3 sync apps/web/dist/widgets/ s3://${{ env.YC_BUCKET_PWA }}/widgets/ \
              --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=0, must-revalidate"
          fi

          # === STEP 3: Entry Points (NO CACHE AT ALL) ===
          # index.html, sw.js, version.json - must always be fresh
          echo "ðŸ“„ Updating entry points (no-store)..."

          aws s3 cp apps/web/dist/index.html s3://${{ env.YC_BUCKET_PWA }}/index.html \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" &

          aws s3 cp apps/web/dist/sw.js s3://${{ env.YC_BUCKET_PWA }}/sw.js \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/javascript" &

          aws s3 cp apps/web/dist/version.json s3://${{ env.YC_BUCKET_PWA }}/version.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json" &

          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json" &

          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.webmanifest \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json" &

          wait

          # === STEP 4: Legal Docs ===
          if [ -n "$DOCS_VERSION" ] && [ -d "apps/web/dist/docs" ]; then
            echo "ðŸ“‹ Uploading legal docs..."
            # Versioned path (immutable)
            aws s3 cp apps/web/dist/docs/ s3://${{ env.YC_BUCKET_PWA }}/docs/v${DOCS_VERSION}/ \
              --recursive --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=31536000, immutable" &

            # Latest path (no-cache)
            aws s3 cp apps/web/dist/docs/ s3://${{ env.YC_BUCKET_PWA }}/docs/ \
              --recursive --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "no-cache, no-store, must-revalidate" &

            wait
          fi

          echo "âœ… PWA deployment complete!"

      - name: Deploy Landing to Yandex Object Storage
        run: |
          # === Landing Page â†’ heys-static bucket ===
          # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Next.js static export

          # STEP 1: Ð’ÑÑ‘ Ñ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ñ‹Ð¼ ÐºÑÑˆÐµÐ¼ (1 Ð³Ð¾Ð´)
          echo "ðŸ“¦ Landing: Uploading all files..."
          aws s3 sync apps/landing/out/ s3://${{ env.YC_BUCKET_LANDING }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "public, max-age=31536000, immutable"

          # STEP 2: HTML Ð±ÐµÐ· ÐºÑÑˆÐ° (Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾)
          echo "ðŸ“„ Landing: Updating HTML files (no-cache)..."
          for htmlfile in apps/landing/out/*.html apps/landing/out/**/*.html; do
            if [ -f "$htmlfile" ]; then
              relpath="${htmlfile#apps/landing/out/}"
              aws s3 cp "$htmlfile" "s3://${{ env.YC_BUCKET_LANDING }}/$relpath" \
                --endpoint-url=${{ env.YC_ENDPOINT }} \
                --cache-control "no-cache, no-store, must-revalidate" \
                --content-type "text/html; charset=utf-8" &
            fi
          done
          wait

          echo "âœ… Landing deployment complete!"

      - name: Invalidate CDN cache
        continue-on-error: true
        env:
          YC_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_FOLDER: ${{ secrets.YC_FOLDER_ID }}
          # CDN Resource IDs (Ð¸Ð· infra/README.md)
          CDN_PWA_ID: bc8rvrvenqslkmti5yts
          CDN_LANDING_ID: bc8rk3pnqppsfime3nth
        run: |
          # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ‚Ð¾ÐºÐµÐ½Ð°
          if [ -z "$YC_TOKEN" ]; then
            echo "â­ï¸ Skipping CDN invalidation (no YC_OAUTH_TOKEN)"
            exit 0
          fi

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ YC CLI
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€ÑƒÐµÐ¼
          yc config set token "$YC_TOKEN"
          yc config set folder-id "$YC_FOLDER"

          # === PWA CDN Invalidation ===
          echo "ðŸ”„ Purging CDN cache for PWA..."

          # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð±ÐµÐ· ÐºÑÑˆÐ°)
          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/" \
            --path "/index.html" \
            --path "/sw.js" \
            --path "/manifest.json" \
            --path "/manifest.webmanifest" \
            --path "/version.json" || true

          # Ð’Ð¡Ð• ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ JS Ñ„Ð°Ð¹Ð»Ñ‹ â€” Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº!
          echo "ðŸ”„ Purging all heys_*.js files..."
          JS_PATHS=""
          for jsfile in apps/web/dist/heys_*.js; do
            if [ -f "$jsfile" ]; then
              filename=$(basename "$jsfile")
              JS_PATHS="$JS_PATHS --path /$filename"
              echo "  â†’ /$filename"
            fi
          done

          if [ -n "$JS_PATHS" ]; then
            yc cdn cache purge --resource-id "$CDN_PWA_ID" $JS_PATHS || true
          fi

          # Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ â€” Ð’Ð¡Ð•Ð“Ð”Ð Ð¸Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ (152-Ð¤Ð— compliance)
          echo "ðŸ”„ Purging legal docs from CDN cache..."
          DOCS_VERSION=$(node -e "const fs=require('fs'); const s=fs.readFileSync('apps/web/heys_consents_v1.js','utf8'); const m=s.match(/user_agreement:\\s*'([^']+)'/); process.stdout.write(m?m[1]:'');")
          echo "  Legal docs version: ${DOCS_VERSION:-unknown}"

          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/docs/user-agreement.md" \
            --path "/docs/privacy-policy.md" \
            --path "/docs/consent-forms.md" \
            --path "/docs/chat-rules.md" || true

          # Ð’ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ ÑŽÑ€Ð¸Ð´Ð¸ÐºÐ¸
          if [ -n "$DOCS_VERSION" ]; then
            yc cdn cache purge --resource-id "$CDN_PWA_ID" \
              --path "/docs/v${DOCS_VERSION}/user-agreement.md" \
              --path "/docs/v${DOCS_VERSION}/privacy-policy.md" \
              --path "/docs/v${DOCS_VERSION}/consent-forms.md" \
              --path "/docs/v${DOCS_VERSION}/chat-rules.md" || true
          fi

          # === Landing CDN Invalidation ===
          echo "ðŸ”„ Purging CDN cache for Landing..."
          yc cdn cache purge --resource-id "$CDN_LANDING_ID" \
            --path "/" \
            --path "/index.html" || true

          echo "âœ… CDN cache purged for all critical paths"

      - name: Health check
        run: |
          echo "ðŸ¥ Running health checks..."

          # 1) Validate ORIGIN (Object Storage) â€” this is the real signal that deploy succeeded.
          PWA_ORIGIN_URL="${YC_ENDPOINT}/${YC_BUCKET_PWA}/index.html"
          LANDING_ORIGIN_URL="${YC_ENDPOINT}/${YC_BUCKET_LANDING}/index.html"
          API_URL="https://api.heyslab.ru/health"

          PWA_ORIGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PWA_ORIGIN_URL")
          LANDING_ORIGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$LANDING_ORIGIN_URL")
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")

          echo "Origin: PWA $PWA_ORIGIN_STATUS ($PWA_ORIGIN_URL)"
          echo "Origin: Landing $LANDING_ORIGIN_STATUS ($LANDING_ORIGIN_URL)"
          echo "API: $API_STATUS ($API_URL)"

          if [ "$PWA_ORIGIN_STATUS" != "200" ] || [ "$LANDING_ORIGIN_STATUS" != "200" ] || [ "$API_STATUS" != "200" ]; then
            echo "âŒ Origin/API health check failed (deployment likely broken)"
            exit 1
          fi

          # 2) Validate CDN â€” best effort. CDN propagation can lag by region and return cached 404.
          echo "â³ Waiting 10s for CDN propagation..."
          sleep 10

          MAX_RETRIES=3
          RETRY_DELAY=10
          CACHE_BUST="v=${BUILD_VERSION}&ts=$(date +%s)"

          PWA_CDN_URL="https://app.heyslab.ru/version.json?${CACHE_BUST}"
          LANDING_CDN_URL="https://heyslab.ru/?${CACHE_BUST}"

          CDN_OK=0
          for i in $(seq 1 $MAX_RETRIES); do
            PWA_CDN_STATUS=$(curl -s -H "Cache-Control: no-cache" -o /dev/null -w "%{http_code}" "$PWA_CDN_URL")
            LANDING_CDN_STATUS=$(curl -s -H "Cache-Control: no-cache" -o /dev/null -w "%{http_code}" "$LANDING_CDN_URL")

            echo "CDN attempt $i/$MAX_RETRIES: PWA $PWA_CDN_STATUS | Landing $LANDING_CDN_STATUS"

            if [ "$PWA_CDN_STATUS" = "200" ] && [ "$LANDING_CDN_STATUS" = "200" ]; then
              CDN_OK=1
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          if [ $CDN_OK -eq 1 ]; then
            echo "âœ… Health checks passed (origin + CDN)"
            exit 0
          fi

          echo "âš ï¸ CDN still not fully propagated in this runner region (origin is OK). Not failing deployment."
          exit 0

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.BUILD_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Deployed URLs" >> $GITHUB_STEP_SUMMARY
          echo "| Site | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| PWA | https://app.heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | https://heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api.heyslab.ru |" >> $GITHUB_STEP_SUMMARY

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Cloud Functions (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²)
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾, Ð½Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ build-and-deploy
    if: ${{ github.event_name == 'workflow_dispatch' || contains(toJSON(github.event.commits.*.modified), 'yandex-cloud-functions/') || contains(toJSON(github.event.commits.*.added), 'yandex-cloud-functions/') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ git diff HEAD~1

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Check which functions changed
        id: changes
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files: $CHANGED"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ
          echo "rpc_changed=$([[ "$CHANGED" == *"heys-api-rpc"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "rest_changed=$([[ "$CHANGED" == *"heys-api-rest"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "sms_changed=$([[ "$CHANGED" == *"heys-api-sms"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "leads_changed=$([[ "$CHANGED" == *"heys-api-leads"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "auth_changed=$([[ "$CHANGED" == *"heys-api-auth"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Deploy heys-api-rpc
        if: steps.changes.outputs.rpc_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rpc
          yc serverless function version create \
            --function-name heys-api-rpc \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-rest
        if: steps.changes.outputs.rest_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rest
          yc serverless function version create \
            --function-name heys-api-rest \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-sms
        if: steps.changes.outputs.sms_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-sms
          yc serverless function version create \
            --function-name heys-api-sms \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path . \
            --environment "SMS_API_KEY=${{ secrets.SMS_API_KEY }}"

      - name: Deploy heys-api-leads
        if: steps.changes.outputs.leads_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-leads
          yc serverless function version create \
            --function-name heys-api-leads \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Deploy heys-api-auth
        if: steps.changes.outputs.auth_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-auth
          yc serverless function version create \
            --function-name heys-api-auth \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,JWT_SECRET=${{ secrets.JWT_SECRET }}"
