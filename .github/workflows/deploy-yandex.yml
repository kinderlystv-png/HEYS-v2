name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8"
  # Yandex Cloud Object Storage
  YC_BUCKET_NAME: heys-static
  YC_ENDPOINT: https://storage.yandexcloud.net

jobs:
  build-and-deploy:
    name: Build & Deploy to Yandex Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run critical tests
        run: |
          cd apps/web && pnpm run test -- \
            "__tests__/sync-race-condition.test.js" \
            "__tests__/merge-day-data.test.js" \
            "__tests__/auth-session.test.js" \
            "__tests__/storage-layer.test.js" \
            "__tests__/products-protection.test.js" \
            "__tests__/data-models.test.js"

      - name: Build web app
        run: pnpm --filter @heys/web run build
        env:
          VITE_API_URL: https://api.heyslab.ru

      - name: Generate build version
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M).${{ github.run_number }}
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Build version: $VERSION"
          # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ PWA
          echo "{\"version\":\"$VERSION\",\"buildTime\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"${{ github.sha }}\"}" > apps/web/dist/version.json

      - name: Install AWS CLI (S3-compatible)
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update

      - name: Configure AWS CLI for Yandex Cloud
        run: |
          aws configure set aws_access_key_id ${{ secrets.YC_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.YC_SECRET_ACCESS_KEY }}
          aws configure set default.region ru-central1

      - name: Deploy to Yandex Object Storage
        run: |
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ (ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ, Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ)
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_NAME }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "sw.js" \
            --exclude "version.json" \
            --exclude "manifest.webmanifest"

          # HTML Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ PWA)
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_NAME }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --exclude "*" \
            --include "*.html"

          # Service Worker Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          aws s3 cp apps/web/dist/sw.js s3://${{ env.YC_BUCKET_NAME }}/sw.js \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/javascript"

          # Manifest Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ  
          aws s3 cp apps/web/dist/manifest.webmanifest s3://${{ env.YC_BUCKET_NAME }}/manifest.webmanifest \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json"

          # Version file Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          aws s3 cp apps/web/dist/version.json s3://${{ env.YC_BUCKET_NAME }}/version.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json"

      - name: Invalidate CDN cache (optional)
        if: ${{ secrets.YC_CDN_RESOURCE_ID != '' }}
        run: |
          # Ð•ÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ CDN, Ð¸Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.YC_IAM_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"paths": ["/*"]}' \
            "https://cdn.api.cloud.yandex.net/cdn/v1/resources/${{ secrets.YC_CDN_RESOURCE_ID }}:purge"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.BUILD_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket | ${{ env.YC_BUCKET_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://heys.app (pending DNS) |" >> $GITHUB_STEP_SUMMARY

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Cloud Functions (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸)
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: |
      contains(github.event.head_commit.modified, 'yandex-cloud-functions/') ||
      contains(github.event.head_commit.added, 'yandex-cloud-functions/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Deploy heys-api-rpc
        if: contains(github.event.head_commit.modified, 'heys-api-rpc/')
        run: |
          cd yandex-cloud-functions/heys-api-rpc
          yc serverless function version create \
            --function-name heys-api-rpc \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path .

      - name: Deploy heys-api-rest
        if: contains(github.event.head_commit.modified, 'heys-api-rest/')
        run: |
          cd yandex-cloud-functions/heys-api-rest
          yc serverless function version create \
            --function-name heys-api-rest \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path .
