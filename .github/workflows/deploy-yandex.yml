name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8"
  # Yandex Cloud Object Storage
  YC_BUCKET_PWA: heys-app # PWA Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ â†’ app.heyslab.ru
  YC_BUCKET_LANDING: heys-static # Ð›ÐµÐ½Ð´Ð¸Ð½Ð³ â†’ heyslab.ru
  YC_ENDPOINT: https://storage.yandexcloud.net

jobs:
  build-and-deploy:
    name: Build & Deploy to Yandex Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Ð”Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # TODO: Fix CI test environment (tests pass locally but fail in CI)
      # - name: Run critical tests
      #   run: |
      #     cd apps/web && pnpm run test -- \
      #       "__tests__/sync-race-condition.test.js" \
      #       "__tests__/merge-day-data.test.js" \
      #       "__tests__/auth-session.test.js" \
      #       "__tests__/storage-layer.test.js" \
      #       "__tests__/products-protection.test.js" \
      #       "__tests__/data-models.test.js"

      - name: Build web app (PWA)
        run: pnpm --filter @heys/web run build
        env:
          VITE_API_URL: https://api.heyslab.ru

      - name: Build landing page
        run: pnpm --filter @heys/landing run build

      - name: Generate build version
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M).${{ github.run_number }}
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Build version: $VERSION"
          # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ PWA
          echo "{\"version\":\"$VERSION\",\"buildTime\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"${{ github.sha }}\"}" > apps/web/dist/version.json

      - name: Install AWS CLI (S3-compatible)
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update

      - name: Configure AWS CLI for Yandex Cloud
        run: |
          aws configure set aws_access_key_id ${{ secrets.YC_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.YC_SECRET_ACCESS_KEY }}
          aws configure set default.region ru-central1

      - name: Deploy PWA to Yandex Object Storage
        run: |
          # === PWA Application â†’ heys-app bucket ===
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ (ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ, Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ)
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "sw.js" \
            --exclude "version.json" \
            --exclude "manifest.json"

          # HTML Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ PWA)
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --exclude "*" \
            --include "*.html"

          # Service Worker Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          aws s3 cp apps/web/dist/sw.js s3://${{ env.YC_BUCKET_PWA }}/sw.js \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/javascript"

          # Manifest Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (manifest.json â†’ Ñ‚Ð°ÐºÐ¶Ðµ ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ðº .webmanifest Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json"

          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.webmanifest \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json"

          # Version file Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          aws s3 cp apps/web/dist/version.json s3://${{ env.YC_BUCKET_PWA }}/version.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json"

      - name: Deploy Landing to Yandex Object Storage
        run: |
          # === Landing Page â†’ heys-static bucket ===
          aws s3 sync apps/landing/out/ s3://${{ env.YC_BUCKET_LANDING }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html"

          # HTML Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÐµÐ· ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          aws s3 sync apps/landing/out/ s3://${{ env.YC_BUCKET_LANDING }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CDN cache (optional)
        continue-on-error: true
        env:
          YC_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_FOLDER: ${{ secrets.YC_FOLDER_ID }}
          # CDN Resource IDs (Ð¸Ð· infra/README.md)
          CDN_PWA_ID: bc8rvrvenqslkmti5yts
          CDN_LANDING_ID: bc8rk3pnqppsfime3nth
        run: |
          # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ‚Ð¾ÐºÐµÐ½Ð°
          if [ -z "$YC_TOKEN" ]; then
            echo "â­ï¸ Skipping CDN invalidation (no YC_OAUTH_TOKEN)"
            exit 0
          fi

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ YC CLI
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€ÑƒÐµÐ¼
          yc config set token "$YC_TOKEN"
          yc config set folder-id "$YC_FOLDER"

          # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ (Ð½Ðµ Ð²ÐµÑÑŒ ÐºÑÑˆ)
          echo "ðŸ”„ Purging CDN cache for PWA..."
          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/" --path "/index.html" --path "/sw.js" --path "/manifest.webmanifest" || true

          echo "ðŸ”„ Purging CDN cache for Landing..."
          yc cdn cache purge --resource-id "$CDN_LANDING_ID" \
            --path "/" --path "/index.html" || true

          echo "âœ… CDN cache purged for critical paths"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.BUILD_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Deployed URLs" >> $GITHUB_STEP_SUMMARY
          echo "| Site | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| PWA | https://app.heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | https://heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api.heyslab.ru |" >> $GITHUB_STEP_SUMMARY

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Cloud Functions (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²)
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾, Ð½Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ build-and-deploy
    if: ${{ github.event_name == 'workflow_dispatch' || contains(toJSON(github.event.commits.*.modified), 'yandex-cloud-functions/') || contains(toJSON(github.event.commits.*.added), 'yandex-cloud-functions/') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Check which functions changed
        id: changes
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files: $CHANGED"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ
          echo "rpc_changed=$([[ "$CHANGED" == *"heys-api-rpc"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "rest_changed=$([[ "$CHANGED" == *"heys-api-rest"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "sms_changed=$([[ "$CHANGED" == *"heys-api-sms"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "leads_changed=$([[ "$CHANGED" == *"heys-api-leads"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "auth_changed=$([[ "$CHANGED" == *"heys-api-auth"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Deploy heys-api-rpc
        if: steps.changes.outputs.rpc_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rpc
          yc serverless function version create \
            --function-name heys-api-rpc \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-rest
        if: steps.changes.outputs.rest_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rest
          yc serverless function version create \
            --function-name heys-api-rest \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-sms
        if: steps.changes.outputs.sms_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-sms
          yc serverless function version create \
            --function-name heys-api-sms \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path . \
            --environment "SMS_API_KEY=${{ secrets.SMS_API_KEY }}"

      - name: Deploy heys-api-leads
        if: steps.changes.outputs.leads_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-leads
          yc serverless function version create \
            --function-name heys-api-leads \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Deploy heys-api-auth
        if: steps.changes.outputs.auth_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-auth
          yc serverless function version create \
            --function-name heys-api-auth \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,JWT_SECRET=${{ secrets.JWT_SECRET }}"
