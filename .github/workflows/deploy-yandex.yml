name: Deploy to Yandex Cloud

on:
  push:
    branches: [main]
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8"
  # Yandex Cloud Object Storage
  YC_BUCKET_PWA: heys-app # PWA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí app.heyslab.ru
  YC_BUCKET_LANDING: heys-static # –õ–µ–Ω–¥–∏–Ω–≥ ‚Üí heyslab.ru (CDN origin: heys-static.website.yandexcloud.net)
  YC_ENDPOINT: https://storage.yandexcloud.net

jobs:
  build-and-deploy:
    name: Build & Deploy to Yandex Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git commands
          submodules: false

      - name: Fix git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Turbo cache –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã—Ö —Å–±–æ—Ä–æ–∫
      - name: Setup Turbo cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # TODO: Fix CI test environment (tests pass locally but fail in CI)
      # - name: Run critical tests
      #   run: |
      #     cd apps/web && pnpm run test -- \
      #       "__tests__/sync-race-condition.test.js" \
      #       "__tests__/merge-day-data.test.js" \
      #       "__tests__/auth-session.test.js" \
      #       "__tests__/storage-layer.test.js" \
      #       "__tests__/products-protection.test.js" \
      #       "__tests__/data-models.test.js"

      # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ PWA –∏ Landing —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π exit codes
      - name: Build apps (parallel)
        run: |
          set -e  # Exit on first error

          # –ó–∞–ø—É—Å–∫ –±–∏–ª–¥–æ–≤ –≤ background
          pnpm --filter @heys/web run build &
          PID_PWA=$!
          pnpm --filter @heys/landing run build &
          PID_LANDING=$!

          # –ñ–¥—ë–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º exit codes –ö–ê–ñ–î–û–ì–û –ø—Ä–æ—Ü–µ—Å—Å–∞
          FAIL=0
          wait $PID_PWA || { echo "‚ùå PWA build FAILED!"; FAIL=1; }
          wait $PID_LANDING || { echo "‚ùå Landing build FAILED!"; FAIL=1; }

          if [ $FAIL -eq 1 ]; then
            echo "::error::One or more builds failed!"
            exit 1
          fi

          echo "‚úÖ Both builds completed successfully"
        env:
          VITE_API_URL: https://api.heyslab.ru

      # üõ°Ô∏è –ó–ê–©–ò–¢–ê: –í–∞–ª–∏–¥–∞—Ü–∏—è —á—Ç–æ PWA build —Å–æ–∑–¥–∞–ª –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
      - name: Validate PWA build output
        run: |
          echo "üîç Validating PWA build output..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ dist —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -d "apps/web/dist" ]; then
            echo "::error::apps/web/dist directory not found!"
            exit 1
          fi

          # –°—á–∏—Ç–∞–µ–º heys_*.js —Ñ–∞–π–ª—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 50)
          JS_COUNT=$(ls -1 apps/web/dist/heys_*.js 2>/dev/null | wc -l)
          echo "üì¶ Found $JS_COUNT heys_*.js files in dist"

          if [ "$JS_COUNT" -lt 50 ]; then
            echo "::error::Expected at least 50 heys_*.js files, found only $JS_COUNT!"
            echo "This usually means the build failed silently."
            echo "Check that all dependencies are installed (e.g., esbuild)."
            ls -la apps/web/dist/ | head -20
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
          CRITICAL_FILES=(
            "apps/web/dist/heys_app_v12.js"
            "apps/web/dist/heys_core_v12.js"
            "apps/web/dist/heys_day_v12.js"
            "apps/web/dist/heys_add_product_step_v1.js"
            "apps/web/dist/index.html"
            "apps/web/dist/version.json"
          )

          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::Critical file missing: $file"
              exit 1
            fi
          done

          echo "‚úÖ PWA build validation passed ($JS_COUNT JS files)"

      - name: Ensure SW from public
        run: |
          if [ -f apps/web/public/sw.js ]; then
            cp apps/web/public/sw.js apps/web/dist/sw.js
            echo "‚úÖ Copied public/sw.js to dist/sw.js"
          else
            echo "‚ùå apps/web/public/sw.js not found"
            exit 1
          fi

      - name: Read build version from generated file
        run: |
          # version.json —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ prebuild —Å–∫—Ä–∏–ø—Ç–æ–º update-version.cjs
          # –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ ‚Äî –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º –¥–ª—è –ª–æ–≥–æ–≤ –∏ summary
          if [ -f apps/web/dist/version.json ]; then
            VERSION=$(cat apps/web/dist/version.json | jq -r '.version')
            echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
            echo "‚úÖ Build version from prebuild: $VERSION"
            cat apps/web/dist/version.json
          else
            echo "‚ö†Ô∏è version.json not found, using fallback"
            VERSION=$(date +%Y.%m.%d.%H%M).${{ github.run_number }}
            echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
            echo "{\"version\":\"$VERSION\",\"buildTime\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"${{ github.sha }}\"}" > apps/web/dist/version.json
          fi

      - name: Read SW cache version
        run: |
          if [ -f apps/web/dist/sw.js ]; then
            CACHE_VERSION=$(node -e "const fs=require('fs');const s=fs.readFileSync('apps/web/dist/sw.js','utf8');const m=s.match(/const CACHE_VERSION = '([^']+)'/);process.stdout.write(m?m[1]:'');")
            echo "SW_CACHE_VERSION=$CACHE_VERSION" >> $GITHUB_ENV
            echo "‚úÖ SW cache version: $CACHE_VERSION"
          else
            echo "‚ö†Ô∏è sw.js not found in dist"
            echo "SW_CACHE_VERSION=unknown" >> $GITHUB_ENV
          fi

      - name: Configure AWS CLI for Yandex Cloud
        # AWS CLI —É–∂–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ubuntu-latest!
        run: |
          aws configure set aws_access_key_id ${{ secrets.YC_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.YC_SECRET_ACCESS_KEY }}
          aws configure set default.region ru-central1

      - name: Deploy PWA to Yandex Object Storage
        run: |
          # === PWA Application ‚Üí heys-app bucket ===
          # GOLDEN STANDARD CACHING STRATEGY

          DOCS_VERSION=$(node -e "const fs=require('fs'); const s=fs.readFileSync('apps/web/heys_consents_v1.js','utf8'); const m=s.match(/user_agreement:\\s*'([^']+)'/); process.stdout.write(m?m[1]:'');")
          echo "üìú Legal docs version: ${DOCS_VERSION:-unknown}"

          # === STEP 1: Immutable Assets (1 year cache) ===
          # Images, fonts, hashed assets in assets/ folder
          echo "üì¶ Uploading immutable assets..."
          aws s3 sync apps/web/dist/ s3://${{ env.YC_BUCKET_PWA }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --exclude "index.html" \
            --exclude "sw.js" \
            --exclude "version.json" \
            --exclude "manifest.json" \
            --exclude "manifest.webmanifest" \
            --exclude "heys_*.js" \
            --exclude "react-bundle.js" \
            --exclude "day/*" \
            --exclude "advice/*" \
            --cache-control "public, max-age=31536000, immutable"

          # === STEP 2: Mutable JS Files (0 cache, must-revalidate) ===
          # These files change often but keep the same name
          echo "üìú Updating mutable JS files (max-age=0)..."
          JS_UPLOAD_COUNT=0
          for jsfile in apps/web/dist/heys_*.js; do
            if [ -f "$jsfile" ]; then
              filename=$(basename "$jsfile")
              aws s3 cp "$jsfile" s3://${{ env.YC_BUCKET_PWA }}/$filename \
                --endpoint-url=${{ env.YC_ENDPOINT }} \
                --cache-control "public, max-age=0, must-revalidate" \
                --content-type "application/javascript" &
              JS_UPLOAD_COUNT=$((JS_UPLOAD_COUNT + 1))
            fi
          done
          wait

          # üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Ä–µ–∞–ª—å–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
          if [ "$JS_UPLOAD_COUNT" -lt 50 ]; then
            echo "::error::Only $JS_UPLOAD_COUNT heys_*.js files were uploaded (expected 50+)!"
            echo "Build likely failed silently. Check build logs."
            exit 1
          fi
          echo "‚úÖ Uploaded $JS_UPLOAD_COUNT heys_*.js files"

          # === STEP 2.1: React bundle (critical, no cache) ===
          if [ -f "apps/web/dist/react-bundle.js" ]; then
            echo "‚öõÔ∏è Uploading react-bundle.js..."
            aws s3 cp apps/web/dist/react-bundle.js s3://${{ env.YC_BUCKET_PWA }}/react-bundle.js \
              --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=0, must-revalidate" \
              --content-type "application/javascript"
          fi

          # === STEP 2.5: Widgets folder ===
          if [ -d "apps/web/dist/widgets" ]; then
            echo "üß© Uploading widgets folder..."
            aws s3 sync apps/web/dist/widgets/ s3://${{ env.YC_BUCKET_PWA }}/widgets/ \
              --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=0, must-revalidate"
          fi

          # === STEP 2.6: Insights folder (modular Predictive Insights) ===
          if [ -d "apps/web/dist/insights" ]; then
            echo "üß† Uploading insights folder (15 pi_*.js modules)..."
            aws s3 sync apps/web/dist/insights/ s3://${{ env.YC_BUCKET_PWA }}/insights/ \
              --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=0, must-revalidate"
          fi

          # === STEP 2.7: Day folder (modular day components) ===
          if [ -d "apps/web/dist/day" ]; then
            echo "üìÖ Uploading day folder (modular _*.js components)..."
            aws s3 sync apps/web/dist/day/ s3://${{ env.YC_BUCKET_PWA }}/day/ \
              --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=0, must-revalidate"
          fi

          # === STEP 2.8: Advice folder (modular advice rules) ===
          if [ -d "apps/web/dist/advice" ]; then
            echo "üí° Uploading advice folder (modular _*.js rules)..."
            aws s3 sync apps/web/dist/advice/ s3://${{ env.YC_BUCKET_PWA }}/advice/ \
              --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=0, must-revalidate"
          fi

          # === STEP 3: Entry Points (NO CACHE AT ALL) ===
          # index.html, sw.js, version.json - must always be fresh
          echo "üìÑ Updating entry points (no-store)..."

          aws s3 cp apps/web/dist/index.html s3://${{ env.YC_BUCKET_PWA }}/index.html \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8" &

          aws s3 cp apps/web/dist/sw.js s3://${{ env.YC_BUCKET_PWA }}/sw.js \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/javascript" &

          aws s3 cp apps/web/dist/version.json s3://${{ env.YC_BUCKET_PWA }}/version.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/json" &

          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.json \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json" &

          aws s3 cp apps/web/dist/manifest.json s3://${{ env.YC_BUCKET_PWA }}/manifest.webmanifest \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "application/manifest+json" &

          wait

          # === STEP 4: Legal Docs ===
          if [ -n "$DOCS_VERSION" ] && [ -d "apps/web/dist/docs" ]; then
            echo "üìã Uploading legal docs..."
            # Versioned path (immutable)
            aws s3 cp apps/web/dist/docs/ s3://${{ env.YC_BUCKET_PWA }}/docs/v${DOCS_VERSION}/ \
              --recursive --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "public, max-age=31536000, immutable" &

            # Latest path (no-cache)
            aws s3 cp apps/web/dist/docs/ s3://${{ env.YC_BUCKET_PWA }}/docs/ \
              --recursive --endpoint-url=${{ env.YC_ENDPOINT }} \
              --cache-control "no-cache, no-store, must-revalidate" &

            wait
          fi

          echo "‚úÖ PWA deployment complete!"

      - name: Deploy Landing to Yandex Object Storage
        run: |
          # === Landing Page ‚Üí heys-static bucket ===
          # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π Next.js static export

          # STEP 1: –í—Å—ë —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∫—ç—à–µ–º (1 –≥–æ–¥)
          echo "üì¶ Landing: Uploading all files..."
          aws s3 sync apps/landing/out/ s3://${{ env.YC_BUCKET_LANDING }}/ \
            --endpoint-url=${{ env.YC_ENDPOINT }} \
            --cache-control "public, max-age=31536000, immutable"

          # STEP 2: HTML –±–µ–∑ –∫—ç—à–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
          echo "üìÑ Landing: Updating HTML files (no-cache)..."
          for htmlfile in apps/landing/out/*.html apps/landing/out/**/*.html; do
            if [ -f "$htmlfile" ]; then
              relpath="${htmlfile#apps/landing/out/}"
              aws s3 cp "$htmlfile" "s3://${{ env.YC_BUCKET_LANDING }}/$relpath" \
                --endpoint-url=${{ env.YC_ENDPOINT }} \
                --cache-control "no-cache, no-store, must-revalidate" \
                --content-type "text/html; charset=utf-8" &
            fi
          done
          wait

          echo "‚úÖ Landing deployment complete!"

      - name: Invalidate CDN cache
        continue-on-error: true
        env:
          YC_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_FOLDER: ${{ secrets.YC_FOLDER_ID }}
          # CDN Resource IDs (–∏–∑ infra/README.md)
          CDN_PWA_ID: bc8rvrvenqslkmti5yts
          CDN_LANDING_ID: bc8rk3pnqppsfime3nth
        run: |
          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
          if [ -z "$YC_TOKEN" ]; then
            echo "‚è≠Ô∏è Skipping CDN invalidation (no YC_OAUTH_TOKEN)"
            exit 0
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º YC CLI
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º
          yc config set token "$YC_TOKEN"
          yc config set folder-id "$YC_FOLDER"

          # === PWA CDN Invalidation ===
          echo "üîÑ Purging CDN cache for PWA..."

          # –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã (–±–µ–∑ –∫—ç—à–∞)
          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/" \
            --path "/index.html" \
            --path "/sw.js" \
            --path "/manifest.json" \
            --path "/manifest.webmanifest" \
            --path "/version.json" || true

          # –í–°–ï –∫–∞—Å—Ç–æ–º–Ω—ã–µ JS —Ñ–∞–π–ª—ã ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫!
          echo "üîÑ Purging all heys_*.js files..."
          JS_PATHS=""
          for jsfile in apps/web/dist/heys_*.js; do
            if [ -f "$jsfile" ]; then
              filename=$(basename "$jsfile")
              JS_PATHS="$JS_PATHS --path /$filename"
              echo "  ‚Üí /$filename"
            fi
          done

          if [ -n "$JS_PATHS" ]; then
            yc cdn cache purge --resource-id "$CDN_PWA_ID" $JS_PATHS || true
          fi

          # –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî –í–°–ï–ì–î–ê –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º (152-–§–ó compliance)
          echo "üîÑ Purging legal docs from CDN cache..."
          DOCS_VERSION=$(node -e "const fs=require('fs'); const s=fs.readFileSync('apps/web/heys_consents_v1.js','utf8'); const m=s.match(/user_agreement:\\s*'([^']+)'/); process.stdout.write(m?m[1]:'');")
          echo "  Legal docs version: ${DOCS_VERSION:-unknown}"

          yc cdn cache purge --resource-id "$CDN_PWA_ID" \
            --path "/docs/user-agreement.md" \
            --path "/docs/privacy-policy.md" \
            --path "/docs/consent-forms.md" \
            --path "/docs/chat-rules.md" || true

          # –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É—Ç–∏ —é—Ä–∏–¥–∏–∫–∏
          if [ -n "$DOCS_VERSION" ]; then
            yc cdn cache purge --resource-id "$CDN_PWA_ID" \
              --path "/docs/v${DOCS_VERSION}/user-agreement.md" \
              --path "/docs/v${DOCS_VERSION}/privacy-policy.md" \
              --path "/docs/v${DOCS_VERSION}/consent-forms.md" \
              --path "/docs/v${DOCS_VERSION}/chat-rules.md" || true
          fi

          # === Landing CDN Invalidation ===
          echo "üîÑ Purging CDN cache for Landing..."
          yc cdn cache purge --resource-id "$CDN_LANDING_ID" \
            --path "/" \
            --path "/index.html" || true

          echo "‚úÖ CDN cache purged for all critical paths"

      - name: Health check
        run: |
          echo "üè• Running health checks..."

          # Validate ORIGIN (Object Storage) ‚Äî this is the real signal that deploy succeeded.
          PWA_ORIGIN_URL="${YC_ENDPOINT}/${YC_BUCKET_PWA}/index.html"
          LANDING_ORIGIN_URL="${YC_ENDPOINT}/${YC_BUCKET_LANDING}/index.html"
          API_URL="https://api.heyslab.ru/health"

          PWA_ORIGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PWA_ORIGIN_URL")
          LANDING_ORIGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$LANDING_ORIGIN_URL")
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")

          echo "Origin: PWA $PWA_ORIGIN_STATUS | Landing $LANDING_ORIGIN_STATUS | API $API_STATUS"

          if [ "$PWA_ORIGIN_STATUS" != "200" ] || [ "$LANDING_ORIGIN_STATUS" != "200" ] || [ "$API_STATUS" != "200" ]; then
            echo "‚ùå Origin/API health check failed"
            exit 1
          fi

          echo "‚úÖ Health checks passed (origin OK, CDN propagation is async)"

      - name: Deployment summary
        run: |
          echo "## üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.BUILD_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SW Cache Version | ${{ env.SW_CACHE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üßæ version.json" >> $GITHUB_STEP_SUMMARY
          if [ -f apps/web/dist/version.json ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat apps/web/dist/version.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "version.json missing in dist" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Deployed URLs" >> $GITHUB_STEP_SUMMARY
          echo "| Site | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| PWA | https://app.heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | https://heyslab.ru |" >> $GITHUB_STEP_SUMMARY
          echo "| API | https://api.heyslab.ru |" >> $GITHUB_STEP_SUMMARY

  # –î–µ–ø–ª–æ–π Cloud Functions (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Ö —Ñ–∞–π–ª–æ–≤)
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    # –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è ‚Äî —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —à–∞–≥–æ–≤
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # –ù—É–∂–Ω–æ –¥–ª—è git diff HEAD~1

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Check which functions changed
        id: changes
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files: $CHANGED"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ñ—É–Ω–∫—Ü–∏—é
          echo "rpc_changed=$([[ "$CHANGED" == *"heys-api-rpc"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "rest_changed=$([[ "$CHANGED" == *"heys-api-rest"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "sms_changed=$([[ "$CHANGED" == *"heys-api-sms"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "leads_changed=$([[ "$CHANGED" == *"heys-api-leads"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "auth_changed=$([[ "$CHANGED" == *"heys-api-auth"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Deploy heys-api-rpc
        if: steps.changes.outputs.rpc_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rpc
          # Pre-deploy safety checks
          if [ ! -f "shared/db-pool.js" ]; then
            echo "‚ùå FATAL: shared/db-pool.js missing! Deploy would break the function."
            echo "   Ensure shared/ is tracked in git (not in .gitignore)"
            exit 1
          fi
          if [ ! -f "package.json" ]; then
            echo "‚ùå FATAL: package.json missing!"
            exit 1
          fi
          # Build environment string, skipping empty secrets
          ENV_VARS="PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then ENV_VARS="${ENV_VARS},JWT_SECRET=${{ secrets.JWT_SECRET }}"; fi
          if [ -n "${{ secrets.HEYS_ENCRYPTION_KEY }}" ]; then ENV_VARS="${ENV_VARS},HEYS_ENCRYPTION_KEY=${{ secrets.HEYS_ENCRYPTION_KEY }}"; fi
          yc serverless function version create \
            --function-name heys-api-rpc \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "$ENV_VARS"
          # Post-deploy health check
          sleep 10
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            'https://api.heyslab.ru/rpc?fn=get_shared_products' \
            -H 'Content-Type: application/json' \
            -H 'Origin: https://app.heyslab.ru' -d '{}' --max-time 30)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è Post-deploy health check returned HTTP $HTTP_CODE (may need cold start)"
          else
            echo "‚úÖ Health check passed"
          fi

      - name: Deploy heys-api-rest
        if: steps.changes.outputs.rest_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-rest
          yc serverless function version create \
            --function-name heys-api-rest \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"

      - name: Deploy heys-api-sms
        if: steps.changes.outputs.sms_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-sms
          yc serverless function version create \
            --function-name heys-api-sms \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path . \
            --environment "SMS_API_KEY=${{ secrets.SMS_API_KEY }}"

      - name: Deploy heys-api-leads
        if: steps.changes.outputs.leads_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-leads
          yc serverless function version create \
            --function-name heys-api-leads \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Deploy heys-api-auth
        if: steps.changes.outputs.auth_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd yandex-cloud-functions/heys-api-auth
          ENV_VARS="PG_HOST=${{ secrets.PG_HOST }},PG_PORT=6432,PG_DATABASE=heys_production,PG_USER=${{ secrets.PG_USER }},PG_PASSWORD=${{ secrets.PG_PASSWORD }},PG_SSL=verify-full"
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then ENV_VARS="${ENV_VARS},JWT_SECRET=${{ secrets.JWT_SECRET }}"; fi
          yc serverless function version create \
            --function-name heys-api-auth \
            --runtime nodejs18 \
            --entrypoint index.handler \
            --memory 256m \
            --execution-timeout 30s \
            --source-path . \
            --environment "$ENV_VARS"
