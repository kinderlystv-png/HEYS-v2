/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_smart_search.js (566 —Å—Ç—Ä–æ–∫)                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üèóÔ∏è –ö–õ–ê–°–° SmartSearchEngine (—Å—Ç—Ä–æ–∫–∏ 1-80):                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ constructor() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (9-30)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ index, documents Maps (11-12)                                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ stopWords Set (13-16)                                                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ config –æ–±—ä–µ–∫—Ç (17-25)                                                            ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞ (26-40)                                                 ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìö –ò–ù–î–ï–ö–°–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–û–í (—Å—Ç—Ä–æ–∫–∏ 81-200):                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ addDocument() - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (41-70)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ removeDocument() - —É–¥–∞–ª–µ–Ω–∏–µ (71-90)                                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ updateDocument() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (91-110)                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ tokenize() - —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (111-140)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ stemWord() - —Å—Ç–µ–º–º–∏–Ω–≥ —Å–ª–æ–≤ (141-160)                                             ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ buildIndex() - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ (161-200)                                      ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîç –û–°–ù–û–í–ù–û–ô –ü–û–ò–°–ö (—Å—Ç—Ä–æ–∫–∏ 201-350):                                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ search() - –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ (201-250)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ exactSearch() - —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ (251-280)                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ fuzzySearch() - –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫ (281-310)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ phraseSearch() - –ø–æ–∏—Å–∫ —Ñ—Ä–∞–∑ (311-330)                                            ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ booleanSearch() - –±—É–ª–µ–≤ –ø–æ–∏—Å–∫ (331-350)                                          ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìä –†–ê–ù–ñ–ò–†–û–í–ê–ù–ò–ï –ò –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨ (—Å—Ç—Ä–æ–∫–∏ 351-450):                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ calculateRelevance() - —Ä–∞—Å—á–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (351-390)                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ tfIdf() - TF-IDF —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ (391-420)                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ boostByPosition() - –±—É—Å—Ç –ø–æ –ø–æ–∑–∏—Ü–∏–∏ (421-440)                                    ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ sortResults() - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (441-450)                                 ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üéØ –ü–†–û–î–í–ò–ù–£–¢–´–ï –§–£–ù–ö–¶–ò–ò (—Å—Ç—Ä–æ–∫–∏ 451-520):                                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ suggest() - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ (451-480)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ autocomplete() - –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ (481-500)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ highlightMatches() - –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (501-510)                              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ getSearchStats() - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞ (511-520)                                   ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîó –£–¢–ò–õ–ò–¢–´ –ò –≠–ö–°–ü–û–†–¢ (—Å—Ç—Ä–æ–∫–∏ 521-566):                                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ clearIndex() - –æ—á–∏—Å—Ç–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ (521-530)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ exportIndex() - —ç–∫—Å–ø–æ—Ä—Ç –∏–Ω–¥–µ–∫—Å–∞ (531-540)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ importIndex() - –∏–º–ø–æ—Ä—Ç –∏–Ω–¥–µ–∫—Å–∞ (541-550)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.SmartSearch —ç–∫—Å–ø–æ—Ä—Ç (551-560)                                               ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (561-566)                                           ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ö–ª–∞—Å—Å: SmartSearchEngine (9), search() (201)                                      ‚îÇ
‚îÇ    ‚Ä¢ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è: addDocument() (41), tokenize() (111), buildIndex() (161)              ‚îÇ
‚îÇ    ‚Ä¢ –ü–æ–∏—Å–∫: exactSearch() (251), fuzzySearch() (281), phraseSearch() (311)             ‚îÇ
‚îÇ    ‚Ä¢ –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ: calculateRelevance() (351), tfIdf() (391)                           ‚îÇ
‚îÇ    ‚Ä¢ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ: suggest() (451), autocomplete() (481)                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

/**
 * HEYS Smart Search Engine v1.0
 * –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º
 * 
 * @author HEYS Development Team
 * @date 26.08.2025
 */

class SmartSearchEngine {
    constructor(config = {}) {
        this.index = new Map();
        this.documents = new Map();
        this.stopWords = new Set([
            '–∏', '–≤', '–Ω–∞', '—Å', '–ø–æ', '–¥–ª—è', '–æ—Ç', '–¥–æ', '–∏–∑', '–∫', '–æ', '—É', '–∑–∞', '–ø–æ–¥', '–Ω–∞–¥', '–ø—Ä–∏', '–±–µ–∑',
            'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from'
        ]);
        this.config = {
            minWordLength: 2,
            maxResults: 50,
            fuzzyThreshold: 0.7,
            enableFuzzy: true,
            rankingWeights: {
                exactMatch: 10,
                titleMatch: 5,
                contentMatch: 1,
                fuzzyMatch: 0.5
            },
            ...config
        };
        this.isReady = false;
        this.stats = {
            documentsIndexed: 0,
            searchesPerformed: 0,
            averageSearchTime: 0,
            totalWords: 0
        };
        
        console.log('üîç SmartSearchEngine initialized');
    }

    /**
     * –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
     * @param {Array} dataSet - –º–∞—Å—Å–∏–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
     * @param {Object} options - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
     */
    async indexData(dataSet, options = {}) {
        console.log('üîÑ Starting data indexation...');
        const startTime = performance.now();
        
        const fieldMap = {
            title: options.titleField || 'title',
            content: options.contentField || 'content',
            id: options.idField || 'id',
            tags: options.tagsField || 'tags',
            category: options.categoryField || 'category'
        };

        this.clearIndex();

        for (const doc of dataSet) {
            await this.indexDocument(doc, fieldMap);
        }

        this.isReady = true;
        const indexTime = performance.now() - startTime;
        
        this.stats.documentsIndexed = dataSet.length;
        
        console.log(`‚úÖ Indexed ${dataSet.length} documents in ${indexTime.toFixed(2)}ms`);
        return {
            documentsIndexed: dataSet.length,
            totalWords: this.stats.totalWords,
            indexTime: indexTime
        };
    }

    /**
     * –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    async indexDocument(doc, fieldMap) {
        const docId = doc[fieldMap.id] || `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        this.documents.set(docId, {
            id: docId,
            title: doc[fieldMap.title] || '',
            content: doc[fieldMap.content] || '',
            tags: doc[fieldMap.tags] || [],
            category: doc[fieldMap.category] || '',
            originalDoc: doc
        });

        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (doc[fieldMap.title]) {
            this.indexText(doc[fieldMap.title], docId, 'title');
        }

        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        if (doc[fieldMap.content]) {
            this.indexText(doc[fieldMap.content], docId, 'content');
        }

        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º —Ç–µ–≥–∏
        if (doc[fieldMap.tags] && Array.isArray(doc[fieldMap.tags])) {
            doc[fieldMap.tags].forEach(tag => {
                this.indexText(tag, docId, 'tag');
            });
        }

        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        if (doc[fieldMap.category]) {
            this.indexText(doc[fieldMap.category], docId, 'category');
        }
    }

    /**
     * –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
     */
    indexText(text, docId, field) {
        const words = this.tokenize(text);
        
        words.forEach(word => {
            if (!this.index.has(word)) {
                this.index.set(word, new Map());
            }
            
            const wordIndex = this.index.get(word);
            if (!wordIndex.has(docId)) {
                wordIndex.set(docId, {
                    count: 0,
                    fields: new Set(),
                    positions: []
                });
            }
            
            const docData = wordIndex.get(docId);
            docData.count++;
            docData.fields.add(field);
            docData.positions.push({ field, position: words.indexOf(word) });
            
            this.stats.totalWords++;
        });
    }

    /**
     * –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
     */
    tokenize(text) {
        if (!text) return [];
        
        return text
            .toLowerCase()
            .replace(/[^\w–∞-—è—ë]/gi, ' ')
            .split(/\s+/)
            .filter(word => 
                word.length >= this.config.minWordLength && 
                !this.stopWords.has(word)
            );
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞
     * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
     * @param {Object} options - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
     */
    async search(query, options = {}) {
        if (!this.isReady) {
            throw new Error('Search engine is not ready. Please index data first.');
        }

        const startTime = performance.now();
        this.stats.searchesPerformed++;

        const searchOptions = {
            fuzzy: options.fuzzy !== undefined ? options.fuzzy : this.config.enableFuzzy,
            category: options.category,
            tags: options.tags,
            limit: options.limit || this.config.maxResults,
            sortBy: options.sortBy || 'relevance',
            filters: options.filters || {}
        };

        console.log(`üîç Searching for: "${query}"`);

        // –¢–æ–∫–µ–Ω–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        const queryWords = this.tokenize(query);
        if (queryWords.length === 0) {
            return { results: [], stats: { searchTime: 0, totalFound: 0 } };
        }

        // –ü–æ–ª—É—á–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        const candidates = this.getCandidates(queryWords, searchOptions);
        
        // –†–∞–Ω–∂–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const rankedResults = this.rankResults(candidates, queryWords, query);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        const filteredResults = this.applyFilters(rankedResults, searchOptions);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const finalResults = filteredResults.slice(0, searchOptions.limit);

        const searchTime = performance.now() - startTime;
        this.updateSearchStats(searchTime);

        console.log(`‚úÖ Found ${finalResults.length} results in ${searchTime.toFixed(2)}ms`);

        return {
            results: finalResults.map(result => ({
                document: result.document.originalDoc,
                score: result.score,
                highlights: result.highlights,
                matchedFields: Array.from(result.matchedFields)
            })),
            stats: {
                searchTime: searchTime,
                totalFound: filteredResults.length,
                query: query,
                queryWords: queryWords
            }
        };
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
     */
    getCandidates(queryWords, options) {
        const candidates = new Map();

        queryWords.forEach(word => {
            // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            if (this.index.has(word)) {
                this.addCandidates(candidates, word, this.index.get(word), 'exact');
            }

            // –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
            if (options.fuzzy) {
                this.index.forEach((docMap, indexedWord) => {
                    const similarity = this.calculateSimilarity(word, indexedWord);
                    if (similarity >= this.config.fuzzyThreshold) {
                        this.addCandidates(candidates, word, docMap, 'fuzzy', similarity);
                    }
                });
            }
        });

        return candidates;
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
     */
    addCandidates(candidates, queryWord, docMap, matchType, similarity = 1) {
        docMap.forEach((wordData, docId) => {
            if (!candidates.has(docId)) {
                candidates.set(docId, {
                    document: this.documents.get(docId),
                    matches: [],
                    totalScore: 0,
                    matchedFields: new Set()
                });
            }

            const candidate = candidates.get(docId);
            candidate.matches.push({
                queryWord,
                matchType,
                similarity,
                count: wordData.count,
                fields: Array.from(wordData.fields),
                positions: wordData.positions
            });

            wordData.fields.forEach(field => candidate.matchedFields.add(field));
        });
    }

    /**
     * –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
     */
    rankResults(candidates, queryWords, originalQuery) {
        const results = [];

        candidates.forEach(candidate => {
            let score = 0;
            const highlights = [];

            candidate.matches.forEach(match => {
                let fieldWeight = 1;
                
                // –í–µ—Å–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–µ–π
                if (match.fields.includes('title')) {
                    fieldWeight = this.config.rankingWeights.titleMatch;
                } else if (match.fields.includes('tag')) {
                    fieldWeight = 3;
                } else if (match.fields.includes('category')) {
                    fieldWeight = 2;
                } else {
                    fieldWeight = this.config.rankingWeights.contentMatch;
                }

                // –†–∞—Å—á–µ—Ç –æ—á–∫–æ–≤
                if (match.matchType === 'exact') {
                    score += this.config.rankingWeights.exactMatch * fieldWeight * match.count;
                } else if (match.matchType === 'fuzzy') {
                    score += this.config.rankingWeights.fuzzyMatch * fieldWeight * match.similarity * match.count;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                match.fields.forEach(field => {
                    if (['title', 'content'].includes(field)) {
                        highlights.push({
                            field,
                            word: match.queryWord,
                            positions: match.positions.filter(p => p.field === field)
                        });
                    }
                });
            });

            // –ë–æ–Ω—É—Å –∑–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ñ—Ä–∞–∑—ã
            if (this.hasExactPhraseMatch(candidate.document, originalQuery)) {
                score *= 2;
            }

            results.push({
                ...candidate,
                score,
                highlights
            });
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        return results.sort((a, b) => b.score - a.score);
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
     */
    applyFilters(results, options) {
        return results.filter(result => {
            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (options.category && result.document.category !== options.category) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
            if (options.tags && options.tags.length > 0) {
                const hasMatchingTag = options.tags.some(tag => 
                    result.document.tags.includes(tag)
                );
                if (!hasMatchingTag) return false;
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            if (options.filters) {
                for (const [key, value] of Object.entries(options.filters)) {
                    if (result.document.originalDoc[key] !== value) {
                        return false;
                    }
                }
            }

            return true;
        });
    }

    /**
     * –†–∞—Å—á–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏ —Å—Ç—Ä–æ–∫ (–∞–ª–≥–æ—Ä–∏—Ç–º –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞)
     */
    calculateSimilarity(str1, str2) {
        const matrix = [];
        const len1 = str1.length;
        const len2 = str2.length;

        if (len1 === 0) return len2 === 0 ? 1 : 0;
        if (len2 === 0) return 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ç—Ä–∏—Ü—ã
        for (let i = 0; i <= len1; i++) {
            matrix[i] = [i];
        }
        for (let j = 0; j <= len2; j++) {
            matrix[0][j] = j;
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã
        for (let i = 1; i <= len1; i++) {
            for (let j = 1; j <= len2; j++) {
                const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                matrix[i][j] = Math.min(
                    matrix[i - 1][j] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j - 1] + cost
                );
            }
        }

        const maxLen = Math.max(len1, len2);
        return (maxLen - matrix[len1][len2]) / maxLen;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ñ—Ä–∞–∑—ã
     */
    hasExactPhraseMatch(document, phrase) {
        const normalizedPhrase = phrase.toLowerCase();
        return (
            document.title.toLowerCase().includes(normalizedPhrase) ||
            document.content.toLowerCase().includes(normalizedPhrase)
        );
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
     */
    getSearchSuggestions(partial, limit = 10) {
        if (!partial || partial.length < 2) return [];

        const suggestions = [];
        const normalizedPartial = partial.toLowerCase();

        this.index.forEach((docMap, word) => {
            if (word.startsWith(normalizedPartial)) {
                suggestions.push({
                    suggestion: word,
                    frequency: this.getWordFrequency(word),
                    type: 'prefix'
                });
            }
        });

        // Fuzzy suggestions
        if (suggestions.length < limit) {
            this.index.forEach((docMap, word) => {
                if (!word.startsWith(normalizedPartial)) {
                    const similarity = this.calculateSimilarity(normalizedPartial, word);
                    if (similarity >= 0.6) {
                        suggestions.push({
                            suggestion: word,
                            frequency: this.getWordFrequency(word),
                            type: 'fuzzy',
                            similarity
                        });
                    }
                }
            });
        }

        return suggestions
            .sort((a, b) => {
                if (a.type !== b.type) {
                    return a.type === 'prefix' ? -1 : 1;
                }
                return b.frequency - a.frequency;
            })
            .slice(0, limit);
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã —Å–ª–æ–≤–∞
     */
    getWordFrequency(word) {
        const wordIndex = this.index.get(word);
        if (!wordIndex) return 0;

        let totalFreq = 0;
        wordIndex.forEach(docData => {
            totalFreq += docData.count;
        });
        return totalFreq;
    }

    /**
     * –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ —Å –æ–ø—Ü–∏—è–º–∏
     */
    buildSearchIndex(options = {}) {
        console.log('üîß Building search index with options:', options);
        
        this.config = { ...this.config, ...options };
        
        if (options.stopWords) {
            this.stopWords = new Set([...this.stopWords, ...options.stopWords]);
        }

        return {
            status: 'ready',
            config: this.config,
            stopWords: Array.from(this.stopWords)
        };
    }

    /**
     * –û—á–∏—Å—Ç–∫–∞ –∏–Ω–¥–µ–∫—Å–∞
     */
    clearIndex() {
        this.index.clear();
        this.documents.clear();
        this.isReady = false;
        this.stats.documentsIndexed = 0;
        this.stats.totalWords = 0;
        console.log('üßπ Search index cleared');
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∏—Å–∫–∞
     */
    updateSearchStats(searchTime) {
        const totalTime = this.stats.averageSearchTime * (this.stats.searchesPerformed - 1);
        this.stats.averageSearchTime = (totalTime + searchTime) / this.stats.searchesPerformed;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
     */
    getStats() {
        return {
            ...this.stats,
            indexSize: this.index.size,
            documentsCount: this.documents.size,
            isReady: this.isReady
        };
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –∏–Ω–¥–µ–∫—Å–∞
     */
    exportIndex() {
        return {
            index: Array.from(this.index.entries()),
            documents: Array.from(this.documents.entries()),
            config: this.config,
            stats: this.stats
        };
    }

    /**
     * –ò–º–ø–æ—Ä—Ç –∏–Ω–¥–µ–∫—Å–∞
     */
    importIndex(indexData) {
        this.index = new Map(indexData.index);
        this.documents = new Map(indexData.documents);
        this.config = { ...this.config, ...indexData.config };
        this.stats = { ...this.stats, ...indexData.stats };
        this.isReady = true;
        
        console.log('üì• Search index imported successfully');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HEYS
if (typeof window !== 'undefined') {
    window.SmartSearchEngine = SmartSearchEngine;
    
    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ HEYS namespace
    if (window.HEYS) {
        window.HEYS.SmartSearchEngine = SmartSearchEngine;
        console.log('‚úÖ SmartSearchEngine integrated into HEYS namespace');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è Node.js
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SmartSearchEngine;
}
