{"version":3,"sources":["../src/index.ts"],"names":["SmartSearchEngine","config","str1","str2","matrix","i","j","indicator","query","text","result","rule","word","synonymList","key","values","v","target","distance","maxLength","similarity","items","searchFields","startTime","normalizedQuery","cached","phoneticQuery","synonyms","maxDistance","matches","item","field","fieldValue","phoneticValue","score","phoneticDistance","phoneticScore","synonym","synonymDistance","synonymScore","uniqueMatches","m","a","b","resultItems","suggestions","queryLength","match","entries","searchTime","newConfig"],"mappings":"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","sourcesContent":["// HEYS Search Engine - Modern TypeScript implementation\n// Migrated from heys_smart_search_with_typos_v1.js\n\nexport interface SearchConfig {\n  maxTypoDistance: number;\n  minQueryLength: number;\n  maxSuggestions: number;\n  cacheEnabled: boolean;\n  cacheTimeout: number;\n  enablePhonetic: boolean;\n  enableSynonyms: boolean;\n  debugMode: boolean;\n}\n\nexport interface SearchResult<T = any> {\n  items: T[];\n  query: string;\n  suggestions: string[];\n  searchTime: number;\n  total: number;\n  typosCorrected: boolean;\n}\n\nexport interface SearchMetrics {\n  totalSearches: number;\n  averageSearchTime: number;\n  cacheHitRate: number;\n  typoCorrections: number;\n}\n\nexport class SmartSearchEngine<T = any> {\n  private config: SearchConfig;\n  private cache = new Map<string, { result: SearchResult<T>; timestamp: number }>();\n  private metrics: SearchMetrics = {\n    totalSearches: 0,\n    averageSearchTime: 0,\n    cacheHitRate: 0,\n    typoCorrections: 0,\n  };\n\n  // Common words dictionary for improved search\n  private commonWords = new Set([\n    'хлеб',\n    'молоко',\n    'мясо',\n    'рыба',\n    'овощи',\n    'фрукты',\n    'крупа',\n    'макароны',\n    'сыр',\n    'масло',\n    'яйца',\n    'курица',\n    'говядина',\n    'свинина',\n    'картофель',\n    'морковь',\n    'лук',\n    'помидор',\n    'огурец',\n    'яблоко',\n    'банан',\n    'апельсин',\n  ]);\n\n  // Synonyms dictionary\n  private synonyms = new Map([\n    ['хлеб', ['батон', 'буханка', 'булка', 'багет']],\n    ['молоко', ['молочко', 'молочный']],\n    ['мясо', ['мясной', 'мясные']],\n    ['курица', ['куриный', 'цыпленок', 'птица']],\n    ['говядина', ['говяжий', 'телятина']],\n    ['свинина', ['свиной', 'поросенок']],\n    ['картофель', ['картошка', 'картофельный']],\n    ['помидор', ['томат', 'томатный']],\n    ['масло', ['маслице', 'сливочное']],\n  ]);\n\n  // Phonetic rules for Russian language\n  private phoneticRules = [\n    { from: /[её]/g, to: 'е' },\n    { from: /[ии]/g, to: 'и' },\n    { from: /[оё]/g, to: 'о' },\n    { from: /[ъь]/g, to: '' },\n    { from: /тс/g, to: 'ц' },\n    { from: /дс/g, to: 'ц' },\n  ];\n\n  constructor(config: Partial<SearchConfig> = {}) {\n    this.config = {\n      maxTypoDistance: 2,\n      minQueryLength: 2,\n      maxSuggestions: 5,\n      cacheEnabled: true,\n      cacheTimeout: 300000, // 5 minutes\n      enablePhonetic: true,\n      enableSynonyms: true,\n      debugMode: false,\n      ...config,\n    };\n  }\n\n  /**\n   * Calculate Levenshtein distance between two strings\n   */\n  private levenshteinDistance(str1: string, str2: string): number {\n    const matrix = Array(str2.length + 1)\n      .fill(null)\n      .map(() => Array(str1.length + 1).fill(null));\n\n    for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;\n    for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;\n\n    for (let j = 1; j <= str2.length; j++) {\n      for (let i = 1; i <= str1.length; i++) {\n        const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;\n        matrix[j][i] = Math.min(\n          matrix[j][i - 1] + 1, // deletion\n          matrix[j - 1][i] + 1, // insertion\n          matrix[j - 1][i - 1] + indicator, // substitution\n        );\n      }\n    }\n\n    return matrix[str2.length][str1.length];\n  }\n\n  /**\n   * Normalize query string\n   */\n  private normalizeQuery(query: string): string {\n    return query.toLowerCase().trim().replace(/\\s+/g, ' ');\n  }\n\n  /**\n   * Apply phonetic transformation\n   */\n  private phoneticTransform(text: string): string {\n    if (!this.config.enablePhonetic) return text;\n\n    let result = text;\n    for (const rule of this.phoneticRules) {\n      result = result.replace(rule.from, rule.to);\n    }\n    return result;\n  }\n\n  /**\n   * Find synonyms for a word\n   */\n  private findSynonyms(word: string): string[] {\n    if (!this.config.enableSynonyms) return [];\n\n    const synonymList = this.synonyms.get(word) || [];\n\n    // Also check if word is a synonym of another word\n    for (const [key, values] of this.synonyms) {\n      if (values.includes(word)) {\n        synonymList.push(key, ...values.filter((v) => v !== word));\n      }\n    }\n\n    return [...new Set(synonymList)];\n  }\n\n  /**\n   * Calculate relevance score for a match\n   */\n  private calculateRelevance(query: string, target: string, distance: number): number {\n    const maxLength = Math.max(query.length, target.length);\n    const similarity = 1 - distance / maxLength;\n\n    // Boost score for exact matches\n    if (distance === 0) return 1.0;\n\n    // Boost score for common words\n    if (this.commonWords.has(target.toLowerCase())) {\n      return similarity * 1.2;\n    }\n\n    return similarity;\n  }\n\n  /**\n   * Search function with fuzzy matching\n   */\n  search<TItem extends Record<string, any>>(\n    items: TItem[],\n    query: string,\n    searchFields: (keyof TItem)[],\n  ): SearchResult<TItem> {\n    const startTime = Date.now();\n    const normalizedQuery = this.normalizeQuery(query);\n\n    // Check cache first\n    if (this.config.cacheEnabled) {\n      const cached = this.getCachedResult(normalizedQuery);\n      if (cached) {\n        this.metrics.cacheHitRate =\n          (this.metrics.cacheHitRate * this.metrics.totalSearches + 1) /\n          (this.metrics.totalSearches + 1);\n        this.updateMetrics(Date.now() - startTime);\n        return cached;\n      }\n    }\n\n    if (normalizedQuery.length < this.config.minQueryLength) {\n      const emptyResult: SearchResult<TItem> = {\n        items: items.slice(0, this.config.maxSuggestions),\n        query: normalizedQuery,\n        suggestions: [],\n        searchTime: Date.now() - startTime,\n        total: items.length,\n        typosCorrected: false,\n      };\n      return emptyResult;\n    }\n\n    const phoneticQuery = this.phoneticTransform(normalizedQuery);\n    const synonyms = this.findSynonyms(normalizedQuery);\n    const maxDistance = this.getMaxTypoDistance(normalizedQuery.length);\n\n    const matches: Array<{ item: TItem; score: number; field: string }> = [];\n\n    for (const item of items) {\n      for (const field of searchFields) {\n        const fieldValue = String(item[field]).toLowerCase();\n        const phoneticValue = this.phoneticTransform(fieldValue);\n\n        // Direct match\n        let distance = this.levenshteinDistance(normalizedQuery, fieldValue);\n        let score = this.calculateRelevance(normalizedQuery, fieldValue, distance);\n\n        // Phonetic match\n        const phoneticDistance = this.levenshteinDistance(phoneticQuery, phoneticValue);\n        const phoneticScore = this.calculateRelevance(\n          phoneticQuery,\n          phoneticValue,\n          phoneticDistance,\n        );\n\n        if (phoneticScore > score) {\n          distance = phoneticDistance;\n          score = phoneticScore;\n        }\n\n        // Synonym match\n        for (const synonym of synonyms) {\n          const synonymDistance = this.levenshteinDistance(synonym, fieldValue);\n          const synonymScore = this.calculateRelevance(synonym, fieldValue, synonymDistance);\n\n          if (synonymScore > score) {\n            distance = synonymDistance;\n            score = synonymScore;\n          }\n        }\n\n        // Partial match (contains)\n        if (fieldValue.includes(normalizedQuery)) {\n          score = Math.max(score, 0.8);\n        }\n\n        if (distance <= maxDistance || score > 0.3) {\n          matches.push({ item, score, field: String(field) });\n        }\n      }\n    }\n\n    // Sort by score and remove duplicates\n    const uniqueMatches = Array.from(new Map(matches.map((m) => [m.item, m])).values()).sort(\n      (a, b) => b.score - a.score,\n    );\n\n    const resultItems = uniqueMatches.slice(0, this.config.maxSuggestions).map((m) => m.item);\n    const suggestions = this.generateSuggestions(normalizedQuery, uniqueMatches);\n\n    const result: SearchResult<TItem> = {\n      items: resultItems,\n      query: normalizedQuery,\n      suggestions,\n      searchTime: Date.now() - startTime,\n      total: uniqueMatches.length,\n      typosCorrected: suggestions.length > 0,\n    };\n\n    // Cache result\n    if (this.config.cacheEnabled) {\n      this.cacheResult(normalizedQuery, result);\n    }\n\n    this.updateMetrics(result.searchTime);\n    if (result.typosCorrected) {\n      this.metrics.typoCorrections++;\n    }\n\n    return result;\n  }\n\n  private getMaxTypoDistance(queryLength: number): number {\n    if (queryLength <= 4) return 1;\n    if (queryLength <= 6) return 2;\n    return 3;\n  }\n\n  private generateSuggestions<TItem>(\n    query: string,\n    matches: Array<{ item: TItem; score: number; field: string }>,\n  ): string[] {\n    // Extract unique suggestions from field values\n    const suggestions = new Set<string>();\n\n    for (const match of matches.slice(0, this.config.maxSuggestions)) {\n      if (match.score < 1.0) {\n        // Only suggest if not exact match\n        const fieldValue = String((match.item as any)[match.field]);\n        if (fieldValue.toLowerCase() !== query) {\n          suggestions.add(fieldValue);\n        }\n      }\n    }\n\n    return Array.from(suggestions).slice(0, this.config.maxSuggestions);\n  }\n\n  private getCachedResult<TItem>(query: string): SearchResult<TItem> | null {\n    const cached = this.cache.get(query);\n    if (!cached) return null;\n\n    const isExpired = Date.now() - cached.timestamp > this.config.cacheTimeout;\n    if (isExpired) {\n      this.cache.delete(query);\n      return null;\n    }\n\n    return cached.result;\n  }\n\n  private cacheResult<TItem>(query: string, result: SearchResult<TItem>): void {\n    this.cache.set(query, {\n      result,\n      timestamp: Date.now(),\n    });\n\n    // Cleanup old cache entries\n    if (this.cache.size > 1000) {\n      const entries = Array.from(this.cache.entries());\n      entries.sort((a, b) => a[1].timestamp - b[1].timestamp);\n      entries.slice(0, 500).forEach(([key]) => this.cache.delete(key));\n    }\n  }\n\n  private updateMetrics(searchTime: number): void {\n    this.metrics.totalSearches++;\n    this.metrics.averageSearchTime =\n      (this.metrics.averageSearchTime * (this.metrics.totalSearches - 1) + searchTime) /\n      this.metrics.totalSearches;\n  }\n\n  /**\n   * Get search statistics\n   */\n  getMetrics(): SearchMetrics {\n    return { ...this.metrics };\n  }\n\n  /**\n   * Clear search cache\n   */\n  clearCache(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Update configuration\n   */\n  updateConfig(newConfig: Partial<SearchConfig>): void {\n    this.config = { ...this.config, ...newConfig };\n  }\n}\n"]}