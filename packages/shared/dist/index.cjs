'use strict';

var W = require('dompurify');
var zod = require('zod');
var supabaseJs = require('@supabase/supabase-js');
var events = require('events');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var W__default = /*#__PURE__*/_interopDefault(W);

var q=(n=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(n,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):n)(function(n){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+n+'" is not supported')});var b=class{metrics=[];errors=[];config;batchTimer;constructor(e){this.config=e,e.enabled&&e.flushInterval&&this.startBatchReporting();}recordMetric(e,t,r="ms",i){if(!this.config.enabled)return;let s={name:e,value:t,unit:r,timestamp:Date.now(),...i&&{tags:i}};this.metrics.push(s),this.config.batchSize&&this.metrics.length>=this.config.batchSize&&this.flush();}recordError(e,t="medium",r){if(!this.config.enabled)return;let i={id:this.generateId(),message:typeof e=="string"?e:e.message,timestamp:Date.now(),severity:t,sessionId:this.getSessionId(),...typeof e=="object"&&e.stack&&{stack:e.stack},...r&&{context:r}};this.errors.push(i),(t==="critical"||this.config.batchSize&&this.errors.length>=this.config.batchSize)&&this.flush();}async measureAsync(e,t,r){let i=performance.now();try{let s=await t(),a=performance.now()-i;return this.recordMetric(e,a,"ms",r),s}catch(s){let a=performance.now()-i;throw this.recordMetric(`${e}_error`,a,"ms",r),this.recordError(s,"high",{operation:e,...r}),s}}measure(e,t,r){let i=performance.now();try{let s=t(),a=performance.now()-i;return this.recordMetric(e,a,"ms",r),s}catch(s){let a=performance.now()-i;throw this.recordMetric(`${e}_error`,a,"ms",r),this.recordError(s,"high",{operation:e,...r}),s}}getMetrics(){return [...this.metrics]}getErrors(){return [...this.errors]}async flush(){if(!this.config.endpoint||!this.metrics.length&&!this.errors.length)return;let e={metrics:this.metrics,errors:this.errors,timestamp:Date.now()};try{await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:JSON.stringify(e)}),this.metrics=[],this.errors=[];}catch(t){console.warn("Failed to send monitoring data:",t);}}startBatchReporting(){this.batchTimer&&clearInterval(this.batchTimer),this.batchTimer=setInterval(()=>{this.flush();},this.config.flushInterval);}stop(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=void 0),this.flush();}generateId(){return `${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getSessionId(){if(typeof window<"u"&&window.sessionStorage){let e=window.sessionStorage.getItem("monitoring_session_id");return e||(e=this.generateId(),window.sessionStorage.setItem("monitoring_session_id",e)),e}return "server-session"}},g=new b({enabled:process.env.NODE_ENV==="production",batchSize:100,flushInterval:3e4,enableRealtime:false}),x=(n,e,t,r)=>g.recordMetric(n,e,t,r),P=(n,e,t)=>g.recordError(n,e,t),T=(n,e,t)=>g.measureAsync(n,e,t),R=(n,e,t)=>g.measure(n,e,t);var v=class{constructor(e){this.websocketUrl=e;e&&this.connect();}ws;alerts=[];alertRules=[];liveMetrics=new Map;subscribers=new Map;connect(){if(!(typeof globalThis<"u"&&globalThis.process?.env?.NODE_ENV==="test")&&!(!this.websocketUrl||this.ws&&this.ws.readyState===1))try{if(typeof WebSocket>"u"){console.warn("WebSocket not available in this environment");return}this.ws=new WebSocket(this.websocketUrl),this.ws.onopen=()=>{console.log("Real-time monitoring connected"),this.emit("connection",{status:"connected"});},this.ws.onmessage=e=>{try{let t=JSON.parse(e.data);this.handleMessage(t);}catch(t){console.error("Failed to parse WebSocket message:",t);}},this.ws.onclose=()=>{console.log("Real-time monitoring disconnected"),this.emit("connection",{status:"disconnected"}),setTimeout(()=>this.connect(),5e3);},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.emit("error",{error:e});};}catch(e){console.error("Failed to connect to WebSocket:",e);}}disconnect(){this.ws&&(this.ws.close(),this.ws=void 0);}subscribe(e,t){return this.subscribers.has(e)||this.subscribers.set(e,new Set),this.subscribers.get(e).add(t),()=>{this.subscribers.get(e)?.delete(t);}}addAlertRule(e){let t={id:this.generateId(),...e};return this.alertRules.push(t),this.emit("alert_rule_added",t),t.id}removeAlertRule(e){let t=this.alertRules.findIndex(r=>r.id===e);if(t>=0){let r=this.alertRules.splice(t,1)[0];return this.emit("alert_rule_removed",r),true}return  false}updateMetric(e,t,r="ms"){let i=this.liveMetrics.get(e),s={name:e,current:t,previous:i?.current??t,trend:this.calculateTrend(t,i?.current),unit:r,timestamp:Date.now()};this.liveMetrics.set(e,s),this.emit("metric_updated",s),this.checkAlerts(e,t);}getLiveMetrics(){return Array.from(this.liveMetrics.values())}getActiveAlerts(){return this.alerts.filter(e=>!e.acknowledged&&!e.resolvedAt)}acknowledgeAlert(e){let t=this.alerts.find(r=>r.id===e);return t&&!t.acknowledged?(t.acknowledged=true,this.emit("alert_acknowledged",t),true):false}resolveAlert(e){let t=this.alerts.find(r=>r.id===e);return t&&!t.resolvedAt?(t.resolvedAt=Date.now(),this.emit("alert_resolved",t),true):false}send(e){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e));}handleMessage(e){switch(e.type){case "metric":this.updateMetric(e.name,e.value,e.unit);break;case "alert":this.handleIncomingAlert(e);break;case "system_status":this.emit("system_status",e);break;default:this.emit("message",e);}}handleIncomingAlert(e){let t={id:e.id||this.generateId(),ruleId:e.ruleId,message:e.message,severity:e.severity,timestamp:e.timestamp||Date.now(),acknowledged:false};this.alerts.push(t),this.emit("alert_triggered",t);}checkAlerts(e,t){let r=this.alertRules.filter(i=>i.enabled&&i.metric===e);for(let i of r)this.evaluateRule(i,t)&&this.triggerAlert(i,t);}evaluateRule(e,t){switch(e.operator){case "gt":return t>e.threshold;case "gte":return t>=e.threshold;case "lt":return t<e.threshold;case "lte":return t<=e.threshold;case "eq":return t===e.threshold;default:return  false}}triggerAlert(e,t){if(this.alerts.find(s=>s.ruleId===e.id&&Date.now()-s.timestamp<(e.duration||60)*1e3&&!s.resolvedAt))return;let i={id:this.generateId(),ruleId:e.id,message:`${e.name}: ${e.metric} is ${t} (threshold: ${e.threshold})`,severity:t>e.threshold*2?"critical":"warning",timestamp:Date.now(),acknowledged:false};this.alerts.push(i),this.emit("alert_triggered",i);}calculateTrend(e,t){return !t||t===e?"stable":e>t?"up":"down"}emit(e,t){let r=this.subscribers.get(e);r&&r.forEach(i=>{try{i(t);}catch(s){console.error(`Error in subscriber for event ${e}:`,s);}});}generateId(){return `${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},f=new v(process.env.MONITORING_WS_URL||(typeof window<"u"?"ws://localhost:8080/monitoring":void 0)),j=n=>f.addAlertRule(n),N=n=>f.removeAlertRule(n),H=(n,e,t)=>f.updateMetric(n,e,t),F=()=>f.getLiveMetrics(),X=()=>f.getActiveAlerts();var U=(n={})=>({enabled:process.env.NODE_ENV==="production",batchSize:100,flushInterval:3e4,enableRealtime:false,...n}),Y=n=>{let e=U(n);if(typeof window<"u"&&(window.addEventListener("error",t=>{g.recordError(t.error||t.message,"high",{filename:t.filename,lineno:t.lineno,colno:t.colno});}),window.addEventListener("unhandledrejection",t=>{g.recordError(t.reason,"high",{type:"unhandled_promise_rejection"});})),typeof window<"u"&&"PerformanceObserver"in window)try{new PerformanceObserver(s=>{for(let a of s.getEntries())g.recordMetric("lcp",a.startTime,"ms",{type:"core_web_vital"});}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(s=>{for(let a of s.getEntries())g.recordMetric("fid",a.processingStart-a.startTime,"ms",{type:"core_web_vital"});}).observe({entryTypes:["first-input"]}),new PerformanceObserver(s=>{for(let a of s.getEntries())a.hadRecentInput||g.recordMetric("cls",a.value,"score",{type:"core_web_vital"});}).observe({entryTypes:["layout-shift"]});}catch(t){console.warn("Failed to setup Core Web Vitals monitoring:",t);}return {config:e,monitor:g,recordMetric:x,recordError:P,measureAsync:T,measure:R}};var m=class n{directives={};constructor(e={}){this.directives={...e};}setDirective(e,t){return typeof t=="boolean"?this.directives[e]=t:this.directives[e]=[...t],this}addToDirective(e,t){(!this.directives[e]||typeof this.directives[e]=="boolean")&&(this.directives[e]=[]);let r=this.directives[e];return this.directives[e]=[...r,...t],this}build(){let e=[];return Object.entries(this.directives).forEach(([t,r])=>{typeof r=="boolean"&&r?e.push(t):Array.isArray(r)&&r.length>0&&e.push(`${t} ${r.join(" ")}`);}),e.join("; ")}static strict(){return new n({"default-src":["'none'"],"script-src":["'self'"],"style-src":["'self'","'unsafe-inline'"],"img-src":["'self'","data:","https:"],"font-src":["'self'"],"connect-src":["'self'"],"media-src":["'self'"],"object-src":["'none'"],"frame-src":["'none'"],"base-uri":["'self'"],"form-action":["'self'"],"frame-ancestors":["'none'"],"upgrade-insecure-requests":true,"block-all-mixed-content":true})}static development(){return new n({"default-src":["'self'"],"script-src":["'self'","'unsafe-eval'","'unsafe-inline'","localhost:*"],"style-src":["'self'","'unsafe-inline'","localhost:*"],"img-src":["'self'","data:","https:","localhost:*"],"font-src":["'self'","localhost:*"],"connect-src":["'self'","localhost:*","ws:","wss:"],"media-src":["'self'","localhost:*"],"object-src":["'none'"],"frame-src":["'self'","localhost:*"],"base-uri":["'self'"],"form-action":["'self'"]})}},A=class n{config;isDevelopment;constructor(e={},t=false){this.config=e,this.isDevelopment=t;}generateHeaders(){let e={};if(this.config.csp){let t=new m(this.config.csp);e["Content-Security-Policy"]=t.build();}else {let t=this.isDevelopment?m.development():m.strict();e["Content-Security-Policy"]=t.build();}if(this.config.hsts!==false&&!this.isDevelopment){let t=this.config.hsts||{},i=`max-age=${t.maxAge||31536e3}`;t.includeSubDomains!==false&&(i+="; includeSubDomains"),t.preload&&(i+="; preload"),e["Strict-Transport-Security"]=i;}if(e["X-Frame-Options"]=this.config.frameOptions||"DENY",this.config.contentTypeOptions!==false&&(e["X-Content-Type-Options"]="nosniff"),this.config.xssProtection!==false&&(e["X-XSS-Protection"]="1; mode=block"),e["Referrer-Policy"]=this.config.referrerPolicy||"strict-origin-when-cross-origin",this.config.permissionsPolicy){let t=Object.entries(this.config.permissionsPolicy).map(([r,i])=>`${r}=(${i.join(" ")})`).join(", ");e["Permissions-Policy"]=t;}else e["Permissions-Policy"]=["camera=()","microphone=()","geolocation=()","payment=()","usb=()","magnetometer=()","accelerometer=()","gyroscope=()"].join(", ");return e["Cross-Origin-Embedder-Policy"]=this.config.crossOriginEmbedderPolicy||"unsafe-none",e["Cross-Origin-Opener-Policy"]=this.config.crossOriginOpenerPolicy||"same-origin-allow-popups",e["Cross-Origin-Resource-Policy"]=this.config.crossOriginResourcePolicy||"same-origin",e}applyToResponse(e){let t=this.generateHeaders();Object.entries(t).forEach(([r,i])=>{e.setHeader(r,i);});}getFetchHeaders(){let e=new Headers,t=this.generateHeaders();return Object.entries(t).forEach(([r,i])=>{e.set(r,i);}),e}validateCSP(){let e=[],t=[],r=this.config.csp||{};return Object.entries(r).forEach(([i,s])=>{Array.isArray(s)&&(s.includes("'unsafe-inline'")&&e.push(`${i} allows 'unsafe-inline' which can enable XSS attacks`),s.includes("'unsafe-eval'")&&e.push(`${i} allows 'unsafe-eval' which can enable code injection`),s.includes("*")&&e.push(`${i} allows wildcard (*) which is overly permissive`));}),!r["default-src"]&&!r["script-src"]&&t.push("Missing script-src directive - scripts can be loaded from anywhere"),r["object-src"]||e.push("Consider setting object-src to prevent plugin injection"),r["base-uri"]||e.push("Consider setting base-uri to prevent base tag injection"),{isValid:t.length===0,warnings:e,errors:t}}static forEnvironment(e,t={}){let i={...{development:{csp:m.development().directives,hsts:false,frameOptions:"SAMEORIGIN"},staging:{csp:m.strict().addToDirective("script-src",["staging.example.com"]).directives,frameOptions:"DENY"},production:{csp:m.strict().directives,hsts:{maxAge:31536e3,includeSubDomains:true,preload:true},frameOptions:"DENY"}}[e],...t};return new n(i,e==="development")}},S=class n{config;constructor(e={}){this.config={origin:false,methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"],exposedHeaders:[],credentials:false,maxAge:86400,optionsSuccessStatus:204,...e};}isOriginAllowed(e){return e?typeof this.config.origin=="boolean"?this.config.origin:typeof this.config.origin=="string"?this.config.origin===e:Array.isArray(this.config.origin)?this.config.origin.includes(e):typeof this.config.origin=="function"?this.config.origin(e):false:true}generateHeaders(e){let t={};return this.isOriginAllowed(e)&&(this.config.credentials?t["Access-Control-Allow-Origin"]=e||"*":t["Access-Control-Allow-Origin"]="*"),this.config.methods&&this.config.methods.length>0&&(t["Access-Control-Allow-Methods"]=this.config.methods.join(", ")),this.config.allowedHeaders&&this.config.allowedHeaders.length>0&&(t["Access-Control-Allow-Headers"]=this.config.allowedHeaders.join(", ")),this.config.exposedHeaders&&this.config.exposedHeaders.length>0&&(t["Access-Control-Expose-Headers"]=this.config.exposedHeaders.join(", ")),this.config.credentials&&(t["Access-Control-Allow-Credentials"]="true"),this.config.maxAge!==void 0&&(t["Access-Control-Max-Age"]=this.config.maxAge.toString()),t}static secure(e){return new n({origin:e,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","X-Requested-With"],credentials:true,maxAge:86400})}static development(){return new n({origin:true,methods:["GET","POST","PUT","DELETE","OPTIONS","PATCH"],allowedHeaders:["*"],credentials:true})}},ie=A.forEnvironment(process.env.NODE_ENV==="production"?"production":"development"),se=process.env.NODE_ENV==="production"?S.secure([]):S.development();var I=class{name="XSS Scanner";description="Cross-Site Scripting vulnerability detection";severity="high";xssPayloads=['<script>alert("XSS")</script>','"><script>alert("XSS")</script>','<img src=x onerror=alert("XSS")>','javascript:alert("XSS")','<svg onload=alert("XSS")>','"><script>alert("XSS")</script>','<script>console.log("XSS")</script>',`<iframe src="javascript:alert('XSS')"></iframe>`];async scan(e){let t=[];for(let[r,i]of Object.entries(e))if(typeof i=="string")for(let s of this.xssPayloads){let a=i+s,o=this.detectXSSPatterns(a);o.length>0&&t.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"Cross-Site Scripting (XSS) Vulnerability",description:`Field "${r}" contains potentially dangerous XSS patterns: ${o.join(", ")}`,location:r,evidence:{payload:s,original:i,detectedPatterns:o,testValue:a.substring(0,100)},remediation:"Implement proper input validation and output encoding with Content Security Policy",timestamp:new Date});}return t}detectXSSPatterns(e){let t=[{name:"script_tag",regex:/<script[\s\S]*?>[\s\S]*?<\/script>/gi},{name:"javascript_protocol",regex:/javascript:/gi},{name:"event_handlers",regex:/on\w+\s*=\s*["'][^"']*["']/gi},{name:"svg_onload",regex:/<svg[^>]*onload/gi},{name:"img_onerror",regex:/<img[^>]*onerror/gi},{name:"iframe_javascript",regex:/<iframe[^>]*src\s*=\s*["']javascript:/gi},{name:"data_protocol",regex:/data:text\/html/gi},{name:"vbscript",regex:/vbscript:/gi}],r=[];for(let i of t)i.regex.test(e)&&r.push(i.name);return r}generateId(){return `xss-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},O=class{name="SQL Injection Scanner";description="SQL Injection vulnerability detection";severity="critical";sqlPayloads=["' OR '1'='1","'; DROP TABLE users; --","1' OR '1'='1","admin'--","admin'/*","' OR 1=1--","' UNION SELECT * FROM users--","1; UPDATE users SET password='hacked'--"];async scan(e){let t=[];for(let[r,i]of Object.entries(e))if(typeof i=="string")for(let s of this.sqlPayloads)this.detectSQLInjection(i+s)&&t.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"SQL Injection Vulnerability",description:`Field "${r}" may be vulnerable to SQL injection`,location:r,evidence:{payload:s,original:i},remediation:"Use parameterized queries and input validation",cve:"CWE-89",timestamp:new Date});return t}detectSQLInjection(e){return [/(\bOR\b|\bAND\b).*?=.*?(\b1\b|\b'1'\b)/i,/(\bUNION\b|\bSELECT\b|\bINSERT\b|\bUPDATE\b|\bDELETE\b|\bDROP\b)/i,/('|\").*?(\bOR\b|\bAND\b).*?('|\")/i,/--|\#|\/\*/].some(r=>r.test(e))}generateId(){return `sqli-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},D=class{name="Input Validation Scanner";description="Input validation and sanitization testing";severity="medium";async scan(e){let t=[];for(let[r,i]of Object.entries(e)){let s=[{name:"Long input",value:"A".repeat(1e4)},{name:"Special characters",value:`!@#$%^&*()_+{}|:"<>?[]\\;',./`},{name:"Unicode characters",value:"\u{1F680}\u{1F389}\u{1F4BB}\u{1F525}\u26A1"},{name:"Null bytes",value:"test\0test"},{name:"HTML entities",value:"&lt;script&gt;alert(&quot;test&quot;)&lt;/script&gt;"}];for(let a of s)try{let o=p.validateInput(a.value,"text",{sanitize:!0,required:!1});!o.isValid&&!o.errors?.length&&t.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"Insufficient Input Validation",description:`Field "${r}" may not properly validate ${a.name}`,location:r,evidence:{testCase:a.name,input:a.value},remediation:"Implement comprehensive input validation",timestamp:new Date});}catch(o){t.push({id:this.generateId(),scanner:this.name,severity:"high",title:"Input Validation Error",description:`Field "${r}" causes validation errors with ${a.name}`,location:r,evidence:{testCase:a.name,error:o.message},remediation:"Fix input validation error handling",timestamp:new Date});}}return t}generateId(){return `input-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},M=class{name="Authentication Bypass Scanner";description="Authentication and authorization vulnerability testing";severity="critical";async scan(e){let t=[],r=["password","token","auth","authorization","session"],i=["",null,void 0,"admin","password","123456","null","false","0","[]","{}"];for(let s of r)if(e.hasOwnProperty(s))for(let a of i)t.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"Potential Authentication Bypass",description:`Authentication field "${s}" should be tested against bypass attempts`,location:s,evidence:{field:s,bypassAttempt:a},remediation:"Implement secure authentication validation and proper session management",cve:"CWE-287",timestamp:new Date});return t}generateId(){return `auth-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},C=class{scanners=[];constructor(){this.registerScanner(new I),this.registerScanner(new O),this.registerScanner(new D),this.registerScanner(new M);}registerScanner(e){this.scanners.push(e);}async runPenetrationTest(e,t,r={}){let i=new Date,s=[],a=this.scanners;r.includeScanners&&(a=a.filter(l=>r.includeScanners.includes(l.name))),r.excludeScanners&&(a=a.filter(l=>!r.excludeScanners.includes(l.name))),r.severity&&(a=a.filter(l=>r.severity.includes(l.severity)));for(let l of a)try{console.log(`Running ${l.name}...`);let y=await l.scan(t);s=s.concat(y);}catch(y){console.error(`Scanner ${l.name} failed:`,y);}let o=new Date,u={totalVulnerabilities:s.length,criticalCount:s.filter(l=>l.severity==="critical").length,highCount:s.filter(l=>l.severity==="high").length,mediumCount:s.filter(l=>l.severity==="medium").length,lowCount:s.filter(l=>l.severity==="low").length},h=this.generateRecommendations(s);return {id:`pentest-${Date.now()}`,targetName:e,startTime:i,endTime:o,vulnerabilities:s,summary:u,recommendations:h}}generateRecommendations(e){let t=new Set;return e.forEach(r=>{r.remediation&&t.add(r.remediation),r.scanner.includes("XSS")&&(t.add("Implement Content Security Policy (CSP) headers"),t.add("Use secure templating engines with auto-escaping")),r.scanner.includes("SQL")&&(t.add("Use parameterized queries or ORM"),t.add("Implement principle of least privilege for database access")),r.scanner.includes("Auth")&&(t.add("Implement multi-factor authentication"),t.add("Use secure session management"),t.add("Implement account lockout mechanisms"));}),e.length>0&&(t.add("Conduct regular security audits"),t.add("Implement security monitoring and logging"),t.add("Keep all dependencies updated"),t.add("Provide security training for development team")),Array.from(t)}exportReport(e){return JSON.stringify(e,null,2)}generateHtmlReport(e){let t={critical:"#dc3545",high:"#fd7e14",medium:"#ffc107",low:"#198754"};return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penetration Test Report - ${e.targetName}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .vulnerability { background: white; padding: 20px; margin-bottom: 20px; border-left: 4px solid #ddd; border-radius: 4px; }
        .critical { border-left-color: ${t.critical}; }
        .high { border-left-color: ${t.high}; }
        .medium { border-left-color: ${t.medium}; }
        .low { border-left-color: ${t.low}; }
        .recommendations { background: #e7f3ff; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .severity-badge { padding: 4px 8px; color: white; border-radius: 4px; font-size: 12px; }
        code { background: #f1f3f4; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Penetration Test Report</h1>
        <p><strong>Target:</strong> ${e.targetName}</p>
        <p><strong>Test Period:</strong> ${e.startTime.toISOString()} - ${e.endTime.toISOString()}</p>
        <p><strong>Duration:</strong> ${Math.round((e.endTime.getTime()-e.startTime.getTime())/1e3)} seconds</p>
    </div>

    <div class="summary">
        <div class="summary-card">
            <h3>Total Vulnerabilities</h3>
            <h2>${e.summary.totalVulnerabilities}</h2>
        </div>
        <div class="summary-card">
            <h3>Critical</h3>
            <h2 style="color: ${t.critical}">${e.summary.criticalCount}</h2>
        </div>
        <div class="summary-card">
            <h3>High</h3>
            <h2 style="color: ${t.high}">${e.summary.highCount}</h2>
        </div>
        <div class="summary-card">
            <h3>Medium</h3>
            <h2 style="color: ${t.medium}">${e.summary.mediumCount}</h2>
        </div>
        <div class="summary-card">
            <h3>Low</h3>
            <h2 style="color: ${t.low}">${e.summary.lowCount}</h2>
        </div>
    </div>

    <h2>Vulnerabilities</h2>
    ${e.vulnerabilities.map(r=>`
        <div class="vulnerability ${r.severity}">
            <h3>${r.title}</h3>
            <span class="severity-badge" style="background-color: ${t[r.severity]}">${r.severity.toUpperCase()}</span>
            <p><strong>Scanner:</strong> ${r.scanner}</p>
            <p><strong>Location:</strong> ${r.location||"N/A"}</p>
            <p><strong>Description:</strong> ${r.description}</p>
            ${r.remediation?`<p><strong>Remediation:</strong> ${r.remediation}</p>`:""}
            ${r.evidence?`<p><strong>Evidence:</strong> <code>${JSON.stringify(r.evidence,null,2)}</code></p>`:""}
            ${r.cve?`<p><strong>CVE:</strong> ${r.cve}</p>`:""}
            <p><strong>Timestamp:</strong> ${r.timestamp.toISOString()}</p>
        </div>
    `).join("")}

    <div class="recommendations">
        <h2>Recommendations</h2>
        <ul>
            ${e.recommendations.map(r=>`<li>${r}</li>`).join("")}
        </ul>
    </div>
</body>
</html>
    `}},oe=new C;var ue={user:zod.z.object({id:zod.z.string().uuid(),email:zod.z.string().email(),username:zod.z.string().min(3).max(50).regex(/^[a-zA-Z0-9_-]+$/),password:zod.z.string().min(8).max(128),role:zod.z.enum(["admin","user","moderator","guest"]),isActive:zod.z.boolean().default(true),createdAt:zod.z.date().optional(),updatedAt:zod.z.date().optional()}),content:zod.z.object({id:zod.z.string().uuid(),title:zod.z.string().min(1).max(200),content:zod.z.string().max(1e4),authorId:zod.z.string().uuid(),tags:zod.z.array(zod.z.string()).max(10).optional(),isPublic:zod.z.boolean().default(false),metadata:zod.z.record(zod.z.unknown()).optional()}),file:zod.z.object({name:zod.z.string().min(1).max(255),type:zod.z.string().regex(/^[a-zA-Z0-9/.\-]+$/),size:zod.z.number().min(1).max(10*1024*1024),content:zod.z.string().or(zod.z.instanceof(ArrayBuffer))}),apiRequest:zod.z.object({method:zod.z.enum(["GET","POST","PUT","DELETE","PATCH"]),path:zod.z.string().regex(/^\/[a-zA-Z0-9/_-]*$/),headers:zod.z.record(zod.z.string()).optional(),body:zod.z.unknown().optional(),query:zod.z.record(zod.z.string()).optional()})},k=class{dompurify;config;constructor(){this.dompurify=W__default.default,this.config={ALLOWED_TAGS:["b","i","em","strong","a","p","br"],ALLOWED_ATTR:["href","title"],ALLOW_DATA_ATTR:false,ALLOW_UNKNOWN_PROTOCOLS:false,SANITIZE_DOM:true,KEEP_CONTENT:true};}sanitizeHTML(e){if(typeof e!="string")throw new Error("Input must be a string");return this.dompurify.sanitize(e,this.config)}sanitizeText(e){if(typeof e!="string")throw new Error("Input must be a string");return this.dompurify.sanitize(e,{ALLOWED_TAGS:[]})}sanitizeSQL(e){if(typeof e!="string")throw new Error("Input must be a string");let t=[/('|(\\'))/gi,/(;|--|\||\|\||&&)/gi,/(union|select|insert|update|delete|drop|create|alter|exec|execute)/gi,/(\*|%|_)/gi],r=e;return t.forEach(i=>{r=r.replace(i,"");}),r.trim()}sanitizeFileName(e){if(typeof e!="string")throw new Error("Input must be a string");return e.replace(/[^a-zA-Z0-9._-]/g,"").replace(/\.{2,}/g,".").substring(0,255)}},d={noXSS:{name:"XSS Protection",validator:n=>typeof n!="string"?true:![/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,/javascript:/gi,/on\w+\s*=/gi,/<iframe/gi,/<object/gi,/<embed/gi].some(t=>t.test(n)),message:"Potential XSS attack detected",severity:"critical"},noSQLInjection:{name:"SQL Injection Protection",validator:n=>typeof n!="string"?true:![/('|(\\'))/gi,/(;|--|\||\|\||&&)/gi,/\b(union|select|insert|update|delete|drop|create|alter|exec|execute)\b/gi].some(t=>t.test(n)),message:"Potential SQL injection detected",severity:"critical"},validEmail:{name:"Email Validation",validator:n=>typeof n!="string"?false:/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n),message:"Invalid email format",severity:"medium"},strongPassword:{name:"Strong Password",validator:n=>typeof n!="string"?false:n.length>=8&&/[A-Z]/.test(n)&&/[a-z]/.test(n)&&/[0-9]/.test(n)&&/[^A-Za-z0-9]/.test(n),message:"Password must be at least 8 characters with uppercase, lowercase, number, and special character",severity:"high"},noPathTraversal:{name:"Path Traversal Protection",validator:n=>typeof n!="string"?true:!/(\.\.\/|\.\.\\)/g.test(n),message:"Path traversal attempt detected",severity:"high"}},w=class{sanitizer;customRules;constructor(){this.sanitizer=new k,this.customRules=new Map;}addRule(e,t){this.customRules.set(e,t);}removeRule(e){this.customRules.delete(e);}async validateSchema(e,t,r={}){let i={isValid:true,errors:[],warnings:[]};try{let s=e;r.sanitize&&typeof e=="object"&&e!==null&&(s=this.sanitizeObject(e),i.sanitized=s);let a=t.safeParse(s);if(a.success||(a.error.errors.forEach(o=>{i.errors.push({field:o.path.join("."),rule:"schema",message:o.message,severity:"medium",value:o.code});}),i.isValid=!1),r.customRules){let o=this.applySecurityRules(s,r.customRules);i.errors.push(...o),o.length>0&&(i.isValid=!1);}if(r.strictMode){let o=Object.keys(d),u=this.applySecurityRules(s,o);i.errors.push(...u),u.length>0&&(i.isValid=!1);}}catch(s){i.isValid=false,i.errors.push({field:"root",rule:"validation",message:s instanceof Error?s.message:"Validation failed",severity:"critical"});}return i}validateInput(e,t,r={}){let i={isValid:true,errors:[],warnings:[]};if(r.required&&(e==null||e===""))return i.isValid=false,i.errors.push({field:"value",rule:"required",message:"Value is required",severity:"medium"}),i;if(e==null)return i;switch(t){case "email":d.validEmail&&!d.validEmail.validator(e)&&(i.isValid=false,i.errors.push({field:"value",rule:"validEmail",message:d.validEmail.message,severity:d.validEmail.severity}));break;case "password":d.strongPassword&&!d.strongPassword.validator(e)&&(i.isValid=false,i.errors.push({field:"value",rule:"strongPassword",message:d.strongPassword.message,severity:d.strongPassword.severity}));break;case "text":typeof e=="string"&&(r.sanitize&&(i.sanitized=this.sanitizer.sanitizeText(e)),d.noXSS&&!d.noXSS.validator(e)&&(i.isValid=false,i.errors.push({field:"value",rule:"noXSS",message:d.noXSS.message,severity:d.noXSS.severity})));break;case "html":typeof e=="string"&&r.sanitize&&(i.sanitized=this.sanitizer.sanitizeHTML(e));break;case "filename":typeof e=="string"&&(r.sanitize&&(i.sanitized=this.sanitizer.sanitizeFileName(e)),d.noPathTraversal&&!d.noPathTraversal.validator(e)&&(i.isValid=false,i.errors.push({field:"value",rule:"noPathTraversal",message:d.noPathTraversal.message,severity:d.noPathTraversal.severity})));break}return i}sanitizeObject(e){if(typeof e=="string")return this.sanitizer.sanitizeText(e);if(e instanceof Date)return e;if(Array.isArray(e))return e.map(t=>this.sanitizeObject(t));if(e&&typeof e=="object"){let t={};for(let[r,i]of Object.entries(e))t[r]=this.sanitizeObject(i);return t}return e}applySecurityRules(e,t){let r=[];return t.forEach(i=>{let s=d[i]||this.customRules.get(i);s&&!s.validator(e)&&r.push({field:"data",rule:i,message:s.message,severity:s.severity,value:e});}),r}};function ge(n=[]){return function(e,t,r){let i=r.value,s=new w;r.value=async function(...a){for(let o=0;o<a.length;o++){let u=await s.validateSchema(a[o],zod.z.unknown(),{strictMode:true,customRules:n});if(!u.isValid)throw new $(`Security validation failed for argument ${o}`,u.errors)}return i.apply(this,a)};}}var $=class extends Error{errors;constructor(e,t=[]){super(e),this.name="SecurityError",this.errors=t;}},p=new w,me={email:n=>p.validateInput(n,"email",{required:true}),password:n=>p.validateInput(n,"password",{required:true}),text:(n,e=true)=>p.validateInput(n,"text",{sanitize:e}),html:(n,e=true)=>p.validateInput(n,"html",{sanitize:e}),filename:(n,e=true)=>p.validateInput(n,"filename",{sanitize:e})};var _=class{supabase;constructor(e,t){this.supabase=supabaseJs.createClient(e,t);}async createSecurityEvent(e){let{data:t,error:r}=await this.supabase.from("security_events").insert(e).select().single();if(r)throw new Error(`Failed to create security event: ${r.message}`);return t}async getSecurityEvents(e,t,r=100,i=0){let s=this.supabase.from("security_events").select("*").order("created_at",{ascending:false}).range(i,i+r-1);t?s=s.eq("client_id",t):s=s.eq("user_id",e);let{data:a,error:o}=await s;if(o)throw new Error(`Failed to fetch security events: ${o.message}`);return a||[]}async createSecurityIncident(e){let{data:t,error:r}=await this.supabase.from("security_incidents").insert(e).select().single();if(r)throw new Error(`Failed to create security incident: ${r.message}`);return t}async getSecurityIncidents(e,t,r){let i=this.supabase.from("security_incidents").select("*").order("created_at",{ascending:false});t?i=i.eq("client_id",t):i=i.eq("user_id",e),r&&(i=i.eq("status",r));let{data:s,error:a}=await i;if(a)throw new Error(`Failed to fetch security incidents: ${a.message}`);return s||[]}async updateSecurityIncident(e,t){let{data:r,error:i}=await this.supabase.from("security_incidents").update(t).eq("id",e).select().single();if(i)throw new Error(`Failed to update security incident: ${i.message}`);return r}async createAnalyticsMetric(e){let{data:t,error:r}=await this.supabase.from("analytics_metrics").insert(e).select().single();if(r)throw new Error(`Failed to create analytics metric: ${r.message}`);return t}async getAnalyticsMetrics(e,t,r,i,s,a){let o=this.supabase.from("analytics_metrics").select("*").order("period_start",{ascending:false});t?o=o.eq("client_id",t):o=o.eq("user_id",e),r&&(o=o.eq("metric_name",r)),i&&(o=o.eq("aggregation_period",i)),s&&(o=o.gte("period_start",s)),a&&(o=o.lte("period_end",a));let{data:u,error:h}=await o;if(h)throw new Error(`Failed to fetch analytics metrics: ${h.message}`);return u||[]}async getThreatIntelligence(){let{data:e,error:t}=await this.supabase.from("threat_intelligence").select("*").eq("is_active",true).order("updated_at",{ascending:false});if(t)throw new Error(`Failed to fetch threat intelligence: ${t.message}`);return e||[]}async checkIOCMatch(e,t){let{data:r,error:i}=await this.supabase.from("threat_intelligence").select("*").eq("ioc_type",e).eq("ioc_value",t).eq("is_active",true).single();if(i&&i.code!=="PGRST116")throw new Error(`Failed to check IOC match: ${i.message}`);return r}async createGuestSession(e){let{data:t,error:r}=await this.supabase.from("guest_sessions").insert(e).select().single();if(r)throw new Error(`Failed to create guest session: ${r.message}`);return t}async getGuestSession(e){let{data:t,error:r}=await this.supabase.from("guest_sessions").select("*").eq("session_token",e).single();if(r&&r.code!=="PGRST116")throw new Error(`Failed to fetch guest session: ${r.message}`);return t}async getSecurityMetrics(e,t,r,i){let{data:s,error:a}=await this.supabase.rpc("get_security_metrics",{p_user_id:e,p_client_id:t||null,p_start_date:r||new Date(Date.now()-864e5).toISOString(),p_end_date:i||new Date().toISOString()});if(a)throw new Error(`Failed to get security metrics: ${a.message}`);return s||{total_events:0,unique_ips:0,error_rate:0,avg_response_time:0,failed_attempts:0,event_types:[]}}async getTopThreats(e=10){let{data:t,error:r}=await this.supabase.rpc("get_top_threats",{p_limit:e});if(r)throw new Error(`Failed to get top threats: ${r.message}`);return t||[]}subscribeToSecurityEvents(e,t){return this.supabase.channel("security_events").on("postgres_changes",{event:"INSERT",schema:"public",table:"security_events",filter:`user_id=eq.${e}`},r=>{t(r.new);}).subscribe()}subscribeToSecurityIncidents(e,t){return this.supabase.channel("security_incidents").on("postgres_changes",{event:"*",schema:"public",table:"security_incidents",filter:`user_id=eq.${e}`},r=>{t(r.new);}).subscribe()}};var E;try{E=q("@heys/threat-detection").ThreatDetectionService;}catch{E=class{async initialize(){console.warn("Using mock ThreatDetectionService - install @heys/threat-detection for full functionality");}async analyzeSecurityEvent(t){return {threat_level:"low",matches:[]}}async getStatistics(){return {totalEvents:0,threats:0,incidents:0}}};}var z=class extends events.EventEmitter{threatDetection;database;config;processingQueue=[];isProcessing=false;constructor(e){super(),this.config=e,this.database=new _(e.supabaseUrl,e.supabaseKey),this.threatDetection=new E,e.enableRealTimeProcessing&&this.startRealTimeProcessing();}async initialize(){try{await this.threatDetection.initialize();let e=await this.database.getThreatIntelligence();console.log(`Loaded ${e.length} threat intelligence indicators`),await this.trainMLModel(),this.emit("initialized"),console.log("SecurityAnalyticsService initialized successfully");}catch(e){throw console.error("Failed to initialize SecurityAnalyticsService:",e),e}}async processSecurityEvent(e){try{let t=await this.database.createSecurityEvent(e),r=await this.threatDetection.analyzeSecurityEvent({id:t.id,timestamp:t.created_at,userId:t.user_id||"unknown",sessionId:t.session_id||"",ipAddress:t.source_ip||"",userAgent:t.user_agent||"",endpoint:e.event_type,method:"POST",statusCode:t.error_rate&&t.error_rate>0?500:200,responseTime:this.parseResponseTime(t.response_time),requestSize:t.data_volume||0,responseSize:t.data_volume||0,geoLocation:t.geo_location,deviceFingerprint:t.device_fingerprint,customAttributes:e.metadata||t.metadata||{}}),i={...t,anomaly_score:r.anomalyScore,threat_level:this.calculateThreatLevel(r),automated_response:[]};if(r.incidentCreated&&r.incident){let s=await this.database.createSecurityIncident({title:r.incident.title,description:r.incident.description,severity:r.incident.severity,user_id:t.user_id,client_id:t.client_id,event_ids:[t.id],ioc_matches:r.iocMatches,ml_confidence:r.anomalyScore,response_actions:r.incident.responseActions,timeline:r.incident.timeline,impact_assessment:r.incident.impactAssessment});i.automated_response=this.getAutomatedResponseActions(s),this.emit("incidentCreated",s);}return this.emit("eventProcessed",i),i}catch(t){throw console.error("Failed to process security event:",t),t}}async getSecurityAnalytics(e,t,r="day"){let i=new Date,s=new Date;switch(r){case "hour":s.setHours(s.getHours()-1);break;case "day":s.setDate(s.getDate()-1);break;case "week":s.setDate(s.getDate()-7);break;case "month":s.setMonth(s.getMonth()-1);break}let[a,o,u,h]=await Promise.all([this.database.getSecurityMetrics(e,t,s.toISOString(),i.toISOString()),this.database.getTopThreats(10),this.database.getSecurityIncidents(e,t),this.database.getSecurityEvents(e,t,100)]),l=this.calculateThreatDistribution(h),y=this.calculateRiskScore(a,u),L=await this.calculateTrends(e,r,t);return {overview:{...a,risk_score:y,active_incidents:u.filter(V=>V.status==="open"||V.status==="investigating").length,total_incidents:u.length},threats:{top_threats:o,threat_distribution:l},incidents:u.slice(0,10),trends:L,ml_stats:await this.threatDetection.getStatistics()}}async batchProcessEvents(e){let r=[];for(let i=0;i<e.length;i+=100){let s=e.slice(i,i+100),a=await Promise.all(s.map(o=>this.processSecurityEvent(o)));r.push(...a),this.emit("batchProgress",{processed:Math.min(i+100,e.length),total:e.length,results:a});}this.emit("batchCompleted",r);}subscribeToRealTimeEvents(e){return this.database.subscribeToSecurityEvents(e,t=>{this.processingQueue.push(t),this.emit("realTimeEvent",t);})}subscribeToRealTimeIncidents(e){return this.database.subscribeToSecurityIncidents(e,t=>{this.emit("realTimeIncident",t);})}async startRealTimeProcessing(){setInterval(async()=>{if(!this.isProcessing&&this.processingQueue.length>0){this.isProcessing=true;let e=this.processingQueue.splice(0,10);try{await Promise.all(e.map(t=>this.processSecurityEvent(t)));}catch(t){console.error("Error in real-time processing:",t);}finally{this.isProcessing=false;}}},1e3);}async trainMLModel(){try{let e=await this.database.getSecurityEvents("system",void 0,1e3);if(e.length>=100){let t=e.map(r=>({id:r.id,timestamp:r.created_at,userId:r.user_id||"unknown",sessionId:r.session_id||"",ipAddress:r.source_ip||"",userAgent:r.user_agent||"",endpoint:r.event_type,method:"POST",statusCode:r.error_rate&&r.error_rate>0?500:200,responseTime:this.parseResponseTime(r.response_time),requestSize:r.data_volume||0,responseSize:r.data_volume||0,geoLocation:r.geo_location,deviceFingerprint:r.device_fingerprint,customAttributes:r.metadata||{}}));console.log(`ML model trained on ${t.length} historical events`);}}catch(e){console.warn("Failed to train ML model:",e);}}parseResponseTime(e){if(!e)return 0;let t=e.match(/(\d+(?:\.\d+)?)\s*ms/);return t?parseFloat(t[1]):0}calculateThreatLevel(e){return e.anomalyScore>.8?"critical":e.anomalyScore>.6?"high":e.anomalyScore>.4?"medium":"low"}getAutomatedResponseActions(e){let t=[];return (e.severity==="high"||e.severity==="critical")&&t.push("ip_block","session_terminate"),e.ioc_matches&&t.push("threat_intelligence_update"),t}calculateThreatDistribution(e){let t={};return e.forEach(r=>{let i=r.event_type;t[i]=(t[i]||0)+1;}),Object.entries(t).sort(([,r],[,i])=>i-r).slice(0,10).map(([r,i])=>({type:r,count:i}))}calculateRiskScore(e,t){let r=0;e.error_rate>.1&&(r+=20),e.failed_attempts>10&&(r+=30),e.unique_ips>100&&(r+=10);let i=t.filter(a=>a.status==="open"||a.status==="investigating");r+=i.length*15;let s=t.filter(a=>a.severity==="critical");return r+=s.length*25,Math.min(100,r)}async calculateTrends(e,t,r){await this.database.getSecurityMetrics(e,r);return {events_trend:"+15%",incidents_trend:"+3%",risk_trend:"-5%",response_time_trend:"-10%"}}};var Oe=n=>n.toISOString().split("T")[0],De=()=>crypto.randomUUID();

exports.AuthBypassScanner = M;
exports.CORSManager = S;
exports.CSPBuilder = m;
exports.DatabaseService = _;
exports.InputSanitizer = k;
exports.InputValidationScanner = D;
exports.PenetrationTestFramework = C;
exports.PerformanceMonitor = b;
exports.RealtimeMonitor = v;
exports.SQLInjectionScanner = O;
exports.SecurityAnalyticsService = z;
exports.SecurityBoundary = ge;
exports.SecurityError = $;
exports.SecurityHeadersManager = A;
exports.SecurityRules = d;
exports.SecurityValidator = w;
exports.ValidationSchemas = ue;
exports.XSSScanner = I;
exports.addAlert = j;
exports.createMonitoringConfig = U;
exports.defaultCORS = se;
exports.defaultPentestFramework = oe;
exports.defaultSecurityHeaders = ie;
exports.defaultValidator = p;
exports.formatDate = Oe;
exports.generateId = De;
exports.getActiveAlerts = X;
exports.getLiveMetrics = F;
exports.measure = R;
exports.measureAsync = T;
exports.monitor = g;
exports.realtimeMonitor = f;
exports.recordError = P;
exports.recordMetric = x;
exports.removeAlert = N;
exports.setupMonitoring = Y;
exports.updateLiveMetric = H;
exports.validate = me;
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.cjs.map