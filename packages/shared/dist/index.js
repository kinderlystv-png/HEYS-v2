import _n from 'dompurify';
import { z } from 'zod';
import { createClient } from '@supabase/supabase-js';
import { EventEmitter } from 'events';

var ln=Object.create;var Ut=Object.defineProperty;var un=Object.getOwnPropertyDescriptor;var fn=Object.getOwnPropertyNames;var dn=Object.getPrototypeOf,gn=Object.prototype.hasOwnProperty;var C=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var x=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var hn=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of fn(e))!gn.call(t,n)&&n!==r&&Ut(t,n,{get:()=>e[n],enumerable:!(i=un(e,n))||i.enumerable});return t};var mn=(t,e,r)=>(r=t!=null?ln(dn(t)):{},hn(Ut(r,"default",{value:t,enumerable:true}),t));var Ke=x((Gl,Xt)=>{var oe=t=>t&&typeof t.message=="string",Ue=t=>{if(!t)return;let e=t.cause;if(typeof e=="function"){let r=t.cause();return oe(r)?r:void 0}else return oe(e)?e:void 0},Kt=(t,e)=>{if(!oe(t))return "";let r=t.stack||"";if(e.has(t))return r+`
causes have become circular...`;let i=Ue(t);return i?(e.add(t),r+`
caused by: `+Kt(i,e)):r},xn=t=>Kt(t,new Set),Gt=(t,e,r)=>{if(!oe(t))return "";let i=r?"":t.message||"";if(e.has(t))return i+": ...";let n=Ue(t);if(n){e.add(t);let s=typeof t.cause=="function";return i+(s?"":": ")+Gt(n,e,s)}else return i},Tn=t=>Gt(t,new Set);Xt.exports={isErrorLike:oe,getErrorCause:Ue,stackWithCauses:xn,messageWithCauses:Tn};});var Ge=x((Xl,Qt)=>{var On=Symbol("circular-ref-tag"),me=Symbol("pino-raw-err-ref"),Jt=Object.create({},{type:{enumerable:true,writable:true,value:void 0},message:{enumerable:true,writable:true,value:void 0},stack:{enumerable:true,writable:true,value:void 0},aggregateErrors:{enumerable:true,writable:true,value:void 0},raw:{enumerable:false,get:function(){return this[me]},set:function(t){this[me]=t;}}});Object.defineProperty(Jt,me,{writable:true,value:{}});Qt.exports={pinoErrProto:Jt,pinoErrorSymbols:{seen:On,rawSymbol:me}};});var er=x((Jl,Zt)=>{Zt.exports=Je;var{messageWithCauses:An,stackWithCauses:Rn,isErrorLike:Yt}=Ke(),{pinoErrProto:Pn,pinoErrorSymbols:In}=Ge(),{seen:Xe}=In,{toString:$n}=Object.prototype;function Je(t){if(!Yt(t))return t;t[Xe]=void 0;let e=Object.create(Pn);e.type=$n.call(t.constructor)==="[object Function]"?t.constructor.name:t.name,e.message=An(t),e.stack=Rn(t),Array.isArray(t.errors)&&(e.aggregateErrors=t.errors.map(r=>Je(r)));for(let r in t)if(e[r]===void 0){let i=t[r];Yt(i)?r!=="cause"&&!Object.prototype.hasOwnProperty.call(i,Xe)&&(e[r]=Je(i)):e[r]=i;}return delete t[Xe],e.raw=t,e}});var rr=x((Ql,tr)=>{tr.exports=ye;var{isErrorLike:Qe}=Ke(),{pinoErrProto:Ln,pinoErrorSymbols:kn}=Ge(),{seen:pe}=kn,{toString:Cn}=Object.prototype;function ye(t){if(!Qe(t))return t;t[pe]=void 0;let e=Object.create(Ln);e.type=Cn.call(t.constructor)==="[object Function]"?t.constructor.name:t.name,e.message=t.message,e.stack=t.stack,Array.isArray(t.errors)&&(e.aggregateErrors=t.errors.map(r=>ye(r))),Qe(t.cause)&&!Object.prototype.hasOwnProperty.call(t.cause,pe)&&(e.cause=ye(t.cause));for(let r in t)if(e[r]===void 0){let i=t[r];Qe(i)?Object.prototype.hasOwnProperty.call(i,pe)||(e[r]=ye(i)):e[r]=i;}return delete t[pe],e.raw=t,e}});var or=x((Yl,sr)=>{sr.exports={mapHttpRequest:Dn,reqSerializer:nr};var Ye=Symbol("pino-raw-req-ref"),ir=Object.create({},{id:{enumerable:true,writable:true,value:""},method:{enumerable:true,writable:true,value:""},url:{enumerable:true,writable:true,value:""},query:{enumerable:true,writable:true,value:""},params:{enumerable:true,writable:true,value:""},headers:{enumerable:true,writable:true,value:{}},remoteAddress:{enumerable:true,writable:true,value:""},remotePort:{enumerable:true,writable:true,value:""},raw:{enumerable:false,get:function(){return this[Ye]},set:function(t){this[Ye]=t;}}});Object.defineProperty(ir,Ye,{writable:true,value:{}});function nr(t){let e=t.info||t.socket,r=Object.create(ir);if(r.id=typeof t.id=="function"?t.id():t.id||(t.info?t.info.id:void 0),r.method=t.method,t.originalUrl)r.url=t.originalUrl;else {let i=t.path;r.url=typeof i=="string"?i:t.url?t.url.path||t.url:void 0;}return t.query&&(r.query=t.query),t.params&&(r.params=t.params),r.headers=t.headers,r.remoteAddress=e&&e.remoteAddress,r.remotePort=e&&e.remotePort,r.raw=t.raw||t,r}function Dn(t){return {req:nr(t)}}});var ur=x((Zl,lr)=>{lr.exports={mapHttpResponse:Mn,resSerializer:cr};var Ze=Symbol("pino-raw-res-ref"),ar=Object.create({},{statusCode:{enumerable:true,writable:true,value:0},headers:{enumerable:true,writable:true,value:""},raw:{enumerable:false,get:function(){return this[Ze]},set:function(t){this[Ze]=t;}}});Object.defineProperty(ar,Ze,{writable:true,value:{}});function cr(t){let e=Object.create(ar);return e.statusCode=t.headersSent?t.statusCode:null,e.headers=t.getHeaders?t.getHeaders():t._headers,e.raw=t,e}function Mn(t){return {res:cr(t)}}});var tt=x((eu,fr)=>{var et=er(),jn=rr(),be=or(),we=ur();fr.exports={err:et,errWithCause:jn,mapHttpRequest:be.mapHttpRequest,mapHttpResponse:we.mapHttpResponse,req:be.reqSerializer,res:we.resSerializer,wrapErrorSerializer:function(e){return e===et?e:function(i){return e(et(i))}},wrapRequestSerializer:function(e){return e===be.reqSerializer?e:function(i){return e(be.reqSerializer(i))}},wrapResponseSerializer:function(e){return e===we.resSerializer?e:function(i){return e(we.resSerializer(i))}}};});var rt=x((tu,dr)=>{function zn(t,e){return e}dr.exports=function(){let e=Error.prepareStackTrace;Error.prepareStackTrace=zn;let r=new Error().stack;if(Error.prepareStackTrace=e,!Array.isArray(r))return;let i=r.slice(2),n=[];for(let s of i)s&&n.push(s.getFileName());return n};});var hr=x((ru,gr)=>{gr.exports=qn;function qn(t={}){let{ERR_PATHS_MUST_BE_STRINGS:e=()=>"fast-redact - Paths must be (non-empty) strings",ERR_INVALID_PATH:r=i=>`fast-redact \u2013 Invalid path (${i})`}=t;return function({paths:n}){n.forEach(s=>{if(typeof s!="string")throw Error(e());try{if(/ã€‡/.test(s))throw Error();let o=(s[0]==="["?"":".")+s.replace(/^\*/,"\u3007").replace(/\.\*/g,".\u3007").replace(/\[\*\]/g,"[\u3007]");if(/\n|\r|;/.test(o)||/\/\*/.test(o))throw Error();Function(`
            'use strict'
            const o = new Proxy({}, { get: () => o, set: () => { throw Error() } });
            const \u3007 = null;
            o${o}
            if ([o${o}].length !== 1) throw Error()`)();}catch{throw Error(r(s))}});}}});var Se=x((iu,mr)=>{mr.exports=/[^.[\]]+|\[((?:.)*?)\]/g;});var yr=x((nu,pr)=>{var Nn=Se();pr.exports=Vn;function Vn({paths:t}){let e=[];var r=0;let i=t.reduce(function(n,s,o){var c=s.match(Nn).map(f=>f.replace(/'|"|`/g,""));let u=s[0]==="[";c=c.map(f=>f[0]==="["?f.substr(1,f.length-2):f);let h=c.indexOf("*");if(h>-1){let f=c.slice(0,h),l=f.join("."),p=c.slice(h+1,c.length),d=p.length>0;r++,e.push({before:f,beforeStr:l,after:p,nested:d});}else n[s]={path:c,val:void 0,precensored:false,circle:"",escPath:JSON.stringify(s),leadingBracket:u};return n},{});return {wildcards:e,wcLen:r,secret:i}}});var wr=x((su,br)=>{var Bn=Se();br.exports=Fn;function Fn({secret:t,serialize:e,wcLen:r,strict:i,isCensorFct:n,censorFctTakesPath:s},o){let c=Function("o",`
    if (typeof o !== 'object' || o == null) {
      ${Kn(i,e)}
    }
    const { censor, secret } = this
    const originalSecret = {}
    const secretKeys = Object.keys(secret)
    for (var i = 0; i < secretKeys.length; i++) {
      originalSecret[secretKeys[i]] = secret[secretKeys[i]]
    }

    ${Wn(t,n,s)}
    this.compileRestore()
    ${Hn(r>0,n,s)}
    this.secret = originalSecret
    ${Un(e)}
  `).bind(o);return c.state=o,e===false&&(c.restore=u=>o.restore(u)),c}function Wn(t,e,r){return Object.keys(t).map(i=>{let{escPath:n,leadingBracket:s,path:o}=t[i],c=s?1:0,u=s?"":".",h=[];for(var f;(f=Bn.exec(i))!==null;){let[,a]=f,{index:y,input:m}=f;y>c&&h.push(m.substring(0,y-(a?0:1)));}var l=h.map(a=>`o${u}${a}`).join(" && ");l.length===0?l+=`o${u}${i} != null`:l+=` && o${u}${i} != null`;let p=`
      switch (true) {
        ${h.reverse().map(a=>`
          case o${u}${a} === censor:
            secret[${n}].circle = ${JSON.stringify(a)}
            break
        `).join(`
`)}
      }
    `,d=r?`val, ${JSON.stringify(o)}`:"val";return `
      if (${l}) {
        const val = o${u}${i}
        if (val === censor) {
          secret[${n}].precensored = true
        } else {
          secret[${n}].val = val
          o${u}${i} = ${e?`censor(${d})`:"censor"}
          ${p}
        }
      }
    `}).join(`
`)}function Hn(t,e,r){return t===true?`
    {
      const { wildcards, wcLen, groupRedact, nestedRedact } = this
      for (var i = 0; i < wcLen; i++) {
        const { before, beforeStr, after, nested } = wildcards[i]
        if (nested === true) {
          secret[beforeStr] = secret[beforeStr] || []
          nestedRedact(secret[beforeStr], o, before, after, censor, ${e}, ${r})
        } else secret[beforeStr] = groupRedact(o, before, censor, ${e}, ${r})
      }
    }
  `:""}function Un(t){return t===false?"return o":`
    var s = this.serialize(o)
    this.restore(o)
    return s
  `}function Kn(t,e){return t===true?"throw Error('fast-redact: primitives cannot be redacted')":e===false?"return o":"return this.serialize(o)"}});var nt=x((ou,_r)=>{_r.exports={groupRedact:Xn,groupRestore:Gn,nestedRedact:Qn,nestedRestore:Jn};function Gn({keys:t,values:e,target:r}){if(r==null||typeof r=="string")return;let i=t.length;for(var n=0;n<i;n++){let s=t[n];r[s]=e[n];}}function Xn(t,e,r,i,n){let s=Sr(t,e);if(s==null||typeof s=="string")return {keys:null,values:null,target:s,flat:true};let o=Object.keys(s),c=o.length,u=e.length,h=n?[...e]:void 0,f=new Array(c);for(var l=0;l<c;l++){let p=o[l];f[l]=s[p],n?(h[u]=p,s[p]=r(s[p],h)):i?s[p]=r(s[p]):s[p]=r;}return {keys:o,values:f,target:s,flat:true}}function Jn(t){for(let e=0;e<t.length;e++){let{target:r,path:i,value:n}=t[e],s=r;for(let o=i.length-1;o>0;o--)s=s[i[o]];s[i[0]]=n;}}function Qn(t,e,r,i,n,s,o){let c=Sr(e,r);if(c==null)return;let u=Object.keys(c),h=u.length;for(var f=0;f<h;f++){let l=u[f];Yn(t,c,l,r,i,n,s,o);}return t}function it(t,e){return t!=null?"hasOwn"in Object?Object.hasOwn(t,e):Object.prototype.hasOwnProperty.call(t,e):false}function Yn(t,e,r,i,n,s,o,c){let u=n.length,h=u-1,f=r;var l=-1,p,d,a,m=null,S,b,w=false,v=0,E=0,T=Zn();if(a=p=e[r],typeof p=="object"){for(;p!=null&&++l<u&&(E+=1,r=n[l],!(r!=="*"&&!m&&!(typeof p=="object"&&r in p)));)if(!(r==="*"&&(m==="*"&&(w=true),m=r,l!==h))){if(m){let R=Object.keys(p);for(var A=0;A<R.length;A++){let _=R[A];if(b=p[_],S=r==="*",w)T=U(T,_,E),v=l,a=vr(b,v-1,r,i,n,s,o,c,f,p,d,a,S,_,l,h,T,t,e[f],E+1);else if(S||typeof b=="object"&&b!==null&&r in b){if(S?a=b:a=b[r],d=l!==h?a:o?c?s(a,[...i,f,...n]):s(a):s,S){let P=ae(U(T,_,E),a,e[f]);t.push(P),p[_]=d;}else if(b[r]!==d)if(d===void 0&&s!==void 0||it(b,r)&&d===a)T=U(T,_,E);else {T=U(T,_,E);let P=ae(U(T,r,E+1),a,e[f]);t.push(P),b[r]=d;}}}m=null;}else {if(a=p[r],T=U(T,r,E),d=l!==h?a:o?c?s(a,[...i,f,...n]):s(a):s,!(it(p,r)&&d===a||d===void 0&&s!==void 0)){let R=ae(T,a,e[f]);t.push(R),p[r]=d;}p=p[r];}if(typeof p!="object")break}}}function Sr(t,e){for(var r=-1,i=e.length,n=t;n!=null&&++r<i;)n=n[e[r]];return n}function vr(t,e,r,i,n,s,o,c,u,h,f,l,p,d,a,y,m,S,b,w){if(e===0&&(p||typeof t=="object"&&t!==null&&r in t)){if(p?l=t:l=t[r],f=a!==y?l:o?c?s(l,[...i,u,...n]):s(l):s,p){let v=ae(m,l,b);S.push(v),h[d]=f;}else if(t[r]!==f){if(!(f===void 0&&s!==void 0||it(t,r)&&f===l)){let v=ae(U(m,r,w+1),l,b);S.push(v),t[r]=f;}}}for(let v in t)typeof t[v]=="object"&&(m=U(m,v,w),vr(t[v],e-1,r,i,n,s,o,c,u,h,f,l,p,d,a,y,m,S,b,w+1));}function Zn(){return {parent:null,key:null,children:[],depth:0}}function U(t,e,r){if(t.depth===r)return U(t.parent,e,r);var i={parent:t,key:e,depth:r,children:[]};return t.children.push(i),i}function ae(t,e,r){let i=t,n=[];do n.push(i.key),i=i.parent;while(i.parent!=null);return {path:n,value:e,target:r}}});var xr=x((au,Er)=>{var{groupRestore:es,nestedRestore:ts}=nt();Er.exports=rs;function rs(){return function(){if(this.restore){this.restore.state.secret=this.secret;return}let{secret:e,wcLen:r}=this,i=Object.keys(e),n=is(e,i),s=r>0,o=s?{secret:e,groupRestore:es,nestedRestore:ts}:{secret:e};this.restore=Function("o",ns(n,i,s)).bind(o),this.restore.state=o;}}function is(t,e){return e.map(r=>{let{circle:i,escPath:n,leadingBracket:s}=t[r],c=i?`o.${i} = secret[${n}].val`:`o${s?"":"."}${r} = secret[${n}].val`,u=`secret[${n}].val = undefined`;return `
      if (secret[${n}].val !== undefined) {
        try { ${c} } catch (e) {}
        ${u}
      }
    `}).join("")}function ns(t,e,r){return `
    const secret = this.secret
    ${r===true?`
    const keys = Object.keys(secret)
    const len = keys.length
    for (var i = len - 1; i >= ${e.length}; i--) {
      const k = keys[i]
      const o = secret[k]
      if (o) {
        if (o.flat === true) this.groupRestore(o)
        else this.nestedRestore(o)
        secret[k] = null
      }
    }
  `:""}
    ${t}
    return o
  `}});var Or=x((cu,Tr)=>{Tr.exports=ss;function ss(t){let{secret:e,censor:r,compileRestore:i,serialize:n,groupRedact:s,nestedRedact:o,wildcards:c,wcLen:u}=t,h=[{secret:e,censor:r,compileRestore:i}];return n!==false&&h.push({serialize:n}),u>0&&h.push({groupRedact:s,nestedRedact:o,wildcards:c,wcLen:u}),Object.assign(...h)}});var Pr=x((lu,Rr)=>{var Ar=hr(),os=yr(),as=wr(),cs=xr(),{groupRedact:ls,nestedRedact:us}=nt(),fs=Or(),ds=Se(),gs=Ar(),st=t=>t;st.restore=st;var hs="[REDACTED]";ot.rx=ds;ot.validator=Ar;Rr.exports=ot;function ot(t={}){let e=Array.from(new Set(t.paths||[])),r="serialize"in t&&(t.serialize===false||typeof t.serialize=="function")?t.serialize:JSON.stringify,i=t.remove;if(i===true&&r!==JSON.stringify)throw Error("fast-redact \u2013 remove option may only be set when serializer is JSON.stringify");let n=i===true?void 0:"censor"in t?t.censor:hs,s=typeof n=="function",o=s&&n.length>1;if(e.length===0)return r||st;gs({paths:e,serialize:r,censor:n});let{wildcards:c,wcLen:u,secret:h}=os({paths:e,censor:n}),f=cs(),l="strict"in t?t.strict:true;return as({secret:h,wcLen:u,serialize:r,strict:l,isCensorFct:s,censorFctTakesPath:o},fs({secret:h,censor:n,compileRestore:f,serialize:r,groupRedact:ls,nestedRedact:us,wildcards:c,wcLen:u}))}});var ie=x((uu,Ir)=>{var ms=Symbol("pino.setLevel"),ps=Symbol("pino.getLevel"),ys=Symbol("pino.levelVal"),bs=Symbol("pino.levelComp"),ws=Symbol("pino.useLevelLabels"),Ss=Symbol("pino.useOnlyCustomLevels"),vs=Symbol("pino.mixin"),_s=Symbol("pino.lsCache"),Es=Symbol("pino.chindings"),xs=Symbol("pino.asJson"),Ts=Symbol("pino.write"),Os=Symbol("pino.redactFmt"),As=Symbol("pino.time"),Rs=Symbol("pino.timeSliceIndex"),Ps=Symbol("pino.stream"),Is=Symbol("pino.stringify"),$s=Symbol("pino.stringifySafe"),Ls=Symbol("pino.stringifiers"),ks=Symbol("pino.end"),Cs=Symbol("pino.formatOpts"),Ds=Symbol("pino.messageKey"),Ms=Symbol("pino.errorKey"),js=Symbol("pino.nestedKey"),zs=Symbol("pino.nestedKeyStr"),qs=Symbol("pino.mixinMergeStrategy"),Ns=Symbol("pino.msgPrefix"),Vs=Symbol("pino.wildcardFirst"),Bs=Symbol.for("pino.serializers"),Fs=Symbol.for("pino.formatters"),Ws=Symbol.for("pino.hooks"),Hs=Symbol.for("pino.metadata");Ir.exports={setLevelSym:ms,getLevelSym:ps,levelValSym:ys,levelCompSym:bs,useLevelLabelsSym:ws,mixinSym:vs,lsCacheSym:_s,chindingsSym:Es,asJsonSym:xs,writeSym:Ts,serializersSym:Bs,redactFmtSym:Os,timeSym:As,timeSliceIndexSym:Rs,streamSym:Ps,stringifySym:Is,stringifySafeSym:$s,stringifiersSym:Ls,endSym:ks,formatOptsSym:Cs,messageKeySym:Ds,errorKeySym:Ms,nestedKeySym:js,wildcardFirstSym:Vs,needsMetadataGsym:Hs,useOnlyCustomLevelsSym:Ss,formattersSym:Fs,hooksSym:Ws,nestedKeyStrSym:zs,mixinMergeStrategySym:qs,msgPrefixSym:Ns};});var lt=x((fu,Cr)=>{var ct=Pr(),{redactFmtSym:Us,wildcardFirstSym:ve}=ie(),{rx:at,validator:Ks}=ct,$r=Ks({ERR_PATHS_MUST_BE_STRINGS:()=>"pino \u2013 redacted paths must be strings",ERR_INVALID_PATH:t=>`pino \u2013 redact paths array contains an invalid path (${t})`}),Lr="[Redacted]",kr=false;function Gs(t,e){let{paths:r,censor:i}=Xs(t),n=r.reduce((c,u)=>{at.lastIndex=0;let h=at.exec(u),f=at.exec(u),l=h[1]!==void 0?h[1].replace(/^(?:"|'|`)(.*)(?:"|'|`)$/,"$1"):h[0];if(l==="*"&&(l=ve),f===null)return c[l]=null,c;if(c[l]===null)return c;let{index:p}=f,d=`${u.substr(p,u.length-1)}`;return c[l]=c[l]||[],l!==ve&&c[l].length===0&&c[l].push(...c[ve]||[]),l===ve&&Object.keys(c).forEach(function(a){c[a]&&c[a].push(d);}),c[l].push(d),c},{}),s={[Us]:ct({paths:r,censor:i,serialize:e,strict:kr})},o=(...c)=>e(typeof i=="function"?i(...c):i);return [...Object.keys(n),...Object.getOwnPropertySymbols(n)].reduce((c,u)=>{if(n[u]===null)c[u]=h=>o(h,[u]);else {let h=typeof i=="function"?(f,l)=>i(f,[u,...l]):i;c[u]=ct({paths:n[u],censor:h,serialize:e,strict:kr});}return c},s)}function Xs(t){if(Array.isArray(t))return t={paths:t,censor:Lr},$r(t),t;let{paths:e,censor:r=Lr,remove:i}=t;if(Array.isArray(e)===false)throw Error("pino \u2013 redact must contain an array of strings");return i===true&&(r=void 0),$r({paths:e,censor:r}),{paths:e,censor:r}}Cr.exports=Gs;});var Mr=x((du,Dr)=>{var Js=()=>"",Qs=()=>`,"time":${Date.now()}`,Ys=()=>`,"time":${Math.round(Date.now()/1e3)}`,Zs=()=>`,"time":"${new Date(Date.now()).toISOString()}"`;Dr.exports={nullTime:Js,epochTime:Qs,unixTime:Ys,isoTime:Zs};});var zr=x((gu,jr)=>{function eo(t){try{return JSON.stringify(t)}catch{return '"[Circular]"'}}jr.exports=to;function to(t,e,r){var i=r&&r.stringify||eo,n=1;if(typeof t=="object"&&t!==null){var s=e.length+n;if(s===1)return t;var o=new Array(s);o[0]=i(t);for(var c=1;c<s;c++)o[c]=i(e[c]);return o.join(" ")}if(typeof t!="string")return t;var u=e.length;if(u===0)return t;for(var h="",f=1-n,l=-1,p=t&&t.length||0,d=0;d<p;){if(t.charCodeAt(d)===37&&d+1<p){switch(l=l>-1?l:0,t.charCodeAt(d+1)){case 100:case 102:if(f>=u||e[f]==null)break;l<d&&(h+=t.slice(l,d)),h+=Number(e[f]),l=d+2,d++;break;case 105:if(f>=u||e[f]==null)break;l<d&&(h+=t.slice(l,d)),h+=Math.floor(Number(e[f])),l=d+2,d++;break;case 79:case 111:case 106:if(f>=u||e[f]===void 0)break;l<d&&(h+=t.slice(l,d));var a=typeof e[f];if(a==="string"){h+="'"+e[f]+"'",l=d+2,d++;break}if(a==="function"){h+=e[f].name||"<anonymous>",l=d+2,d++;break}h+=i(e[f]),l=d+2,d++;break;case 115:if(f>=u)break;l<d&&(h+=t.slice(l,d)),h+=String(e[f]),l=d+2,d++;break;case 37:l<d&&(h+=t.slice(l,d)),h+="%",l=d+2,d++,f--;break}++f;}++d;}return l===-1?t:(l<p&&(h+=t.slice(l)),h)}});var ft=x((hu,ut)=>{if(typeof SharedArrayBuffer<"u"&&typeof Atomics<"u"){let e=function(r){if((r>0&&r<1/0)===false)throw typeof r!="number"&&typeof r!="bigint"?TypeError("sleep: ms must be a number"):RangeError("sleep: ms must be a number that is greater than 0 but less than Infinity");Atomics.wait(t,0,0,Number(r));},t=new Int32Array(new SharedArrayBuffer(4));ut.exports=e;}else {let t=function(e){if((e>0&&e<1/0)===false)throw typeof e!="number"&&typeof e!="bigint"?TypeError("sleep: ms must be a number"):RangeError("sleep: ms must be a number that is greater than 0 but less than Infinity");};ut.exports=t;}});var Ur=x((mu,Hr)=>{var I=C("fs"),ro=C("events"),io=C("util").inherits,qr=C("path"),gt=ft(),no=C("assert"),_e=100,Ee=Buffer.allocUnsafe(0),so=16*1024,Nr="buffer",Vr="utf8",[oo,ao]=(process.versions.node||"0.0").split(".").map(Number),co=oo>=22&&ao>=7;function Br(t,e){e._opening=true,e._writing=true,e._asyncDrainScheduled=false;function r(s,o){if(s){e._reopening=false,e._writing=false,e._opening=false,e.sync?process.nextTick(()=>{e.listenerCount("error")>0&&e.emit("error",s);}):e.emit("error",s);return}let c=e._reopening;e.fd=o,e.file=t,e._reopening=false,e._opening=false,e._writing=false,e.sync?process.nextTick(()=>e.emit("ready")):e.emit("ready"),!e.destroyed&&(!e._writing&&e._len>e.minLength||e._flushPending?e._actualWrite():c&&process.nextTick(()=>e.emit("drain")));}let i=e.append?"a":"w",n=e.mode;if(e.sync)try{e.mkdir&&I.mkdirSync(qr.dirname(t),{recursive:!0});let s=I.openSync(t,i,n);r(null,s);}catch(s){throw r(s),s}else e.mkdir?I.mkdir(qr.dirname(t),{recursive:true},s=>{if(s)return r(s);I.open(t,i,n,r);}):I.open(t,i,n,r);}function V(t){if(!(this instanceof V))return new V(t);let{fd:e,dest:r,minLength:i,maxLength:n,maxWrite:s,periodicFlush:o,sync:c,append:u=true,mkdir:h,retryEAGAIN:f,fsync:l,contentMode:p,mode:d}=t||{};e=e||r,this._len=0,this.fd=-1,this._bufs=[],this._lens=[],this._writing=false,this._ending=false,this._reopening=false,this._asyncDrainScheduled=false,this._flushPending=false,this._hwm=Math.max(i||0,16387),this.file=null,this.destroyed=false,this.minLength=i||0,this.maxLength=n||0,this.maxWrite=s||so,this._periodicFlush=o||0,this._periodicFlushTimer=void 0,this.sync=c||false,this.writable=true,this._fsync=l||false,this.append=u||false,this.mode=d,this.retryEAGAIN=f||(()=>true),this.mkdir=h||false;let a,y;if(p===Nr)this._writingBuf=Ee,this.write=fo,this.flush=ho,this.flushSync=po,this._actualWrite=bo,a=()=>I.writeSync(this.fd,this._writingBuf),y=()=>I.write(this.fd,this._writingBuf,this.release);else if(p===void 0||p===Vr)this._writingBuf="",this.write=uo,this.flush=go,this.flushSync=mo,this._actualWrite=yo,a=()=>I.writeSync(this.fd,this._writingBuf,"utf8"),y=()=>I.write(this.fd,this._writingBuf,"utf8",this.release);else throw new Error(`SonicBoom supports "${Vr}" and "${Nr}", but passed ${p}`);if(typeof e=="number")this.fd=e,process.nextTick(()=>this.emit("ready"));else if(typeof e=="string")Br(e,this);else throw new Error("SonicBoom supports only file descriptors and files");if(this.minLength>=this.maxWrite)throw new Error(`minLength should be smaller than maxWrite (${this.maxWrite})`);this.release=(m,S)=>{if(m){if((m.code==="EAGAIN"||m.code==="EBUSY")&&this.retryEAGAIN(m,this._writingBuf.length,this._len-this._writingBuf.length))if(this.sync)try{gt(_e),this.release(void 0,0);}catch(v){this.release(v);}else setTimeout(y,_e);else this._writing=false,this.emit("error",m);return}this.emit("write",S);let b=dt(this._writingBuf,this._len,S);if(this._len=b.len,this._writingBuf=b.writingBuf,this._writingBuf.length){if(!this.sync){y();return}try{do{let v=a(),E=dt(this._writingBuf,this._len,v);this._len=E.len,this._writingBuf=E.writingBuf;}while(this._writingBuf.length)}catch(v){this.release(v);return}}this._fsync&&I.fsyncSync(this.fd);let w=this._len;this._reopening?(this._writing=false,this._reopening=false,this.reopen()):w>this.minLength?this._actualWrite():this._ending?w>0?this._actualWrite():(this._writing=false,xe(this)):(this._writing=false,this.sync?this._asyncDrainScheduled||(this._asyncDrainScheduled=true,process.nextTick(lo,this)):this.emit("drain"));},this.on("newListener",function(m){m==="drain"&&(this._asyncDrainScheduled=false);}),this._periodicFlush!==0&&(this._periodicFlushTimer=setInterval(()=>this.flush(null),this._periodicFlush),this._periodicFlushTimer.unref());}function dt(t,e,r){return typeof t=="string"&&Buffer.byteLength(t)!==r&&(r=Buffer.from(t).subarray(0,r).toString().length),e=Math.max(e-r,0),t=t.slice(r),{writingBuf:t,len:e}}function lo(t){t.listenerCount("drain")>0&&(t._asyncDrainScheduled=false,t.emit("drain"));}io(V,ro);function Fr(t,e){return t.length===0?Ee:t.length===1?t[0]:Buffer.concat(t,e)}function uo(t){if(this.destroyed)throw new Error("SonicBoom destroyed");let e=this._len+t.length,r=this._bufs;return this.maxLength&&e>this.maxLength?(this.emit("drop",t),this._len<this._hwm):(r.length===0||r[r.length-1].length+t.length>this.maxWrite?r.push(""+t):r[r.length-1]+=t,this._len=e,!this._writing&&this._len>=this.minLength&&this._actualWrite(),this._len<this._hwm)}function fo(t){if(this.destroyed)throw new Error("SonicBoom destroyed");let e=this._len+t.length,r=this._bufs,i=this._lens;return this.maxLength&&e>this.maxLength?(this.emit("drop",t),this._len<this._hwm):(r.length===0||i[i.length-1]+t.length>this.maxWrite?(r.push([t]),i.push(t.length)):(r[r.length-1].push(t),i[i.length-1]+=t.length),this._len=e,!this._writing&&this._len>=this.minLength&&this._actualWrite(),this._len<this._hwm)}function Wr(t){this._flushPending=true;let e=()=>{if(this._fsync)this._flushPending=false,t();else try{I.fsync(this.fd,i=>{this._flushPending=!1,t(i);});}catch(i){t(i);}this.off("error",r);},r=i=>{this._flushPending=false,t(i),this.off("drain",e);};this.once("drain",e),this.once("error",r);}function go(t){if(t!=null&&typeof t!="function")throw new Error("flush cb must be a function");if(this.destroyed){let e=new Error("SonicBoom destroyed");if(t){t(e);return}throw e}if(this.minLength<=0){t?.();return}t&&Wr.call(this,t),!this._writing&&(this._bufs.length===0&&this._bufs.push(""),this._actualWrite());}function ho(t){if(t!=null&&typeof t!="function")throw new Error("flush cb must be a function");if(this.destroyed){let e=new Error("SonicBoom destroyed");if(t){t(e);return}throw e}if(this.minLength<=0){t?.();return}t&&Wr.call(this,t),!this._writing&&(this._bufs.length===0&&(this._bufs.push([]),this._lens.push(0)),this._actualWrite());}V.prototype.reopen=function(t){if(this.destroyed)throw new Error("SonicBoom destroyed");if(this._opening){this.once("ready",()=>{this.reopen(t);});return}if(this._ending)return;if(!this.file)throw new Error("Unable to reopen a file descriptor, you must pass a file to SonicBoom");if(t&&(this.file=t),this._reopening=true,this._writing)return;let e=this.fd;this.once("ready",()=>{e!==this.fd&&I.close(e,r=>{if(r)return this.emit("error",r)});}),Br(this.file,this);};V.prototype.end=function(){if(this.destroyed)throw new Error("SonicBoom destroyed");if(this._opening){this.once("ready",()=>{this.end();});return}this._ending||(this._ending=true,!this._writing&&(this._len>0&&this.fd>=0?this._actualWrite():xe(this)));};function mo(){if(this.destroyed)throw new Error("SonicBoom destroyed");if(this.fd<0)throw new Error("sonic boom is not ready yet");!this._writing&&this._writingBuf.length>0&&(this._bufs.unshift(this._writingBuf),this._writingBuf="");let t="";for(;this._bufs.length||t;){t.length<=0&&(t=this._bufs[0]);try{let e=I.writeSync(this.fd,t,"utf8"),r=dt(t,this._len,e);t=r.writingBuf,this._len=r.len,t.length<=0&&this._bufs.shift();}catch(e){if((e.code==="EAGAIN"||e.code==="EBUSY")&&!this.retryEAGAIN(e,t.length,this._len-t.length))throw e;gt(_e);}}try{I.fsyncSync(this.fd);}catch{}}function po(){if(this.destroyed)throw new Error("SonicBoom destroyed");if(this.fd<0)throw new Error("sonic boom is not ready yet");!this._writing&&this._writingBuf.length>0&&(this._bufs.unshift([this._writingBuf]),this._writingBuf=Ee);let t=Ee;for(;this._bufs.length||t.length;){t.length<=0&&(t=Fr(this._bufs[0],this._lens[0]));try{let e=I.writeSync(this.fd,t);t=t.subarray(e),this._len=Math.max(this._len-e,0),t.length<=0&&(this._bufs.shift(),this._lens.shift());}catch(e){if((e.code==="EAGAIN"||e.code==="EBUSY")&&!this.retryEAGAIN(e,t.length,this._len-t.length))throw e;gt(_e);}}}V.prototype.destroy=function(){this.destroyed||xe(this);};function yo(){let t=this.release;if(this._writing=true,this._writingBuf=this._writingBuf||this._bufs.shift()||"",this.sync)try{let e=I.writeSync(this.fd,this._writingBuf,"utf8");t(null,e);}catch(e){t(e);}else I.write(this.fd,this._writingBuf,"utf8",t);}function bo(){let t=this.release;if(this._writing=true,this._writingBuf=this._writingBuf.length?this._writingBuf:Fr(this._bufs.shift(),this._lens.shift()),this.sync)try{let e=I.writeSync(this.fd,this._writingBuf);t(null,e);}catch(e){t(e);}else co&&(this._writingBuf=Buffer.from(this._writingBuf)),I.write(this.fd,this._writingBuf,t);}function xe(t){if(t.fd===-1){t.once("ready",xe.bind(null,t));return}t._periodicFlushTimer!==void 0&&clearInterval(t._periodicFlushTimer),t.destroyed=true,t._bufs=[],t._lens=[],no(typeof t.fd=="number",`sonic.fd must be a number, got ${typeof t.fd}`);try{I.fsync(t.fd,e);}catch{}function e(){t.fd!==1&&t.fd!==2?I.close(t.fd,r):r();}function r(i){if(i){t.emit("error",i);return}t._ending&&!t._writing&&t.emit("finish"),t.emit("close");}}V.SonicBoom=V;V.default=V;Hr.exports=V;});var ht=x((pu,Qr)=>{var B={exit:[],beforeExit:[]},Kr={exit:vo,beforeExit:_o},ne;function wo(){ne===void 0&&(ne=new FinalizationRegistry(Eo));}function So(t){B[t].length>0||process.on(t,Kr[t]);}function Gr(t){B[t].length>0||(process.removeListener(t,Kr[t]),B.exit.length===0&&B.beforeExit.length===0&&(ne=void 0));}function vo(){Xr("exit");}function _o(){Xr("beforeExit");}function Xr(t){for(let e of B[t]){let r=e.deref(),i=e.fn;r!==void 0&&i(r,t);}B[t]=[];}function Eo(t){for(let e of ["exit","beforeExit"]){let r=B[e].indexOf(t);B[e].splice(r,r+1),Gr(e);}}function Jr(t,e,r){if(e===void 0)throw new Error("the object can't be undefined");So(t);let i=new WeakRef(e);i.fn=r,wo(),ne.register(e,i),B[t].push(i);}function xo(t,e){Jr("exit",t,e);}function To(t,e){Jr("beforeExit",t,e);}function Oo(t){if(ne!==void 0){ne.unregister(t);for(let e of ["exit","beforeExit"])B[e]=B[e].filter(r=>{let i=r.deref();return i&&i!==t}),Gr(e);}}Qr.exports={register:xo,registerBeforeExit:To,unregister:Oo};});var Yr=x((yu,Ao)=>{Ao.exports={name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"};});var ei=x((bu,Zr)=>{function Ro(t,e,r,i,n){let s=Date.now()+i,o=Atomics.load(t,e);if(o===r){n(null,"ok");return}let c=o,u=h=>{Date.now()>s?n(null,"timed-out"):setTimeout(()=>{c=o,o=Atomics.load(t,e),o===c?u(h>=1e3?1e3:h*2):o===r?n(null,"ok"):n(null,"not-equal");},h);};u(1);}function Po(t,e,r,i,n){let s=Date.now()+i,o=Atomics.load(t,e);if(o!==r){n(null,"ok");return}let c=u=>{Date.now()>s?n(null,"timed-out"):setTimeout(()=>{o=Atomics.load(t,e),o!==r?n(null,"ok"):c(u>=1e3?1e3:u*2);},u);};c(1);}Zr.exports={wait:Ro,waitDiff:Po};});var ri=x((wu,ti)=>{ti.exports={WRITE_INDEX:4,READ_INDEX:8};});var ai=x((Su,oi)=>{var{version:Io}=Yr(),{EventEmitter:$o}=C("events"),{Worker:Lo}=C("worker_threads"),{join:ko}=C("path"),{pathToFileURL:Co}=C("url"),{wait:Do}=ei(),{WRITE_INDEX:M,READ_INDEX:F}=ri(),Mo=C("buffer"),jo=C("assert"),g=Symbol("kImpl"),zo=Mo.constants.MAX_STRING_LENGTH,ce=class{constructor(e){this._value=e;}deref(){return this._value}},Oe=class{register(){}unregister(){}},qo=process.env.NODE_V8_COVERAGE?Oe:global.FinalizationRegistry||Oe,No=process.env.NODE_V8_COVERAGE?ce:global.WeakRef||ce,ii=new qo(t=>{t.exited||t.terminate();});function Vo(t,e){let{filename:r,workerData:i}=e,s=("__bundlerPathsOverrides"in globalThis?globalThis.__bundlerPathsOverrides:{})["thread-stream-worker"]||ko(__dirname,"lib","worker.js"),o=new Lo(s,{...e.workerOpts,trackUnmanagedFds:false,workerData:{filename:r.indexOf("file://")===0?r:Co(r).href,dataBuf:t[g].dataBuf,stateBuf:t[g].stateBuf,workerData:{$context:{threadStreamVersion:Io},...i}}});return o.stream=new ce(t),o.on("message",Bo),o.on("exit",si),ii.register(t,o),o}function ni(t){jo(!t[g].sync),t[g].needDrain&&(t[g].needDrain=false,t.emit("drain"));}function Te(t){let e=Atomics.load(t[g].state,M),r=t[g].data.length-e;if(r>0){if(t[g].buf.length===0){t[g].flushing=false,t[g].ending?wt(t):t[g].needDrain&&process.nextTick(ni,t);return}let i=t[g].buf.slice(0,r),n=Buffer.byteLength(i);n<=r?(t[g].buf=t[g].buf.slice(r),Ae(t,i,Te.bind(null,t))):t.flush(()=>{if(!t.destroyed){for(Atomics.store(t[g].state,F,0),Atomics.store(t[g].state,M,0);n>t[g].data.length;)r=r/2,i=t[g].buf.slice(0,r),n=Buffer.byteLength(i);t[g].buf=t[g].buf.slice(r),Ae(t,i,Te.bind(null,t));}});}else if(r===0){if(e===0&&t[g].buf.length===0)return;t.flush(()=>{Atomics.store(t[g].state,F,0),Atomics.store(t[g].state,M,0),Te(t);});}else W(t,new Error("overwritten"));}function Bo(t){let e=this.stream.deref();if(e===void 0){this.exited=true,this.terminate();return}switch(t.code){case "READY":this.stream=new No(e),e.flush(()=>{e[g].ready=true,e.emit("ready");});break;case "ERROR":W(e,t.err);break;case "EVENT":Array.isArray(t.args)?e.emit(t.name,...t.args):e.emit(t.name,t.args);break;case "WARNING":process.emitWarning(t.err);break;default:W(e,new Error("this should not happen: "+t.code));}}function si(t){let e=this.stream.deref();e!==void 0&&(ii.unregister(e),e.worker.exited=true,e.worker.off("exit",si),W(e,t!==0?new Error("the worker thread exited"):null));}var pt=class extends $o{constructor(e={}){if(super(),e.bufferSize<4)throw new Error("bufferSize must at least fit a 4-byte utf-8 char");this[g]={},this[g].stateBuf=new SharedArrayBuffer(128),this[g].state=new Int32Array(this[g].stateBuf),this[g].dataBuf=new SharedArrayBuffer(e.bufferSize||4*1024*1024),this[g].data=Buffer.from(this[g].dataBuf),this[g].sync=e.sync||false,this[g].ending=false,this[g].ended=false,this[g].needDrain=false,this[g].destroyed=false,this[g].flushing=false,this[g].ready=false,this[g].finished=false,this[g].errored=null,this[g].closed=false,this[g].buf="",this.worker=Vo(this,e),this.on("message",(r,i)=>{this.worker.postMessage(r,i);});}write(e){if(this[g].destroyed)return yt(this,new Error("the worker has exited")),false;if(this[g].ending)return yt(this,new Error("the worker is ending")),false;if(this[g].flushing&&this[g].buf.length+e.length>=zo)try{mt(this),this[g].flushing=!0;}catch(r){return W(this,r),false}if(this[g].buf+=e,this[g].sync)try{return mt(this),!0}catch(r){return W(this,r),false}return this[g].flushing||(this[g].flushing=true,setImmediate(Te,this)),this[g].needDrain=this[g].data.length-this[g].buf.length-Atomics.load(this[g].state,M)<=0,!this[g].needDrain}end(){this[g].destroyed||(this[g].ending=true,wt(this));}flush(e){if(this[g].destroyed){typeof e=="function"&&process.nextTick(e,new Error("the worker has exited"));return}let r=Atomics.load(this[g].state,M);Do(this[g].state,F,r,1/0,(i,n)=>{if(i){W(this,i),process.nextTick(e,i);return}if(n==="not-equal"){this.flush(e);return}process.nextTick(e);});}flushSync(){this[g].destroyed||(mt(this),bt(this));}unref(){this.worker.unref();}ref(){this.worker.ref();}get ready(){return this[g].ready}get destroyed(){return this[g].destroyed}get closed(){return this[g].closed}get writable(){return !this[g].destroyed&&!this[g].ending}get writableEnded(){return this[g].ending}get writableFinished(){return this[g].finished}get writableNeedDrain(){return this[g].needDrain}get writableObjectMode(){return  false}get writableErrored(){return this[g].errored}};function yt(t,e){setImmediate(()=>{t.emit("error",e);});}function W(t,e){t[g].destroyed||(t[g].destroyed=true,e&&(t[g].errored=e,yt(t,e)),t.worker.exited?setImmediate(()=>{t[g].closed=true,t.emit("close");}):t.worker.terminate().catch(()=>{}).then(()=>{t[g].closed=true,t.emit("close");}));}function Ae(t,e,r){let i=Atomics.load(t[g].state,M),n=Buffer.byteLength(e);return t[g].data.write(e,i),Atomics.store(t[g].state,M,i+n),Atomics.notify(t[g].state,M),r(),true}function wt(t){if(!(t[g].ended||!t[g].ending||t[g].flushing)){t[g].ended=true;try{t.flushSync();let e=Atomics.load(t[g].state,F);Atomics.store(t[g].state,M,-1),Atomics.notify(t[g].state,M);let r=0;for(;e!==-1;){if(Atomics.wait(t[g].state,F,e,1e3),e=Atomics.load(t[g].state,F),e===-2){W(t,new Error("end() failed"));return}if(++r===10){W(t,new Error("end() took too long (10s)"));return}}process.nextTick(()=>{t[g].finished=!0,t.emit("finish");});}catch(e){W(t,e);}}}function mt(t){let e=()=>{t[g].ending?wt(t):t[g].needDrain&&process.nextTick(ni,t);};for(t[g].flushing=false;t[g].buf.length!==0;){let r=Atomics.load(t[g].state,M),i=t[g].data.length-r;if(i===0){bt(t),Atomics.store(t[g].state,F,0),Atomics.store(t[g].state,M,0);continue}else if(i<0)throw new Error("overwritten");let n=t[g].buf.slice(0,i),s=Buffer.byteLength(n);if(s<=i)t[g].buf=t[g].buf.slice(i),Ae(t,n,e);else {for(bt(t),Atomics.store(t[g].state,F,0),Atomics.store(t[g].state,M,0);s>t[g].buf.length;)i=i/2,n=t[g].buf.slice(0,i),s=Buffer.byteLength(n);t[g].buf=t[g].buf.slice(i),Ae(t,n,e);}}}function bt(t){if(t[g].flushing)throw new Error("unable to flush while flushing");let e=Atomics.load(t[g].state,M),r=0;for(;;){let i=Atomics.load(t[g].state,F);if(i===-2)throw Error("_flushSync failed");if(i!==e)Atomics.wait(t[g].state,F,i,1e3);else break;if(++r===10)throw new Error("_flushSync took too long (10s)")}}oi.exports=pt;});var _t=x((vu,ci)=>{var{createRequire:Fo}=C("module"),Wo=rt(),{join:St,isAbsolute:Ho,sep:Uo}=C("path"),Ko=ft(),vt=ht(),Go=ai();function Xo(t){vt.register(t,Qo),vt.registerBeforeExit(t,Yo),t.on("close",function(){vt.unregister(t);});}function Jo(t,e,r,i){let n=new Go({filename:t,workerData:e,workerOpts:r,sync:i});n.on("ready",s),n.on("close",function(){process.removeListener("exit",o);}),process.on("exit",o);function s(){process.removeListener("exit",o),n.unref(),r.autoEnd!==false&&Xo(n);}function o(){n.closed||(n.flushSync(),Ko(100),n.end());}return n}function Qo(t){t.ref(),t.flushSync(),t.end(),t.once("close",function(){t.unref();});}function Yo(t){t.flushSync();}function Zo(t){let{pipeline:e,targets:r,levels:i,dedupe:n,worker:s={},caller:o=Wo(),sync:c=false}=t,u={...t.options},h=typeof o=="string"?[o]:o,f="__bundlerPathsOverrides"in globalThis?globalThis.__bundlerPathsOverrides:{},l=t.target;if(l&&r)throw new Error("only one of target or targets can be specified");return r?(l=f["pino-worker"]||St(__dirname,"worker.js"),u.targets=r.filter(d=>d.target).map(d=>({...d,target:p(d.target)})),u.pipelines=r.filter(d=>d.pipeline).map(d=>d.pipeline.map(a=>({...a,level:d.level,target:p(a.target)})))):e&&(l=f["pino-worker"]||St(__dirname,"worker.js"),u.pipelines=[e.map(d=>({...d,target:p(d.target)}))]),i&&(u.levels=i),n&&(u.dedupe=n),u.pinoWillSendConfig=true,Jo(p(l),u,s,c);function p(d){if(d=f[d]||d,Ho(d)||d.indexOf("file://")===0)return d;if(d==="pino/file")return St(__dirname,"..","file.js");let a;for(let y of h)try{let m=y==="node:repl"?process.cwd()+Uo:y;a=Fo(m).resolve(d);break}catch{continue}if(!a)throw new Error(`unable to determine transport target for "${d}"`);return a}}ci.exports=Zo;});var Ie=x((_u,wi)=>{var li=zr(),{mapHttpRequest:ea,mapHttpResponse:ta}=tt(),xt=Ur(),ui=ht(),{lsCacheSym:ra,chindingsSym:gi,writeSym:fi,serializersSym:hi,formatOptsSym:di,endSym:ia,stringifiersSym:mi,stringifySym:pi,stringifySafeSym:Tt,wildcardFirstSym:yi,nestedKeySym:na,formattersSym:bi,messageKeySym:sa,errorKeySym:oa,nestedKeyStrSym:aa,msgPrefixSym:Re}=ie(),{isMainThread:ca}=C("worker_threads"),la=_t();function se(){}function ua(t,e){if(!e)return r;return function(...n){e.call(this,n,r,t);};function r(i,...n){if(typeof i=="object"){let s=i;i!==null&&(i.method&&i.headers&&i.socket?i=ea(i):typeof i.setHeader=="function"&&(i=ta(i)));let o;s===null&&n.length===0?o=[null]:(s=n.shift(),o=n),typeof this[Re]=="string"&&s!==void 0&&s!==null&&(s=this[Re]+s),this[fi](i,li(s,o,this[di]),t);}else {let s=i===void 0?n.shift():i;typeof this[Re]=="string"&&s!==void 0&&s!==null&&(s=this[Re]+s),this[fi](null,li(s,n,this[di]),t);}}}function Et(t){let e="",r=0,i=false,n=255,s=t.length;if(s>100)return JSON.stringify(t);for(var o=0;o<s&&n>=32;o++)n=t.charCodeAt(o),(n===34||n===92)&&(e+=t.slice(r,o)+"\\",r=o,i=true);return i?e+=t.slice(r):e=t,n<32?JSON.stringify(t):'"'+e+'"'}function fa(t,e,r,i){let n=this[pi],s=this[Tt],o=this[mi],c=this[ia],u=this[gi],h=this[hi],f=this[bi],l=this[sa],p=this[oa],d=this[ra][r]+i;d=d+u;let a;f.log&&(t=f.log(t));let y=o[yi],m="";for(let b in t)if(a=t[b],Object.prototype.hasOwnProperty.call(t,b)&&a!==void 0){h[b]?a=h[b](a):b===p&&h.err&&(a=h.err(a));let w=o[b]||y;switch(typeof a){case "undefined":case "function":continue;case "number":Number.isFinite(a)===false&&(a=null);case "boolean":w&&(a=w(a));break;case "string":a=(w||Et)(a);break;default:a=(w||n)(a,s);}if(a===void 0)continue;let v=Et(b);m+=","+v+":"+a;}let S="";if(e!==void 0){a=h[l]?h[l](e):e;let b=o[l]||y;switch(typeof a){case "function":break;case "number":Number.isFinite(a)===false&&(a=null);case "boolean":b&&(a=b(a)),S=',"'+l+'":'+a;break;case "string":a=(b||Et)(a),S=',"'+l+'":'+a;break;default:a=(b||n)(a,s),S=',"'+l+'":'+a;}}return this[na]&&m?d+this[aa]+m.slice(1)+"}"+S+c:d+m+S+c}function da(t,e){let r,i=t[gi],n=t[pi],s=t[Tt],o=t[mi],c=o[yi],u=t[hi],h=t[bi].bindings;e=h(e);for(let f in e)if(r=e[f],(f!=="level"&&f!=="serializers"&&f!=="formatters"&&f!=="customLevels"&&e.hasOwnProperty(f)&&r!==void 0)===true){if(r=u[f]?u[f](r):r,r=(o[f]||c||n)(r,s),r===void 0)continue;i+=',"'+f+'":'+r;}return i}function ga(t){return t.write!==t.constructor.prototype.write}function Pe(t){let e=new xt(t);return e.on("error",r),!t.sync&&ca&&(ui.register(e,ha),e.on("close",function(){ui.unregister(e);})),e;function r(i){if(i.code==="EPIPE"){e.write=se,e.end=se,e.flushSync=se,e.destroy=se;return}e.removeListener("error",r),e.emit("error",i);}}function ha(t,e){t.destroyed||(e==="beforeExit"?(t.flush(),t.on("drain",function(){t.end();})):t.flushSync());}function ma(t){return function(r,i,n={},s){if(typeof n=="string")s=Pe({dest:n}),n={};else if(typeof s=="string"){if(n&&n.transport)throw Error("only one of option.transport or stream can be specified");s=Pe({dest:s});}else if(n instanceof xt||n.writable||n._writableState)s=n,n={};else if(n.transport){if(n.transport instanceof xt||n.transport.writable||n.transport._writableState)throw Error("option.transport do not allow stream, please pass to option directly. e.g. pino(transport)");if(n.transport.targets&&n.transport.targets.length&&n.formatters&&typeof n.formatters.level=="function")throw Error("option.transport.targets do not allow custom level formatters");let u;n.customLevels&&(u=n.useOnlyCustomLevels?n.customLevels:Object.assign({},n.levels,n.customLevels)),s=la({caller:i,...n.transport,levels:u});}if(n=Object.assign({},t,n),n.serializers=Object.assign({},t.serializers,n.serializers),n.formatters=Object.assign({},t.formatters,n.formatters),n.prettyPrint)throw new Error("prettyPrint option is no longer supported, see the pino-pretty package (https://github.com/pinojs/pino-pretty)");let{enabled:o,onChild:c}=n;return o===false&&(n.level="silent"),c||(n.onChild=se),s||(ga(process.stdout)?s=process.stdout:s=Pe({fd:process.stdout.fd||1})),{opts:n,stream:s}}}function pa(t,e){try{return JSON.stringify(t)}catch{try{return (e||this[Tt])(t)}catch{return '"[unable to serialize, circular reference is too complex to analyze]"'}}}function ya(t,e,r){return {level:t,bindings:e,log:r}}function ba(t){let e=Number(t);return typeof t=="string"&&Number.isFinite(e)?e:t===void 0?1:t}wi.exports={noop:se,buildSafeSonicBoom:Pe,asChindings:da,asJson:fa,genLog:ua,createArgsNormalizer:ma,stringify:pa,buildFormatters:ya,normalizeDestFileDescriptor:ba};});var $e=x((Eu,Si)=>{var wa={trace:10,debug:20,info:30,warn:40,error:50,fatal:60},Sa={ASC:"ASC",DESC:"DESC"};Si.exports={DEFAULT_LEVELS:wa,SORTING_ORDER:Sa};});var Rt=x((xu,xi)=>{var{lsCacheSym:va,levelValSym:Ot,useOnlyCustomLevelsSym:_a,streamSym:Ea,formattersSym:xa,hooksSym:Ta,levelCompSym:vi}=ie(),{noop:Oa,genLog:Q}=Ie(),{DEFAULT_LEVELS:H,SORTING_ORDER:_i}=$e(),Ei={fatal:t=>{let e=Q(H.fatal,t);return function(...r){let i=this[Ea];if(e.call(this,...r),typeof i.flushSync=="function")try{i.flushSync();}catch{}}},error:t=>Q(H.error,t),warn:t=>Q(H.warn,t),info:t=>Q(H.info,t),debug:t=>Q(H.debug,t),trace:t=>Q(H.trace,t)},At=Object.keys(H).reduce((t,e)=>(t[H[e]]=e,t),{}),Aa=Object.keys(At).reduce((t,e)=>(t[e]='{"level":'+Number(e),t),{});function Ra(t){let e=t[xa].level,{labels:r}=t.levels,i={};for(let n in r){let s=e(r[n],Number(n));i[n]=JSON.stringify(s).slice(0,-1);}return t[va]=i,t}function Pa(t,e){if(e)return  false;switch(t){case "fatal":case "error":case "warn":case "info":case "debug":case "trace":return  true;default:return  false}}function Ia(t){let{labels:e,values:r}=this.levels;if(typeof t=="number"){if(e[t]===void 0)throw Error("unknown level value"+t);t=e[t];}if(r[t]===void 0)throw Error("unknown level "+t);let i=this[Ot],n=this[Ot]=r[t],s=this[_a],o=this[vi],c=this[Ta].logMethod;for(let u in r){if(o(r[u],n)===false){this[u]=Oa;continue}this[u]=Pa(u,s)?Ei[u](c):Q(r[u],c);}this.emit("level-change",t,n,e[i],i,this);}function $a(t){let{levels:e,levelVal:r}=this;return e&&e.labels?e.labels[r]:""}function La(t){let{values:e}=this.levels,r=e[t];return r!==void 0&&this[vi](r,this[Ot])}function ka(t,e,r){return t===_i.DESC?e<=r:e>=r}function Ca(t){return typeof t=="string"?ka.bind(null,t):t}function Da(t=null,e=false){let r=t?Object.keys(t).reduce((s,o)=>(s[t[o]]=o,s),{}):null,i=Object.assign(Object.create(Object.prototype,{Infinity:{value:"silent"}}),e?null:At,r),n=Object.assign(Object.create(Object.prototype,{silent:{value:1/0}}),e?null:H,t);return {labels:i,values:n}}function Ma(t,e,r){if(typeof t=="number"){if(![].concat(Object.keys(e||{}).map(s=>e[s]),r?[]:Object.keys(At).map(s=>+s),1/0).includes(t))throw Error(`default level:${t} must be included in custom levels`);return}let i=Object.assign(Object.create(Object.prototype,{silent:{value:1/0}}),r?null:H,e);if(!(t in i))throw Error(`default level:${t} must be included in custom levels`)}function ja(t,e){let{labels:r,values:i}=t;for(let n in e){if(n in i)throw Error("levels cannot be overridden");if(e[n]in r)throw Error("pre-existing level values cannot be used for new levels")}}function za(t){if(typeof t!="function"&&!(typeof t=="string"&&Object.values(_i).includes(t)))throw new Error('Levels comparison should be one of "ASC", "DESC" or "function" type')}xi.exports={initialLsCache:Aa,genLsCache:Ra,levelMethods:Ei,getLevel:$a,setLevel:Ia,isLevelEnabled:La,mappings:Da,assertNoLevelCollisions:ja,assertDefaultLevelFound:Ma,genLevelComparison:Ca,assertLevelComparison:za};});var Pt=x((Tu,Ti)=>{Ti.exports={version:"9.9.4"};});var Di=x((Au,Ci)=>{var{EventEmitter:qa}=C("events"),{lsCacheSym:Na,levelValSym:Va,setLevelSym:$t,getLevelSym:Oi,chindingsSym:kt,parsedChindingsSym:Ba,mixinSym:Fa,asJsonSym:Ii,writeSym:Wa,mixinMergeStrategySym:Ha,timeSym:Ua,timeSliceIndexSym:Ka,streamSym:$i,serializersSym:Y,formattersSym:It,errorKeySym:Ga,messageKeySym:Xa,useOnlyCustomLevelsSym:Ja,needsMetadataGsym:Qa,redactFmtSym:Ya,stringifySym:Za,formatOptsSym:ec,stringifiersSym:tc,msgPrefixSym:Lt,hooksSym:rc}=ie(),{getLevel:ic,setLevel:nc,isLevelEnabled:sc,mappings:oc,initialLsCache:ac,genLsCache:cc,assertNoLevelCollisions:lc}=Rt(),{asChindings:Li,asJson:uc,buildFormatters:Ai,stringify:Ri}=Ie(),{version:fc}=Pt(),dc=lt(),gc=class{},ki={constructor:gc,child:hc,bindings:mc,setBindings:pc,flush:Sc,isLevelEnabled:sc,version:fc,get level(){return this[Oi]()},set level(t){this[$t](t);},get levelVal(){return this[Va]},set levelVal(t){throw Error("levelVal is read-only")},get msgPrefix(){return this[Lt]},[Na]:ac,[Wa]:bc,[Ii]:uc,[Oi]:ic,[$t]:nc};Object.setPrototypeOf(ki,qa.prototype);Ci.exports=function(){return Object.create(ki)};var Pi=t=>t;function hc(t,e){if(!t)throw Error("missing bindings for child Pino");e=e||{};let r=this[Y],i=this[It],n=Object.create(this);if(e.hasOwnProperty("serializers")===true){n[Y]=Object.create(null);for(let h in r)n[Y][h]=r[h];let c=Object.getOwnPropertySymbols(r);for(var s=0;s<c.length;s++){let h=c[s];n[Y][h]=r[h];}for(let h in e.serializers)n[Y][h]=e.serializers[h];let u=Object.getOwnPropertySymbols(e.serializers);for(var o=0;o<u.length;o++){let h=u[o];n[Y][h]=e.serializers[h];}}else n[Y]=r;if(e.hasOwnProperty("formatters")){let{level:c,bindings:u,log:h}=e.formatters;n[It]=Ai(c||i.level,u||Pi,h||i.log);}else n[It]=Ai(i.level,Pi,i.log);if(e.hasOwnProperty("customLevels")===true&&(lc(this.levels,e.customLevels),n.levels=oc(e.customLevels,n[Ja]),cc(n)),typeof e.redact=="object"&&e.redact!==null||Array.isArray(e.redact)){n.redact=e.redact;let c=dc(n.redact,Ri),u={stringify:c[Ya]};n[Za]=Ri,n[tc]=c,n[ec]=u;}if(typeof e.msgPrefix=="string"&&(n[Lt]=(this[Lt]||"")+e.msgPrefix),n[kt]=Li(n,t),e.level!==void 0&&e.level!==this.level||e.hasOwnProperty("customLevels")){let c=e.level||this.level;n[$t](c);}return this.onChild(n),n}function mc(){let e=`{${this[kt].substr(1)}}`,r=JSON.parse(e);return delete r.pid,delete r.hostname,r}function pc(t){let e=Li(this,t);this[kt]=e,delete this[Ba];}function yc(t,e){return Object.assign(e,t)}function bc(t,e,r){let i=this[Ua](),n=this[Fa],s=this[Ga],o=this[Xa],c=this[Ha]||yc,u,h=this[rc].streamWrite;t==null?u={}:t instanceof Error?(u={[s]:t},e===void 0&&(e=t.message)):(u=t,e===void 0&&t[o]===void 0&&t[s]&&(e=t[s].message)),n&&(u=c(u,n(u,r,this)));let f=this[Ii](u,e,r,i),l=this[$i];l[Qa]===true&&(l.lastLevel=r,l.lastObj=u,l.lastMsg=e,l.lastTime=i.slice(this[Ka]),l.lastLogger=this),l.write(h?h(f):f);}function wc(){}function Sc(t){if(t!=null&&typeof t!="function")throw Error("callback must be a function");let e=this[$i];typeof e.flush=="function"?e.flush(t||wc):t&&t();}});var qi=x((jt,zi)=>{var{hasOwnProperty:le}=Object.prototype,ee=Mt();ee.configure=Mt;ee.stringify=ee;ee.default=ee;jt.stringify=ee;jt.configure=Mt;zi.exports=ee;var vc=/[\u0000-\u001f\u0022\u005c\ud800-\udfff]/;function G(t){return t.length<5e3&&!vc.test(t)?`"${t}"`:JSON.stringify(t)}function Ct(t,e){if(t.length>200||e)return t.sort(e);for(let r=1;r<t.length;r++){let i=t[r],n=r;for(;n!==0&&t[n-1]>i;)t[n]=t[n-1],n--;t[n]=i;}return t}var _c=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(Object.getPrototypeOf(new Int8Array)),Symbol.toStringTag).get;function Dt(t){return _c.call(t)!==void 0&&t.length!==0}function Mi(t,e,r){t.length<r&&(r=t.length);let i=e===","?"":" ",n=`"0":${i}${t[0]}`;for(let s=1;s<r;s++)n+=`${e}"${s}":${i}${t[s]}`;return n}function Ec(t){if(le.call(t,"circularValue")){let e=t.circularValue;if(typeof e=="string")return `"${e}"`;if(e==null)return e;if(e===Error||e===TypeError)return {toString(){throw new TypeError("Converting circular structure to JSON")}};throw new TypeError('The "circularValue" argument must be of type string or the value null or undefined')}return '"[Circular]"'}function xc(t){let e;if(le.call(t,"deterministic")&&(e=t.deterministic,typeof e!="boolean"&&typeof e!="function"))throw new TypeError('The "deterministic" argument must be of type boolean or comparator function');return e===void 0?true:e}function Tc(t,e){let r;if(le.call(t,e)&&(r=t[e],typeof r!="boolean"))throw new TypeError(`The "${e}" argument must be of type boolean`);return r===void 0?true:r}function ji(t,e){let r;if(le.call(t,e)){if(r=t[e],typeof r!="number")throw new TypeError(`The "${e}" argument must be of type number`);if(!Number.isInteger(r))throw new TypeError(`The "${e}" argument must be an integer`);if(r<1)throw new RangeError(`The "${e}" argument must be >= 1`)}return r===void 0?1/0:r}function Z(t){return t===1?"1 item":`${t} items`}function Oc(t){let e=new Set;for(let r of t)(typeof r=="string"||typeof r=="number")&&e.add(String(r));return e}function Ac(t){if(le.call(t,"strict")){let e=t.strict;if(typeof e!="boolean")throw new TypeError('The "strict" argument must be of type boolean');if(e)return r=>{let i=`Object can not safely be stringified. Received type ${typeof r}`;throw typeof r!="function"&&(i+=` (${r.toString()})`),new Error(i)}}}function Mt(t){t={...t};let e=Ac(t);e&&(t.bigint===void 0&&(t.bigint=false),"circularValue"in t||(t.circularValue=Error));let r=Ec(t),i=Tc(t,"bigint"),n=xc(t),s=typeof n=="function"?n:void 0,o=ji(t,"maximumDepth"),c=ji(t,"maximumBreadth");function u(d,a,y,m,S,b){let w=a[d];switch(typeof w=="object"&&w!==null&&typeof w.toJSON=="function"&&(w=w.toJSON(d)),w=m.call(a,d,w),typeof w){case "string":return G(w);case "object":{if(w===null)return "null";if(y.indexOf(w)!==-1)return r;let v="",E=",",T=b;if(Array.isArray(w)){if(w.length===0)return "[]";if(o<y.length+1)return '"[Array]"';y.push(w),S!==""&&(b+=S,v+=`
${b}`,E=`,
${b}`);let L=Math.min(w.length,c),j=0;for(;j<L-1;j++){let X=u(String(j),w,y,m,S,b);v+=X!==void 0?X:"null",v+=E;}let z=u(String(j),w,y,m,S,b);if(v+=z!==void 0?z:"null",w.length-1>c){let X=w.length-c-1;v+=`${E}"... ${Z(X)} not stringified"`;}return S!==""&&(v+=`
${T}`),y.pop(),`[${v}]`}let A=Object.keys(w),R=A.length;if(R===0)return "{}";if(o<y.length+1)return '"[Object]"';let _="",P="";S!==""&&(b+=S,E=`,
${b}`,_=" ");let D=Math.min(R,c);n&&!Dt(w)&&(A=Ct(A,s)),y.push(w);for(let L=0;L<D;L++){let j=A[L],z=u(j,w,y,m,S,b);z!==void 0&&(v+=`${P}${G(j)}:${_}${z}`,P=E);}if(R>c){let L=R-c;v+=`${P}"...":${_}"${Z(L)} not stringified"`,P=E;}return S!==""&&P.length>1&&(v=`
${b}${v}
${T}`),y.pop(),`{${v}}`}case "number":return isFinite(w)?String(w):e?e(w):"null";case "boolean":return w===true?"true":"false";case "undefined":return;case "bigint":if(i)return String(w);default:return e?e(w):void 0}}function h(d,a,y,m,S,b){switch(typeof a=="object"&&a!==null&&typeof a.toJSON=="function"&&(a=a.toJSON(d)),typeof a){case "string":return G(a);case "object":{if(a===null)return "null";if(y.indexOf(a)!==-1)return r;let w=b,v="",E=",";if(Array.isArray(a)){if(a.length===0)return "[]";if(o<y.length+1)return '"[Array]"';y.push(a),S!==""&&(b+=S,v+=`
${b}`,E=`,
${b}`);let R=Math.min(a.length,c),_=0;for(;_<R-1;_++){let D=h(String(_),a[_],y,m,S,b);v+=D!==void 0?D:"null",v+=E;}let P=h(String(_),a[_],y,m,S,b);if(v+=P!==void 0?P:"null",a.length-1>c){let D=a.length-c-1;v+=`${E}"... ${Z(D)} not stringified"`;}return S!==""&&(v+=`
${w}`),y.pop(),`[${v}]`}y.push(a);let T="";S!==""&&(b+=S,E=`,
${b}`,T=" ");let A="";for(let R of m){let _=h(R,a[R],y,m,S,b);_!==void 0&&(v+=`${A}${G(R)}:${T}${_}`,A=E);}return S!==""&&A.length>1&&(v=`
${b}${v}
${w}`),y.pop(),`{${v}}`}case "number":return isFinite(a)?String(a):e?e(a):"null";case "boolean":return a===true?"true":"false";case "undefined":return;case "bigint":if(i)return String(a);default:return e?e(a):void 0}}function f(d,a,y,m,S){switch(typeof a){case "string":return G(a);case "object":{if(a===null)return "null";if(typeof a.toJSON=="function"){if(a=a.toJSON(d),typeof a!="object")return f(d,a,y,m,S);if(a===null)return "null"}if(y.indexOf(a)!==-1)return r;let b=S;if(Array.isArray(a)){if(a.length===0)return "[]";if(o<y.length+1)return '"[Array]"';y.push(a),S+=m;let _=`
${S}`,P=`,
${S}`,D=Math.min(a.length,c),L=0;for(;L<D-1;L++){let z=f(String(L),a[L],y,m,S);_+=z!==void 0?z:"null",_+=P;}let j=f(String(L),a[L],y,m,S);if(_+=j!==void 0?j:"null",a.length-1>c){let z=a.length-c-1;_+=`${P}"... ${Z(z)} not stringified"`;}return _+=`
${b}`,y.pop(),`[${_}]`}let w=Object.keys(a),v=w.length;if(v===0)return "{}";if(o<y.length+1)return '"[Object]"';S+=m;let E=`,
${S}`,T="",A="",R=Math.min(v,c);Dt(a)&&(T+=Mi(a,E,c),w=w.slice(a.length),R-=a.length,A=E),n&&(w=Ct(w,s)),y.push(a);for(let _=0;_<R;_++){let P=w[_],D=f(P,a[P],y,m,S);D!==void 0&&(T+=`${A}${G(P)}: ${D}`,A=E);}if(v>c){let _=v-c;T+=`${A}"...": "${Z(_)} not stringified"`,A=E;}return A!==""&&(T=`
${S}${T}
${b}`),y.pop(),`{${T}}`}case "number":return isFinite(a)?String(a):e?e(a):"null";case "boolean":return a===true?"true":"false";case "undefined":return;case "bigint":if(i)return String(a);default:return e?e(a):void 0}}function l(d,a,y){switch(typeof a){case "string":return G(a);case "object":{if(a===null)return "null";if(typeof a.toJSON=="function"){if(a=a.toJSON(d),typeof a!="object")return l(d,a,y);if(a===null)return "null"}if(y.indexOf(a)!==-1)return r;let m="",S=a.length!==void 0;if(S&&Array.isArray(a)){if(a.length===0)return "[]";if(o<y.length+1)return '"[Array]"';y.push(a);let T=Math.min(a.length,c),A=0;for(;A<T-1;A++){let _=l(String(A),a[A],y);m+=_!==void 0?_:"null",m+=",";}let R=l(String(A),a[A],y);if(m+=R!==void 0?R:"null",a.length-1>c){let _=a.length-c-1;m+=`,"... ${Z(_)} not stringified"`;}return y.pop(),`[${m}]`}let b=Object.keys(a),w=b.length;if(w===0)return "{}";if(o<y.length+1)return '"[Object]"';let v="",E=Math.min(w,c);S&&Dt(a)&&(m+=Mi(a,",",c),b=b.slice(a.length),E-=a.length,v=","),n&&(b=Ct(b,s)),y.push(a);for(let T=0;T<E;T++){let A=b[T],R=l(A,a[A],y);R!==void 0&&(m+=`${v}${G(A)}:${R}`,v=",");}if(w>c){let T=w-c;m+=`${v}"...":"${Z(T)} not stringified"`;}return y.pop(),`{${m}}`}case "number":return isFinite(a)?String(a):e?e(a):"null";case "boolean":return a===true?"true":"false";case "undefined":return;case "bigint":if(i)return String(a);default:return e?e(a):void 0}}function p(d,a,y){if(arguments.length>1){let m="";if(typeof y=="number"?m=" ".repeat(Math.min(y,10)):typeof y=="string"&&(m=y.slice(0,10)),a!=null){if(typeof a=="function")return u("",{"":d},[],a,m,"");if(Array.isArray(a))return h("",d,[],Oc(a),m,"")}if(m.length!==0)return f("",d,[],m,"")}return l("",d,[])}return p}});var Fi=x((Ru,Bi)=>{var zt=Symbol.for("pino.metadata"),{DEFAULT_LEVELS:Vi}=$e(),Rc=Vi.info;function Pc(t,e){t=t||[],e=e||{dedupe:false};let r=Object.create(Vi);r.silent=1/0,e.levels&&typeof e.levels=="object"&&Object.keys(e.levels).forEach(l=>{r[l]=e.levels[l];});let i={write:n,add:c,remove:u,emit:s,flushSync:o,end:h,minLevel:0,lastId:0,streams:[],clone:f,[zt]:true,streamLevels:r};return Array.isArray(t)?t.forEach(c,i):c.call(i,t),t=null,i;function n(l){let p,d=this.lastLevel,{streams:a}=this,y=0,m;for(let S=Ic(a.length,e.dedupe);Lc(S,a.length,e.dedupe);S=$c(S,e.dedupe))if(p=a[S],p.level<=d){if(y!==0&&y!==p.level)break;if(m=p.stream,m[zt]){let{lastTime:b,lastMsg:w,lastObj:v,lastLogger:E}=this;m.lastLevel=d,m.lastTime=b,m.lastMsg=w,m.lastObj=v,m.lastLogger=E;}m.write(l),e.dedupe&&(y=p.level);}else if(!e.dedupe)break}function s(...l){for(let{stream:p}of this.streams)typeof p.emit=="function"&&p.emit(...l);}function o(){for(let{stream:l}of this.streams)typeof l.flushSync=="function"&&l.flushSync();}function c(l){if(!l)return i;let p=typeof l.write=="function"||l.stream,d=l.write?l:l.stream;if(!p)throw Error("stream object needs to implement either StreamEntry or DestinationStream interface");let{streams:a,streamLevels:y}=this,m;typeof l.levelVal=="number"?m=l.levelVal:typeof l.level=="string"?m=y[l.level]:typeof l.level=="number"?m=l.level:m=Rc;let S={stream:d,level:m,levelVal:void 0,id:++i.lastId};return a.unshift(S),a.sort(Ni),this.minLevel=a[0].level,i}function u(l){let{streams:p}=this,d=p.findIndex(a=>a.id===l);return d>=0&&(p.splice(d,1),p.sort(Ni),this.minLevel=p.length>0?p[0].level:-1),i}function h(){for(let{stream:l}of this.streams)typeof l.flushSync=="function"&&l.flushSync(),l.end();}function f(l){let p=new Array(this.streams.length);for(let d=0;d<p.length;d++)p[d]={level:l,stream:this.streams[d].stream};return {write:n,add:c,remove:u,minLevel:l,streams:p,clone:f,emit:s,flushSync:o,[zt]:true}}}function Ni(t,e){return t.level-e.level}function Ic(t,e){return e?t-1:0}function $c(t,e){return e?t-1:t+1}function Lc(t,e,r){return r?t>=0:t<e}Bi.exports=Pc;});var nn=x((Pu,N)=>{var kc=C("os"),Qi=tt(),Cc=rt(),Dc=lt(),Yi=Mr(),Mc=Di(),Zi=ie(),{configure:jc}=qi(),{assertDefaultLevelFound:zc,mappings:en,genLsCache:qc,genLevelComparison:Nc,assertLevelComparison:Vc}=Rt(),{DEFAULT_LEVELS:tn,SORTING_ORDER:Bc}=$e(),{createArgsNormalizer:Fc,asChindings:Wc,buildSafeSonicBoom:Wi,buildFormatters:Hc,stringify:qt,normalizeDestFileDescriptor:Hi,noop:Uc}=Ie(),{version:Kc}=Pt(),{chindingsSym:Ui,redactFmtSym:Gc,serializersSym:Ki,timeSym:Xc,timeSliceIndexSym:Jc,streamSym:Qc,stringifySym:Gi,stringifySafeSym:Nt,stringifiersSym:Xi,setLevelSym:Yc,endSym:Zc,formatOptsSym:el,messageKeySym:tl,errorKeySym:rl,nestedKeySym:il,mixinSym:nl,levelCompSym:sl,useOnlyCustomLevelsSym:ol,formattersSym:Ji,hooksSym:al,nestedKeyStrSym:cl,mixinMergeStrategySym:ll,msgPrefixSym:ul}=Zi,{epochTime:rn,nullTime:fl}=Yi,{pid:dl}=process,gl=kc.hostname(),hl=Qi.err,ml={level:"info",levelComparison:Bc.ASC,levels:tn,messageKey:"msg",errorKey:"err",nestedKey:null,enabled:true,base:{pid:dl,hostname:gl},serializers:Object.assign(Object.create(null),{err:hl}),formatters:Object.assign(Object.create(null),{bindings(t){return t},level(t,e){return {level:e}}}),hooks:{logMethod:void 0,streamWrite:void 0},timestamp:rn,name:void 0,redact:null,customLevels:null,useOnlyCustomLevels:false,depthLimit:5,edgeLimit:100},pl=Fc(ml),yl=Object.assign(Object.create(null),Qi);function Vt(...t){let e={},{opts:r,stream:i}=pl(e,Cc(),...t);r.level&&typeof r.level=="string"&&tn[r.level.toLowerCase()]!==void 0&&(r.level=r.level.toLowerCase());let{redact:n,crlf:s,serializers:o,timestamp:c,messageKey:u,errorKey:h,nestedKey:f,base:l,name:p,level:d,customLevels:a,levelComparison:y,mixin:m,mixinMergeStrategy:S,useOnlyCustomLevels:b,formatters:w,hooks:v,depthLimit:E,edgeLimit:T,onChild:A,msgPrefix:R}=r,_=jc({maximumDepth:E,maximumBreadth:T}),P=Hc(w.level,w.bindings,w.log),D=qt.bind({[Nt]:_}),L=n?Dc(n,D):{},j=n?{stringify:L[Gc]}:{stringify:D},z="}"+(s?`\r
`:`
`),X=Wc.bind(null,{[Ui]:"",[Ki]:o,[Xi]:L,[Gi]:qt,[Nt]:_,[Ji]:P}),ke="";l!==null&&(p===void 0?ke=X(l):ke=X(Object.assign({},l,{name:p})));let Wt=c instanceof Function?c:c?rn:fl,an=Wt().indexOf(":")+1;if(b&&!a)throw Error("customLevels is required if useOnlyCustomLevels is set true");if(m&&typeof m!="function")throw Error(`Unknown mixin type "${typeof m}" - expected "function"`);if(R&&typeof R!="string")throw Error(`Unknown msgPrefix type "${typeof R}" - expected "string"`);zc(d,a,b);let Ht=en(a,b);typeof i.emit=="function"&&i.emit("message",{code:"PINO_CONFIG",config:{levels:Ht,messageKey:u,errorKey:h}}),Vc(y);let cn=Nc(y);return Object.assign(e,{levels:Ht,[sl]:cn,[ol]:b,[Qc]:i,[Xc]:Wt,[Jc]:an,[Gi]:qt,[Nt]:_,[Xi]:L,[Zc]:z,[el]:j,[tl]:u,[rl]:h,[il]:f,[cl]:f?`,${JSON.stringify(f)}:{`:"",[Ki]:o,[nl]:m,[ll]:S,[Ui]:ke,[Ji]:P,[al]:v,silent:Uc,onChild:A,[ul]:R}),Object.setPrototypeOf(e,Mc()),qc(e),e[Yc](d),e}N.exports=Vt;N.exports.destination=(t=process.stdout.fd)=>typeof t=="object"?(t.dest=Hi(t.dest||process.stdout.fd),Wi(t)):Wi({dest:Hi(t),minLength:0});N.exports.transport=_t();N.exports.multistream=Fi();N.exports.levels=en();N.exports.stdSerializers=yl;N.exports.stdTimeFunctions=Object.assign({},Yi);N.exports.symbols=Zi;N.exports.version=Kc;N.exports.default=Vt;N.exports.pino=Vt;});var ue=class{metrics=[];errors=[];config;batchTimer;constructor(e){this.config=e,e.enabled&&e.flushInterval&&this.startBatchReporting();}recordMetric(e,r,i="ms",n){if(!this.config.enabled)return;let s={name:e,value:r,unit:i,timestamp:Date.now(),...n&&{tags:n}};this.metrics.push(s),this.config.batchSize&&this.metrics.length>=this.config.batchSize&&this.flush();}recordError(e,r="medium",i){if(!this.config.enabled)return;let n={id:this.generateId(),message:typeof e=="string"?e:e.message,timestamp:Date.now(),severity:r,sessionId:this.getSessionId(),...typeof e=="object"&&e.stack&&{stack:e.stack},...i&&{context:i}};this.errors.push(n),(r==="critical"||this.config.batchSize&&this.errors.length>=this.config.batchSize)&&this.flush();}async measureAsync(e,r,i){let n=performance.now();try{let s=await r(),o=performance.now()-n;return this.recordMetric(e,o,"ms",i),s}catch(s){let o=performance.now()-n;throw this.recordMetric(`${e}_error`,o,"ms",i),this.recordError(s,"high",{operation:e,...i}),s}}measure(e,r,i){let n=performance.now();try{let s=r(),o=performance.now()-n;return this.recordMetric(e,o,"ms",i),s}catch(s){let o=performance.now()-n;throw this.recordMetric(`${e}_error`,o,"ms",i),this.recordError(s,"high",{operation:e,...i}),s}}getMetrics(){return [...this.metrics]}getErrors(){return [...this.errors]}async flush(){if(!this.config.endpoint||!this.metrics.length&&!this.errors.length)return;let e={metrics:this.metrics,errors:this.errors,timestamp:Date.now()};try{await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.config.apiKey&&{Authorization:`Bearer ${this.config.apiKey}`}},body:JSON.stringify(e)}),this.metrics=[],this.errors=[];}catch(r){console.warn("Failed to send monitoring data:",r);}}startBatchReporting(){this.batchTimer&&clearInterval(this.batchTimer),this.batchTimer=setInterval(()=>{this.flush();},this.config.flushInterval);}stop(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=void 0),this.flush();}generateId(){return `${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getSessionId(){if(typeof window<"u"&&window.sessionStorage){let e=window.sessionStorage.getItem("monitoring_session_id");return e||(e=this.generateId(),window.sessionStorage.setItem("monitoring_session_id",e)),e}return "server-session"}},q=new ue({enabled:process.env.NODE_ENV==="production",batchSize:100,flushInterval:3e4,enableRealtime:false}),Ce=(t,e,r,i)=>q.recordMetric(t,e,r,i),De=(t,e,r)=>q.recordError(t,e,r),Me=(t,e,r)=>q.measureAsync(t,e,r),je=(t,e,r)=>q.measure(t,e,r);var fe=class{constructor(e){this.websocketUrl=e;e&&this.connect();}ws;alerts=[];alertRules=[];liveMetrics=new Map;subscribers=new Map;connect(){if(!(typeof globalThis<"u"&&globalThis.process?.env?.NODE_ENV==="test")&&!(!this.websocketUrl||this.ws&&this.ws.readyState===1))try{if(typeof WebSocket>"u"){console.warn("WebSocket not available in this environment");return}this.ws=new WebSocket(this.websocketUrl),this.ws.onopen=()=>{console.log("Real-time monitoring connected"),this.emit("connection",{status:"connected"});},this.ws.onmessage=e=>{try{let r=JSON.parse(e.data);this.handleMessage(r);}catch(r){console.error("Failed to parse WebSocket message:",r);}},this.ws.onclose=()=>{console.log("Real-time monitoring disconnected"),this.emit("connection",{status:"disconnected"}),setTimeout(()=>this.connect(),5e3);},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.emit("error",{error:e});};}catch(e){console.error("Failed to connect to WebSocket:",e);}}disconnect(){this.ws&&(this.ws.close(),this.ws=void 0);}subscribe(e,r){return this.subscribers.has(e)||this.subscribers.set(e,new Set),this.subscribers.get(e).add(r),()=>{this.subscribers.get(e)?.delete(r);}}addAlertRule(e){let r={id:this.generateId(),...e};return this.alertRules.push(r),this.emit("alert_rule_added",r),r.id}removeAlertRule(e){let r=this.alertRules.findIndex(i=>i.id===e);if(r>=0){let i=this.alertRules.splice(r,1)[0];return this.emit("alert_rule_removed",i),true}return  false}updateMetric(e,r,i="ms"){let n=this.liveMetrics.get(e),s={name:e,current:r,previous:n?.current??r,trend:this.calculateTrend(r,n?.current),unit:i,timestamp:Date.now()};this.liveMetrics.set(e,s),this.emit("metric_updated",s),this.checkAlerts(e,r);}getLiveMetrics(){return Array.from(this.liveMetrics.values())}getActiveAlerts(){return this.alerts.filter(e=>!e.acknowledged&&!e.resolvedAt)}acknowledgeAlert(e){let r=this.alerts.find(i=>i.id===e);return r&&!r.acknowledged?(r.acknowledged=true,this.emit("alert_acknowledged",r),true):false}resolveAlert(e){let r=this.alerts.find(i=>i.id===e);return r&&!r.resolvedAt?(r.resolvedAt=Date.now(),this.emit("alert_resolved",r),true):false}send(e){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e));}handleMessage(e){switch(e.type){case "metric":this.updateMetric(e.name,e.value,e.unit);break;case "alert":this.handleIncomingAlert(e);break;case "system_status":this.emit("system_status",e);break;default:this.emit("message",e);}}handleIncomingAlert(e){let r={id:e.id||this.generateId(),ruleId:e.ruleId,message:e.message,severity:e.severity,timestamp:e.timestamp||Date.now(),acknowledged:false};this.alerts.push(r),this.emit("alert_triggered",r);}checkAlerts(e,r){let i=this.alertRules.filter(n=>n.enabled&&n.metric===e);for(let n of i)this.evaluateRule(n,r)&&this.triggerAlert(n,r);}evaluateRule(e,r){switch(e.operator){case "gt":return r>e.threshold;case "gte":return r>=e.threshold;case "lt":return r<e.threshold;case "lte":return r<=e.threshold;case "eq":return r===e.threshold;default:return  false}}triggerAlert(e,r){if(this.alerts.find(s=>s.ruleId===e.id&&Date.now()-s.timestamp<(e.duration||60)*1e3&&!s.resolvedAt))return;let n={id:this.generateId(),ruleId:e.id,message:`${e.name}: ${e.metric} is ${r} (threshold: ${e.threshold})`,severity:r>e.threshold*2?"critical":"warning",timestamp:Date.now(),acknowledged:false};this.alerts.push(n),this.emit("alert_triggered",n);}calculateTrend(e,r){return !r||r===e?"stable":e>r?"up":"down"}emit(e,r){let i=this.subscribers.get(e);i&&i.forEach(n=>{try{n(r);}catch(s){console.error(`Error in subscriber for event ${e}:`,s);}});}generateId(){return `${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},re=new fe(process.env.MONITORING_WS_URL||(typeof window<"u"?"ws://localhost:8080/monitoring":void 0)),pn=t=>re.addAlertRule(t),yn=t=>re.removeAlertRule(t),bn=(t,e,r)=>re.updateMetric(t,e,r),wn=()=>re.getLiveMetrics(),Sn=()=>re.getActiveAlerts();var vn=(t={})=>({enabled:process.env.NODE_ENV==="production",batchSize:100,flushInterval:3e4,enableRealtime:false,...t}),Tl=t=>{let e=vn(t);if(typeof window<"u"&&(window.addEventListener("error",r=>{q.recordError(r.error||r.message,"high",{filename:r.filename,lineno:r.lineno,colno:r.colno});}),window.addEventListener("unhandledrejection",r=>{q.recordError(r.reason,"high",{type:"unhandled_promise_rejection"});})),typeof window<"u"&&"PerformanceObserver"in window)try{new PerformanceObserver(s=>{for(let o of s.getEntries())q.recordMetric("lcp",o.startTime,"ms",{type:"core_web_vital"});}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(s=>{for(let o of s.getEntries())q.recordMetric("fid",o.processingStart-o.startTime,"ms",{type:"core_web_vital"});}).observe({entryTypes:["first-input"]}),new PerformanceObserver(s=>{for(let o of s.getEntries())o.hadRecentInput||q.recordMetric("cls",o.value,"score",{type:"core_web_vital"});}).observe({entryTypes:["layout-shift"]});}catch(r){console.warn("Failed to setup Core Web Vitals monitoring:",r);}return {config:e,monitor:q,recordMetric:Ce,recordError:De,measureAsync:Me,measure:je}};var K=class t{directives={};constructor(e={}){this.directives={...e};}setDirective(e,r){return typeof r=="boolean"?this.directives[e]=r:this.directives[e]=[...r],this}addToDirective(e,r){(!this.directives[e]||typeof this.directives[e]=="boolean")&&(this.directives[e]=[]);let i=this.directives[e];return this.directives[e]=[...i,...r],this}build(){let e=[];return Object.entries(this.directives).forEach(([r,i])=>{typeof i=="boolean"&&i?e.push(r):Array.isArray(i)&&i.length>0&&e.push(`${r} ${i.join(" ")}`);}),e.join("; ")}static strict(){return new t({"default-src":["'none'"],"script-src":["'self'"],"style-src":["'self'","'unsafe-inline'"],"img-src":["'self'","data:","https:"],"font-src":["'self'"],"connect-src":["'self'"],"media-src":["'self'"],"object-src":["'none'"],"frame-src":["'none'"],"base-uri":["'self'"],"form-action":["'self'"],"frame-ancestors":["'none'"],"upgrade-insecure-requests":true,"block-all-mixed-content":true})}static development(){return new t({"default-src":["'self'"],"script-src":["'self'","'unsafe-eval'","'unsafe-inline'","localhost:*"],"style-src":["'self'","'unsafe-inline'","localhost:*"],"img-src":["'self'","data:","https:","localhost:*"],"font-src":["'self'","localhost:*"],"connect-src":["'self'","localhost:*","ws:","wss:"],"media-src":["'self'","localhost:*"],"object-src":["'none'"],"frame-src":["'self'","localhost:*"],"base-uri":["'self'"],"form-action":["'self'"]})}},ze=class t{config;isDevelopment;constructor(e={},r=false){this.config=e,this.isDevelopment=r;}generateHeaders(){let e={};if(this.config.csp){let r=new K(this.config.csp);e["Content-Security-Policy"]=r.build();}else {let r=this.isDevelopment?K.development():K.strict();e["Content-Security-Policy"]=r.build();}if(this.config.hsts!==false&&!this.isDevelopment){let r=this.config.hsts||{},n=`max-age=${r.maxAge||31536e3}`;r.includeSubDomains!==false&&(n+="; includeSubDomains"),r.preload&&(n+="; preload"),e["Strict-Transport-Security"]=n;}if(e["X-Frame-Options"]=this.config.frameOptions||"DENY",this.config.contentTypeOptions!==false&&(e["X-Content-Type-Options"]="nosniff"),this.config.xssProtection!==false&&(e["X-XSS-Protection"]="1; mode=block"),e["Referrer-Policy"]=this.config.referrerPolicy||"strict-origin-when-cross-origin",this.config.permissionsPolicy){let r=Object.entries(this.config.permissionsPolicy).map(([i,n])=>`${i}=(${n.join(" ")})`).join(", ");e["Permissions-Policy"]=r;}else e["Permissions-Policy"]=["camera=()","microphone=()","geolocation=()","payment=()","usb=()","magnetometer=()","accelerometer=()","gyroscope=()"].join(", ");return e["Cross-Origin-Embedder-Policy"]=this.config.crossOriginEmbedderPolicy||"unsafe-none",e["Cross-Origin-Opener-Policy"]=this.config.crossOriginOpenerPolicy||"same-origin-allow-popups",e["Cross-Origin-Resource-Policy"]=this.config.crossOriginResourcePolicy||"same-origin",e}applyToResponse(e){let r=this.generateHeaders();Object.entries(r).forEach(([i,n])=>{e.setHeader(i,n);});}getFetchHeaders(){let e=new Headers,r=this.generateHeaders();return Object.entries(r).forEach(([i,n])=>{e.set(i,n);}),e}validateCSP(){let e=[],r=[],i=this.config.csp||{};return Object.entries(i).forEach(([n,s])=>{Array.isArray(s)&&(s.includes("'unsafe-inline'")&&e.push(`${n} allows 'unsafe-inline' which can enable XSS attacks`),s.includes("'unsafe-eval'")&&e.push(`${n} allows 'unsafe-eval' which can enable code injection`),s.includes("*")&&e.push(`${n} allows wildcard (*) which is overly permissive`));}),!i["default-src"]&&!i["script-src"]&&r.push("Missing script-src directive - scripts can be loaded from anywhere"),i["object-src"]||e.push("Consider setting object-src to prevent plugin injection"),i["base-uri"]||e.push("Consider setting base-uri to prevent base tag injection"),{isValid:r.length===0,warnings:e,errors:r}}static forEnvironment(e,r={}){let n={...{development:{csp:K.development().directives,hsts:false,frameOptions:"SAMEORIGIN"},staging:{csp:K.strict().addToDirective("script-src",["staging.example.com"]).directives,frameOptions:"DENY"},production:{csp:K.strict().directives,hsts:{maxAge:31536e3,includeSubDomains:true,preload:true},frameOptions:"DENY"}}[e],...r};return new t(n,e==="development")}},de=class t{config;constructor(e={}){this.config={origin:false,methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"],exposedHeaders:[],credentials:false,maxAge:86400,optionsSuccessStatus:204,...e};}isOriginAllowed(e){return e?typeof this.config.origin=="boolean"?this.config.origin:typeof this.config.origin=="string"?this.config.origin===e:Array.isArray(this.config.origin)?this.config.origin.includes(e):typeof this.config.origin=="function"?this.config.origin(e):false:true}generateHeaders(e){let r={};return this.isOriginAllowed(e)&&(this.config.credentials?r["Access-Control-Allow-Origin"]=e||"*":r["Access-Control-Allow-Origin"]="*"),this.config.methods&&this.config.methods.length>0&&(r["Access-Control-Allow-Methods"]=this.config.methods.join(", ")),this.config.allowedHeaders&&this.config.allowedHeaders.length>0&&(r["Access-Control-Allow-Headers"]=this.config.allowedHeaders.join(", ")),this.config.exposedHeaders&&this.config.exposedHeaders.length>0&&(r["Access-Control-Expose-Headers"]=this.config.exposedHeaders.join(", ")),this.config.credentials&&(r["Access-Control-Allow-Credentials"]="true"),this.config.maxAge!==void 0&&(r["Access-Control-Max-Age"]=this.config.maxAge.toString()),r}static secure(e){return new t({origin:e,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","X-Requested-With"],credentials:true,maxAge:86400})}static development(){return new t({origin:true,methods:["GET","POST","PUT","DELETE","OPTIONS","PATCH"],allowedHeaders:["*"],credentials:true})}},Pl=ze.forEnvironment(process.env.NODE_ENV==="production"?"production":"development"),Il=process.env.NODE_ENV==="production"?de.secure([]):de.development();var qe=class{name="XSS Scanner";description="Cross-Site Scripting vulnerability detection";severity="high";xssPayloads=['<script>alert("XSS")</script>','"><script>alert("XSS")</script>','<img src=x onerror=alert("XSS")>','javascript:alert("XSS")','<svg onload=alert("XSS")>','"><script>alert("XSS")</script>','<script>console.log("XSS")</script>',`<iframe src="javascript:alert('XSS')"></iframe>`];async scan(e){let r=[];for(let[i,n]of Object.entries(e))if(typeof n=="string")for(let s of this.xssPayloads){let o=n+s,c=this.detectXSSPatterns(o);c.length>0&&r.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"Cross-Site Scripting (XSS) Vulnerability",description:`Field "${i}" contains potentially dangerous XSS patterns: ${c.join(", ")}`,location:i,evidence:{payload:s,original:n,detectedPatterns:c,testValue:o.substring(0,100)},remediation:"Implement proper input validation and output encoding with Content Security Policy",timestamp:new Date});}return r}detectXSSPatterns(e){let r=[{name:"script_tag",regex:/<script[\s\S]*?>[\s\S]*?<\/script>/gi},{name:"javascript_protocol",regex:/javascript:/gi},{name:"event_handlers",regex:/on\w+\s*=\s*["'][^"']*["']/gi},{name:"svg_onload",regex:/<svg[^>]*onload/gi},{name:"img_onerror",regex:/<img[^>]*onerror/gi},{name:"iframe_javascript",regex:/<iframe[^>]*src\s*=\s*["']javascript:/gi},{name:"data_protocol",regex:/data:text\/html/gi},{name:"vbscript",regex:/vbscript:/gi}],i=[];for(let n of r)n.regex.test(e)&&i.push(n.name);return i}generateId(){return `xss-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},Ne=class{name="SQL Injection Scanner";description="SQL Injection vulnerability detection";severity="critical";sqlPayloads=["' OR '1'='1","'; DROP TABLE users; --","1' OR '1'='1","admin'--","admin'/*","' OR 1=1--","' UNION SELECT * FROM users--","1; UPDATE users SET password='hacked'--"];async scan(e){let r=[];for(let[i,n]of Object.entries(e))if(typeof n=="string")for(let s of this.sqlPayloads)this.detectSQLInjection(n+s)&&r.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"SQL Injection Vulnerability",description:`Field "${i}" may be vulnerable to SQL injection`,location:i,evidence:{payload:s,original:n},remediation:"Use parameterized queries and input validation",cve:"CWE-89",timestamp:new Date});return r}detectSQLInjection(e){return [/(\bOR\b|\bAND\b).*?=.*?(\b1\b|\b'1'\b)/i,/(\bUNION\b|\bSELECT\b|\bINSERT\b|\bUPDATE\b|\bDELETE\b|\bDROP\b)/i,/('|\").*?(\bOR\b|\bAND\b).*?('|\")/i,/--|\#|\/\*/].some(i=>i.test(e))}generateId(){return `sqli-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},Ve=class{name="Input Validation Scanner";description="Input validation and sanitization testing";severity="medium";async scan(e){let r=[];for(let[i,n]of Object.entries(e)){let s=[{name:"Long input",value:"A".repeat(1e4)},{name:"Special characters",value:`!@#$%^&*()_+{}|:"<>?[]\\;',./`},{name:"Unicode characters",value:"\u{1F680}\u{1F389}\u{1F4BB}\u{1F525}\u26A1"},{name:"Null bytes",value:"test\0test"},{name:"HTML entities",value:"&lt;script&gt;alert(&quot;test&quot;)&lt;/script&gt;"}];for(let o of s)try{let c=J.validateInput(o.value,"text",{sanitize:!0,required:!1});!c.isValid&&!c.errors?.length&&r.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"Insufficient Input Validation",description:`Field "${i}" may not properly validate ${o.name}`,location:i,evidence:{testCase:o.name,input:o.value},remediation:"Implement comprehensive input validation",timestamp:new Date});}catch(c){r.push({id:this.generateId(),scanner:this.name,severity:"high",title:"Input Validation Error",description:`Field "${i}" causes validation errors with ${o.name}`,location:i,evidence:{testCase:o.name,error:c.message},remediation:"Fix input validation error handling",timestamp:new Date});}}return r}generateId(){return `input-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},Be=class{name="Authentication Bypass Scanner";description="Authentication and authorization vulnerability testing";severity="critical";async scan(e){let r=[],i=["password","token","auth","authorization","session"],n=["",null,void 0,"admin","password","123456","null","false","0","[]","{}"];for(let s of i)if(e.hasOwnProperty(s))for(let o of n)r.push({id:this.generateId(),scanner:this.name,severity:this.severity,title:"Potential Authentication Bypass",description:`Authentication field "${s}" should be tested against bypass attempts`,location:s,evidence:{field:s,bypassAttempt:o},remediation:"Implement secure authentication validation and proper session management",cve:"CWE-287",timestamp:new Date});return r}generateId(){return `auth-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},Fe=class{scanners=[];constructor(){this.registerScanner(new qe),this.registerScanner(new Ne),this.registerScanner(new Ve),this.registerScanner(new Be);}registerScanner(e){this.scanners.push(e);}async runPenetrationTest(e,r,i={}){let n=new Date,s=[],o=this.scanners;i.includeScanners&&(o=o.filter(f=>i.includeScanners.includes(f.name))),i.excludeScanners&&(o=o.filter(f=>!i.excludeScanners.includes(f.name))),i.severity&&(o=o.filter(f=>i.severity.includes(f.severity)));for(let f of o)try{console.log(`Running ${f.name}...`);let l=await f.scan(r);s=s.concat(l);}catch(l){console.error(`Scanner ${f.name} failed:`,l);}let c=new Date,u={totalVulnerabilities:s.length,criticalCount:s.filter(f=>f.severity==="critical").length,highCount:s.filter(f=>f.severity==="high").length,mediumCount:s.filter(f=>f.severity==="medium").length,lowCount:s.filter(f=>f.severity==="low").length},h=this.generateRecommendations(s);return {id:`pentest-${Date.now()}`,targetName:e,startTime:n,endTime:c,vulnerabilities:s,summary:u,recommendations:h}}generateRecommendations(e){let r=new Set;return e.forEach(i=>{i.remediation&&r.add(i.remediation),i.scanner.includes("XSS")&&(r.add("Implement Content Security Policy (CSP) headers"),r.add("Use secure templating engines with auto-escaping")),i.scanner.includes("SQL")&&(r.add("Use parameterized queries or ORM"),r.add("Implement principle of least privilege for database access")),i.scanner.includes("Auth")&&(r.add("Implement multi-factor authentication"),r.add("Use secure session management"),r.add("Implement account lockout mechanisms"));}),e.length>0&&(r.add("Conduct regular security audits"),r.add("Implement security monitoring and logging"),r.add("Keep all dependencies updated"),r.add("Provide security training for development team")),Array.from(r)}exportReport(e){return JSON.stringify(e,null,2)}generateHtmlReport(e){let r={critical:"#dc3545",high:"#fd7e14",medium:"#ffc107",low:"#198754"};return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penetration Test Report - ${e.targetName}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .vulnerability { background: white; padding: 20px; margin-bottom: 20px; border-left: 4px solid #ddd; border-radius: 4px; }
        .critical { border-left-color: ${r.critical}; }
        .high { border-left-color: ${r.high}; }
        .medium { border-left-color: ${r.medium}; }
        .low { border-left-color: ${r.low}; }
        .recommendations { background: #e7f3ff; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .severity-badge { padding: 4px 8px; color: white; border-radius: 4px; font-size: 12px; }
        code { background: #f1f3f4; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Penetration Test Report</h1>
        <p><strong>Target:</strong> ${e.targetName}</p>
        <p><strong>Test Period:</strong> ${e.startTime.toISOString()} - ${e.endTime.toISOString()}</p>
        <p><strong>Duration:</strong> ${Math.round((e.endTime.getTime()-e.startTime.getTime())/1e3)} seconds</p>
    </div>

    <div class="summary">
        <div class="summary-card">
            <h3>Total Vulnerabilities</h3>
            <h2>${e.summary.totalVulnerabilities}</h2>
        </div>
        <div class="summary-card">
            <h3>Critical</h3>
            <h2 style="color: ${r.critical}">${e.summary.criticalCount}</h2>
        </div>
        <div class="summary-card">
            <h3>High</h3>
            <h2 style="color: ${r.high}">${e.summary.highCount}</h2>
        </div>
        <div class="summary-card">
            <h3>Medium</h3>
            <h2 style="color: ${r.medium}">${e.summary.mediumCount}</h2>
        </div>
        <div class="summary-card">
            <h3>Low</h3>
            <h2 style="color: ${r.low}">${e.summary.lowCount}</h2>
        </div>
    </div>

    <h2>Vulnerabilities</h2>
    ${e.vulnerabilities.map(i=>`
        <div class="vulnerability ${i.severity}">
            <h3>${i.title}</h3>
            <span class="severity-badge" style="background-color: ${r[i.severity]}">${i.severity.toUpperCase()}</span>
            <p><strong>Scanner:</strong> ${i.scanner}</p>
            <p><strong>Location:</strong> ${i.location||"N/A"}</p>
            <p><strong>Description:</strong> ${i.description}</p>
            ${i.remediation?`<p><strong>Remediation:</strong> ${i.remediation}</p>`:""}
            ${i.evidence?`<p><strong>Evidence:</strong> <code>${JSON.stringify(i.evidence,null,2)}</code></p>`:""}
            ${i.cve?`<p><strong>CVE:</strong> ${i.cve}</p>`:""}
            <p><strong>Timestamp:</strong> ${i.timestamp.toISOString()}</p>
        </div>
    `).join("")}

    <div class="recommendations">
        <h2>Recommendations</h2>
        <ul>
            ${e.recommendations.map(i=>`<li>${i}</li>`).join("")}
        </ul>
    </div>
</body>
</html>
    `}},kl=new Fe;var jl={user:z.object({id:z.string().uuid(),email:z.string().email(),username:z.string().min(3).max(50).regex(/^[a-zA-Z0-9_-]+$/),password:z.string().min(8).max(128),role:z.enum(["admin","user","moderator","guest"]),isActive:z.boolean().default(true),createdAt:z.date().optional(),updatedAt:z.date().optional()}),content:z.object({id:z.string().uuid(),title:z.string().min(1).max(200),content:z.string().max(1e4),authorId:z.string().uuid(),tags:z.array(z.string()).max(10).optional(),isPublic:z.boolean().default(false),metadata:z.record(z.unknown()).optional()}),file:z.object({name:z.string().min(1).max(255),type:z.string().regex(/^[a-zA-Z0-9/.\-]+$/),size:z.number().min(1).max(10*1024*1024),content:z.string().or(z.instanceof(ArrayBuffer))}),apiRequest:z.object({method:z.enum(["GET","POST","PUT","DELETE","PATCH"]),path:z.string().regex(/^\/[a-zA-Z0-9/_-]*$/),headers:z.record(z.string()).optional(),body:z.unknown().optional(),query:z.record(z.string()).optional()})},We=class{dompurify;config;constructor(e=_n){this.dompurify=e,this.config={ALLOWED_TAGS:["b","i","em","strong","a","p","br"],ALLOWED_ATTR:["href","title"],ALLOW_DATA_ATTR:false,ALLOW_UNKNOWN_PROTOCOLS:false,SANITIZE_DOM:true,KEEP_CONTENT:true};}sanitizeHTML(e){if(typeof e!="string")throw new Error("Input must be a string");return this.sanitizeToString(e,this.config)}sanitizeText(e){if(typeof e!="string")throw new Error("Input must be a string");return this.sanitizeToString(e,{ALLOWED_TAGS:[]})}sanitizeSQL(e){if(typeof e!="string")throw new Error("Input must be a string");let r=[/('|(\\'))/gi,/(;|--|\||\|\||&&)/gi,/(union|select|insert|update|delete|drop|create|alter|exec|execute)/gi,/(\*|%|_)/gi],i=e;return r.forEach(n=>{i=i.replace(n,"");}),i.trim()}sanitizeFileName(e){if(typeof e!="string")throw new Error("Input must be a string");return e.replace(/[^a-zA-Z0-9._-]/g,"").replace(/\.{2,}/g,".").substring(0,255)}sanitizeToString(e,r){let i=this.dompurify.sanitize(e,r);return typeof i=="string"?i:i&&typeof i.toString=="function"?i.toString():String(i??"")}},k={noXSS:{name:"XSS Protection",validator:t=>typeof t!="string"?true:![/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,/javascript:/gi,/on\w+\s*=/gi,/<iframe/gi,/<object/gi,/<embed/gi].some(r=>r.test(t)),message:"Potential XSS attack detected",severity:"critical"},noSQLInjection:{name:"SQL Injection Protection",validator:t=>typeof t!="string"?true:![/('|(\\'))/gi,/(;|--|\||\|\||&&)/gi,/\b(union|select|insert|update|delete|drop|create|alter|exec|execute)\b/gi].some(r=>r.test(t)),message:"Potential SQL injection detected",severity:"critical"},validEmail:{name:"Email Validation",validator:t=>typeof t!="string"?false:/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),message:"Invalid email format",severity:"medium"},strongPassword:{name:"Strong Password",validator:t=>typeof t!="string"?false:t.length>=8&&/[A-Z]/.test(t)&&/[a-z]/.test(t)&&/[0-9]/.test(t)&&/[^A-Za-z0-9]/.test(t),message:"Password must be at least 8 characters with uppercase, lowercase, number, and special character",severity:"high"},noPathTraversal:{name:"Path Traversal Protection",validator:t=>typeof t!="string"?true:!/(\.\.\/|\.\.\\)/g.test(t),message:"Path traversal attempt detected",severity:"high"}},ge=class{sanitizer;customRules;constructor(){this.sanitizer=new We,this.customRules=new Map;}addRule(e,r){this.customRules.set(e,r);}removeRule(e){this.customRules.delete(e);}async validateSchema(e,r,i={}){let n={isValid:true,errors:[],warnings:[]};try{let s=e;i.sanitize&&typeof e=="object"&&e!==null&&(s=this.sanitizeObject(e),n.sanitized=s);let o=r.safeParse(s);if(o.success||(o.error.errors.forEach(c=>{n.errors.push({field:c.path.join("."),rule:"schema",message:c.message,severity:"medium",value:c.code});}),n.isValid=!1),i.customRules){let c=this.applySecurityRules(s,i.customRules);n.errors.push(...c),c.length>0&&(n.isValid=!1);}if(i.strictMode){let c=Object.keys(k),u=this.applySecurityRules(s,c);n.errors.push(...u),u.length>0&&(n.isValid=!1);}}catch(s){n.isValid=false,n.errors.push({field:"root",rule:"validation",message:s instanceof Error?s.message:"Validation failed",severity:"critical"});}return n}validateInput(e,r,i={}){let n={isValid:true,errors:[],warnings:[]};if(i.required&&(e==null||e===""))return n.isValid=false,n.errors.push({field:"value",rule:"required",message:"Value is required",severity:"medium"}),n;if(e==null)return n;switch(r){case "email":k.validEmail&&!k.validEmail.validator(e)&&(n.isValid=false,n.errors.push({field:"value",rule:"validEmail",message:k.validEmail.message,severity:k.validEmail.severity}));break;case "password":k.strongPassword&&!k.strongPassword.validator(e)&&(n.isValid=false,n.errors.push({field:"value",rule:"strongPassword",message:k.strongPassword.message,severity:k.strongPassword.severity}));break;case "text":typeof e=="string"&&(i.sanitize&&(n.sanitized=this.sanitizer.sanitizeText(e)),k.noXSS&&!k.noXSS.validator(e)&&(n.isValid=false,n.errors.push({field:"value",rule:"noXSS",message:k.noXSS.message,severity:k.noXSS.severity})));break;case "html":typeof e=="string"&&i.sanitize&&(n.sanitized=this.sanitizer.sanitizeHTML(e));break;case "filename":typeof e=="string"&&(i.sanitize&&(n.sanitized=this.sanitizer.sanitizeFileName(e)),k.noPathTraversal&&!k.noPathTraversal.validator(e)&&(n.isValid=false,n.errors.push({field:"value",rule:"noPathTraversal",message:k.noPathTraversal.message,severity:k.noPathTraversal.severity})));break}return n}sanitizeObject(e){if(typeof e=="string")return this.sanitizer.sanitizeText(e);if(e instanceof Date)return e;if(Array.isArray(e))return e.map(r=>this.sanitizeObject(r));if(e&&typeof e=="object"){let r={};for(let[i,n]of Object.entries(e))r[i]=this.sanitizeObject(n);return r}return e}applySecurityRules(e,r){let i=[];return r.forEach(n=>{let s=k[n]||this.customRules.get(n);s&&!s.validator(e)&&i.push({field:"data",rule:n,message:s.message,severity:s.severity,value:e});}),i}};function zl(t=[]){return function(e,r,i){let n=i.value,s=new ge;i.value=async function(...o){for(let c=0;c<o.length;c++){let u=await s.validateSchema(o[c],z.unknown(),{strictMode:true,customRules:t});if(!u.isValid)throw new He(`Security validation failed for argument ${c}`,u.errors)}return n.apply(this,o)};}}var He=class extends Error{errors;constructor(e,r=[]){super(e),this.name="SecurityError",this.errors=r;}},J=new ge,ql={email:t=>J.validateInput(t,"email",{required:true}),password:t=>J.validateInput(t,"password",{required:true}),text:(t,e=true)=>J.validateInput(t,"text",{sanitize:e}),html:(t,e=true)=>J.validateInput(t,"html",{sanitize:e}),filename:(t,e=true)=>J.validateInput(t,"filename",{sanitize:e})};var he=class{supabase;constructor(e,r){this.supabase=createClient(e,r);}async createSecurityEvent(e){let{data:r,error:i}=await this.supabase.from("security_events").insert(e).select().single();if(i)throw new Error(`Failed to create security event: ${i.message}`);return r}async getSecurityEvents(e,r,i=100,n=0){let s=this.supabase.from("security_events").select("*").order("created_at",{ascending:false}).range(n,n+i-1);r?s=s.eq("client_id",r):s=s.eq("user_id",e);let{data:o,error:c}=await s;if(c)throw new Error(`Failed to fetch security events: ${c.message}`);return o||[]}async createSecurityIncident(e){let{data:r,error:i}=await this.supabase.from("security_incidents").insert(e).select().single();if(i)throw new Error(`Failed to create security incident: ${i.message}`);return r}async getSecurityIncidents(e,r,i){let n=this.supabase.from("security_incidents").select("*").order("created_at",{ascending:false});r?n=n.eq("client_id",r):n=n.eq("user_id",e),i&&(n=n.eq("status",i));let{data:s,error:o}=await n;if(o)throw new Error(`Failed to fetch security incidents: ${o.message}`);return s||[]}async updateSecurityIncident(e,r){let{data:i,error:n}=await this.supabase.from("security_incidents").update(r).eq("id",e).select().single();if(n)throw new Error(`Failed to update security incident: ${n.message}`);return i}async createAnalyticsMetric(e){let{data:r,error:i}=await this.supabase.from("analytics_metrics").insert(e).select().single();if(i)throw new Error(`Failed to create analytics metric: ${i.message}`);return r}async getAnalyticsMetrics(e,r,i,n,s,o){let c=this.supabase.from("analytics_metrics").select("*").order("period_start",{ascending:false});r?c=c.eq("client_id",r):c=c.eq("user_id",e),i&&(c=c.eq("metric_name",i)),n&&(c=c.eq("aggregation_period",n)),s&&(c=c.gte("period_start",s)),o&&(c=c.lte("period_end",o));let{data:u,error:h}=await c;if(h)throw new Error(`Failed to fetch analytics metrics: ${h.message}`);return u||[]}async getThreatIntelligence(){let{data:e,error:r}=await this.supabase.from("threat_intelligence").select("*").eq("is_active",true).order("updated_at",{ascending:false});if(r)throw new Error(`Failed to fetch threat intelligence: ${r.message}`);return e||[]}async checkIOCMatch(e,r){let{data:i,error:n}=await this.supabase.from("threat_intelligence").select("*").eq("ioc_type",e).eq("ioc_value",r).eq("is_active",true).single();if(n&&n.code!=="PGRST116")throw new Error(`Failed to check IOC match: ${n.message}`);return i}async createGuestSession(e){let{data:r,error:i}=await this.supabase.from("guest_sessions").insert(e).select().single();if(i)throw new Error(`Failed to create guest session: ${i.message}`);return r}async getGuestSession(e){let{data:r,error:i}=await this.supabase.from("guest_sessions").select("*").eq("session_token",e).single();if(i&&i.code!=="PGRST116")throw new Error(`Failed to fetch guest session: ${i.message}`);return r}async getSecurityMetrics(e,r,i,n){let{data:s,error:o}=await this.supabase.rpc("get_security_metrics",{p_user_id:e,p_client_id:r||null,p_start_date:i||new Date(Date.now()-864e5).toISOString(),p_end_date:n||new Date().toISOString()});if(o)throw new Error(`Failed to get security metrics: ${o.message}`);return s||{total_events:0,unique_ips:0,error_rate:0,avg_response_time:0,failed_attempts:0,event_types:[]}}async getTopThreats(e=10){let{data:r,error:i}=await this.supabase.rpc("get_top_threats",{p_limit:e});if(i)throw new Error(`Failed to get top threats: ${i.message}`);return r||[]}subscribeToSecurityEvents(e,r){return this.supabase.channel("security_events").on("postgres_changes",{event:"INSERT",schema:"public",table:"security_events",filter:`user_id=eq.${e}`},i=>{r(i.new);}).subscribe()}subscribeToSecurityIncidents(e,r){return this.supabase.channel("security_incidents").on("postgres_changes",{event:"*",schema:"public",table:"security_incidents",filter:`user_id=eq.${e}`},i=>{r(i.new);}).subscribe()}};var te=mn(nn());var bl=z.enum(["trace","debug","info","warn","error","fatal"]),wl=z.object({level:bl.default("info"),name:z.string().default("heys-app"),version:z.string().optional(),environment:z.enum(["development","staging","production"]).default("development"),enableConsole:z.boolean().default(true),enableFile:z.boolean().default(false),enableRemote:z.boolean().default(false),fileOptions:z.object({filename:z.string(),maxFiles:z.number().default(5),maxSize:z.string().default("10MB")}).optional(),remoteOptions:z.object({url:z.string().url(),headers:z.record(z.string()).optional(),interval:z.number().default(5e3)}).optional(),redactPaths:z.array(z.string()).default(["password","token","secret","apiKey"]),prettyPrint:z.boolean().default(false)}),Ft=class t{logger;config;startTimes=new Map;defaultContext;constructor(e={},r={}){this.config=wl.parse(e),this.defaultContext=r,this.logger=this.createLogger();}createLogger(){let e={name:this.config.name,level:this.config.level,redact:{paths:this.config.redactPaths,censor:"[REDACTED]"},base:{pid:process.pid,hostname:typeof window<"u"?window.location.hostname:"unknown",environment:this.config.environment,version:this.config.version},timestamp:te.default.stdTimeFunctions.isoTime,formatters:{level:r=>({level:r})}};if(typeof window<"u"){let r=typeof globalThis.console<"u"?globalThis.console:void 0,i={trace:"debug",debug:"debug",info:"info",warn:"warn",error:"error",fatal:"error"};return (0, te.default)({...e,browser:{asObject:true,write:n=>{if(!r)return;let s=n.level,o=typeof s=="string"?s:te.default.levels.labels[s??30]??"info",c=i[o]??"log",u=r[c];typeof u=="function"&&u.call(r,n);}}})}if(this.config.prettyPrint&&this.config.environment==="development"){let r=te.default.transport({target:"pino-pretty",options:{colorize:true,translateTime:"HH:MM:ss Z",ignore:"pid,hostname"}});return (0, te.default)(e,r)}return (0, te.default)(e)}trace(e,r){this.log("trace",e,r);}debug(e,r){this.log("debug",e,r);}info(e,r){this.log("info",e,r);}warn(e,r){this.log("warn",e,r);}error(e,r){this.log("error",e,r);}fatal(e,r){this.log("fatal",e,r);}log(e,r,i){let n=this.mergeContexts(this.defaultContext,i),s={msg:r,timestamp:new Date().toISOString()};n.userId&&(s.userId=n.userId),n.sessionId&&(s.sessionId=n.sessionId),n.traceId&&(s.traceId=n.traceId),n.component&&(s.component=n.component),n.operation&&(s.operation=n.operation),typeof n.duration=="number"&&(s.duration=n.duration),n.metadata&&Object.keys(n.metadata).length>0&&(s.metadata=n.metadata),n.tags&&n.tags.length>0&&(s.tags=n.tags),this.logger[e](s);}logError(e){let r={errorName:e.error.name,errorMessage:e.error.message,errorStack:e.error.stack,...e.context??{}},i={...e.component?{component:e.component}:{},...e.operation?{operation:e.operation}:{},...e.userId?{userId:e.userId}:{},metadata:r,tags:["error"]},n=e.component??"unknown";this.error(`Error in ${n}: ${e.error.message}`,i);}logPerformance(e){let r={success:e.success,...e.metadata??{}},i={...e.component?{component:e.component}:{},operation:e.operation,duration:e.duration,metadata:r,tags:["performance"]},n=e.success?"success":"failed",s=`${e.operation} completed in ${e.duration}ms (${n})`;this.info(s,i);}startTiming(e){this.startTimes.set(e,performance.now());}endTiming(e,r,i=true,n,s){let o=this.startTimes.get(e);if(!o)return this.warn(`No start time found for operation: ${e}`),0;let c=performance.now()-o;return this.startTimes.delete(e),this.logPerformance({operation:r,duration:c,success:i,...n?{component:n}:{},...s?{metadata:s}:{}}),c}logUserAction(e,r,i){let n={userId:r,operation:e,...i?{metadata:i}:{},tags:["user-action"]};this.info(`User action: ${e}`,n);}logApiRequest(e,r,i,n,s,o){let c={...s?{userId:s}:{},operation:`${e} ${r}`,...typeof n=="number"?{duration:n}:{},metadata:{method:e,url:r,...i!==void 0?{statusCode:i}:{},...o??{}},tags:["api-request"]},u=i&&i>=400?"warn":"info",h=`API ${e} ${r} - ${i||"pending"}`;this.log(u,h,c);}logSecurityEvent(e,r,i,n){let s={...i?{userId:i}:{},operation:e,metadata:{severity:r,...n??{}},tags:["security",r]},o=r==="critical"||r==="high"?"error":"warn";this.log(o,`Security event: ${e}`,s);}child(e){return new t(this.config,{...this.defaultContext,...e,metadata:{...this.defaultContext.metadata??{},...e.metadata??{}},tags:this.mergeTags(this.defaultContext.tags,e.tags)})}async flush(){return typeof window<"u"?Promise.resolve():new Promise(e=>{let r=this.logger;typeof r.flush=="function"&&r.flush(),e();})}getLevel(){return this.config.level}setLevel(e){this.config.level=e,this.logger.level=e;}isLevelEnabled(e){return this.logger.isLevelEnabled(e)}mergeContexts(e,r){let i={...e.metadata??{},...r?.metadata??{}},n=this.mergeTags(e.tags,r?.tags),s={...e.userId?{userId:e.userId}:{},...e.sessionId?{sessionId:e.sessionId}:{},...e.traceId?{traceId:e.traceId}:{},...e.component?{component:e.component}:{},...e.operation?{operation:e.operation}:{},...typeof e.duration=="number"?{duration:e.duration}:{}};return r&&(r.userId&&(s.userId=r.userId),r.sessionId&&(s.sessionId=r.sessionId),r.traceId&&(s.traceId=r.traceId),r.component&&(s.component=r.component),r.operation&&(s.operation=r.operation),typeof r.duration=="number"&&(s.duration=r.duration)),Object.keys(i).length>0&&(s.metadata=i),n.length>0&&(s.tags=n),s}mergeTags(e,r){let i=[...e??[],...r??[]];return Array.from(new Set(i))}};var Bt=null;function sn(){return Bt||(Bt=new Ft),Bt}var Le;try{Le=C("@heys/threat-detection").ThreatDetectionService;}catch{Le=class{async initialize(){console.warn("Using mock ThreatDetectionService - install @heys/threat-detection for full functionality");}async analyzeSecurityEvent(r){return {threat_level:"low",matches:[]}}async getStatistics(){return {totalEvents:0,threats:0,incidents:0}}};}var on=class extends EventEmitter{threatDetection;database;processingQueue=[];isProcessing=false;logger=sn().child({component:"SecurityAnalyticsService"});constructor(e){super(),this.database=new he(e.supabaseUrl,e.supabaseKey),this.threatDetection=new Le,e.enableRealTimeProcessing&&this.startRealTimeProcessing();}async initialize(){try{await this.threatDetection.initialize();let e=await this.database.getThreatIntelligence();this.logger.info("Loaded threat intelligence indicators",{metadata:{indicatorCount:e.length}}),await this.trainMLModel(),this.emit("initialized"),this.logger.info("SecurityAnalyticsService initialized successfully");}catch(e){let r=e instanceof Error?e:new Error(String(e));throw this.logger.error("Failed to initialize SecurityAnalyticsService",{metadata:{error:r}}),e}}async processSecurityEvent(e){try{let r=await this.database.createSecurityEvent(e),i=await this.threatDetection.analyzeSecurityEvent({id:r.id,timestamp:r.created_at,userId:r.user_id||"unknown",sessionId:r.session_id||"",ipAddress:r.source_ip||"",userAgent:r.user_agent||"",endpoint:e.event_type,method:"POST",statusCode:r.error_rate&&r.error_rate>0?500:200,responseTime:this.parseResponseTime(r.response_time),requestSize:r.data_volume||0,responseSize:r.data_volume||0,geoLocation:r.geo_location,deviceFingerprint:r.device_fingerprint,customAttributes:e.metadata||r.metadata||{}}),n={...r,anomaly_score:i.anomalyScore,threat_level:this.calculateThreatLevel(i),automated_response:[]};if(i.incidentCreated&&i.incident){let{incident:s}=i,o={title:s.title,severity:s.severity,status:"open"};s.description&&(o.description=s.description),r.user_id&&(o.user_id=r.user_id),r.client_id&&(o.client_id=r.client_id),o.event_ids=[r.id],o.ml_confidence=i.anomalyScore;let c=this.normalizeToRecord(i.iocMatches);c&&(o.ioc_matches=c);let u=this.normalizeToRecord(s.responseActions);u&&(o.response_actions=u);let h=this.normalizeToRecord(s.timeline);h&&(o.timeline=h);let f=this.normalizeToRecord(s.impactAssessment);f&&(o.impact_assessment=f);let l=await this.database.createSecurityIncident(o);n.automated_response=this.getAutomatedResponseActions(l),this.emit("incidentCreated",l);}return this.emit("eventProcessed",n),n}catch(r){let i=r instanceof Error?r:new Error(String(r));throw this.logger.error("Failed to process security event",{metadata:{error:i}}),r}}async getSecurityAnalytics(e,r,i="day"){let n=new Date,s=new Date;switch(i){case "hour":s.setHours(s.getHours()-1);break;case "day":s.setDate(s.getDate()-1);break;case "week":s.setDate(s.getDate()-7);break;case "month":s.setMonth(s.getMonth()-1);break}let[o,c,u,h]=await Promise.all([this.database.getSecurityMetrics(e,r,s.toISOString(),n.toISOString()),this.database.getTopThreats(10),this.database.getSecurityIncidents(e,r),this.database.getSecurityEvents(e,r,100)]),f=this.calculateThreatDistribution(h),l=this.calculateRiskScore(o,u),p=await this.calculateTrends(e,i,r);return {overview:{...o,risk_score:l,active_incidents:u.filter(d=>d.status==="open"||d.status==="investigating").length,total_incidents:u.length},threats:{top_threats:c,threat_distribution:f},incidents:u.slice(0,10),trends:p,ml_stats:await this.threatDetection.getStatistics()}}async batchProcessEvents(e){let i=[];for(let n=0;n<e.length;n+=100){let s=e.slice(n,n+100),o=await Promise.all(s.map(c=>this.processSecurityEvent(c)));i.push(...o),this.emit("batchProgress",{processed:Math.min(n+100,e.length),total:e.length,results:o});}this.emit("batchCompleted",i);}subscribeToRealTimeEvents(e){return this.database.subscribeToSecurityEvents(e,r=>{this.processingQueue.push(r),this.emit("realTimeEvent",r);})}subscribeToRealTimeIncidents(e){return this.database.subscribeToSecurityIncidents(e,r=>{this.emit("realTimeIncident",r);})}async startRealTimeProcessing(){setInterval(async()=>{if(!this.isProcessing&&this.processingQueue.length>0){this.isProcessing=true;let e=this.processingQueue.splice(0,10);try{await Promise.all(e.map(r=>this.processSecurityEvent(r)));}catch(r){let i=r instanceof Error?r:new Error(String(r));this.logger.error("Error in real-time processing",{metadata:{error:i}});}finally{this.isProcessing=false;}}},1e3);}async trainMLModel(){try{let e=await this.database.getSecurityEvents("system",void 0,1e3);if(e.length>=100){let r=e.map(i=>({id:i.id,timestamp:i.created_at,userId:i.user_id||"unknown",sessionId:i.session_id||"",ipAddress:i.source_ip||"",userAgent:i.user_agent||"",endpoint:i.event_type,method:"POST",statusCode:i.error_rate&&i.error_rate>0?500:200,responseTime:this.parseResponseTime(i.response_time),requestSize:i.data_volume||0,responseSize:i.data_volume||0,geoLocation:i.geo_location,deviceFingerprint:i.device_fingerprint,customAttributes:i.metadata||{}}));this.logger.info("ML model trained on historical events",{metadata:{trainingSamples:r.length}});}}catch(e){let r=e instanceof Error?e:new Error(String(e));this.logger.warn("Failed to train ML model",{metadata:{error:r}});}}parseResponseTime(e){if(!e)return 0;let r=e.match(/(\d+(?:\.\d+)?)\s*ms/);return r?parseFloat(r[1]??"0"):0}calculateThreatLevel(e){return e.anomalyScore>.8?"critical":e.anomalyScore>.6?"high":e.anomalyScore>.4?"medium":"low"}getAutomatedResponseActions(e){let r=[];return (e.severity==="high"||e.severity==="critical")&&r.push("ip_block","session_terminate"),e.ioc_matches&&r.push("threat_intelligence_update"),r}calculateThreatDistribution(e){let r={};return e.forEach(i=>{let n=i.event_type;r[n]=(r[n]||0)+1;}),Object.entries(r).sort(([,i],[,n])=>n-i).slice(0,10).map(([i,n])=>({type:i,count:n}))}calculateRiskScore(e,r){let i=0;e.error_rate>.1&&(i+=20),e.failed_attempts>10&&(i+=30),e.unique_ips>100&&(i+=10);let n=r.filter(o=>o.status==="open"||o.status==="investigating");i+=n.length*15;let s=r.filter(o=>o.severity==="critical");return i+=s.length*25,Math.min(100,i)}async calculateTrends(e,r,i){return await this.database.getSecurityMetrics(e,i),{period:r,events_trend:"+15%",incidents_trend:"+3%",risk_trend:"-5%",response_time_trend:"-10%"}}normalizeToRecord(e){if(e!=null)return Array.isArray(e)?{items:e}:typeof e=="object"?e:{value:e}}};var Vu=t=>t.toISOString().split("T")[0],Bu=()=>crypto.randomUUID();

export { Be as AuthBypassScanner, de as CORSManager, K as CSPBuilder, he as DatabaseService, We as InputSanitizer, Ve as InputValidationScanner, Fe as PenetrationTestFramework, ue as PerformanceMonitor, fe as RealtimeMonitor, Ne as SQLInjectionScanner, on as SecurityAnalyticsService, zl as SecurityBoundary, He as SecurityError, ze as SecurityHeadersManager, k as SecurityRules, ge as SecurityValidator, jl as ValidationSchemas, qe as XSSScanner, pn as addAlert, vn as createMonitoringConfig, Il as defaultCORS, kl as defaultPentestFramework, Pl as defaultSecurityHeaders, J as defaultValidator, Vu as formatDate, Bu as generateId, Sn as getActiveAlerts, wn as getLiveMetrics, je as measure, Me as measureAsync, q as monitor, re as realtimeMonitor, De as recordError, Ce as recordMetric, yn as removeAlert, Tl as setupMonitoring, bn as updateLiveMetric, ql as validate };
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map