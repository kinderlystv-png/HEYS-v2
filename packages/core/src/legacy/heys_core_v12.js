/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_core_v12.js (498 —Å—Ç—Ä–æ–∫)                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üõ†Ô∏è –û–°–ù–û–í–ù–´–ï –£–¢–ò–õ–ò–¢–´ (—Å—Ç—Ä–æ–∫–∏ 1-50):                                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: round1, uuid, toNum, toNumInput (8-12)                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: computeDerived (13)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ LocalStorage: lsGet, lsSet —Å cloud sync (14-22)                                  ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –¢–µ–∫—Å—Ç–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã: INVIS, NUM_RE (8-9)                                           ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìÑ –ü–ê–†–°–ò–ù–ì –î–ê–ù–ù–´–• (—Å—Ç—Ä–æ–∫–∏ 51-150):                                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ isHeaderLine() - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (24)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ normalizeLine() - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ (25)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ findTokenPositions() - –ø–æ–∏—Å–∫ –ø–æ–∑–∏—Ü–∏–π (26)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ extractRow() - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (27)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ parsePasted() - —Å Web Worker (32-49)                                             ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ parsePastedSync() - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (85-95)                                   ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìä –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–ê–ú–ò (—Å—Ç—Ä–æ–∫–∏ 151-250):                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getAllProducts() - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ (96-105)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ addProduct() - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (106-125)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ saveProduct() - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (126-145)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ deleteProduct() - —É–¥–∞–ª–µ–Ω–∏–µ (146-165)                                             ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ searchProducts() - –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (166-185)                                  ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ ‚öõÔ∏è REACT –ö–û–ú–ü–û–ù–ï–ù–¢ RationTab (—Å—Ç—Ä–æ–∫–∏ 251-400):                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ state —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (186-220)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Event handlers (221-280):                                                         ‚îÇ
‚îÇ    ‚îÇ   ‚îú‚îÄ‚îÄ handleAddProduct() (221-240)                                                 ‚îÇ
‚îÇ    ‚îÇ   ‚îú‚îÄ‚îÄ handleEditProduct() (241-260)                                                ‚îÇ
‚îÇ    ‚îÇ   ‚îú‚îÄ‚îÄ handleDeleteProduct() (261-270)                                              ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ handlePasteData() (271-280)                                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Render –º–µ—Ç–æ–¥—ã (281-360):                                                          ‚îÇ
‚îÇ    ‚îÇ   ‚îú‚îÄ‚îÄ renderProductForm() (281-320)                                                ‚îÇ
‚îÇ    ‚îÇ   ‚îú‚îÄ‚îÄ renderProductList() (321-350)                                                ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ renderPasteArea() (351-360)                                                  ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ Main render() method (361-400)                                                    ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîó –≠–ö–°–ü–û–†–¢ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 401-444):                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.RationTab - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (401-420)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.utils - —É—Ç–∏–ª–∏—Ç—ã (421-435)                                                   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ã (436-444)                                               ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ü–∞—Ä—Å–∏–Ω–≥: parsePasted() (—Å—Ç—Ä–æ–∫–∞ 32), extractRow() (27)                             ‚îÇ
‚îÇ    ‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç—ã: getAllProducts() (96), addProduct() (106)                               ‚îÇ
‚îÇ    ‚Ä¢ React: RationTab class (186), render() (361)                                       ‚îÇ
‚îÇ    ‚Ä¢ –£—Ç–∏–ª–∏—Ç—ã: lsGet/lsSet (14-22), computeDerived() (13)                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys_core_v12.js ‚Äî —è–¥—Ä–æ + –≤–∫–ª–∞–¥–∫–∞ ¬´–†–∞—Ü–∏–æ–Ω¬ª
(function(global){
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const Store = (HEYS.store)||(HEYS.store={});

  // ===== Utils =====
  const INVIS = /[\u00A0\u1680\u180E\u2000-\u200A\u200B-\u200F\u202F\u205F\u3000\uFEFF]/g;
  const NUM_RE = /[-+]?\d+(?:[\.,]\d+)?/g;
  const round1 = (v) => Math.round(v * 10) / 10;
  const uuid = () => Math.random().toString(36).slice(2,10);
  const toNum = (x) => { if (x===undefined || x===null) return 0; if (typeof x === 'number') return x; const s = String(x).trim().replace(',', '.'); const n = Number(s); return Number.isFinite(n) ? n : 0; };
  const toNumInput = (v)=>{ const n = Number(String(v).replace(',', '.')); return Number.isFinite(n)?n:0; };
  function computeDerived(p){ const carbs100 = toNum(p.simple100) + toNum(p.complex100); const fat100 = toNum(p.badFat100) + toNum(p.goodFat100) + toNum(p.trans100); const kcal100 = 4*(toNum(p.protein100) + carbs100) + 8*fat100; return { carbs100: round1(carbs100), fat100: round1(fat100), kcal100: round1(kcal100) }; }
  function lsGet(key, def){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): def; }catch(e){ return def; } }
  function lsSet(key, val){ 
    try{ 
      console.log('[lsSet] Saving to localStorage:', key, val);
      localStorage.setItem(key, JSON.stringify(val)); 
      console.log('[lsSet] Saving to cloud:', key);
      window.HEYS.saveClientKey(key, val); 
    }catch(e){
      console.error('[lsSet] Error saving:', key, e);
    } 
  }

  function isHeaderLine(line){ const l=line.toLowerCase(); return l.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') && (l.includes('–∫–∫–∞–ª') || l.includes('–∫–∞–ª–æ—Ä–∏') || l.includes('—É–≥–ª–µ–≤–æ–¥')); }
  function normalizeLine(raw){ let s = raw.replace(INVIS,' '); s = s.replace(/\u060C/g, ',').replace(/\u066B/g, ',').replace(/\u066C/g, ',').replace(/\u201A/g, ','); s = s.replace(/\u00B7/g, '.').replace(/[‚Äì‚Äî‚àí]/g, '-').replace(/%/g, ''); s = s.replace(/\t+/g, ' ').replace(/\s+/g, ' ').trim(); return s; }
  function findTokenPositions(s, tokens){ const positions=[]; let start=0; for(const tok of tokens){ const idx=s.indexOf(tok, start); positions.push(idx===-1?null:idx); if(idx!==-1) start=idx+tok.length; } return positions; }
  function extractRow(raw){ const clean = normalizeLine(raw); const tokens = clean.match(NUM_RE) || []; if (!tokens.length) return null; let last = tokens.slice(-12); if (last.length<12) last = Array(12-last.length).fill('0').concat(last); const positions = findTokenPositions(clean, last); const firstPos = positions[0] ?? clean.length; const name = clean.slice(0, firstPos).trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'; const nums = last.map(toNum); return { name, nums }; }
  // --- Web Worker proxy for heavy parsePasted ---
  let _parseWorker = null;
  function getParseWorker() {
    if (!_parseWorker) {
      _parseWorker = new Worker('parse_worker.js');
    }
    return _parseWorker;
  }
  function parsePasted(text) {
    // fallback sync for environments without Worker
    if (typeof Worker === 'undefined') return parsePastedSync(text);
    return new Promise((resolve, reject) => {
      const worker = getParseWorker();
      const handler = (e) => {
        worker.removeEventListener('message', handler);
        resolve(e.data.result && e.data.result.rows ? e.data.result.rows : []);
      };
      worker.addEventListener('message', handler);
      worker.postMessage({ text });
      setTimeout(() => {
        worker.removeEventListener('message', handler);
        reject(new Error('parse timeout'));
      }, 10000);
    });
  }
  // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–∫–µ—Ä–∞ –∏ –∫–∞–∫ fallback)
  function parsePastedSync(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0 && !isHeaderLine(l));
    const rows=[];
    for(const raw of lines){
      const st = extractRow(raw); if(!st) continue;
      const [kcal, carbs, simple, complex, protein, fat, bad, good, trans, fiber, gi, harm] = st.nums;
      const base = { id: uuid(), name: st.name, simple100:simple, complex100:complex, protein100:protein, badFat100:bad, goodFat100:good, trans100:trans, fiber100:fiber, gi:gi, harmScore:harm };
      const d = computeDerived(base);
      rows.push({ id: base.id, name: base.name, ...base, carbs100: d.carbs100, fat100: d.fat100, kcal100: d.kcal100 });
    }
    return rows;
  }

    function RationTab(props){
      const { setProducts } = props;
      const products = Array.isArray(props.products) ? props.products : [];

      // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –æ–±–ª–∞–∫–æ –∏ localStorage –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (—á–µ—Ä–µ–∑ HEYS.utils –¥–ª—è namespace)
      React.useEffect(() => {
        // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ
        if (products.length === 0) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ localStorage –∏–ª–∏ –æ–±–ª–∞–∫–µ
          const existingProducts = (window.HEYS && window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || 
                                  (window.HEYS && window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', null));
          if (existingProducts && Array.isArray(existingProducts) && existingProducts.length > 0) {
            // –ï—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≤ storage, –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º –∏—Ö –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
            return;
          }
        }
        
        if (Array.isArray(products) && window.HEYS && window.HEYS.store && typeof window.HEYS.store.set === 'function') {
          window.HEYS.store.set('heys_products', products);
        } else if (window.HEYS && window.HEYS.utils && typeof window.HEYS.utils.lsSet==='function') {
          // fallback
          window.HEYS.utils.lsSet('heys_products', products);
        }
      }, [products]);
      const [query, setQuery] = React.useState('');
      const [paste, setPaste] = React.useState('');
      const [showModal, setShowModal] = React.useState(false);
      const [draft, setDraft] = React.useState({ name:'', simple100:0, complex100:0, protein100:0, badFat100:0, goodFat100:0, trans100:0, fiber100:0, gi:0, harmScore:0 });
      const derived = computeDerived(draft);
      
      // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π
      const searchIndex = React.useMemo(() => {
        const index = new Map();
        products.forEach((product, idx) => {
          const name = (product.name || '').toLowerCase();
          // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ –ø–µ—Ä–≤—ã–º –±—É–∫–≤–∞–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
          for (let i = 1; i <= Math.min(name.length, 3); i++) {
            const prefix = name.substring(0, i);
            if (!index.has(prefix)) index.set(prefix, []);
            index.get(prefix).push(idx);
          }
          // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ —Å–ª–æ–≤–∞–º
          name.split(/\s+/).forEach(word => {
            if (word.length > 0) {
              if (!index.has(word)) index.set(word, []);
              index.get(word).push(idx);
            }
          });
        });
        return index;
      }, [products]);
      
      const filtered = React.useMemo(() => {
        const startTime = performance.now();
        const result = performSearch();
        const duration = performance.now() - startTime;
        
        // –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–∏—Å–∫–∞
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackSearch(query, result.length, duration);
        }
        
        return result;
          
        function performSearch() {
          const q = query.trim().toLowerCase();
          if (!q) return products;
          
          // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω —É–º–Ω—ã–π –ø–æ–∏—Å–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
          if (window.HEYS && window.HEYS.SmartSearchWithTypos) {
            try {
              const smartResult = window.HEYS.SmartSearchWithTypos.search(q, products, {
                enablePhonetic: true,
                enableSynonyms: true,
                maxSuggestions: 50
              });
              
              if (smartResult && smartResult.results && smartResult.results.length > 0) {
                return smartResult.results;
              }
            } catch (error) {
              console.warn('[HEYS] –û—à–∏–±–∫–∞ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π:', error);
            }
          }
          
          if (q.length <= 3) {
            // –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
            const indices = searchIndex.get(q) || [];
            if (indices.length > 0) {
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackDataOperation('cache-hit');
              }
              return indices.map(idx => products[idx]);
            } else {
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackDataOperation('cache-miss');
              }
              return products.filter(p => (p.name || '').toLowerCase().includes(q));
            }
          } else {
            // –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
            const candidateIndices = new Set();
            
            // –ò—â–µ–º –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º –∏ —Å–ª–æ–≤–∞–º
            for (const [key, indices] of searchIndex.entries()) {
              if (key.includes(q) || q.includes(key)) {
                indices.forEach(idx => candidateIndices.add(idx));
              }
            }
            
            // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö
            if (candidateIndices.size > 0) {
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackDataOperation('cache-hit');
              }
              const candidates = Array.from(candidateIndices).map(idx => products[idx]);
              return candidates.filter(p => (p.name || '').toLowerCase().includes(q));
            }
            
            // Fallback –∫ –æ–±—ã—á–Ω–æ–º—É –ø–æ–∏—Å–∫—É
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackDataOperation('cache-miss');
            }
            return products.filter(p => (p.name || '').toLowerCase().includes(q));
          }
        }
      }, [products, query, searchIndex]);

      // –ü–æ–¥–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –æ–±–ª–∞–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
      React.useEffect(()=>{
        const clientId = window.HEYS && window.HEYS.currentClientId;
        const cloud = window.HEYS && window.HEYS.cloud;
        if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
          const startTime = performance.now();
          const need = (typeof cloud.shouldSyncClient==='function') ? cloud.shouldSyncClient(clientId, 4000) : true;
          if (need){
            cloud.bootstrapClientSync(clientId).then(()=>{
              const duration = performance.now() - startTime;
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackApiCall('bootstrapClientSync', duration, true);
                window.HEYS.analytics.trackDataOperation('cloud-sync');
              }
              const latest = (window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || (window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', [])) || [];
              if (Array.isArray(latest) && latest.length > 0) {
                if (window.HEYS && window.HEYS.analytics) {
                  window.HEYS.analytics.trackDataOperation('products-loaded', latest.length);
                }
              }
              setProducts(Array.isArray(latest)?latest:[]);
            }).catch((error) => {
              const duration = performance.now() - startTime;
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackApiCall('bootstrapClientSync', duration, false);
              }
              console.error('Bootstrap client sync failed:', error);
            });
          } else {
            const latest = (window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || (window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', [])) || [];
            if (Array.isArray(latest) && latest.length > 0) {
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackDataOperation('products-loaded', latest.length);
              }
            }
            setProducts(Array.isArray(latest)?latest:[]);
          }
        } else {
          const latest = (window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || (window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', [])) || [];
          setProducts(Array.isArray(latest)?latest:[]);
        }
      }, [window.HEYS && window.HEYS.currentClientId]);

    function resetDraft(){ setDraft({name:'', simple100:0, complex100:0, protein100:0, badFat100:0, goodFat100:0, trans100:0, fiber100:0, gi:0, harmScore:0}); }
    function addProduct(){ 
      const base = { id: uuid(), name: draft.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', simple100: toNum(draft.simple100), complex100: toNum(draft.complex100), protein100: toNum(draft.protein100), badFat100: toNum(draft.badFat100), goodFat100: toNum(draft.goodFat100), trans100: toNum(draft.trans100), fiber100: toNum(draft.fiber100), gi: toNum(draft.gi), harmScore: toNum(draft.harmScore) }; 
      const d = computeDerived(base); 
      setProducts([...products, { ...base, ...d }]); 
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('products-loaded', 1);
      }
      resetDraft(); 
      setShowModal(false); 
    }
    function updateRow(id, patch){ 
      setProducts(products.map(p=>{ if(p.id !== id) return p; const changed = { ...p, ...patch }; const d = computeDerived(changed); return { ...changed, ...d }; })); 
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('storage-op');
      }
    }
    function deleteRow(id){ 
      setProducts(products.filter(p=>p.id!==id)); 
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('storage-op');
      }
    }
    async function importAppend(){
      const startTime = performance.now();
      let rows = [];
      try {
        rows = await parsePasted(paste);
        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, true);
        }
      } catch(e) { 
        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, false);
        }
        alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: '+e.message); 
        return; 
      }
      if(!rows.length){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ'); return; }
      setProducts([...products, ...rows]);
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('products-loaded', rows.length);
      }
    }
    async function importReplace(){
      const startTime = performance.now();
      let rows = [];
      try {
        rows = await parsePasted(paste);
        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, true);
        }
      } catch(e) { 
        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, false);
        }
        alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: '+e.message); 
        return; 
      }
      if(!rows.length){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ'); return; }
      setProducts(rows);
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('products-loaded', rows.length);
      }
    }

    return React.createElement('div', {className:'page page-ration'},
      React.createElement('div', {className:'card tone-amber', style:{marginBottom:'8px'}},
        React.createElement('div', {className:'section-title'}, '–ò–º–ø–æ—Ä—Ç –∏–∑ –≤—Å—Ç–∞–≤–∫–∏'),
        React.createElement('textarea', {placeholder:'–í—Å—Ç–∞–≤—å —Å—Ç—Ä–æ–∫–∏: –ù–∞–∑–≤–∞–Ω–∏–µ + 12 —á–∏—Å–µ–ª —Å–ø—Ä–∞–≤–∞', value:paste, onChange:e=>setPaste(e.target.value)}),
        React.createElement('div', {className:'row', style:{marginTop:'8px'}},
          React.createElement('button', {className:'btn acc', onClick:importAppend}, '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å (–¥–æ–±–∞–≤–∏—Ç—å)'),
          React.createElement('button', {className:'btn', onClick:importReplace}, '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å (–∑–∞–º–µ–Ω–∏—Ç—å)'),
          React.createElement('span', {className:'muted'}, '–ó–∞–ø—è—Ç—ã–µ –¥–æ–ø—É—Å—Ç–∏–º—ã. –ï—Å–ª–∏ —á–∏—Å–µ–ª –º–µ–Ω—å—à–µ 12 ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ = 0.')
        )
      ),
      React.createElement('div', {className:'card tone-blue'},
        React.createElement('div', {className:'topbar'},
          React.createElement('div', {className:'row'},
            React.createElement('input', {placeholder:'–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶', value:query, onChange:e=>setQuery(e.target.value), style:{minWidth:'260px'}}),
            React.createElement('span', {className:'muted'}, `–ù–∞–π–¥–µ–Ω–æ: ${filtered.length} –∏–∑ ${products.length}`)
          ),
          React.createElement('div', {className:'row'},
            React.createElement('button', {className:'btn acc', onClick:()=>setShowModal(true)}, '+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç')
          )
        ),
        React.createElement('div', {style:{overflowX:'auto'}},
          React.createElement('table', null,
            React.createElement('thead', null,
              React.createElement('tr', null,
                React.createElement('th', null, '–ù–∞–∑–≤–∞–Ω–∏–µ'),
                React.createElement('th', null, '–ö–∫–∞–ª (100–≥)'),
                React.createElement('th', null, '–£–≥–ª–µ–≤–æ–¥—ã'),
                React.createElement('th', null, '–ü—Ä–æ—Å—Ç—ã–µ'),
                React.createElement('th', null, '–°–ª–æ–∂–Ω—ã–µ'),
                React.createElement('th', null, '–ë–µ–ª–∫–∏'),
                React.createElement('th', null, '–ñ–∏—Ä—ã'),
                React.createElement('th', null, '–í—Ä–µ–¥–Ω—ã–µ'),
                React.createElement('th', null, '–ü–æ–ª–µ–∑–Ω—ã–µ'),
                React.createElement('th', null, '–°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ'),
                React.createElement('th', null, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞'),
                React.createElement('th', null, '–ì–ò'),
                React.createElement('th', null, '–í—Ä–µ–¥–Ω–æ—Å—Ç—å'),
                React.createElement('th', null, '')
              )
            ),
            React.createElement('tbody', null,
              filtered.map(p=> React.createElement('tr', {key:p.id},
                React.createElement('td', null, React.createElement('input', {value:p.name, onChange:e=>updateRow(p.id, {name:e.target.value})})),
                React.createElement('td', null, React.createElement('input', {className:'readOnly', value:p.kcal100, readOnly:true})),
                React.createElement('td', null, React.createElement('input', {className:'readOnly', value:p.carbs100, readOnly:true})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.simple100, onChange:e=>updateRow(p.id, {simple100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.complex100, onChange:e=>updateRow(p.id, {complex100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.protein100, onChange:e=>updateRow(p.id, {protein100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {className:'readOnly', value:p.fat100, readOnly:true})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.badFat100, onChange:e=>updateRow(p.id, {badFat100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.goodFat100, onChange:e=>updateRow(p.id, {goodFat100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.trans100, onChange:e=>updateRow(p.id, {trans100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.fiber100, onChange:e=>updateRow(p.id, {fiber100:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.gi, onChange:e=>updateRow(p.id, {gi:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('input', {type:'text', value:p.harmScore, onChange:e=>updateRow(p.id, {harmScore:toNum(e.target.value)})})),
                React.createElement('td', null, React.createElement('button', {className:'btn', onClick:()=>deleteRow(p.id)}, '–£–¥–∞–ª–∏—Ç—å'))
              ))
            )
          )
        ),
        React.createElement('div', {className:'muted', style:{marginTop:'8px'}}, '–°–µ—Ä—ã–µ –ø–æ–ª—è ‚Äî –∞–≤—Ç–æ: –£=–ø—Ä–æ—Å—Ç—ã–µ+—Å–ª–æ–∂–Ω—ã–µ; –ñ=–≤—Ä–µ–¥–Ω—ã–µ+–ø–æ–ª–µ–∑–Ω—ã–µ+—Å—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ; –ö–∫–∞–ª=4√ó(–ë+–£)+8√ó–ñ.')
      ),
      showModal && React.createElement('div', {className:'modal-backdrop', onClick:(e)=>{ if(e.target.classList.contains('modal-backdrop')) setShowModal(false); }},
        React.createElement('div', {className:'modal'},
          React.createElement('div', {className:'row', style:{justifyContent:'space-between'}},
            React.createElement('div', null, '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç'),
            React.createElement('button', {className:'btn', onClick:()=>setShowModal(false)}, '√ó')
          ),
          React.createElement('div', {className:'grid grid-2', style:{marginTop:'8px'}},
            React.createElement('div', null, React.createElement('label', null, '–ù–∞–∑–≤–∞–Ω–∏–µ'), React.createElement('input', {value:draft.name, onChange:e=>setDraft({...draft, name:e.target.value})})),
            React.createElement('div', null, React.createElement('label', null, '–ì–ò'), React.createElement('input', {type:'text', value:draft.gi, onChange:e=>setDraft({...draft, gi:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–ü—Ä–æ—Å—Ç—ã–µ (100–≥)'), React.createElement('input', {type:'text', value:draft.simple100, onChange:e=>setDraft({...draft, simple100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–°–ª–æ–∂–Ω—ã–µ (100–≥)'), React.createElement('input', {type:'text', value:draft.complex100, onChange:e=>setDraft({...draft, complex100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–ë–µ–ª–∫–∏ (100–≥)'), React.createElement('input', {type:'text', value:draft.protein100, onChange:e=>setDraft({...draft, protein100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'), React.createElement('input', {type:'text', value:draft.badFat100, onChange:e=>setDraft({...draft, badFat100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'), React.createElement('input', {type:'text', value:draft.goodFat100, onChange:e=>setDraft({...draft, goodFat100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'), React.createElement('input', {type:'text', value:draft.trans100, onChange:e=>setDraft({...draft, trans100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (100–≥)'), React.createElement('input', {type:'text', value:draft.fiber100, onChange:e=>setDraft({...draft, fiber100:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–í—Ä–µ–¥–Ω–æ—Å—Ç—å (0‚Äì10)'), React.createElement('input', {type:'text', value:draft.harmScore, onChange:e=>setDraft({...draft, harmScore:toNum(e.target.value)})})),
            React.createElement('div', null, React.createElement('label', null, '–£–≥–ª–µ–≤–æ–¥—ã (100–≥) ‚Äî –∞–≤—Ç–æ'), React.createElement('input', {className:'readOnly', readOnly:true, value:derived.carbs100})),
            React.createElement('div', null, React.createElement('label', null, '–ñ–∏—Ä—ã (100–≥) ‚Äî –∞–≤—Ç–æ'), React.createElement('input', {className:'readOnly', readOnly:true, value:derived.fat100})),
            React.createElement('div', null, React.createElement('label', null, '–ö–∞–ª–æ—Ä–∏–∏ (100–≥) ‚Äî –∞–≤—Ç–æ'), React.createElement('input', {className:'readOnly', readOnly:true, value:derived.kcal100}))
          ),
          React.createElement('div', {className:'row', style:{justifyContent:'flex-end', marginTop:'10px'}},
            React.createElement('button', {className:'btn', onClick:()=>{ setShowModal(false); resetDraft(); }}, '–û—Ç–º–µ–Ω–∞'),
            React.createElement('button', {className:'btn acc', onClick:addProduct}, '–î–æ–±–∞–≤–∏—Ç—å')
          )
        )
      )
    );
  }

  // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  const validateInput = (value, type) => {
    if (value === null || value === undefined) return false;
    if (type === 'number') return !isNaN(parseFloat(value));
    if (type === 'string') return typeof value === 'string' && value.length > 0;
    if (type === 'email') return typeof value === 'string' && value.includes('@');
    return true; // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞
  };

  HEYS.utils = { INVIS, NUM_RE, round1, uuid, toNum, toNumInput, computeDerived, lsGet, lsSet, parsePasted, validateInput };
  HEYS.validateInput = validateInput; // –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  HEYS.core = { validateInput }; // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç core —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
  
  // products helper API (thin wrapper over store + local fallback)
  HEYS.products = HEYS.products || {
    getAll: ()=> (HEYS.store&&HEYS.store.get&&HEYS.store.get('heys_products', [])) || (HEYS.utils&&HEYS.utils.lsGet&&HEYS.utils.lsGet('heys_products', [])) || [],
    setAll: (arr)=> { if(HEYS.store&&HEYS.store.set) HEYS.store.set('heys_products', arr); else if(HEYS.utils&&HEYS.utils.lsSet) HEYS.utils.lsSet('heys_products', arr); },
    watch: (fn)=> { if(HEYS.store&&HEYS.store.watch) return HEYS.store.watch('heys_products', fn); return ()=>{}; }
  };
  HEYS.RationTab = RationTab;
  HEYS.Ration = RationTab;
})(window);


;(function(global){
  const HEYS = global.HEYS = global.HEYS || {};
  const U = HEYS.utils || {};
  if (!U.__clientScoped) {
    const get0 = U.lsGet ? U.lsGet.bind(U) : (k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(e){ return d; } };
    const set0 = U.lsSet ? U.lsSet.bind(U) : (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} };

    function nsKey(k){
      // 1) —Ç–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç: –∏–∑ –≥–ª–æ–±–∞–ª–∞ –∏–ª–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
      let cid = (global.HEYS && HEYS.currentClientId) || '';
      if (!cid) {
        try { const raw = localStorage.getItem('heys_client_current'); if (raw) cid = JSON.parse(raw); } catch(e){ cid=''; }
      }
      // 2) —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏ –ù–ï –ø—Ä–µ—Ñ–∏–∫—Å—É–µ–º (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
      if (/^heys_(clients|client_current)$/i.test(k)) return k;
      // 3) –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
      if (!cid) return k;
      // 4) –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—à–∏ –∫–ª—é—á–∏ –ø—Ä–µ—Ñ–∏–∫—Å—É–µ–º
      if (/^(heys_|day_)/i.test(k)) {
        return k.replace(/^(heys_|day_)/i, (m)=> m + cid + '_');
      }
      return k;
    }

    U.lsGet = (k,d)=> get0(nsKey(k), d);
    U.lsSet = (k,v)=> set0(nsKey(k), v);
    U.__clientScoped = true;
  }
})(window);
