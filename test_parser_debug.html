<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>üî¨ Parser Debug Test</title>
    <style>
        body {
            font-family: system-ui;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .test {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .pass {
            border-left: 4px solid #22c55e;
        }

        .fail {
            border-left: 4px solid #ef4444;
        }

        pre {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        h2 {
            color: #6ba6ff;
        }
    </style>
</head>

<body>
    <h1>üî¨ AI Parser Debug Test</h1>
    <button onclick="runTest()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <div id="results"></div>

    <script>
        // Copy-paste normalizeAIKey function
        function normalizeAIKey(rawKey) {
            return String(rawKey || '')
                .toLowerCase()
                .replace(/—ë/g, '–µ')
                .replace(/[^a-z0-9–∞-—è]/gi, '');
        }

        // Test cases
        const testCases = [
            { input: '–í–∏—Ç–∞–º–∏–Ω K', expected: '–≤–∏—Ç–∞–º–∏–Ωk', desc: '–í–∏—Ç–∞–º–∏–Ω K —Å –ø—Ä–æ–±–µ–ª–æ–º' },
            { input: '–ì–ò', expected: '–≥–∏', desc: '–ì–ò –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏' },
            { input: '–û–º–µ–≥–∞-3', expected: '–æ–º–µ–≥–∞3', desc: '–û–º–µ–≥–∞-3 —Å –¥–µ—Ñ–∏—Å–æ–º' },
            { input: '–ñ–µ–ª–µ–∑–æ', expected: '–∂–µ–ª–µ–∑–æ', desc: '–ñ–µ–ª–µ–∑–æ' },
            { input: '–í–∏—Ç–∞–º–∏–Ω B1', expected: '–≤–∏—Ç–∞–º–∏–Ωb1', desc: 'B1 —Å –ø—Ä–æ–±–µ–ª–æ–º' },
            { input: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã', expected: '—Ç—Ä–∞–Ω—Å–∂–∏—Ä—ã', desc: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã —Å –¥–µ—Ñ–∏—Å–æ–º' },
        ];

        // Test parseNumber
        function parseAIValueNumber(rawValue) {
            if (rawValue == null) return undefined;
            const cleaned = String(rawValue)
                .replace(/,/g, '.')
                .replace(/[^0-9+\-.]/g, ' ');
            const match = cleaned.match(/[-+]?\d+(?:\.\d+)?/);
            if (!match) return undefined;
            const n = Number(match[0]);
            return Number.isFinite(n) ? n : undefined;
        }

        const numberTests = [
            { input: '0.1', expected: 0.1 },
            { input: '1.2', expected: 1.2 },
            { input: '12', expected: 12 },
            { input: '450', expected: 450 },
            { input: '0', expected: 0 },
            { input: '0.0', expected: 0 },
        ];

        function runTest() {
            const results = document.getElementById('results');
            results.innerHTML = '';

            // Test key normalization
            results.innerHTML += '<h2>üîë –¢–µ—Å—Ç normalizeAIKey</h2>';
            testCases.forEach(test => {
                const actual = normalizeAIKey(test.input);
                const pass = actual === test.expected;
                results.innerHTML += `
                    <div class="test ${pass ? 'pass' : 'fail'}">
                        <strong>${test.desc}</strong><br>
                        –í–≤–æ–¥: <code>${test.input}</code><br>
                        –û–∂–∏–¥–∞–ª–æ—Å—å: <code>${test.expected}</code><br>
                        –ü–æ–ª—É—á–µ–Ω–æ: <code>${actual}</code><br>
                        ${pass ? '‚úÖ PASS' : '‚ùå FAIL'}
                    </div>
                `;
            });

            // Test number parsing
            results.innerHTML += '<h2>üî¢ –¢–µ—Å—Ç parseAIValueNumber</h2>';
            numberTests.forEach(test => {
                const actual = parseAIValueNumber(test.input);
                const pass = actual === test.expected;
                results.innerHTML += `
                    <div class="test ${pass ? 'pass' : 'fail'}">
                        –í–≤–æ–¥: <code>${test.input}</code><br>
                        –û–∂–∏–¥–∞–ª–æ—Å—å: <code>${test.expected}</code><br>
                        –ü–æ–ª—É—á–µ–Ω–æ: <code>${actual}</code><br>
                        ${pass ? '‚úÖ PASS' : '‚ùå FAIL'}
                    </div>
                `;
            });

            // Test full string parsing
            results.innerHTML += '<h2>üìù –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Å—Ç—Ä–æ–∫–∏</h2>';
            const fullString = `–ù–∞–∑–≤–∞–Ω–∏–µ: –°–∞–ª–∞—Ç —Å –∫–æ–ø—á—ë–Ω–æ–π –∫—É—Ä–∏—Ü–µ–π
–ö–∫–∞–ª: 108.4
–£–≥–ª–µ–≤–æ–¥—ã: 8.5
–ü—Ä–æ—Å—Ç—ã–µ: 3.8
–°–ª–æ–∂–Ω—ã–µ: 3.3
–ë–µ–ª–æ–∫: 8.7
–ñ–∏—Ä—ã: 3.9
–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: 0.8
–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: 3.2
–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: 0
–ö–ª–µ—Ç—á–∞—Ç–∫–∞: 1.5
–ì–ò: 45
–í—Ä–µ–¥: 2.2
–ù–∞—Ç—Ä–∏–π: 950
–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 20
–û–º–µ–≥–∞-3: 0.1
–û–º–µ–≥–∞-6: 1.1
–ñ–µ–ª–µ–∑–æ: 1.2
–í–∏—Ç–∞–º–∏–Ω K: 12`;

            const lines = fullString.split('\n');
            const parsed = [];
            lines.forEach(line => {
                const match = line.match(/^(.+?)[\s]*[:=][\s]+(.+)$/);
                if (!match) return;
                const rawKey = match[1].trim();
                const rawValue = match[2].trim();
                const normalizedKey = normalizeAIKey(rawKey);
                const numVal = parseAIValueNumber(rawValue);
                parsed.push({
                    raw: rawKey,
                    normalized: normalizedKey,
                    value: rawValue,
                    parsed: numVal
                });
            });

            results.innerHTML += '<pre>' + JSON.stringify(parsed, null, 2) + '</pre>';
        }
    </script>
</body>

</html>