<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>HEYS Module Load Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #222; color: #eee; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #0a84ff; background: #333; }
        .success { border-color: #30d158; }
        .error { border-color: #ff453a; }
        .warning { border-color: #ff9f0a; }
        .log { background: #111; padding: 10px; margin: 10px 0; font-family: monospace; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ HEYS Module Load Test</h1>
    <div id="progress"></div>
    <div id="log" class="log"></div>
    <button onclick="runDiagnostic().then(result => console.log('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', result))">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>

    <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª–∏ –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <script src="../heys_performance_monitor.js"></script>
    <script src="../heys_analytics_ui.js"></script>
    <script src="../heys_smart_search.js"></script>
    <script src="../heys_integration_layer.js"></script>
    <script src="../heys_security_validation.js"></script>
    <script src="../heys_storage_supabase_v1.js"></script>
    <script src="../heys_models_v1.js"></script>
    <script src="../heys_storage_layer_v1.js"></script>
    <script src="../heys_core_v12.js"></script>
    <script src="../heys_day_v12.js"></script>
    <script src="../heys_user_v12.js"></script>
    <script src="../heys_reports_v12.js"></script>
    <script src="../heys_error_boundary_v1.js"></script>
    <script src="../heys_virtual_list_v1.js"></script>
    <script src="../heys_stats_v1.js"></script>

    <script>
        let logContent = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }

        function addStep(message, type = 'step') {
            const progress = document.getElementById('progress');
            const step = document.createElement('div');
            step.className = `step ${type}`;
            step.textContent = message;
            progress.appendChild(step);
        }

        function testModule(name, path) {
            const parts = path.split('.');
            let current = window;
            
            for (const part of parts) {
                if (current && current[part]) {
                    current = current[part];
                } else {
                    return { exists: false, error: `–ù–µ –Ω–∞–π–¥–µ–Ω ${part} –≤ ${path}` };
                }
            }
            
            return { exists: true, value: current };
        }

        function runDiagnostic() {
            return new Promise(async (resolve) => {
                document.getElementById('progress').innerHTML = '';
                logContent = '';
                
                const startTime = performance.now();
                log('üöÄ –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º–æ–¥—É–ª–µ–π HEYS...');
                addStep('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ namespace', 'step');

                // üîí PROMISE-BASED –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º HEYS namespace
                if (typeof window.HEYS === 'undefined') {
                    log('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: window.HEYS –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                    addStep('‚ùå HEYS namespace –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
                    resolve({ status: 'critical_error', message: 'HEYS namespace –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' });
                    return;
                }

                log('‚úÖ HEYS namespace –Ω–∞–π–¥–µ–Ω');
                log(`üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ HEYS: ${Object.keys(window.HEYS).join(', ')}`);
                addStep('‚úÖ HEYS namespace –Ω–∞–π–¥–µ–Ω', 'success');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û
                const modules = [
                    { name: 'Reports System', path: 'HEYS.ReportsManager' },
                    { name: 'Smart Search', path: 'HEYS.SmartSearchEngine' },
                    { name: 'Integration Layer', path: 'HEYS.IntegrationLayer' },
                    { name: 'Security Headers', path: 'HEYS.SecurityValidationManager' }
                ];

                const testResults = [];
                
                // üß™ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï: –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
                for (const module of modules) {
                    const moduleStartTime = performance.now();
                    addStep(`üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${module.name}...`, 'step');
                    
                    // ‚è≥ –ò–ú–ò–¢–ê–¶–ò–Ø –°–ò–ù–•–†–û–ù–ù–û–ì–û –û–ñ–ò–î–ê–ù–ò–Ø
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const result = testModule(module.name, module.path);
                    const moduleTime = Math.round(performance.now() - moduleStartTime);
                    
                    if (result.exists) {
                        log(`‚úÖ ${module.name}: –ù–ê–ô–î–ï–ù (${moduleTime}ms)`);
                        addStep(`‚úÖ ${module.name}: –ù–ê–ô–î–ï–ù (${moduleTime}ms)`, 'success');
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                        if (typeof result.value === 'function') {
                            log(`  üì¶ ${module.name} —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π/–∫–ª–∞—Å—Å–æ–º`);
                            
                            try {
                                const instance = new result.value();
                                log(`  ‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä ${module.name} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ`);
                                
                                // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è SecurityValidationManager
                                if (module.path === 'HEYS.SecurityValidationManager') {
                                    await testSecurityMethods(instance);
                                }
                                
                                testResults.push({ 
                                    module: module.name, 
                                    status: 'success', 
                                    duration: moduleTime,
                                    instanceCreated: true 
                                });
                                
                            } catch (error) {
                                log(`  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä: ${error.message}`);
                                addStep(`‚ö†Ô∏è ${module.name}: –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ–º`, 'warning');
                                testResults.push({ 
                                    module: module.name, 
                                    status: 'warning', 
                                    duration: moduleTime,
                                    instanceCreated: false,
                                    error: error.message 
                                });
                            }
                        } else {
                            log(`  üìã ${module.name} —è–≤–ª—è–µ—Ç—Å—è ${typeof result.value}`);
                            testResults.push({ 
                                module: module.name, 
                                status: 'success', 
                                duration: moduleTime,
                                type: typeof result.value 
                            });
                        }
                    } else {
                        log(`‚ùå ${module.name}: –ù–ï –ù–ê–ô–î–ï–ù - ${result.error} (${moduleTime}ms)`);
                        addStep(`‚ùå ${module.name}: –ù–ï –ù–ê–ô–î–ï–ù (${moduleTime}ms)`, 'error');
                        testResults.push({ 
                            module: module.name, 
                            status: 'error', 
                            duration: moduleTime,
                            error: result.error 
                        });
                    }
                }

                // üìä –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
                const totalTime = Math.round(performance.now() - startTime);
                const successful = testResults.filter(r => r.status === 'success').length;
                const failed = testResults.filter(r => r.status === 'error').length;
                const warnings = testResults.filter(r => r.status === 'warning').length;
                
                log('üèÅ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${successful} —É—Å–ø–µ—à–Ω–æ, ${warnings} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π, ${failed} –æ—à–∏–±–æ–∫`);
                log(`‚è±Ô∏è –û–±—â–µ–µ –≤—Ä–µ–º—è: ${totalTime}ms`);
                
                addStep('üèÅ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                addStep(`üìä ${successful}‚úÖ ${warnings}‚ö†Ô∏è ${failed}‚ùå –∑–∞ ${totalTime}ms`, 'success');
                
                resolve({
                    status: 'completed',
                    totalTime,
                    successful,
                    warnings,
                    failed,
                    results: testResults
                });
            });
        }

        async function testSecurityMethods(instance) {
            // üîí –ü–†–û–í–ï–†–ö–ê –ú–ï–¢–û–î–û–í –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
            if (typeof instance.applySecurityHeaders === 'function') {
                log(`  ‚úÖ applySecurityHeaders() –¥–æ—Å—Ç—É–ø–µ–Ω`);
                try {
                    const headers = instance.applySecurityHeaders();
                    log(`  ‚úÖ applySecurityHeaders() —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: ${headers.size}`);
                } catch (error) {
                    log(`  ‚ùå applySecurityHeaders() –æ—à–∏–±–∫–∞: ${error.message}`);
                }
            } else {
                log(`  ‚ùå applySecurityHeaders() –ù–ï –ù–ê–ô–î–ï–ù`);
            }
            
            if (typeof instance.validateInput === 'function') {
                log(`  ‚úÖ validateInput() –¥–æ—Å—Ç—É–ø–µ–Ω`);
                try {
                    const result = instance.validateInput('test@email.com', 'email');
                    log(`  ‚úÖ validateInput() —Ä–∞–±–æ—Ç–∞–µ—Ç: ${JSON.stringify(result)}`);
                } catch (error) {
                    log(`  ‚ùå validateInput() –æ—à–∏–±–∫–∞: ${error.message}`);
                }
            } else {
                log(`  ‚ùå validateInput() –ù–ï –ù–ê–ô–î–ï–ù`);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        window.addEventListener('load', () => {
            setTimeout(async () => {
                log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
                const result = await runDiagnostic();
                log(`üìã –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${result.status}`);
                if (result.status === 'completed') {
                    log(`üéØ –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º—ã: ${Math.round((result.successful / (result.successful + result.failed + result.warnings)) * 100)}%`);
                }
            }, 3000);
        });
    </script>
</body>
</html>
