<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>HEYS Diagnostic Center (v2-core)</title>
    <link rel="manifest" href="../manifest.webmanifest">

    <!-- â™¦ ĞœĞ˜ĞĞ˜ĞœĞĞ›Ğ¬ĞĞ«Ğ™ CSS -->
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif}
        body{background:#f8fafc;color:#1e293b}
        h1{font-size:1.8rem;margin:20px 0;text-align:center}
        .controls,.log,.stats{max-width:1100px;margin:20px auto}
        .controls button{margin:4px;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;background:#667eea;color:#fff}
        .controls button:hover{background:#5a67d8}
        .bar{width:100%;height:10px;background:#e2e8f0;border-radius:6px;overflow:hidden;margin:10px 0}
        .fill{height:100%;width:0;background:#22c55e;transition:width .3s}
        .tests{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;max-width:1100px;margin:20px auto}
        .test{padding:12px;border:1px solid #cbd5e1;border-radius:8px;display:flex;justify-content:space-between}
        .test.running{background:#fef9c3}
        .test.success{background:#dcfce7}
        .test.error{background:#fee2e2}
        .log{background:#1e293b;color:#cbd5e1;padding:12px;border-radius:8px;max-height:280px;overflow:auto;font-size:12px}
    </style>

    <!-- â™¦ Ñ€Ğ°Ğ½Ğ½ÑÑ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ€ĞµĞµÑÑ‚Ñ€Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ suites Ğ¼Ğ¾Ğ³Ğ»Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ -->
    <script>
        window.__heysTests = [];
        window.addTest = t => window.__heysTests.push(t);
    </script>

    <!-- â™¦ heys-ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹ (ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾) -->
    <script src="../heys_core_v12.js"></script>
    <script src="../heys_reports_v12.js"></script>
    <script src="../heys_smart_search_with_typos_v1.js"></script>
    <script src="../heys_integration_layer_v1.js"></script>

    <!-- â™¦ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸-suites (Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑÑ€Ğ°Ğ·Ñƒ zĞ²Ğ°Ñ‚ÑŒ addTest) -->
    <script src="./suites/core.js"></script>
    <script src="./suites/security.js"></script>
    <script src="./suites/performance.js"></script>
    <script src="./suites/ux.js"></script>
    <script src="./suites/pwa.js"></script>
    <link rel="manifest" href="../manifest.webmanifest">
</head>
<body>

<h1>ğŸ¥ HEYS Diagnostic Center</h1>

<!-- â™¦ ĞšĞĞĞŸĞšĞ˜ Ğ—ĞĞŸĞ£Ğ¡ĞšĞ -->
<div class="controls">
    <button id="btn-keep">âš¡ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ (KEEP)</button>
    <button id="btn-fast">ğŸƒâ€â™‚ï¸ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ (KEEP + SIMPLIFY)</button>
    <button id="btn-all">ğŸš€ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°</button>
    <button id="btn-core">ğŸ”§ Core Tests</button>
    <button id="btn-security">ğŸ”’ Security Tests</button>
    <button id="btn-performance">âš¡ Performance Tests</button>
    <button id="btn-ux">ğŸ¨ UX Tests</button>
    <button id="btn-pwa">ğŸ“± PWA Tests</button>
</div>

<!-- â™¦ ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡ -->
<div class="controls">
    <div class="bar"><div id="bar-fill" class="fill"></div></div>
    <div id="stat-text">0 / 0</div>
</div>

<!-- â™¦ Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ¢Ğ•Ğ¡Ğ¢ĞĞ’ (Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ JS) -->
<div id="tests" class="tests"></div>

<!-- â™¦ Ğ›ĞĞ“ -->
<div class="log" id="log"></div>

<!-- â™¦ Ğ•Ğ”Ğ˜ĞĞ«Ğ™ Ğ ĞĞĞĞ•Ğ  -->
<script>
/* ----------  Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜  ---------- */
const qs  = id => document.getElementById(id);
const diagResults = [];

const log = (msg, cls = '') => {
  const area = qs('log');
  const line = document.createElement('div');
  if (cls) {
    line.style.color =
      cls === 'error'   ? '#f87171' :
      cls === 'success' ? '#4ade80' :
                          '#60a5fa';
  }
  line.textContent = msg;
  area.appendChild(line);
  area.scrollTop = area.scrollHeight;
};

const setBar = (done, total) => {
  qs('bar-fill').style.width = total ? `${(done / total) * 100}%` : '0';
  qs('stat-text').textContent = `${done}/${total}`;
};

const addTestEl = name => {
  const el = document.createElement('div');
  el.className = 'test';
  el.id = `test-${name}`.replace(/\s+/g, '-');
  el.innerHTML = `<span>${name}</span><span>ğŸ•’</span>`;
  qs('tests').appendChild(el);
  return el;
};

/* ----------  Ğ Ğ•Ğ•Ğ¡Ğ¢Ğ   ---------- */
const tests = window.__heysTests;

/* ----------  RUNNER  ---------- */
async function run(profile) {
    // Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚
    const tags = Array.isArray(profile) ? profile : [profile];

    // ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹ â†’ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ category
    const categories = ['core','security','performance','ux','pwa'];
    let allowed;
    if (categories.includes(tags[0])) {
        const cat = tags[0];
        allowed = tests.filter(t => t.category === cat && !t.tags.includes('drop'));
    } else {
        // Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ-Ğ¿Ğ¾-Ñ‚ĞµĞ³Ğ°Ğ¼
        const tagSet = tags[0]==='keep' ? ['keep']
                    : tags[0]==='fast' ? ['keep','simplify']
                    : tags.includes('all') ? ['all'] : tags;

        allowed = tagSet.includes('all')
            ? tests
            : tests.filter(t => !t.tags || t.tags.some(tag => tagSet.includes(tag)));
    }

    if (!allowed.length) {
        log(`âŒ ĞĞµÑ‚ Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ: ${profile}`, 'error');   // â† profile
        return;
    }

    log(`ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº ${allowed.length} Ñ‚ĞµÑÑ‚Ğ¾Ğ² (Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ: ${profile})`, 'info'); // â† profile
    allowed.forEach(t => addTestEl(t.name));

    let done = 0;
    for (const t of allowed){
        const el = qs(`test-${t.name}`.replace(/\s+/g,'-'));
        el.classList.add('running');

        let ok = false, reason = '';
        try {
            const result = await Promise.race([
                Promise.resolve(t.fn()).catch(e=>{throw e}),
                new Promise(r=>setTimeout(()=>r(false), t.timeout||4000))
            ]);
            
            // ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°
            if (typeof result === 'object' && result !== null) {
                ok = result.success;
                reason = result.error || result.details || '';
            } else {
                ok = result;
                if (!ok && !reason) reason = 'timeout | returned false';
            }
        } catch (e){
            ok = false;
            reason = e?.message || 'exception';
        }

        diagResults.push({ 
            name: t.name, 
            category: t.category || 'legacy',
            tags: t.tags || [],
            ok, 
            reason,
            description: t.description || ''
        });
        
        el.classList.remove('running');
        el.classList.add(ok ? 'success' : 'error');
        el.lastChild.textContent = ok ? 'âœ…' : 'âŒ';

        const icon = ok ? 'âœ…' : 'âŒ';
        log(`${icon} ${t.name}${!ok ? ' â€” ' + reason : ''}`, ok?'success':'error');

        setBar(++done, allowed.length);
    }

    /* Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğµ Ñ€ĞµĞ·ÑĞ¼Ğµ Ğ² Ğ¾Ğ´Ğ½Ñƒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ JSON â”€ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ */
    const summary = {
        timestamp: new Date().toISOString(),
        passed:   diagResults.filter(r=>r.ok).length,
        failed:   diagResults.filter(r=>!r.ok).length,
        results:  diagResults
    };
    console.table(diagResults);
    console.log('ğŸ“„ HEYS-Diag-Summary:', summary);   // ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· ĞºĞ¾Ğ½ÑĞ¾Ğ»Ğ¸
    log('â€”â€” Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« JSON ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ· ĞºĞ¾Ğ½ÑĞ¾Ğ»Ğ¸: "HEYS-Diag-Summary" â€”â€”','info');
}

/* ----------  ĞšĞĞĞŸĞšĞ˜  ---------- */
qs('btn-keep').onclick        = () => run('keep');
qs('btn-fast').onclick        = () => run('fast');
qs('btn-all').onclick         = () => run('all');
qs('btn-core').onclick        = () => run('core');
qs('btn-security').onclick    = () => run('security');
qs('btn-performance').onclick = () => run('performance');
qs('btn-ux').onclick          = () => run('ux');
qs('btn-pwa').onclick         = () => run('pwa');
</script>
</body>
</html>