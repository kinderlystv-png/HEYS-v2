/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_security_validation.js (522 —Å—Ç—Ä–æ–∫–∏)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üõ°Ô∏è –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° SecurityValidationManager (—Å—Ç—Ä–æ–∫–∏ 1-80):                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ constructor() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (9-30)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (11-18)                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ securityHeaders, validationRules (20-22)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ú–µ—Ç—Ä–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (23-28)                                                     ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ initializeSecurityManager() (32-45)                                              ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîí –°–ò–°–¢–ï–ú–ê –ó–ê–ì–û–õ–û–í–ö–û–í –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (—Å—Ç—Ä–æ–∫–∏ 81-180):                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ setupSecurityHeaders() - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (46-80)                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ validateSecurityHeaders() - –ø—Ä–æ–≤–µ—Ä–∫–∞ (81-110)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ updateSecurityHeader() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (111-130)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ removeSecurityHeader() - —É–¥–∞–ª–µ–Ω–∏–µ (131-150)                                      ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ getSecurityReport() - –æ—Ç—á–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (151-180)                               ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ ‚úÖ –°–ò–°–¢–ï–ú–ê –í–ê–õ–ò–î–ê–¶–ò–ò (—Å—Ç—Ä–æ–∫–∏ 181-350):                                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ registerValidationRules() - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª (181-220)                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ validateInput() - –æ—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (221-260)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ validateEmail() - –≤–∞–ª–∏–¥–∞—Ü–∏—è email (261-280)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ validatePassword() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è (281-310)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ validateFileUpload() - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ (311-340)                                ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ validateJSON() - –ø—Ä–æ–≤–µ—Ä–∫–∞ JSON (341-350)                                         ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üßπ –°–ò–°–¢–ï–ú–ê –°–ê–ù–ò–¢–ò–ó–ê–¶–ò–ò (—Å—Ç—Ä–æ–∫–∏ 351-450):                                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ initializeSanitization() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (351-370)                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ sanitizeInput() - –æ—Å–Ω–æ–≤–Ω–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è (371-400)                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ sanitizeHtml() - –æ—á–∏—Å—Ç–∫–∞ HTML (401-420)                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ sanitizeSQL() - –∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection (421-440)                                ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ sanitizeXSS() - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS (441-450)                                          ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê (—Å—Ç—Ä–æ–∫–∏ 451-500):                                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ logSecurityEvent() - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (451-470)                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getSecurityMetrics() - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ (471-490)                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ generateSecurityReport() - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ (491-500)                            ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ resetMetrics() - —Å–±—Ä–æ—Å –º–µ—Ç—Ä–∏–∫ (501-510)                                          ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîó –≠–ö–°–ü–û–†–¢ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 501-522):                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.SecurityManager —ç–∫—Å–ø–æ—Ä—Ç (501-515)                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (516-520)                                           ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã (521-522)                                                     ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ö–ª–∞—Å—Å: SecurityValidationManager (—Å—Ç—Ä–æ–∫–∞ 9), constructor (9)                      ‚îÇ
‚îÇ    ‚Ä¢ –í–∞–ª–∏–¥–∞—Ü–∏—è: validateInput() (221), validateEmail() (261)                           ‚îÇ
‚îÇ    ‚Ä¢ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è: sanitizeInput() (371), sanitizeHtml() (401)                          ‚îÇ
‚îÇ    ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: setupSecurityHeaders() (46), logSecurityEvent() (451)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

/**
 * HEYS Security & Validation Manager v1.0
 * –ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
 * 
 * @author HEYS Development Team
 * @date 26.08.2025
 */

class SecurityValidationManager {
    constructor(config = {}) {
        this.config = {
            enableStrictMode: true,
            enableLogging: true,
            enableMetrics: true,
            maxInputLength: 10000,
            allowedFileTypes: ['json', 'csv', 'txt'],
            sanitizeHtml: true,
            ...config
        };

        this.securityHeaders = new Map();
        this.validationRules = new Map();
        this.metrics = {
            validationChecks: 0,
            validationFailures: 0,
            securityIncidents: 0,
            sanitizedInputs: 0
        };

        this.isInitialized = false;
        this.initializeSecurityManager();
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
     */
    initializeSecurityManager() {
        console.log('üõ°Ô∏è Initializing Security & Validation Manager...');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        this.setupSecurityHeaders();
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        this.registerValidationRules();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—é
        this.initializeSanitization();
        
        this.isInitialized = true;
        console.log('‚úÖ Security & Validation Manager initialized');
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
     */
    setupSecurityHeaders() {
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ CSP
        this.securityHeaders.set('Content-Security-Policy', 
            "default-src 'self'; " +
            "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; " +
            "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; " +
            "font-src 'self' https://fonts.gstatic.com; " +
            "img-src 'self' data: blob: https:; " +
            "connect-src 'self' https: wss: ws:;"
        );

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        this.securityHeaders.set('X-Content-Type-Options', 'nosniff');
        this.securityHeaders.set('X-Frame-Options', 'DENY');
        this.securityHeaders.set('X-XSS-Protection', '1; mode=block');
        this.securityHeaders.set('Referrer-Policy', 'strict-origin-when-cross-origin');
        this.securityHeaders.set('Permissions-Policy', 
            'geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()'
        );

        console.log('üîí Security headers configured');
    }

    /**
     * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
     */
    applySecurityHeaders() {
        if (typeof document !== 'undefined') {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º meta-—Ç–µ–≥–∏ –¥–ª—è CSP
            const existingCsp = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (!existingCsp) {
                const cspMeta = document.createElement('meta');
                cspMeta.setAttribute('http-equiv', 'Content-Security-Policy');
                cspMeta.setAttribute('content', this.securityHeaders.get('Content-Security-Policy'));
                document.head.appendChild(cspMeta);
            }

            // –î—Ä—É–≥–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —á–µ—Ä–µ–∑ meta-—Ç–µ–≥–∏ (–≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ)
            const xContentType = document.createElement('meta');
            xContentType.setAttribute('http-equiv', 'X-Content-Type-Options');
            xContentType.setAttribute('content', 'nosniff');
            document.head.appendChild(xContentType);

            console.log('üîê Security headers applied to document');
        }

        return this.securityHeaders;
    }

    /**
     * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    registerValidationRules() {
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
        this.addValidationRule('email', (value) => {
            if (!value || typeof value !== 'string') return false;
            
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π regex –¥–ª—è email
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return emailRegex.test(value) && value.length <= 254;
        });

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è URL
        this.addValidationRule('url', (value) => {
            if (!value || typeof value !== 'string') return false;
            
            try {
                const url = new URL(value);
                // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã
                return ['http:', 'https:', 'ftp:', 'ftps:'].includes(url.protocol);
            } catch {
                return false;
            }
        });

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π
        this.addValidationRule('password', (value) => {
            if (!value || typeof value !== 'string') return false;
            
            // –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
            const hasMinLength = value.length >= 8;
            const hasLetter = /[a-zA-Z–∞-—è–ê-–Ø]/.test(value);
            const hasNumber = /\d/.test(value);
            
            return hasMinLength && hasLetter && hasNumber;
        });

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–µ–ª
        this.addValidationRule('number', (value, min = -Infinity, max = Infinity) => {
            const num = parseFloat(value);
            return !isNaN(num) && isFinite(num) && num >= min && num <= max;
        });

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
        this.addValidationRule('text', (value, minLength = 0, maxLength = this.config.maxInputLength) => {
            if (typeof value !== 'string') return false;
            return value.length >= minLength && value.length <= maxLength;
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã
        this.addValidationRule('date', (value) => {
            if (!value) return false;
            const date = new Date(value);
            return date instanceof Date && !isNaN(date.getTime());
        });

        console.log('üìù Validation rules registered');
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    addValidationRule(name, validator) {
        this.validationRules.set(name, validator);
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     * @param {*} value - –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     * @param {string} type - —Ç–∏–ø –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     * @param {...*} args - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
     */
    validateInput(value, type, ...args) {
        this.metrics.validationChecks++;

        try {
            const validator = this.validationRules.get(type);
            if (!validator) {
                console.warn(`‚ö†Ô∏è Unknown validation type: ${type}`);
                return { valid: false, error: `Unknown validation type: ${type}` };
            }

            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ null/undefined
            if (value === null || value === undefined) {
                return { valid: false, error: 'Value cannot be null or undefined' };
            }

            const isValid = validator(value, ...args);
            
            if (!isValid) {
                this.metrics.validationFailures++;
                return { 
                    valid: false, 
                    error: `Validation failed for type: ${type}`,
                    value: this.sanitizeForLogging(value)
                };
            }

            return { valid: true, value };

        } catch (error) {
            this.metrics.validationFailures++;
            console.error(`‚ùå Validation error for type ${type}:`, error);
            
            return { 
                valid: false, 
                error: `Validation error: ${error.message}`,
                value: this.sanitizeForLogging(value)
            };
        }
    }

    /**
     * –ú–∞—Å—Å–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞
     * @param {Object} data - –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
     * @param {Object} schema - —Å—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    validateObject(data, schema) {
        const results = {};
        const errors = [];

        for (const [field, rules] of Object.entries(schema)) {
            const value = data[field];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (rules.required && (value === null || value === undefined || value === '')) {
                errors.push(`Field '${field}' is required`);
                results[field] = { valid: false, error: 'Required field is missing' };
                continue;
            }

            // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏ –ø—É—Å—Ç–æ–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
            if (!rules.required && (value === null || value === undefined || value === '')) {
                results[field] = { valid: true, value };
                continue;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ —Ç–∏–ø—É
            const validationResult = this.validateInput(value, rules.type, ...(rules.args || []));
            results[field] = validationResult;

            if (!validationResult.valid) {
                errors.push(`Field '${field}': ${validationResult.error}`);
            }
        }

        return {
            valid: errors.length === 0,
            results,
            errors
        };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
     */
    initializeSanitization() {
        // –ö–∞—Ä—Ç–∞ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        this.htmlEscapeMap = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#x27;',
            '/': '&#x2F;'
        };

        console.log('üßº Sanitization system initialized');
    }

    /**
     * –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML
     * @param {string} html - HTML —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
     */
    sanitizeHtml(html) {
        if (!this.config.sanitizeHtml || typeof html !== 'string') {
            return html;
        }

        this.metrics.sanitizedInputs++;

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        return html.replace(/[&<>"'\/]/g, (match) => {
            return this.htmlEscapeMap[match];
        });
    }

    /**
     * –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
     */
    sanitizeForLogging(value) {
        if (typeof value !== 'string') {
            return value;
        }

        // –°–ø–∏—Å–æ–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        const sensitivePatterns = [
            /password/i,
            /token/i,
            /secret/i,
            /key/i,
            /auth/i
        ];

        const isSensitive = sensitivePatterns.some(pattern => pattern.test(value));
        
        if (isSensitive || value.length > 50) {
            return '[SANITIZED]';
        }

        return value;
    }

    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
     * @param {File} file - —Ñ–∞–π–ª –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
     */
    validateFile(file) {
        if (!(file instanceof File)) {
            return { valid: false, error: 'Invalid file object' };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 10 –ú–ë)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            return { valid: false, error: 'File size exceeds 10MB limit' };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        const fileExtension = file.name.split('.').pop()?.toLowerCase();
        if (!this.config.allowedFileTypes.includes(fileExtension)) {
            return { 
                valid: false, 
                error: `File type '${fileExtension}' is not allowed. Allowed types: ${this.config.allowedFileTypes.join(', ')}` 
            };
        }

        return { valid: true, file };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ XSS –∞—Ç–∞–∫–∏
     * @param {string} input - –≤—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
     */
    checkXSS(input) {
        if (typeof input !== 'string') {
            return { safe: true };
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –¥–µ—Ç–µ–∫—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        const xssPatterns = [
            /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
            /javascript:/gi,
            /on\w+\s*=/gi,
            /<iframe/gi,
            /<object/gi,
            /<embed/gi,
            /data:text\/html/gi,
            /vbscript:/gi
        ];

        for (const pattern of xssPatterns) {
            if (pattern.test(input)) {
                this.metrics.securityIncidents++;
                return { 
                    safe: false, 
                    threat: 'XSS', 
                    pattern: pattern.source 
                };
            }
        }

        return { safe: true };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ SQL –∏–Ω—ä–µ–∫—Ü–∏–∏
     * @param {string} input - –≤—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
     */
    checkSQLInjection(input) {
        if (typeof input !== 'string') {
            return { safe: true };
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –¥–µ—Ç–µ–∫—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π
        const sqlPatterns = [
            /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION)\b)/gi,
            /(\b(OR|AND)\s+\d+\s*=\s*\d+)/gi,
            /(UNION\s+SELECT)/gi,
            /('|(\\')|(;)|(--)|(\|)|(\*)|(%)|(\+))/gi
        ];

        for (const pattern of sqlPatterns) {
            if (pattern.test(input)) {
                this.metrics.securityIncidents++;
                return { 
                    safe: false, 
                    threat: 'SQL_INJECTION', 
                    pattern: pattern.source 
                };
            }
        }

        return { safe: true };
    }

    /**
     * –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
     * @param {string} input - –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
     */
    securityScan(input) {
        const results = {
            input: this.sanitizeForLogging(input),
            timestamp: Date.now(),
            checks: {}
        };

        // XSS –ø—Ä–æ–≤–µ—Ä–∫–∞
        results.checks.xss = this.checkXSS(input);
        
        // SQL –∏–Ω—ä–µ–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        results.checks.sqlInjection = this.checkSQLInjection(input);

        // –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        const allSafe = Object.values(results.checks).every(check => check.safe);
        
        results.safe = allSafe;
        results.threats = Object.entries(results.checks)
            .filter(([_, check]) => !check.safe)
            .map(([type, check]) => ({ type, threat: check.threat }));

        if (!allSafe) {
            console.warn('üö® Security threats detected:', results.threats);
        }

        return results;
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
     */
    getSecurityMetrics() {
        return {
            ...this.metrics,
            isInitialized: this.isInitialized,
            timestamp: Date.now()
        };
    }

    /**
     * –°–±—Ä–æ—Å –º–µ—Ç—Ä–∏–∫
     */
    resetMetrics() {
        this.metrics = {
            validationChecks: 0,
            validationFailures: 0,
            securityIncidents: 0,
            sanitizedInputs: 0
        };
        
        console.log('üìä Security metrics reset');
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
     */
    exportSecurityConfig() {
        return {
            config: this.config,
            securityHeaders: Object.fromEntries(this.securityHeaders),
            validationRules: Array.from(this.validationRules.keys()),
            metrics: this.getSecurityMetrics()
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
     */
    runIntegrityCheck() {
        console.log('üîç Running security integrity check...');
        
        const checks = {
            securityHeaders: this.securityHeaders.size > 0,
            validationRules: this.validationRules.size > 0,
            sanitization: !!this.htmlEscapeMap,
            initialization: this.isInitialized
        };

        const allPassed = Object.values(checks).every(check => check);
        
        console.log(`${allPassed ? '‚úÖ' : '‚ùå'} Security integrity check ${allPassed ? 'passed' : 'failed'}`);
        
        return {
            passed: allPassed,
            checks,
            timestamp: Date.now()
        };
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HEYS
if (typeof window !== 'undefined') {
    window.SecurityValidationManager = SecurityValidationManager;
    
    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ HEYS namespace
    if (window.HEYS) {
        window.HEYS.SecurityValidationManager = SecurityValidationManager;
        window.HEYS.SecurityManager = SecurityValidationManager; // –ê–ª–∏–∞—Å
        console.log('‚úÖ SecurityValidationManager integrated into HEYS namespace');
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è Node.js
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SecurityValidationManager;
}
