/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_advanced_error_tracker_v1.js (415 —Å—Ç—Ä–æ–∫)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 1-80):                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Namespace –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (6)                                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ CONFIG –æ–±—ä–µ–∫—Ç (8-18)                                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ errorStorage —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (20-27)                                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ userContext –∫–æ–Ω—Ç–µ–∫—Å—Ç (29-37)                                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ generateSessionId() (39-42)                                                      ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ formatTimestamp() (44-48)                                                        ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üõ†Ô∏è –û–°–ù–û–í–ù–´–ï –£–¢–ò–õ–ò–¢–´ (—Å—Ç—Ä–æ–∫–∏ 81-150):                                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getStackTrace() - —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤ (50-70)                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ sanitizeError() - –æ—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫ (71-90)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ classifyError() - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (91-110)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ extractErrorInfo() - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (111-130)                             ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ addUserAction() - –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (131-150)                                ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìä –°–ò–°–¢–ï–ú–ê –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 151-280):                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackJSError() - JS –æ—à–∏–±–∫–∏ (151-180)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackNetworkError() - —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (181-210)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackConsoleError() - –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ (211-240)                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackPerformanceIssue() - –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (241-270)                          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ logError() - –æ—Å–Ω–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (271-280)                                      ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìà –ê–ù–ê–õ–ò–¢–ò–ö–ê –ò –û–¢–ß–ï–¢–´ (—Å—Ç—Ä–æ–∫–∏ 281-350):                                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ generateErrorReport() - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ (281-310)                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getErrorStats() - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ (311-330)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ findSimilarErrors() - –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö (331-340)                                    ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ exportErrorData() - —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (341-350)                                     ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîÑ –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò (—Å—Ç—Ä–æ–∫–∏ 351-400):                                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ saveToStorage() - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage (351-370)                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ loadFromStorage() - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage (371-380)                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ clearOldErrors() - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—à–∏–±–æ–∫ (381-390)                               ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ resetErrorTracker() - —Å–±—Ä–æ—Å —Ç—Ä–µ–∫–µ—Ä–∞ (391-400)                                    ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîó –≠–ö–°–ü–û–†–¢ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 401-415):                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.ErrorTracker —ç–∫—Å–ø–æ—Ä—Ç (401-410)                                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (411-413)                                           ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ Window error handlers (414-415)                                                  ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: CONFIG (8), userContext (29)                                        ‚îÇ
‚îÇ    ‚Ä¢ –¢—Ä–µ–∫–∏–Ω–≥: trackJSError() (151), trackNetworkError() (181)                          ‚îÇ
‚îÇ    ‚Ä¢ –£—Ç–∏–ª–∏—Ç—ã: getStackTrace() (50), sanitizeError() (71)                               ‚îÇ
‚îÇ    ‚Ä¢ –û—Ç—á–µ—Ç—ã: generateErrorReport() (281), getErrorStats() (311)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys_advanced_error_tracker_v1.js - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
;(function(global) {
  'use strict';

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HEYS namespace
  global.HEYS = global.HEYS || {};

  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
  const CONFIG = {
    maxErrorsInMemory: 100,
    maxErrorsInStorage: 500,
    errorRetentionDays: 7,
    autoReport: true,
    logLevel: 'info', // debug, info, warn, error
    enableStackTrace: true,
    enableUserContext: true,
    enablePerformanceMetrics: true
  };

  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—à–∏–±–æ–∫
  let errorStorage = {
    jsErrors: [],
    networkErrors: [],
    consoleErrors: [],
    userActions: [],
    performanceIssues: []
  };

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  let userContext = {
    sessionId: generateSessionId(),
    userAgent: navigator.userAgent,
    startTime: Date.now(),
    pageLoadTime: null,
    lastActions: [],
    currentPage: window.location.href
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —Å–µ—Å—Å–∏–∏
  function generateSessionId() {
    return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏
  function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU') + '.' + date.getMilliseconds().toString().padStart(3, '0');
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–µ–∫–∞ –≤—ã–∑–æ–≤–æ–≤
  function getStackTrace() {
    if (!CONFIG.enableStackTrace) return null;
    
    try {
      throw new Error('Stack trace');
    } catch (e) {
      return e.stack ? e.stack.split('\n').slice(2, 10).join('\n') : null;
    }
  }

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏
  function getErrorSeverity(error, context = {}) {
    const message = error.message || error.toString();
    
    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
    if (message.includes('Uncaught') || 
        message.includes('TypeError') ||
        message.includes('ReferenceError') ||
        context.type === 'unhandledrejection') {
      return 'critical';
    }
    
    // –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
    if (context.type === 'network' || message.includes('fetch')) {
      return 'high';
    }
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if (context.type === 'warning' || message.includes('warn')) {
      return 'medium';
    }
    
    return 'low';
  }

  // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
  function logAdvancedError(error, context = {}) {
    const timestamp = Date.now();
    const severity = getErrorSeverity(error, context);
    
    const errorReport = {
      id: generateErrorId(),
      timestamp: timestamp,
      formattedTime: formatTimestamp(timestamp),
      severity: severity,
      type: context.type || 'javascript',
      message: error.message || error.toString(),
      stack: error.stack || getStackTrace(),
      url: context.url || window.location.href,
      line: context.line || null,
      column: context.column || null,
      userAgent: navigator.userAgent,
      sessionId: userContext.sessionId,
      userContext: CONFIG.enableUserContext ? {
        lastActions: [...userContext.lastActions].slice(-5),
        currentPage: userContext.currentPage,
        sessionDuration: timestamp - userContext.startTime
      } : null,
      additionalData: context.additionalData || {}
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    const storageKey = getStorageKey(context.type || 'javascript');
    if (errorStorage[storageKey]) {
      errorStorage[storageKey].push(errorReport);
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
      if (errorStorage[storageKey].length > CONFIG.maxErrorsInMemory) {
        errorStorage[storageKey].shift();
      }
    }

    // –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
    logToConsole(errorReport);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
    saveErrorToStorage(errorReport);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
    if (CONFIG.autoReport && severity === 'critical') {
      reportErrorAutomatically(errorReport);
    }

    return errorReport;
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –æ—à–∏–±–∫–∏
  function generateErrorId() {
    return 'err_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
  }

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏
  function getStorageKey(type) {
    const mapping = {
      'javascript': 'jsErrors',
      'network': 'networkErrors',
      'console': 'consoleErrors',
      'performance': 'performanceIssues'
    };
    return mapping[type] || 'jsErrors';
  }

  // –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
  function logToConsole(errorReport) {
    const colors = {
      critical: 'color: #ff4757; font-weight: bold;',
      high: 'color: #ff6b35; font-weight: bold;',
      medium: 'color: #f39c12;',
      low: 'color: #7f8c8d;'
    };

    const style = colors[errorReport.severity] || colors.low;
    
    console.group(`%cüö® [${errorReport.severity.toUpperCase()}] ${errorReport.formattedTime}`, style);
    console.log('üìù –°–æ–æ–±—â–µ–Ω–∏–µ:', errorReport.message);
    console.log('üîó URL:', errorReport.url);
    if (errorReport.line) console.log('üìç –ü–æ–∑–∏—Ü–∏—è:', `${errorReport.line}:${errorReport.column}`);
    if (errorReport.stack) console.log('üìö –°—Ç–µ–∫:', errorReport.stack);
    if (errorReport.userContext) console.log('üë§ –ö–æ–Ω—Ç–µ–∫—Å—Ç:', errorReport.userContext);
    console.log('üÜî ID:', errorReport.id);
    console.groupEnd();
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ localStorage
  function saveErrorToStorage(errorReport) {
    try {
      const storageKey = 'heys_error_reports';
      const existingErrors = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –æ—à–∏–±–∫—É
      existingErrors.push({
        ...errorReport,
        // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
        stack: errorReport.stack ? errorReport.stack.slice(0, 500) : null
      });

      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
      const cutoffTime = Date.now() - (CONFIG.errorRetentionDays * 24 * 60 * 60 * 1000);
      const filteredErrors = existingErrors.filter(err => err.timestamp > cutoffTime);

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
      const finalErrors = filteredErrors.slice(-CONFIG.maxErrorsInStorage);

      localStorage.setItem(storageKey, JSON.stringify(finalErrors));
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫—É –≤ localStorage:', e);
    }
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
  function reportErrorAutomatically(errorReport) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    console.warn('üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞:', errorReport.id);
    
    // –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π
    if (global.HEYS && global.HEYS.analytics) {
      global.HEYS.analytics.trackError('CriticalError', {
        errorId: errorReport.id,
        message: errorReport.message,
        severity: errorReport.severity
      });
    }
  }

  // –¢—Ä–µ–∫–∏–Ω–≥ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  function trackUserAction(action, details = {}) {
    if (!CONFIG.enableUserContext) return;

    const actionRecord = {
      timestamp: Date.now(),
      action: action,
      details: details,
      url: window.location.href
    };

    userContext.lastActions.push(actionRecord);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π
    if (userContext.lastActions.length > 20) {
      userContext.lastActions.shift();
    }
  }

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫
  function setupGlobalErrorHandlers() {
    // JavaScript –æ—à–∏–±–∫–∏
    window.addEventListener('error', (event) => {
      logAdvancedError(event.error || new Error(event.message), {
        type: 'javascript',
        url: event.filename,
        line: event.lineno,
        column: event.colno
      });
    });

    // –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ Promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));
      logAdvancedError(error, {
        type: 'unhandledrejection'
      });
    });

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç fetch –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const startTime = performance.now();
      try {
        const response = await originalFetch.apply(this, args);
        
        // –õ–æ–≥–∏—Ä—É–µ–º –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        const duration = performance.now() - startTime;
        if (duration > 3000) { // –ë–æ–ª–µ–µ 3 —Å–µ–∫—É–Ω–¥
          logAdvancedError(new Error('–ú–µ–¥–ª–µ–Ω–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å'), {
            type: 'performance',
            additionalData: {
              url: args[0],
              duration: duration,
              status: response.status
            }
          });
        }

        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ HTTP
        if (!response.ok) {
          logAdvancedError(new Error(`HTTP ${response.status}: ${response.statusText}`), {
            type: 'network',
            additionalData: {
              url: args[0],
              status: response.status,
              statusText: response.statusText
            }
          });
        }

        return response;
      } catch (error) {
        logAdvancedError(error, {
          type: 'network',
          url: args[0],
          additionalData: {
            duration: performance.now() - startTime
          }
        });
        throw error;
      }
    };

    // –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    document.addEventListener('click', (e) => {
      trackUserAction('click', {
        target: e.target.tagName,
        className: e.target.className,
        id: e.target.id
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === 'Escape') {
        trackUserAction('keypress', { key: e.key });
      }
    });
  }

  // API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  const AdvancedErrorTracker = {
    // –†—É—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
    logError: (error, context = {}) => logAdvancedError(error, context),
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
    getAllErrors: () => ({ ...errorStorage }),
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø—É
    getErrorsByType: (type) => errorStorage[getStorageKey(type)] || [],
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
    getCriticalErrors: () => {
      return Object.values(errorStorage)
        .flat()
        .filter(err => err.severity === 'critical')
        .sort((a, b) => b.timestamp - a.timestamp);
    },
    
    // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
    clearErrors: () => {
      errorStorage = {
        jsErrors: [],
        networkErrors: [],
        consoleErrors: [],
        userActions: [],
        performanceIssues: []
      };
      localStorage.removeItem('heys_error_reports');
    },
    
    // –≠–∫—Å–ø–æ—Ä—Ç –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    exportErrors: () => {
      return {
        session: userContext,
        errors: errorStorage,
        config: CONFIG,
        timestamp: Date.now()
      };
    },
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
    getErrorStats: () => {
      const all = Object.values(errorStorage).flat();
      const stats = {
        total: all.length,
        bySeverity: {},
        byType: {},
        recentCount: 0
      };

      // –ü–æ–¥—Å—á–µ—Ç –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
      all.forEach(err => {
        stats.bySeverity[err.severity] = (stats.bySeverity[err.severity] || 0) + 1;
        stats.byType[err.type] = (stats.byType[err.type] || 0) + 1;
        
        // –û—à–∏–±–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
        if (Date.now() - err.timestamp < 3600000) {
          stats.recentCount++;
        }
      });

      return stats;
    },
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    configure: (newConfig) => Object.assign(CONFIG, newConfig),
    
    // –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    trackAction: trackUserAction
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  function initialize() {
    setupGlobalErrorHandlers();
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', () => {
      userContext.pageLoadTime = Date.now() - userContext.startTime;
    });

    console.log('üõ°Ô∏è –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ HEYS –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    console.log('üìä ID —Å–µ—Å—Å–∏–∏:', userContext.sessionId);
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
  global.HEYS.AdvancedErrorTracker = AdvancedErrorTracker;
  global.HEYS.logError = AdvancedErrorTracker.logError;
  
  // –ê–ª–∏–∞—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ç–µ—Å—Ç–∞–º–∏
  global.HEYS.errorTracker = AdvancedErrorTracker;

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }

})(window);
