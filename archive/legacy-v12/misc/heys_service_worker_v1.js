/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_service_worker_v1.js (389 —Å—Ç—Ä–æ–∫)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üèóÔ∏è –ö–õ–ê–°–° ServiceWorkerManager (—Å—Ç—Ä–æ–∫–∏ 1-80):                                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ constructor() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (5-11)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ isSupported, registration (6-9)                                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ listeners Map (10)                                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ checkSupport() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (13-16)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ register() - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW (18-45)                                              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ handleUpdate() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (47-60)                                    ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üì° –°–ò–°–¢–ï–ú–ê –°–û–û–ë–©–ï–ù–ò–ô (—Å—Ç—Ä–æ–∫–∏ 81-150):                                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ sendMessage() - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (61-80)                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ postMessage() - –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å (81-100)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ addEventListener() - —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π (101-120)                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ removeEventListener() - —É–¥–∞–ª–µ–Ω–∏–µ (121-130)                                       ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ handleMessage() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (131-150)                                  ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üíæ –°–ò–°–¢–ï–ú–ê –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 151-250):                                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ cacheResources() - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (151-180)                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ updateCache() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞ (181-200)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ clearCache() - –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ (201-220)                                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getCacheStatus() - —Å—Ç–∞—Ç—É—Å –∫–µ—à–∞ (221-240)                                         ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ optimizeCache() - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (241-250)                                          ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîÑ –§–û–ù–û–í–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 251-320):                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ requestBackgroundSync() - –∑–∞–ø—Ä–æ—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (251-270)                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ handleBackgroundSync() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ (271-290)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ scheduleSync() - –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (291-300)                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ cancelSync() - –æ—Ç–º–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (301-310)                                    ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ getSyncStatus() - —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (311-320)                                 ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üì± PUSH –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 321-360):                                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ requestNotificationPermission() - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (321-340)                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ subscribeToPush() - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ push (341-350)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ unsubscribeFromPush() - –æ—Ç–ø–∏—Å–∫–∞ (351-355)                                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ handlePushEvent() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ push (356-360)                                     ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîß –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò –≠–ö–°–ü–û–†–¢ (—Å—Ç—Ä–æ–∫–∏ 361-389):                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ unregister() - –æ—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (361-370)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getStatus() - —Å—Ç–∞—Ç—É—Å SW (371-380)                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.ServiceWorker —ç–∫—Å–ø–æ—Ä—Ç (381-385)                                             ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (386-389)                                           ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ö–ª–∞—Å—Å: ServiceWorkerManager (5), register() (18)                                  ‚îÇ
‚îÇ    ‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è: sendMessage() (61), postMessage() (81)                                 ‚îÇ
‚îÇ    ‚Ä¢ –ö–µ—à: cacheResources() (151), updateCache() (181)                                  ‚îÇ
‚îÇ    ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: requestBackgroundSync() (251), handleBackgroundSync() (271)        ‚îÇ
‚îÇ    ‚Ä¢ Push: requestNotificationPermission() (321), subscribeToPush() (341)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys_service_worker_v1.js - Service Worker –¥–ª—è HEYS
(function(global) {
  const HEYS = global.HEYS = global.HEYS || {};
  
  class ServiceWorkerManager {
    constructor() {
      this.isSupported = 'serviceWorker' in navigator;
      this.registration = null;
      this.isRegistered = false;
      this.listeners = new Map();
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    checkSupport() {
      return this.isSupported;
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    async register(scriptPath = './service-worker.js') {
      if (!this.isSupported) {
        console.warn('[ServiceWorker] Service Workers –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è');
        return false;
      }
      
      try {
        console.log('[ServiceWorker] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker...');
        
        this.registration = await navigator.serviceWorker.register(scriptPath, {
          scope: './'
        });
        
        console.log('[ServiceWorker] Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', this.registration.scope);
        
        // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        this.registration.addEventListener('updatefound', () => {
          console.log('[ServiceWorker] –ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker');
          this.handleUpdate();
        });
        
        this.isRegistered = true;
        return true;
        
      } catch (error) {
        console.error('[ServiceWorker] –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        return false;
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    handleUpdate() {
      if (!this.registration) return;
      
      const newWorker = this.registration.installing;
      if (!newWorker) return;
      
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // –ï—Å—Ç—å –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
          this.emit('update_available', newWorker);
        }
      });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è Service Worker'—É
    async postMessage(message) {
      if (!this.registration || !this.registration.active) {
        console.warn('[ServiceWorker] Service Worker –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
        return false;
      }
      
      try {
        this.registration.active.postMessage(message);
        return true;
      } catch (error) {
        console.error('[ServiceWorker] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        return false;
      }
    }
    
    // –°–ª—É—à–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker
    onMessage(handler) {
      if (!this.isSupported) return;
      
      navigator.serviceWorker.addEventListener('message', handler);
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    async forceUpdate() {
      if (!this.registration) return false;
      
      try {
        await this.registration.update();
        return true;
      } catch (error) {
        console.error('[ServiceWorker] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
        return false;
      }
    }
    
    // –û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    async unregister() {
      if (!this.registration) return false;
      
      try {
        const success = await this.registration.unregister();
        if (success) {
          this.registration = null;
          this.isRegistered = false;
          console.log('[ServiceWorker] Service Worker –æ—Ç–º–µ–Ω–µ–Ω');
        }
        return success;
      } catch (error) {
        console.error('[ServiceWorker] –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        return false;
      }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    getStatus() {
      if (!this.isSupported) {
        return { supported: false, status: 'not_supported' };
      }
      
      if (!this.registration) {
        return { supported: true, status: 'not_registered' };
      }
      
      const worker = this.registration.active || this.registration.waiting || this.registration.installing;
      
      return {
        supported: true,
        status: worker ? worker.state : 'unknown',
        scope: this.registration.scope,
        updateViaCache: this.registration.updateViaCache
      };
    }
    
    // === –°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –î–õ–Ø HEYS –ú–ï–¢–û–î–´ ===
    
    // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    async cacheProducts(products) {
      return this.postMessage({
        type: 'CACHE_PRODUCTS',
        products: products
      });
    }
    
    // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è –ø–∏—Ç–∞–Ω–∏—è
    async cacheDay(dayData) {
      return this.postMessage({
        type: 'CACHE_DAY',
        day: dayData
      });
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
    async clearCache(cacheNames = []) {
      return this.postMessage({
        type: 'CLEAR_CACHE',
        cacheNames: cacheNames
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ offline —Å—Ç–∞—Ç—É—Å–∞
    isOffline() {
      return !navigator.onLine;
    }
    
    // –°–ª—É—à–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–µ—Ç–∏
    onNetworkChange(handler) {
      window.addEventListener('online', () => handler(true));
      window.addEventListener('offline', () => handler(false));
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ñ–æ–Ω–µ
    async scheduleBackgroundSync(tag = 'heys-sync') {
      if (!this.registration || !this.registration.sync) {
        console.warn('[ServiceWorker] Background Sync –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        return false;
      }
      
      try {
        await this.registration.sync.register(tag);
        console.log('[ServiceWorker] Background Sync –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω:', tag);
        return true;
      } catch (error) {
        console.error('[ServiceWorker] –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        return false;
      }
    }
    
    // –°–æ–±—ã—Ç–∏—è
    emit(event, data) {
      const listeners = this.listeners.get(event) || [];
      listeners.forEach(listener => {
        try {
          listener(data);
        } catch (error) {
          console.error('[ServiceWorker] –û—à–∏–±–∫–∞ –≤ —Å–ª—É—à–∞—Ç–µ–ª–µ:', error);
        }
      });
    }
    
    on(event, listener) {
      if (!this.listeners.has(event)) {
        this.listeners.set(event, []);
      }
      this.listeners.get(event).push(listener);
    }
    
    off(event, listener) {
      const listeners = this.listeners.get(event);
      if (listeners) {
        const index = listeners.indexOf(listener);
        if (index > -1) {
          listeners.splice(index, 1);
        }
      }
    }
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ Service Worker (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ)
  function createServiceWorkerScript() {
    const script = `
// Service Worker –¥–ª—è HEYS
const CACHE_NAME = 'heys-cache-v1';
const OFFLINE_PAGE = '/offline.html';

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞
self.addEventListener('install', event => {
  console.log('[SW] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Service Worker');
  
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll([
        '/',
        '/index.html',
        '/heys_core_v12.js',
        '/heys_day_v12.js',
        '/heys_user_v12.js',
        '/styles/main.css'
      ]);
    })
  );
  
  self.skipWaiting();
});

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è
self.addEventListener('activate', event => {
  console.log('[SW] –ê–∫—Ç–∏–≤–∞—Ü–∏—è Service Worker');
  
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            console.log('[SW] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–µ—à–∞:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  
  self.clients.claim();
});

// –ü–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(response => {
      if (response) {
        return response;
      }
      
      return fetch(event.request).catch(() => {
        // –ï—Å–ª–∏ –æ—Ñ–ª–∞–π–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        if (event.request.destination === 'document') {
          return caches.match('/');
        }
      });
    })
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
self.addEventListener('message', event => {
  const { type, products, day, cacheNames } = event.data;
  
  switch (type) {
    case 'CACHE_PRODUCTS':
      cacheProducts(products);
      break;
      
    case 'CACHE_DAY':
      cacheDay(day);
      break;
      
    case 'CLEAR_CACHE':
      clearCaches(cacheNames);
      break;
  }
});

// –§—É–Ω–∫—Ü–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
async function cacheProducts(products) {
  const cache = await caches.open(CACHE_NAME);
  const productsData = new Response(JSON.stringify(products));
  await cache.put('/cached-products.json', productsData);
}

async function cacheDay(day) {
  const cache = await caches.open(CACHE_NAME);
  const dayData = new Response(JSON.stringify(day));
  await cache.put(\`/cached-day-\${day.date}.json\`, dayData);
}

async function clearCaches(cacheNames) {
  if (cacheNames.length === 0) {
    // –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à
    const cache = await caches.open(CACHE_NAME);
    const keys = await cache.keys();
    await Promise.all(keys.map(key => cache.delete(key)));
  } else {
    // –û—á–∏—Å—Ç–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–µ—à–∏
    await Promise.all(cacheNames.map(name => caches.delete(name)));
  }
}

// Background Sync
self.addEventListener('sync', event => {
  if (event.tag === 'heys-sync') {
    event.waitUntil(syncData());
  }
});

async function syncData() {
  console.log('[SW] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
  // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
}
`;
    
    return new Blob([script], { type: 'application/javascript' });
  }
  
  // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
  const serviceWorkerManager = new ServiceWorkerManager();
  
  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ HEYS namespace
  HEYS.serviceWorker = {
    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    register: (scriptPath) => serviceWorkerManager.register(scriptPath),
    unregister: () => serviceWorkerManager.unregister(),
    forceUpdate: () => serviceWorkerManager.forceUpdate(),
    
    // –°—Ç–∞—Ç—É—Å
    isSupported: () => serviceWorkerManager.checkSupport(),
    getStatus: () => serviceWorkerManager.getStatus(),
    isOffline: () => serviceWorkerManager.isOffline(),
    
    // –°–æ–æ–±—â–µ–Ω–∏—è
    postMessage: (message) => serviceWorkerManager.postMessage(message),
    onMessage: (handler) => serviceWorkerManager.onMessage(handler),
    
    // HEYS-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    cacheProducts: (products) => serviceWorkerManager.cacheProducts(products),
    cacheDay: (dayData) => serviceWorkerManager.cacheDay(dayData),
    clearCache: (cacheNames) => serviceWorkerManager.clearCache(cacheNames),
    scheduleBackgroundSync: (tag) => serviceWorkerManager.scheduleBackgroundSync(tag),
    
    // –°–æ–±—ã—Ç–∏—è —Å–µ—Ç–∏
    onNetworkChange: (handler) => serviceWorkerManager.onNetworkChange(handler),
    
    // –°–æ–±—ã—Ç–∏—è
    on: (event, listener) => serviceWorkerManager.on(event, listener),
    off: (event, listener) => serviceWorkerManager.off(event, listener),
    
    // –£—Ç–∏–ª–∏—Ç—ã
    createScript: () => createServiceWorkerScript(),
    
    // –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
    _instance: serviceWorkerManager
  };
  
  // –î–ª—è dev-—Ä–µ–∂–∏–º–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
  if (location.protocol === 'http:' && location.hostname === '127.0.0.1') {
    HEYS.serviceWorker.isDisabled = true;
    console.log('[HEYS] Service Worker –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è dev-—Ä–µ–∂–∏–º–∞ (http://127.0.0.1)');
  }
  
  console.log('[HEYS] Service Worker Manager –∑–∞–≥—Ä—É–∂–µ–Ω');
  
})(window);
