/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_integration_layer_v1.js (443 —Å—Ç—Ä–æ–∫–∏)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üèóÔ∏è –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° IntegrationLayer (—Å—Ç—Ä–æ–∫–∏ 1-80):                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ constructor() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (5-16)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ capabilities –æ–±—ä–µ–∫—Ç (7-14)                                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ eventBus - —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π (15)                                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ init() - –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (18-30)                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ checkCapabilities() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (32-42)                                 ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ initializeSupported() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (44-50)                                    ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üóÑÔ∏è INDEXEDDB –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 81-180):                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ initIndexedDB() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î (51-80)                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ setupDatabase() - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ö–µ–º—ã (81-110)                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ migrateDatabase() - –º–∏–≥—Ä–∞—Ü–∏–∏ (111-140)                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ getFromDB() - —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (141-160)                                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ saveToDb() - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (161-170)                                                ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ deleteFromDB() - —É–¥–∞–ª–µ–Ω–∏–µ (171-180)                                              ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üë∑ WEB WORKERS –°–ò–°–¢–ï–ú–ê (—Å—Ç—Ä–æ–∫–∏ 181-280):                                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ initWebWorkers() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Ä–∫–µ—Ä–æ–≤ (181-200)                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ createWorker() - —Å–æ–∑–¥–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–∞ (201-220)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ executeInWorker() - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á (221-240)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ terminateWorker() - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (241-250)                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ manageWorkerPool() - –ø—É–ª –≤–æ—Ä–∫–µ—Ä–æ–≤ (251-270)                                      ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ optimizeWorkerUsage() - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (271-280)                                    ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîß SERVICE WORKER –£–ü–†–ê–í–õ–ï–ù–ò–ï (—Å—Ç—Ä–æ–∫–∏ 281-350):                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ initServiceWorker() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SW (281-300)                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ registerServiceWorker() - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (301-320)                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ updateServiceWorker() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (321-330)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ messageServiceWorker() - —Å–æ–æ–±—â–µ–Ω–∏—è (331-340)                                     ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ unregisterServiceWorker() - –æ—Ç–º–µ–Ω–∞ (341-350)                                     ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ ‚ö° WEBASSEMBLY –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 351-400):                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ initWebAssembly() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WASM (351-370)                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ loadWasmModule() - –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è (371-380)                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ executeWasmFunction() - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (381-390)                                     ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ optimizeWasmPerformance() - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (391-400)                                ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üì° –°–ò–°–¢–ï–ú–ê –°–û–ë–´–¢–ò–ô –ò –≠–ö–°–ü–û–†–¢ (—Å—Ç—Ä–æ–∫–∏ 401-443):                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ emit() - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π (401-410)                                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ on() - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è (411-420)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ off() - –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π (421-430)                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.IntegrationLayerV1 —ç–∫—Å–ø–æ—Ä—Ç (431-440)                                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (441-443)                                           ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ö–ª–∞—Å—Å: IntegrationLayer (5), init() (18)                                          ‚îÇ
‚îÇ    ‚Ä¢ IndexedDB: initIndexedDB() (51), setupDatabase() (81)                             ‚îÇ
‚îÇ    ‚Ä¢ Workers: initWebWorkers() (181), createWorker() (201)                             ‚îÇ
‚îÇ    ‚Ä¢ Service Worker: initServiceWorker() (281), registerServiceWorker() (301)          ‚îÇ
‚îÇ    ‚Ä¢ WebAssembly: initWebAssembly() (351), loadWasmModule() (371)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys_integration_layer_v1.js - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
(function(global) {
  const HEYS = global.HEYS = global.HEYS || {};
  
  class IntegrationLayer {
    constructor() {
      this.initialized = false;
      this.capabilities = {
        indexedDB: false,
        webWorkers: false,
        serviceWorker: false,
        webAssembly: false,
        webRTC: false
      };
      
      this.eventBus = new EventTarget();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
    async init() {
      if (this.initialized) return 'ok';
      
      console.log('[Integration] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
      this.checkCapabilities();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
      await this.initializeSupported();
      
      this.initialized = true;
      this.emit('integration_ready', this.capabilities);
      
      console.log('[Integration] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', this.capabilities);
      return 'ok';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
    checkCapabilities() {
      this.capabilities.indexedDB = 'indexedDB' in window;
      this.capabilities.webWorkers = typeof Worker !== 'undefined';
      this.capabilities.serviceWorker = 'serviceWorker' in navigator;
      this.capabilities.webAssembly = typeof WebAssembly !== 'undefined';
      this.capabilities.webRTC = 'RTCPeerConnection' in window;
      
      console.log('[Integration] –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:', this.capabilities);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
    async initializeSupported() {
      const initPromises = [];
      
      // IndexedDB
      if (this.capabilities.indexedDB && HEYS.indexedDB) {
        initPromises.push(
          HEYS.indexedDB.init()
            .then(() => console.log('[Integration] IndexedDB –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'))
            .catch(error => console.error('[Integration] –û—à–∏–±–∫–∞ IndexedDB:', error))
        );
      }
      
      // Web Workers
      if (this.capabilities.webWorkers && HEYS.workers) {
        initPromises.push(
          HEYS.workers.init()
            .then(() => console.log('[Integration] Web Workers –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã'))
            .catch(error => console.error('[Integration] –û—à–∏–±–∫–∞ Web Workers:', error))
        );
      }
      
      // Service Worker
      if (this.capabilities.serviceWorker) {
        initPromises.push(this.initServiceWorker());
      }
      
      await Promise.allSettled(initPromises);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Service Worker
    async initServiceWorker() {
      try {
        const registration = await navigator.serviceWorker.register('/heys-sw.js');
        console.log('[Integration] Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
        
        // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        registration.addEventListener('updatefound', () => {
          this.emit('sw_update_available');
        });
        
        return registration;
      } catch (error) {
        console.error('[Integration] –û—à–∏–±–∫–∞ Service Worker:', error);
        throw error;
      }
    }
    
    // === –í–´–°–û–ö–û–£–†–û–í–ù–ï–í–´–ï –ú–ï–¢–û–î–´ ===
    
    // –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
    async smartSearch(query, options = {}) {
      const searchOptions = {
        useCache: true,
        useWorker: true,
        limit: 20,
        ...options
      };
      
      console.log('[Integration] –£–º–Ω—ã–π –ø–æ–∏—Å–∫:', query);
      
      // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º IndexedDB –∫–µ—à
      if (searchOptions.useCache && this.capabilities.indexedDB) {
        try {
          const cached = await HEYS.indexedDB.searchProducts(query, searchOptions.limit);
          if (cached && cached.length > 0) {
            console.log('[Integration] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –∫–µ—à–∞:', cached.length);
            return {
              source: 'cache',
              results: cached,
              timestamp: Date.now()
            };
          }
        } catch (error) {
          console.warn('[Integration] –û—à–∏–±–∫–∞ –∫–µ—à–∞ –ø–æ–∏—Å–∫–∞:', error);
        }
      }
      
      // 2. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Web Worker
      if (searchOptions.useWorker && this.capabilities.webWorkers) {
        try {
          const results = await HEYS.workers.searchProducts(query, searchOptions);
          console.log('[Integration] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ Worker:', results.length);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
          if (this.capabilities.indexedDB && results.length > 0) {
            await HEYS.indexedDB.saveProducts(results);
          }
          
          return {
            source: 'worker',
            results: results,
            timestamp: Date.now()
          };
        } catch (error) {
          console.warn('[Integration] –û—à–∏–±–∫–∞ Worker –ø–æ–∏—Å–∫–∞:', error);
        }
      }
      
      // 3. Fallback –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø–æ—Ç–æ–∫—É
      console.log('[Integration] Fallback –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø–æ–∏—Å–∫—É');
      return this.fallbackSearch(query, searchOptions);
    }
    
    // –†–∞—Å—á–µ—Ç –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
    async calculateNutrition(products, portions, options = {}) {
      const calcOptions = {
        useWorker: true,
        saveToCache: true,
        ...options
      };
      
      console.log('[Integration] –†–∞—Å—á–µ—Ç –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è', products.length, '–ø—Ä–æ–¥—É–∫—Ç–æ–≤');
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
      const cacheKey = this.generateNutritionCacheKey(products, portions);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
      if (calcOptions.saveToCache && this.capabilities.indexedDB) {
        try {
          const cached = await HEYS.indexedDB.getStatsCache(cacheKey, 60 * 60 * 1000); // 1 —á–∞—Å
          if (cached) {
            console.log('[Integration] –ü–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ –∫–µ—à–∞');
            return cached;
          }
        } catch (error) {
          console.warn('[Integration] –û—à–∏–±–∫–∞ –∫–µ—à–∞ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:', error);
        }
      }
      
      // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç
      let result;
      if (calcOptions.useWorker && this.capabilities.webWorkers) {
        result = await HEYS.workers.calculateNutrition(products, portions);
      } else {
        result = this.fallbackCalculateNutrition(products, portions);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
      if (calcOptions.saveToCache && this.capabilities.indexedDB && result) {
        try {
          await HEYS.indexedDB.saveStatsCache(cacheKey, result, 'nutrition');
        } catch (error) {
          console.warn('[Integration] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–µ—à:', error);
        }
      }
      
      return result;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–Ω—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
    async saveDay(dayData, options = {}) {
      const saveOptions = {
        syncImmediately: false,
        updateCache: true,
        ...options
      };
      
      console.log('[Integration] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–Ω—è:', dayData.date);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ IndexedDB
      if (this.capabilities.indexedDB) {
        await HEYS.indexedDB.saveDay(dayData);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–µ—à–∏
      if (saveOptions.updateCache) {
        await this.invalidateRelatedCaches(dayData.date);
      }
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
      if (saveOptions.syncImmediately && this.capabilities.webWorkers) {
        HEYS.workers.syncData().catch(error => {
          console.warn('[Integration] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        });
      }
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
      this.emit('day_saved', {
        date: dayData.date,
        totalKcal: dayData.totalKcal
      });
      
      return { success: true, timestamp: Date.now() };
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    async generateAnalytics(dateRange, options = {}) {
      const analyticsOptions = {
        useWorker: true,
        useCache: true,
        includeCharts: false,
        includeTrends: true,
        ...options
      };
      
      console.log('[Integration] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', dateRange);
      
      const cacheKey = `analytics_${dateRange.start}_${dateRange.end}_${JSON.stringify(analyticsOptions)}`;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
      if (analyticsOptions.useCache && this.capabilities.indexedDB) {
        try {
          const cached = await HEYS.indexedDB.getStatsCache(cacheKey, 30 * 60 * 1000); // 30 –º–∏–Ω—É—Ç
          if (cached) {
            console.log('[Integration] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–∑ –∫–µ—à–∞');
            return cached;
          }
        } catch (error) {
          console.warn('[Integration] –û—à–∏–±–∫–∞ –∫–µ—à–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
        }
      }
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
      let analytics;
      if (analyticsOptions.useWorker && this.capabilities.webWorkers) {
        analytics = await HEYS.workers.generateAnalytics(dateRange, analyticsOptions);
      } else {
        analytics = await this.fallbackGenerateAnalytics(dateRange, analyticsOptions);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
      if (analyticsOptions.useCache && this.capabilities.indexedDB && analytics) {
        try {
          await HEYS.indexedDB.saveStatsCache(cacheKey, analytics, 'analytics');
        } catch (error) {
          console.warn('[Integration] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
        }
      }
      
      return analytics;
    }
    
    // === –û–§–õ–ê–ô–ù –ü–û–î–î–ï–†–ñ–ö–ê ===
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏
    isOnline() {
      return navigator.onLine;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –æ—Ñ–ª–∞–π–Ω/–æ–Ω–ª–∞–π–Ω
    setupOfflineHandlers() {
      window.addEventListener('online', () => {
        console.log('[Integration] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        this.emit('network_online');
        this.processPendingSync();
      });
      
      window.addEventListener('offline', () => {
        console.log('[Integration] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
        this.emit('network_offline');
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ pending —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    async processPendingSync() {
      if (!this.capabilities.webWorkers) return;
      
      try {
        const result = await HEYS.workers.syncData();
        console.log('[Integration] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', result);
        this.emit('sync_completed', result);
      } catch (error) {
        console.error('[Integration] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        this.emit('sync_failed', error);
      }
    }
    
    // === –£–¢–ò–õ–ò–¢–´ ===
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫–µ—à–∞ –¥–ª—è –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    generateNutritionCacheKey(products, portions) {
      const productIds = products.map(p => p.id).sort().join(',');
      const portionString = portions.join(',');
      return `nutrition_${productIds}_${portionString}`;
    }
    
    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–µ—à–µ–π
    async invalidateRelatedCaches(date) {
      if (!this.capabilities.indexedDB) return;
      
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–µ—à–µ–π
      // –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã
      console.log('[Integration] –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–µ–π –¥–ª—è –¥–∞—Ç—ã:', date);
    }
    
    // Fallback –º–µ—Ç–æ–¥—ã
    fallbackSearch(query, options) {
      // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –±–µ–∑ Worker
      console.log('[Integration] Fallback –ø–æ–∏—Å–∫:', query);
      return Promise.resolve({
        source: 'fallback',
        results: [],
        timestamp: Date.now()
      });
    }
    
    fallbackCalculateNutrition(products, portions) {
      // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –±–µ–∑ Worker
      console.log('[Integration] Fallback —Ä–∞—Å—á–µ—Ç –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏');
      return {
        totalKcal: 0,
        totalProteins: 0,
        totalFats: 0,
        totalCarbs: 0,
        details: []
      };
    }
    
    async fallbackGenerateAnalytics(dateRange, options) {
      // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑ Worker
      console.log('[Integration] Fallback –∞–Ω–∞–ª–∏—Ç–∏–∫–∞');
      return {
        period: dateRange,
        summary: {
          totalDays: 0,
          avgKcal: 0
        }
      };
    }
    
    // Event —Å–∏—Å—Ç–µ–º–∞
    emit(eventName, data) {
      this.eventBus.dispatchEvent(new CustomEvent(eventName, { detail: data }));
    }
    
    on(eventName, callback) {
      this.eventBus.addEventListener(eventName, callback);
    }
    
    off(eventName, callback) {
      this.eventBus.removeEventListener(eventName, callback);
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    getPerformanceStats() {
      return {
        capabilities: this.capabilities,
        initialized: this.initialized,
        online: this.isOnline(),
        indexedDBStats: this.capabilities.indexedDB ? 
          HEYS.indexedDB?.getStats?.() : null,
        workerStats: this.capabilities.webWorkers ? 
          HEYS.workers?.getStats?.() : null
      };
    }
  }
  
  // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
  const integration = new IntegrationLayer();
  
  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ HEYS namespace
  HEYS.integration = {
    init: () => integration.init(),
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    smartSearch: (query, options) => integration.smartSearch(query, options),
    calculateNutrition: (products, portions, options) => integration.calculateNutrition(products, portions, options),
    saveDay: (dayData, options) => integration.saveDay(dayData, options),
    generateAnalytics: (dateRange, options) => integration.generateAnalytics(dateRange, options),
    
    // –°–µ—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    isOnline: () => integration.isOnline(),
    processPendingSync: () => integration.processPendingSync(),
    
    // –°–æ–±—ã—Ç–∏—è
    on: (event, callback) => integration.on(event, callback),
    off: (event, callback) => integration.off(event, callback),
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    getStats: () => integration.getPerformanceStats(),
    
    // –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
    _instance: integration
  };
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      integration.init().catch(error => {
        console.error('[Integration] –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
      });
    });
  } else {
    // –î–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    setTimeout(() => {
      integration.init().catch(error => {
        console.error('[Integration] –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
      });
    }, 100);
  }
  
  console.log('[HEYS] Integration Layer –∑–∞–≥—Ä—É–∂–µ–Ω');
  
  // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  if (typeof window !== 'undefined' && window.HEYS) {
    window.HEYS.IntegrationLayer = integration;
    window.HEYS.IntegrationLayerV1 = integration;
  }
  
})(window);
