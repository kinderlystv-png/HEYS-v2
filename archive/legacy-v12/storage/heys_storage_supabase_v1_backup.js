/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_storage_supabase_v1_backup.js (362 —Å—Ç—Ä–æ–∫–∏)            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 1-30):                                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ë–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: client, status, user, muteMirror (9-15)                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: log(), err() (17-18)                                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: tryParse() (20)                                                ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 31-80):                                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ signIn() - –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (31-50)                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ signOut() - –≤—ã—Ö–æ–¥ –∏ –æ—á–∏—Å—Ç–∫–∞ (51-70)                                              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (71-80)                                          ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üíæ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• (—Å—Ç—Ä–æ–∫–∏ 81-200):                                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ syncUp() - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (81-120)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ syncDown() - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ (121-160)                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ mirror() - –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ localStorage (161-180)                                 ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö (181-200)                                            ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üóÑÔ∏è –û–ü–ï–†–ê–¶–ò–ò –° –•–†–ê–ù–ò–õ–ò–©–ï–ú (—Å—Ç—Ä–æ–∫–∏ 201-300):                                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kv.set() - –∑–∞–ø–∏—Å—å –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ (201-230)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kv.get() - —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (231-260)                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kv.clear() - –æ—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (261-280)                                         ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ (281-300)                                                         ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ ‚ö° –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (—Å—Ç—Ä–æ–∫–∏ 301-362):                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ localStorage –ø–µ—Ä–µ—Ö–≤–∞—Ç (301-330)                                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫–∞ (331-350)                                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (351-362)                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys_storage_supabase_v1.js ‚Äî Supabase bridge (v8, reports-ready)
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
//  ‚Ä¢ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º localStorage.setItem –∏ –∑–µ—Ä–∫–∞–ª–∏–º –Ω–µ —Ç–æ–ª—å–∫–æ 'heys_*', –Ω–æ –∏ –∫–ª—é—á–∏ –¥–Ω–µ–π: 'day*' (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞);
//  ‚Ä¢ –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ —á–∏—Å—Ç–∏–º –∏ 'heys_*', –∏ 'day*' ‚Äî –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –Ω–µ —É–≤–∏–¥–∏—Ç —á—É–∂–∏–µ –¥–Ω–∏;
//  ‚Ä¢ –≤–æ –≤—Ä–µ–º—è sync/clear –æ—Ç–∫–ª—é—á–∞–µ–º –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (muteMirror), —á—Ç–æ–±—ã –Ω–µ –≥–æ–Ω—è—Ç—å ¬´—ç—Ö–æ¬ª.
;(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const cloud = HEYS.cloud = HEYS.cloud || {};

  let client = null;
  cloud.client = null;
  let status = 'offline'; // offline | signin | sync | online
  let user = null;
  let muteMirror = false;

  function log(){ try{ console.log.apply(console, ['[HEYS.cloud]'].concat([].slice.call(arguments))); }catch(e){} }
  function err(){ try{ console.error.apply(console, ['[HEYS.cloud:ERR]'].concat([].slice.call(arguments))); }catch(e){} }

  function tryParse(v){ try{return JSON.parse(v);}catch(e){ return v; } }

  // –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –º—ã –∑–µ—Ä–∫–∞–ª–∏–º / —á–∏—Å—Ç–∏–º
  function isOurKey(k){
    if (typeof k !== 'string') return false;
    if (k.indexOf('heys_') === 0) return true;
    // —Ç–∞–∫–∂–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª—é—á–∏ –¥–Ω–µ–π
    const lower = k.toLowerCase();
    if (lower.indexOf('day') >= 0) return true;
    return false;
  }

  function clearNamespace(clientId){
    try{
      const ls = global.localStorage;
      for (let i = ls.length - 1; i >= 0; i--) {
        const k = ls.key(i);
        if (!k) continue;
        const lower = k.toLowerCase();
        if (clientId) {
          // clear only client-specific keys
          if (lower.indexOf(('heys_' + clientId + '_').toLowerCase()) === 0) { ls.removeItem(k); continue; }
          if (lower.indexOf(('day_' + clientId + '_').toLowerCase()) === 0) { ls.removeItem(k); continue; }
        } else {
          // clear all
          if (isOurKey(k)) ls.removeItem(k);
        }
      }
      log('local heys_*/day* cleared', clientId ? ('for client '+clientId) : 'all');
    }catch(e){ err('clearNamespace', e); }
  }

  // intercept localStorage.setItem (–∑–µ—Ä–∫–∞–ª–∏–º –Ω–∞—à–∏ –∫–ª—é—á–∏)
  let originalSetItem = null;
  function interceptSetItem(){
    try{
      if (originalSetItem) return;
      originalSetItem = global.localStorage.setItem.bind(global.localStorage);
      global.localStorage.setItem = function(k, v){
        originalSetItem(k, v);
        if (!muteMirror && isOurKey(k)){
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –≤ client_kv_store
          const needsClientStorage = (
            (k && k.includes('dayv2_')) ||  // –¥–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            (k === 'heys_profile') ||       // –ø—Ä–æ—Ñ–∏–ª—å
            (k === 'heys_hr_zones') ||      // –∑–æ–Ω—ã –ø—É–ª—å—Å–∞  
            (k === 'heys_norms') ||         // –Ω–æ—Ä–º—ã
            (k === 'heys_products')         // –ø—Ä–æ–¥—É–∫—Ç—ã
          );
          
          if (needsClientStorage && window.HEYS && window.HEYS.currentClientId) {
            console.log('[DEBUG] localStorage –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ client_kv_store:', k);
            cloud.saveClientKey(k, tryParse(v));
          } else {
            cloud.saveKey(k, tryParse(v));
          }
        }
      };
      log('localStorage.setItem intercepted');
    }catch(e){ err('intercept setItem failed', e); }
  }

  cloud.init = function({ url, anonKey }){
    if (!global.supabase || !global.supabase.createClient){
      err('supabase-js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      return;
    }
    try{
      client = global.supabase.createClient(url, anonKey);
      cloud.client = client;
      status = 'offline';
      interceptSetItem();
      log('cloud bridge loaded');
    }catch(e){ err('init failed', e); }
  };

  cloud.signIn = async function(email, password){
    if (!client) { err('client not initialized'); return; }
    try{
      status = 'signin';
      const { data, error } = await client.auth.signInWithPassword({ email, password });
      if (error) { status = 'offline'; err('signIn failed', error); return { error }; }
      user = data.user;
      if (!user) { status = 'offline'; err('no user after signin'); return { error: 'no user' }; }
      status = 'sync';
      await cloud.bootstrapSync();
      status = 'online';
      log('signIn ok, user=', user.email);
      return { user };
    }catch(e){
      status = 'offline';
      err('signIn exception', e);
      return { error: e };
    }
  };

  cloud.signOut = function(){
    if (client) client.auth.signOut();
    user = null;
    status = 'offline';
    clearNamespace();
    log('signOut ok');
  };

  cloud.getUser = function(){ return user; };
  cloud.getStatus = function(){ return status; };

  cloud.bootstrapSync = async function(){
    try{
      muteMirror = true;
      if (!client || !user) return;
      const { data, error } = await client.from('kv_store').select('k,v,updated_at');
      if (error) { err('bootstrap select', error); return; }
      const ls = global.localStorage;
      // clear only global keys for full bootstrap (no clientId)
      clearNamespace();
      (data||[]).forEach(row => {
        try {
          const key = row.k;
          ls.setItem(key, JSON.stringify(row.v));
        } catch(e){}
      });
      muteMirror = false;
      log('bootstrap synced keys:', (data||[]).length);
    }catch(e){ err('bootstrap exception', e); muteMirror=false; }
  };

  cloud.bootstrapClientSync = async function(client_id){
    if (!client || !user || !client_id) return;
    const now = Date.now();
    if (cloud._lastClientSync && cloud._lastClientSync.clientId === client_id && (now - cloud._lastClientSync.ts) < 4000){
      log('client bootstrap skipped (throttled)', client_id);
      return;
    }
    try{
      const { data, error } = await client.from('client_kv_store').select('k,v,updated_at').eq('client_id', client_id);
      if (error) { err('client bootstrap select', error); return; }
      const ls = global.localStorage;
  muteMirror = true;
  // clear only keys that belong to the requested client to avoid wiping other clients' data
  clearNamespace(client_id);
      (data||[]).forEach(row => {
        try {
          // row.k is stored in DB as the original key; when using client-scoped storage,
          // DB should contain keys already scoped for the client (heys_<cid>_... or day_<cid>_...)
          const key = row.k;
          // –ö–æ–Ω—Ñ–ª–∏–∫—Ç: –µ—Å–ª–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –µ—Å—Ç—å —Ä–µ–≤–∏–∑–∏—è, —Å—Ä–∞–≤–Ω–∏—Ç—å –∏ –≤–∑—è—Ç—å –±–æ–ª–µ–µ —Å–≤–µ–∂—É—é
          let local = null;
          try { local = JSON.parse(ls.getItem(key)); } catch(e){}
          let remoteRev = row.v && row.v.revision ? row.v.revision : 0;
          let localRev = local && local.revision ? local.revision : 0;
          if (localRev > remoteRev) {
            // –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –Ω–æ–≤–µ–µ ‚Äî –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º
            log('conflict: keep local', key);
            return;
          }
          ls.setItem(key, JSON.stringify(row.v));
          
          // DEBUG: –ª–æ–≥–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏–∑ –æ–±–ª–∞–∫–∞
          if (key && key.includes('dayv2_') && row.v && row.v.trainings) {
            console.log('[DEBUG] bootstrapClientSync: –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞ –¥–ª—è –∫–ª—é—á–∞:', key);
            console.log('[DEBUG] bootstrapClientSync: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', JSON.stringify(row.v.trainings));
          }
        } catch(e){}
      });
      muteMirror = false;
      log('client bootstrap synced keys:', (data||[]).length);
      cloud._lastClientSync = { clientId: client_id, ts: now };
    }catch(e){ err('client bootstrap exception', e); muteMirror=false; }
  };

  cloud.shouldSyncClient = function(client_id, maxAgeMs){
    if (!client_id) return false;
    const rec = cloud._lastClientSync;
    if (!rec || rec.clientId !== client_id) return true;
    return (Date.now() - rec.ts) > (maxAgeMs||4000);
  };

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (client_kv_store).
  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—É—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É saveClientKey(k, v) ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ client_id –±–µ—Ä—ë—Ç—Å—è –∏–∑ HEYS.currentClientId.
      cloud.saveClientKey = function(...args) {
        console.log('[DEBUG] cloud.saveClientKey –í–´–ó–í–ê–ù —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏:', args.length, args);
        
        let client_id, k, value;

        if (args.length === 3) {
            client_id = args[0];
            k = args[1];
            value = args[2];
        } else if (args.length === 2) {
            console.log('[DEBUG] cloud.saveClientKey: 2 –∞—Ä–≥—É–º–µ–Ω—Ç–∞, –ø–æ–ª—É—á–∞–µ–º client_id –∏–∑ HEYS.getCurrentClientId()');
            k = args[0];
            value = args[1];
            
            // –ï—Å–ª–∏ –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç client_id –≤ —Ñ–æ—Ä–º–∞—Ç–µ heys_clientId_dayv2_... - –∏–∑–≤–ª–µ–∫–∞–µ–º –µ–≥–æ
            if (k && k.startsWith('heys_') && k.includes('_dayv2_')) {
                const parts = k.split('_');
                if (parts.length >= 3) {
                    client_id = parts[1]; // –±–µ—Ä–µ–º client_id –∏–∑ –∫–ª—é—á–∞
                    console.log('[DEBUG] cloud.saveClientKey: –∏–∑–≤–ª–µ–∫–ª–∏ client_id –∏–∑ –∫–ª—é—á–∞:', client_id);
                }
            }
            
            // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–ª—é—á–µ–π (heys_profile, heys_products –∏ —Ç.–¥.) –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            if (!client_id && window.HEYS && window.HEYS.currentClientId) {
                client_id = window.HEYS.currentClientId;
                console.log('[DEBUG] cloud.saveClientKey: –∏—Å–ø–æ–ª—å–∑—É–µ–º currentClientId:', client_id);
            }
            
            console.log('[DEBUG] cloud.saveClientKey: client_id =', client_id, 'typeof HEYS.getCurrentClientId =', typeof HEYS.getCurrentClientId);
        } else {
            console.log('[DEBUG] cloud.saveClientKey: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –∑–∞–≤–µ—Ä—à–∞–µ–º');
            return;
        }

        if (!client_id) {
            console.log('[DEBUG] cloud.saveClientKey: –ù–ï–¢ client_id, –∑–∞–≤–µ—Ä—à–∞–µ–º');
            return;
        }
        
        console.log('[DEBUG] cloud.saveClientKey: –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏, client_id =', client_id, 'k =', k, 'value type =', typeof value);
        
        // DEBUG: —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —É—Ö–æ–¥–∏—Ç –≤ –æ–±–ª–∞–∫–æ
        console.log('[DEBUG] cloud.saveClientKey: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø value =', typeof value, 'value =', value);

        // –î–ª—è –¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª—é–±—ã–µ —Ç–∏–ø—ã
        if (k && k.includes('dayv2_')) {
            if (typeof value !== 'object' || value === null) {
                console.log('[DEBUG] cloud.saveClientKey: –û–¢–ö–õ–û–ù–ï–ù–û - –¥–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º');
                return;
            }
        } else {
            // –î–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π, –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ —Ç.–¥. —Ä–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±—ã–µ —Ç–∏–ø—ã
            console.log('[DEBUG] cloud.saveClientKey: –∫–ª—é—á –Ω–µ dayv2_, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞');
        }

        // DEBUG: –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–æ
        if (k && k.includes('dayv2_')) {
            console.log('[DEBUG] cloud.saveClientKey: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ–Ω—å –≤ –æ–±–ª–∞–∫–æ –¥–ª—è –∫–ª—é—á–∞:', k);
            console.log('[DEBUG] cloud.saveClientKey: –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–Ω—è:', JSON.stringify(value));
            if (value && value.trainings) {
                console.log('[DEBUG] cloud.saveClientKey: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞–π–¥–µ–Ω—ã:', JSON.stringify(value.trainings));
            } else {
                console.log('[DEBUG] cloud.saveClientKey: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ù–ï –Ω–∞–π–¥–µ–Ω—ã –≤ –æ–±—ä–µ–∫—Ç–µ, –ø–æ–ª—è –æ–±—ä–µ–∫—Ç–∞:', Object.keys(value || {}));
            }
        } else {
            console.log('[DEBUG] cloud.saveClientKey: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ –∫–ª—é—á:', k, '—Ç–∏–ø value:', typeof value);
        }

        const upsertObj = {
            client_id: client_id,
            k: k,
            v: value,
            updated_at: (new Date()).toISOString(),
        };

        cloud.upsert('client_kv_store', upsertObj, 'client_id,k')
            .then(() => {
                console.log('[DEBUG] cloud.saveClientKey: –£–°–ü–ï–®–ù–û –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ client_kv_store:', k);
                log('[HEYS.cloud] client upsert ok: ' + k);
            })
            .catch(err => {
                console.log('[DEBUG] cloud.saveClientKey: –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ client_kv_store:', err);
                err('client upsert error', err);
            });
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ client_kv_store
    cloud.upsert = async function(tableName, obj, conflictKey) {
        if (!client || !user) {
            console.log('[DEBUG] cloud.upsert: –ù–ï–¢ client –∏–ª–∏ user');
            throw new Error('Client or user not available');
        }
        
        console.log('[DEBUG] cloud.upsert: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É', tableName, '–æ–±—ä–µ–∫—Ç:', obj);
        
        try {
            const { error } = await client
                .from(tableName)
                .upsert(obj, { onConflict: 'client_id,k' });
            
            if (error) {
                console.log('[DEBUG] cloud.upsert: –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤', tableName, error);
                throw error;
            } else {
                console.log('[DEBUG] cloud.upsert: –£–°–ü–ï–®–ù–û –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤', tableName);
                return { success: true };
            }
        } catch (e) {
            console.log('[DEBUG] cloud.upsert: –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤', tableName, e);
            throw e;
        }
    };

  // –æ—á–µ—Ä–µ–¥—å upsert'–æ–≤
  let upsertQueue = [];
  let upsertTimer = null;
  function schedulePush(){
    if (upsertTimer) return;
    upsertTimer = setTimeout(async () => {
      const batch = upsertQueue.splice(0, upsertQueue.length);
      upsertTimer = null;
      if (!client || !user || !batch.length) return;
      try{
        const { error } = await client.from('kv_store').upsert(batch, { onConflict: 'k' });
        if (error) { err('bulk upsert', error); return; }
        batch.forEach(item => log('upsert ok: ' + item.k));
      }catch(e){ err('bulk upsert exception', e); }
    }, 300);
  }

  cloud.saveKey = function(k, v){
    if (!user || !k) return;
    const upsertObj = {
      k: k,
      v: v,
      updated_at: (new Date()).toISOString(),
    };
    console.log('[DEBUG][cloud.saveKey] –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª—é—á:', k, '—Ç–∏–ø value:', typeof v);
    upsertQueue.push(upsertObj);
    schedulePush();
  };

  cloud.deleteKey = function(k){
    // –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ .delete(), –∏–ª–∏ —Å—Ç–∞–≤–∏—Ç—å –ø–æ–º–µ—Ç–∫—É
  };

  cloud.clearAll = function(){
    clearNamespace();
  };

  // —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  cloud.lsGet = typeof global.HEYS !== 'undefined' && global.HEYS.lsGet
    ? global.HEYS.lsGet
    : function(k, def){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }catch(e){ return def; } };

  cloud.lsSet = typeof global.HEYS !== 'undefined' && global.HEYS.lsSet
    ? global.HEYS.lsSet
    : function(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} };

  log('utils lsSet wrapped');

})(window);
