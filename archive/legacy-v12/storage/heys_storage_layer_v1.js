/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—ºï¸ ĞĞĞ’Ğ˜Ğ“ĞĞ¦Ğ˜ĞĞĞĞĞ¯ ĞšĞĞ Ğ¢Ğ Ğ¤ĞĞ™Ğ›Ğ heys_storage_layer_v1.js (164 ÑÑ‚Ñ€Ğ¾ĞºĞ¸)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ Ğ¤ĞĞ™Ğ›Ğ:                                                                       â”‚
â”‚                                                                                           â”‚
â”‚ ğŸ”§ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 1-20):                                                          â”‚
â”‚    â”œâ”€â”€ Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ: memory Map, watchers Map (6-7)                            â”‚
â”‚    â””â”€â”€ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Store Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° (5)                                                      â”‚
â”‚                                                                                           â”‚
â”‚ ğŸ“¦ Ğ¡Ğ–ĞĞ¢Ğ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥ (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 21-50):                                                         â”‚
â”‚    â”œâ”€â”€ compress() - ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ² (9-25)                                              â”‚
â”‚    â””â”€â”€ decompress() - Ñ€Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (26-50)                                         â”‚
â”‚                                                                                           â”‚
â”‚ ğŸ’¾ ĞĞŸĞ•Ğ ĞĞ¦Ğ˜Ğ˜ Ğ¥Ğ ĞĞĞ•ĞĞ˜Ğ¯ (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 51-100):                                                    â”‚
â”‚    â”œâ”€â”€ Store.set() - ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (51-70)                                          â”‚
â”‚    â”œâ”€â”€ Store.get() - Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (71-85)                                           â”‚
â”‚    â”œâ”€â”€ Store.remove() - ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ»ÑÑ‡ĞµĞ¹ (86-95)                                         â”‚
â”‚    â””â”€â”€ Store.clear() - Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ° (96-100)                                       â”‚
â”‚                                                                                           â”‚
â”‚ ğŸ”” Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞĞš (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 101-140):                                                    â”‚
â”‚    â”œâ”€â”€ Store.watch() - Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ (101-120)                                  â”‚
â”‚    â”œâ”€â”€ Store.unwatch() - Ğ¾Ñ‚Ğ¿Ğ¸ÑĞºĞ° Ğ¾Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ (121-130)                                 â”‚
â”‚    â””â”€â”€ notifyWatchers() - ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ² (131-140)                             â”‚
â”‚                                                                                           â”‚
â”‚ ğŸ“Š Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« Ğ˜ Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢ (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 141-164):                                                   â”‚
â”‚    â”œâ”€â”€ Store.keys() - ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ»ÑÑ‡ĞµĞ¹ (141-150)                                           â”‚
â”‚    â”œâ”€â”€ Store.size() - Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ° (151-160)                                        â”‚
â”‚    â””â”€â”€ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° (161-164)                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
*/

// heys_storage_layer_v1.js â€” Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ğ¹ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ + ĞºÑÑˆ (v1)
;(function(global){
  const HEYS = global.HEYS = global.HEYS || {};
  const Store = HEYS.store = HEYS.store || {};

  const memory = new Map();
  const watchers = new Map(); // key -> Set<fn>

  // ---------- Ğ¡Ğ¶Ğ°Ñ‚Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ----------
  function compress(obj) {
    try {
      const json = JSON.stringify(obj);
      
      // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğµ ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ: ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑÑ‰Ğ¸ĞµÑÑ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
      let compressed = json
        .replace(/":"/g, '":"')
        .replace(/","/g, '","')
        .replace(/{""/g, '{"')
        .replace(/"}/g, '"}');
      
      // Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ°ÑÑ‰Ğ¸Ñ…ÑÑ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ² Ğ½Ğ° ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ ĞºĞ¾Ğ´Ñ‹
      const patterns = {
        '"name":"': 'Â¤nÂ¤',
        '"kcal100"': 'Â¤kÂ¤',
        '"protein100"': 'Â¤pÂ¤',
        '"carbs100"': 'Â¤cÂ¤',
        '"fat100"': 'Â¤fÂ¤',
        '"simple100"': 'Â¤sÂ¤',
        '"complex100"': 'Â¤xÂ¤',
        '"badFat100"': 'Â¤bÂ¤',
        '"goodFat100"': 'Â¤gÂ¤',
        '"trans100"': 'Â¤tÂ¤',
        '"fiber100"': 'Â¤iÂ¤',
        '"gi"': 'Â¤GÂ¤',
        '"harmScore"': 'Â¤hÂ¤'
      };
      
      for (const [pattern, code] of Object.entries(patterns)) {
        compressed = compressed.split(pattern).join(code);
      }
      
      // Ğ•ÑĞ»Ğ¸ ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ Ğ´Ğ°ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ¾Ğ¼
      if (compressed.length < json.length * 0.9) {
        return 'Â¤ZÂ¤' + compressed;
      }
      
      return json;
    } catch (e) {
      return JSON.stringify(obj);
    }
  }
  
  function decompress(str) {
    try {
      if (!str.startsWith('Â¤ZÂ¤')) {
        return JSON.parse(str);
      }
      
      let compressed = str.substring(3);
      
      // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²
      const patterns = {
        'Â¤nÂ¤': '"name":"',
        'Â¤kÂ¤': '"kcal100"',
        'Â¤pÂ¤': '"protein100"',
        'Â¤cÂ¤': '"carbs100"',
        'Â¤fÂ¤': '"fat100"',
        'Â¤sÂ¤': '"simple100"',
        'Â¤xÂ¤': '"complex100"',
        'Â¤bÂ¤': '"badFat100"',
        'Â¤gÂ¤': '"goodFat100"',
        'Â¤tÂ¤': '"trans100"',
        'Â¤iÂ¤': '"fiber100"',
        'Â¤GÂ¤': '"gi"',
        'Â¤hÂ¤': '"harmScore"'
      };
      
      for (const [code, pattern] of Object.entries(patterns)) {
        compressed = compressed.split(code).join(pattern);
      }
      
      return JSON.parse(compressed);
    } catch (e) {
      return JSON.parse(str);
    }
  }

  function rawGet(k, d){ 
    try{ 
      const v = localStorage.getItem(k); 
      return v ? decompress(v) : d; 
    } catch(e) { 
      return d; 
    } 
  }
  
  function rawSet(k, v){ 
    try{ 
      localStorage.setItem(k, compress(v)); 
    } catch(e) {} 
  }

  function ns(){ return (global.HEYS && global.HEYS.currentClientId) || ''; }
  function scoped(k){ const cid=ns(); if(!cid) return k; if(/^heys_(clients|client_current)$/i.test(k)) return k;
    // ĞšĞ»ÑÑ‡ `k` Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ 'dayv2_2025-01-01' Ğ¸Ğ»Ğ¸ 'heys_dayv2_date'.
    // ĞœÑ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ client_id Ğ¿Ğ¾ÑĞ»Ğµ 'heys_'.
    if (k.startsWith('heys_')) {
        return 'heys_' + cid + '_' + k.substring('heys_'.length);
    }
    // Ğ”Ğ»Ñ ĞºĞ»ÑÑ‡ĞµĞ¹, Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ñ…ÑÑ Ñ 'heys_', Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ.
    return `heys_${cid}_${k}`;
  }

  Store.get = function(k, def){ const sk=scoped(k); if(memory.has(sk)) return memory.get(sk); const v=rawGet(sk, def); memory.set(sk,v); return v; };
  // If scoped key not present, try unscoped legacy key and migrate it into scoped namespace
  Store.get = (function(orig){
    return function(k, def){
      const sk = scoped(k);
      if (memory.has(sk)) return memory.get(sk);
      let v = rawGet(sk, undefined);
      if (v === undefined || v === null) {
        // try legacy unscoped key
        try{
          const legacy = rawGet(k, undefined);
          if (legacy !== undefined && legacy !== null){
            // migrate to scoped key for future reads/writes
            memory.set(sk, legacy);
            rawSet(sk, legacy);
            return legacy;
          }
        }catch(e){}
        // return default
        v = def;
      }
      memory.set(sk, v);
      return v;
    };
  })(Store.get);
  Store.set = function(k, v){
    const sk=scoped(k);
    memory.set(sk,v);
    rawSet(sk,v);
    if(watchers.has(sk)) watchers.get(sk).forEach(fn=>{ try{ fn(v); }catch(e){} });
    try{
      if(global.HEYS && typeof global.HEYS.saveClientKey==='function'){
        const cid=ns();
        if(cid) {
          // Always pass the original key (not scoped) to saveClientKey
          // And remove the 'heys_' prefix if it exists, to keep DB keys clean.
          const keyForCloud = k.startsWith('heys_') ? k.substring('heys_'.length) : k;
          // ĞĞµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾ ĞµÑĞ»Ğ¸ v Ğ½Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ÑÑ‚Ñ€Ğ¾ĞºĞ° ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ ĞºĞ»ÑÑ‡Ğ¾Ğ¼)
          if (typeof v !== 'object' || v === null) return;
          global.HEYS.saveClientKey(cid, keyForCloud, v);
        }
      }
    }catch(e){}
  };

  Store.watch = function(k, fn){ const sk=scoped(k); if(!watchers.has(sk)) watchers.set(sk,new Set()); watchers.get(sk).add(fn); return ()=>{ const set=watchers.get(sk); if(set){ set.delete(fn); if(!set.size) watchers.delete(sk); } }; };

  Store.flushMemory = function(){ memory.clear(); };

})(window);
