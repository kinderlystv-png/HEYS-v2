<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HEYS Nutrition Tracker - Production</title>

    <!-- Critical CSS for instant rendering -->
    <link rel="stylesheet" href="styles/critical.css" />

    <!-- HTTP/2 + Resource hints for optimal performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin />
    <link rel="dns-prefetch" href="https://unpkg.com" />

    <!-- HTTP/2 Server Push hints -->
    <link
      rel="preload"
      href="https://unpkg.com/react@18/umd/react.development.js"
      as="script"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      as="script"
      crossorigin="anonymous"
    />

    <!-- Critical resource preloading with priority hints -->
    <link rel="preload" href="heys_core_v12.js" as="script" fetchpriority="high" />
    <link rel="preload" href="heys_simple_analytics.js" as="script" fetchpriority="high" />

    <!-- Resource hints for better caching -->
    <link rel="prefetch" href="heys_storage_supabase_v1.js" />
    <link rel="prefetch" href="heys_models_v1.js" />

    <!-- Load non-critical CSS asynchronously -->
    <link
      rel="preload"
      href="styles/main.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript><link rel="stylesheet" href="styles/main.css" /></noscript>
  </head>
  <body>
    <div id="root"></div>

    <!-- libs with defer and priority for optimal loading -->
    <script
      defer
      src="https://unpkg.com/react@18/umd/react.development.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"
      fetchpriority="low"
      crossorigin="anonymous"
    ></script>

    <!-- app modules with defer and optimized priority -->
    <script defer src="heys_dev_utils.js" fetchpriority="high"></script>
    <script defer src="heys_simple_analytics.js" fetchpriority="high"></script>
    <script defer src="heys_core_v12.js" fetchpriority="high"></script>
    <script defer src="heys_storage_supabase_v1.js?v=15" fetchpriority="low"></script>
    <script defer src="heys_models_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_storage_layer_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_day_v12.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_user_v12.js" fetchpriority="low"></script>
    <script defer src="heys_reports_v12.js" fetchpriority="low"></script>

    <script>
      /*
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ðŸ—ºï¸ ÐÐÐ’Ð˜Ð“ÐÐ¦Ð˜ÐžÐÐÐÐ¯ ÐšÐÐ Ð¢Ð index.html (1170 ÑÑ‚Ñ€Ð¾Ðº)                                â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ ðŸ“‹ Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð Ð¤ÐÐ™Ð›Ð:                                                            â”‚
      â”‚                                                                                â”‚
      â”‚ 1ï¸âƒ£  Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 82-139)                                             â”‚
      â”‚    â”œâ”€â”€ Service Worker setup (Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½)                                        â”‚
      â”‚    â”œâ”€â”€ initializeApp() - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ React Ð¸ HEYS ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²          â”‚
      â”‚    â””â”€â”€ Supabase config initialization                                         â”‚
      â”‚                                                                                â”‚
      â”‚ 2ï¸âƒ£  ÐžÐ‘Ð›ÐÐ§ÐÐ«Ð• ÐžÐ‘ÐÐ Ð¢ÐšÐ˜ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢ÐžÐ’ (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 140-290)                             â”‚
      â”‚    â”œâ”€â”€ ðŸ“… DayTabWithCloudSync (142-181) - ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð´Ð½Ñ + ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ     â”‚
      â”‚    â”œâ”€â”€ ðŸ½ï¸ RationTabWithCloudSync (185-227) - Ñ€Ð°Ñ†Ð¸Ð¾Ð½ + ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ         â”‚
      â”‚    â””â”€â”€ ðŸ‘¤ UserTabWithCloudSync (230-266) - Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ + ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ           â”‚
      â”‚                                                                                â”‚
      â”‚ 3ï¸âƒ£  ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 269-480)                                                â”‚
      â”‚    â””â”€â”€ ðŸ“Š AnalyticsTab (269-450) - Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ, auto-refresh          â”‚
      â”‚                                                                                â”‚
      â”‚ 4ï¸âƒ£  Ð“Ð›ÐÐ’ÐÐžÐ• ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð• (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 482-1140)                                      â”‚
      â”‚    â”œâ”€â”€ ðŸš€ App() - ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚                                          â”‚
      â”‚    â”œâ”€â”€ State management (clients, products, sync)                            â”‚
      â”‚    â”œâ”€â”€ Supabase integration (fetchClients, addClient, etc.)                  â”‚
      â”‚    â”œâ”€â”€ Modal Ð¾ÐºÐ½Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (ÐµÑÐ»Ð¸ !clientId)                            â”‚
      â”‚    â”œâ”€â”€ Header Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð¸ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²                        â”‚
      â”‚    â”œâ”€â”€ Tab navigation (Ð´ÐµÐ½ÑŒ/Ñ€Ð°Ñ†Ð¸Ð¾Ð½/Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹/Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ/Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°)                 â”‚
      â”‚    â””â”€â”€ Render ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°                                            â”‚
      â”‚                                                                                â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ ðŸ” Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ ÐŸÐžÐ˜Ð¡Ðš:                                                             â”‚
      â”‚   â€¢ ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚: Ctrl+F "ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: " + Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ                               â”‚
      â”‚   â€¢ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ: Ctrl+F "function " + Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ                                   â”‚
      â”‚   â€¢ State: Ctrl+F "useState" Ð¸Ð»Ð¸ "useEffect"                                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      */

      // Service Worker Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð´Ð»Ñ dev Ñ€ÐµÐ¶Ð¸Ð¼Ð°
      // if ('serviceWorker' in navigator) {
      //   window.addEventListener('load', () => {
      //     navigator.serviceWorker.register('/sw.js')
      //       .then((registration) => {
      //         console.log('âœ… SW: Registered successfully', registration.scope);
      //       })
      //       .catch((error) => {
      //         console.log('âŒ SW: Registration failed', error);
      //       });
      //   });
      // }

      (function () {
        window.HEYS = window.HEYS || {};
        // Wait for React and HEYS components to load
        let reactCheckCount = 0;
        function initializeApp() {
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ React
          if (!window.React || !window.ReactDOM) {
            reactCheckCount++;
            if (reactCheckCount === 1 || reactCheckCount % 10 === 0) {
              console.log('â³ Waiting for React to load...');
            }
            setTimeout(initializeApp, 100);
            return;
          }

          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… HEYS ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
          const heysReady =
            window.HEYS &&
            window.HEYS.DayTab &&
            window.HEYS.Ration &&
            window.HEYS.UserTab &&
            window.HEYS.ReportsTab;

          if (!heysReady) {
            reactCheckCount++;
            if (reactCheckCount === 1 || reactCheckCount % 10 === 0) {
              console.log('â³ Waiting for HEYS components to load...');
            }
            setTimeout(initializeApp, 100);
            return;
          }

          console.log('âœ… React and HEYS components loaded, initializing app...');
          const React = window.React,
            ReactDOM = window.ReactDOM;
          const { useState, useEffect } = React;

          // init cloud (safe if no cloud module)
          if (window.HEYS.cloud && typeof HEYS.cloud.init === 'function') {
            HEYS.cloud.init({
              url: 'https://ukqolcziqcuplqfgrmsh.supabase.co',
              anonKey:
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcW9sY3ppcWN1cGxxZmdybXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTE1NDUsImV4cCI6MjA3MDgyNzU0NX0.Nzd8--PyGMJvIHqFoCQKNUOwpxnrAZuslQHtAjcE1Ds',
            });
          }

          /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           * ðŸ“… ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: DayTabWithCloudSync (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 142-181)
           * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           * ÐžÐ±Ñ‘Ñ€Ñ‚ÐºÐ° Ð´Ð»Ñ heys_day_v12.js Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð¸Ð· Ð¾Ð±Ð»Ð°ÐºÐ°
           * Props: { clientId, products }
           * Dependencies: window.HEYS.cloud.bootstrapClientSync, window.HEYS.DayTab
           * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           */
          function DayTabWithCloudSync(props) {
            const { clientId, products } = props;
            const [loading, setLoading] = React.useState(true);
            React.useEffect(() => {
              let cancelled = false;
              const cloud = window.HEYS && window.HEYS.cloud;
              const finish = () => {
                if (!cancelled) setLoading(false);
              };
              if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
                const need =
                  typeof cloud.shouldSyncClient === 'function'
                    ? cloud.shouldSyncClient(clientId, 4000)
                    : true;
                if (need) {
                  setLoading(true);
                  cloud.bootstrapClientSync(clientId).then(finish);
                } else finish();
              } else {
                finish();
              }
              return () => {
                cancelled = true;
              };
            }, [clientId]);
            if (loading)
              return React.createElement(
                'div',
                { className: 'muted', style: { padding: 24 } },
                'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°...',
              );
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ DayTab Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½
            if (!window.HEYS || !window.HEYS.DayTab) {
              return React.createElement(
                'div',
                { className: 'muted', style: { padding: 24 } },
                'â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°...',
              );
            }
            return React.createElement(window.HEYS.DayTab, { products });
          }

          /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           * ðŸ½ï¸ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: RationTabWithCloudSync (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 185-227)
           * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           * ÐžÐ±Ñ‘Ñ€Ñ‚ÐºÐ° Ð´Ð»Ñ heys_core_v12.js (Ration) Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²
           * Props: { clientId, setProducts, products }
           * Dependencies: window.HEYS.cloud.bootstrapClientSync, window.HEYS.Ration
           * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           */
          function RationTabWithCloudSync(props) {
            const { clientId, setProducts, products } = props;
            const [loading, setLoading] = React.useState(true);
            React.useEffect(() => {
              let cancelled = false;
              if (
                clientId &&
                window.HEYS.cloud &&
                typeof window.HEYS.cloud.bootstrapClientSync === 'function'
              ) {
                setLoading(true);
                window.HEYS.cloud.bootstrapClientSync(clientId).then(() => {
                  if (!cancelled) {
                    const loadedProducts = Array.isArray(
                      window.HEYS.utils.lsGet('heys_products', []),
                    )
                      ? window.HEYS.utils.lsGet('heys_products', [])
                      : [];
                    setProducts(loadedProducts);
                    setLoading(false);
                  }
                });
              } else {
                setLoading(false);
              }
              return () => {
                cancelled = true;
              };
            }, [clientId]);
            if (loading)
              return React.createElement(
                'div',
                { className: 'muted', style: { padding: 24 } },
                'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°...',
              );
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ration Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½
            if (!window.HEYS || !window.HEYS.Ration) {
              return React.createElement(
                'div',
                { className: 'muted', style: { padding: 24 } },
                'â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°...',
              );
            }
            return React.createElement(window.HEYS.Ration, { products, setProducts });
          }

          /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           * ðŸ‘¤ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: UserTabWithCloudSync (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 230-266)
           * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           * ÐžÐ±Ñ‘Ñ€Ñ‚ÐºÐ° Ð´Ð»Ñ heys_user_v12.js Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸ Ð·Ð¾Ð½
           * Props: { clientId }
           * Dependencies: window.HEYS.cloud.bootstrapClientSync, window.HEYS.UserTab
           * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           */
          function UserTabWithCloudSync(props) {
            const { clientId } = props;
            const [loading, setLoading] = React.useState(true);
            React.useEffect(() => {
              let cancelled = false;
              if (
                clientId &&
                window.HEYS.cloud &&
                typeof window.HEYS.cloud.bootstrapClientSync === 'function'
              ) {
                setLoading(true);
                window.HEYS.cloud.bootstrapClientSync(clientId).then(() => {
                  if (!cancelled) setLoading(false);
                });
              } else {
                setLoading(false);
              }
              return () => {
                cancelled = true;
              };
            }, [clientId]);
            if (loading)
              return React.createElement(
                'div',
                { className: 'muted', style: { padding: 24 } },
                'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°...',
              );
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ UserTab Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½
            if (!window.HEYS || !window.HEYS.UserTab) {
              return React.createElement(
                'div',
                { className: 'muted', style: { padding: 24 } },
                'â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°...',
              );
            }
            return React.createElement(window.HEYS.UserTab, {});
          }

          /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           * ðŸ“Š ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: AnalyticsTab (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 269-450)
           * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           * Ð’ÐºÐ»Ð°Ð´ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ (heys_simple_analytics.js)
           * Props: none
           * Dependencies: window.HEYS.analytics, window.HEYS.analyticsUI
           * Features: Auto-refresh ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 ÑÐµÐº, ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
           * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           */
          function AnalyticsTab() {
            const [stats, setStats] = useState(null);
            const [autoRefresh, setAutoRefresh] = useState(true);

            const loadStats = () => {
              if (window.HEYS && window.HEYS.analytics) {
                const data = window.HEYS.analytics.getStats();
                setStats(data);
              }
            };

            useEffect(() => {
              loadStats();
              if (autoRefresh) {
                const interval = setInterval(loadStats, 5000); // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 ÑÐµÐº
                return () => clearInterval(interval);
              }
            }, [autoRefresh]);

            if (!stats) {
              return React.createElement(
                'div',
                { style: { padding: 24 } },
                'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸...',
              );
            }

            return React.createElement(
              'div',
              { style: { padding: 24, maxWidth: 900 } },
              // Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
              React.createElement(
                'div',
                {
                  style: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: 24,
                  },
                },
                React.createElement('h2', { style: { margin: 0 } }, 'ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐµÑÑÐ¸Ð¸'),
                React.createElement(
                  'div',
                  { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                  React.createElement(
                    'label',
                    null,
                    React.createElement('input', {
                      type: 'checkbox',
                      checked: autoRefresh,
                      onChange: (e) => setAutoRefresh(e.target.checked),
                      style: { marginRight: 4 },
                    }),
                    'ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ',
                  ),
                  React.createElement(
                    'button',
                    { className: 'btn', onClick: loadStats },
                    'ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
                  ),
                ),
              ),

              // Ð’Ñ€ÐµÐ¼Ñ ÑÐµÑÑÐ¸Ð¸
              React.createElement(
                'div',
                {
                  style: { marginBottom: 24, padding: 16, background: '#f8f9fa', borderRadius: 8 },
                },
                React.createElement(
                  'div',
                  { style: { fontSize: 14, color: '#666', marginBottom: 4 } },
                  'Ð’Ñ€ÐµÐ¼Ñ ÑÐµÑÑÐ¸Ð¸',
                ),
                React.createElement(
                  'div',
                  { style: { fontSize: 24, fontWeight: 600 } },
                  stats.session.duration,
                ),
              ),

              // ÐŸÐ¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
              React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'ðŸ” ÐŸÐ¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹'),
                React.createElement(
                  'div',
                  { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#e3f2fd', borderRadius: 8 } },
                    React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Ð’ÑÐµÐ³Ð¾'),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.searches.total,
                    ),
                  ),
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#fff3e0', borderRadius: 8 } },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'ÐœÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ñ… (>1s)',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.searches.slow,
                    ),
                  ),
                  React.createElement(
                    'div',
                    {
                      style: {
                        padding: 16,
                        background: stats.searches.slowRate === '0%' ? '#e8f5e9' : '#ffebee',
                        borderRadius: 8,
                      },
                    },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'Slow Rate',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.searches.slowRate,
                    ),
                  ),
                ),
              ),

              // API Ð²Ñ‹Ð·Ð¾Ð²Ñ‹
              React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'ðŸŒ API Ð²Ñ‹Ð·Ð¾Ð²Ñ‹'),
                React.createElement(
                  'div',
                  { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 } },
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#e3f2fd', borderRadius: 8 } },
                    React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Ð’ÑÐµÐ³Ð¾'),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.apiCalls.total,
                    ),
                  ),
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#fff3e0', borderRadius: 8 } },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'ÐœÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ñ… (>2s)',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.apiCalls.slow,
                    ),
                  ),
                  React.createElement(
                    'div',
                    {
                      style: {
                        padding: 16,
                        background: stats.apiCalls.failed > 0 ? '#ffebee' : '#e8f5e9',
                        borderRadius: 8,
                      },
                    },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'ÐžÑˆÐ¸Ð±Ð¾Ðº',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.apiCalls.failed,
                    ),
                  ),
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#f3e5f5', borderRadius: 8 } },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'Slow Rate',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.apiCalls.slowRate,
                    ),
                  ),
                ),
              ),

              // Cache ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
              React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'ðŸ’¾ Cache ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ'),
                React.createElement(
                  'div',
                  { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#e8f5e9', borderRadius: 8 } },
                    React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Hits'),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.cache.hits,
                    ),
                  ),
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#ffebee', borderRadius: 8 } },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'Misses',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.cache.misses,
                    ),
                  ),
                  React.createElement(
                    'div',
                    { style: { padding: 16, background: '#e1f5fe', borderRadius: 8 } },
                    React.createElement(
                      'div',
                      { style: { fontSize: 12, color: '#666' } },
                      'Hit Rate',
                    ),
                    React.createElement(
                      'div',
                      { style: { fontSize: 20, fontWeight: 600 } },
                      stats.cache.hitRate,
                    ),
                  ),
                ),
              ),

              // ÐžÑˆÐ¸Ð±ÐºÐ¸
              React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'ðŸ› ÐžÑˆÐ¸Ð±ÐºÐ¸'),
                React.createElement(
                  'div',
                  {
                    style: {
                      padding: 16,
                      background: stats.errors.total > 0 ? '#ffebee' : '#e8f5e9',
                      borderRadius: 8,
                    },
                  },
                  React.createElement(
                    'div',
                    { style: { fontSize: 12, color: '#666' } },
                    'Ð’ÑÐµÐ³Ð¾ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² ÑÐµÑÑÐ¸Ð¸',
                  ),
                  React.createElement(
                    'div',
                    { style: { fontSize: 24, fontWeight: 600 } },
                    stats.errors.total,
                  ),
                ),
              ),

              // ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐ±Ñ€Ð¾ÑÐ°
              React.createElement(
                'div',
                { style: { marginTop: 32, paddingTop: 24, borderTop: '1px solid #eee' } },
                React.createElement(
                  'button',
                  {
                    className: 'btn secondary',
                    onClick: () => {
                      if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.reset) {
                        if (confirm('Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð²ÑÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÑÐµÑÑÐ¸Ð¸?')) {
                          window.HEYS.analytics.reset();
                          loadStats();
                        }
                      }
                    },
                  },
                  'ðŸ—‘ï¸ Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ',
                ),
              ),
            );
          }

          /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           * ðŸš€ Ð“Ð›ÐÐ’ÐÐ«Ð™ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: App (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 482-1140)
           * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           * ÐšÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÐµÐ¼
           *
           * STATE MANAGEMENT:
           *   - tab: Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð²ÐºÐ»Ð°Ð´ÐºÐ° ('day'|'ration'|'reports'|'user'|'analytics')
           *   - products: Ð¼Ð°ÑÑÐ¸Ð² Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð´Ð»Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
           *   - clients: ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² ÐºÑƒÑ€Ð°Ñ‚Ð¾Ñ€Ð°
           *   - clientId: ID Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
           *   - cloudUser: Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Supabase
           *   - status: ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ('online'|'offline')
           *
           * MAIN FEATURES:
           *   - ÐÐ²Ñ‚Ð¾Ð»Ð¾Ð³Ð¸Ð½ Ð² Supabase (ONE_CURATOR_MODE)
           *   - ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
           *   - Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ Ð¾Ð±Ð»Ð°ÐºÐ¾Ð¼
           *   - Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (localStorage fallback)
           *
           * DEPENDENCIES: window.HEYS.cloud, window.HEYS.utils
           * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           */
          const CORE_BACKUP_KEYS = [
            'heys_products',
            'heys_profile',
            'heys_hr_zones',
            'heys_norms',
            'heys_dayv2_date',
          ];

          function App() {
            const ONE_CURATOR_MODE = true; // Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð²Ñ…Ð¾Ð´ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Supabase
            const [tab, setTab] = useState('day');
            // ...Ð²ÑÐµ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ useState...
            // useEffect Ð°Ð²Ñ‚Ð¾ÑÐ¼ÐµÐ½Ñ‹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° â€” Ð½Ð¸Ð¶Ðµ Ð²ÑÐµÑ… useState!
            const U = window.HEYS.utils || { lsGet: (k, d) => d, lsSet: () => {} };
            const [products, setProducts] = useState([]);
            const [reportsRefresh, setReportsRefresh] = useState(0);

            const cloud = window.HEYS.cloud || {};
            const [status, setStatus] = useState(
              typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline',
            );
            const [syncVer, setSyncVer] = useState(0);
            // === Clients (selector + persistence) ===
            const [clients, setClients] = useState([]);
            const [clientId, setClientId] = useState('');
            const [newName, setNewName] = useState('');
            const [cloudUser, setCloudUser] = useState(null);
            const [isInitializing, setIsInitializing] = useState(true); // Ð¤Ð»Ð°Ð³ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
            const [backupMeta, setBackupMeta] = useState(() => {
              if (U && typeof U.lsGet === 'function') {
                try {
                  return U.lsGet('heys_backup_meta', null);
                } catch (error) {
                  console.warn('[HEYS] ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ backup Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸:', error);
                }
              }
              return null;
            });
            const [backupBusy, setBackupBusy] = useState(false);

            // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² ÐºÑƒÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¸Ð· Supabase
            async function fetchClientsFromCloud(curatorId) {
              if (!cloud.client || !curatorId) return [];
              const { data, error } = await cloud.client
                .from('clients')
                .select('id, name')
                .eq('curator_id', curatorId)
                .order('updated_at', { ascending: true });
              if (error) {
                console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²:', error);
                return [];
              }
              return data || [];
            }

            // Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð² Supabase Ð¸Ð»Ð¸ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
            async function addClientToCloud(name) {
              const clientName = (name || '').trim() || `ÐšÐ»Ð¸ÐµÐ½Ñ‚ ${clients.length + 1}`;

              // Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
              if (!cloud.client || !cloudUser || !cloudUser.id) {
                console.log('addClientToCloud: ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                const newClient = {
                  id: `local-user-${Date.now()}`,
                  name: clientName,
                };
                const updatedClients = [...clients, newClient];
                setClients(updatedClients);
                U.lsSet('heys_clients', updatedClients);
                setClientId(newClient.id);
                U.lsSet('heys_client_current', newClient.id);
                return;
              }

              // ÐžÐ±Ð»Ð°Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
              const userId = cloudUser.id;
              const { data, error } = await cloud.client
                .from('clients')
                .insert([{ name: clientName, curator_id: userId }])
                .select('id, name')
                .single();
              if (error) {
                console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:', error);
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: ' + error.message);
                return;
              }
              // ÐŸÐ¾ÑÐ»Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ â€” Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº
              const updated = await fetchClientsFromCloud(userId);
              setClients(updated);
              setClientId(data.id);
              U.lsSet('heys_client_current', data.id);
            }

            // ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð¸Ð»Ð¸ Supabase)
            async function renameClient(id, name) {
              // Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
              if (!cloud.client || !cloudUser || !cloudUser.id) {
                const updatedClients = clients.map((c) => (c.id === id ? { ...c, name } : c));
                setClients(updatedClients);
                U.lsSet('heys_clients', updatedClients);
                return;
              }

              // ÐžÐ±Ð»Ð°Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
              const userId = cloudUser.id;
              await cloud.client.from('clients').update({ name }).eq('id', id);
              const updated = await fetchClientsFromCloud(userId);
              setClients(updated);
            }

            // Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð¸Ð»Ð¸ Supabase)
            async function removeClient(id) {
              // Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
              if (!cloud.client || !cloudUser || !cloudUser.id) {
                const updatedClients = clients.filter((c) => c.id !== id);
                setClients(updatedClients);
                U.lsSet('heys_clients', updatedClients);
                if (clientId === id) {
                  setClientId('');
                  U.lsSet('heys_client_current', '');
                }
                return;
              }

              // ÐžÐ±Ð»Ð°Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
              const userId = cloudUser.id;
              await cloud.client.from('clients').delete().eq('id', id);
              const updated = await fetchClientsFromCloud(userId);
              setClients(updated);
              if (clientId === id) {
                setClientId('');
                U.lsSet('heys_client_current', '');
              }
            }

            const downloadBackupFile = React.useCallback((payload, activeClientId, timestamp) => {
              try {
                const blob = new Blob([JSON.stringify(payload, null, 2)], {
                  type: 'application/json',
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const safeTs = (timestamp || '').replace(/[:]/g, '-');
                a.download = `heys-backup-${activeClientId || 'client'}-${safeTs || Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 0);
              } catch (error) {
                console.error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸:', error);
              }
            }, []);

            const listDayKeysForClient = React.useCallback(() => {
              if (!clientId) return [];
              const normalized = new Set();
              try {
                const heysPrefix = `heys_${clientId}_`;
                const legacyDayPrefix = `day_${clientId}_`;
                for (let i = 0; i < localStorage.length; i++) {
                  const rawKey = localStorage.key(i);
                  if (!rawKey) continue;
                  if (rawKey.startsWith(`${heysPrefix}dayv2_`)) {
                    normalized.add('heys_' + rawKey.slice(heysPrefix.length));
                  } else if (rawKey.startsWith(legacyDayPrefix)) {
                    normalized.add('day_' + rawKey.slice(legacyDayPrefix.length));
                  }
                }
              } catch (error) {
                console.warn('[HEYS] ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÑ‡Ð¸ÑÐ»Ð¸Ñ‚ÑŒ Ð´Ð½ÐµÐ²Ð½Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸ Ð´Ð»Ñ Ð±ÑÐºÐ°Ð¿Ð°:', error);
              }
              return Array.from(normalized);
            }, [clientId]);

            const backupAllKeys = React.useCallback(
              (options = {}) => {
                if (!clientId) {
                  if (!options.silent) alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                  return { ok: false, reason: 'no-client' };
                }
                const timestamp = new Date().toISOString();
                const reason = options.reason || 'manual';
                const includeDays = options.includeDays !== false;
                const baseKeys = Array.isArray(options.keys) && options.keys.length
                  ? options.keys
                  : CORE_BACKUP_KEYS;
                const keysToProcess = new Set(baseKeys);
                if (includeDays) {
                  listDayKeysForClient().forEach((key) => keysToProcess.add(key));
                }
                const shouldDownload = Boolean(options.triggerDownload);
                const filePayload = shouldDownload
                  ? { version: 1, clientId, generatedAt: timestamp, reason, items: [] }
                  : null;
                let processed = 0;
                keysToProcess.forEach((key) => {
                  let data = null;
                  try {
                    data = U && typeof U.lsGet === 'function' ? U.lsGet(key, null) : null;
                  } catch (error) {
                    console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ ÐºÐ»ÑŽÑ‡Ð° Ð´Ð»Ñ Ð±ÑÐºÐ°Ð¿Ð°:', key, error);
                    data = null;
                  }
                  if (data === null || data === undefined) return;
                  if (key === 'heys_products' && Array.isArray(data) && data.length === 0) {
                    if (window.DEV) {
                      window.DEV.log(
                        '[BACKUP] SKIP heys_products_backup: source array is empty, keep previous snapshot',
                      );
                    }
                    return;
                  }
                  const snapshot = {
                    key,
                    clientId,
                    backupAt: timestamp,
                    reason,
                    data,
                    itemsCount: Array.isArray(data)
                      ? data.length
                      : data && typeof data === 'object'
                        ? Object.keys(data).length
                        : 1,
                  };
                  if (window.DEV && key === 'heys_products') {
                    window.DEV.log('[BACKUP] heys_products_backup items:', snapshot.itemsCount);
                  }
                  if (U && typeof U.lsSet === 'function') {
                    U.lsSet(`${key}_backup`, snapshot);
                  } else {
                    try {
                      localStorage.setItem(`${key}_backup`, JSON.stringify(snapshot));
                    } catch (error) {
                      console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð±ÑÐºÐ°Ð¿Ð° Ð² localStorage:', error);
                    }
                    if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                      try {
                        window.HEYS.saveClientKey(`${key}_backup`, snapshot);
                      } catch (error) {
                        console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð±ÑÐºÐ°Ð¿Ð° Ð² Ð¾Ð±Ð»Ð°ÐºÐ¾:', error);
                      }
                    }
                  }
                  if (filePayload) {
                    filePayload.items.push(snapshot);
                  }
                  processed++;
                });
                const meta = {
                  timestamp,
                  clientId,
                  reason,
                  processed,
                  keys: Array.from(keysToProcess),
                };
                if (U && typeof U.lsSet === 'function') {
                  U.lsSet('heys_backup_meta', meta);
                } else {
                  try {
                    localStorage.setItem('heys_backup_meta', JSON.stringify(meta));
                  } catch (error) {}
                  if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                    try {
                      window.HEYS.saveClientKey('heys_backup_meta', meta);
                    } catch (error) {
                      console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð±ÑÐºÐ°Ð¿Ð°:', error);
                    }
                  }
                }
                setBackupMeta(meta);
                if (shouldDownload && filePayload && filePayload.items.length) {
                  downloadBackupFile(filePayload, clientId, timestamp);
                }
                if (!options.silent) {
                  alert(
                    processed
                      ? `Ð‘ÑÐºÐ°Ð¿ Ð³Ð¾Ñ‚Ð¾Ð²: ${processed} Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²`
                      : 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ',
                  );
                }
                if (window.HEYS && window.HEYS.analytics) {
                  window.HEYS.analytics.trackDataOperation('backup-save', processed);
                }
                return { ok: processed > 0, meta, processed };
              },
              [clientId, downloadBackupFile, listDayKeysForClient, setBackupMeta],
            );

            const restoreFromBackup = React.useCallback(
              (target = 'heys_products', options = {}) => {
                if (!clientId) {
                  if (!options.silent) alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                  return { ok: false, reason: 'no-client' };
                }
                const keysList =
                  target === 'all'
                    ? Array.from(
                        new Set([
                          ...CORE_BACKUP_KEYS,
                          ...(options.includeDays === false
                            ? []
                            : listDayKeysForClient()),
                        ]),
                      )
                    : Array.isArray(target)
                      ? target
                      : [target];
                let restored = 0;
                keysList.forEach((key) => {
                  let snapshot = null;
                  try {
                    snapshot = U && typeof U.lsGet === 'function' ? U.lsGet(`${key}_backup`, null) : null;
                  } catch (error) {
                    console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð±ÑÐºÐ°Ð¿Ð° Ð¿ÐµÑ€ÐµÐ´ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼:', key, error);
                    snapshot = null;
                  }
                  if (!snapshot || typeof snapshot !== 'object' || !('data' in snapshot)) {
                    return;
                  }
                  if (key === 'heys_products' && Array.isArray(snapshot.data) && snapshot.data.length === 0) {
                    if (window.DEV) {
                      window.DEV.log('[RESTORE] Empty heys_products_backup, treating as no backup');
                    }
                    return;
                  }
                  if (key === 'heys_products') {
                    setProducts(Array.isArray(snapshot.data) ? snapshot.data : []);
                  } else if (U && typeof U.lsSet === 'function') {
                    U.lsSet(key, snapshot.data);
                  } else {
                    try {
                      localStorage.setItem(key, JSON.stringify(snapshot.data));
                    } catch (error) {}
                    if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                      try {
                        window.HEYS.saveClientKey(key, snapshot.data);
                      } catch (error) {
                        console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
                      }
                    }
                  }
                  restored++;
                });
                if (restored) {
                  setSyncVer((v) => v + 1);
                  if (window.HEYS && window.HEYS.analytics) {
                    window.HEYS.analytics.trackDataOperation('backup-restore', restored);
                  }
                }
                if (!options.silent) {
                  alert(
                    restored
                      ? `Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²: ${restored}`
                      : 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð±ÑÐºÐ°Ð¿',
                  );
                }
                return { ok: restored > 0, restored };
              },
              [clientId, listDayKeysForClient, setProducts, setSyncVer],
            );

            // ÐÐ²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÑƒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð´Ð½Ñ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            useEffect(() => {
              if (clientId) setTab('day');
            }, [clientId]);

            // Fallback: ÐµÑÐ»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ…Ð¾Ð´Ð° Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿ÑƒÑÑ‚Ñ‹Ðµ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð²Ð·ÑÑ‚ÑŒ Ð¸Ð· localStorage Ñ‡ÐµÑ€ÐµÐ· utils
            useEffect(() => {
              if (products.length === 0) {
                try {
                  const stored =
                    (window.HEYS &&
                      window.HEYS.utils &&
                      window.HEYS.utils.lsGet &&
                      window.HEYS.utils.lsGet('heys_products', [])) ||
                    [];
                  if (Array.isArray(stored) && stored.length) setProducts(stored);
                } catch (e) {}
              }
            }, [products.length]);

            // ÐŸÑ€Ð¸ ÑÐ¼ÐµÐ½Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² localStorage (Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
            useEffect(() => {
              if (clientId) {
                U.lsSet('heys_client_current', clientId);
                window.HEYS = window.HEYS || {};
                window.HEYS.currentClientId = clientId;
                // ÐŸÐ¾Ð´Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¸Ð· Supabase Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹
                if (cloud && typeof cloud.bootstrapClientSync === 'function') {
                  console.log(`ðŸ”„ [CLIENT CHANGE] Starting bootstrap for client: ${clientId}`);
                  // ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹
                  const productsBeforeSync = products.length > 0 ? products : window.HEYS.utils.lsGet('heys_products', []);
                  console.log(`ðŸ“¦ [CLIENT CHANGE] Products before sync: ${Array.isArray(productsBeforeSync) ? productsBeforeSync.length : 0} items`);
                  
                  cloud.bootstrapClientSync(clientId).then(() => {
                    console.log(`ðŸ”„ [CLIENT CHANGE] Bootstrap completed, loading products...`);
                    // Ð²ÑÐµÐ³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ HEYS.utils.lsGet Ð´Ð»Ñ clientId-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°
                    const loadedProducts = Array.isArray(
                      window.HEYS.utils.lsGet('heys_products', []),
                    )
                      ? window.HEYS.utils.lsGet('heys_products', [])
                      : [];
                    console.log(`ðŸ“¦ [CLIENT CHANGE] Loaded products from localStorage: ${loadedProducts.length} items`);
                    
                    // Ð—ÐÐ©Ð˜Ð¢Ð: ÐµÑÐ»Ð¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²ÐµÑ€Ð½ÑƒÐ»Ð° Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð¼Ð°ÑÑÐ¸Ð², Ð° Ñƒ Ð½Ð°Ñ Ð±Ñ‹Ð»Ð¸ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ - Ð½Ðµ Ð·Ð°Ñ‚Ð¸Ñ€Ð°ÐµÐ¼
                    if (loadedProducts.length === 0 && Array.isArray(productsBeforeSync) && productsBeforeSync.length > 0) {
                      console.warn(`âš ï¸ [CLIENT CHANGE] PROTECTION: Sync returned empty, keeping ${productsBeforeSync.length} products`);
                      setProducts(productsBeforeSync);
                      // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð² localStorage
                      window.HEYS.utils.lsSet('heys_products', productsBeforeSync);
                    } else {
                      setProducts(loadedProducts);
                    }
                    setSyncVer((v) => v + 1);
                  });
                } else {
                  setSyncVer((v) => v + 1);
                }
              }
            }, [clientId]);

            useEffect(() => {
              if (!clientId) {
                setBackupMeta(null);
                return;
              }
              try {
                const meta = U && typeof U.lsGet === 'function' ? U.lsGet('heys_backup_meta', null) : null;
                setBackupMeta(meta || null);
              } catch (error) {
                console.warn('[HEYS] ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð±ÑÐºÐ°Ð¿Ð° Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:', error);
              }
            }, [clientId]);

            // Ð¡Ð»ÑƒÑˆÐ°ÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð¸Ð· Ð¾Ð±Ð»Ð°ÐºÐ°
            useEffect(() => {
              const handleProductsUpdate = (event) => {
                const { products } = event.detail;
                setProducts(products);
                setSyncVer((v) => v + 1);
              };

              window.addEventListener('heysProductsUpdated', handleProductsUpdate);
              return () => window.removeEventListener('heysProductsUpdated', handleProductsUpdate);
            }, []);

            // ÐžÐ±ÐµÑ€Ñ‚ÐºÐ° Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð² Ð¾Ð±Ð»Ð°ÐºÐ¾
            window.HEYS = window.HEYS || {};
            window.HEYS.saveClientKey = function (k, v) {
              if (clientId && cloud && typeof cloud.saveClientKey === 'function') {
                cloud.saveClientKey(clientId, k, v);
              }
            };
            useEffect(() => {
              window.HEYS = window.HEYS || {};
              window.HEYS.backupManager = window.HEYS.backupManager || {};
              window.HEYS.backupManager.backupAll = backupAllKeys;
              window.HEYS.backupManager.restore = restoreFromBackup;
              window.HEYS.backupManager.getLastBackupMeta = () => backupMeta;
            }, [backupAllKeys, restoreFromBackup, backupMeta]);
            // overlay (no early return, to keep hooks order stable)
            // One-time migration of old, namespaced client lists -> global
            // ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ…Ð¾Ð´Ð° â€” Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² ÐºÑƒÑ€Ð°Ñ‚Ð¾Ñ€Ð°
            useEffect(() => {
              if (cloudUser && cloudUser.id) {
                fetchClientsFromCloud(cloudUser.id).then(setClients);
              }
            }, [cloudUser]);

            // Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
            async function createTestClients() {
              if (!cloud.client || !cloudUser || !cloudUser.id) return;
              const userId = cloudUser.id; // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
              const testClients = [{ name: 'Ð˜Ð²Ð°Ð½ ÐŸÐµÑ‚Ñ€Ð¾Ð²' }, { name: 'ÐÐ½Ð½Ð° Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð²Ð°' }];

              for (const testClient of testClients) {
                try {
                  await cloud.client
                    .from('clients')
                    .insert([{ name: testClient.name, curator_id: userId }]);
                } catch (error) {
                  console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:', error);
                }
              }

              // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
              const updated = await fetchClientsFromCloud(userId);
              setClients(updated);
            }

            function formatBackupTime(meta) {
              if (!meta || !meta.timestamp) return 'â€”';
              try {
                return new Date(meta.timestamp).toLocaleString('ru-RU', { hour12: false });
              } catch (error) {
                return meta.timestamp;
              }
            }

            async function handleManualBackup() {
              if (!clientId) {
                alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                return;
              }
              if (backupBusy) return;
              setBackupBusy(true);
              try {
                await backupAllKeys({ reason: 'manual' });
              } finally {
                setBackupBusy(false);
              }
            }

            async function handleExportBackup() {
              if (!clientId) {
                alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                return;
              }
              if (backupBusy) return;
              setBackupBusy(true);
              try {
                const result = await backupAllKeys({
                  reason: 'manual-export',
                  triggerDownload: true,
                  includeDays: true,
                  silent: true,
                });
                alert(
                  result && result.processed
                    ? `Ð¤Ð°Ð¹Ð» Ð±ÑÐºÐ°Ð¿Ð° ÑÐºÐ°Ñ‡Ð°Ð½ (${result.processed} Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²)`
                    : 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°',
                );
              } finally {
                setBackupBusy(false);
              }
            }

            function handleRestoreProducts() {
              if (!clientId) {
                alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                return;
              }
              if (!confirm('Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð¸Ð· Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð±ÑÐºÐ°Ð¿Ð°?')) return;
              const result = restoreFromBackup('heys_products', { silent: true });
              alert(result && result.ok ? 'ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹.' : 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð±ÑÐºÐ°Ð¿ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð².');
            }

            function handleRestoreAll() {
              if (!clientId) {
                alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°');
                return;
              }
              if (!confirm('Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð±ÑÐºÐ°Ð¿Ð°?')) return;
              const result = restoreFromBackup('all', { silent: true });
              alert(
                result && result.ok
                  ? `Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²: ${result.restored}`
                  : 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð².',
              );
            }

            const gate = !clientId
              ? React.createElement(
                  'div',
                  { className: 'modal-backdrop' },
                  React.createElement(
                    'div',
                    { className: 'modal' },
                    isInitializing
                      ? React.createElement(
                          'div',
                          { style: { textAlign: 'center', padding: '40px 20px' } },
                          React.createElement(
                            'div',
                            { style: { fontSize: 18, marginBottom: 12 } },
                            'â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...',
                          ),
                          React.createElement(
                            'div',
                            { className: 'muted' },
                            'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ',
                          ),
                        )
                      : React.createElement(
                          React.Fragment,
                          null,
                          React.createElement(
                            'div',
                            {
                              className: 'row',
                              style: { justifyContent: 'space-between', marginBottom: '6px' },
                            },
                            React.createElement(
                              'div',
                              { style: { fontWeight: 600 } },
                              'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°',
                            ),
                            React.createElement(
                              'span',
                              { className: 'muted' },
                              `Ð’ÑÐµÐ³Ð¾: ${clients.length}`,
                            ),
                          ),
                          React.createElement(
                            'div',
                            { style: { maxHeight: 260, overflow: 'auto', marginBottom: 8 } },
                            clients.length
                              ? clients.map((c) =>
                                  React.createElement(
                                    'div',
                                    {
                                      key: c.id,
                                      className: 'row',
                                      style: { justifyContent: 'space-between' },
                                    },
                                    React.createElement(
                                      'div',
                                      null,
                                      React.createElement(
                                        'div',
                                        { style: { fontWeight: 600 } },
                                        c.name,
                                      ),
                                      React.createElement('div', { className: 'muted' }, c.id),
                                    ),
                                    React.createElement(
                                      'div',
                                      { className: 'row' },
                                      React.createElement(
                                        'button',
                                        {
                                          className: 'btn',
                                          onClick: () => {
                                            setClientId(c.id);
                                            U.lsSet('heys_client_current', c.id); // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ñ‹Ð±Ð¾Ñ€
                                          },
                                        },
                                        'Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ',
                                      ),
                                      React.createElement(
                                        'button',
                                        {
                                          className: 'btn',
                                          onClick: () => {
                                            const nm = prompt('ÐÐ¾Ð²Ð¾Ðµ Ð¸Ð¼Ñ', c.name) || c.name;
                                            renameClient(c.id, nm);
                                          },
                                        },
                                        'ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½.',
                                      ),
                                      React.createElement(
                                        'button',
                                        {
                                          className: 'btn',
                                          onClick: () => {
                                            if (confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°?')) removeClient(c.id);
                                          },
                                        },
                                        'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ',
                                      ),
                                    ),
                                  ),
                                )
                              : React.createElement(
                                  'div',
                                  { className: 'muted' },
                                  'Ð•Ñ‰Ñ‘ Ð½ÐµÑ‚ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°',
                                ),
                          ),
                          React.createElement(
                            'div',
                            { className: 'row' },
                            React.createElement('input', {
                              placeholder: 'Ð˜Ð¼Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°',
                              value: newName,
                              onChange: (e) => setNewName(e.target.value),
                            }),
                            React.createElement(
                              'button',
                              { className: 'btn acc', onClick: () => addClientToCloud(newName) },
                              'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ',
                            ),
                          ),
                          React.createElement(
                            'div',
                            { className: 'row', style: { marginTop: 8 } },
                            React.createElement(
                              'button',
                              { className: 'btn secondary', onClick: createTestClients },
                              'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²',
                            ),
                          ),
                        ), // â† Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ React.Fragment
                  ),
                )
              : null;

            const [email, setEmail] = useState('poplanton@mail.ru');
            const [pwd, setPwd] = useState('007670');

            useEffect(() => {
              // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¾Ð±Ð»Ð°ÐºÐ°)
              const initLocalData = () => {
                // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¸Ð· localStorage Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð¼Ð°ÑÑÐ¸Ð²
                const storedProducts = U.lsGet('heys_products', []);
                if (Array.isArray(storedProducts)) {
                  setProducts(storedProducts);
                }

                // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
                const storedClients = U.lsGet('heys_clients', []);
                if (Array.isArray(storedClients) && storedClients.length > 0) {
                  setClients(storedClients);
                } else {
                  // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² offline Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
                  const defaultClients = [
                    { id: 'local-user-001', name: 'Ð˜Ð²Ð°Ð½ ÐŸÐµÑ‚Ñ€Ð¾Ð²' },
                    { id: 'local-user-002', name: 'ÐÐ½Ð½Ð° Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð²Ð°' },
                  ];
                  setClients(defaultClients);
                  U.lsSet('heys_clients', defaultClients);
                }

                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚
                const currentClient = U.lsGet('heys_client_current');
                const storedClientsArray = U.lsGet('heys_clients', []);
                if (currentClient && storedClientsArray.some((c) => c.id === currentClient)) {
                  setClientId(currentClient);
                  window.HEYS = window.HEYS || {};
                  window.HEYS.currentClientId = currentClient;
                  console.log('[HEYS] ðŸ”„ Restored client in offline mode:', currentClient);
                }

                setStatus('offline');
                setSyncVer((v) => v + 1);
              };

              // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº Ð¾Ð±Ð»Ð°ÐºÑƒ ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾
              if (cloud && typeof cloud.bootstrapSync === 'function') {
                // Ð’ÐÐ–ÐÐž: Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½ÑƒÐ¶ÐµÐ½ signIn, ÐŸÐžÐ¢ÐžÐœ bootstrapSync!
                console.log('[HEYS] ðŸš€ Starting auto sign-in...');

                // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ…Ð¾Ð´ Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ñ‹Ð¼Ð¸ credentials
                const savedEmail = 'poplanton@mail.ru'; // TODO: Ð²Ð·ÑÑ‚ÑŒ Ð¸Ð· Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
                const savedPwd = '007670'; // TODO: Ð²Ð·ÑÑ‚ÑŒ Ð¸Ð· Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº

                cloud
                  .signIn(savedEmail, savedPwd)
                  .then(async (result) => {
                    console.log('[HEYS] âœ… Auto sign-in completed, user:', result.user?.email);

                    if (result.error) {
                      console.error('[HEYS] âŒ Sign-in failed:', result.error);
                      initLocalData();
                      setIsInitializing(false);
                      return;
                    }

                    // Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ð»Ð¾Ð³Ð¸Ð½ÐµÐ½, Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ cloudUser
                    const user = result.user || (cloud.getUser && cloud.getUser());
                    if (user) {
                      setCloudUser(user);
                      setStatus('online');

                      // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐÐÐ¡Ð¢ÐžÐ¯Ð©Ð˜Ð¥ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¸Ð· Supabase Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ clients
                      try {
                        const realClients = await fetchClientsFromCloud(user.id);
                        if (realClients && realClients.length > 0) {
                          setClients(realClients);
                          U.lsSet('heys_clients', realClients); // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² localStorage

                          // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ Ð² ÑÐ¿Ð¸ÑÐºÐµ
                          const savedClientId = U.lsGet('heys_client_current');
                          if (savedClientId && realClients.some((c) => c.id === savedClientId)) {
                            console.log('[HEYS] ðŸ”„ Restoring saved client:', savedClientId);
                            setClientId(savedClientId);
                            window.HEYS = window.HEYS || {};
                            window.HEYS.currentClientId = savedClientId;
                          } else {
                            console.log(
                              '[HEYS] â„¹ï¸ No saved client or client not found in list, showing selector',
                            );
                          }

                          console.log(
                            '[HEYS] âœ… Loaded',
                            realClients.length,
                            'clients from Supabase',
                          );
                        } else {
                          // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð² Supabase â€” fallback Ð½Ð° localStorage
                          const localClients = U.lsGet('heys_clients', []).filter(
                            (c) => !c.id?.startsWith('local-user'),
                          );
                          if (localClients.length > 0) {
                            setClients(localClients);
                          } else {
                            initLocalData(); // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑÐ¾Ð²ÑÐµÐ¼ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½ÐµÑ‚
                          }
                        }
                      } catch (error) {
                        console.error('[HEYS] Error loading clients:', error);
                        initLocalData();
                      }
                    } else {
                      // ÐÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ÑÐ»Ðµ signIn â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ offline
                      console.warn('[HEYS] âš ï¸ No user after signIn, using offline mode');
                      initLocalData();
                    }

                    const initialProducts = Array.isArray(U.lsGet('heys_products', []))
                      ? U.lsGet('heys_products', [])
                      : [];
                    console.log(`ðŸ“¦ [INIT] Loading initial products: ${initialProducts.length} items`);
                    setProducts(initialProducts);
                    setSyncVer((v) => v + 1);
                    console.log(
                      '[HEYS] ðŸŽ¯ Setting isInitializing = false, clients.length:',
                      clients.length,
                    );
                    setIsInitializing(false); // âœ… Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°
                  })
                  .catch((error) => {
                    console.error('[HEYS] âŒ Auto sign-in failed:', error);
                    initLocalData();
                    setIsInitializing(false); // âœ… Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° (offline)
                  });
              } else {
                console.log('[HEYS] âš ï¸ No cloud available, using offline mode');
                initLocalData();
                setIsInitializing(false); // âœ… Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° (no cloud)
              }
            }, []);

            // ÐŸÑ€Ð¸ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð¿Ð°Ð½ÐµÐ»Ð¸ â€” bootstrap Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð¸Ð· Ð¾Ð±Ð»Ð°ÐºÐ°, ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ ÐºÐ»Ð¸ÐµÐ½Ñ‚
            useEffect(() => {
              if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
                console.log(`ðŸ”„ [RELOAD] Starting bootstrap for client: ${clientId}`);
                // Ð—ÐÐ©Ð˜Ð¢Ð: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´ reload
                const currentProducts = window.HEYS.utils.lsGet('heys_products', []);
                console.log(`ðŸ“¦ [RELOAD] Current products before bootstrap: ${Array.isArray(currentProducts) ? currentProducts.length : 0} items`);
                
                cloud.bootstrapClientSync(clientId).then(() => {
                  console.log(`ðŸ”„ [RELOAD] Bootstrap completed, loading products...`);
                  const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                    ? window.HEYS.utils.lsGet('heys_products', [])
                    : [];
                  console.log(`ðŸ“¦ [RELOAD] Loaded products from localStorage: ${loadedProducts.length} items`);
                  
                  // Ð—ÐÐ©Ð˜Ð¢Ð: Ð½Ðµ Ð·Ð°Ñ‚Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ Ð¿Ð¾ÑÐ»Ðµ reload
                  if (loadedProducts.length === 0 && Array.isArray(currentProducts) && currentProducts.length > 0) {
                    console.warn(`âš ï¸ [RELOAD] PROTECTION: Bootstrap returned empty, keeping ${currentProducts.length} products`);
                    setProducts(currentProducts);
                    window.HEYS.utils.lsSet('heys_products', currentProducts);
                  } else {
                    setProducts(loadedProducts);
                  }
                  setSyncVer((v) => v + 1);
                });
              }
            }, [clientId]);

            // debounced save products
            const saveTimerRef = React.useRef(null);
            useEffect(() => {
              console.log(`ðŸ’¾ [useEffect] Products changed, length: ${products.length}, clientId: ${clientId}`);
              if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
              saveTimerRef.current = setTimeout(() => {
                try {
                  console.log(`ðŸ’¾ [useEffect] Saving products to cloud: ${products.length} items`);
                  window.HEYS.saveClientKey('heys_products', products);
                } catch (e) {
                  console.error('Error saving products:', e);
                }
              }, 300);
              return () => {
                if (saveTimerRef.current) {
                  clearTimeout(saveTimerRef.current);
                  saveTimerRef.current = null;
                }
              };
            }, [products]);

            // auto sign-in in single-curator mode
            useEffect(() => {
              if (ONE_CURATOR_MODE && status !== 'online') {
                doSignIn();
              }
            }, [ONE_CURATOR_MODE, status]);

            async function doSignIn() {
              try {
                if (!email || !pwd) {
                  alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ');
                  return;
                }
                setStatus('signin');
                if (cloud && typeof cloud.signIn === 'function') {
                  const result = await cloud.signIn(email, pwd);
                  if (result.error) {
                    alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°: ' + (result.error.message || result.error));
                    setStatus('offline');
                    return;
                  }
                  setCloudUser(result.user);
                }
                setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'online');
                // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿Ð¾ÑÐ»Ðµ sign-in
                const loadedProducts = Array.isArray(U.lsGet('heys_products', []))
                  ? U.lsGet('heys_products', [])
                  : [];
                setProducts(loadedProducts);
                setSyncVer((v) => v + 1);
              } catch (e) {
                setStatus('offline');
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°: ' + (e && e.message ? e.message : e));
              }
            }
            async function doSignOut() {
              try {
                if (cloud && typeof cloud.signOut === 'function') await cloud.signOut();
              } catch (e) {}
              setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline');
              setProducts([]);
              setSyncVer((v) => v + 1);
            }

            return React.createElement(
              React.Fragment,
              null,
              gate,
              React.createElement(
                'div',
                { className: 'wrap' },
                React.createElement(
                  'div',
                  { className: 'hdr' },
                  React.createElement('div', null, 'HEYS â€” Ð¿Ð°Ð½ÐµÐ»ÑŒ ÐºÑƒÑ€Ð°Ñ‚Ð¾Ñ€Ð°'),
                  ONE_CURATOR_MODE
                    ? React.createElement(
                        'div',
                        { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                        React.createElement(
                          'span',
                          { className: 'status ' + (status === 'online' ? 'ok' : 'err') },
                          'cloud: ' + String(status || ''),
                        ),
                        window.HEYS.analyticsUI
                          ? React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                          : null,
                      )
                    : React.createElement(
                        'div',
                        { className: 'login' },
                        React.createElement('input', {
                          placeholder: 'email',
                          value: email,
                          onChange: (e) => setEmail(e.target.value),
                        }),
                        React.createElement('input', {
                          placeholder: 'Ð¿Ð°Ñ€Ð¾Ð»ÑŒ',
                          type: 'password',
                          value: pwd,
                          onChange: (e) => setPwd(e.target.value),
                        }),
                        React.createElement(
                          'button',
                          { className: 'btn', onClick: doSignIn },
                          'Ð’Ð¾Ð¹Ñ‚Ð¸',
                        ),
                        React.createElement(
                          'button',
                          { className: 'btn secondary', onClick: doSignOut },
                          'Ð’Ñ‹Ð¹Ñ‚Ð¸',
                        ),
                        React.createElement(
                          'span',
                          { className: 'status ' + (status === 'online' ? 'ok' : 'err') },
                          String(status || ''),
                        ),
                        window.HEYS.analyticsUI
                          ? React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                          : null,
                      ),
                  React.createElement(
                    'div',
                    { className: 'row' },
                    clientId
                      ? React.createElement(
                          React.Fragment,
                          null,
                          React.createElement(
                            'span',
                            { className: 'muted', style: { marginRight: 8 } },
                            'ÐšÐ»Ð¸ÐµÐ½Ñ‚:',
                          ),
                          React.createElement(
                            'span',
                            { style: { fontWeight: 600, marginRight: 8 } },
                            clients.find((c) => c.id === clientId)?.name || clientId,
                          ),
                          React.createElement(
                            'button',
                            {
                              className: 'btn',
                              onClick: () => {
                                // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
                                localStorage.removeItem('heys_client_current');
                                window.HEYS = window.HEYS || {};
                                window.HEYS.currentClientId = null;
                                setClientId('');
                                console.log('[HEYS] ðŸ”„ Client selection cleared, showing selector');
                              },
                            },
                            'Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ',
                          ),
                        )
                      : null,
                  ),
                  clientId
                    ? React.createElement(
                        'div',
                        {
                          className: 'row',
                          style: {
                            marginTop: 8,
                            flexWrap: 'wrap',
                            gap: 8,
                            alignItems: 'center',
                          },
                        },
                        React.createElement(
                          'button',
                          {
                            className: 'btn',
                            onClick: handleManualBackup,
                            disabled: backupBusy,
                          },
                          backupBusy ? 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼â€¦' : 'Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿',
                        ),
                        React.createElement(
                          'button',
                          {
                            className: 'btn',
                            onClick: handleExportBackup,
                            disabled: backupBusy,
                          },
                          'Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ .json',
                        ),
                        React.createElement(
                          'button',
                          { className: 'btn secondary', onClick: handleRestoreProducts },
                          'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹',
                        ),
                        React.createElement(
                          'button',
                          { className: 'btn secondary', onClick: handleRestoreAll },
                          'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²ÑÑ‘',
                        ),
                        React.createElement(
                          'span',
                          { className: 'muted', style: { marginLeft: 'auto' } },
                          backupMeta
                            ? `ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð±ÑÐºÐ°Ð¿: ${formatBackupTime(backupMeta)}`
                            : 'Ð‘ÑÐºÐ°Ð¿ ÐµÑ‰Ñ‘ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»ÑÑ',
                        ),
                      )
                    : null,
                ),
                React.createElement(
                  'div',
                  { className: 'tabs' },
                  React.createElement(
                    'div',
                    {
                      className: 'tab ' + (tab === 'ration' ? 'active' : ''),
                      onClick: () => setTab('ration'),
                    },
                    'Ð Ð°Ñ†Ð¸Ð¾Ð½',
                  ),
                  React.createElement(
                    'div',
                    {
                      className: 'tab ' + (tab === 'day' ? 'active' : ''),
                      onClick: () => setTab('day'),
                    },
                    'Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð´Ð½Ñ',
                  ),
                  React.createElement(
                    'div',
                    {
                      className: 'tab ' + (tab === 'reports' ? 'active' : ''),
                      onClick: () => {
                        if (
                          window.HEYS &&
                          window.HEYS.Day &&
                          typeof window.HEYS.Day.requestFlush === 'function'
                        ) {
                          try {
                            window.HEYS.Day.requestFlush();
                          } catch (error) {}
                        }
                        setTab('reports');
                        setReportsRefresh(Date.now());
                      },
                    },
                    'ÐžÑ‚Ñ‡Ñ‘Ñ‚Ð½Ð¾ÑÑ‚ÑŒ',
                  ),
                  React.createElement(
                    'div',
                    {
                      className: 'tab ' + (tab === 'user' ? 'active' : ''),
                      onClick: () => setTab('user'),
                    },
                    'Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ',
                  ),
                  React.createElement(
                    'div',
                    {
                      className: 'tab ' + (tab === 'analytics' ? 'active' : ''),
                      onClick: () => setTab('analytics'),
                    },
                    'ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°',
                  ),
                ),
                tab === 'ration'
                  ? React.createElement(RationTabWithCloudSync, {
                      key: 'ration' + syncVer + '_' + String(clientId || ''),
                      products,
                      setProducts,
                      clientId,
                    })
                  : tab === 'day'
                    ? React.createElement(DayTabWithCloudSync, {
                        key: 'day' + syncVer + '_' + String(clientId || ''),
                        products,
                        clientId,
                      })
                    : tab === 'user'
                      ? React.createElement(UserTabWithCloudSync, {
                          key: 'user' + syncVer + '_' + String(clientId || ''),
                          clientId,
                        })
                      : tab === 'analytics'
                        ? React.createElement(AnalyticsTab, {
                            key: 'analytics' + syncVer,
                          })
                        : window.HEYS && window.HEYS.ReportsTab
                          ? React.createElement(window.HEYS.ReportsTab, {
                              key:
                                'reports' +
                                syncVer +
                                '_' +
                                String(clientId || '') +
                                '_' +
                                reportsRefresh,
                              products,
                            })
                          : React.createElement(
                              'div',
                              { className: 'muted', style: { padding: 24 } },
                              'â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð° Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²...',
                            ),
              ),
            );
          }
          const root = ReactDOM.createRoot(document.getElementById('root'));
          root.render(React.createElement(App));
        }

        // Start initialization
        initializeApp();
      })();
    </script>
  </body>
</html>
