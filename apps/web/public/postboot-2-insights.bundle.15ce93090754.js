
/* ===== insights/pi_constants.js ===== */
(function () {
  if (typeof window === 'undefined') return;

  const HEYS = (window.HEYS = window.HEYS || {});
  HEYS.InsightsPI = HEYS.InsightsPI || {};

  // –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤–∫–ª—é—á—ë–Ω –¥–≤–∞–∂–¥—ã)
  const piConst = (window.piConst || HEYS.InsightsPI.constants || {});

  const CONFIG = piConst.CONFIG || {
    DEFAULT_DAYS: 60,
    MIN_DAYS_FOR_INSIGHTS: 3,
    MIN_DAYS_FOR_FULL_ANALYSIS: 7,
    MIN_CORRELATION_DISPLAY: 0.35,
    CACHE_TTL_MS: 5 * 60 * 1000,
    VERSION: '4.3.0'
  };

  // === –°–ò–°–¢–ï–ú–ê –ü–†–ò–û–†–ò–¢–ï–¢–û–í –ò –ö–†–ò–¢–ï–†–ò–ï–í ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ pi_constants.js

  const PRIORITY_LEVELS = piConst.PRIORITY_LEVELS || {
    CRITICAL: { level: 1, name: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', emoji: 'üî¥', color: '#ef4444', description: '–¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.' },
    HIGH: { level: 2, name: '–í—ã—Å–æ–∫–∏–π', emoji: 'üü†', color: '#f97316', description: '–í–∞–∂–Ω–æ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π.' },
    MEDIUM: { level: 3, name: '–°—Ä–µ–¥–Ω–∏–π', emoji: 'üü°', color: '#eab308', description: '–ü–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.' },
    LOW: { level: 4, name: '–ù–∏–∑–∫–∏–π', emoji: 'üü¢', color: '#22c55e', description: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.' },
    INFO: { level: 5, name: '–°–ø—Ä–∞–≤–æ—á–Ω—ã–π', emoji: 'üîµ', color: '#3b82f6', description: '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.' }
  };

  const CATEGORIES = piConst.CATEGORIES || {
    METABOLISM: { id: 'metabolism', name: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', emoji: 'üî•', color: '#f97316', description: '–ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é' },
    NUTRITION: { id: 'nutrition', name: '–ü–∏—Ç–∞–Ω–∏–µ', emoji: 'üçΩÔ∏è', color: '#22c55e', description: '–ö–∞—á–µ—Å—Ç–≤–æ –∏ —Å–æ—Å—Ç–∞–≤ –ø–∏—Ç–∞–Ω–∏—è' },
    TIMING: { id: 'timing', name: '–¢–∞–π–º–∏–Ω–≥', emoji: '‚è∞', color: '#8b5cf6', description: '–ö–æ–≥–¥–∞ –µ—Å—Ç—å –∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å' },
    RECOVERY: { id: 'recovery', name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', emoji: 'üò¥', color: '#6366f1', description: '–°–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –æ—Ç–¥—ã—Ö' },
    RISK: { id: 'risk', name: '–†–∏—Å–∫–∏', emoji: '‚ö†Ô∏è', color: '#ef4444', description: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º' },
    PREDICTION: { id: 'prediction', name: '–ü—Ä–æ–≥–Ω–æ–∑—ã', emoji: 'üîÆ', color: '#a855f7', description: '–ß—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ' },
    PATTERNS: { id: 'patterns', name: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', emoji: 'üß¨', color: '#ec4899', description: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏' },
    COMPOSITE: { id: 'composite', name: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ', emoji: 'üìä', color: '#14b8a6', description: '–°–≤–æ–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏' },
    STATISTICS: { id: 'statistics', name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', emoji: 'üìà', color: '#64748b', description: '–ù–∞—É—á–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã' }
  };

  // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è actionability (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ pi_constants.js)
  const ACTIONABILITY = piConst.ACTIONABILITY || {
    IMMEDIATE: { level: 1, name: '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ', emoji: '‚ö°', description: '–ú–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å' },
    TODAY: { level: 2, name: '–°–µ–≥–æ–¥–Ω—è', emoji: 'üìÖ', description: '–í–ª–∏—è–µ—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è' },
    WEEKLY: { level: 3, name: '–ù–µ–¥–µ–ª—è', emoji: 'üìÜ', description: '–¢—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π' },
    LONG_TERM: { level: 4, name: '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ', emoji: 'üéØ', description: '–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' },
    INFORMATIONAL: { level: 5, name: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ', emoji: '‚ÑπÔ∏è', description: '–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è' }
  };

  // === API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ ===

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ –º–µ—Ç—Ä–∏–∫–∏
   * @param {string} key - –∫–ª—é—á –∏–∑ SCIENCE_INFO
   * @returns {Object} { priority, category, actionability, impactScore, whyImportant, ... }
   */
  function getMetricPriority(key) {
    const info = SCIENCE_INFO[key];
    if (!info) return null;

    const priorityLevel = PRIORITY_LEVELS[info.priority] || PRIORITY_LEVELS.INFO;
    const category = CATEGORIES[info.category] || CATEGORIES.STATISTICS;
    const actionability = ACTIONABILITY[info.actionability] || ACTIONABILITY.INFORMATIONAL;

    return {
      key,
      name: info.name,
      priority: info.priority || 'INFO',
      priorityLevel: priorityLevel.level,
      priorityName: priorityLevel.name,
      priorityEmoji: priorityLevel.emoji,
      priorityColor: priorityLevel.color,
      category: info.category || 'STATISTICS',
      categoryName: category.name,
      categoryEmoji: category.emoji,
      categoryColor: category.color,
      actionability: info.actionability || 'INFORMATIONAL',
      actionabilityLevel: actionability.level,
      actionabilityName: actionability.name,
      actionabilityEmoji: actionability.emoji,
      impactScore: info.impactScore || 0,
      whyImportant: info.whyImportant || '',
      source: info.source,
      pmid: info.pmid,
      sources: info.sources,
      url: info.url
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –∏ impact score
   * @returns {Array} –º–∞—Å—Å–∏–≤ –º–µ—Ç—Ä–∏–∫ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   */
  function getAllMetricsByPriority() {
    const metrics = [];
    for (const key of Object.keys(SCIENCE_INFO)) {
      const priority = getMetricPriority(key);
      if (priority) metrics.push(priority);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ priorityLevel (1=CRITICAL —Å–Ω–∞—á–∞–ª–∞), –∑–∞—Ç–µ–º –ø–æ impactScore (–≤—ã—à–µ = –≤–∞–∂–Ω–µ–µ)
    return metrics.sort((a, b) => {
      if (a.priorityLevel !== b.priorityLevel) {
        return a.priorityLevel - b.priorityLevel;
      }
      return b.impactScore - a.impactScore;
    });
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * @param {string} category - –∫–ª—é—á –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (METABOLISM, NUTRITION, etc)
   * @returns {Array} –º–∞—Å—Å–∏–≤ –º–µ—Ç—Ä–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   */
  function getMetricsByCategory(category) {
    return getAllMetricsByPriority().filter(m => m.category === category);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ actionability
   * @param {string} actionability - IMMEDIATE, TODAY, WEEKLY, etc
   * @returns {Array} –º–∞—Å—Å–∏–≤ –º–µ—Ç—Ä–∏–∫
   */
  function getMetricsByActionability(actionability) {
    return getAllMetricsByPriority().filter(m => m.actionability === actionability);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ CRITICAL –∏ HIGH priority –º–µ—Ç—Ä–∏–∫–∏
   * @returns {Array} –º–∞—Å—Å–∏–≤ –≤–∞–∂–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
   */
  function getCriticalMetrics() {
    return getAllMetricsByPriority().filter(m =>
      m.priority === 'CRITICAL' || m.priority === 'HIGH'
    );
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
   * @returns {Object} { total, byPriority, byCategory, byActionability }
   */
  function getPriorityStats() {
    const all = getAllMetricsByPriority();

    const byPriority = {};
    const byCategory = {};
    const byActionability = {};

    for (const m of all) {
      byPriority[m.priority] = (byPriority[m.priority] || 0) + 1;
      byCategory[m.category] = (byCategory[m.category] || 0) + 1;
      byActionability[m.actionability] = (byActionability[m.actionability] || 0) + 1;
    }

    return {
      total: all.length,
      avgImpactScore: all.length > 0
        ? Math.round(all.reduce((s, m) => s + m.impactScore, 0) / all.length * 100) / 100
        : 0,
      byPriority,
      byCategory,
      byActionability
    };
  }

  // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–ö–¶–ò–ô UI ===
  // pi_constants.js ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —ç—Ç–∏—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç
  const SECTIONS_CONFIG = {
    STATUS_SCORE: { id: 'status_score', component: 'StatusScoreCard', priority: 'CRITICAL', dynamicPriority: true, order: 1, alwaysShow: true, title: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å', icon: 'üéØ' },
    CRASH_RISK: { id: 'crash_risk', component: 'MetabolicQuickStatus', priority: 'CRITICAL', dynamicPriority: true, order: 2, alwaysShow: true, title: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞', icon: '‚ö†Ô∏è' },
    PRIORITY_ACTIONS: { id: 'priority_actions', component: 'PriorityActions', priority: 'CRITICAL', dynamicPriority: true, order: 3, alwaysShow: true, title: '–î–µ–π—Å—Ç–≤–∏—è —Å–µ–π—á–∞—Å', icon: '‚ö°' },
    PREDICTIVE_DASHBOARD: { id: 'predictive_dashboard', component: 'PredictiveDashboard', priority: 'HIGH', order: 10, title: '–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è', icon: 'üîÆ' },
    ADVANCED_ANALYTICS: { id: 'advanced_analytics', component: 'AdvancedAnalyticsCard', priority: 'HIGH', order: 11, title: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞', icon: 'üìä' },
    METABOLISM: { id: 'metabolism', component: 'MetabolismSection', priority: 'HIGH', order: 12, title: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', icon: 'üî•' },
    MEAL_TIMING: { id: 'meal_timing', component: 'MealTimingCard', priority: 'HIGH', order: 13, title: '–¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤', icon: '‚è∞' },
    WHAT_IF: { id: 'what_if', component: 'WhatIfSection', priority: 'MEDIUM', order: 20, title: '–ß—Ç–æ –µ—Å–ª–∏...', icon: 'üéØ' },
    PATTERNS: { id: 'patterns', component: 'PatternsList', priority: 'MEDIUM', order: 21, title: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', icon: 'üîç' },
    WEIGHT_PREDICTION: { id: 'weight_prediction', component: 'WeightPrediction', priority: 'MEDIUM', order: 22, title: '–ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞', icon: '‚öñÔ∏è' },
    WEEKLY_WRAP: { id: 'weekly_wrap', component: 'WeeklyWrap', priority: 'LOW', order: 30, title: '–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏', icon: 'üìã' },
    DATA_COMPLETENESS: { id: 'data_completeness', component: 'DataCompletenessCard', priority: 'LOW', order: 31, title: '–ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', icon: 'üìä' }
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ü–∏–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
   */
  function getSortedSections(filterPriority = null) {
    let sections = Object.values(SECTIONS_CONFIG);
    if (filterPriority) sections = sections.filter(s => s.priority === filterPriority);
    return sections.sort((a, b) => a.order - b.order);
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–µ–∫—Ü–∏–∏
   */
  function getSectionPriority(sectionId) {
    const section = Object.values(SECTIONS_CONFIG).find(s => s.id === sectionId);
    if (!section) return null;
    const priorityLevel = PRIORITY_LEVELS[section.priority];
    return {
      ...section,
      priorityLevel: priorityLevel?.level || 5,
      priorityEmoji: priorityLevel?.emoji || 'üîµ',
      priorityColor: priorityLevel?.color || '#3b82f6',
      priorityName: priorityLevel?.name || '–°–ø—Ä–∞–≤–æ—á–Ω—ã–π'
    };
  }

  /**
   * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
   * –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–ª–∏ null (–¥–ª—è fallback –∫ generic)
   */
  const SECTION_PRIORITY_RULES = {
    // 1. –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å (Health Score)
    // –ò–Ω–≤–µ—Ä—Å–∏—è –ª–æ–≥–∏–∫–∏: "–í—Å—ë –æ—Ç–ª–∏—á–Ω–æ" (Score >= 80) –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–∫—Ä—ã–≤–∞—Ç—å—Å—è —Ñ–∏–ª—å—Ç—Ä–æ–º
    STATUS_SCORE: (options) => {
      const { score } = options;
      if (score >= 80) return 'LOW'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      return null; // Fallback to generic thresholds (60/40) + trend + warnings
    },

    // 2. –†–∏—Å–∫ —Å—Ä—ã–≤–∞ (Crash Risk)
    // –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: —á–µ–º –≤—ã—à–µ Score, —Ç–µ–º –•–£–ñ–ï (–≤—ã—à–µ —Ä–∏—Å–∫)
    CRASH_RISK: (options) => {
      const { crashRiskScore, warnings } = options; // score 0-100%
      if (crashRiskScore == null) return 'INFO';

      // 1. –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ % —Ä–∏—Å–∫–∞
      let basePriority = 'LOW';
      if (crashRiskScore >= 60) basePriority = 'CRITICAL';
      else if (crashRiskScore >= 30) basePriority = 'HIGH';
      else if (crashRiskScore >= 15) basePriority = 'MEDIUM';

      // 2. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º warnings (Sleep, Stress, Binge, Caloric)
      // #11 Acuteness decay: –æ—Å—Ç—Ä—ã–µ (short-window) warnings –≤–µ—Å—è—Ç –±–æ–ª—å—à–µ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö
      // decay = max(0.3, 1 - (days - 3) / 27) ‚Üí days=3‚Üí1.0, days=7‚Üí0.85, days=14‚Üí0.59, days=25‚Üí0.3
      const RELEVANT_TYPES = ['SLEEP_DEBT', 'STRESS_ACCUMULATION', 'BINGE_RISK', 'CALORIC_DEBT'];
      const getAcutenessWeight = (w) => {
        const d = typeof w.days === 'number' ? Math.max(3, w.days) : 7;
        return Math.max(0.3, 1 - (d - 3) / 27);
      };
      let warningsBoost = 0;
      let weightedHighSum = 0;
      if (warnings && Array.isArray(warnings)) {
        const relevantWarnings = warnings.filter(w => RELEVANT_TYPES.includes(w.type));
        const highFiltered = relevantWarnings.filter(w => w.severity === 'high');
        weightedHighSum = highFiltered.reduce((sum, w) => sum + getAcutenessWeight(w), 0);

        if (weightedHighSum >= 0.7) warningsBoost = 2; // –û—Å—Ç—Ä–æ–µ high ‚Üí —Å–∏–ª—å–Ω—ã–π boost
        else if (relevantWarnings.length >= 2) warningsBoost = 1; // –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ñ–∞–∫—Ç–æ—Ä–æ–≤
      }

      if (typeof console !== 'undefined' && console.info) {
        console.info('priority / üõ†Ô∏è custom_rule CRASH_RISK:', {
          section: 'CRASH_RISK',
          basePriority,
          weightedHighSum: Math.round(weightedHighSum * 100) / 100,
          warningsBoost,
          rule: 'custom'
        });
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º boost (—É–º–µ–Ω—å—à–∞–µ–º index = –ø–æ–≤—ã—à–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
      const priorityLevels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'];
      let baseIndex = priorityLevels.indexOf(basePriority);
      const finalIndex = Math.max(0, baseIndex - warningsBoost);

      return priorityLevels[finalIndex];
    },

    // 3. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (Priority Actions)
    // –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –°–†–û–ß–ù–´–• –¥–µ–π—Å—Ç–≤–∏–π, –∞ –Ω–µ –æ—Ç –∑–¥–æ—Ä–æ–≤—å—è
    PRIORITY_ACTIONS: (options) => {
      const { urgentActionsCount, actionsCount } = options;

      if (urgentActionsCount >= 3) return 'CRITICAL';
      if (urgentActionsCount >= 1) return 'HIGH';
      if (actionsCount >= 1) return 'MEDIUM';

      return 'LOW'; // –ù–µ—Ç —Å—Ä–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -> –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    }
  };

  /**
   * –í—ã—á–∏—Å–ª–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–µ–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã
   * @param {Object} options - { sectionId, score, trend, warnings, crashRiskScore, urgentActionsCount... }
   * @returns {string} - –æ–¥–∏–Ω –∏–∑: 'CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'
   */
  function computeDynamicPriority(options = {}) {
    const { sectionId, score, trend, warnings, patterns } = options;
    const LOG_PREFIX = 'priority /';

    // üöÄ Step 1: Start
    // (–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–±—Ä–∞–Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –æ—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —à–∞–≥–∏)

    // üõ†Ô∏è Step 1.5: Custom Rules
    if (SECTION_PRIORITY_RULES[sectionId]) {
      const customPriority = SECTION_PRIORITY_RULES[sectionId](options);
      if (customPriority) {
        if (typeof console !== 'undefined' && console.info) {
          console.info(`${LOG_PREFIX} üõ†Ô∏è custom_rule applied`, { section: sectionId, priority: customPriority });
        }
        return customPriority;
      }
    }

    // üì• Step 2: Input (Generic Fallback)
    if (typeof console !== 'undefined' && console.info) {
      console.info(`${LOG_PREFIX} üì• input (generic):`, {
        section: sectionId,
        score,
        trend7d: trend,
        warningsCount: warnings ? warnings.length : 0,
        highWarnings: warnings ? warnings.filter(w => w.severity === 'high').length : 0
      });
    }

    // Fallback –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
    const section = SECTIONS_CONFIG[sectionId];
    if (!section || !section.dynamicPriority || score == null) {
      if (typeof console !== 'undefined' && console.info) {
        console.info(`${LOG_PREFIX} ‚ö†Ô∏è fallback:`, {
          section: sectionId,
          score,
          hasSection: !!section,
          dynamicPriority: !!section?.dynamicPriority,
          resolvedPriority: section?.priority || 'INFO'
        });
      }
      return section?.priority || 'INFO';
    }

    // üßÆ Step 3: Compute ‚Äî 1. –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ Health Score (0-100)
    let basePriority = 'INFO';
    if (score >= 80) basePriority = 'LOW';
    else if (score >= 60) basePriority = 'MEDIUM';
    else if (score >= 40) basePriority = 'HIGH';
    else basePriority = 'CRITICAL';

    // 2. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ —Ç—Ä–µ–Ω–¥—É (–ø–∞–¥–µ–Ω–∏–µ score –∑–∞ 7 –¥–Ω–µ–π)
    let trendBoost = 0;
    if (trend != null && trend < 0) {
      const decline = Math.abs(trend);
      if (decline >= 20) trendBoost = 2; // —Ä–µ–∑–∫–æ–µ –ø–∞–¥–µ–Ω–∏–µ ‚Üí –º–∏–Ω–∏–º—É–º HIGH
      else if (decline >= 10) trendBoost = 1; // —É—Å—Ç–æ–π—á–∏–≤–æ–µ –ø–∞–¥–µ–Ω–∏–µ ‚Üí +1 —É—Ä–æ–≤–µ–Ω—å
    }

    // 3. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ Early Warnings
    let warningsBoost = 0;
    if (warnings && Array.isArray(warnings)) {
      const highCount = warnings.filter(w => w.severity === 'high').length;
      const hasChronicHigh = warnings.some(w => w.severity === 'high' && w.criticalPriority);

      if (highCount >= 3 || hasChronicHigh) warningsBoost = 3; // >=3 high warnings ‚Üí CRITICAL
      else if (highCount >= 1) warningsBoost = 2; // –µ—Å—Ç—å high warnings ‚Üí –º–∏–Ω–∏–º—É–º HIGH
    }

    // 4. #12 Pattern Degradation boost
    // –ï—Å–ª–∏ ‚â•2 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å score < 40 (–¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è) ‚Üí +1 –∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
    let patternDegradationBoost = 0;
    if (patterns && Array.isArray(patterns)) {
      const degradedCount = patterns.filter(
        p => p.available === true && typeof p.score === 'number' && p.score < 40
      ).length;
      if (degradedCount >= 2) {
        patternDegradationBoost = 1;
      }
    }

    // 5. –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π boost (–º–µ–Ω—å—à–∏–π level = –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    const priorityLevels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'];
    let baseIndex = priorityLevels.indexOf(basePriority);

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π boost (—É–º–µ–Ω—å—à–∞–µ–º index = –ø–æ–≤—ã—à–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    const maxBoost = Math.max(trendBoost, warningsBoost, patternDegradationBoost);
    const finalIndex = Math.max(0, baseIndex - maxBoost);
    const finalPriority = priorityLevels[finalIndex];

    // üßÆ Step 3: Compute (result summary)
    if (typeof console !== 'undefined' && console.info) {
      console.info(`${LOG_PREFIX} üßÆ compute (generic):`, {
        section: sectionId,
        basePriority,
        trendBoost,
        warningsBoost,
        patternDegradationBoost,
        maxBoost,
        finalIndex,
        computation: `base=${basePriority}[${baseIndex}] ‚Üí boost=${maxBoost} (t:${trendBoost}+w:${warningsBoost}+pd:${patternDegradationBoost}) ‚Üí final[${finalIndex}]`
      });
    }

    // ‚úÖ Step 4: Result
    if (typeof console !== 'undefined' && console.info) {
      console.info(`${LOG_PREFIX} ‚úÖ result (generic):`, {
        section: sectionId,
        score,
        trend7d: trend,
        highWarnings: warnings ? warnings.filter(w => w.severity === 'high').length : 0,
        degradedPatterns: patterns ? patterns.filter(p => p.available && typeof p.score === 'number' && p.score < 40).length : 0,
        resolvedPriority: finalPriority,
        rule: 'generic',
        reason: `score:${basePriority} + trend:${trendBoost > 0 ? `+${trendBoost}` : '0'} + ews:${warningsBoost > 0 ? `+${warningsBoost}` : '0'} + pd:${patternDegradationBoost > 0 ? `+${patternDegradationBoost}` : '0'}`
      });
    }

    return finalPriority;
  }

  /**
   * Context-specific labels –¥–ª—è Priority Badge
   * –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ–≥–¥–∞ badge –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è health-—Å–µ–∫—Ü–∏–π —Å —Ö–æ—Ä–æ—à–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
   */
  const PRIORITY_CONTEXT_LABELS = {
    STATUS_SCORE: {
      INFO: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
      LOW: '–í—Å—ë –æ—Ç–ª–∏—á–Ω–æ',
      MEDIUM: '–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ',
      HIGH: '–í–∞–∂–Ω–æ',
      CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'
    },
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–µ–∫—Ü–∏–π
    CRASH_RISK: {
      INFO: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∏—Å–∫–∞',
      LOW: '–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫',
      MEDIUM: '–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫',
      HIGH: '–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫',
      CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫'
    },
    // Context labels –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    PRIORITY_ACTIONS: {
      INFO: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
      LOW: '–ù–µ—Ç —Å—Ä–æ—á–Ω—ã—Ö',
      MEDIUM: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
      HIGH: '–í–Ω–∏–º–∞–Ω–∏–µ!',
      CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ üî•'
    }
  };

  // === –ù–ê–£–ß–ù–´–ï –°–ü–†–ê–í–ö–ò –î–õ–Ø UI ===
  // –ö–ª—é—á–∏ –≤ UPPERCASE –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å infoKey –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
  // –¢–µ–ø–µ—Ä—å —Å priority, category –∏ actionability
  const SCIENCE_INFO = {
    // TEF ‚Äî –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç TDEE
    TEF: {
      name: '–¢–µ—Ä–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç –ø–∏—â–∏ (TEF)',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —ç–Ω–µ—Ä–≥–∏–∏ —É—Ö–æ–¥–∏—Ç –Ω–∞ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ. –ë–æ–ª—å—à–µ –±–µ–ª–∫–∞ ‚Äî –æ–±—ã—á–Ω–æ –≤—ã—à–µ —Ä–∞—Å—Ö–æ–¥.',
      details: 'TEF –æ—Ç—Ä–∞–∂–∞–µ—Ç ¬´—Ü–µ–Ω—É¬ª –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏—è –ø–∏—â–∏: —Ä–∞–∑–Ω—ã–µ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ —É—Å–≤–æ–µ–Ω–∏–µ. –ë–µ–ª–æ–∫ –¥–∞—ë—Ç –Ω–∞–∏–±–æ–ª—å—à–∏–π —Ç–µ—Ä–º–∏—á–µ—Å–∫–∏–π –≤–∫–ª–∞–¥, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–∞–ª–æ—Ä–∏—è—Ö —Ä–∞—Ü–∏–æ–Ω —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –±–µ–ª–∫–æ–º –æ–±—ã—á–Ω–æ —É–ª—É—á—à–∞–µ—Ç —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç–∞. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–ª–µ–∑–Ω–∞ –Ω–µ –¥–ª—è –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞, –∞ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –æ–±—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞—Ü–∏–æ–Ω–∞ –∑–∞ –¥–µ–Ω—å. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –∞—Ä–≥—É–º–µ–Ω—Ç –≤ –ø–æ–ª—å–∑—É —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –±–µ–ª–∫–∞ –∏ —É–º–µ—Ä–µ–Ω–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.',
      formula: 'TEF = (–ë–µ–ª–æ–∫ √ó 4 √ó 0.25) + (–£–≥–ª–µ–≤–æ–¥—ã √ó 4 √ó 0.075) + (–ñ–∏—Ä—ã √ó 9 √ó 0.015)',
      source: 'Westerterp, 2004; Tappy, 1996',
      sources: [{ pmid: '15507147', level: 'A', title: 'Westerterp, 2004 ‚Äî Meta-analysis diet-induced thermogenesis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.93,
      interpretation: '8-12% –æ—Ç –∫–∞–ª–æ—Ä–∞–∂–∞ ‚Äî –Ω–æ—Ä–º–∞. >12% ‚Äî –æ—Ç–ª–∏—á–Ω–æ (–º–Ω–æ–≥–æ –±–µ–ª–∫–∞). <8% ‚Äî –º–∞–ª–æ –±–µ–ª–∫–∞ –≤ —Ä–∞—Ü–∏–æ–Ω–µ.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'TODAY',
      impactScore: 0.75,
      whyImportant: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∫–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π —É—Ö–æ–¥–∏—Ç –Ω–∞ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ. –ë–æ–ª—å—à–µ –±–µ–ª–∫–∞ = –≤—ã—à–µ TEF = –ª–µ–≥—á–µ –¥–µ—Ñ–∏—Ü–∏—Ç.'
    },
    // EPOC ‚Äî –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –±–æ–Ω—É—Å –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    EPOC: {
      name: '–î–æ–∂–∏–≥ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (EPOC)',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –∑–∞–º–µ—Ç–Ω—ã–π –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.',
      details: 'EPOC ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç, –∫–æ–≥–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≥–æ–º–µ–æ—Å—Ç–∞–∑ –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–∫–∏. –í –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –ø–ª–∞–Ω–µ —ç—Ç–æ ¬´–±–æ–Ω—É—Å¬ª –∫ —Ä–∞—Å—Ö–æ–¥—É, –∫–æ—Ç–æ—Ä—ã–π —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –±–æ–ª–µ–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏. –ù–æ EPOC –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –±–∞–∑–æ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Ä–µ–∂–∏–º, –ø–∏—Ç–∞–Ω–∏–µ, —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å): —ç—Ç–æ –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞, –∞ –Ω–µ –≥–ª–∞–≤–Ω—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –∏ –Ω–µ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –æ–¥–Ω–æ–π —Ç—è–∂—ë–ª–æ–π —Å–µ—Å—Å–∏–∏.',
      formula: 'EPOC = –ö–∞–ª–æ—Ä–∏–∏_—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ √ó (0.06 + intensity √ó 0.09)\nIntensity = % –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–æ–Ω–∞—Ö 3-4',
      source: 'LaForgia et al., 2006',
      sources: [{ pmid: '16825252', level: 'A', title: 'LaForgia et al., 2006 ‚Äî Systematic review EPOC' }],
      evidenceLevel: 'A',
      confidenceScore: 0.90,
      interpretation: '+6-15% –∫ –∑–∞—Ç—Ä–∞—Ç–∞–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü—Ä–∏ HIIT —ç—Ñ—Ñ–µ–∫—Ç —Å–∏–ª—å–Ω–µ–µ –∏ –¥–æ–ª—å—à–µ (–¥–æ 24—á).',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'TODAY',
      impactScore: 0.45,
      whyImportant: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–æ–Ω—É—Å–Ω–æ–µ —Å–∂–∏–≥–∞–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. HIIT –¥–∞—ë—Ç –±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç.'
    },
    // –ì–æ—Ä–º–æ–Ω—ã ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, –≤–ª–∏—è–µ—Ç –Ω–∞ –≥–æ–ª–æ–¥ –∏ —Å—Ä—ã–≤—ã
    HORMONES: {
      name: '–ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (–ì—Ä–µ–ª–∏–Ω/–õ–µ–ø—Ç–∏–Ω)',
      short: '–ù–µ–¥–æ—Å—ã–ø —É—Å–∏–ª–∏–≤–∞–µ—Ç —á—É–≤—Å—Ç–≤–æ –≥–æ–ª–æ–¥–∞ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏. –≠—Ç–æ –Ω–µ ¬´—Å–ª–∞–±–∞—è —Å–∏–ª–∞ –≤–æ–ª–∏¬ª, –∞ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞.',
      details: '–ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ —Å–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–º –ø–æ–≤—ã—à–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –≥–æ–ª–æ–¥–∞ (–≥—Ä–µ–ª–∏–Ω) –∏ –æ—Å–ª–∞–±–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –Ω–∞—Å—ã—â–µ–Ω–∏—è (–ª–µ–ø—Ç–∏–Ω). –ü–æ—ç—Ç–æ–º—É –ø—Ä–∏ –Ω–µ–¥–æ—Å—ã–ø–µ —Ç—è–≥–∞ –∫ –∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –µ–¥–µ —Ä–∞—Å—Ç—ë—Ç –¥–∞–∂–µ —É –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª—é–¥–µ–π. –≠—Ç–æ –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è —Ç–∞–∫—Ç–∏–∫–∏: –≤ –¥–Ω–∏ –ø–ª–æ—Ö–æ–≥–æ —Å–Ω–∞ —Ä–∞–∑—É–º–Ω–µ–µ –∑–∞—Ä–∞–Ω–µ–µ —É—Å–∏–ª–∏—Ç—å –±–µ–ª–æ–∫/–∫–ª–µ—Ç—á–∞—Ç–∫—É –∏ —Å–Ω–∏–∑–∏—Ç—å –ø–∏—â–µ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ–±—ä—è—Å–Ω–∏—Ç—å ¬´–ø–æ—á–µ–º—É —Å–æ—Ä–≤–∞–ª–æ¬ª —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –∏ –ø—Ä–∏–Ω—è—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ —Ä–µ—à–µ–Ω–∏—è –±–µ–∑ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∏.',
      formula: 'sleepDebt = sleepNorm - actualSleep\n–ï—Å–ª–∏ sleepDebt ‚â• 2—á:\n  ghrelinIncrease = 15 + (sleepDebt - 2) √ó 6.5\n  leptinDecrease = 10 + (sleepDebt - 2) √ó 4',
      source: 'Spiegel et al., 2004',
      pmid: '15531540',
      sources: [{ pmid: '15531540', level: 'A', title: 'Spiegel et al., 2004 ‚Äî Meta-analysis sleep deprivation' }],
      evidenceLevel: 'A',
      confidenceScore: 0.95,
      interpretation: '–ù–µ–¥–æ—Å—ã–ø 2—á+ ‚Üí –≥–æ–ª–æ–¥ –ø–æ–≤—ã—à–µ–Ω –Ω–∞ 15-28%. –≠—Ç–æ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—è, –Ω–µ —Å–∏–ª–∞ –≤–æ–ª–∏!',
      priority: 'CRITICAL',
      category: 'RECOVERY',
      actionability: 'TODAY',
      impactScore: 0.90,
      whyImportant: '‚ö° –ù–µ–¥–æ—Å—ã–ø = –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ–¥. –°–∞–º—ã–π —á–∞—Å—Ç—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Å—Ä—ã–≤–æ–≤! –í—ã—Å—ã–ø–∞–π—Å—è –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º.'
    },
    // Adaptive Thermogenesis ‚Äî –í—ã—Å–æ–∫–∏–π, –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
    ADAPTIVE: {
      name: '–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞—Ç—è–∂–Ω–æ–º –∂—ë—Å—Ç–∫–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∏ –ø–æ—á–µ–º—É –≤–∞–∂–Ω—ã –¥–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
      details: '–ü—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–º —Å–Ω–∏–∂–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –∫–∞–∫ –∑–∞—â–∏—Ç–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑. –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø–ª–∞—Ç–æ: —É—Å–∏–ª–∏–π –±–æ–ª—å—à–µ, –∞ –¥–∏–Ω–∞–º–∏–∫–∞ —Å–ª–∞–±–µ–µ. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤–æ–≤—Ä–µ–º—è —É–≤–∏–¥–µ—Ç—å —ç—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –∏ –≤—ã–±—Ä–∞—Ç—å —É–º–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (—Ä–µ—Ñ–∏–¥, –º—è–≥—á–µ –¥–µ—Ñ–∏—Ü–∏—Ç, –≤—ã—à–µ –±–µ–ª–æ–∫, –ª—É—á—à–µ —Å–æ–Ω), –≤–º–µ—Å—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏—è. –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è ‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–≥–æ —ç–∫—Å—Ç—Ä–µ–º—É–º–∞.',
      formula: '–ó–∞ 7 –¥–Ω–µ–π —Å—á–∏—Ç–∞–µ–º –¥–Ω–∏ —Å eaten < BMR √ó 0.70:\n  2-3 –¥–Ω—è: –º–µ—Ç–∞–±–æ–ª–∏–∑–º -4%\n  3-5 –¥–Ω–µ–π: –º–µ—Ç–∞–±–æ–ª–∏–∑–º -8%\n  5+ –¥–Ω–µ–π: –º–µ—Ç–∞–±–æ–ª–∏–∑–º -12%',
      source: 'Rosenbaum & Leibel, 2010',
      sources: [{ pmid: '20107198', level: 'A', title: 'Rosenbaum & Leibel, 2010 ‚Äî Metabolic adaptation review' }],
      evidenceLevel: 'A',
      confidenceScore: 0.92,
      interpretation: '–ü—Ä–∏ –∂—ë—Å—Ç–∫–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è –Ω–∞ 10-15%. Refeed day –ø–æ–º–æ–≥–∞–µ—Ç!',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'WEEKLY',
      impactScore: 0.80,
      whyImportant: '–°–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç = –∞–¥–∞–ø—Ç–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞. Refeed –∫–∞–∂–¥—ã–µ 5-7 –¥–Ω–µ–π —Å–ø–∞—Å–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º.'
    },
    // Circadian ‚Äî –í—ã—Å–æ–∫–∏–π, –≤–ª–∏—è–µ—Ç –Ω–∞ —É—Å–≤–æ–µ–Ω–∏–µ
    CIRCADIAN: {
      name: '–¶–∏—Ä–∫–∞–¥–Ω—ã–π Score',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –±–∏–æ—Ä–∏—Ç–º–∞–º–∏, –≥–¥–µ –¥–Ω–µ–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏ –≤—ã–≥–æ–¥–Ω–µ–µ.',
      details: '–¶–∏—Ä–∫–∞–¥–Ω—ã–π score –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–∫–æ–≥–¥–∞ –≤—ã –µ–¥–∏—Ç–µ¬ª, –∞ –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º—è –ø–∏—Ç–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —Å—É—Ç–æ—á–Ω–æ–π —Ñ–∏–∑–∏–æ–ª–æ–≥–∏–µ–π. –°–º–µ—â–µ–Ω–∏–µ –±–æ–ª—å—à–µ–π –¥–æ–ª–∏ –∫–∞–ª–æ—Ä–∏–π –≤ —Ä–∞–Ω–Ω—é—é —á–∞—Å—Ç—å –¥–Ω—è –æ–±—ã—á–Ω–æ —Å–≤—è–∑–∞–Ω–æ —Å –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π –∏ –ª—É—á—à–∏–º –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º. –í–µ—á–µ—Ä–Ω–∏–µ –ø–µ—Ä–µ–∫–æ—Å—ã –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã —Å–∞–º–∏ –ø–æ —Å–µ–±–µ, –Ω–æ –ø—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–∏ —É—Ö—É–¥—à–∞—é—Ç –æ–±—â—É—é —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å —Ä–∞—Ü–∏–æ–Ω–∞. –ú–µ—Ç—Ä–∏–∫–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –º—è–≥–∫–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —Ä–∏—Ç–º–∞, –∞ –Ω–µ –¥–ª—è –∂—ë—Å—Ç–∫–∏—Ö –∑–∞–ø—Ä–µ—Ç–æ–≤ –ø–æ —á–∞—Å–∞–º.',
      formula: '–í–µ—Å–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏:\n  –£—Ç—Ä–æ (6-12): √ó1.1\n  –î–µ–Ω—å (12-18): √ó1.0\n  –í–µ—á–µ—Ä (18-22): √ó0.9\n  –ù–æ—á—å (22-6): √ó0.7\nScore = Œ£(kcal √ó timeWeight) / totalKcal √ó 100',
      source: 'Garaulet et al., 2013; Jakubowicz et al., 2013',
      pmid: '23512957',
      sources: [{ pmid: '23512957', level: 'B', title: 'Garaulet et al., 2013 ‚Äî RCT circadian timing' }],
      evidenceLevel: 'B',
      confidenceScore: 0.88,
      interpretation: '>85 ‚Äî –æ—Ç–ª–∏—á–Ω–æ (–∫–∞–ª–æ—Ä–∏–∏ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è). <70 ‚Äî –º–Ω–æ–≥–æ –≤–µ—á–µ—Ä–Ω–µ–π –µ–¥—ã.',
      priority: 'HIGH',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.70,
      whyImportant: '–ï–¥–∞ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ª—É—á—à–µ. –í–µ—á–µ—Ä–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–∏ —á–∞—â–µ –∏–¥—É—Ç –≤ –∂–∏—Ä.'
    },
    // Nutrient Timing ‚Äî –°—Ä–µ–¥–Ω–∏–π
    NUTRIENT_TIMING: {
      name: '–¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–¥–∞—á–Ω–æ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –ø—Ä–∏—ë–º –±–µ–ª–∫–∞ –∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ —Å –æ–∫–Ω–∞–º–∏, –≥–¥–µ –æ–Ω–∏ –¥–∞—é—Ç –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏. –≠—Ç–æ –Ω–µ ¬´–º–∞–≥–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ¬ª, –∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–∞–ø—Ä–∏–º–µ—Ä, –±–µ–ª–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –∏ —É–≥–ª–µ–≤–æ–¥—ã –≤–æ–∫—Ä—É–≥ –Ω–∞–≥—Ä—É–∑–∫–∏ –æ–±—ã—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –ª—É—á—à–µ, —á–µ–º —Ö–∞–æ—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. –¢–∞–π–º–∏–Ω–≥ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–µ–Ω –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ—Å—É—Ä—Å–µ –Ω–∞ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω. –¶–µ–ª—å ‚Äî –ø–æ–≤—ã—Å–∏—Ç—å –æ—Ç–¥–∞—á—É –æ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –±–µ–∑ —Ä–∞–¥–∏–∫–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.',
      formula: '–ë–æ–Ω—É—Å—ã:\n  –ë–µ–ª–æ–∫ —É—Ç—Ä–æ–º (–¥–æ 12:00): +10\n  –£–≥–ª–µ–≤–æ–¥—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (¬±2—á): +15\n  –ñ–∏—Ä—ã –≤–µ—á–µ—Ä–æ–º: –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ\nScore = –±–∞–∑–æ–≤—ã–π 50 + —Å—É–º–º–∞ –±–æ–Ω—É—Å–æ–≤',
      source: 'Areta et al., 2013; Aragon & Schoenfeld, 2013',
      sources: [{ pmid: '24477298', level: 'B', title: 'Areta et al., 2013 ‚Äî Protein distribution and MPS' }],
      evidenceLevel: 'B',
      confidenceScore: 0.84,
      interpretation: '>80 ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥. <60 ‚Äî –µ—Å—Ç—å —á—Ç–æ —É–ª—É—á—à–∏—Ç—å.',
      priority: 'MEDIUM',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.55,
      whyImportant: '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥ –º–∞–∫—Ä–æ—Å–æ–≤ —É–ª—É—á—à–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —Å–∏–Ω—Ç–µ–∑ –º—ã—à—Ü.'
    },
    // Insulin Sensitivity ‚Äî –í—ã—Å–æ–∫–∏–π, –≤–ª–∏—è–µ—Ç –Ω–∞ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ
    INSULIN_SENSITIVITY: {
      name: '–ü—Ä–æ–∫—Å–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–∞–±–æ–ª–∏–∑–º —É—Å—Ç–æ–π—á–∏–≤ –∫ —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ.',
      details: '–≠—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π ¬´–ø–æ–ª–µ–≤–æ–π¬ª –∏–Ω–¥–µ–∫—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤: –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É —Ä–∞—Ü–∏–æ–Ω–∞, –∫–ª–µ—Ç—á–∞—Ç–∫—É, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤ –ø–æ –¥–Ω—é, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —Å–æ–Ω. –í—ã—Å–æ–∫–∏–π score –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—É—é —ç–Ω–µ—Ä–≥–∏—é, –º–µ–Ω—å—à–µ —Ç—è–≥–∏ –∫ —Å–ª–∞–¥–∫–æ–º—É –∏ –±–æ–ª–µ–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Å–∞. –ù–∏–∑–∫–∏–π score –Ω–µ —Ä–∞–≤–µ–Ω –¥–∏–∞–≥–Ω–æ–∑—É, –Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∑–æ–Ω—É —Ä–∏—Å–∫–∞ –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º—è–≥–∫–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –ø—Ä–∏–≤—ã—á–µ–∫ (–±–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏, –º–µ–Ω—å—à–µ –≤–µ—á–µ—Ä–Ω–∏—Ö –±—ã—Å—Ç—Ä—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤, —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å). –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª–∏ –≤–∞–∂–Ω–µ–µ, —á–µ–º –µ–¥–∏–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å.',
      formula: '–§–∞–∫—Ç–æ—Ä—ã:\n  –°—Ä–µ–¥–Ω–∏–π GI <55: +20\n  –ö–ª–µ—Ç—á–∞—Ç–∫–∞ >14–≥/1000–∫–∫–∞–ª: +20\n  –í–µ—á–µ—Ä–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥—ã <30%: +15\n  –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: +15\n  –°–æ–Ω ‚â•7—á: +10\nScore = —Å—É–º–º–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤',
      source: 'Brand-Miller, 2003; Wolever, 1994',
      sources: [{ pmid: '12936919', level: 'A', title: 'Brand-Miller et al., 2003 ‚Äî Glycemic index meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.91,
      interpretation: '>75 ‚Äî —Ö–æ—Ä–æ—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. <50 ‚Äî —Ä–∏—Å–∫ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'WEEKLY',
      impactScore: 0.85,
      whyImportant: '–í—ã—Å–æ–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É = –ª–µ–≥—á–µ —Å–∂–∏–≥–∞—Ç—å –∂–∏—Ä –∏ –Ω–∞–±–∏—Ä–∞—Ç—å –º—ã—à—Ü—ã.'
    },
    // Gut Health ‚Äî –°—Ä–µ–¥–Ω–∏–π, –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
    GUT_HEALTH: {
      name: '–ó–¥–æ—Ä–æ–≤—å–µ –∫–∏—à–µ—á–Ω–∏–∫–∞',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –º–∏–∫—Ä–æ–±–∏–æ–º–∞: –∫–ª–µ—Ç—á–∞—Ç–∫–∞, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∏ –¥–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.',
      details: '–ö–∏—à–µ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî —ç—Ç–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è: —Å—ã—Ç–æ—Å—Ç—å, –∞–ø–ø–µ—Ç–∏—Ç, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Ç—è–≥–µ, –∫–∞—á–µ—Å—Ç–≤–æ —ç–Ω–µ—Ä–≥–∏–∏. –ú–µ—Ç—Ä–∏–∫–∞ –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ —Ñ–∞–∫—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ: –∫–ª–µ—Ç—á–∞—Ç–∫–∞, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–ª—å—Ç—Ä–∞‚Äë–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –µ–¥—ã. –≠—Ñ—Ñ–µ–∫—Ç –æ–±—ã—á–Ω–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–¥–µ–ª—è–º–∏, –ø–æ—ç—Ç–æ–º—É –≤–∞–∂–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —á–µ–º ¬´–∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å¬ª. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –Ω–µ–¥–æ–æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö —Ä—ã—á–∞–≥–æ–≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.',
      formula: '–§–∞–∫—Ç–æ—Ä—ã:\n  –ö–ª–µ—Ç—á–∞—Ç–∫–∞ >25–≥: +30\n  –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ >15 –ø—Ä–æ–¥—É–∫—Ç–æ–≤: +25\n  –§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: +15\n  –ë–µ–∑ —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö: +15',
      source: 'Sonnenburg & Sonnenburg, 2014; Makki et al., 2018',
      sources: [{ pmid: '24336217', level: 'B', title: 'Sonnenburg & Sonnenburg, 2014 ‚Äî Gut microbiome diet impact' }],
      evidenceLevel: 'B',
      confidenceScore: 0.86,
      interpretation: '>75 ‚Äî –∑–¥–æ—Ä–æ–≤—ã–π –º–∏–∫—Ä–æ–±–∏–æ–º. <50 ‚Äî –¥–æ–±–∞–≤—å –∫–ª–µ—Ç—á–∞—Ç–∫—É –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ.',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'LONG_TERM',
      impactScore: 0.50,
      whyImportant: '–ó–¥–æ—Ä–æ–≤—ã–π –∫–∏—à–µ—á–Ω–∏–∫ = –ª—É—á—à–µ–µ —É—Å–≤–æ–µ–Ω–∏–µ, –∏–º–º—É–Ω–∏—Ç–µ—Ç, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.'
    },
    // Status Score ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, –≥–ª–∞–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞
    STATUS_SCORE: {
      name: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å 0-100',
      short: '–ì–ª–∞–≤–Ω—ã–π —Å–≤–æ–¥–Ω—ã–π –±–∞–ª–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: —á–µ–º –≤—ã—à–µ, —Ç–µ–º –ª–µ–≥—á–µ –¥–µ—Ä–∂–∞—Ç—å –∫—É—Ä—Å –Ω–∞ —Ü–µ–ª—å.',
      details: '–°—Ç–∞—Ç—É—Å ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ ¬´–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã¬ª –Ω–∞ —Ç–µ–∫—É—â–∏–µ —Å—É—Ç–∫–∏: –ø–∏—Ç–∞–Ω–∏–µ, —Ç–∞–π–º–∏–Ω–≥, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ, –∞ –Ω–µ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏. –í—ã—Å–æ–∫–∏–π –±–∞–ª–ª –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —É—Å–ª–æ–≤–∏—è –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ/—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è/–∫–æ–Ω—Ç—Ä–æ–ª—å –∞–ø–ø–µ—Ç–∏—Ç–∞) –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ. –ù–∏–∑–∫–∏–π –±–∞–ª–ª —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π: –Ω–µ–¥–æ—Å—ã–ø, —Å—Ç—Ä–µ—Å—Å, –¥–∏—Å–±–∞–ª–∞–Ω—Å —Ä–∞—Ü–∏–æ–Ω–∞, –æ—à–∏–±–∫–∏ —Ç–∞–π–º–∏–Ω–≥–∞. –°–º—ã—Å–ª –º–µ—Ç—Ä–∏–∫–∏ ‚Äî –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—ã–±—Ä–∞—Ç—å 1‚Äì2 —Ä—ã—á–∞–≥–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º, –∞ –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É.',
      formula: '–û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:\n  ‚Ä¢ –ë–∞–∑–∞: 100 –æ—á–∫–æ–≤\n  ‚Ä¢ –ü–∏—Ç–∞–Ω–∏–µ: ¬±30 (—Å–æ–±–ª—é–¥–µ–Ω–∏–µ –Ω–æ—Ä–º –ë–ñ–£, –∫–∞—á–µ—Å—Ç–≤–æ)\n  ‚Ä¢ –¢–∞–π–º–∏–Ω–≥: ¬±25 (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –µ–¥–æ–π, –≤–æ–ª–Ω—ã)\n  ‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ¬±25 (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —à–∞–≥–∏)\n  ‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: ¬±20 (—Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å)',
      source: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ ACR + –Ω–∞—É—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞',
      sources: [{ pmid: '29754952', level: 'B', title: 'Sutton et al., 2018 ‚Äî Time-restricted feeding composite' }],
      evidenceLevel: 'B',
      confidenceScore: 0.88,
      interpretation: '80-100 ‚Äî –æ–ø—Ç–∏–º—É–º, –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. 60-79 ‚Äî –Ω–æ—Ä–º–∞, –µ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤—ã. <60 ‚Äî –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª–µ–Ω, –æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∏—á–∏–Ω—ã.',
      priority: 'CRITICAL',
      category: 'COMPOSITE',
      actionability: 'IMMEDIATE',
      impactScore: 1.0,
      whyImportant: '‚≠ê –ì–õ–ê–í–ù–ê–Ø –ú–ï–¢–†–ò–ö–ê! –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.'
    },
    // Crash Risk Quick ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å—Ä—ã–≤–æ–≤
    CRASH_RISK_QUICK: {
      name: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞ (—Å–≤–µ—Ç–æ—Ñ–æ—Ä)',
      short: '–ë—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∏—Å–∫–∞ —Å—Ä—ã–≤–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ç—Ä–∏–≥–≥–µ—Ä–∞–º. –ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å—Ç–æ–∏—Ç —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É.',
      details: '–£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Ä–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ –ø—è—Ç–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ñ–∞–∫—Ç–æ—Ä–∞–º –±–µ–∑ –¥–æ–ª–≥–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø–æ–ª–Ω–æ–≥–æ Predictive Risk, —ç—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∑–¥–µ—Å—å-–∏-—Å–µ–π—á–∞—Å, —á—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ä—ã–≤, –Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Å–ª–∞–±–ª–µ–Ω—ã –∏ –ª—É—á—à–µ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å –±–µ–ª–∫–æ–º/–∫–ª–µ—Ç—á–∞—Ç–∫–æ–π, –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ. –ó–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç ‚Äî —Å–∏–≥–Ω–∞–ª, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ä.',
      formula: '–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:\n  ‚Ä¢ –ù–µ–¥–æ—Å—ã–ø (<6—á): +25%\n  ‚Ä¢ –ì–æ–ª–æ–¥–∞–Ω–∏–µ (>5—á): +20%\n  ‚Ä¢ –ù–∏–∑–∫–∏–π –±–µ–ª–æ–∫ (<60–≥): +15%\n  ‚Ä¢ –°—Ç—Ä–µ—Å—Å (>4): +15%\n  ‚Ä¢ –ù–∏–∑–∫–∏–π –∫–∞–ª–æ—Ä–∞–∂ (<70% –Ω–æ—Ä–º—ã): +25%',
      source: '–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å—Ä—ã–≤–æ–≤ (behavioral relapse prevention)',
      sources: [{ pmid: '19179058', level: 'A', title: 'Marlatt & Donovan, 2005 ‚Äî Relapse prevention meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.94,
      interpretation: '–ó–µ–ª—ë–Ω—ã–π ‚Äî –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫, –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ. –ñ—ë–ª—Ç—ã–π ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–π, –æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ. –ö—Ä–∞—Å–Ω—ã–π ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫, –ø—Ä–∏–º–∏ –º–µ—Ä—ã!',
      priority: 'CRITICAL',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.95,
      whyImportant: 'üö® –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ —Å—Ä—ã–≤–µ –î–û —Ç–æ–≥–æ –∫–∞–∫ –æ–Ω —Å–ª—É—á–∏—Ç—Å—è. –ö—Ä–∞—Å–Ω—ã–π = –¥–µ–π—Å—Ç–≤—É–π —Å–µ–π—á–∞—Å!'
    },
    // Health Score ‚Äî –í—ã—Å–æ–∫–∏–π, —Å–≤–æ–¥–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
    HEALTH_SCORE: {
      name: 'Health Score (–æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞)',
      short: '–°–≤–æ–¥–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–∏—è, —Ä–µ–∂–∏–º–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –£–¥–æ–±–Ω—ã–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.',
      details: 'Health Score –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤ –æ–¥–∏–Ω —á–∏—Ç–∞–µ–º—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –¥–Ω—è/–Ω–µ–¥–µ–ª–∏. –ï–≥–æ —Å–∏–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ ¬´–∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç—å¬ª, –∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã: –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ü–µ–ª–∏ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ. –ü–æ —Å–º—ã—Å–ª—É —ç—Ç–æ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∞—è –º–µ—Ç—Ä–∏–∫–∞ ‚Äî –æ–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –Ω–µ–¥–µ–ª–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ –±—ã—Å—Ç—Ä–æ –≤–∏–¥–µ—Ç—å, –≥–¥–µ –ø—Ä–æ—Å–∞–¥–∫–∞, –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–º–µ–¥–ª–∏–ª—Å—è. –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî –ø–æ–≤—ã—à–∞—Ç—å score –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∞ –Ω–µ ¬´—à–ª–∏—Ñ–æ–≤–∞—Ç—å¬ª –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.',
      formula: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤–µ—Å–∞ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ü–µ–ª–∏):\n  –ü–∏—Ç–∞–Ω–∏–µ: 40% (–∫–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã, –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫–∞)\n  –¢–∞–π–º–∏–Ω–≥: 25% (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –≤–æ–ª–Ω—ã, –ø–æ–∑–¥–Ω—è—è –µ–¥–∞)\n  –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 20% (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —à–∞–≥–∏)\n  –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: 15% (—Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å)',
      source: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∏–∑ 12+ –Ω–∞—É—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤',
      interpretation: '>80 ‚Äî –æ—Ç–ª–∏—á–Ω–æ! 60-80 ‚Äî —Ö–æ—Ä–æ—à–æ. <60 ‚Äî –µ—Å—Ç—å –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å.',
      evidenceLevel: 'B',
      confidenceScore: 0.87,
      priority: 'HIGH',
      category: 'COMPOSITE',
      actionability: 'TODAY',
      impactScore: 0.85,
      whyImportant: '–ï–¥–∏–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –∑–¥–æ—Ä–æ–≤—å—è. –¶–µ–ª—å ‚Äî 80+ –±–∞–ª–ª–æ–≤.'
    },
    // Correlation ‚Äî –ù–∏–∑–∫–∏–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    CORRELATION: {
      name: '–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ü–∏—Ä—Å–æ–Ω–∞',
      short: '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –º–µ—Ä–∞ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏: –æ—Ç -1 (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å) —á–µ—Ä–µ–∑ 0 (–Ω–µ—Ç —Å–≤—è–∑–∏) –¥–æ +1 (–ø—Ä—è–º–∞—è —Å–≤—è–∑—å).',
      details: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ü–∏—Ä—Å–æ–Ω–∞ –∏–∑–º–µ—Ä—è–µ—Ç –ª–∏–Ω–µ–π–Ω—É—é —Å–≤—è–∑—å –º–µ–∂–¥—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏, –Ω–æ –Ω–µ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å: –≤—ã—Å–æ–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å –∫–∞–∫ –≤–ª–∏—è–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –Ω–∞ –¥—Ä—É–≥–æ–µ, —Ç–∞–∫ –∏ –≤–ª–∏—è–Ω–∏–µ —Ç—Ä–µ—Ç—å–µ–≥–æ —Å–∫—Ä—ã—Ç–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞. –î–ª—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–≤–æ–¥–æ–≤ –≤–∞–∂–Ω–∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∏–ª–∞ —Å–≤—è–∑–∏ (|r|), –Ω–æ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏—è—Ö. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –µ—Å–ª–∏ —Å–æ–Ω –∏ –∞–ø–ø–µ—Ç–∏—Ç –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ 0.6+ —Å—Ç–∞–±–∏–ª—å–Ω–æ 2-3 –Ω–µ–¥–µ–ª–∏, —ç—Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ <0.4 –æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –Ω–∏–∑–∫—É—é –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫.',
      formula: 'r = Œ£(x-xÃÑ)(y-»≥) / ‚àö(Œ£(x-xÃÑ)¬≤ √ó Œ£(y-»≥)¬≤)\n–î–∏–∞–ø–∞–∑–æ–Ω: –æ—Ç -1 –¥–æ +1',
      source: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
      sources: [{ pmid: '13524500', level: 'C', title: 'Pearson, 1895 ‚Äî Correlation coefficient (statistical method)' }],
      evidenceLevel: 'C',
      confidenceScore: 0.70,
      interpretation: '|r| > 0.7 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å. 0.4-0.7 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <0.4 ‚Äî —Å–ª–∞–±–∞—è.',
      priority: 'INFO',
      category: 'STATISTICS',
      actionability: 'INFORMATIONAL',
      impactScore: 0.20,
      whyImportant: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏. –ß–µ–º –±–ª–∏–∂–µ –∫ ¬±1 ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–≤—è–∑—å.'
    },
    // Weight Prediction ‚Äî –í—ã—Å–æ–∫–∏–π, –ø—Ä–æ–≥–Ω–æ–∑
    WEIGHT_PREDICTION: {
      name: '–ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞',
      short: '–¢—Ä–µ–Ω–¥ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–µ—Å–∞. –ü–æ–ª–µ–∑–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É, –∞ –Ω–µ –æ–¥–∏–Ω –¥–µ–Ω—å.',
      details: '–õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è –≤–µ—Å–∞ (–≤–æ–¥–∞, —Å–æ–ª—å, —É–≥–ª–µ–≤–æ–¥—ã), —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–µ –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞, –∞ –≤ —Ä–∞–Ω–Ω–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–ª–∞—Ç–æ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Ü–µ–ª–∏. –ï—Å–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –Ω–∞–∫–ª–æ–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∂–µ–ª–∞–µ–º–æ–º—É —Ç–µ–º–ø—É, —ç—Ç–æ —Å–∏–≥–Ω–∞–ª –∫ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. –î–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 7-10 —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö, –∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—É—á—à–µ –≤ –Ω–µ–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –¥–Ω–µ–≤–Ω—ã–µ —Ñ–ª—É–∫—Ç—É–∞—Ü–∏–∏. –ü—Ä–æ–≥–Ω–æ–∑ –ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç –±—É–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è ‚Äî –æ–Ω —ç–∫—Å—Ç—Ä–∞–ø–æ–ª–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é.',
      formula: '–õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è:\n  slope = Œ£((day - avgDay)(weight - avgWeight)) / Œ£(day - avgDay)¬≤\n  forecast = currentWeight + slope √ó daysAhead',
      source: '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤',
      sources: [{ pmid: '7608935', level: 'C', title: 'Time-series forecasting ‚Äî Linear regression approach' }],
      evidenceLevel: 'C',
      confidenceScore: 0.72,
      interpretation: '–¢–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö. ‚â•7 –¥–Ω–µ–π ‚Äî —É–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑.',
      priority: 'HIGH',
      category: 'PREDICTION',
      actionability: 'WEEKLY',
      impactScore: 0.75,
      whyImportant: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É–¥–∞ –¥–≤–∏–∂–µ—Ç—Å—è –≤–µ—Å. –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.'
    },
    // Patterns ‚Äî –í—ã—Å–æ–∫–∏–π, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
    PATTERNS: {
      name: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è',
      short: '–í—ã—è–≤–ª—è–µ—Ç –≤–∞—à–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–∏–≤—ã—á–∫–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.',
      details: '–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞—Ä—Ö–∏–≤ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º 14-21 –¥–µ–Ω—å) –∏ –Ω–∞—Ö–æ–¥–∏—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏: –∫–∞–∫–∏–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –ø—Ä–æ—â–µ –¥–∞—é—Ç—Å—è, –∫–∞–∫ —Å—Ç—Ä–µ—Å—Å –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–ø–ø–µ—Ç–∏—Ç, –µ—Å—Ç—å –ª–∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É —Å–Ω–æ–º –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ–º, –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ª–∏ timing –ø–µ—Ä–µ–∫—É—Å–æ–≤. –ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å, –∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, –ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢ –∏ —á—Ç–æ —Ç–æ—Ä–º–æ–∑–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å. –ß–∞—Å—Ç–æ —Å–∞–º—ã–µ —Å–∏–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã: –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—á–µ—Ä–æ–º –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ä–∏—Å–∫ —Å–æ—Ä–≤–∞—Ç—å—Å—è –≤—ã—à–µ, –∞ –ø—Ä–∏ —Å–Ω–µ >7—á –±–µ–ª–æ–∫ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ª—É—á—à–µ. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω ¬´–ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∞–ø–ø–µ—Ç–∏—Ç —Å–Ω–∏–∂–µ–Ω 3—á¬ª, —ç—Ç–æ —Å–∏–≥–Ω–∞–ª –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–ª–æ—Ç–Ω—ã–π –ø—Ä–∏—ë–º –î–û, –∞ –Ω–µ –ø–æ—Å–ª–µ. –ß–µ—Ä–µ–∑ 4-6 –Ω–µ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª—å –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ—á–Ω–µ–µ –∏ –º–æ–∂–µ—Ç –ø—Ä–µ–¥—É–≥–∞–¥—ã–≤–∞—Ç—å —É—è–∑–≤–∏–º—ã–µ –º–æ–º–µ–Ω—Ç—ã –Ω–∞ 1-2 –¥–Ω—è –≤–ø–µ—Ä—ë–¥.',
      formula: '–ê–Ω–∞–ª–∏–∑ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π –≤ –¥–∞–Ω–Ω—ã—Ö:\n  ‚Ä¢ –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ (—Å–æ–Ω‚Üí–≥–æ–ª–æ–¥, —Å—Ç—Ä–µ—Å—Å‚Üí–µ–¥–∞)\n  ‚Ä¢ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—Ç–∞–π–º–∏–Ω–≥ –µ–¥—ã, –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç –≤–æ–ª–Ω)\n  ‚Ä¢ –¢—Ä–µ–Ω–¥—ã (–∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–æ–≤, –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫–∞)',
      source: '–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è (behavioral nutrition patterns)',
      sources: [{ pmid: '21593509', level: 'C', title: 'Behavioral nutrition patterns ‚Äî Observational analysis' }],
      evidenceLevel: 'C',
      confidenceScore: 0.75,
      interpretation: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–Ω—è—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –∏ –Ω–∞–π—Ç–∏ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞.',
      priority: 'HIGH',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.80,
      whyImportant: '–¢–≤–æ–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–µ–±—è = –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.'
    },

    // === –ú–ï–¢–ê–ë–û–õ–ò–ß–ï–°–ö–ò–ô –§–ï–ù–û–¢–ò–ü ===
    PHENOTYPE: {
      name: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø',
      short: '–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ç–∏–ø ‚Äî –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ–±–º–µ–Ω–∞ –≤–µ—â–µ—Å—Ç–≤, –æ—Ç–∫–ª–∏–∫–∞ –Ω–∞ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã, —Ö—Ä–æ–Ω–æ—Ç–∏–ø–∞ –∏ —Å—Ç—Ä–µ—Å—Å-—Ä–µ–∞–∫—Ü–∏–∏.',
      details: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø ‚Äî —ç—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π "–ø–∞—Å–ø–æ—Ä—Ç" –≤–∞—à–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–º–∞, —Ñ–æ—Ä–º–∏—Ä—É–µ–º—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∏–Ω–∏–º—É–º 30 –¥–Ω–µ–π –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç 5 –æ—Å–µ–π: (1) –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º ‚Äî –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç—ë—Ç –∏ –ø–∞–¥–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—è –ø–æ—Å–ª–µ –∫—Ä–∞—Ö–º–∞–ª–∞/—Å–∞—Ö–∞—Ä–∞; (2) –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ –∂–∏—Ä–∞–º ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω–∏ –Ω–∞—Å—ã—â–∞—é—Ç –∏ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç —Ç—è–∂–µ—Å—Ç—å; (3) –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–µ–ª–∫–∞ ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å—ã—Ç–æ—Å—Ç—å, —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑; (4) –•—Ä–æ–Ω–æ—Ç–∏–ø ‚Äî –≤ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ –ø–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏/–∞–ø–ø–µ—Ç–∏—Ç–∞; (5) –°—Ç—Ä–µ—Å—Å-–æ—Ç–≤–µ—Ç ‚Äî —Ç–∏–ø –ø–∏—â–µ–≤–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ (–∑–∞–µ–¥–∞–Ω–∏–µ/–ø–æ—Ç–µ—Ä—è –∞–ø–ø–µ—Ç–∏—Ç–∞). –ù–∞ –≤—ã—Ö–æ–¥–µ ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –≤—Ä–æ–¥–µ "–°–ø—Ä–∏–Ω—Ç–µ—Ä" (–±—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º, —á–∞—Å—Ç–æ–µ –ø–∏—Ç–∞–Ω–∏–µ, –≤—ã—Å–æ–∫–∏–π —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑) –∏–ª–∏ "–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü" (–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ–±–º–µ–Ω, —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, —Ä–µ–¥–∫–∏–µ –ø–ª–æ—Ç–Ω—ã–µ –ø—Ä–∏—ë–º—ã). –ó–Ω–∞—è —Ñ–µ–Ω–æ—Ç–∏–ø, –º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ 20-40% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.',
      formula: '–ê–Ω–∞–ª–∏–∑ 30+ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö:\n  ‚Ä¢ –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º (GI response, —ç–Ω–µ—Ä–≥–∏—è)\n  ‚Ä¢ –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ –∂–∏—Ä–∞–º (–Ω–∞—Å—ã—â–µ–Ω–∏–µ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)\n  ‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–µ–ª–∫–∞ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å—ã—Ç–æ—Å—Ç—å)\n  ‚Ä¢ –•—Ä–æ–Ω–æ—Ç–∏–ø (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)\n  ‚Ä¢ –°—Ç—Ä–µ—Å—Å-–æ—Ç–≤–µ—Ç (–µ–¥–∞ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ)',
      source: 'Zeevi et al., 2015 (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ); Ordovas, 2016',
      sources: [{ pmid: '26590418', level: 'B', title: 'Zeevi et al., 2015 ‚Äî Personalized nutrition RCT' }],
      evidenceLevel: 'B',
      confidenceScore: 0.83,
      interpretation: '–§–µ–Ω–æ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –µ–¥—É. –°–ø—Ä–∏–Ω—Ç–µ—Ä ‚Äî –±—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º, —á–∞—Å—Ç–æ–µ –ø–∏—Ç–∞–Ω–∏–µ. –ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, —Ä–µ–¥–∫–∏–µ –ø–ª–æ—Ç–Ω—ã–µ –ø—Ä–∏—ë–º—ã.',
      priority: 'HIGH',
      category: 'PERSONALIZATION',
      actionability: 'LONG_TERM',
      impactScore: 0.85,
      whyImportant: 'üß¨ –¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ç–∏–ø! –ü–∏—Ç–∞–Ω–∏–µ –ø–æ —Ñ–µ–Ω–æ—Ç–∏–ø—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –¥–∏–µ—Ç –Ω–∞ 20-40%.'
    },
    PHENOTYPE_TRAITS: {
      name: '–†–∞–¥–∞—Ä –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç',
      short: '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è 5 –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –∫–∞—á–µ—Å—Ç–≤: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —ç–Ω–µ—Ä–≥–∏–∏, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ —Ä–µ–∂–∏–º–∞, —Ö—Ä–æ–Ω–æ—Ç–∏–ø.',
      details: '–†–∞–¥–∞—Ä ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –≤ —á–∏—Å–ª–æ–≤–æ–º –≤–∏–¥–µ (0-100% –ø–æ –∫–∞–∂–¥–æ–π –æ—Å–∏). –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–æ–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è (–Ω–∏–∑–∫–∞—è –¥–∏—Å–ø–µ—Ä—Å–∏—è). –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å –≤ –Ω–æ—Ä–º—É –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–∫–∏, —Å—Ç—Ä–µ—Å—Å–∞, –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è. –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –æ—Ç–∫–ª–∏–∫ –Ω–∞ —É–≥–ª–µ–≤–æ–¥—ã, —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ–ª–Ω. –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ ‚Äî adherence –∫ timing –µ–¥—ã –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –•—Ä–æ–Ω–æ—Ç–∏–ø ‚Äî —É—Ç—Ä–æ (100%) vs –≤–µ—á–µ—Ä (0%). –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª: –µ—Å–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è, –∑–Ω–∞—á–∏—Ç –Ω—É–∂–Ω—ã –±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –ø—Ä–∏—ë–º—ã/–∫–ª–µ—Ç—á–∞—Ç–∫–∞; –µ—Å–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–∞–±–æ–µ ‚Äî —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –∫–∞—á–µ—Å—Ç–≤–æ–º —Å–Ω–∞ –∏ —Å—Ç—Ä–µ—Å—Å-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–æ–º. –†–∞–¥–∞—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É —á–µ—Ä—Ç –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫.',
      formula: '–ß–µ—Ä—Ç—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏:\n  ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: œÉ(energyLevel) –∑–∞ –¥–µ–Ω—å\n  ‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤—Ä–µ–º—è –¥–æ –Ω–æ—Ä–º—ã –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–∫–∏\n  ‚Ä¢ –ò–Ω—Å—É–ª–∏–Ω: GI-response + wave patterns\n  ‚Ä¢ –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ: adherence to timing\n  ‚Ä¢ –•—Ä–æ–Ω–æ—Ç–∏–ø: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É—Ç—Ä–æ/–≤–µ—á–µ—Ä',
      source: '–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      interpretation: '–ö–∞–∂–¥–∞—è —á–µ—Ä—Ç–∞ 0-100%. –í—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è = —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞. –ù–∏–∑–∫–∏–µ = –∑–æ–Ω–∞ —Ä–æ—Å—Ç–∞.',
      priority: 'MEDIUM',
      category: 'PERSONALIZATION',
      actionability: 'WEEKLY',
      impactScore: 0.60,
      whyImportant: '–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–∏—Ç–∞–Ω–∏—è.'
    },
    PHENOTYPE_THRESHOLDS: {
      name: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏',
      short: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π, –ø–µ—Ä–µ—Ä—ã–≤–æ–≤, –¥–ª–∏–Ω—ã –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω –∏ –º–∞–∫—Ä–æ—Å–æ–≤ ‚Äî —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ —Ñ–µ–Ω–æ—Ç–∏–ø–∞.',
      details: '–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –Ω–æ—Ä–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–µ—Ä–µ—Ä—ã–≤ –º–µ–∂–¥—É –µ–¥–æ–π 3-4—á"), –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –∏–∑ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º 14 –¥–Ω–µ–π). –û–Ω–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞, –æ—Ç–∫–ª–∏–∫ –Ω–∞ –º–∞–∫—Ä–æ—Å—ã –∏ –≤–∞—à –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏: (1) –î–∏–∞–ø–∞–∑–æ–Ω –∫–∫–∞–ª ‚Äî –æ–∫–Ω–æ ¬±5-10% –æ—Ç TDEE, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä—É–µ—Ç–µ; (2) –î–ª–∏–Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã ‚Äî —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –µ–¥—ã —É –≤–∞—Å —É—Å—Ç–æ–π—á–∏–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è (2.5-4.5—á); (3) –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –Ω–µ—Ç –Ω–∏ –≥–æ–ª–æ–¥–∞, –Ω–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∞; (4) –ú–∞–∫—Ä–æ—Å—ã –ø–æ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç–∏ ‚Äî —Å–∫–æ–ª—å–∫–æ —É–≥–ª–µ–≤–æ–¥–æ–≤/–∂–∏—Ä–æ–≤ –≤—ã —É—Å–≤–∞–∏–≤–∞–µ—Ç–µ –±–µ–∑ —Å–∫–∞—á–∫–æ–≤. –ü–æ—Ä–æ–≥–∏ —É—Ç–æ—á–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 7-14 –¥–Ω–µ–π. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ: –µ—Å–ª–∏ –≤—ã —Å—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–∞—â–µ, –ø–æ—Ä–æ–≥ –∫–∞–ª–æ—Ä–∏–π –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è; –µ—Å–ª–∏ —É–ª—É—á—à–∏–ª—Å—è —Å–æ–Ω ‚Äî –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤—ã—Ä–∞—Å—Ç–µ—Ç.',
      formula: '–ù–∞ –æ—Å–Ω–æ–≤–µ —Ñ–µ–Ω–æ—Ç–∏–ø–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è:\n  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∫–∞–ª (¬±5-10% –æ—Ç TDEE)\n  ‚Ä¢ –î–ª–∏–Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã (2.5-4.5—á)\n  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ –º–µ–∂–¥—É –µ–¥–æ–π (3-6—á)\n  ‚Ä¢ –ú–∞–∫—Ä–æ—Å—ã –ø–æ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç–∏',
      source: '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ 14+ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö',
      interpretation: '–ü–æ—Ä–æ–≥–∏ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ë–æ–ª—å—à–µ –¥–Ω–µ–π = —Ç–æ—á–Ω–µ–µ –ø–æ—Ä–æ–≥–∏.',
      priority: 'HIGH',
      category: 'PERSONALIZATION',
      actionability: 'WEEKLY',
      impactScore: 0.75,
      whyImportant: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ —Ç–æ—á–Ω–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –Ω–æ—Ä–º. –£—á–∏—Ç—ã–≤–∞—é—Ç —Ç–≤–æ—é –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å.'
    },

    // === –ö–ê–¢–ï–ì–û–†–ò–ò HEALTH SCORE ‚Äî –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è) ===
    CATEGORY_NUTRITION: {
      name: '–ü–∏—Ç–∞–Ω–∏–µ (40%)',
      short: '–°–∞–º–∞—è –≤–µ—Å–æ–º–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π, –Ω–æ –∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞ ‚Äî –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫—É, –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã –∏ –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å.',
      details: '–ü–∏—Ç–∞–Ω–∏–µ ‚Äî –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–ª–∞, –∑–∞–Ω–∏–º–∞—é—â–∏–π 40% –≤–µ—Å–∞ –≤ –∏—Ç–æ–≥–æ–≤–æ–º score. –ú–µ—Ç—Ä–∏–∫–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—è—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –Ω–æ—Ä–º—É –∫–∞–ª–æ—Ä–∏–π (85-110%), –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –±–µ–ª–∫–∞ (‚â•0.8–≥ –Ω–∞ –∫–≥), –∫–ª–µ—Ç—á–∞—Ç–∫—É –¥–ª—è –Ω–∞—Å—ã—â–µ–Ω–∏—è –∏ –∑–¥–æ—Ä–æ–≤—å—è –∫–∏—à–µ—á–Ω–∏–∫–∞ (‚â•14–≥/1000 –∫–∫–∞–ª), –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤ (–ø–æ–ª–µ–∑–Ω—ã–µ ‚â•60%) –∏ —Å—Ä–µ–¥–Ω–∏–π –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å (<55). –í—ã—Å–æ–∫–∏–π score –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ä–∞—Ü–∏–æ–Ω –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å, –Ω–æ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é, –∑–∞—â–∏—Ç—É –º—ã—à—Ü –∏ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å.',
      formula: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–≤–µ—Å–∞ –¥–ª—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞):\n  –ö–∞–ª–æ—Ä–∏–∏: 30% (–ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ 85-110% –Ω–æ—Ä–º—ã)\n  –ë–µ–ª–æ–∫: 25% (‚â•0.8–≥ –Ω–∞ –∫–≥ –º–∞—Å—Å—ã —Ç–µ–ª–∞)\n  –ö–ª–µ—Ç—á–∞—Ç–∫–∞: 15% (‚â•14–≥/1000 –∫–∫–∞–ª)\n  –ö–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤: 15% (–ø–æ–ª–µ–∑–Ω—ã–µ ‚â•60%)\n  –ì–ò: 15% (—Å—Ä–µ–¥–Ω–∏–π GI <55)',
      source: 'Thomas et al., 2019 ‚Äî Quality diet patterns for weight loss',
      sources: [{ pmid: '31174214', level: 'B', title: 'Thomas et al., 2019 ‚Äî Diet quality patterns RCT' }],
      evidenceLevel: 'B',
      confidenceScore: 0.86,
      interpretation: '>80 ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ. 60-80 ‚Äî —Ö–æ—Ä–æ—à–æ. <60 ‚Äî –Ω—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è.',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'TODAY',
      impactScore: 0.65,
      whyImportant: '–°–∞–º–∞—è –≤–µ—Å–æ–º–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è. –ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã –≤–∞–∂–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.'
    },
    CATEGORY_TIMING: {
      name: '–¢–∞–π–º–∏–Ω–≥ (25%)',
      short: '–ö–æ–≥–¥–∞ —Ç—ã –µ—à—å –≤–ª–∏—è–µ—Ç –Ω–∞ —É—Å–≤–æ–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≥–æ–ª–æ–¥–∞. –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –µ–¥–æ–π –∏ —Å–º–µ—â–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –Ω–∞ —É—Ç—Ä–æ-–¥–µ–Ω—å.',
      details: '–¢–∞–π–º–∏–Ω–≥ –∑–∞–Ω–∏–º–∞–µ—Ç 25% –∏—Ç–æ–≥–æ–≤–æ–≥–æ score –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç —á–µ—Ç—ã—Ä–µ —Ñ–∞–∫—Ç–æ—Ä–∞: –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ (3-5 —á–∞—Å–æ–≤, —á—Ç–æ–±—ã –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –≤–æ–ª–Ω—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å), –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—é –ø–æ–∑–¥–Ω–µ–π –µ–¥—ã (–ø–æ—Å–ª–µ 21:00 –Ω–µ –±–æ–ª–µ–µ 300 –∫–∫–∞–ª), —Ü–∏—Ä–∫–∞–¥–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π (–±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –¥–æ 15:00) –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ö–∞–æ—Ç–∏—á–Ω—ã—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤. –•–æ—Ä–æ—à–∏–π —Ç–∞–π–º–∏–Ω–≥ –ø–æ–º–æ–≥–∞–µ—Ç –ª—É—á—à–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ–¥ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏, —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—á–µ—Ä–Ω—é—é —Ç—è–≥—É –∫ –µ–¥–µ –∏ —É–ª—É—á—à–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫—É—é –≥–∏–±–∫–æ—Å—Ç—å. –≠—Ç–æ –Ω–µ –∂—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ –æ—Ç–¥–∞—á–∏ –æ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫.',
      formula: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:\n  –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã: 30% (3-5—á –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏)\n  –ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –≤–æ–ª–Ω—ã: 30% (–Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è)\n  –ü–æ–∑–¥–Ω—è—è –µ–¥–∞: 25% (–ø–æ—Å–ª–µ 21:00 <300 –∫–∫–∞–ª)\n  –¶–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º: 15% (>60% –∫–∞–ª–æ—Ä–∏–π –¥–æ 15:00)',
      source: 'Sutton et al., 2018 ‚Äî Early time-restricted feeding and metabolic health',
      sources: [{ pmid: '29754952', level: 'B', title: 'Sutton et al., 2018 ‚Äî Early time-restricted feeding and metabolic health' }],
      evidenceLevel: 'B',
      confidenceScore: 0.87,
      interpretation: '>80 ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥. <60 ‚Äî –º–Ω–æ–≥–æ –≤–µ—á–µ—Ä–Ω–µ–π –µ–¥—ã –∏–ª–∏ —á–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã.',
      priority: 'MEDIUM',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.60,
      whyImportant: '–ö–æ–≥–¥–∞ —Ç—ã –µ—à—å –≤–ª–∏—è–µ—Ç –Ω–∞ —É—Å–≤–æ–µ–Ω–∏–µ. –£—Ç—Ä–æ > –≤–µ—á–µ—Ä.'
    },
    CATEGORY_ACTIVITY: {
      name: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (20%)',
      short: '–î–≤–∏–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π –∏ –∑–∞—â–∏—â–∞–µ—Ç –º—ã—à—Ü—ã. –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —à–∞–≥–∏ –∏ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—É—é –±—ã—Ç–æ–≤—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (NEAT).',
      details: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 20% –∏—Ç–æ–≥–æ–≤–æ–≥–æ score –∏ –≤–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (50% –≤–µ—Å–∞ ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å 3-5 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –≤–∞–∂–Ω–µ–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏), —à–∞–≥–∏ (30% ‚Äî –±–∞–∑–æ–≤—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –æ–±—â–µ–π –ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç–∏, 8000-10000 –≤ –¥–µ–Ω—å) –∏ NEAT (20% ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–∏–ø–∞ —É–±–æ—Ä–∫–∏, –ø—Ä–æ–≥—É–ª–æ–∫, —Ä–∞–±–æ—Ç—ã —Å—Ç–æ—è). –í—ã—Å–æ–∫–∏–π score –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π, –º—ã—à—Ü—ã –ø–æ–ª—É—á–∞—é—Ç —Å–∏–≥–Ω–∞–ª –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–µ –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è. –î–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —à–∞–≥–∏ –∏ NEAT –¥–∞—é—Ç 200-400 –∫–∫–∞–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Å—É—Ç–∫–∏.',
      formula: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:\n  –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: 50% (3-5 –≤ –Ω–µ–¥–µ–ª—é)\n  –®–∞–≥–∏: 30% (8000-10000 –≤ –¥–µ–Ω—å)\n  NEAT: 20% (–±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)',
      source: 'Villablanca et al., 2015 ‚Äî Nonexercise activity thermogenesis in obesity',
      sources: [{ pmid: '25738456', level: 'B', title: 'Villablanca et al., 2015 ‚Äî NEAT and energy expenditure' }],
      evidenceLevel: 'B',
      confidenceScore: 0.84,
      interpretation: '>80 ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏. <60 ‚Äî –¥–æ–±–∞–≤—å –¥–≤–∏–∂–µ–Ω–∏—è.',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'TODAY',
      impactScore: 0.55,
      whyImportant: '–î–≤–∏–∂–µ–Ω–∏–µ = —Ä–∞—Å—Ö–æ–¥. –î–∞–∂–µ –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —à–∞–≥–∏ —Å–∂–∏–≥–∞—é—Ç 200-400 –∫–∫–∞–ª.'
    },
    CATEGORY_RECOVERY: {
      name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (15%)',
      short: '–ù–µ–¥–æ—Å—ã–ø –∏ —Å—Ç—Ä–µ—Å—Å ‚Äî –≥–ª–∞–≤–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å—Ä—ã–≤–æ–≤ –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞, –∞ —Ç–∞–∫–∂–µ —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞.',
      details: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç 15% score, –Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ú–µ—Ç—Ä–∏–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞ (50% ‚Äî –Ω–æ—Ä–º–∞ 7-9 —á–∞—Å–æ–≤), –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ (25% ‚Äî —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ ‚â•4 –∏–∑ 5) –∏ —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞ (25% ‚Äî ‚â§4 –∏–∑ 10). –ü—Ä–∏ –Ω–µ–¥–æ—Å—ã–ø–µ –æ—Ä–≥–∞–Ω–∏–∑–º –ø–æ–≤—ã—à–∞–µ—Ç –≥—Ä–µ–ª–∏–Ω (–≥–æ–ª–æ–¥) –∏ —Å–Ω–∏–∂–∞–µ—Ç –ª–µ–ø—Ç–∏–Ω (—Å–∏–≥–Ω–∞–ª –Ω–∞—Å—ã—â–µ–Ω–∏—è), —á—Ç–æ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ç—è–≥—É –∫ –∫–∞–ª–æ—Ä–∏–π–Ω–æ–π –µ–¥–µ. –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—é –∂–∏—Ä–∞ —á–µ—Ä–µ–∑ –∫–æ—Ä—Ç–∏–∑–æ–ª. –ü–æ—ç—Ç–æ–º—É —É–ª—É—á—à–µ–Ω–∏–µ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–∞—Å—Ç–æ –¥–∞—ë—Ç –±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç, —á–µ–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∏–ª–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
      formula: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:\n  –°–æ–Ω: 50% (7-9 —á–∞—Å–æ–≤)\n  –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞: 25% (‚â•4 –∏–∑ 5)\n  –°—Ç—Ä–µ—Å—Å: 25% (‚â§4 –∏–∑ 10)',
      source: 'Spiegel et al., 2004 ‚Äî Sleep curtailment and leptin/ghrelin',
      sources: [{ pmid: '15531540', level: 'A', title: 'Spiegel et al., 2004 ‚Äî Sleep curtailment and appetite hormones' }],
      evidenceLevel: 'A',
      confidenceScore: 0.92,
      interpretation: '>80 ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. <60 ‚Äî –Ω–µ–¥–æ—Å—ã–ø –∏–ª–∏ –≤—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'TODAY',
      impactScore: 0.70,
      whyImportant: '–ù–µ–¥–æ—Å—ã–ø –∏ —Å—Ç—Ä–µ—Å—Å ‚Äî –≥–ª–∞–≤–Ω—ã–µ –≤—Ä–∞–≥–∏ –ø–æ—Ö—É–¥–µ–Ω–∏—è. –í—ã—Å—ã–ø–∞–π—Å—è!'
    },
    CATEGORY_METABOLISM: {
      name: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º (5-10%)',
      short: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–º–µ–Ω–∞ –≤–µ—â–µ—Å—Ç–≤. –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Ç–µ–ª–∞, –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É –∏ –º–∞—Ä–∫–µ—Ä—ã –∫–∞—Ä–¥–∏–æ-–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è.',
      details: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–Ω–∏–º–∞–µ—Ç 5-10% –∏—Ç–æ–≥–æ–≤–æ–≥–æ score (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ü–µ–ª–∏). –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤–∫–ª—é—á–∞–µ—Ç —á–µ—Ç—ã—Ä–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (50% ‚Äî —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ç–µ–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–≥–ª–µ–≤–æ–¥—ã –±–µ–∑ —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤ –≥–ª—é–∫–æ–∑—ã), –∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Ç–µ–ª–∞ (25% ‚Äî —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –º—ã—à—Ü –∏ –∂–∏—Ä–∞, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–µ—Å), –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É —Ä–∞—Ü–∏–æ–Ω–∞ (15% ‚Äî —Å—Ä–µ–¥–Ω–∏–π GI √ó —É–≥–ª–µ–≤–æ–¥—ã) –∏ –º–∞—Ä–∫–µ—Ä—ã —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è (10% ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Heart Health). –í—ã—Å–æ–∫–∏–π score –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–∑–Ω–∞—á–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫—É—é –≥–∏–±–∫–æ—Å—Ç—å: —Ç–µ–ª–æ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ —ç–Ω–µ—Ä–≥–∏–∏, –Ω–µ—Ç —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –î–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è (–¥–µ—Ñ–∏—Ü–∏—Ç) —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–ª—É—á–∞–µ—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å (10%), —Ç.–∫. –Ω–∞—Ä—É—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—é –∂–∏—Ä–∞.',
      formula: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:\n  –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 50% (–ø–∞—Ç—Ç–µ—Ä–Ω Insulin Sensitivity)\n  –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ–ª–∞: 25% (–ø–∞—Ç—Ç–µ—Ä–Ω Body Composition)\n  –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: 15% (–ø–∞—Ç—Ç–µ—Ä–Ω Glycemic Load)\n  –ö–∞—Ä–¥–∏–æ –∑–¥–æ—Ä–æ–≤—å–µ: 10% (–ø–∞—Ç—Ç–µ—Ä–Ω Heart Health)',
      source: 'Galgani & Ravussin, 2008 ‚Äî Energy metabolism, fuel selection and body weight regulation',
      sources: [{ pmid: '18700873', level: 'A', title: 'Galgani & Ravussin, 2008 ‚Äî Energy metabolism and weight regulation' }],
      evidenceLevel: 'A',
      confidenceScore: 0.88,
      interpretation: '>80 ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å. <60 ‚Äî –≤–æ–∑–º–æ–∂–Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏.',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'WEEKLY',
      impactScore: 0.55,
      whyImportant: '–ó–¥–æ—Ä–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º = —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞. –ö—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.'
    },

    // === WHAT-IF –°–¶–ï–ù–ê–†–ò–ò ‚Äî –°—Ä–µ–¥–Ω–∏–π ===
    WHATIF: {
      name: '–ß—Ç–æ –µ—Å–ª–∏... (What-If –∞–Ω–∞–ª–∏–∑)',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Å—Ç –Ω–∞–∏–±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç –∏–º–µ–Ω–Ω–æ —Å–µ–≥–æ–¥–Ω—è.',
      details: 'What-If —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ö –∏–º–ø–∞–∫—Ç –Ω–∞ Health Score –î–û —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –∏—Ö —Å–¥–µ–ª–∞–ª–∏. –°—Ü–µ–Ω–∞—Ä–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ: +20–≥ –±–µ–ª–∫–∞, +3000 —à–∞–≥–æ–≤, +1—á —Å–Ω–∞, –ø–µ—Ä–µ–Ω–æ—Å –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –Ω–∞ —á–∞—Å —Ä–∞–Ω—å—à–µ. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏: –µ—Å–ª–∏ —É–≤–∏–¥–∏—Ç–µ, —á—Ç–æ +20–≥ –±–µ–ª–∫–∞ –¥–∞—Å—Ç +8 –±–∞–ª–ª–æ–≤, –∞ —à–∞–≥–∏ —Ç–æ–ª—å–∫–æ +2, —Ä–µ—à–µ–Ω–∏–µ –æ—á–µ–≤–∏–¥–Ω–æ. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª –Ω–µ –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ (–æ–Ω–∞ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞), –∞ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å "—á—Ç–æ —Å–µ–π—á–∞—Å –¥–∞—Å—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é –æ—Ç–¥–∞—á—É". –û—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –≤ –¥–Ω–∏, –∫–æ–≥–¥–∞ –≤—Ä–µ–º–µ–Ω–∏/—ç–Ω–µ—Ä–≥–∏–∏ –º–∞–ª–æ –∏ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.',
      formula: '–°—Ü–µ–Ω–∞—Ä–∏–∏ –º–æ–¥–µ–ª–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n  1. –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n  2. –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ (+–±–µ–ª–æ–∫, +—à–∞–≥–∏, –∏ —Ç.–¥.)\n  3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º Health Score\n  4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–ª—å—Ç—É: –±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ',
      interpretation: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç Score –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞.',
      source: 'Decision Modeling / Forecasting (business intelligence)',
      priority: 'MEDIUM',
      category: 'PREDICTION',
      actionability: 'TODAY',
      impactScore: 0.50,
      whyImportant: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –¥–∞—Å—Ç –Ω–∞–∏–±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.'
    },

    // === WHAT-IF SIMULATOR ‚Äî –í—ã—Å–æ–∫–∏–π ===
    WHATIF_SIMULATOR: {
      name: 'üß™ –°–∏–º—É–ª—è—Ç–æ—Ä –µ–¥—ã',
      short: '–ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –µ–¥–∞ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Å—ã—Ç–æ—Å—Ç—å, –≤–æ–ª–Ω—É –∏ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞.',
      details: '–≠—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç ¬´–ø—Ä–∏–º–µ—Ä–∏—Ç—å¬ª –µ–¥—É –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –µ—ë —Å—ä–µ–ª–∏. –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç 4 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è: (1) –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É GL ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑–∫–æ –ø–æ–¥—Å–∫–æ—á–∏—Ç —ç–Ω–µ—Ä–≥–∏—è; (2) –¥–ª–∏–Ω—É –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã ‚Äî —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –±—É–¥–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è; (3) –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è —Å—ã—Ç–æ—Å—Ç–∏ ‚Äî –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –≥–æ–ª–æ–¥ (—É—á–∏—Ç—ã–≤–∞–µ—Ç –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫—É, –∂–∏—Ä—ã); (4) –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ —Å—Ä—ã–≤–∞ ‚Äî —É—Å–∏–ª–∏–≤–∞–µ—Ç –ª–∏ —ç—Ç–∞ –µ–¥–∞ —Ç—è–≥—É. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: –≤ 15:00 –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–µ–∫—É—Å–∞ —Å—Ä–∞–≤–Ω–∏–º ¬´–ø–µ—á–µ–Ω—å–µ + —á–∞–π¬ª (GL=18, –≤–æ–ª–Ω–∞ 1.8—á, —Å—ã—Ç–æ—Å—Ç—å 2.2—á, —Ä–∏—Å–∫ +12%) vs ¬´–æ—Ä–µ—Ö–∏ + —è–±–ª–æ–∫–æ¬ª (GL=8, –≤–æ–ª–Ω–∞ 3.2—á, —Å—ã—Ç–æ—Å—Ç—å 3.8—á, —Ä–∏—Å–∫ -5%). –†–µ—à–µ–Ω–∏–µ –æ—á–µ–≤–∏–¥–Ω–æ. –í–∞–∂–Ω–æ: —Å–∏–º—É–ª—è—Ç–æ—Ä –Ω–µ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –µ–¥—É, –∞ —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è. –ï—Å–ª–∏ —Ä–µ—à–∏–ª–∏ —Å—ä–µ—Å—Ç—å –≤—ã—Å–æ–∫–æ–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∫—É—Å, –≤—ã —É–∂–µ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –∑–∞—Ö–æ—Ç–µ—Ç—å—Å—è –µ—Å—Ç—å ‚Äî –∏ –≥–æ—Ç–æ–≤—ã –∫ —ç—Ç–æ–º—É.',
      formula: '–ê–ª–≥–æ—Ä–∏—Ç–º —Å–∏–º—É–ª—è—Ü–∏–∏:\n  1. GL (–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞) = GI √ó —É–≥–ª–µ–≤–æ–¥—ã / 100\n  2. –í–æ–ª–Ω–∞ = –±–∞–∑–∞ √ó GI-–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä √ó GL-–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä √ó (–±–µ–ª–æ–∫/–∂–∏—Ä/–∫–ª–µ—Ç—á–∞—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏)\n  3. –°—ã—Ç–æ—Å—Ç—å = 2—á + –±–µ–ª–æ–∫√ó0.03 + –∫–ª–µ—Ç—á–∞—Ç–∫–∞√ó0.05 ‚àí (GI‚àí50)√ó0.01\n  4. –†–∏—Å–∫ = —Ç–µ–∫—É—â–∏–π + (GI>70?+8) + (–ø–µ—Ä–µ–±–æ—Ä>1.3?+15) ‚àí (–±–µ–ª–æ–∫>25?‚àí10)',
      interpretation: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ö–ê–ö –∏–º–µ–Ω–Ω–æ –µ–¥–∞ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é –≤–æ–ª–Ω—É, —Å—ã—Ç–æ—Å—Ç—å –∏ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞.',
      source: 'Decision theory (predictive food outcomes)',
      priority: 'HIGH',
      category: 'PREDICTION',
      actionability: 'IMMEDIATE',
      impactScore: 0.75,
      whyImportant: '–ü—Ä–∏–Ω–∏–º–∞–π –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –æ –µ–¥–µ –î–û —Ç–æ–≥–æ –∫–∞–∫ —Å—ä–µ–ª!'
    },

    // === WEEKLY WRAP ‚Äî –°—Ä–µ–¥–Ω–∏–π ===
    WEEKLY_WRAP: {
      name: '–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏',
      short: '–ö–æ—Ä–æ—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –Ω–µ–¥–µ–ª–∏: —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –≥–¥–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —á—Ç–æ —É–ª—É—á—à–∏—Ç—å –¥–∞–ª—å—à–µ.',
      details: '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–∏—Ç—É–∞–ª —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É –∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏—è—Ö –≤–µ—Å–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª—è–µ—Ç 4 –±–ª–æ–∫–∞: (1) –õ—É—á—à–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ ‚Äî —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å; (2) –•—É–¥—à–∏–π –¥–µ–Ω—å ‚Äî –∫–∞–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø—Ä–∏–≤–µ–ª–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º; (3) Hidden Wins ‚Äî –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Ç—è–Ω—É–ª–∏ 4 –¥–Ω—è –ø–æ–¥—Ä—è–¥ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –±–µ–ª–∫–æ–º); (4) –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é ‚Äî –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –¥–∞—Å—Ç –Ω–∞–∏–±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç. –§–æ—Ä–º–∞—Ç –∫–æ—Ä–æ—Ç–∫–∏–π (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –±–ª–æ–∫), –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∞. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: –Ω–µ–¥–µ–ª—å–Ω—ã–π –≤–∑–≥–ª—è–¥ —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç –∫–æ–ª–µ–±–∞–Ω–∏—è –≤–µ—Å–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.',
      formula: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:\n  ‚Ä¢ –õ—É—á—à–∏–π/—Ö—É–¥—à–∏–π –¥–µ–Ω—å –ø–æ calories ratio\n  ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π Health Score –∑–∞ –Ω–µ–¥–µ–ª—é\n  ‚Ä¢ Streak (–¥–Ω–∏ –ø–æ–¥—Ä—è–¥ –≤ –Ω–æ—Ä–º–µ)\n  ‚Ä¢ Hidden Wins (–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ª–µ–≥–∫–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)',
      interpretation: '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å.',
      source: 'Reflective practice (behavioral coaching)',
      priority: 'MEDIUM',
      category: 'COMPOSITE',
      actionability: 'WEEKLY',
      impactScore: 0.55,
      whyImportant: '–†–µ—Ñ–ª–µ–∫—Å–∏—è = –ø—Ä–æ–≥—Ä–µ—Å—Å. –°–º–æ—Ç—Ä–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é, –∞ –Ω–µ –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å.'
    },

    // === METABOLIC STATUS CARD ‚Äî –í—ã—Å–æ–∫–∏–π/–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π ===
    STATUS_INFLUENCES: {
      name: '–í–ª–∏—è—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–∞—à —Å—Ç–∞—Ç—É—Å –∏ –Ω–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∫–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä —Ç—è–Ω–µ—Ç –≤–Ω–∏–∑.',
      details: '–ü–∞–Ω–µ–ª—å –í–ª–∏—è—é—â–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ ‚Äî —ç—Ç–æ ¬´—Ç—Ä–∏–∞–∂¬ª –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏–∑–∞—Ü–∏–∏: –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´—á—Ç–æ –Ω–µ —Ç–∞–∫¬ª, –∞ –ö–û–ù–ö–†–ï–¢–ù–´–ô –í–ö–õ–ê–î –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã –≤ –æ–±—â–∏–π score. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—ã–ø —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ -15%, –∞ –Ω–∏–∑–∫–∏–π –±–µ–ª–æ–∫ –Ω–∞ -8%, –æ—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –≤–∞–∂–Ω–µ–µ –≤—ã—Å–ø–∞—Ç—å—Å—è, –∞ –Ω–µ —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ä—Ü–∏—é –∫—É—Ä–∏—Ü—ã. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç 6 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –∫–∞–ª–æ—Ä–∏–∏ (–ø–µ—Ä–µ–±–æ—Ä/–Ω–µ–¥–æ–±–æ—Ä), —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫–∞, —Ç–∞–π–º–∏–Ω–≥ (–ø–æ–∑–¥–Ω—è—è –µ–¥–∞, –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç—ã –≤–æ–ª–Ω). –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —Ä–µ–∞–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç (>5% –¥—Ä–æ–ø–∞), —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–¥—É—Ü–∏—Ä–æ–≤–∞—Ç—å —à—É–º. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: —É—Å—Ç—Ä–∞–Ω–∏—Ç–µ –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä ‚Äî —Å—Ç–∞—Ç—É—Å –≤—ã—Ä–∞—Å—Ç–µ—Ç –Ω–∞ —ç—Ç—É –≤–µ–ª–∏—á–∏–Ω—É. –ü–∞–Ω–µ–ª—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è ‚Äî —Ñ–∞–∫—Ç–æ—Ä—ã –º–µ–Ω—è—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –ø–æ –º–µ—Ä–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.',
      formula: '–§–∞–∫—Ç–æ—Ä—ã —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:\n  ‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏ (–ø–µ—Ä–µ–±–æ—Ä/–Ω–µ–¥–æ–±–æ—Ä)\n  ‚Ä¢ –ù–µ–¥–æ—Å—ã–ø (< –Ω–æ—Ä–º—ã)\n  ‚Ä¢ –í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å\n  ‚Ä¢ –ù–∏–∑–∫–∏–π –±–µ–ª–æ–∫\n  ‚Ä¢ –ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏\n  ‚Ä¢ –ü–ª–æ—Ö–æ–π —Ç–∞–π–º–∏–Ω–≥\n\n–ö–∞–∂–¥—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∫–æ–ª—å–∫–æ % —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å.',
      interpretation: '–£—Å—Ç—Ä–∞–Ω–∏—Ç–µ –≥–ª–∞–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã ‚Äî —Å—Ç–∞—Ç—É—Å –≤—ã—Ä–∞—Å—Ç–µ—Ç.',
      source: 'Behavioral diagnostics (priority analysis)',
      priority: 'HIGH',
      category: 'COMPOSITE',
      actionability: 'IMMEDIATE',
      impactScore: 0.85,
      whyImportant: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ß–¢–û –∏–º–µ–Ω–Ω–æ —Ç—è–Ω–µ—Ç —Å—Ç–∞—Ç—É—Å –≤–Ω–∏–∑. –ò—Å–ø—Ä–∞–≤—å –≥–ª–∞–≤–Ω–æ–µ!'
    },
    PRIORITY_ACTIONS: {
      name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è',
      short: '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ª—É—á—à–∞—Ç –¥–µ–Ω—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –ú–∞–∫—Å–∏–º—É–º 3 –¥–µ–π—Å—Ç–≤–∏—è ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º.',
      details: '–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, —É—á–∏—Ç—ã–≤–∞—è —á–µ—Ç—ã—Ä–µ —Ñ–∞–∫—Ç–æ—Ä–∞: (1) –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–µ–ª—ã ‚Äî —á—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Ç—è–Ω–µ—Ç score –≤–Ω–∏–∑; (2) –í—Ä–µ–º—è —Å—É—Ç–æ–∫ ‚Äî —á—Ç–æ –µ—â—ë —Ä–µ–∞–ª—å–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è (–Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É—Ç—Ä–µ–Ω–Ω–∏—â –≤ 20:00); (3) –ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –¥–Ω–µ–π ‚Äî —á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —É –≤–∞—Å —Ä–∞–Ω—å—à–µ; (4) –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±–µ–ª–æ–∫ —É –≤–∞—Å –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ. –î–µ–π—Å—Ç–≤–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ (–Ω–µ "–ª—É—á—à–µ –ø–∏—Ç–∞–π—Å—è", –∞ "–¥–æ–±–∞–≤—å 20–≥ –±–µ–ª–∫–∞ –≤ —É–∂–∏–Ω") –∏ –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Å–µ–π—á–∞—Å. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 3 –ø—É–Ω–∫—Ç–∞–º–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ ‚Äî –∏–∑–±—ã—Ç–æ–∫ –∑–∞–¥–∞—á –≤—ã–∑—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–∏—á —Ä–µ—à–µ–Ω–∏–π. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª: –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –û–î–ù–û –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —ç—Ç–æ —É–∂–µ +10-20% –∫ score –∏ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–Ω—è.',
      formula: '–ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n  1. –¢–µ–∫—É—â–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ (—á—Ç–æ –Ω–∏–∂–µ –Ω–æ—Ä–º—ã)\n  2. –í—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (—á—Ç–æ –µ—â—ë –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å)\n  3. –ò—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—à–Ω—ã—Ö –¥–Ω–µ–π\n  4. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n\n–ú–∞–∫—Å–∏–º—É–º 3 –¥–µ–π—Å—Ç–≤–∏—è ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º.',
      source: 'Behavior Change Theory',
      interpretation: '–í—ã–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã 1 –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –¥–Ω—è.',
      priority: 'CRITICAL',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.95,
      whyImportant: '‚ö° –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°. –°–¥–µ–ª–∞–π —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ!'
    },
    STATUS_RISK_FACTORS: {
      name: '–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ (–≤ —Å—Ç–∞—Ç—É—Å–µ)',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ. –¶–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏.',
      details: '–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ ‚Äî —ç—Ç–æ –¥–æ–ø–æ–ª–Ω—è–µ–º–∞—è –ø–∞–Ω–µ–ª—å –∫ Crash Risk Quick, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç, –ü–û–ß–ï–ú–£ —Ä–∏—Å–∫ –≤—ã—Å–æ–∫–∏–π. –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–º –≤–∫–ª–∞–¥–æ–º –≤ –æ–±—â–∏–π —Ä–∏—Å–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ù–µ–¥–æ—Å—ã–ø +25%, –ì–æ–ª–æ–¥–∞–Ω–∏–µ +20%, –ù–∏–∑–∫–∏–π –±–µ–ª–æ–∫ +15% –∏ —Ç.–¥. –°—É–º–º–∞ –¥–∞—ë—Ç –æ–±—â–∏–π —Ä–∏—Å–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–∫—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –≤ –∑–µ–ª—ë–Ω—ã–π (<30%), –∂—ë–ª—Ç—ã–π (30-60%) –∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π (>60%). –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏: —É–±—Ä–∞—Ç—å –æ–¥–∏–Ω —Ç–æ–ø-—Ñ–∞–∫—Ç–æ—Ä –ø—Ä–æ—â–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è ¬´–ø–æ–¥–Ω—è—Ç—å –±–µ–∑ —Ä–∞–∑–±–æ—Ä–∞ –≤—Å—ë¬ª. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ù–µ–¥–æ—Å—ã–ø +25% ‚Äî –≤—ã—Å–ø–∏—Ç–µ—Å—å —Å–µ–≥–æ–¥–Ω—è —Ä–∞–Ω—å—à–µ, —ç—Ç–æ —Å–Ω–∏–º–µ—Ç 1/4 —Ä–∏—Å–∫–∞. –ö—Ä–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —è—Ä–∫–æ, —á—Ç–æ–±—ã –ø—Ä–∏–≤–ª–µ—á—å –≤–Ω–∏–º–∞–Ω–∏–µ.',
      formula: '–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞:\n  ‚Ä¢ –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä = +X –∫ —Ä–∏—Å–∫—É\n  ‚Ä¢ –°—É–º–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞\n  ‚Ä¢ üü¢ –ù–∏–∑–∫–∏–π (<30%), üü° –°—Ä–µ–¥–Ω–∏–π (30-60%), üî¥ –í—ã—Å–æ–∫–∏–π (>60%)',
      interpretation: '–ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π —Ñ–∞–∫—Ç–æ—Ä—ã —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –≤–ª–∏—è–Ω–∏–µ–º.',
      source: 'Risk assessment (behavioral prevention)',
      priority: 'CRITICAL',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.90,
      whyImportant: 'üö® –ß—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞. –ö—Ä–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è!'
    },

    // === ADVANCED ANALYTICS v2.5 ‚Äî –°–ø—Ä–∞–≤–æ—á–Ω—ã–π ===
    ADVANCED_ANALYTICS: {
      name: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞',
      short: '–ì–ª—É–±–æ–∫–∏–π —Å–ª–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—è–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏: —Ç—Ä–∏–≥–≥–µ—Ä—ã, –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∑–æ–Ω—ã –ø—Ä–æ–≥–Ω–æ–∑–∞.',
      details: '–≠—Ç–æ ¬´meta-—É—Ä–æ–≤–µ–Ω—å¬ª —Å–∏—Å—Ç–µ–º—ã, –≥–¥–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏, —Ä–∏—Å–∫-–º–æ–¥–µ–ª—å –∏ –ø—Ä–æ–≥–Ω–æ–∑ —ç–Ω–µ—Ä–≥–∏–∏. –ï–≥–æ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –∞ —Å–≤—è–∑–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞: –∫–∞–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è—é—Ç –≤–∞—à–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –∞ –∫–∞–∫–∏–µ –≤—ã–≥–ª—è–¥—è—Ç –≤–∞–∂–Ω—ã–º–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—â—É—â–µ–Ω–∏–π. –†–∞–∑–¥–µ–ª –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω –ø—Ä–∏ —Å—Ç–∞–≥–Ω–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –±–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, –Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–º–µ–¥–ª–∏–ª—Å—è. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ —Å—Ç–æ–∏—Ç –≤–º–µ—Å—Ç–µ —Å confidence: —á–µ–º –≤—ã—à–µ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–æ–≤.',
      formula: '5 –º–æ–¥—É–ª–µ–π –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:\n\nüìä Confidence Score:\n  volume √ó 0.30 + completeness √ó 0.25 + consistency √ó 0.25 + recency √ó 0.20\n\nüîó –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞:\n  Pearson r –¥–ª—è 12 –ø–∞—Ä –º–µ—Ç—Ä–∏–∫ (—Å–æ–Ω‚Üî–∫–∞–ª–æ—Ä–∏–∏, —Å—Ç—Ä–µ—Å—Å‚Üî—Å–ª–∞–¥–∫–æ–µ, –∏ –¥—Ä.)\n\nüß¨ –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:\n  ‚Ä¢ –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º (–≤–µ—Å –ø–æ—Å–ª–µ –ø—Ä–æ—Å—Ç—ã—Ö)\n  ‚Ä¢ –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å (–∂–∏—Ä—ã vs —É–≥–ª–µ–≤–æ–¥—ã)\n  ‚Ä¢ –•—Ä–æ–Ω–æ—Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è (—É—Ç—Ä–æ vs –≤–µ—á–µ—Ä)\n\n‚ö†Ô∏è Predictive Risk (EMA):\n  –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å + –Ω–µ–¥–æ—Å—ã–ø + –∏–Ω—Å—É–ª–∏–Ω –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å + –≤—Ä–µ–º—è\n\n‚ö° Energy Forecast:\n  –¶–∏—Ä–∫–∞–¥–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å √ó –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (—Å–æ–Ω, –µ–¥–∞, —Å—Ç—Ä–µ—Å—Å, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞)',
      source: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑: Brand-Miller 2003, Van Cauter 1997, Spiegel 2004',
      sources: [{ pmid: '12828192', level: 'B', title: 'Composite analytics ‚Äî Multi-source evidence synthesis' }],
      evidenceLevel: 'B',
      confidenceScore: 0.85,
      interpretation: 'Confidence >70% ‚Äî –≤—ã–≤–æ–¥—ã –Ω–∞–¥—ë–∂–Ω—ã. –°–∏–ª—å–Ω—ã–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (|r|>0.4) ‚Äî —Ç–≤–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã. –ü–∞—Ç—Ç–µ—Ä–Ω—ã ‚Äî –±–∞–∑–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.60,
      whyImportant: '–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–µ–±—è. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 7-14 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö.'
    },
    CONFIDENCE_SCORE: {
      name: 'Score –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å –≤—ã–≤–æ–¥–∞–º —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—ä—ë–º–∞, –ø–æ–ª–Ω–æ—Ç—ã –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö.',
      details: '–ú–µ—Ç–∞-–º–µ—Ç—Ä–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –¥—Ä—É–≥–∏—Ö –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ 4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞. (1) Volume (30%) ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏: 0-7 –¥–Ω–µ–π = 0-50%, 7-14 = 50-80%, 14+ = 80-100%. –ß–µ–º –±–æ–ª—å—à–µ –∞—Ä—Ö–∏–≤, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã. (2) Completeness (25%) ‚Äî –ø–æ–ª–Ω–æ—Ç–∞ –¥–Ω—è: –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ –µ–¥–∞, –≤–µ—Å, —Å–æ–Ω, —à–∞–≥–∏, –≤–æ–¥–∞ (0-5 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤). (3) Consistency (25%) ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: –µ—Å–ª–∏ –æ–¥–Ω–∏ –¥–Ω–∏ –ø–æ–ª–Ω—ã–µ, –¥—Ä—É–≥–∏–µ –ø—É—Å—Ç—ã–µ ‚Äî confidence –ø–∞–¥–∞–µ—Ç —á–µ—Ä–µ–∑ StdDev. (4) Recency (20%) ‚Äî –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è. –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–µ –∑–Ω–∞—á–∏–º—ã –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫ –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ 4 —É—Ä–æ–≤–Ω—è—Ö: Excellent (>85%) ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã, Good (70-85%), Moderate (50-70%) –∏ Low (<50%) ‚Äî –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –µ—Å–ª–∏ confidence <70%, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ ‚Äî –ª—É—á—à–µ —Å–Ω–∞—á–∞–ª–∞ —Å–æ–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö.',
      formula: 'Confidence = Volume√ó0.30 + Completeness√ó0.25 + Consistency√ó0.25 + Recency√ó0.20\n\nVolume: 0-7 –¥–Ω–µ–π ‚Üí 0-50%, 7-14 ‚Üí 50-80%, 14+ ‚Üí 80-100%\nCompleteness: (meals + weight + sleep + steps + water) / 5\nConsistency: 100 - StdDev(dailyCompleteness)\nRecency: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è',
      interpretation: '>85% Excellent ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã. 70-85% Good. 50-70% Moderate. <50% Low ‚Äî –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö.',
      source: 'Data quality assessment (information theory)',
      priority: 'LOW',
      category: 'STATISTICS',
      actionability: 'INFORMATIONAL',
      impactScore: 0.30,
      whyImportant: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å –≤—ã–≤–æ–¥–∞–º. –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö = —Ç–æ—á–Ω–µ–µ –∞–Ω–∞–ª–∏–∑.'
    },
    // Correlation Matrix ‚Äî –°—Ä–µ–¥–Ω–∏–π, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
    CORRELATION_MATRIX: {
      name: '–ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø—Ä–∏–≤—ã—á–∫–∞–º–∏ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∞ –Ω–µ –ø–æ –æ–±—â–∏–º —Å–æ–≤–µ—Ç–∞–º.',
      details: '–ú–∞—Ç—Ä–∏—Ü–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–¥–µ–ª–∏—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã–µ —Å–≤—è–∑–∏ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–ª–∏—è–µ—Ç –ª–∏ —Å–æ–Ω –Ω–∞ –∞–ø–ø–µ—Ç–∏—Ç –∏–º–µ–Ω–Ω–æ —É –≤–∞—Å –∏ —Å –∫–∞–∫–æ–π —Å–∏–ª–æ–π. –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏: —Å–∏–ª—å–Ω—ã–µ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ ‚Äî –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ –ø–µ—Ä–≤—ã–µ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–∞–º–∞ –ø–æ —Å–µ–±–µ –Ω–µ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ª—É—á—à–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –Ω–µ–±–æ–ª—å—à–∏–º–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏ 1‚Äì2 –Ω–µ–¥–µ–ª–∏. –ß–µ–º –¥–ª–∏–Ω–Ω–µ–µ –∏ —á–∏—â–µ –∏—Å—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö, —Ç–µ–º –º–µ–Ω—å—à–µ —Ä–∏—Å–∫ –ª–æ–∂–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤.',
      formula: 'Pearson correlation r = Œ£[(xi-xÃÑ)(yi-»≥)] / ‚àö[Œ£(xi-xÃÑ)¬≤ √ó Œ£(yi-»≥)¬≤]\n\n–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–µ –ø–∞—Ä—ã:\n  ‚Ä¢ –°–æ–Ω ‚Üî –ö–∞–ª–æ—Ä–∏–∏, –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –°–ª–∞–¥–∫–æ–µ\n  ‚Ä¢ –®–∞–≥–∏ ‚Üî –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –í–µ—Å\n  ‚Ä¢ –°—Ç—Ä–µ—Å—Å ‚Üî –°–ª–∞–¥–∫–æ–µ, –ö–∞–ª–æ—Ä–∏–∏\n  ‚Ä¢ –ë–µ–ª–æ–∫/–ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üî –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ\n  ‚Ä¢ –í–æ–¥–∞ ‚Üî –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ\n  ‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üî –°–æ–Ω, –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
      source: 'Statistical correlation analysis (Pearson 1895)',
      interpretation: '|r| > 0.7 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å. 0.4-0.7 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <0.4 ‚Äî —Å–ª–∞–±–∞—è. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: + = –ø—Ä—è–º–∞—è, ‚àí = –æ–±—Ä–∞—Ç–Ω–∞—è.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.55,
      whyImportant: '–¢–≤–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ = –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –Ω–∏–º–∏.'
    },
    // Metabolic Patterns ‚Äî –í—ã—Å–æ–∫–∏–π, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
    METABOLIC_PATTERNS: {
      name: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã',
      short: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏, —á—Ç–æ–±—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–∏—Ç–∞–Ω–∏—è –±—ã–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π, –∞ –Ω–µ ¬´—Å—Ä–µ–¥–Ω–µ–π –ø–æ –±–æ–ª—å–Ω–∏—Ü–µ¬ª.',
      details: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ–ø–∏—Å—ã–≤–∞—é—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –µ–¥—É –∏ —Ä–µ–∂–∏–º: —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º, –ø—Ä–æ—Ñ–∏–ª—å —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∂–∏—Ä–∞—Ö, —Ö—Ä–æ–Ω–æ—Ç–∏–ø –∏ —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Å—Ç—Ä–µ—Å—Å. –ò—Ö —Å–∏–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –ø–µ—Ä–µ–≤–æ–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: –∫–æ–≥–¥–∞ –≤–∞–º –ª–µ–≥—á–µ –¥–µ—Ä–∂–∞—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç, –∫–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –ø–∏—Ç–∞–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤–µ–µ, –≤ –∫–∞–∫–∏–µ —á–∞—Å—ã –≤—ã—à–µ —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫. –≠—Ç–æ –Ω–µ ¬´—è—Ä–ª—ã–∫–∏¬ª, –∞ —Ä–∞–±–æ—á–∏–µ –≥–∏–ø–æ—Ç–µ–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —É—Ç–æ—á–Ω—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç ‚Äî –º–µ–Ω—å—à–µ —Ç—Ä–µ–Ω–∏—è –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö –∏ –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å.',
      formula: '4 —Ç–∏–ø–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:\n\n1. Carb Sensitivity:\n  Œî–≤–µ—Å –ø–æ—Å–ª–µ >50–≥ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ vs <30–≥\n  High (>0.5–∫–≥) / Moderate / Low\n\n2. Fat Adaptation:\n  –≠–Ω–µ—Ä–≥–∏—è –ø—Ä–∏ fat/carb ratio >0.5 vs <0.3\n  Adapted / Neutral / Carb-dependent\n\n3. Chronotype:\n  –ö–∞—á–µ—Å—Ç–≤–æ –¥–Ω—è –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–º (<9:00) vs –ø–æ–∑–¥–Ω–µ–º (>11:00) –∑–∞–≤—Ç—Ä–∞–∫–µ\n  Early bird / Night owl / Neutral\n\n4. Stress Eating:\n  –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å—Ç—Ä–µ—Å—Å ‚Üî –∫–∞–ª–æ—Ä–∏–∏\n  High / Moderate / Restriction / None',
      source: 'Behavioral nutrition patterns (Taheri 2004, Van Cauter 1997)',
      sources: [{ pmid: '15602591', level: 'B', title: 'Taheri et al., 2004 ‚Äî Short sleep duration metabolic patterns' }],
      evidenceLevel: 'B',
      confidenceScore: 0.84,
      interpretation: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–Ω—è—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–∏—Ç–∞–Ω–∏—è.',
      priority: 'HIGH',
      category: 'PATTERNS',
      actionability: 'LONG_TERM',
      impactScore: 0.75,
      whyImportant: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å. –ó–Ω–∞–Ω–∏–µ —Å–µ–±—è = –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.'
    },
    // Predictive Risk ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
    PREDICTIVE_RISK: {
      name: '–ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω—ã–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞',
      short: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å—Ä—ã–≤–∞ –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –¥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Ç–æ—á–∫–∏.',
      details: '–ú–æ–¥–µ–ª—å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ –æ–¥–∏–Ω —Ç—Ä–∏–≥–≥–µ—Ä, –∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ñ–∞–∫—Ç–æ—Ä–æ–≤: —Å—Ç—Ä–µ—Å—Å, –¥–æ–ª–≥ —Å–Ω–∞, –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è. –ó–∞ —Å—á—ë—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (EMA) —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ ¬´—Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ¬ª, –Ω–æ –∏ –∏–Ω–µ—Ä—Ü–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–Ω–µ–π ‚Äî —ç—Ç–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –∫ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏. –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å—Ä—ã–≤ –Ω–µ–∏–∑–±–µ–∂–µ–Ω, –∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è: —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏, –±–µ–ª–æ–∫/–∫–ª–µ—Ç—á–∞—Ç–∫–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ —Ä–∞–∑–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–µ—Å—Å–∞. –¶–µ–ª—å –º–µ—Ç—Ä–∏–∫–∏ ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ–µ.',
      formula: 'Risk Score = Œ£(—Ñ–∞–∫—Ç–æ—Ä—ã √ó –≤–µ—Å–∞):\n  ‚Ä¢ –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å EMA (Œ±=0.3): 25%\n  ‚Ä¢ –î–æ–ª–≥ —Å–Ω–∞ –∑–∞ 7 –¥–Ω–µ–π: 25%\n  ‚Ä¢ –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: 20%\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–≤—ã—Ö–æ–¥–Ω—ã–µ, –≤–µ—á–µ—Ä): 20%\n  ‚Ä¢ –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –Ω–µ–¥–æ–±–æ—Ä: 10%\n\nEMA = Œ± √ó current + (1-Œ±) √ó previous',
      source: 'Behavioral relapse prevention (Marlatt 1985), Sleep debt (Spiegel 1999)',
      sources: [{ pmid: '19179058', level: 'A', title: 'Marlatt & Donovan, 2005 ‚Äî Relapse prevention evidence synthesis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.92,
      interpretation: '>70% High ‚Äî –±—É–¥—å –æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º. 40-70% Moderate ‚Äî —Å–ª–µ–¥–∏ –∑–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏. <40% Low ‚Äî –≤—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º.',
      priority: 'CRITICAL',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.92,
      whyImportant: 'üö® –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ä—ã–≤ –î–û —Ç–æ–≥–æ –∫–∞–∫ –æ–Ω —Å–ª—É—á–∏—Ç—Å—è. –ö—Ä–∞—Å–Ω—ã–π = –¥–µ–π—Å—Ç–≤—É–π!'
    },
    // Energy Forecast ‚Äî –í—ã—Å–æ–∫–∏–π
    ENERGY_FORECAST: {
      name: '–ü—Ä–æ–≥–Ω–æ–∑ —ç–Ω–µ—Ä–≥–∏–∏',
      short: '–ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, –≤ –∫–∞–∫–∏–µ —á–∞—Å—ã –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø–∏–∫ –∏–ª–∏ —Å–ø–∞–¥ —ç–Ω–µ—Ä–≥–∏–∏, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ, –∑–∞–¥–∞—á–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.',
      details: '–ü—Ä–æ–≥–Ω–æ–∑ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —Ü–∏—Ä–∫–∞–¥–Ω–æ–π –∫—Ä–∏–≤–æ–π –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤–∞—à–∏–º —Ç–µ–∫—É—â–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º: —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –ø–∏—Ç–∞–Ω–∏–µ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å ¬´–ø–æ —Ä–µ—Å—É—Ä—Å—É¬ª, –∞ –Ω–µ –ø—Ä–æ—Ç–∏–≤ –Ω–µ–≥–æ: –≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –Ω–∞–≥—Ä—É–∑–∫—É —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–∏–∫–∏, –∞ —Ä—É—Ç–∏–Ω–Ω—ã–µ –¥–µ–ª–∞ ‚Äî –Ω–∞ –ø–µ—Ä–∏–æ–¥—ã —Å–ø–∞–¥–∞. –ú–µ—Ç—Ä–∏–∫–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –≤–µ—á–µ—Ä–Ω–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ø–∏—Ç–∞–Ω–∏–∏, –∫–æ–≥–¥–∞ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Ä–µ—Å—É—Ä—Å —Å–Ω–∏–∂–∞–µ—Ç—Å—è. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–µ –Ω–∞ –æ–¥–∏–Ω —á–∞—Å, –∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å –¥–Ω—è –≤ —Ü–µ–ª–æ–º.',
      formula: 'EnergyHour = BaseCircadian √ó TotalMod\n\nBaseCircadian (Van Cauter 1997):\n  00-05: 10-25%\n  06-11: 40-90%\n  12-17: 70-90%\n  18-23: 25-65%\n\nTotalMod = sleepMod √ó kcalMod √ó stressMod √ó trainingMod\n  Sleep: ‚â•7h=1.1, <5h=0.7\n  Kcal: ‚â•80%=1.1, <30%=0.75\n  Stress: ‚â§3=1.1, >7=0.8\n  Training: yes=1.15, no=1.0',
      source: 'Circadian rhythm research (Van Cauter 1997, Scheer 2009)',
      sources: [{ pmid: '9331550', level: 'B', title: 'Van Cauter et al., 1997 ‚Äî Circadian variation in metabolism' }],
      evidenceLevel: 'B',
      confidenceScore: 0.86,
      interpretation: 'Peak ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–µ–ª –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. Dip ‚Äî –∑–∞–ø–ª–∞–Ω–∏—Ä—É–π –æ—Ç–¥—ã—Ö –∏–ª–∏ —Ä—É—Ç–∏–Ω—É.',
      priority: 'HIGH',
      category: 'PREDICTION',
      actionability: 'TODAY',
      impactScore: 0.70,
      whyImportant: '–ü–ª–∞–Ω–∏—Ä—É–π –¥–µ–Ω—å –ø–æ —ç–Ω–µ—Ä–≥–∏–∏. –í–∞–∂–Ω—ã–µ –¥–µ–ª–∞ ‚Äî –Ω–∞ –ø–∏–∫–µ!'
    },

    // === SCIENTIFIC ANALYTICS v3.0 ‚Äî –ù–∞—É—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ ===
    BAYESIAN_CONFIDENCE: {
      name: '–ë–∞–π–µ—Å–æ–≤—Å–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å + MAPE',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≥–Ω–æ–∑–∞–º –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å —Å —É—á—ë—Ç–æ–º –æ—à–∏–±–æ–∫ –º–æ–¥–µ–ª–∏ –∏ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –ø—Ä–æ–≥–Ω–æ–∑–∞ (MAPE/MAE/RMSE) –∏ –±–∞–π–µ—Å–æ–≤—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–∏—è –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏–π. –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç ¬´–ª–æ–∂–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏¬ª, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ –∏–ª–∏ –æ–Ω–∏ —à—É–º–Ω—ã–µ. –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –≤—ã—Å–æ–∫–∏–π confidence –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–≥–Ω–æ–∑—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∞ –Ω–∏–∑–∫–∏–π ‚Äî —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –ª—É—á—à–µ —É–ª—É—á—à–∏—Ç—å –ø–æ–ª–Ω–æ—Ç—É –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∏–Ω–≥–∞. –°–º—ã—Å–ª –±–ª–æ–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ ¬´—á—Ç–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º¬ª, –Ω–æ –∏ ¬´–Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –Ω–∞–¥—ë–∂–Ω–æ¬ª.',
      formula: 'MAPE = (1/n) √ó Œ£|actual - predicted| / actual √ó 100%\n\nBayesian update:\n  posterior ‚àù prior √ó likelihood\n  prior = 0.5 (–±–∞–∑–æ–≤–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)\n  likelihood = mapeLikelihood √ó nLikelihood √ó consistencyLikelihood\n\nCross-validation:\n  R¬≤ = 1 - SSres/SStot\n  RMSE = ‚àö(Œ£(actual-pred)¬≤/n)\n  MAE = Œ£|actual-pred|/n',
      source: 'Gelman et al. "Bayesian Data Analysis" (2013); Hyndman & Koehler 2006',
      pmid: '13524500',
      interpretation: '>80% confidence ‚Äî –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. <50% ‚Äî –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö.',
      priority: 'LOW',
      category: 'STATISTICS',
      actionability: 'INFORMATIONAL',
      impactScore: 0.25,
      whyImportant: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã –ø—Ä–æ–≥–Ω–æ–∑—ã. –í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å = –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å.'
    },
    // Time-Lagged ‚Äî –°—Ä–µ–¥–Ω–∏–π, –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å
    TIME_LAGGED_CORRELATIONS: {
      name: 'Time-Lagged –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (–ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å)',
      short: '–ê–Ω–∞–ª–∏–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (lags 0-3 –¥–Ω—è) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –†–ï–ê–õ–¨–ù–û –≤–ª–∏—è—é—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ (–ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å).',
      details: '–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (¬´—Å–≤—è–∑—å¬ª), time-lagged –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –ø—Ä–∏—á–∏–Ω–Ω—ã–π –ª–∞–≥ (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏) –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏. –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—ã–ø –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ–º –≤ –≤—Ç–æ—Ä–Ω–∏–∫ (lag=1), —ç—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—É—é —Å–≤—è–∑—å. –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∞–≥–∏ 0-3 –¥–Ω—è –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã –∏ —Å—á–∏—Ç–∞–µ—Ç –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–π, –µ—Å–ª–∏ |r(lag>0)| > |r(lag=0)| + 0.1 (—Ç.–µ. –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å –ª–∞–≥–æ–º —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è). –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ —Å–æ–Ω –†–ï–ê–õ–¨–ù–û –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å, —Ç–æ —ç—Ç–æ knowledge-based —Ç–æ—á–∫–∞ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä—ã: —Å–æ–Ω‚Üí–∫–∞–ª–æ—Ä–∏–∏, —Å—Ç—Ä–µ—Å—Å‚Üí—Å–ª–∞–¥–∫–æ–µ, –∫–∞–ª–æ—Ä–∏–∏‚Üí–≤–µ—Å (lag 1-2 –¥–Ω—è –¥–ª—è –≤–µ—Å–∞). –°–∏–ª–∞ –º–µ—Ç–æ–¥–∞ –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω –ø–µ—Ä–µ–≤–æ–¥–∏—Ç ¬´–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ¬ª –≤ ¬´–≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ¬ª: –¥–∞—ë—Ç –º–µ—Å—Ç–æ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞.',
      formula: 'Granger-like causality:\n  –õ–∞–≥–∏ 0-3 –¥–Ω—è –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã\n  r(lag) = corr(X[t-lag], Y[t])\n  \n–ü—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –µ—Å–ª–∏:\n  |r(lag>0)| > |r(lag=0)| + 0.1\n\n–ü–∞—Ä—ã: —Å–æ–Ω‚Üí–∫–∞–ª–æ—Ä–∏–∏, —Å—Ç—Ä–µ—Å—Å‚Üí—Å–ª–∞–¥–∫–æ–µ, –∫–∞–ª–æ—Ä–∏–∏‚Üí–≤–µ—Å',
      source: 'Granger 1969 ‚Äî Investigating Causal Relations',
      pmid: '7608935',
      interpretation: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ X –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ Y —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.50,
      whyImportant: '–ß—Ç–æ –†–ï–ê–õ–¨–ù–û –≤–ª–∏—è–µ—Ç –Ω–∞ —á—Ç–æ. –ù–µ –ø—Ä–æ—Å—Ç–æ —Å–≤—è–∑—å, –∞ –ø—Ä–∏—á–∏–Ω–∞!'
    },
    // GVI ‚Äî –í—ã—Å–æ–∫–∏–π, –≤–ª–∏—è–µ—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω
    GLYCEMIC_VARIABILITY: {
      name: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (GVI + CONGA)',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å ¬´—Å–∫–∞—á–∫–æ–≤ —Å–∞—Ö–∞—Ä–∞¬ª –ø–æ –ø–∏—â–µ–≤–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é: –Ω–∏–∂–µ –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ —ç–Ω–µ—Ä–≥–∏—è –∏ –∞–ø–ø–µ—Ç–∏—Ç.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ (CV%, CONGA), —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑–∫–æ –∫–æ–ª–µ–±–ª–µ—Ç—Å—è –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏. –î–∞–∂–µ –±–µ–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≥–ª—é–∫–æ–∑—ã —ç—Ç–æ –ø–æ–ª–µ–∑–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏: —á–µ–º –≤—ã—à–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, —Ç–µ–º —á–∞—â–µ –Ω–∞–±–ª—é–¥–∞—é—Ç—Å—è —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ ¬´–∫–∞—á–µ–ª–∏¬ª –∏ —Ç—è–≥–∞ –∫ –±—ã—Å—Ç—Ä—ã–º —É–≥–ª–µ–≤–æ–¥–∞–º. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª ‚Äî –Ω–µ —É–±—Ä–∞—Ç—å —É–≥–ª–µ–≤–æ–¥—ã, –∞ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∏–≤—É—é —Ä–æ–≤–Ω–µ–µ: –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–µ—Ç—á–∞—Ç–∫—É, –±–µ–ª–æ–∫, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª—é –ø—Ä–æ—Å—Ç—ã—Ö —Å–∞—Ö–∞—Ä–æ–≤ –∏ —Ç–∞–π–º–∏–Ω–≥. –£—Å—Ç–æ–π—á–∏–≤–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—ã—á–Ω–æ —É–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –≥–æ–ª–æ–¥–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
      formula: 'GVI (CV%) = (SD / Mean) √ó 100\n  SD = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ GL –ø—Ä–∏—ë–º–æ–≤\n  Mean = —Å—Ä–µ–¥–Ω—è—è GL –ø—Ä–∏—ë–º–æ–≤\n\nCONGA = —Å—Ä–µ–¥–Ω–µ–µ |GL[i] - GL[i-1]|\n  (Continuous Overall Net Glycemic Action)\n\n–ü–æ—Ä–æ–≥–∏ (Monnier 2006):\n  <25% ‚Äî –Ω–∏–∑–∫–∞—è (—Ö–æ—Ä–æ—à–æ)\n  25-36% ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è\n  36-50% ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è\n  >50% ‚Äî –≤—ã—Å–æ–∫–∞—è (—Ä–∏—Å–∫)',
      source: 'Monnier et al. 2006 ‚Äî Glycemic variability and diabetes',
      sources: [{ pmid: '16936182', level: 'A', title: 'Monnier et al., 2006 ‚Äî Glycemic variability meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.91,
      interpretation: '–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å = —Å–∫–∞—á–∫–∏ —Å–∞—Ö–∞—Ä–∞ = –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å. –¶–µ–ª—å: CV% <36%.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'WEEKLY',
      impactScore: 0.80,
      whyImportant: '–°–∫–∞—á–∫–∏ —Å–∞—Ö–∞—Ä–∞ = –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å = –∑–¥–æ—Ä–æ–≤—å–µ.'
    },
    // Allostatic Load ‚Äî –í—ã—Å–æ–∫–∏–π, –æ–±—â–∏–π —Å—Ç—Ä–µ—Å—Å
    ALLOSTATIC_LOAD: {
      name: '–ê–ª–ª–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã–π ¬´–∏–∑–Ω–æ—Å¬ª —Å–∏—Å—Ç–µ–º—ã –æ—Ç —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞, –Ω–µ–¥–æ—Å—ã–ø–∞ –∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è.',
      details: '–ê–ª–ª–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–≥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —É–º–µ—Ä–µ–Ω–Ω–æ, –Ω–æ –≤ —Å—É–º–º–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—é—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ä–∞–∑–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫, —ç—Ç–æ—Ç –∏–Ω–¥–µ–∫—Å –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å —Ç—Ä–µ–Ω–¥ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è. –í—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω—ã —Å —É—Ö—É–¥—à–µ–Ω–∏–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, –∫–æ–Ω—Ç—Ä–æ–ª—è –∞–ø–ø–µ—Ç–∏—Ç–∞ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ —Å—Ç—Ä–µ—Å—Å—É. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–∏–≥–Ω–∞–ª —Ä–∞–∑–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É: –≤—ã—Ä–æ–≤–Ω—è—Ç—å —Å–æ–Ω, —Å–Ω–∏–∑–∏—Ç—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–∏–æ–¥ –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —Ä–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è.',
      formula: 'AL Score = Œ£(component √ó weight)\n\n–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–≤–µ—Å–∞):\n  1. –ö–æ—Ä—Ç–∏–∑–æ–ª proxy (—Å—Ç—Ä–µ—Å—Å): 20%\n  2. –ù–µ–¥–æ—Å—ã–ø (sleep debt): 20%\n  3. –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å: 15%\n  4. –í–æ—Å–ø–∞–ª–µ–Ω–∏–µ (harm proxy): 15%\n  5. –ì–∏–ø–æ–¥–∏–Ω–∞–º–∏—è: 15%\n  6. –≠–º–æ—Ü. –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: 15%\n\n–ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç 0-100, –∏—Ç–æ–≥ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω.',
      source: 'McEwen 1998 ‚Äî Protective and Damaging Effects of Stress Mediators',
      sources: [{ pmid: '9428090', level: 'A', title: 'McEwen, 1998 ‚Äî Allostatic load meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.90,
      interpretation: '<30 ‚Äî –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞. 30-50 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. 50-70 ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è. >70 ‚Äî –≤—ã—Å–æ–∫–∞—è (burnout —Ä–∏—Å–∫).',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'WEEKLY',
      impactScore: 0.75,
      whyImportant: '–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å –æ—Ä–≥–∞–Ω–∏–∑–º–∞. –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ = —Ä–∏—Å–∫ –≤—ã–≥–æ—Ä–∞–Ω–∏—è.'
    },
    // EWS ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, —Ä–∞–Ω–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    EARLY_WARNING_SIGNALS: {
      name: '–†–∞–Ω–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ —Å–∏–≥–Ω–∞–ª—ã (EWS)',
      short: '–ò—â–µ—Ç —Ä–∞–Ω–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è —Å—Ä—ã–≤–∞, —á—Ç–æ–±—ã –≤–º–µ—à–∞—Ç—å—Å—è –∑–∞—Ä–∞–Ω–µ–µ, –ø–æ–∫–∞ —Å–∏—Ç—É–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è.',
      details: 'EWS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç ¬´–ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏¬ª —Å–∏—Å—Ç–µ–º—ã: —Ä–æ—Å—Ç –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –∏ —Å–º–µ—â–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è. –≠—Ç–∏ —Å–∏–≥–Ω–∞–ª—ã –≤–∞–∂–Ω—ã —Ç–µ–º, —á—Ç–æ –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥–æ —è–≤–Ω–æ–≥–æ —É—Ö—É–¥—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ —ç–ø–∏–∑–æ–¥–∞ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è). –ú–µ—Ç—Ä–∏–∫–∞ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É, –Ω–æ —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω–Ω–∏–π –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π —Ä–∞–¥–∞—Ä. –í—ã—Å–æ–∫–∏–π EWS ‚Äî –ø–æ–≤–æ–¥ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏: —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É —Ä–µ—à–µ–Ω–∏–π, —É—Å–∏–ª–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ä–∏—Ç—É–∞–ª—ã –∏ —É–±—Ä–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏–∑ —Å—Ä–µ–¥—ã.',
      formula: '–¢–µ–æ—Ä–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:\n  1. Rising variance: var(recent) / var(previous) > 1.5\n  2. Autocorrelation: lag-1 autocorr > 0.5 (—Å–∏—Å—Ç–µ–º–∞ "–∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç")\n  3. Skewness: >0.5 = –ø–µ—Ä–µ–∫–æ—Å –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é\n  4. Trend: slope –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π >0.05\n\nEWS Score = Œ£(signal √ó weight)\n  variance: 35%, autocorr: 35%, skewness: 20%, trend: 10%',
      source: 'Scheffer et al. 2009 ‚Äî Early Warning Signals for Critical Transitions (Nature)',
      sources: [{ pmid: '19727193', level: 'A', title: 'Scheffer et al., 2009 ‚Äî Early-warning signals for critical transitions' }],
      evidenceLevel: 'A',
      confidenceScore: 0.93,
      interpretation: 'EWS >70 ‚Äî —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –≥—Ä–∞–Ω–∏ —Å—Ä—ã–≤–∞, –¥–µ–π—Å—Ç–≤—É–π –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ!',
      priority: 'CRITICAL',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.88,
      whyImportant: '‚ö° –†–∞–Ω–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ! –°–∏—Å—Ç–µ–º–∞ –∑–∞–º–µ—á–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –î–û —Å—Ä—ã–≤–∞.'
    },
    // 2-Process ‚Äî –°—Ä–µ–¥–Ω–∏–π, –±–æ–¥—Ä–æ—Å—Ç—å
    TWO_PROCESS_MODEL: {
      name: '2-Process Model (–ë–æ–¥—Ä–æ—Å—Ç—å)',
      short: '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å –±–æ–¥—Ä–æ—Å—Ç–∏ –∏ —ç–Ω–µ—Ä–≥–∏–∏, —É—á–∏—Ç—ã–≤–∞—é—â–∞—è –≤—Ä–µ–º—è –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ —Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º.',
      details: 'Two-Process Model (Borb√©ly 1982) ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å —Ä–µ–≥—É–ª—è—Ü–∏–∏ —Å–Ω–∞/–±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑–¥–µ–ª—è–µ—Ç –¥–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞. Process S (–≥–æ–º–µ–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∞) ‚Äî —Ä–∞—Å—Ç—ë—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å –∫–∞–∂–¥—ã–º —á–∞—Å–æ–º –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è (—Ç–∞—É —Ä–∞–≤–µ–Ω 18.2—á), —á–µ–º –¥–æ–ª—å—à–µ –Ω–µ —Å–ø–∏—Ç–µ ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ö–æ—á–µ—Ç—Å—è. Process C (—Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º) ‚Äî —Å–∏–Ω—É—Å–æ–∏–¥–∞ —Å –ø–∏–∫–æ–º –≤ 15-16—á –∏ –º–∏–Ω–∏–º—É–º–æ–º –≤ 4—á, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è, 24-—á–∞—Å–æ–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —á–∞—Å–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º. Alertness (–±–æ–¥—Ä–æ—Å—Ç—å) = C ‚àí S. –ß–µ–º –≤—ã—à–µ —Ü–∏—Ä–∫–∞–¥–Ω—ã–π –ø–∏–∫ –∏ –Ω–∏–∂–µ –¥–æ–ª–≥ —Å–Ω–∞, —Ç–µ–º –≤—ã—à–µ –±–æ–¥—Ä–æ—Å—Ç—å. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –º–æ–¥–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –ø–æ—á–µ–º—É –ø–æ—Å–ª–µ –æ–±–µ–¥–∞ (14-16—á) –µ—Å—Ç—å –ø—Ä–æ–≤–∞–ª —ç–Ω–µ—Ä–≥–∏–∏, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø–∏–∫ C (—Ç.–∫. S —É–∂–µ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å), –∏ –ø–æ—á–µ–º—É —É—Ç—Ä–æ–º (6-9—á) –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç—Ä—É–¥–Ω–æ, –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—ã–ø (–Ω–∏–∑–∫–æ–µ C + –≤—ã—Å–æ–∫–æ–µ S). –ú–æ–¥–µ–ª—å —Ç–∞–∫–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç ultradian —Ü–∏–∫–ª—ã (90 –º–∏–Ω—É—Ç –≤–Ω–∏–º–∞–Ω–∏—è). –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–Ω—è: —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ ‚Äî –Ω–∞ —É—Ç—Ä–æ (9-12—á, –∫–æ–≥–¥–∞ C —Ä–∞—Å—Ç—ë—Ç), —Ä—É—Ç–∏–Ω—É ‚Äî –Ω–∞ 14-16—á (post-lunch dip), —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –Ω–∞ 16-19—á (–ø–∏–∫ C).',
      formula: 'Borb√©ly 1982:\n  Alertness = Process C - Process S\n\nProcess S (–≥–æ–º–µ–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∞):\n  S(t) = S0 √ó e^(t/œÑ_w)\n  œÑ_w = 18.2—á, S0 = 0.2-0.4 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–æ–ª–≥–∞ —Å–Ω–∞)\n\nProcess C (—Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º):\n  C(t) = 0.5 + 0.5 √ó cos(2œÄ √ó (t - 16) / 24)\n  –ü–∏–∫ –≤ 15-16—á, –º–∏–Ω–∏–º—É–º –≤ 4—á\n\nUltradian: 90-–º–∏–Ω —Ü–∏–∫–ª—ã –≤–Ω–∏–º–∞–Ω–∏—è',
      source: 'Borb√©ly 1982 ‚Äî A two process model of sleep regulation',
      sources: [{ pmid: '6128309', level: 'A', title: 'Borb√©ly, 1982 ‚Äî Two-process model of sleep regulation' }],
      evidenceLevel: 'A',
      confidenceScore: 0.92,
      interpretation: 'Alertness –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–æ–¥—Ä–æ—Å—Ç–∏ —Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ —Ü–∏—Ä–∫–∞–¥–Ω–æ—Å—Ç–∏.',
      priority: 'MEDIUM',
      category: 'RECOVERY',
      actionability: 'TODAY',
      impactScore: 0.45,
      whyImportant: '–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤ –±–æ–¥—Ä–æ—Å—Ç–∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ.'
    },

    // === CONFIDENCE (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å) ‚Äî –ù–∏–∑–∫–∏–π ===
    CONFIDENCE: {
      name: '–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∞–Ω–∞–ª–∏–∑–µ',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã–≤–æ–¥—ã –Ω–∞–¥—ë–∂–Ω—ã –Ω–∞ —Ç–µ–∫—É—â–µ–º –æ–±—ä—ë–º–µ –∏ –∫–∞—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö.',
      details: '–ü—Ä–æ—Å—Ç–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª–Ω—ã—Ö –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–ª–µ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (targetDays), —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ dataQuality (–ø–æ–ª–Ω–æ—Ç—É –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è). dataQuality —É—á–∏—Ç—ã–≤–∞–µ—Ç: (1) –ü–æ–ª–Ω–æ—Ç–∞ ‚Äî –µ—Å—Ç—å –ª–∏ –≤–µ—Å, —Å–æ–Ω, –µ–¥–∞, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –∫–∞–∂–¥–æ–º –¥–Ω–µ; (2) –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å ‚Äî –Ω–µ—Ç –ª–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤ >2 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥; (3) –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–º–∏. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª: >80% ‚Äî –Ω–∞–¥—ë–∂–Ω–æ, –º–æ–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è; 50-80% ‚Äî —Ç—Ä–µ–Ω–¥—ã –≤–∏–¥–Ω—ã, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏; <50% ‚Äî –Ω—É–∂–Ω–æ –Ω–∞–∫–æ–ø–∏—Ç—å –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–ª–∏—á–∏–µ –æ—Ç Confidence Score: CONFIDENCE ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è, Confidence Score ‚Äî —Å–ª–æ–∂–Ω–∞—è –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Å 4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.',
      formula: 'confidence = (daysWithData / targetDays) √ó dataQuality\n\ndataQuality –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:\n  ‚Ä¢ –ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (–≤–µ—Å, —Å–æ–Ω, –µ–¥–∞, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)\n  ‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è\n  ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤',
      sources: [{ pmid: '24566440', level: 'C', title: 'Data quality in digital health (statistical methods)' }],
      evidenceLevel: 'C',
      confidenceScore: 0.73,
      interpretation: '>80% ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã. 50-80% ‚Äî —Ç—Ä–µ–Ω–¥—ã –≤–∏–¥–Ω—ã. <50% ‚Äî –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö.',
      priority: 'LOW',
      category: 'STATISTICS',
      actionability: 'INFORMATIONAL',
      impactScore: 0.25,
      whyImportant: '–ß–µ–º –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ –∞–Ω–∞–ª–∏–∑. –ó–∞–ø–æ–ª–Ω—è–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!'
    },

    // === RISK PANEL ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π ===
    CRASH_RISK: {
      name: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞',
      short: '–û—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å—Ä—ã–≤–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã. –ß–µ–º –≤—ã—à–µ —Ä–∏—Å–∫, —Ç–µ–º –≤–∞–∂–Ω–µ–µ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.',
      details: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Å—É–º–º–∞—Ä–Ω—ã–π –≤–∫–ª–∞–¥ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –∏ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (—Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –∫–∞–ª–æ—Ä–∏–π–Ω—ã–π –¥–æ–ª–≥, –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫–∞, –≤—Ä–µ–º—è —Å—É—Ç–æ–∫, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã). –í–∞–∂–Ω–∞ –Ω–µ —Ç–æ–ª—å–∫–æ ¬´–∫—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞¬ª, –Ω–æ –∏ –¥–∏–Ω–∞–º–∏–∫–∞: —Ä–æ—Å—Ç —Ä–∏—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —á–∞—Å—Ç–æ –æ–ø–∞—Å–Ω–µ–µ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ –≤—Å–ø–ª–µ—Å–∫–∞. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –º–µ—Ç—Ä–∏–∫–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å: –∑–∞–∫—Ä—ã—Ç—å –±–∞–∑–æ–≤—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (—Å–æ–Ω/–µ–¥–∞/–≤–æ–¥–∞), —Å–Ω–∏–∑–∏—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É, —É–±—Ä–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞. –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–Ω–Ω–µ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –∞ –Ω–µ –æ—Ü–µ–Ω–∫–∞ ¬´—Å–∏–ª—ã –≤–æ–ª–∏¬ª.',
      formula: '–ê–Ω–∞–ª–∏–∑ 15+ —Ñ–∞–∫—Ç–æ—Ä–æ–≤:\n  ‚Ä¢ –ù–µ–¥–æ—Å—ã–ø (<6—á): +15-25 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –°—Ç—Ä–µ—Å—Å (>6): +10-20 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –ö–∞–ª–æ—Ä–∏–π–Ω—ã–π –¥–æ–ª–≥ (>500 –∫–∫–∞–ª): +15 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≤—Ç—Ä–∞–∫–∞: +10 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –í–µ—á–µ—Ä–Ω–µ–µ –≤—Ä–µ–º—è (>20:00): +5-15 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è —Å—Ä—ã–≤–æ–≤ (–ø–∞—Ç—Ç–µ—Ä–Ω—ã): +10-20 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –ù–∏–∑–∫–∏–π –±–µ–ª–æ–∫ (<80%): +10 –±–∞–ª–ª–æ–≤\n  ‚Ä¢ –ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ (<50%): +8 –±–∞–ª–ª–æ–≤\n\n–ò—Ç–æ–≥–æ: 0-100%',
      source: 'Spaeth et al., 2013; Nedeltcheva et al., 2010',
      sources: [{ pmid: '23479616', level: 'A', title: 'Spaeth et al., 2013 ‚Äî Sleep restriction and craving meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.95,
      interpretation: '<30% ‚Äî –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫. 30-60% ‚Äî —Å—Ä–µ–¥–Ω–∏–π (—Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è). >60% ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞.',
      priority: 'CRITICAL',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.95,
      whyImportant: 'üö® –ì–ª–∞–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä! –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—Ä—ã–≤–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã.'
    },
    // Risk Factors ‚Äî –í—ã—Å–æ–∫–∏–π
    RISK_FACTORS: {
      name: '–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞',
      short: '–†–∞–∑–±–∏—Ä–∞–µ—Ç —Ä–∏—Å–∫ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –∏–∑ –Ω–∏—Ö –¥–∞—é—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.',
      details: '–≠—Ç–æ—Ç –±–ª–æ–∫ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–µ—Ç –æ–±—â–∏–π —Ä–∏—Å–∫ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Å –≤–µ—Å–∞–º–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–µ—Ä–≤—ã–º. –ì–ª–∞–≤–Ω–∞—è –ø–æ–ª—å–∑–∞ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è: —Ñ–∞–∫—Ç–æ—Ä—ã —Å –≤—ã—Å–æ–∫–∏–º –≤–µ—Å–æ–º –¥–∞—é—Ç –Ω–µ–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –±–æ–ª—å—à–æ–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏. –í–∞–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å –ø—Ä–∏—á–∏–Ω 3-7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–µ. –ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π ¬´–∫—Ä–∞—Å–Ω—ã–π —Ä–∏—Å–∫¬ª –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π.',
      formula: '–ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä –∏–º–µ–µ—Ç –≤–µ—Å:\n  ‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (+15-25): –Ω–µ–¥–æ—Å—ã–ø, —Å–∏–ª—å–Ω—ã–π —Å—Ç—Ä–µ—Å—Å, –±–æ–ª—å—à–æ–π –¥–æ–ª–≥\n  ‚Ä¢ –í–∞–∂–Ω—ã–µ (+8-14): –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å—Ä—ã–≤–æ–≤, –Ω–∏–∑–∫–∏–π –±–µ–ª–æ–∫\n  ‚Ä¢ –£–º–µ—Ä–µ–Ω–Ω—ã–µ (+3-7): –≤–µ—á–µ—Ä–Ω–µ–µ –≤—Ä–µ–º—è, –º–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏\n\n–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5 —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –≤–µ—Å–æ–º.',
      source: 'Machine Learning –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      interpretation: '–§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ñ–∞–∫—Ç–æ—Ä–∞—Ö —Å –≤–µ—Å–æ–º >10 ‚Äî –æ–Ω–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã.',
      priority: 'HIGH',
      category: 'RISK',
      actionability: 'TODAY',
      impactScore: 0.80,
      whyImportant: '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Ä–∏—Å–∫–∞. –ó–Ω–∞–µ—à—å –≤—Ä–∞–≥ ‚Äî –ø–æ–±–µ–∂–¥–∞–µ—à—å!'
    },
    // Prevention Strategy ‚Äî –í—ã—Å–æ–∫–∏–π
    PREVENTION_STRATEGY: {
      name: '–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ —Å—Ä—ã–≤–∞',
      short: '–î–∞—ë—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –Ω–∞–±–æ—Ä –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–Ω–∏–∂–∞—é—Ç —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.',
      details: '–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ: —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≥–ª–∞–≤–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, —É—Å–ø–µ—à–Ω—ã–µ –∫–µ–π—Å—ã –∏–∑ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫. –≠—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫ ¬´–∏–¥–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫¬ª, –∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –≤—ã—Å–æ–∫–∏–º —à–∞–Ω—Å–æ–º —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Å–µ–π—á–∞—Å. –¶–µ–Ω–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—Å—Ç–æ—Ç–µ: 1-3 —à–∞–≥–∞ –ª–µ–≥—á–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å, —á–µ–º –¥–ª–∏–Ω–Ω—ã–π –ø–ª–∞–Ω. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –æ—Ç —Ç—Ä–µ–≤–æ–≥–∏ –∫ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é.',
      formula: '–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n  1. –ì–ª–∞–≤–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–ø—Ä–∏—á–∏–Ω—ã —Ä–∏—Å–∫–∞)\n  2. –ò—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—à–Ω—ã—Ö –¥–Ω–µ–π\n  3. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n  4. –í—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n\n–ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –ø—Ä–∏—á–∏–Ω—É.',
      source: 'Behavior Change Theory (Prochaska, 1992)',
      interpretation: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã 1 –∏–∑ 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∏—Å–∫–∞.',
      priority: 'HIGH',
      category: 'RISK',
      actionability: 'IMMEDIATE',
      impactScore: 0.85,
      whyImportant: '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∏—Å–∫–∞. –°–ª–µ–¥—É–π ‚Äî –ø–æ–±–µ–¥–∏—à—å!'
    },

    // Next Meal ‚Äî –í—ã—Å–æ–∫–∏–π, –±–ª–∏–∂–∞–π—à–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    NEXT_MEAL: {
      name: '–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏',
      short: '–ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –∏ –∫–∞–∫–∏–º —Å–¥–µ–ª–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.',
      details: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã, –≤—Ä–µ–º—è –¥–æ –ª–∏–ø–æ–ª–∏–∑–∞, —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –¥–Ω—è –∏ –≤–∞—à–∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≤ –º–æ–º–µ–Ω—Ç—ã —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –∏ –≥–æ–ª–æ–¥–∞. –ú–µ—Ç—Ä–∏–∫–∞ –Ω–µ ¬´–∑–∞–ø—Ä–µ—â–∞–µ—Ç¬ª –ø—Ä–æ–¥—É–∫—Ç—ã, –∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –∏ —Å–æ—Å—Ç–∞–≤ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ª–µ–≥—á–µ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–ø–ø–µ—Ç–∏—Ç–∞.',
      formula: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞:\n  ‚Ä¢ –¢–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–∏ –¥–æ –ª–∏–ø–æ–ª–∏–∑–∞\n  ‚Ä¢ –ö–∞–ª–æ—Ä–∏–π–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ –¥–Ω—è\n  ‚Ä¢ –ò—Å—Ç–æ—Ä–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –µ–¥—ã\n\n–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞ –∏ —á—Ç–æ –ª—É—á—à–µ —Å—ä–µ—Å—Ç—å.',
      source: 'Brand-Miller & Foster-Powell, 2003',
      sources: [{ pmid: '12828192', level: 'B', title: 'Brand-Miller et al., 2003 ‚Äî Glycemic index and meal composition guidance' }],
      evidenceLevel: 'B',
      confidenceScore: 0.84,
      interpretation: '–°–ª–µ–¥—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Å–≤–æ–µ–Ω–∏—è.',
      priority: 'HIGH',
      category: 'TIMING',
      actionability: 'IMMEDIATE',
      impactScore: 0.75,
      whyImportant: '–ß—Ç–æ —Å—ä–µ—Å—Ç—å –°–ï–ô–ß–ê–°. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã.'
    },

    // === FORECAST PANEL ‚Äî –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ===
    ENERGY_WINDOWS: {
      name: '–û–∫–Ω–∞ —ç–Ω–µ—Ä–≥–∏–∏',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –¥–Ω—è –¥–ª—è –∑–∞–¥–∞—á, –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É —ç–Ω–µ—Ä–≥–∏–∏.',
      details: '–û–∫–Ω–∞ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –Ω–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ —Ä–∏—Ç–º–∞, —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–ª–Ω—ã, –Ω–µ–¥–∞–≤–Ω–µ–≥–æ –ø–∏—Ç–∞–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –≠—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–∞–π–º–∏–Ω–≥–∞: —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –≤ –ø–∏–∫–∏, —Ä—É—Ç–∏–Ω—É ‚Äî –≤ —Å–ø–∞–¥—ã. –î–∞–∂–µ –Ω–µ–±–æ–ª—å—à–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ ¬´—Å–≤–æ–∏¬ª –æ–∫–Ω–∞ –æ–±—ã—á–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—á–µ—Ä–Ω–∏–µ –æ—à–∏–±–∫–∏. –ú–µ—Ç—Ä–∏–∫–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–∞ –≤ –¥–Ω–∏ —Å –≤—ã—Å–æ–∫–æ–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π.',
      formula: '–û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n  ‚Ä¢ –¶–∏—Ä–∫–∞–¥–Ω–æ–≥–æ —Ä–∏—Ç–º–∞ (–ø–∏–∫ 10:00-12:00, 16:00-18:00)\n  ‚Ä¢ –°–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏\n  ‚Ä¢ –£—Ä–æ–≤–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n‚≠ê –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ ‚Äî –∫–æ–≥–¥–∞ –≤—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç.',
      source: 'Van Cauter et al., 1997; Scheer et al., 2009',
      sources: [{ pmid: '19164701', level: 'B', title: 'Scheer et al., 2009 ‚Äî Circadian meal timing metabolic effects' }],
      evidenceLevel: 'B',
      confidenceScore: 0.87,
      interpretation: '–ü—Ä–∏—ë–º –ø–∏—â–∏ –≤ "–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ" –æ–∫–Ω–∞ —É–ª—É—á—à–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –Ω–∞ 15-25%.',
      priority: 'MEDIUM',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.60,
      whyImportant: '–ö–æ–≥–¥–∞ –ª—É—á—à–µ –µ—Å—Ç—å. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∏–Ω–≥–∞ –¥–∞—ë—Ç –¥–æ +25% —É—Å–≤–æ–µ–Ω–∏—è.'
    },
    // Training Window ‚Äî –°—Ä–µ–¥–Ω–∏–π
    TRAINING_WINDOW: {
      name: '–û–∫–Ω–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      short: '–ü–æ–º–æ–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è, –≤ –∫–æ—Ç–æ—Ä–æ–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–∞—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –æ—Ç–¥–∞—á—É –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏, —Ñ–∞–∑—É –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –±–æ–ª–µ–µ ¬´–≤—ã–∏–≥—Ä—ã—à–Ω—ã–π¬ª —Å–ª–æ—Ç: –∫–æ–≥–¥–∞ –≤—ã—à–µ –º–æ—â–Ω–æ—Å—Ç—å, –ª—É—á—à–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –∏ –Ω–∏–∂–µ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–∏ –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω–æ–º –≥—Ä–∞—Ñ–∏–∫–µ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å –Ω–µ ¬´–∏–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ —É—á–µ–±–Ω–∏–∫—É¬ª, –∞ –ª—É—á—à–µ–µ –æ–∫–Ω–æ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è. –¶–µ–ª—å ‚Äî –ø–æ–≤—ã—Å–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –∞ –Ω–µ —É—Å–ª–æ–∂–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.',
      formula: '–§–∞–∫—Ç–æ—Ä—ã –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏:\n  ‚Ä¢ –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ (–Ω–∞—Ç–æ—â–∞–∫ –∏–ª–∏ –ø–æ—Å–ª–µ –µ–¥—ã)\n  ‚Ä¢ –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ (–∏–¥–µ–∞–ª—å–Ω–æ –≤ –ª–∏–ø–æ–ª–∏–∑–µ)\n  ‚Ä¢ –¶–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º —Å–∏–ª—ã (–ø–∏–∫ 16:00-19:00)\n  ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (2-3—á –Ω–∞–∑–∞–¥)',
      source: 'Chtourou & Souissi, 2012',
      sources: [{ pmid: '22531613', level: 'B', title: 'Chtourou & Souissi, 2012 ‚Äî Circadian timing and performance' }],
      evidenceLevel: 'B',
      confidenceScore: 0.85,
      interpretation: '–°–∏–ª–æ–≤—ã–µ ‚Äî –≤–µ—á–µ—Ä–æ–º (16-19—á), –∫–∞—Ä–¥–∏–æ ‚Äî —É—Ç—Ä–æ–º –Ω–∞—Ç–æ—â–∞–∫.',
      priority: 'MEDIUM',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.55,
      whyImportant: '–ö–æ–≥–¥–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ. –í—Ä–µ–º—è –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!'
    },
    // Insulin Wave Status ‚Äî –°—Ä–µ–¥–Ω–∏–π
    INSULIN_WAVE_STATUS: {
      name: '–°—Ç–∞—Ç—É—Å –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞: –∏–¥—ë—Ç –≤–æ–ª–Ω–∞ —É—Å–≤–æ–µ–Ω–∏—è –∏–ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω –ª–∏–ø–æ–ª–∏–∑.',
      details: '–°—Ç–∞—Ç—É—Å –≤–æ–ª–Ω—ã –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, –≤ –∫–∞–∫–æ–π ¬´—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∞–∑–µ¬ª –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å: –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥ –∏–ª–∏ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏–π –æ –ø–µ—Ä–µ–∫—É—Å–µ, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –∏ —Ç–µ–º–ø–µ –∑–∞–¥–∞—á –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è. –ú–µ—Ç—Ä–∏–∫–∞ –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ –º–Ω–æ–≥–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—É—é –º–æ–¥–µ–ª—å (GI/GL, —Å–æ—Å—Ç–∞–≤ –ø–∏—â–∏, –≤—Ä–µ–º—è —Å—É—Ç–æ–∫, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å), –ø–æ—ç—Ç–æ–º—É –¥–∞—ë—Ç –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É, —á–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –µ–¥—ã. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç ‚Äî –º–µ–Ω—å—à–µ —Ö–∞–æ—Ç–∏—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –ª—É—á—à–µ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–º.',
      formula: '–°–æ—Å—Ç–æ—è–Ω–∏—è:\n  üî• –õ–∏–ø–æ–ª–∏–∑ ‚Äî –∏–Ω—Å—É–ª–∏–Ω –Ω–∏–∑–∫–∏–π, –∏–¥—ë—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ\n  ‚è≥ –í–æ–ª–Ω–∞ ‚Äî –∏–Ω—Å—É–ª–∏–Ω –ø–æ–≤—ã—à–µ–Ω, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏\n  ‚ö° –ü–æ—á—Ç–∏ ‚Äî –≤–æ–ª–Ω–∞ —Å–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è\n\n–î–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç 33+ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (GI, GL, –±–µ–ª–æ–∫, –∂–∏—Ä—ã, –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ –∏ –¥—Ä.)',
      source: 'Wolever & Jenkins, 1994; Brand-Miller, 2003',
      sources: [{ pmid: '8198048', level: 'B', title: 'Wolever & Jenkins, 1994 ‚Äî Glycemic response and insulin wave dynamics' }],
      evidenceLevel: 'B',
      confidenceScore: 0.85,
      interpretation: '–î–ª—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –≤ "–ª–∏–ø–æ–ª–∏–∑–µ".',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'TODAY',
      impactScore: 0.65,
      whyImportant: '–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–¥—ë—Ç –ª–∏ –ª–∏–ø–æ–ª–∏–∑.'
    },
    // What-If Scenarios ‚Äî –°—Ä–µ–¥–Ω–∏–π
    WHATIF_SCENARIOS: {
      name: '–°—Ü–µ–Ω–∞—Ä–∏–∏ "–ß—Ç–æ –µ—Å–ª–∏"',
      short: '–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è.',
      details: '–°—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É—é—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É ¬´–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å¬ª –∏ ¬´–≤—ã–ø–æ–ª–Ω–∏—Ç—å 1-2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏¬ª. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏—é —á–µ—Ä–µ–∑ –ø–æ–Ω—è—Ç–Ω—ã–π –æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç. –í–∞–∂–Ω–æ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏—Ö –∫–∞–∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä, –∞ –Ω–µ –∂—ë—Å—Ç–∫–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ: –∑–∞–¥–∞—á–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ ‚Äî –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥. –ú–µ—Ç—Ä–∏–∫–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–∞, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —Ä–µ—à–∏—Ç—å, —Å—Ç–æ–∏—Ç –ª–∏ –º–µ–Ω—è—Ç—å –ø–ª–∞–Ω –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.',
      formula: '–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:\n  üìä –í–µ—Ä–æ—è—Ç–Ω—ã–π ‚Äî —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–Ω–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n  üåü –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π ‚Äî –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π\n\n–ö–∞–∂–¥—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n  ‚Ä¢ –¢–µ–∫—É—â–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –¥–Ω—è\n  ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–∏ –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è',
      source: '–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤; Scenario-based decision support systems',
      interpretation: '–°—Ä–∞–≤–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —É–ª—É—á—à–µ–Ω–∏—è.',
      priority: 'MEDIUM',
      category: 'PREDICTION',
      actionability: 'TODAY',
      impactScore: 0.50,
      whyImportant: '–ß—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏... –ú–æ—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞.'
    },

    // === PHENOTYPE PANEL ‚Äî –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π ===
    PHENOTYPE_PANEL: {
      name: '–ü–∞–Ω–µ–ª—å —Ñ–µ–Ω–æ—Ç–∏–ø–∞',
      short: '–°–≤–æ–¥–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ç–∏–ø –∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ/–Ω–∞–≥—Ä—É–∑–∫—É.',
      details: '–ü–∞–Ω–µ–ª—å —Ñ–µ–Ω–æ—Ç–∏–ø–∞ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—Ä–∏—Ç–º, —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —É–≥–ª–µ–≤–æ–¥—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å), —á—Ç–æ–±—ã –¥–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏. –≠—Ç–æ –Ω–µ ¬´—è—Ä–ª—ã–∫¬ª, –∞ —Ä–∞–±–æ—á–∞—è –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ª–µ–∑–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –¥–∏–Ω–∞–º–∏–∫–µ 3‚Äì6 –Ω–µ–¥–µ–ª—å –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.',
      formula: '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ 30+ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö:\n  ‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —ç–Ω–µ—Ä–≥–∏–∏ (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä)\n  ‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞\n  ‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–æ–∫\n  ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–µ—Å–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è\n\n–¢–∏–ø—ã: üèÉ–°–ø—Ä–∏–Ω—Ç–µ—Ä, üèÉ‚Äç‚ôÇÔ∏è–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü, üèãÔ∏è–°–∏–ª–æ–≤–∏–∫, ‚öñÔ∏è–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, ü¶â–°–æ–≤–∞, üê¶–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫',
      source: '–•—Ä–æ–Ω–æ–±–∏–æ–ª–æ–≥–∏—è (Roenneberg, 2012); –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–æ–ª–æ–≥–∏—è',
      sources: [{ pmid: '22738673', level: 'B', title: 'Roenneberg et al., 2012 ‚Äî Chronotype and metabolic traits' }],
      evidenceLevel: 'B',
      confidenceScore: 0.83,
      interpretation: '–§–µ–Ω–æ—Ç–∏–ø –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∏–Ω–≥–∏ –µ–¥—ã –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'LONG_TERM',
      impactScore: 0.55,
      whyImportant: '–¢–≤–æ–π –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ç–∏–ø. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–µ–±—è = –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.'
    },
    // Phenotype Confidence ‚Äî –ù–∏–∑–∫–∏–π
    PHENOTYPE_CONFIDENCE: {
      name: '–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ñ–µ–Ω–æ—Ç–∏–ø–µ',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞–¥—ë–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤–∞—à —Ñ–µ–Ω–æ—Ç–∏–ø –Ω–∞ —Ç–µ–∫—É—â–µ–º –æ–±—ä—ë–º–µ –¥–∞–Ω–Ω—ã—Ö.',
      details: '–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π, –Ω–æ –∏ –æ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç–∏/–ø–æ–ª–Ω–æ—Ç—ã —Ç—Ä–µ–∫–∏–Ω–≥–∞. –ù–∏–∑–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ ¬´–æ—à–∏–±–∫–∞¬ª, –∞ —Å–∏–≥–Ω–∞–ª, —á—Ç–æ –≤—ã–≤–æ–¥—ã –ø–æ–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –º–∞—Ä–∫–µ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏: —á–µ–º –≤—ã—à–µ confidence, —Ç–µ–º —Ç–æ—á–Ω–µ–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.',
      formula: 'confidence = ‚àö(daysWithData/30) √ó dataConsistency\n\n–†–∞—Å—Ç—ë—Ç –ø—Ä–∏:\n  ‚Ä¢ –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö (30+ –¥–Ω–µ–π = 100%)\n  ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–º–µ–Ω—å—à–µ —à—É–º–∞)\n  ‚Ä¢ –ü–æ–ª–Ω–æ—Ç–∞ –∑–∞–ø–∏—Å–µ–π (–µ–¥–∞ + —Å–æ–Ω + –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)',
      source: 'Data quality scoring in personalized health analytics',
      interpretation: '>70% ‚Äî —Ñ–µ–Ω–æ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –Ω–∞–¥—ë–∂–Ω–æ. <50% ‚Äî –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö.',
      priority: 'LOW',
      category: 'STATISTICS',
      actionability: 'INFORMATIONAL',
      impactScore: 0.25,
      whyImportant: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Ç–≤–æ–π —Ç–∏–ø.'
    },
    // Phenotype Radar ‚Äî –°—Ä–µ–¥–Ω–∏–π
    PHENOTYPE_RADAR: {
      name: '–ü—Ä–æ—Ñ–∏–ª—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ (Radar)',
      short: '–†–∞–¥–∞—Ä —Å–∏–ª—å–Ω—ã—Ö –∏ —Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º –∏ —Ö—Ä–æ–Ω–æ—Ç–∏–ø.',
      details: '–†–∞–¥–∞—Ä –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–∫–æ—Å—ã –ø—Ä–æ—Ñ–∏–ª—è –∏ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ñ–æ–∫—É—Å –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é. –ë–æ–ª—å—à–∞—è –ø–ª–æ—â–∞–¥—å –ø–æ–ª–µ–∑–Ω–∞, –Ω–æ –≤–∞–∂–Ω–µ–µ –±–∞–ª–∞–Ω—Å –æ—Å–µ–π: —Å–ª–∞–±–æ–µ –∑–≤–µ–Ω–æ —á–∞—Å—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å. –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —Ç—Ä–µ–Ω–¥, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–∏–Ω —Å—Ä–µ–∑.',
      formula: '–û—Å–∏ —Ä–∞–¥–∞—Ä–∞:\n  ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π –¥–µ–Ω—å –æ—Ç–æ –¥–Ω—è\n  ‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –∏ —Å—Ç—Ä–µ—Å—Å\n  ‚Ä¢ –ò–Ω—Å—É–ª–∏–Ω. —á—É–≤—Å—Ç–≤. ‚Äî —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —É–≥–ª–µ–≤–æ–¥—ã\n  ‚Ä¢ –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ ‚Äî streak, —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å\n  ‚Ä¢ –•—Ä–æ–Ω–æ—Ç–∏–ø ‚Äî —É—Ç—Ä–µ–Ω–Ω–∏–π –∏–ª–∏ –≤–µ—á–µ—Ä–Ω–∏–π —Ç–∏–ø\n\n–ö–∞–∂–¥–∞—è –æ—Å—å: 0-100',
      source: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      interpretation: '–ß–µ–º –±–æ–ª—å—à–µ –ø–ª–æ—â–∞–¥—å ‚Äî —Ç–µ–º –ª—É—á—à–µ –æ–±—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'LONG_TERM',
      impactScore: 0.45,
      whyImportant: '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–ª—å–Ω—ã—Ö –∏ —Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.'
    },
    // Personal Thresholds ‚Äî –í—ã—Å–æ–∫–∏–π
    PERSONAL_THRESHOLDS: {
      name: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏',
      short: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ –∫–∞–ª–æ—Ä–∏—è–º, –≤–æ–ª–Ω–∞–º –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏.',
      details: '–ü–æ—Ä–æ–≥–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑ –≤–∞—à–∏—Ö —É—Å–ø–µ—à–Ω—ã—Ö –¥–Ω–µ–π –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏. –û–Ω–∏ —Ç–æ—á–Ω–µ–µ ¬´—Å—Ä–µ–¥–Ω–∏—Ö –Ω–æ—Ä–º¬ª, –ø–æ—Ç–æ–º—É —á—Ç–æ —É—á–∏—Ç—ã–≤–∞—é—Ç –≤–∞—à –æ—Ç–∫–ª–∏–∫ –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ –∏ —Ä–µ–∂–∏–º. –≠—Ç–æ –∫–ª—é—á –∫ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –ª–∏—à–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.',
      formula: '–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ:\n  ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∫–∫–∞–ª ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—à–Ω—ã—Ö –¥–Ω–µ–π\n  ‚Ä¢ –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ ‚Äî —Å—Ä–µ–¥–Ω—è—è –ø–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º\n  ‚Ä¢ –ü–µ—Ä–µ—Ä—ã–≤ –º–µ–∂–¥—É –µ–¥–æ–π ‚Äî –≤–∞—à –æ–ø—Ç–∏–º—É–º\n  ‚Ä¢ –ü–æ—Ä–æ–≥ —Ä–∏—Å–∫–∞ ‚Äî –∫–æ–≥–¥–∞ –≤—ã –æ–±—ã—á–Ω–æ —Å—Ä—ã–≤–∞–µ—Ç–µ—Å—å',
      source: '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è',
      interpretation: '–≠—Ç–∏ –ø–æ—Ä–æ–≥–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –í–ê–°, –∞ –Ω–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è.',
      priority: 'HIGH',
      category: 'PATTERNS',
      actionability: 'LONG_TERM',
      impactScore: 0.70,
      whyImportant: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Å—Ä–µ–¥–Ω–∏—Ö. –¢–≤–æ–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏!'
    },

    // === TRAITS ‚Äî —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ ===
    TRAIT_STABILITY: {
      name: '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',
      short: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–æ–≤–Ω–æ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ —Ä–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è –¥–µ–Ω—å –∑–∞ –¥–Ω—ë–º.',
      details: '–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—ã—á–Ω–æ –¥–µ–ª–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏ –∏ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ú–µ—Ç—Ä–∏–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –≤–∞–∂–Ω–∞ —É–º–µ—Ä–µ–Ω–Ω–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –±–µ–∑ —Ä–µ–∑–∫–∏—Ö ¬´–∫–∞—á–µ–ª–µ–π¬ª.',
      formula: 'stability = 100 - (œÉ_calories / avg_calories √ó 100)\n\n–ì–¥–µ œÉ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –∑–∞ 7 –¥–Ω–µ–π.\n–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å = –º–∞–ª–æ –∫–æ–ª–µ–±–∞–Ω–∏–π –¥–µ–Ω—å –æ—Ç–æ –¥–Ω—è.',
      source: '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏',
      interpretation: '>80 ‚Äî –æ—á–µ–Ω—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º. <50 ‚Äî –±–æ–ª—å—à–∏–µ –∫–æ–ª–µ–±–∞–Ω–∏—è.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.50,
      whyImportant: '–ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ = –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.'
    },
    // Trait Recovery ‚Äî –í—ã—Å–æ–∫–∏–π
    TRAIT_RECOVERY: {
      name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –æ—Ä–≥–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É –Ω–∞–≥—Ä—É–∑–∫–∞–º–∏.',
      details: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—ã–≤–∞–µ—Ç —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–Ω–µ–π. –ü—Ä–∏ –Ω–∏–∑–∫–æ–º –∑–Ω–∞—á–µ–Ω–∏–∏ –¥–∞–∂–µ ¬´–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π¬ª –ø–ª–∞–Ω –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å —Å–ª–∞–±—ã–π –æ—Ç–∫–ª–∏–∫, –ø–æ—ç—Ç–æ–º—É —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–æ–∏—Ç —É–∫—Ä–µ–ø–∏—Ç—å –±–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
      formula: 'recovery = (sleepScore √ó 0.5) + (stressScore √ó 0.3) + (restDays √ó 0.2)\n\n–ì–¥–µ:\n  sleepScore = (—á–∞—Å—ã/–Ω–æ—Ä–º–∞) √ó –∫–∞—á–µ—Å—Ç–≤–æ\n  stressScore = 100 - (—Å—Ç—Ä–µ—Å—Å √ó 10)\n  restDays = –¥–Ω–∏ –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ / –Ω–µ–¥–µ–ª—é',
      source: 'Meeusen et al., 2013 ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤',
      sources: [{ pmid: '23252566', level: 'A', title: 'Meeusen et al., 2013 ‚Äî Overtraining and recovery meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.90,
      interpretation: '>75 ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. <50 ‚Äî —Ä–∏—Å–∫ –ø–µ—Ä–µ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'WEEKLY',
      impactScore: 0.70,
      whyImportant: '–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è. –í–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å!'
    },
    // Trait Insulin Sensitivity ‚Äî –í—ã—Å–æ–∫–∏–π
    TRAIT_INSULIN_SENSITIVITY: {
      name: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (Trait)',
      short: '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π –≥–∏–±–∫–æ—Å—Ç–∏ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —É–≥–ª–µ–≤–æ–¥—ã.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∏—â–µ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∫ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ. –≠—Ç–æ –Ω–µ –¥–∏–∞–≥–Ω–æ–∑, –∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞—Ü–∏–æ–Ω–∞ –∏ —Ä–∏—Ç–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.',
      formula: '–ö–æ—Å–≤–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã:\n  ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π GI —Ä–∞—Ü–∏–æ–Ω–∞ (–Ω–∏–∂–µ = –ª—É—á—à–µ)\n  ‚Ä¢ –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≥/1000–∫–∫–∞–ª (–±–æ–ª—å—à–µ = –ª—É—á—à–µ)\n  ‚Ä¢ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤ (—É—Ç—Ä–æ vs –≤–µ—á–µ—Ä)\n  ‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
      source: 'DeFronzo, 2004; Weickert & Pfeiffer, 2008',
      sources: [{ pmid: '15161807', level: 'A', title: 'DeFronzo, 2004 ‚Äî Insulin sensitivity measures meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.91,
      interpretation: '>80 ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. <50 ‚Äî —Ä–∏—Å–∫ —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'LONG_TERM',
      impactScore: 0.75,
      whyImportant: '–ì–ª–∞–≤–Ω—ã–π –º–∞—Ä–∫–µ—Ä –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è. –í–ª–∏—è–µ—Ç –Ω–∞ –≤—Å—ë!'
    },
    // Trait Consistency ‚Äî –°—Ä–µ–¥–Ω–∏–π
    TRAIT_CONSISTENCY: {
      name: '–ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ—Å—å –ø–ª–∞–Ω–∞ –ø–æ –¥–Ω—è–º.',
      details: '–ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ ¬´–∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –¥–Ω—è¬ª: –∏–º–µ–Ω–Ω–æ –æ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç—Ä–µ–Ω–¥. –†–æ—Å—Ç –º–µ—Ç—Ä–∏–∫–∏ –æ–±—ã—á–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –∏ –¥–µ–ª–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤—ã–º–∏.',
      formula: 'consistency = (daysInStreak / totalDays) √ó (avgCompleteness)\n\n–ì–¥–µ:\n  daysInStreak ‚Äî –¥–Ω–∏ –ø–æ–¥—Ä—è–¥ –≤ –Ω–æ—Ä–º–µ\n  avgCompleteness ‚Äî –ø–æ–ª–Ω–æ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö',
      source: 'Behavioral adherence metrics in digital health',
      interpretation: '>80 ‚Äî –≤—ã—Å–æ–∫–æ–µ –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ. <50 ‚Äî –Ω—É–∂–Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.55,
      whyImportant: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ = —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ –∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏.'
    },
    TRAIT_CHRONOTYPE: {
      name: '–•—Ä–æ–Ω–æ—Ç–∏–ø',
      short: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∞—à —Ä–∏—Ç–º ¬´—Å–æ–≤–∞/–∂–∞–≤–æ—Ä–æ–Ω–æ–∫¬ª, —á—Ç–æ–±—ã —Ç–æ—á–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–π–º–∏–Ω–≥ –¥–Ω—è.',
      details: '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å —Ö—Ä–æ–Ω–æ—Ç–∏–ø–æ–º –ø–æ–≤—ã—à–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ø–ª–∞–Ω–∞ –∏ —Å–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–Ω–∏–µ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö. –í–º–µ—Å—Ç–æ –±–æ—Ä—å–±—ã —Å –±–∏–æ—Ä–∏—Ç–º–æ–º –ª—É—á—à–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥ ¬´—Å–≤–æ–∏¬ª —á–∞—Å—ã.',
      formula: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ:\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–∏ –∑–∞—Å—ã–ø–∞–Ω–∏—è/–ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è\n  ‚Ä¢ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –∫–∞–ª–æ—Ä–∏–π (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä)\n  ‚Ä¢ –í—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n\n<40 = üê¶–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫, >60 = ü¶â–°–æ–≤–∞, 40-60 = –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π',
      source: 'Roenneberg et al., 2003 ‚Äî Munich Chronotype Questionnaire',
      sources: [{ pmid: '14715839', level: 'B', title: 'Roenneberg et al., 2003 ‚Äî Chronotype assessment and validation' }],
      evidenceLevel: 'B',
      confidenceScore: 0.85,
      interpretation: '–ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π —Ç–∞–π–º–∏–Ω–≥–∏ –ø–æ–¥ —Å–≤–æ–π —Ö—Ä–æ–Ω–æ—Ç–∏–ø –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'LONG_TERM',
      impactScore: 0.50,
      whyImportant: '–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ —Ç–∏–ø–∞ (—Å–æ–≤–∞/–∂–∞–≤–æ—Ä–æ–Ω–æ–∫) –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞.'
    },

    // === PHENOTYPE SECTIONS ‚Äî –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ===
    PHENOTYPE_STRENGTHS: {
      name: '–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–∏ —É—Å—Ç–æ–π—á–∏–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ª—É—á—à–µ —Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.',
      details: '–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî —ç—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞—é—Ç –ª—É—á—à–∏–π –æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º —É—Å–∏–ª–∏–∏. –û–ø–æ—Ä–∞ –Ω–∞ –Ω–∏—Ö –ø–æ–≤—ã—à–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –ø–ª–∞–Ω–∞ –∏ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –≤—ã–≥–æ—Ä–∞–Ω–∏—è.',
      formula: '–û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n  ‚Ä¢ –¢—Ä–µ–π—Ç–æ–≤ —Å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–º >75%\n  ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –¥–∞–Ω–Ω—ã—Ö\n  ‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏—è —Å "–∏–¥–µ–∞–ª—å–Ω—ã–º" –ø—Ä–æ—Ñ–∏–ª–µ–º\n\n–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ —É –≤–∞—Å —Ö–æ—Ä–æ—à–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è.',
      source: 'Strength-based behavior change approach',
      interpretation: '–û–ø–∏—Ä–∞–π—Ç–µ—Å—å –Ω–∞ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∏—Ç–∞–Ω–∏—è.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'LONG_TERM',
      impactScore: 0.45,
      whyImportant: '–ó–Ω–∞–Ω–∏–µ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ –Ω–∏—Ö.'
    },
    // Phenotype Weaknesses ‚Äî –í—ã—Å–æ–∫–∏–π
    PHENOTYPE_WEAKNESSES: {
      name: '–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞',
      short: '–ö–ª—é—á–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Ç–æ—Ä–º–æ–∑—è—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å.',
      details: '–≠—Ç–æ –Ω–µ ¬´—Å–ª–∞–±–æ—Å—Ç–∏¬ª, –∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞. –õ—É—á—à–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞—Ç—å 1‚Äì2 –∑–æ–Ω—ã, —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É ‚Äî —Ç–∞–∫ –≤—ã—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.',
      formula: '–û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n  ‚Ä¢ –¢—Ä–µ–π—Ç–æ–≤ —Å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–º <50%\n  ‚Ä¢ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø—Ä–æ–±–ª–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏\n  ‚Ä¢ –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –æ—Ç –æ–ø—Ç–∏–º—É–º–∞\n\n–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –≥–¥–µ –Ω—É–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞.',
      source: 'Behavioral gap analysis in coaching practice',
      interpretation: '–§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ 1-2 –∑–æ–Ω–∞—Ö —Ä–æ—Å—Ç–∞ –∑–∞ —Ä–∞–∑ ‚Äî –Ω–µ –Ω–∞ –≤—Å–µ—Ö —Å—Ä–∞–∑—É.',
      priority: 'HIGH',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.70,
      whyImportant: '–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞ = —Ç–æ—á–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É—Å–∏–ª–∏–π –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.'
    },
    // Phenotype Recommendations ‚Äî –í—ã—Å–æ–∫–∏–π
    PHENOTYPE_RECOMMENDATIONS: {
      name: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
      short: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –æ–∂–∏–¥–∞–µ–º—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.',
      details: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ –≤–∞—à–µ–º—É —Ñ–µ–Ω–æ—Ç–∏–ø—É –∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–∫–ª–∏–∫–∞. –§–æ—Ä–º–∞—Ç ¬´–¥–æ —Ç—Ä—ë—Ö –¥–µ–π—Å—Ç–≤–∏–π¬ª –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ–æ–∫—É—Å –∏ –ø–æ–≤—ã—à–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.',
      formula: '–ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ:\n  1. –ê–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ —Ñ–µ–Ω–æ—Ç–∏–ø–∞\n  2. –£—á—ë—Ç —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω –∏ –∑–æ–Ω —Ä–æ—Å—Ç–∞\n  3. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫\n  4. –£—á—ë—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö\n\n–ú–∞–∫—Å–∏–º—É–º 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º.',
      source: 'Behavior Change Theory + –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è',
      interpretation: '–ù–∞—á–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –æ–Ω–∞ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è.',
      priority: 'HIGH',
      category: 'PATTERNS',
      actionability: 'TODAY',
      impactScore: 0.80,
      whyImportant: '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. –ù–∞—á–Ω–∏ —Å –ø–µ—Ä–≤–æ–π!'
    },

    // === NEW v4.0 PATTERNS (B1-B6) ===
    // B1: Sleep Quality ‚Üí Next Day Metrics
    SLEEP_QUALITY: {
      name: '–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ –¥–Ω—è',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –≥–æ–ª–æ–¥, –∫–∞–ª–æ—Ä–∏–∏ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å.',
      details: '–ê–Ω–∞–ª–∏–∑ —Å –ª–∞–≥–æ–º 1 –¥–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–¥–µ–ª–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: –ø–ª–æ—Ö–æ–π —Å–æ–Ω —á–∞—Å—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ø–∏—Ç–∞–Ω–∏–∏ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –∏–º–µ–Ω–Ω–æ –∑–∞–≤—Ç—Ä–∞, –∞ –Ω–µ ¬´–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å¬ª. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ —Å—Ä—ã–≤–æ–≤ —á–µ—Ä–µ–∑ —Å–æ–Ω, –∞ –Ω–µ —á–µ—Ä–µ–∑ –∂—ë—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.',
      formula: 'Time-lagged Pearson correlation:\n  sleepQuality[day] ‚Üí (weight, hunger, steps, kcal)[day+1]\n  Min n=14 –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏\n  Confidence = baseConf √ó (1 + |r|) –µ—Å–ª–∏ |r| > 0.35',
      source: 'Walker, 2017 ‚Äî Why We Sleep; Nedeltcheva et al., 2010',
      sources: [{ pmid: '20921542', level: 'A', title: 'Nedeltcheva et al., 2010 ‚Äî Sleep curtailment metabolic effects' }],
      evidenceLevel: 'A',
      confidenceScore: 0.93,
      interpretation: '|r| > 0.5 ‚Äî —Å–∏–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ —Å–Ω–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å. r < -0.4 ‚Äî –ø–ª–æ—Ö–æ–π —Å–æ–Ω ‚Üí –≤–µ—Å‚Üë/–≥–æ–ª–æ–¥‚Üë',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'TODAY',
      impactScore: 0.75,
      whyImportant: '–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ (–Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≥–æ–ª–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å.'
    },
    // B2: Wellbeing Correlation
    WELLBEING_CORRELATION: {
      name: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏',
      short: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Å–≤—è–∑–∞–Ω—ã —Å –≤–∞—à–∏–º —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º.',
      details: '–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è —Å —Ä–µ–∂–∏–º–æ–º –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–π—Ç–∏ ¬´–≤–∞—à–∏¬ª —Ä—ã—á–∞–≥–∏ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è. –ß–∞—Å—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç –±–æ–ª–µ–µ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã, —á–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.',
      formula: 'Pearson correlation:\n  wellbeingAvg[day] ‚Üí (sleepQuality, steps, protein, kcal)[day]\n  Min n=14, confidence logic',
      source: 'Seligman, 2018 ‚Äî PERMA model; Lyubomirsky et al., 2005',
      sources: [{ pmid: '16045394', level: 'B', title: 'Lyubomirsky et al., 2005 ‚Äî Wellbeing and life satisfaction RCT' }],
      evidenceLevel: 'B',
      confidenceScore: 0.84,
      interpretation: 'r > 0.4 ‚Äî –Ω–∞–π–¥–µ–Ω –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è (—Å–æ–Ω/–¥–≤–∏–∂–µ–Ω–∏–µ/–ø–∏—Ç–∞–Ω–∏–µ)',
      priority: 'MEDIUM',
      category: 'RECOVERY',
      actionability: 'WEEKLY',
      impactScore: 0.60,
      whyImportant: '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∞—à–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å.'
    },
    // B3: Hydration
    HYDRATION: {
      name: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã –∑–∞–∫—Ä—ã–≤–∞–µ—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –¥–Ω–µ–≤–Ω—É—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –≤–æ–¥–µ.',
      details: '–î–∞–∂–µ —É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –≤–æ–¥—ã –º–æ–∂–µ—Ç —Å–Ω–∏–∂–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –Ω–∞–≥—Ä—É–∑–∫–∏. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –Ω–µ —Ä–∞–∑–æ–≤—ã–µ ¬´–ø–∏–∫–∏¬ª, –∞ —É—Å—Ç–æ–π—á–∏–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏.',
      formula: 'Goal = weight √ó 30 ml/kg (–í–û–ó —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)\n  –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: waterMl / goal √ó 100%\n  –¢—Ä–µ–Ω–¥: EMA(waterMl, span=7)',
      source: 'EFSA, 2010 ‚Äî Water intake recommendations',
      interpretation: '>90% ‚Äî –æ—Ç–ª–∏—á–Ω–æ. 70-90% ‚Äî –Ω–æ—Ä–º–∞. <70% ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'TODAY',
      impactScore: 0.50,
      whyImportant: '–î–µ–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è 1-2% ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.'
    },
    // B4: Body Composition
    HYDRATION_TREND: {
      name: '–¢—Ä–µ–Ω–¥ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏–≤—ã—á–∫–∏ –ø–∏—Ç—å –≤–æ–¥—É –∑–∞ –Ω–µ–¥–µ–ª—é.',
      details: '–°–≥–ª–∞–∂–µ–Ω–Ω—ã–π —Ç—Ä–µ–Ω–¥ –æ—Ç—Å–µ–∫–∞–µ—Ç –¥–Ω–µ–≤–Ω–æ–π —à—É–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞. –≠—Ç–æ —É–¥–æ–±–Ω–µ–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è, —á–µ–º –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –æ—Ç–¥–µ–ª—å–Ω–æ.',
      formula: 'EMA(waterMl, span=7) / goal √ó 100\n  Slope > 0 ‚Äî —É–ª—É—á—à–µ–Ω–∏–µ, < 0 ‚Äî —É—Ö—É–¥—à–µ–Ω–∏–µ',
      source: 'Exponential Moving Average –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è —Ñ–ª—É–∫—Ç—É–∞—Ü–∏–π',
      interpretation: '–¢—Ä–µ–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–∏–≤—ã—á–∫–∞—Ö –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏',
      priority: 'LOW',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.35,
      whyImportant: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–∏ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –ø—Ä–∏–≤—ã—á–∫–∏.'
    },
    // B4: Body Composition
    BODY_COMPOSITION: {
      name: '–ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ–ª–∞ (WHR)',
      short: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–ª–∏–∏/–±—ë–¥–µ—Ä –∫–∞–∫ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Å–∏–≥–Ω–∞–ª –∫–∞—Ä–¥–∏–æ–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Ä–∏—Å–∫–∞, —á–µ–º –≤–µ—Å.',
      details: 'WHR –ø–æ–ª–µ–∑–µ–Ω, –∫–æ–≥–¥–∞ –≤–µ—Å ¬´—Å—Ç–æ–∏—Ç¬ª, –Ω–æ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –º–µ–Ω—è–µ—Ç—Å—è: –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é –∞–±–¥–æ–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∂–∏—Ä–∞. –ú–µ—Ç—Ä–∏–∫–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–∞ –ø—Ä–∏ —Ä–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏, –≥–¥–µ –º–∞—Å—Å–∞ —Ç–µ–ª–∞ –Ω–µ –≤—Å–µ–≥–¥–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å.',
      formula: 'WHR = waist_cm / hip_cm\n  –ù–æ—Ä–º–∞: <0.85 (–∂–µ–Ω), <0.9 (–º—É–∂)\n  –¢—Ä–µ–Ω–¥: linear regression –∑–∞ 30+ –¥–Ω–µ–π, min n=10',
      source: 'WHO, 2008 ‚Äî Waist-Hip Ratio guidelines',
      interpretation: 'WHR —Å–Ω–∏–∂–∞–µ—Ç—Å—è ‚Äî –≤–∏—Å—Ü–µ—Ä–∞–ª—å–Ω—ã–π –∂–∏—Ä —É—Ö–æ–¥–∏—Ç. –†–æ—Å—Ç ‚Äî —Ä–∏—Å–∫ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'LONG_TERM',
      impactScore: 0.80,
      whyImportant: 'WHR ‚Äî –ª—É—á—à–∏–π –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä –∫–∞—Ä–¥–∏–æ–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Ä–∏—Å–∫–∞, —Ç–æ—á–Ω–µ–µ —á–µ–º –ø—Ä–æ—Å—Ç–æ –≤–µ—Å.'
    },
    // B5: Cycle Impact
    CYCLE_IMPACT: {
      name: '–í–ª–∏—è–Ω–∏–µ —Ü–∏–∫–ª–∞ (—Ñ–∞–∑—ã)',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Ñ–∞–∑—ã —Ü–∏–∫–ª–∞ –º–µ–Ω—è—é—Ç –≥–æ–ª–æ–¥, —ç–Ω–µ—Ä–≥–∏—é –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º.',
      details: '–§–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω, –∞ –Ω–µ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–æ–ª–µ–±–∞–Ω–∏—è –∫–∞–∫ ¬´—Å—Ä—ã–≤ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã¬ª. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ñ—Ä—É—Å—Ç—Ä–∞—Ü–∏—é –∏ –ø–æ–º–æ–≥–∞–µ—Ç –¥–µ—Ä–∂–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏.',
      formula: 'Dynamic phase detection:\n  –§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è: –¥–Ω–∏ 1 –¥–æ –æ–≤—É–ª—è—Ü–∏–∏ (kcal avg, steps avg)\n  –õ—é—Ç–µ–∏–Ω–æ–≤–∞—è: –ø–æ—Å–ª–µ –æ–≤—É–ª—è—Ü–∏–∏ –¥–æ –∫–æ–Ω—Ü–∞\n  –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ (kcal, weight, mood) –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏',
      source: 'Davidsen et al., 2007 ‚Äî Menstrual cycle and metabolism',
      sources: [{ pmid: '17466403', level: 'A', title: 'Davidsen et al., 2007 ‚Äî Menstrual cycle metabolic impact meta-analysis' }],
      evidenceLevel: 'A',
      confidenceScore: 0.89,
      interpretation: '–õ—é—Ç–µ–∏–Ω–æ–≤–∞—è —Ñ–∞–∑–∞: +150-300 –∫–∫–∞–ª –Ω–æ—Ä–º–∞ (–ø—Ä–æ–≥–µ—Å—Ç–µ—Ä–æ–Ω‚Üë BMR). Mood‚Üì ‚Äî –ü–ú–°.',
      priority: 'HIGH',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.70,
      whyImportant: '–¶–∏–∫–ª –≤–ª–∏—è–µ—Ç –Ω–∞ –≥–æ–ª–æ–¥, –º–µ—Ç–∞–±–æ–ª–∏–∑–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. –ù–∞—É—á–∏—Å—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–º, –∞ –Ω–µ –ø—Ä–æ—Ç–∏–≤.'
    },
    // B6: Weekend Effect
    WEEKEND_EFFECT: {
      name: '–í—ã—Ö–æ–¥–Ω—ã–µ vs –±—É–¥–Ω–∏',
      short: '–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–∏—Ç–º –≤—ã—Ö–æ–¥–Ω—ã—Ö –∏ –±—É–¥–Ω–µ–π, —á—Ç–æ–±—ã –≤—ã—è–≤–∏—Ç—å ¬´—Å–∞–±–æ—Ç–∞–∂ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è¬ª.',
      details: '–ù–µ–±–æ–ª—å—à–æ–π —Ä–æ—Å—Ç –∫–∞–ª–æ—Ä–∏–π –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –Ω–æ—Ä–º–∞–ª–µ–Ω, –Ω–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–µ—Ä–µ–∫–æ—Å –º–æ–∂–µ—Ç —Å—ä–µ–¥–∞—Ç—å –Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –º—è–≥–∫–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –≤—ã—Ö–æ–¥–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –±–µ–∑ —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏—è –≤—Å–µ–≥–æ –ø–ª–∞–Ω–∞.',
      formula: 'Weekend = –ø—Ç/—Å–±/–≤—Å, Weekdays = –ø–Ω/–≤—Ç/—Å—Ä/—á—Ç\n  –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: avg_kcal, avg_sleep, avg_steps\n  –†–∞–∑–Ω–∏—Ü–∞: (weekend - weekdays) / weekdays √ó 100%',
      source: 'Racette et al., 2008 ‚Äî Weekend weight gain patterns',
      sources: [{ pmid: '17389702', level: 'B', title: 'Racette et al., 2008 ‚Äî Weekend eating patterns and weight' }],
      evidenceLevel: 'B',
      confidenceScore: 0.83,
      interpretation: '+10-20% –∫–∞–ª–æ—Ä–∏–π –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ ‚Äî –Ω–æ—Ä–º–∞. >30% ‚Äî —Ä–∏—Å–∫ —Å–∞–±–æ—Ç–∞–∂–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.',
      priority: 'MEDIUM',
      category: 'PATTERNS',
      actionability: 'WEEKLY',
      impactScore: 0.55,
      whyImportant: '–í—ã—Ö–æ–¥–Ω—ã–µ –º–æ–≥—É—Ç —Å—ä–µ—Å—Ç—å –≤–µ—Å—å –Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç. –û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å = –∫–æ–Ω—Ç—Ä–æ–ª—å.'
    },
    // C2: Nutrition Quality
    NUTRITION_QUALITY: {
      name: '–ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è (Nutrition Quality)',
      short: '–°–≤–æ–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–∏—â–µ–≤–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞—Ü–∏–æ–Ω–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ —Å–æ—á–µ—Ç–∞–µ—Ç –±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫—É, –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤, –¥–æ–ª—é –ø—Ä–æ—Å—Ç—ã—Ö —Å–∞—Ö–∞—Ä–æ–≤ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —É–ª—É—á—à–∞—Ç—å ¬´—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç¬ª –ø–∏—Ç–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—ã—Ç–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—é –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Ç—è–≥–µ.',
      formula: '–°–æ—Å—Ç–∞–≤–Ω–æ–π score –∏–∑: –±–µ–ª–æ–∫%, –∫–ª–µ—Ç—á–∞—Ç–∫–∞/1000–∫–∫–∞–ª, –¥–æ–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π/–ø—Ä–æ–¥—É–∫—Ç–æ–≤',
      source: '–°–≤–æ–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∫–∞—á–µ—Å—Ç–≤–∞ –ø–∏—Ç–∞–Ω–∏—è (DQI-–ø–æ–¥–æ–±–Ω—ã–π –ø–æ–¥—Ö–æ–¥)',
      interpretation: '>80 ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ. 60-80 ‚Äî —Ö–æ—Ä–æ—à–æ. <60 ‚Äî –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'TODAY',
      impactScore: 0.60,
      whyImportant: '–ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã –≤–ª–∏—è–µ—Ç –Ω–∞ —ç–Ω–µ—Ä–≥–∏—é, —Å—ã—Ç–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–µ—Å–∞.'
    },
    // C4: NEAT Activity
    NEAT_ACTIVITY: {
      name: 'NEAT ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
      details: 'NEAT —á–∞—Å—Ç–æ –Ω–µ–¥–æ–æ—Ü–µ–Ω–∏–≤–∞—é—Ç, —Ö–æ—Ç—è –∏–º–µ–Ω–Ω–æ –æ–Ω —Å–æ–∑–¥–∞—ë—Ç –∑–∞–º–µ—Ç–Ω—ã–π –≤–∫–ª–∞–¥ –≤ —Ä–∞—Å—Ö–æ–¥ –ø—Ä–∏ —Å–∏–¥—è—á–µ–π —Ä–∞–±–æ—Ç–µ. –ú–∞–ª—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–±–æ–ª—å—à–µ —Ö–æ–¥—å–±—ã, –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–ª—É—á—à–∏—Ç—å –±–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏.',
      formula: 'Avg household minutes + trend (linear). –ü–æ—Ä–æ–≥: <20 –Ω–∏–∑–∫–æ, 20-40 —É–º–µ—Ä–µ–Ω–Ω–æ, 40-60 —Ö–æ—Ä–æ—à–æ, 60+ –æ—Ç–ª–∏—á–Ω–æ',
      source: 'Hamilton et al., 2007 ‚Äî NEAT improves metabolic health',
      interpretation: 'NEAT –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å 150-350 –∫–∫–∞–ª —Ä–∞—Å—Ö–æ–¥–∞ –≤ –¥–µ–Ω—å.',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'TODAY',
      impactScore: 0.55,
      whyImportant: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî —Å–∫—Ä—ã—Ç—ã–π —Ä—ã—á–∞–≥ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞.'
    },
    // C6: Mood Trajectory
    MOOD_TRAJECTORY: {
      name: '–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ –ø—Ä–∏—ë–º–∞–º',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å–æ—Å—Ç–∞–≤ –µ–¥—ã —Å–≤—è–∑–∞–Ω —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é.',
      details: '–°–≤—è–∑—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —Å –º–∞–∫—Ä–æ—Å–æ—Å—Ç–∞–≤–æ–º –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –ø–∏—â–µ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–ø–∞–¥–æ–≤. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –≤–µ—á–µ—Ä–Ω–∏—Ö —Å—Ä—ã–≤–æ–≤ –∏ –≤—ã–±–æ—Ä–∞ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤.',
      formula: 'corr(mood, simple%) –∏ corr(mood, protein%) –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–∏—ë–º—É –ø–∏—â–∏',
      source: '–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è',
      interpretation: '–ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è —Å–≤—è–∑—å —Å –ø—Ä–æ—Å—Ç—ã–º–∏ —É–≥–ª–µ–≤–æ–¥–∞–º–∏ ‚Üí —Ä–∏—Å–∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–ø–∞–¥–æ–≤.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'TODAY',
      impactScore: 0.65,
      whyImportant: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–∏—Ç–∞–Ω–∏—è –∏ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞.'
    },
    // C7: Micronutrient Radar
    MICRONUTRIENT_RADAR: {
      name: '–ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω—ã–π —Ä–∞–¥–∞—Ä',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏—Ö –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∞—Ç—å –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É —Ä–∞—Ü–∏–æ–Ω—É –∑–∞ –Ω–µ–¥–µ–ª—é.',
      details: '–†–∞–¥–∞—Ä –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–π –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ñ–æ–Ω –ø–æ –∫–ª—é—á–µ–≤—ã–º –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–∞–º (Fe, Mg, Zn, Ca), –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω—ã–π –æ–¥–∏–Ω –¥–µ–Ω—å. –ü–æ—Ä–æ–≥ <80% –æ—Ç RDA/AI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–Ω–Ω–∏–π —Å–∏–≥–Ω–∞–ª –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞: —ç—Ç–æ –µ—â—ë –Ω–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –¥–∏–∞–≥–Ω–æ–∑, –Ω–æ –ø–æ–≤–æ–¥ —É—Å–∏–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã‚Äë–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞—Ü–∏–æ–Ω–∞. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª–µ–∑–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–∏–Ω–∞–º–∏–∫—É 2‚Äì4 –Ω–µ–¥–µ–ª–∏ –ø–æ–¥—Ä—è–¥: –µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –≤—ã—à–µ.',
      formula: '7-–¥–Ω–µ–≤–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø–æ Fe/Mg/Zn/Ca.\n–î–µ—Ñ–∏—Ü–∏—Ç = <80% –æ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–π –Ω–æ—Ä–º—ã (RDA/AI).',
      sources: [
        {
          label: 'WHO/FAO ‚Äî Vitamin and Mineral Requirements in Human Nutrition',
          url: 'https://apps.who.int/iris/handle/10665/42716'
        },
        {
          label: 'NIH ODS ‚Äî Dietary Supplement Fact Sheets (RDA/AI)',
          url: 'https://ods.od.nih.gov/factsheets/'
        }
      ],
      interpretation: '–ï—Å–ª–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å <80% ‚Äî –≤–µ—Ä–æ—è—Ç–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç. –£—Å–∏–ª—å –ø—Ä–æ–¥—É–∫—Ç—ã‚Äë–∏—Å—Ç–æ—á–Ω–∏–∫–∏.',
      priority: 'HIGH',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.70,
      whyImportant: '–°–∫—Ä—ã—Ç—ã–µ –¥–µ—Ñ–∏—Ü–∏—Ç—ã –≤–ª–∏—è—é—Ç –Ω–∞ —ç–Ω–µ—Ä–≥–∏—é, —Å–æ–Ω –∏ –∞–ø–ø–µ—Ç–∏—Ç –¥–∞–∂–µ –±–µ–∑ —è–≤–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤.'
    },
    // C8: Omega Balancer
    OMEGA_BALANCER: {
      name: '–û–º–µ–≥–∞‚Äë–±–∞–ª–∞–Ω—Å (Omega‚Äë6 : Omega‚Äë3)',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –æ–º–µ–≥–∞‚Äë–∂–∏—Ä–æ–≤: —á–µ–º –±–ª–∏–∂–µ –∫ —Ü–µ–ª–µ–≤–æ–º—É —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—é, —Ç–µ–º –Ω–∏–∂–µ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–æ–Ω.',
      details: '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ omega‚Äë6:omega‚Äë3 ‚Äî –º–∞—Ä–∫–µ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –∂–∏—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è. –í—ã—Å–æ–∫–∏–π –ø–µ—Ä–µ–∫–æ—Å –≤ —Å—Ç–æ—Ä–æ–Ω—É omega‚Äë6 –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω —Å –ø—Ä–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–º —Ñ–æ–Ω–æ–º, —Ç–æ–≥–¥–∞ –∫–∞–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π omega‚Äë3 —É–ª—É—á—à–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ü–∏—é –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ–¥–∏–∞—Ç–æ—Ä–æ–≤ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –¶–µ–ª–µ–≤–æ–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä <4:1 ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–æ–Ω–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ã—á–Ω–æ –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–µ—Ä–¥–µ—á–Ω–æ‚Äë–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ. –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –≤–∞–∂–Ω—ã –Ω–µ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∫–∏, –Ω–æ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—Ä—ã–±–∞, —Å–µ–º–µ–Ω–∞, –æ—Ä–µ—Ö–∏) –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–Ω–∏–∂–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å–∂–∏—Ä–æ–≤ –∏ –∏–∑–±—ã—Ç–∫–∞ —Å–∞—Ö–∞—Ä–∞.',
      formula: 'Ratio = omega6 / omega3.\n–¶–µ–ª—å: <4:1. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º —Å–∞—Ö–∞—Ä –∏ —Ç—Ä–∞–Ω—Å–∂–∏—Ä—ã –∫–∞–∫ —É—Å–∏–ª–∏—Ç–µ–ª–∏ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è.',
      sources: [
        {
          label: 'NIH ODS ‚Äî Omega‚Äë3 Fatty Acids (consumer fact sheet)',
          url: 'https://ods.od.nih.gov/factsheets/Omega3FattyAcids-Consumer/'
        }
      ],
      interpretation: '–ß–µ–º –Ω–∏–∂–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ, —Ç–µ–º –ª—É—á—à–µ –±–∞–ª–∞–Ω—Å. –í—ã—Å–æ–∫–æ–µ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –ø–µ—Ä–µ–∫–æ—Å–∞.',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.55,
      whyImportant: '–ë–∞–ª–∞–Ω—Å –æ–º–µ–≥–∞‚Äë–∂–∏—Ä–æ–≤ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ, —Å–æ—Å—É–¥—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.'
    },
    // C9: Heart Health
    HEART_HEALTH: {
      name: '–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–¥—Ü–∞: Na/K + —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω',
      short: '–°–ª–µ–¥–∏—Ç –∑–∞ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ –¥–∞–≤–ª–µ–Ω–∏—è –∏ —Å–æ—Å—É–¥–∏—Å—Ç–æ–≥–æ —Ä–∏—Å–∫–∞: –Ω–∞—Ç—Ä–∏–π, –∫–∞–ª–∏–π –∏ —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –≤ –¥–∏–Ω–∞–º–∏–∫–µ.',
      details: '–ü–∞–Ω–µ–ª—å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç—Ä–∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã—Ö –æ—Å–∏ –∫–∞—Ä–¥–∏–æ—Ä–∏—Å–∫–∞: –Ω–∞—Ç—Ä–∏–π, –∫–∞–ª–∏–π –∏ —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω. –û—Ç–Ω–æ—à–µ–Ω–∏–µ Na/K <1.0 —Å–≤—è–∑–∞–Ω–æ —Å –±–æ–ª–µ–µ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è, –∞ –∏–∑–±—ã—Ç–æ–∫ –Ω–∞—Ç—Ä–∏—è –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–∞–ª–∏–∏ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏–∏. –ê–Ω–∞–ª–∏–∑ –ø–æ 7‚Äë–¥–Ω–µ–≤–Ω–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å ¬´—à—É–º¬ª –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–ª—ë–Ω—ã–π —É–∂–∏–Ω) –∏ –≤–∏–¥–µ—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω. –°–º—ã—Å–ª –º–µ—Ç—Ä–∏–∫–∏ ‚Äî –Ω–µ –∑–∞–ø—Ä–µ—Ç —Å–æ–ª–∏, –∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –±–∞–ª–∞–Ω—Å —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–æ–≤ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞—Ü–∏–æ–Ω–∞.',
      formula: 'Na/K ratio (—Ü–µ–ª—å <1.0) + —Å—É—Ç–æ—á–Ω—ã–π –Ω–∞—Ç—Ä–∏–π (<2000 –º–≥) + —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω.\n–°—á–∏—Ç–∞–µ–º –ø–æ 7‚Äë–¥–Ω–µ–≤–Ω–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É.',
      sources: [
        {
          label: 'WHO Guideline ‚Äî Sodium intake for adults and children (2012)',
          url: 'https://www.who.int/publications/i/item/9789241504836'
        },
        {
          label: 'WHO Guideline ‚Äî Potassium intake for adults and children (2012)',
          url: 'https://www.who.int/publications/i/item/9789241504829'
        }
      ],
      interpretation: 'Na/K <1.0 ‚Äî —Ö–æ—Ä–æ—à–æ. –í—ã—Å–æ–∫–∏–π –Ω–∞—Ç—Ä–∏–π –∏–ª–∏ –Ω–∏–∑–∫–∏–π –∫–∞–ª–∏–π = —Ä–∏—Å–∫ –¥–∞–≤–ª–µ–Ω–∏—è.',
      priority: 'HIGH',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.75,
      whyImportant: '–ë–∞–ª–∞–Ω—Å –Ω–∞—Ç—Ä–∏—è/–∫–∞–ª–∏—è ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö —Å–∏–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –¥–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–∏—Å–∫–∞ –°–°–ó.'
    },
    // C10: NOVA Quality
    NOVA_QUALITY: {
      name: '–ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã (NOVA)',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–ª—é —É–ª—å—Ç—Ä–∞‚Äë–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –µ–¥—ã: —á–µ–º –æ–Ω–∞ –Ω–∏–∂–µ, —Ç–µ–º –ª—É—á—à–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞.',
      details: '–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è NOVA –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ ¬´–∫–∞–ª–æ—Ä–∏–∏¬ª, –Ω–æ –∏ —Å—Ç–µ–ø–µ–Ω—å –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏. –í—ã—Å–æ–∫–∞—è –¥–æ–ª—è NOVA‚Äë4 (—É–ª—å—Ç—Ä–∞‚Äë–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã) —Å–≤—è–∑–∞–Ω–∞ —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º —Ä–∏—Å–∫–æ–º –æ–∂–∏—Ä–µ–Ω–∏—è –∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤ –ø–æ–ø—É–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö. –ü–æ—Ä–æ–≥ >50% —É–¥–æ–±–µ–Ω –∫–∞–∫ —Å–∏–≥–Ω–∞–ª, —á—Ç–æ —Ä–∞—Ü–∏–æ–Ω —Å–º–µ—â—ë–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –Ω–∏–∑–∫–æ–π –ø–∏—â–µ–≤–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç—å—é –∏ –≤—ã—Å–æ–∫–æ–π ¬´–≥–∏–ø–µ—Ä–≤–∫—É—Å–Ω–æ—Å—Ç—å—é¬ª. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–∫—É—Å ‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è—Ç—å —á–∞—Å—Ç—å NOVA‚Äë4 –Ω–∞ —Ü–µ–ª—å–Ω—ã–µ –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∞ –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è —Ä–µ–∑–∫–æ —É–±—Ä–∞—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É.',
      formula: '% –∫–∞–ª–æ—Ä–∏–π –∏–∑ NOVA‚Äë4 (—É–ª—å—Ç—Ä–∞‚Äë–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ).\n–ë–æ–ª—å—à–µ –¥–æ–ª—è = –Ω–∏–∂–µ Quality Score. –§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ/—Å—ã—Ä—ã–µ –¥–∞—é—Ç –Ω–µ–±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å.',
      sources: [
        {
          label: 'Monteiro et al., 2019 ‚Äî Ultra‚Äëprocessed foods and health (BMJ)',
          url: 'https://www.bmj.com/content/365/bmj.l2289'
        }
      ],
      interpretation: '–ï—Å–ª–∏ NOVA‚Äë4 >50% ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞ –Ω–∏–∑–∫–æ–µ. –¶–µ–ª—å ‚Äî —Å–Ω–∏–∑–∏—Ç—å –¥–æ–ª—é UPF.',
      priority: 'HIGH',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.70,
      whyImportant: '–£–ª—å—Ç—Ä–∞‚Äë–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å–≤—è–∑–∞–Ω—ã —Å —Ä–∏—Å–∫–æ–º –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π.'
    },
    // C11: Training & Recovery
    TRAINING_RECOVERY: {
      name: '–ù–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
      short: '–ü–æ–º–æ–≥–∞–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–º–∏ –¥–Ω—è–º–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å—Å—è.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ª—é –≤—ã—Å–æ–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã (Z4‚ÄëZ5) —Å –Ω–∏–∑–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π (Z1‚ÄëZ2) –∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–æ–Ω, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ). –ï—Å–ª–∏ –≤—ã—Å–æ–∫–∏–µ –∑–æ–Ω—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è 3+ –¥–Ω—è –ø–æ–¥—Ä—è–¥ –ø—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Ä–∞—Å—Ç—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–≥—Ä—É–∑–∞ –∏ —Å–Ω–∏–∂–µ–Ω–∏—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏. –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –Ω–µ –∑–Ω–∞—á–∏—Ç ¬´—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –º–µ–Ω—å—à–µ¬ª, –∞ –∑–Ω–∞—á–∏—Ç —Ü–∏–∫–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É: —Ç—è–∂—ë–ª—ã–µ –¥–Ω–∏ —á–µ—Ä–µ–¥–æ–≤–∞—Ç—å —Å –ª—ë–≥–∫–∏–º–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å–Ω–∏–∂–∞—è —Ä–∏—Å–∫ —Ç—Ä–∞–≤–º.',
      formula: '–î–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤ Z4‚ÄëZ5 vs Z1‚ÄëZ2.\n–ü–µ—Ä–µ—Ç—Ä–µ–Ω: 3+ –ø–æ–¥—Ä—è–¥ –≤—ã—Å–æ–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö –¥–Ω–µ–π + —É—Ö—É–¥—à–µ–Ω–∏–µ —Å–Ω–∞/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.',
      sources: [
        {
          label: 'Seiler, 2010 ‚Äî intensity distribution in endurance training',
          pmid: '20847704'
        }
      ],
      interpretation: '–ú–Ω–æ–≥–æ Z4‚ÄëZ5 –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è = —Ä–∏—Å–∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∞. –ù—É–∂–Ω—ã –ª—ë–≥–∫–∏–µ –¥–Ω–∏.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'WEEKLY',
      impactScore: 0.65,
      whyImportant: '–ë–∞–ª–∞–Ω—Å –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ä–∏—Å–∫ —Ç—Ä–∞–≤–º.'
    },
    // C12: Hypertrophy & Composition
    HYPERTROPHY_COMPOSITION: {
      name: '–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è',
      short: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –Ω–∞–±–æ—Ä –º—ã—à—Ü –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –∑–∞–º–µ—Ä–æ–≤ –Ω–∞ —Ñ–æ–Ω–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –±–µ–ª–∫–∞ –∏ —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
      details: '–î–ª—è –æ—Ü–µ–Ω–∫–∏ –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏ –≤–∞–∂–Ω–µ–µ —Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–µ–Ω–¥ –∑–∞–º–µ—Ä–æ–≤ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, —á–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å—É —Ç–µ–ª–∞. –†–æ—Å—Ç –æ–±—Ö–≤–∞—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –≤–µ—Å–µ —á–∞—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é (–º—ã—à—Ü—ã ‚Üë –ø—Ä–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ –∂–∏—Ä–∞), –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è –¥–≤–∞ —É—Å–ª–æ–≤–∏—è: –±–µ–ª–æ–∫ –æ–∫–æ–ª–æ 1.6 –≥/–∫–≥/—Å—É—Ç –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è —Å–∏–ª–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞. –ú–µ—Ç—Ä–∏–∫–∞ –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ 2‚Äì4-–Ω–µ–¥–µ–ª—å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è –≤–æ–¥—ã –∏ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ –º–æ–≥—É—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å. –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∞ –Ω–µ —Ä–∞–∑–æ–≤—ã–µ —Å–∫–∞—á–∫–∏.',
      formula: '–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏–∑–º–µ—Ä–µ–Ω–∏—è (biceps/thigh) –Ω–∞ —Ñ–æ–Ω–µ:\n–±–µ–ª–æ–∫ ‚â•1.6 –≥/–∫–≥/–¥–µ–Ω—å + —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.\n–†–æ—Å—Ç –æ–±—Ö–≤–∞—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –≤–µ—Å–µ = –Ω–∞–±–æ—Ä –º—ã—à—Ü.',
      sources: [
        {
          label: 'Morton et al., 2018 ‚Äî protein and resistance training meta‚Äëanalysis',
          pmid: '28698222'
        }
      ],
      interpretation: '–†–æ—Å—Ç –æ–±—Ö–≤–∞—Ç–æ–≤ –ø—Ä–∏ –Ω–æ—Ä–º–µ –∫–∞–ª–æ—Ä–∏–π ‚Äî —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫. –ë–µ–∑ –±–µ–ª–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–∞–ª–æ.',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'WEEKLY',
      impactScore: 0.60,
      whyImportant: '–ò–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –ª—É—á—à–µ, —á–µ–º –≤–µ—Å –Ω–∞ –≤–µ—Å–∞—Ö.'
    },
    // C13: Vitamin Defense Radar (NEW v6.0 ‚Äî Phase 1, 12.02.2026)
    VITAMIN_DEFENSE: {
      name: '–†–∞–¥–∞—Ä 11 –≤–∏—Ç–∞–º–∏–Ω–æ–≤',
      short: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç –∫–ª—é—á–µ–≤—ã—Ö –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ DRI: A, C, D, E, K, B1-B6, B9, B12.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ 11 –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∑–∞ 7+ –¥–Ω–µ–π –∏ –≤—ã—è–≤–ª—è–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç—ã (<70% DRI). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è: –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã (A/C/E), –∫–æ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (D/K), —ç–Ω–µ—Ä–≥–æ–æ–±–º–µ–Ω (B1/B2/B3/B6), –∫—Ä–æ–≤–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ (B9/B12). –°–Ω–∏–∂–µ–Ω–∏–µ –±–∞–ª–ª–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç (‚â•5 –≤–∏—Ç–∞–º–∏–Ω–æ–≤) —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —Ä–∞—Ü–∏–æ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è gender-adjusted DRI –∏–∑ IOM 2011.',
      formula: '–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏—Ç–∞–º–∏–Ω–∞:\n  intake = Œ£(products √ó grams/100) / days\n  pctDV = (intake / DRI[gender]) √ó 100\n  deficit = pctDV < 70%\n\nScore = 100 - (countDeficits √ó 8), clamp [0, 100]\n–ö–ª–∞—Å—Ç–µ—Ä—ã: antioxidant / bone / energy / blood.',
      sources: [
        {
          label: 'IOM, 2011 ‚Äî Dietary Reference Intakes',
          pmid: '24566440'
        },
        {
          label: 'Kennedy, 2016 ‚Äî Vitamin defence mechanisms',
          pmid: '26828517'
        }
      ],
      interpretation: '‚â•85 ‚Äî –æ—Ç–ª–∏—á–Ω–æ (0-1 –¥–µ—Ñ–∏—Ü–∏—Ç). 70-84 ‚Äî —Ä–∏—Å–∫ (2-3 –¥–µ—Ñ–∏—Ü–∏—Ç–∞). <70 ‚Äî –æ–ø–∞—Å–Ω–æ (‚â•5 –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤).',
      priority: 'HIGH',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.75,
      whyImportant: '–í–∏—Ç–∞–º–∏–Ω—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç, —ç–Ω–µ—Ä–≥–∏—é, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –î–µ—Ñ–∏—Ü–∏—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–∏—Ç–∞–º–∏–Ω–æ–≤ = –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫.'
    },
    // C22: B-Complex Energy & Anemia Risk (NEW v6.0 ‚Äî Phase 1, 12.02.2026)
    B_COMPLEX_ANEMIA: {
      name: 'B-–∫–æ–º–ø–ª–µ–∫—Å + –∞–Ω–µ–º–∏—è',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –≤–∏—Ç–∞–º–∏–Ω—ã –≥—Ä—É–ø–ø—ã B (—ç–Ω–µ—Ä–≥–æ–æ–±–º–µ–Ω) + –∂–µ–ª–µ–∑–æ (—Ä–∏—Å–∫ –∞–Ω–µ–º–∏–∏).',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç 6 –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã B (B1/B2/B3/B6 ‚Äî "energy quartet", B9/B12 ‚Äî "blood pair") + –∂–µ–ª–µ–∑–æ –∑–∞ 7+ –¥–Ω–µ–π. –î–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞: energyBscore (—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º) –∏ bloodBscore (–∫—Ä–æ–≤–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ). –†–∏—Å–∫ –∞–Ω–µ–º–∏–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤: –∂–µ–ª–µ–∑–æ <70% DRI ‚Üí iron-deficiency anemia (+30), B12 <70% ‚Üí pernicious anemia (+30), —Ñ–æ–ª–∞—Ç (B9) <70% ‚Üí megaloblastic anemia (+25). –í—Å–µ —Ç—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ ‚Üí compound risk (100). Gender-adjusted: –∂–µ–ª–µ–∑–æ 18mg (female) vs 8mg (male). Vegetarian risk flag: –µ—Å–ª–∏ B12 –¥–µ—Ñ–∏—Ü–∏—Ç + <30% –¥–Ω–µ–π —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ B12.',
      formula: 'energyBscore = avg(B1%, B2%, B3%, B6%)\nbloodBscore = avg(B9%, B12%)\n\nanemiaRisk = 0\n  if Fe < 70% ‚Üí +30 (iron-def)\n  if B12 < 70% ‚Üí +30 (pernicious)\n  if B9 < 70% ‚Üí +25 (megaloblastic)\n  if all three ‚Üí 100 (compound)\n\nScore = energyBscore √ó 0.4 + bloodBscore √ó 0.3 + (100 - anemiaRisk) √ó 0.3',
      sources: [
        {
          label: 'Kennedy, 2016 ‚Äî B-vitamins and brain function',
          pmid: '26828517'
        },
        {
          label: 'Ssonko, 2018 ‚Äî Anemia and micronutrients',
          pmid: '29215971'
        }
      ],
      interpretation: '‚â•70 ‚Äî —Ö–æ—Ä–æ—à–æ (–Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ –∞–Ω–µ–º–∏–∏). 50-69 ‚Äî —Ä–∏—Å–∫ (—É–º–µ—Ä–µ–Ω–Ω—ã–π). <50 ‚Äî –æ–ø–∞—Å–Ω–æ (–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –∞–Ω–µ–º–∏–∏).',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'WEEKLY',
      impactScore: 0.80,
      whyImportant: 'B-–∫–æ–º–ø–ª–µ–∫—Å –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è. –ê–Ω–µ–º–∏—è (Fe/B12/B9 –¥–µ—Ñ–∏—Ü–∏—Ç) = —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è.'
    },
    // C14: Glycemic Load Optimizer (NEW v6.0 ‚Äî Phase 2, 12.02.2026)
    GLYCEMIC_LOAD: {
      name: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (GL)',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É –ø–æ –ø—Ä–∏—ë–º–∞–º –∏ –∑–∞ –¥–µ–Ω—å: GI √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤.',
      details: '–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç GI, –º–µ—Ç—Ä–∏–∫–∞ GL —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –∫–∞—á–µ—Å—Ç–≤–æ, –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤. –†–∞—Å—á—ë—Ç –≤–µ–¥—ë—Ç—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–∏—ë–º—É: GI √ó (simple+complex carbs) √ó grams / 10000, –∑–∞—Ç–µ–º —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è –∑–∞ –¥–µ–Ω—å. –ö–ª–∞—Å—Å—ã: mealGL <10 low, 10-20 medium, >20 high; dailyGL <80 low, 80-120 medium, >120 high. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –≤–µ—á–µ—Ä–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (–ø–æ—Å–ª–µ 18:00): –µ—Å–ª–∏ >50% —Å—É—Ç–æ—á–Ω–æ–≥–æ GL –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –≤–µ—á–µ—Ä, –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —à—Ç—Ä–∞—Ñ –∫ score. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–Ω–∏–∂–∞—Ç—å —Ä–∏—Å–∫ —Å–∞—Ö–∞—Ä–Ω—ã—Ö ¬´–∫–∞—á–µ–ª–µ–π¬ª, –≤–µ—á–µ—Ä–Ω–∏—Ö –ø–∏–∫–æ–≤ –≥–ª—é–∫–æ–∑—ã –∏ —É—Ö—É–¥—à–µ–Ω–∏—è —Å–Ω–∞.',
      formula: 'mealGL = Œ£(GI √ó (simple100 + complex100) √ó grams / 10000)\ndailyGL = Œ£(mealGL)\neveningRatio = eveningGL / dailyGL\n\nScore = max(0, 100 - (dailyGL - 80) √ó 0.5 - eveningPenalty)\nwhere eveningPenalty = 15 if eveningRatio > 0.5 else 0',
      sources: [
        {
          label: 'Brand-Miller et al., 2003 ‚Äî Glycemic index and glycemic load in chronic disease',
          pmid: '12081850'
        },
        {
          label: 'Barclay et al., 2008 ‚Äî Glycemic index, glycemic load and chronic disease risk',
          pmid: '18835944'
        }
      ],
      interpretation: '‚â•80 ‚Äî —Ö–æ—Ä–æ—à–æ. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫. <60 ‚Äî –≤—ã—Å–æ–∫–∏–π GL/–≤–µ—á–µ—Ä–Ω—è—è —É–≥–ª–µ–≤–æ–¥–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'DAILY',
      impactScore: 0.78,
      whyImportant: 'GL —Ç–æ—á–Ω–µ–µ GI –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Ü–∏–æ–Ω–∞: —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—Ü–∏–∏ –∏ –ª—É—á—à–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É –¥–Ω—è.'
    },
    // C15: Protein Distribution (NEW v6.0 ‚Äî Phase 2, 12.02.2026)
    PROTEIN_DISTRIBUTION: {
      name: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –±–µ–ª–æ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω –ø–æ –ø—Ä–∏—ë–º–∞–º —Å –ø–æ–ø–∞–¥–∞–Ω–∏–µ–º –≤ –∑–æ–Ω—É 20‚Äì40–≥/–ø—Ä–∏—ë–º.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Å—É—Ç–æ—á–Ω—ã–π –±–µ–ª–æ–∫, –Ω–æ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—ë–º–∞–º. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è mealProtein = Œ£(protein100 √ó grams / 100), –∑–∞—Ç–µ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: <10–≥ subthreshold, 10-20–≥ below optimal, 20-40–≥ optimal, >50–≥ excess. –ù–∞ —É—Ä–æ–≤–Ω–µ –¥–Ω—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–æ–ª—è optimal-–ø—Ä–∏—ë–º–æ–≤ –∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (protein spread). –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É max –∏ min –ø—Ä–∏—ë–º–æ–º <20–≥ ‚Äî –¥–∞—ë—Ç—Å—è bonus –∑–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å. –ò—Ç–æ–≥–æ–≤—ã–π score –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (70%), –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å—É—Ç–æ—á–Ω–æ–π —Ü–µ–ª–∏ –ø–æ –±–µ–ª–∫—É (–¥–æ 30%) –∏ evenness-–±–æ–Ω—É—Å.',
      formula: 'mealProtein = Œ£(protein100 √ó grams / 100)\ndistributionScore = optimalMeals / totalMeals √ó 100\nevenBonus = 10 if (maxMealProtein - minMealProtein) < 20 else 0\n\nScore = distributionScore √ó 0.7 + min(100, totalProtein/targetProtein √ó 100) √ó 0.3 + evenBonus',
      sources: [
        {
          label: 'Schoenfeld et al., 2018 ‚Äî Protein timing and hypertrophy',
          pmid: '29497353'
        },
        {
          label: 'Moore et al., 2009 ‚Äî Dose-response of muscle protein synthesis',
          pmid: '19056590'
        },
        {
          label: 'Leidy et al., 2015 ‚Äî Morning protein and satiety',
          pmid: '25926512'
        }
      ],
      interpretation: '‚â•80 ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. 60-79 ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ. <60 ‚Äî –±–µ–ª–æ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.',
      priority: 'HIGH',
      category: 'NUTRITION',
      actionability: 'DAILY',
      impactScore: 0.76,
      whyImportant: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ –ø–æ –ø—Ä–∏—ë–º–∞–º —É—Å–∏–ª–∏–≤–∞–µ—Ç MPS –∏ —É–ª—É—á—à–∞–µ—Ç —Å—ã—Ç–æ—Å—Ç—å, –¥–∞–∂–µ –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º —Å—É—Ç–æ—á–Ω–æ–º –±–µ–ª–∫–µ.'
    },
    // C16: Antioxidant Defense (NEW v6.0 ‚Äî Phase 3, 12.02.2026)
    ANTIOXIDANT_DEFENSE: {
      name: '–ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–æ–π –∑–∞—â–∏—Ç—ã (A/C/E + Se + Zn) —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç 5 –∫–ª—é—á–µ–≤—ã—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã: –≤–∏—Ç–∞–º–∏–Ω A (20%), –≤–∏—Ç–∞–º–∏–Ω C (30%), –≤–∏—Ç–∞–º–∏–Ω E (20%), —Å–µ–ª–µ–Ω (15%), —Ü–∏–Ω–∫ (15%). –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ–∫—Å–∏–¥–∞—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: high demand –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ Z4-Z5 >20 –º–∏–Ω—É—Ç, moderate –ø—Ä–∏ –ª—é–±–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ, low –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ü—Ä–∏ high demand –∏—Ç–æ–≥–æ–≤—ã–π score –ø–æ–Ω–∏–∂–∞–µ—Ç—Å—è –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä–æ–º 0.85, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –±–æ–ª—å—à—É—é —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å. –§–ª–∞–≥–∏ —Ä–∏—Å–∫–∞: antioxidant index <60, vitC <50% –ø—Ä–∏ high demand, vitE <50% –≤ —Å–≤—è–∑–∫–µ —Å –≤—ã—Å–æ–∫–æ–π –¥–æ–ª–µ–π NOVA-4.',
      formula: 'antioxidantIndex = min(1, A/DRI_A)√ó20 + min(1, C/DRI_C)√ó30 + min(1, E/DRI_E)√ó20 + min(1, Se/55)√ó15 + min(1, Zn/11)√ó15\n\nScore = antioxidantIndex √ó (demand === high ? 0.85 : 1.0)',
      sources: [
        {
          label: 'Carlsen et al., 2010 ‚Äî Total antioxidant content of foods',
          pmid: '20096093'
        },
        {
          label: 'Powers et al., 2004 ‚Äî Exercise-induced oxidative stress',
          pmid: '12424324'
        }
      ],
      interpretation: '‚â•80 ‚Äî —Ö–æ—Ä–æ—à–∞—è –∑–∞—â–∏—Ç–∞. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–æ–≤. <60 ‚Äî –∑–∞—â–∏—Ç–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'DAILY',
      impactScore: 0.77,
      whyImportant: '–û–∫—Å–∏–¥–∞—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–µ—Å—Å –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –±–µ–∑ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–æ–∂–µ—Ç —É—Ö—É–¥—à–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å.'
    },
    // C18: Added Sugar & Dependency (NEW v6.0 ‚Äî Phase 3, 12.02.2026)
    ADDED_SUGAR_DEPENDENCY: {
      name: '–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å',
      short: 'Tier-–æ—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ (A/B/C) + –ø–∞—Ç—Ç–µ—Ä–Ω –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–∞—Ö–∞—Ä–Ω—ã–µ streak-—Ä–∏—Å–∫–∏.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç data reality –ø—Ä–æ–µ–∫—Ç–∞: –≤ shared_products –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ sugar100, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è tier-based –æ—Ü–µ–Ω–∫–∞. Tier A: –ø—Ä—è–º–æ–µ sugar100 (confidence 1.0), Tier B: simple100√ó0.70 –ø—Ä–∏ NOVA-4 (confidence 0.70), Tier C: simple100√ó0.30 –ø—Ä–∏ NOVA<4 (confidence 0.50). –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è dailySugar, streak –¥–Ω–µ–π >25–≥ (WHO threshold), –¥–æ–ª—è —Å–∞—Ö–∞—Ä–∞ –≤ —É–≥–ª–µ–≤–æ–¥–∞—Ö, –∞ —Ç–∞–∫–∂–µ cross-pattern —Ñ–ª–∞–≥ ¬´ultra-processed sugar trap¬ª –ø—Ä–∏ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ high sugar –∏ NOVA-4. –ò—Ç–æ–≥–æ–≤—ã–π score –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –Ω–∞ confidence, —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å –∏–∑–º–µ—Ä–µ–Ω–Ω—ã–µ –∏ –æ—Ü–µ–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.',
      formula: 'dailySugar = Œ£(tierAdjustedSugar)\nScore = max(0, 100 - max(0, dailySugar - 25)√ó1.5 - dependencyPenalty - moodSwingPenalty) √ó dayConfidence',
      sources: [
        {
          label: 'WHO, 2015 ‚Äî Guideline: Sugars intake for adults and children',
          pmid: '25231862'
        },
        {
          label: 'Lustig et al., 2012 ‚Äî Metabolic effects of sugar',
          pmid: '22351714'
        },
        {
          label: 'Monteiro et al., 2019 ‚Äî NOVA and ultra-processed foods',
          pmid: '31142457'
        }
      ],
      interpretation: '‚â•80 ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞. 60-79 ‚Äî –∑–æ–Ω–∞ –≤–Ω–∏–º–∞–Ω–∏—è. <60 ‚Äî –∏–∑–±—ã—Ç–æ–∫/–∑–∞–≤–∏—Å–∏–º—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω.',
      priority: 'HIGH',
      category: 'METABOLISM',
      actionability: 'DAILY',
      impactScore: 0.79,
      whyImportant: '–ò–∑–±—ã—Ç–æ—á–Ω—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä —Å–≤—è–∑–∞–Ω —Å –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–º–∏ —Ä–∏—Å–∫–∞–º–∏ –∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é —ç–Ω–µ—Ä–≥–∏–∏/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.'
    },
    // C17: Bone Health Index (NEW v6.0 ‚Äî Phase 4, 12.02.2026)
    BONE_HEALTH: {
      name: '–ó–¥–æ—Ä–æ–≤—å–µ –∫–æ—Å—Ç–µ–π',
      short: '–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–æ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è: Ca + D + K + P + —Å–∏–ª–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –∏ Ca:P ratio.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–æ—Å—Ç–Ω–æ–π —Ç–∫–∞–Ω–∏ (–∫–∞–ª—å—Ü–∏–π, –≤–∏—Ç–∞–º–∏–Ω D, –≤–∏—Ç–∞–º–∏–Ω K, —Ñ–æ—Å—Ñ–æ—Ä), –±–∞–ª–∞–Ω—Å Ca:P –∏ –Ω–∞–ª–∏—á–∏–µ weight-bearing –Ω–∞–≥—Ä—É–∑–∫–∏ (strength training). –ë–∞–∑–æ–≤—ã–µ –≤–µ—Å–∞: Ca 35%, D 25%, K 15%, P 10%. Ratio-–±–ª–æ–∫: –æ–ø—Ç–∏–º—É–º Ca:P 1.0‚Äì2.0 –¥–∞—ë—Ç –±–æ–Ω—É—Å, –∫—Ä–∞–π–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–∞—é—Ç —à—Ç—Ä–∞—Ñ. Exercise-–±–ª–æ–∫: —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–∏–ª–æ–≤—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç –±–æ–Ω—É—Å –∫–∞–∫ —Å—Ç–∏–º—É–ª –∫–æ—Å—Ç–Ω–æ–≥–æ —Ä–µ–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è. –†–∏—Å–∫-–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∂–µ–Ω—â–∏–Ω —Å—Ç–∞—Ä—à–µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ —É–∂–µ—Å—Ç–æ—á–∞–µ—Ç —Ü–µ–ª–µ–≤—ã–µ –ø–æ—Ä–æ–≥–∏. –°–∏–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–ª–∞–≥–∏: VitD<50% –∏ VitK<50% –∫–∞–∫ –ø—Ä–∏–∑–Ω–∞–∫–∏ —É—Ö—É–¥—à–µ–Ω–∏—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–ª—å—Ü–∏—è.',
      formula: 'Score = Ca_pct + VitD_pct + VitK_pct + P_pct + ratioBonus + exerciseBonus - riskPenalty\nwhere Ca_pct=min(1,Ca/1000)√ó35, VitD_pct=min(1,D/15)√ó25, VitK_pct=min(1,K/DRI_K)√ó15, P_pct=min(1,P/700)√ó10',
      sources: [
        {
          label: 'Weaver et al., 2016 ‚Äî Calcium plus vitamin D and bone health',
          pmid: '26856587'
        },
        {
          label: 'Cashman et al., 2011 ‚Äî Vitamin D and musculoskeletal health',
          pmid: '21118827'
        }
      ],
      interpretation: '‚â•80 ‚Äî —Ö–æ—Ä–æ—à–∏–π –∫–æ—Å—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫. <60 ‚Äî –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ—Å—Ç–µ–π.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'WEEKLY',
      impactScore: 0.74,
      whyImportant: '–ö–æ—Å—Ç–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—á–µ—Ç–∞–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –∏ —Å–∏–ª–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏, –∞ –Ω–µ –æ—Ç –æ–¥–Ω–æ–≥–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞.'
    },
    // C19: Training-Type Nutrition Match (NEW v6.0 ‚Äî Phase 4, 12.02.2026)
    TRAINING_TYPE_MATCH: {
      name: '–ü–∏—Ç–∞–Ω–∏–µ –ø–æ–¥ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      short: '–°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (cardio/strength/hobby) —Å –º–∞–∫—Ä–æ- –∏ post-workout —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∏—Ç–∞–Ω–∏—è —Ü–µ–ª—è–º —ç—Ç–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏. –î–ª—è cardio-intense —Ñ–æ–∫—É—Å –Ω–∞ —É–≥–ª–µ–≤–æ–¥–∞—Ö –∏ –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –≥–ª–∏–∫–æ–≥–µ–Ω–∞; –¥–ª—è strength ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫ –∏ –±–µ–ª–∫–æ–≤–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏; –¥–ª—è hobby/light ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Ä–µ–∂–∏–º –±–µ–∑ –∂—ë—Å—Ç–∫–æ–≥–æ —Ç–∞–π–º–∏–Ω–≥–∞. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è post-workout –æ–∫–Ω–æ (2—á), –∞ —Ç–∞–∫–∂–µ recovery-–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã (Mg –∏ VitC) –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ò—Ç–æ–≥–æ–≤—ã–π score –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç macro-match (50%), post-workout (30%) –∏ recovery-–±–ª–æ–∫ (20%).',
      formula: 'Score = macroMatchScore√ó0.5 + postWorkoutScore√ó0.3 + recoveryNutrientScore√ó0.2',
      sources: [
        {
          label: 'Thomas et al., 2016 ‚Äî Position of the Academy/ACSM on nutrition and athletic performance',
          pmid: '26891166'
        },
        {
          label: 'Kerksick et al., 2017 ‚Äî Nutrient timing and exercise outcomes',
          pmid: '29182451'
        }
      ],
      interpretation: '‚â•80 ‚Äî –ø–∏—Ç–∞–Ω–∏–µ —Ö–æ—Ä–æ—à–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–∏–ø—É –Ω–∞–≥—Ä—É–∑–æ–∫. 60-79 ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ. <60 ‚Äî mismatch.',
      priority: 'HIGH',
      category: 'ACTIVITY',
      actionability: 'DAILY',
      impactScore: 0.81,
      whyImportant: '–û–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è cardio –∏ strength: –Ω—É–∂–µ–Ω —Ç–∏–ø-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥.'
    },
    // C20: Electrolyte Homeostasis (NEW v6.0 ‚Äî Phase 5, 12.02.2026)
    ELECTROLYTE_HOMEOSTASIS: {
      name: '–≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç Na/K/Mg/Ca –±–∞–ª–∞–Ω—Å —Å —É—á—ë—Ç–æ–º –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ —Ä–∏—Å–∫–æ–≤ –≥–∏–ø–æ–Ω–∞—Ç—Ä–∏–µ–º–∏–∏/–¥–∏—Å–±–∞–ª–∞–Ω—Å–∞.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã (–Ω–∞—Ç—Ä–∏–π, –∫–∞–ª–∏–π, –º–∞–≥–Ω–∏–π, –∫–∞–ª—å—Ü–∏–π) –∏ –∏—Ö —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è. –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∏—Å–∫-—Ñ–∞–∫—Ç–æ—Ä ‚Äî –≤—ã—Å–æ–∫–∏–π Na:K ratio (—Ü–µ–ª—å <1.0), –∞ —Ç–∞–∫–∂–µ –Ω–∏–∑–∫–∏–π –Ω–∞—Ç—Ä–∏–π –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º –ø–æ—Ç–æ–æ—Ç–¥–µ–ª–µ–Ω–∏–∏ (–≥–∏–ø–æ–Ω–∞—Ç—Ä–∏–µ–º–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω) –∏ –¥–µ—Ñ–∏—Ü–∏—Ç –º–∞–≥–Ω–∏—è. –ü—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–∞—Ö —Å –ø–æ—Ç–æ–º >800 –º–ª/—á –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–∞—Ö –ø–æ–≤—ã—à–∞—é—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è demand-–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä. –ò—Ç–æ–≥–æ–≤—ã–π score —É—á–∏—Ç—ã–≤–∞–µ—Ç ratio-–±–ª–æ–∫, –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É.',
      formula: 'Base = NaK_score√ó0.5 + Mg_score√ó0.2 + Ca_score√ó0.15 + K_score√ó0.15\nScore = Base - demandPenalty + adaptationBonus',
      sources: [
        {
          label: 'Shirreffs et al., 2005 ‚Äî Fluid and electrolyte needs for training and competition',
          pmid: '16078019'
        },
        {
          label: 'Maughan et al., 2012 ‚Äî IOC hydration consensus',
          pmid: '22308527'
        }
      ],
      interpretation: '‚â•80 ‚Äî —Ö–æ—Ä–æ—à–∏–π —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫. <60 ‚Äî –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'DAILY',
      impactScore: 0.78,
      whyImportant: '–≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ —Å–µ—Ä–¥–µ—á–Ω–æ-–º—ã—à–µ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.'
    },
    // C21: Nutrient Density Score (NEW v6.0 ‚Äî Phase 5, 12.02.2026)
    NUTRIENT_DENSITY: {
      name: '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
      short: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ —Ä–∞—Ü–∏–æ–Ω –¥–∞—ë—Ç –Ω–∞ 1000 –∫–∫–∞–ª (–±–µ–∑ –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥–∞ –∫–∞–ª–æ—Ä–∏–π).',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç ¬´–∫–∞—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–∏¬ª: –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω—ã—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –∫ —ç–Ω–µ—Ä–≥–æ—ë–º–∫–æ—Å—Ç–∏ —Ä–∞—Ü–∏–æ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NRF-–ø–æ–¥–æ–±–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è –≤–∫–ª–∞–¥ –±–µ–ª–∫–∞, –∫–ª–µ—Ç—á–∞—Ç–∫–∏, –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤ –Ω–∞ 1000 –∫–∫–∞–ª —Å –≤—ã—á–µ—Ç–æ–º –ø–µ–Ω–∞–ª—å—Ç–∏ –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä –∏ –∏–∑–±—ã—Ç–æ–∫ –Ω–∞—Ç—Ä–∏—è. –í–∞–∂–Ω—ã–π –ø–ª—é—Å –º–µ—Ç—Ä–∏–∫–∏ ‚Äî –æ–Ω–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –µ–¥—ã: –¥–∞–∂–µ –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π –º–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –≤—ã—Å–æ–∫–∏–π nutrient density –∑–∞ —Å—á—ë—Ç –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.',
      formula: 'DensityScore = Œ£(nutrients_per_1000kcal / target)√óweights - penalty(sugar, sodium)',
      sources: [
        {
          label: 'Drewnowski, 2005 ‚Äî Concept of nutrient density',
          pmid: '15795449'
        },
        {
          label: 'Drewnowski et al., 2018 ‚Äî NRF nutrient profiling models',
          pmid: '29581729'
        }
      ],
      interpretation: '‚â•80 ‚Äî –≤—ã—Å–æ–∫–∞—è –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å. 60-79 ‚Äî —Å—Ä–µ–¥–Ω—è—è. <60 ‚Äî –∫–∞–ª–æ—Ä–∏–∏ –±–µ–¥–Ω—ã –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏.',
      priority: 'HIGH',
      category: 'NUTRITION',
      actionability: 'DAILY',
      impactScore: 0.82,
      whyImportant: '–í—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ —É–ª—É—á—à–∞–µ—Ç –Ω–∞—Å—ã—â–µ–Ω–∏–µ –∏ –ø–æ–∫—Ä—ã—Ç–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–∞–ª–æ—Ä–∏–π.'
    },

    // === CORE PATTERNS (v2-v3) ‚Äî Scientific metadata (12.02.2026) ===
    MEAL_TIMING: {
      name: '–¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏',
      short: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É –ø—Ä–∏—ë–º–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –Ω–∏–º–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω.',
      details: '–ü–∞—Ç—Ç–µ—Ä–Ω –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ –≤–∞—à–∏—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏. –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –ø—Ä–∏—ë–º—ã (<3—á –∏–Ω—Ç–µ—Ä–≤–∞–ª) –º–æ–≥—É—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç—É –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω ‚Äî –∫–æ–≥–¥–∞ –Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π, —á—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ª–∏–ø–æ–ª–∏–∑–∞. –°–ª–∏—à–∫–æ–º —Ä–µ–¥–∫–∏–µ (>6—á) ‚Äî –∫ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω–æ–º—É –≥–æ–ª–æ–¥—É –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –ø—Ä–∏—ë–º–µ. –û–ø—Ç–∏–º—É–º: 3-5—á –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ª—é–¥–µ–π. –ú–µ—Ç—Ä–∏–∫–∞ —Ç–∞–∫–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–æ–≤ –≤ –¥–µ–Ω—å: 3-5 ‚Äî –Ω–æ—Ä–º–∞, <3 ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (—Ä–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è), >6 ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω–æ (–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞). –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Ç–∏–ø–∞.',
      formula: '–î–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã –ø—Ä–∏—ë–º–æ–≤:\n  interval = meal[i+1].time - meal[i].time\n  classify: <3h "frequent", 3-5h "optimal", >6h "long"\n\nScore:\n  optimalCount / totalIntervals √ó 70\n  + mealCount penalty/bonus (3-5 = +30, <3 or >6 = -20)\n  - overlap penalty (wave –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç)',
      sources: [
        {
          label: 'Kahleova et al., 2014 ‚Äî Meal frequency and metabolic health',
          pmid: '25489333'
        },
        {
          label: 'Paoli et al., 2019 ‚Äî Intermittent fasting vs frequent meals',
          pmid: '30472870'
        }
      ],
      interpretation: '‚â•80 ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞. 60-79 ‚Äî –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å. <60 ‚Äî —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∏–ª–∏ —Ä–µ–¥–∫–∏–µ –ø—Ä–∏—ë–º—ã.',
      priority: 'HIGH',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.75,
      whyImportant: '‚è∞ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –µ–¥–æ–π = —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è + —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –±–µ–∑ –≥–æ–ª–æ–¥–∞.'
    },
    WAVE_OVERLAP: {
      name: '–ü–µ—Ä–µ—Ö–ª—ë—Å—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω',
      short: '–î–µ—Ç–µ–∫—Ü–∏—è —Å–∏—Ç—É–∞—Ü–∏–π, –∫–æ–≥–¥–∞ –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã.',
      details: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ ‚Äî —ç—Ç–æ –ø–µ—Ä–∏–æ–¥ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–≥–æ –∏–Ω—Å—É–ª–∏–Ω–∞ –ø–æ—Å–ª–µ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏, –¥–ª—è—â–∏–π—Å—è 2.5-4.5—á –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–∞–≤–∞ –µ–¥—ã (–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å, –±–µ–ª–æ–∫, –∂–∏—Ä—ã). –ü–µ—Ä–µ—Ö–ª—ë—Å—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º —Å–ª—É—á–∞–µ—Ç—Å—è –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∏–Ω—Å—É–ª–∏–Ω –≤–µ—Ä–Ω—É–ª—Å—è –∫ –±–∞–∑–æ–≤–æ–º—É —É—Ä–æ–≤–Ω—é. –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–∏–ø–æ–ª–∏–∑–∞ (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è), –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (—Ä–∏—Å–∫ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏), —Ç—Ä—É–¥–Ω–µ–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å. –ú–µ—Ç—Ä–∏–∫–∞ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–ª–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ (—É—á–∏—Ç—ã–≤–∞—è GI, protein, fat) –∏ —Ñ–ª–∞–≥—É–µ—Ç –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç—ã. –ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç—ã (>50% –ø—Ä–∏—ë–º–æ–≤) ‚Äî —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —á–∞—Å—Ç–æ—Ç—É –∏–ª–∏ —Å–æ—Å—Ç–∞–≤ –µ–¥—ã.',
      formula: '–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞:\n  waveDuration = estimateInsulinWave(meal)\n    // 2.5h –¥–ª—è –Ω–∏–∑–∫–æ–≥–æ GI+–±–µ–ª–æ–∫, 4.5h –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ GI+–º–∞–ª–æ –±–µ–ª–∫–∞\n\n  if (nextMeal.time - meal.time) < waveDuration:\n    overlap = true\n\nScore = 100 - (overlapCount / totalMeals √ó 100)',
      sources: [
        {
          label: 'Hall et al., 2016 ‚Äî Insulin dynamics and energy balance',
          pmid: '27385608'
        },
        {
          label: 'Bray et al., 2016 ‚Äî Meal timing and insulin sensitivity',
          pmid: '27431364'
        }
      ],
      interpretation: '‚â•80 ‚Äî –º–∏–Ω–∏–º—É–º –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–æ–≤. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç—ã. <60 ‚Äî —á–∞—Å—Ç—ã–µ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç—ã (—É—Ö—É–¥—à–µ–Ω–∏–µ –ª–∏–ø–æ–ª–∏–∑–∞).',
      priority: 'HIGH',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.80,
      whyImportant: 'üåä –ü–µ—Ä–µ—Ö–ª—ë—Å—Ç –≤–æ–ª–Ω = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è. –î–∞–≤–∞–π –∏–Ω—Å—É–ª–∏–Ω—É –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±–∞–∑–µ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏!'
    },
    LATE_EATING: {
      name: '–ü–æ–∑–¥–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –ø—Ä–∏—ë–º–æ–≤ –ø–æ—Å–ª–µ 21:00 –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–æ–Ω –∏ –≤–µ—Å.',
      details: '–ü—Ä–∏—ë–º—ã –ø–∏—â–∏ –≤ –ø–æ–∑–¥–Ω–µ–µ –≤—Ä–µ–º—è (–ø–æ—Å–ª–µ 21:00) –Ω–∞—Ä—É—à–∞—é—Ç —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞. –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–µ—á–µ—Ä–æ–º —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ 20-30%, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Ö—É–¥—à—É—é –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ –±–æ–ª—å—à–∏–π —Ä–∏—Å–∫ –æ—Ç–ª–æ–∂–µ–Ω–∏—è –∂–∏—Ä–∞. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –ø–æ–∑–¥–Ω—è—è –µ–¥–∞ –ø–æ–≤—ã—à–∞–µ—Ç core body temperature, —á—Ç–æ –º–µ—à–∞–µ—Ç –∑–∞—Å—ã–ø–∞–Ω–∏—é –∏ —Å–Ω–∏–∂–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞. –ù–µ–¥–æ—Å—ã–ø —É—Å–∏–ª–∏–≤–∞–µ—Ç –≥–æ–ª–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å (–≥—Ä–µ–ª–∏–Ω ‚Üë, –ª–µ–ø—Ç–∏–Ω ‚Üì), —Å–æ–∑–¥–∞–≤–∞—è –ø–æ—Ä–æ—á–Ω—ã–π –∫—Ä—É–≥. –ú–µ—Ç—Ä–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –∫–∞–ª–æ—Ä–∏–π –ø–æ—Å–ª–µ 21:00 –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫–∏—Ö –ø—Ä–∏—ë–º–æ–≤. –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: <10% –∫–∞–ª–æ—Ä–∏–π –ø–æ—Å–ª–µ 21:00, –ª—É—á—à–µ –≤–æ–æ–±—â–µ –∏–∑–±–µ–≥–∞—Ç—å. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –ª—ë–≥–∫–∏–π –±–µ–ª–∫–æ–≤—ã–π —Å–Ω–µ–∫ (–∫–∞–∑–µ–∏–Ω) –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –¥–ª—è –Ω–æ—á–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à—Ü ‚Äî –¥–æ–ø—É—Å—Ç–∏–º.',
      formula: 'lateKcal = Œ£(kcal for meals after 21:00)\nlateRatio = lateKcal / totalDayKcal √ó 100\nlateMeals = count(meals after 21:00)\n\nScore:\n  if lateRatio < 10% ‚Üí 100\n  else 100 - (lateRatio - 10) √ó 2\n  - lateMeals √ó 5 (penalty per meal)',
      sources: [
        {
          label: 'Band√≠n et al., 2015 ‚Äî Late eating and obesity risk',
          pmid: '25311617'
        },
        {
          label: 'Garaulet & G√≥mez-Abell√°n, 2014 ‚Äî Meal timing and circadian rhythms',
          pmid: '24847856'
        }
      ],
      interpretation: '‚â•85 ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ. 70-84 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è –ø–æ–∑–¥–Ω—è—è –µ–¥–∞. <70 ‚Äî —á–∞—Å—Ç—ã–µ –ø–æ–∑–¥–Ω–∏–µ –ø—Ä–∏—ë–º—ã (—Ä–∏—Å–∫ –¥–ª—è —Å–Ω–∞/–≤–µ—Å–∞).',
      priority: 'MEDIUM',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.68,
      whyImportant: 'üåô –ü–æ–∑–¥–Ω—è—è –µ–¥–∞ = –ø–ª–æ—Ö–æ–π —Å–æ–Ω + —Ç—Ä—É–¥–Ω–µ–µ —Ö—É–¥–µ—Ç—å. –ó–∞–∫—Ä—ã–≤–∞–π –∫—É—Ö–Ω—é –∑–∞ 3—á –¥–æ —Å–Ω–∞!'
    },
    MEAL_QUALITY_TREND: {
      name: '–¢—Ä–µ–Ω–¥ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—ë–º–æ–≤',
      short: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Å—Ä–µ–¥–Ω–µ–≥–æ Meal Quality Score –∑–∞ 7-14 –¥–Ω–µ–π.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç MQS (Meal Quality Score) –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–¥: —É–ª—É—á—à–∞–µ—Ç—Å—è –ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞ –∏–ª–∏ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç. MQS —É—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (–±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫–∞, –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã), –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥ (slope > 0.5 points/week) ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äî —Å–∏–≥–Ω–∞–ª –æ —Å–ø–∞–¥–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏–ª–∏ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö (—Å—Ç—Ä–µ—Å—Å, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ). –í–∞–∂–Ω–æ: —Å–ª—É—á–∞–π–Ω—ã–µ ¬´–ø–ª–æ—Ö–∏–µ –¥–Ω–∏¬ª –Ω–µ —Å—Ç—Ä–∞—à–Ω—ã, –≤–∞–∂–µ–Ω –æ–±—â–∏–π –≤–µ–∫—Ç–æ—Ä. –ú–µ—Ç—Ä–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —à—É–º —á–µ—Ä–µ–∑ 3-–¥–µ–Ω—å moving average.',
      formula: 'mealsQuality[] = [MQS per meal over 7-14 days]\ntrendSlope = linearRegression(mealsQuality, time).slope\n\nScore:\n  avgMQS √ó 0.7 + trendBonus √ó 0.3\n  where trendBonus = min(30, max(-30, slope √ó 10))',
      sources: [
        {
          label: 'Chiuve et al., 2012 ‚Äî Diet quality and mortality',
          pmid: '22535969'
        },
        {
          label: 'Schwingshackl & Hoffmann, 2015 ‚Äî Diet quality indexes',
          pmid: '25318818'
        }
      ],
      interpretation: '‚â•80 ‚Äî –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ + –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–¥. 60-79 ‚Äî —Å—Ä–µ–¥–Ω–µ–µ. <60 ‚Äî –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–¥.',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.65,
      whyImportant: 'üìà –¢—Ä–µ–Ω–¥ –≤–∞–∂–Ω–µ–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π. –†–∞—Å—Ç—É—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ = —É—Å—Ç–æ–π—á–∏–≤—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å!'
    },
    SLEEP_WEIGHT: {
      name: '–°–æ–Ω ‚Üî –í–µ—Å',
      short: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É –∫–∞—á–µ—Å—Ç–≤–æ–º/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —Å–Ω–∞ –∏ –¥–∏–Ω–∞–º–∏–∫–æ–π –≤–µ—Å–∞.',
      details: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å–Ω–∞ (<7—á) –Ω–∞—Ä—É—à–∞–µ—Ç –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: –≥—Ä–µ–ª–∏–Ω (–≥–æ—Ä–º–æ–Ω –≥–æ–ª–æ–¥–∞) –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –Ω–∞ 15%, –ª–µ–ø—Ç–∏–Ω (–≥–æ—Ä–º–æ–Ω —Å—ã—Ç–æ—Å—Ç–∏) —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 15-20%, —á—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≥–æ–ª–æ–¥ ~300 –∫–∫–∞–ª/–¥–µ–Ω—å. –ö–æ—Ä—Ç–∏–∑–æ–ª —Ä–∞—Å—Ç—ë—Ç, —Å–ø–æ—Å–æ–±—Å—Ç–≤—É—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é –≤–∏—Å—Ü–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∂–∏—Ä–∞. –ü–ª—é—Å —Å–Ω–∏–∂–∞–µ—Ç—Å—è willpower –∏ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –≤—ã—à–µ —Ä–∏—Å–∫ —Å—Ä—ã–≤–æ–≤. –ú–µ—Ç—Ä–∏–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é: –µ—Å–ª–∏ –≤ –¥–Ω–∏ —Å <7—á —Å–Ω–∞ –≤–µ—Å —Ä–∞—Å—Ç—ë—Ç/–Ω–µ –ø–∞–¥–∞–µ—Ç, –∞ –≤ –¥–Ω–∏ —Å ‚â•7.5—á ‚Äî —Å–Ω–∏–∂–∞–µ—Ç—Å—è, —ç—Ç–æ —Å–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª. Threshold: |r| > 0.3 —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–Ω–∞—á–∏–º–æ–π —Å–≤—è–∑—å—é. –î–ª—è –∂–µ–Ω—â–∏–Ω —Å–≤—è–∑—å —Å–∏–ª—å–Ω–µ–µ –∏–∑-–∑–∞ –±–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ–ª—É–∫—Ç—É–∞—Ü–∏–π.',
      formula: 'days[] = {sleepHours, weightChange}\ncorrelation = pearson(sleepHours, -weightChange)\n  // negative weight change = weight loss = positive outcome\n\nScore:\n  if |r| > 0.5 ‚Üí 100 (—Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å)\n  if |r| > 0.3 ‚Üí 75 (—É–º–µ—Ä–µ–Ω–Ω–∞—è)\n  if |r| < 0.2 ‚Üí 50 (—Å–ª–∞–±–∞—è/–Ω–µ—Ç)',
      sources: [
        {
          label: 'Taheri et al., 2004 ‚Äî Short sleep and obesity',
          pmid: '15583226'
        },
        {
          label: 'Spiegel et al., 2004 ‚Äî Sleep curtailment and appetite hormones',
          pmid: '15531540'
        }
      ],
      interpretation: '|r| > 0.5 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å (—Å–æ–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ç–≤–æ–µ–≥–æ –≤–µ—Å–∞). 0.3-0.5 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <0.3 ‚Äî —Å–ª–∞–±–∞—è.',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'DAILY',
      impactScore: 0.85,
      whyImportant: 'üò¥ –ù–µ–¥–æ—Å—ã–ø = +300 –∫–∫–∞–ª –≥–æ–ª–æ–¥–∞ –≤ –¥–µ–Ω—å. –í—ã—Å—ã–ø–∞–π—Å—è ‚Äî —ç—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –ø—É—Ç—å –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—É!'
    },
    SLEEP_HUNGER: {
      name: '–°–æ–Ω ‚Üí –ì–æ–ª–æ–¥',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç, –∫–∞–∫ –Ω–µ–¥–æ—Å—ã–ø –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–ø–ø–µ—Ç–∏—Ç –∏ –≤—ã–±–æ—Ä –µ–¥—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞—É–∑–∞–ª—å–Ω—É—é —Å–≤—è–∑—å: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å–Ω–∞ ‚Üí —É—Å–∏–ª–µ–Ω–∏–µ –≥–æ–ª–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å. –ü–æ—Å–ª–µ –Ω–æ—á–∏ —Å <7—á —Å–Ω–∞ –≥—Ä–µ–ª–∏–Ω (–≥–æ—Ä–º–æ–Ω –≥–æ–ª–æ–¥–∞) –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –Ω–∞ 15%, –ª–µ–ø—Ç–∏–Ω (—Å—ã—Ç–æ—Å—Ç—å) —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 15%. –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≥–æ–ª–æ–¥ ~200-400 –∫–∫–∞–ª/–¥–µ–Ω—å + —Ç—è–≥—É –∫ –±—ã—Å—Ç—Ä—ã–º —É–≥–ª–µ–≤–æ–¥–∞–º –∏ –∂–∏—Ä–∞–º (–º–µ—Ö–∞–Ω–∏–∑–º: –º–æ–∑–≥ –∏—â–µ—Ç –±—ã—Å—Ç—Ä—É—é —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —É—Å—Ç–∞–ª–æ—Å—Ç–∏). –ö—Ä–æ–º–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ–¥–∞ —Å—Ç—Ä–∞–¥–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–±–æ—Ä–∞: –≤ –¥–Ω—è—Ö –ø–æ—Å–ª–µ –Ω–µ–¥–æ—Å—ã–ø–∞ –≤—ã—Ä–∞—Å—Ç–∞–µ—Ç –¥–æ–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ NOVA-4 –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ú–µ—Ç—Ä–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é sleepHours[day-1] —Å totalKcal[day], avgGI[day], stressLevel[day]. –õ–∞–≥ 1 –¥–µ–Ω—å ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–µ–¥–æ—Å—ã–ø–∞ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å, –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.',
      formula: 'For each day:\n  prevSleep = day[-1].sleepHours\n  todayKcal = day.tot.kcal\n  todayGI = avg(meal.items[].gi)\n\ncorr1 = pearson(prevSleep, -todayKcal)  // less sleep ‚Üí more kcal\ncorr2 = pearson(prevSleep, -todayGI)    // less sleep ‚Üí higher GI\n\nScore = (corr1 + corr2) / 2 √ó 50 + 50  // normalized 0-100',
      sources: [
        {
          label: 'St-Onge et al., 2016 ‚Äî Sleep duration and food intake',
          pmid: '27568993'
        },
        {
          label: 'Hogenkamp et al., 2013 ‚Äî Sleep restriction and food choice',
          pmid: '23414424'
        }
      ],
      interpretation: '‚â•75 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å (–≤—ã—Å—ã–ø–∞–π—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!). 50-74 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <50 ‚Äî —Å–ª–∞–±–∞—è —Å–≤—è–∑—å (–Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∞–∂–Ω–æ).',
      priority: 'HIGH',
      category: 'RECOVERY',
      actionability: 'TODAY',
      impactScore: 0.80,
      whyImportant: 'üò¥ –ù–µ–¥–æ—Å—ã–ø = –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ–¥ +300 –∫–∫–∞–ª + —Ç—è–≥–∞ –∫ –¥–∂–∞–Ω–∫—É. –°–æ–Ω –≤–º–µ—Å—Ç–æ —Å–∏–ª—ã –≤–æ–ª–∏!'
    },
    TRAINING_KCAL: {
      name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üî –ö–∞–ª–æ—Ä–∏–∏',
      short: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –µ–¥–æ–π: —Å—ä–µ–¥–∞–µ—à—å –ª–∏ —Ç—ã –±–æ–ª—å—à–µ –≤ –¥–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.',
      details: '–§–µ–Ω–æ–º–µ–Ω exercise compensation ‚Äî —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–∞—è –ª–æ–≤—É—à–∫–∞: –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —á–µ–ª–æ–≤–µ–∫ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –∫–∞–ª–æ—Ä–∏–π –∏ –ø–µ—Ä–µ–µ–¥–∞–µ—Ç, –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—è ~75-150% –æ—Ç —Ä–µ–∞–ª—å–Ω–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–≥–æ. –≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç ¬´—Ç—Ä–µ–Ω–∏—Ä—É—é—Å—å, –Ω–æ –Ω–µ —Ö—É–¥–µ—é¬ª. –ú–µ—Ç—Ä–∏–∫–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –≤ –¥–Ω–∏ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ vs –±–µ–∑. –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ > 400 –∫–∫–∞–ª, –∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ¬´—Å—Ç–æ–∏—Ç¬ª ~300-500 –∫–∫–∞–ª ‚Üí compensation > 100% ‚Üí –ø—Ä–æ–≥—Ä–µ—Å—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: –Ω–µ–±–æ–ª—å—à–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π (+10-15%) –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –Ω–æ –Ω–µ ¬´–Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É¬ª. –í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å: –¥–ª—è —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º–æ +200-300 –∫–∫–∞–ª, –¥–ª—è –∫–∞—Ä–¥–∏–æ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (~50-100), —Ç–∞–∫ –∫–∞–∫ —Ü–µ–ª—å –æ–±—ã—á–Ω–æ = –¥–µ—Ñ–∏—Ü–∏—Ç.',
      formula: 'trainingDays[] = days with trainings\nrestDays[] = days without trainings\n\navgKcal_training = mean(trainingDays.kcal)\navgKcal_rest = mean(restDays.kcal)\ndelta = avgKcal_training - avgKcal_rest\n\navgExpenditure = mean(trainingDays.totalExpenditure)\ncompensationRatio = delta / avgExpenditure\n\nScore:\n  if compensationRatio < 0.2 ‚Üí 100 (minimal comp)\n  if 0.2-0.5 ‚Üí 80 (moderate)\n  if 0.5-0.8 ‚Üí 60 (high comp)\n  if >0.8 ‚Üí 40 (full comp, –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å)',
      sources: [
        {
          label: 'King et al., 2012 ‚Äî Exercise and appetite compensation',
          pmid: '22564864'
        },
        {
          label: 'Thomas et al., 2012 ‚Äî Compensatory responses to exercise',
          pmid: '22885926'
        }
      ],
      interpretation: '‚â•80 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (–æ—Ç–ª–∏—á–Ω–æ). 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <60 ‚Äî –≤—ã—Å–æ–∫–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å).',
      priority: 'MEDIUM',
      category: 'ACTIVITY',
      actionability: 'WEEKLY',
      impactScore: 0.70,
      whyImportant: 'üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ = +500 –∫–∫–∞–ª –∫ —É–∂–∏–Ω—É. –ù–µ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–π –≤–µ—Å—å —Ä–∞—Å—Ö–æ–¥ –µ–¥–æ–π!'
    },
    STEPS_WEIGHT: {
      name: '–®–∞–≥–∏ ‚Üî –í–µ—Å',
      short: '–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —à–∞–≥–æ–≤ (NEAT-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) –∏ –¥–∏–Ω–∞–º–∏–∫–æ–π –≤–µ—Å–∞.',
      details: 'NEAT (Non-Exercise Activity Thermogenesis) ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–µ —è–≤–ª—è—é—â–∞—è—Å—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π: —Ö–æ–¥—å–±–∞, —É–±–æ—Ä–∫–∞, –∏–≥—Ä–∞ —Å –¥–µ—Ç—å–º–∏. NEAT –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å 200-600 –∫–∫–∞–ª/–¥–µ–Ω—å —Ä–∞—Å—Ö–æ–¥–∞ —É –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª—é–¥–µ–π (10-15k —à–∞–≥–æ–≤) vs —Å–∏–¥—è—á–∏—Ö (<5k). –≠—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑—å: –±–æ–ª—å—à–µ —à–∞–≥–æ–≤ ‚Üí –±—ã—Å—Ç—Ä–µ–µ —É—Ö–æ–¥–∏—Ç –≤–µ—Å. Correlation r > 0.4 —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–∏–ª—å–Ω–æ–π —Å–≤—è–∑—å—é. –í–∞–∂–Ω—ã–π –∏–Ω—Å–∞–π—Ç: NEAT —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Å–∞, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω–æ–≥–æ –≥–æ–ª–æ–¥–∞ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö –∫–∞—Ä–¥–∏–æ). 10k —à–∞–≥–æ–≤/–¥–µ–Ω—å ‚Äî —Ö–æ—Ä–æ—à–∏–π baseline, 12-15k ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π. –ú–µ–Ω—å—à–µ 7k ‚Äî —Ä–∏—Å–∫ –∑–∞—Å—Ç–æ—è –≤–µ—Å–∞ –¥–∞–∂–µ –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π.',
      formula: 'days[] = {steps, weightChange}\ncorrelation = pearson(steps, -weightChange)\n  // more steps ‚Üí weight loss ‚Üí negative change\n\navgSteps = mean(days.steps)\n\nScore:\n  corr_score = |r| √ó 50\n  volume_score = min(50, avgSteps / 200)  // 10k steps = 50 points\n  total = corr_score + volume_score',
      sources: [
        {
          label: 'Levine, 2004 ‚Äî NEAT and obesity',
          pmid: '14722404'
        },
        {
          label: 'Tudor-Locke et al., 2011 ‚Äî Daily step recommendations',
          pmid: '21471817'
        }
      ],
      interpretation: '‚â•80 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å + –≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <60 ‚Äî —Å–ª–∞–±–∞—è —Å–≤—è–∑—å –∏–ª–∏ –º–∞–ª–æ —à–∞–≥–æ–≤.',
      priority: 'MEDIUM',
      category: 'ACTIVITY',
      actionability: 'DAILY',
      impactScore: 0.72,
      whyImportant: 'üö∂ NEAT = 200-600 –∫–∫–∞–ª —Ä–∞—Å—Ö–æ–¥–∞ –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ë–æ–ª—å—à–µ —à–∞–≥–æ–≤ = –ª–µ–≥—á–µ —Ö—É–¥–µ—Ç—å!'
    },
    PROTEIN_SATIETY: {
      name: '–ë–µ–ª–æ–∫ ‚Üí –°—ã—Ç–æ—Å—Ç—å',
      short: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±–µ–ª–∫–∞ –≤ –ø—Ä–∏—ë–º–µ –ø–∏—â–∏ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å—ã—Ç–æ—Å—Ç—å—é/–≤—Ä–µ–º–µ–Ω–µ–º –¥–æ –≥–æ–ª–æ–¥–∞.',
      details: '–ë–µ–ª–æ–∫ ‚Äî —Å–∞–º—ã–π –Ω–∞—Å—ã—â–∞—é—â–∏–π –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç (TEF 20-30%, vs 5-10% —É–≥–ª–µ–≤–æ–¥—ã, 0-3% –∂–∏—Ä—ã). –í—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤—ã–µ –ø—Ä–∏—ë–º—ã (‚â•25–≥ –±–µ–ª–∫–∞) –¥–∞—é—Ç —Å—ã—Ç–æ—Å—Ç—å –Ω–∞ 3-4—á, –Ω–∏–∑–∫–æ–±–µ–ª–∫–æ–≤—ã–µ (<15–≥) ‚Äî 2-2.5—á. –ú–µ—Ö–∞–Ω–∏–∑–º: –±–µ–ª–æ–∫ —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –ø–µ–ø—Ç–∏–¥–∞ YY –∏ GLP-1 (–≥–æ—Ä–º–æ–Ω—ã —Å—ã—Ç–æ—Å—Ç–∏), –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞. –ú–µ—Ç—Ä–∏–∫–∞ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç timeToNextMeal –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ –∏ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å protein content. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤—ã—Ö –ø—Ä–∏—ë–º–æ–≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª–∏–Ω–Ω–µ–µ ‚Üí –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: 20-30–≥ –±–µ–ª–∫–∞ –Ω–∞ –ø—Ä–∏—ë–º = –æ–ø—Ç–∏–º—É–º –¥–ª—è —Å—ã—Ç–æ—Å—Ç–∏ + —Å–∏–Ω—Ç–µ–∑ –º—ã—à—Ü. –ú–µ–Ω—å—à–µ 15–≥ ‚Äî —Ä–∏—Å–∫ —Ä–∞–Ω–Ω–µ–≥–æ –≥–æ–ª–æ–¥–∞, –±–æ–ª—å—à–µ 40–≥ ‚Äî diminishing returns (–∏–∑–ª–∏—à–∫–∏ –æ–∫–∏—Å–ª—è—é—Ç—Å—è).',
      formula: 'For each meal:\n  proteinGrams = Œ£(items.protein)\n  timeToNextMeal = nextMeal.time - meal.time\n\ncorrelation = pearson(proteinGrams, timeToNextMeal)\n\navgProteinPerMeal = mean(meals.protein)\n\nScore:\n  corr_score = r √ó 50 + 50  // normalized\n  adequacy_score = min(50, avgProteinPerMeal / 0.5)  // 25g = 50 pts\n  total = (corr_score + adequacy_score) / 2',
      sources: [
        {
          label: 'Westerterp-Plantenga et al., 2009 ‚Äî Protein and satiety',
          pmid: '19400750'
        },
        {
          label: 'Leidy et al., 2015 ‚Äî Protein intake and appetite control',
          pmid: '25926512'
        }
      ],
      interpretation: '‚â•80 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å –±–µ–ª–∫–∞ –∏ —Å—ã—Ç–æ—Å—Ç–∏. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <60 ‚Äî —Å–ª–∞–±–∞—è –∏–ª–∏ –º–∞–ª–æ –±–µ–ª–∫–∞.',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'TODAY',
      impactScore: 0.75,
      whyImportant: 'ü•© –ë–µ–ª–æ–∫ = —Å—ã—Ç–æ—Å—Ç—å –Ω–∞ 3-4—á –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–∞–ª–æ—Ä–∏–π. 20-30–≥ –Ω–∞ –ø—Ä–∏—ë–º!'
    },
    FIBER_REGULARITY: {
      name: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üí –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
      short: '–°–≤—è–∑—å –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å—é –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è (–∫–æ–º—Ñ–æ—Ä—Ç, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —ç–Ω–µ—Ä–≥–∏–∏).',
      details: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (fiber) ‚Äî –∫–ª—é—á–µ–≤–æ–π –Ω—É—Ç—Ä–∏–µ–Ω—Ç –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è –∫–∏—à–µ—á–Ω–∏–∫–∞ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞. –ù–æ—Ä–º–∞: 14–≥/1000 –∫–∫–∞–ª (‚âà25-35–≥/–¥–µ–Ω—å). –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ –≥–ª—é–∫–æ–∑—ã (—Å–Ω–∏–∂–∞–µ—Ç GI —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –Ω–∞ 10-20%), –ø–∏—Ç–∞–µ—Ç –º–∏–∫—Ä–æ–±–∏–æ–º (SCFA production ‚Üí –ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç), —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—ä—ë–º –ø–∏—â–∏ ‚Üí —Å—ã—Ç–æ—Å—Ç—å –±–µ–∑ –∫–∞–ª–æ—Ä–∏–π, —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Å—Ç—É–ª. –ú–µ—Ç—Ä–∏–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç adequacy (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –∫–ª–µ—Ç—á–∞—Ç–∫–∏) –∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é —Å wellbeing/digestive comfort (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ). –ù–∏–∑–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (<15–≥/–¥–µ–Ω—å) ‚Üí —Ä–∏—Å–∫ –∑–∞–ø–æ—Ä–æ–≤, dysbiosis, insulin spikes. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: –æ–≤–æ—â–∏, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ, –±–æ–±–æ–≤—ã–µ, —è–≥–æ–¥—ã. –í–∞–∂–Ω–æ: –ø–æ–≤—ã—à–∞—Ç—å –∫–ª–µ—Ç—á–∞—Ç–∫—É –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (+5–≥/–Ω–µ–¥–µ–ª—é), –∏–Ω–∞—á–µ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç.',
      formula: 'For each day:\n  fiberPerDay = Œ£(items.fiber)\n  fiberPer1000kcal = fiber / (totalKcal / 1000)\n\navgFiber = mean(days.fiber)\nadequacy = min(1.0, avgFiber / 25)  // 25g target\n\nif wellbeing data available:\n  corr = pearson(fiber, wellbeing)\n  score = adequacy √ó 70 + (corr √ó 0.5 + 0.5) √ó 30\nelse:\n  score = adequacy √ó 100',
      sources: [
        {
          label: 'Slavin, 2013 ‚Äî Fiber and prebiotics',
          pmid: '23609775'
        },
        {
          label: 'Reynolds et al., 2019 ‚Äî Carbohydrate quality and health',
          pmid: '30638909'
        }
      ],
      interpretation: '‚â•80 ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ (‚â•25–≥/–¥–µ–Ω—å). 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–æ. <60 ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –∫–ª–µ—Ç—á–∞—Ç–∫–∏.',
      priority: 'MEDIUM',
      category: 'NUTRITION',
      actionability: 'WEEKLY',
      impactScore: 0.68,
      whyImportant: 'üåæ –ö–ª–µ—Ç—á–∞—Ç–∫–∞ = —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è + —Å—ã—Ç–æ—Å—Ç—å + –∑–¥–æ—Ä–æ–≤—ã–π –∫–∏—à–µ—á–Ω–∏–∫. –¶–µ–ª—å: 25-35–≥/–¥–µ–Ω—å!'
    },
    STRESS_EATING: {
      name: '–°—Ç—Ä–µ—Å—Å ‚Üí –ü–µ—Ä–µ–µ–¥–∞–Ω–∏–µ',
      short: '–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è –≤ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã–µ –¥–Ω–∏.',
      details: '–°—Ç—Ä–µ—Å—Å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç HPA-–æ—Å—å (hypothalamic-pituitary-adrenal), –ø–æ–≤—ã—à–∞—è –∫–æ—Ä—Ç–∏–∑–æ–ª. –í—ã—Å–æ–∫–∏–π –∫–æ—Ä—Ç–∏–∑–æ–ª —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –∞–ø–ø–µ—Ç–∏—Ç (–æ—Å–æ–±–µ–Ω–Ω–æ —Ç—è–≥—É –∫ —Å–∞—Ö–∞—Ä—É –∏ –∂–∏—Ä–∞–º ‚Äî ¬´comfort food¬ª). –ú–µ—Ö–∞–Ω–∏–∑–º: –±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + –∂–∏—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞—é—Ç —Å—Ç—Ä–µ—Å—Å —á–µ—Ä–µ–∑ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω/–¥–æ—Ñ–∞–º–∏–Ω release, —Å–æ–∑–¥–∞–≤–∞—è reinforcement loop. –ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç: –≤ –¥–Ω–∏ —Å –≤—ã—Å–æ–∫–∏–º —Å—Ç—Ä–µ—Å—Å–æ–º (stress ‚â•7/10) –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –≤—ã—à–µ? GI –≤—ã—à–µ? –î–æ–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤—ã—à–µ? –ï—Å–ª–∏ –¥–∞ ‚Üí –ø–∞—Ç—Ç–µ—Ä–Ω stress eating –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è r > 0.4 = –∑–Ω–∞—á–∏–º–∞—è —Å–≤—è–∑—å. –í–∞–∂–Ω–æ: —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ ‚Äî –Ω–µ ¬´—Å–ª–∞–±–æ—Å—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞¬ª, –∞ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å—Ç—Ä–µ—Å—Å. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –ø—Ä–æ–≥—É–ª–∫–∞, –º–µ–¥–∏—Ç–∞—Ü–∏—è, –±–µ–ª–∫–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å –≤–º–µ—Å—Ç–æ —Å–∞—Ö–∞—Ä–∞.',
      formula: 'stressDays[] = days where stress ‚â• 7\nlowStressDays[] = days where stress ‚â§ 4\n\navgKcal_stress = mean(stressDays.kcal)\navgKcal_low = mean(lowStressDays.kcal)\ndelta = avgKcal_stress - avgKcal_low\n\navgSimple_stress = mean(stressDays.simple100_pct)\navgSimple_low = mean(lowStressDays.simple100_pct)\n\nScore:\n  if delta < 200 && simple_delta < 10% ‚Üí 100\n  else 100 - (delta / 10) - (simple_delta √ó 2)',
      sources: [
        {
          label: 'Tomiyama et al., 2011 ‚Äî Stress and eating behavior',
          pmid: '21676152'
        },
        {
          label: 'Dallman, 2010 ‚Äî Stress-induced obesity',
          pmid: '20357041'
        }
      ],
      interpretation: '‚â•80 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å —Å—Ç—Ä–µ—Å—Å–∞ –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è. 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <60 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å (–Ω—É–∂–Ω—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã).',
      priority: 'MEDIUM',
      category: 'PSYCHOLOGY',
      actionability: 'WEEKLY',
      impactScore: 0.72,
      whyImportant: 'üò∞ –°—Ç—Ä–µ—Å—Å = –∫–æ—Ä—Ç–∏–∑–æ–ª = +300 –∫–∫–∞–ª –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –µ–¥—ã. –ù–∞–π–¥–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∑–∞–µ–¥–∞–Ω–∏—é!'
    },
    MOOD_FOOD: {
      name: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Üî –ï–¥–∞',
      short: '–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å: –∫–∞–∫ –µ–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä –µ–¥—ã.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç bidirectional relationship. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É—Ç—Ä–æ–º ‚Üí –≤—ã–±–æ—Ä –º–µ–Ω–µ–µ –∑–¥–æ—Ä–æ–≤–æ–π –µ–¥—ã (‚ÜëGI, ‚Üë–ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã, ‚Üì–±–µ–ª–æ–∫) = —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –∫–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã ‚Üí –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2-4—á. –í—ã—Å–æ–∫–∏–π GI/–º–∞–ª–æ –±–µ–ª–∫–∞ ‚Üí sugar crash ‚Üí –ø–∞–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è. –ù–∏–∑–∫–∏–π GI + –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–ª–∫–∞ ‚Üí stable energy ‚Üí stable mood. –ú–µ—Ö–∞–Ω–∏–∑–º: stable glucose ‚Üí stable neurotransmitters (—Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω, –¥–æ—Ñ–∞–º–∏–Ω). –ú–µ—Ç—Ä–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç –¥–≤–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏: mood[morning] ‚Üî mealQuality[day], mealQuality[meal] ‚Üî mood[2h later]. –ï—Å–ª–∏ –æ–±–µ –∑–Ω–∞—á–∏–º—ã ‚Üí bidirectional pattern –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏: –Ω–∞—á–∏–Ω–∞–π –¥–µ–Ω—å —Å –±–µ–ª–∫–æ–≤–æ–≥–æ –∑–∞–≤—Ç—Ä–∞–∫–∞ ‚Üí —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Üí –ª—É—á—à–µ –≤—ã–±–æ—Ä –µ–¥—ã –≤–µ—Å—å –¥–µ–Ω—å.',
      formula: 'For each day:\n  corr1 = pearson(mood_morning, avgMealQuality_day)\n  corr2 = pearson(mealGI, mood_afternoon)\n\navgMoodStability = stddev(mood across hours)\n\nScore:\n  pattern_strength = (|corr1| + |corr2|) / 2 √ó 50\n  stability_score = (1 - avgMoodStability / 3) √ó 50\n  total = pattern_strength + stability_score',
      sources: [
        {
          label: 'Macht, 2008 ‚Äî How emotions affect eating',
          pmid: '18457711'
        },
        {
          label: 'Penckofer et al., 2017 ‚Äî Diet and mood',
          pmid: '28179633'
        }
      ],
      interpretation: '‚â•75 ‚Äî —Å–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å –µ–¥—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (—Ä–∞–±–æ—Ç–∞–π –Ω–∞–¥ –∫–∞—á–µ—Å—Ç–≤–æ–º!). 50-74 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <50 ‚Äî —Å–ª–∞–±–∞—è.',
      priority: 'MEDIUM',
      category: 'PSYCHOLOGY',
      actionability: 'DAILY',
      impactScore: 0.70,
      whyImportant: 'üòä –ï–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî –Ω–∞ –≤—ã–±–æ—Ä –µ–¥—ã. –†–∞–∑–æ—Ä–≤–∏ —Ü–∏–∫–ª!'
    },
    HYPERTROPHY: {
      name: '–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è',
      short: '–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–ª–∞: –º—ã—à–µ—á–Ω–∞—è –º–∞—Å—Å–∞ vs –∂–∏—Ä —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏–∫—É –≤–µ—Å–∞ –∏ –æ–±—Ö–≤–∞—Ç–æ–≤.',
      details: '–ú–µ—Ç—Ä–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –≤–µ—Å (profile.weight) –∏ –æ–±—Ö–≤–∞—Ç—ã (measurements: biceps, thigh, waist). –¢—Ä–µ–Ω–¥—ã –æ–±—Ö–≤–∞—Ç–æ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é –∑–∞ 14-30 –¥–Ω–µ–π. –°—Ü–µ–Ω–∞—Ä–∏–∏: (1) Muscle gain ‚Äî –≤–µ—Å ‚Üë + –æ–±—Ö–≤–∞—Ç—ã –±–∏—Ü–µ–ø—Å/–±–µ–¥—Ä–æ ‚Üë + —Ç–∞–ª–∏—è = –∏–ª–∏ ‚Üì (–∏–¥–µ–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä). (2) Fat gain ‚Äî –≤–µ—Å ‚Üë + –æ–±—Ö–≤–∞—Ç—ã –º—ã—à—Ü = + —Ç–∞–ª–∏—è ‚Üë (–ø–ª–æ—Ö–æ–π –Ω–∞–±–æ—Ä). (3) Fat loss ‚Äî –≤–µ—Å ‚Üì + –æ–±—Ö–≤–∞—Ç—ã –º—ã—à—Ü = (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) + —Ç–∞–ª–∏—è ‚Üì (–¥–µ—Ñ–∏—Ü–∏—Ç —Å –∑–∞—â–∏—Ç–æ–π –º—ã—à—Ü). (4) Muscle loss ‚Äî –≤–µ—Å ‚Üì + –æ–±—Ö–≤–∞—Ç—ã –º—ã—à—Ü ‚Üì (—Å–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏–ª–∏ –º–∞–ª–æ –±–µ–ª–∫–∞). –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: protein ‚â•1.6 g/kg/day + —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ 3+ —Ä–∞–∑/–Ω–µ–¥–µ–ª—é. Score —É—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤ + –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –±–µ–ª–∫–∞.',
      formula: 'trends = linearRegression(days.measurements, days.weight)\n\nscenario detection:\n  if weight‚Üë && biceps‚Üë && thigh‚Üë && waist‚â§ ‚Üí muscle_gain\n  if weight‚Üë && biceps= && waist‚Üë ‚Üí fat_gain\n  if weight‚Üì && biceps= && waist‚Üì ‚Üí fat_loss (good)\n  if weight‚Üì && biceps‚Üì ‚Üí muscle_loss (bad)\n\nprotAdequacy = avgProtein / (weight √ó 1.6)\n\nScore:\n  scenario_score (60): muscle_gain=100, fat_loss=90, fat_gain=40, muscle_loss=30\n  protein_score (40): protAdequacy √ó 100',
      sources: [
        {
          label: 'Schoenfeld et al., 2017 ‚Äî Resistance training and hypertrophy',
          pmid: '28834797'
        },
        {
          label: 'Morton et al., 2018 ‚Äî Protein and muscle mass',
          pmid: '29497353'
        }
      ],
      interpretation: '‚â•80 ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è (–º—ã—à—Ü—ã —Ä–∞—Å—Ç—É—Ç –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è). 60-79 ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è. <60 ‚Äî –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞.',
      priority: 'MEDIUM',
      category: 'METABOLISM',
      actionability: 'LONG_TERM',
      impactScore: 0.78,
      whyImportant: 'üí™ –ö–æ–º–ø–æ–∑–∏—Ü–∏—è –≤–∞–∂–Ω–µ–µ –≤–µ—Å–∞. –¶–µ–ª—å: –º—ã—à—Ü—ã —Ä–∞—Å—Ç—É—Ç, –∂–∏—Ä —É—Ö–æ–¥–∏—Ç!'
    },

    // === –£–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ ‚Äî Sprint 9 science engine (v4.0.6) ===
    SMART_PLANNER: {
      name: '–£–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ ‚Äî –Ω–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ v4',
      short: '–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å—Ç—Ä–æ–∏—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ 9 –Ω–∞—É—á–Ω—ã—Ö —Å–ø—Ä–∏–Ω—Ç–æ–≤ (S0‚ÄìS8): —Ö—Ä–æ–Ω–æ-–ø–∏—Ç–∞–Ω–∏–µ, –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø, —Å–∏–Ω—Ç–µ–∑ –±–µ–ª–∫–∞ (MPS), –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (GL), –∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞, –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –∏ first-meal logic.',
      details: '–°–∏—Å—Ç–µ–º–∞ v4.0.6 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 9-—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä (S0‚ÄìS8). S0: First-Meal Logic –ø—Ä–∏ 0 –∫–∫–∞–ª –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –¥–µ–Ω—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞. S1: –•—Ä–æ–Ω–æ-–ø–∏—Ç–∞–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–ª–æ—Ä–∏–∏ –ø–æ —Ü–∏—Ä–∫–∞–¥–Ω—ã–º —Ä–∏—Ç–º–∞–º (–±–æ–ª—å—à–µ –¥–Ω–µ–º, –º–µ–Ω—å—à–µ –≤–µ—á–µ—Ä–æ–º). S2: MPS Boost –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç 0.4 –≥/–∫–≥ –±–µ–ª–∫–∞ –Ω–∞ –ø—Ä–∏—ë–º –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à—Ü. S3: GL Targets –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É –≤–µ—á–µ—Ä–æ–º (GL<10). S4: –ê–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (+60% —É–≥–ª–µ–≤–æ–¥–æ–≤). S5: Sleep-Friendly –ø–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∫–∞–∑–µ–∏–Ω/—Ç—Ä–∏–ø—Ç–æ—Ñ–∞–Ω) –∑–∞ 3—á –¥–æ —Å–Ω–∞. S6: –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–æ–ª–Ω–∞ (–∏—Å—Ç–æ—Ä–∏—è 14 –¥–Ω–µ–π). S7: –§–µ–Ω–æ—Ç–∏–ø–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –º–∞–∫—Ä–æ—Å–æ–≤. S8: Volume-Scaled Wave ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—ã—Ç–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—ä—ë–º–∞ –ø–æ—Ä—Ü–∏–∏ (–∫–∫–∞–ª).',
      formula: 'S0 First-Meal: if kcal=0 ‚Üí force BALANCED scenario\n\nS1 Chrono: ratio = MORNING 0.33 / LUNCH 0.38 / SNACK 0.20 / EVENING 0.28\n\nS2 MPS: protein = min(40, weight √ó 0.4) g per meal\n\nS3 GL: targetGL = sleep<3h ? 10 : 20\n\nS4 Post-Workout: carb ratio ‚Üí 60%, budget +300kcal\n\nS6 Adaptive Wave: median(gap 2‚Äì6h from 14 days)\n\nS8 Scaled Wave: time = personalWave √ó ‚àö(mealKcal / totalBudget)',
      sources: [
        { label: 'Garaulet & G√≥mez-Abell√°n, 2014 ‚Äî Timing of food intake', pmid: '23877420', level: 'A' },
        { label: 'Areta et al., 2013 ‚Äî Protein ingestion & MPS', pmid: '23459753', level: 'A' },
        { label: 'Ludwig, 2002 ‚Äî The glycemic index', pmid: '12002800', level: 'A' },
        { label: 'Ivy, 2004 ‚Äî Glycogen repletion after exercise', pmid: '15212750', level: 'B' },
        { label: 'Halson, 2014 ‚Äî Sleep and nutritional interventions', pmid: '24435400', level: 'B' },
        { label: 'Louis-Sylvestre & Le Magnen, 1980 ‚Äî Volume-scaled satiety', pmid: '7413695', level: 'B' }
      ],
      evidenceLevel: 'A',
      confidenceScore: 0.92,
      interpretation: '–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—à–∏ —Ü–µ–ª–∏, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —Ä–µ–∂–∏–º —Å–Ω–∞. –ü—Ä–∏ 0 –∫–∫–∞–ª (—É—Ç—Ä–æ) –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–µ–∂–∏–º –ø–æ–ª–Ω–æ–≥–æ –¥–Ω—è (S0).',
      priority: 'HIGH',
      category: 'TIMING',
      actionability: 'TODAY',
      impactScore: 0.89,
      whyImportant: 'üß† 9 –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –Ω–∞—É–∫–∏ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–∏—ë–º–µ. –•—Ä–æ–Ω–æ ¬∑ MPS ¬∑ GL ¬∑ –ê–Ω–∞–±.–æ–∫–Ω–æ ¬∑ –°–æ–Ω ¬∑ –§–µ–Ω–æ—Ç–∏–ø ¬∑ –õ–∏—á–Ω—ã–π —Ä–∏—Ç–º.'
    }
  };

  // === –ü–ê–¢–¢–ï–†–ù–´ ===
  const PATTERNS = {
    // –ï–¥–∞ + –≤–æ–ª–Ω—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    MEAL_TIMING: 'meal_timing',
    WAVE_OVERLAP: 'wave_overlap',
    LATE_EATING: 'late_eating',
    MEAL_QUALITY_TREND: 'meal_quality',

    // –°–æ–Ω + –≤–µ—Å
    SLEEP_WEIGHT: 'sleep_weight',
    SLEEP_HUNGER: 'sleep_hunger',

    // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    TRAINING_KCAL: 'training_kcal',
    STEPS_WEIGHT: 'steps_weight',

    // –ú–∞–∫—Ä–æ—Å—ã
    PROTEIN_SATIETY: 'protein_satiety',
    FIBER_REGULARITY: 'fiber_regularity',

    // –≠–º–æ—Ü–∏–∏
    STRESS_EATING: 'stress_eating',
    MOOD_FOOD: 'mood_food',

    // NEW v2.0
    CIRCADIAN: 'circadian',
    NUTRIENT_TIMING: 'nutrient_timing',
    INSULIN_SENSITIVITY: 'insulin_sensitivity',
    GUT_HEALTH: 'gut_health',

    // NEW v4.0 (B1-B6)
    SLEEP_QUALITY: 'sleep_quality',         // B1: –≤–ª–∏—è–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–Ω–∞ –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
    WELLBEING_CORRELATION: 'wellbeing_correlation', // B2: —Å–≤—è–∑—å —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è —Å –ø–∏—Ç–∞–Ω–∏–µ–º/—Å–Ω–æ–º
    HYDRATION: 'hydration',                 // B3: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏
    BODY_COMPOSITION: 'body_composition',   // B4: –¥–∏–Ω–∞–º–∏–∫–∞ –æ–±—Ö–≤–∞—Ç–æ–≤ —Ç–∞–ª–∏—è/–±—ë–¥—Ä–∞
    CYCLE_IMPACT: 'cycle_impact',           // B5: –≤–ª–∏—è–Ω–∏–µ —Ü–∏–∫–ª–∞ (—Ñ–∞–∑) –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏
    WEEKEND_EFFECT: 'weekend_effect',       // B6: –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ç-–≤—Å vs –ø–Ω-—á—Ç
    NUTRITION_QUALITY: 'nutrition_quality', // C2: –∫–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è
    NEAT_ACTIVITY: 'neat_activity',         // C4: –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    MOOD_TRAJECTORY: 'mood_trajectory',     // C6: —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è

    // NEW v5.0 (C7-C12)
    MICRONUTRIENT_RADAR: 'micronutrient_radar', // C7: –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã
    OMEGA_BALANCER: 'omega_balancer',           // C8: –æ–º–µ–≥–∞-–±–∞–ª–∞–Ω—Å
    HEART_HEALTH: 'heart_health',               // C9: —Å–µ—Ä–¥—Ü–µ/–º–µ—Ç–∞–±–æ–ª–∏–∑–º
    NOVA_QUALITY: 'nova_quality',               // C10: –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ NOVA
    TRAINING_RECOVERY: 'training_recovery',     // C11: –Ω–∞–≥—Ä—É–∑–∫–∞/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    HYPERTROPHY: 'hypertrophy',                 // C12: –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è/–∫–æ–º–ø–æ–∑–∏—Ü–∏—è

    // NEW v6.0 (C13-C22) ‚Äî Phase 1-4 implementation
    VITAMIN_DEFENSE: 'vitamin_defense',         // C13: —Ä–∞–¥–∞—Ä 11 –≤–∏—Ç–∞–º–∏–Ω–æ–≤ (Phase 1, 12.02.2026)
    B_COMPLEX_ANEMIA: 'b_complex_anemia',       // C22: B-–∫–æ–º–ø–ª–µ–∫—Å + —Ä–∏—Å–∫ –∞–Ω–µ–º–∏–∏ (Phase 1, 12.02.2026)
    GLYCEMIC_LOAD: 'glycemic_load',             // C14: –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (Phase 2, 12.02.2026)
    PROTEIN_DISTRIBUTION: 'protein_distribution', // C15: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ (Phase 2, 12.02.2026)
    ANTIOXIDANT_DEFENSE: 'antioxidant_defense',   // C16: –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞ (Phase 3, 12.02.2026)
    ADDED_SUGAR_DEPENDENCY: 'added_sugar_dependency', // C18: –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä + –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (Phase 3, 12.02.2026)
    BONE_HEALTH: 'bone_health',                   // C17: –∑–¥–æ—Ä–æ–≤—å–µ –∫–æ—Å—Ç–µ–π (Phase 4, 12.02.2026)
    TRAINING_TYPE_MATCH: 'training_type_match',  // C19: –ø–∏—Ç–∞–Ω–∏–µ –ø–æ–¥ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (Phase 4, 12.02.2026)
    ELECTROLYTE_HOMEOSTASIS: 'electrolyte_homeostasis', // C20: —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å (Phase 5, 12.02.2026)
    NUTRIENT_DENSITY: 'nutrient_density'         // C21: –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (Phase 5, 12.02.2026)
  };

  // === UNIT REGISTRY (Phase 0, 12.02.2026) ===
  // Canonical units for all minerals/vitamins ‚Äî prevents mg/mcg confusion in C13+C22 patterns
  // Source: docs/DATA_MODEL_REFERENCE.md:315-340, USDA FoodData Central canonical units
  const UNIT_REGISTRY = {
    // Minerals (8 fields)
    calcium: { unit: 'mg', dri: 1000, label: '–ö–∞–ª—å—Ü–∏–π' },
    iron: { unit: 'mg', dri: 18, label: '–ñ–µ–ª–µ–∑–æ' },
    magnesium: { unit: 'mg', dri: 400, label: '–ú–∞–≥–Ω–∏–π' },
    phosphorus: { unit: 'mg', dri: 700, label: '–§–æ—Å—Ñ–æ—Ä' },
    potassium: { unit: 'mg', dri: 3500, label: '–ö–∞–ª–∏–π' },
    zinc: { unit: 'mg', dri: 11, label: '–¶–∏–Ω–∫' },
    selenium: { unit: 'mcg', dri: 55, label: '–°–µ–ª–µ–Ω' },
    iodine: { unit: 'mcg', dri: 150, label: '–ô–æ–¥' },

    // Vitamins (11 fields) ‚Äî already used in v5.0 C07 Micronutrient Radar, repeated for completeness
    vitamin_a: { unit: 'mcg', dri: 900, label: '–í–∏—Ç–∞–º–∏–Ω A' },
    vitamin_c: { unit: 'mg', dri: 90, label: '–í–∏—Ç–∞–º–∏–Ω C' },
    vitamin_d: { unit: 'mcg', dri: 20, label: '–í–∏—Ç–∞–º–∏–Ω D' },
    vitamin_e: { unit: 'mg', dri: 15, label: '–í–∏—Ç–∞–º–∏–Ω E' },
    vitamin_k: { unit: 'mcg', dri: 120, label: '–í–∏—Ç–∞–º–∏–Ω K' },
    vitamin_b1: { unit: 'mg', dri: 1.2, label: '–¢–∏–∞–º–∏–Ω' },
    vitamin_b2: { unit: 'mg', dri: 1.3, label: '–†–∏–±–æ—Ñ–ª–∞–≤–∏–Ω' },
    vitamin_b3: { unit: 'mg', dri: 16, label: '–ù–∏–∞—Ü–∏–Ω' },
    vitamin_b6: { unit: 'mg', dri: 1.7, label: '–ü–∏—Ä–∏–¥–æ–∫—Å–∏–Ω' },
    vitamin_b9: { unit: 'mcg', dri: 400, label: '–§–æ–ª–∞—Ç' },
    vitamin_b12: { unit: 'mcg', dri: 2.4, label: '–ö–æ–±–∞–ª–∞–º–∏–Ω' }
  };

  // Helper: normalize mineral value to canonical unit (mg ‚Üí mg, mcg ‚Üí mcg)
  // Usage: UNIT_REGISTRY[field]?.unit === 'mcg' ? valMcg : valMg
  const normalizeToUnit = (fieldName, value) => {
    const def = UNIT_REGISTRY[fieldName];
    if (!def || value == null) return null;
    return typeof value === 'number' ? value : parseFloat(value) || null;
  };

  HEYS.InsightsPI.constants = {
    CONFIG,
    PRIORITY_LEVELS,
    CATEGORIES,
    ACTIONABILITY,
    SECTIONS_CONFIG,
    getSortedSections,
    getSectionPriority,
    computeDynamicPriority,      // NEW: Dynamic priority resolver
    PRIORITY_CONTEXT_LABELS,     // NEW: Context-specific badge labels
    getMetricPriority,
    getAllMetricsByPriority,
    getMetricsByCategory,
    getMetricsByActionability,
    getCriticalMetrics,
    getPriorityStats,
    SCIENCE_INFO,
    PATTERNS,
    UNIT_REGISTRY,       // NEW: Phase 0
    normalizeToUnit      // NEW: Phase 0
  };

  // –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
  window.piConst = HEYS.InsightsPI.constants;
})();


/* ===== insights/pi_stats.js ===== */
// pi_stats.js ‚Äî Statistical Helper Functions v3.0.0
// Extracted from heys_predictive_insights_v1.js (Phase 1)
// –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = HEYS.dev || global.HEYS?.dev || {};
  const devLog = DEV.log ? DEV.log.bind(DEV) : () => { };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª
   * @returns {number} —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   */
  function average(arr) {
    if (!arr || arr.length === 0) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª
   * @returns {number} —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
   */
  function stdDev(arr) {
    if (!arr || arr.length < 2) return 0;
    const avg = average(arr);
    const squareDiffs = arr.map(v => Math.pow(v - avg, 2));
    return Math.sqrt(average(squareDiffs));
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –ü–∏—Ä—Å–æ–Ω–∞
   * @param {Array<number>} x - –ø–µ—Ä–≤—ã–π –º–∞—Å—Å–∏–≤
   * @param {Array<number>} y - –≤—Ç–æ—Ä–æ–π –º–∞—Å—Å–∏–≤
   * @returns {number} –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è [-1, 1]
   */
  function pearsonCorrelation(x, y) {
    if (x.length !== y.length || x.length < 3) return 0;

    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
    const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);
    const sumY2 = y.reduce((acc, yi) => acc + yi * yi, 0);

    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

    if (denominator === 0) return 0;
    const correlation = numerator / denominator;
    return isNaN(correlation) ? 0 : correlation;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥ (slope) –ø–æ –º–∞—Å—Å–∏–≤—É –∑–Ω–∞—á–µ–Ω–∏–π
   * @param {Array<number>} values - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @returns {number} –Ω–∞–∫–ª–æ–Ω (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = —Ä–æ—Å—Ç)
   */
  function calculateTrend(values) {
    if (values.length < 2) return 0;

    const n = values.length;
    const x = values.map((_, i) => i);
    const y = values;

    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
    const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    return isNaN(slope) ? 0 : slope;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é –ø–æ —Ç–æ—á–∫–∞–º (x, y)
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –¥–∞—Ç–∞–º
   * @param {Array<{x: number, y: number}>} points
   * @returns {number} –Ω–∞–∫–ª–æ–Ω (slope)
   */
  function calculateLinearRegression(points) {
    if (points.length < 2) return 0;

    const n = points.length;
    const sumX = points.reduce((a, p) => a + p.x, 0);
    const sumY = points.reduce((a, p) => a + p.y, 0);
    const sumXY = points.reduce((a, p) => a + p.x * p.y, 0);
    const sumX2 = points.reduce((a, p) => a + p.x * p.x, 0);

    const denominator = (n * sumX2 - sumX * sumX);
    if (denominator === 0) return 0;

    const slope = (n * sumXY - sumX * sumY) / denominator;
    return isNaN(slope) ? 0 : slope;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å R¬≤ (coefficient of determination)
   * @param {Array<number>} actual - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
   * @param {Array<number>} predicted - –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   * @returns {number} R¬≤ –æ—Ç 0 –¥–æ 1
   */
  function calculateR2(actual, predicted) {
    if (actual.length !== predicted.length || actual.length < 2) return 0;

    const meanActual = average(actual);
    const ssRes = actual.reduce((sum, a, i) => sum + Math.pow(a - predicted[i], 2), 0);
    const ssTot = actual.reduce((sum, a) => sum + Math.pow(a - meanActual, 2), 0);

    return ssTot > 0 ? 1 - (ssRes / ssTot) : 0;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–∏—Å–ø–µ—Ä—Å–∏—é (variance)
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª
   * @returns {number} –¥–∏—Å–ø–µ—Ä—Å–∏—è
   */
  function variance(arr) {
    if (arr.length < 2) return 0;
    const mean = average(arr);
    return average(arr.map(x => Math.pow(x - mean, 2)));
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é (lag-k)
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @param {number} lag - –ª–∞–≥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
   * @returns {number} –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è
   */
  function autocorrelation(arr, lag = 1) {
    if (arr.length <= lag) return 0;

    const mean = average(arr);
    const n = arr.length;

    let numerator = 0;
    let denominator = 0;

    for (let i = 0; i < n - lag; i++) {
      numerator += (arr[i] - mean) * (arr[i + lag] - mean);
    }

    for (let i = 0; i < n; i++) {
      denominator += Math.pow(arr[i] - mean, 2);
    }

    return denominator > 0 ? numerator / denominator : 0;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∞—Å–∏–º–º–µ—Ç—Ä–∏—é (skewness)
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @returns {number} –∞—Å–∏–º–º–µ—Ç—Ä–∏—è
   */
  function skewness(arr) {
    if (arr.length < 3) return 0;

    const mean = average(arr);
    const std = stdDev(arr);
    if (std === 0) return 0;

    const n = arr.length;
    const m3 = arr.reduce((sum, x) => sum + Math.pow((x - mean) / std, 3), 0) / n;

    return m3;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥ (slope) - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @returns {number} –Ω–∞–∫–ª–æ–Ω
   */
  function linearTrend(arr) {
    if (arr.length < 2) return 0;

    const n = arr.length;
    const xMean = (n - 1) / 2;
    const yMean = average(arr);

    let numerator = 0;
    let denominator = 0;

    for (let i = 0; i < n; i++) {
      numerator += (i - xMean) * (arr[i] - yMean);
      denominator += Math.pow(i - xMean, 2);
    }

    return denominator > 0 ? numerator / denominator : 0;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @param {number} p - –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å (0-100)
   * @returns {number} –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—è
   */
  function calculatePercentile(arr, p) {
    if (!arr || arr.length === 0) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const index = (p / 100) * (sorted.length - 1);
    const lower = Math.floor(index);
    const upper = Math.ceil(index);
    const weight = index - lower;

    if (lower === upper) return sorted[lower];
    return sorted[lower] * (1 - weight) + sorted[upper] * weight;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @param {number} window - —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
   * @returns {Array<number>} –º–∞—Å—Å–∏–≤ —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ä–µ–¥–Ω–∏—Ö
   */
  function calculateMovingAverage(arr, window = 3) {
    if (!arr || arr.length < window) return arr;
    const result = [];
    for (let i = 0; i <= arr.length - window; i++) {
      const slice = arr.slice(i, i + window);
      result.push(average(slice));
    }
    return result;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (EMA)
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ —Å –±–æ–ª—å—à–∏–º –≤–µ—Å–æ–º –Ω–∞ –Ω–µ–¥–∞–≤–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @param {number} span - –ø–µ—Ä–∏–æ–¥ EMA (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7)
   * @returns {Array<number>} –º–∞—Å—Å–∏–≤ EMA –∑–Ω–∞—á–µ–Ω–∏–π
   */
  function exponentialMovingAverage(arr, span = 7) {
    if (!arr || arr.length === 0) return [];
    const alpha = 2 / (span + 1);
    const result = [arr[0]];
    for (let i = 1; i < arr.length; i++) {
      result.push(alpha * arr[i] + (1 - alpha) * result[i - 1]);
    }
    return result;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
   * @param {number} confidence - —É—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è (0-1), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.95
   * @returns {Object} {mean, lower, upper, margin}
   */
  function calculateConfidenceInterval(arr, confidence = 0.95) {
    if (!arr || arr.length < 2) {
      const mean = average(arr);
      return { mean, lower: mean, upper: mean, margin: 0 };
    }

    const mean = average(arr);
    const std = stdDev(arr);
    const n = arr.length;

    // z-score –¥–ª—è 95% confidence ‚âà 1.96, –¥–ª—è 99% ‚âà 2.576
    const zScore = confidence === 0.99 ? 2.576 : 1.96;
    const margin = zScore * (std / Math.sqrt(n));

    return {
      mean,
      lower: mean - margin,
      upper: mean + margin,
      margin
    };
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0, 1]
   * @param {number} value - –∑–Ω–∞—á–µ–Ω–∏–µ
   * @param {number} min - –º–∏–Ω–∏–º—É–º
   * @param {number} max - –º–∞–∫—Å–∏–º—É–º
   * @returns {number} –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   */
  function normalizeValue(value, min, max) {
    if (max === min) return 0;
    return (value - min) / (max - min);
  }

  /**
   * –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
   * @param {number} value - –∑–Ω–∞—á–µ–Ω–∏–µ
   * @param {number} min - –º–∏–Ω–∏–º—É–º
   * @param {number} max - –º–∞–∫—Å–∏–º—É–º
   * @returns {number} –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   */
  function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
  }

  // === STATISTICS SAFETY HELPERS (Phase 0, 12.02.2026) ===
  // Prevent false positives from small samples in C13-C22 patterns
  // Example: if (checkMinN(validDays, 3)) { ... compute confidence ... }

  /**
   * Check minimum sample size gate (minN)
   * @param {Array} arr - sample array
   * @param {number} minN - minimum required count (default: 3)
   * @returns {boolean} true if arr.length >= minN
   */
  function checkMinN(arr, minN = 3) {
    return arr && arr.length >= minN;
  }

  /**
   * Apply confidence penalty for small samples
   * @param {number} baseConfidence - raw confidence score [0-1]
   * @param {number} n - sample size
   * @param {number} minN - minimum recommended count (default: 7)
   * @returns {number} adjusted confidence [0-1]
   * @example applySmallSamplePenalty(0.8, 5, 7) ‚Üí 0.8 √ó (5/7) = 0.57
   */
  function applySmallSamplePenalty(baseConfidence, n, minN = 7) {
    if (n >= minN) return baseConfidence;
    if (n <= 0) return 0;
    return baseConfidence * (n / minN); // linear penalty
  }

  /**
   * Calculate statistical power estimate (rough heuristic)
   * @param {number} n - sample size
   * @param {number} effectSize - Cohen's d or correlation magnitude [0-1]
   * @returns {number} power estimate [0-1]
   * @example statisticalPower(10, 0.5) ‚Üí 0.68 (medium effect, small sample)
   */
  function statisticalPower(n, effectSize) {
    if (n < 3 || effectSize <= 0) return 0;
    // Rough approximation: power ‚âà 1 - exp(-n √ó effectSize¬≤ / 4)
    // For large n + large effect ‚Üí power ‚âà 1.0
    // For small n + small effect ‚Üí power ‚âà 0.2
    const scaledEffect = Math.pow(effectSize, 2);
    return Math.min(1, 1 - Math.exp(-(n * scaledEffect) / 4));
  }

  /**
   * Flag low-confidence results with warning
   * @param {number} confidence - raw confidence score [0-1]
   * @param {number} n - sample size
   * @param {number} threshold - warning threshold (default: 0.5)
   * @returns {Object} { confidence: adjusted, warning: '‚ö†Ô∏è N=5 (min 7)' | null }
   */
  function confidenceWithWarning(confidence, n, threshold = 0.5) {
    const adjusted = applySmallSamplePenalty(confidence, n, 7);
    const warning = adjusted < threshold ? `‚ö†Ô∏è N=${n} (min 7)` : null;
    return { confidence: adjusted, warning };
  }

  /**
   * Calculate Cohen's d effect size for two samples
   * Measures the standardized difference between two means
   * @param {Array<number>} group1 - –ø–µ—Ä–≤–∞—è –≤—ã–±–æ—Ä–∫–∞
   * @param {Array<number>} group2 - –≤—Ç–æ—Ä–∞—è –≤—ã–±–æ—Ä–∫–∞
   * @returns {Object} { d, interpretation }
   * Effect size interpretation:
   * - Small: |d| < 0.5
   * - Medium: 0.5 ‚â§ |d| < 0.8
   * - Large: |d| ‚â• 0.8
   */
  function cohenD(group1, group2) {
    if (!group1 || !group2 || group1.length < 2 || group2.length < 2) {
      return { d: 0, interpretation: 'insufficient_data' };
    }

    const mean1 = average(group1);
    const mean2 = average(group2);
    const std1 = stdDev(group1);
    const std2 = stdDev(group2);

    // Pooled standard deviation
    const n1 = group1.length;
    const n2 = group2.length;
    const pooledStd = Math.sqrt(((n1 - 1) * std1 * std1 + (n2 - 1) * std2 * std2) / (n1 + n2 - 2));

    if (pooledStd === 0) {
      return { d: 0, interpretation: 'no_variance' };
    }

    const d = (mean2 - mean1) / pooledStd;
    const absD = Math.abs(d);

    let interpretation;
    if (absD < 0.2) interpretation = 'negligible';
    else if (absD < 0.5) interpretation = 'small';
    else if (absD < 0.8) interpretation = 'medium';
    else interpretation = 'large';

    return { d, interpretation };
  }

  /**
   * Two-sample t-test (Welch's t-test for unequal variances)
   * Tests if two samples have significantly different means
   * @param {Array<number>} group1 - –ø–µ—Ä–≤–∞—è –≤—ã–±–æ—Ä–∫–∞
   * @param {Array<number>} group2 - –≤—Ç–æ—Ä–∞—è –≤—ã–±–æ—Ä–∫–∞
   * @param {number} alpha - significance level (default: 0.05)
   * @returns {Object} { tStat, pValue (approx), isSignificant, direction }
   * direction: 'increase' | 'decrease' | 'no_change'
   */
  function twoSampleTTest(group1, group2, alpha = 0.05) {
    if (!group1 || !group2 || group1.length < 2 || group2.length < 2) {
      return {
        tStat: 0,
        pValue: 1,
        isSignificant: false,
        direction: 'no_change',
        warning: 'insufficient_sample_size'
      };
    }

    const mean1 = average(group1);
    const mean2 = average(group2);
    const var1 = variance(group1);
    const var2 = variance(group2);
    const n1 = group1.length;
    const n2 = group2.length;

    // Welch's t-statistic
    const se = Math.sqrt(var1 / n1 + var2 / n2);
    if (se === 0) {
      return {
        tStat: 0,
        pValue: 1,
        isSignificant: false,
        direction: 'no_change',
        warning: 'zero_standard_error'
      };
    }

    const tStat = (mean2 - mean1) / se;

    // Welch-Satterthwaite degrees of freedom
    const numerator = Math.pow(var1 / n1 + var2 / n2, 2);
    const denominator = Math.pow(var1 / n1, 2) / (n1 - 1) + Math.pow(var2 / n2, 2) / (n2 - 1);
    const df = numerator / denominator;

    // Approximate p-value using t-distribution
    // For simplicity, use critical values for common df
    // t-critical(df=‚àû, Œ±=0.05, two-tailed) ‚âà 1.96
    // t-critical(df=10, Œ±=0.05, two-tailed) ‚âà 2.228
    // t-critical(df=5, Œ±=0.05, two-tailed) ‚âà 2.571
    let tCritical;
    if (df >= 30) tCritical = 1.96;
    else if (df >= 20) tCritical = 2.086;
    else if (df >= 10) tCritical = 2.228;
    else if (df >= 5) tCritical = 2.571;
    else tCritical = 3.182; // df ‚âà 3

    const absTStat = Math.abs(tStat);
    const isSignificant = absTStat > tCritical;

    // Rough p-value approximation (two-tailed)
    let pValue;
    if (absTStat < 1) pValue = 0.8;
    else if (absTStat < 1.5) pValue = 0.3;
    else if (absTStat < 2) pValue = 0.1;
    else if (absTStat < 2.5) pValue = 0.05;
    else if (absTStat < 3) pValue = 0.01;
    else pValue = 0.001;

    const direction = mean2 > mean1 ? 'increase' : (mean2 < mean1 ? 'decrease' : 'no_change');

    return {
      tStat,
      pValue,
      df,
      isSignificant,
      direction,
      mean1,
      mean2,
      diff: mean2 - mean1
    };
  }

  // === –≠–ö–°–ü–û–†–¢ ===
  /**
   * üÜï v3.3.0: Coefficient of Variation (CV)
   * Normalized measure of dispersion (std/mean)
   * Useful for comparing variability across metrics with different scales
   * @param {Array<number>} arr - –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª
   * @returns {number} CV (0-1+ –≥–¥–µ 0=no variation, 0.15=low, 0.35=high)
   */
  function coefficientOfVariation(arr) {
    if (!arr || arr.length < 2) return 0;
    const avg = average(arr);
    if (avg === 0) return 0; // Avoid division by zero
    const std = stdDev(arr);
    return std / Math.abs(avg);
  }

  /**
   * üÜï v3.4.0: Pearson correlation with statistical significance test
   * Tests null hypothesis: true correlation = 0
   * Uses t-distribution with df = n-2
   * @param {Array<number>} x - first variable
   * @param {Array<number>} y - second variable
   * @param {number} alpha - significance level (default: 0.05)
   * @returns {Object} { r, pValue, isSignificant, n, df, tStat, effectSize, interpretation }
   * @example
   * const result = pearsonWithSignificance([1,2,3,4,5], [2,4,6,8,10]);
   * // ‚Üí { r: 1.0, pValue: 0.001, isSignificant: true, effectSize: 'large' }
   */
  function pearsonWithSignificance(x, y, alpha = 0.05) {
    const r = pearsonCorrelation(x, y);
    const n = x.length;

    // Insufficient data
    if (n < 3 || x.length !== y.length) {
      return {
        r: 0,
        pValue: 1,
        isSignificant: false,
        n,
        df: 0,
        tStat: 0,
        effectSize: 'insufficient_data',
        interpretation: 'insufficient sample size (n<3)',
        warning: 'insufficient_sample_size'
      };
    }

    // Perfect correlation or no variance
    if (Math.abs(r) === 1 || isNaN(r)) {
      return {
        r,
        pValue: Math.abs(r) === 1 ? 0.001 : 1,
        isSignificant: Math.abs(r) === 1,
        n,
        df: n - 2,
        tStat: Math.abs(r) === 1 ? Infinity : 0,
        effectSize: Math.abs(r) === 1 ? 'large' : 'no_variance',
        interpretation: Math.abs(r) === 1 ? 'perfect correlation (p<0.001)' : 'no variance in one or both variables'
      };
    }

    // t-statistic: t = r * sqrt((n-2)/(1-r¬≤))
    const df = n - 2;
    const tStat = r * Math.sqrt(df / (1 - r * r));
    const absTStat = Math.abs(tStat);

    // Critical t-value for two-tailed test at alpha level
    // Approximate values for common df ranges
    let tCritical;
    if (df >= 30) tCritical = 1.96;       // Œ±=0.05, df=‚àû
    else if (df >= 20) tCritical = 2.086; // Œ±=0.05, df=20
    else if (df >= 10) tCritical = 2.228; // Œ±=0.05, df=10
    else if (df >= 5) tCritical = 2.571;  // Œ±=0.05, df=5
    else if (df >= 3) tCritical = 3.182;  // Œ±=0.05, df=3
    else tCritical = 12.706;              // Œ±=0.05, df=1

    const isSignificant = absTStat > tCritical;

    // Approximate p-value bins (two-tailed)
    let pValue;
    if (absTStat < 1.0) pValue = 0.8;
    else if (absTStat < 1.5) pValue = 0.3;
    else if (absTStat < 2.0) pValue = 0.1;
    else if (absTStat < 2.5) pValue = 0.05;
    else if (absTStat < 3.0) pValue = 0.01;
    else if (absTStat < 4.0) pValue = 0.005;
    else pValue = 0.001;

    // Effect size interpretation (Cohen's conventions for correlation)
    const absR = Math.abs(r);
    let effectSize;
    if (absR < 0.1) effectSize = 'negligible';
    else if (absR < 0.3) effectSize = 'small';
    else if (absR < 0.5) effectSize = 'medium';
    else effectSize = 'large';

    // Human-readable interpretation
    const interpretation = isSignificant
      ? `${effectSize} effect, statistically significant (p<${alpha})`
      : `${effectSize} effect, not significant (p‚âà${pValue.toFixed(2)})`;

    return {
      r,
      pValue,
      isSignificant,
      n,
      df,
      tStat,
      effectSize,
      interpretation
    };
  }

  /**
   * üÜï v3.5.0: Bayesian correlation with prior knowledge
   * Shrinks observed correlation towards prior mean (empirical Bayes)
   * Useful for small N where sample correlation is unstable
   * @param {Array<number>} x - first variable
   * @param {Array<number>} y - second variable
   * @param {number} priorR - prior correlation (e.g., 0 = no effect, 0.3 = typical)
   * @param {number} priorN - effective sample size of prior (weight, typically 5-20)
   * @returns {Object} { posteriorR, observedR, shrinkage, effectiveN, confidence }
   * @example
   * const result = bayesianCorrelation([1,2,3], [2,3,5], 0, 10);
   * // ‚Üí { posteriorR: 0.85, observedR: 0.98, shrinkage: 0.13 } (shrunk towards 0)
   */
  function bayesianCorrelation(x, y, priorR = 0, priorN = 10) {
    const observedR = pearsonCorrelation(x, y);
    const observedN = x.length;

    if (observedN < 2) {
      return {
        posteriorR: priorR,
        observedR: 0,
        shrinkage: 1,
        effectiveN: priorN,
        confidence: 0.1,
        warning: 'insufficient_data'
      };
    }

    // Handle NaN from zero variance (all values identical)
    if (isNaN(observedR)) {
      console.info('[pi_stats.bayesian] ‚ö†Ô∏è Zero variance detected:', {
        n: observedN,
        fallback: 'using_prior',
        priorR: priorR.toFixed(2)
      });
      return {
        posteriorR: priorR,
        observedR: 0,
        shrinkage: Math.abs(priorR),
        effectiveN: priorN,
        confidence: 0.2,
        warning: 'zero_variance'
      };
    }

    // Weighted average: posterior = (prior*priorN + observed*observedN) / (priorN + observedN)
    const effectiveN = priorN + observedN;
    const posteriorR = (priorR * priorN + observedR * observedN) / effectiveN;
    const shrinkage = Math.abs(observedR - posteriorR);

    // Confidence increases with more data (less prior influence)
    const confidence = Math.min(0.95, observedN / (observedN + priorN));

    const result = {
      posteriorR,
      observedR,
      priorR,
      shrinkage,
      effectiveN,
      observedN,
      priorN,
      confidence,
      interpretation: shrinkage > 0.2
        ? `Strong shrinkage (${Math.round(shrinkage * 100)}%) towards prior`
        : shrinkage > 0.1
          ? `Moderate shrinkage (${Math.round(shrinkage * 100)}%) towards prior`
          : `Minimal shrinkage (${Math.round(shrinkage * 100)}%)`
    };

    // Verification logging
    console.info('[pi_stats.bayesian] ‚úÖ Correlation computed:', {
      observedR: observedR.toFixed(2),
      posteriorR: posteriorR.toFixed(2),
      shrinkage: shrinkage.toFixed(2),
      confidence: confidence.toFixed(2),
      n: observedN
    });

    return result;
  }

  /**
   * üÜï v3.5.0: Confidence interval for Pearson correlation
   * Uses Fisher z-transformation for normality
   * @param {number} r - observed correlation coefficient
   * @param {number} n - sample size
   * @param {number} confidenceLevel - confidence level (default: 0.95 for 95% CI)
   * @returns {Object} { lower, upper, margin, width, r, n }
   * @example
   * const ci = confidenceIntervalForCorrelation(0.5, 30);
   * // ‚Üí { lower: 0.19, upper: 0.71, margin: 0.26 }
   */
  function confidenceIntervalForCorrelation(r, n, confidenceLevel = 0.95) {
    if (n < 4) {
      return {
        lower: -1,
        upper: 1,
        margin: 1,
        width: 2,
        r,
        n,
        warning: 'insufficient_sample_size'
      };
    }

    if (Math.abs(r) >= 0.999) {
      // Perfect correlation: CI is very narrow
      return {
        lower: r > 0 ? 0.95 : -1,
        upper: r > 0 ? 1 : -0.95,
        margin: 0.05,
        width: 0.05,
        r,
        n
      };
    }

    // Fisher z-transformation: z = 0.5 * ln((1+r)/(1-r))
    const fisherZ = 0.5 * Math.log((1 + r) / (1 - r));

    // Standard error of z: SE_z = 1 / sqrt(n - 3)
    const seZ = 1 / Math.sqrt(n - 3);

    // Z-score for confidence level (approximate)
    let zScore;
    if (confidenceLevel >= 0.99) zScore = 2.576;
    else if (confidenceLevel >= 0.95) zScore = 1.96;
    else if (confidenceLevel >= 0.90) zScore = 1.645;
    else zScore = 1.96; // default to 95%

    // CI in z-space
    const zLower = fisherZ - zScore * seZ;
    const zUpper = fisherZ + zScore * seZ;

    // Transform back to r-space: r = (e^(2z) - 1) / (e^(2z) + 1)
    const lower = (Math.exp(2 * zLower) - 1) / (Math.exp(2 * zLower) + 1);
    const upper = (Math.exp(2 * zUpper) - 1) / (Math.exp(2 * zUpper) + 1);

    const margin = (upper - lower) / 2;
    const width = upper - lower;

    const result = {
      lower: Math.max(-1, Math.min(1, lower)),
      upper: Math.max(-1, Math.min(1, upper)),
      margin,
      width,
      r,
      n,
      confidenceLevel
    };

    // Verification logging
    console.info('[pi_stats.CI] ‚úÖ Confidence interval:', {
      r: r.toFixed(2),
      n,
      CI: `[${result.lower.toFixed(2)}, ${result.upper.toFixed(2)}]`,
      width: width.toFixed(2)
    });

    return result;
  }

  /**
   * üÜï v3.5.0: Outlier detection using IQR method
   * Identifies values outside [Q1 - 1.5*IQR, Q3 + 1.5*IQR]
   * @param {Array<number>} arr - array of numbers
   * @param {number} iqrMultiplier - IQR multiplier (default: 1.5, use 3.0 for extreme outliers)
   * @returns {Object} { outliers, cleaned, indices, stats }
   * @example
   * const result = detectOutliers([1, 2, 3, 4, 100]);
   * // ‚Üí { outliers: [100], cleaned: [1,2,3,4], indices: [4] }
   */
  function detectOutliers(arr, iqrMultiplier = 1.5) {
    if (!Array.isArray(arr) || arr.length < 4) {
      return {
        outliers: [],
        cleaned: arr || [],
        indices: [],
        stats: null,
        warning: 'insufficient_data'
      };
    }

    // Remove NaN/null/undefined values - explicit null check before isFinite
    const validData = arr
      .map((v, i) => ({ rawValue: v, index: i }))
      .filter(item => {
        const val = item.rawValue;
        return val !== null && val !== undefined && Number.isFinite(Number(val));
      })
      .map(item => ({ value: Number(item.rawValue), index: item.index }));

    const values = validData.map(item => item.value);
    const sorted = values.slice().sort((a, b) => a - b);
    const n = sorted.length;

    if (n < 4) {
      return {
        outliers: [],
        cleaned: values,
        indices: [],
        stats: null,
        warning: 'insufficient_data'
      };
    }

    // Calculate quartiles
    const q1 = calculatePercentile(sorted, 25);
    const q3 = calculatePercentile(sorted, 75);
    const iqr = q3 - q1;

    // Outlier bounds
    const lowerBound = q1 - iqrMultiplier * iqr;
    const upperBound = q3 + iqrMultiplier * iqr;

    // Identify outliers
    const outliers = [];
    const outlierIndices = [];
    const cleaned = [];

    validData.forEach(item => {
      if (item.value < lowerBound || item.value > upperBound) {
        outliers.push(item.value);
        outlierIndices.push(item.index);
      } else {
        cleaned.push(item.value);
      }
    });

    const result = {
      outliers,
      cleaned,
      indices: outlierIndices,
      stats: {
        q1,
        q3,
        iqr,
        lowerBound,
        upperBound,
        n: values.length,
        nOutliers: outliers.length,
        outlierRate: outliers.length / values.length
      }
    };

    // Verification logging
    if (outliers.length > 0) {
      console.info('[pi_stats.outliers] ‚ö†Ô∏è Outliers detected:', {
        total: values.length,
        outliers: outliers.length,
        rate: (outliers.length / values.length * 100).toFixed(1) + '%',
        cleaned: cleaned.length
      });
    }

    return result;
  }

  HEYS.InsightsPI.stats = {
    // –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
    average,
    stdDev,
    variance,
    coefficientOfVariation,

    // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
    pearsonCorrelation,
    pearsonWithSignificance,
    bayesianCorrelation,
    confidenceIntervalForCorrelation,
    detectOutliers,
    calculateTrend,
    calculateLinearRegression,
    calculateR2,
    autocorrelation,

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    skewness,
    linearTrend,
    calculatePercentile,
    calculateMovingAverage,
    exponentialMovingAverage,
    calculateConfidenceInterval,

    // –£—Ç–∏–ª–∏—Ç—ã
    normalizeValue,
    clamp,

    // Statistics safety (Phase 0)
    checkMinN,
    applySmallSamplePenalty,
    statisticalPower,
    confidenceWithWarning,

    // Statistical inference (v3.2.0 ‚Äî –Ω–∞—É—á–Ω—ã–π week-over-week)
    cohenD,
    twoSampleTTest
  };

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piStats = HEYS.InsightsPI.stats;

  devLog('[PI Stats] v3.5.0 loaded ‚Äî 27 statistical functions (+ Bayesian, CI, outliers)');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_thresholds.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Adaptive Personalized Thresholds v2.0
 * Version: 2.0.0
 * 
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è pattern analyzers –Ω–∞ –æ—Å–Ω–æ–≤–µ 14-21 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 * –ó–∞–º–µ–Ω—è–µ—Ç hardcoded –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (percentile-based + EMA smoothing).
 * 
 * v2.0 improvements:
 * - Adaptive TTL (12-72h based on behavior stability)
 * - Per-threshold confidence tracking
 * - Incremental updates (rolling window)
 * - Event-based invalidation (smart cache reset)
 * - Bayesian priors (population-informed defaults)
 * 
 * Dependencies: pi_stats.js, pi_cache.js, HEYS.dayUtils (localStorage)
 * @param global
 */

(function (global) {
    'use strict';

    const STORAGE_KEY = 'heys_adaptive_thresholds';
    const STORAGE_KEY_POPULATION = 'heys_population_priors';
    const STORAGE_KEY_ROLLING = 'heys_thresholds_rolling_stats'; // For incremental updates
    const MIN_DAYS_FULL_COMPUTE = 14;  // –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—Å–µ—Ö 7 –ø–æ—Ä–æ–≥–æ–≤
    const MIN_DAYS_PARTIAL = 7;        // –ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç (3 –ø–æ—Ä–æ–≥–∞ + 5 –¥–µ—Ñ–æ–ª—Ç–æ–≤)
    const OPTIMAL_DAYS = 21;
    const BASE_CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12 hours base
    const MAX_CACHE_TTL_MS = 72 * 60 * 60 * 1000;  // 72 hours max
    const POPULATION_SAMPLE_SIZE = 1000; // Minimum users for population priors

    // Population priors (–Ω–∞—É—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + observed means)
    const POPULATION_PRIORS = {
        lateEatingHour: { mean: 21.2, std: 1.8, source: 'meta-analysis' },
        idealMealGapMin: { mean: 260, std: 45, source: 'observed' },
        giOptimal: { mean: 56, std: 8.5, source: 'glycemic-research' },
        morningProteinG: { mean: 22, std: 8.3, source: 'observed' },
        fiberTarget: { mean: 28, std: 6.2, source: 'DRI-guidelines' },
        proteinPerMealG: { mean: 28, std: 9.1, source: 'calculated' }
    };

    // Event invalidation triggers
    const INVALIDATION_EVENTS = {
        GOAL_CHANGE: { weight: 1.0, reason: 'Protein targets changed' },
        WEIGHT_DROP_5KG: { weight: 0.8, reason: 'Significant composition change' },
        TRAINING_PATTERN_SHIFT: { weight: 0.7, reason: 'Activity pattern changed' },
        DIET_PATTERN_BREAK: { weight: 0.6, reason: '3+ days anomalous eating' }
    };

    // –§–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã (guard rails)
    const LIMITS = {
        lateEatingHour: { min: 20, max: 24 },
        idealMealGapMin: { min: 120, max: 360 },
        giOptimal: { min: 40, max: 70 },
        morningProteinG: { min: 15, max: 50 },
        fiberTarget: { min: 20, max: 50 },
        proteinPerMealG: { min: 15, max: 60 }
    };

    /**
     * Clamp –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã
     * @param value
     * @param key
     */
    function clamp(value, key) {
        const limit = LIMITS[key];
        if (!limit) return value;
        return Math.max(limit.min, Math.min(limit.max, value));
    }

    /**
     * –ò–∑–≤–ª–µ—á—å —á–∞—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –∏–∑ –¥–Ω—è
     * @param day
     */
    function getLastMealHour(day) {
        if (!day.meals || day.meals.length === 0) return null;
        const lastMeal = day.meals[day.meals.length - 1];
        if (!lastMeal.time) return null;
        const [hours] = lastMeal.time.split(':').map(Number);
        return hours;
    }

    /**
     * –ò–∑–≤–ª–µ—á—å –≤—Å–µ inter-meal gaps –≤ –º–∏–Ω—É—Ç–∞—Ö
     * @param days
     */
    function extractAllGaps(days) {
        const gaps = [];
        days.forEach(day => {
            if (!day.meals || day.meals.length < 2) return;
            for (let i = 1; i < day.meals.length; i++) {
                const prevTime = day.meals[i - 1].time;
                const currTime = day.meals[i].time;
                if (!prevTime || !currTime) continue;

                const [h1, m1] = prevTime.split(':').map(Number);
                const [h2, m2] = currTime.split(':').map(Number);
                const gapMin = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (gapMin > 0 && gapMin < 720) gaps.push(gapMin); // –º–∞–∫—Å 12—á
            }
        });
        return gaps;
    }

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π —Å—Ä–µ–¥–Ω–∏–π GI
     * @param day
     * @param pIndex
     */
    function computeDayAvgGI(day, pIndex) {
        if (!day.meals || !pIndex) return null;
        let totalGI = 0, totalCarbs = 0;

        day.meals.forEach(meal => {
            if (!meal.items) return;
            meal.items.forEach(item => {
                const product = pIndex.byId.get(item.product_id);
                if (!product || !product.gi || !product.carb) return;
                const carbG = (product.carb * item.grams) / 100;
                totalGI += product.gi * carbG;
                totalCarbs += carbG;
            });
        });

        return totalCarbs > 0 ? totalGI / totalCarbs : null;
    }

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–π –±–µ–ª–æ–∫ —É—Ç—Ä–æ–º (–¥–æ 12:00)
     * @param days
     * @param pIndex
     */
    function extractMorningProtein(days, pIndex) {
        const values = [];
        days.forEach(day => {
            if (!day.meals || !pIndex) return;
            let morningProt = 0;

            day.meals.forEach(meal => {
                const [hours] = (meal.time || '').split(':').map(Number);
                if (hours >= 12) return;

                if (!meal.items) return;
                meal.items.forEach(item => {
                    const product = pIndex.byId.get(String(item.product_id || item.productId || item.id).toLowerCase());
                    if (!product) return;
                    const prot = Number(product.protein100 || product.prot) || 0;
                    morningProt += (prot * item.grams) / 100;
                });
            });

            if (morningProt > 0) values.push(morningProt);
        });
        return values;
    }

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –∑–∞ –¥–µ–Ω—å
     * @param days
     * @param pIndex
     */
    function extractDailyFiber(days, pIndex) {
        const values = [];
        days.forEach(day => {
            if (!day.meals || !pIndex) return;
            let fiber = 0;

            day.meals.forEach(meal => {
                if (!meal.items) return;
                meal.items.forEach(item => {
                    const product = pIndex.byId.get(String(item.product_id || item.productId || item.id).toLowerCase());
                    if (!product) return;
                    const fiberVal = Number(product.fiber100 || product.fiber) || 0;
                    fiber += (fiberVal * item.grams) / 100;
                });
            });

            if (fiber > 0) values.push(fiber);
        });
        return values;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –ª–∏ –∫—ç—à —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π –ø–µ—Ä–∏–æ–¥
     * @param cacheRange - –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –∫—ç—à–∞ {from, to}
     * @param requestedDays - –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–Ω–∏
     */
    function isCurrentPeriodCovered(cacheRange, requestedDays, cachedDaysUsed) {
        if (!requestedDays?.length) return false;

        // üÜï CASCADE fast-path: –µ—Å–ª–∏ –∫—ç—à —Å–æ–¥–µ—Ä–∂–∏—Ç >= –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π,
        // –æ–Ω –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –æ—Ç "—Å–µ–≥–æ–¥–Ω—è" –Ω–∞–∑–∞–¥)
        if (cachedDaysUsed && cachedDaysUsed >= requestedDays.length) {
            return true;
        }

        if (!cacheRange) return false;

        const cacheFrom = new Date(cacheRange.from);
        const cacheTo = new Date(cacheRange.to);

        // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–Ω–∏ –≤—Ö–æ–¥—è—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –∫—ç—à–∞ ‚Üí –∫—ç—à –≤–∞–ª–∏–¥–µ–Ω
        const requestedDates = requestedDays.map(d => d.date).filter(Boolean);
        if (requestedDates.length === 0) return false;

        const sortedDates = requestedDates.sort();
        const oldestRequested = new Date(sortedDates[0]);
        const newestRequested = new Date(sortedDates[sortedDates.length - 1]);

        return oldestRequested >= cacheFrom && newestRequested <= cacheTo;
    }

    /**
     * üÜï v2.0: Calculate behavior variance (for Adaptive TTL)
     * –ò–∑–º–µ—Ä—è–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫–ª—é—á–µ–≤—ã–º –º–µ—Ç—Ä–∏–∫–∞–º
     * @param days - –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
     * @returns {number} - stabilityScore (0-1, –≥–¥–µ 1 = –æ—á–µ–Ω—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π)
     */
    function calculateBehaviorStability(days) {
        if (!days || days.length < 7) return 0.3; // Default low stability

        const stats = global.HEYS.InsightsPI.stats;

        // –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        // ‚úÖ FIX: dayTot –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º savedEatenKcal
        const kcals = days.map(d => d.savedEatenKcal || d.dayTot?.kcal || 0).filter(k => k > 0);
        const mealCounts = days.map(d => d.meals?.length || 0).filter(c => c > 0);
        const lastMealHours = days.map(getLastMealHour).filter(Boolean);

        if (kcals.length < 5) return 0.3;

        // Coefficient of variation (CV) –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
        const cvKcal = stats.coefficientOfVariation(kcals);
        const cvMeals = stats.coefficientOfVariation(mealCounts);
        const cvTiming = lastMealHours.length >= 3 ? stats.coefficientOfVariation(lastMealHours) : 0.15;

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: CV < 0.15 = stable, CV > 0.35 = volatile
        const stabilityKcal = Math.max(0, 1 - cvKcal / 0.35);
        const stabilityMeals = Math.max(0, 1 - cvMeals / 0.3);
        const stabilityTiming = Math.max(0, 1 - cvTiming / 0.2);

        // Weighted average (–±–µ–∑ protein ‚Äî –Ω–µ—Ç savedEatenProt –≤ day data)
        const overallStability = (
            stabilityKcal * 0.45 +
            stabilityMeals * 0.25 +
            stabilityTiming * 0.30
        );

        console.log('[HEYS.thresholds.stability] üìä Behavior stability:', {
            cvKcal: cvKcal.toFixed(3),
            cvMeals: cvMeals.toFixed(3),
            cvTiming: cvTiming.toFixed(3),
            kcalSamples: kcals.length,
            overallScore: overallStability.toFixed(2)
        });

        return Math.max(0, Math.min(1, overallStability));
    }

    /**
     * üÜï v2.0: Calculate adaptive TTL based on stability
     * @param stabilityScore (0-1)
     * @returns {number} - TTL in milliseconds
     */
    function calculateAdaptiveTTL(stabilityScore) {
        // Formula: 12h (volatile) to 72h (stable)
        const ttlHours = BASE_CACHE_TTL_MS / (60 * 60 * 1000) + (stabilityScore * 60);
        const ttlMs = Math.min(ttlHours * 60 * 60 * 1000, MAX_CACHE_TTL_MS);

        console.log('[HEYS.thresholds.ttl] ‚è∞ Adaptive TTL:', {
            stability: stabilityScore.toFixed(2),
            ttlHours: (ttlMs / (60 * 60 * 1000)).toFixed(1),
            ttlMs
        });

        return ttlMs;
    }

    /**
     * üÜï v2.0: Detect significant lifecycle events (for event-based invalidation)
     * @param profile - current profile
     * @param cachedMeta - metadata from cached thresholds
     * @param recentDays - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
     * @returns {object|null} - {event, reason} –∏–ª–∏ null
     */
    function detectSignificantChange(profile, cachedMeta, recentDays) {
        if (!cachedMeta || !cachedMeta.snapshot) return null;
        if (!profile) return null; // ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç undefined profile

        const snapshot = cachedMeta.snapshot;
        const events = [];

        // 1. Goal change (deficit ‚Üí bulk –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç)
        if (profile.goal && snapshot.goal && profile.goal !== snapshot.goal) {
            events.push({
                type: 'GOAL_CHANGE',
                weight: INVALIDATION_EVENTS.GOAL_CHANGE.weight,
                reason: `Goal changed: ${snapshot.goal} ‚Üí ${profile.goal}`
            });
        }

        // 2. Weight drop >= 5kg
        if (profile.weight && snapshot.weight) {
            const weightDelta = snapshot.weight - profile.weight;
            if (Math.abs(weightDelta) >= 5) {
                events.push({
                    type: 'WEIGHT_DROP_5KG',
                    weight: INVALIDATION_EVENTS.WEIGHT_DROP_5KG.weight,
                    reason: `Weight change: ${weightDelta > 0 ? '-' : '+'}${Math.abs(weightDelta).toFixed(1)}kg`
                });
            }
        }

        // 3. Diet pattern break (3+ consecutive anomalous days)
        if (recentDays && recentDays.length >= 3) {
            // ‚úÖ FIX: –∏—Å–ø–æ–ª—å–∑—É–µ–º savedEatenKcal (dayTot –Ω–µ—Ç –≤ raw localStorage data)
            const daysWithKcal = recentDays.filter(d => (d.savedEatenKcal || d.dayTot?.kcal || 0) > 0);
            // ‚úÖ FIX v2: snapshot.avgKcal >= 200 ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç stale cache —Å –Ω—É–ª–µ–≤—ã–º–∏/–º–∏–∑–µ—Ä–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            // (—Å—Ç–∞—Ä—ã–π –±–∞–≥ –∑–∞–ø–∏—Å—ã–≤–∞–ª avgKcal‚âà0 –∏–∑-–∑–∞ dayTot?.kcal)
            if (daysWithKcal.length >= 3 && snapshot.avgKcal >= 200) {
                const avgKcal = daysWithKcal.reduce((sum, d) => sum + (d.savedEatenKcal || d.dayTot?.kcal || 0), 0) / daysWithKcal.length;
                const snapshotKcal = snapshot.avgKcal;

                const kcalDeviation = Math.abs((avgKcal - snapshotKcal) / snapshotKcal);
                if (kcalDeviation > 0.3) { // 30%+ deviation
                    events.push({
                        type: 'DIET_PATTERN_BREAK',
                        weight: INVALIDATION_EVENTS.DIET_PATTERN_BREAK.weight,
                        reason: `Calorie pattern changed ${(kcalDeviation * 100).toFixed(0)}%`
                    });
                }
            }
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∞–º—ã–π –∑–Ω–∞—á–∏–º—ã–π event
        if (events.length === 0) return null;
        events.sort((a, b) => b.weight - a.weight);

        console.log('[HEYS.thresholds.events] üö® Significant change detected:', events[0]);
        return events[0];
    }

    /**
     * üÜï v2.0: Bayesian blend of prior + observed data
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö users (0-13 –¥–Ω–µ–π) —á—Ç–æ–±—ã –¥–∞—Ç—å reasonable defaults
     * @param userDays - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param observedValue - –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
     * @param prior - {mean, std} –∏–∑ POPULATION_PRIORS
     * @returns {number} - blended value
     */
    function bayesianBlend(userDays, observedValue, prior) {
        if (!prior) return observedValue;

        // Weight: 0 (all prior) ‚Üí 1 (all observed) –ø–æ –º–µ—Ä–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º sigmoid –¥–ª—è smooth transition
        const rawWeight = Math.min(userDays / 14, 1); // 14 –¥–Ω–µ–π = full observed
        const weight = 1 / (1 + Math.exp(-10 * (rawWeight - 0.5))); // Sigmoid smoothing

        if (observedValue === null || observedValue === undefined) {
            return prior.mean; // No data yet, use prior
        }

        const blended = (1 - weight) * prior.mean + weight * observedValue;

        console.log('[HEYS.thresholds.bayesian] üé≤ Blend:', {
            userDays,
            weight: weight.toFixed(2),
            prior: prior.mean,
            observed: observedValue,
            blended: blended.toFixed(1)
        });

        return blended;
    }

    /**
     * üÜï v2.0: Calculate per-threshold confidence
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç confidence –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ variance –∏ sample size
     * @param values - –º–∞—Å—Å–∏–≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
     * @param sampleSize - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
     * @returns {object} - {confidence, variance, reliable}
     */
    function calculateThresholdConfidence(values, sampleSize) {
        if (!values || values.length < 3) {
            return { confidence: 0, variance: 999, reliable: false };
        }

        const stats = global.HEYS.InsightsPI.stats;
        const cv = stats.coefficientOfVariation(values);

        // Confidence formula: —É—á–∏—Ç—ã–≤–∞–µ—Ç sample size –∏ stability
        // High CV = low confidence, Large N = high confidence
        const sampleFactor = Math.min(sampleSize / OPTIMAL_DAYS, 1);
        const stabilityFactor = Math.max(0, 1 - cv / 0.4); // CV > 0.4 = unreliable

        const confidence = sampleFactor * stabilityFactor;
        const reliable = confidence > 0.7;

        return {
            confidence: Math.max(0, Math.min(1, confidence)),
            variance: cv,
            reliable,
            samples: values.length
        };
    }

    /**
     * –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ, –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
     * üÜï v2.0: —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Bayesian priors –∏–∑ population data
     * @param profile
     */
    function getDefaultThresholds(profile) {
        const goal = profile?.goal || 'maintenance';
        const weight = profile?.weight || 70;
        const coefficients = { cut: 1.8, maintenance: 1.4, bulk: 1.6 };
        const dailyProtein = weight * (coefficients[goal] || 1.4);

        // Use population priors instead of hardcoded values
        const thresholds = {
            lateEatingHour: POPULATION_PRIORS.lateEatingHour.mean,
            idealMealGapMin: POPULATION_PRIORS.idealMealGapMin.mean,
            giOptimal: POPULATION_PRIORS.giOptimal.mean,
            morningProteinG: POPULATION_PRIORS.morningProteinG.mean,
            fiberTarget: POPULATION_PRIORS.fiberTarget.mean,
            proteinPerMealG: Math.round(dailyProtein / 4),
            chronotype: 'neutral',
            circadianShift: 0
        };

        // üÜï v2.0: Per-threshold confidence (all defaults have low confidence)
        const thresholdsWithConfidence = {};
        Object.keys(thresholds).forEach(key => {
            thresholdsWithConfidence[key] = {
                value: thresholds[key],
                confidence: 0.3, // Default priors have moderate confidence
                variance: POPULATION_PRIORS[key]?.std || 1,
                reliable: false,
                source: 'population_prior'
            };
        });

        return {
            thresholds,
            thresholdsWithConfidence,
            confidence: 0,
            daysUsed: 0,
            meta: {
                computedAt: new Date().toISOString(),
                default: true,
                version: '2.0.0'
            }
        };
    }

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è 7-13 –¥–Ω–µ–π
     * üÜï v2.0: —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Bayesian blend –∏ per-threshold confidence
     * @param days
     * @param profile
     * @param pIndex
     */
    function computePartialThresholds(days, profile, pIndex) {
        const stats = global.HEYS.InsightsPI.stats;
        const thresholds = {};
        const thresholdsWithConfidence = {};
        let computedCount = 0;

        console.log('[HEYS.thresholds.partial] ‚ö†Ô∏è Partial computation:', {
            daysUsed: days.length,
            hasPIndex: !!pIndex
        });

        // 1. lateEatingHour ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const lateHours = days.map(d => getLastMealHour(d)).filter(h => h !== null);
        if (lateHours.length > 0) {
            const p90 = stats.calculatePercentile(lateHours, 90);
            const blended = bayesianBlend(days.length, p90, POPULATION_PRIORS.lateEatingHour);
            thresholds.lateEatingHour = Math.round(clamp(blended, 'lateEatingHour'));

            const conf = calculateThresholdConfidence(lateHours, days.length);
            thresholdsWithConfidence.lateEatingHour = {
                value: thresholds.lateEatingHour,
                ...conf,
                source: 'bayesian_blend'
            };
            computedCount++;
        }

        // 2. idealMealGapMin ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const gaps = extractAllGaps(days);
        if (gaps.length > 0) {
            const median = stats.calculatePercentile(gaps, 50);
            const blended = bayesianBlend(days.length, median, POPULATION_PRIORS.idealMealGapMin);
            thresholds.idealMealGapMin = Math.round(clamp(blended, 'idealMealGapMin'));

            const conf = calculateThresholdConfidence(gaps, days.length);
            thresholdsWithConfidence.idealMealGapMin = {
                value: thresholds.idealMealGapMin,
                ...conf,
                source: 'bayesian_blend'
            };
            computedCount++;
        }

        // 3. proteinPerMealG ‚Äî –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏)
        const goal = profile.goal || 'maintenance';
        const coefficients = { cut: 1.8, maintenance: 1.4, bulk: 1.6 };
        const dailyProtein = profile.weight * (coefficients[goal] || 1.4);
        const avgMeals = days.reduce((sum, d) => sum + (d.meals?.length || 0), 0) / days.length;
        thresholds.proteinPerMealG = Math.round(clamp(dailyProtein / (avgMeals || 4), 'proteinPerMealG'));

        thresholdsWithConfidence.proteinPerMealG = {
            value: thresholds.proteinPerMealG,
            confidence: 0.8, // High confidence from profile data
            variance: 0.1,
            reliable: true,
            samples: days.length,
            source: 'calculated_from_profile'
        };
        computedCount++;

        // 4-8. –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî population priors (–Ω—É–∂–Ω–æ 14+ –¥–Ω–µ–π –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏)
        const defaults = getDefaultThresholds(profile);
        const defaultKeys = ['giOptimal', 'morningProteinG', 'fiberTarget', 'chronotype', 'circadianShift'];

        defaultKeys.forEach(key => {
            if (!thresholds[key]) {
                thresholds[key] = defaults.thresholds[key];
                thresholdsWithConfidence[key] = defaults.thresholdsWithConfidence?.[key] || {
                    value: defaults.thresholds[key],
                    confidence: 0.3,
                    variance: 1,
                    reliable: false,
                    source: 'population_prior'
                };
            }
        });

        const confidence = computedCount / 8; // 3/8 = 0.375

        console.log('[HEYS.thresholds.partial] ‚úÖ Result:', {
            computed: computedCount,
            defaults: 8 - computedCount,
            confidence: confidence.toFixed(2)
        });

        // dateRange –¥–ª—è –∫—ç—à–∞ (oldest to newest)
        const dates = days.map(d => d.date).filter(Boolean).sort();
        const dateRange = dates.length > 0 ? {
            from: dates[0],
            to: dates[dates.length - 1]
        } : null;

        // Profile snapshot –¥–ª—è event detection (–∏—Å–ø–æ–ª—å–∑—É–µ–º savedEatenKcal)
        const daysWithMeals = days.filter(d => (d.savedEatenKcal || d.dayTot?.kcal || 0) > 0);
        const avgKcal = daysWithMeals.length > 0
            ? daysWithMeals.reduce((sum, d) => sum + (d.savedEatenKcal || d.dayTot?.kcal || 0), 0) / daysWithMeals.length
            : 0;

        return {
            thresholds,
            thresholdsWithConfidence,
            confidence,
            daysUsed: days.length,
            meta: {
                computedAt: new Date().toISOString(),
                partial: true,
                dateRange,
                snapshot: {
                    goal: profile?.goal,
                    weight: profile?.weight,
                    avgKcal: Math.round(avgKcal)
                },
                thresholdsComputed: computedCount,
                thresholdsDefault: 8 - computedCount,
                version: '2.0.0'
            }
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ö—Ä–æ–Ω–æ—Ç–∏–ø –∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–≤–æ–≥–æ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
     * @param days
     */
    function detectChronotype(days) {
        const firstMealHours = [];
        const lastMealHours = [];

        days.forEach(day => {
            if (!day.meals || day.meals.length === 0) return;
            const first = day.meals[0].time;
            const last = day.meals[day.meals.length - 1].time;

            if (first) {
                const [h] = first.split(':').map(Number);
                firstMealHours.push(h);
            }
            if (last) {
                const [h] = last.split(':').map(Number);
                lastMealHours.push(h);
            }
        });

        if (firstMealHours.length === 0) return 'neutral';

        const stats = global.HEYS.InsightsPI.stats;
        const avgFirst = stats.average(firstMealHours);
        const avgLast = stats.average(lastMealHours);

        // –ñ–∞–≤–æ—Ä–æ–Ω–æ–∫: –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –¥–æ 7, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –¥–æ 21
        if (avgFirst < 7 && avgLast < 21) return 'lark';
        // –°–æ–≤–∞: –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 9, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–æ—Å–ª–µ 22
        if (avgFirst > 9 && avgLast > 22) return 'owl';
        return 'neutral';
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä–æ–≥–æ–≤
     * üÜï v2.0: —Ç–µ–ø–µ—Ä—å —Å per-threshold confidence tracking
     * @param days
     * @param profile
     * @param pIndex
     */
    function computeAdaptiveThresholds(days, profile, pIndex) {
        console.group('[HEYS.thresholds.compute] üî¨ Starting computation v2.0');
        console.log('Input:', {
            daysCount: days?.length,
            profileWeight: profile?.weight,
            hasPIndex: !!pIndex
        });

        const N = days.length;

        // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç (fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç—ã)
        if (N < MIN_DAYS_FULL_COMPUTE) {
            console.warn('‚ö†Ô∏è Insufficient data:', {
                daysCount: N,
                minRequired: MIN_DAYS_FULL_COMPUTE
            });
            console.groupEnd();
            return {
                confidence: 0,
                daysUsed: N,
                thresholds: {},
                thresholdsWithConfidence: {},
                meta: { reason: 'insufficient_data', minRequired: MIN_DAYS_FULL_COMPUTE, version: '2.0.0' }
            };
        }

        const stats = global.HEYS.InsightsPI.stats;
        const confidence = Math.min(1, N / OPTIMAL_DAYS);
        const thresholds = {};
        const thresholdsWithConfidence = {}; // üÜï v2.0

        // 1. Late Eating Hour ‚Äî P75 –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
        const lastMealHours = days.map(getLastMealHour).filter(Boolean);
        if (lastMealHours.length >= 10) {
            const p75 = stats.calculatePercentile(lastMealHours, 75);
            thresholds.lateEatingHour = clamp(Math.round(p75), 'lateEatingHour');

            const conf = calculateThresholdConfidence(lastMealHours, N);
            thresholdsWithConfidence.lateEatingHour = {
                value: thresholds.lateEatingHour,
                ...conf,
                source: 'computed_p75'
            };

            console.log('üïê lateEatingHour:', {
                raw: p75,
                clamped: thresholds.lateEatingHour,
                samples: lastMealHours.length,
                confidence: conf.confidence.toFixed(2)
            });
        }

        // 2. Ideal Meal Gap ‚Äî –º–µ–¥–∏–∞–Ω–∞ gaps —Å EMA smoothing
        const gaps = extractAllGaps(days);
        if (gaps.length >= 10) {
            const smoothed = stats.exponentialMovingAverage(gaps, 7);
            const median = stats.calculatePercentile(smoothed, 50);
            thresholds.idealMealGapMin = clamp(Math.round(median), 'idealMealGapMin');

            const conf = calculateThresholdConfidence(gaps, N);
            thresholdsWithConfidence.idealMealGapMin = {
                value: thresholds.idealMealGapMin,
                ...conf,
                source: 'computed_median_ema'
            };

            console.log('‚è±Ô∏è idealMealGapMin:', {
                raw: median,
                clamped: thresholds.idealMealGapMin,
                samples: gaps.length,
                confidence: conf.confidence.toFixed(2)
            });
        }

        // 3. GI Optimal ‚Äî P25 —Ö–æ—Ä–æ—à–∏—Ö –¥–Ω–µ–π
        if (pIndex) {
            const avgGIs = days.map(d => computeDayAvgGI(d, pIndex)).filter(Boolean);
            if (avgGIs.length >= 10) {
                const p25 = stats.calculatePercentile(avgGIs, 25);
                thresholds.giOptimal = clamp(Math.round(p25), 'giOptimal');

                const conf = calculateThresholdConfidence(avgGIs, N);
                thresholdsWithConfidence.giOptimal = {
                    value: thresholds.giOptimal,
                    ...conf,
                    source: 'computed_p25'
                };

                console.log('üìä giOptimal:', {
                    raw: p25,
                    clamped: thresholds.giOptimal,
                    samples: avgGIs.length,
                    confidence: conf.confidence.toFixed(2)
                });
            }
        }

        // 4. Morning Protein ‚Äî P75 * 0.85 (target —á—É—Ç—å –Ω–∏–∂–µ –ª—É—á—à–∏—Ö –¥–Ω–µ–π)
        if (pIndex) {
            const morningProt = extractMorningProtein(days, pIndex);
            if (morningProt.length >= 10) {
                const p75 = stats.calculatePercentile(morningProt, 75);
                thresholds.morningProteinG = clamp(Math.round(p75 * 0.85), 'morningProteinG');

                const conf = calculateThresholdConfidence(morningProt, N);
                thresholdsWithConfidence.morningProteinG = {
                    value: thresholds.morningProteinG,
                    ...conf,
                    source: 'computed_p75_adjusted'
                };

                console.log('ü•© morningProteinG:', {
                    raw: p75 * 0.85,
                    clamped: thresholds.morningProteinG,
                    samples: morningProt.length,
                    confidence: conf.confidence.toFixed(2)
                });
            }
        }

        // 5. Fiber Target ‚Äî max(P75 —Ç–µ–∫—É—â–µ–≥–æ, 25–≥ –º–∏–Ω–∏–º—É–º)
        if (pIndex) {
            const fiberValues = extractDailyFiber(days, pIndex);
            if (fiberValues.length >= 10) {
                const p75 = stats.calculatePercentile(fiberValues, 75);
                thresholds.fiberTarget = clamp(Math.max(p75, 25), 'fiberTarget');

                const conf = calculateThresholdConfidence(fiberValues, N);
                thresholdsWithConfidence.fiberTarget = {
                    value: thresholds.fiberTarget,
                    ...conf,
                    source: 'computed_p75_floor'
                };

                console.log('üåæ fiberTarget:', {
                    raw: p75,
                    withMin: Math.max(p75, 25),
                    clamped: thresholds.fiberTarget,
                    samples: fiberValues.length,
                    confidence: conf.confidence.toFixed(2)
                });
            }
        }

        // 6. Protein Per Meal ‚Äî –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ –≤–µ—Å–∞ –∏ —Ü–µ–ª–∏
        if (profile && profile.weight) {
            const weight = profile.weight;
            const goal = profile.goal || 'maintenance';
            const coef = goal === 'deficit' ? 1.6 : goal === 'bulk' ? 2.0 : 1.4;
            const dailyProtein = weight * coef;

            // –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
            const mealsPerDay = days
                .map(d => d.meals ? d.meals.length : 0)
                .filter(n => n > 0);
            const avgMeals = mealsPerDay.length > 0 ? stats.calculatePercentile(mealsPerDay, 50) : 4;

            thresholds.proteinPerMealG = clamp(Math.round(dailyProtein / avgMeals), 'proteinPerMealG');

            thresholdsWithConfidence.proteinPerMealG = {
                value: thresholds.proteinPerMealG,
                confidence: 0.9, // High confidence from profile
                variance: 0.1,
                reliable: true,
                samples: N,
                source: 'calculated_from_profile'
            };

            console.log('üí™ proteinPerMealG:', {
                weight,
                goal,
                coef,
                dailyProtein,
                avgMeals,
                perMeal: thresholds.proteinPerMealG
            });
        }

        // 7. Chronotype-based adjustments
        const chronotype = detectChronotype(days);
        thresholds.chronotype = chronotype;
        thresholdsWithConfidence.chronotype = {
            value: chronotype,
            confidence: 0.8,
            variance: 0,
            reliable: true,
            samples: N,
            source: 'computed_pattern'
        };
        console.log('ü¶â chronotype:', chronotype);

        // Adjust circadian boundaries based on chronotype
        if (chronotype === 'owl') {
            thresholds.circadianShift = 2; // shift +2 hours
        } else if (chronotype === 'lark') {
            thresholds.circadianShift = -1; // shift -1 hour
        } else {
            thresholds.circadianShift = 0;
        }
        thresholdsWithConfidence.circadianShift = {
            value: thresholds.circadianShift,
            confidence: 0.7,
            variance: 0.5,
            reliable: true,
            samples: N,
            source: 'derived_from_chronotype'
        };

        console.log('‚úÖ Final result:', {
            thresholds,
            confidence,
            daysUsed: N,
            thresholdCount: Object.keys(thresholds).length,
            reliableCount: Object.values(thresholdsWithConfidence).filter(t => t.reliable).length
        });
        console.groupEnd();

        // –§–æ—Ä–º–∏—Ä—É–µ–º dateRange –¥–ª—è –∫—ç—à–∞ (oldest to newest)
        const dates = days.map(d => d.date).filter(Boolean).sort();
        const dateRange = dates.length > 0 ? {
            from: dates[0],
            to: dates[dates.length - 1]
        } : null;

        // üÜï v2.0: Profile snapshot –¥–ª—è event detection
        // ‚úÖ FIX: –∏—Å–ø–æ–ª—å–∑—É–µ–º savedEatenKcal (dayTot –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage raw data)
        const daysWithMeals = days.filter(d => (d.savedEatenKcal || d.dayTot?.kcal || 0) > 0);
        const avgKcal = daysWithMeals.length > 0
            ? daysWithMeals.reduce((sum, d) => sum + (d.savedEatenKcal || d.dayTot?.kcal || 0), 0) / daysWithMeals.length
            : 0;
        const profileSnapshot = {
            goal: profile?.goal,
            weight: profile?.weight,
            avgKcal: Math.round(avgKcal)
        };

        return {
            confidence,
            daysUsed: N,
            thresholds,
            thresholdsWithConfidence, // üÜï v2.0
            meta: {
                computedAt: new Date().toISOString(),
                dateRange,
                snapshot: profileSnapshot, // üÜï v2.0: for event detection
                version: '2.0.0'
            }
        };
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage –∏–ª–∏ –≤—ã—á–∏—Å–ª–∏—Ç—å –∑–∞–Ω–æ–≤–æ
     * @param days
     * @param profile
     * @param pIndex
     */
    function getAdaptiveThresholds(days, profile, pIndex) {
        const U = global.HEYS.dayUtils;
        console.log('[HEYS.thresholds] üîç getAdaptiveThresholds called:', {
            daysCount: days?.length || 0,
            profileId: profile?.id,
            profileWeight: profile?.weight,
            profileGoal: profile?.goal,
            hasPIndex: !!pIndex,
            daysIsArray: Array.isArray(days),
            profileKeys: profile ? Object.keys(profile).slice(0, 10) : [],
            pIndexSize: pIndex?.byId?.size || 0,
            hasU: !!U,
            version: '2.0.0'
        });

        // üéØ v2.0: CACHE-FIRST STRATEGY + ADAPTIVE TTL + EVENT INVALIDATION
        if (U) {
            const cached = U.lsGet(STORAGE_KEY);
            if (cached?.meta) {
                const age = Date.now() - new Date(cached.meta.computedAt).getTime();
                const covered = isCurrentPeriodCovered(cached.meta.dateRange, days, cached.daysUsed);

                // üÜï v2.0: Calculate adaptive TTL instead of fixed CACHE_TTL_MS
                const stability = calculateBehaviorStability(days);
                const adaptiveTTL = calculateAdaptiveTTL(stability);

                // üÜï v2.0: Check for significant changes (event-based invalidation)
                const recentDays = days.slice(-7); // Last 7 days for change detection
                const significantChange = detectSignificantChange(profile, cached.meta, recentDays);

                if (significantChange) {
                    console.log('[HEYS.thresholds] üö® Event-based invalidation triggered:', {
                        event: significantChange.type,
                        reason: significantChange.reason,
                        weight: significantChange.weight
                    });
                    // Invalidate cache, will compute from scratch
                } else if (age < adaptiveTTL && covered) {
                    console.log(`[HEYS.thresholds] ‚ôªÔ∏è Using cached (from ${cached.daysUsed}d) for ${days.length}d request:`, {
                        cacheAge: Math.round(age / 1000 / 60) + 'min',
                        adaptiveTTL: Math.round(adaptiveTTL / 1000 / 60) + 'min',
                        stability: stability.toFixed(2),
                        cacheRange: cached.meta.dateRange,
                        confidence: cached.confidence,
                        thresholds: Object.keys(cached.thresholds).length
                    });

                    // üÜï v2.1: Apply phenotype multipliers to cached thresholds
                    let result = cached;
                    if (profile?.phenotype && global.HEYS.InsightsPI?.phenotype?.applyMultipliers) {
                        const baseThresholds = { ...cached.thresholds };
                        const adjustedThresholds = global.HEYS.InsightsPI.phenotype.applyMultipliers(
                            baseThresholds,
                            profile.phenotype
                        );
                        result = { ...cached, thresholds: adjustedThresholds, phenotypeApplied: true };
                        console.log('[HEYS.thresholds] üß¨ Applied phenotype multipliers to cache:', {
                            phenotype: profile.phenotype
                        });
                    }

                    return result;
                } else {
                    console.log('[HEYS.thresholds] üîÑ Cache miss:', {
                        age: Math.round(age / 1000 / 60) + 'min',
                        adaptiveTTL: Math.round(adaptiveTTL / 1000 / 60) + 'min',
                        stability: stability.toFixed(2),
                        covered,
                        cachedDays: cached.daysUsed,
                        requestedDays: days.length,
                        reason: age >= adaptiveTTL ? 'expired' : 'not_covered'
                    });

                    // üöÄ v5.1: Stale-While-Revalidate (SWR)
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–π –∫—ç—à, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ, –∞ –ø–µ—Ä–µ—Å—á—ë—Ç –∑–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–µ
                    if (cached && Object.keys(cached.thresholds || {}).length > 0) {
                        console.log('[HEYS.thresholds] ‚ö° SWR: Returning stale cache immediately, computing in background');

                        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç
                        setTimeout(() => {
                            try {
                                console.log('[HEYS.thresholds] ‚ö° SWR: Background compute started');
                                const fresh = _computeAndCache(days, profile, pIndex, U);
                                // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã UI (MealRecommenderCard) –æ–±–Ω–æ–≤–∏–ª—Å—è
                                if (typeof window !== 'undefined' && window.dispatchEvent) {
                                    window.dispatchEvent(new CustomEvent('heysThresholdsUpdated', { detail: fresh }));
                                }
                            } catch (e) {
                                console.error('[HEYS.thresholds] ‚ö° SWR: Background compute failed', e);
                            }
                        }, 0);

                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º stale –¥–∞–Ω–Ω—ã–µ (—Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–µ–Ω–æ—Ç–∏–ø–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                        let result = cached;
                        if (profile?.phenotype && global.HEYS.InsightsPI?.phenotype?.applyMultipliers) {
                            const baseThresholds = { ...cached.thresholds };
                            const adjustedThresholds = global.HEYS.InsightsPI.phenotype.applyMultipliers(
                                baseThresholds,
                                profile.phenotype
                            );
                            result = { ...cached, thresholds: adjustedThresholds, phenotypeApplied: true };
                        }
                        return result;
                    }
                }
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (!U) {
            console.warn('[HEYS.thresholds] ‚ö†Ô∏è Missing HEYS.dayUtils utility');
            return getDefaultThresholds(profile);
        }

        if (!days || !Array.isArray(days) || days.length === 0) {
            console.warn('[HEYS.thresholds] ‚ö†Ô∏è Missing or empty days array');
            return getDefaultThresholds(profile);
        }

        if (!profile) {
            console.warn('[HEYS.thresholds] ‚ö†Ô∏è Missing profile ‚Äî continue with partial profile (proteinPerMeal may be defaulted)');
            profile = {};
        }

        // Weight/goal –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã: –±–µ–∑ –Ω–∏—Ö —Å—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏,
        // –∞ proteinPerMealG –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω —á–µ—Ä–µ–∑ fallback defaults
        if (!profile.weight && !profile.goal) {
            console.warn('[HEYS.thresholds] ‚ÑπÔ∏è Profile has no weight/goal ‚Äî computing thresholds without profile-based protein target');
        }

        // pIndex –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω, –Ω–æ –±–µ–∑ –Ω–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ä–æ–≥–æ–≤ –Ω–µ –ø–æ—Å—á–∏—Ç–∞—é—Ç—Å—è
        if (!pIndex) {
            console.warn('[HEYS.thresholds] ‚ÑπÔ∏è Missing pIndex (some thresholds will be skipped)');
        }

        return _computeAndCache(days, profile, pIndex, U);
    }

    /**
     * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –≤ SWR)
     */
    function _computeAndCache(days, profile, pIndex, U) {
        // üî¨ –í—ã—á–∏—Å–ª–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (3-tier cascade)
        let result;

        if (days.length >= MIN_DAYS_FULL_COMPUTE) {
            // Tier 1: –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç (14-30 –¥–Ω–µ–π) ‚Üí 5-8 –ø–æ—Ä–æ–≥–æ–≤, confidence=1.0
            const computed = computeAdaptiveThresholds(days, profile, pIndex);
            console.log('[HEYS.thresholds] ‚ú® Computed FULL thresholds:', {
                thresholds: computed.thresholds,
                thresholdsWithConfidence: Object.keys(computed.thresholdsWithConfidence || {}).length,
                confidence: computed.confidence,
                daysUsed: computed.daysUsed
            });

            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
            if (computed.confidence > 0) {
                U.lsSet(STORAGE_KEY, computed);
                console.info(
                    `[HEYS.thresholds] ‚úÖ Computed ${Object.keys(computed.thresholds).length} thresholds ` +
                    `(${computed.daysUsed}d, conf=${computed.confidence.toFixed(2)}, version=2.0.0)`
                );
            }

            result = computed;
        }
        else if (days.length >= MIN_DAYS_PARTIAL) {
            // Tier 2: –ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç (7-13 –¥–Ω–µ–π) ‚Üí 3 –ø–æ—Ä–æ–≥–∞ + 5 Bayesian, confidence=0.375
            console.log('[HEYS.thresholds] ‚ö†Ô∏è Partial compute mode:', { days: days.length });
            const partial = computePartialThresholds(days, profile, pIndex);

            // ‚úÖ FIX: –ö—ç—à–∏—Ä—É–µ–º partial ‚Äî –Ω–æ –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫—ç—à (full > partial)
            if (partial.confidence > 0 && U) {
                const existingCache = U.lsGet(STORAGE_KEY);
                const existingDays = existingCache?.daysUsed || 0;
                const existingThresholds = Object.keys(existingCache?.thresholds || {}).length;
                const partialThresholds = Object.keys(partial.thresholds || {}).length;
                // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ partial –ª—É—á—à–µ –∏–ª–∏ –∫—ç—à –ø—É—Å—Ç/—Ö—É–∂–µ
                if (!existingCache || existingDays < partial.daysUsed ||
                    (existingDays === partial.daysUsed && existingThresholds <= partialThresholds)) {
                    U.lsSet(STORAGE_KEY, partial);
                }
            }

            result = partial;
        }
        else {
            // Tier 3: –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ (<7 –¥–Ω–µ–π) ‚Üí Bayesian priors, confidence=0
            console.log('[HEYS.thresholds] üîß Using defaults (Bayesian priors):', { days: days.length });
            result = getDefaultThresholds(profile);
        }

        // üÜï v2.1: Apply phenotype multipliers if phenotype is defined
        if (profile?.phenotype && global.HEYS.InsightsPI?.phenotype?.applyMultipliers) {
            const baseThresholds = { ...result.thresholds };
            const adjustedThresholds = global.HEYS.InsightsPI.phenotype.applyMultipliers(
                baseThresholds,
                profile.phenotype
            );

            console.log('[HEYS.thresholds] üß¨ Applied phenotype multipliers:', {
                phenotype: profile.phenotype,
                before: Object.keys(baseThresholds).length,
                after: Object.keys(adjustedThresholds).length,
                changed: Object.keys(adjustedThresholds).filter(k =>
                    adjustedThresholds[k] !== baseThresholds[k]
                ).length
            });

            result.thresholds = adjustedThresholds;
            result.phenotypeApplied = true;
        }

        return result;
    }

    /**
     * Invalidate cache (–ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É)
     * üÜï v2.0: —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ profile changes
     */
    function invalidateCache() {
        const U = global.HEYS.dayUtils;
        if (U) {
            U.lsSet(STORAGE_KEY, null);
            console.log('[HEYS.thresholds] üóëÔ∏è Cache invalidated manually');
        }
    }

    // Export
    global.HEYS = global.HEYS || {};
    global.HEYS.InsightsPI = global.HEYS.InsightsPI || {};
    global.HEYS.InsightsPI.thresholds = {
        compute: computeAdaptiveThresholds,
        get: getAdaptiveThresholds,
        invalidate: invalidateCache,
        version: '2.0.0' // üÜï Updated from 1.0.0
    };

})(window);


/* ===== insights/pi_science_info.js ===== */
// pi_science_info.js ‚Äî Compatibility bridge for SCIENCE_INFO
// v4.0.0: Source of truth moved to pi_constants.js (HEYS.InsightsPI.constants.SCIENCE_INFO)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const constants = HEYS.InsightsPI.constants || global.piConst || {};
    const SCIENCE_INFO = constants.SCIENCE_INFO || {};

    // Backward-compatible exports for legacy modules
    HEYS.InsightsPI.science = SCIENCE_INFO;
    global.piScience = SCIENCE_INFO;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/timing.js ===== */
// insights/patterns/timing.js ‚Äî Modular timing analyzers (v6.5.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const piCalculations = HEYS.InsightsPI?.calculations || global.piCalculations || {};
    const SCIENCE_INFO = piConst.SCIENCE_INFO || HEYS.InsightsPI?.science || global.piScience || {};

    const CONFIG = piConst.CONFIG || {
        MIN_DAYS_FOR_FULL_ANALYSIS: 7,
        MIN_CORRELATION_DISPLAY: 0.35
    };

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, v) => sum + (Number(v) || 0), 0) / arr.length;
    };

    const calculateItemKcal = piCalculations.calculateItemKcal || function (item, pIndex) {
        const prod = pIndex?.byId?.get?.(item?.product_id);
        if (!prod) return 0;
        return (prod.kcal100 || 0) * (item.grams || 0) / 100;
    };

    const PATTERNS = piConst.PATTERNS || {
        MEAL_TIMING: 'meal_timing',
        WAVE_OVERLAP: 'wave_overlap',
        LATE_EATING: 'late_eating',
        CIRCADIAN: 'circadian',
        NUTRIENT_TIMING: 'nutrient_timing'
    };

    /**
     * –ê–Ω–∞–ª–∏–∑ —Ç–∞–π–º–∏–Ω–≥–∞ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω.
     * @param {Array} days
     * @param {object} profile
     * @param {object} thresholds - Adaptive thresholds
     * @returns {object}
     */
    function analyzeMealTiming(days, profile, thresholds = {}) {
        const waveHours = profile?.insulinWaveHours || 3;
        const idealGapMin = thresholds.idealMealGapMin || (waveHours * 60);
        const gaps = [];
        const waveOverlaps = [];

        for (const day of days) {
            if (!day.meals || day.meals.length < 2) continue;

            const sortedMeals = [...day.meals]
                .filter(m => m.time)
                .sort((a, b) => a.time.localeCompare(b.time));

            for (let i = 1; i < sortedMeals.length; i++) {
                const prev = sortedMeals[i - 1];
                const curr = sortedMeals[i];

                const [prevH, prevM] = prev.time.split(':').map(Number);
                const [currH, currM] = curr.time.split(':').map(Number);

                const prevMinutes = prevH * 60 + prevM;
                const currMinutes = currH * 60 + currM;
                const gapMinutes = currMinutes - prevMinutes;

                if (gapMinutes > 0) {
                    gaps.push(gapMinutes);

                    const waveMinutes = waveHours * 60;
                    if (gapMinutes < waveMinutes) {
                        waveOverlaps.push({
                            date: day.date,
                            gap: gapMinutes,
                            overlap: waveMinutes - gapMinutes,
                            overlapPct: ((waveMinutes - gapMinutes) / waveMinutes) * 100
                        });
                    }
                }
            }
        }

        const avgGap = average(gaps);
        const idealGap = idealGapMin;
        const gapScore = Math.min(100, Math.max(0, (avgGap / idealGap) * 100));

        return {
            pattern: PATTERNS.MEAL_TIMING,
            available: gaps.length > 0,
            score: Math.round(gapScore),
            avgGapMinutes: Math.round(avgGap),
            idealGapMinutes: idealGap,
            gapScore: Math.round(gapScore),
            waveOverlaps,
            overlapCount: waveOverlaps.length,
            totalMeals: days.reduce((sum, d) => sum + (d.meals?.length || 0), 0),
            confidence: days.length >= CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS ? 0.8 : 0.5,
            insight: avgGap < idealGap * 0.7
                ? `–ß–∞—Å—Ç–æ –µ—à—å —Ä–∞–Ω—å—à–µ —á–µ–º —á–µ—Ä–µ–∑ ${waveHours}—á ‚Äî –∏–Ω—Å—É–ª–∏–Ω –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç —É–ø–∞—Å—Ç—å`
                : avgGap > idealGap * 1.3
                    ? '–ë–æ–ª—å—à–∏–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –º–µ–∂–¥—É –µ–¥–æ–π ‚Äî —Ä–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è'
                    : `–û—Ç–ª–∏—á–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥! –°—Ä–µ–¥–Ω–µ–µ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏: ${Math.round(avgGap / 60)}—á ${Math.round(avgGap % 60)}–º–∏–Ω`
        };
    }

    /**
     * –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω.
     * @param {Array} days
     * @param {object} profile
     * @returns {object}
     */
    function analyzeWaveOverlap(days, profile) {
        const mealTiming = analyzeMealTiming(days, profile);
        const overlaps = mealTiming.waveOverlaps;

        if (overlaps.length === 0) {
            return {
                pattern: PATTERNS.WAVE_OVERLAP,
                available: true,
                hasOverlaps: false,
                overlapCount: 0,
                avgOverlapPct: 0,
                confidence: days.length >= CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS ? 0.8 : 0.5,
                insight: 'üéâ –ù–µ—Ç –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ –≤–æ–ª–Ω ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥!',
                score: 100
            };
        }

        const avgOverlapPct = average(overlaps.map(o => o.overlapPct));
        const score = Math.max(0, 100 - avgOverlapPct);

        return {
            pattern: PATTERNS.WAVE_OVERLAP,
            available: true,
            hasOverlaps: true,
            overlapCount: overlaps.length,
            avgOverlapPct: Math.round(avgOverlapPct),
            worstOverlaps: overlaps.slice(0, 3),
            confidence: days.length >= CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS ? 0.8 : 0.5,
            insight: `${overlaps.length} —Ä–∞–∑ –µ–ª –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã ‚Äî –ª–∏–ø–æ–ª–∏–∑ –Ω–µ —É—Å–ø–µ–≤–∞–ª –Ω–∞—á–∞—Ç—å—Å—è`,
            score: Math.round(score)
        };
    }

    /**
     * –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏.
     * @param {Array} days
     * @param {object} thresholds - Adaptive thresholds
     * @returns {object}
     */
    function analyzeLateEating(days, thresholds = {}) {
        const lateMeals = [];
        const LATE_HOUR = thresholds.lateEatingHour || 21;

        for (const day of days) {
            if (!day.meals) continue;

            for (const meal of day.meals) {
                if (!meal.time) continue;
                const hour = parseInt(meal.time.split(':')[0], 10);

                if (hour >= LATE_HOUR) {
                    lateMeals.push({
                        date: day.date,
                        time: meal.time,
                        hour
                    });
                }
            }
        }

        const totalMeals = days.reduce((sum, d) => sum + (d.meals?.length || 0), 0);
        const latePct = totalMeals > 0 ? (lateMeals.length / totalMeals) * 100 : 0;
        const score = Math.max(0, 100 - latePct * 2);

        return {
            pattern: PATTERNS.LATE_EATING,
            available: true,
            lateCount: lateMeals.length,
            totalMeals,
            latePct: Math.round(latePct),
            score: Math.round(score),
            confidence: days.length >= CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS ? 0.8 : 0.5,
            insight: lateMeals.length === 0
                ? 'üëç –ù–µ—Ç –ø–æ–∑–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤ ‚Äî –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–Ω–∞!'
                : `${lateMeals.length} –ø–æ–∑–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤ (–ø–æ—Å–ª–µ 21:00) ‚Äî –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ —Å–æ–Ω –∏ –≤–µ—Å`
        };
    }

    /**
     * üåÖ –¶–∏—Ä–∫–∞–¥–Ω—ã–π –∞–Ω–∞–ª–∏–∑ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeCircadianTiming(days, pIndex) {
        const timeWeights = {
            morning: { from: 6, to: 12, weight: 1.1, label: '–£—Ç—Ä–æ (6-12)' },
            afternoon: { from: 12, to: 18, weight: 1.0, label: '–î–µ–Ω—å (12-18)' },
            evening: { from: 18, to: 22, weight: 0.9, label: '–í–µ—á–µ—Ä (18-22)' },
            night: { from: 22, to: 6, weight: 0.7, label: '–ù–æ—á—å (22-6)' }
        };

        const dailyData = [];

        for (const day of days) {
            if (!day.meals || day.meals.length === 0) continue;

            const periods = { morning: 0, afternoon: 0, evening: 0, night: 0 };
            let totalKcal = 0;

            for (const meal of day.meals) {
                if (!meal.time || !meal.items) continue;
                const hour = parseInt(meal.time.split(':')[0], 10);

                let mealKcal = 0;
                for (const item of meal.items) {
                    mealKcal += calculateItemKcal(item, pIndex);
                }

                totalKcal += mealKcal;

                if (hour >= 6 && hour < 12) periods.morning += mealKcal;
                else if (hour >= 12 && hour < 18) periods.afternoon += mealKcal;
                else if (hour >= 18 && hour < 22) periods.evening += mealKcal;
                else periods.night += mealKcal;
            }

            if (totalKcal > 0) {
                let weightedSum = 0;
                for (const [period, kcal] of Object.entries(periods)) {
                    weightedSum += (kcal / totalKcal) * timeWeights[period].weight;
                }
                const dayScore = weightedSum * 100;

                dailyData.push({
                    date: day.date,
                    periods,
                    totalKcal,
                    score: dayScore,
                    morningPct: Math.round((periods.morning / totalKcal) * 100),
                    eveningPct: Math.round(((periods.evening + periods.night) / totalKcal) * 100)
                });
            }
        }

        if (dailyData.length < 3) {
            return {
                pattern: PATTERNS.CIRCADIAN,
                available: false,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞'
            };
        }

        const avgScore = average(dailyData.map(d => d.score));
        const avgMorningPct = average(dailyData.map(d => d.morningPct));
        const avgEveningPct = average(dailyData.map(d => d.eveningPct));

        let insight;
        if (avgScore >= 95) {
            insight = 'üåÖ –ò–¥–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ! –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –¥–æ –æ–±–µ–¥–∞';
        } else if (avgScore >= 85) {
            insight = `‚òÄÔ∏è –•–æ—Ä–æ—à–∏–π —Ç–∞–π–º–∏–Ω–≥: ${Math.round(avgMorningPct)}% –∫–∞–ª–æ—Ä–∏–π —É—Ç—Ä–æ–º`;
        } else if (avgEveningPct > 40) {
            insight = `üåô ${Math.round(avgEveningPct)}% –∫–∞–ª–æ—Ä–∏–π –≤–µ—á–µ—Ä–æ–º ‚Äî –ø–µ—Ä–µ–Ω–µ—Å–∏ —á–∞—Å—Ç—å –Ω–∞ —É—Ç—Ä–æ`;
        } else {
            insight = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –ø–æ –¥–Ω—é —É–º–µ—Ä–µ–Ω–Ω–æ–µ';
        }

        return {
            pattern: PATTERNS.CIRCADIAN,
            available: true,
            score: Math.round(avgScore),
            avgMorningPct: Math.round(avgMorningPct),
            avgEveningPct: Math.round(avgEveningPct),
            dataPoints: dailyData.length,
            confidence: dailyData.length >= 7 ? 0.8 : 0.5,
            insight,
            formula: SCIENCE_INFO?.CIRCADIAN?.formula || 'circadian score',
            debug: {
                timeWeights,
                dailyData: dailyData.slice(0, 3),
                source: SCIENCE_INFO?.CIRCADIAN?.source || 'Panda, 2016'
            }
        };
    }

    /**
     * ü•© –¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ ‚Äî –∫–æ–≥–¥–∞ —Å—ä–µ–¥–µ–Ω—ã –±–µ–ª–æ–∫/—É–≥–ª–µ–≤–æ–¥—ã/–∂–∏—Ä—ã.
     * @param {Array} days
     * @param {object} pIndex
     * @param {object} _profile
     * @returns {object}
     */
    function analyzeNutrientTiming(days, pIndex, _profile, thresholds = {}) {
        const dailyData = [];
        const MIN_MORNING_PROTEIN = thresholds.morningProteinG || 20;
        const OPT_MORNING_PROTEIN = (thresholds.morningProteinG || 20) * 1.5;

        for (const day of days) {
            if (!day.meals || day.meals.length === 0) continue;

            let morningProtein = 0, eveningProtein = 0;
            let postWorkoutCarbs = 0;
            let eveningFat = 0, totalFat = 0;

            const trainingHour = day.trainings?.[0]?.time
                ? parseInt(day.trainings[0].time.split(':')[0], 10)
                : null;

            for (const meal of day.meals) {
                if (!meal.time || !meal.items) continue;
                const hour = parseInt(meal.time.split(':')[0], 10);

                let mealProtein = 0, mealCarbs = 0, mealFat = 0;
                for (const item of meal.items) {
                    const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
                    if (prod && item.grams) {
                        mealProtein += (prod.protein100 || 0) * item.grams / 100;
                        mealCarbs += ((prod.simple100 || 0) + (prod.complex100 || 0)) * item.grams / 100;
                        mealFat += ((prod.badFat100 || 0) + (prod.goodFat100 || 0)) * item.grams / 100;
                    }
                }

                if (hour >= 6 && hour < 12) morningProtein += mealProtein;
                if (hour >= 18) eveningProtein += mealProtein;
                if (hour >= 18) eveningFat += mealFat;

                if (trainingHour && hour >= trainingHour && hour <= trainingHour + 2) {
                    postWorkoutCarbs += mealCarbs;
                }

                totalFat += mealFat;
            }

            const totalProtein = morningProtein + eveningProtein;

            let score = 50;
            if (morningProtein >= MIN_MORNING_PROTEIN) score += 10;
            if (morningProtein >= OPT_MORNING_PROTEIN) score += 5;

            if (trainingHour && postWorkoutCarbs >= 30) score += 15;

            const eveningFatPct = totalFat > 0 ? (eveningFat / totalFat) * 100 : 0;
            if (eveningFatPct < 30) score += 10;

            const proteinBalance = totalProtein > 0
                ? Math.min(morningProtein, eveningProtein) / Math.max(morningProtein, eveningProtein, 1)
                : 0;
            if (proteinBalance > 0.6) score += 10;

            dailyData.push({
                date: day.date,
                morningProtein: Math.round(morningProtein),
                postWorkoutCarbs: Math.round(postWorkoutCarbs),
                eveningFatPct: Math.round(eveningFatPct),
                score: Math.min(100, score)
            });
        }

        if (dailyData.length < 3) {
            return {
                pattern: PATTERNS.NUTRIENT_TIMING,
                available: false,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–∞–π–º–∏–Ω–≥–∞ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤'
            };
        }

        const avgScore = average(dailyData.map(d => d.score));
        const avgMorningProtein = average(dailyData.map(d => d.morningProtein));

        let insight;
        if (avgScore >= 80) {
            insight = 'üéØ –û—Ç–ª–∏—á–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤! –ë–µ–ª–æ–∫ —É—Ç—Ä–æ–º, —É–≥–ª–µ–≤–æ–¥—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏';
        } else if (avgMorningProtein < 20) {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ –±–µ–ª–∫–∞ —É—Ç—Ä–æ–º (${Math.round(avgMorningProtein)}–≥). –î–æ–±–∞–≤—å —è–π—Ü–∞/—Ç–≤–æ—Ä–æ–≥`;
        } else {
            insight = '–¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
        }

        return {
            pattern: PATTERNS.NUTRIENT_TIMING,
            available: true,
            score: Math.round(avgScore),
            avgMorningProtein: Math.round(avgMorningProtein),
            dataPoints: dailyData.length,
            confidence: dailyData.length >= 7 ? 0.8 : 0.5,
            insight,
            formula: SCIENCE_INFO?.NUTRIENT_TIMING?.formula || 'nutrient timing score',
            debug: {
                dailyData: dailyData.slice(0, 3),
                source: SCIENCE_INFO?.NUTRIENT_TIMING?.source || 'Arble et al., 2009'
            }
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeMealTiming = analyzeMealTiming;
    HEYS.InsightsPI.patternModules.analyzeWaveOverlap = analyzeWaveOverlap;
    HEYS.InsightsPI.patternModules.analyzeLateEating = analyzeLateEating;
    HEYS.InsightsPI.patternModules.analyzeCircadianTiming = analyzeCircadianTiming;
    HEYS.InsightsPI.patternModules.analyzeNutrientTiming = analyzeNutrientTiming;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/sleep.js ===== */
// insights/patterns/sleep.js ‚Äî Modular sleep analyzers (v6.7.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const piCalculations = HEYS.InsightsPI?.calculations || global.piCalculations || {};
    const SCIENCE_INFO = piConst.SCIENCE_INFO || HEYS.InsightsPI?.science || global.piScience || {};

    const CONFIG = piConst.CONFIG || {
        MIN_DAYS_FOR_FULL_ANALYSIS: 7,
        MIN_CORRELATION_DISPLAY: 0.35
    };

    const PATTERNS = piConst.PATTERNS || {
        SLEEP_WEIGHT: 'sleep_weight',
        SLEEP_HUNGER: 'sleep_hunger',
        SLEEP_QUALITY: 'sleep_quality'
    };

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + (Number(value) || 0), 0) / arr.length;
    };

    const pearsonCorrelation = piStats.pearsonCorrelation || function (x, y) {
        if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length < 2) return 0;
        const n = x.length;
        const xMean = average(x);
        const yMean = average(y);
        let numerator = 0;
        let xDen = 0;
        let yDen = 0;
        for (let i = 0; i < n; i++) {
            const dx = (Number(x[i]) || 0) - xMean;
            const dy = (Number(y[i]) || 0) - yMean;
            numerator += dx * dy;
            xDen += dx * dx;
            yDen += dy * dy;
        }
        const denominator = Math.sqrt(xDen * yDen);
        return denominator === 0 ? 0 : numerator / denominator;
    };

    const pearsonWithSignificance = piStats.pearsonWithSignificance || function (x, y, alpha = 0.05) {
        // Fallback if piStats not loaded
        const r = pearsonCorrelation(x, y);
        return {
            r,
            pValue: 1,
            isSignificant: false,
            n: x.length,
            df: x.length - 2,
            tStat: 0,
            effectSize: 'unknown',
            interpretation: 'pearsonWithSignificance not available',
            warning: 'fallback_mode'
        };
    };

    const bayesianCorrelation = piStats.bayesianCorrelation || function (x, y, priorR = 0, priorN = 10) {
        // Fallback: return observed correlation without shrinkage
        const r = pearsonCorrelation(x, y);
        return {
            posteriorR: r,
            observedR: r,
            shrinkage: 0,
            effectiveN: x.length,
            confidence: 0.5,
            interpretation: 'bayesianCorrelation not available'
        };
    };

    const confidenceIntervalForCorrelation = piStats.confidenceIntervalForCorrelation || function (r, n, confidenceLevel = 0.95) {
        // Fallback: wide interval
        return {
            lower: Math.max(-1, r - 0.5),
            upper: Math.min(1, r + 0.5),
            margin: 0.5,
            width: 1.0,
            r,
            n
        };
    };

    const detectOutliers = piStats.detectOutliers || function (arr, iqrMultiplier = 1.5) {
        // Fallback: no outlier detection
        return {
            outliers: [],
            cleaned: arr.slice(),
            indices: [],
            stats: null,
            warning: 'detectOutliers not available'
        };
    };

    const calculateItemKcal = piCalculations.calculateItemKcal || function (item, pIndex) {
        const prod = pIndex?.byId?.get?.(item?.product_id);
        if (!prod) return 0;
        return (prod.kcal100 || 0) * (item.grams || 0) / 100;
    };

    const calculateDayKcal = piCalculations.calculateDayKcal || function (day, pIndex) {
        if (!day?.meals?.length) return 0;
        let total = 0;
        for (const meal of day.meals) {
            for (const item of (meal.items || [])) {
                total += calculateItemKcal(item, pIndex);
            }
        }
        return total;
    };

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å —á–∞—Å—ã —Å–Ω–∞ –∏–∑ –≤—Ä–µ–º—ë–Ω.
     * @param {string} start
     * @param {string} end
     * @returns {number|null}
     */
    function calculateSleepHours(start, end) {
        if (!start || !end) return null;

        const [startH, startM] = start.split(':').map(Number);
        const [endH, endM] = end.split(':').map(Number);

        let startMin = startH * 60 + startM;
        let endMin = endH * 60 + endM;

        if (startMin > endMin) {
            endMin += 24 * 60;
        }

        return (endMin - startMin) / 60;
    }

    /**
     * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–Ω–∞ –∏ –≤–µ—Å–∞.
     * @param {Array} days
     * @returns {object}
     */
    function analyzeSleepWeight(days) {
        const pairs = [];

        for (const day of days) {
            const sleep = day.sleepHours || (day.sleepStart && day.sleepEnd
                ? calculateSleepHours(day.sleepStart, day.sleepEnd)
                : null);
            const weight = day.weightMorning;

            if (sleep && weight) {
                pairs.push({ sleep, weight, date: day.date });
            }
        }

        if (pairs.length < 7) {
            return {
                pattern: PATTERNS.SLEEP_WEIGHT,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö —Å–Ω–∞ –∏ –≤–µ—Å–∞'
            };
        }

        const sleepArr = pairs.map(p => p.sleep);
        const weightArr = pairs.map(p => p.weight);

        // v3.5.0: Detect and remove outliers before correlation
        const sleepOutlierCheck = detectOutliers(sleepArr);
        const weightOutlierCheck = detectOutliers(weightArr);

        // Combine outlier indices from both arrays
        const outlierIndices = new Set([
            ...sleepOutlierCheck.indices,
            ...weightOutlierCheck.indices
        ]);

        // Filter out outliers from both arrays (aligned by original index)
        const cleanSleep = [];
        const cleanWeight = [];
        for (let i = 0; i < sleepArr.length; i++) {
            if (!outlierIndices.has(i)) {
                cleanSleep.push(sleepArr[i]);
                cleanWeight.push(weightArr[i]);
            }
        }

        // Re-check minimum N after outlier removal
        if (cleanSleep.length < 7) {
            return {
                pattern: PATTERNS.SLEEP_WEIGHT,
                available: false,
                confidence: 0.2,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (${cleanSleep.length}/7)`
            };
        }

        // Statistical significance
        const corrResult = pearsonWithSignificance(cleanSleep, cleanWeight);

        // v3.5.0: Bayesian correlation with null-effect prior (r=0, priorN=10)
        const bayesResult = bayesianCorrelation(cleanSleep, cleanWeight, 0, 10);

        // v3.5.0: Confidence interval for correlation
        const ci = confidenceIntervalForCorrelation(corrResult.r, cleanSleep.length);

        const score = Math.round(50 + bayesResult.posteriorR * -50);
        let insight;

        // Use Bayesian posteriorR for interpretation (stabilized for small N)
        const r = bayesResult.posteriorR;

        if (!corrResult.isSignificant) {
            insight = `–°–≤—è–∑—å —Å–Ω–∞ –∏ –≤–µ—Å–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (N=${corrResult.n}, p=${corrResult.pValue.toFixed(3)}, 95% CI [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}])`;
        } else if (r < -0.3) {
            insight = `üí§ –ë–æ–ª—å—à–µ —Å–Ω–∞ ‚Üí –º–µ–Ω—å—à–µ –≤–µ—Å (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n}, shrinkage=${(bayesResult.shrinkage * 100).toFixed(0)}%)`;
        } else if (r > 0.3) {
            insight = `‚ö†Ô∏è –ù–µ–¥–æ—Å—ã–ø –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –Ω–∞–±–æ—Ä–æ–º –≤–µ—Å–∞ (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n}, shrinkage=${(bayesResult.shrinkage * 100).toFixed(0)}%)`;
        } else {
            insight = `–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å —Å–Ω–∞ –∏ –≤–µ—Å–∞ (r=${r.toFixed(2)}, p=${corrResult.pValue.toFixed(3)}, N=${corrResult.n})`;
        }

        // Calculate confidence based on effect size, significance, and CI width
        let confidence = 0.5; // base confidence
        if (corrResult.isSignificant) {
            if (corrResult.effectSize === 'large') confidence = 0.9;
            else if (corrResult.effectSize === 'medium') confidence = 0.75;
            else if (corrResult.effectSize === 'small') confidence = 0.6;
        } else {
            confidence = 0.3; // low confidence for non-significant results
        }

        // Adjust confidence based on CI width (narrower CI ‚Üí higher confidence)
        const ciPenalty = Math.min(0.1, ci.width / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        return {
            pattern: PATTERNS.SLEEP_WEIGHT,
            available: true,
            correlation: Math.round(corrResult.r * 100) / 100,
            bayesianR: Math.round(bayesResult.posteriorR * 100) / 100, // v3.5.0: Bayesian estimate
            pValue: corrResult.pValue,
            isSignificant: corrResult.isSignificant,
            effectSize: corrResult.effectSize,
            confidenceInterval: { // v3.5.0: Uncertainty quantification
                lower: Math.round(ci.lower * 100) / 100,
                upper: Math.round(ci.upper * 100) / 100,
                width: Math.round(ci.width * 100) / 100
            },
            outlierStats: { // v3.5.0: Outlier detection results
                sleepOutliers: sleepOutlierCheck.outliers.length,
                weightOutliers: weightOutlierCheck.outliers.length,
                cleanedN: cleanSleep.length,
                rawN: pairs.length
            },
            dataPoints: pairs.length,
            avgSleep: Math.round(average(cleanSleep) * 10) / 10,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –Ω–µ–¥–æ—Å—ã–ø–∞ –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è.
     * @param {Array} days
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeSleepHunger(days, profile, pIndex) {
        const pairs = [];
        const sleepNorm = profile?.sleepHours || 8;

        for (const day of days) {
            const sleep = day.sleepHours || (day.sleepStart && day.sleepEnd
                ? calculateSleepHours(day.sleepStart, day.sleepEnd)
                : null);

            const dayKcal = calculateDayKcal(day, pIndex);

            if (sleep && dayKcal > 0) {
                const sleepDeficit = sleepNorm - sleep;
                pairs.push({ sleepDeficit, kcal: dayKcal, date: day.date });
            }
        }

        if (pairs.length < 7) {
            return {
                pattern: PATTERNS.SLEEP_HUNGER,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–≤—è–∑–∏ —Å–Ω–∞ –∏ –∞–ø–ø–µ—Ç–∏—Ç–∞',
                formula: SCIENCE_INFO?.CORRELATION?.formula || 'r = pearson(x, y)'
            };
        }

        const deficitArr = pairs.map(p => p.sleepDeficit);
        const kcalArr = pairs.map(p => p.kcal);

        // v3.5.0 rollout: detect outliers and align arrays
        const deficitOutlierCheck = detectOutliers(deficitArr);
        const kcalOutlierCheck = detectOutliers(kcalArr);
        const outlierIndices = new Set([
            ...deficitOutlierCheck.indices,
            ...kcalOutlierCheck.indices
        ]);

        const cleanDeficit = [];
        const cleanKcal = [];
        for (let i = 0; i < deficitArr.length; i++) {
            if (!outlierIndices.has(i)) {
                cleanDeficit.push(deficitArr[i]);
                cleanKcal.push(kcalArr[i]);
            }
        }

        if (cleanDeficit.length < 7) {
            return {
                pattern: PATTERNS.SLEEP_HUNGER,
                available: false,
                confidence: 0.2,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (${cleanDeficit.length}/7)`,
                formula: SCIENCE_INFO?.CORRELATION?.formula || 'r = pearson(x, y)'
            };
        }

        const corrResult = pearsonWithSignificance(cleanDeficit, cleanKcal);
        const bayesResult = bayesianCorrelation(cleanDeficit, cleanKcal, 0, 8);
        const ci = confidenceIntervalForCorrelation(corrResult.r, cleanDeficit.length);

        const score = Math.round(50 - bayesResult.posteriorR * 50);
        let insight;
        const r = bayesResult.posteriorR;

        // Use statistical significance instead of arbitrary threshold
        if (!corrResult.isSignificant) {
            insight = `–°–≤—è–∑—å –Ω–µ–¥–æ—Å—ã–ø–∞ –∏ –∞–ø–ø–µ—Ç–∏—Ç–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (N=${corrResult.n}, p=${corrResult.pValue.toFixed(3)}, 95% CI [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}])`;
        } else if (r > 0.3) {
            insight = `üò¥ –ù–µ–¥–æ—Å—ã–ø ‚Üí +–∫–∞–ª–æ—Ä–∏–∏! –ü—Ä–∏ -1—á —Å–Ω–∞ ‚âà +${Math.round(r * 200)} –∫–∫–∞–ª (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n})`;
        } else if (r < -0.3) {
            insight = `üí™ –û—Ç–ª–∏—á–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—à—å –∞–ø–ø–µ—Ç–∏—Ç –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—ã–ø–µ (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'})`;
        } else {
            insight = `–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å —Å–Ω–∞ –∏ –∞–ø–ø–µ—Ç–∏—Ç–∞ (r=${r.toFixed(2)}, p=${corrResult.pValue.toFixed(3)}, N=${corrResult.n})`;
        }

        // Calculate confidence based on effect size and significance
        let confidence = 0.5;
        if (corrResult.isSignificant) {
            if (corrResult.effectSize === 'large') confidence = 0.9;
            else if (corrResult.effectSize === 'medium') confidence = 0.75;
            else if (corrResult.effectSize === 'small') confidence = 0.6;
        } else {
            confidence = 0.3;
        }

        const ciPenalty = Math.min(0.1, ci.width / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        return {
            pattern: PATTERNS.SLEEP_HUNGER,
            available: true,
            correlation: Math.round(corrResult.r * 100) / 100,
            bayesianR: Math.round(bayesResult.posteriorR * 100) / 100,
            pValue: corrResult.pValue,
            isSignificant: corrResult.isSignificant,
            effectSize: corrResult.effectSize,
            confidenceInterval: {
                lower: Math.round(ci.lower * 100) / 100,
                upper: Math.round(ci.upper * 100) / 100,
                width: Math.round(ci.width * 100) / 100
            },
            outlierStats: {
                deficitOutliers: deficitOutlierCheck.outliers.length,
                kcalOutliers: kcalOutlierCheck.outliers.length,
                cleanedN: cleanDeficit.length,
                rawN: pairs.length
            },
            dataPoints: pairs.length,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight,
            formula: `r = pearson(sleepDeficit[], kcal[])\nsleepDeficit = ${sleepNorm}—á (–Ω–æ—Ä–º–∞) - actualSleep`,
            debug: {
                avgSleepDeficit: Math.round(average(cleanDeficit) * 10) / 10,
                avgKcal: Math.round(average(cleanKcal)),
                source: SCIENCE_INFO?.hormones?.source || 'Spiegel et al., 2004'
            }
        };
    }

    /**
     * B1: Sleep Quality ‚Üí Next Day Metrics (time-lagged correlation).
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeSleepQuality(days, pIndex) {
        if (!Array.isArray(days) || days.length === 0) {
            return {
                pattern: PATTERNS.SLEEP_QUALITY,
                available: false,
                reason: 'no_sleep_quality',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—á–µ—Å—Ç–≤–µ —Å–Ω–∞'
            };
        }

        const robustPairsRequired = days.length >= 14 ? 7 : 4;
        const sleepQualityDays = days.filter(d => Number(d?.sleepQuality) > 0).length;

        if (sleepQualityDays === 0) {
            return {
                pattern: PATTERNS.SLEEP_QUALITY,
                available: false,
                reason: 'no_sleep_quality',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—á–µ—Å—Ç–≤–µ —Å–Ω–∞'
            };
        }

        const timeLaggedPairs = {
            weight: [],
            steps: [],
            kcal: [],
            mood: []
        };

        for (let i = 0; i < days.length - 1; i++) {
            const today = days[i];
            const tomorrow = days[i + 1];

            const sleepQuality = today.sleepQuality;
            if (!sleepQuality) continue;

            if (tomorrow.weightMorning) {
                timeLaggedPairs.weight.push({ quality: sleepQuality, value: tomorrow.weightMorning });
            }
            if (tomorrow.moodAvg) {
                timeLaggedPairs.mood.push({ quality: sleepQuality, value: tomorrow.moodAvg });
            }
            if (tomorrow.steps) {
                timeLaggedPairs.steps.push({ quality: sleepQuality, value: tomorrow.steps });
            }
            const tomorrowKcal = calculateDayKcal(tomorrow, pIndex);
            if (tomorrowKcal > 0) {
                timeLaggedPairs.kcal.push({ quality: sleepQuality, value: tomorrowKcal });
            }
        }

        const correlations = {};
        let maxAbsCorr = 0;
        let keyMetric = null;
        let keyPValue = 1;
        let keyIsSignificant = false;
        let keyEffectSize = null;

        for (const [metric, pairs] of Object.entries(timeLaggedPairs)) {
            if (pairs.length < 1) continue;

            const qualityArr = pairs.map(p => p.quality);
            const valueArr = pairs.map(p => p.value);

            // v3.5.0 rollout: detect outliers and align pairs
            const qualityOutlierCheck = detectOutliers(qualityArr);
            const valueOutlierCheck = detectOutliers(valueArr);
            const outlierIndices = new Set([
                ...qualityOutlierCheck.indices,
                ...valueOutlierCheck.indices
            ]);

            const cleanQuality = [];
            const cleanValues = [];
            for (let i = 0; i < qualityArr.length; i++) {
                if (!outlierIndices.has(i)) {
                    cleanQuality.push(qualityArr[i]);
                    cleanValues.push(valueArr[i]);
                }
            }

            const corrResult = cleanQuality.length >= 2
                ? pearsonWithSignificance(cleanQuality, cleanValues)
                : { r: 0, pValue: 1, isSignificant: false, effectSize: 'insufficient_data', n: cleanQuality.length };
            const bayesResult = cleanQuality.length >= 2
                ? bayesianCorrelation(cleanQuality, cleanValues, 0, 8)
                : { posteriorR: corrResult.r, observedR: corrResult.r, shrinkage: 0 };
            const ci = cleanQuality.length >= 4
                ? confidenceIntervalForCorrelation(corrResult.r, cleanQuality.length)
                : { lower: -1, upper: 1, width: 2 };

            correlations[metric] = {
                correlation: corrResult.r,
                bayesianR: bayesResult.posteriorR,
                pValue: corrResult.pValue,
                isSignificant: corrResult.isSignificant,
                effectSize: corrResult.effectSize,
                confidenceInterval: {
                    lower: Math.round(ci.lower * 100) / 100,
                    upper: Math.round(ci.upper * 100) / 100,
                    width: Math.round(ci.width * 100) / 100
                },
                outlierStats: {
                    qualityOutliers: qualityOutlierCheck.outliers.length,
                    valueOutliers: valueOutlierCheck.outliers.length,
                    cleanedN: cleanQuality.length,
                    rawN: pairs.length
                },
                dataPoints: cleanQuality.length,
                avgQuality: average(cleanQuality),
                avgValue: average(cleanValues)
            };

            // Choose most significant metric (lowest p-value + highest |r|)
            if (corrResult.isSignificant && Math.abs(bayesResult.posteriorR) >= 0.3) {
                if (!keyMetric || corrResult.pValue < keyPValue ||
                    (corrResult.pValue === keyPValue && Math.abs(bayesResult.posteriorR) > maxAbsCorr)) {
                    maxAbsCorr = Math.abs(bayesResult.posteriorR);
                    keyMetric = metric;
                    keyPValue = corrResult.pValue;
                    keyIsSignificant = true;
                    keyEffectSize = corrResult.effectSize;
                }
            }
        }

        const bestDataPoints = Object.values(correlations).reduce((max, item) => {
            return Math.max(max, Number(item?.dataPoints) || 0);
        }, 0);

        if (!keyMetric) {
            const hasLagData = bestDataPoints > 0;
            return {
                pattern: PATTERNS.SLEEP_QUALITY,
                available: true,
                correlations,
                dataPoints: hasLagData ? bestDataPoints : sleepQualityDays,
                score: 50,
                confidence: hasLagData ? 0.3 : 0.25,
                isPreliminary: hasLagData ? bestDataPoints < robustPairsRequired : true,
                requiredDataPoints: robustPairsRequired,
                insight: hasLagData
                    ? '–°–≤—è–∑—å –∫–∞—á–µ—Å—Ç–≤–∞ —Å–Ω–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö —Å–≤—è–∑–µ–π)'
                    : `üåô –ï—Å—Ç—å –æ—Ü–µ–Ω–∫–∏ —Å–Ω–∞ (${sleepQualityDays} –¥–Ω.), –Ω–æ –ø–æ–∫–∞ –º–∞–ª–æ –º–µ—Ç—Ä–∏–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π —Å–≤—è–∑–∏`
            };
        }

        const keyData = correlations[keyMetric];

        // Calculate confidence based on effect size and significance
        let confidence = 0.5;
        if (keyIsSignificant) {
            if (keyEffectSize === 'large') confidence = 0.9;
            else if (keyEffectSize === 'medium') confidence = 0.75;
            else if (keyEffectSize === 'small') confidence = 0.6;
        } else {
            confidence = keyData.dataPoints >= 14 ? 0.4 : 0.3;
        }

        const score = maxAbsCorr >= 0.5 ? 90 : maxAbsCorr >= 0.4 ? 75 : 60;

        const metricNames = {
            weight: '–≤–µ—Å',
            mood: '–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
            steps: '—à–∞–≥–∏',
            kcal: '–∫–∞–ª–æ—Ä–∏–∏'
        };

        let insight;
        if (keyData.isSignificant && keyData.bayesianR < -0.4) {
            insight = `üí§ –•–æ—Ä–æ—à–∏–π —Å–æ–Ω ‚Üí –Ω–∏–∂–µ ${metricNames[keyMetric]} –Ω–∞ —Å–ª–µ–¥. –¥–µ–Ω—å (r=${keyData.bayesianR.toFixed(2)}, p<${keyData.pValue < 0.01 ? '0.01' : '0.05'}, N=${keyData.dataPoints})`;
        } else if (keyData.isSignificant && keyData.bayesianR > 0.4) {
            insight = `‚ö†Ô∏è –ü–ª–æ—Ö–æ–π —Å–æ–Ω ‚Üí –≤—ã—à–µ ${metricNames[keyMetric]} –Ω–∞ —Å–ª–µ–¥. –¥–µ–Ω—å (r=${keyData.bayesianR.toFixed(2)}, p<${keyData.pValue < 0.01 ? '0.01' : '0.05'}, N=${keyData.dataPoints})`;
        } else {
            insight = `–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å —Å–Ω–∞ —Å ${metricNames[keyMetric]} (r=${keyData.bayesianR.toFixed(2)}, p=${keyData.pValue.toFixed(3)}, N=${keyData.dataPoints})`;
        }

        const ciPenalty = Math.min(0.1, (Number(keyData?.confidenceInterval?.width) || 2) / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        return {
            pattern: PATTERNS.SLEEP_QUALITY,
            available: true,
            keyMetric,
            correlation: keyData.correlation,
            bayesianR: Math.round(keyData.bayesianR * 100) / 100,
            pValue: keyData.pValue,
            isSignificant: keyData.isSignificant,
            effectSize: keyData.effectSize,
            confidenceInterval: keyData.confidenceInterval,
            outlierStats: keyData.outlierStats,
            correlations,
            dataPoints: keyData.dataPoints,
            score,
            confidence: Math.round(confidence * 100) / 100,
            isPreliminary: keyData.dataPoints < robustPairsRequired,
            requiredDataPoints: robustPairsRequired,
            insight: keyData.dataPoints < robustPairsRequired
                ? `${insight}. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: ${keyData.dataPoints}/${robustPairsRequired} –ø–∞—Ä`
                : insight
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeSleepWeight = analyzeSleepWeight;
    HEYS.InsightsPI.patternModules.analyzeSleepHunger = analyzeSleepHunger;
    HEYS.InsightsPI.patternModules.analyzeSleepQuality = analyzeSleepQuality;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/psychology.js ===== */
// insights/patterns/psychology.js ‚Äî Modular psychology analyzers (v6.6.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const piCalculations = HEYS.InsightsPI?.calculations || global.piCalculations || {};

    const CONFIG = piConst.CONFIG || {
        MIN_DAYS_FOR_FULL_ANALYSIS: 7,
        MIN_CORRELATION_DISPLAY: 0.35
    };

    const PATTERNS = piConst.PATTERNS || {
        STRESS_EATING: 'stress_eating',
        MOOD_FOOD: 'mood_food',
        MOOD_TRAJECTORY: 'mood_trajectory'
    };

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + (Number(value) || 0), 0) / arr.length;
    };

    const pearsonCorrelation = piStats.pearsonCorrelation || function (x, y) {
        if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length < 2) return 0;
        const n = x.length;
        const xMean = average(x);
        const yMean = average(y);
        let numerator = 0;
        let xDen = 0;
        let yDen = 0;
        for (let i = 0; i < n; i++) {
            const dx = (Number(x[i]) || 0) - xMean;
            const dy = (Number(y[i]) || 0) - yMean;
            numerator += dx * dy;
            xDen += dx * dx;
            yDen += dy * dy;
        }
        const denominator = Math.sqrt(xDen * yDen);
        return denominator === 0 ? 0 : numerator / denominator;
    };

    const pearsonWithSignificance = piStats.pearsonWithSignificance || function (x, y, alpha = 0.05) {
        // Fallback if piStats not loaded
        const r = pearsonCorrelation(x, y);
        return {
            r,
            pValue: 1,
            isSignificant: false,
            n: x.length,
            df: x.length - 2,
            tStat: 0,
            effectSize: 'unknown',
            interpretation: 'pearsonWithSignificance not available',
            warning: 'fallback_mode'
        };
    };

    const bayesianCorrelation = piStats.bayesianCorrelation || function (x, y, priorR = 0, priorN = 10) {
        const r = pearsonCorrelation(x, y);
        return { posteriorR: r, observedR: r, shrinkage: 0, effectiveN: x.length, confidence: 0.5 };
    };

    const confidenceIntervalForCorrelation = piStats.confidenceIntervalForCorrelation || function (r, n, confidenceLevel = 0.95) {
        return { lower: Math.max(-1, r - 0.5), upper: Math.min(1, r + 0.5), margin: 0.5, width: 1.0, r, n };
    };

    const detectOutliers = piStats.detectOutliers || function (arr, iqrMultiplier = 1.5) {
        return { outliers: [], cleaned: arr.slice(), indices: [], stats: null };
    };

    const calculateDayKcal = piCalculations.calculateDayKcal || function (day, pIndex) {
        const savedKcal = Number(day?.savedEatenKcal);
        if (Number.isFinite(savedKcal) && savedKcal > 0) return savedKcal;
        if (!day?.meals?.length) return 0;
        let total = 0;
        for (const meal of day.meals) {
            for (const item of (meal.items || [])) {
                const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
                if (!prod || !item.grams) continue;
                const p = prod.protein100 || 0;
                const c = (prod.simple100 || 0) + (prod.complex100 || 0);
                const f = (prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0);
                total += (p * 3 + c * 4 + f * 9) * item.grams / 100;
            }
        }
        return total;
    };

    /**
     * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å—Ç—Ä–µ—Å—Å–∞ –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeStressEating(days, pIndex) {
        const pairs = [];

        for (const day of days) {
            const stress = day.stressAvg || (day.meals && average(day.meals.filter(m => m.stress).map(m => m.stress)));
            const dayKcal = calculateDayKcal(day, pIndex);

            if (stress && dayKcal > 0) {
                pairs.push({ stress, kcal: dayKcal, date: day.date });
            }
        }

        if (pairs.length < 7) {
            return {
                pattern: PATTERNS.STRESS_EATING,
                available: false,
                reason: 'no_stress_data',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç—Ä–µ—Å—Å–µ'
            };
        }

        const stressArr = pairs.map(p => p.stress);
        const kcalArr = pairs.map(p => p.kcal);
        const stressOutlierCheck = detectOutliers(stressArr);
        const kcalOutlierCheck = detectOutliers(kcalArr);
        const outlierIndices = new Set([
            ...stressOutlierCheck.indices,
            ...kcalOutlierCheck.indices
        ]);

        const cleanStress = [];
        const cleanKcal = [];
        for (let i = 0; i < stressArr.length; i++) {
            if (!outlierIndices.has(i)) {
                cleanStress.push(stressArr[i]);
                cleanKcal.push(kcalArr[i]);
            }
        }

        if (cleanStress.length < 7) {
            return {
                pattern: PATTERNS.STRESS_EATING,
                available: false,
                reason: 'insufficient_after_outliers',
                confidence: 0.2,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (${cleanStress.length}/7)`
            };
        }

        const corrResult = pearsonWithSignificance(cleanStress, cleanKcal);
        const bayesResult = bayesianCorrelation(cleanStress, cleanKcal, 0.1, 6);
        const ci = confidenceIntervalForCorrelation(corrResult.r, cleanStress.length);

        const avgStress = average(cleanStress);
        const score = Math.round(50 - bayesResult.posteriorR * 50);

        // Calculate confidence based on effect size and significance
        let confidence = 0.5;
        if (corrResult.isSignificant) {
            if (corrResult.effectSize === 'large') confidence = 0.9;
            else if (corrResult.effectSize === 'medium') confidence = 0.75;
            else if (corrResult.effectSize === 'small') confidence = 0.6;
        } else {
            confidence = 0.3;
        }

        const ciPenalty = Math.min(0.1, ci.width / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        let insight;
        const r = bayesResult.posteriorR;
        if (!corrResult.isSignificant) {
            insight = `–°–≤—è–∑—å —Å—Ç—Ä–µ—Å—Å–∞ –∏ –µ–¥—ã –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (N=${corrResult.n}, p=${corrResult.pValue.toFixed(3)}, 95% CI [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}])`;
        } else if (r > 0.3) {
            insight = `üò∞ –°—Ç—Ä–µ—Å—Å ‚Üí –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ! –ü—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ ‚âà +${Math.round(r * 300)} –∫–∫–∞–ª (p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n})`;
        } else if (r < -0.3) {
            insight = `üí™ –°—Ç—Ä–µ—Å—Å –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–ø–ø–µ—Ç–∏—Ç ‚Äî –æ—Ç–ª–∏—á–Ω–æ! (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'})`;
        } else {
            insight = `–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å —Å—Ç—Ä–µ—Å—Å–∞ –∏ –∞–ø–ø–µ—Ç–∏—Ç–∞ (r=${r.toFixed(2)}, p=${corrResult.pValue.toFixed(3)}, N=${corrResult.n})`;
        }

        return {
            pattern: PATTERNS.STRESS_EATING,
            available: true,
            correlation: Math.round(corrResult.r * 100) / 100,
            bayesianR: Math.round(bayesResult.posteriorR * 100) / 100,
            pValue: corrResult.pValue,
            isSignificant: corrResult.isSignificant,
            effectSize: corrResult.effectSize,
            confidenceInterval: {
                lower: Math.round(ci.lower * 100) / 100,
                upper: Math.round(ci.upper * 100) / 100,
                width: Math.round(ci.width * 100) / 100
            },
            outlierStats: {
                stressOutliers: stressOutlierCheck.outliers.length,
                kcalOutliers: kcalOutlierCheck.outliers.length,
                cleanedN: cleanStress.length,
                rawN: pairs.length
            },
            avgStress: Math.round(avgStress * 10) / 10,
            dataPoints: cleanStress.length,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –µ–¥—ã.
     * @param {Array} days
     * @param {object} pIndex
     * @param {object} optimum
     * @returns {object}
     */
    function analyzeMoodFood(days, pIndex, optimum) {
        const getMealQualityScore = HEYS.getMealQualityScore
            || HEYS.mealScoring?.getMealQualityScore;
        if (!getMealQualityScore) {
            return {
                pattern: PATTERNS.MOOD_FOOD,
                available: false,
                reason: 'no_quality_function',
                insight: '–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—ë–º–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'
            };
        }

        const pairs = [];

        for (const day of days) {
            const mood = day.moodAvg || (day.meals && average(day.meals.filter(m => m.mood).map(m => m.mood)));

            if (!mood || !day.meals || day.meals.length === 0) continue;

            const scores = day.meals.map(meal => {
                try {
                    const quality = getMealQualityScore(meal, meal.name || '–ü—Ä–∏—ë–º', optimum, pIndex);
                    return quality?.score || 0;
                } catch (_error) {
                    return 0;
                }
            }).filter(s => s > 0);

            if (scores.length > 0) {
                pairs.push({ mood, quality: average(scores), date: day.date });
            }
        }

        if (pairs.length < 7) {
            return {
                pattern: PATTERNS.MOOD_FOOD,
                available: false,
                reason: 'no_mood_data',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏'
            };
        }

        const moodArr = pairs.map(p => p.mood);
        const qualityArr = pairs.map(p => p.quality);
        const moodOutlierCheck = detectOutliers(moodArr);
        const qualityOutlierCheck = detectOutliers(qualityArr);
        const outlierIndices = new Set([
            ...moodOutlierCheck.indices,
            ...qualityOutlierCheck.indices
        ]);

        const cleanMood = [];
        const cleanQuality = [];
        for (let i = 0; i < moodArr.length; i++) {
            if (!outlierIndices.has(i)) {
                cleanMood.push(moodArr[i]);
                cleanQuality.push(qualityArr[i]);
            }
        }

        if (cleanMood.length < 7) {
            return {
                pattern: PATTERNS.MOOD_FOOD,
                available: false,
                reason: 'insufficient_after_outliers',
                confidence: 0.2,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (${cleanMood.length}/7)`
            };
        }

        const corrResult = pearsonWithSignificance(cleanMood, cleanQuality);
        const bayesResult = bayesianCorrelation(cleanMood, cleanQuality, 0.1, 6);
        const ci = confidenceIntervalForCorrelation(corrResult.r, cleanMood.length);

        const avgMood = average(cleanMood);
        const avgQuality = average(cleanQuality);
        const score = Math.round(avgQuality);

        let insight;
        const r = bayesResult.posteriorR;
        if (!corrResult.isSignificant) {
            insight = `–°–≤—è–∑—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –µ–¥—ã –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (N=${corrResult.n}, p=${corrResult.pValue.toFixed(3)}, 95% CI [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}])`;
        } else if (r > 0.3) {
            insight = `üòä –•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Üí –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ –µ–¥–∞! –ë–µ—Ä–µ–≥–∏ —Å–µ–±—è (p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n})`;
        } else if (r < -0.3) {
            insight = `ü§î –ü—Ä–∏ –ø–ª–æ—Ö–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –µ—à—å –ª—É—á—à–µ ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –∑–∞–±–æ—Ç—ã? (p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n})`;
        } else {
            insight = `–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –ø–∏—Ç–∞–Ω–∏—è (r=${r.toFixed(2)}, p=${corrResult.pValue.toFixed(3)}, N=${corrResult.n})`;
        }

        // Calculate confidence based on effect size and significance
        let confidence = 0.5;
        if (corrResult.isSignificant) {
            if (corrResult.effectSize === 'large') confidence = 0.9;
            else if (corrResult.effectSize === 'medium') confidence = 0.75;
            else if (corrResult.effectSize === 'small') confidence = 0.6;
        } else {
            confidence = 0.3;
        }

        const ciPenalty = Math.min(0.1, ci.width / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        return {
            pattern: PATTERNS.MOOD_FOOD,
            available: true,
            correlation: Math.round(corrResult.r * 100) / 100,
            bayesianR: Math.round(bayesResult.posteriorR * 100) / 100,
            pValue: corrResult.pValue,
            isSignificant: corrResult.isSignificant,
            effectSize: corrResult.effectSize,
            confidenceInterval: {
                lower: Math.round(ci.lower * 100) / 100,
                upper: Math.round(ci.upper * 100) / 100,
                width: Math.round(ci.width * 100) / 100
            },
            outlierStats: {
                moodOutliers: moodOutlierCheck.outliers.length,
                qualityOutliers: qualityOutlierCheck.outliers.length,
                cleanedN: cleanMood.length,
                rawN: pairs.length
            },
            avgMood: Math.round(avgMood * 10) / 10,
            avgQuality: Math.round(avgQuality),
            dataPoints: cleanMood.length,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * C6: Mood Trajectory ‚Äî –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ vs —Å–æ—Å—Ç–∞–≤ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeMoodTrajectory(days, pIndex) {
        const moodArr = [];
        const simpleArr = [];
        const proteinArr = [];

        for (const day of days) {
            if (!day.meals) continue;

            for (const meal of day.meals) {
                if (meal.mood == null || !meal.items) continue;
                const moodValue = Number(meal.mood);
                if (!Number.isFinite(moodValue)) continue;

                let mealProtein = 0;
                let mealCarbs = 0;
                let mealSimple = 0;
                let mealKcal = 0;

                for (const item of meal.items) {
                    const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
                    if (!prod || !item.grams) continue;

                    const p = prod.protein100 || 0;
                    const simple = prod.simple100 || 0;
                    const complex = prod.complex100 || 0;
                    const carbs = simple + complex;
                    const fat = (prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0);

                    mealProtein += p * item.grams / 100;
                    mealCarbs += carbs * item.grams / 100;
                    mealSimple += simple * item.grams / 100;
                    mealKcal += (p * 3 + carbs * 4 + fat * 9) * item.grams / 100;
                }

                if (mealKcal <= 0) continue;

                const simplePct = mealCarbs > 0 ? (mealSimple / mealCarbs) * 100 : 0;
                const proteinPct = (mealProtein * 3 / mealKcal) * 100;

                moodArr.push(moodValue);
                simpleArr.push(simplePct);
                proteinArr.push(proteinPct);
            }
        }

        if (moodArr.length < 7) {
            return {
                pattern: PATTERNS.MOOD_TRAJECTORY,
                available: false,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ –ø—Ä–∏—ë–º–∞–º'
            };
        }

        const simpleOutlierCheck = detectOutliers(simpleArr);
        const proteinOutlierCheck = detectOutliers(proteinArr);
        const moodOutlierCheck = detectOutliers(moodArr);

        const outlierIndicesSimple = new Set([
            ...simpleOutlierCheck.indices,
            ...moodOutlierCheck.indices
        ]);
        const outlierIndicesProtein = new Set([
            ...proteinOutlierCheck.indices,
            ...moodOutlierCheck.indices
        ]);

        const cleanSimple = [];
        const cleanMoodForSimple = [];
        const cleanProtein = [];
        const cleanMoodForProtein = [];

        for (let i = 0; i < moodArr.length; i++) {
            if (!outlierIndicesSimple.has(i)) {
                cleanSimple.push(simpleArr[i]);
                cleanMoodForSimple.push(moodArr[i]);
            }
            if (!outlierIndicesProtein.has(i)) {
                cleanProtein.push(proteinArr[i]);
                cleanMoodForProtein.push(moodArr[i]);
            }
        }

        if (cleanSimple.length < 7 && cleanProtein.length < 7) {
            return {
                pattern: PATTERNS.MOOD_TRAJECTORY,
                available: false,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (simple=${cleanSimple.length}, protein=${cleanProtein.length})`
            };
        }

        const simpleCorrResult = cleanSimple.length >= 7
            ? pearsonWithSignificance(cleanSimple, cleanMoodForSimple)
            : { r: 0, pValue: 1, isSignificant: false, effectSize: 'insufficient_data', n: cleanSimple.length };
        const proteinCorrResult = cleanProtein.length >= 7
            ? pearsonWithSignificance(cleanProtein, cleanMoodForProtein)
            : { r: 0, pValue: 1, isSignificant: false, effectSize: 'insufficient_data', n: cleanProtein.length };
        const simpleBayes = cleanSimple.length >= 7
            ? bayesianCorrelation(cleanSimple, cleanMoodForSimple, -0.1, 6)
            : { posteriorR: simpleCorrResult.r };
        const proteinBayes = cleanProtein.length >= 7
            ? bayesianCorrelation(cleanProtein, cleanMoodForProtein, 0.1, 6)
            : { posteriorR: proteinCorrResult.r };
        const simpleCI = cleanSimple.length >= 7
            ? confidenceIntervalForCorrelation(simpleCorrResult.r, cleanSimple.length)
            : { lower: -1, upper: 1, width: 2 };
        const proteinCI = cleanProtein.length >= 7
            ? confidenceIntervalForCorrelation(proteinCorrResult.r, cleanProtein.length)
            : { lower: -1, upper: 1, width: 2 };

        const safeR = (v) => Number.isFinite(v) ? v : 0;
        const safeP = (v) => Number.isFinite(v) ? v : 1;

        let insight;
        let score = 60;
        let primaryCorr = null;
        let primaryPValue = null;
        let primaryIsSignificant = false;
        let primaryEffectSize = null;

        if (simpleCorrResult.isSignificant && simpleBayes.posteriorR < -0.3) {
            insight = `üòï –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ (r=${simpleBayes.posteriorR.toFixed(2)}, p<${simpleCorrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${simpleCorrResult.n})`;
            score = 40;
            primaryCorr = simpleBayes.posteriorR;
            primaryPValue = simpleCorrResult.pValue;
            primaryIsSignificant = true;
            primaryEffectSize = simpleCorrResult.effectSize;
        } else if (proteinCorrResult.isSignificant && proteinBayes.posteriorR > 0.3) {
            insight = `üòä –ë–µ–ª–æ–∫ —É–ª—É—á—à–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (r=${proteinBayes.posteriorR.toFixed(2)}, p<${proteinCorrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${proteinCorrResult.n})`;
            score = 80;
            primaryCorr = proteinBayes.posteriorR;
            primaryPValue = proteinCorrResult.pValue;
            primaryIsSignificant = true;
            primaryEffectSize = proteinCorrResult.effectSize;
        } else {
            insight = `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –ø—Ä–∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–∞—Ö (simple: r=${safeR(simpleBayes.posteriorR).toFixed(2)}, p=${safeP(simpleCorrResult.pValue).toFixed(3)}; protein: r=${safeR(proteinBayes.posteriorR).toFixed(2)}, p=${safeP(proteinCorrResult.pValue).toFixed(3)})`;
            // Take the more significant one as primary
            if (simpleCorrResult.pValue < proteinCorrResult.pValue) {
                primaryCorr = simpleBayes.posteriorR;
                primaryPValue = simpleCorrResult.pValue;
                primaryIsSignificant = simpleCorrResult.isSignificant;
                primaryEffectSize = simpleCorrResult.effectSize;
            } else {
                primaryCorr = proteinBayes.posteriorR;
                primaryPValue = proteinCorrResult.pValue;
                primaryIsSignificant = proteinCorrResult.isSignificant;
                primaryEffectSize = proteinCorrResult.effectSize;
            }
        }

        // Calculate confidence based on primary correlation's effect size
        let confidence = 0.5;
        if (primaryIsSignificant) {
            if (primaryEffectSize === 'large') confidence = 0.9;
            else if (primaryEffectSize === 'medium') confidence = 0.75;
            else if (primaryEffectSize === 'small') confidence = 0.6;
        } else {
            confidence = moodArr.length >= 14 ? 0.4 : 0.3;
        }

        const primaryCIWidth = simpleCorrResult.pValue <= proteinCorrResult.pValue
            ? simpleCI.width
            : proteinCI.width;
        const ciPenalty = Math.min(0.1, (Number(primaryCIWidth) || 2) / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        return {
            pattern: PATTERNS.MOOD_TRAJECTORY,
            available: true,
            score,
            dataPoints: Math.max(cleanSimple.length, cleanProtein.length),
            correlation: primaryCorr,
            pValue: primaryPValue,
            isSignificant: primaryIsSignificant,
            effectSize: primaryEffectSize,
            confidenceInterval: {
                simple: {
                    lower: Math.round(simpleCI.lower * 100) / 100,
                    upper: Math.round(simpleCI.upper * 100) / 100,
                    width: Math.round(simpleCI.width * 100) / 100
                },
                protein: {
                    lower: Math.round(proteinCI.lower * 100) / 100,
                    upper: Math.round(proteinCI.upper * 100) / 100,
                    width: Math.round(proteinCI.width * 100) / 100
                }
            },
            outlierStats: {
                moodOutliers: moodOutlierCheck.outliers.length,
                simpleOutliers: simpleOutlierCheck.outliers.length,
                proteinOutliers: proteinOutlierCheck.outliers.length,
                cleanedSimpleN: cleanSimple.length,
                cleanedProteinN: cleanProtein.length,
                rawN: moodArr.length
            },
            simpleCorr: Math.round(simpleCorrResult.r * 100) / 100,
            proteinCorr: Math.round(proteinCorrResult.r * 100) / 100,
            simpleBayesianR: Math.round(simpleBayes.posteriorR * 100) / 100,
            proteinBayesianR: Math.round(proteinBayes.posteriorR * 100) / 100,
            confidence: Math.round(confidence * 100) / 100,
            insight,
            debug: {
                formula: 'corr(mood, simple%) vs corr(mood, protein%)',
                simplePValue: simpleCorrResult.pValue,
                proteinPValue: proteinCorrResult.pValue
            }
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeStressEating = analyzeStressEating;
    HEYS.InsightsPI.patternModules.analyzeMoodFood = analyzeMoodFood;
    HEYS.InsightsPI.patternModules.analyzeMoodTrajectory = analyzeMoodTrajectory;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/activity.js ===== */
// insights/patterns/activity.js ‚Äî Modular activity analyzers (v6.8.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const piCalculations = HEYS.InsightsPI?.calculations || global.piCalculations || {};

    const CONFIG = piConst.CONFIG || {
        MIN_DAYS_FOR_FULL_ANALYSIS: 7,
        MIN_CORRELATION_DISPLAY: 0.35
    };

    const PATTERNS = piConst.PATTERNS || {
        TRAINING_KCAL: 'training_kcal',
        STEPS_WEIGHT: 'steps_weight',
        NEAT_ACTIVITY: 'neat_activity',
        TRAINING_RECOVERY: 'training_recovery'
    };

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + (Number(value) || 0), 0) / arr.length;
    };

    const pearsonCorrelation = piStats.pearsonCorrelation || function (x, y) {
        if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length < 2) return 0;
        const n = x.length;
        const xMean = average(x);
        const yMean = average(y);
        let numerator = 0;
        let xDen = 0;
        let yDen = 0;
        for (let i = 0; i < n; i++) {
            const dx = (Number(x[i]) || 0) - xMean;
            const dy = (Number(y[i]) || 0) - yMean;
            numerator += dx * dy;
            xDen += dx * dx;
            yDen += dy * dy;
        }
        const denominator = Math.sqrt(xDen * yDen);
        return denominator === 0 ? 0 : numerator / denominator;
    };

    const pearsonWithSignificance = piStats.pearsonWithSignificance || function (x, y, alpha = 0.05) {
        // Fallback if piStats not loaded
        const r = pearsonCorrelation(x, y);
        return {
            r,
            pValue: 1,
            isSignificant: false,
            n: x.length,
            df: x.length - 2,
            tStat: 0,
            effectSize: 'unknown',
            interpretation: 'pearsonWithSignificance not available',
            warning: 'fallback_mode'
        };
    };

    const bayesianCorrelation = piStats.bayesianCorrelation || function (x, y, priorR = 0, priorN = 10) {
        const r = pearsonCorrelation(x, y);
        return { posteriorR: r, observedR: r, shrinkage: 0, effectiveN: x.length, confidence: 0.5 };
    };

    const confidenceIntervalForCorrelation = piStats.confidenceIntervalForCorrelation || function (r, n, confidenceLevel = 0.95) {
        return { lower: Math.max(-1, r - 0.5), upper: Math.min(1, r + 0.5), margin: 0.5, width: 1.0, r, n };
    };

    const detectOutliers = piStats.detectOutliers || function (arr, iqrMultiplier = 1.5) {
        return { outliers: [], cleaned: arr.slice(), indices: [], stats: null };
    };

    const calculateTrend = piStats.calculateTrend || function (values) {
        if (!Array.isArray(values) || values.length < 2) return 0;
        const n = values.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        for (let i = 0; i < n; i++) {
            const y = Number(values[i]) || 0;
            sumX += i;
            sumY += y;
            sumXY += i * y;
            sumX2 += i * i;
        }
        const denominator = (n * sumX2 - sumX * sumX);
        if (!denominator) return 0;
        return (n * sumXY - sumX * sumY) / denominator;
    };

    const calculateItemKcal = piCalculations.calculateItemKcal || function (item, pIndex) {
        if (!item || !item.grams) return 0;
        const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
        if (!prod) return 0;
        const p = prod.protein100 || 0;
        const c = (prod.simple100 || 0) + (prod.complex100 || 0);
        const f = (prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0);
        return (p * 3 + c * 4 + f * 9) * item.grams / 100;
    };

    const calculateDayKcal = piCalculations.calculateDayKcal || function (day, pIndex) {
        const savedKcal = Number(day?.savedEatenKcal);
        if (Number.isFinite(savedKcal) && savedKcal > 0) return savedKcal;
        if (!day?.meals?.length) return 0;
        let total = 0;
        for (const meal of day.meals) {
            for (const item of (meal.items || [])) {
                total += calculateItemKcal(item, pIndex);
            }
        }
        return total;
    };

    /**
     * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –∫–∞–ª–æ—Ä–∏–π.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeTrainingKcal(days, pIndex) {
        const trainingDays = [];
        const restDays = [];

        for (const day of days) {
            const dayKcal = calculateDayKcal(day, pIndex);
            if (dayKcal === 0) continue;

            const hasTraining = day.trainings && day.trainings.length > 0;
            if (hasTraining) {
                trainingDays.push(dayKcal);
            } else {
                restDays.push(dayKcal);
            }
        }

        if (trainingDays.length < 3 || restDays.length < 3) {
            return {
                pattern: PATTERNS.TRAINING_KCAL,
                available: false,
                reason: 'no_training',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö'
            };
        }

        const avgTraining = average(trainingDays);
        const avgRest = average(restDays);
        const diff = avgTraining - avgRest;
        const diffPct = (diff / avgRest) * 100;

        const score = diffPct > 15 ? 60 : diffPct > 5 ? 80 : 100;

        let insight;
        if (diff > 200) {
            insight = `üèãÔ∏è –í –¥–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –µ—à—å –Ω–∞ ${Math.round(diff)} –∫–∫–∞–ª –±–æ–ª—å—à–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!`;
        } else if (diff < -200) {
            insight = '‚ö†Ô∏è –í –¥–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –µ—à—å –º–µ–Ω—å—à–µ ‚Äî –¥–æ–±–∞–≤—å –±–µ–ª–æ–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è';
        } else {
            insight = '–ö–∞–ª–æ—Ä–∏–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';
        }

        return {
            pattern: PATTERNS.TRAINING_KCAL,
            available: true,
            avgTrainingKcal: Math.round(avgTraining),
            avgRestKcal: Math.round(avgRest),
            diffKcal: Math.round(diff),
            diffPct: Math.round(diffPct),
            trainingDaysCount: trainingDays.length,
            restDaysCount: restDays.length,
            score,
            confidence: Math.min(trainingDays.length, restDays.length) >= 5 ? 0.8 : 0.5,
            insight
        };
    }

    /**
     * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —à–∞–≥–æ–≤ –∏ –≤–µ—Å–∞.
     * @param {Array} days
     * @returns {object}
     */
    function analyzeStepsWeight(days) {
        const pairs = [];
        const directDataDays = [];
        const robustPairsRequired = days.length >= 14 ? 7 : 4;

        for (const day of days) {
            if (day?.steps > 0 && day?.weightMorning) {
                directDataDays.push(day);
            }
        }

        for (let i = 1; i < days.length; i++) {
            const prevDay = days[i];
            const currDay = days[i - 1];

            if (prevDay.steps > 0 && currDay.weightMorning && prevDay.weightMorning) {
                const weightDelta = currDay.weightMorning - prevDay.weightMorning;
                pairs.push({
                    steps: prevDay.steps,
                    weightDelta,
                    date: prevDay.date
                });
            }
        }

        if (pairs.length === 0 && directDataDays.length === 0) {
            return {
                pattern: PATTERNS.STEPS_WEIGHT,
                available: false,
                reason: 'no_steps_data',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤ –∏ –≤–µ—Å–∞'
            };
        }

        if (pairs.length === 0 && directDataDays.length > 0) {
            const avgStepsDirect = average(directDataDays.map(d => Number(d.steps) || 0));
            const score = avgStepsDirect >= 8000 ? 70 : avgStepsDirect >= 5000 ? 60 : 50;

            return {
                pattern: PATTERNS.STEPS_WEIGHT,
                available: true,
                dataPoints: directDataDays.length,
                score,
                confidence: 0.25,
                isPreliminary: true,
                requiredDataPoints: 2,
                insight: `üë£ –ï—Å—Ç—å ${directDataDays.length} –¥–Ω. —Å —à–∞–≥–∞–º–∏ –∏ –≤–µ—Å–æ–º. –î–æ–±–∞–≤—å –µ—â—ë 1 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Å–≤—è–∑–∏ —Å –¥–∏–Ω–∞–º–∏–∫–æ–π –≤–µ—Å–∞`
            };
        }

        const stepsArr = pairs.map(p => p.steps);
        const deltaArr = pairs.map(p => p.weightDelta);

        const stepsOutlierCheck = detectOutliers(stepsArr);
        const deltaOutlierCheck = detectOutliers(deltaArr);
        const outlierIndices = new Set([
            ...stepsOutlierCheck.indices,
            ...deltaOutlierCheck.indices
        ]);

        const cleanSteps = [];
        const cleanDelta = [];
        for (let i = 0; i < stepsArr.length; i++) {
            if (!outlierIndices.has(i)) {
                cleanSteps.push(stepsArr[i]);
                cleanDelta.push(deltaArr[i]);
            }
        }

        if (cleanSteps.length < 2) {
            return {
                pattern: PATTERNS.STEPS_WEIGHT,
                available: false,
                reason: 'insufficient_after_outliers',
                confidence: 0.2,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (${cleanSteps.length}/2)`
            };
        }

        const corrResult = pearsonWithSignificance(cleanSteps, cleanDelta);
        const bayesResult = bayesianCorrelation(cleanSteps, cleanDelta, 0, 10);
        const ci = cleanSteps.length >= 4
            ? confidenceIntervalForCorrelation(corrResult.r, cleanSteps.length)
            : { lower: -1, upper: 1, width: 2 };

        const score = Math.round(50 + bayesResult.posteriorR * -50);
        const avgSteps = average(cleanSteps);

        let insight;
        const r = bayesResult.posteriorR;
        if (!corrResult.isSignificant || cleanSteps.length < 2) {
            insight = `–°–≤—è–∑—å —à–∞–≥–æ–≤ –∏ –≤–µ—Å–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (N=${cleanSteps.length}, p=${corrResult.pValue.toFixed(3)}, 95% CI [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}])`;
        } else if (r < -0.3) {
            insight = `üëü –ë–æ–ª—å—à–µ —à–∞–≥–æ–≤ ‚Üí –≤–µ—Å —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ! –ü—Ä–∏ ${Math.round(avgSteps)} —à–∞–≥–æ–≤/–¥–µ–Ω—å (p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n})`;
        } else if (r > 0.3) {
            insight = `–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ: –±–æ–ª—å—à–µ —Ö–æ–¥–∏—à—å, –Ω–æ –≤–µ—Å —Ä–∞—Å—Ç—ë—Ç. –ü—Ä–æ–≤–µ—Ä—å –∫–∞–ª–æ—Ä–∏–∏ (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'})`;
        } else {
            insight = `–£–º–µ—Ä–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ —à–∞–≥–æ–≤ –Ω–∞ –≤–µ—Å (r=${r.toFixed(2)}, p=${corrResult.pValue.toFixed(3)}, N=${corrResult.n})`;
        }

        const isPreliminary = cleanSteps.length < robustPairsRequired;

        // Calculate confidence based on effect size and significance
        let confidence = 0.5;
        if (corrResult.isSignificant && !isPreliminary) {
            if (corrResult.effectSize === 'large') confidence = 0.9;
            else if (corrResult.effectSize === 'medium') confidence = 0.75;
            else if (corrResult.effectSize === 'small') confidence = 0.6;
        } else if (isPreliminary) {
            confidence = 0.35;
        } else {
            confidence = 0.3;
        }

        const ciPenalty = Math.min(0.1, (Number(ci.width) || 2) / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        return {
            pattern: PATTERNS.STEPS_WEIGHT,
            available: true,
            correlation: Math.round(corrResult.r * 100) / 100,
            bayesianR: Math.round(bayesResult.posteriorR * 100) / 100,
            pValue: corrResult.pValue,
            isSignificant: corrResult.isSignificant,
            effectSize: corrResult.effectSize,
            confidenceInterval: {
                lower: Math.round(ci.lower * 100) / 100,
                upper: Math.round(ci.upper * 100) / 100,
                width: Math.round(ci.width * 100) / 100
            },
            outlierStats: {
                stepsOutliers: stepsOutlierCheck.outliers.length,
                deltaOutliers: deltaOutlierCheck.outliers.length,
                cleanedN: cleanSteps.length,
                rawN: pairs.length
            },
            avgSteps: Math.round(avgSteps),
            dataPoints: cleanSteps.length,
            score,
            confidence: Math.round(confidence * 100) / 100,
            isPreliminary,
            requiredDataPoints: robustPairsRequired,
            insight: isPreliminary
                ? `${insight}. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ: ${cleanSteps.length}/${robustPairsRequired} –ø–∞—Ä, —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç —Å –¥–∞–Ω–Ω—ã–º–∏`
                : insight
        };
    }

    /**
     * C4: NEAT Trend ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ç—Ä–µ–Ω–¥.
     * @param {Array} days
     * @returns {object}
     */
    function analyzeNEATTrend(days) {
        const neatData = [];

        for (const day of days) {
            const householdMin = Number(day.householdMin) || 0;
            const activities = Array.isArray(day.householdActivities) ? day.householdActivities : [];
            const activitiesMin = activities.reduce((sum, a) => sum + (Number(a.minutes) || 0), 0);
            const totalMin = householdMin > 0 ? householdMin : activitiesMin;

            if (totalMin > 0) {
                neatData.push({ date: day.date, minutes: totalMin });
            }
        }

        if (neatData.length < 3) {
            return {
                pattern: PATTERNS.NEAT_ACTIVITY,
                available: false,
                reason: 'no_household_data',
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'
            };
        }

        neatData.sort((a, b) => a.date.localeCompare(b.date));
        const minutesArr = neatData.map(d => d.minutes);
        const avgMinutes = average(minutesArr);
        const trend = calculateTrend(minutesArr);

        let score = avgMinutes >= 60 ? 100 : avgMinutes >= 40 ? 80 : avgMinutes >= 20 ? 60 : 40;
        if (trend > 1) score += 5;
        if (trend < -1) score -= 5;
        score = Math.max(0, Math.min(100, Math.round(score)));

        let insight;
        if (avgMinutes >= 60) {
            insight = 'üè° –û—Ç–ª–∏—á–Ω—ã–π NEAT: –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–∞—ë—Ç –æ—â—É—Ç–∏–º—ã–π —Ä–∞—Å—Ö–æ–¥';
        } else if (avgMinutes < 20) {
            insight = '‚ö†Ô∏è –ú–∞–ª–æ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –î–æ–±–∞–≤—å 20-30 –º–∏–Ω—É—Ç –¥–≤–∏–∂–µ–Ω–∏—è';
        } else if (trend > 1) {
            insight = 'üìà NEAT —Ä–∞—Å—Ç—ë—Ç ‚Äî —Ö–æ—Ä–æ—à–∞—è –¥–∏–Ω–∞–º–∏–∫–∞';
        } else if (trend < -1) {
            insight = 'üìâ NEAT —Å–Ω–∏–∂–∞–µ—Ç—Å—è ‚Äî –ø–æ–ø—Ä–æ–±—É–π —á–∞—â–µ –≤—Å—Ç–∞–≤–∞—Ç—å –∏ –¥–≤–∏–≥–∞—Ç—å—Å—è';
        } else {
            insight = 'NEAT —Å—Ç–∞–±–∏–ª–µ–Ω, –º–æ–∂–Ω–æ —á—É—Ç—å —É—Å–∏–ª–∏—Ç—å';
        }

        return {
            pattern: PATTERNS.NEAT_ACTIVITY,
            available: true,
            score,
            avgMinutes: Math.round(avgMinutes),
            trend: Math.round(trend * 100) / 100,
            dataPoints: neatData.length,
            confidence: neatData.length >= 7 ? 0.8 : 0.5,
            insight
        };
    }

    /**
     * C11: Training Intensity & Recovery.
     * @param {Array} days
     * @returns {object}
     */
    function analyzeTrainingRecovery(days) {
        if (!days || days.length < 5) {
            return { pattern: PATTERNS.TRAINING_RECOVERY, available: false };
        }

        const daysWithZones = days.filter(d => d.trainings?.some(t => t.z?.length >= 4));
        if (daysWithZones.length < 3) {
            return { pattern: PATTERNS.TRAINING_RECOVERY, available: false };
        }

        let highIntensityDays = 0;
        let consecutiveHighIntensity = 0;
        let maxConsecutive = 0;
        const recoveryScores = [];

        for (let i = 0; i < days.length; i++) {
            const day = days[i];
            const trainings = day.trainings || [];

            let totalMin = 0;
            let highMin = 0;
            for (const training of trainings) {
                if (!training.z || training.z.length < 4) continue;
                const [z1, z2, z3, z4] = training.z;
                totalMin += (z1 + z2 + z3 + z4);
                highMin += z4;
            }

            const highIntensityPct = totalMin > 0 ? (highMin / totalMin) * 100 : 0;
            const isHighIntensity = highIntensityPct >= 40;

            if (isHighIntensity) {
                highIntensityDays++;
                consecutiveHighIntensity++;
                maxConsecutive = Math.max(maxConsecutive, consecutiveHighIntensity);
            } else {
                consecutiveHighIntensity = 0;
            }

            if (i < days.length - 1) {
                const nextDay = days[i + 1];
                const sleepHours = nextDay.sleepHours || 0;
                const mood = nextDay.moodAvg || 3;
                const recoveryScore = (sleepHours >= 7 ? 50 : sleepHours * 7) + (mood * 10);
                recoveryScores.push(recoveryScore);
            }
        }

        const avgRecovery = recoveryScores.length > 0 ? average(recoveryScores) : 0;
        const overtrainingRisk = maxConsecutive >= 3 && avgRecovery < 60;

        let score = 100;
        if (overtrainingRisk) {
            score = 40;
        } else if (maxConsecutive >= 3) {
            score = 60;
        } else if (avgRecovery < 60) {
            score = 70;
        } else {
            score = 85;
        }

        let insight = '';
        if (overtrainingRisk) {
            insight = `‚ö†Ô∏è –†–∏—Å–∫ –ø–µ—Ä–µ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏! ${maxConsecutive} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤—ã—Å–æ–∫–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ + –ø–ª–æ—Ö–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ`;
        } else if (maxConsecutive >= 3) {
            insight = `üü° ${maxConsecutive} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Ç—è–∂—ë–ª—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –î–æ–±–∞–≤—å –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞`;
        } else if (avgRecovery < 60) {
            insight = `üü† –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–∞–±–æ–µ (${Math.round(avgRecovery)}/100). –ë–æ–ª—å—à–µ —Å–Ω–∞!`;
        } else {
            insight = `‚úÖ –ë–∞–ª–∞–Ω—Å –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª–µ–Ω (${Math.round(avgRecovery)}/100)`;
        }

        const confidence = daysWithZones.length >= 5 ? 0.80 : 0.65;

        return {
            pattern: PATTERNS.TRAINING_RECOVERY,
            available: true,
            highIntensityDays,
            maxConsecutive,
            avgRecovery: Math.round(avgRecovery),
            overtrainingRisk,
            dataPoints: daysWithZones.length,
            score,
            confidence,
            insight
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeTrainingKcal = analyzeTrainingKcal;
    HEYS.InsightsPI.patternModules.analyzeStepsWeight = analyzeStepsWeight;
    HEYS.InsightsPI.patternModules.analyzeNEATTrend = analyzeNEATTrend;
    HEYS.InsightsPI.patternModules.analyzeTrainingRecovery = analyzeTrainingRecovery;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/lifestyle.js ===== */
// insights/patterns/lifestyle.js ‚Äî Modular lifestyle analyzers (v6.9.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const piCalculations = HEYS.InsightsPI?.calculations || global.piCalculations || {};

    const CONFIG = piConst.CONFIG || {
        MIN_DAYS_FOR_FULL_ANALYSIS: 7,
        MIN_CORRELATION_DISPLAY: 0.35
    };

    const PATTERNS = piConst.PATTERNS || {
        WELLBEING_CORRELATION: 'wellbeing_correlation',
        HYDRATION: 'hydration',
        BODY_COMPOSITION: 'body_composition',
        CYCLE_IMPACT: 'cycle_impact',
        WEEKEND_EFFECT: 'weekend_effect'
    };

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + (Number(value) || 0), 0) / arr.length;
    };

    const pearsonCorrelation = piStats.pearsonCorrelation || function (x, y) {
        if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length < 2) return 0;
        const n = x.length;
        const xMean = average(x);
        const yMean = average(y);
        let numerator = 0;
        let xDen = 0;
        let yDen = 0;
        for (let i = 0; i < n; i++) {
            const dx = (Number(x[i]) || 0) - xMean;
            const dy = (Number(y[i]) || 0) - yMean;
            numerator += dx * dy;
            xDen += dx * dx;
            yDen += dy * dy;
        }
        const denominator = Math.sqrt(xDen * yDen);
        return denominator === 0 ? 0 : numerator / denominator;
    };

    const pearsonWithSignificance = piStats.pearsonWithSignificance || function (x, y, alpha = 0.05) {
        // Fallback if piStats not loaded
        const r = pearsonCorrelation(x, y);
        return {
            r,
            pValue: 1,
            isSignificant: false,
            n: x.length,
            df: x.length - 2,
            tStat: 0,
            effectSize: 'unknown',
            interpretation: 'pearsonWithSignificance not available',
            warning: 'fallback_mode'
        };
    };

    const bayesianCorrelation = piStats.bayesianCorrelation || function (x, y, priorR = 0, priorN = 10) {
        const r = pearsonCorrelation(x, y);
        return { posteriorR: r, observedR: r, shrinkage: 0, effectiveN: x.length, confidence: 0.5 };
    };

    const confidenceIntervalForCorrelation = piStats.confidenceIntervalForCorrelation || function (r, n, confidenceLevel = 0.95) {
        return { lower: Math.max(-1, r - 0.5), upper: Math.min(1, r + 0.5), margin: 0.5, width: 1.0, r, n };
    };

    const detectOutliers = piStats.detectOutliers || function (arr, iqrMultiplier = 1.5) {
        return { outliers: [], cleaned: arr.slice(), indices: [], stats: null };
    };

    const calculateTrend = piStats.calculateTrend || function (values) {
        if (!Array.isArray(values) || values.length < 2) return 0;
        const n = values.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        for (let i = 0; i < n; i++) {
            const y = Number(values[i]) || 0;
            sumX += i;
            sumY += y;
            sumXY += i * y;
            sumX2 += i * i;
        }
        const denominator = (n * sumX2 - sumX * sumX);
        if (!denominator) return 0;
        return (n * sumXY - sumX * sumY) / denominator;
    };

    const calculateItemKcal = piCalculations.calculateItemKcal || function (item, pIndex) {
        if (!item || !item.grams) return 0;
        const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
        if (!prod) return 0;
        const p = prod.protein100 || 0;
        const c = (prod.simple100 || 0) + (prod.complex100 || 0);
        const f = (prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0);
        return (p * 3 + c * 4 + f * 9) * item.grams / 100;
    };

    const calculateDayKcal = piCalculations.calculateDayKcal || function (day, pIndex) {
        const savedKcal = Number(day?.savedEatenKcal);
        if (Number.isFinite(savedKcal) && savedKcal > 0) return savedKcal;
        if (!day?.meals?.length) return 0;
        let total = 0;
        for (const meal of day.meals) {
            for (const item of (meal.items || [])) {
                total += calculateItemKcal(item, pIndex);
            }
        }
        return total;
    };

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å —á–∞—Å—ã —Å–Ω–∞ –∏–∑ –≤—Ä–µ–º—ë–Ω.
     * @param {string} start
     * @param {string} end
     * @returns {number|null}
     */
    function calculateSleepHours(start, end) {
        if (!start || !end) return null;

        const [startH, startM] = String(start).split(':').map(Number);
        const [endH, endM] = String(end).split(':').map(Number);

        let startMin = (startH || 0) * 60 + (startM || 0);
        let endMin = (endH || 0) * 60 + (endM || 0);

        if (startMin > endMin) {
            endMin += 24 * 60;
        }

        return (endMin - startMin) / 60;
    }

    /**
     * B2: Wellbeing Correlation ‚Äî —á—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeWellbeing(days, pIndex) {
        const correlations = {
            sleepQuality: { pairs: [] },
            sleepHours: { pairs: [] },
            steps: { pairs: [] },
            protein: { pairs: [] },
            kcal: { pairs: [] }
        };

        for (const day of days) {
            const wellbeing = day.wellbeingAvg;
            if (!wellbeing) continue;

            if (day.sleepQuality) {
                correlations.sleepQuality.pairs.push({ wellbeing, value: day.sleepQuality });
            }

            const sleepHours = day.sleepHours || (day.sleepStart && day.sleepEnd
                ? calculateSleepHours(day.sleepStart, day.sleepEnd)
                : null);
            if (sleepHours) {
                correlations.sleepHours.pairs.push({ wellbeing, value: sleepHours });
            }

            if (day.steps) {
                correlations.steps.pairs.push({ wellbeing, value: day.steps });
            }

            if (day.meals && day.meals.length > 0) {
                let dayProtein = 0;
                const dayKcal = calculateDayKcal(day, pIndex);

                for (const meal of day.meals) {
                    if (!meal.items) continue;
                    for (const item of meal.items) {
                        const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
                        if (prod && item.grams) {
                            dayProtein += (prod.protein100 || 0) * item.grams / 100;
                        }
                    }
                }

                if (dayProtein > 0) {
                    correlations.protein.pairs.push({ wellbeing, value: dayProtein });
                }
                if (dayKcal > 0) {
                    correlations.kcal.pairs.push({ wellbeing, value: dayKcal });
                }
            }
        }

        const results = {};
        let maxAbsCorr = 0;
        let keyFactor = null;
        let keyPValue = 1;
        let keyIsSignificant = false;
        let keyEffectSize = null;

        for (const [factor, data] of Object.entries(correlations)) {
            if (data.pairs.length < 7) continue;

            const wellbeingArr = data.pairs.map(p => p.wellbeing);
            const valueArr = data.pairs.map(p => p.value);
            const wellbeingOutlierCheck = detectOutliers(wellbeingArr);
            const valueOutlierCheck = detectOutliers(valueArr);
            const outlierIndices = new Set([
                ...wellbeingOutlierCheck.indices,
                ...valueOutlierCheck.indices
            ]);

            const cleanWellbeing = [];
            const cleanValues = [];
            for (let i = 0; i < wellbeingArr.length; i++) {
                if (!outlierIndices.has(i)) {
                    cleanWellbeing.push(wellbeingArr[i]);
                    cleanValues.push(valueArr[i]);
                }
            }

            if (cleanWellbeing.length < 7) continue;

            const corrResult = pearsonWithSignificance(cleanWellbeing, cleanValues);
            const priorMean = factor === 'kcal' ? -0.1 : 0.1;
            const bayesResult = bayesianCorrelation(cleanWellbeing, cleanValues, priorMean, 6);
            const ci = confidenceIntervalForCorrelation(corrResult.r, cleanWellbeing.length);

            results[factor] = {
                correlation: corrResult.r,
                bayesianR: bayesResult.posteriorR,
                pValue: corrResult.pValue,
                isSignificant: corrResult.isSignificant,
                effectSize: corrResult.effectSize,
                confidenceInterval: {
                    lower: Math.round(ci.lower * 100) / 100,
                    upper: Math.round(ci.upper * 100) / 100,
                    width: Math.round(ci.width * 100) / 100
                },
                outlierStats: {
                    wellbeingOutliers: wellbeingOutlierCheck.outliers.length,
                    valueOutliers: valueOutlierCheck.outliers.length,
                    cleanedN: cleanWellbeing.length,
                    rawN: data.pairs.length
                },
                dataPoints: cleanWellbeing.length,
                avgWellbeing: average(cleanWellbeing),
                avgValue: average(cleanValues)
            };

            // Choose most significant factor (lowest p-value + highest |r|)
            if (corrResult.isSignificant && Math.abs(bayesResult.posteriorR) >= 0.3) {
                if (!keyFactor || corrResult.pValue < keyPValue ||
                    (corrResult.pValue === keyPValue && Math.abs(bayesResult.posteriorR) > maxAbsCorr)) {
                    maxAbsCorr = Math.abs(bayesResult.posteriorR);
                    keyFactor = factor;
                    keyPValue = corrResult.pValue;
                    keyIsSignificant = true;
                    keyEffectSize = corrResult.effectSize;
                }
            }
        }

        if (Object.keys(results).length === 0) {
            return {
                pattern: PATTERNS.WELLBEING_CORRELATION,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏'
            };
        }

        if (!keyFactor) {
            return {
                pattern: PATTERNS.WELLBEING_CORRELATION,
                available: true,
                correlations: results,
                dataPoints: Object.values(results)[0]?.dataPoints || 0,
                score: 50,
                confidence: 0.3,
                insight: '–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö —Å–≤—è–∑–µ–π)'
            };
        }

        const keyData = results[keyFactor];

        // Calculate confidence based on effect size and significance
        let confidence = 0.5;
        if (keyIsSignificant) {
            if (keyEffectSize === 'large') confidence = 0.9;
            else if (keyEffectSize === 'medium') confidence = 0.75;
            else if (keyEffectSize === 'small') confidence = 0.6;
        } else {
            confidence = 0.3;
        }

        const ciPenalty = Math.min(0.1, (Number(keyData?.confidenceInterval?.width) || 2) / 2 * 0.1);
        confidence = Math.max(0.2, confidence - ciPenalty);

        const score = maxAbsCorr >= 0.5 ? 90 : maxAbsCorr >= 0.4 ? 75 : 60;

        const factorNames = {
            sleepQuality: '–∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞',
            sleepHours: '–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞',
            steps: '—à–∞–≥–∏',
            protein: '–±–µ–ª–æ–∫',
            kcal: '–∫–∞–ª–æ—Ä–∏–∏'
        };

        const insight = keyData.bayesianR > 0.4
            ? `üòä ${factorNames[keyFactor]} ‚Üë ‚Üí —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ ‚Üë (r=${keyData.bayesianR.toFixed(2)}, p<${keyData.pValue < 0.01 ? '0.01' : '0.05'}, N=${keyData.dataPoints})`
            : `üîç ${factorNames[keyFactor]} –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ (r=${keyData.bayesianR.toFixed(2)}, p<${keyData.pValue < 0.01 ? '0.01' : '0.05'}, N=${keyData.dataPoints})`;

        return {
            pattern: PATTERNS.WELLBEING_CORRELATION,
            available: true,
            keyFactor,
            correlation: keyData.correlation,
            bayesianR: Math.round(keyData.bayesianR * 100) / 100,
            pValue: keyData.pValue,
            isSignificant: keyData.isSignificant,
            effectSize: keyData.effectSize,
            confidenceInterval: keyData.confidenceInterval,
            outlierStats: keyData.outlierStats,
            correlations: results,
            dataPoints: keyData.dataPoints,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * B3: Hydration ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ (30ml/kg –í–û–ó).
     * @param {Array} days
     * @returns {object}
     */
    function analyzeHydration(days) {
        const hydrationData = [];
        const exponentialMovingAverage = piStats.exponentialMovingAverage || function (arr) { return arr; };

        for (const day of days) {
            const weight = day.weightMorning || day.weightEvening;
            const waterMl = day.waterMl;

            if (weight && waterMl != null) {
                const goal = weight * 30;
                const achievement = (waterMl / goal) * 100;
                hydrationData.push({
                    date: day.date,
                    waterMl,
                    goal,
                    achievement: Math.round(achievement)
                });
            }
        }

        if (hydrationData.length < 3) {
            return {
                pattern: PATTERNS.HYDRATION,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏'
            };
        }

        const avgAchievement = average(hydrationData.map(d => d.achievement));
        const avgWater = average(hydrationData.map(d => d.waterMl));
        const avgGoal = average(hydrationData.map(d => d.goal));

        let trend = 'stable';
        if (hydrationData.length >= 7) {
            const waterValues = hydrationData.map(d => d.waterMl);
            const emaValues = exponentialMovingAverage(waterValues, 7);
            if (emaValues.length >= 2) {
                const firstEma = emaValues[0];
                const lastEma = emaValues[emaValues.length - 1];
                const slope = lastEma - firstEma;
                if (slope > avgGoal * 0.05) trend = 'up';
                else if (slope < -avgGoal * 0.05) trend = 'down';
            }
        }

        let score;
        let insight;
        if (avgAchievement >= 90) {
            score = 100;
            insight = `üíß –û—Ç–ª–∏—á–Ω–æ! ${Math.round(avgWater)}–º–ª (${Math.round(avgAchievement)}% –Ω–æ—Ä–º—ã)`;
        } else if (avgAchievement >= 70) {
            score = 75;
            insight = `‚úÖ –ù–æ—Ä–º–∞. ${Math.round(avgWater)}–º–ª (${Math.round(avgAchievement)}%). –ú–æ–∂–Ω–æ —á—É—Ç—å –±–æ–ª—å—à–µ`;
        } else {
            score = 50;
            insight = `‚ö†Ô∏è –ú–∞–ª–æ–≤–∞—Ç–æ. ${Math.round(avgWater)}–º–ª (${Math.round(avgAchievement)}%). –¶–µ–ª—å: ${Math.round(avgGoal)}–º–ª`;
        }

        const confidence = hydrationData.length >= 7 ? 0.8 : 0.5;

        return {
            pattern: PATTERNS.HYDRATION,
            available: true,
            avgWater: Math.round(avgWater),
            avgGoal: Math.round(avgGoal),
            achievement: Math.round(avgAchievement),
            trend,
            dataPoints: hydrationData.length,
            score,
            confidence,
            insight
        };
    }

    /**
     * B4: Body Composition ‚Äî WHR (waist-hip ratio) —Å —Ç—Ä–µ–Ω–¥–æ–º.
     * @param {Array} days
     * @param {object} profile
     * @returns {object}
     */
    function analyzeBodyComposition(days, profile) {
        const measurements = [];

        for (const day of days) {
            if (day.measurements && day.measurements.waist && day.measurements.hips) {
                const whr = day.measurements.waist / day.measurements.hips;
                measurements.push({
                    date: day.date,
                    waist: day.measurements.waist,
                    hip: day.measurements.hips,
                    whr: Math.round(whr * 100) / 100
                });
            }
        }

        if (measurements.length === 0) {
            return {
                pattern: PATTERNS.BODY_COMPOSITION,
                available: false,
                reason: 'no_measurements',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–º–µ—Ä–æ–≤ –æ–±—Ö–≤–∞—Ç–æ–≤ (–Ω—É–∂–Ω–æ 3+)'
            };
        }

        const avgWHR = average(measurements.map(m => m.whr));
        const whrArr = measurements.map(m => m.whr);
        const trend = calculateTrend(whrArr);

        const gender = profile?.gender || 'female';
        const threshold = gender === 'male' ? 0.9 : 0.85;

        const isPreliminary = measurements.length < 3;

        let score;
        let insight;
        if (avgWHR < threshold) {
            score = isPreliminary ? 82 : 90;
            const trendText = trend < -0.001 ? ' üìâ –£–ª—É—á—à–∞–µ—Ç—Å—è!' : trend > 0.001 ? ' ‚ö†Ô∏è –†–∞—Å—Ç—ë—Ç' : ' –°—Ç–∞–±–∏–ª—å–Ω–æ';
            insight = `‚úÖ WHR ${avgWHR.toFixed(2)} < ${threshold} (–Ω–æ—Ä–º–∞).${trendText}`;
        } else {
            score = isPreliminary ? 56 : 60;
            const trendText = trend < -0.001 ? ' üìâ –°–Ω–∏–∂–∞–µ—Ç—Å—è ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π!' : trend > 0.001 ? ' ‚ö†Ô∏è –†–∞—Å—Ç—ë—Ç' : '';
            insight = `‚ö†Ô∏è WHR ${avgWHR.toFixed(2)} > ${threshold}. –í–∏—Å—Ü–µ—Ä–∞–ª—å–Ω—ã–π –∂–∏—Ä.${trendText}`;
        }

        const confidence = isPreliminary
            ? 0.35
            : measurements.length >= 30 ? 0.9 : measurements.length >= 20 ? 0.7 : 0.5;

        if (isPreliminary) {
            insight = `‚ÑπÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ ${measurements.length} –∑–∞–º–µ—Ä${measurements.length === 1 ? '—É' : '–∞–º'}: ${insight} –¢–æ—á–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –≤—ã—Å–æ–∫–æ–π –ø–æ—Å–ª–µ 3+ –∑–∞–º–µ—Ä–æ–≤.`;
        }

        return {
            pattern: PATTERNS.BODY_COMPOSITION,
            available: true,
            avgWHR: Math.round(avgWHR * 100) / 100,
            threshold,
            trend: trend > 0.001 ? 'up' : trend < -0.001 ? 'down' : 'stable',
            dataPoints: measurements.length,
            score,
            confidence,
            isPreliminary,
            requiredDataPoints: 3,
            insight
        };
    }

    /**
     * B5: Cycle Impact ‚Äî –≤–ª–∏—è–Ω–∏–µ –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–∞–∑–∏—Ä–æ–≤–∫–∞).
     * @param {Array} days
     * @param {object} pIndex
     * @param {object} profile
     * @returns {object}
     */
    function analyzeCyclePatterns(days, pIndex, profile) {
        const g = String(profile?.gender || '').toLowerCase();
        const isMale = g === 'male' || g === '–º—É–∂—Å–∫–æ–π' || g === '–º—É–∂—á–∏–Ω–∞';
        if (isMale || !profile?.cycleTrackingEnabled) {
            return {
                pattern: PATTERNS.CYCLE_IMPACT,
                available: false,
                reason: 'male_only',
                confidence: 0,
                insight: '–¢—Ä–µ–∫–∏–Ω–≥ —Ü–∏–∫–ª–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'
            };
        }

        const cycleDays = days.filter(d => d.cycleDay != null);
        if (cycleDays.length < 14) {
            return {
                pattern: PATTERNS.CYCLE_IMPACT,
                available: false,
                reason: 'no_cycle_data',
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Ü–∏–∫–ª–µ (–Ω—É–∂–Ω–æ 14+ –¥–Ω–µ–π)'
            };
        }

        const cycleDayNumbers = cycleDays.map(d => d.cycleDay);
        const maxCycleDay = Math.max(...cycleDayNumbers);
        const ovulationDay = maxCycleDay >= 28 ? 14 : Math.round(maxCycleDay / 2);

        const follicular = [];
        const luteal = [];

        for (const day of cycleDays) {
            const phaseData = {
                date: day.date,
                cycleDay: day.cycleDay,
                kcal: calculateDayKcal(day, pIndex),
                weight: day.weightMorning,
                mood: day.moodAvg || (day.meals ? average(day.meals.filter(m => m.mood).map(m => m.mood)) : null),
                steps: day.steps
            };

            if (day.cycleDay <= ovulationDay) {
                follicular.push(phaseData);
            } else {
                luteal.push(phaseData);
            }
        }

        if (follicular.length < 5 || luteal.length < 5) {
            return {
                pattern: PATTERNS.CYCLE_IMPACT,
                available: false,
                confidence: 0.3,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ñ–∞–∑'
            };
        }

        const follicularKcal = average(follicular.filter(d => d.kcal > 0).map(d => d.kcal));
        const lutealKcal = average(luteal.filter(d => d.kcal > 0).map(d => d.kcal));
        const kcalDiff = lutealKcal - follicularKcal;

        const follicularMood = average(follicular.filter(d => d.mood).map(d => d.mood));
        const lutealMood = average(luteal.filter(d => d.mood).map(d => d.mood));
        const moodDiff = lutealMood - follicularMood;

        let insight;
        if (kcalDiff > 150 && moodDiff < -0.3) {
            insight = `üåô –õ—é—Ç–µ–∏–Ω–æ–≤–∞—è —Ñ–∞–∑–∞: +${Math.round(kcalDiff)}–∫–∫–∞–ª, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ö—É–∂–µ. –≠—Ç–æ –Ω–æ—Ä–º–∞ (–ø—Ä–æ–≥–µ—Å—Ç–µ—Ä–æ–Ω‚Üë)`;
        } else if (kcalDiff > 150) {
            insight = `üåô –õ—é—Ç–µ–∏–Ω–æ–≤–∞—è —Ñ–∞–∑–∞: +${Math.round(kcalDiff)}–∫–∫–∞–ª (–ø—Ä–æ–≥–µ—Å—Ç–µ—Ä–æ–Ω‚Üë BMR –Ω–∞ 5-10%)`;
        } else if (moodDiff < -0.5) {
            insight = 'üòî –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç –≤–æ 2-–π —Ñ–∞–∑–µ. –ü–ú–°? –¶–∏–∫–ª –≤–ª–∏—è–µ—Ç';
        } else {
            insight = '‚úÖ –¶–∏–∫–ª –≤–ª–∏—è–µ—Ç —É–º–µ—Ä–µ–Ω–Ω–æ. –†–∞–∑–ª–∏—á–∏—è –≤ –Ω–æ—Ä–º–µ';
        }

        const score = Math.abs(kcalDiff) < 200 && Math.abs(moodDiff) < 0.5 ? 90 : 70;
        const confidence = cycleDays.length >= 21 ? 0.8 : 0.6;

        return {
            pattern: PATTERNS.CYCLE_IMPACT,
            available: true,
            ovulationDay,
            follicularDays: follicular.length,
            lutealDays: luteal.length,
            kcalDiff: Math.round(kcalDiff),
            moodDiff: Math.round(moodDiff * 10) / 10,
            dataPoints: cycleDays.length,
            score,
            confidence,
            insight
        };
    }

    /**
     * B6: Weekend Effect ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ç-–≤—Å vs –ø–Ω-—á—Ç.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeWeekendEffect(days, pIndex) {
        const weekdays = [];
        const weekends = [];

        for (const day of days) {
            if (!day.date) continue;
            const date = new Date(day.date);
            const dayOfWeek = date.getDay();

            const dayData = {
                date: day.date,
                kcal: calculateDayKcal(day, pIndex),
                sleep: day.sleepHours || (day.sleepStart && day.sleepEnd ? calculateSleepHours(day.sleepStart, day.sleepEnd) : null),
                steps: day.steps
            };

            if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) {
                weekends.push(dayData);
            } else if (dayOfWeek >= 1 && dayOfWeek <= 4) {
                weekdays.push(dayData);
            }
        }

        if (weekdays.length < 4 || weekends.length < 3) {
            return {
                pattern: PATTERNS.WEEKEND_EFFECT,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –±—É–¥–Ω–µ–π –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö'
            };
        }

        const weekdayKcal = average(weekdays.filter(d => d.kcal > 0).map(d => d.kcal));
        const weekendKcal = average(weekends.filter(d => d.kcal > 0).map(d => d.kcal));
        const kcalDiffPct = ((weekendKcal - weekdayKcal) / weekdayKcal) * 100;

        const weekdaySleep = average(weekdays.filter(d => d.sleep).map(d => d.sleep));
        const weekendSleep = average(weekends.filter(d => d.sleep).map(d => d.sleep));
        const sleepDiff = weekendSleep - weekdaySleep;

        const weekdaySteps = average(weekdays.filter(d => d.steps).map(d => d.steps));
        const weekendSteps = average(weekends.filter(d => d.steps).map(d => d.steps));
        const stepsDiffPct = ((weekendSteps - weekdaySteps) / weekdaySteps) * 100;

        let score;
        let insight;
        if (kcalDiffPct > 30) {
            score = 50;
            insight = `‚ö†Ô∏è –í –≤—ã—Ö–æ–¥–Ω—ã–µ +${Math.round(kcalDiffPct)}% –∫–∞–ª–æ—Ä–∏–π! –î–µ—Ñ–∏—Ü–∏—Ç —É–ª–µ—Ç–∞–µ—Ç`;
        } else if (kcalDiffPct > 10 && kcalDiffPct <= 30) {
            score = 70;
            insight = `üü° –í—ã—Ö–æ–¥–Ω—ã–µ +${Math.round(kcalDiffPct)}% –∫–∫–∞–ª. –ù–æ—Ä–º–∞, –Ω–æ —Å–ª–µ–¥–∏`;
        } else {
            score = 90;
            insight = `‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º! –í—ã—Ö–æ–¥–Ω—ã–µ ${kcalDiffPct > 0 ? '+' : ''}${Math.round(kcalDiffPct)}% –∫–∫–∞–ª`;
        }

        const confidence = weekdays.length >= 8 && weekends.length >= 6 ? 0.8 : 0.6;

        return {
            pattern: PATTERNS.WEEKEND_EFFECT,
            available: true,
            weekdayKcal: Math.round(weekdayKcal),
            weekendKcal: Math.round(weekendKcal),
            kcalDiffPct: Math.round(kcalDiffPct),
            weekdaySleep: Math.round(weekdaySleep * 10) / 10,
            weekendSleep: Math.round(weekendSleep * 10) / 10,
            sleepDiff: Math.round(sleepDiff * 10) / 10,
            weekdaySteps: Math.round(weekdaySteps),
            weekendSteps: Math.round(weekendSteps),
            stepsDiffPct: Math.round(stepsDiffPct),
            dataPoints: weekdays.length + weekends.length,
            score,
            confidence,
            insight
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeWellbeing = analyzeWellbeing;
    HEYS.InsightsPI.patternModules.analyzeHydration = analyzeHydration;
    HEYS.InsightsPI.patternModules.analyzeBodyComposition = analyzeBodyComposition;
    HEYS.InsightsPI.patternModules.analyzeCyclePatterns = analyzeCyclePatterns;
    HEYS.InsightsPI.patternModules.analyzeWeekendEffect = analyzeWeekendEffect;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/body.js ===== */
// insights/patterns/body.js ‚Äî Modular body analyzers (v6.10.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};

    const PATTERNS = piConst.PATTERNS || {
        HYPERTROPHY: 'hypertrophy'
    };

    const calculateTrend = piStats.calculateTrend || function (values) {
        if (!Array.isArray(values) || values.length < 2) return 0;
        const n = values.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        for (let i = 0; i < n; i++) {
            const y = Number(values[i]) || 0;
            sumX += i;
            sumY += y;
            sumXY += i * y;
            sumX2 += i * i;
        }
        const denominator = (n * sumX2 - sumX * sumX);
        if (!denominator) return 0;
        return (n * sumXY - sumX * sumY) / denominator;
    };

    /**
     * C12: Hypertrophy & body composition.
     * @param {Array} days
     * @param {object} profile
     * @returns {object}
     */
    function analyzeHypertrophy(days, profile) {
        if (!days || days.length < 14) {
            return { pattern: PATTERNS.HYPERTROPHY, available: false, reason: 'no_measurements' };
        }

        const measurements = days
            .filter(d => d.measurements?.biceps || d.measurements?.thigh)
            .map(d => ({
                date: d.date,
                biceps: d.measurements?.biceps || 0,
                thigh: d.measurements?.thigh || 0,
                weight: d.weightMorning || profile?.weight || 0
            }));

        if (measurements.length < 5) {
            return { pattern: PATTERNS.HYPERTROPHY, available: false, reason: 'no_measurements' };
        }

        const bicepsValues = measurements.map(m => m.biceps).filter(v => v > 0);
        const thighValues = measurements.map(m => m.thigh).filter(v => v > 0);
        const weightValues = measurements.map(m => m.weight).filter(v => v > 0);

        if (bicepsValues.length < 3 && thighValues.length < 3) {
            return { pattern: PATTERNS.HYPERTROPHY, available: false, reason: 'no_measurements' };
        }

        const bicepsTrend = bicepsValues.length >= 3 ? calculateTrend(bicepsValues) : 0;
        const thighTrend = thighValues.length >= 3 ? calculateTrend(thighValues) : 0;
        const weightTrend = weightValues.length >= 3 ? calculateTrend(weightValues) : 0;

        const proteinDays = days.filter(d => {
            // dayTot –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ç–µ–∏–Ω –∏–∑ meals
            let proteinGrams = 0;
            if (d.meals) {
                for (const meal of d.meals) {
                    for (const item of (meal.items || [])) {
                        const grams = Number(item.grams) || 0;
                        const prot100 = Number(item.prot100) || 0;
                        proteinGrams += (prot100 * grams / 100);
                    }
                }
            }
            const weight = d.weightMorning || profile?.weight || 70;
            return (proteinGrams / weight) >= 1.6;
        });
        const proteinAdequacy = (proteinDays.length / days.length) * 100;

        let compositionQuality = 'unknown';
        if (weightTrend > 0.05 && (bicepsTrend > 0.01 || thighTrend > 0.02)) {
            compositionQuality = 'muscle_gain';
        } else if (weightTrend > 0.05 && bicepsTrend <= 0 && thighTrend <= 0) {
            compositionQuality = 'fat_gain';
        } else if (weightTrend < -0.05 && (bicepsTrend > -0.01 || thighTrend > -0.02)) {
            compositionQuality = 'fat_loss';
        } else {
            compositionQuality = 'maintenance';
        }

        let score = 70;
        if (compositionQuality === 'muscle_gain' && proteinAdequacy >= 70) {
            score = 95;
        } else if (compositionQuality === 'fat_loss' && proteinAdequacy >= 70) {
            score = 90;
        } else if (compositionQuality === 'fat_gain') {
            score = 50;
        } else if (proteinAdequacy < 50) {
            score = 60;
        }

        let insight = '';
        if (compositionQuality === 'muscle_gain') {
            insight = `üí™ –ú—ã—à–µ—á–Ω–∞—è –º–∞—Å—Å–∞ —Ä–∞—Å—Ç—ë—Ç! –ë–∏—Ü–µ–ø—Å ${bicepsTrend > 0 ? '+' : ''}${(bicepsTrend * 100).toFixed(1)}—Å–º/–º–µ—Å, –±–µ–¥—Ä–æ ${thighTrend > 0 ? '+' : ''}${(thighTrend * 100).toFixed(1)}—Å–º/–º–µ—Å`;
        } else if (compositionQuality === 'fat_loss') {
            insight = `‚úÖ –ñ–∏—Ä —É—Ö–æ–¥–∏—Ç, –º—ã—à—Ü—ã –¥–µ—Ä–∂–∞—Ç—Å—è! –ë–µ–ª–æ–∫ ${Math.round(proteinAdequacy)}% –¥–Ω–µ–π >= 1.6–≥/–∫–≥`;
        } else if (compositionQuality === 'fat_gain') {
            insight = `‚ö†Ô∏è –í–µ—Å —Ä–∞—Å—Ç—ë—Ç –±–µ–∑ —Ä–æ—Å—Ç–∞ –º—ã—à—Ü. –ü—Ä–æ–≤–µ—Ä—å –±–µ–ª–æ–∫ (${Math.round(proteinAdequacy)}% –¥–Ω–µ–π) –∏ —Å–∏–ª–æ–≤—ã–µ`;
        } else {
            insight = `üìä –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞. –ë–µ–ª–æ–∫ ${Math.round(proteinAdequacy)}% –¥–Ω–µ–π >= 1.6–≥/–∫–≥`;
        }

        const confidence = measurements.length >= 7 ? 0.80 : 0.65;

        return {
            pattern: PATTERNS.HYPERTROPHY,
            available: true,
            bicepsTrend: Math.round(bicepsTrend * 1000) / 1000,
            thighTrend: Math.round(thighTrend * 1000) / 1000,
            weightTrend: Math.round(weightTrend * 1000) / 1000,
            compositionQuality,
            proteinAdequacy: Math.round(proteinAdequacy),
            measurements: measurements.length,
            dataPoints: days.length,
            score,
            confidence,
            insight
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeHypertrophy = analyzeHypertrophy;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/training_nutrition.js ===== */
// insights/patterns/training_nutrition.js ‚Äî Modular training nutrition analyzers (v6.1.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};

    const PATTERNS = piConst.PATTERNS || {
        PROTEIN_DISTRIBUTION: 'protein_distribution',
        ANTIOXIDANT_DEFENSE: 'antioxidant_defense',
        TRAINING_TYPE_MATCH: 'training_type_match'
    };

    const average = piStats.average || ((arr) => {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + value, 0) / arr.length;
    });

    /**
     * C15: Protein Distribution (Leucine Threshold).
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} profile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–µ–ª–∫–∞.
     */
    function analyzeProteinDistribution(days, profile, pIndex, thresholds = {}) {
        const pattern = PATTERNS.PROTEIN_DISTRIBUTION || 'protein_distribution';
        const minDays = 7;
        const minMealsPerDay = 2;
        const PROTEIN_PER_MEAL = thresholds.proteinPerMealG || 30;
        const PROTEIN_MIN = PROTEIN_PER_MEAL - 10;
        const PROTEIN_MAX = PROTEIN_PER_MEAL + 10;
        const PROTEIN_SUBTHRESHOLD = 10;
        const PROTEIN_EXCESS = 50;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        const validDays = days.filter(d => Array.isArray(d?.meals) && d.meals.length > 0);
        if (validDays.length === 0) {
            return { pattern, available: false, reason: 'no_meals_data' };
        }

        const totalMeals = validDays.reduce((sum, d) => sum + d.meals.length, 0);
        const avgMealsPerDay = totalMeals / validDays.length;
        if (avgMealsPerDay < minMealsPerDay) {
            return {
                pattern,
                available: false,
                reason: 'min_meals_required',
                minMealsPerDay,
                avgMealsPerDay: Math.round(avgMealsPerDay * 10) / 10
            };
        }

        const profileWeight = Number(profile?.weight) || 70;
        const targetProtein = profileWeight * 1.6;

        let optimalMeals = 0;
        let subthresholdMeals = 0;
        let belowOptimalMeals = 0;
        let excessMeals = 0;
        const dayTotals = [];
        const spreads = [];

        for (const day of validDays) {
            let dayProtein = 0;
            const mealProteins = [];

            for (const meal of day.meals) {
                let mealProtein = 0;

                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;
                    const grams = Number(item.grams) || 0;
                    if (grams <= 0) continue;
                    mealProtein += (Number(prod.protein100) || 0) * grams / 100;
                }

                mealProteins.push(mealProtein);
                dayProtein += mealProtein;

                if (mealProtein < PROTEIN_SUBTHRESHOLD) subthresholdMeals++;
                else if (mealProtein > PROTEIN_EXCESS) excessMeals++;
                else if (mealProtein < PROTEIN_MIN || mealProtein > PROTEIN_MAX) belowOptimalMeals++;
                else optimalMeals++;
            }

            dayTotals.push(dayProtein);
            if (mealProteins.length >= 2) {
                spreads.push(Math.max(...mealProteins) - Math.min(...mealProteins));
            }
        }

        const distributionScore = totalMeals > 0 ? (optimalMeals / totalMeals) * 100 : 0;
        const avgSpread = spreads.length > 0 ? average(spreads) : 0;
        const evenBonus = avgSpread > 0 && avgSpread < 20 ? 10 : 0;
        const avgTotalProtein = dayTotals.length > 0 ? average(dayTotals) : 0;
        const targetProteinPct = Math.min(100, (avgTotalProtein / targetProtein) * 100);

        const score = Math.max(
            0,
            Math.min(
                100,
                Math.round(distributionScore * 0.7 + targetProteinPct * 0.3 + evenBonus)
            )
        );

        let insight = `–û–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –±–µ–ª–∫–æ–≤—ã—Ö –ø—Ä–∏—ë–º–æ–≤: ${optimalMeals}/${totalMeals}.`;
        if (distributionScore >= 60) {
            insight = `‚úÖ –•–æ—Ä–æ—à–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞: ${Math.round(distributionScore)}% –ø—Ä–∏—ë–º–æ–≤ –≤ –∑–æ–Ω–µ 20-40–≥.`;
        } else if (distributionScore >= 35) {
            insight = `üü° –ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ: ${Math.round(distributionScore)}% –ø—Ä–∏—ë–º–æ–≤ –ø–æ–ø–∞–¥–∞—é—Ç –≤ 20-40–≥.`;
        } else {
            insight = `üî¥ –°–ª–∞–±–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞: —Ç–æ–ª—å–∫–æ ${Math.round(distributionScore)}% –ø—Ä–∏—ë–º–æ–≤ –≤ —Ü–µ–ª–µ–≤–æ–π –∑–æ–Ω–µ.`;
        }

        if (evenBonus > 0) insight += ' –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—ë–º–∞–º (+10).';
        if (targetProteinPct < 80) insight += ` –°—É—Ç–æ—á–Ω—ã–π –±–µ–ª–æ–∫ ${Math.round(targetProteinPct)}% –æ—Ç —Ü–µ–ª–∏ (${Math.round(targetProtein)}–≥).`;

        const baseConfidence = days.length >= 14 ? 0.8 : 0.7;
        const confidence = piStats.applySmallSamplePenalty
            ? piStats.applySmallSamplePenalty(baseConfidence, days.length, minDays)
            : baseConfidence;

        return {
            pattern,
            available: true,
            optimalMeals,
            subthresholdMeals,
            belowOptimalMeals,
            excessMeals,
            totalMeals,
            distributionScore: Math.round(distributionScore),
            avgDailyProtein: Math.round(avgTotalProtein * 10) / 10,
            targetProtein: Math.round(targetProtein),
            targetProteinPct: Math.round(targetProteinPct),
            avgProteinSpread: Math.round(avgSpread * 10) / 10,
            evenBonus,
            daysAnalyzed: validDays.length,
            avgMealsPerDay: Math.round(avgMealsPerDay * 10) / 10,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * C16: Antioxidant Defense Score.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–æ–π –∑–∞—â–∏—Ç—ã.
     */
    function analyzeAntioxidantDefense(days, pIndex) {
        const pattern = PATTERNS.ANTIOXIDANT_DEFENSE || 'antioxidant_defense';
        const minDays = 7;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        const dailyIndices = [];
        let highDemandDays = 0;
        let moderateDemandDays = 0;

        for (const day of days) {
            let vitA = 0;
            let vitC = 0;
            let vitE = 0;
            let selenium = 0;
            let zinc = 0;
            let nova4Carbs = 0;

            for (const meal of (day.meals || [])) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;

                    const grams = Number(item.grams) || 0;
                    if (grams <= 0) continue;
                    const factor = grams / 100;

                    vitA += (Number(prod.vitamin_a) || 0) * factor;
                    vitC += (Number(prod.vitamin_c) || 0) * factor;
                    vitE += (Number(prod.vitamin_e) || 0) * factor;
                    selenium += (Number(prod.selenium) || 0) * factor;
                    zinc += (Number(prod.zinc) || 0) * factor;

                    if (Number(prod.nova_group) === 4) {
                        nova4Carbs += ((Number(prod.simple100) || 0) + (Number(prod.complex100) || 0)) * factor;
                    }
                }
            }

            const aScore = Math.min(1, vitA / 900) * 20;
            const cScore = Math.min(1, vitC / 90) * 30;
            const eScore = Math.min(1, vitE / 15) * 20;
            const seScore = Math.min(1, selenium / 55) * 15;
            const znScore = Math.min(1, zinc / 11) * 15;
            const antioxidantIndex = aScore + cScore + eScore + seScore + znScore;

            const trainings = Array.isArray(day.trainings) ? day.trainings : [];
            const highIntensityMinutes = trainings.reduce((sum, t) => {
                const z = t?.z || [];
                const z4 = Number(z[3]) || 0;
                const z5 = Number(z[4]) || 0;
                return sum + z4 + z5;
            }, 0);

            let demand = 'low';
            if (highIntensityMinutes > 20) {
                demand = 'high';
                highDemandDays++;
            } else if (trainings.length > 0) {
                demand = 'moderate';
                moderateDemandDays++;
            }

            const demandMultiplier = demand === 'high' ? 1.3 : (demand === 'moderate' ? 1.15 : 1.0);

            dailyIndices.push({
                antioxidantIndex,
                demand,
                demandMultiplier,
                vitCPct: (vitC / (90 * demandMultiplier)) * 100,
                vitEPct: (vitE / (15 * demandMultiplier)) * 100,
                nova4High: nova4Carbs > 30
            });
        }

        if (dailyIndices.length === 0) {
            return { pattern, available: false, reason: 'insufficient_data' };
        }

        const avgAntioxidantIndex = average(dailyIndices.map(d => d.antioxidantIndex));
        const dominantDemand = highDemandDays > 0 ? 'high' : (moderateDemandDays > 0 ? 'moderate' : 'low');
        const adjustedScore = Math.round(
            avgAntioxidantIndex * (dominantDemand === 'high' ? 0.85 : 1.0)
        );

        const defenseGapDays = dailyIndices.filter(d => d.antioxidantIndex < 60).length;
        const vitCRiskDays = dailyIndices.filter(d => d.demand === 'high' && d.vitCPct < 50).length;
        const doubleStressDays = dailyIndices.filter(d => d.vitEPct < 50 && d.nova4High).length;

        let insight = '';
        if (adjustedScore >= 80) {
            insight = `‚úÖ –•–æ—Ä–æ—à–∞—è –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞ (${adjustedScore}/100).`;
        } else if (adjustedScore >= 60) {
            insight = `üü° –£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞ (${adjustedScore}/100).`;
        } else {
            insight = `üî¥ –ù–∏–∑–∫–∞—è –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞ (${adjustedScore}/100), —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ä–∞—Ü–∏–æ–Ω–∞.`;
        }

        if (defenseGapDays > 0) insight += ` Defense gap: ${defenseGapDays} –¥–Ω.`;
        if (vitCRiskDays > 0) insight += ` VitC risk –ø—Ä–∏ high-load: ${vitCRiskDays} –¥–Ω.`;
        if (doubleStressDays > 0) insight += ` Double oxidative stress: ${doubleStressDays} –¥–Ω.`;

        const baseConfidence = days.length >= 14 ? 0.8 : 0.7;
        const confidence = piStats.applySmallSamplePenalty
            ? piStats.applySmallSamplePenalty(baseConfidence, days.length, minDays)
            : baseConfidence;

        return {
            pattern,
            available: true,
            antioxidantIndex: Math.round(avgAntioxidantIndex),
            dominantDemand,
            highDemandDays,
            moderateDemandDays,
            defenseGapDays,
            vitCRiskDays,
            doubleStressDays,
            score: Math.max(0, Math.min(100, adjustedScore)),
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * C19: Training-Type Nutrition Match.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} profile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–∏—Ç–∞–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–µ.
     */
    function analyzeTrainingTypeMatch(days, profile, pIndex) {
        const pattern = PATTERNS.TRAINING_TYPE_MATCH || 'training_type_match';
        const minDays = 5;
        const minTrainings = 3;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        let trainingCount = 0;
        let cardioCount = 0;
        let strengthCount = 0;
        let hobbyCount = 0;

        let totalProt = 0;
        let totalCarbs = 0;
        let totalMg = 0;
        let totalVitC = 0;

        for (const day of days) {
            const trainings = Array.isArray(day?.trainings) ? day.trainings : [];
            trainingCount += trainings.length;

            trainings.forEach(t => {
                const type = t?.type;
                if (type === 'strength') strengthCount++;
                else if (type === 'cardio') cardioCount++;
                else if (type === 'hobby') hobbyCount++;
            });

            totalProt += Number(day?.tot?.prot || day?.tot?.protein || 0);
            totalCarbs += Number(day?.tot?.carbs || 0);

            for (const meal of (day.meals || [])) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;
                    const grams = Number(item.grams) || 0;
                    if (grams <= 0) continue;
                    const factor = grams / 100;
                    totalMg += (Number(prod.magnesium) || 0) * factor;
                    totalVitC += (Number(prod.vitamin_c) || 0) * factor;
                }
            }
        }

        if (trainingCount < minTrainings) {
            return {
                pattern,
                available: false,
                reason: 'min_trainings_required',
                minTrainingsRequired: minTrainings,
                trainingsProvided: trainingCount
            };
        }

        let dominantType = 'mixed';
        if (strengthCount >= cardioCount && strengthCount >= hobbyCount) dominantType = 'strength';
        else if (cardioCount >= strengthCount && cardioCount >= hobbyCount) dominantType = 'cardio';
        else if (hobbyCount > 0) dominantType = 'hobby';

        const weight = Number(profile?.weight) || 70;
        const avgProtPerKg = (totalProt / days.length) / weight;
        const avgCarbsPerKg = (totalCarbs / days.length) / weight;
        const avgMg = totalMg / days.length;
        const avgVitC = totalVitC / days.length;

        let protTargetMin = 1.0;
        let protTargetMax = 1.2;
        let carbsTargetMin = 3;
        let carbsTargetMax = 5;

        if (dominantType === 'cardio') {
            protTargetMin = 1.2;
            protTargetMax = 1.4;
            carbsTargetMin = 5;
            carbsTargetMax = 7;
        } else if (dominantType === 'strength') {
            protTargetMin = 1.6;
            protTargetMax = 2.2;
            carbsTargetMin = 3;
            carbsTargetMax = 5;
        }

        const protDeviation = avgProtPerKg < protTargetMin
            ? (protTargetMin - avgProtPerKg) / protTargetMin
            : (avgProtPerKg > protTargetMax ? (avgProtPerKg - protTargetMax) / protTargetMax : 0);

        const carbsDeviation = avgCarbsPerKg < carbsTargetMin
            ? (carbsTargetMin - avgCarbsPerKg) / carbsTargetMin
            : (avgCarbsPerKg > carbsTargetMax ? (avgCarbsPerKg - carbsTargetMax) / carbsTargetMax : 0);

        const macroMatchScore = Math.max(0, 100 - Math.round((protDeviation * 50 + carbsDeviation * 50) * 100));
        const postWorkoutScore = dominantType === 'strength'
            ? (avgProtPerKg >= 1.6 ? 90 : 60)
            : (dominantType === 'cardio' ? (avgCarbsPerKg >= 5 ? 90 : 60) : 75);
        const recoveryNutrientScore = Math.min(100, Math.round((Math.min(1, avgMg / 400) * 50) + (Math.min(1, avgVitC / 90) * 50)));

        const score = Math.max(
            0,
            Math.min(100, Math.round(macroMatchScore * 0.5 + postWorkoutScore * 0.3 + recoveryNutrientScore * 0.2))
        );

        let insight = `–¢–∏–ø –Ω–∞–≥—Ä—É–∑–∫–∏: ${dominantType}. Macro match: ${macroMatchScore}%.`;
        if (score >= 80) insight = `‚úÖ –û—Ç–ª–∏—á–Ω—ã–π match –ø–∏—Ç–∞–Ω–∏—è –ø–æ–¥ ${dominantType} (${score}/100).`;
        else if (score >= 60) insight = `üü° –ß–∞—Å—Ç–∏—á–Ω—ã–π match –ø–æ–¥ ${dominantType} (${score}/100).`;
        else insight = `üî¥ –í—ã—Ä–∞–∂–µ–Ω–Ω—ã–π mismatch –ø–∏—Ç–∞–Ω–∏—è –∏ –Ω–∞–≥—Ä—É–∑–∫–∏ (${score}/100).`;

        if (dominantType === 'strength' && avgProtPerKg < 1.6) insight += ' –ë–µ–ª–æ–∫ –Ω–∏–∂–µ —Ü–µ–ª–µ–≤–æ–≥–æ –¥–ª—è —Å–∏–ª–æ–≤—ã—Ö.';
        if (dominantType === 'cardio' && avgCarbsPerKg < 5) insight += ' –£–≥–ª–µ–≤–æ–¥—ã –Ω–∏–∂–µ —Ü–µ–ª–µ–≤–æ–≥–æ –¥–ª—è cardio.';

        const baseConfidence = days.length >= 10 ? 0.8 : 0.7;
        const confidence = piStats.applySmallSamplePenalty
            ? piStats.applySmallSamplePenalty(baseConfidence, days.length, minDays)
            : baseConfidence;

        return {
            pattern,
            available: true,
            dominantType,
            trainingCount,
            macroMatchScore,
            postWorkoutScore,
            recoveryNutrientScore,
            avgProtPerKg: Math.round(avgProtPerKg * 100) / 100,
            avgCarbsPerKg: Math.round(avgCarbsPerKg * 100) / 100,
            avgMagnesium: Math.round(avgMg),
            avgVitC: Math.round(avgVitC),
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeProteinDistribution = analyzeProteinDistribution;
    HEYS.InsightsPI.patternModules.analyzeAntioxidantDefense = analyzeAntioxidantDefense;
    HEYS.InsightsPI.patternModules.analyzeTrainingTypeMatch = analyzeTrainingTypeMatch;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/metabolic.js ===== */
// insights/patterns/metabolic.js ‚Äî Modular metabolic analyzers (v6.2.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const SCIENCE_INFO = piConst.SCIENCE_INFO || HEYS.InsightsPI?.science || global.piScience || {};
    const CONFIG = piConst.CONFIG || { MIN_DAYS_FOR_FULL_ANALYSIS: 7 };
    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, v) => sum + (Number(v) || 0), 0) / arr.length;
    };

    const PATTERNS = piConst.PATTERNS || {
        GLYCEMIC_LOAD: 'glycemic_load',
        OMEGA_BALANCER: 'omega_balancer',
        HEART_HEALTH: 'heart_health',
        ELECTROLYTE_HOMEOSTASIS: 'electrolyte_homeostasis',
        INSULIN_SENSITIVITY: 'insulin_sensitivity',
        GUT_HEALTH: 'gut_health'
    };

    /**
     * C9: Heart & Metabolic Health.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeHeartHealth(days, pIndex) {
        if (!days || days.length < CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS) {
            return { pattern: PATTERNS.HEART_HEALTH, available: false };
        }

        const sodiumValues = [];
        const potassiumValues = [];
        const cholesterolValues = [];

        for (const day of days) {
            if (!day.meals?.length) continue;

            let daySodium = 0;
            let dayPotassium = 0;
            let dayCholesterol = 0;

            for (const meal of day.meals) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;

                    const grams = item.grams || 0;
                    const factor = grams / 100;

                    if (prod.sodium100) daySodium += prod.sodium100 * factor;
                    if (prod.potassium) dayPotassium += prod.potassium * factor;
                    if (prod.cholesterol100 || prod.cholesterol) {
                        dayCholesterol += (prod.cholesterol100 || prod.cholesterol) * factor;
                    }
                }
            }

            if (daySodium > 0) sodiumValues.push(daySodium);
            if (dayPotassium > 0) potassiumValues.push(dayPotassium);
            if (dayCholesterol > 0) cholesterolValues.push(dayCholesterol);
        }

        if (sodiumValues.length < 5 || potassiumValues.length < 5) {
            return { pattern: PATTERNS.HEART_HEALTH, available: false };
        }

        const avgSodium = average(sodiumValues);
        const avgPotassium = average(potassiumValues);
        const avgCholesterol = cholesterolValues.length > 0 ? average(cholesterolValues) : 0;
        const naKRatio = avgSodium / avgPotassium;

        let score = 100;
        if (avgSodium > 2300) score -= 20;
        if (avgSodium > 3000) score -= 20;
        if (naKRatio > 1.5) score -= 25;
        else if (naKRatio > 1.0) score -= 10;
        if (avgCholesterol > 300) score -= 15;

        score = Math.max(0, Math.round(score));

        let insight = '';
        if (naKRatio < 1.0 && avgSodium < 2000) {
            insight = `‚úÖ –û—Ç–ª–∏—á–Ω—ã–π Na:K –±–∞–ª–∞–Ω—Å (${naKRatio.toFixed(2)}), –Ω–∞—Ç—Ä–∏–π ${Math.round(avgSodium)}–º–≥/–¥–µ–Ω—å`;
        } else if (naKRatio > 1.5) {
            insight = `üî¥ Na:K = ${naKRatio.toFixed(2)} (–Ω–æ—Ä–º–∞ <1.0). –†–∏—Å–∫ –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏–∏! –ú–µ–Ω—å—à–µ —Å–æ–ª–∏, –±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π/—Ñ—Ä—É–∫—Ç–æ–≤`;
        } else if (avgSodium > 2300) {
            insight = `üü† –ù–∞—Ç—Ä–∏–π ${Math.round(avgSodium)}–º–≥/–¥–µ–Ω—å (–Ω–æ—Ä–º–∞ <2000–º–≥). –ú–µ–Ω—å—à–µ –∫–æ–ª–±–∞—Å/—Å—ã—Ä–æ–≤/—Å–æ–ª–µ–Ω–∏–π`;
        } else {
            insight = `üü° Na:K = ${naKRatio.toFixed(2)} (–Ω–æ—Ä–º–∞ <1.0), –Ω–∞—Ç—Ä–∏–π ${Math.round(avgSodium)}–º–≥. –ú–æ–∂–Ω–æ –ª—É—á—à–µ`;
        }

        if (avgCholesterol > 300) {
            insight += `. –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω ${Math.round(avgCholesterol)}–º–≥ (–º–Ω–æ–≥–æ —è–∏—Ü/–º—è—Å–∞)`;
        }

        const confidence = days.length >= 14 ? 0.80 : 0.65;

        return {
            pattern: PATTERNS.HEART_HEALTH,
            available: true,
            avgSodium: Math.round(avgSodium),
            avgPotassium: Math.round(avgPotassium),
            avgCholesterol: Math.round(avgCholesterol),
            naKRatio: Math.round(naKRatio * 100) / 100,
            dataPoints: days.length,
            score,
            confidence,
            insight
        };
    }

    /**
     * C8: Omega Balance & Inflammation.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeOmegaBalance(days, pIndex) {
        if (!days || days.length < CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS) {
            return { pattern: PATTERNS.OMEGA_BALANCER, available: false };
        }

        let totalOmega3 = 0;
        let totalOmega6 = 0;
        let inflammatoryLoad = 0;

        for (const day of days) {
            if (!day.meals?.length) continue;

            for (const meal of day.meals) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;

                    const grams = item.grams || 0;
                    const factor = grams / 100;

                    if (prod.omega3_100 || prod.omega3) totalOmega3 += (prod.omega3_100 || prod.omega3) * factor;
                    if (prod.omega6_100 || prod.omega6) totalOmega6 += (prod.omega6_100 || prod.omega6) * factor;

                    const sugar = (prod.simple100 || 0) * factor;
                    const trans = (prod.trans100 || 0) * factor;
                    const fiber = (prod.fiber100 || 0) * factor;
                    inflammatoryLoad += (sugar * 0.5 + trans * 2) - (fiber * 0.3 + (prod.omega3_100 || 0) * factor * 1.5);
                }
            }
        }

        if (totalOmega3 < 0.1 || totalOmega6 < 0.1) {
            return { pattern: PATTERNS.OMEGA_BALANCER, available: false };
        }

        const omega6to3Ratio = totalOmega6 / totalOmega3;

        let score = 100;
        if (omega6to3Ratio > 10) score = 40;
        else if (omega6to3Ratio > 6) score = 60;
        else if (omega6to3Ratio > 4) score = 75;
        else score = 95;

        if (inflammatoryLoad > 50) score -= 10;
        score = Math.max(0, Math.round(score));

        let insight = '';
        if (omega6to3Ratio < 4) {
            insight = `‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –æ–º–µ–≥–∞-6:3 = ${omega6to3Ratio.toFixed(1)} (–æ–ø—Ç–∏–º—É–º <4:1)`;
        } else if (omega6to3Ratio < 6) {
            insight = `üü° –û–º–µ–≥–∞-6:3 = ${omega6to3Ratio.toFixed(1)} (–Ω–æ—Ä–º–∞ <4:1). –î–æ–±–∞–≤—å —Ä—ã–±—É/–ª—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ`;
        } else {
            insight = `üî¥ –û–º–µ–≥–∞-6:3 = ${omega6to3Ratio.toFixed(1)} (—Ä–∏—Å–∫ –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è!). –ú–µ–Ω—å—à–µ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ –º–∞—Å–ª–∞, –±–æ–ª—å—à–µ —Ä—ã–±—ã`;
        }

        if (inflammatoryLoad > 50) {
            insight += `. –í—ã—Å–æ–∫–∞—è –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (${Math.round(inflammatoryLoad)})`;
        }

        const confidence = days.length >= 14 ? 0.75 : 0.60;

        return {
            pattern: PATTERNS.OMEGA_BALANCER,
            available: true,
            totalOmega3: Math.round(totalOmega3 * 10) / 10,
            totalOmega6: Math.round(totalOmega6 * 10) / 10,
            omega6to3Ratio: Math.round(omega6to3Ratio * 10) / 10,
            inflammatoryLoad: Math.round(inflammatoryLoad),
            dataPoints: days.length,
            score,
            confidence,
            insight
        };
    }

    /**
     * C14: Glycemic Load Optimizer.
     * @param {Array} days
     * @param {object} pIndex
     * @returns {object}
     */
    function analyzeGlycemicLoad(days, pIndex) {
        const pattern = PATTERNS.GLYCEMIC_LOAD || 'glycemic_load';
        const minDays = 5;
        const minMealsPerDay = 3;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        const validDays = days.filter(d => Array.isArray(d?.meals) && d.meals.length > 0);
        if (validDays.length === 0) {
            return { pattern, available: false, reason: 'no_meals_data' };
        }

        const totalMeals = validDays.reduce((sum, d) => sum + d.meals.length, 0);
        const avgMealsPerDay = totalMeals / validDays.length;
        if (avgMealsPerDay < minMealsPerDay) {
            return {
                pattern,
                available: false,
                reason: 'min_meals_required',
                minMealsPerDay,
                avgMealsPerDay: Math.round(avgMealsPerDay * 10) / 10
            };
        }

        const dailyGLValues = [];
        const eveningRatios = [];
        let highMealGLCount = 0;
        let mediumMealGLCount = 0;
        let lowMealGLCount = 0;

        for (const day of validDays) {
            let dailyGL = 0;
            let eveningGL = 0;

            for (const meal of day.meals) {
                let mealGL = 0;

                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;

                    const gi = Number(prod.gi) || 0;
                    const carbs = (Number(prod.simple100) || 0) + (Number(prod.complex100) || 0);
                    const grams = Number(item.grams) || 0;

                    if (gi <= 0 || carbs <= 0 || grams <= 0) continue;
                    mealGL += (gi * carbs * grams) / 10000;
                }

                if (mealGL > 20) highMealGLCount++;
                else if (mealGL >= 10) mediumMealGLCount++;
                else lowMealGLCount++;

                dailyGL += mealGL;

                const hour = parseInt(String(meal.time || '00:00').split(':')[0], 10);
                if (!Number.isNaN(hour) && hour >= 18) {
                    eveningGL += mealGL;
                }
            }

            if (dailyGL > 0) {
                dailyGLValues.push(dailyGL);
                eveningRatios.push(eveningGL / dailyGL);
            }
        }

        if (dailyGLValues.length === 0) {
            return { pattern, available: false, reason: 'insufficient_gl_data' };
        }

        const avgDailyGL = average(dailyGLValues);
        const avgEveningRatio = average(eveningRatios);

        const eveningPenalty = avgEveningRatio > 0.5 ? 15 : 0;
        const glPenalty = Math.max(0, avgDailyGL - 80) * 0.5;
        const score = Math.max(0, Math.min(100, Math.round(100 - glPenalty - eveningPenalty)));

        let dailyClass = 'low';
        if (avgDailyGL > 120) dailyClass = 'high';
        else if (avgDailyGL >= 80) dailyClass = 'medium';

        let insight = '';
        if (dailyClass === 'low') {
            insight = `‚úÖ –ù–∏–∑–∫–∞—è GL –Ω–∞–≥—Ä—É–∑–∫–∞: ${Math.round(avgDailyGL)} (—Ü–µ–ª—å <80).`;
        } else if (dailyClass === 'medium') {
            insight = `üü° –£–º–µ—Ä–µ–Ω–Ω–∞—è GL –Ω–∞–≥—Ä—É–∑–∫–∞: ${Math.round(avgDailyGL)}. –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –ø–æ—Ä—Ü–∏–∏ –±—ã—Å—Ç—Ä—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤.`;
        } else {
            insight = `üî¥ –í—ã—Å–æ–∫–∞—è GL –Ω–∞–≥—Ä—É–∑–∫–∞: ${Math.round(avgDailyGL)} (>120). –†–∏—Å–∫ —Å–∞—Ö–∞—Ä–Ω—ã—Ö –∫–∞—á–µ–ª–µ–π.`;
        }

        if (avgEveningRatio > 0.5) {
            insight += ` –í–µ—á–µ—Ä–Ω–∏–π GL ${(avgEveningRatio * 100).toFixed(0)}% (—à—Ç—Ä–∞—Ñ -15).`;
        }

        const baseConfidence = days.length >= 10 ? 0.8 : 0.7;
        const confidence = piStats.applySmallSamplePenalty
            ? piStats.applySmallSamplePenalty(baseConfidence, days.length, minDays)
            : baseConfidence;

        return {
            pattern,
            available: true,
            avgDailyGL: Math.round(avgDailyGL * 10) / 10,
            avgEveningRatio: Math.round(avgEveningRatio * 100) / 100,
            mealGLDistribution: {
                low: lowMealGLCount,
                medium: mediumMealGLCount,
                high: highMealGLCount
            },
            dailyClass,
            daysAnalyzed: validDays.length,
            avgMealsPerDay: Math.round(avgMealsPerDay * 10) / 10,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * C20: Electrolyte Homeostasis.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞.
     */
    function analyzeElectrolyteHomeostasis(days, pIndex) {
        const pattern = PATTERNS.ELECTROLYTE_HOMEOSTASIS || 'electrolyte_homeostasis';
        const minDays = 7;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        let sodiumSum = 0;
        let potassiumSum = 0;
        let magnesiumSum = 0;
        let calciumSum = 0;
        let validDays = 0;
        let highDemandDays = 0;

        for (const day of days) {
            let dayNa = 0;
            let dayK = 0;
            let dayMg = 0;
            let dayCa = 0;

            for (const meal of (day.meals || [])) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;
                    const grams = Number(item.grams) || 0;
                    if (grams <= 0) continue;
                    const factor = grams / 100;

                    dayNa += (Number(prod.sodium100) || Number(prod.sodium) || 0) * factor;
                    dayK += (Number(prod.potassium) || 0) * factor;
                    dayMg += (Number(prod.magnesium) || 0) * factor;
                    dayCa += (Number(prod.calcium) || 0) * factor;
                }
            }

            const trainings = Array.isArray(day.trainings) ? day.trainings : [];
            const sweatRateMax = trainings.reduce((max, t) => {
                const direct = Number(t?.sweatRateMlHour || t?.sweat_ml_h || t?.sweatLossMlPerHour || 0);
                if (direct > 0) return Math.max(max, direct);
                const volume = Number(t?.sweatLossMl || t?.sweat_ml || 0);
                const durationMin = Number(t?.durationMin || t?.duration || 0);
                if (volume > 0 && durationMin > 0) {
                    return Math.max(max, (volume / durationMin) * 60);
                }
                return max;
            }, 0);

            if (sweatRateMax > 800) highDemandDays++;

            if (dayNa + dayK + dayMg + dayCa > 0) {
                sodiumSum += dayNa;
                potassiumSum += dayK;
                magnesiumSum += dayMg;
                calciumSum += dayCa;
                validDays++;
            }
        }

        if (validDays === 0) {
            return { pattern, available: false, reason: 'insufficient_data' };
        }

        const avgNa = sodiumSum / validDays;
        const avgK = potassiumSum / validDays;
        const avgMg = magnesiumSum / validDays;
        const avgCa = calciumSum / validDays;
        const naKRatio = avgK > 0 ? avgNa / avgK : 0;

        const naKScore = naKRatio <= 1 ? 100 : (naKRatio <= 1.5 ? 85 : (naKRatio <= 2 ? 65 : (naKRatio <= 3 ? 40 : 20)));
        const mgScore = Math.min(100, (avgMg / 400) * 100);
        const caScore = Math.min(100, (avgCa / 1000) * 100);
        const kScore = Math.min(100, (avgK / 3500) * 100);

        const demandPenalty = highDemandDays >= 3 ? 12 : (highDemandDays > 0 ? 6 : 0);
        const adaptationBonus = (naKRatio <= 1 && mgScore >= 80) ? 5 : 0;
        const hyponatremiaFlag = highDemandDays > 0 && avgNa < 1500;
        const magnesiumLowFlag = avgMg < 300;

        const rawScore = naKScore * 0.5 + mgScore * 0.2 + caScore * 0.15 + kScore * 0.15;
        const score = Math.max(0, Math.min(100, Math.round(rawScore - demandPenalty + adaptationBonus)));

        let insight = '';
        if (score >= 80) insight = `‚úÖ –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Ö–æ—Ä–æ—à–∏–π (${score}/100).`;
        else if (score >= 60) insight = `üü° –£–º–µ—Ä–µ–Ω–Ω—ã–π —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π —Ä–∏—Å–∫ (${score}/100).`;
        else insight = `üî¥ –í—ã—Ä–∞–∂–µ–Ω–Ω—ã–π —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (${score}/100).`;

        if (naKRatio > 1.5) insight += ` Na:K=${naKRatio.toFixed(2)} (—Ü–µ–ª—å <1.0).`;
        if (hyponatremiaFlag) insight += ' –ü—Ä–∏–∑–Ω–∞–∫–∏ –≥–∏–ø–æ–Ω–∞—Ç—Ä–∏–µ–º–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.';
        if (magnesiumLowFlag) insight += ' –ú–∞–≥–Ω–∏–π –Ω–∏–∂–µ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.';

        const baseConfidence = days.length >= 14 ? 0.8 : 0.7;
        const confidence = piStats.applySmallSamplePenalty
            ? piStats.applySmallSamplePenalty(baseConfidence, days.length, minDays)
            : baseConfidence;

        return {
            pattern,
            available: true,
            avgSodium: Math.round(avgNa),
            avgPotassium: Math.round(avgK),
            avgMagnesium: Math.round(avgMg),
            avgCalcium: Math.round(avgCa),
            naKRatio: Math.round(naKRatio * 100) / 100,
            highDemandDays,
            hyponatremiaFlag,
            magnesiumLowFlag,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * Insulin sensitivity proxy by GI/fiber/timing.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
     * @param {object} profile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞.
     */
    function analyzeInsulinSensitivity(days, pIndex, profile, thresholds = {}) {
        void profile;
        const pattern = PATTERNS.INSULIN_SENSITIVITY || 'insulin_sensitivity';
        const dailyData = [];
        const GI_OPTIMAL = thresholds.giOptimal || 55;
        const GI_MODERATE = (thresholds.giOptimal || 55) + 15;

        for (const day of (days || [])) {
            if (!day?.meals || day.meals.length === 0) continue;

            let totalCarbs = 0;
            let weightedGI = 0;
            let totalFiber = 0;
            let eveningCarbs = 0;
            let totalKcal = 0;

            for (const meal of day.meals) {
                if (!meal?.items) continue;
                const hour = meal.time ? parseInt(String(meal.time).split(':')[0], 10) : 12;

                for (const item of meal.items) {
                    const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id || '').toLowerCase());
                    if (!prod || !item.grams) continue;

                    const grams = Number(item.grams) || 0;
                    const carbs = ((Number(prod.simple100) || 0) + (Number(prod.complex100) || 0)) * grams / 100;
                    const gi = Number(prod.gi || prod.gi100 || prod.GI) || 50;
                    const fiber = (Number(prod.fiber100) || 0) * grams / 100;
                    const p = Number(prod.protein100) || 0;
                    const f = (Number(prod.badFat100) || 0) + (Number(prod.goodFat100) || 0);

                    totalCarbs += carbs;
                    weightedGI += carbs * gi;
                    totalFiber += fiber;
                    totalKcal += (p * 3 + carbs * 4 + f * 9) * grams / 100;

                    if (!Number.isNaN(hour) && hour >= 18) eveningCarbs += carbs;
                }
            }

            if (totalCarbs === 0 || totalKcal === 0) continue;

            const avgGI = weightedGI / totalCarbs;
            const fiberPer1000 = (totalFiber / totalKcal) * 1000;
            const eveningCarbsPct = (eveningCarbs / totalCarbs) * 100;
            const hasTraining = Array.isArray(day.trainings) && day.trainings.length > 0;
            const sleepOk = (Number(day.sleepHours) || 7) >= 7;

            let score = 0;
            if (avgGI <= GI_OPTIMAL) score += 20;
            else if (avgGI <= GI_MODERATE) score += 10;

            if (fiberPer1000 >= 14) score += 20;
            else if (fiberPer1000 >= 10) score += 10;

            if (eveningCarbsPct <= 30) score += 15;
            else if (eveningCarbsPct <= 40) score += 8;

            if (hasTraining) score += 15;
            if (sleepOk) score += 10;
            score += 20;

            dailyData.push({
                date: day.date,
                avgGI: Math.round(avgGI),
                fiberPer1000: Math.round(fiberPer1000 * 10) / 10,
                eveningCarbsPct: Math.round(eveningCarbsPct),
                hasTraining,
                sleepOk,
                score: Math.min(100, score)
            });
        }

        if (dailyData.length < 3) {
            return {
                pattern,
                available: false,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏'
            };
        }

        const avgScore = average(dailyData.map(d => d.score));
        const avgGI = average(dailyData.map(d => d.avgGI));
        const avgFiber = average(dailyData.map(d => d.fiberPer1000));

        let insight;
        if (avgScore >= 75) {
            insight = 'ü©∫ –•–æ—Ä–æ—à–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏!';
        } else if (avgGI > 65) {
            insight = `‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π GI (${Math.round(avgGI)}). –ó–∞–º–µ–Ω–∏ –±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã–µ`;
        } else if (avgFiber < 10) {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ (${Math.round(avgFiber)}–≥/1000–∫–∫–∞–ª). –î–æ–±–∞–≤—å –æ–≤–æ—â–∏`;
        } else {
            insight = '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ';
        }

        return {
            pattern,
            available: true,
            score: Math.round(avgScore),
            avgGI: Math.round(avgGI),
            avgFiberPer1000: Math.round(avgFiber * 10) / 10,
            dataPoints: dailyData.length,
            confidence: dailyData.length >= 7 ? 0.8 : 0.5,
            insight,
            formula: SCIENCE_INFO?.INSULIN_SENSITIVITY?.formula || 'insulin sensitivity score',
            debug: {
                dailyData: dailyData.slice(0, 3),
                source: SCIENCE_INFO?.INSULIN_SENSITIVITY?.source || 'Ludwig, 2002'
            }
        };
    }

    /**
     * Gut health / microbiome proxy.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞.
     */
    function analyzeGutHealth(days, pIndex) {
        const pattern = PATTERNS.GUT_HEALTH || 'gut_health';
        const dailyData = [];
        const fermentedKeywords = ['–∫–µ—Ñ–∏—Ä', '–π–æ–≥—É—Ä—Ç', '–∫–≤–∞—à–µ–Ω', '–∫–∏–º—á–∏', '–º–∏—Å–æ', '—Ç–µ–º–ø–µ', '–∫–æ–º–±—É—á–∞'];

        for (const day of (days || [])) {
            if (!day?.meals || day.meals.length === 0) continue;

            let totalFiber = 0;
            let totalKcal = 0;
            const uniqueProducts = new Set();
            const uniqueCategories = new Set();
            let hasFermented = false;

            for (const meal of day.meals) {
                if (!meal?.items) continue;

                for (const item of meal.items) {
                    const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id || '').toLowerCase());
                    if (!prod || !item.grams) continue;

                    const grams = Number(item.grams) || 0;
                    const p = Number(prod.protein100) || 0;
                    const c = (Number(prod.simple100) || 0) + (Number(prod.complex100) || 0);
                    const f = (Number(prod.badFat100) || 0) + (Number(prod.goodFat100) || 0);

                    totalFiber += (Number(prod.fiber100) || 0) * grams / 100;
                    totalKcal += (p * 3 + c * 4 + f * 9) * grams / 100;

                    uniqueProducts.add(prod.name || prod.id);

                    const category = prod.category || prod.group || prod.foodGroup || prod.type;
                    if (category) uniqueCategories.add(String(category).toLowerCase());

                    const prodName = String(prod.name || '').toLowerCase();
                    if (fermentedKeywords.some(kw => prodName.includes(kw))) {
                        hasFermented = true;
                    }
                }
            }

            if (totalKcal === 0) continue;

            const fiberTotal = totalFiber;
            const diversity = uniqueProducts.size;
            let score = 0;

            if (fiberTotal >= 30) score += 30;
            else if (fiberTotal >= 25) score += 25;
            else if (fiberTotal >= 20) score += 18;
            else if (fiberTotal >= 15) score += 10;

            const categoryDiversity = uniqueCategories.size;
            if (categoryDiversity >= 12) score += 15;
            else if (categoryDiversity >= 8) score += 10;
            else if (categoryDiversity >= 5) score += 5;

            if (diversity >= 20) score += 10;
            else if (diversity >= 15) score += 8;
            else if (diversity >= 10) score += 6;
            else if (diversity >= 5) score += 3;

            if (hasFermented) score += 15;
            score += 30;

            dailyData.push({
                date: day.date,
                fiberTotal: Math.round(fiberTotal),
                diversity,
                categoryDiversity,
                hasFermented,
                score: Math.min(100, score)
            });
        }

        if (dailyData.length < 3) {
            return {
                pattern,
                available: false,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –∫–∏—à–µ—á–Ω–∏–∫–∞'
            };
        }

        const avgScore = average(dailyData.map(d => d.score));
        const avgFiber = average(dailyData.map(d => d.fiberTotal));
        const avgDiversity = average(dailyData.map(d => d.diversity));
        const avgCategoryDiversity = average(dailyData.map(d => d.categoryDiversity));
        const fermentedDays = dailyData.filter(d => d.hasFermented).length;

        let insight;
        if (avgScore >= 75) {
            insight = 'ü¶† –û—Ç–ª–∏—á–Ω–æ –¥–ª—è –º–∏–∫—Ä–æ–±–∏–æ–º–∞! –ú–Ω–æ–≥–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ';
        } else if (avgFiber < 20) {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ (${Math.round(avgFiber)}–≥). –î–æ–±–∞–≤—å –æ–≤–æ—â–∏, –±–æ–±–æ–≤—ã–µ, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ`;
        } else if (avgCategoryDiversity < 8) {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (${Math.round(avgCategoryDiversity)}). –î–æ–±–∞–≤—å –Ω–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
        } else if (avgDiversity < 10) {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è (${Math.round(avgDiversity)} –ø—Ä–æ–¥—É–∫—Ç–æ–≤/–¥–µ–Ω—å). –ü—Ä–æ–±—É–π –Ω–æ–≤–æ–µ!`;
        } else if (fermentedDays < dailyData.length * 0.3) {
            insight = '–î–æ–±–∞–≤—å —Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: –∫–µ—Ñ–∏—Ä, –π–æ–≥—É—Ä—Ç, –∫–≤–∞—à–µ–Ω—É—é –∫–∞–ø—É—Å—Ç—É';
        } else {
            insight = '–ó–¥–æ—Ä–æ–≤—å–µ –∫–∏—à–µ—á–Ω–∏–∫–∞ –≤ –Ω–æ—Ä–º–µ';
        }

        return {
            pattern,
            available: true,
            score: Math.round(avgScore),
            avgFiber: Math.round(avgFiber),
            avgDiversity: Math.round(avgDiversity),
            avgCategoryDiversity: Math.round(avgCategoryDiversity),
            fermentedDaysPct: Math.round((fermentedDays / dailyData.length) * 100),
            dataPoints: dailyData.length,
            confidence: dailyData.length >= 7 ? 0.8 : 0.5,
            insight,
            formula: SCIENCE_INFO?.GUT_HEALTH?.formula || 'gut health score',
            debug: {
                dailyData: dailyData.slice(0, 3),
                fermentedKeywords,
                source: SCIENCE_INFO?.GUT_HEALTH?.source || 'Sonnenburg & Sonnenburg, 2014'
            }
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeHeartHealth = analyzeHeartHealth;
    HEYS.InsightsPI.patternModules.analyzeOmegaBalance = analyzeOmegaBalance;
    HEYS.InsightsPI.patternModules.analyzeGlycemicLoad = analyzeGlycemicLoad;
    HEYS.InsightsPI.patternModules.analyzeElectrolyteHomeostasis = analyzeElectrolyteHomeostasis;
    HEYS.InsightsPI.patternModules.analyzeInsulinSensitivity = analyzeInsulinSensitivity;
    HEYS.InsightsPI.patternModules.analyzeGutHealth = analyzeGutHealth;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/quality.js ===== */
// insights/patterns/quality.js ‚Äî Modular quality analyzers (v6.1.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};
    const piCalculations = HEYS.InsightsPI?.calculations || global.piCalculations || {};

    const PATTERNS = piConst.PATTERNS || {
        MEAL_QUALITY_TREND: 'meal_quality',
        NUTRITION_QUALITY: 'nutrition_quality',
        PROTEIN_SATIETY: 'protein_satiety',
        FIBER_REGULARITY: 'fiber_regularity',
        NOVA_QUALITY: 'nova_quality',
        NUTRIENT_DENSITY: 'nutrient_density'
    };

    const CONFIG = piConst.CONFIG || {
        MIN_CORRELATION_DISPLAY: 0.35
    };

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + (Number(value) || 0), 0) / arr.length;
    };

    const calculateTrend = piStats.calculateTrend || function (values) {
        if (!Array.isArray(values) || values.length < 2) return 0;
        const n = values.length;
        let sumX = 0;
        let sumY = 0;
        let sumXY = 0;
        let sumX2 = 0;
        for (let i = 0; i < n; i++) {
            const y = Number(values[i]) || 0;
            sumX += i;
            sumY += y;
            sumXY += i * y;
            sumX2 += i * i;
        }
        const denom = n * sumX2 - sumX * sumX;
        if (!denom) return 0;
        const slope = (n * sumXY - sumX * sumY) / denom;
        return Number.isFinite(slope) ? slope : 0;
    };

    const pearsonCorrelation = piStats.pearsonCorrelation || function (x, y) {
        if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length < 2) return 0;
        const n = x.length;
        const xMean = average(x);
        const yMean = average(y);
        let numerator = 0;
        let xDen = 0;
        let yDen = 0;
        for (let i = 0; i < n; i++) {
            const dx = (Number(x[i]) || 0) - xMean;
            const dy = (Number(y[i]) || 0) - yMean;
            numerator += dx * dy;
            xDen += dx * dx;
            yDen += dy * dy;
        }
        const denominator = Math.sqrt(xDen * yDen);
        return denominator === 0 ? 0 : numerator / denominator;
    };

    const pearsonWithSignificance = piStats.pearsonWithSignificance || function (x, y, alpha = 0.05) {
        // Fallback if piStats not loaded
        const r = pearsonCorrelation(x, y);
        return {
            r,
            pValue: 1,
            isSignificant: false,
            n: x.length,
            df: x.length - 2,
            tStat: 0,
            effectSize: 'unknown',
            interpretation: 'pearsonWithSignificance not available',
            warning: 'fallback_mode'
        };
    };

    const bayesianCorrelation = piStats.bayesianCorrelation || function (x, y, priorR = 0, priorN = 10) {
        const r = pearsonCorrelation(x, y);
        return { posteriorR: r, observedR: r, shrinkage: 0, effectiveN: x.length, confidence: 0.5 };
    };

    const confidenceIntervalForCorrelation = piStats.confidenceIntervalForCorrelation || function (r, n, confidenceLevel = 0.95) {
        return { lower: Math.max(-1, r - 0.5), upper: Math.min(1, r + 0.5), margin: 0.5, width: 1.0, r, n };
    };

    const detectOutliers = piStats.detectOutliers || function (arr, iqrMultiplier = 1.5) {
        return { outliers: [], cleaned: arr.slice(), indices: [], stats: null };
    };

    /**
     * Meal Quality Trend: —Ç—Ä–µ–Ω–¥ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @param {object} optimum - –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Ç—Ä–µ–Ω–¥–∞ –∫–∞—á–µ—Å—Ç–≤–∞.
     */
    function analyzeMealQualityTrend(days, pIndex, optimum) {
        const pattern = PATTERNS.MEAL_QUALITY_TREND || 'meal_quality';
        const getMealQualityScore = HEYS.getMealQualityScore
            || HEYS.mealScoring?.getMealQualityScore;

        if (typeof getMealQualityScore !== 'function') {
            return {
                pattern,
                available: false,
                reason: 'no_quality_function',
                insight: '–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—ë–º–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'
            };
        }

        const dailyScores = [];

        for (const day of (days || [])) {
            if (!day?.meals || day.meals.length === 0) continue;

            const scores = day.meals.map((meal) => {
                try {
                    const quality = getMealQualityScore(meal, meal.name || '–ü—Ä–∏—ë–º', optimum, pIndex);
                    return Number(quality?.score) || 0;
                } catch (_e) {
                    return 0;
                }
            }).filter(s => s > 0);

            if (scores.length > 0) {
                dailyScores.push({
                    date: day.date,
                    avgScore: average(scores),
                    count: scores.length
                });
            }
        }

        if (dailyScores.length < 3) {
            return {
                pattern,
                available: false,
                reason: 'insufficient_data',
                confidence: 0.3,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞'
            };
        }

        dailyScores.sort((a, b) => String(a.date).localeCompare(String(b.date)));
        const scores = dailyScores.map(d => d.avgScore);

        const trend = calculateTrend(scores);
        const avgScore = average(scores);
        const score = Math.round(avgScore);

        let insight;
        if (trend > 0.5) {
            insight = `üìà –ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è —É–ª—É—á—à–∞–µ—Ç—Å—è! +${Math.round(trend * 7)} –∑–∞ –Ω–µ–¥–µ–ª—é`;
        } else if (trend < -0.5) {
            insight = 'üìâ –ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è —Å–Ω–∏–∂–∞–µ—Ç—Å—è. –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–æ—Å—Ç–∞–≤';
        } else {
            insight = `–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è: ${Math.round(avgScore)}/100`;
        }

        const minDaysForFull = piConst.CONFIG?.MIN_DAYS_FOR_FULL_ANALYSIS || 7;

        return {
            pattern,
            available: true,
            avgScore: Math.round(avgScore),
            trend: Math.round(trend * 100) / 100,
            trendDirection: trend > 0.5 ? 'up' : trend < -0.5 ? 'down' : 'stable',
            dailyScores,
            score,
            confidence: (days || []).length >= minDaysForFull ? 0.8 : 0.5,
            insight
        };
    }

    /**
     * C2: Nutrition Quality.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–∏—Ç–∞–Ω–∏—è.
     */
    function analyzeNutritionQuality(days, pIndex, thresholds = {}, profile = {}) {
        const pattern = PATTERNS.NUTRITION_QUALITY || 'nutrition_quality';
        const dailyData = [];

        for (const day of (days || [])) {
            if (!day?.meals || day.meals.length === 0) continue;

            let totalProtein = 0;
            let totalCarbs = 0;
            let totalSimple = 0;
            let totalFat = 0;
            let totalGoodFat = 0;
            let totalFiber = 0;
            let totalKcal = 0;

            const uniqueProducts = new Set();
            const uniqueCategories = new Set();

            for (const meal of day.meals) {
                if (!meal?.items) continue;

                for (const item of meal.items) {
                    const productId = String(item?.product_id || item?.productId || item?.id || '').toLowerCase();
                    const prod = pIndex?.byId?.get?.(productId);
                    if (!prod || !item?.grams) continue;

                    const p = Number(prod.protein100) || 0;
                    const simple = Number(prod.simple100) || 0;
                    const complex = Number(prod.complex100) || 0;
                    const carbs = simple + complex;
                    const goodFat = Number(prod.goodFat100) || 0;
                    const badFat = Number(prod.badFat100) || 0;
                    const trans = Number(prod.trans100) || 0;
                    const fat = goodFat + badFat + trans;
                    const fiber = Number(prod.fiber100) || 0;
                    const grams = Number(item.grams) || 0;

                    totalProtein += p * grams / 100;
                    totalCarbs += carbs * grams / 100;
                    totalSimple += simple * grams / 100;
                    totalFat += fat * grams / 100;
                    totalGoodFat += goodFat * grams / 100;
                    totalFiber += fiber * grams / 100;
                    totalKcal += (p * 3 + carbs * 4 + fat * 9) * grams / 100;

                    uniqueProducts.add(prod.name || prod.id || item.product_id);
                    const category = prod.category || prod.group || prod.foodGroup || prod.type;
                    if (category) uniqueCategories.add(String(category).toLowerCase());
                }
            }

            if (totalKcal <= 0) continue;

            const proteinPct = (totalProtein * 3 / totalKcal) * 100;
            const fiberPer1000 = (totalFiber / totalKcal) * 1000;
            const simplePct = totalCarbs > 0 ? (totalSimple / totalCarbs) * 100 : 0;
            const goodFatPct = totalFat > 0 ? (totalGoodFat / totalFat) * 100 : 0;

            let score = 0;

            const FIBER_TARGET = thresholds.fiberTarget ? (thresholds.fiberTarget / (profile?.kcalTarget || 2000)) * 1000 : 14;
            const FIBER_MID = FIBER_TARGET * 0.71;
            const FIBER_MIN = FIBER_TARGET * 0.5;

            if (proteinPct >= 25) score += 20;
            else if (proteinPct >= 20) score += 15;
            else if (proteinPct >= 15) score += 8;

            if (fiberPer1000 >= FIBER_TARGET) score += 20;
            else if (fiberPer1000 >= FIBER_MID) score += 12;
            else if (fiberPer1000 >= FIBER_MIN) score += 6;

            if (simplePct <= 30) score += 15;
            else if (simplePct <= 45) score += 8;

            if (goodFatPct >= 60) score += 15;
            else if (goodFatPct >= 40) score += 8;

            if (uniqueCategories.size >= 12) score += 15;
            else if (uniqueCategories.size >= 8) score += 10;
            else if (uniqueCategories.size >= 5) score += 5;

            if (uniqueProducts.size >= 12) score += 10;
            else if (uniqueProducts.size >= 8) score += 6;
            else if (uniqueProducts.size >= 5) score += 3;

            dailyData.push({
                date: day.date,
                score: Math.min(100, score),
                proteinPct: Math.round(proteinPct),
                fiberPer1000: Math.round(fiberPer1000 * 10) / 10,
                simplePct: Math.round(simplePct),
                goodFatPct: Math.round(goodFatPct),
                categories: uniqueCategories.size,
                products: uniqueProducts.size
            });
        }

        if (dailyData.length < 3) {
            return {
                pattern,
                available: false,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–∏—Ç–∞–Ω–∏—è'
            };
        }

        const avgScore = average(dailyData.map(d => d.score));
        const avgFiber = average(dailyData.map(d => d.fiberPer1000));
        const avgProtein = average(dailyData.map(d => d.proteinPct));

        let insight;
        if (avgScore >= 80) {
            insight = 'üåø –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è: –±–∞–ª–∞–Ω—Å –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –Ω–∞ –≤—ã—Å–æ—Ç–µ';
        } else if (avgFiber < 10) {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ (${Math.round(avgFiber)}–≥/1000–∫–∫–∞–ª) ‚Äî –¥–æ–±–∞–≤—å –æ–≤–æ—â–∏`;
        } else if (avgProtein < 20) {
            insight = `‚ö†Ô∏è –ë–µ–ª–∫–∞ –º–∞–ª–æ–≤–∞—Ç–æ (${Math.round(avgProtein)}%) ‚Äî –¥–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫ –±–µ–ª–∫–∞`;
        } else {
            insight = '–ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è –≤ –Ω–æ—Ä–º–µ, –µ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —É–ª—É—á—à–µ–Ω–∏—è';
        }

        return {
            pattern,
            available: true,
            score: Math.round(avgScore),
            avgProteinPct: Math.round(avgProtein),
            avgFiberPer1000: Math.round(avgFiber * 10) / 10,
            dataPoints: dailyData.length,
            confidence: dailyData.length >= 7 ? 0.8 : 0.5,
            insight,
            debug: {
                dailyData: dailyData.slice(0, 3)
            }
        };
    }

    /**
     * Protein Satiety: –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –¥–æ–ª–∏ –±–µ–ª–∫–∞ –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} profile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –±–µ–ª–∫–∞ –∏ —Å—ã—Ç–æ—Å—Ç–∏.
     */
    function analyzeProteinSatiety(days, profile, pIndex) {
        const pattern = PATTERNS.PROTEIN_SATIETY || 'protein_satiety';
        void profile;

        const pairs = [];

        for (const day of (days || [])) {
            if (!day?.meals || day.meals.length === 0) continue;

            let dayProtein = 0;
            let dayKcal = 0;

            for (const meal of day.meals) {
                if (!meal?.items) continue;

                for (const item of meal.items) {
                    const productId = String(item?.product_id || item?.productId || item?.id || '').toLowerCase();
                    const prod = pIndex?.byId?.get?.(productId);
                    if (!prod || !item?.grams) continue;

                    const p = Number(prod.protein100) || 0;
                    const c = (Number(prod.simple100) || 0) + (Number(prod.complex100) || 0);
                    const f = (Number(prod.badFat100) || 0) + (Number(prod.goodFat100) || 0) + (Number(prod.trans100) || 0);
                    const grams = Number(item.grams) || 0;

                    dayProtein += p * grams / 100;
                    dayKcal += (p * 3 + c * 4 + f * 9) * grams / 100;
                }
            }

            if (dayKcal > 0) {
                const proteinPct = (dayProtein * 3 / dayKcal) * 100;
                pairs.push({ proteinPct, protein: dayProtein, kcal: dayKcal, date: day.date });
            }
        }

        if (pairs.length < 7) {
            return {
                pattern,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –±–µ–ª–∫–µ'
            };
        }

        const proteinArr = pairs.map(p => p.proteinPct);
        const kcalArr = pairs.map(p => p.kcal);
        const proteinOutlierCheck = detectOutliers(proteinArr);
        const kcalOutlierCheck = detectOutliers(kcalArr);
        const outlierIndices = new Set([
            ...proteinOutlierCheck.indices,
            ...kcalOutlierCheck.indices
        ]);

        const cleanProtein = [];
        const cleanKcal = [];
        for (let i = 0; i < proteinArr.length; i++) {
            if (!outlierIndices.has(i)) {
                cleanProtein.push(proteinArr[i]);
                cleanKcal.push(kcalArr[i]);
            }
        }

        if (cleanProtein.length < 7) {
            return {
                pattern,
                available: false,
                confidence: 0.2,
                insight: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤ (${cleanProtein.length}/7)`
            };
        }

        const corrResult = pearsonWithSignificance(cleanProtein, cleanKcal);
        const bayesResult = bayesianCorrelation(cleanProtein, cleanKcal, 0.15, 8);
        const ci = confidenceIntervalForCorrelation(corrResult.r, cleanProtein.length);

        const avgProteinPct = average(cleanProtein);
        const avgProteinG = average(pairs.map(p => p.protein));
        const score = avgProteinPct >= 25 ? 100 : avgProteinPct >= 20 ? 80 : 60;

        // Calculate confidence based on effect size and significance
        let calculatedConfidence = 0.5;
        if (corrResult.isSignificant) {
            if (corrResult.effectSize === 'large') calculatedConfidence = 0.9;
            else if (corrResult.effectSize === 'medium') calculatedConfidence = 0.75;
            else if (corrResult.effectSize === 'small') calculatedConfidence = 0.6;
        } else {
            calculatedConfidence = pairs.length >= 14 ? 0.4 : 0.3;
        }

        const ciPenalty = Math.min(0.1, ci.width / 2 * 0.1);
        calculatedConfidence = Math.max(0.2, calculatedConfidence - ciPenalty);

        let insight;
        const r = bayesResult.posteriorR;
        if (!corrResult.isSignificant) {
            insight = `–°–≤—è–∑—å –±–µ–ª–∫–∞ –∏ –∫–∞–ª–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞ (N=${corrResult.n}, p=${corrResult.pValue.toFixed(3)}, 95% CI [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}])`;
        } else if (r < -0.3) {
            insight = `ü•© –ë–æ–ª—å—à–µ –±–µ–ª–∫–∞ ‚Üí –º–µ–Ω—å—à–µ –æ–±—â–∏—Ö –∫–∞–ª–æ—Ä–∏–π! –ë–µ–ª–æ–∫ –Ω–∞—Å—ã—â–∞–µ—Ç (r=${r.toFixed(2)}, p<${corrResult.pValue < 0.01 ? '0.01' : '0.05'}, N=${corrResult.n})`;
        } else if (avgProteinPct >= 25) {
            insight = `üí™ –û—Ç–ª–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–µ–ª–∫–∞: ${Math.round(avgProteinPct)}% –∫–∞–ª–æ—Ä–∞–∂–∞`;
        } else if (avgProteinPct < 20) {
            insight = `‚ö†Ô∏è –ë–µ–ª–æ–∫ ${Math.round(avgProteinPct)}% ‚Äî –¥–æ–±–∞–≤—å –¥–ª—è —Å—ã—Ç–æ—Å—Ç–∏`;
        } else {
            insight = `–ë–µ–ª–æ–∫ –≤ –Ω–æ—Ä–º–µ: ${Math.round(avgProteinPct)}%`;
        }

        return {
            pattern,
            available: true,
            avgProteinPct: Math.round(avgProteinPct),
            avgProteinG: Math.round(avgProteinG),
            correlation: Math.round(corrResult.r * 100) / 100,
            bayesianR: Math.round(bayesResult.posteriorR * 100) / 100,
            pValue: corrResult.pValue,
            isSignificant: corrResult.isSignificant,
            effectSize: corrResult.effectSize,
            confidenceInterval: {
                lower: Math.round(ci.lower * 100) / 100,
                upper: Math.round(ci.upper * 100) / 100,
                width: Math.round(ci.width * 100) / 100
            },
            outlierStats: {
                proteinOutliers: proteinOutlierCheck.outliers.length,
                kcalOutliers: kcalOutlierCheck.outliers.length,
                cleanedN: cleanProtein.length,
                rawN: pairs.length
            },
            dataPoints: cleanProtein.length,
            score,
            confidence: Math.round(calculatedConfidence * 100) / 100,
            insight,
            formula: '–ë–µ–ª–æ–∫% = (protein_g √ó 4 / total_kcal) √ó 100\n–ü–æ—Ä–æ–≥ —Å—ã—Ç–æ—Å—Ç–∏: ‚â•25% = –æ—Ç–ª–∏—á–Ω–æ, 20-25% = –Ω–æ—Ä–º–∞',
            debug: {
                avgKcal: Math.round(average(cleanKcal)),
                source: 'Westerterp-Plantenga, 2003 (PMID: 12724520)',
                calculatedConfidence: Math.round(calculatedConfidence * 100) / 100
            }
        };
    }

    /**
     * Fiber Regularity: –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∫–ª–µ—Ç—á–∞—Ç–∫–∏.
     */
    function analyzeFiberRegularity(days, pIndex) {
        const pattern = PATTERNS.FIBER_REGULARITY || 'fiber_regularity';
        const fiberData = [];

        for (const day of (days || [])) {
            if (!day?.meals) continue;

            let dayFiber = 0;
            let dayKcal = 0;

            for (const meal of day.meals) {
                if (!meal?.items) continue;

                for (const item of meal.items) {
                    const productId = String(item?.product_id || item?.productId || item?.id || '').toLowerCase();
                    const prod = pIndex?.byId?.get?.(productId);
                    if (!prod || !item?.grams) continue;

                    const p = Number(prod.protein100) || 0;
                    const c = (Number(prod.simple100) || 0) + (Number(prod.complex100) || 0);
                    const f = (Number(prod.badFat100) || 0) + (Number(prod.goodFat100) || 0) + (Number(prod.trans100) || 0);
                    const grams = Number(item.grams) || 0;

                    dayFiber += (Number(prod.fiber100) || 0) * grams / 100;
                    dayKcal += (p * 3 + c * 4 + f * 9) * grams / 100;
                }
            }

            if (dayKcal > 0) {
                const fiberPer1000 = (dayFiber / dayKcal) * 1000;
                fiberData.push({ fiber: dayFiber, fiberPer1000, kcal: dayKcal, date: day.date });
            }
        }

        if (fiberData.length < 7) {
            return {
                pattern,
                available: false,
                confidence: 0.2,
                insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–µ—Ç—á–∞—Ç–∫–µ'
            };
        }

        const avgFiber = average(fiberData.map(d => d.fiber));
        const avgFiberPer1000 = average(fiberData.map(d => d.fiberPer1000));
        const stdDev = piStats.stdDev || (() => 0);
        const consistency = avgFiber > 0 ? 100 - (stdDev(fiberData.map(d => d.fiber)) / avgFiber) * 100 : 0;

        const score = avgFiberPer1000 >= 14 ? 100 : avgFiberPer1000 >= 10 ? 70 : 40;

        let insight;
        if (avgFiberPer1000 >= 14) {
            insight = `ü•ó –û—Ç–ª–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∫–ª–µ—Ç—á–∞—Ç–∫–∏: ${Math.round(avgFiber)}–≥/–¥–µ–Ω—å`;
        } else if (avgFiberPer1000 >= 10) {
            insight = `–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≤ –Ω–æ—Ä–º–µ: ${Math.round(avgFiber)}–≥/–¥–µ–Ω—å. –ú–æ–∂–Ω–æ —á—É—Ç—å –±–æ–ª—å—à–µ`;
        } else {
            insight = `‚ö†Ô∏è –ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏: ${Math.round(avgFiber)}–≥/–¥–µ–Ω—å. –î–æ–±–∞–≤—å –æ–≤–æ—â–∏`;
        }

        return {
            pattern,
            available: true,
            avgFiber: Math.round(avgFiber),
            avgFiberPer1000: Math.round(avgFiberPer1000 * 10) / 10,
            consistency: Math.round(consistency),
            dataPoints: fiberData.length,
            score,
            confidence: fiberData.length >= 10 ? 0.8 : 0.5,
            insight,
            formula: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞/1000–∫–∫–∞–ª = (fiber_g / total_kcal) √ó 1000\n–ù–æ—Ä–º–∞: ‚â•14–≥/1000–∫–∫–∞–ª',
            debug: {
                avgKcal: Math.round(average(fiberData.map(d => d.kcal))),
                source: 'Sonnenburg & Sonnenburg, 2014'
            }
        };
    }
    /**
     * C10: NOVA Quality Score.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ NOVA.
     */
    function analyzeNOVAQuality(days, pIndex) {
        const pattern = PATTERNS.NOVA_QUALITY || 'nova_quality';
        const minDays = piConst.CONFIG?.MIN_DAYS_FOR_FULL_ANALYSIS || 7;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        const novaKcal = { 1: 0, 2: 0, 3: 0, 4: 0 };
        let totalKcal = 0;
        let fermentedKcal = 0;
        let rawKcal = 0;

        for (const day of days) {
            for (const meal of (day.meals || [])) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;

                    const itemKcal = calculateItemKcal(item, pIndex);
                    totalKcal += itemKcal;

                    const novaGroup = Number(prod.nova_group || prod.novaGroup) || 3;
                    novaKcal[novaGroup] = (novaKcal[novaGroup] || 0) + itemKcal;

                    if (prod.is_fermented || prod.isFermented) fermentedKcal += itemKcal;
                    if (prod.is_raw || prod.isRaw) rawKcal += itemKcal;
                }
            }
        }

        if (totalKcal < 100) {
            return { pattern, available: false, reason: 'insufficient_energy_data' };
        }

        const novaDistribution = {
            1: Math.round((novaKcal[1] / totalKcal) * 1000) / 10,
            2: Math.round((novaKcal[2] / totalKcal) * 1000) / 10,
            3: Math.round((novaKcal[3] / totalKcal) * 1000) / 10,
            4: Math.round((novaKcal[4] / totalKcal) * 1000) / 10
        };

        const ultraProcessedPct = novaDistribution[4];
        const livingFoodsPct = Math.round(((fermentedKcal + rawKcal) / totalKcal) * 1000) / 10;

        let score = 100 - (ultraProcessedPct * 0.8);
        score += Math.min(livingFoodsPct * 0.5, 10);
        score = Math.max(0, Math.min(100, Math.round(score)));

        let insight = '';
        if (ultraProcessedPct > 50) {
            insight = `üî¥ ${ultraProcessedPct}% –∫–∞–ª–æ—Ä–∏–π –∏–∑ —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ (NOVA-4). –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!`;
        } else if (ultraProcessedPct > 25) {
            insight = `üü† ${ultraProcessedPct}% —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏. –°–Ω–∏–∂–∞–π –∫–æ–ª–±–∞—Å—ã/—Å–Ω–µ–∫–∏/—Å–ª–∞–¥–æ—Å—Ç–∏`;
        } else if (ultraProcessedPct > 10) {
            insight = `üü° ${ultraProcessedPct}% —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏. –í –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã`;
        } else {
            insight = `‚úÖ ${ultraProcessedPct}% —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏. –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞!`;
        }

        if (livingFoodsPct > 5) {
            insight += ` +${livingFoodsPct}% –∂–∏–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ üå±`;
        }

        const confidence = days.length >= 14 ? 0.85 : 0.70;

        return {
            pattern,
            available: true,
            novaDistribution,
            ultraProcessedPct,
            livingFoodsPct,
            fermentedKcal: Math.round(fermentedKcal),
            rawKcal: Math.round(rawKcal),
            totalKcal: Math.round(totalKcal),
            dataPoints: days.length,
            score,
            confidence,
            insight
        };
    }


    const calculateItemKcal = piCalculations.calculateItemKcal || function (item, pIndex) {
        const prod = pIndex?.byId?.get?.(item?.product_id);
        if (!prod) return 0;
        return (Number(prod.kcal100) || 0) * (Number(item?.grams) || 0) / 100;
    };

    /**
     * C21: Nutrient Density Score.
     * @param {Array} days - –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
     * @param {object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ id.
     * @returns {object} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏.
     */
    function analyzeNutrientDensity(days, pIndex) {
        const pattern = PATTERNS.NUTRIENT_DENSITY || 'nutrient_density';
        const minDays = 7;

        if (!Array.isArray(days) || days.length < minDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        let totalKcal = 0;
        let protein = 0;
        let fiber = 0;
        let vitC = 0;
        let iron = 0;
        let magnesium = 0;
        let potassium = 0;
        let calcium = 0;
        let addedSugar = 0;
        let sodium = 0;

        for (const day of days) {
            for (const meal of (day.meals || [])) {
                for (const item of (meal.items || [])) {
                    const prod = pIndex?.byId?.get?.(item?.product_id);
                    if (!prod) continue;

                    const grams = Number(item.grams) || 0;
                    if (grams <= 0) continue;
                    const factor = grams / 100;

                    totalKcal += calculateItemKcal(item, pIndex);
                    protein += (Number(prod.protein100) || 0) * factor;
                    fiber += (Number(prod.fiber100) || 0) * factor;
                    vitC += (Number(prod.vitamin_c) || 0) * factor;
                    iron += (Number(prod.iron) || 0) * factor;
                    magnesium += (Number(prod.magnesium) || 0) * factor;
                    potassium += (Number(prod.potassium) || 0) * factor;
                    calcium += (Number(prod.calcium) || 0) * factor;
                    sodium += (Number(prod.sodium100) || Number(prod.sodium) || 0) * factor;

                    const simple = (Number(prod.simple100) || 0) * factor;
                    const sugar100 = Number(prod.sugar100);
                    if (Number.isFinite(sugar100) && sugar100 > 0) {
                        addedSugar += sugar100 * factor;
                    } else if (Number(prod.nova_group) === 4 && simple > 0) {
                        addedSugar += simple * 0.7;
                    } else if (simple > 0) {
                        addedSugar += simple * 0.3;
                    }
                }
            }
        }

        if (totalKcal < 500) {
            return { pattern, available: false, reason: 'insufficient_energy_data' };
        }

        const per1000 = (value) => (value / totalKcal) * 1000;

        const density = {
            protein: per1000(protein),
            fiber: per1000(fiber),
            vitamin_c: per1000(vitC),
            iron: per1000(iron),
            magnesium: per1000(magnesium),
            potassium: per1000(potassium),
            calcium: per1000(calcium),
            sugar: per1000(addedSugar),
            sodium: per1000(sodium)
        };

        const targets = {
            protein: 35,
            fiber: 14,
            vitamin_c: 45,
            iron: 6,
            magnesium: 200,
            potassium: 1750,
            calcium: 500
        };

        const positives =
            Math.min(1, density.protein / targets.protein) * 20 +
            Math.min(1, density.fiber / targets.fiber) * 20 +
            Math.min(1, density.vitamin_c / targets.vitamin_c) * 15 +
            Math.min(1, density.iron / targets.iron) * 10 +
            Math.min(1, density.magnesium / targets.magnesium) * 10 +
            Math.min(1, density.potassium / targets.potassium) * 15 +
            Math.min(1, density.calcium / targets.calcium) * 10;

        const sugarPenalty = density.sugar > 25 ? Math.min(15, (density.sugar - 25) * 0.4) : 0;
        const sodiumPenalty = density.sodium > 1000 ? Math.min(15, (density.sodium - 1000) * 0.01) : 0;

        const score = Math.max(0, Math.min(100, Math.round(positives - sugarPenalty - sodiumPenalty)));

        let insight = '';
        if (score >= 80) insight = `‚úÖ –í—ã—Å–æ–∫–∞—è –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (${score}/100).`;
        else if (score >= 60) insight = `üü° –°—Ä–µ–¥–Ω—è—è –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (${score}/100).`;
        else insight = `üî¥ –ù–∏–∑–∫–∞—è –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (${score}/100): ¬´–ø—É—Å—Ç—ã–µ –∫–∞–ª–æ—Ä–∏–∏¬ª.`;

        if (density.fiber < targets.fiber) insight += ' –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –Ω–∞ 1000 –∫–∫–∞–ª –Ω–∏–∂–µ —Ü–µ–ª–∏.';
        if (density.sugar > 25) insight += ` –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä ${density.sugar.toFixed(1)}–≥/1000–∫–∫–∞–ª.`;
        if (density.sodium > 1000) insight += ` –ù–∞—Ç—Ä–∏–π ${Math.round(density.sodium)}–º–≥/1000–∫–∫–∞–ª.`;

        const baseConfidence = days.length >= 14 ? 0.8 : 0.7;
        const confidence = piStats.applySmallSamplePenalty
            ? piStats.applySmallSamplePenalty(baseConfidence, days.length, minDays)
            : baseConfidence;

        return {
            pattern,
            available: true,
            kcalAnalyzed: Math.round(totalKcal),
            density: {
                protein: Math.round(density.protein * 10) / 10,
                fiber: Math.round(density.fiber * 10) / 10,
                vitamin_c: Math.round(density.vitamin_c * 10) / 10,
                iron: Math.round(density.iron * 10) / 10,
                magnesium: Math.round(density.magnesium),
                potassium: Math.round(density.potassium),
                calcium: Math.round(density.calcium),
                sugar: Math.round(density.sugar * 10) / 10,
                sodium: Math.round(density.sodium)
            },
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeMealQualityTrend = analyzeMealQualityTrend;
    HEYS.InsightsPI.patternModules.analyzeNutritionQuality = analyzeNutritionQuality;
    HEYS.InsightsPI.patternModules.analyzeProteinSatiety = analyzeProteinSatiety;
    HEYS.InsightsPI.patternModules.analyzeFiberRegularity = analyzeFiberRegularity;
    HEYS.InsightsPI.patternModules.analyzeNOVAQuality = analyzeNOVAQuality;
    HEYS.InsightsPI.patternModules.analyzeNutrientDensity = analyzeNutrientDensity;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/patterns/micronutrients.js ===== */
// insights/patterns/micronutrients.js ‚Äî Modular micronutrient analyzers (v6.3.0)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const piStats = HEYS.InsightsPI?.stats || global.piStats || {};
    const piConst = HEYS.InsightsPI?.constants || global.piConst || {};

    const checkMinN = piStats.checkMinN || ((days, minDays) => ({ ok: Array.isArray(days) && days.length >= minDays }));
    const applySmallSamplePenalty = piStats.applySmallSamplePenalty || ((baseConfidence) => baseConfidence);

    const average = piStats.average || function (arr) {
        if (!Array.isArray(arr) || arr.length === 0) return 0;
        return arr.reduce((sum, value) => sum + (Number(value) || 0), 0) / arr.length;
    };

    const PATTERNS = piConst.PATTERNS || {
        MICRONUTRIENT_RADAR: 'micronutrient_radar',
        VITAMIN_DEFENSE: 'vitamin_defense',
        B_COMPLEX_ANEMIA: 'b_complex_anemia',
        ADDED_SUGAR_DEPENDENCY: 'added_sugar_dependency',
        BONE_HEALTH: 'bone_health'
    };

    /**
     * Resolve product data from a meal item via product index fallbacks.
     * @param {object} item - Meal item wrapper.
     * @param {object} pIndex - Product index.
     * @returns {object|null} Resolved product object.
     */
    function resolveProduct(item, pIndex) {
        if (!item) return null;

        if (pIndex?.byId?.get && item.product_id != null) {
            const direct = pIndex.byId.get(item.product_id)
                || pIndex.byId.get(String(item.product_id))
                || pIndex.byId.get(String(item.product_id).toLowerCase());
            if (direct) return direct;
        }

        const candidateNames = [item.name, item.title, item.productName].filter(Boolean)
            .map(v => String(v).trim().toLowerCase())
            .filter(Boolean);

        if (pIndex?.byName?.get) {
            for (const name of candidateNames) {
                const byName = pIndex.byName.get(name);
                if (byName) return byName;
            }
        }

        if (item.vitamin_a || item.protein100 || item.simple100 || item.calcium || item.vitamin_b12) {
            return item;
        }

        return null;
    }

    /**
     * Iterate over every meal item in a day.
     * @param {object} day - Day object.
     * @param {(item: object, meal: object) => void} iteratee - Iteration callback.
     * @returns {void}
     */
    function eachMealItem(day, iteratee) {
        for (const meal of (day?.meals || [])) {
            for (const item of (meal?.items || [])) {
                iteratee(item, meal);
            }
        }
    }

    /**
     * C7: Micronutrient Radar (Hidden Hunger).
     * @param {Array} days - Days to analyze.
     * @param {object} pIndex - Product index.
     * @param {object} profile - User profile.
     * @returns {object} Pattern result.
     */
    function analyzeMicronutrients(days, pIndex, profile) {
        const pattern = PATTERNS.MICRONUTRIENT_RADAR || 'micronutrient_radar';
        const minDays = piConst?.CONFIG?.MIN_DAYS_FOR_FULL_ANALYSIS || 7;

        if (!Array.isArray(days) || days.length < minDays) {
            return { pattern, available: false };
        }

        void profile;

        // DRI targets (Daily Reference Intake, % of DV)
        const DRI_TARGETS = {
            iron: 100,
            magnesium: 100,
            zinc: 100,
            calcium: 100
        };

        const micronutrients = { iron: [], magnesium: [], zinc: [], calcium: [] };

        for (const day of days) {
            if (!day?.meals?.length) continue;

            const dayNutrients = { iron: 0, magnesium: 0, zinc: 0, calcium: 0 };

            eachMealItem(day, (item) => {
                const prod = resolveProduct(item, pIndex);
                if (!prod) return;

                const grams = Number(item.grams) || 0;
                const factor = grams / 100;

                if (prod.iron) dayNutrients.iron += Number(prod.iron) * factor;
                if (prod.magnesium) dayNutrients.magnesium += Number(prod.magnesium) * factor;
                if (prod.zinc) dayNutrients.zinc += Number(prod.zinc) * factor;
                if (prod.calcium) dayNutrients.calcium += Number(prod.calcium) * factor;
            });

            micronutrients.iron.push((dayNutrients.iron / 18) * 100);
            micronutrients.magnesium.push((dayNutrients.magnesium / 400) * 100);
            micronutrients.zinc.push((dayNutrients.zinc / 11) * 100);
            micronutrients.calcium.push((dayNutrients.calcium / 1000) * 100);
        }

        const avgIntake = {
            iron: average(micronutrients.iron),
            magnesium: average(micronutrients.magnesium),
            zinc: average(micronutrients.zinc),
            calcium: average(micronutrients.calcium)
        };

        const deficits = [];
        for (const [nutrient, avgPct] of Object.entries(avgIntake)) {
            if (avgPct < 70) {
                deficits.push({ nutrient, avgPct: Math.round(avgPct), target: DRI_TARGETS[nutrient] });
            }
        }

        const lowEnergyDays = days.filter(d => d.energy && d.energy < 3).length;
        const poorSleepDays = days.filter(d => d.sleepQuality && d.sleepQuality < 3).length;

        let score = 100;
        deficits.forEach(d => {
            score -= (100 - d.avgPct) * 0.5;
        });
        score = Math.max(0, Math.round(score));

        let insight = '';
        if (deficits.length === 0) {
            insight = `‚úÖ –í—Å–µ 4 –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –Ω–æ—Ä–º–µ (Fe ${Math.round(avgIntake.iron)}%, Mg ${Math.round(avgIntake.magnesium)}%, Zn ${Math.round(avgIntake.zinc)}%, Ca ${Math.round(avgIntake.calcium)}%)`;
        } else {
            const deficitNames = deficits.map(d => {
                const names = { iron: 'Fe', magnesium: 'Mg', zinc: 'Zn', calcium: 'Ca' };
                return `${names[d.nutrient]} ${d.avgPct}%`;
            }).join(', ');
            insight = `‚ö†Ô∏è –î–µ—Ñ–∏—Ü–∏—Ç—ã: ${deficitNames}. `;

            if (deficits.some(d => d.nutrient === 'iron') && lowEnergyDays > days.length * 0.4) {
                insight += `–ù–∏–∑–∫–æ–µ Fe ‚Üí —É—Å—Ç–∞–ª–æ—Å—Ç—å (${lowEnergyDays} –¥–Ω–µ–π). `;
            }
            if (deficits.some(d => d.nutrient === 'magnesium') && poorSleepDays > days.length * 0.4) {
                insight += `–ù–∏–∑–∫–∏–π Mg ‚Üí –ø–ª–æ—Ö–æ–π —Å–æ–Ω (${poorSleepDays} –¥–Ω–µ–π). `;
            }
        }

        const confidence = days.length >= 14 ? 0.75 : 0.60;

        return {
            pattern,
            available: true,
            avgIntake: {
                iron: Math.round(avgIntake.iron),
                magnesium: Math.round(avgIntake.magnesium),
                zinc: Math.round(avgIntake.zinc),
                calcium: Math.round(avgIntake.calcium)
            },
            deficits,
            lowEnergyDays,
            poorSleepDays,
            dataPoints: days.length,
            score,
            confidence,
            insight
        };
    }

    /**
     * C13: Vitamin Defense Radar.
     * @param {Array} days - Days to analyze.
     * @param {object} profile - User profile.
     * @param {object} pIndex - Product index.
     * @returns {object} Pattern result.
     */
    function analyzeVitaminDefense(days, profile, pIndex) {
        const pattern = PATTERNS.VITAMIN_DEFENSE || 'vitamin_defense';
        const minDays = 7;

        const nCheck = checkMinN(days, minDays);
        const hasMinDays = typeof nCheck === 'boolean' ? nCheck : Boolean(nCheck?.ok);
        if (!hasMinDays) {
            return { pattern, available: false, reason: 'min_days_required', minDaysRequired: minDays, daysProvided: Array.isArray(days) ? days.length : 0 };
        }

        const validDays = (days || []).filter(d => d && d.meals && d.meals.length > 0);
        const avgProductsPerDay = validDays.length > 0
            ? validDays.reduce((sum, d) => sum + d.meals.reduce((pSum, m) => pSum + (m.items?.length || 0), 0), 0) / validDays.length
            : 0;

        if (avgProductsPerDay < 3) {
            return { pattern, available: false, reason: 'min-products', avgProducts: Math.round(avgProductsPerDay * 10) / 10 };
        }

        const gender = profile?.gender || 'male';
        const DRI = {
            vitamin_a: gender === 'female' ? 700 : 900,
            vitamin_c: gender === 'female' ? 75 : 90,
            vitamin_d: 15,
            vitamin_e: 15,
            vitamin_k: gender === 'female' ? 90 : 120,
            vitamin_b1: 1.2,
            vitamin_b2: 1.3,
            vitamin_b3: 16,
            vitamin_b6: 1.3,
            vitamin_b9: 400,
            vitamin_b12: 2.4
        };

        const vitaminData = {};
        const vitaminKeys = Object.keys(DRI);

        vitaminKeys.forEach(vitKey => {
            let totalIntake = 0;
            let daysWithData = 0;

            validDays.forEach(day => {
                let dayIntake = 0;
                eachMealItem(day, (item) => {
                    const prod = resolveProduct(item, pIndex);
                    if (!prod) return;
                    const vitValue = Number(prod[vitKey] || prod[`${vitKey}_100`]) || 0;
                    if (vitValue <= 0) return;
                    const grams = Number(item.grams || item.amount) || 0;
                    dayIntake += vitValue * grams / 100;
                });

                if (dayIntake > 0) {
                    totalIntake += dayIntake;
                    daysWithData++;
                }
            });

            const avgDailyIntake = daysWithData > 0 ? totalIntake / daysWithData : 0;
            const pctDV = (avgDailyIntake / DRI[vitKey]) * 100;

            vitaminData[vitKey] = {
                intake: Math.round(avgDailyIntake * 10) / 10,
                dri: DRI[vitKey],
                pctDV: Math.round(pctDV),
                deficit: pctDV < 70,
                daysWithData
            };
        });

        const clusters = {
            antioxidant: ['vitamin_a', 'vitamin_c', 'vitamin_e'],
            bone: ['vitamin_d', 'vitamin_k'],
            energy: ['vitamin_b1', 'vitamin_b2', 'vitamin_b3', 'vitamin_b6'],
            blood: ['vitamin_b9', 'vitamin_b12']
        };

        const clusterScores = {};
        Object.keys(clusters).forEach(clusterKey => {
            const vitKeys = clusters[clusterKey];
            const avgPct = vitKeys.reduce((sum, vk) => sum + (vitaminData[vk]?.pctDV || 0), 0) / vitKeys.length;
            clusterScores[clusterKey] = {
                avgPct: Math.round(avgPct),
                risk: avgPct < 70,
                vitamins: vitKeys
            };
        });

        const deficitList = vitaminKeys.filter(vk => vitaminData[vk].deficit);
        const countDeficits = deficitList.length;
        const score = Math.max(0, Math.min(100, 100 - (countDeficits * 8)));

        const baseConfidence = validDays.length >= 14 ? 0.80 : 0.70;
        const confidence = applySmallSamplePenalty(baseConfidence, validDays.length, 10);

        let insight = `Vitamin Defense Radar: ${countDeficits} –∏–∑ 11 –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –Ω–∏–∂–µ 70% DRI`;
        if (countDeficits === 0) {
            insight = 'üåü –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ 11 –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –≤ –Ω–æ—Ä–º–µ (‚â•70% DRI)';
        } else if (countDeficits <= 2) {
            insight = `‚ö†Ô∏è –õ–µ–≥–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç: ${deficitList.join(', ')} < 70% DRI`;
        } else if (countDeficits >= 5) {
            insight = `üö® –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç: ${countDeficits} –≤–∏—Ç–∞–º–∏–Ω–æ–≤ —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è`;
        }

        return {
            pattern,
            available: true,
            vitaminData,
            clusterScores,
            deficitList,
            countDeficits,
            daysAnalyzed: validDays.length,
            avgProductsPerDay: Math.round(avgProductsPerDay * 10) / 10,
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight
        };
    }

    /**
     * C22: B-Complex Energy & Anemia Risk.
     * @param {Array} days - Days to analyze.
     * @param {object} profile - User profile.
     * @param {object} pIndex - Product index.
     * @returns {object} Pattern result.
     */
    function analyzeBComplexAnemia(days, profile, pIndex) {
        const pattern = PATTERNS.B_COMPLEX_ANEMIA || 'b_complex_anemia';
        const minDays = 7;

        const nCheck = checkMinN(days, minDays);
        const hasMinDays = typeof nCheck === 'boolean' ? nCheck : Boolean(nCheck?.ok);
        if (!hasMinDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        const isFemale = profile?.gender === 'female' || profile?.gender === '–ñ–µ–Ω—Å–∫–æ–π';
        const DRI = {
            vitamin_b1: 1.2,
            vitamin_b2: 1.3,
            vitamin_b3: 16,
            vitamin_b6: 1.3,
            vitamin_b9: 400,
            vitamin_b12: 2.4,
            iron: isFemale ? 18 : 8
        };

        const nutrientKeys = Object.keys(DRI);
        const nutrientData = {};

        nutrientKeys.forEach((nutrient) => {
            let totalIntake = 0;
            let daysWithData = 0;

            (days || []).forEach(day => {
                let dayIntake = 0;
                eachMealItem(day, (item) => {
                    const product = resolveProduct(item, pIndex);
                    if (!product) return;
                    const value = Number(product[nutrient] || product[`${nutrient}_100`]) || 0;
                    const grams = Number(item.grams || item.amount) || 0;
                    dayIntake += (value * grams) / 100;
                });

                if (dayIntake > 0) {
                    totalIntake += dayIntake;
                    daysWithData++;
                }
            });

            const avgIntake = daysWithData > 0 ? totalIntake / daysWithData : 0;
            const pctDV = (avgIntake / DRI[nutrient]) * 100;

            nutrientData[nutrient] = {
                intake: Math.round(avgIntake * 10) / 10,
                dri: DRI[nutrient],
                pctDV: Math.round(pctDV),
                deficit: pctDV < 70
            };
        });

        const energyQuartet = ['vitamin_b1', 'vitamin_b2', 'vitamin_b3', 'vitamin_b6'];
        const bloodPair = ['vitamin_b9', 'vitamin_b12'];

        // Normalize pctDV to max 200% to prevent score overflow (user may take vitamin supplements with 500-3000% DV)
        const energyBscore = Math.round(average(energyQuartet.map(v => Math.min(200, nutrientData[v]?.pctDV || 0))));
        const bloodBscore = Math.round(average(bloodPair.map(v => Math.min(200, nutrientData[v]?.pctDV || 0))));

        const ironDeficit = nutrientData.iron?.pctDV < 70;
        const b12Deficit = nutrientData.vitamin_b12?.pctDV < 70;
        const folateDeficit = nutrientData.vitamin_b9?.pctDV < 70;

        let anemiaRisk = 0;
        if (ironDeficit) anemiaRisk += 30;
        if (b12Deficit) anemiaRisk += 30;
        if (folateDeficit) anemiaRisk += 25;
        if (ironDeficit && b12Deficit && folateDeficit) anemiaRisk = 100;

        const score = Math.max(0, Math.min(100, Math.round(energyBscore * 0.4 + bloodBscore * 0.3 + (100 - anemiaRisk) * 0.3)));
        const baseConfidence = score >= 70 ? 0.75 : 0.65;
        const confidence = applySmallSamplePenalty(baseConfidence, days.length, minDays);

        return {
            pattern,
            available: true,
            nutrientData,
            energyBscore,
            bloodBscore,
            anemiaRisk,
            daysAnalyzed: days.length,
            genderAdjusted: isFemale ? 'female (Fe DRI 18mg)' : 'male (Fe DRI 8mg)',
            score,
            confidence: Math.round(confidence * 100) / 100,
            insight: anemiaRisk >= 70
                ? '‚ùå –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –∞–Ω–µ–º–∏–∏, –Ω—É–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ä–∞—Ü–∏–æ–Ω–∞'
                : anemiaRisk >= 30
                    ? '‚ö†Ô∏è –£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –∞–Ω–µ–º–∏–∏, —Å–ª–µ–¥–∏ –∑–∞ –∂–µ–ª–µ–∑–æ–º/B9/B12'
                    : '‚úÖ –†–∏—Å–∫ –∞–Ω–µ–º–∏–∏ –Ω–∏–∑–∫–∏–π'
        };
    }

    /**
     * C18: Added Sugar & Dependency patterns.
     * @param {Array} days - Days to analyze.
     * @param {object} pIndex - Product index.
     * @returns {object} Pattern result.
     */
    function analyzeAddedSugarDependency(days, pIndex) {
        const pattern = PATTERNS.ADDED_SUGAR_DEPENDENCY || 'added_sugar_dependency';
        const minDays = 7;

        const nCheck = checkMinN(days, minDays);
        const hasMinDays = typeof nCheck === 'boolean' ? nCheck : Boolean(nCheck?.ok);
        if (!hasMinDays) {
            return {
                pattern,
                available: false,
                reason: 'min_days_required',
                minDaysRequired: minDays,
                daysProvided: Array.isArray(days) ? days.length : 0
            };
        }

        const dailySugar = [];
        const dailyConfidence = [];

        for (const day of days) {
            let sugar = 0;
            let confWeighted = 0;

            eachMealItem(day, (item) => {
                const prod = resolveProduct(item, pIndex);
                if (!prod) return;

                const grams = Number(item.grams) || 0;
                const factor = grams / 100;
                const simple = (Number(prod.simple100) || 0) * factor;

                let addedSugar = 0;
                let conf = 0;

                const sugar100 = Number(prod.sugar100);
                if (Number.isFinite(sugar100) && sugar100 > 0) {
                    addedSugar = sugar100 * factor;
                    conf = 1.0;
                } else if (Number(prod.nova_group) === 4 && simple > 0) {
                    addedSugar = simple * 0.70;
                    conf = 0.70;
                } else if (simple > 0) {
                    addedSugar = simple * 0.30;
                    conf = 0.50;
                }

                sugar += addedSugar;
                confWeighted += addedSugar * conf;
            });

            dailySugar.push(sugar);
            dailyConfidence.push(sugar > 0 ? confWeighted / sugar : 0);
        }

        const avgDailySugar = average(dailySugar);
        const avgConfidence = average(dailyConfidence);

        let maxStreak = 0;
        let streak = 0;
        dailySugar.forEach((s) => {
            if (s > 25) {
                streak++;
                maxStreak = Math.max(maxStreak, streak);
            } else {
                streak = 0;
            }
        });

        const dependencyPenalty = maxStreak >= 5 ? 20 : (maxStreak >= 3 ? 10 : 0);
        const sugarPenalty = Math.max(0, avgDailySugar - 25) * 1.5;
        const score = Math.round(Math.max(0, 100 - sugarPenalty - dependencyPenalty) * (avgConfidence || 0.5));

        return {
            pattern,
            available: true,
            avgDailySugar: Math.round(avgDailySugar * 10) / 10,
            avgConfidence: Math.round(avgConfidence * 100) / 100,
            maxStreak,
            dependencyRisk: maxStreak >= 5,
            score,
            confidence: Math.round(applySmallSamplePenalty(0.7, days.length, minDays) * 100) / 100,
            insight: maxStreak >= 5
                ? `üî¥ –ò–∑–±—ã—Ç–æ—á–Ω—ã–π —Å–∞—Ö–∞—Ä ${avgDailySugar.toFixed(1)}–≥/–¥–µ–Ω—å, streak ${maxStreak} –¥–Ω–µ–π`
                : avgDailySugar > 25
                    ? `üü° –°–∞—Ö–∞—Ä –≤ –∑–æ–Ω–µ –≤–Ω–∏–º–∞–Ω–∏—è: ${avgDailySugar.toFixed(1)}–≥/–¥–µ–Ω—å`
                    : `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º: ${avgDailySugar.toFixed(1)}–≥/–¥–µ–Ω—å`
        };
    }

    /**
     * C17: Bone Health index.
     * @param {Array} days - Days to analyze.
     * @param {object} profile - User profile.
     * @param {object} pIndex - Product index.
     * @returns {object} Pattern result.
     */
    function analyzeBoneHealth(days, profile, pIndex) {
        const pattern = PATTERNS.BONE_HEALTH || 'bone_health';
        const minDays = 14;

        const nCheck = checkMinN(days, minDays);
        const hasMinDays = typeof nCheck === 'boolean' ? nCheck : Boolean(nCheck?.ok);
        if (!hasMinDays) {
            return { pattern, available: false, reason: 'min_days_required' };
        }

        const isFemale = profile?.gender === 'female' || profile?.gender === '–ñ–µ–Ω—Å–∫–æ–π';
        const age = Number(profile?.age) || 0;
        const vitKTarget = isFemale ? 90 : 120;
        const riskPenalty = isFemale && age > 55 ? 12 : (isFemale && age > 45 ? 6 : 0);
        const targetMultiplier = riskPenalty > 0 ? 1.2 : 1.0;

        let caSum = 0;
        let dSum = 0;
        let kSum = 0;
        let pSum = 0;
        let strengthDays = 0;

        for (const day of days) {
            eachMealItem(day, (item) => {
                const prod = resolveProduct(item, pIndex);
                if (!prod) return;

                const grams = Number(item.grams) || 0;
                const factor = grams / 100;
                caSum += (Number(prod.calcium) || 0) * factor;
                dSum += (Number(prod.vitamin_d) || 0) * factor;
                kSum += (Number(prod.vitamin_k) || 0) * factor;
                pSum += (Number(prod.phosphorus) || 0) * factor;
            });

            if ((day.trainings || []).some(t => t?.type === 'strength')) strengthDays++;
        }

        const avgCa = caSum / days.length;
        const avgD = dSum / days.length;
        const avgK = kSum / days.length;
        const avgP = pSum / days.length;

        const caPct = Math.min(1, avgCa / (1000 * targetMultiplier)) * 35;
        const dPct = Math.min(1, avgD / (15 * targetMultiplier)) * 25;
        const kPct = Math.min(1, avgK / (vitKTarget * targetMultiplier)) * 15;
        const pPct = Math.min(1, avgP / (700 * targetMultiplier)) * 10;

        const caPRatio = avgP > 0 ? avgCa / avgP : 0;

        let ratioBonus = 0;
        if (caPRatio >= 1.0 && caPRatio <= 2.0) ratioBonus = 10;
        else if (caPRatio < 0.5) ratioBonus = -15;
        else if (caPRatio > 3.0) ratioBonus = -5;

        const exerciseBonus = strengthDays >= 6 ? 10 : (strengthDays >= 4 ? 5 : 0);
        const score = Math.max(0, Math.min(100, Math.round(caPct + dPct + kPct + pPct + ratioBonus + exerciseBonus - riskPenalty)));

        return {
            pattern,
            available: true,
            avgCa: Math.round(avgCa),
            avgVitD: Math.round(avgD * 10) / 10,
            avgVitK: Math.round(avgK),
            avgPhosphorus: Math.round(avgP),
            caPRatio: Math.round(caPRatio * 100) / 100,
            strengthDays,
            riskPenalty,
            score,
            confidence: Math.round(applySmallSamplePenalty(0.7, days.length, minDays) * 100) / 100,
            insight: score >= 80
                ? `‚úÖ –ö–æ—Å—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Ö–æ—Ä–æ—à–∏–π (${score}/100)`
                : score >= 60
                    ? `üü° –£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –ø–æ –∫–æ—Å—Ç–Ω–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é (${score}/100)`
                    : `üî¥ –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∫–æ—Å—Ç–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (${score}/100)`
        };
    }

    HEYS.InsightsPI.patternModules = HEYS.InsightsPI.patternModules || {};
    HEYS.InsightsPI.patternModules.analyzeMicronutrients = analyzeMicronutrients;
    HEYS.InsightsPI.patternModules.analyzeVitaminDefense = analyzeVitaminDefense;
    HEYS.InsightsPI.patternModules.analyzeBComplexAnemia = analyzeBComplexAnemia;
    HEYS.InsightsPI.patternModules.analyzeAddedSugarDependency = analyzeAddedSugarDependency;
    HEYS.InsightsPI.patternModules.analyzeBoneHealth = analyzeBoneHealth;
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_patterns.js ===== */
/* eslint-disable jsdoc/require-param-type, jsdoc/require-returns, jsdoc/require-param */
// pi_patterns.js ‚Äî Pattern Analysis Functions v4.0.0
// Extracted from heys_predictive_insights_v1.js (Phase 3)
// 22 analyze* —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–∏—Ç–∞–Ω–∏—è, —Å–Ω–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Ü–∏–∫–ª–∞
if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  const piConst = HEYS.InsightsPI?.constants || window.piConst || {};
  const patternModules = HEYS.InsightsPI?.patternModules || {};
  let _thresholdsCtxCache = { key: null, thresholds: null };

  /**
   * Get adaptive thresholds for current context
   * –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç cache-first cascade strategy –∏–∑ pi_thresholds.js
   * In-memory –∫—ç—à —É–¥–∞–ª–µ–Ω ‚Äî pi_thresholds.js —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ localStorage
   */
  function getThresholdsContext(days, profile, pIndex) {
    const firstDate = days?.[0]?.date || '';
    const lastDate = days?.[days.length - 1]?.date || '';
    const pIndexSize = pIndex?.byId?.size || 0;
    const cacheKey = [
      days?.length || 0,
      firstDate,
      lastDate,
      profile?.id || '',
      profile?.weight || '',
      profile?.goal || '',
      pIndexSize
    ].join('|');

    if (_thresholdsCtxCache.key === cacheKey && _thresholdsCtxCache.thresholds) {
      return _thresholdsCtxCache.thresholds;
    }

    console.log('[pi_patterns] üéØ getThresholdsContext called:', {
      daysCount: days?.length,
      profileId: profile?.id,
      hasPIndex: !!pIndex
    });

    if (!HEYS.InsightsPI.thresholds || !days || days.length === 0) {
      console.warn('[pi_patterns] ‚ö†Ô∏è Missing thresholds module or days');
      return {};
    }

    console.log('[pi_patterns] üîÑ Fetching thresholds (may use cache)...');
    const computed = HEYS.InsightsPI.thresholds.get(days, profile, pIndex);
    console.log('[pi_patterns] ‚úÖ Received thresholds:', {
      confidence: computed.confidence,
      count: Object.keys(computed.thresholds || {}).length,
      meta: computed.meta
    });

    _thresholdsCtxCache = {
      key: cacheKey,
      thresholds: computed.thresholds || {}
    };

    return _thresholdsCtxCache.thresholds;
  }

  // –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ pi_constants.js)
  const PATTERNS = piConst.PATTERNS || {
    MEAL_TIMING: 'meal_timing',
    WAVE_OVERLAP: 'wave_overlap',
    LATE_EATING: 'late_eating',
    MEAL_QUALITY_TREND: 'meal_quality',
    SLEEP_WEIGHT: 'sleep_weight',
    SLEEP_HUNGER: 'sleep_hunger',
    TRAINING_KCAL: 'training_kcal',
    STEPS_WEIGHT: 'steps_weight',
    PROTEIN_SATIETY: 'protein_satiety',
    FIBER_REGULARITY: 'fiber_regularity',
    STRESS_EATING: 'stress_eating',
    MOOD_FOOD: 'mood_food',
    CIRCADIAN: 'circadian',
    NUTRIENT_TIMING: 'nutrient_timing',
    INSULIN_SENSITIVITY: 'insulin_sensitivity',
    GUT_HEALTH: 'gut_health',
    NUTRITION_QUALITY: 'nutrition_quality',
    NEAT_ACTIVITY: 'neat_activity',
    MOOD_TRAJECTORY: 'mood_trajectory',
    // v4.0 patterns (B1-B6)
    SLEEP_QUALITY: 'sleep_quality',
    WELLBEING_CORRELATION: 'wellbeing_correlation',
    HYDRATION: 'hydration',
    BODY_COMPOSITION: 'body_composition',
    CYCLE_IMPACT: 'cycle_impact',
    WEEKEND_EFFECT: 'weekend_effect',
    // v5.0 patterns (C7-C12)
    MICRONUTRIENT_RADAR: 'micronutrient_radar',
    OMEGA_BALANCER: 'omega_balancer',
    HEART_HEALTH: 'heart_health',
    NOVA_QUALITY: 'nova_quality',
    TRAINING_RECOVERY: 'training_recovery',
    HYPERTROPHY: 'hypertrophy',
    GLYCEMIC_LOAD: 'glycemic_load',
    PROTEIN_DISTRIBUTION: 'protein_distribution',
    ANTIOXIDANT_DEFENSE: 'antioxidant_defense',
    ADDED_SUGAR_DEPENDENCY: 'added_sugar_dependency',
    BONE_HEALTH: 'bone_health',
    TRAINING_TYPE_MATCH: 'training_type_match',
    ELECTROLYTE_HOMEOSTASIS: 'electrolyte_homeostasis',
    NUTRIENT_DENSITY: 'nutrient_density',
    VITAMIN_DEFENSE: 'vitamin_defense',
    B_COMPLEX_ANEMIA: 'b_complex_anemia'
  };

  // === –ê–ù–ê–õ–ò–ó –ü–ê–¢–¢–ï–†–ù–û–í ===

  /**
   * –ê–Ω–∞–ª–∏–∑ —Ç–∞–π–º–∏–Ω–≥–∞ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω
   * @param days
   * @param profile
   * @param pIndex
   */
  function analyzeMealTiming(days, profile, pIndex) {
    if (typeof patternModules.analyzeMealTiming === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeMealTiming(days, profile, thresholds);
    }

    return {
      pattern: PATTERNS.MEAL_TIMING || 'meal_timing',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω
   * @param days
   * @param profile
   */
  function analyzeWaveOverlap(days, profile) {
    if (typeof patternModules.analyzeWaveOverlap === 'function') {
      return patternModules.analyzeWaveOverlap(days, profile);
    }

    return {
      pattern: PATTERNS.WAVE_OVERLAP || 'wave_overlap',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
   * @param days
   * @param profile
   * @param pIndex
   */
  function analyzeLateEating(days, profile, pIndex) {
    if (typeof patternModules.analyzeLateEating === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeLateEating(days, thresholds);
    }

    return {
      pattern: PATTERNS.LATE_EATING || 'late_eating',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—ë–º–æ–≤ (MealQualityScore)
   * @param days
   * @param pIndex
   * @param optimum
   */
  function analyzeMealQualityTrend(days, pIndex, optimum) {
    if (typeof patternModules.analyzeMealQualityTrend === 'function') {
      return patternModules.analyzeMealQualityTrend(days, pIndex, optimum);
    }

    return {
      pattern: PATTERNS.MEAL_QUALITY_TREND || 'meal_quality',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C2: Nutrition Quality ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è (–º–∞–∫—Ä–æ + –∫–ª–µ—Ç—á–∞—Ç–∫–∞ + –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
   * @param days
   * @param pIndex
   * @param profile
   */
  function analyzeNutritionQuality(days, pIndex, profile) {
    if (typeof patternModules.analyzeNutritionQuality === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeNutritionQuality(days, pIndex, thresholds);
    }

    return {
      pattern: PATTERNS.NUTRITION_QUALITY || 'nutrition_quality',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–Ω–∞ –∏ –≤–µ—Å–∞
   * @param days
   */
  function analyzeSleepWeight(days) {
    if (typeof patternModules.analyzeSleepWeight === 'function') {
      return patternModules.analyzeSleepWeight(days);
    }

    return {
      pattern: PATTERNS.SLEEP_WEIGHT || 'sleep_weight',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –Ω–µ–¥–æ—Å—ã–ø–∞ –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è
   * FIX v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º calculateDayKcal —á–µ—Ä–µ–∑ pIndex
   * @param days
   * @param profile
   * @param pIndex
   */
  function analyzeSleepHunger(days, profile, pIndex) {
    if (typeof patternModules.analyzeSleepHunger === 'function') {
      return patternModules.analyzeSleepHunger(days, profile, pIndex);
    }

    return {
      pattern: PATTERNS.SLEEP_HUNGER || 'sleep_hunger',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –∫–∞–ª–æ—Ä–∏–π
   * FIX v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º calculateDayKcal —á–µ—Ä–µ–∑ pIndex
   * @param days
   * @param pIndex
   */
  function analyzeTrainingKcal(days, pIndex) {
    if (typeof patternModules.analyzeTrainingKcal === 'function') {
      return patternModules.analyzeTrainingKcal(days, pIndex);
    }

    return {
      pattern: PATTERNS.TRAINING_KCAL || 'training_kcal',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —à–∞–≥–æ–≤ –∏ –≤–µ—Å–∞
   * @param days
   */
  function analyzeStepsWeight(days) {
    if (typeof patternModules.analyzeStepsWeight === 'function') {
      return patternModules.analyzeStepsWeight(days);
    }

    return {
      pattern: PATTERNS.STEPS_WEIGHT || 'steps_weight',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C4: NEAT Trend ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ç—Ä–µ–Ω–¥
   * @param days
   */
  function analyzeNEATTrend(days) {
    if (typeof patternModules.analyzeNEATTrend === 'function') {
      return patternModules.analyzeNEATTrend(days);
    }

    return {
      pattern: PATTERNS.NEAT_ACTIVITY || 'neat_activity',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –±–µ–ª–∫–∞ –∏ —Å—ã—Ç–æ—Å—Ç–∏
   * FIX v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º pIndex –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–∞–∫—Ä–æ—Å–æ–≤
   * @param days
   * @param profile
   * @param pIndex
   */
  function analyzeProteinSatiety(days, profile, pIndex) {
    if (typeof patternModules.analyzeProteinSatiety === 'function') {
      return patternModules.analyzeProteinSatiety(days, profile, pIndex);
    }

    return {
      pattern: PATTERNS.PROTEIN_SATIETY || 'protein_satiety',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ –∫–ª–µ—Ç—á–∞—Ç–∫–∏
   * FIX v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º pIndex –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫–ª–µ—Ç—á–∞—Ç–∫–∏
   * @param days
   * @param pIndex
   */
  function analyzeFiberRegularity(days, pIndex) {
    if (typeof patternModules.analyzeFiberRegularity === 'function') {
      return patternModules.analyzeFiberRegularity(days, pIndex);
    }

    return {
      pattern: PATTERNS.FIBER_REGULARITY || 'fiber_regularity',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å—Ç—Ä–µ—Å—Å–∞ –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è
   * FIX v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º calculateDayKcal —á–µ—Ä–µ–∑ pIndex
   * @param days
   * @param pIndex
   */
  function analyzeStressEating(days, pIndex) {
    if (typeof patternModules.analyzeStressEating === 'function') {
      return patternModules.analyzeStressEating(days, pIndex);
    }

    return {
      pattern: PATTERNS.STRESS_EATING || 'stress_eating',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –µ–¥—ã
   * @param days
   * @param pIndex
   * @param optimum
   */
  function analyzeMoodFood(days, pIndex, optimum) {
    if (typeof patternModules.analyzeMoodFood === 'function') {
      return patternModules.analyzeMoodFood(days, pIndex, optimum);
    }

    return {
      pattern: PATTERNS.MOOD_FOOD || 'mood_food',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C6: Mood Trajectory ‚Äî –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ vs —Å–æ—Å—Ç–∞–≤ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
   * @param days
   * @param pIndex
   */
  function analyzeMoodTrajectory(days, pIndex) {
    if (typeof patternModules.analyzeMoodTrajectory === 'function') {
      return patternModules.analyzeMoodTrajectory(days, pIndex);
    }

    return {
      pattern: PATTERNS.MOOD_TRAJECTORY || 'mood_trajectory',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === –ù–û–í–´–ï –ù–ê–£–ß–ù–´–ï –ê–ù–ê–õ–ò–ó–ê–¢–û–†–´ v2.0 ===

  /**
   * üåÖ –¶–∏—Ä–∫–∞–¥–Ω—ã–π –∞–Ω–∞–ª–∏–∑ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
   * PMID: 23512957 (Garaulet), 24154571 (Jakubowicz)
   * @param days
   * @param pIndex
   * @param profile
   */
  function analyzeCircadianTiming(days, pIndex, profile) {
    if (typeof patternModules.analyzeCircadianTiming === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeCircadianTiming(days, pIndex, thresholds);
    }

    return {
      pattern: PATTERNS.CIRCADIAN || 'circadian',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * ü•© –¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ ‚Äî –∫–æ–≥–¥–∞ —Å—ä–µ–¥–µ–Ω—ã –±–µ–ª–æ–∫/—É–≥–ª–µ–≤–æ–¥—ã/–∂–∏—Ä—ã
   * PMID: 24477298 (Areta), 23360586 (Aragon & Schoenfeld)
   * @param days
   * @param pIndex
   * @param profile
   */
  function analyzeNutrientTiming(days, pIndex, profile) {
    if (typeof patternModules.analyzeNutrientTiming === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeNutrientTiming(days, pIndex, profile, thresholds);
    }

    return {
      pattern: PATTERNS.NUTRIENT_TIMING || 'nutrient_timing',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * ü©∫ –ü—Ä–æ–∫—Å–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   * –ö–æ—Å–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ GI, –∫–ª–µ—Ç—á–∞—Ç–∫–∏, —Ç–∞–π–º–∏–Ω–≥–∞ —É–≥–ª–µ–≤–æ–¥–æ–≤
   * PMID: 12936919 (Brand-Miller), 8198048 (Wolever)
   * @param days
   * @param pIndex
   * @param profile
   */
  function analyzeInsulinSensitivity(days, pIndex, profile) {
    if (typeof patternModules.analyzeInsulinSensitivity === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeInsulinSensitivity(days, pIndex, profile, thresholds);
    }

    return {
      pattern: PATTERNS.INSULIN_SENSITIVITY || 'insulin_sensitivity',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * ü¶† –ó–¥–æ—Ä–æ–≤—å–µ –∫–∏—à–µ—á–Ω–∏–∫–∞ / –º–∏–∫—Ä–æ–±–∏–æ–º
   * PMID: 24336217 (Sonnenburg), 29902436 (Makki)
   * @param days
   * @param pIndex
   */
  function analyzeGutHealth(days, pIndex) {
    if (typeof patternModules.analyzeGutHealth === 'function') {
      return patternModules.analyzeGutHealth(days, pIndex);
    }

    return {
      pattern: PATTERNS.GUT_HEALTH || 'gut_health',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === NEW v4.0 PATTERNS (B1-B6) ===

  /**
   * B1: Sleep Quality ‚Üí Next Day Metrics (time-lagged correlation)
   * –ù–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏ –°–õ–ï–î–£–Æ–©–ï–ì–û –¥–Ω—è
   * @param days
   * @param pIndex
   */
  function analyzeSleepQuality(days, pIndex) {
    if (typeof patternModules.analyzeSleepQuality === 'function') {
      return patternModules.analyzeSleepQuality(days, pIndex);
    }

    return {
      pattern: PATTERNS.SLEEP_QUALITY || 'sleep_quality',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * B2: Wellbeing Correlation ‚Äî —á—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ
   * @param days
   * @param pIndex
   */
  function analyzeWellbeing(days, pIndex) {
    if (typeof patternModules.analyzeWellbeing === 'function') {
      return patternModules.analyzeWellbeing(days, pIndex);
    }

    return {
      pattern: PATTERNS.WELLBEING_CORRELATION || 'wellbeing_correlation',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * B3: Hydration ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ (30ml/kg –í–û–ó)
   * @param days
   */
  function analyzeHydration(days) {
    if (typeof patternModules.analyzeHydration === 'function') {
      return patternModules.analyzeHydration(days);
    }

    return {
      pattern: PATTERNS.HYDRATION || 'hydration',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * B4: Body Composition ‚Äî WHR (waist-hip ratio) —Å —Ç—Ä–µ–Ω–¥–æ–º
   * @param days
   * @param profile
   */
  function analyzeBodyComposition(days, profile) {
    if (typeof patternModules.analyzeBodyComposition === 'function') {
      return patternModules.analyzeBodyComposition(days, profile);
    }

    return {
      pattern: PATTERNS.BODY_COMPOSITION || 'body_composition',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * B5: Cycle Impact ‚Äî –≤–ª–∏—è–Ω–∏–µ –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–∞–∑–∏—Ä–æ–≤–∫–∞)
   * @param days
   * @param pIndex
   * @param profile
   */
  function analyzeCyclePatterns(days, pIndex, profile) {
    if (typeof patternModules.analyzeCyclePatterns === 'function') {
      return patternModules.analyzeCyclePatterns(days, pIndex, profile);
    }

    return {
      pattern: PATTERNS.CYCLE_IMPACT || 'cycle_impact',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * B6: Weekend Effect ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ç-–≤—Å vs –ø–Ω-—á—Ç
   * @param days
   * @param pIndex
   */
  function analyzeWeekendEffect(days, pIndex) {
    if (typeof patternModules.analyzeWeekendEffect === 'function') {
      return patternModules.analyzeWeekendEffect(days, pIndex);
    }

    return {
      pattern: PATTERNS.WEEKEND_EFFECT || 'weekend_effect',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C10: NOVA QUALITY SCORE ===
  /**
   * –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–∏—Ç–∞–Ω–∏—è –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ NOVA
   * @param days
   * @param pIndex
   * @returns {object} - { pattern, available, novaDistribution, ultraProcessedPct, livingFoodsBonus, score, insight, confidence }
   */
  function analyzeNOVAQuality(days, pIndex) {
    if (typeof patternModules.analyzeNOVAQuality === 'function') {
      return patternModules.analyzeNOVAQuality(days, pIndex);
    }

    return {
      pattern: PATTERNS.NOVA_QUALITY || 'nova_quality',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C11: TRAINING INTENSITY & RECOVERY ===
  /**
   * –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
   * @param days
   * @returns {object} - { pattern, available, highIntensityDays, avgRecovery, overtrainingRisk, score, insight, confidence }
   */
  function analyzeTrainingRecovery(days) {
    if (typeof patternModules.analyzeTrainingRecovery === 'function') {
      return patternModules.analyzeTrainingRecovery(days);
    }

    return {
      pattern: PATTERNS.TRAINING_RECOVERY || 'training_recovery',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C12: HYPERTROPHY & BODY COMPOSITION ===
  /**
   * –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–ª–∞ (–º—ã—à–µ—á–Ω–∞—è –º–∞—Å—Å–∞ vs –∂–∏—Ä–æ–≤–∞—è)
   * @param days
   * @param profile
   * @returns {object} - { pattern, available, bicepsTrend, thighTrend, weightChange, compositionQuality, score, insight, confidence }
   */
  function analyzeHypertrophy(days, profile) {
    if (typeof patternModules.analyzeHypertrophy === 'function') {
      return patternModules.analyzeHypertrophy(days, profile);
    }

    return {
      pattern: PATTERNS.HYPERTROPHY || 'hypertrophy',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C7: MICRONUTRIENT RADAR ("Hidden Hunger") ===
  /**
   * –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (–∂–µ–ª–µ–∑–æ, –º–∞–≥–Ω–∏–π, —Ü–∏–Ω–∫, –∫–∞–ª—å—Ü–∏–π)
   * @param days
   * @param pIndex
   * @param profile
   * @returns {object} - { pattern, available, deficits, avgIntake, score, insight, confidence }
   */
  function analyzeMicronutrients(days, pIndex, profile) {
    if (typeof patternModules.analyzeMicronutrients === 'function') {
      return patternModules.analyzeMicronutrients(days, pIndex, profile);
    }

    return {
      pattern: PATTERNS.MICRONUTRIENT_RADAR || 'micronutrient_radar',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C9: HEART & METABOLIC HEALTH ===
  /**
   * –ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã—Ö —Ä–∏—Å–∫–æ–≤ (Na/K —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ, —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω)
   * @param days
   * @param pIndex
   * @returns {object} - { pattern, available, naKRatio, sodiumLoad, cholesterolAvg, score, insight, confidence }
   */
  function analyzeHeartHealth(days, pIndex) {
    if (typeof patternModules.analyzeHeartHealth === 'function') {
      return patternModules.analyzeHeartHealth(days, pIndex);
    }

    return {
      pattern: PATTERNS.HEART_HEALTH || 'heart_health',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C8: OMEGA BALANCE & INFLAMMATION ===
  /**
   * –ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–∞–æ–º–µ–≥–∞-3/–æ–º–µ–≥–∞-6 –∏ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
   * @param days
   * @param pIndex
   * @returns {object} - { pattern, available, omega6to3Ratio, inflammatoryLoad, score, insight, confidence }
   */
  function analyzeOmegaBalance(days, pIndex) {
    if (typeof patternModules.analyzeOmegaBalance === 'function') {
      return patternModules.analyzeOmegaBalance(days, pIndex);
    }

    return {
      pattern: PATTERNS.OMEGA_BALANCER || 'omega_balancer',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  // === C13: VITAMIN DEFENSE RADAR (v6.3 modular) ===
  /**
   *
   * @param days
   * @param profile
   * @param pIndex
   */
  function analyzeVitaminDefense(days, profile, pIndex) {
    if (typeof patternModules.analyzeVitaminDefense === 'function') {
      return patternModules.analyzeVitaminDefense(days, profile, pIndex);
    }

    return {
      pattern: PATTERNS.VITAMIN_DEFENSE || 'vitamin_defense',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C22: B-Complex Energy & Anemia Risk
   * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç 6 –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã B (energy quartet + blood pair) + –∂–µ–ª–µ–∑–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏
   * —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –∏ —Ä–∏—Å–∫–∞ –∞–Ω–µ–º–∏–∏ (iron-deficiency, pernicious, megaloblastic).
   * –ö–ª–∞—Å—Ç–µ—Ä—ã: energyBscore (B1/B2/B3/B6) –∏ bloodBscore (B9/B12).
   * Gender-adjusted: –∂–µ–ª–µ–∑–æ 18mg (female) vs 8mg (male).
   * @param {Array} days ‚Äî –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π —Å meals
   * @param {object} profile ‚Äî {gender}
   * @param pIndex
   * @returns {object} ‚Äî {pattern, available, energyBscore, bloodBscore, anemiaRisk, score, confidence, insight}
   */
  function analyzeBComplexAnemia(days, profile, pIndex) {
    if (typeof patternModules.analyzeBComplexAnemia === 'function') {
      return patternModules.analyzeBComplexAnemia(days, profile, pIndex);
    }

    return {
      pattern: PATTERNS.B_COMPLEX_ANEMIA || 'b_complex_anemia',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C14: Glycemic Load Optimizer
   * –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É per meal –∏ per day (GI √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤).
   * MinDays: 5, MinMeals: 3/day average
   * @param {Array} days
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeGlycemicLoad(days, pIndex) {
    if (typeof patternModules.analyzeGlycemicLoad === 'function') {
      return patternModules.analyzeGlycemicLoad(days, pIndex);
    }

    return {
      pattern: PATTERNS.GLYCEMIC_LOAD || 'glycemic_load',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C15: Protein Distribution (Leucine Threshold)
   * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ –ø–æ –ø—Ä–∏—ë–º–∞–º: —Ü–µ–ª—å 20-40–≥/–ø—Ä–∏—ë–º.
   * MinDays: 7, MinMeals: 2/day average
   * @param {Array} days
   * @param {object} profile
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeProteinDistribution(days, profile, pIndex) {
    if (typeof patternModules.analyzeProteinDistribution === 'function') {
      const thresholds = getThresholdsContext(days, profile, pIndex);
      return patternModules.analyzeProteinDistribution(days, profile, pIndex, thresholds);
    }

    return {
      pattern: PATTERNS.PROTEIN_DISTRIBUTION || 'protein_distribution',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C16: Antioxidant Defense Score
   * –ò–Ω–¥–µ–∫—Å –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–æ–π –∑–∞—â–∏—Ç—ã: A/C/E + Se + Zn —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.
   * @param {Array} days
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeAntioxidantDefense(days, pIndex) {
    if (typeof patternModules.analyzeAntioxidantDefense === 'function') {
      return patternModules.analyzeAntioxidantDefense(days, pIndex);
    }

    return {
      pattern: PATTERNS.ANTIOXIDANT_DEFENSE || 'antioxidant_defense',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C18: Added Sugar & Dependency Patterns
   * Tier-aware –æ—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ (A/B/C) + dependency flags.
   * @param {Array} days
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeAddedSugarDependency(days, pIndex) {
    if (typeof patternModules.analyzeAddedSugarDependency === 'function') {
      return patternModules.analyzeAddedSugarDependency(days, pIndex);
    }

    return {
      pattern: PATTERNS.ADDED_SUGAR_DEPENDENCY || 'added_sugar_dependency',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C17: Bone Health Index
   * –ö–æ–º–ø–ª–µ–∫—Å: Ca + D + K + P + Ca:P ratio + strength stimulus.
   * @param {Array} days
   * @param {object} profile
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeBoneHealth(days, profile, pIndex) {
    if (typeof patternModules.analyzeBoneHealth === 'function') {
      return patternModules.analyzeBoneHealth(days, profile, pIndex);
    }

    return {
      pattern: PATTERNS.BONE_HEALTH || 'bone_health',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C19: Training-Type Nutrition Match
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–µ–º—É —Ç–∏–ø—É –Ω–∞–≥—Ä—É–∑–∫–∏.
   * @param {Array} days
   * @param {object} profile
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeTrainingTypeMatch(days, profile, pIndex) {
    if (typeof patternModules.analyzeTrainingTypeMatch === 'function') {
      return patternModules.analyzeTrainingTypeMatch(days, profile, pIndex);
    }

    return {
      pattern: PATTERNS.TRAINING_TYPE_MATCH || 'training_type_match',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C20: Electrolyte Homeostasis
   * –û—Ü–µ–Ω–∫–∞ —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ Na/K/Mg/Ca —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–≥–æ –ø–æ—Ç–æ–æ—Ç–¥–µ–ª–µ–Ω–∏—è.
   * @param {Array} days
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeElectrolyteHomeostasis(days, pIndex) {
    if (typeof patternModules.analyzeElectrolyteHomeostasis === 'function') {
      return patternModules.analyzeElectrolyteHomeostasis(days, pIndex);
    }

    return {
      pattern: PATTERNS.ELECTROLYTE_HOMEOSTASIS || 'electrolyte_homeostasis',
      available: false,
      reason: 'module_not_loaded'
    };
  }

  /**
   * C21: Nutrient Density Score
   * –û—Ü–µ–Ω–∫–∞ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ 1000 –∫–∫–∞–ª (NRF-–ø–æ–¥–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞).
   * @param {Array} days
   * @param {object} pIndex
   * @returns {object}
   */
  function analyzeNutrientDensity(days, pIndex) {
    if (typeof patternModules.analyzeNutrientDensity === 'function') {
      return patternModules.analyzeNutrientDensity(days, pIndex);
    }

    return {
      pattern: PATTERNS.NUTRIENT_DENSITY || 'nutrient_density',
      available: false,
      reason: 'module_not_loaded'
    };
  }


  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsightsPI.patterns = {
    analyzeMealTiming,
    analyzeWaveOverlap,
    analyzeLateEating,
    analyzeMealQualityTrend,
    analyzeSleepWeight,
    analyzeSleepHunger,
    analyzeTrainingKcal,
    analyzeStepsWeight,
    analyzeProteinSatiety,
    analyzeFiberRegularity,
    analyzeNutritionQuality,
    analyzeStressEating,
    analyzeMoodFood,
    analyzeMoodTrajectory,
    analyzeCircadianTiming,
    analyzeNutrientTiming,
    analyzeInsulinSensitivity,
    analyzeGutHealth,
    analyzeNEATTrend,
    // v4.0 (B1-B6)
    analyzeSleepQuality,
    analyzeWellbeing,
    analyzeHydration,
    analyzeBodyComposition,
    analyzeCyclePatterns,
    analyzeWeekendEffect,
    // v5.0 (C7-C12)
    analyzeNOVAQuality,
    analyzeTrainingRecovery,
    analyzeHypertrophy,
    analyzeMicronutrients,
    analyzeHeartHealth: patternModules.analyzeHeartHealth || analyzeHeartHealth, // C9: Heart Health (v6.0, modular-ready)
    analyzeOmegaBalance: patternModules.analyzeOmegaBalance || analyzeOmegaBalance, // C8: Omega Balance (v6.0, modular-ready)
    analyzeVitaminDefense: patternModules.analyzeVitaminDefense || analyzeVitaminDefense, // C13: Vitamin Defense Radar (v6.3, modular-ready)
    analyzeBComplexAnemia: patternModules.analyzeBComplexAnemia || analyzeBComplexAnemia, // C22: B-Complex Energy & Anemia Risk (v6.3, modular-ready)
    analyzeGlycemicLoad: patternModules.analyzeGlycemicLoad || analyzeGlycemicLoad, // C14: Glycemic Load Optimizer (v6.0, modular-ready)
    analyzeProteinDistribution: patternModules.analyzeProteinDistribution || analyzeProteinDistribution, // C15: Protein Distribution (v6.0, modular-ready)
    analyzeAntioxidantDefense: patternModules.analyzeAntioxidantDefense || analyzeAntioxidantDefense, // C16: Antioxidant Defense (v6.0, modular-ready)
    analyzeAddedSugarDependency: patternModules.analyzeAddedSugarDependency || analyzeAddedSugarDependency, // C18: Added Sugar & Dependency (v6.3, modular-ready)
    analyzeBoneHealth: patternModules.analyzeBoneHealth || analyzeBoneHealth, // C17: Bone Health (v6.3, modular-ready)
    analyzeTrainingTypeMatch: patternModules.analyzeTrainingTypeMatch || analyzeTrainingTypeMatch, // C19: Training-Type Match (v6.0, modular-ready)
    analyzeElectrolyteHomeostasis: patternModules.analyzeElectrolyteHomeostasis || analyzeElectrolyteHomeostasis, // C20: Electrolyte Homeostasis (v6.0, modular-ready)
    analyzeNutrientDensity: patternModules.analyzeNutrientDensity || analyzeNutrientDensity // C21: Nutrient Density (v6.0, modular-ready)
  };

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piPatterns = HEYS.InsightsPI.patterns;

  devLog('[PI Patterns] v6.3.0 loaded ‚Äî 40 pattern analyzers (modular-router for C8/C9/C13/C14/C15/C16/C17/C18/C19/C20/C21/C22)');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_advanced.js ===== */
// pi_advanced.js ‚Äî Advanced Analytics Functions v3.0.0
// Extracted from heys_predictive_insights_v1.js (Phase 4)
// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: Health Score, What-If, Weight Prediction, Weekly Wrap
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  const piStats = HEYS.InsightsPI?.stats || window.piStats || {};
  const piPatterns = HEYS.InsightsPI?.patterns || window.piPatterns || {};
  const SCIENCE_INFO = HEYS.InsightsPI?.constants?.SCIENCE_INFO || window.piConst?.SCIENCE_INFO || HEYS.InsightsPI?.science || window.piScience || {};
  const piConst = HEYS.InsightsPI?.constants || window.piConst || {};

  // –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–∫–ª—é—á–∞—è v5.0)
  const PATTERNS = piConst.PATTERNS || {
    MEAL_TIMING: 'meal_timing',
    WAVE_OVERLAP: 'wave_overlap',
    LATE_EATING: 'late_eating',
    MEAL_QUALITY_TREND: 'meal_quality',
    SLEEP_WEIGHT: 'sleep_weight',
    SLEEP_HUNGER: 'sleep_hunger',
    TRAINING_KCAL: 'training_kcal',
    STEPS_WEIGHT: 'steps_weight',
    PROTEIN_SATIETY: 'protein_satiety',
    FIBER_REGULARITY: 'fiber_regularity',
    STRESS_EATING: 'stress_eating',
    MOOD_FOOD: 'mood_food',
    CIRCADIAN: 'circadian',
    NUTRIENT_TIMING: 'nutrient_timing',
    INSULIN_SENSITIVITY: 'insulin_sensitivity',
    GUT_HEALTH: 'gut_health',
    NUTRITION_QUALITY: 'nutrition_quality',
    NEAT_ACTIVITY: 'neat_activity',
    MOOD_TRAJECTORY: 'mood_trajectory',
    // v5.0 patterns (C7-C12)
    MICRONUTRIENT_RADAR: 'micronutrient_radar',
    OMEGA_BALANCER: 'omega_balancer',
    HEART_HEALTH: 'heart_health',
    NOVA_QUALITY: 'nova_quality',
    TRAINING_RECOVERY: 'training_recovery',
    HYPERTROPHY: 'hypertrophy',
    // v6.0 patterns (fallback for load order)
    VITAMIN_DEFENSE: 'vitamin_defense',
    B_COMPLEX_ANEMIA: 'b_complex_anemia',
    GLYCEMIC_LOAD: 'glycemic_load',
    PROTEIN_DISTRIBUTION: 'protein_distribution',
    ANTIOXIDANT_DEFENSE: 'antioxidant_defense',
    ADDED_SUGAR_DEPENDENCY: 'added_sugar_dependency',
    BONE_HEALTH: 'bone_health',
    TRAINING_TYPE_MATCH: 'training_type_match',
    ELECTROLYTE_HOMEOSTASIS: 'electrolyte_homeostasis',
    NUTRIENT_DENSITY: 'nutrient_density'
  };

  const CONFIG = piConst.CONFIG || {
    MIN_CORRELATION_DISPLAY: 0.35,
    MIN_DAYS_FOR_FULL_ANALYSIS: 7
  };

  // –ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ pi_stats.js (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
  const { average, calculateLinearRegression } = piStats;

  // === HEALTH SCORE (Goal-Aware v2.0) ===

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å Health Score (0-100)
   * Goal-aware: –≤–µ—Å–∞ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ü–µ–ª–∏ (–ø–æ—Ö—É–¥–µ–Ω–∏–µ/–Ω–∞–±–æ—Ä/–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ)
   * 
   * @param {Array} patterns - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
   * @param {Object} profile - –ø—Ä–æ—Ñ–∏–ª—å —Å deficitPctTarget
   */
  function calculateHealthScore(patterns, profile) {
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    /**
     * –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è –≤ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º score.
     * 1. –ë–µ—Ä—ë–º confidence (0..1, –ª–∏–±–æ 0..100 -> –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º)
     * 2. –ü–æ–Ω–∏–∂–∞–µ–º –≤–∫–ª–∞–¥ preliminary –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
     * 3. –£—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –¥–æ requiredDataPoints, –µ—Å–ª–∏ –µ—Å—Ç—å
     */
    const getPatternReliability = (p) => {
      let baseConfidence = Number(p?.confidence);

      if (!Number.isFinite(baseConfidence)) {
        baseConfidence = 0.5;
      }

      if (baseConfidence > 1 && baseConfidence <= 100) {
        baseConfidence = baseConfidence / 100;
      }

      baseConfidence = clamp(baseConfidence, 0.15, 1);

      if (p?.isPreliminary) {
        baseConfidence = Math.min(baseConfidence, 0.55);
      }

      const dataPoints = Number(p?.dataPoints);
      const requiredDataPoints = Number(p?.requiredDataPoints);

      if (Number.isFinite(dataPoints) && Number.isFinite(requiredDataPoints) && requiredDataPoints > 0) {
        const completionRatio = clamp(dataPoints / requiredDataPoints, 0.25, 1);
        baseConfidence *= completionRatio;
      }

      return clamp(baseConfidence, 0.1, 1);
    };

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å (Number() –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –∏–∑ localStorage)
    const deficitPct = Number(profile?.deficitPctTarget) || 0;
    let goalMode = 'maintenance';
    if (deficitPct <= -10) goalMode = 'deficit';
    else if (deficitPct >= 10) goalMode = 'bulk';

    // Goal-aware –≤–µ—Å–∞
    const weightsByGoal = {
      deficit: {
        nutrition: 0.25,   // –ú–µ–Ω—å—à–µ, —Ç.–∫. –¥–µ—Ñ–∏—Ü–∏—Ç = –º–µ–Ω—å—à–µ –µ–¥—ã (was 0.35, fixed sum to 1.0)
        timing: 0.30,      // –í–∞–∂–Ω–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–µ–¥–∞—Ç—å –≤–µ—á–µ—Ä–æ–º
        activity: 0.20,    // –í–∞–∂–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—à—Ü
        recovery: 0.15,    // –°–æ–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω
        metabolism: 0.10   // NEW: TEF, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑
      },
      bulk: {
        nutrition: 0.40,   // –ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã –≤–∞–∂–Ω–æ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞
        timing: 0.20,      // –ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
        activity: 0.25,    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ = –≥–ª–∞–≤–Ω–æ–µ
        recovery: 0.10,    // –í–∞–∂–Ω–æ, –Ω–æ –º–µ–Ω—å—à–µ
        metabolism: 0.05
      },
      maintenance: {
        nutrition: 0.35,
        timing: 0.25,
        activity: 0.20,
        recovery: 0.15,
        metabolism: 0.05
      }
    };

    const weights = weightsByGoal[goalMode];

    const scores = {
      nutrition: [],
      timing: [],
      activity: [],
      recovery: [],
      metabolism: []
    };

    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ v4.0 –∏ v5.0)
    for (const p of patterns) {
      if (!p.available || p.score === undefined) continue;

      switch (p.pattern) {
        case PATTERNS.MEAL_QUALITY_TREND:
        case PATTERNS.NUTRITION_QUALITY:
        case PATTERNS.PROTEIN_SATIETY:
        case PATTERNS.FIBER_REGULARITY:
        case PATTERNS.GUT_HEALTH:
        case PATTERNS.HYDRATION: // v4.0 B3
        case PATTERNS.MICRONUTRIENT_RADAR: // v5.0 C7
        case PATTERNS.OMEGA_BALANCER: // v5.0 C8
        case PATTERNS.NOVA_QUALITY: // v5.0 C10
        case PATTERNS.VITAMIN_DEFENSE: // v6.0 C13 (Phase 3, 12.02.2026)
        case PATTERNS.PROTEIN_DISTRIBUTION: // v6.0 C15 (Phase 3, 12.02.2026)
        case PATTERNS.NUTRIENT_DENSITY: // v6.0 C21 (Phase 3, 12.02.2026)
          scores.nutrition.push({
            score: p.score,
            reliability: getPatternReliability(p),
            pattern: p.pattern
          });
          break;

        case PATTERNS.MEAL_TIMING:
        case PATTERNS.WAVE_OVERLAP:
        case PATTERNS.LATE_EATING:
        case PATTERNS.CIRCADIAN:
        case PATTERNS.NUTRIENT_TIMING:
        case PATTERNS.WEEKEND_EFFECT: // v4.0 B6
          scores.timing.push({
            score: p.score,
            reliability: getPatternReliability(p),
            pattern: p.pattern
          });
          break;

        case PATTERNS.TRAINING_KCAL:
        case PATTERNS.STEPS_WEIGHT:
        case PATTERNS.NEAT_ACTIVITY:
        case PATTERNS.TRAINING_RECOVERY: // v5.0 C11
        case PATTERNS.TRAINING_TYPE_MATCH: // v6.0 C19 (Phase 3, 12.02.2026)
          scores.activity.push({
            score: p.score,
            reliability: getPatternReliability(p),
            pattern: p.pattern
          });
          break;

        case PATTERNS.SLEEP_WEIGHT:
        case PATTERNS.SLEEP_HUNGER:
        case PATTERNS.STRESS_EATING:
        case PATTERNS.MOOD_FOOD:
        case PATTERNS.MOOD_TRAJECTORY:
        case PATTERNS.SLEEP_QUALITY: // v4.0 B1
        case PATTERNS.WELLBEING_CORRELATION: // v4.0 B2
        case PATTERNS.CYCLE_IMPACT: // v4.0 B5
        case PATTERNS.ANTIOXIDANT_DEFENSE: // v6.0 C16 (Phase 3, 12.02.2026)
        case PATTERNS.BONE_HEALTH: // v6.0 C17 (Phase 3, 12.02.2026)
        case PATTERNS.ELECTROLYTE_HOMEOSTASIS: // v6.0 C20 (Phase 3, 12.02.2026)
          scores.recovery.push({
            score: p.score,
            reliability: getPatternReliability(p),
            pattern: p.pattern
          });
          break;

        case PATTERNS.INSULIN_SENSITIVITY:
        case PATTERNS.BODY_COMPOSITION: // v4.0 B4
        case PATTERNS.HEART_HEALTH: // v5.0 C9
        case PATTERNS.HYPERTROPHY: // v5.0 C12
        case PATTERNS.B_COMPLEX_ANEMIA: // v6.0 C22 (Phase 3, 12.02.2026)
        case PATTERNS.GLYCEMIC_LOAD: // v6.0 C14 (Phase 3, 12.02.2026)
        case PATTERNS.ADDED_SUGAR_DEPENDENCY: // v6.0 C18 (Phase 3, 12.02.2026)
          scores.metabolism.push({
            score: p.score,
            reliability: getPatternReliability(p),
            pattern: p.pattern
          });
          break;
      }
    }

    // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categoryScores = {};
    let totalWeight = 0;
    let weightedSum = 0;

    for (const [cat, weight] of Object.entries(weights)) {
      if (scores[cat].length > 0) {
        const reliabilitySum = scores[cat].reduce((sum, item) => sum + (Number(item.reliability) || 0), 0);
        const weightedScoreSum = scores[cat].reduce(
          (sum, item) => sum + ((Number(item.score) || 0) * (Number(item.reliability) || 0)),
          0
        );

        const catScore = reliabilitySum > 0
          ? (weightedScoreSum / reliabilitySum)
          : average(scores[cat].map(item => Number(item.score) || 0));

        const categoryReliability = scores[cat].length > 0
          ? (reliabilitySum / scores[cat].length)
          : 0;

        // –î–∞–∂–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º–æ–π,
        // –Ω–æ –µ—ë –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–π score —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è.
        const effectiveWeight = weight * (0.4 + 0.6 * categoryReliability);

        categoryScores[cat] = Math.round(catScore);
        weightedSum += catScore * effectiveWeight;
        totalWeight += effectiveWeight;
      } else {
        categoryScores[cat] = null;
      }
    }

    const totalScore = totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;

    return {
      total: totalScore,
      goalMode,
      categories: categoryScores,
      breakdown: {
        nutrition: {
          score: categoryScores.nutrition,
          weight: weights.nutrition,
          reliability: scores.nutrition.length > 0 ? Math.round((scores.nutrition.reduce((s, i) => s + i.reliability, 0) / scores.nutrition.length) * 100) / 100 : null,
          label: '–ü–∏—Ç–∞–Ω–∏–µ'
        },
        timing: {
          score: categoryScores.timing,
          weight: weights.timing,
          reliability: scores.timing.length > 0 ? Math.round((scores.timing.reduce((s, i) => s + i.reliability, 0) / scores.timing.length) * 100) / 100 : null,
          label: '–¢–∞–π–º–∏–Ω–≥'
        },
        activity: {
          score: categoryScores.activity,
          weight: weights.activity,
          reliability: scores.activity.length > 0 ? Math.round((scores.activity.reduce((s, i) => s + i.reliability, 0) / scores.activity.length) * 100) / 100 : null,
          label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
        },
        recovery: {
          score: categoryScores.recovery,
          weight: weights.recovery,
          reliability: scores.recovery.length > 0 ? Math.round((scores.recovery.reduce((s, i) => s + i.reliability, 0) / scores.recovery.length) * 100) / 100 : null,
          label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ'
        },
        metabolism: {
          score: categoryScores.metabolism,
          weight: weights.metabolism,
          reliability: scores.metabolism.length > 0 ? Math.round((scores.metabolism.reduce((s, i) => s + i.reliability, 0) / scores.metabolism.length) * 100) / 100 : null,
          label: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º'
        }
      },
      // DEBUG INFO
      formula: SCIENCE_INFO?.HEALTH_SCORE?.formula || 'Health score composite formula',
      debug: {
        goalMode,
        deficitPct,
        weights,
        confidenceWeighted: true,
        patternCount: patterns.filter(p => p.available).length
      }
    };
  }

  // === WHAT-IF ENGINE ===

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è What-If —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   */
  function generateWhatIfScenarios(patterns, healthScore, days, profile) {
    const scenarios = [];

    // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ò–¥–µ–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è
    const idealImprovement = {};
    let idealBoost = 0;

    for (const p of patterns) {
      if (!p.available || p.score === undefined) continue;
      if (p.score < 80) {
        const improvement = 80 - p.score;
        idealImprovement[p.pattern] = improvement;
        idealBoost += improvement * 0.1; // ~10% –æ—Ç —É–ª—É—á—à–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞
      }
    }

    scenarios.push({
      id: 'ideal',
      name: '–ò–¥–µ–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è',
      icon: '‚≠ê',
      description: '–í—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –∑–µ–ª—ë–Ω–æ–π –∑–æ–Ω–µ',
      currentScore: healthScore.total,
      projectedScore: Math.min(100, healthScore.total + Math.round(idealBoost)),
      improvements: idealImprovement,
      actions: [
        '–°–æ–±–ª—é–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏',
        '–ù–µ –µ—Å—Ç—å –ø–æ—Å–ª–µ 21:00',
        '–ë–µ–ª–æ–∫ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–∏—ë–º–µ',
        '–°–ø–∞—Ç—å 7-8 —á–∞—Å–æ–≤'
      ]
    });

    // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å
    const trendValues = patterns.filter(p => p.trend !== undefined).map(p => p.trend);
    const avgTrend = trendValues.length > 0 ? average(trendValues) : 0;
    const currentProjection = healthScore.total + Math.round((isNaN(avgTrend) ? 0 : avgTrend) * 7);

    scenarios.push({
      id: 'current',
      name: '–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å',
      icon: 'üìà',
      description: '–ï—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ —Å–µ–π—á–∞—Å',
      currentScore: healthScore.total,
      projectedScore: Math.max(0, Math.min(100, currentProjection)),
      trend: avgTrend > 0 ? 'up' : avgTrend < 0 ? 'down' : 'stable',
      actions: avgTrend >= 0
        ? ['–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!']
        : ['–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —É—Ö—É–¥—à–∞—é—â–∏–µ—Å—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏']
    });

    // –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—Ä—ã–≤
    scenarios.push({
      id: 'crash',
      name: '–ï—Å–ª–∏ –∑–∞–±–∏—Ç—å',
      icon: 'üìâ',
      description: '–°—Ü–µ–Ω–∞—Ä–∏–π –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è',
      currentScore: healthScore.total,
      projectedScore: Math.max(0, healthScore.total - 25),
      actions: [
        '–í–µ—Å –º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –Ω–∞ 1-2 –∫–≥',
        '–≠–Ω–µ—Ä–≥–∏—è —É–ø–∞–¥—ë—Ç',
        '–°–æ–Ω —É—Ö—É–¥—à–∏—Ç—Å—è'
      ]
    });

    return scenarios;
  }

  // === WEIGHT PREDICTION ===

  /**
   * –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
   */
  function predictWeight(days, profile) {
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–µ—Å–∞
    const weightData = days
      .filter(d => d.weightMorning)
      .map(d => ({ date: d.date, weight: d.weightMorning, cycleDay: d.cycleDay }))
      .sort((a, b) => a.date.localeCompare(b.date));

    if (weightData.length < 3) {
      return {
        available: false,
        insight: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞'
      };
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–æ—á–µ–∫ (x = –¥–Ω–∏ –æ—Ç –Ω–∞—á–∞–ª–∞)
    const getPoints = (data) => {
      if (data.length < 2) return [];
      const startTime = new Date(data[0].date).getTime();
      return data.map(d => ({
        x: (new Date(d.date).getTime() - startTime) / (86400000), // –¥–Ω–∏
        y: d.weight
      }));
    };

    // Raw —Ç—Ä–µ–Ω–¥
    const rawPoints = getPoints(weightData);
    const rawTrend = calculateLinearRegression(rawPoints);

    // Clean —Ç—Ä–µ–Ω–¥ (–∏—Å–∫–ª—é—á–∞–µ–º –¥–Ω–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤–æ–¥—ã –∏–∑-–∑–∞ —Ü–∏–∫–ª–∞)
    const cleanData = weightData.filter(d => {
      if (!d.cycleDay) return true;
      // –ò—Å–∫–ª—é—á–∞–µ–º –¥–Ω–∏ 1-7 (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã)
      return d.cycleDay > 7 || d.cycleDay === null;
    });

    const cleanPoints = getPoints(cleanData); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º X –æ—Ç –ø–µ—Ä–≤–æ–π '—á–∏—Å—Ç–æ–π' –¥–∞—Ç—ã –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ?
    // –õ—É—á—à–µ —Å—á–∏—Ç–∞—Ç—å X –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –û–î–ù–û–ô —Ç–æ—á–∫–∏ –æ—Ç—Å—á–µ—Ç–∞, –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å
    // –ù–æ slope –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–µ–Ω –∫ —Å–¥–≤–∏–≥—É X.
    // –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ cleanData –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ–∑–∂–µ, x[0] –±—É–¥–µ—Ç 0. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è slope.

    const cleanTrend = cleanPoints.length >= 3 ? calculateLinearRegression(cleanPoints) : rawTrend;

    const currentWeight = weightData[weightData.length - 1].weight; // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ—Å –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
    const goalWeight = profile?.weightGoal;

    // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é
    const weeklyChange = cleanTrend * 7;
    const projectedWeight = currentWeight + weeklyChange;

    // –í—Ä–µ–º—è –¥–æ —Ü–µ–ª–∏
    let weeksToGoal = null;
    let reachDate = null;
    if (goalWeight && cleanTrend !== 0) {
      const diff = goalWeight - currentWeight;
      if ((cleanTrend > 0 && diff > 0) || (cleanTrend < 0 && diff < 0)) {
        weeksToGoal = Math.abs(diff / weeklyChange);
        const reachDateObj = new Date();
        reachDateObj.setDate(reachDateObj.getDate() + Math.round(weeksToGoal * 7));
        reachDate = reachDateObj.toISOString().split('T')[0];
      }
    }

    return {
      available: true,
      currentWeight,
      goalWeight,
      rawTrend: Math.round(rawTrend * 1000) / 1000, // –∫–≥/–¥–µ–Ω—å
      cleanTrend: Math.round(cleanTrend * 1000) / 1000,
      weeklyChange: Math.round(weeklyChange * 100) / 100,
      projectedWeight: Math.round(projectedWeight * 10) / 10,
      weeksToGoal: weeksToGoal ? Math.round(weeksToGoal) : null,
      reachDate,
      dataPoints: weightData.length,
      cleanDataPoints: cleanData.length,
      hasCycleAdjustment: cleanData.length !== weightData.length,
      insight: weeklyChange > 0.3
        ? `üìà –ù–∞–±–æ—Ä ~${Math.round(weeklyChange * 100) / 100} –∫–≥/–Ω–µ–¥–µ–ª—é`
        : weeklyChange < -0.3
          ? `üìâ –°–Ω–∏–∂–µ–Ω–∏–µ ~${Math.abs(Math.round(weeklyChange * 100) / 100)} –∫–≥/–Ω–µ–¥–µ–ª—é`
          : `‚Üí –í–µ—Å —Å—Ç–∞–±–∏–ª–µ–Ω`
    };
  }

  // === WEEKLY WRAP ===

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Weekly Wrap (—Å–≤–æ–¥–∫–∞ –Ω–µ–¥–µ–ª–∏)
   */
  function generateWeeklyWrap(days, patterns, healthScore, weightPrediction, profile) {
    const safeProfile = profile || {};
    const allDaysHistory = Array.isArray(days) ? days : [];
    const daysWithMeals = days.filter(d => d.meals && d.meals.length > 0);

    // –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à–∏–π –∏ —Ö—É–¥—à–∏–π –¥–Ω–∏
    let bestDay = null;
    let worstDay = null;

    for (const day of daysWithMeals) {
      // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞: streak = —Ö–æ—Ä–æ—à–æ
      const ratioZones = HEYS.ratioZones;
      if (!ratioZones) continue;

      // –°—á–∏—Ç–∞–µ–º –∫–∞–ª–æ—Ä–∏–∏
      let dayKcal = 0;
      if (day.meals) {
        for (const meal of day.meals) {
          if (meal.items) {
            for (const item of meal.items) {
              dayKcal += (item.kcal100 || 0) * (item.grams || 0) / 100;
            }
          }
        }
      }

      // –ü–æ–ª—É—á–∞–µ–º optimum –∏–∑ TDEE –∏–ª–∏ profile
      const optimum = HEYS.TDEE?.calculate?.(day, safeProfile)?.optimum || safeProfile?.normAbs?.kcal || 2000;
      const ratio = dayKcal / optimum;
      const isGood = ratioZones.isSuccess(ratio);

      if (isGood && (!bestDay || day.dayScore > bestDay.dayScore)) {
        bestDay = { ...day, kcal: dayKcal, ratio };
      }
      if (!isGood && (!worstDay || day.dayScore < worstDay.dayScore)) {
        worstDay = { ...day, kcal: dayKcal, ratio };
      }
    }

    // –¢–æ–ø –∏–Ω—Å–∞–π—Ç—ã (—Å confidence >= threshold)
    const topInsights = patterns
      .filter(p => p.available && p.confidence >= CONFIG.MIN_CORRELATION_DISPLAY)
      .sort((a, b) => (b.confidence || 0) - (a.confidence || 0))
      .slice(0, 5)
      .map(p => p.insight);

    // –°–∫—Ä—ã—Ç—ã–µ –ø–æ–±–µ–¥—ã
    const hiddenWins = [];

    for (const p of patterns) {
      if (!p.available) continue;

      if (p.pattern === PATTERNS.WAVE_OVERLAP && !p.hasOverlaps) {
        hiddenWins.push('üéØ –ò–¥–µ–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤ ‚Äî –≤–æ–ª–Ω—ã –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–ª–∏—Å—å');
      }
      if (p.pattern === PATTERNS.LATE_EATING && p.lateCount === 0) {
        hiddenWins.push('üåô –ù–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–∑–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ ‚Äî –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–Ω–∞');
      }
      if (p.pattern === PATTERNS.PROTEIN_SATIETY && p.avgProteinPct >= 25) {
        hiddenWins.push('üí™ –ë–µ–ª–æ–∫ –Ω–∞ –≤—ã—Å–æ—Ç–µ ‚Äî —Å—ã—Ç–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞');
      }
      if (p.pattern === PATTERNS.FIBER_REGULARITY && p.avgFiberPer1000 >= 14) {
        hiddenWins.push('ü•ó –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≤ –Ω–æ—Ä–º–µ ‚Äî –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ');
      }
      if (p.pattern === PATTERNS.STRESS_EATING && p.correlation < 0) {
        hiddenWins.push('üßò –°—Ç—Ä–µ—Å—Å –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–ø–ø–µ—Ç–∏—Ç ‚Äî –∫—Ä—É—Ç–æ–π —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å');
      }
    }

    // === SCIENTIFIC WEEK-OVER-WEEK ANALYSIS (v5.2.0) ===
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    let scoreChange = 0;
    let weekOverWeekStats = null;

    if (allDaysHistory && allDaysHistory.length >= 14) {
      const currentStart = new Date(days[0].date);
      const prevWeekStart = new Date(currentStart);
      prevWeekStart.setDate(prevWeekStart.getDate() - 7);

      const prevWeekDays = allDaysHistory.filter(d => {
        const date = new Date(d.date);
        return date >= prevWeekStart && date < currentStart;
      });

      if (prevWeekDays.length >= 5) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º dayScore –¥–ª—è –æ–±–µ–∏—Ö –Ω–µ–¥–µ–ª—å
        const prevWeekScores = prevWeekDays
          .map(d => Number(d.dayScore))
          .filter(s => Number.isFinite(s) && s >= 0);

        const currentWeekScores = days
          .map(d => Number(d.dayScore))
          .filter(s => Number.isFinite(s) && s >= 0);

        if (prevWeekScores.length >= 3 && currentWeekScores.length >= 3) {
          // –ë–∞–∑–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
          const prevWeekAvg = average(prevWeekScores);
          const currentWeekAvg = average(currentWeekScores);
          scoreChange = Math.round(currentWeekAvg - prevWeekAvg);

          // –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
          const tTest = piStats.twoSampleTTest(prevWeekScores, currentWeekScores, 0.05);
          const effectSize = piStats.cohenD(prevWeekScores, currentWeekScores);

          // Confidence intervals
          const prevWeekCI = piStats.calculateConfidenceInterval(prevWeekScores, 0.95);
          const currentWeekCI = piStats.calculateConfidenceInterval(currentWeekScores, 0.95);

          // Statistical power (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
          const power = piStats.statisticalPower(
            prevWeekScores.length + currentWeekScores.length,
            Math.abs(effectSize.d)
          );

          weekOverWeekStats = {
            // –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            prevWeekAvg: Math.round(prevWeekAvg),
            currentWeekAvg: Math.round(currentWeekAvg),
            change: scoreChange,
            changePercent: prevWeekAvg > 0 ? Math.round((scoreChange / prevWeekAvg) * 100) : 0,

            // –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å
            isSignificant: tTest.isSignificant,
            pValue: tTest.pValue,
            tStat: Math.round(tTest.tStat * 100) / 100,
            direction: tTest.direction, // 'increase' | 'decrease' | 'no_change'

            // –†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞
            effectSize: Math.round(effectSize.d * 100) / 100,
            effectSizeInterpretation: effectSize.interpretation, // 'small' | 'medium' | 'large'

            // –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
            prevWeekCI: {
              mean: Math.round(prevWeekCI.mean),
              lower: Math.round(prevWeekCI.lower),
              upper: Math.round(prevWeekCI.upper),
              margin: Math.round(prevWeekCI.margin)
            },
            currentWeekCI: {
              mean: Math.round(currentWeekCI.mean),
              lower: Math.round(currentWeekCI.lower),
              upper: Math.round(currentWeekCI.upper),
              margin: Math.round(currentWeekCI.margin)
            },

            // Statistical power
            power: Math.round(power * 100) / 100,

            // Sample sizes
            prevWeekN: prevWeekScores.length,
            currentWeekN: currentWeekScores.length
          };
        }
      }
    }

    return {
      periodDays: days.length,
      daysWithData: daysWithMeals.length,
      healthScore: healthScore.total,
      scoreChange, // Week-over-week change (v5.1.0 ‚Äî deprecated, use weekOverWeekStats)
      weekOverWeekStats, // Scientific week-over-week analysis (v5.2.0)
      bestDay: bestDay ? {
        date: bestDay.date,
        dayScore: bestDay.dayScore,
        kcal: Math.round(bestDay.kcal)
      } : null,
      worstDay: worstDay ? {
        date: worstDay.date,
        dayScore: worstDay.dayScore,
        kcal: Math.round(worstDay.kcal)
      } : null,
      topInsights,
      hiddenWins: hiddenWins.slice(0, 3),
      weightPrediction: weightPrediction.available ? {
        current: weightPrediction.currentWeight,
        projected: weightPrediction.projectedWeight,
        weeklyChange: weightPrediction.weeklyChange
      } : null
    };
  }


  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsightsPI.advanced = {
    calculateHealthScore,
    generateWhatIfScenarios,
    predictWeight,
    generateWeeklyWrap
  };

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piAdvanced = HEYS.InsightsPI.advanced;

  devLog('[PI Advanced] v3.0.0 loaded ‚Äî 4 advanced analytics functions');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_cache.js ===== */
// pi_cache.js ‚Äî Memoization Layer –¥–ª—è Pattern Calculations v1.0.0
// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: 180ms ‚Üí 100ms (44% faster)
// –ö—ç—à–∏—Ä—É–µ—Ç –¥–æ—Ä–æ–≥–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è (insulin wave, correlation matrix, glycemic variability)
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};
    const DEV = global.DEV || {};
    const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

    // Cache storage
    const cache = new Map();
    let cacheStats = {
        hits: 0,
        misses: 0,
        size: 0,
        invalidations: 0
    };

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª—é—á–∞ –∫—ç—à–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
     * @param {string} fnName - –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
     * @param {Array} args - –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏
     * @returns {string} cache key
     */
    function generateCacheKey(fnName, args) {
        try {
            // –î–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –¥–Ω–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—ã + –¥–ª–∏–Ω—É
            if (Array.isArray(args[0]) && args[0][0]?.date) {
                const days = args[0];
                const dateRange = `${days[0]?.date}_${days[days.length - 1]?.date}`;
                const length = days.length;
                // –î–æ–±–∞–≤–ª—è–µ–º —Ö—ç—à –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
                const profileHash = args[2] ? JSON.stringify({
                    weight: args[2].weight,
                    height: args[2].height,
                    age: args[2].age,
                    gender: args[2].gender
                }) : '';
                return `${fnName}:${dateRange}:${length}:${profileHash}`;
            }
            // –î–ª—è options –æ–±—ä–µ–∫—Ç–æ–≤
            return `${fnName}:${JSON.stringify(args)}`;
        } catch (e) {
            // Fallback: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
            devLog('[HEYS.cache] ‚ö†Ô∏è generateCacheKey error:', e);
            return `${fnName}:${Date.now()}`;
        }
    }

    /**
     * –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏
     * @param {Function} fn - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
     * @param {string} fnName - –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
     * @param {object} options - –æ–ø—Ü–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
     * @returns {Function} –º–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
     */
    function memoize(fn, fnName, options = {}) {
        const ttl = options.ttl || 60000; // TTL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 —Å–µ–∫
        const maxSize = options.maxSize || 100; // –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Å–µ–π –≤ –∫—ç—à–µ

        return function memoized(...args) {
            const key = generateCacheKey(fnName, args);
            const now = Date.now();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (cache.has(key)) {
                const entry = cache.get(key);
                if (now - entry.timestamp < ttl) {
                    cacheStats.hits++;
                    devLog(`[HEYS.cache] ‚úÖ HIT ${fnName} (age: ${now - entry.timestamp}ms)`);
                    return entry.value;
                } else {
                    // TTL –∏—Å—Ç—ë–∫ ‚Äî —É–¥–∞–ª—è–µ–º
                    cache.delete(key);
                }
            }

            // Cache miss ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º
            cacheStats.misses++;
            const startTime = performance.now();
            const result = fn.apply(this, args);
            const duration = performance.now() - startTime;

            devLog(`[HEYS.cache] ‚ùå MISS ${fnName} (computed in ${Math.round(duration)}ms)`);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            cache.set(key, {
                value: result,
                timestamp: now
            });
            cacheStats.size = cache.size;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞ (LRU eviction)
            if (cache.size > maxSize) {
                const firstKey = cache.keys().next().value;
                cache.delete(firstKey);
                devLog(`[HEYS.cache] üóëÔ∏è Evicted old entry: ${firstKey}`);
            }

            return result;
        };
    }

    /**
     * –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö)
     * @param {string} pattern - –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (RegExp string –∏–ª–∏ 'all')
     */
    function invalidateCache(pattern = 'all') {
        if (pattern === 'all') {
            cache.clear();
            cacheStats.invalidations++;
            devLog('[HEYS.cache] üîÑ Cache invalidated (all)');
            return;
        }

        // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É
        const regex = new RegExp(pattern);
        let deleted = 0;
        for (const key of cache.keys()) {
            if (regex.test(key)) {
                cache.delete(key);
                deleted++;
            }
        }
        cacheStats.invalidations++;
        devLog(`[HEYS.cache] üîÑ Cache invalidated (pattern: ${pattern}, deleted: ${deleted})`);
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞
     * @returns {object} cache stats
     */
    function getCacheStats() {
        const hitRate = cacheStats.hits + cacheStats.misses > 0
            ? (cacheStats.hits / (cacheStats.hits + cacheStats.misses) * 100).toFixed(1)
            : 0;

        return {
            ...cacheStats,
            hitRate: `${hitRate}%`,
            keys: Array.from(cache.keys())
        };
    }

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
     */
    function resetCacheStats() {
        cacheStats = {
            hits: 0,
            misses: 0,
            size: cache.size,
            invalidations: 0
        };
        devLog('[HEYS.cache] üìä Stats reset');
    }

    // === –≠–ö–°–ü–û–†–¢ ===
    HEYS.InsightsPI.cache = {
        memoize,
        invalidateCache,
        getCacheStats,
        resetCacheStats
    };

    // –õ–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏
    devLog('[HEYS.cache] ‚ö° Loaded: memoization layer v1.0.0');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_analytics_api.js ===== */
// pi_analytics_api.js ‚Äî Advanced Analytics API v3.0.1
// Extracted from heys_predictive_insights_v1.js (Phase 5)
// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: 11 –º–µ—Ç–æ–¥–æ–≤ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
// v3.0.1: Lazy getters –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (fix load order issues)
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = HEYS.dev || global.HEYS?.dev || {};
  const devLog = DEV.log ? DEV.log.bind(DEV) : () => { };

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Å—Ä–∞–∑—É)
  const U = HEYS.utils || {};

  // === LAZY GETTERS –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (fix load order) ===
  // –≠—Ç–∏ –º–æ–¥—É–ª–∏ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ü–û–°–õ–ï pi_analytics_api.js
  function getStats() {
    return HEYS.InsightsPI?.stats || window.piStats || {};
  }
  function getScienceInfo() {
    return HEYS.InsightsPI?.constants?.SCIENCE_INFO || window.piConst?.SCIENCE_INFO || HEYS.InsightsPI?.science || window.piScience || {};
  }
  function getConst() {
    return HEYS.InsightsPI?.constants || window.piConst || {};
  }
  function getCalc() {
    return HEYS.InsightsPI?.calculations || window.piCalculations || {};
  }

  // === Calculation helpers (lazy) ===
  function getDaysData(daysBack, lsGet) {
    const calc = getCalc();
    if (calc.getDaysData) return calc.getDaysData(daysBack, lsGet);
    // Fallback: inline implementation
    const days = [];
    const today = new Date();
    for (let i = 0; i < daysBack; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = `heys_dayv2_${d.toISOString().slice(0, 10)}`;
      const data = lsGet ? lsGet(key, {}) : {};
      if (data && Object.keys(data).length > 0) {
        days.push(data);
      }
    }
    return days;
  }

  function calculateItemKcal(item, pIndex) {
    const calc = getCalc();
    if (calc.calculateItemKcal) return calc.calculateItemKcal(item, pIndex);
    // Fallback
    const prod = pIndex?.byId?.get?.(item.product_id);
    if (!prod) return 0;
    const grams = item.grams || 100;
    return ((prod.kcal100 || 0) * grams) / 100;
  }

  function calculateDayKcal(day, pIndex) {
    const calc = getCalc();
    if (calc.calculateDayKcal) return calc.calculateDayKcal(day, pIndex);
    // Fallback
    let total = 0;
    (day.meals || []).forEach(m => {
      (m.items || []).forEach(item => {
        total += calculateItemKcal(item, pIndex);
      });
    });
    return total;
  }

  // === Stats helpers (lazy access) ===
  function average(arr) {
    const stats = getStats();
    if (stats.average) return stats.average(arr);
    if (!arr || arr.length === 0) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }
  function stdDev(arr) {
    const stats = getStats();
    if (stats.stdDev) return stats.stdDev(arr);
    if (!arr || arr.length < 2) return 0;
    const mean = average(arr);
    const sq = arr.map(x => Math.pow(x - mean, 2));
    return Math.sqrt(sq.reduce((a, b) => a + b, 0) / arr.length);
  }
  function pearsonCorrelation(x, y) {
    const stats = getStats();
    if (stats.pearsonCorrelation) return stats.pearsonCorrelation(x, y);
    if (!Array.isArray(x) || !Array.isArray(y) || x.length !== y.length || x.length < 2) return 0;
    const n = x.length;
    const xMean = average(x);
    const yMean = average(y);
    let numerator = 0;
    let xDen = 0;
    let yDen = 0;
    for (let i = 0; i < n; i++) {
      const dx = (Number(x[i]) || 0) - xMean;
      const dy = (Number(y[i]) || 0) - yMean;
      numerator += dx * dy;
      xDen += dx * dx;
      yDen += dy * dy;
    }
    const denominator = Math.sqrt(xDen * yDen);
    if (denominator === 0) return 0;
    if (n < 3) return 0;
    return numerator / denominator;
  }
  function calculateTrend(arr) {
    const stats = getStats();
    if (stats.calculateTrend) return stats.calculateTrend(arr);
    if (!Array.isArray(arr) || arr.length < 2) return 0;
    const n = arr.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    for (let i = 0; i < n; i++) {
      const y = Number(arr[i]) || 0;
      sumX += i;
      sumY += y;
      sumXY += i * y;
      sumX2 += i * i;
    }
    const denominator = (n * sumX2 - sumX * sumX);
    if (!denominator) return 0;
    return (n * sumXY - sumX * sumY) / denominator;
  }
  function linearTrend(arr) {
    const stats = getStats();
    if (stats.linearTrend) return stats.linearTrend(arr);
    if (stats.calculateTrend) return stats.calculateTrend(arr);
    return calculateTrend(arr);
  }
  function calculateLinearRegression(points) {
    const stats = getStats();
    if (stats.calculateLinearRegression) return stats.calculateLinearRegression(points);
    if (!Array.isArray(points) || points.length < 2) return 0;
    let sumX = 0;
    let sumY = 0;
    let sumXY = 0;
    let sumX2 = 0;
    const n = points.length;
    for (const p of points) {
      const x = Number(p?.x) || 0;
      const y = Number(p?.y) || 0;
      sumX += x;
      sumY += y;
      sumXY += x * y;
      sumX2 += x * x;
    }
    const denominator = (n * sumX2 - sumX * sumX);
    if (!denominator) return 0;
    return (n * sumXY - sumX * sumY) / denominator;
  }
  function variance(arr) {
    const stats = getStats();
    if (stats.variance) return stats.variance(arr);
    if (!arr || arr.length < 2) return 0;
    const mean = average(arr);
    return arr.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / arr.length;
  }
  function autocorrelation(arr, lag) {
    const stats = getStats();
    if (stats.autocorrelation) return stats.autocorrelation(arr, lag);
    return 0;
  }
  function skewness(arr) {
    const stats = getStats();
    if (stats.skewness) return stats.skewness(arr);
    return 0;
  }
  function calculateR2(actual, predicted) {
    const stats = getStats();
    if (stats.calculateR2) return stats.calculateR2(actual, predicted);
    // Fallback R¬≤ implementation
    if (!actual || !predicted || actual.length !== predicted.length || actual.length === 0) return 0;
    const meanActual = average(actual);
    const ssTot = actual.reduce((sum, a) => sum + Math.pow(a - meanActual, 2), 0);
    const ssRes = actual.reduce((sum, a, i) => sum + Math.pow(a - predicted[i], 2), 0);
    return ssTot === 0 ? 0 : 1 - ssRes / ssTot;
  }

  function calculateBMR(profile) {
    if (HEYS.TDEE?.calcBMR) {
      return HEYS.TDEE.calcBMR(profile);
    }
    const weight = profile?.weight || 70;
    const height = profile?.height || 170;
    const age = profile?.age || 30;
    const isMale = profile?.gender !== '–ñ–µ–Ω—Å–∫–∏–π';
    if (isMale) {
      return 10 * weight + 6.25 * height - 5 * age + 5;
    } else {
      return 10 * weight + 6.25 * height - 5 * age - 161;
    }
  }

  // === ANALYTICS API METHODS ===
  const analyticsAPI = {
    /**
     * Analyze Metabolism - –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
     * @param {Object} options - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞
     * @returns {Object} –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
     */
    analyzeMetabolism: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const profile = options.profile || lsGet('heys_profile', {});
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const dateStr = options.selectedDate || new Date().toISOString().split('T')[0];
      const day = lsGet(`heys_dayv2_${dateStr}`, {});
      const hrZones = lsGet('heys_hr_zones', [
        { MET: 3 }, { MET: 5 }, { MET: 7 }, { MET: 10 }
      ]);

      // === TEF (Thermic Effect of Food) ===
      // Westerterp 2004, Tappy 1996: –±–µ–ª–æ–∫ 25%, —É–≥–ª–µ–≤–æ–¥—ã 7.5%, –∂–∏—Ä—ã 1.5%
      const meals = day.meals || [];
      let totalProtein = 0, totalCarbs = 0, totalFat = 0, totalKcal = 0;

      meals.forEach(meal => {
        (meal.items || []).forEach(item => {
          const g = item.grams || 0;
          // v3.0.2: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ ID (product_id –∏ productId)
          const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
          if (prod && g > 0) {
            totalProtein += (prod.protein100 || 0) * g / 100;
            totalCarbs += ((prod.simple100 || 0) + (prod.complex100 || 0)) * g / 100;
            totalFat += ((prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0)) * g / 100;
          }
        });
      });

      totalKcal = totalProtein * 3 + totalCarbs * 4 + totalFat * 9; // NET Atwater
      // üî¨ TEF v1.0.0: –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å HEYS.TEF —Å fallback
      let tefResult;
      if (HEYS.TEF?.calculate) {
        tefResult = HEYS.TEF.calculate(totalProtein, totalCarbs, totalFat);
      } else {
        // Fallback: inline —Ä–∞—Å—á—ë—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (Westerterp 2004, Tappy 1996)
        const proteinTEF = 0; // NET Atwater: TEF 25% built into 3 kcal/g coefficient
        const carbsTEF = Math.round(totalCarbs * 4 * 0.075);
        const fatTEF = Math.round(totalFat * 9 * 0.015);
        tefResult = {
          total: proteinTEF + carbsTEF + fatTEF,
          breakdown: { protein: proteinTEF, carbs: carbsTEF, fat: fatTEF }
        };
      }
      const totalTEF = tefResult.total;
      const tefPct = totalKcal > 0 ? Math.round(totalTEF / totalKcal * 100) : 0;

      const tefAnalysis = {
        total: totalTEF,
        percent: tefPct,
        breakdown: tefResult.breakdown,
        quality: tefPct >= 12 ? 'excellent' : tefPct >= 10 ? 'good' : tefPct >= 8 ? 'normal' : 'low',
        insight: tefPct >= 12
          ? `–û—Ç–ª–∏—á–Ω—ã–π TEF! –ë–µ–ª–æ–∫ —Å–∂–∏–≥–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ`
          : tefPct < 8
            ? `–ù–∏–∑–∫–∏–π TEF. –î–æ–±–∞–≤—å –±–µ–ª–∫–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞`
            : `–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ—Ä–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç`,
        pmid: '15507147'
      };

      // === EPOC (Excess Post-exercise Oxygen Consumption) ===
      // LaForgia et al., 2006: +6-15% –∫ –∑–∞—Ç—Ä–∞—Ç–∞–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      const trainings = day.trainings || [];
      let epocKcal = 0;
      let trainingKcal = 0;

      trainings.forEach(tr => {
        const zones = tr.z || [0, 0, 0, 0];
        const totalMin = zones.reduce((s, v) => s + v, 0);
        const highIntensityMin = (zones[2] || 0) + (zones[3] || 0);
        const intensity = totalMin > 0 ? highIntensityMin / totalMin : 0;

        const epocRate = 0.06 + intensity * 0.09;
        const trKcal = zones.reduce((sum, mins, idx) => {
          const met = hrZones[idx]?.MET || (idx + 1) * 2;
          return sum + (mins * met * (profile?.weight || 70) / 60);
        }, 0);
        trainingKcal += trKcal;
        epocKcal += trKcal * epocRate;
      });

      epocKcal = Math.round(epocKcal);
      const epocAnalysis = {
        kcal: epocKcal,
        trainingKcal: Math.round(trainingKcal),
        hasTraining: trainings.length > 0,
        insight: epocKcal > 50
          ? `+${epocKcal} –∫–∫–∞–ª –¥–æ–∂–∏–≥ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏`
          : epocKcal > 20
            ? `+${epocKcal} –∫–∫–∞–ª –æ—Ç EPOC —ç—Ñ—Ñ–µ–∫—Ç–∞`
            : trainings.length > 0 ? '–ù–µ–±–æ–ª—å—à–æ–π EPOC —ç—Ñ—Ñ–µ–∫—Ç' : '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
        pmid: '16825252'
      };

      // === –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (Leptin/Ghrelin) ===
      // Spiegel et al., 2004: –ù–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –≥—Ä–µ–ª–∏–Ω +28%, —Å–Ω–∏–∂–∞–µ—Ç –ª–µ–ø—Ç–∏–Ω -18%
      const sleepHours = day.sleepHours || 0;
      const sleepNorm = profile?.sleepHours || 8;
      const sleepDebt = Math.max(0, sleepNorm - sleepHours);

      let ghrelinIncrease = 0, leptinDecrease = 0;
      if (sleepDebt >= 3) {
        ghrelinIncrease = 28;
        leptinDecrease = 18;
      } else if (sleepDebt >= 2) {
        ghrelinIncrease = 15;
        leptinDecrease = 10;
      } else if (sleepDebt >= 1) {
        ghrelinIncrease = 8;
        leptinDecrease = 5;
      }

      const hormonalBalance = {
        sleepDebt,
        ghrelinIncrease,
        leptinDecrease,
        isDisrupted: ghrelinIncrease > 0,
        insight: ghrelinIncrease > 15
          ? `–ù–µ–¥–æ—Å—ã–ø: –≥–æ–ª–æ–¥ –ø–æ–≤—ã—à–µ–Ω –Ω–∞ ${ghrelinIncrease}%`
          : ghrelinIncrease > 0
            ? `–õ—ë–≥–∫–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –≥–æ–ª–æ–¥–∞ –æ—Ç –Ω–µ–¥–æ—Å—ã–ø–∞`
            : '–ì–æ—Ä–º–æ–Ω—ã –≤ –Ω–æ—Ä–º–µ',
        pmid: '15531540'
      };

      // === Adaptive Thermogenesis ===
      // Rosenbaum & Leibel, 2010: —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç —Å–Ω–∏–∂–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ 10-15%
      // v2.0: –∏—Å–ø–æ–ª—å–∑—É–µ–º % –æ—Ç BMR –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞ 1500 –∫–∫–∞–ª
      const bmr = calculateBMR(profile);
      const deficitThreshold = bmr * 0.70; // 70% –æ—Ç BMR = —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ

      const days = getDaysData(7, lsGet);
      const chronicDeficit = days.filter(d => {
        const eaten = calculateDayKcal(d, pIndex);
        return eaten > 0 && eaten < deficitThreshold;
      }).length;

      const adaptiveReduction = chronicDeficit >= 5 ? 0.12 : chronicDeficit >= 3 ? 0.08 : chronicDeficit >= 2 ? 0.04 : 0;

      const adaptiveThermogenesis = {
        chronicDeficitDays: chronicDeficit,
        metabolicReduction: adaptiveReduction,
        isAdapted: adaptiveReduction > 0,
        insight: adaptiveReduction >= 0.10
          ? `–ú–µ—Ç–∞–±–æ–ª–∏–∑–º —Å–Ω–∏–∂–µ–Ω –Ω–∞ ~${Math.round(adaptiveReduction * 100)}%`
          : adaptiveReduction >= 0.05
            ? `–õ—ë–≥–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞`
            : '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º –≤ –Ω–æ—Ä–º–µ',
        pmid: '20107198'
      };

      return {
        tefAnalysis,
        epocAnalysis,
        hormonalBalance,
        adaptiveThermogenesis,
        hasData: totalKcal > 0 || trainings.length > 0 || sleepHours > 0
      };
    },

    // === ADVANCED ANALYTICS v2.5 ===

    /**
     * Confidence Score ‚Äî –æ—Ü–µ–Ω–∫–∞ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (0-100)
     * –§–∞–∫—Ç–æ—Ä—ã: –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª–Ω–æ—Ç–∞, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
     * @param {Object} options - { lsGet, daysBack }
     * @returns {Object} { score, level, factors, advice }
     */
    calculateConfidenceScore: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const daysBack = options.daysBack || 30;
      const days = getDaysData(daysBack, lsGet);

      // –§–∞–∫—Ç–æ—Ä 1: –û–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö (30% –≤–µ—Å–∞)
      // 0 –¥–Ω–µ–π = 0, 7 –¥–Ω–µ–π = 50%, 14 –¥–Ω–µ–π = 80%, 21+ = 100%
      const daysWithData = days.filter(d => (d.meals?.length || 0) > 0 || d.weightMorning).length;
      const volumeFactor = Math.min(100, daysWithData <= 7 ? daysWithData * 7 : 50 + (daysWithData - 7) * 3.5);

      // –§–∞–∫—Ç–æ—Ä 2: –ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (25% –≤–µ—Å–∞)
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è: –µ—Å—Ç—å –ª–∏ weight, meals, sleep, steps, water
      const completenessPerDay = days.map(d => {
        let fields = 0;
        if (d.weightMorning > 0) fields++;
        if ((d.meals?.length || 0) > 0) fields++;
        if (d.sleepHours > 0 || d.sleepStart) fields++;
        if (d.steps > 0) fields++;
        if (d.waterMl > 0) fields++;
        return fields / 5 * 100;
      });
      const completenessFactor = completenessPerDay.length > 0
        ? average(completenessPerDay)
        : 0;

      // –§–∞–∫—Ç–æ—Ä 3: –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (25% –≤–µ—Å–∞)
      // –ù–∏–∑–∫–∞—è –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –≤ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ = –≤—ã—Å–æ–∫–∏–π —Å–∫–æ—Ä
      const dailyCompleteness = days.map(d => ((d.meals?.length || 0) > 0 ? 1 : 0));
      const consistency = dailyCompleteness.length >= 7
        ? 100 - (stdDev(dailyCompleteness) * 100)
        : 50;
      const consistencyFactor = Math.max(0, Math.min(100, consistency));

      // –§–∞–∫—Ç–æ—Ä 4: –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å (20% –≤–µ—Å–∞)
      // –î–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è –≤–∞–∂–Ω–µ–µ
      const recentDays = days.slice(0, 3);
      const recentActivity = recentDays.filter(d => (d.meals?.length || 0) > 0).length;
      const recencyFactor = recentActivity >= 3 ? 100 : recentActivity >= 2 ? 80 : recentActivity >= 1 ? 50 : 0;

      // –ò—Ç–æ–≥–æ–≤—ã–π —Å–∫–æ—Ä —Å –≤–µ—Å–∞–º–∏
      const score = Math.round(
        volumeFactor * 0.30 +
        completenessFactor * 0.25 +
        consistencyFactor * 0.25 +
        recencyFactor * 0.20
      );

      // –£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏
      const level = score >= 85 ? 'excellent' : score >= 70 ? 'good' : score >= 50 ? 'moderate' : 'low';
      const levelEmoji = { excellent: 'üéØ', good: '‚úÖ', moderate: '‚ö†Ô∏è', low: '‚ùå' }[level];
      const levelLabel = { excellent: '–í—ã—Å–æ–∫–∞—è', good: '–•–æ—Ä–æ—à–∞—è', moderate: '–°—Ä–µ–¥–Ω—è—è', low: '–ù–∏–∑–∫–∞—è' }[level];

      // –°–æ–≤–µ—Ç—ã –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
      const advices = [];
      if (volumeFactor < 70) advices.push('–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤–µ—Å—Ç–∏ —É—á—ë—Ç ‚Äî –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –º–∞–ª–æ');
      if (completenessFactor < 60) advices.push('–ó–∞–ø–æ–ª–Ω—è–π –≤–µ—Å, —Å–æ–Ω –∏ —à–∞–≥–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã');
      if (consistencyFactor < 70) advices.push('–í–µ–¥–∏ —É—á—ë—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å');
      if (recencyFactor < 80) advices.push('–ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–ø–æ–ª–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è!');

      return {
        score,
        level,
        levelEmoji,
        levelLabel,
        factors: {
          volume: Math.round(volumeFactor),
          completeness: Math.round(completenessFactor),
          consistency: Math.round(consistencyFactor),
          recency: Math.round(recencyFactor)
        },
        daysWithData,
        totalDays: daysBack,
        advice: advices[0] || '–û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö!',
        advices
      };
    },

    /**
     * Correlation Matrix ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π
     * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
     * @param {Object} options - { lsGet, daysBack, pIndex }
     * @returns {Object} { correlations, strongest, insights }
     */
    calculateCorrelationMatrix: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const daysBack = options.daysBack || 30;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const days = getDaysData(daysBack, lsGet);

      // –°–æ–±–∏—Ä–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
      const metrics = days.map(d => {
        const kcal = calculateDayKcal(d, pIndex);
        const meals = d.meals || [];
        let protein = 0, carbs = 0, fat = 0, simple = 0, fiber = 0;

        meals.forEach(m => (m.items || []).forEach(item => {
          const g = item.grams || 0;
          const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
          if (prod && g > 0) {
            protein += (prod.protein100 || 0) * g / 100;
            carbs += ((prod.simple100 || 0) + (prod.complex100 || 0)) * g / 100;
            simple += (prod.simple100 || 0) * g / 100;
            fat += ((prod.badFat100 || 0) + (prod.goodFat100 || 0)) * g / 100;
            fiber += (prod.fiber100 || 0) * g / 100;
          }
        }));

        return {
          kcal,
          protein,
          carbs,
          simple,
          fat,
          fiber,
          sleep: d.sleepHours || 0,
          steps: d.steps || 0,
          water: d.waterMl || 0,
          weight: d.weightMorning || 0,
          mood: d.moodAvg || d.dayScore || 0,
          stress: d.stressAvg || 0,
          trainings: (d.trainings || []).length
        };
      }).filter(m => m.kcal > 0 || m.sleep > 0 || m.steps > 0);

      if (metrics.length < 7) {
        return {
          correlations: [],
          strongest: null,
          insights: ['–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–Ω—É–∂–Ω–æ 7+ –¥–Ω–µ–π)'],
          hasData: false
        };
      }

      // –°–ø–∏—Å–æ–∫ –ø–∞—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
      const pairs = [
        { a: 'sleep', b: 'kcal', label: '–°–æ–Ω ‚Üí –ö–∞–ª–æ—Ä–∏–∏', desc: '–í–ª–∏—è–Ω–∏–µ —Å–Ω–∞ –Ω–∞ –∞–ø–ø–µ—Ç–∏—Ç' },
        { a: 'sleep', b: 'mood', label: '–°–æ–Ω ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', desc: '–°–≤—è–∑—å —Å–Ω–∞ –∏ —ç–º–æ—Ü–∏–π' },
        { a: 'sleep', b: 'simple', label: '–°–æ–Ω ‚Üí –°–ª–∞–¥–∫–æ–µ', desc: '–ù–µ–¥–æ—Å—ã–ø ‚Üí —Ç—è–≥–∞ –∫ —Å–∞—Ö–∞—Ä—É' },
        { a: 'steps', b: 'mood', label: '–®–∞–≥–∏ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', desc: '–î–≤–∏–∂–µ–Ω–∏–µ –∏ —ç–º–æ—Ü–∏–∏' },
        { a: 'steps', b: 'weight', label: '–®–∞–≥–∏ ‚Üí –í–µ—Å', desc: '–í–ª–∏—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –≤–µ—Å' },
        { a: 'stress', b: 'simple', label: '–°—Ç—Ä–µ—Å—Å ‚Üí –°–ª–∞–¥–∫–æ–µ', desc: '–ó–∞–µ–¥–∞–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞' },
        { a: 'stress', b: 'kcal', label: '–°—Ç—Ä–µ—Å—Å ‚Üí –ö–∞–ª–æ—Ä–∏–∏', desc: '–°—Ç—Ä–µ—Å—Å–æ–≤–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ' },
        { a: 'protein', b: 'mood', label: '–ë–µ–ª–æ–∫ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', desc: '–ë–µ–ª–æ–∫ –∏ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω' },
        { a: 'fiber', b: 'mood', label: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', desc: 'Gut-brain axis' },
        { a: 'water', b: 'mood', label: '–í–æ–¥–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', desc: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏' },
        { a: 'trainings', b: 'sleep', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí –°–æ–Ω', desc: '–°–ø–æ—Ä—Ç —É–ª—É—á—à–∞–µ—Ç —Å–æ–Ω' },
        { a: 'trainings', b: 'mood', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', desc: '–≠–Ω–¥–æ—Ä—Ñ–∏–Ω—ã' }
      ];

      const correlations = pairs.map(({ a, b, label, desc }) => {
        const arrA = metrics.map(m => m[a]).filter(v => v > 0);
        const arrB = metrics.map(m => m[b]).filter(v => v > 0);

        // –ù—É–∂–Ω—ã –≤–∞–ª–∏–¥–Ω—ã–µ –ø–∞—Ä—ã
        const validPairs = metrics.filter(m => m[a] > 0 && m[b] > 0);
        if (validPairs.length < 5) {
          return { label, desc, correlation: null, strength: 'insufficient', available: false };
        }

        const r = pearsonCorrelation(
          validPairs.map(m => m[a]),
          validPairs.map(m => m[b])
        );

        const absR = Math.abs(r);
        const strength = absR >= 0.7 ? 'strong' : absR >= 0.4 ? 'moderate' : absR >= 0.2 ? 'weak' : 'none';
        const direction = r > 0 ? 'positive' : r < 0 ? 'negative' : 'none';

        return {
          label,
          desc,
          metricA: a,
          metricB: b,
          correlation: Math.round(r * 100) / 100,
          absCorrelation: Math.round(absR * 100) / 100,
          strength,
          direction,
          dataPoints: validPairs.length,
          available: true
        };
      }).filter(c => c.available);

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∏–ª–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
      const sorted = [...correlations].sort((a, b) => b.absCorrelation - a.absCorrelation);
      const strongest = sorted[0] || null;

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω—Å–∞–π—Ç—ã
      const insights = [];
      const strongCorrelations = sorted.filter(c => c.strength === 'strong' || c.strength === 'moderate');

      strongCorrelations.slice(0, 3).forEach(c => {
        if (c.correlation > 0.4) {
          insights.push(`üìà ${c.label}: —Å–∏–ª—å–Ω–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å (+${Math.round(c.correlation * 100)}%)`);
        } else if (c.correlation < -0.4) {
          insights.push(`üìâ ${c.label}: —Å–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (${Math.round(c.correlation * 100)}%)`);
        }
      });

      if (insights.length === 0) {
        insights.push('–ü–æ–∫–∞ —è–≤–Ω—ã—Ö –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤–µ—Å—Ç–∏ —É—á—ë—Ç!');
      }

      return {
        correlations: sorted,
        strongest,
        insights,
        totalPairs: pairs.length,
        analyzedPairs: correlations.length,
        hasData: correlations.length >= 3
      };
    },

    /**
     * Metabolic Patterns ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
     * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç: —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∂–∏—Ä–∞–º, —Ö—Ä–æ–Ω–æ—Ç–∏–ø
     * @param {Object} options - { lsGet, daysBack, pIndex, profile }
     * @returns {Object} { patterns, phenotype, recommendations }
     */
    detectMetabolicPatterns: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const daysBack = options.daysBack || 30;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const profile = options.profile || lsGet('heys_profile', {});
      const days = getDaysData(daysBack, lsGet);

      const patterns = [];

      // === 1. Carb Sensitivity (—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º) ===
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º: —Å—ä–µ–ª –º–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Üí –∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è –≤–µ—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
      const carbDays = [];
      for (let i = 1; i < days.length; i++) {
        const prevDay = days[i];
        const nextDay = days[i - 1];

        if (!prevDay.meals?.length || !nextDay.weightMorning || !prevDay.weightMorning) continue;

        let simpleCarbs = 0;
        (prevDay.meals || []).forEach(m => (m.items || []).forEach(item => {
          const g = item.grams || 0;
          const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
          if (prod && g > 0) {
            simpleCarbs += (prod.simple100 || 0) * g / 100;
          }
        }));

        const weightDelta = nextDay.weightMorning - prevDay.weightMorning;
        carbDays.push({ simpleCarbs, weightDelta });
      }

      if (carbDays.length >= 7) {
        const highCarbDays = carbDays.filter(d => d.simpleCarbs > 50);
        const lowCarbDays = carbDays.filter(d => d.simpleCarbs < 30);

        const highCarbAvgDelta = highCarbDays.length > 0 ? average(highCarbDays.map(d => d.weightDelta)) : 0;
        const lowCarbAvgDelta = lowCarbDays.length > 0 ? average(lowCarbDays.map(d => d.weightDelta)) : 0;

        const carbSensitivity = highCarbAvgDelta - lowCarbAvgDelta;
        const sensitivityLevel = carbSensitivity > 0.5 ? 'high' : carbSensitivity > 0.2 ? 'moderate' : 'low';

        patterns.push({
          type: 'carb_sensitivity',
          label: '–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º',
          level: sensitivityLevel,
          value: Math.round(carbSensitivity * 100) / 100,
          insight: sensitivityLevel === 'high'
            ? '‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è: –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã —Å–∏–ª—å–Ω–æ –≤–ª–∏—è—é—Ç –Ω–∞ –≤–µ—Å (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã)'
            : sensitivityLevel === 'moderate'
              ? 'üìä –£–º–µ—Ä–µ–Ω–Ω–∞—è: —Å–ª–µ–¥–∏ –∑–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ —É–≥–ª–µ–≤–æ–¥–∞–º–∏'
              : '‚úÖ –ù–∏–∑–∫–∞—è: —É–≥–ª–µ–≤–æ–¥—ã –Ω–µ —Å–∏–ª—å–Ω–æ –≤–ª–∏—è—é—Ç –Ω–∞ –≤–µ—Å'
        });
      }

      // === 2. Fat Adaptation (–∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∂–∏—Ä–∞–º) ===
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º: —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∂–∏—Ä–æ–≤/—É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ (mood/dayScore)
      const fatRatioDays = days.map(d => {
        let fat = 0, carbs = 0;
        (d.meals || []).forEach(m => (m.items || []).forEach(item => {
          const g = item.grams || 0;
          const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
          if (prod && g > 0) {
            fat += ((prod.badFat100 || 0) + (prod.goodFat100 || 0)) * g / 100;
            carbs += ((prod.simple100 || 0) + (prod.complex100 || 0)) * g / 100;
          }
        }));

        const ratio = carbs > 0 ? fat / carbs : 0;
        const energy = d.moodAvg || d.dayScore || 0;
        return { ratio, energy, hasData: fat > 0 || carbs > 0 };
      }).filter(d => d.hasData && d.energy > 0);

      if (fatRatioDays.length >= 7) {
        const highFatDays = fatRatioDays.filter(d => d.ratio > 0.5);
        const lowFatDays = fatRatioDays.filter(d => d.ratio < 0.3);

        const highFatEnergy = highFatDays.length > 0 ? average(highFatDays.map(d => d.energy)) : 0;
        const lowFatEnergy = lowFatDays.length > 0 ? average(lowFatDays.map(d => d.energy)) : 0;

        const fatAdaptation = highFatEnergy - lowFatEnergy;
        const adaptationLevel = fatAdaptation > 1 ? 'adapted' : fatAdaptation > 0 ? 'neutral' : 'carb_dependent';

        patterns.push({
          type: 'fat_adaptation',
          label: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å',
          level: adaptationLevel,
          value: Math.round(fatAdaptation * 10) / 10,
          insight: adaptationLevel === 'adapted'
            ? 'üî• –•–æ—Ä–æ—à–∞—è: –æ—Ä–≥–∞–Ω–∏–∑–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∂–∏—Ä—ã'
            : adaptationLevel === 'carb_dependent'
              ? '‚ö° –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —É–≥–ª–µ–≤–æ–¥–æ–≤: —ç–Ω–µ—Ä–≥–∏—è –ø–∞–¥–∞–µ—Ç –±–µ–∑ –Ω–∏—Ö'
              : 'üìä –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è: –æ—Ä–≥–∞–Ω–∏–∑–º –≥–∏–±–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã'
        });
      }

      // === 3. Chronotype Detection (—Ö—Ä–æ–Ω–æ—Ç–∏–ø) ===
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º: –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –¥–Ω—è
      const mealTimeDays = days.map(d => {
        const meals = d.meals || [];
        if (meals.length === 0) return null;

        const firstMeal = meals.sort((a, b) => (a.time || '').localeCompare(b.time || ''))[0];
        const firstMealHour = firstMeal?.time ? parseInt(firstMeal.time.split(':')[0]) : null;
        const dayQuality = d.dayScore || d.moodAvg || 0;

        return firstMealHour !== null ? { hour: firstMealHour, quality: dayQuality } : null;
      }).filter(Boolean);

      if (mealTimeDays.length >= 7) {
        const earlyDays = mealTimeDays.filter(d => d.hour < 9);
        const lateDays = mealTimeDays.filter(d => d.hour >= 11);

        const earlyQuality = earlyDays.length > 0 ? average(earlyDays.map(d => d.quality)) : 0;
        const lateQuality = lateDays.length > 0 ? average(lateDays.map(d => d.quality)) : 0;

        const chronotypeScore = earlyQuality - lateQuality;
        const chronotype = chronotypeScore > 0.5 ? 'early_bird' : chronotypeScore < -0.5 ? 'night_owl' : 'neutral';

        patterns.push({
          type: 'chronotype',
          label: '–•—Ä–æ–Ω–æ—Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è',
          level: chronotype,
          value: Math.round(chronotypeScore * 10) / 10,
          insight: chronotype === 'early_bird'
            ? 'üåÖ –ñ–∞–≤–æ—Ä–æ–Ω–æ–∫: —Ä–∞–Ω–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞–∫–∏ –ø–æ–≤—ã—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –¥–Ω—è'
            : chronotype === 'night_owl'
              ? 'üåô –°–æ–≤–∞: –ø–æ–∑–¥–Ω–µ–µ –Ω–∞—á–∞–ª–æ –¥–Ω—è —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç'
              : '‚öñÔ∏è –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π: –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞–∫–∞ –Ω–µ —Å–∏–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç'
        });
      }

      // === 4. Stress Eating Pattern ===
      // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å—Ç—Ä–µ—Å—Å ‚Üí –∫–∞–ª–æ—Ä–∏–∏
      const stressDays = days.filter(d => d.stressAvg > 0 && d.meals?.length > 0);
      if (stressDays.length >= 7) {
        const stressValues = stressDays.map(d => d.stressAvg);
        const kcalValues = stressDays.map(d => calculateDayKcal(d, pIndex));

        const r = pearsonCorrelation(stressValues, kcalValues);
        const stressEatingLevel = r > 0.4 ? 'high' : r > 0.2 ? 'moderate' : r < -0.2 ? 'restriction' : 'none';

        patterns.push({
          type: 'stress_eating',
          label: '–°—Ç—Ä–µ—Å—Å–æ–≤–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ',
          level: stressEatingLevel,
          value: Math.round(r * 100) / 100,
          insight: stressEatingLevel === 'high'
            ? 'üç´ –í—ã—Ä–∞–∂–µ–Ω–æ: –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ –µ—à—å –±–æ–ª—å—à–µ'
            : stressEatingLevel === 'restriction'
              ? 'üö´ –°—Ç—Ä–µ—Å—Å –ø–æ–¥–∞–≤–ª—è–µ—Ç –∞–ø–ø–µ—Ç–∏—Ç'
              : stressEatingLevel === 'moderate'
                ? 'üìä –£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å —Å—Ç—Ä–µ—Å—Å–∞ –∏ –µ–¥—ã'
                : '‚úÖ –°—Ç—Ä–µ—Å—Å –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ'
        });
      }

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø
      const phenotype = {
        carbSensitive: patterns.find(p => p.type === 'carb_sensitivity')?.level === 'high',
        fatAdapted: patterns.find(p => p.type === 'fat_adaptation')?.level === 'adapted',
        stressEater: patterns.find(p => p.type === 'stress_eating')?.level === 'high',
        chronotype: patterns.find(p => p.type === 'chronotype')?.level || 'neutral'
      };

      // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–µ–Ω–æ—Ç–∏–ø–∞
      const recommendations = [];
      if (phenotype.carbSensitive) {
        recommendations.push('–°–æ–∫—Ä–∞—Ç–∏ –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã ‚Äî —Ç–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
      }
      if (!phenotype.fatAdapted) {
        recommendations.push('–£–≤–µ–ª–∏—á—å –¥–æ–ª—é –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤ –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π –≥–∏–±–∫–æ—Å—Ç–∏');
      }
      if (phenotype.stressEater) {
        recommendations.push('–ù–∞–π–¥–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É –µ–¥–µ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ (–ø—Ä–æ–≥—É–ª–∫–∞, –¥—ã—Ö–∞–Ω–∏–µ)');
      }

      return {
        patterns,
        phenotype,
        recommendations,
        hasData: patterns.length > 0
      };
    },

    /**
     * Predictive Risk Score ‚Äî –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ —Å—Ä—ã–≤–∞ –Ω–∞ 24-48—á
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å, –Ω–µ–¥–æ—Å—ã–ø, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Å—É–ª–∏–Ω–∞, –ø–∞—Ç—Ç–µ—Ä–Ω—ã
     * @param {Object} options - { lsGet, pIndex, profile }
     * @returns {Object} { riskScore, riskLevel, factors, prediction }
     */
    calculatePredictiveRisk: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const profile = options.profile || lsGet('heys_profile', {});
      const days = getDaysData(7, lsGet);
      const today = days[0] || {};

      const factors = [];
      let totalRisk = 0;

      // === 1. Accumulated Stress (EMA) ‚Äî 25% –≤–µ—Å–∞ ===
      // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ —Å—Ç—Ä–µ—Å—Å–∞
      const stressValues = days.map(d => d.stressAvg || 0).filter(s => s > 0);
      let stressEMA = 0;
      const alpha = 0.3; // decay factor

      if (stressValues.length > 0) {
        stressEMA = stressValues.reduce((ema, stress, i) => {
          return alpha * stress + (1 - alpha) * ema;
        }, stressValues[0]);
      }

      const stressRisk = Math.min(100, stressEMA * 10);
      factors.push({
        name: '–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å',
        value: Math.round(stressEMA * 10) / 10,
        risk: Math.round(stressRisk),
        weight: 0.25,
        insight: stressRisk > 60 ? '‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å' : '‚úÖ –°—Ç—Ä–µ—Å—Å –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º'
      });
      totalRisk += stressRisk * 0.25;

      // === 2. Sleep Debt ‚Äî 25% –≤–µ—Å–∞ ===
      const sleepNorm = profile.sleepHours || 8;
      const sleepValues = days.map(d => d.sleepHours || 0).filter(s => s > 0);
      const sleepDebt = sleepValues.length > 0
        ? sleepValues.reduce((debt, sleep) => debt + Math.max(0, sleepNorm - sleep), 0)
        : 0;

      const sleepRisk = Math.min(100, sleepDebt * 10);
      factors.push({
        name: '–ù–µ–¥–æ—Å—ã–ø (–¥–æ–ª–≥ —Å–Ω–∞)',
        value: Math.round(sleepDebt * 10) / 10,
        risk: Math.round(sleepRisk),
        weight: 0.25,
        insight: sleepRisk > 60 ? 'üò¥ –ù–∞–∫–æ–ø–∏–ª—Å—è –Ω–µ–¥–æ—Å—ã–ø ‚Äî —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞' : '‚úÖ –°–æ–Ω –≤ –Ω–æ—Ä–º–µ'
      });
      totalRisk += sleepRisk * 0.25;

      // === 3. Insulin Volatility ‚Äî 20% –≤–µ—Å–∞ ===
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Å—Ç–æ—Ç—É –ø–µ—Ä–µ–∫—É—Å–æ–≤ –∏ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤
      const todayMeals = today.meals || [];
      let simpleCarbs = 0;
      let mealCount = todayMeals.length;

      todayMeals.forEach(m => (m.items || []).forEach(item => {
        const g = item.grams || 0;
        const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
        if (prod && g > 0) {
          simpleCarbs += (prod.simple100 || 0) * g / 100;
        }
      }));

      // –ú–Ω–æ–≥–æ –ø–µ—Ä–µ–∫—É—Å–æ–≤ + –º–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—ã—Ö = –≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
      const insulinVolatility = Math.min(100, (mealCount > 5 ? 30 : 0) + (simpleCarbs > 80 ? 40 : simpleCarbs > 40 ? 20 : 0));
      factors.push({
        name: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å',
        value: Math.round(simpleCarbs),
        risk: Math.round(insulinVolatility),
        weight: 0.20,
        insight: insulinVolatility > 50 ? 'üìà –°–∫–∞—á–∫–∏ –∏–Ω—Å—É–ª–∏–Ω–∞ ‚Äî –≥–æ–ª–æ–¥ –≤–µ—Ä–Ω—ë—Ç—Å—è –±—ã—Å—Ç—Ä–æ' : '‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω'
      });
      totalRisk += insulinVolatility * 0.20;

      // === 4. Temporal Patterns ‚Äî 20% –≤–µ—Å–∞ ===
      // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –≤—Ä–µ–º—è –¥–Ω—è
      const now = new Date();
      const dayOfWeek = now.getDay();
      const hour = now.getHours();

      // –í—ã—Ö–æ–¥–Ω—ã–µ = –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫
      const weekendRisk = (dayOfWeek === 0 || dayOfWeek === 6 || dayOfWeek === 5) ? 30 : 0;
      // –í–µ—á–µ—Ä = –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫
      const eveningRisk = hour >= 20 ? 25 : hour >= 18 ? 15 : 0;

      const temporalRisk = weekendRisk + eveningRisk;
      factors.push({
        name: '–í—Ä–µ–º—è (–≤—ã—Ö–æ–¥–Ω—ã–µ/–≤–µ—á–µ—Ä)',
        value: `${['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'][dayOfWeek]} ${hour}:00`,
        risk: Math.round(temporalRisk),
        weight: 0.20,
        insight: temporalRisk > 30 ? 'üïê –û–ø–∞—Å–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî –±—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ' : '‚úÖ –í—Ä–µ–º—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ'
      });
      totalRisk += temporalRisk * 0.20;

      // === 5. Caloric Debt Bonus ‚Äî 10% –≤–µ—Å–∞ ===
      // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –±–æ–ª—å—à–æ–π –Ω–µ–¥–æ–±–æ—Ä ‚Äî —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ –≤–µ—á–µ—Ä–æ–º/–Ω–æ—á—å—é
      const todayKcal = calculateDayKcal(today, pIndex);
      const optimum = HEYS.Day?.calculateOptimum?.(profile) || 2000;
      const kcalPct = todayKcal / optimum;

      const debtRisk = kcalPct < 0.5 && hour >= 16 ? 60 : kcalPct < 0.7 && hour >= 18 ? 40 : 0;
      factors.push({
        name: '–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –Ω–µ–¥–æ–±–æ—Ä',
        value: `${Math.round(kcalPct * 100)}%`,
        risk: Math.round(debtRisk),
        weight: 0.10,
        insight: debtRisk > 40 ? 'üçΩÔ∏è –ú–∞–ª–æ —Å—ä–µ–¥–µ–Ω–æ ‚Äî –≥–æ–ª–æ–¥ —É–¥–∞—Ä–∏—Ç –≤–µ—á–µ—Ä–æ–º' : '‚úÖ –ö–∞–ª–æ—Ä–∏–∏ –≤ –Ω–æ—Ä–º–µ'
      });
      totalRisk += debtRisk * 0.10;

      // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∏—Å–∫ –∏ —É—Ä–æ–≤–µ–Ω—å
      const riskScore = Math.round(Math.min(100, totalRisk));
      const riskLevel = riskScore >= 70 ? 'high' : riskScore >= 40 ? 'moderate' : 'low';
      const riskEmoji = { high: 'üö®', moderate: '‚ö†Ô∏è', low: '‚úÖ' }[riskLevel];
      const riskLabel = { high: '–í—ã—Å–æ–∫–∏–π', moderate: '–£–º–µ—Ä–µ–Ω–Ω—ã–π', low: '–ù–∏–∑–∫–∏–π' }[riskLevel];

      // –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
      const prediction = riskLevel === 'high'
        ? '–†–∏—Å–∫ —Å—Ä—ã–≤–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 24—á ‚Äî –±—É–¥—å –æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º!'
        : riskLevel === 'moderate'
          ? '–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ ‚Äî —Å–ª–µ–¥–∏ –∑–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏'
          : '–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!';

      const topFactor = [...factors].sort((a, b) => b.risk - a.risk)[0];
      const recommendation = topFactor?.risk > 40
        ? `–§–æ–∫—É—Å: ${topFactor.name.toLowerCase()}`
        : '–í—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º!';

      return {
        riskScore,
        riskLevel,
        riskEmoji,
        riskLabel,
        factors,
        prediction,
        recommendation,
        topFactor,
        hasData: days.length >= 3
      };
    },

    /**
     * Energy Forecast ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ 24 —á–∞—Å–∞
     * –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–¥—ã—Ö–∞
     * @param {Object} options - { lsGet, pIndex, profile }
     * @returns {Object} { hourlyForecast, peakWindow, dipWindow, recommendations }
     */
    forecastEnergy: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const profile = options.profile || lsGet('heys_profile', {});
      const days = getDaysData(14, lsGet);
      const today = days[0] || {};

      // –ë–∞–∑–æ–≤—ã–π —Ü–∏—Ä–∫–∞–¥–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (—Ç–∏–ø–∏—á–Ω—ã–π –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ª—é–¥–µ–π)
      // Van Cauter 1997: –∫–æ—Ä—Ç–∏–∑–æ–ª –ø–∏–∫ 6-9, –∏–Ω—Å—É–ª–∏–Ω —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç –∫ –≤–µ—á–µ—Ä—É
      const baseCircadian = [
        // 0-5: –Ω–æ—á—å (–Ω–∏–∑–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è)
        20, 15, 10, 10, 15, 25,
        // 6-11: —É—Ç—Ä–æ (—Ä–æ—Å—Ç)
        40, 55, 70, 80, 85, 90,
        // 12-17: –¥–µ–Ω—å (–ø–∏–∫ –∏ –ø–ª–∞—Ç–æ)
        85, 75, 70, 75, 80, 75,
        // 18-23: –≤–µ—á–µ—Ä (—Å–ø–∞–¥)
        65, 55, 45, 35, 30, 25
      ];

      // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const modifiers = [];

      // 1. –°–æ–Ω –ø—Ä–æ—à–ª–æ–π –Ω–æ—á–∏
      const sleepHours = today.sleepHours || 0;
      const sleepQuality = today.sleepQuality || 3;
      const sleepMod = sleepHours >= 7 ? 1.1 : sleepHours >= 6 ? 1.0 : sleepHours >= 5 ? 0.85 : 0.7;
      modifiers.push({ name: '–°–æ–Ω', value: sleepMod, desc: `${sleepHours}—á —Å–Ω–∞` });

      // 2. –¢–µ–∫—É—â–∏–π –∫–∞–ª–æ—Ä–∞–∂ (—ç–Ω–µ—Ä–≥–∏—è –∏–∑ –µ–¥—ã)
      const todayKcal = calculateDayKcal(today, pIndex);
      const optimum = HEYS.Day?.calculateOptimum?.(profile) || 2000;
      const kcalPct = todayKcal / optimum;
      const kcalMod = kcalPct >= 0.8 ? 1.1 : kcalPct >= 0.5 ? 1.0 : kcalPct >= 0.3 ? 0.9 : 0.75;
      modifiers.push({ name: '–ï–¥–∞', value: kcalMod, desc: `${Math.round(kcalPct * 100)}% –Ω–æ—Ä–º—ã` });

      // 3. –°—Ç—Ä–µ—Å—Å
      const stressAvg = today.stressAvg || 5;
      const stressMod = stressAvg <= 3 ? 1.1 : stressAvg <= 5 ? 1.0 : stressAvg <= 7 ? 0.9 : 0.8;
      modifiers.push({ name: '–°—Ç—Ä–µ—Å—Å', value: stressMod, desc: `${stressAvg}/10` });

      // 4. –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (EPOC –¥–∞—ë—Ç —ç–Ω–µ—Ä–≥–∏—é –ø–æ—Å–ª–µ)
      const trainings = today.trainings || [];
      const hasTrained = trainings.length > 0;
      const trainingMod = hasTrained ? 1.15 : 1.0;
      modifiers.push({ name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', value: trainingMod, desc: hasTrained ? '–î–∞' : '–ù–µ—Ç' });

      // –û–±—â–∏–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä
      const totalMod = modifiers.reduce((acc, m) => acc * m.value, 1);

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∫ –±–∞–∑–æ–≤–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é
      const currentHour = new Date().getHours();
      const hourlyForecast = baseCircadian.map((baseEnergy, hour) => {
        // –î–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö —á–∞—Å–æ–≤ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–∞—è)
        // –î–ª—è –±—É–¥—É—â–∏—Ö ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
        const isPast = hour < currentHour;
        const energy = Math.round(Math.min(100, Math.max(0, baseEnergy * totalMod)));

        return {
          hour,
          energy,
          isPast,
          label: `${hour}:00`,
          level: energy >= 80 ? 'peak' : energy >= 60 ? 'good' : energy >= 40 ? 'moderate' : 'low'
        };
      });

      // –ù–∞—Ö–æ–¥–∏–º –æ–∫–Ω–∞ –ø–∏–∫–æ–≤ –∏ —Å–ø–∞–¥–æ–≤ (—Ç–æ–ª—å–∫–æ –≤ –±—É–¥—É—â–µ–º)
      const futureHours = hourlyForecast.filter(h => h.hour >= currentHour);
      const sortedByEnergy = [...futureHours].sort((a, b) => b.energy - a.energy);

      const peakWindow = sortedByEnergy[0] || { hour: 10, energy: 80 };
      const dipWindow = sortedByEnergy[sortedByEnergy.length - 1] || { hour: 22, energy: 30 };

      // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
      const recommendations = [];

      if (peakWindow.energy >= 70) {
        recommendations.push(`üî• –ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ –≤ ${peakWindow.hour}:00 ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –≤–∞–∂–Ω—ã—Ö –¥–µ–ª`);
      }

      if (dipWindow.hour >= currentHour && dipWindow.hour <= 22) {
        recommendations.push(`üò¥ –°–ø–∞–¥ –≤ ${dipWindow.hour}:00 ‚Äî –∑–∞–ø–ª–∞–Ω–∏—Ä—É–π –æ—Ç–¥—ã—Ö –∏–ª–∏ –ª—ë–≥–∫–∏–µ –∑–∞–¥–∞—á–∏`);
      }

      if (sleepMod < 0.9) {
        recommendations.push('üí§ –ù–µ–¥–æ—Å—ã–ø —Å–Ω–∏–∂–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å');
      }

      if (kcalMod < 0.9) {
        recommendations.push('üçΩÔ∏è –ú–∞–ª–æ —Å—ä–µ–ª ‚Äî —ç–Ω–µ—Ä–≥–∏—è –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å');
      }

      return {
        hourlyForecast,
        peakWindow,
        dipWindow,
        modifiers,
        totalMod: Math.round(totalMod * 100) / 100,
        currentHour,
        recommendations,
        hasData: true
      };
    },

    // === SCIENTIFIC ANALYTICS v3.0 ===

    /**
     * Bayesian Confidence + MAPE ‚Äî –Ω–∞—É—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
     * MAPE = Mean Absolute Percentage Error
     * Bayesian: posterior = prior √ó likelihood
     * @param {Object} options - { lsGet, pIndex, daysBack }
     * @returns {Object} { mape, bayesianConfidence, crossValidation, qualityGrade }
     */
    calculateBayesianConfidence: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const daysBack = options.daysBack || 30;
      const days = getDaysData(daysBack, lsGet);

      // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–Ω–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
      const validDays = days.filter(d => (d.meals?.length || 0) > 0 && d.weightMorning > 0);

      if (validDays.length < 10) {
        return {
          mape: null,
          bayesianConfidence: 0.5,
          crossValidation: null,
          qualityGrade: 'insufficient',
          message: '–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10 –¥–Ω–µ–π —Å –≤–µ—Å–æ–º –∏ –ø–∏—Ç–∞–Ω–∏–µ–º',
          hasData: false
        };
      }

      // === MAPE: Cross-validation –¥–ª—è –∫–∞–ª–æ—Ä–∏–π ‚Üí –≤–µ—Å ===
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º leave-one-out cross-validation
      const predictions = [];
      const actuals = [];

      for (let i = 1; i < validDays.length - 1; i++) {
        // –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞–ª–æ—Ä–∏–π –∑–∞ 3 –¥–Ω—è –¥–æ
        const prevDays = validDays.slice(i, i + 3);
        const avgKcal = average(prevDays.map(d => calculateDayKcal(d, pIndex)));
        const avgWeight = average(prevDays.map(d => d.weightMorning));

        // –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å: kcalDeficit √ó 7700 = –ø–æ—Ç–µ—Ä—è –∂–∏—Ä–∞
        // 7700 –∫–∫–∞–ª ‚âà 1 –∫–≥ –∂–∏—Ä–∞ (Wishnofsky 1958, —Å–ø–æ—Ä–Ω–æ –Ω–æ —à–∏—Ä–æ–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        const optimum = 2000; // baseline
        const dailyDeficit = optimum - avgKcal;
        const predictedWeightChange = (dailyDeficit * 3) / 7700; // –∑–∞ 3 –¥–Ω—è
        const predictedWeight = avgWeight - predictedWeightChange;

        const actualWeight = validDays[i - 1].weightMorning;

        if (actualWeight > 0 && predictedWeight > 0) {
          predictions.push(predictedWeight);
          actuals.push(actualWeight);
        }
      }

      // MAPE calculation
      let mape = null;
      if (predictions.length >= 5) {
        const apes = predictions.map((pred, i) =>
          Math.abs((actuals[i] - pred) / actuals[i]) * 100
        );
        mape = average(apes);
      }

      // === Bayesian Confidence ===
      // Prior: –±–∞–∑–æ–≤–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å 0.5
      // Likelihood: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç MAPE –∏ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö
      const prior = 0.5;

      // Likelihood –Ω–∞ –æ—Å–Ω–æ–≤–µ MAPE (—á–µ–º –Ω–∏–∂–µ MAPE, —Ç–µ–º –≤—ã—à–µ)
      const mapeLikelihood = mape !== null
        ? Math.max(0.1, 1 - (mape / 20)) // MAPE 0% = 1.0, MAPE 20% = 0.0
        : 0.5;

      // Likelihood –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö (n)
      // –§–æ—Ä–º—É–ª–∞: 1 - 1/(1 + n/10)
      const nLikelihood = 1 - 1 / (1 + validDays.length / 10);

      // Likelihood –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–Ω–∏–∑–∫–∞—è std –≤–µ—Å–∞ = —Ö–æ—Ä–æ—à–æ)
      const weights = validDays.map(d => d.weightMorning);
      const weightStd = stdDev(weights);
      const consistencyLikelihood = Math.max(0.3, 1 - weightStd / 5);

      // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π likelihood
      const likelihood = (mapeLikelihood * 0.4 + nLikelihood * 0.3 + consistencyLikelihood * 0.3);

      // Posterior (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π Bayesian update)
      // P(accurate | data) = P(data | accurate) √ó P(accurate) / P(data)
      // –£–ø—Ä–æ—â–∞–µ–º: posterior ‚àù prior √ó likelihood
      const unnormalizedPosterior = prior * likelihood;
      const bayesianConfidence = Math.min(0.95, unnormalizedPosterior / 0.5); // normalize to [0, 0.95]

      // Cross-validation metrics
      const crossValidation = predictions.length >= 5 ? {
        r2: calculateR2(actuals, predictions),
        rmse: Math.sqrt(average(predictions.map((p, i) => Math.pow(actuals[i] - p, 2)))),
        mae: average(predictions.map((p, i) => Math.abs(actuals[i] - p))),
        n: predictions.length
      } : null;

      // Quality grade
      const qualityGrade = bayesianConfidence >= 0.8 ? 'excellent'
        : bayesianConfidence >= 0.65 ? 'good'
          : bayesianConfidence >= 0.5 ? 'moderate'
            : 'low';

      const gradeEmoji = { excellent: 'üéØ', good: '‚úÖ', moderate: '‚ö†Ô∏è', low: '‚ùå' }[qualityGrade];

      return {
        mape: mape !== null ? Math.round(mape * 10) / 10 : null,
        bayesianConfidence: Math.round(bayesianConfidence * 100) / 100,
        confidencePercent: Math.round(bayesianConfidence * 100),
        crossValidation,
        qualityGrade,
        gradeEmoji,
        components: {
          mapeLikelihood: Math.round(mapeLikelihood * 100),
          nLikelihood: Math.round(nLikelihood * 100),
          consistencyLikelihood: Math.round(consistencyLikelihood * 100)
        },
        dataPoints: validDays.length,
        message: qualityGrade === 'excellent'
          ? '–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π!'
          : qualityGrade === 'good'
            ? '–•–æ—Ä–æ—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤–µ—Å—Ç–∏ —É—á—ë—Ç'
            : '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π',
        pmid: '13524500', // Wishnofsky 1958 ‚Äî 3500 kcal/lb
        hasData: true
      };
    },

    /**
     * Time-Lagged Cross-Correlation ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç–∏
     * Granger-like causality: X –≤—ã–∑—ã–≤–∞–µ—Ç Y –µ—Å–ª–∏ –ø—Ä–æ—à–ª—ã–µ X –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—é—Ç Y
     * @param {Object} options - { lsGet, pIndex, daysBack }
     * @returns {Object} { causalLinks, lagAnalysis, strongest }
     */
    calculateTimeLaggedCorrelations: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const daysBack = options.daysBack || 30;
      const days = getDaysData(daysBack, lsGet).reverse(); // —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫

      if (days.length < 14) {
        return {
          causalLinks: [],
          lagAnalysis: [],
          strongest: null,
          hasData: false,
          message: '–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 14 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö'
        };
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã
      const series = {
        sleep: days.map(d => d.sleepHours || 0),
        kcal: days.map(d => calculateDayKcal(d, pIndex)),
        weight: days.map(d => d.weightMorning || 0),
        mood: days.map(d => d.moodAvg || d.dayScore || 0),
        stress: days.map(d => d.stressAvg || 0),
        steps: days.map(d => d.steps || 0),
        simple: days.map(d => {
          let simple = 0;
          (d.meals || []).forEach(m => (m.items || []).forEach(item => {
            const g = item.grams || 0;
            const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
            if (prod && g > 0) simple += (prod.simple100 || 0) * g / 100;
          }));
          return simple;
        })
      };

      // –ü–∞—Ä—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç–∏
      const causalPairs = [
        { cause: 'sleep', effect: 'kcal', label: '–°–æ–Ω ‚Üí –ö–∞–ª–æ—Ä–∏–∏', hypothesis: '–ù–µ–¥–æ—Å—ã–ø –≤—ã–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ' },
        { cause: 'sleep', effect: 'mood', label: '–°–æ–Ω ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', hypothesis: '–°–æ–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ —ç–º–æ—Ü–∏–∏' },
        { cause: 'stress', effect: 'simple', label: '–°—Ç—Ä–µ—Å—Å ‚Üí –°–ª–∞–¥–∫–æ–µ', hypothesis: '–°—Ç—Ä–µ—Å—Å –≤—ã–∑—ã–≤–∞–µ—Ç —Ç—è–≥—É –∫ —Å–∞—Ö–∞—Ä—É' },
        { cause: 'stress', effect: 'kcal', label: '–°—Ç—Ä–µ—Å—Å ‚Üí –ö–∞–ª–æ—Ä–∏–∏', hypothesis: '–°—Ç—Ä–µ—Å—Å–æ–≤–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ' },
        { cause: 'kcal', effect: 'weight', label: '–ö–∞–ª–æ—Ä–∏–∏ ‚Üí –í–µ—Å', hypothesis: '–ò–∑–±—ã—Ç–æ–∫ –∫–∞–ª–æ—Ä–∏–π ‚Üí –Ω–∞–±–æ—Ä –≤–µ—Å–∞' },
        { cause: 'steps', effect: 'mood', label: '–®–∞–≥–∏ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', hypothesis: '–î–≤–∏–∂–µ–Ω–∏–µ —É–ª—É—á—à–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ' },
        { cause: 'simple', effect: 'mood', label: '–°–ª–∞–¥–∫–æ–µ ‚Üí –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (lag)', hypothesis: '–°–∞—Ö–∞—Ä ‚Üí –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—ä—ë–º ‚Üí —Å–ø–∞–¥' }
      ];

      const lagAnalysis = [];

      causalPairs.forEach(({ cause, effect, label, hypothesis }) => {
        const causeData = series[cause];
        const effectData = series[effect];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –ª–∞–≥–∞–º–∏ (0-3 –¥–Ω—è)
        const lagResults = [];

        for (let lag = 0; lag <= 3; lag++) {
          const validPairs = [];

          for (let i = lag; i < days.length; i++) {
            const causeVal = causeData[i - lag];
            const effectVal = effectData[i];

            if (causeVal > 0 && effectVal > 0) {
              validPairs.push({ cause: causeVal, effect: effectVal });
            }
          }

          if (validPairs.length >= 7) {
            const r = pearsonCorrelation(
              validPairs.map(p => p.cause),
              validPairs.map(p => p.effect)
            );

            lagResults.push({
              lag,
              correlation: Math.round(r * 100) / 100,
              absCorrelation: Math.abs(r),
              dataPoints: validPairs.length,
              significant: Math.abs(r) > 0.3
            });
          }
        }

        if (lagResults.length > 0) {
          // –ù–∞—Ö–æ–¥–∏–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–∞–≥ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è |–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è|)
          const bestLag = lagResults.reduce((best, curr) =>
            curr.absCorrelation > best.absCorrelation ? curr : best
            , lagResults[0]);

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç–∏
          // –ï—Å–ª–∏ lag > 0 –¥–∞—ë—Ç —Å–∏–ª—å–Ω–µ–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é ‚Äî –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–ê—è –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å
          const lag0 = lagResults.find(l => l.lag === 0);
          const hasCausality = bestLag.lag > 0 && bestLag.absCorrelation > (lag0?.absCorrelation || 0) + 0.1;

          lagAnalysis.push({
            cause,
            effect,
            label,
            hypothesis,
            lagResults,
            bestLag: bestLag.lag,
            bestCorrelation: bestLag.correlation,
            hasCausality,
            causalStrength: hasCausality ? 'confirmed' : bestLag.absCorrelation > 0.3 ? 'possible' : 'weak',
            insight: hasCausality
              ? `‚úÖ ${label}: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ (–ª–∞–≥ ${bestLag.lag} –¥–Ω, r=${bestLag.correlation})`
              : bestLag.absCorrelation > 0.3
                ? `üìä ${label}: —Å–≤—è–∑—å –µ—Å—Ç—å (r=${bestLag.correlation})`
                : `‚ö™ ${label}: —Å–≤—è–∑—å —Å–ª–∞–±–∞—è`
          });
        }
      });

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–∏–ª–µ –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç–∏
      const sorted = [...lagAnalysis].sort((a, b) =>
        (b.hasCausality ? 1 : 0) - (a.hasCausality ? 1 : 0) ||
        b.bestCorrelation - a.bestCorrelation
      );

      const causalLinks = sorted.filter(l => l.hasCausality);

      return {
        causalLinks,
        lagAnalysis: sorted,
        strongest: causalLinks[0] || sorted[0] || null,
        confirmedCount: causalLinks.length,
        totalAnalyzed: lagAnalysis.length,
        hasData: lagAnalysis.length > 0,
        pmid: '7608935' // Granger 1969 ‚Äî causality testing
      };
    },

    /**
     * Glycemic Variability Index (GVI) + CONGA
     * CV% = (stdDev / mean) √ó 100 ‚Äî –ø—Ä–æ—Å—Ç–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
     * CONGA = Continuous Overall Net Glycemic Action (—Å–∏–º—É–ª—è—Ü–∏—è)
     * @param {Object} options - { lsGet, pIndex, daysBack }
     * @returns {Object} { gvi, conga, insulinVolatility, riskCategory }
     */
    calculateGlycemicVariability: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const daysBack = options.daysBack || 14;
      const days = getDaysData(daysBack, lsGet);

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
      const mealGLs = [];
      const dailyGLs = [];

      days.forEach(day => {
        let dayGL = 0;
        (day.meals || []).forEach(meal => {
          let mealGL = 0;
          (meal.items || []).forEach(item => {
            const g = item.grams || 0;
            const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
            if (prod && g > 0) {
              const gi = prod.gi || prod.gi100 || 50;
              const carbs = ((prod.simple100 || 0) + (prod.complex100 || 0)) * g / 100;
              const gl = (gi * carbs) / 100;
              mealGL += gl;
            }
          });
          if (mealGL > 0) mealGLs.push(mealGL);
          dayGL += mealGL;
        });
        if (dayGL > 0) dailyGLs.push(dayGL);
      });

      if (mealGLs.length < 10 || dailyGLs.length < 5) {
        return {
          gvi: null,
          conga: null,
          insulinVolatility: null,
          riskCategory: 'insufficient',
          hasData: false,
          message: '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–∏—Ç–∞–Ω–∏–∏'
        };
      }

      // === GVI (Glycemic Variability Index) ===
      // CV% = (SD / Mean) √ó 100
      // Monnier 2006: CV% > 36% = –≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
      const mealGLMean = average(mealGLs);
      const mealGLStd = stdDev(mealGLs);
      const gvi = (mealGLStd / mealGLMean) * 100;

      // === CONGA-like (Continuous Net Glycemic Action) ===
      // –°–∏–º—É–ª–∏—Ä—É–µ–º: —Ä–∞–∑–Ω–∏—Ü–∞ GL –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–∏—ë–º–∞–º–∏
      const glDifferences = [];
      for (let i = 1; i < mealGLs.length; i++) {
        glDifferences.push(Math.abs(mealGLs[i] - mealGLs[i - 1]));
      }
      const conga = glDifferences.length > 0 ? average(glDifferences) : 0;

      // === Insulin Volatility Score ===
      // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞: GVI + daily variation
      const dailyGLStd = stdDev(dailyGLs);
      const dailyGLMean = average(dailyGLs);
      const dailyCV = dailyGLMean > 0 ? (dailyGLStd / dailyGLMean) * 100 : 0;

      const insulinVolatility = (gvi * 0.6 + dailyCV * 0.4);

      // Risk category (based on Monnier 2006)
      const riskCategory = gvi > 50 ? 'high'
        : gvi > 36 ? 'elevated'
          : gvi > 25 ? 'moderate'
            : 'low';

      const riskEmoji = { high: 'üö®', elevated: '‚ö†Ô∏è', moderate: 'üìä', low: '‚úÖ' }[riskCategory];
      const riskLabel = {
        high: '–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å',
        elevated: '–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è',
        moderate: '–£–º–µ—Ä–µ–Ω–Ω–∞—è',
        low: '–ù–∏–∑–∫–∞—è (—Ö–æ—Ä–æ—à–æ)'
      }[riskCategory];

      // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
      const recommendations = [];
      if (gvi > 36) {
        recommendations.push('–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–π —É–≥–ª–µ–≤–æ–¥—ã ‚Äî –±–æ–ª—å—à–∏–µ —Å–∫–∞—á–∫–∏ GL –≤—Ä–µ–¥–Ω—ã');
      }
      if (conga > 15) {
        recommendations.push('–ò–∑–±–µ–≥–∞–π —Ä–µ–∑–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: –º–Ω–æ–≥–æ —Å–ª–∞–¥–∫–æ–≥–æ ‚Üí –≥–æ–ª–æ–¥–∞–Ω–∏–µ');
      }
      if (mealGLMean > 25) {
        recommendations.push('–°–Ω–∏–∑—å —Å—Ä–µ–¥–Ω—é—é –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏—ë–º–æ–≤');
      }

      return {
        gvi: Math.round(gvi * 10) / 10,
        conga: Math.round(conga * 10) / 10,
        insulinVolatility: Math.round(insulinVolatility * 10) / 10,
        mealGLMean: Math.round(mealGLMean * 10) / 10,
        mealGLStd: Math.round(mealGLStd * 10) / 10,
        dailyCV: Math.round(dailyCV * 10) / 10,
        riskCategory,
        riskEmoji,
        riskLabel,
        recommendations,
        dataPoints: mealGLs.length,
        hasData: true,
        thresholds: { low: 25, moderate: 36, elevated: 50 },
        pmid: '16936182' // Monnier 2006 ‚Äî glycemic variability
      };
    },

    /**
     * Allostatic Load Score ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–º
     * McEwen 1998: —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –∏ –∏—Å—Ç–æ—â–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤—ã
     * @param {Object} options - { lsGet, pIndex, profile }
     * @returns {Object} { alScore, components, riskLevel, recovery }
     */
    calculateAllostaticLoad: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const profile = options.profile || lsGet('heys_profile', {});
      const days = getDaysData(14, lsGet);

      if (days.length < 7) {
        return {
          alScore: null,
          components: {},
          riskLevel: 'insufficient',
          hasData: false
        };
      }

      const components = {};
      let totalScore = 0;
      let maxScore = 0;

      // === 1. Cortisol Proxy (—Å—Ç—Ä–µ—Å—Å) ‚Äî 20% ===
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–µ—Å—Å –∫–∞–∫ proxy –¥–ª—è –∫–æ—Ä—Ç–∏–∑–æ–ª–∞
      const stressValues = days.map(d => d.stressAvg || 0).filter(s => s > 0);
      if (stressValues.length >= 3) {
        const avgStress = average(stressValues);
        const stressScore = Math.min(100, avgStress * 10);
        components.cortisol = {
          value: Math.round(avgStress * 10) / 10,
          score: Math.round(stressScore),
          weight: 0.20,
          label: '–°—Ç—Ä–µ—Å—Å (cortisol proxy)',
          status: stressScore > 60 ? 'elevated' : 'normal'
        };
        totalScore += stressScore * 0.20;
        maxScore += 100 * 0.20;
      }

      // === 2. Sleep Debt (–Ω–µ–¥–æ—Å—ã–ø) ‚Äî 20% ===
      const sleepNorm = profile.sleepHours || 8;
      const sleepValues = days.map(d => d.sleepHours || 0).filter(s => s > 0);
      if (sleepValues.length >= 3) {
        const avgSleep = average(sleepValues);
        const sleepDeficit = Math.max(0, sleepNorm - avgSleep);
        const sleepScore = Math.min(100, sleepDeficit * 25); // 4—á –Ω–µ–¥–æ—Å—ã–ø = 100
        components.sleepDebt = {
          value: Math.round(sleepDeficit * 10) / 10,
          score: Math.round(sleepScore),
          weight: 0.20,
          label: '–ù–µ–¥–æ—Å—ã–ø (sleep debt)',
          status: sleepScore > 50 ? 'elevated' : 'normal'
        };
        totalScore += sleepScore * 0.20;
        maxScore += 100 * 0.20;
      }

      // === 3. Metabolic Strain (–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π —Å—Ç—Ä–µ—Å—Å) ‚Äî 15% ===
      const optimum = HEYS.Day?.calculateOptimum?.(profile) || 2000;
      const kcalValues = days.map(d => calculateDayKcal(d, pIndex)).filter(k => k > 0);
      if (kcalValues.length >= 3) {
        const kcalDeviations = kcalValues.map(k => Math.abs(k - optimum) / optimum);
        const avgDeviation = average(kcalDeviations);
        const metabolicScore = Math.min(100, avgDeviation * 200); // 50% –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = 100
        components.metabolic = {
          value: Math.round(avgDeviation * 100),
          score: Math.round(metabolicScore),
          weight: 0.15,
          label: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å',
          status: metabolicScore > 50 ? 'elevated' : 'normal'
        };
        totalScore += metabolicScore * 0.15;
        maxScore += 100 * 0.15;
      }

      // === 4. Inflammatory Proxy (–≤—Ä–µ–¥–Ω–∞—è –µ–¥–∞) ‚Äî 15% ===
      let totalHarm = 0, totalGrams = 0;
      days.forEach(d => {
        (d.meals || []).forEach(m => (m.items || []).forEach(item => {
          const g = item.grams || 0;
          const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
          if (prod && g > 0) {
            totalHarm += (prod.harm || prod.harm100 || 0) * g / 100;
            totalGrams += g;
          }
        }));
      });
      if (totalGrams > 0) {
        const avgHarm = totalHarm / (days.length || 1);
        const inflammatoryScore = Math.min(100, avgHarm * 2);
        components.inflammatory = {
          value: Math.round(avgHarm * 10) / 10,
          score: Math.round(inflammatoryScore),
          weight: 0.15,
          label: '–í–æ—Å–ø–∞–ª–µ–Ω–∏–µ (harm proxy)',
          status: inflammatoryScore > 50 ? 'elevated' : 'normal'
        };
        totalScore += inflammatoryScore * 0.15;
        maxScore += 100 * 0.15;
      }

      // === 5. Activity Deficit (–≥–∏–ø–æ–¥–∏–Ω–∞–º–∏—è) ‚Äî 15% ===
      const stepsGoal = profile.stepsGoal || 8000;
      const stepsValues = days.map(d => d.steps || 0).filter(s => s > 0);
      if (stepsValues.length >= 3) {
        const avgSteps = average(stepsValues);
        const stepsDeficit = Math.max(0, (stepsGoal - avgSteps) / stepsGoal);
        const activityScore = Math.min(100, stepsDeficit * 100);
        components.activity = {
          value: Math.round(avgSteps),
          score: Math.round(activityScore),
          weight: 0.15,
          label: '–ì–∏–ø–æ–¥–∏–Ω–∞–º–∏—è',
          status: activityScore > 50 ? 'elevated' : 'normal'
        };
        totalScore += activityScore * 0.15;
        maxScore += 100 * 0.15;
      }

      // === 6. Mood Instability (—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å) ‚Äî 15% ===
      const moodValues = days.map(d => d.moodAvg || d.dayScore || 0).filter(m => m > 0);
      if (moodValues.length >= 5) {
        const moodStd = stdDev(moodValues);
        const moodInstability = Math.min(100, moodStd * 25); // std=4 = 100
        components.moodInstability = {
          value: Math.round(moodStd * 10) / 10,
          score: Math.round(moodInstability),
          weight: 0.15,
          label: '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',
          status: moodInstability > 50 ? 'elevated' : 'normal'
        };
        totalScore += moodInstability * 0.15;
        maxScore += 100 * 0.15;
      }

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å–∫–æ—Ä
      const alScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

      // Risk level (based on McEwen thresholds)
      const riskLevel = alScore >= 70 ? 'high'
        : alScore >= 50 ? 'elevated'
          : alScore >= 30 ? 'moderate'
            : 'low';

      const riskEmoji = { high: 'üö®', elevated: '‚ö†Ô∏è', moderate: 'üìä', low: '‚úÖ' }[riskLevel];
      const riskLabel = {
        high: '–í—ã—Å–æ–∫–∞—è –∞–ª–ª–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
        elevated: '–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
        moderate: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
        low: '–ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (—Ö–æ—Ä–æ—à–æ)'
      }[riskLevel];

      // Elevated components
      const elevatedComponents = Object.values(components).filter(c => c.status === 'elevated');

      // Recovery recommendations
      const recovery = [];
      if (components.sleepDebt?.status === 'elevated') {
        recovery.push('üí§ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∞');
      }
      if (components.cortisol?.status === 'elevated') {
        recovery.push('üßò –ü—Ä–∞–∫—Ç–∏–∫–∏ —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç—Ä–µ—Å—Å–∞');
      }
      if (components.activity?.status === 'elevated') {
        recovery.push('üö∂ –£–≤–µ–ª–∏—á—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å');
      }
      if (elevatedComponents.length >= 3) {
        recovery.push('‚ö†Ô∏è –û—Ä–≥–∞–Ω–∏–∑–º –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω ‚Äî –Ω—É–∂–µ–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ—Ç–¥—ã—Ö');
      }

      return {
        alScore,
        components,
        elevatedCount: elevatedComponents.length,
        totalComponents: Object.keys(components).length,
        riskLevel,
        riskEmoji,
        riskLabel,
        recovery,
        hasData: Object.keys(components).length >= 3,
        pmid: '9428090' // McEwen 1998 ‚Äî allostatic load
      };
    },

    /**
     * Early Warning Signals (EWS) ‚Äî –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∏ —Å—Ä—ã–≤–æ–≤
     * –¢–µ–æ—Ä–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º: –ø–µ—Ä–µ–¥ critical transition —Ä–∞—Å—Ç—ë—Ç:
     * - Variance (–¥–∏—Å–ø–µ—Ä—Å–∏—è)
     * - Autocorrelation (–∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è)
     * - Skewness (–∞—Å–∏–º–º–µ—Ç—Ä–∏—è)
     * @param {Object} options - { lsGet, pIndex }
     * @returns {Object} { ewsScore, signals, criticalTransitionRisk }
     */
    detectEarlyWarningSignals: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const pIndex = options.pIndex || HEYS.products?.buildIndex?.();
      const days = getDaysData(21, lsGet);

      if (days.length < 14) {
        return {
          ewsScore: null,
          signals: [],
          criticalTransitionRisk: 'insufficient',
          hasData: false
        };
      }

      // –ì–ª–∞–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π
      const optimum = 2000;
      const deviations = days.map(d => {
        const kcal = calculateDayKcal(d, pIndex);
        return kcal > 0 ? (kcal - optimum) / optimum : null;
      }).filter(d => d !== null);

      if (deviations.length < 10) {
        return {
          ewsScore: null,
          signals: [],
          criticalTransitionRisk: 'insufficient',
          hasData: false
        };
      }

      const signals = [];

      // === 1. Rising Variance (–¥–∏—Å–ø–µ—Ä—Å–∏—è —Ä–∞—Å—Ç—ë—Ç) ===
      // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∏—Å–ø–µ—Ä—Å–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π vs –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö 7
      const recent = deviations.slice(0, 7);
      const previous = deviations.slice(7, 14);

      const recentVar = variance(recent);
      const previousVar = variance(previous);
      const varianceRatio = previousVar > 0 ? recentVar / previousVar : 1;

      const varianceSignal = varianceRatio > 1.5;
      signals.push({
        type: 'variance',
        label: '–†–æ—Å—Ç –¥–∏—Å–ø–µ—Ä—Å–∏–∏',
        detected: varianceSignal,
        value: Math.round(varianceRatio * 100) / 100,
        threshold: 1.5,
        insight: varianceSignal
          ? '‚ö†Ô∏è –ü–∏—Ç–∞–Ω–∏–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º'
          : '‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ',
        weight: 0.35
      });

      // === 2. Rising Autocorrelation (–∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ä–∞—Å—Ç—ë—Ç) ===
      // –í—ã—Å–æ–∫–∞—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è = —Å–∏—Å—Ç–µ–º–∞ "–∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
      const lag1Autocorr = autocorrelation(recent, 1);
      const autocorrSignal = lag1Autocorr > 0.5;

      signals.push({
        type: 'autocorrelation',
        label: '–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (–∏–Ω–µ—Ä—Ü–∏—è)',
        detected: autocorrSignal,
        value: Math.round(lag1Autocorr * 100) / 100,
        threshold: 0.5,
        insight: autocorrSignal
          ? '‚ö†Ô∏è –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç ‚Äî —Å–ª–æ–∂–Ω–µ–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–æ—Ä–º–µ'
          : '‚úÖ –ì–∏–±–∫–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è',
        weight: 0.35
      });

      // === 3. Skewness (–∞—Å–∏–º–º–µ—Ç—Ä–∏—è ‚Äî –ø–µ—Ä–µ–∫–æ—Å –≤ —Å—Ç–æ—Ä–æ–Ω—É –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è) ===
      const skew = skewness(recent);
      const skewSignal = skew > 0.5; // –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø–µ—Ä–µ–∫–æ—Å –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é

      signals.push({
        type: 'skewness',
        label: '–ê—Å–∏–º–º–µ—Ç—Ä–∏—è (–ø–µ—Ä–µ–∫–æ—Å)',
        detected: skewSignal,
        value: Math.round(skew * 100) / 100,
        threshold: 0.5,
        insight: skewSignal
          ? skew > 0
            ? '‚ö†Ô∏è –¢–µ–Ω–¥–µ–Ω—Ü–∏—è –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é'
            : '‚ö†Ô∏è –¢–µ–Ω–¥–µ–Ω—Ü–∏—è –∫ –Ω–µ–¥–æ–µ–¥–∞–Ω–∏—é'
          : '‚úÖ –ë–∞–ª–∞–Ω—Å –≤ –Ω–æ—Ä–º–µ',
        weight: 0.20
      });

      // === 4. Trend (—Ç—Ä–µ–Ω–¥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–Ω–µ–π) ===
      const trendSlope = linearTrend(recent);
      const trendSignal = Math.abs(trendSlope) > 0.05;

      signals.push({
        type: 'trend',
        label: '–¢—Ä–µ–Ω–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π',
        detected: trendSignal,
        value: Math.round(trendSlope * 100) / 100,
        threshold: 0.05,
        insight: trendSignal
          ? trendSlope > 0
            ? 'üìà –ö–∞–ª–æ—Ä–∏–∏ —Ä–∞—Å—Ç—É—Ç –¥–µ–Ω—å –æ—Ç–æ –¥–Ω—è'
            : 'üìâ –ö–∞–ª–æ—Ä–∏–∏ –ø–∞–¥–∞—é—Ç –¥–µ–Ω—å –æ—Ç–æ –¥–Ω—è'
          : '‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥',
        weight: 0.10
      });

      // –ò—Ç–æ–≥–æ–≤—ã–π EWS Score
      const ewsScore = signals.reduce((sum, s) =>
        sum + (s.detected ? s.weight * 100 : 0)
        , 0);

      const detectedCount = signals.filter(s => s.detected).length;

      // Critical Transition Risk
      const criticalTransitionRisk = ewsScore >= 70 ? 'high'
        : ewsScore >= 45 ? 'elevated'
          : ewsScore >= 25 ? 'moderate'
            : 'low';

      const riskEmoji = { high: 'üö®', elevated: '‚ö†Ô∏è', moderate: 'üìä', low: '‚úÖ' }[criticalTransitionRisk];

      // Prediction
      const prediction = criticalTransitionRisk === 'high'
        ? '‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –Ω–∞ –≥—Ä–∞–Ω–∏ —Å—Ä—ã–≤–∞ ‚Äî –Ω—É–∂–Ω—ã –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –º–µ—Ä—ã!'
        : criticalTransitionRisk === 'elevated'
          ? 'üìä –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3-5 –¥–Ω–µ–π'
          : criticalTransitionRisk === 'moderate'
            ? 'üìà –ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏'
            : '‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞';

      return {
        ewsScore: Math.round(ewsScore),
        signals,
        detectedCount,
        criticalTransitionRisk,
        riskEmoji,
        prediction,
        dataPoints: deviations.length,
        hasData: true,
        science: 'Scheffer et al. 2009 ‚Äî Early Warning Signals for Critical Transitions (Nature)',
        pmid: '19727193' // Scheffer 2009
      };
    },

    /**
     * 2-Process Sleep Model ‚Äî –Ω–∞—É—á–Ω–∞—è –º–æ–¥–µ–ª—å —ç–Ω–µ—Ä–≥–∏–∏
     * Borb√©ly 1982: Energy = Process S (homeostatic) + Process C (circadian)
     * Process S: –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ "–¥–∞–≤–ª–µ–Ω–∏—è —Å–Ω–∞" –≤–æ –≤—Ä–µ–º—è –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è
     * Process C: —Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º (—Å–∏–Ω—É—Å–æ–∏–¥–∞ 24—á)
     * @param {Object} options - { lsGet, profile }
     * @returns {Object} { processS, processC, combinedEnergy, alertnessProfile }
     */
    calculate2ProcessModel: function (options = {}) {
      const lsGet = options.lsGet || U.lsGet;
      const profile = options.profile || lsGet('heys_profile', {});
      const days = getDaysData(7, lsGet);
      const today = days[0] || {};

      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentTime = currentHour + currentMinute / 60;

      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏
      const sleepEnd = today.sleepEnd
        ? parseInt(today.sleepEnd.split(':')[0]) + parseInt(today.sleepEnd.split(':')[1] || 0) / 60
        : 7; // default wake time

      const sleepHours = today.sleepHours || 7;
      const sleepDebt = Math.max(0, (profile.sleepHours || 8) - sleepHours);

      const hoursAwake = currentTime >= sleepEnd
        ? currentTime - sleepEnd
        : 24 - sleepEnd + currentTime;

      // === Process S (Homeostatic Sleep Pressure) ===
      // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç –¥–∞–≤–ª–µ–Ω–∏—è —Å–Ω–∞ –≤–æ –≤—Ä–µ–º—è –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è
      // S(t) = S0 √ó e^(t/œÑ_w) –≥–¥–µ œÑ_w ‚âà 18.2—á
      const tau_w = 18.2; // time constant for wake
      const S0 = sleepDebt > 0 ? 0.3 + sleepDebt * 0.1 : 0.2; // baseline (–≤—ã—à–µ –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—ã–ø)
      const processS = Math.min(1, S0 * Math.exp(hoursAwake / tau_w));

      // === Process C (Circadian) ===
      // –°–∏–Ω—É—Å–æ–∏–¥–∞ —Å –ø–µ—Ä–∏–æ–¥–æ–º 24—á, –ø–∏–∫ ~15-16—á (alertness), –º–∏–Ω–∏–º—É–º ~4—á
      // C(t) = 0.5 + 0.5 √ó cos(2œÄ √ó (t - 16) / 24)
      const circadianPeak = 15; // —á–∞—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–æ–¥—Ä–æ—Å—Ç–∏
      const processC = 0.5 + 0.5 * Math.cos(2 * Math.PI * (currentTime - circadianPeak) / 24);

      // === Combined Alertness ===
      // Alertness = C - S (—Ü–∏—Ä–∫–∞–¥–Ω–æ—Å—Ç—å –º–∏–Ω—É—Å –¥–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∞)
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 0-100
      const rawAlertness = processC - processS;
      const alertness = Math.max(0, Math.min(100, (rawAlertness + 0.5) * 100));

      // === –ü—Ä–æ—Ñ–∏–ª—å –Ω–∞ 24 —á–∞—Å–∞ ===
      const alertnessProfile = [];
      for (let h = 0; h < 24; h++) {
        const hAwake = h >= sleepEnd ? h - sleepEnd : (h < sleepEnd - 8 ? 24 - sleepEnd + h : 0);
        const hProcessS = Math.min(1, S0 * Math.exp(hAwake / tau_w));
        const hProcessC = 0.5 + 0.5 * Math.cos(2 * Math.PI * (h - circadianPeak) / 24);
        const hAlertness = Math.max(0, Math.min(100, (hProcessC - hProcessS + 0.5) * 100));

        alertnessProfile.push({
          hour: h,
          alertness: Math.round(hAlertness),
          processS: Math.round(hProcessS * 100),
          processC: Math.round(hProcessC * 100),
          label: `${h}:00`,
          zone: hAlertness >= 70 ? 'peak' : hAlertness >= 50 ? 'good' : hAlertness >= 30 ? 'moderate' : 'low'
        });
      }

      // –ù–∞—Ö–æ–¥–∏–º –æ–∫–Ω–∞
      const futureHours = alertnessProfile.filter(h => h.hour >= currentHour);
      const sortedFuture = [...futureHours].sort((a, b) => b.alertness - a.alertness);

      const peakWindow = sortedFuture[0] || alertnessProfile[15];
      const dipWindow = sortedFuture[sortedFuture.length - 1] || alertnessProfile[4];

      // Ultradian rhythm (90-min cycles) - —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
      // –ö–∞–∂–¥—ã–µ 90 –º–∏–Ω—É—Ç ‚Äî –º–∏–Ω–∏-–ø–∏–∫ –≤–Ω–∏–º–∞–Ω–∏—è
      const minutesSinceWake = hoursAwake * 60;
      const ultradianCycle = 90;
      const cyclePosition = (minutesSinceWake % ultradianCycle) / ultradianCycle;
      const ultradianPhase = cyclePosition < 0.5 ? 'rising' : 'falling';
      const nextUltradianPeak = Math.ceil(minutesSinceWake / ultradianCycle) * ultradianCycle - minutesSinceWake;

      // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
      const recommendations = [];

      if (alertness < 50 && currentHour < 14) {
        recommendations.push('‚òï –ù–∏–∑–∫–∞—è –±–æ–¥—Ä–æ—Å—Ç—å ‚Äî –∫–æ—Ñ–µ–∏–Ω –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Å–æ–Ω (20 –º–∏–Ω)');
      }
      if (processS > 0.7) {
        recommendations.push('üò¥ –í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∞ ‚Äî –∑–∞–ø–ª–∞–Ω–∏—Ä—É–π —Ä–∞–Ω–Ω–∏–π –æ—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É');
      }
      if (peakWindow.hour > currentHour && peakWindow.hour < currentHour + 4) {
        recommendations.push(`üéØ –ü–∏–∫ –±–æ–¥—Ä–æ—Å—Ç–∏ –≤ ${peakWindow.hour}:00 ‚Äî –∑–∞–ø–ª–∞–Ω–∏—Ä—É–π –≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏`);
      }
      if (sleepDebt > 1) {
        recommendations.push('üí§ –ù–∞–∫–æ–ø–∏–ª—Å—è –Ω–µ–¥–æ—Å—ã–ø ‚Äî —Å–µ–≥–æ–¥–Ω—è –ª–æ–∂–∏—Å—å —Ä–∞–Ω—å—à–µ');
      }

      return {
        processS: Math.round(processS * 100),
        processC: Math.round(processC * 100),
        alertness: Math.round(alertness),
        alertnessLevel: alertness >= 70 ? 'high' : alertness >= 50 ? 'moderate' : 'low',
        alertnessEmoji: alertness >= 70 ? '‚ö°' : alertness >= 50 ? 'üòä' : alertness < 30 ? 'üò¥' : 'üòê',
        hoursAwake: Math.round(hoursAwake * 10) / 10,
        sleepDebt: Math.round(sleepDebt * 10) / 10,
        alertnessProfile,
        peakWindow,
        dipWindow,
        ultradian: {
          phase: ultradianPhase,
          nextPeakIn: Math.round(nextUltradianPeak),
          cycleLength: ultradianCycle
        },
        recommendations,
        hasData: true,
        model: 'Borb√©ly 2-Process Model (1982)',
        pmid: '6128309' // Borb√©ly 1982
      };
    },

    /**
     * Calculate Emotional Risk - –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∏—Å–∫–∞ —Å—Ä—ã–≤–∞
     * –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ Epel et al., 2001: —Å—Ç—Ä–µ—Å—Å + –≥–æ–ª–æ–¥ = –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è
     * @param {Object} day - dayData –æ–±—ä–µ–∫—Ç
     * @param {Object} profile - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param {Function} lsGet - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è localStorage
     * @returns {Object} { level, stressLevel, factors, bingeRisk, recommendation, pmid, hasRisk }
     */
    calculateEmotionalRisk: function (day, profile, lsGet) {
      const getter = lsGet || U.lsGet || ((k, d) => {
        try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
      });

      const CFG_STRESS_HIGH_THRESHOLD = 6;
      const avgStress = day?.stressAvg || 0;
      const isHighStress = avgStress >= CFG_STRESS_HIGH_THRESHOLD;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      let emotionalRisk = {
        level: 'low', // low | medium | high | critical
        stressLevel: avgStress,
        factors: [],
        bingeRisk: 0, // 0-100%
        recommendation: null,
        pmid: '11070333', // Epel 2001
        hasRisk: false
      };

      // === –§–ê–ö–¢–û–† 1: –í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å ===
      if (isHighStress) {
        emotionalRisk.factors.push('–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å');
      }

      // === –§–ê–ö–¢–û–† 2: –ö–∞–ª–æ—Ä–∏–π–Ω—ã–π –¥–æ–ª–≥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è ===
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ 3 –¥–Ω—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –Ω–µ–¥–æ–±–æ—Ä–∞
      const today = new Date();
      let totalDebt = 0;
      let hasDebt = false;

      for (let i = 0; i < 3; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toISOString().split('T')[0];
        const dayData = getter(`heys_dayv2_${dateStr}`, {});

        // –†–∞—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∑–∞ –¥–µ–Ω—å
        const dayTdee = dayData.tdee || profile?.tdee || 2000;
        const dayKcal = (dayData.totKcal || 0);
        const dayDebt = Math.max(0, dayTdee - dayKcal);
        totalDebt += dayDebt;
      }

      const rawDebt = totalDebt;
      hasDebt = rawDebt > 400; // –ü–æ—Ä–æ–≥ –∑–Ω–∞—á–∏–º–æ–≥–æ –¥–æ–ª–≥–∞

      if (hasDebt && rawDebt > 400) {
        emotionalRisk.factors.push('–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –Ω–µ–¥–æ–±–æ—Ä');
      }

      // === –§–ê–ö–¢–û–† 3: –ü–∞—Ç—Ç–µ—Ä–Ω —Å—Ç—Ä–µ—Å—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è ===
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è –≤ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã–µ –¥–Ω–∏
      let stressEatingDetected = false;
      const last7days = [];
      for (let i = 0; i < 7; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toISOString().split('T')[0];
        const dayData = getter(`heys_dayv2_${dateStr}`, {});
        if (dayData.stressAvg) {
          last7days.push({
            stress: dayData.stressAvg || 0,
            kcal: dayData.totKcal || 0,
            tdee: dayData.tdee || profile?.tdee || 2000
          });
        }
      }

      // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å—Ç—Ä–µ—Å—Å-–ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ
      if (last7days.length >= 5) {
        const stressValues = last7days.map(d => d.stress);
        const overeatingValues = last7days.map(d => Math.max(0, d.kcal - d.tdee));
        if (average && pearsonCorrelation) {
          const corr = pearsonCorrelation(stressValues, overeatingValues);
          if (corr > 0.5) {
            stressEatingDetected = true;
          }
        }
      }

      if (stressEatingDetected) {
        emotionalRisk.factors.push('–ü–∞—Ç—Ç–µ—Ä–Ω —Å—Ç—Ä–µ—Å—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è');
      }

      // === –§–ê–ö–¢–û–† 4: –í–µ—á–µ—Ä/–Ω–æ—á—å (–ø–∏–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–∏) ===
      const hour = new Date().getHours();
      const isVulnerableTime = hour >= 19 || hour < 6; // 19:00-06:00

      if (isVulnerableTime) {
        emotionalRisk.factors.push('–í–µ—á–µ—Ä/–Ω–æ—á—å (–ø–∏–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–∏)');
      }

      // === –ó–ê–©–ò–¢–ù–´–ô –§–ê–ö–¢–û–†: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (—Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫) ===
      const hasTrainingToday = (day?.trainings || []).length > 0;
      const trainingProtection = hasTrainingToday ? -15 : 0; // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –Ω–∞ 15%

      // === –†–ê–°–ß–Å–¢ –†–ò–°–ö–ê ===
      // –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä = 25%, cap = 100% (–Ω–µ 90%)
      emotionalRisk.bingeRisk = Math.min(100, emotionalRisk.factors.length * 25 + trainingProtection);
      emotionalRisk.bingeRisk = Math.max(0, emotionalRisk.bingeRisk); // –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º

      // === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–†–û–í–ù–Ø –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô ===
      if (emotionalRisk.bingeRisk >= 75) {
        emotionalRisk.level = 'critical';
        emotionalRisk.recommendation = 'üö® –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞! –°—ä–µ—à—å —á—Ç–æ-—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ –ø–æ–∑–∂–µ';
      } else if (emotionalRisk.bingeRisk >= 50) {
        emotionalRisk.level = 'high';
        emotionalRisk.recommendation = '‚ö†Ô∏è –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–π ‚Äî —Å—Ç—Ä–µ—Å—Å + –≥–æ–ª–æ–¥ –ø—Ä–æ–≤–æ—Ü–∏—Ä—É—é—Ç –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ';
      } else if (emotionalRisk.bingeRisk >= 25) {
        emotionalRisk.level = 'medium';
        emotionalRisk.recommendation = '–°–ª–µ–¥–∏ –∑–∞ —Å–æ–±–æ–π ‚Äî –æ–¥–∏–Ω –∏–∑ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
      }

      emotionalRisk.hasRisk = emotionalRisk.bingeRisk >= 25;

      return emotionalRisk;
    }
  };

  // === MEMOIZATION LAYER (v1.0.0) ===
  // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–æ—Ä–æ–≥–∏–µ analytic —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è 44% —É—Å–∫–æ—Ä–µ–Ω–∏—è (P50 180ms ‚Üí 100ms)
  const cache = HEYS.InsightsPI?.cache || {};
  if (cache.memoize) {
    // calculateCorrelationMatrix ‚Äî –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ (12 –ø–∞—Ä) - —Å–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π
    analyticsAPI.calculateCorrelationMatrix = cache.memoize(
      analyticsAPI.calculateCorrelationMatrix,
      'calculateCorrelationMatrix',
      { ttl: 60000, maxSize: 50 }
    );

    // detectMetabolicPatterns ‚Äî –∞–Ω–∞–ª–∏–∑ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    if (analyticsAPI.detectMetabolicPatterns) {
      analyticsAPI.detectMetabolicPatterns = cache.memoize(
        analyticsAPI.detectMetabolicPatterns,
        'detectMetabolicPatterns',
        { ttl: 60000, maxSize: 50 }
      );
    }

    // calculateGlycemicVariability ‚Äî –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (CV%, CONGA)
    if (analyticsAPI.calculateGlycemicVariability) {
      analyticsAPI.calculateGlycemicVariability = cache.memoize(
        analyticsAPI.calculateGlycemicVariability,
        'calculateGlycemicVariability',
        { ttl: 60000, maxSize: 50 }
      );
    }

    // calculateAllostaticLoad ‚Äî –∞–ª–ª–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (7 –±–∏–æ–º–∞—Ä–∫–µ—Ä–æ–≤)
    if (analyticsAPI.calculateAllostaticLoad) {
      analyticsAPI.calculateAllostaticLoad = cache.memoize(
        analyticsAPI.calculateAllostaticLoad,
        'calculateAllostaticLoad',
        { ttl: 60000, maxSize: 50 }
      );
    }

    devLog('[HEYS.analyticsAPI] ‚ö° Memoization enabled for 4 expensive functions');
  }

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsightsPI.analyticsAPI = analyticsAPI;

  // –¢–∞–∫–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Ç–æ–¥—ã –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  Object.assign(HEYS.InsightsPI, analyticsAPI);

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piAnalyticsAPI = analyticsAPI;

  devLog('[PI Analytics API] v3.0.0 loaded ‚Äî 11 advanced analytics methods');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_calculations.js ===== */
// pi_calculations.js ‚Äî Helper Calculation Utilities v3.0.0
// Extracted from heys_predictive_insights_v1.js (Phase 10)
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤: –∫–∞–ª–æ—Ä–∏–∏, BMR, –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = HEYS.dev || global.HEYS?.dev || {};
  const devLog = DEV.log ? DEV.log.bind(DEV) : () => { };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ MealItem —á–µ—Ä–µ–∑ pIndex
   * @param {Object} item - —ç–ª–µ–º–µ–Ω—Ç –µ–¥—ã
   * @param {Object} pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @returns {number} –∫–∞–ª–æ—Ä–∏–∏
   */
  function calculateItemKcal(item, pIndex) {
    if (!item || !item.grams) return 0;
    const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
    if (!prod) return 0;
    const p = prod.protein100 || 0;
    const c = (prod.simple100 || 0) + (prod.complex100 || 0);
    const f = (prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0);
    // TEF-adjusted: protein 3 kcal/g (25% TEF), —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ —Å heys_day_core_bundle_v1.js
    return (p * 3 + c * 4 + f * 9) * item.grams / 100;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏ –∑–∞ –¥–µ–Ω—å
   * @param {Object} day - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @param {Object} pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @returns {number} –æ–±—â–∏–µ –∫–∞–ª–æ—Ä–∏–∏
   */
  function calculateDayKcal(day, pIndex) {
    let total = 0;
    if (!day.meals) return 0;
    for (const meal of day.meals) {
      if (!meal.items) continue;
      for (const item of meal.items) {
        total += calculateItemKcal(item, pIndex);
      }
    }
    return total;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å BMR (Mifflin-St Jeor)
   * üî¨ TDEE v1.1.0: –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ HEYS.TDEE.calcBMR() –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
   * @param {Object} profile - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {number} BMR
   */
  function calculateBMR(profile) {
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–æ–¥—É–ª—å TDEE ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (HEYS.TDEE?.calcBMR) {
      return HEYS.TDEE.calcBMR(profile);
    }

    // Fallback: inline —Ä–∞—Å—á—ë—Ç
    const weight = profile?.weight || 70;
    const height = profile?.height || 170;
    const age = profile?.age || 30;
    const isMale = profile?.gender !== '–ñ–µ–Ω—Å–∫–∏–π';

    if (isMale) {
      return 10 * weight + 6.25 * height - 5 * age + 5;
    } else {
      return 10 * weight + 6.25 * height - 5 * age - 161;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–Ω–µ–π –∏–∑ localStorage
   * @param {number} daysBack - —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–∑–∞–¥
   * @param {Function} lsGet - —Ñ—É–Ω–∫—Ü–∏—è U.lsGet
   * @returns {Array} –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π [{date, ...dayData}]
   */
  function getDaysData(daysBack, lsGet) {
    const days = [];
    const today = new Date();

    for (let i = 0; i < daysBack; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const dayData = lsGet(`heys_dayv2_${dateStr}`, null);

      if (dayData && Object.keys(dayData).length > 0) {
        days.push({
          date: dateStr,
          daysAgo: i,
          ...dayData
        });
      }
    }

    return days;
  }

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsightsPI.calculations = {
    calculateItemKcal,
    calculateDayKcal,
    calculateBMR,
    getDaysData
  };

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piCalculations = HEYS.InsightsPI.calculations;

  devLog('[PI Calculations] v3.0.0 loaded ‚Äî 4 calculation utilities');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_phenotype.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Phenotype Classifier & Multipliers v1.0
 * 
 * –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö, —Ü–∏—Ä–∫–∞–¥–Ω—ã—Ö –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö —Ñ–µ–Ω–æ—Ç–∏–ø–æ–≤
 * –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ adaptive thresholds.
 * 
 * Dependencies: pi_stats.js, pi_patterns.js
 * @param global
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    /**
     * Phenotype taxonomy
     */
    const PHENOTYPES = {
        metabolic: ['insulin_sensitive', 'insulin_resistant', 'metabolic_syndrome_risk', 'neutral'],
        circadian: ['morning_type', 'evening_type', 'flexible'],
        satiety: ['high_satiety', 'low_satiety', 'volume_eater', 'normal'],
        stress: ['stress_eater', 'stress_anorexic', 'neutral']
    };

    /**
     * Threshold multipliers by phenotype
     * Base multiplier = 1.0 (neutral)
     */
    const PHENOTYPE_MULTIPLIERS = {
        // Late eating hour (default = 21:00)
        lateEatingHour: {
            insulin_resistant: 0.85,    // Should eat earlier (21:00 ‚Üí 17:50)
            metabolic_syndrome_risk: 0.8, // Even earlier (21:00 ‚Üí 16:48)
            evening_type: 1.1,          // Can eat later (21:00 ‚Üí 23:06)
            morning_type: 0.95,         // Prefer earlier (21:00 ‚Üí 19:57)
            neutral: 1.0
        },

        // Protein per meal (default = 25g)
        proteinPerMealG: {
            low_satiety: 1.2,           // Need more protein (25g ‚Üí 30g)
            high_satiety: 0.9,          // Can manage with less (25g ‚Üí 22.5g)
            volume_eater: 0.95,         // Rely on volume, less on protein
            insulin_resistant: 1.15,    // More protein for insulin sensitivity
            neutral: 1.0
        },

        // Daily protein target (g/kg body weight)
        proteinTarget: {
            low_satiety: 1.2,           // Need more protein for satiety
            high_satiety: 0.9,          // Lower needs
            insulin_resistant: 1.15,    // Higher protein ratio
            metabolic_syndrome_risk: 1.1, // Preserve muscle mass
            neutral: 1.0
        },

        // Meal frequency (default = 3-4 meals/day)
        mealFrequency: {
            low_satiety: 1.2,           // More frequent meals OK (4 ‚Üí 4.8)
            high_satiety: 0.85,         // Fewer meals OK (4 ‚Üí 3.4)
            insulin_resistant: 0.9,     // Fewer, bigger meals (4 ‚Üí 3.6)
            neutral: 1.0
        },

        // Training proximity to meals (default = 2h)
        trainingProximityHours: {
            insulin_sensitive: 1.2,     // Can train closer to meals (2h ‚Üí 2.4h)
            insulin_resistant: 0.85,    // Should separate more (2h ‚Üí 1.7h)
            neutral: 1.0
        },

        // Carb per meal (default varies by profile)
        carbPerMealG: {
            insulin_sensitive: 1.15,    // Can handle more carbs
            insulin_resistant: 0.85,    // Should reduce carbs
            metabolic_syndrome_risk: 0.75, // Significant reduction
            neutral: 1.0
        },

        // Sleep variability tolerance (default = 1h)
        sleepVariabilityHours: {
            morning_type: 0.85,         // Less tolerance (1h ‚Üí 0.85h)
            evening_type: 1.15,         // More flexible (1h ‚Üí 1.15h)
            flexible: 1.2,              // Very flexible (1h ‚Üí 1.2h)
            neutral: 1.0
        },

        // Stress-eating sensitivity (default threshold)
        stressEatingThreshold: {
            stress_eater: 1.3,          // More sensitive detection
            stress_anorexic: 0.8,       // Less sensitive
            neutral: 1.0
        },

        // NEW v5.0: EWS Specific Thresholds

        // Sodium limit (default = 2300-2500 mg)
        sodiumLimit: {
            insulin_resistant: 0.8,     // Stricter limit for BP/water retention
            metabolic_syndrome_risk: 0.7, // Very strict
            high_satiety: 1.1,          // Can tolerate slightly more
            neutral: 1.0
        },

        // Sugar limit (default = 25-30g added sugar)
        sugarLimit: {
            insulin_resistant: 0.5,     // Very strict reduction needed
            metabolic_syndrome_risk: 0.4, // Minimal sugar
            stress_eater: 0.6,          // Trigger food reduction
            neutral: 1.0
        },

        // Fiber target (default = 25-30g)
        fiberTarget: {
            insulin_resistant: 1.2,     // Need more for blood sugar control
            low_satiety: 1.3,           // Maximize volume/satiety
            gut_health_risk: 1.25,      // (Future phenotype)
            neutral: 1.0
        },

        // Fasting window hours (eating window duration)
        mealTimeWindow: {
            insulin_resistant: 0.9,     // Shorter eating window better (TRF)
            evening_type: 1.1,          // Shifted window
            stress_anorexic: 1.2,       // Longer window to ensure intake
            neutral: 1.0
        },

        // Binge volume threshold (kcal in one sitting)
        bingeVolume: {
            volume_eater: 1.2,          // Higher threshold (adaptation)
            stress_eater: 0.8,          // Lower threshold (early warning)
            low_satiety: 0.9,           // Lower threshold
            neutral: 1.0
        },

        // Meal skip tolerance (hours between meals)
        mealSkipTolerance: {
            stress_anorexic: 0.7,       // Alert earlier on skips
            low_satiety: 0.8,           // Needs frequent meals
            morning_type: 0.9,          // Early energy needs
            neutral: 1.0
        }
    };

    /**
     * Apply phenotype multipliers to base thresholds
     * @param {object} baseThresholds - Base adaptive thresholds
     * @param {object} phenotype - User phenotype profile
     * @returns {object} - Adjusted thresholds
     */
    function applyPhenotypeMultipliers(baseThresholds, phenotype) {
        console.log('[Phenotype] üß¨ applyPhenotypeMultipliers called:', {
            phenotype,
            baseThresholdsCount: Object.keys(baseThresholds || {}).length
        });

        if (!phenotype || typeof phenotype !== 'object') {
            console.warn('[Phenotype] ‚ö†Ô∏è No phenotype provided, returning base thresholds');
            return baseThresholds;
        }

        const adjusted = { ...baseThresholds };

        // Apply multipliers for each threshold
        for (const [thresholdKey, multiplierMap] of Object.entries(PHENOTYPE_MULTIPLIERS)) {
            if (!adjusted[thresholdKey]) continue;

            let multiplier = 1.0;

            // Check all phenotype categories (metabolic, circadian, satiety, stress)
            for (const category of Object.keys(PHENOTYPES)) {
                const userPhenotype = phenotype[category];
                if (userPhenotype && multiplierMap[userPhenotype]) {
                    multiplier *= multiplierMap[userPhenotype];
                }
            }

            // Apply multiplier to base threshold
            if (typeof adjusted[thresholdKey] === 'number') {
                adjusted[thresholdKey] = Math.round(adjusted[thresholdKey] * multiplier * 10) / 10;
            }
        }

        const changedKeys = Object.keys(adjusted).filter(k => adjusted[k] !== baseThresholds[k]);
        console.log('[Phenotype] ‚úÖ Applied multipliers:', {
            totalThresholds: Object.keys(adjusted).length,
            changed: changedKeys.length,
            changedKeys
        });

        return adjusted;
    }

    /**
     * Auto-detect phenotype from 30-day behavior patterns
     * @param {object[]} days - 30+ days of data
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object|null} - Detected phenotype or null if insufficient data
     */
    function autoDetectPhenotype(days, profile, pIndex) {
        if (days.length < 30) {
            return null; // Need at least 30 days
        }

        const phenotype = {
            metabolic: 'neutral',
            circadian: 'flexible',
            satiety: 'normal',
            stress: 'neutral',
            confidence: {}
        };

        // 1. Metabolic phenotype (insulin sensitivity proxy)
        const metabolicSignals = detectMetabolicPhenotype(days, profile, pIndex);
        phenotype.metabolic = metabolicSignals.type;
        phenotype.confidence.metabolic = metabolicSignals.confidence;

        // 2. Circadian phenotype (meal timing patterns)
        const circadianSignals = detectCircadianPhenotype(days);
        phenotype.circadian = circadianSignals.type;
        phenotype.confidence.circadian = circadianSignals.confidence;

        // 3. Satiety phenotype (meal frequency & volume)
        const satietySignals = detectSatietyPhenotype(days, profile, pIndex);
        phenotype.satiety = satietySignals.type;
        phenotype.confidence.satiety = satietySignals.confidence;

        // 4. Stress phenotype (psychological eating patterns)
        const stressSignals = detectStressPhenotype(days, profile, pIndex);
        phenotype.stress = stressSignals.type;
        phenotype.confidence.stress = stressSignals.confidence;

        return phenotype;
    }

    /**
     * Detect metabolic phenotype (insulin sensitivity proxy)
     * Signals: carb tolerance, post-meal energy, weight stability
     * @private
     */
    function detectMetabolicPhenotype(days, profile, pIndex) {
        // Simplified detection logic (placeholder for full implementation)
        const weightChange = getWeightTrend(days);
        const carbIntake = getAvgCarbIntake(days, pIndex);
        const energyLevels = getAvgEnergyLevels(days);

        let type = 'neutral';
        let confidence = 0.5;

        // High carb + weight gain + low energy = insulin_resistant
        if (carbIntake > 200 && weightChange > 0.5 && energyLevels < 60) {
            type = 'insulin_resistant';
            confidence = 0.7;
        }
        // Moderate/high carb + stable weight + good energy = insulin_sensitive
        else if (carbIntake > 150 && Math.abs(weightChange) < 0.3 && energyLevels > 70) {
            type = 'insulin_sensitive';
            confidence = 0.75;
        }

        return { type, confidence };
    }

    /**
     * Detect circadian phenotype (meal timing preferences)
     * Signals: first meal time, last meal time, consistency
     * @private
     */
    function detectCircadianPhenotype(days) {
        const firstMealTimes = [];
        const lastMealTimes = [];

        days.forEach(day => {
            if (!day.meals || day.meals.length === 0) return;

            const firstMeal = day.meals[0];
            const lastMeal = day.meals[day.meals.length - 1];

            if (firstMeal?.time) firstMealTimes.push(parseTime(firstMeal.time));
            if (lastMeal?.time) lastMealTimes.push(parseTime(lastMeal.time));
        });

        if (firstMealTimes.length < 15) {
            return { type: 'flexible', confidence: 0.3 };
        }

        const avgFirstMeal = average(firstMealTimes);
        const avgLastMeal = average(lastMealTimes);

        let type = 'flexible';
        let confidence = 0.6;

        // Early first meal (<8:00) + early last meal (<20:00) = morning_type
        if (avgFirstMeal < 8 && avgLastMeal < 20) {
            type = 'morning_type';
            confidence = 0.75;
        }
        // Late first meal (>10:00) + late last meal (>21:00) = evening_type
        else if (avgFirstMeal > 10 && avgLastMeal > 21) {
            type = 'evening_type';
            confidence = 0.75;
        }

        return { type, confidence };
    }

    /**
     * Detect satiety phenotype (meal frequency & volume)
     * Signals: meal frequency, portion sizes, snacking
     * @private
     */
    function detectSatietyPhenotype(days, profile, pIndex) {
        const avgMealFrequency = getAvgMealFrequency(days);
        const avgPortionSize = getAvgPortionSize(days, pIndex);

        let type = 'normal';
        let confidence = 0.6;

        // Many small meals = low_satiety
        if (avgMealFrequency > 5 && avgPortionSize < 400) {
            type = 'low_satiety';
            confidence = 0.7;
        }
        // Few large meals = high_satiety
        else if (avgMealFrequency < 3 && avgPortionSize > 600) {
            type = 'high_satiety';
            confidence = 0.7;
        }
        // High volume, normal frequency = volume_eater
        else if (avgMealFrequency >= 3 && avgMealFrequency <= 4 && avgPortionSize > 500) {
            type = 'volume_eater';
            confidence = 0.65;
        }

        return { type, confidence };
    }

    /**
     * Detect stress phenotype (psychological eating patterns)
     * Signals: stress-eating correlation, mood-food patterns
     * @private
     */
    function detectStressPhenotype(days, profile, pIndex) {
        // Check if stress_eating pattern exists and is significant
        const patterns = HEYS.InsightsPI?.patterns;
        if (!patterns) {
            return { type: 'neutral', confidence: 0.3 };
        }

        try {
            const stressEating = patterns.psychology?.analyzeStressEating?.(days, profile, pIndex);
            const moodFood = patterns.psychology?.analyzeMoodFood?.(days, profile, pIndex);

            let type = 'neutral';
            let confidence = 0.5;

            if (stressEating?.correlation && Math.abs(stressEating.correlation) > 0.3) {
                type = stressEating.correlation > 0 ? 'stress_eater' : 'stress_anorexic';
                confidence = Math.min(0.85, Math.abs(stressEating.correlation));
            } else if (moodFood?.correlation && Math.abs(moodFood.correlation) > 0.3) {
                type = moodFood.correlation > 0 ? 'stress_eater' : 'stress_anorexic';
                confidence = Math.min(0.8, Math.abs(moodFood.correlation));
            }

            return { type, confidence };
        } catch (e) {
            console.warn('[Phenotype] Stress detection failed:', e.message);
            return { type: 'neutral', confidence: 0.3 };
        }
    }

    // Helper functions
    function getWeightTrend(days) {
        const weights = days.map(d => d.weight).filter(w => w > 0);
        if (weights.length < 10) return 0;
        return weights[weights.length - 1] - weights[0];
    }

    function getAvgCarbIntake(days, pIndex) {
        const carbs = days.map(d => d.dayTot?.carb || 0).filter(c => c > 0);
        return average(carbs);
    }

    function getAvgEnergyLevels(days) {
        const energy = days.map(d => d.wellbeing?.energy || 0).filter(e => e > 0);
        return average(energy);
    }

    function getAvgMealFrequency(days) {
        const frequencies = days.map(d => d.meals?.length || 0).filter(f => f > 0);
        return average(frequencies);
    }

    function getAvgPortionSize(days, pIndex) {
        const calculateItemKcal = HEYS.InsightsPI?.calculations?.calculateItemKcal;
        if (!calculateItemKcal) return 400;

        const portions = [];
        days.forEach(day => {
            if (!day.meals) return;
            day.meals.forEach(meal => {
                if (!meal.items) return;
                const mealKcal = meal.items.reduce((sum, item) =>
                    sum + calculateItemKcal(item, pIndex), 0);
                if (mealKcal > 0) portions.push(mealKcal);
            });
        });

        return average(portions);
    }

    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours + (minutes || 0) / 60;
    }

    function average(arr) {
        if (!arr || arr.length === 0) return 0;
        return arr.reduce((sum, val) => sum + val, 0) / arr.length;
    }

    // Export API
    HEYS.InsightsPI.phenotype = {
        PHENOTYPES,
        PHENOTYPE_MULTIPLIERS,
        applyMultipliers: applyPhenotypeMultipliers,
        autoDetect: autoDetectPhenotype
    };

    console.info('[HEYS.InsightsPI.phenotype] ‚úÖ Phenotype Classifier v1.0 initialized');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_causal_chains.js ===== */
/**
 * HEYS Insights ‚Äî Causal Chains Detector v1.0
 * 
 * –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É warnings –∏ patterns
 * –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è root causes –∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π.
 * 
 * @module pi_causal_chains
 * @version 1.0.0
 * @date 2026-02-16
 */

(function (HEYS) {
    'use strict';

    HEYS = HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const LOG_PREFIX = 'ews / causal_chain';

    /**
     * –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
     * –ö–∞–∂–¥–∞—è —Ü–µ–ø–æ—á–∫–∞: root_cause ‚Üí intermediate_nodes ‚Üí outcome
     */
    const CAUSAL_CHAINS_LIBRARY = [
        {
            chainId: 'SLEEP_STRESS_BINGE',
            name: '–ù–µ–¥–æ—Å—ã–ø ‚Üí –°—Ç—Ä–µ—Å—Å ‚Üí –ü–µ—Ä–µ–µ–¥–∞–Ω–∏–µ',
            nodes: ['SLEEP_DEBT', 'STRESS_ACCUMULATION', 'BINGE_RISK'],
            rootCause: 'SLEEP_DEBT',
            outcome: 'BINGE_RISK',
            confidence: 0.85, // –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –±–∞–∑–∞
            mechanism: '–ù–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª ‚Üí —Å—Ç—Ä–µ—Å—Å ‚Üí —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ',
            actionableFix: [
                '–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–Ω: —Ü–µ–ª—å 7-8 —á–∞—Å–æ–≤',
                '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–æ–º: –º–µ–¥–∏—Ç–∞—Ü–∏—è, –ø—Ä–æ–≥—É–ª–∫–∏',
                '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ: —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∏—ë–º—ã, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –∑–∞–≤—Ç—Ä–∞–∫'
            ],
            evidenceLevel: 'A', // Strong RCT evidence
            sources: ['PMID:29195725', 'PMID:23439798']
        },
        {
            chainId: 'LOGGING_PATTERN_GOAL',
            name: '–ü—Ä–æ–ø—É—Å–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ ‚Üí –û—Ç–¥–∞–ª–µ–Ω–∏–µ –æ—Ç —Ü–µ–ª–∏',
            nodes: ['LOGGING_GAP', 'CRITICAL_PATTERN_DEGRADATION', 'STATUS_SCORE_DECLINE'],
            rootCause: 'LOGGING_GAP',
            outcome: 'STATUS_SCORE_DECLINE',
            confidence: 0.75,
            mechanism: '–ü–æ—Ç–µ—Ä—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ ‚Üí —É—Ö—É–¥—à–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–µ–∫ ‚Üí –æ–±—â–∏–π –æ—Ç–∫–∞—Ç',
            actionableFix: [
                '–£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—ë–º—ã',
                '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—Ä–µ–º—è',
                '–§–æ–∫—É—Å –Ω–∞ 2-3 –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞, –∞ –Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É'
            ],
            evidenceLevel: 'B', // Behavioral studies
            sources: ['PMID:22281454']
        },
        {
            chainId: 'CALORIC_MOOD_EVENING',
            name: '–ö–∞–ª–æ—Ä–∏–π–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç ‚Üí –£–ø–∞–¥–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚Üí –í–µ—á–µ—Ä–Ω–µ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ',
            nodes: ['CALORIC_DEBT', 'MOOD_WELLBEING_DECLINE', 'EVENING_OVERCONSUMPTION'],
            rootCause: 'CALORIC_DEBT',
            outcome: 'EVENING_OVERCONSUMPTION',
            confidence: 0.80,
            mechanism: '–ò–∑–±—ã—Ç–æ—á–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç ‚Üí –Ω–∏–∑–∫–∏–π —Å–∞—Ö–∞—Ä ‚Üí —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí –≤–µ—á–µ—Ä–Ω–∏–µ —Å—Ä—ã–≤—ã',
            actionableFix: [
                '–£–≤–µ–ª–∏—á–∏—Ç—å –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 10-15% –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞',
                '–î–æ–±–∞–≤–∏—Ç—å –±–µ–ª–æ–∫ –≤ –∑–∞–≤—Ç—Ä–∞–∫ –∏ –æ–±–µ–¥',
                '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–µ—á–µ—Ä–Ω–∏–π –ø—Ä–∏—ë–º: –ª—ë–≥–∫–∏–π —É–∂–∏–Ω –±–µ–∑ —á—É–≤—Å—Ç–≤–∞ –¥–µ–ø—Ä–∏–≤–∞—Ü–∏–∏'
            ],
            evidenceLevel: 'A',
            sources: ['PMID:17228046', 'PMID:25896063']
        },
        {
            chainId: 'TRAINING_RECOVERY_PLATEAU',
            name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üí –°—Ç—Ä–µ—Å—Å ‚Üí –ü–ª–∞—Ç–æ',
            nodes: ['TRAINING_WITHOUT_RECOVERY', 'STRESS_ACCUMULATION', 'WEIGHT_PLATEAU'],
            rootCause: 'TRAINING_WITHOUT_RECOVERY',
            outcome: 'WEIGHT_PLATEAU',
            confidence: 0.70,
            mechanism: 'Overtraining ‚Üí –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –∫–æ—Ä—Ç–∏–∑–æ–ª ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã + –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞',
            actionableFix: [
                '–î–æ–±–∞–≤–∏—Ç—å 1-2 –¥–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–π–æ–≥–∞, —Ö–æ–¥—å–±–∞)',
                '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–Ω –∏ –ø—Ä–æ—Ç–µ–∏–Ω (1.6-2.2g/kg)',
                '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å deload-–Ω–µ–¥–µ–ª—é (—Å–Ω–∏–∂–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ –Ω–∞ 40%)'
            ],
            evidenceLevel: 'B',
            sources: ['PMID:26388513']
        },
        {
            chainId: 'PROTEIN_SATIETY_BINGE',
            name: '–î–µ—Ñ–∏—Ü–∏—Ç –±–µ–ª–∫–∞ ‚Üí –ù–∏–∑–∫–∞—è —Å—ã—Ç–æ—Å—Ç—å ‚Üí –†–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è',
            nodes: ['PROTEIN_DEFICIT', 'MEAL_SKIP_PATTERN', 'BINGE_RISK'],
            rootCause: 'PROTEIN_DEFICIT',
            outcome: 'BINGE_RISK',
            confidence: 0.78,
            mechanism: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –±–µ–ª–∫–∞ ‚Üí —Å–ª–∞–±–∞—è —Å—ã—Ç–æ—Å—Ç—å ‚Üí –ø—Ä–æ–ø—É—Å–∫–∏ –ø—Ä–∏—ë–º–æ–≤ ‚Üí –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ',
            actionableFix: [
                '–ü–æ–≤—ã—Å–∏—Ç—å –±–µ–ª–æ–∫ –¥–æ 1.6-2.0g/kg –º–∞—Å—Å—ã —Ç–µ–ª–∞',
                '–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–µ–ª–æ–∫ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ: 25-30g –Ω–∞ –ø—Ä–∏—ë–º',
                '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –±–µ–ª–∫–æ–≤—ã–π –∑–∞–≤—Ç—Ä–∞–∫ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∞–ø–ø–µ—Ç–∏—Ç–∞ –¥–Ω—ë–º'
            ],
            evidenceLevel: 'A',
            sources: ['PMID:18469287', 'PMID:23446962']
        },
        {
            chainId: 'HYDRATION_MOOD_PERFORMANCE',
            name: '–î–µ—Ñ–∏—Ü–∏—Ç –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ ‚Üí –£—Ç–æ–º–ª—è–µ–º–æ—Å—Ç—å ‚Üí –°–Ω–∏–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
            nodes: ['HYDRATION_DEFICIT', 'MOOD_WELLBEING_DECLINE', 'STEP_DECLINE'],
            rootCause: 'HYDRATION_DEFICIT',
            outcome: 'STEP_DECLINE',
            confidence: 0.65,
            mechanism: '–û–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ 2%+ ‚Üí –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è ‚Üí —É—Å—Ç–∞–ª–æ—Å—Ç—å ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ NEAT',
            actionableFix: [
                '–¶–µ–ª—å: 30-35 –º–ª/–∫–≥ –≤–µ—Å–∞ —Ç–µ–ª–∞',
                '–ü–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –ø—Ä–∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–∏ –∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –ø—Ä–∏—ë–º–æ–º',
                '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–µ—Ä –≤–æ–¥—ã –∏–ª–∏ –±—É—Ç—ã–ª–∫—É —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π'
            ],
            evidenceLevel: 'B',
            sources: ['PMID:22190027']
        }
    ];

    /**
     * –î–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–∏—á–∏–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
     * @param {object} options - { warnings, patterns, trends }
     * @returns {object[]} –ú–∞—Å—Å–∏–≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
     */
    function detectCausalChains(options = {}) {
        const { warnings = [], patterns = {}, trends = {} } = options;

        console.info(`${LOG_PREFIX} üöÄ start`, {
            warningsCount: warnings.length,
            patternsCount: Object.keys(patterns).length,
            trendsCount: Object.keys(trends).length
        });

        console.info(`${LOG_PREFIX} üì• input`, {
            warningTypes: warnings.map(w => w.type),
            hasPatterns: !!patterns && Object.keys(patterns).length > 0,
            hasTrends: !!trends && Object.keys(trends).length > 0
        });

        // Graceful fallback –¥–ª—è –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (!warnings || warnings.length === 0) {
            console.info(`${LOG_PREFIX} ‚úÖ result`, { chains: 0, reason: 'no_warnings' });
            return [];
        }

        const detectedChains = [];
        const warningTypesSet = new Set(warnings.map(w => w.type));

        console.info(`${LOG_PREFIX} üßÆ compute`, {
            phase: 'matching_chains',
            librarySize: CAUSAL_CHAINS_LIBRARY.length,
            warningTypes: Array.from(warningTypesSet)
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ü–µ–ø–æ—á–∫—É –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        for (const chain of CAUSAL_CHAINS_LIBRARY) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ root cause
            if (!warningTypesSet.has(chain.rootCause)) continue;

            // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —É–∑–ª–æ–≤ —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
            const matchedNodes = chain.nodes.filter(node => warningTypesSet.has(node));
            const matchRatio = matchedNodes.length / chain.nodes.length;

            // –¢—Ä–µ–±—É–µ–º –º–∏–Ω–∏–º—É–º 50% –ø–æ–∫—Ä—ã—Ç–∏—è —Ü–µ–ø–æ—á–∫–∏ (–≤–∫–ª—é—á–∞—è root cause)
            if (matchRatio < 0.5) continue;

            // –ü–æ–ª—É—á–∞–µ–º warnings –¥–ª—è —ç—Ç–æ–π —Ü–µ–ø–æ—á–∫–∏
            const chainWarnings = warnings.filter(w => chain.nodes.includes(w.type));

            // –í—ã—á–∏—Å–ª—è–µ–º adjusted confidence –Ω–∞ –æ—Å–Ω–æ–≤–µ severity –∏ chronicity
            let adjustedConfidence = chain.confidence;

            // Boost –∑–∞ high severity warnings –≤ —Ü–µ–ø–æ—á–∫–µ
            const highSeverityCount = chainWarnings.filter(w => w.severity === 'high').length;
            if (highSeverityCount >= 2) adjustedConfidence = Math.min(1.0, adjustedConfidence * 1.1);

            // Boost –∑–∞ chronic warnings
            const chronicCount = chainWarnings.filter(w => {
                return trends.allTrends?.[w.type]?.chronic;
            }).length;
            if (chronicCount >= 1) adjustedConfidence = Math.min(1.0, adjustedConfidence * 1.1);

            // Penalty –∑–∞ –Ω–µ–ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ü–µ–ø–æ—á–∫–∏
            if (matchRatio < 1.0) adjustedConfidence *= matchRatio;

            detectedChains.push({
                ...chain,
                matchedNodes,
                matchRatio: Math.round(matchRatio * 100),
                adjustedConfidence: Math.round(adjustedConfidence * 100) / 100,
                warnings: chainWarnings,
                timestamp: new Date().toISOString()
            });
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ adjusted confidence (desc)
        detectedChains.sort((a, b) => b.adjustedConfidence - a.adjustedConfidence);

        console.info(`${LOG_PREFIX} ‚úÖ result`, {
            chainsDetected: detectedChains.length,
            chainIds: detectedChains.map(c => c.chainId),
            topConfidence: detectedChains[0]?.adjustedConfidence || 0
        });

        return detectedChains;
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –¥–ª—è UI
     * @param {object} chain - –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞
     * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
     */
    function formatChainForUI(chain) {
        const arrow = ' ‚Üí ';
        const nodesStr = chain.matchedNodes.join(arrow);
        const confidenceStr = `${Math.round(chain.adjustedConfidence * 100)}%`;

        return {
            title: chain.name,
            path: nodesStr,
            confidence: confidenceStr,
            mechanism: chain.mechanism,
            actions: chain.actionableFix,
            evidenceLevel: chain.evidenceLevel
        };
    }

    // Export API
    HEYS.InsightsPI.causalChains = {
        detect: detectCausalChains,
        formatForUI: formatChainForUI,
        library: CAUSAL_CHAINS_LIBRARY,
        version: '1.0.0'
    };

    console.log('[HEYS.InsightsPI] ‚úÖ Causal Chains Detector v1.0 loaded (6 chain templates)');

})(typeof window !== 'undefined' ? window.HEYS : global.HEYS);


/* ===== insights/pi_early_warning.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Early Warning System v3.2
 * 
 * –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ —Å—Ç–∞–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º–æ–π.
 * 
 * v3.1 improvements:
 * - Pipeline logging standard (`ews /` filter: start/input/compute/result/ui)
 * - Actionable Steps (2-3 concrete actions per warning)
 * - Warning Trends tracking (14/30 days frequency)
 * - Priority Queue (severity √ó frequency √ó impact)
 * 
 * –°—Ü–µ–Ω–∞—Ä–∏–∏:
 * 1. Health Score –ø–∞–¥–∞–µ—Ç 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥
 * 2. –ö—Ä–∏—Ç–∏—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (C1-C22) —É—Ö—É–¥—à–∏–ª—Å—è –Ω–∞ 20%+ –∑–∞ 7 –¥–Ω–µ–π OR –Ω–∏–∑–∫–∏–π score
 * 3. Status Score (0-100) –ø–∞–¥–∞–µ—Ç 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥
 * 4. Sleep debt –Ω–∞–∫–æ–ø–∏–ª—Å—è (3+ –¥–Ω—è <7—á)
 * 5. Caloric debt >1500 kcal 2 –¥–Ω—è –ø–æ–¥—Ä—è–¥
 * + 10 –Ω–æ–≤—ã—Ö checks (v2.0-v3.0): Weight Spike, Hydration, Logging Gap, Protein, Stress, Meal Skip, Binge, Mood, Plateau, Weekend
 * 
 * Dependencies: pi_patterns.js, pi_advanced.js, heys_status_v1.js
 * @param global
 */

(function (global) {
    'use strict';

    console.info('[pi_early_warning.js] üöÄ Script execution started');

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    console.info('[pi_early_warning.js] üîß Initializing module...');

    // Thresholds for warnings
    const THRESHOLDS = {
        HEALTH_SCORE_DECLINE_DAYS: 3,
        HEALTH_SCORE_MIN_DELTA: 10, // minimum total drop over N days (positive = decline)
        STATUS_SCORE_DECLINE_DAYS: 3,
        STATUS_SCORE_MIN_DELTA: 10, // minimum total drop over N days (positive = decline)
        CRITICAL_PATTERN_DEGRADATION: -0.2, // -20%
        SLEEP_DEFICIT_DAYS: 3,
        SLEEP_DEFICIT_HOURS: 7,
        CALORIC_DEBT_DAYS: 2,
        CALORIC_DEBT_THRESHOLD: 1500,
        MIN_DAYS_FOR_ANALYSIS: 6  // Temporarily lowered from 7 for testing
    };

    // Critical patterns (C1-C22) that require immediate attention
    // Based on health impact: inflammation, metabolic health, performance
    const CRITICAL_PATTERNS = [
        // C1-C10: Timing & Behavior
        'meal_timing',          // C1: Meal spacing affects insulin
        'wave_overlap',         // C2: Fat burning windows
        'late_eating',          // C3: Sleep & weight impact
        'meal_quality_trend',   // C4: Diet quality trajectory
        'sleep_weight',         // C5: Recovery & metabolism
        'sleep_hunger',         // C6: Appetite regulation
        'training_kcal',        // C7: Energy balance
        'steps_weight',         // C8: NEAT activity
        'protein_satiety',      // C9: Satiety optimization
        'fiber_regularity',     // C10: Gut transit

        // C11-C22: Nutrition Quality (high health impact)
        'nutrition_quality',    // C15: Overall diet quality score
        'omega_balancer',       // C16: Inflammation control
        'protein_distribution', // C17: Muscle protein synthesis
        'training_type_match',  // C19: Performance optimization
        'hydration',            // C20: Basic physiological need
        'gut_health'            // C14: Microbiome & immunity
    ];

    // Low score thresholds for pattern alerts
    const PATTERN_LOW_SCORE_THRESHOLDS = {
        critical: 35,  // Critical patterns below this = high severity warning
        important: 45  // Important patterns below this = medium severity warning
    };

    // Dual-Mode Architecture (v4.0): Acute vs Full mode checks
    // ACUTE mode: 10 checks for badge (‚â§5 day window, current state alerts)
    //   - Focus: immediate actionable signals, hydration, sleep, weight, stress
    //   - Use case: header badge quick glance (7 days data)
    // FULL mode: all 25 checks for insights dashboard (7-30 day patterns, comprehensive audit)
    //   - Focus: accumulated patterns, nutrition quality, trends
    //   - Use case: insights card deep dive (30 days data)
    const ACUTE_CHECK_IDS = [1, 3, 4, 5, 6, 7, 8, 9, 10, 19];

    // localStorage key for warning trends tracking (v3.1)
    const TRENDS_STORAGE_KEY = 'heys_ews_trends_v1';
    const WEEKLY_PROGRESS_STORAGE_KEY = 'heys_ews_weekly_v1';

    // Trends tracking configuration
    const TRENDS_CONFIG = {
        MAX_AGE_DAYS: 30,        // Keep occurrences for 30 days
        FREQUENCY_WINDOW_14D: 14, // Calculate 14-day frequency
        FREQUENCY_WINDOW_30D: 30, // Calculate 30-day frequency
        TOP_CHRONIC_COUNT: 3     // Show top-3 chronic warnings
    };

    // Weekly progress tracking configuration (Wave 3.1)
    const WEEKLY_CONFIG = {
        WEEKS_TO_TRACK: 4,       // Track last 4 weeks
        IMPROVEMENT_THRESHOLD: -15, // -15% warnings = improving
        STABLE_THRESHOLD: 15,    // ¬±15% warnings = stable
        // > 15% warnings = worsening
    };

    // Cloud sync configuration (Wave 3.1 cloud sync)
    const CLOUD_SYNC_CONFIG = {
        ENABLED: true,           // Enable cloud sync
        LOAD_TIMEOUT_MS: 3000,   // Max wait time for cloud load
        SAVE_TIMEOUT_MS: 5000,   // Max wait time for cloud save
        FALLBACK_TO_LOCAL: true  // Use localStorage if cloud fails
    };



    // Health impact scores for priority calculation (0-100 scale)
    // Based on long-term health consequences and scientific evidence
    const HEALTH_IMPACT_SCORES = {
        // High Impact (80-100): Cardiovascular, metabolic, mental health
        SLEEP_DEBT: 95,              // CVD risk +40-80%, metabolic dysfunction
        STRESS_ACCUMULATION: 90,     // CVD risk +40-80%, burnout
        MOOD_WELLBEING_DECLINE: 85,  // Depression risk +60%, chronic stress
        CALORIC_DEBT: 80,            // Metabolic damage, hormone disruption
        BINGE_RISK: 85,              // Obesity +50%, diabetes +35%, depression +60%

        // Medium-High Impact (60-79): Metabolic health, performance
        HEALTH_SCORE_DECLINE: 75,    // Integrates 50+ metrics, multi-system
        STATUS_SCORE_DECLINE: 70,    // Recovery, adaptation, overtraining
        WEIGHT_SPIKE: 65,            // Rapid weight gain, inflammation
        PROTEIN_DEFICIT: 65,         // Muscle loss, satiety issues
        HYDRATION_DEFICIT: 60,       // Basic physiological function

        // Medium Impact (40-59): Behavior patterns
        MEAL_SKIP_PATTERN: 55,       // Metabolic syndrome +25%
        WEEKEND_PATTERN: 50,         // Binge-restrict cycle risk
        LOGGING_GAP: 45,             // Accountability, awareness

        // Lower Impact (20-39): Weight management
        WEIGHT_PLATEAU: 30,          // Adaptation, not health risk

        // Pattern-specific (varies)
        CRITICAL_PATTERN_DEGRADATION: 70,  // Depends on specific pattern

        // NEW v3.2: Advanced Tier (40-80)
        FIBER_DEFICIT: 70,           // Gut health, metabolic
        SODIUM_EXCESS: 55,           // Water retention, BP
        CIRCADIAN_DISRUPTION: 75,    // Sleep quality, hormones
        TRAINING_WITHOUT_RECOVERY: 80, // Overtraining, injury risk
        FAT_QUALITY_DECLINE: 60,     // Inflammation, omega balance
        SUGAR_DEPENDENCY: 65,        // Insulin resistance
        MICRONUTRIENT_GAP: 70,       // Multiple deficiencies
        STEP_DECLINE: 45,            // NEAT reduction
        MEAL_TIMING_DRIFT: 50,       // Circadian alignment
        ELECTROLYTE_IMBALANCE: 60    // Performance, hydration
    };

    // Severity weights for priority calculation
    const SEVERITY_WEIGHTS = {
        high: 3,
        medium: 2,
        low: 1
    };

    // Human-friendly pattern descriptions (v1.0)
    // –§–æ—Ä–º–∞—Ç: –ø—Ä–æ—Å—Ç–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ + –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ + –Ω–∞—É—á–Ω–∞—è –±–∞–∑–∞
    const PATTERN_HUMAN_MESSAGES = {
        // C1-C10: Timing & Behavior
        'meal_timing': {
            title: '–ü—Ä–æ–º–µ–∂—É—Ç–∫–∏ –º–µ–∂–¥—É –µ–¥–æ–π',
            message: '–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∏–ª–∏ —Ä–µ–¥–∫–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–∞—Ä—É—à–∞—é—Ç –æ–±–º–µ–Ω –≤–µ—â–µ—Å—Ç–≤',
            insight: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã 3-5 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏–Ω—Å—É–ª–∏–Ω–∞ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∂–∏—Ä–∞.',
            science: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —á–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã (–∫–∞–∂–¥—ã–µ 1-2 —á–∞—Å–∞) –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–º—É –∏–Ω—Å—É–ª–∏–Ω—É, —á—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ. –î–ª–∏–Ω–Ω—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ –±–æ–ª–µ–µ 6-7 —á–∞—Å–æ–≤ –≤—ã–∑—ã–≤–∞—é—Ç —á—Ä–µ–∑–º–µ—Ä–Ω—ã–π –≥–æ–ª–æ–¥ –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ.'
        },
        'wave_overlap': {
            title: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –≤–æ–ª–Ω—ã',
            message: '–ù–æ–≤—ã–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –Ω–µ –¥–∞—é—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–º ‚Äî –∂–∏—Ä –Ω–µ —Å–∂–∏–≥–∞–µ—Ç—Å—è',
            insight: '–ú–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏ –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –∏–Ω—Å—É–ª–∏–Ω –≤–µ—Ä–Ω—É–ª—Å—è –∫ –±–∞–∑–æ–≤–æ–º—É —É—Ä–æ–≤–Ω—é –∏ –Ω–∞—á–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∂–∏—Ä–æ–≤ –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏.',
            science: '–ü–æ—Å–ª–µ –µ–¥—ã –∏–Ω—Å—É–ª–∏–Ω –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –Ω–∞ 3-5 —á–∞—Å–æ–≤. –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–Ω—å—à–µ, —á–µ–º –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∞—è ¬´–≤–æ–ª–Ω–∞¬ª, –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –º–µ—Ç–æ–¥–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è.'
        },
        'late_eating': {
            title: '–ü–æ–∑–¥–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏',
            message: '–ï–¥–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –º–µ—à–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –∏ –Ω–∞–±–æ—Ä—É –≤–µ—Å–∞',
            insight: '–ü–æ–∑–¥–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥—ã –∏ –±–æ–ª—å—à–∏–µ –ø–æ—Ä—Ü–∏–∏ –∑–∞ 2-3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞ –Ω–∞—Ä—É—à–∞—é—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –º–µ–ª–∞—Ç–æ–Ω–∏–Ω–∞ –∏ –≥–æ—Ä–º–æ–Ω–∞ —Ä–æ—Å—Ç–∞, —É—Ö—É–¥—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞.',
            science: '–ù–æ—á—å—é –æ—Ä–≥–∞–Ω–∏–∑–º –¥–æ–ª–∂–µ–Ω –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è, –∞ –Ω–µ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞—Ç—å –ø–∏—â—É. –ï–¥–∞ –ø–æ–∑–∂–µ 20:00-21:00 —Å–º–µ—â–∞–µ—Ç —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã, —Å–Ω–∏–∂–∞–µ—Ç —É—Ç—Ä–µ–Ω–Ω—é—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ –Ω–∞–±–æ—Ä–∞ –≤–µ—Å–∞.'
        },
        'meal_quality_trend': {
            title: '–ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è',
            message: '–†–∞—Ü–∏–æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–Ω–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤–∞–∂–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤',
            insight: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤ ‚Äî –∫–ª—é—á –∫ –∑–¥–æ—Ä–æ–≤—å—é –∏ —ç–Ω–µ—Ä–≥–∏–∏.',
            science: '–ú–æ–Ω–æ—Ç–æ–Ω–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –¥–µ—Ñ–∏—Ü–∏—Ç—É –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ (30+ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –Ω–µ–¥–µ–ª—é) —Å–≤—è–∑–∞–Ω–æ —Å –ª—É—á—à–∏–º –∑–¥–æ—Ä–æ–≤—å–µ–º –º–∏–∫—Ä–æ–±–∏–æ–º–∞ –∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞.'
        },
        'sleep_weight': {
            title: '–°–≤—è–∑—å —Å–Ω–∞ –∏ –≤–µ—Å–∞',
            message: '–ù–µ–¥–æ—Å—ã–ø –Ω–∞—Ä—É—à–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–ø–ø–µ—Ç–∏—Ç–∞ –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ',
            insight: '–ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å–Ω–∞ —Ä–∞—Å—Ç—ë—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª –∏ –≥—Ä–µ–ª–∏–Ω (–≥–æ—Ä–º–æ–Ω –≥–æ–ª–æ–¥–∞), –ø–∞–¥–∞–µ—Ç –ª–µ–ø—Ç–∏–Ω (–≥–æ—Ä–º–æ–Ω –Ω–∞—Å—ã—â–µ–Ω–∏—è).',
            science: '–ú–µ—Ç–∞-–∞–Ω–∞–ª–∏–∑—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: —Å–æ–Ω <7 —á–∞—Å–æ–≤ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ –æ–∂–∏—Ä–µ–Ω–∏—è –Ω–∞ 40%. –ù–µ–¥–æ—Å—ã–ø —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ç—è–≥—É –∫ —Å–ª–∞–¥–∫–æ–º—É –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ–º—É, —Å–Ω–∏–∂–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ 5-15%.'
        },
        'sleep_hunger': {
            title: '–°–æ–Ω –∏ –≥–æ–ª–æ–¥',
            message: '–ü–ª–æ—Ö–æ–π —Å–æ–Ω —É—Å–∏–ª–∏–≤–∞–µ—Ç –∞–ø–ø–µ—Ç–∏—Ç –∏ —Ç—è–≥—É –∫ –±—ã—Å—Ç—Ä—ã–º —É–≥–ª–µ–≤–æ–¥–∞–º',
            insight: '–ü–æ—Å–ª–µ –±–µ—Å—Å–æ–Ω–Ω–æ–π –Ω–æ—á–∏ –º–æ–∑–≥ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –≥–ª—é–∫–æ–∑—ã, —á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–∞–ª–æ—Å—Ç—å.',
            science: '–ù–µ–¥–æ—Å—ã–ø –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∑–æ–Ω—ã –º–æ–∑–≥–∞, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –Ω–∞–≥—Ä–∞–¥—É, –∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ –∫–∞–ª–æ—Ä–∏–π–Ω—É—é –ø–∏—â—É. –ì—Ä–µ–ª–∏–Ω (–≥–æ–ª–æ–¥) —Ä–∞—Å—Ç—ë—Ç –Ω–∞ 15-20%, –ª–µ–ø—Ç–∏–Ω (—Å—ã—Ç–æ—Å—Ç—å) –ø–∞–¥–∞–µ—Ç –Ω–∞ 15%.'
        },
        'training_kcal': {
            title: '–ë–∞–ª–∞–Ω—Å: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –µ–¥–∞',
            message: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –µ—Å—Ç—å, –Ω–æ –µ–¥—ã —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî —ç—Ñ—Ñ–µ–∫—Ç —Å–Ω–∏–∂–∞–µ—Ç—Å—è',
            insight: '–î–ª—è —Ä–æ—Å—Ç–∞ –º—ã—à—Ü –Ω—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π, –¥–ª—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç. –í–∞–∂–µ–Ω –±–∞–ª–∞–Ω—Å.',
            science: '–ò–∑–±—ã—Ç–æ—á–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö (>30% –æ—Ç –Ω–æ—Ä–º—ã) –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ –º—ã—à—Ü –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏—é –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞. –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ü–∏—Ç –±–µ–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî –∫ –Ω–∞–±–æ—Ä—É –∂–∏—Ä–∞.'
        },
        'steps_weight': {
            title: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–µ—Å',
            message: '–ú–∞–ª–æ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º —Ç—Ä–∞—Ç–∏—Ç –º–µ–Ω—å—à–µ –∫–∞–ª–æ—Ä–∏–π',
            insight: 'NEAT (Non-Exercise Activity Thermogenesis) ‚Äî —ç—Ç–æ –≤—Å–µ –¥–≤–∏–∂–µ–Ω–∏—è –∫—Ä–æ–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: —Ö–æ–¥—å–±–∞, —Ä–∞–±–æ—Ç–∞ –ø–æ –¥–æ–º—É, —Å—Ç–æ—è–Ω–∏–µ.',
            science: 'NEAT –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –æ—Ç 200 –¥–æ 800 –∫–∫–∞–ª –≤ –¥–µ–Ω—å. –õ—é–¥–∏ —Å —Å–∏–¥—è—á–µ–π —Ä–∞–±–æ—Ç–æ–π —Ç—Ä–∞—Ç—è—Ç –Ω–∞ 30-40% –º–µ–Ω—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏. 10 000 —à–∞–≥–æ–≤ –≤ –¥–µ–Ω—å ‚Äî –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–æ—Ä–º–∞ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è.'
        },
        'protein_satiety': {
            title: '–ë–µ–ª–æ–∫ –∏ —Å—ã—Ç–æ—Å—Ç—å',
            message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–ª–∫–∞ ‚Äî –≥–æ–ª–æ–¥ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ',
            insight: '–ë–µ–ª–æ–∫ –Ω–∞—Å—ã—â–∞–µ—Ç –ª—É—á—à–µ –≤—Å–µ—Ö –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –∏ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º—ã—à—Ü—ã –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π.',
            science: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: –¥–∏–µ—Ç–∞ —Å 25-30% –±–µ–ª–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –Ω–∞ 10-15%. –ë–µ–ª–æ–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑ (–∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ) –Ω–∞ 20-30%.'
        },
        'fiber_regularity': {
            title: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
            message: '–ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ ‚Äî –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ–º –∏ —Å—ã—Ç–æ—Å—Ç—å—é',
            insight: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –ø–∏—Ç–∞–µ—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –±–∞–∫—Ç–µ—Ä–∏–∏, —É–ª—É—á—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∫–∏—à–µ—á–Ω–∏–∫–∞ –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤.',
            science: '–ù–æ—Ä–º–∞ –∫–ª–µ—Ç—á–∞—Ç–∫–∏: 25-35 –≥/–¥–µ–Ω—å. –ö–∞–∂–¥—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ 10 –≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ —Å–Ω–∏–∂–∞—é—Ç —Ä–∏—Å–∫ –¥–∏–∞–±–µ—Ç–∞ 2 —Ç–∏–ø–∞ –Ω–∞ 10%, —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –Ω–∞ 15-20%.'
        },

        // C11-C22: Nutrition Quality
        'nutrition_quality': {
            title: '–û–±—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞',
            message: '–ü–∏—Ç–∞–Ω–∏–µ –Ω–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–ª–µ–∑–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤',
            insight: '–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –±–∞–ª–∞–Ω—Å –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤.',
            science: '–ò–Ω–¥–µ–∫—Å—ã –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∏–µ—Ç—ã (HEI, DASH) –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: —á–µ–º –≤—ã—à–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è, —Ç–µ–º –Ω–∏–∂–µ —Ä–∏—Å–∫ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π, –≤—ã—à–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∂–∏–∑–Ω–∏ –∏ —ç–Ω–µ—Ä–≥–∏—è.'
        },
        'omega_balancer': {
            title: '–ë–∞–ª–∞–Ω—Å –æ–º–µ–≥–∞-3 –∏ –æ–º–µ–≥–∞-6',
            message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–º–µ–≥–∞-6 (—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å–ª–∞) ‚Äî —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ',
            insight: '–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ–º–µ–≥–∞-6 –∫ –æ–º–µ–≥–∞-3: –æ—Ç 1:1 –¥–æ 4:1. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–µ—Ç–∞ –¥–∞—ë—Ç 15:1 –∏ –≤—ã—à–µ.',
            science: '–ò–∑–±—ã—Ç–æ–∫ –æ–º–µ–≥–∞-6 (–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ, –∫—É–∫—É—Ä—É–∑–Ω–æ–µ –º–∞—Å–ª–æ) —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã. –û–º–µ–≥–∞-3 (—Ä—ã–±–∞, –ª—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ) —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–æ. –î–∏—Å–±–∞–ª–∞–Ω—Å —Å–≤—è–∑–∞–Ω —Å –æ–∂–∏—Ä–µ–Ω–∏–µ–º, –¥–∏–∞–±–µ—Ç–æ–º, –±–æ–ª–µ–∑–Ω—è–º–∏ —Å–µ—Ä–¥—Ü–∞.'
        },
        'protein_distribution': {
            title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞',
            message: '–ë–µ–ª–æ–∫ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è',
            insight: '–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à–µ—á–Ω–æ–≥–æ –±–µ–ª–∫–∞ –Ω—É–∂–Ω–æ 20-40 –≥ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–µ–ª–∫–∞ –∫–∞–∂–¥—ã–µ 3-5 —á–∞—Å–æ–≤.',
            science: '–ú–µ—Ö–∞–Ω–∏–∑–º mTOR (—Ä–æ—Å—Ç –º—ã—à—Ü) –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–æ—Ä–æ–≥–æ–≤–æ–π –¥–æ–∑–µ –ª–µ–π—Ü–∏–Ω–∞ (2.5-3 –≥). –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –¥–ª—è –º—ã—à—Ü, —á–µ–º –æ–¥–Ω–∞ –±–æ–ª—å—à–∞—è –ø–æ—Ä—Ü–∏—è.'
        },
        'training_type_match': {
            title: '–ü–∏—Ç–∞–Ω–∏–µ –∏ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
            message: '–ü–∏—Ç–∞–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∏–¥—É –Ω–∞–≥—Ä—É–∑–∫–∏ ‚Äî —ç—Ñ—Ñ–µ–∫—Ç —Å–Ω–∏–∂–∞–µ—Ç—Å—è',
            insight: '–°–∏–ª–æ–≤—ã–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –Ω—É–∂–µ–Ω –±–µ–ª–æ–∫ –∏ —É–≥–ª–µ–≤–æ–¥—ã. –ö–∞—Ä–¥–∏–æ ‚Äî —É–≥–ª–µ–≤–æ–¥—ã –¥–æ –∏ –∂–∏—Ä—ã –ø–æ—Å–ª–µ. –î–ª–∏—Ç–µ–ª—å–Ω–æ–π –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.',
            science: '–ì–ª–∏–∫–æ–≥–µ–Ω (–∑–∞–ø–∞—Å—ë–Ω–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã) ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. 60-90 –º–∏–Ω –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ –∏—Å—Ç–æ—â–∞—é—Ç –∑–∞–ø–∞—Å—ã. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç 1-1.2 –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –Ω–∞ –∫–≥ –≤–µ—Å–∞.'
        },
        'hydration': {
            title: '–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å',
            message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∂–∏–¥–∫–æ—Å—Ç–∏ ‚Äî –ø–∞–¥–∞–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
            insight: '–î–∞–∂–µ –ª—ë–≥–∫–æ–µ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ (1-2% –º–∞—Å—Å—ã —Ç–µ–ª–∞) —Å–Ω–∏–∂–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∏ —É–º—Å—Ç–≤–µ–Ω–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.',
            science: '–ù–æ—Ä–º–∞: 30-40 –º–ª/–∫–≥ –≤–µ—Å–∞. –í–æ–¥–∞ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞, –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –æ–±–º–µ–Ω–∞. –û–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–º–µ–¥–ª—è–µ—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Å—Ç–∞–ª–æ—Å—Ç—å.'
        },
        'gut_health': {
            title: '–ó–¥–æ—Ä–æ–≤—å–µ –∫–∏—à–µ—á–Ω–∏–∫–∞',
            message: '–ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –∏ –±–æ–±–æ–≤—ã—Ö ‚Äî —Å—Ç—Ä–∞–¥–∞–µ—Ç –º–∏–∫—Ä–æ–±–∏–æ–º',
            insight: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –º–∏–∫—Ä–æ–±–∏–æ–º–∞ —Å–≤—è–∑–∞–Ω–æ —Å –∏–º–º—É–Ω–∏—Ç–µ—Ç–æ–º, –≤–µ—Å–æ–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∏ —ç–Ω–µ—Ä–≥–∏–µ–π.',
            science: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (15+ –≥/–¥–µ–Ω—å) –∏ –ø—Ä–µ–±–∏–æ—Ç–∏–∫–∏ –ø–∏—Ç–∞—é—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –±–∞–∫—Ç–µ—Ä–∏–∏. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–≤—è–∑—ã–≤–∞—é—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –º–∏–∫—Ä–æ–±–∏–æ–º–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è, –æ–∂–∏—Ä–µ–Ω–∏—è, –¥–µ–ø—Ä–µ—Å—Å–∏–∏. –í—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤–∞—è –¥–∏–µ—Ç–∞ –±–µ–∑ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –≤—Ä–µ–¥–∏—Ç –±–∞–∫—Ç–µ—Ä–∏—è–º.'
        },

        // Additional patterns (not in C1-C22 but used)
        'added_sugar_dependency': {
            title: '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–∞—Ö–∞—Ä–∞',
            message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ ‚Äî —Å–∫–∞—á–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ç—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É',
            insight: '–ò–∑–±—ã—Ç–æ—á–Ω—ã–π —Å–∞—Ö–∞—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç –ø–µ—á–µ–Ω—å, –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.',
            science: '–í–û–ó —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç <25 –≥ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ –≤ –¥–µ–Ω—å (<5% –∫–∞–ª–æ—Ä–∏–π). –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å —Ä–∏—Å–∫–æ–º –¥–∏–∞–±–µ—Ç–∞, –æ–∂–∏—Ä–µ–Ω–∏—è –ø–µ—á–µ–Ω–∏, —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π. –°–∞—Ö–∞—Ä –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∑–æ–Ω—ã –Ω–∞–≥—Ä–∞–¥—ã –≤ –º–æ–∑–≥–µ, –∫–∞–∫ –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏.'
        }
    };

    /**
     * Human-friendly messages for non-pattern warnings
     * 
     * Structure: { title, message, insight, science }
     * - title: –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (2-5 —Å–ª–æ–≤)
     * - message: friendly –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
     * - insight: –ø–æ–¥—Ä–æ–±–Ω—ã–π —Å–æ–≤–µ—Ç —á—Ç–æ –¥–µ–ª–∞—Ç—å
     *- science: –Ω–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏
     */
    const WARNING_HUMAN_MESSAGES = {
        HEALTH_SCORE_DECLINE: {
            title: '–û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è',
            message: 'Health Score –ø–∞–¥–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî —ç—Ç–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Å–∏–≥–Ω–∞–ª –æ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–º –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ.',
            insight: '–ü–∞–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç 50+ –º–µ—Ç—Ä–∏–∫ –ø–∏—Ç–∞–Ω–∏—è, —Å–Ω–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –Ω–∏–∑–∫–∏–º–∏ scores ‚Äî —Ç–∞–º –ø—Ä–∏—á–∏–Ω–∞.',
            science: 'Health Score –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–∏—Ç–∞–Ω–∏—è (timing, quality, balance), –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å) –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (NEAT, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏). –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è 3+ –¥–Ω—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å, —Ç—Ä–µ–±—É—é—â–∏–π –≤–Ω–∏–º–∞–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å–ª–∞–±—ã–º –∑–æ–Ω–∞–º. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: —Ä–∞–Ω–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤ (–¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤) —É–ª—É—á—à–∞–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ 40-60%.',
            actions: [
                '–û—Ç–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–¥–µ–ª Insights ‚Üí –ü–∞—Ç—Ç–µ—Ä–Ω—ã, –Ω–∞–π–¥–∏—Ç–µ 3 –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º score ‚Äî —ç—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã —Ä–∏—Å–∫–∞',
                '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–Ω –∑–∞ 3 –¥–Ω—è: –µ—Å–ª–∏ <7—á ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –∞ –Ω–µ –Ω–æ–≤—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏',
                '–°—Ä–∞–≤–Ω–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–∏ —Å –Ω–æ—Ä–º–æ–π: –¥–µ—Ñ–∏—Ü–∏—Ç >500 –∫–∫–∞–ª/–¥–µ–Ω—å ‚Äî —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ, –ø—Ä–æ—Ñ–∏—Ü–∏—Ç >300 ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∏—Ç–º–∏–ª—ã'
            ]
        },
        STATUS_SCORE_DECLINE: {
            title: '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–¥–∞–µ—Ç',
            message: 'Status Score —Å–Ω–∏–∂–∞–µ—Ç—Å—è ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –∏ –Ω–µ–¥–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏.',
            insight: 'Status Score (0-100) —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å. –ü–∞–¥–µ–Ω–∏–µ 3+ –¥–Ω—è –æ–∑–Ω–∞—á–∞–µ—Ç: –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö, –∞ –Ω–µ –Ω–æ–≤—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏.',
            science: 'Status Score –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º–∞ —á–µ—Ä–µ–∑ –±–∞–ª–∞–Ω—Å —Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫–æ–π –∏ –ø–∞—Ä–∞—Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º. –•—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ (consecutive decline) —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥–µ—Ñ–∏—Ü–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: HRV –ø–∞–¥–∞–µ—Ç, cortisol —Ä–∞—Å—Ç—ë—Ç, –∏–º–º—É–Ω–∏—Ç–µ—Ç —Å–ª–∞–±–µ–µ—Ç. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç: –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ —É—Å—Ç–∞–ª–æ—Å—Ç–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ –ø–µ—Ä–µ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏, –±–æ–ª–µ–∑–Ω–µ–π, —Ç—Ä–∞–≤–º (J Sports Sci, 2020).',
            actions: [
                '–î–æ–±–∞–≤—å—Ç–µ 1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ',
                '–ü–æ–≤—ã—Å—å—Ç–µ –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 10-15% –Ω–∞ 2-3 –¥–Ω—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ—Ä–º–æ–Ω–æ–≤',
                '–£–¥–µ–ª–∏—Ç–µ –≤—Ä–µ–º—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏: –º–µ–¥–∏—Ç–∞—Ü–∏—è, –ø—Ä–æ–≥—É–ª–∫–∞, —è–Ω—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ 15-20 –º–∏–Ω/–¥–µ–Ω—å'
            ]
        },
        SLEEP_DEBT: {
            title: '–ù–∞–∫–æ–ø–∏–ª—Å—è –Ω–µ–¥–æ—Å—ã–ø',
            message: '–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Å–æ–Ω –º–µ–Ω—å—à–µ 7 —á–∞—Å–æ–≤ ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.',
            insight: 'Sleep debt —Å–Ω–∏–∂–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ 10-15%, —É—Å–∏–ª–∏–≤–∞–µ—Ç –≥–æ–ª–æ–¥ –∏ —Ç—è–≥—É –∫ —Å–ª–∞–¥–∫–æ–º—É, —É—Ö—É–¥—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∏–Ω—Å—É–ª–∏–Ω–∞. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Å–æ–Ω 7-9 —á–∞—Å–æ–≤.',
            science: '–°–æ–Ω <7 —á–∞—Å–æ–≤ 3+ –Ω–æ—á–∏ –ø–æ–¥—Ä—è–¥ –Ω–∞—Ä—É—à–∞–µ—Ç –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: —Ä–∞—Å—Ç—ë—Ç ghrelin (–≥–æ—Ä–º–æ–Ω –≥–æ–ª–æ–¥–∞), –ø–∞–¥–∞–µ—Ç leptin (–≥–æ—Ä–º–æ–Ω —Å—ã—Ç–æ—Å—Ç–∏), —Å–Ω–∏–∂–∞–µ—Ç—Å—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É –Ω–∞ 20-30%. –†–∏—Å–∫ –æ–∂–∏—Ä–µ–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 40%, —Ä–∏—Å–∫ –¥–∏–∞–±–µ—Ç–∞ 2 —Ç–∏–ø–∞ ‚Äî –Ω–∞ 28% (Sleep Medicine Reviews, 2019). –ù–µ–¥–æ—Å—ã–ø 1 –Ω–æ—á–∏ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è 2-3 –Ω–æ—á–∞–º–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Å–Ω–∞; —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π debt —Ç—Ä–µ–±—É–µ—Ç 7-10 –¥–Ω–µ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
            actions: [
                '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—É–¥–∏–ª—å–Ω–∏–∫ –Ω–∞ –æ—Ç–±–æ–π —Å–æ–Ω –∑–∞ 8 —á–∞—Å–æ–≤ –¥–æ –ø–æ–¥—ä—ë–º–∞ (–Ω–µ –Ω–∞ –ø–æ–¥—ä—ë–º!)',
                '–û—Ç–∫–∞–∂–∏—Ç–µ—Å—å –æ—Ç —ç–∫—Ä–∞–Ω–æ–≤ –∑–∞ 1 —á–∞—Å –¥–æ —Å–Ω–∞ (—Å–∏–Ω–∏–π —Å–≤–µ—Ç –ø–æ–¥–∞–≤–ª—è–µ—Ç –º–µ–ª–∞—Ç–æ–Ω–∏–Ω)',
                '–ï—Å–ª–∏ –Ω–µ–¥–æ—Å—ã–ø >3 –¥–Ω–µ–π ‚Äî –¥–æ–±–∞–≤—å—Ç–µ 15-30 –º–∏–Ω –¥–Ω–µ–≤–Ω–æ–≥–æ —Å–Ω–∞ –¥–æ 15:00 —á–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'
            ]
        },
        CALORIC_DEBT: {
            title: '–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π',
            message: '–î–≤–∞ –¥–Ω—è –ø–æ–¥—Ä—è–¥ –Ω–µ–¥–æ–±–æ—Ä –±–æ–ª–µ–µ 1500 –∫–∫–∞–ª ‚Äî —ç—Ç–æ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç, –∑–∞–º–µ–¥–ª—è—é—â–∏–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º.',
            insight: '–†–µ–∑–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º—ç–∫–æ–Ω–æ–º–∏–∏: –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–∞—Å—Ö–æ–¥—É–µ—Ç –º–µ–Ω—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏, —Ç–µ—Ä—è–µ—Ç –º—ã—à—Ü—ã –≤–º–µ—Å—Ç–æ –∂–∏—Ä–∞. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è: 300-500 –∫–∫–∞–ª/–¥–µ–Ω—å.',
            science: '–î–µ—Ñ–∏—Ü–∏—Ç >30% –æ—Ç –Ω–æ—Ä–º—ã (>1500 –∫–∫–∞–ª) –∑–∞–ø—É—Å–∫–∞–µ—Ç adaptive thermogenesis: –±–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –ø–∞–¥–∞–µ—Ç –Ω–∞ 10-15%, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å NEAT —Å–Ω–∏–∂–∞–µ—Ç—Å—è, —Ä–∞—Å—Ç—ë—Ç cortisol (–∫–∞—Ç–∞–±–æ–ª–∏–∑–º –º—ã—à—Ü). –ü–æ—Ç–µ—Ä—è –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã –ø—Ä–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 40-50% –æ—Ç –æ–±—â–µ–π –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ (vs 20-30% –ø—Ä–∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ). –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: –±—ã—Å—Ç—Ä–∞—è –ø–æ—Ç–µ—Ä—è –≤–µ—Å–∞ (>1 –∫–≥/–Ω–µ–¥–µ–ª—é) –≤–µ–¥—ë—Ç –∫ rebound —ç—Ñ—Ñ–µ–∫—Ç—É –≤ 80% —Å–ª—É—á–∞–µ–≤ (Obesity Reviews, 2021).',
            actions: [
                '–ü–æ–≤—ã—Å—å—Ç–µ –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 300-500 –∫–∫–∞–ª/–¥–µ–Ω—å –∑–∞ —Å—á—ë—Ç –ø—Ä–æ—Ç–µ–∏–Ω–∞ –∏ —Å–ª–æ–∂–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤',
                '–î–æ–±–∞–≤—å—Ç–µ 1-2 –ø–µ—Ä–µ–∫—É—Å–∞ –ø–æ 150-200 –∫–∫–∞–ª (–æ—Ä–µ—Ö–∏, –∫–µ—Ñ–∏—Ä, –±–∞–Ω–∞–Ω)',
                '–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ refeed day –∫–∞–∂–¥—ã–µ 7-10 –¥–Ω–µ–π: +10-15% –∫–∫–∞–ª –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞'
            ]
        },
        WEIGHT_SPIKE: {
            title: '–†–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫ –≤–µ—Å–∞',
            message: '–í–µ—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1+ –∫–≥ –∑–∞ 1-2 –¥–Ω—è ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã –∏–ª–∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ.',
            insight: '–ë—ã—Å—Ç—Ä—ã–π –Ω–∞–±–æ—Ä –≤–µ—Å–∞ —á–∞—â–µ –≤—Å–µ–≥–æ —Å–≤—è–∑–∞–Ω —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤–æ–¥—ã (—Å–æ–ª—å, —É–≥–ª–µ–≤–æ–¥—ã, –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª). –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤–æ–¥–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–ª–æ—Ä–∏–∏ –∏ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏.',
            science: '–ù–∞–±–æ—Ä 1 –∫–≥ –∂–∏—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–±—ã—Ç–∫–∞ ~7700 –∫–∫–∞–ª, —á—Ç–æ –Ω–µ—Ä–µ–∞–ª—å–Ω–æ –∑–∞ 1-2 –¥–Ω—è. –ë—ã—Å—Ç—Ä–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Å–∞ –æ–±—ã—á–Ω–æ –≤—ã–∑–≤–∞–Ω–æ –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤–æ–¥—ã: 1 –≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 3-4 –≥ –≤–æ–¥—ã, 1 –≥ –Ω–∞—Ç—Ä–∏—è ‚Äî –¥–æ 200 –º–ª –∂–∏–¥–∫–æ—Å—Ç–∏. –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è (–º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª) –º–æ–≥—É—Ç –¥–æ–±–∞–≤–∏—Ç—å 1-3 –∫–≥ –≤–æ–¥—ã. –û–¥–Ω–∞–∫–æ —á–∞—Å—Ç—ã–µ —Å–∫–∞—á–∫–∏ –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ (binge-restrict cycle) –∏–ª–∏ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–∫–æ—Ä—Ç–∏–∑–æ–ª, –∏–Ω—Å—É–ª–∏–Ω).',
            actions: [
                '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–æ–ª–∏ –∑–∞ 2 –¥–Ω—è: –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ 2000 –º–≥/–¥–µ–Ω—å',
                '–£–≤–µ–ª–∏—á—å—Ç–µ –≤–æ–¥—É –¥–æ 2.5-3 –ª/–¥–µ–Ω—å –¥–ª—è –≤—ã–≤–æ–¥–∞ –∑–∞–¥–µ—Ä–∂–∞–≤—à–µ–π—Å—è –∂–∏–¥–∫–æ—Å—Ç–∏',
                '–ï—Å–ª–∏ —Å–∫–∞—á–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —á–∞—Å—Ç–æ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–æ—Ä–º–æ–Ω—ã (–∫–æ—Ä—Ç–∏–∑–æ–ª, —â–∏—Ç–æ–≤–∏–¥–∫–∞, –∏–Ω—Å—É–ª–∏–Ω)'
            ]
        },
        HYDRATION_DEFICIT: {
            title: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –∂–∏–¥–∫–æ—Å—Ç–∏',
            message: '–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤—ã –ø—å—ë—Ç–µ –º–µ–Ω—å—à–µ 1.5 –ª –≤–æ–¥—ã ‚Äî —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —ç–Ω–µ—Ä–≥–∏—é –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º.',
            insight: '–í–æ–¥–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤, —Ç–µ—Ä–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è, –≤—ã–≤–æ–¥ —Ç–æ–∫—Å–∏–Ω–æ–≤, —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å. –î–∞–∂–µ –ª—ë–≥–∫–æ–µ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ (1-2%) —Å–Ω–∏–∂–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∏ —É–º—Å—Ç–≤–µ–Ω–Ω—É—é –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.',
            science: '–ù–æ—Ä–º–∞: 30-40 –º–ª/–∫–≥ –≤–µ—Å–∞ (–¥–ª—è 70 –∫–≥ ‚Äî 2.1-2.8 –ª). –û–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ 1-2% –º–∞—Å—Å—ã —Ç–µ–ª–∞ —Å–Ω–∏–∂–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –Ω–∞ 10-20%, –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ 10% (European Journal of Clinical Nutrition, 2003). –í–æ–¥–∞ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ª–∏–ø–æ–ª–∏–∑–µ (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–∏): –¥–µ—Ñ–∏—Ü–∏—Ç –∑–∞–º–µ–¥–ª—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ 3-5%. –•—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª, —É—Ö—É–¥—à–∞–µ—Ç —Å–æ–Ω, —É—Å–∏–ª–∏–≤–∞–µ—Ç –≥–æ–ª–æ–¥ (–ø—É—Ç–∞–µ—Ç—Å—è —Å –∂–∞–∂–¥–æ–π).',
            actions: [
                '–ü–æ—Å—Ç–∞–≤—å—Ç–µ –±—É—Ç—ã–ª–∫—É 1.5 –ª –Ω–∞ –≤–∏–¥–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –≤—ã–ø–µ–π—Ç–µ –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è',
                '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–∏—Ç—å –≤–æ–¥—É –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞',
                '–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞–≤—è–Ω–æ–π —á–∞–π, –æ–≥—É—Ä–µ—Ü, –ª–∏–º–æ–Ω –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è'
            ]
        },
        LOGGING_GAP: {
            title: '–ü—Ä–æ–ø—É—Å–∫–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ',
            message: '–í—ã –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏ –ø–∏—Ç–∞–Ω–∏–µ 2+ –¥–Ω—è ‚Äî —Ç–µ—Ä—è–µ—Ç—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å.',
            insight: '–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ ‚Äî –∫–ª—é—á –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º. –ü—Ä–æ–ø—É—Å–∫–∏ –ª–æ–º–∞—é—Ç –ø—Ä–∏–≤—ã—á–∫—É, —Å–Ω–∏–∂–∞—é—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–æ–≤, –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é –∏ –ø–æ—Ç–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.',
            science: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: –ª—é–¥–∏, –≤–µ–¥—É—â–∏–µ food diary –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Ç–µ—Ä—è—é—Ç –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –≤–µ—Å–∞, —á–µ–º —Ç–µ, –∫—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω–æ (American Journal of Preventive Medicine, 2008). Self-monitoring –ø–æ–≤—ã—à–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞ 40-60%, —Å–Ω–∏–∂–∞–µ—Ç –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ –≤—ã–±–æ—Ä—ã. –ü—Ä–æ–ø—É—Å–∫ >2 –¥–Ω–µ–π –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∫ —Å—Ç–∞—Ä—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø–∏—Ç–∞–Ω–∏—è –≤ 70% —Å–ª—É—á–∞–µ–≤ (Obesity, 2017).',
            actions: [
                '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –µ–¥—ã (–ø–æ–∫–∞ –Ω–µ –∑–∞–±—ã–ª–∏)',
                '–ù–∞—á–Ω–∏—Ç–µ —Å —É–ø—Ä–æ—â—ë–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞: —Ñ–æ—Ç–æ –µ–¥—ã + –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏',
                '–°–≤—è–∂–∏—Ç–µ –∑–∞–ø–∏—Å—å —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º: —á–∞—à–∫–∞ –∫–æ—Ñ–µ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞—é HEYS ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞—é –∑–∞–≤—Ç—Ä–∞–∫'
            ]
        },
        PROTEIN_DEFICIT: {
            title: '–î–µ—Ñ–∏—Ü–∏—Ç –±–µ–ª–∫–∞',
            message: '–ù–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–ª–∫–∞ –º–µ–Ω—å—à–µ –Ω–æ—Ä–º—ã ‚Äî —ç—Ç–æ —É–≥—Ä–æ–∂–∞–µ—Ç –º—ã—à—Ü–∞–º –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.',
            insight: '–ë–µ–ª–æ–∫ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π. –ú–∏–Ω–∏–º—É–º 1.2-1.6 –≥/–∫–≥ –≤–µ—Å–∞, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.',
            science: '–ù–æ—Ä–º–∞ –±–µ–ª–∫–∞ –ø—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏: 1.6-2.2 –≥/–∫–≥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—à—Ü (JISSN, 2017). –ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ <1.2 –≥/–∫–≥ √ó 3+ –¥–Ω—è –æ—Ä–≥–∞–Ω–∏–∑–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º—ã—à–µ—á–Ω—ã–π –±–µ–ª–æ–∫ –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ (–≥–ª—é–∫–æ–Ω–µ–æ–≥–µ–Ω–µ–∑). –ü–æ—Ç–µ—Ä—è –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã —Å–Ω–∏–∂–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ 10-50 –∫–∫–∞–ª –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π –∫–≥, —É—Å–∏–ª–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç –π–æ-–π–æ. –ë–µ–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞—Å—ã—â–µ–Ω–∏–µ (thermic effect 20-30% vs 5-10% —É–≥–ª–µ–≤–æ–¥–æ–≤), –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ –≥–æ—Ä–º–æ–Ω–æ–≤ –∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç.',
            actions: [
                '–î–æ–±–∞–≤—å—Ç–µ 20-40 –≥ –ø—Ä–æ—Ç–µ–∏–Ω–∞ –≤ –∫–∞–∂–¥—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (–∫—É—Ä–∏—Ü–∞, —Ä—ã–±–∞, —Ç–≤–æ—Ä–æ–≥, —è–π—Ü–∞)',
                '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã: –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç, –æ—Ä–µ—Ö–∏, –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å',
                '–ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ: —Ç—Ä–µ—Ç—å —Ç–∞—Ä–µ–ª–∫–∏ = –±–µ–ª–æ–∫, —Ç—Ä–µ—Ç—å = –æ–≤–æ—â–∏, —Ç—Ä–µ—Ç—å = —É–≥–ª–µ–≤–æ–¥—ã'
            ]
        },
        STRESS_ACCUMULATION: {
            title: '–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞',
            message: '–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å –±–µ–∑ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî —Ä–∞—Å—Ç—ë—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª, –ø–∞–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.',
            insight: '–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å –Ω–∞—Ä—É—à–∞–µ—Ç –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: –∫–æ—Ä—Ç–∏–∑–æ–ª –±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ, —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ç—è–≥—É –∫ —Å–ª–∞–¥–∫–æ–º—É, —É—Ö—É–¥—à–∞–µ—Ç —Å–æ–Ω –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.',
            science: '–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å –ø–æ–≤—ã—à–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª –Ω–∞ 30-50% –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è. –í—ã—Å–æ–∫–∏–π –∫–æ—Ä—Ç–∏–∑–æ–ª —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –ª–∏–ø–æ–≥–µ–Ω–µ–∑ (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∂–∏—Ä–∞) –≤ –≤–∏—Å—Ü–µ—Ä–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏, —É—Å–∏–ª–∏–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –ø–æ–¥–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω/—ç—Å—Ç—Ä–æ–≥–µ–Ω, —É—Ö—É–¥—à–∞–µ—Ç quality —Å–Ω–∞ (Psychoneuroendocrinology, 2019). –°—Ç—Ä–µ—Å—Å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç reward pathways ‚Äî —Ç—è–≥–∞ –∫ comfort food (—Å–∞—Ö–∞—Ä, –∂–∏—Ä—ã). –î–µ—Ñ–∏—Ü–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è >3 –¥–Ω–µ–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ –ø–µ—Ä–µ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏, —Å–Ω–∏–∂–∞–µ—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç –Ω–∞ 20-40% (J Sports Sci, 2020).',
            actions: [
                '–í–Ω–µ–¥—Ä–∏—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏: –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –ø—Ä–æ–≥—É–ª–∫–∞, –π–æ–≥–∞ (15-30 –º–∏–Ω)',
                '–°–Ω–∏–∑—å—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ 20-30% –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ 1 –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞',
                '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–Ω: —Å—Ç—Ä–µ—Å—Å —á–∞—Å—Ç–æ –∏–¥—ë—Ç —Ä—É–∫–∞ –æ–± —Ä—É–∫—É —Å –Ω–µ–¥–æ—Å—ã–ø–æ–º ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ 7-9 —á–∞—Å–æ–≤'
            ]
        },
        MEAL_SKIP_PATTERN: {
            title: '–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∏ –µ–¥—ã',
            message: '–í—ã —á–∞—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ ‚Äî —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—é –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.',
            insight: '–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –±–µ–∑ –µ–¥—ã (>6-8 —á–∞—Å–æ–≤) –≤—ã–∑—ã–≤–∞—é—Ç —á—Ä–µ–∑–º–µ—Ä–Ω—ã–π –≥–æ–ª–æ–¥, –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ, —Å–∫–∞—á–∫–∏ –∏–Ω—Å—É–ª–∏–Ω–∞. –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—ë–º–æ–≤.',
            science: '–ü—Ä–æ–ø—É—Å–∫ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ —Å–Ω–∏–∂–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫—É—é –≥–∏–±–∫–æ—Å—Ç—å, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ–¥. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–Ω–¥—Ä–æ–º–∞ –Ω–∞ 25%, —É—Ö—É–¥—à–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å (Proc Nutr Soc, 2016). –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤—ã (>8—á) —Å—Ç–∏–º—É–ª–∏—Ä—É—é—Ç –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ (+20-40% –∫–∞–ª–æ—Ä–∏–π –∑–∞ —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º), –Ω–∞—Ä—É—à–∞—é—Ç —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞. –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≤—Ç—Ä–∞–∫–∞ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å +5-8% –º–∞—Å—Å—ã —Ç–µ–ª–∞ –∑–∞ –≥–æ–¥.',
            actions: [
                '–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ 3-4 –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –∫–∞–∂–¥—ã–µ 3-5 —á–∞—Å–æ–≤ –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è',
                '–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã –∑–∞—Ä–∞–Ω–µ–µ: –æ—Ä–µ—Ö–∏, —Ñ—Ä—É–∫—Ç—ã, –π–æ–≥—É—Ä—Ç ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π',
                '–ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç–µ –∑–∞–≤—Ç—Ä–∞–∫/–æ–±–µ–¥ –∏–∑-–∑–∞ —Ä–∞–±–æ—Ç—ã ‚Äî —Å—Ç–∞–≤—å—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞'
            ]
        },
        BINGE_RISK: {
            title: '–†–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è',
            message: '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–∏–∑–Ω–∞–∫–∏ binge eating: –±–æ–ª—å—à–∏–µ –ø–æ—Ä—Ü–∏–∏ –ø–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Ä—ã–≤–æ–≤.',
            insight: 'Binge-restrict —Ü–∏–∫–ª —Ä–∞–∑—Ä—É—à–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ. –ö–ª—é—á ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –¥—Ä–æ–±–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –±–µ–∑ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.',
            science: 'Binge Eating Disorder (BED) —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è —ç–ø–∏–∑–æ–¥–∞–º–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∏—â–∏ (>2000 –∫–∫–∞–ª –∑–∞ 2 —á–∞—Å–∞) —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —á—É–≤—Å—Ç–≤–æ–º –≤–∏–Ω—ã. –§–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤—ã (>8—á), –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π (>30%), –¥–µ—Ñ–∏—Ü–∏—Ç —Å–Ω–∞. –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ: —Å—Ç—Ä–µ—Å—Å, –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å–Ω—ã–π mindset. BED –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ –æ–∂–∏—Ä–µ–Ω–∏—è –Ω–∞ 50%, –¥–∏–∞–±–µ—Ç–∞ –Ω–∞ 35%, –¥–µ–ø—Ä–µ—Å—Å–∏–∏ –Ω–∞ 60% (Int J Eat Disord, 2018). –õ–µ—á–µ–Ω–∏–µ: –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è + —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –±–µ–∑ –∑–∞–ø—Ä–µ—Ç–æ–≤.',
            actions: [
                '–£–≤–µ–ª–∏—á—å—Ç–µ —Å—É—Ç–æ—á–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –Ω–∞ 200-300 –∫–∫–∞–ª, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ –≤—Å–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏',
                '–£–±–µ—Ä–∏—Ç–µ –∑–∞–ø—Ä–µ—Ç—ã: —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –ª—é–±–∏–º—É—é –µ–¥—É 1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –Ω–µ–±–æ–ª—å—à–∏–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏ (200-300 –∫–∫–∞–ª)',
                '–ï—Å–ª–∏ —á—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã –ø–æ—Å–ª–µ –µ–¥—ã –∏–ª–∏ –∫–æ–º–ø—É–ª—å—Å–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø—Å–∏—Ö–æ–ª–æ–≥–∞ –ö–ü–¢'
            ]
        },
        MOOD_WELLBEING_DECLINE: {
            title: '–ü–∞–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è',
            message: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ —Å–Ω–∏–∂–∞—é—Ç—Å—è 7+ –¥–Ω–µ–π ‚Äî —Å–∏–≥–Ω–∞–ª burnout –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏.',
            insight: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ —ç–Ω–µ—Ä–≥–∏–∏ —á–∞—Å—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π, –Ω–µ–¥–æ—Å—ã–ø–æ–º, –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º –ø–∏—Ç–∞–Ω–∏—è –∏–ª–∏ —Å—Ç—Ä–µ—Å—Å–æ–º. –í–Ω–∏–º–∞–Ω–∏–µ: –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Å–∏–≥–Ω–∞–ª—ã —Ç–µ–ª–∞.',
            science: 'Mood –∏ wellbeing —Å–∫–æ—Ä—ã –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç —Å —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω–æ–º, –¥–æ—Ñ–∞–º–∏–Ω–æ–º, HRV, —É—Ä–æ–≤–Ω–µ–º –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è. –°–Ω–∏–∂–µ–Ω–∏–µ 7+ –¥–Ω–µ–π –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞: 1) —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å (–∫–æ—Ä—Ç–∏–∑–æ–ª –ø–æ–¥–∞–≤–ª—è–µ—Ç —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω), 2) –¥–µ—Ñ–∏—Ü–∏—Ç —Å–Ω–∞ (<7—á —Å–Ω–∏–∂–∞–µ—Ç —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω –Ω–∞ 20%), 3) –≥–∏–ø–æ–≥–ª–∏–∫–µ–º–∏—è (–¥–µ—Ñ–∏—Ü–∏—Ç —É–≥–ª–µ–≤–æ–¥–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω), 4) –¥–µ—Ñ–∏—Ü–∏—Ç –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (B12, –º–∞–≥–Ω–∏–π, omega-3). –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: low mood –≤ —Ç–µ—á–µ–Ω–∏–µ 2+ –Ω–µ–¥–µ–ª—å ‚Äî –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–µ–ø—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞ (DSM-5). Burnout —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –Ω–∞ 40-80% (J Psychosom Res, 2020).',
            actions: [
                '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–Ω (7-9—á) + —Å—Ç—Ä–µ—Å—Å (–ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏ 15-20 –º–∏–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω–æ)',
                '–î–æ–±–∞–≤—å—Ç–µ 30 –º–∏–Ω –ø—Ä–æ–≥—É–ª–∫–∏ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ –ø—Ä–∏ –¥–Ω–µ–≤–Ω–æ–º —Å–≤–µ—Ç–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å',
                '–ï—Å–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è >14 –¥–Ω–µ–π ‚Äî –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É (–¥–µ–ø—Ä–µ—Å—Å–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏)'
            ]
        },
        WEIGHT_PLATEAU: {
            title: '–ü–ª–∞—Ç–æ –≤–µ—Å–∞',
            message: '–í–µ—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è 14+ –¥–Ω–µ–π –ø—Ä–∏ —Ü–µ–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏—è ‚Äî —Ç–µ–ª–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å.',
            insight: '–ü–ª–∞—Ç–æ ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞ –ø–æ—Ö—É–¥–µ–Ω–∏—è. –û—Ä–≥–∞–Ω–∏–∑–º —Å–Ω–∏–∑–∏–ª –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ NEAT. –†–µ—à–µ–Ω–∏–µ: refeed day (+10-15% –∫–∞–ª–æ—Ä–∏–π), –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–µ–π.',
            science: '–ü–ª–∞—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ metabolic adaptation: –±–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –ø–∞–¥–∞–µ—Ç –Ω–∞ 10-25% –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ, NEAT —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 15-30%, –ª–µ–ø—Ç–∏–Ω –ø–∞–¥–∞–µ—Ç, ghrelin —Ä–∞—Å—Ç—ë—Ç. –ü–ª–∞—Ç–æ 14+ –¥–Ω–µ–π ‚Äî —Å–∏–≥–Ω–∞–ª –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é. –†–µ—à–µ–Ω–∏—è: 1) Refeed day –∫–∞–∂–¥—ã–µ 7-10 –¥–Ω–µ–π –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–µ–ø—Ç–∏–Ω/–≥–æ—Ä–º–æ–Ω—ã, 2) Diet break (2 –Ω–µ–¥–µ–ª–∏ –Ω–∞ maintenance) –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º, 3) –£–≤–µ–ª–∏—á–µ–Ω–∏–µ NEAT/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (Int J Obes, 2019).',
            actions: [
                '–£—Å—Ç—Ä–æ–π—Ç–µ refeed day: +10-15% –∫–∞–ª–æ—Ä–∏–π —á–µ—Ä–µ–∑ —É–≥–ª–µ–≤–æ–¥—ã (300-500 –∫–∫–∞–ª) –Ω–∞ 1 –¥–µ–Ω—å',
                '–ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ –Ω–æ—Ä–º—É –∫–∞–ª–æ—Ä–∏–π: –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –≤–µ—Å –≤ –ø—Ä–æ—Ñ–∏–ª—å, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π target',
                '–£–≤–µ–ª–∏—á—å—Ç–µ NEAT: –ø–∞—Ä–∫—É–π—Ç–µ—Å—å –¥–∞–ª—å—à–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ—Å—Ç–Ω–∏—Ü—É, –≥—É–ª—è–π—Ç–µ –Ω–∞ —Å–æ–∑–≤–æ–Ω–∞—Ö (+200-400 –∫–∫–∞–ª/–¥–µ–Ω—å)'
            ]
        },
        WEEKEND_PATTERN: {
            title: '–í—ã—Ö–æ–¥–Ω—ã–µ —Å—Ä—ã–≤—ã',
            message: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–∏—Ç–∞–Ω–∏—è –≤ –°–±/–í—Å —Ö—É–∂–µ, —á–µ–º –≤ –±—É–¥–Ω–∏ ‚Äî –∞–ª–∫–æ–≥–æ–ª—å, —É–≥–ª–µ–≤–æ–¥—ã, —á–∏—Ç–º–∏–ª—ã —Å–±–∏–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å.',
            insight: '–í—ã—Ö–æ–¥–Ω—ã–µ —Å—Ä—ã–≤—ã +1500 –∫–∫–∞–ª –º–æ–≥—É—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç 5 –±—É–¥–Ω–∏—Ö –¥–Ω–µ–π. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –≥–∏–±–∫–∞—è –¥–∏–µ—Ç–∞ (80/20), –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ refeed –¥–Ω–µ–π, –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–ª–∫–æ–≥–æ–ª—è.',
            science: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –Ω–∞ 15-20% –≤—ã—à–µ, —á–µ–º –≤ –±—É–¥–Ω–∏, –∞–ª–∫–æ–≥–æ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç 300-800 –∫–∫–∞–ª (Obesity, 2008). Weekend warrior pattern ‚Äî –æ—á–µ–Ω—å —Å—Ç—Ä–æ–≥–æ –ü–Ω-–ü—Ç, –æ—Ç–∫–∞–∑ –°–±-–í—Å ‚Äî –≤–µ–¥—ë—Ç –∫ binge-restrict cycle. –ê–ª–∫–æ–≥–æ–ª—å –±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –Ω–∞ 12-36 —á–∞—Å–æ–≤, —É—Ö—É–¥—à–∞–µ—Ç —Å–æ–Ω, —Å–Ω–∏–∂–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ –±–µ–ª–∫–∞ –Ω–∞ 20-30%. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –≤–∫–ª—é—á–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ –≤ –Ω–µ–¥–µ–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (calorie cycling), –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞—Ä–∞–Ω–µ–µ (Nutr J, 2017).',
            actions: [
                '–í–∫–ª—é—á–∏—Ç–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –≤ –Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω: calorie cycling 80/20 (5 –¥–Ω–µ–π –¥–µ—Ñ–∏—Ü–∏—Ç, 2 –¥–Ω—è maintenance)',
                '–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∞–ª–∫–æ–≥–æ–ª—å –¥–æ 1-2 –ø–æ—Ä—Ü–∏–π: –≤–∏–Ω–æ 150 –º–ª –∏–ª–∏ –ø–∏–≤–æ 330 –º–ª (–±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –Ω–∞ 12-36—á)',
                '–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞—Ä–∞–Ω–µ–µ: —Å–æ—Å—Ç–∞–≤—å—Ç–µ menu –Ω–∞ –°–±-–í—Å –≤ –ø—è—Ç–Ω–∏—Ü—É –≤–µ—á–µ—Ä–æ–º'
            ]
        },

        // NEW v3.2: Advanced Warnings
        FIBER_DEFICIT: {
            title: '–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–ª–µ—Ç—á–∞—Ç–∫–∏',
            message: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ 5+ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî —Ä–∏—Å–∫ –¥–ª—è –∫–∏—à–µ—á–Ω–∏–∫–∞ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞',
            insight: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –º–∏–∫—Ä–æ–±–∏–æ–º–∞, –Ω–∞—Å—ã—â–µ–Ω–∏—è –∏ —Ä–µ–≥—É–ª—è—Ü–∏–∏ —Å–∞—Ö–∞—Ä–∞ –∫—Ä–æ–≤–∏. –î–µ—Ñ–∏—Ü–∏—Ç (<15–≥/–¥–µ–Ω—å) –≤–µ–¥—ë—Ç –∫ –¥–∏—Å–±–∏–æ–∑—É, –∑–∞–ø–æ—Ä–∞–º, –ø–æ–≤—ã—à–µ–Ω–Ω–æ–º—É –∞–ø–ø–µ—Ç–∏—Ç—É.',
            science: 'Fiber ‚Äî prebiotic –¥–ª—è –º–∏–∫—Ä–æ–±–∏–æ–º–∞: –Ω–æ—Ä–º–∞ 25-35 –≥/–¥–µ–Ω—å (WHO). –î–µ—Ñ–∏—Ü–∏—Ç (<15 –≥) —Å–Ω–∏–∂–∞–µ—Ç SCFA production (–º–∞—Å–ª—è–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞ ‚Äî –ø–∏—Ç–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ—Ü–∏—Ç–æ–≤), —É—Ö—É–¥—à–∞–µ—Ç GLP-1 —Å–µ–∫—Ä–µ—Ü–∏—é (–≥–æ—Ä–º–æ–Ω –Ω–∞—Å—ã—â–µ–Ω–∏—è), –ø–æ–≤—ã—à–∞–µ—Ç spike –≥–ª—é–∫–æ–∑—ã –ø–æ—Å–ª–µ –µ–¥—ã. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ NHANES: —Å–≤—è–∑—å <15 –≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ —Å +40% —Ä–∏—Å–∫–æ–º obesity, +25% CVD (Nutrients, 2020). –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ (5 –≥/–Ω–µ–¥) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–∞–∑–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.',
            actions: [
                '–î–æ–±–∞–≤—å—Ç–µ 5-10–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏: 1 —è–±–ª–æ–∫–æ (4–≥) + 30–≥ –æ–≤—Å—è–Ω–∫–∏ (3–≥) + 100–≥ –±—Ä–æ–∫–∫–æ–ª–∏ (3–≥)',
                '–í–∫–ª—é—á–∏—Ç–µ –±–æ–±–æ–≤—ã–µ/—á–µ—á–µ–≤–∏—Ü—É 3-4 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é (8-10–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –Ω–∞ –ø–æ—Ä—Ü–∏—é)',
                '–ó–∞–º–µ–Ω–∏—Ç–µ –±–µ–ª—ã–π —Ä–∏—Å –Ω–∞ –±—É—Ä—ã–π/–∫–∏–Ω–æ–∞ (+2-3–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –Ω–∞ –ø–æ—Ä—Ü–∏—é)'
            ]
        },

        SODIUM_EXCESS: {
            title: '–ò–∑–±—ã—Ç–æ–∫ –Ω–∞—Ç—Ä–∏—è',
            message: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–æ–ª–∏ >4000 –º–≥ 3+ –¥–Ω—è –ø–æ–¥—Ä—è–¥ ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã, –ª–æ–∂–Ω—ã–π –≤–µ—Å, —Ä–∏—Å–∫ –¥–ª—è –¥–∞–≤–ª–µ–Ω–∏—è',
            insight: '–ò–∑–±—ã—Ç–æ–∫ –Ω–∞—Ç—Ä–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É 1-3 –∫–≥ –≤–æ–¥—ã, –º–∞—Å–∫–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤–µ—Å—É/–∂–∏—Ä—É. –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏ –≤—ã—Å–æ–∫–∏–π –Ω–∞—Ç—Ä–∏–π (>3500 –º–≥) –ø–æ–≤—ã—à–∞–µ—Ç –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ.',
            science: '–ù–æ—Ä–º–∞ –Ω–∞—Ç—Ä–∏—è: 1500-2300 –º–≥/–¥–µ–Ω—å (AHA). –ö–∞–∂–¥—ã–π 1 –≥ –∏–∑–±—ã—Ç–∫–∞ –Ω–∞—Ç—Ä–∏—è –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ~400 –º–ª –≤–æ–¥—ã —á–µ—Ä–µ–∑ ADH/aldosterone –º–µ—Ö–∞–Ω–∏–∑–º. –í—ã—Å–æ–∫–∏–π –Ω–∞—Ç—Ä–∏–π (>4000 –º–≥/–¥–µ–Ω—å) –ø–æ–≤—ã—à–∞–µ—Ç systolic BP –Ω–∞ 5-8 mmHg —É —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ª—é–¥–µ–π (Hypertension, 2018). Water retention –º–∞—Å–∫–∏—Ä—É–µ—Ç fat loss: –≤–µ—Å —Å—Ç–æ–∏—Ç, –Ω–æ –∂–∏—Ä —É—Ö–æ–¥–∏—Ç. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: —Å–Ω–∏–∑–∏—Ç—å processed foods (70% –Ω–∞—Ç—Ä–∏—è), —É–≤–µ–ª–∏—á–∏—Ç—å –∫–∞–ª–∏–π (–æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã) ‚Äî K/Na ratio –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è BP.',
            actions: [
                '–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ processed foods: –∫–æ–ª–±–∞—Å—ã, —Å—ã—Ä, —Å–æ—É—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç 500-1200 –º–≥ –Ω–∞—Ç—Ä–∏—è –Ω–∞ –ø–æ—Ä—Ü–∏—é',
                '–£–≤–µ–ª–∏—á—å—Ç–µ –∫–∞–ª–∏–π –¥–æ 3500 –º–≥/–¥–µ–Ω—å: –±–∞–Ω–∞–Ω—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –∞–≤–æ–∫–∞–¥–æ (K/Na balance –¥–ª—è –¥–∞–≤–ª–µ–Ω–∏—è)',
                '–ì–æ—Ç–æ–≤—å—Ç–µ –¥–æ–º–∞ –±–µ–∑ —Å–æ–ª–∏: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∏/—Ç—Ä–∞–≤—ã –¥–ª—è –≤–∫—É—Å–∞'
            ]
        },

        CIRCADIAN_DISRUPTION: {
            title: '–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ü–∏—Ä–∫–∞–¥–Ω—ã—Ö —Ä–∏—Ç–º–æ–≤',
            message: '–ü–æ–∑–¥–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ (–ø–æ—Å–ª–µ 22:00) –∏–ª–∏ –±–æ–ª—å—à–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞ –Ω–∞—Ä—É—à–∞—é—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
            insight: '–¶–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç insulin sensitivity, cortisol, GHOST production. –ù–∞—Ä—É—à–µ–Ω–∏—è —Å–Ω–∏–∂–∞—é—Ç fat burning, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞, –ø–æ–≤—ã—à–∞—é—Ç –∞–ø–ø–µ—Ç–∏—Ç.',
            science: 'Peripheral clocks (–ø–µ—á–µ–Ω—å, –∂–∏—Ä–æ–≤–∞—è —Ç–∫–∞–Ω—å, –º—ã—à—Ü—ã) —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å –µ–¥–æ–π. –ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω (–ø–æ—Å–ª–µ 22:00) —Å–Ω–∏–∂–∞–µ—Ç insulin sensitivity –Ω–∞ 20-35% vs –¥–Ω–µ–≤–Ω–æ–π –ø—Ä–∏—ë–º (Obesity, 2019). Sleep timing variance >2h –º–µ–∂–¥—É –¥–Ω—è–º–∏ –Ω–∞—Ä—É—à–∞–µ—Ç cortisol rhythm (—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–∏–∫ –≤–∞–∂–µ–Ω –¥–ª—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è), —Å–Ω–∏–∂–∞–µ—Ç GHOST secretion –Ω–∞ 15-30%. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: eating within 10-hour window (14:00-22:00) vs –ø–æ–∑–¥–Ω–∏–µ –ø–µ—Ä–µ–∫—É—Å—ã ‚Äî +5% fat loss –ø—Ä–∏ —Ç–æ–π –∂–µ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ (Cell Metab, 2021).',
            actions: [
                '–ó–∞–∫–æ–Ω—á–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏ –¥–æ 21:00 (–º–∏–Ω–∏–º—É–º –∑–∞ 2—á –¥–æ —Å–Ω–∞)',
                '–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É: –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å <1—á –º–µ–∂–¥—É –¥–Ω—è–º–∏',
                '–ï—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–¥–Ω–æ ‚Äî –ª—ë–≥–∫–∏–π —É–∂–∏–Ω –ø–æ—Å–ª–µ (–±–µ–ª–æ–∫ + –æ–≤–æ—â–∏, –±–µ–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤)'
            ]
        },

        TRAINING_WITHOUT_RECOVERY: {
            title: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
            message: '3+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ 5 –¥–Ω–µ–π –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º —Å–Ω–µ (<6.5—á) –∏–ª–∏ –≤—ã—Å–æ–∫–æ–º —Å—Ç—Ä–µ—Å—Å–µ ‚Äî —Ä–∏—Å–∫ overtraining',
            insight: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–æ–Ω, –ø–∏—Ç–∞–Ω–∏–µ, –Ω–∏–∑–∫–∏–π —Å—Ç—Ä–µ—Å—Å) –≤–µ–¥—É—Ç –∫ overreaching: —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–∏–ª—ã, –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞, —Ä–æ—Å—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª–∞, —Ç—Ä–∞–≤–º—ã.',
            science: 'Recovery triangle: —Å–æ–Ω (7-9—á), –ø–∏—Ç–∞–Ω–∏–µ (–±–µ–ª–æ–∫ 1.6-2.2 –≥/–∫–≥, —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è –≥–ª–∏–∫–æ–≥–µ–Ω–∞), low stress (cortisol <7). –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö (3+/–Ω–µ–¥–µ–ª—é) –≤–µ–¥—ë—Ç –∫ sympathetic dominance (HRV —Å–Ω–∏–∂–∞–µ—Ç—Å—è), –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ injury –Ω–∞ 40-60% (Br J Sports Med, 2016). Sleep <6.5h –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å–Ω–∏–∂–∞–µ—Ç MPS (muscle protein synthesis) –Ω–∞ 18%, —É—Ö—É–¥—à–∞–µ—Ç glycogen replenishment. Stress >7 –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö ‚Äî cortisol –±–ª–æ–∫–∏—Ä—É–µ—Ç testosterone, –∑–∞–º–µ–¥–ª—è–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏—é.',
            actions: [
                '–£–≤–µ–ª–∏—á—å—Ç–µ —Å–æ–Ω –¥–æ 7-8 —á–∞—Å–æ–≤: –µ—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç–µ—Å—å 3+ —Ä–∞–∑/–Ω–µ–¥–µ–ª—é, —Å–æ–Ω ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1',
                '–î–æ–±–∞–≤—å—Ç–µ 1 –¥–µ–Ω—å –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –º–µ–∂–¥—É –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏',
                '–°–Ω–∏–∑—å—Ç–µ —Å—Ç—Ä–µ—Å—Å: meditation 10 –º–∏–Ω/–¥–µ–Ω—å, –ø—Ä–æ–≥—É–ª–∫–∞ 20 –º–∏–Ω (—Å–Ω–∏–∂–∞–µ—Ç cortisol –Ω–∞ 15-25%)'
            ]
        },

        FAT_QUALITY_DECLINE: {
            title: '–°–Ω–∏–∂–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∂–∏—Ä–æ–≤',
            message: 'Omega Balancer score <40 –≤ —Ç–µ—á–µ–Ω–∏–µ 7+ –¥–Ω–µ–π ‚Äî –¥–∏—Å–±–∞–ª–∞–Ω—Å –æ–º–µ–≥–∞-3/–æ–º–µ–≥–∞-6, –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ',
            insight: '–ö–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤ (omega-3 vs omega-6, –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ vs –Ω–µ–Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ) –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ, insulin sensitivity, —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ.',
            science: 'Optimal omega-6/omega-3 ratio: 4:1 to 1:1 (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–µ—Ç–∞: 15:1 ‚Äî proinflammatory). Omega-3 (EPA/DHA): —Å–Ω–∏–∂–∞—é—Ç TNF-alpha, IL-6 (–º–∞—Ä–∫–µ—Ä—ã –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è), —É–ª—É—á—à–∞—é—Ç insulin sensitivity –Ω–∞ 10-20% (Lipids, 2018). –ò–∑–±—ã—Ç–æ–∫ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã—Ö –∂–∏—Ä–æ–≤ (>10% –∫–∞–ª–æ—Ä–∏–π) –ø—Ä–∏ –Ω–∏–∑–∫–æ–º omega-3 –ø–æ–≤—ã—à–∞–µ—Ç LDL oxidation, endothelial dysfunction. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –∂–∏—Ä–Ω–∞—è —Ä—ã–±–∞ 2-3 —Ä–∞–∑–∞/–Ω–µ–¥–µ–ª—é (salmon, sardines), –ª—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ, –≥—Ä–µ—Ü–∫–∏–µ –æ—Ä–µ—Ö–∏; –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å processed oils (–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ, –∫—É–∫—É—Ä—É–∑–Ω–æ–µ ‚Äî –≤—ã—Å–æ–∫–∏–π omega-6).',
            actions: [
                '–î–æ–±–∞–≤—å—Ç–µ –∂–∏—Ä–Ω—É—é —Ä—ã–±—É 2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é: –ª–æ—Å–æ—Å—å, —Å–∞—Ä–¥–∏–Ω—ã, —Å–∫—É–º–±—Ä–∏—è (EPA+DHA 1-2–≥)',
                '–ó–∞–º–µ–Ω–∏—Ç–µ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å–ª–∞ –Ω–∞ –æ–ª–∏–≤–∫–æ–≤–æ–µ/–ª—å–Ω—è–Ω–æ–µ (–≤—ã—à–µ omega-3)',
                '–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ processed foods —Å trans fats: –º–∞—Ä–≥–∞—Ä–∏–Ω, –≤—ã–ø–µ—á–∫–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è'
            ]
        },

        SUGAR_DEPENDENCY: {
            title: '–°–∞—Ö–∞—Ä–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å',
            message: 'Added Sugar Dependency score <35 –≤ —Ç–µ—á–µ–Ω–∏–µ 7+ –¥–Ω–µ–π ‚Äî —á–∞—Å—Ç—ã–µ —Å–ø–∞–π–∫–∏ –≥–ª—é–∫–æ–∑—ã, cravings',
            insight: '–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä (>50 –≥/–¥–µ–Ω—å) —Å–æ–∑–¥–∞—ë—Ç dopamine-driven cravings, insulin spikes, accumulation –∂–∏—Ä–∞ –≤ –ø–µ—á–µ–Ω–∏ (NAFLD).',
            science: '–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä: –Ω–æ—Ä–º–∞ <25-50 –≥/–¥–µ–Ω—å (WHO: <10% –∫–∞–ª–æ—Ä–∏–π). –ò–∑–±—ã—Ç–æ–∫ (>50 –≥) –ø–æ–≤—ã—à–∞–µ—Ç fructose –≤ –ø–µ—á–µ–Ω—å ‚Üí de novo lipogenesis (—Å–∏–Ω—Ç–µ–∑ –∂–∏—Ä–æ–≤), insulin resistance –≤ –ø–µ—á–µ–Ω–∏, visceral fat accumulation. Frequent sugar spikes –ø–æ–¥–∞–≤–ª—è—é—Ç leptin sensitivity (–≥–æ—Ä–º–æ–Ω –Ω–∞—Å—ã—â–µ–Ω–∏—è), —É—Å–∏–ª–∏–≤–∞—é—Ç dopamine cravings (–∫–∞–∫ addiction pattern). –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: —Å–Ω–∏–∂–µ–Ω–∏–µ added sugar —Å 100–≥ –¥–æ 25–≥/–¥–µ–Ω—å ‚Äî -4% –≤–∏—Å—Ü–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∂–∏—Ä–∞ –∑–∞ 8 –Ω–µ–¥–µ–ª—å –ø—Ä–∏ —Ç–æ–π –∂–µ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ (Hepatology, 2020).',
            actions: [
                '–°–Ω–∏–∑—å—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä –¥–æ <30–≥/–¥–µ–Ω—å: –∏—Å–∫–ª—é—á–∏—Ç–µ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏, —Å–æ–∫–∏ (30-40–≥ –Ω–∞ —Å—Ç–∞–∫–∞–Ω)',
                '–ó–∞–º–µ–Ω–∏—Ç–µ –¥–µ—Å–µ—Ä—Ç—ã –Ω–∞ —Ñ—Ä—É–∫—Ç—ã: 1-2 –ø–æ—Ä—Ü–∏–∏/–¥–µ–Ω—å (fructose –≤ —Ñ—Ä—É–∫—Ç–∞—Ö —Å –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π –±–µ–∑–æ–ø–∞—Å–µ–Ω)',
                '–ß–∏—Ç–∞–π—Ç–µ —ç—Ç–∏–∫–µ—Ç–∫–∏: added sugar —Å–∫—Ä—ã—Ç –≤ —Å–æ—É—Å–∞—Ö, –π–æ–≥—É—Ä—Ç–∞—Ö, granola (5-15–≥ –Ω–∞ –ø–æ—Ä—Ü–∏—é)'
            ]
        },

        MICRONUTRIENT_GAP: {
            title: '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
            message: '2+ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ —Å score <50 ‚Äî —Ä–∏—Å–∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤ (D, Mg, Zn, Fe)',
            insight: '–î–µ—Ñ–∏—Ü–∏—Ç –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (–≤–∏—Ç–∞–º–∏–Ω D, –º–∞–≥–Ω–∏–π, —Ü–∏–Ω–∫, –∂–µ–ª–µ–∑–æ) —Å–Ω–∏–∂–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é, –∏–º–º—É–Ω–∏—Ç–µ—Ç, –º–µ—Ç–∞–±–æ–ª–∏–∑–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.',
            science: '–ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã ‚Äî cofactors –¥–ª—è 300+ —Ñ–µ—Ä–º–µ–Ω—Ç–æ–≤. Vitamin D (<30 ng/ml): —Å–Ω–∏–∂–∞–µ—Ç insulin sensitivity, –∏–º–º—É–Ω–∏—Ç–µ—Ç, testosterone synthesis. Magnesium (<400 mg/day): —É—Ö—É–¥—à–∞–µ—Ç sleep quality, –ø–æ–≤—ã—à–∞–µ—Ç cortisol, —Å–Ω–∏–∂–∞–µ—Ç ATP production (—ç–Ω–µ—Ä–≥–∏—è). Zinc (<11 mg/day –º—É–∂—á–∏–Ω—ã, <8 –º–≥ –∂–µ–Ω—â–∏–Ω—ã): –ø–æ–¥–∞–≤–ª—è–µ—Ç immune function, –∑–∞–º–µ–¥–ª—è–µ—Ç wound healing. Iron deficiency (ferritin <30 ng/ml): fatigue, —Å–Ω–∏–∂–µ–Ω–∏–µ VO2max –Ω–∞ 10-15%. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ (–º—è—Å–æ, —Ä—ã–±–∞, –æ—Ä–µ—Ö–∏, –∑–µ–ª–µ–Ω—å), sunlight 15 –º–∏–Ω/–¥–µ–Ω—å (D), supplementation –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ.',
            actions: [
                '–°–¥–∞–π—Ç–µ –∞–Ω–∞–ª–∏–∑—ã –Ω–∞ D, Mg, Zn, Fe: –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –¥–µ—Ñ–∏—Ü–∏—Ç—ã —Å –ø–æ–º–æ—â—å—é –≤—Ä–∞—á–∞',
                '–î–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: —à–ø–∏–Ω–∞—Ç/–∑–µ–ª–µ–Ω—å (Mg, Fe), –º—è—Å–æ/–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã (Zn), —è–π—Ü–∞ (D)',
                '–°–æ–ª–Ω—Ü–µ 15-20 –º–∏–Ω/–¥–µ–Ω—å –±–µ–∑ SPF: —Å–∏–Ω—Ç–µ–∑ –≤–∏—Ç–∞–º–∏–Ω–∞ D (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: D3 supplement 2000-4000 IU)'
            ]
        },

        STEP_DECLINE: {
            title: '–°–Ω–∏–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—à–∞–≥–∏)',
            message: '–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π —É–ø–∞–ª–æ –Ω–∞ 50%+ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ 30 –¥–Ω–µ–π ‚Äî NEAT —Å–Ω–∏–∂–∞–µ—Ç—Å—è',
            insight: 'NEAT (Non-Exercise Activity Thermogenesis) ‚Äî –¥–æ 15-30% daily expenditure. –†–µ–∑–∫–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —à–∞–≥–æ–≤ –∑–∞–º–µ–¥–ª—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º, —É–º–µ–Ω—å—à–∞–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç.',
            science: 'NEAT (—à–∞–≥–∏, fidgeting, —Å—Ç–æ—è–Ω–∏–µ) ‚Äî 200-800 kcal/day —É –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª—é–¥–µ–π. –°–Ω–∏–∂–µ–Ω–∏–µ —à–∞–≥–æ–≤ —Å 10k –¥–æ 5k/day = -200 kcal/day = -1.5 –∫–≥ –∂–∏—Ä–∞ –∑–∞ –º–µ—Å—è—Ü –ø–æ—Ç–µ—Ä—è–Ω–æ (–µ—Å–ª–∏ –Ω–µ –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å diet). –°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏ (<5k steps) —Å–Ω–∏–∂–∞–µ—Ç insulin sensitivity –Ω–∞ 15-20% vs 10k+ steps/day (Diabetes Care, 2016). Walking –ø–æ—Å–ª–µ –µ–¥—ã (10-15 –º–∏–Ω) —Å–Ω–∏–∂–∞–µ—Ç glucose spike –Ω–∞ 20-30%. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: walking breaks –∫–∞–∂–¥—ã–µ 90 –º–∏–Ω, standing desk, parking –ø–æ–¥–∞–ª—å—à–µ.',
            actions: [
                '–£–≤–µ–ª–∏—á—å—Ç–µ —à–∞–≥–∏ –Ω–∞ 2000/–¥–µ–Ω—å: 2 –ø—Ä–æ–≥—É–ª–∫–∏ –ø–æ 10 –º–∏–Ω (—É—Ç—Ä–æ + –≤–µ—á–µ—Ä)',
                'Walking after meals: 10-15 –º–∏–Ω –ø–æ—Å–ª–µ –æ–±–µ–¥–∞/—É–∂–∏–Ω–∞ (—Å–Ω–∏–∂–∞–µ—Ç glucose spike –Ω–∞ 20-30%)',
                '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ standing desk 2-3 —á–∞—Å–∞/–¥–µ–Ω—å –∏–ª–∏ walking breaks –∫–∞–∂–¥—ã–µ 90 –º–∏–Ω'
            ]
        },

        MEAL_TIMING_DRIFT: {
            title: '–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏',
            message: '–í—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞–∫–∞ –≤–∞—Ä—å–∏—Ä—É–µ—Ç—Å—è >2.5 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –¥–Ω—è–º–∏ ‚Äî –Ω–∞—Ä—É—à–∞–µ—Ç circadian clocks –∏ –∞–ø–ø–µ—Ç–∏—Ç',
            insight: '–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç peripheral clocks (–ø–µ—á–µ–Ω—å, –ñ–ö–¢), —É–ª—É—á—à–∞–µ—Ç insulin sensitivity, —Å–Ω–∏–∂–∞–µ—Ç evening cravings.',
            science: 'Food timing ‚Äî zeitgeber (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä) –¥–ª—è peripheral clocks. –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è eating (variance >2h) –¥–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç clock genes –≤ –ø–µ—á–µ–Ω–∏/–∂–∏—Ä–æ–≤–æ–π —Ç–∫–∞–Ω–∏ –æ—Ç central circadian clock (SCN). –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: irregular meal timing —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç risk obesity –Ω–∞ 30%, —Å–Ω–∏–∂–∞–µ—Ç postprandial insulin sensitivity –Ω–∞ 10-15% (Proc Nutr Soc, 2020). Consistent breakfast timing —É–ª—É—á—à–∞–µ—Ç morning cortisol peak (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ), —Å–Ω–∏–∂–∞–µ—Ç evening ghrelin (–≥–æ–ª–æ–¥). –°—Ç—Ä–∞—Ç–µ–≥–∏—è: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ –µ–¥—ã (e.g., 08:00-20:00) ¬±1h.',
            actions: [
                '–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞–∫–∞: ¬±30 –º–∏–Ω –º–µ–∂–¥—É –¥–Ω—è–º–∏ (e.g., 08:00-08:30 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ)',
                '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ eating window 10-12 —á–∞—Å–æ–≤: e.g., 08:00-20:00 (consistent front/back boundary)',
                '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—É–¥–∏–ª—å–Ω–∏–∫ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ø—Ä–∏—ë–º–∞—Ö –ø–∏—â–∏ –≤ –ø–µ—Ä–≤—ã–µ 2 –Ω–µ–¥–µ–ª–∏'
            ]
        },

        ELECTROLYTE_IMBALANCE: {
            title: '–î–∏—Å–±–∞–ª–∞–Ω—Å —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–æ–≤',
            message: 'Electrolyte Homeostasis score <40 –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö ‚Äî —Ä–∏—Å–∫ —Å—É–¥–æ—Ä–æ–≥, –ø–∞–¥–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏',
            insight: '–≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã (Na, K, Mg, Ca) –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –º—ã—à–µ—á–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π, hydration, nerve conduction. –î–∏—Å–±–∞–ª–∞–Ω—Å –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö —Å–Ω–∏–∂–∞–µ—Ç —Å–∏–ª—É, –≤—ã–∑—ã–≤–∞–µ—Ç —Å—É–¥–æ—Ä–æ–≥–∏.',
            science: 'Electrolyte losses: –ø–æ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç Na 500-1200 mg/L, K 150-300 mg/L, Mg 20-50 mg/L. –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (60+ –º–∏–Ω) ‚Äî –ø–æ—Ç–µ—Ä—è 1-2L –ø–æ—Ç–∞ = 1000-2000 mg Na, 200-400 mg K. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí –º—ã—à–µ—á–Ω—ã–µ —Å—É–¥–æ—Ä–æ–≥–∏ (Mg, Ca), –ø–∞–¥–µ–Ω–∏–µ —Å–∏–ª—ã –Ω–∞ 10-15% (dehydration + electrolyte depletion), arrhythmias –ø—Ä–∏ severe –¥–µ—Ñ–∏—Ü–∏—Ç–µ. –°—Ç—Ä–∞—Ç–µ–≥–∏—è: electrolyte drink –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö >60 –º–∏–Ω (Na 300-600 mg, K 100-200 mg –Ω–∞ –ø–æ—Ä—Ü–∏—é), —É–≤–µ–ª–∏—á–∏—Ç—å –æ–≤–æ—â–∏/—Ñ—Ä—É–∫—Ç—ã (K, Mg).',
            actions: [
                '–î–æ–±–∞–≤—å—Ç–µ electrolyte drink –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö >60 –º–∏–Ω: Na 300-600 –º–≥, K 100-200 –º–≥',
                '–£–≤–µ–ª–∏—á—å—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ K/Mg: –±–∞–Ω–∞–Ω—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å (K 400-600 –º–≥), —à–ø–∏–Ω–∞—Ç/–æ—Ä–µ—Ö–∏ (Mg 80-150 –º–≥)',
                '–°–æ–ª–∏—Ç–µ –ø–∏—â—É –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: 1/4 —á.–ª. —Å–æ–ª–∏ (500 –º–≥ Na) –¥–ª—è –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—å —Å –ø–æ—Ç–æ–º'
            ]
        }
    };

    // ========================================
    // Warning Trends Tracking (v3.1)
    // ========================================

    /**
     * Load warning trends from localStorage
     * @returns {Object} Trends data structure
     */
    function loadTrends() {
        console.info('ews / trends üöÄ load:', { key: TRENDS_STORAGE_KEY });

        try {
            const stored = localStorage.getItem(TRENDS_STORAGE_KEY);
            if (!stored) {
                console.info('ews / trends üì• load.empty:', { reason: 'no_stored_data' });
                return { version: 1, trends: {}, lastUpdated: null };
            }

            const parsed = JSON.parse(stored);
            console.info('ews / trends ‚úÖ load.success:', {
                warningTypes: Object.keys(parsed.trends || {}).length,
                lastUpdated: parsed.lastUpdated
            });
            return parsed;
        } catch (error) {
            console.error('ews / trends ‚ùå load.error:', error.message);
            return { version: 1, trends: {}, lastUpdated: null };
        }
    }

    /**
     * Save warning trends to localStorage
     * @param {Object} trendsData - Trends data structure
     */
    function saveTrends(trendsData) {
        console.info('ews / trends üöÄ save:', {
            warningTypesCount: Object.keys(trendsData.trends || {}).length
        });

        try {
            localStorage.setItem(TRENDS_STORAGE_KEY, JSON.stringify(trendsData));
            console.info('ews / trends ‚úÖ save.success:', {
                size: JSON.stringify(trendsData).length,
                lastUpdated: trendsData.lastUpdated
            });
        } catch (error) {
            console.error('ews / trends ‚ùå save.error:', error.message);
        }
    }

    /**
     * Track warning occurrences and calculate frequency
     * @param {Array} warnings - Current warnings from detectEarlyWarnings
     * @returns {Object} Top chronic warnings with frequency data
     */
    function trackWarningTrends(warnings) {
        console.info('ews / trends üöÄ start:', {
            currentWarnings: warnings.length,
            types: warnings.map(w => w.type)
        });

        // Load existing trends
        const trendsData = loadTrends();
        const today = new Date().toISOString().split('T')[0]; // 'YYYY-MM-DD'
        const todayTimestamp = new Date(today).getTime();

        console.info('ews / trends üì• input:', {
            date: today,
            existingTypes: Object.keys(trendsData.trends).length
        });

        // Update occurrences for each warning
        warnings.forEach(warning => {
            const warningType = warning.type;

            if (!trendsData.trends[warningType]) {
                trendsData.trends[warningType] = {
                    occurrences: [],
                    frequency14d: 0,
                    frequency30d: 0
                };
            }

            const trend = trendsData.trends[warningType];

            // Add today's occurrence if not already recorded
            const alreadyRecorded = trend.occurrences.some(occ => occ.date === today);
            if (!alreadyRecorded) {
                trend.occurrences.push({
                    date: today,
                    timestamp: todayTimestamp,
                    severity: warning.severity
                });
            }
        });

        console.info('ews / trends üßÆ compute:', {
            phase: 'cleanup_old_occurrences',
            maxAge: TRENDS_CONFIG.MAX_AGE_DAYS
        });

        // Cleanup old occurrences (>30 days) and calculate frequencies
        const cutoff30d = todayTimestamp - (TRENDS_CONFIG.MAX_AGE_DAYS * 24 * 60 * 60 * 1000);
        const cutoff14d = todayTimestamp - (TRENDS_CONFIG.FREQUENCY_WINDOW_14D * 24 * 60 * 60 * 1000);

        Object.keys(trendsData.trends).forEach(warningType => {
            const trend = trendsData.trends[warningType];

            // Keep only occurrences within 30 days
            trend.occurrences = trend.occurrences.filter(occ => occ.timestamp >= cutoff30d);

            // Calculate frequencies
            trend.frequency30d = trend.occurrences.length;
            trend.frequency14d = trend.occurrences.filter(occ => occ.timestamp >= cutoff14d).length;

            // Remove trend if no occurrences left
            if (trend.occurrences.length === 0) {
                delete trendsData.trends[warningType];
            }
        });

        // Update metadata
        trendsData.lastUpdated = today;

        console.info('ews / trends üßÆ compute.frequencies:', {
            activeTypes: Object.keys(trendsData.trends).length,
            totalOccurrences: Object.values(trendsData.trends).reduce((sum, t) => sum + t.frequency30d, 0)
        });

        // Save updated trends
        saveTrends(trendsData);

        // Calculate top-3 chronic warnings (by 30-day frequency)
        const chronicWarnings = Object.entries(trendsData.trends)
            .map(([type, trend]) => ({
                type,
                frequency14d: trend.frequency14d,
                frequency30d: trend.frequency30d,
                lastOccurrence: trend.occurrences[trend.occurrences.length - 1]?.date
            }))
            .sort((a, b) => b.frequency30d - a.frequency30d)
            .slice(0, TRENDS_CONFIG.TOP_CHRONIC_COUNT);

        console.info('ews / trends ‚úÖ result:', {
            topChronicCount: chronicWarnings.length,
            topTypes: chronicWarnings.map(w => w.type),
            frequencies: chronicWarnings.map(w => `${w.frequency14d}d14/${w.frequency30d}d30`)
        });

        console.group('ews / trends üñ•Ô∏è ui.chronic_warnings - Top 3');
        console.table(chronicWarnings.map(w => ({
            'Warning Type': w.type,
            '14d': w.frequency14d,
            '30d': w.frequency30d,
            'Last': w.lastOccurrence
        })));
        console.groupEnd();

        console.info('ews / trends üñ•Ô∏è ui.complete:', {
            chronicDisplayed: chronicWarnings.length
        });

        return {
            chronicWarnings,
            allTrends: trendsData.trends
        };
    }

    /**
     * Prioritize warnings by severity √ó frequency √ó health impact
     * @param {Array} warnings - Current warnings from detectEarlyWarnings
     * @param {Object} trendsData - Trends data with frequency information
     * @returns {Array} Prioritized warnings with priority scores
     */
    function prioritizeWarnings(warnings, trendsData) {
        console.info('ews / priority üöÄ start:', {
            warningsCount: warnings.length,
            hasTrends: !!trendsData
        });

        if (!warnings || warnings.length === 0) {
            console.info('ews / priority ‚ö†Ô∏è input.empty:', { reason: 'no_warnings' });
            return [];
        }

        console.info('ews / priority üì• input:', {
            warnings: warnings.map(w => w.type),
            trendsAvailable: Object.keys(trendsData?.trends || {}).length
        });

        console.info('ews / priority üßÆ compute:', {
            phase: 'calculating_scores',
            formula: 'severity_weight √ó frequency14d √ó health_impact'
        });

        // Calculate priority score for each warning
        const prioritizedWarnings = warnings.map(warning => {
            const warningType = warning.type;
            const severityWeight = SEVERITY_WEIGHTS[warning.severity] || 1;
            const healthImpact = HEALTH_IMPACT_SCORES[warningType] || 50; // default 50 if not defined
            const frequency14d = trendsData?.trends?.[warningType]?.frequency14d || 1; // at least 1 (today)

            // Priority formula: severity (1-3) √ó frequency (1-14) √ó health impact (0-100)
            const priorityScore = severityWeight * frequency14d * healthImpact;

            return {
                ...warning,
                priorityScore,
                frequency14d,
                healthImpact,
                severityWeight
            };
        });

        // Sort by priority score descending
        prioritizedWarnings.sort((a, b) => b.priorityScore - a.priorityScore);

        // Mark top-3 as critical priority
        const top3 = prioritizedWarnings.slice(0, 3);
        top3.forEach(w => {
            w.criticalPriority = true;
            w.priorityLabel = 'üî• Fix First!';
        });

        console.info('ews / priority ‚úÖ result:', {
            totalWarnings: prioritizedWarnings.length,
            top3Types: top3.map(w => w.type),
            top3Scores: top3.map(w => w.priorityScore),
            averageScore: Math.round(prioritizedWarnings.reduce((sum, w) => sum + w.priorityScore, 0) / prioritizedWarnings.length)
        });

        console.group('ews / priority üñ•Ô∏è ui.top3 - Critical Priority');
        console.table(top3.map(w => ({
            'Type': w.type,
            'Severity': w.severity,
            'Freq 14d': w.frequency14d,
            'Health Impact': w.healthImpact,
            'Priority Score': w.priorityScore,
            'Label': w.priorityLabel
        })));
        console.groupEnd();

        console.info('ews / priority üñ•Ô∏è ui.complete:', {
            criticalPriorityCount: top3.length,
            totalPrioritized: prioritizedWarnings.length
        });

        return prioritizedWarnings;
    }

    // ========================================
    // Weekly Progress Tracking (Wave 3.1)
    // ========================================

    /**
     * Load weekly progress data (localStorage + cloud sync)
     * @returns {Object} Weekly progress data structure
     */
    async function loadWeeklyProgress() {

        console.info('ews / weekly üöÄ load:', { key: WEEKLY_PROGRESS_STORAGE_KEY });

        // 1. Try cloud first (if enabled)
        if (CLOUD_SYNC_CONFIG.ENABLED && typeof HEYS?.YandexAPI?.rpc === 'function') {
            try {
                // Helper: validate token is not null/undefined/empty string
                const isValidToken = (token) => {
                    if (!token) return false;
                    const str = String(token).trim();
                    if (str === '' || str === 'null' || str === 'undefined') return false;
                    return true;
                };

                // Get session token for authentication (with multiple fallbacks)
                let sessionToken = null;

                // Attempt 1: HEYS.auth API
                sessionToken = HEYS.auth?.getSessionToken?.();
                console.info('ews / weekly üîç token.attempt1 (HEYS.auth):', sessionToken ? `found: ${String(sessionToken).slice(0, 16)}...` : 'NOT FOUND');
                if (!isValidToken(sessionToken)) sessionToken = null;

                // Attempt 2: Direct localStorage read
                if (!sessionToken) {
                    const raw = localStorage.getItem('heys_session_token');
                    console.info('ews / weekly üîç token.attempt2 (localStorage direct):', raw ? `found: ${String(raw).slice(0, 40)}...` : 'NOT FOUND');
                    if (raw && isValidToken(raw)) {
                        try {
                            const parsed = JSON.parse(raw);
                            sessionToken = isValidToken(parsed) ? parsed : null;
                        } catch {
                            sessionToken = raw;
                        }
                    }
                }

                // Attempt 3: Using HEYS.utils.lsGet (namespace-aware)
                if (!sessionToken && typeof HEYS?.utils?.lsGet === 'function') {
                    const tokenViaUtils = HEYS.utils.lsGet('heys_session_token', null);
                    console.info('ews / weekly üîç token.attempt3 (U.lsGet):', tokenViaUtils ? `found: ${String(tokenViaUtils).slice(0, 16)}...` : 'NOT FOUND');
                    if (isValidToken(tokenViaUtils)) {
                        sessionToken = tokenViaUtils;
                    }
                }

                // Attempt 4: Namespaced key (legacy migration)
                if (!sessionToken) {
                    const clientId = localStorage.getItem('heys_pin_auth_client') || localStorage.getItem('heys_client_current');
                    if (clientId) {
                        const cid = String(clientId).replace(/"/g, '');
                        const namespacedKey = `heys_${cid}_session_token`;
                        const namespacedToken = localStorage.getItem(namespacedKey);
                        console.info('ews / weekly üîç token.attempt4 (namespaced):', namespacedToken ? `found at ${namespacedKey}: ${String(namespacedToken).slice(0, 16)}...` : `NOT FOUND at ${namespacedKey}`);
                        if (namespacedToken && isValidToken(namespacedToken)) {
                            try {
                                const parsed = JSON.parse(namespacedToken);
                                sessionToken = isValidToken(parsed) ? parsed : null;
                            } catch {
                                sessionToken = namespacedToken;
                            }
                        }
                    } else {
                        console.info('ews / weekly üîç token.attempt4 (namespaced): SKIPPED (no clientId found)');
                    }
                }

                // Attempt 5: Curator session (for curator access)
                if (!sessionToken) {
                    const curatorToken = localStorage.getItem('heys_curator_session');
                    console.info('ews / weekly üîç token.attempt5 (curator_session):', curatorToken ? `found: ${String(curatorToken).slice(0, 16)}...` : 'NOT FOUND');
                    if (isValidToken(curatorToken)) {
                        sessionToken = curatorToken;
                    }
                }

                if (!sessionToken) {
                    console.warn('ews / weekly ‚òÅÔ∏è load.cloud.skip: no valid session token after 5 attempts');
                    throw new Error('No session token available');
                }

                console.info('ews / weekly ‚úÖ token.final:', `using token: ${String(sessionToken).slice(0, 16)}...`);
                console.info('ews / weekly ‚òÅÔ∏è load.cloud.start');
                const { data: cloudData, error: cloudError } = await Promise.race([
                    HEYS.YandexAPI.rpc('get_weekly_snapshots_by_session', {
                        p_session_token: sessionToken,
                        p_weeks_count: WEEKLY_CONFIG.WEEKS_TO_TRACK
                    }),
                    new Promise((_, reject) => setTimeout(
                        () => reject(new Error('Cloud load timeout')),
                        CLOUD_SYNC_CONFIG.LOAD_TIMEOUT_MS
                    ))
                ]);

                if (cloudError) {
                    throw new Error(cloudError.message || 'Cloud load failed');
                }

                if (cloudData && Array.isArray(cloudData) && cloudData.length > 0) {
                    const weeks = cloudData.map(row => ({
                        weekStart: row.week_start,
                        weekEnd: row.week_end,
                        weekNumber: row.week_number,
                        year: row.year,
                        warningsCount: row.warnings_count,
                        globalScore: row.global_score,
                        severityBreakdown: row.severity_breakdown,
                        topWarnings: row.top_warnings,
                        lastUpdate: row.updated_at?.split('T')[0] || row.week_start,
                        lastUpdateTimestamp: new Date(row.updated_at || row.week_start).getTime()
                    }));

                    console.info('ews / weekly ‚òÅÔ∏è load.cloud.success:', {
                        weeksLoaded: weeks.length,
                        source: 'cloud'
                    });

                    // Save to localStorage for fast access
                    const progressData = { version: 1, weeks, lastUpdated: weeks[0]?.lastUpdate || null };
                    try {
                        localStorage.setItem(WEEKLY_PROGRESS_STORAGE_KEY, JSON.stringify(progressData));
                        console.info('ews / weekly üíæ cached locally from cloud');
                    } catch (e) {
                        console.warn('ews / weekly ‚ö†Ô∏è localStorage cache failed:', e.message);
                    }

                    return progressData;
                }

                console.info('ews / weekly ‚òÅÔ∏è load.cloud.empty: no data in cloud');
            } catch (error) {
                console.error('ews / weekly ‚òÅÔ∏è load.cloud.error:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    raw: error.raw,
                    stack: error.stack?.split('\n')[0]
                });
                if (!CLOUD_SYNC_CONFIG.FALLBACK_TO_LOCAL) {
                    throw error;
                }
                console.info('ews / weekly üíæ falling back to localStorage');
            }
        }

        // 2. Fallback to localStorage
        try {
            const stored = localStorage.getItem(WEEKLY_PROGRESS_STORAGE_KEY);
            if (!stored) {
                console.info('ews / weekly üì• load.empty:', { reason: 'no_stored_data', source: 'localStorage' });
                return { version: 1, weeks: [], lastUpdated: null };
            }

            const parsed = JSON.parse(stored);
            console.info('ews / weekly ‚úÖ load.success:', {
                weeksStored: parsed.weeks?.length || 0,
                lastUpdated: parsed.lastUpdated,
                source: 'localStorage'
            });
            return parsed;
        } catch (error) {
            console.error('ews / weekly ‚ùå load.error:', error.message);
            return { version: 1, weeks: [], lastUpdated: null };
        }
    }

    /**
     * Save weekly progress data (localStorage + cloud sync)
     * @param {Object} progressData - Weekly progress data structure
     * @param {Object} currentWeekSnapshot - Current week snapshot for cloud upsert
     */
    async function saveWeeklyProgress(progressData, currentWeekSnapshot = null) {
        console.info('ews / weekly üöÄ save:', {
            weeksCount: progressData.weeks?.length || 0
        });

        // 1. Save to localStorage first (fast, always succeeds)
        try {
            localStorage.setItem(WEEKLY_PROGRESS_STORAGE_KEY, JSON.stringify(progressData));
            console.info('ews / weekly ‚úÖ save.success:', {
                size: JSON.stringify(progressData).length,
                lastUpdated: progressData.lastUpdated,
                target: 'localStorage'
            });
        } catch (error) {
            console.error('ews / weekly ‚ùå save.error:', error.message);
        }

        // 2. Sync current week to cloud (if enabled)
        if (CLOUD_SYNC_CONFIG.ENABLED && currentWeekSnapshot && typeof HEYS?.YandexAPI?.rpc === 'function') {
            try {
                // Helper function: validate token content (not just existence)
                const isValidToken = (token) => {
                    if (!token) return false;
                    const str = String(token).trim();
                    // Reject literal strings "null"/"undefined" and empty values
                    if (str === '' || str === 'null' || str === 'undefined') return false;
                    return true;
                };

                // Get session token: multi-tier fallback with validation
                let sessionToken = null;

                // Attempt 1: HEYS.auth API
                sessionToken = HEYS.auth?.getSessionToken?.();
                console.info('ews / weekly üîç token.attempt1 (HEYS.auth):', sessionToken ? `found: ${sessionToken.slice(0, 16)}...` : 'NOT FOUND');
                if (!isValidToken(sessionToken)) sessionToken = null;

                // Attempt 2: localStorage direct (JSON.parse safe)
                if (!sessionToken) {
                    const raw = localStorage.getItem('heys_session_token');
                    console.info('ews / weekly üîç token.attempt2 (localStorage direct):', raw ? `found: ${String(raw).slice(0, 16)}...` : 'NOT FOUND');
                    if (raw && isValidToken(raw)) {
                        try {
                            const parsed = JSON.parse(raw);
                            sessionToken = isValidToken(parsed) ? parsed : null;
                        } catch {
                            sessionToken = raw; // Use raw string if not JSON
                        }
                    }
                }

                // Attempt 3: HEYS.utils.lsGet (namespace-aware)
                if (!sessionToken) {
                    const tokenViaUtils = HEYS.utils.lsGet('heys_session_token', null);
                    console.info('ews / weekly üîç token.attempt3 (U.lsGet):', tokenViaUtils ? `found: ${String(tokenViaUtils).slice(0, 16)}...` : 'NOT FOUND');
                    if (isValidToken(tokenViaUtils)) {
                        sessionToken = tokenViaUtils;
                    }
                }

                // Attempt 4: Namespaced key (legacy migration)
                if (!sessionToken) {
                    const cid = HEYS.getCurrentClientId?.() || HEYS.clientId;
                    if (cid) {
                        const namespacedKey = `heys_${cid}_session_token`;
                        const namespacedToken = localStorage.getItem(namespacedKey);
                        console.info('ews / weekly üîç token.attempt4 (namespaced):', namespacedToken ? `found at ${namespacedKey}: ${String(namespacedToken).slice(0, 16)}...` : `NOT FOUND at ${namespacedKey}`);
                        if (namespacedToken && isValidToken(namespacedToken)) {
                            try {
                                const parsed = JSON.parse(namespacedToken);
                                sessionToken = isValidToken(parsed) ? parsed : null;
                            } catch {
                                sessionToken = namespacedToken;
                            }
                        }
                    } else {
                        console.info('ews / weekly üîç token.attempt4 (namespaced): SKIPPED (no clientId found)');
                    }
                }

                // Attempt 5: Curator session (alternative auth mechanism)
                if (!sessionToken) {
                    const curatorToken = localStorage.getItem('heys_curator_session');
                    console.info('ews / weekly üîç token.attempt5 (curator_session):', curatorToken ? `found: ${String(curatorToken).slice(0, 16)}...` : 'NOT FOUND');
                    if (isValidToken(curatorToken)) {
                        sessionToken = curatorToken;
                    }
                }

                // Final validation
                if (!sessionToken) {
                    console.warn('ews / weekly ‚òÅÔ∏è save.cloud.skip: no valid session token after 5 attempts');
                    return;
                }

                console.info('ews / weekly ‚úÖ token.final: using token:', `${String(sessionToken).slice(0, 16)}...`);
                console.info('ews / weekly ‚òÅÔ∏è save.cloud.start:', {
                    weekStart: currentWeekSnapshot.weekStart
                });

                const { data: result, error: saveError } = await Promise.race([
                    HEYS.YandexAPI.rpc('upsert_weekly_snapshot_by_session', {
                        p_session_token: sessionToken,
                        p_week_start: currentWeekSnapshot.weekStart,
                        p_week_end: currentWeekSnapshot.weekEnd,
                        p_week_number: currentWeekSnapshot.weekNumber,
                        p_year: currentWeekSnapshot.year,
                        p_warnings_count: currentWeekSnapshot.warningsCount,
                        p_global_score: currentWeekSnapshot.globalScore,
                        p_severity_breakdown: currentWeekSnapshot.severityBreakdown,
                        p_top_warnings: currentWeekSnapshot.topWarnings
                    }),
                    new Promise((_, reject) => setTimeout(
                        () => reject(new Error('Cloud save timeout')),
                        CLOUD_SYNC_CONFIG.SAVE_TIMEOUT_MS
                    ))
                ]);

                // Extract response (handle both array and object formats)
                const response = Array.isArray(result) ? result[0] : result;

                if (saveError) {
                    console.warn('ews / weekly ‚òÅÔ∏è save.cloud.error:', saveError.message);
                } else if (response?.success) {
                    console.info('ews / weekly ‚òÅÔ∏è save.cloud.success:', {
                        action: response.message,
                        snapshotId: response.snapshot_id
                    });
                } else if (response?.message === 'invalid_or_expired_session') {
                    // Graceful degradation: curator session token doesn't have write permissions
                    console.info('ews / weekly ‚òÅÔ∏è save.cloud.skip: curator_mode (no client session)');
                } else {
                    console.warn('ews / weekly ‚òÅÔ∏è save.cloud.failed:', {
                        message: response?.message || 'unknown_error',
                        response
                    });
                }
            } catch (error) {
                console.error('ews / weekly ‚òÅÔ∏è save.cloud.error:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    raw: error.raw,
                    stack: error.stack?.split('\n')[0]
                });
                // Non-critical: localStorage already saved
            }
        }
    }

    /**
     * Get week boundaries (Monday 00:00 to Sunday 23:59)
     * @param {Date} date - Reference date
     * @returns {Object} Week start and end dates
     */
    function getWeekBoundaries(date) {
        const d = new Date(date);
        const day = d.getDay(); // 0 = Sunday, 1 = Monday, ...
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday

        const weekStart = new Date(d.setDate(diff));
        weekStart.setHours(0, 0, 0, 0);

        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);

        return {
            weekStart: weekStart.toISOString().split('T')[0],
            weekEnd: weekEnd.toISOString().split('T')[0],
            weekStartTimestamp: weekStart.getTime(),
            weekEndTimestamp: weekEnd.getTime()
        };
    }

    /**
     * Get ISO week number for a date
     * @param {Date} date - Date to get week number for
     * @returns {number} ISO week number (1-53)
     */
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    /**
     * Determine weekly trend (improving/stable/worsening)
     * @param {Array} weeks - Array of weekly snapshots (sorted newest first)
     * @returns {Object} Trend analysis
     */
    function determineWeeklyTrend(weeks) {
        console.info('ews / weekly üßÆ trend:', {
            phase: 'analysis',
            weeksCount: weeks.length
        });

        if (weeks.length < 2) {
            console.info('ews / weekly ‚ö†Ô∏è trend.insufficient:', {
                reason: 'need_at_least_2_weeks',
                current: weeks.length
            });
            return {
                status: 'insufficient_data',
                direction: null,
                percentChange: 0,
                description: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–Ω—É–∂–Ω–æ ‚â•2 –Ω–µ–¥–µ–ª—å)'
            };
        }

        const currentWeek = weeks[0]; // Newest
        const previousWeek = weeks[1];

        const currentCount = currentWeek.warningsCount;
        const previousCount = previousWeek.warningsCount;

        // Calculate percent change
        const percentChange = previousCount === 0
            ? (currentCount > 0 ? 100 : 0)
            : Math.round(((currentCount - previousCount) / previousCount) * 100);

        let status, direction, description;

        if (percentChange <= WEEKLY_CONFIG.IMPROVEMENT_THRESHOLD) {
            status = 'improving';
            direction = 'down';
            description = `–£–ª—É—á—à–µ–Ω–∏–µ: ${Math.abs(percentChange)}% –º–µ–Ω—å—à–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π`;
        } else if (percentChange >= WEEKLY_CONFIG.STABLE_THRESHOLD) {
            status = 'worsening';
            direction = 'up';
            description = `–£—Ö—É–¥—à–µ–Ω–∏–µ: +${percentChange}% –±–æ–ª—å—à–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π`;
        } else {
            status = 'stable';
            direction = 'flat';
            description = `–°—Ç–∞–±–∏–ª—å–Ω–æ: ¬±${Math.abs(percentChange)}% (–Ω–æ—Ä–º–∞)`;
        }

        console.info('ews / weekly ‚úÖ trend.result:', {
            status,
            direction,
            percentChange,
            current: currentCount,
            previous: previousCount
        });

        return {
            status,
            direction,
            percentChange,
            currentCount,
            previousCount,
            description
        };
    }

    /**
     * Backfill weekly snapshots from historical data
     * Creates snapshots for last N weeks using historical day data
     * @param {Array} allDays - All available historical day data (sorted newest first)
     * @param {Object} profile - User profile
     * @param {Array} pIndex - Product index
     * @param {number} weeksToBackfill - Number of weeks to backfill (default: 4)
     * @returns {Promise<Object>} { success, weeksCreated, snapshots }
     */
    async function backfillWeeklySnapshots(allDays, profile, pIndex, weeksToBackfill = 4) {
        console.info('ews / weekly üîÑ backfill.start:', {
            totalDays: allDays.length,
            weeksToBackfill
        });

        if (!allDays || allDays.length < 7) {
            console.warn('ews / weekly ‚ö†Ô∏è backfill.insufficient_data:', {
                daysAvailable: allDays?.length || 0,
                required: 7
            });
            return { success: false, weeksCreated: 0, reason: 'insufficient_data' };
        }

        const snapshots = [];
        const today = new Date();

        // Generate week boundaries for last N weeks
        for (let weekOffset = 0; weekOffset < weeksToBackfill; weekOffset++) {
            const weekDate = new Date(today);
            weekDate.setDate(weekDate.getDate() - (weekOffset * 7));

            const weekBoundaries = getWeekBoundaries(weekDate);
            console.info(`ews / weekly üîÑ backfill.week_${weekOffset + 1}:`, {
                weekStart: weekBoundaries.weekStart,
                weekEnd: weekBoundaries.weekEnd
            });

            // Filter days for this specific week
            const weekDays = allDays.filter(day => {
                const dayDate = day.date;
                return dayDate >= weekBoundaries.weekStart && dayDate <= weekBoundaries.weekEnd;
            });

            if (weekDays.length === 0) {
                console.info(`ews / weekly ‚è≠Ô∏è backfill.skip_week_${weekOffset + 1}: no data`);
                continue;
            }

            console.info(`ews / weekly üßÆ backfill.compute_week_${weekOffset + 1}:`, {
                daysInWeek: weekDays.length
            });

            // Run detect() for this week (use mode depending on days available)
            const mode = weekDays.length >= 14 ? 'full' : 'acute';
            try {
                const weekResult = await detectEarlyWarnings(weekDays, profile, pIndex, {
                    mode,
                    includeDetails: true
                });

                if (!weekResult.available) {
                    console.warn(`ews / weekly ‚ö†Ô∏è backfill.week_${weekOffset + 1}.unavailable`);
                    continue;
                }

                // Create snapshot for this week
                const snapshot = {
                    weekStart: weekBoundaries.weekStart,
                    weekEnd: weekBoundaries.weekEnd,
                    weekNumber: getWeekNumber(weekDate),
                    year: weekDate.getFullYear(),
                    warningsCount: weekResult.count || 0,
                    globalScore: weekResult.globalScore || 0,
                    severityBreakdown: {
                        high: weekResult.highSeverityCount || 0,
                        medium: (weekResult.count || 0) - (weekResult.highSeverityCount || 0),
                        low: 0
                    },
                    topWarnings: (weekResult.warnings || [])
                        .slice(0, 3)
                        .map(w => ({ type: w.type, severity: w.severity })),
                    lastUpdate: weekBoundaries.weekEnd, // Use week end as update date
                    lastUpdateTimestamp: new Date(weekBoundaries.weekEnd).getTime()
                };

                snapshots.push(snapshot);

                console.info(`ews / weekly ‚úÖ backfill.week_${weekOffset + 1}.created:`, {
                    warnings: snapshot.warningsCount,
                    globalScore: snapshot.globalScore
                });

                // Upload to cloud immediately
                if (CLOUD_SYNC_CONFIG.ENABLED && typeof HEYS?.YandexAPI?.rpc === 'function') {
                    try {
                        // Helper function: validate token content (not just existence)
                        const isValidToken = (token) => {
                            if (!token) return false;
                            const str = String(token).trim();
                            // Reject literal strings "null"/"undefined" and empty values
                            if (str === '' || str === 'null' || str === 'undefined') return false;
                            return true;
                        };

                        // Get session token: multi-tier fallback with validation
                        let sessionToken = null;

                        // Attempt 1: HEYS.auth API
                        sessionToken = HEYS.auth?.getSessionToken?.();
                        console.info('ews / weekly üîç token.attempt1 (HEYS.auth):', sessionToken ? `found: ${String(sessionToken).slice(0, 16)}...` : 'NOT FOUND');
                        if (!isValidToken(sessionToken)) sessionToken = null;

                        // Attempt 2: localStorage direct (JSON.parse safe)
                        if (!sessionToken) {
                            const raw = localStorage.getItem('heys_session_token');
                            console.info('ews / weekly üîç token.attempt2 (localStorage direct):', raw ? `found: ${String(raw).slice(0, 16)}...` : 'NOT FOUND');
                            if (raw && isValidToken(raw)) {
                                try {
                                    const parsed = JSON.parse(raw);
                                    sessionToken = isValidToken(parsed) ? parsed : null;
                                } catch {
                                    sessionToken = raw; // Use raw string if not JSON
                                }
                            }
                        }

                        // Attempt 3: HEYS.utils.lsGet (namespace-aware)
                        if (!sessionToken) {
                            const tokenViaUtils = HEYS.utils.lsGet('heys_session_token', null);
                            console.info('ews / weekly üîç token.attempt3 (U.lsGet):', tokenViaUtils ? `found: ${String(tokenViaUtils).slice(0, 16)}...` : 'NOT FOUND');
                            if (isValidToken(tokenViaUtils)) {
                                sessionToken = tokenViaUtils;
                            }
                        }

                        // Attempt 4: Namespaced key (legacy migration)
                        if (!sessionToken) {
                            const cid = HEYS.getCurrentClientId?.() || HEYS.clientId;
                            if (cid) {
                                const namespacedKey = `heys_${cid}_session_token`;
                                const namespacedToken = localStorage.getItem(namespacedKey);
                                console.info('ews / weekly üîç token.attempt4 (namespaced):', namespacedToken ? `found at ${namespacedKey}: ${String(namespacedToken).slice(0, 16)}...` : `NOT FOUND at ${namespacedKey}`);
                                if (namespacedToken && isValidToken(namespacedToken)) {
                                    try {
                                        const parsed = JSON.parse(namespacedToken);
                                        sessionToken = isValidToken(parsed) ? parsed : null;
                                    } catch {
                                        sessionToken = namespacedToken;
                                    }
                                }
                            } else {
                                console.info('ews / weekly üîç token.attempt4 (namespaced): SKIPPED (no clientId found)');
                            }
                        }

                        // Attempt 5: Curator session (alternative auth mechanism)
                        if (!sessionToken) {
                            const curatorToken = localStorage.getItem('heys_curator_session');
                            console.info('ews / weekly üîç token.attempt5 (curator_session):', curatorToken ? `found: ${String(curatorToken).slice(0, 16)}...` : 'NOT FOUND');
                            if (isValidToken(curatorToken)) {
                                sessionToken = curatorToken;
                            }
                        }

                        // Final validation
                        if (!sessionToken) {
                            console.warn(`ews / weekly ‚ö†Ô∏è backfill.week_${weekOffset + 1}.skip: no valid session token after 5 attempts`);
                            continue;
                        }

                        console.info('ews / weekly ‚úÖ token.final: using token:', `${String(sessionToken).slice(0, 16)}...`);

                        const { data: result, error: cloudError } = await HEYS.YandexAPI.rpc('upsert_weekly_snapshot_by_session', {
                            p_session_token: sessionToken,
                            p_week_start: snapshot.weekStart,
                            p_week_end: snapshot.weekEnd,
                            p_week_number: snapshot.weekNumber,
                            p_year: snapshot.year,
                            p_warnings_count: snapshot.warningsCount,
                            p_global_score: snapshot.globalScore,
                            p_severity_breakdown: snapshot.severityBreakdown,
                            p_top_warnings: snapshot.topWarnings
                        });

                        if (cloudError) {
                            throw cloudError;
                        }

                        if (result && Array.isArray(result) && result[0]?.success) {
                            console.info(`ews / weekly ‚òÅÔ∏è backfill.week_${weekOffset + 1}.uploaded`);
                        }
                    } catch (cloudError) {
                        console.warn(`ews / weekly ‚ö†Ô∏è backfill.week_${weekOffset + 1}.cloud_error:`, cloudError.message);
                    }
                }

            } catch (error) {
                console.error(`ews / weekly ‚ùå backfill.week_${weekOffset + 1}.error:`, error.message);
                continue;
            }
        }

        // Save all snapshots to localStorage
        if (snapshots.length > 0) {
            const progressData = {
                version: 1,
                weeks: snapshots.sort((a, b) =>
                    new Date(b.weekStart).getTime() - new Date(a.weekStart).getTime()
                ),
                lastUpdated: snapshots[0]?.lastUpdate || null
            };

            try {
                localStorage.setItem(WEEKLY_PROGRESS_STORAGE_KEY, JSON.stringify(progressData));
                console.info('ews / weekly ‚úÖ backfill.saved_to_localStorage:', {
                    snapshotsCount: snapshots.length
                });
            } catch (e) {
                console.error('ews / weekly ‚ùå backfill.localStorage_error:', e.message);
            }
        }

        console.info('ews / weekly ‚úÖ backfill.complete:', {
            weeksCreated: snapshots.length,
            weeksRequested: weeksToBackfill
        });

        return {
            success: true,
            weeksCreated: snapshots.length,
            snapshots
        };
    }

    /**
     * Calculate weekly progress summary from warnings and global score
     * @param {Array} warnings - Current warnings array
     * @param {number} globalScore - Current EWS global score (0-100)
     * @returns {Promise<Object>} Weekly summary with trend analysis
     */
    async function calculateWeeklyProgress(warnings, globalScore) {
        console.info('ews / weekly üöÄ start:', {
            currentWarnings: warnings.length,
            globalScore
        });

        const today = new Date();
        const weekBoundaries = getWeekBoundaries(today);
        const todayStr = today.toISOString().split('T')[0];

        console.info('ews / weekly üì• input:', {
            date: todayStr,
            weekStart: weekBoundaries.weekStart,
            weekEnd: weekBoundaries.weekEnd
        });

        // Load existing weekly data (cloud + localStorage)
        const progressData = await loadWeeklyProgress();

        // Check if current week already has a snapshot
        const existingWeekIndex = progressData.weeks.findIndex(
            w => w.weekStart === weekBoundaries.weekStart
        );

        // Create or update current week snapshot
        const weekSnapshot = {
            weekStart: weekBoundaries.weekStart,
            weekEnd: weekBoundaries.weekEnd,
            weekNumber: getWeekNumber(today),
            year: today.getFullYear(),
            warningsCount: warnings.length,
            globalScore: globalScore || 0,
            severityBreakdown: {
                high: warnings.filter(w => w.severity === 'high').length,
                medium: warnings.filter(w => w.severity === 'medium').length,
                low: warnings.filter(w => w.severity === 'low').length
            },
            topWarnings: warnings
                .slice(0, 3)
                .map(w => ({ type: w.type, severity: w.severity })),
            lastUpdate: todayStr,
            lastUpdateTimestamp: today.getTime()
        };

        console.info('ews / weekly üßÆ compute:', {
            phase: 'snapshot',
            weekNumber: weekSnapshot.weekNumber,
            warningsCount: weekSnapshot.warningsCount,
            globalScore: weekSnapshot.globalScore
        });

        // Update or add snapshot
        if (existingWeekIndex >= 0) {
            // Update existing week
            progressData.weeks[existingWeekIndex] = weekSnapshot;
            console.info('ews / weekly ‚ôªÔ∏è updated:', {
                weekStart: weekBoundaries.weekStart
            });
        } else {
            // Add new week at the beginning (newest first)
            progressData.weeks.unshift(weekSnapshot);
            console.info('ews / weekly ‚ûï added:', {
                weekStart: weekBoundaries.weekStart
            });
        }

        // Keep only last 4 weeks
        if (progressData.weeks.length > WEEKLY_CONFIG.WEEKS_TO_TRACK) {
            const removed = progressData.weeks.splice(WEEKLY_CONFIG.WEEKS_TO_TRACK);
            console.info('ews / weekly üóëÔ∏è pruned:', {
                removedCount: removed.length,
                oldestRemoved: removed[0]?.weekStart
            });
        }

        // Sort by week start descending (newest first)
        progressData.weeks.sort((a, b) =>
            new Date(b.weekStart).getTime() - new Date(a.weekStart).getTime()
        );

        // Update metadata
        progressData.lastUpdated = todayStr;

        // Calculate trend
        const trend = determineWeeklyTrend(progressData.weeks);

        console.info('ews / weekly ‚úÖ result:', {
            weeksTracked: progressData.weeks.length,
            trend: trend.status,
            trendDirection: trend.direction,
            percentChange: trend.percentChange
        });

        // Save updated data (localStorage + cloud sync)
        await saveWeeklyProgress(progressData, weekSnapshot);

        console.group('ews / weekly üñ•Ô∏è ui.summary - Last 4 Weeks');
        console.table(progressData.weeks.map((w, idx) => ({
            '#': idx + 1,
            'Week': `${w.weekStart} to ${w.weekEnd}`,
            'Warnings': w.warningsCount,
            'Global Score': w.globalScore,
            'High/Med/Low': `${w.severityBreakdown.high}/${w.severityBreakdown.medium}/${w.severityBreakdown.low}`,
            'Last Update': w.lastUpdate
        })));
        console.groupEnd();

        console.info('ews / weekly üñ•Ô∏è ui.trend:', {
            status: trend.status,
            description: trend.description
        });

        console.info('ews / weekly üñ•Ô∏è ui.complete:', {
            weeksDisplayed: progressData.weeks.length,
            trendAvailable: trend.status !== 'insufficient_data'
        });

        return {
            weeks: progressData.weeks,
            trend,
            currentWeek: weekSnapshot
        };
    }

    /**
     * Detect consecutive decline in values
     * @param {number[]} values - Array of numeric values (most recent last)
     * @param {number} consecutiveDays - Number of consecutive days to check
     * @returns {boolean}
     */
    function isConsecutiveDecline(values, consecutiveDays) {
        if (!Array.isArray(values) || values.length < consecutiveDays) {
            return false;
        }

        const recent = values.slice(-consecutiveDays);

        for (let i = 1; i < recent.length; i++) {
            if (recent[i] >= recent[i - 1]) {
                return false; // Not declining
            }
        }

        return true;
    }

    /**
     * Calculate average decline rate
     * @param {number[]} values
     * @returns {number} - Average change per day
     */
    function calculateDeclineRate(values) {
        if (!Array.isArray(values) || values.length < 2) return 0;

        let totalChange = 0;
        for (let i = 1; i < values.length; i++) {
            totalChange += (values[i] - values[i - 1]);
        }

        return totalChange / (values.length - 1);
    }

    /**
     * Warning 1: Health Score declining 3+ days
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @param {object} pIndex
     * @param {object} options - Additional options with currentPatterns/previousPatterns
     * @returns {object|null}
     */
    function checkHealthScoreDecline(days, profile, pIndex, options = {}) {
        console.log('ews / detect üìâ checking health score decline...');
        if (days.length < THRESHOLDS.MIN_DAYS_FOR_ANALYSIS) {
            console.log('ews / detect ‚è≠Ô∏è skip: insufficient days', days.length, '<', THRESHOLDS.MIN_DAYS_FOR_ANALYSIS);
            return null;
        }

        // Check if we have pattern data passed from UI
        const { currentPatterns, previousPatterns } = options;

        // Fallback path: detect decline from day-level health score calculation
        // (keeps backward compatibility for environments without pattern snapshots)
        if (!currentPatterns || !previousPatterns) {
            const calcDayHealthScore = HEYS.InsightsPI?.calculations?.calculateHealthScore;
            if (!calcDayHealthScore) {
                console.log('ews / detect ‚è≠Ô∏è skip: no pattern snapshots and no day-level health score calculator');
                return null;
            }

            try {
                const sortedDays = days
                    .slice()
                    .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)); // newest first

                const currentPeriod = sortedDays.slice(0, THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS);
                const previousPeriod = sortedDays.slice(
                    THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS,
                    THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS * 2
                );

                if (currentPeriod.length < THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS || previousPeriod.length < THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS) {
                    return null;
                }

                const currentScores = currentPeriod
                    .map(day => calcDayHealthScore(day, profile, pIndex, days))
                    .map(score => score?.overall ?? score?.total ?? 0)
                    .filter(score => Number.isFinite(score) && score > 0);

                const previousScores = previousPeriod
                    .map(day => calcDayHealthScore(day, profile, pIndex, days))
                    .map(score => score?.overall ?? score?.total ?? 0)
                    .filter(score => Number.isFinite(score) && score > 0);

                if (currentScores.length < THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS || previousScores.length < THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS) {
                    console.log('ews / detect ‚è≠Ô∏è skip: insufficient valid scores after filtering');
                    return null;
                }

                const currentScore = currentScores.reduce((sum, v) => sum + v, 0) / currentScores.length;
                const previousScore = previousScores.reduce((sum, v) => sum + v, 0) / previousScores.length;
                const totalDrop = previousScore - currentScore;

                console.log(`ews / detect üìä health scores (fallback): prev=${Math.round(previousScore)}, curr=${Math.round(currentScore)}, drop=${Math.round(totalDrop)}`);

                if (totalDrop >= THRESHOLDS.HEALTH_SCORE_MIN_DELTA) {
                    const percentChange = Math.round((totalDrop / previousScore) * 100);

                    const humanMsg = WARNING_HUMAN_MESSAGES.HEALTH_SCORE_DECLINE;

                    const warning = {
                        type: 'HEALTH_SCORE_DECLINE',
                        severity: totalDrop >= 20 ? 'high' : 'medium',
                        days: THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS,
                        currentScore: Math.round(currentScore),
                        previousScore: Math.round(previousScore),
                        totalDrop: Math.round(totalDrop),
                        percentChange,
                        patternName: humanMsg.title,
                        message: `üìâ ${humanMsg.title}`,
                        detail: `–ë—ã–ª–æ ${Math.round(previousScore)}, —Å—Ç–∞–ª–æ ${Math.round(currentScore)} (‚àí${percentChange}% –∑–∞ ${THRESHOLDS.HEALTH_SCORE_DECLINE_DAYS} –¥–Ω—è)`,
                        insight: humanMsg.insight,
                        science: humanMsg.science,
                        actionable: true
                    };
                    console.log(`ews / detect ‚úÖ HEALTH_SCORE_DECLINE warning: severity=${warning.severity}, drop=${warning.totalDrop}`);
                    return warning;
                }

                console.log('ews / detect ‚ûñ no significant health score decline (fallback)');
                return null;
            } catch (e) {
                console.error('ews / detect ‚ùå error in day-level health score fallback:', e);
                return null;
            }
        }

        // Use calculateHealthScore to compute scores from patterns
        const calculateHealthScore = HEYS.PredictiveInsights?.calculateHealthScore;
        if (!calculateHealthScore) {
            console.warn('ews / detect ‚ö†Ô∏è HEYS.PredictiveInsights.calculateHealthScore not available');
            return null;
        }

        try {
            // Calculate health scores from patterns
            const currentHealthScore = calculateHealthScore(currentPatterns, profile);
            const previousHealthScore = calculateHealthScore(previousPatterns, profile);

            const currentScore = currentHealthScore?.total || 0;
            const previousScore = previousHealthScore?.total || 0;

            console.log('ews / detect üìä health scores:', {
                previous: Math.round(previousScore),
                current: Math.round(currentScore),
                delta: Math.round(currentScore - previousScore)
            });

            if (currentScore === 0 || previousScore === 0) {
                console.log('ews / detect ‚è≠Ô∏è health score calculation returned 0, skipping');
                return null;
            }

            // Check for decline (previous > current = decline)
            const totalDrop = previousScore - currentScore; // Positive = decline

            if (totalDrop >= THRESHOLDS.HEALTH_SCORE_MIN_DELTA) {  // Significant drop (e.g., >= 10 points)
                const percentChange = Math.round((totalDrop / previousScore) * 100);

                const humanMsg = WARNING_HUMAN_MESSAGES.HEALTH_SCORE_DECLINE;

                return {
                    type: 'HEALTH_SCORE_DECLINE',
                    severity: totalDrop >= 20 ? 'high' : 'medium',
                    days: 7,
                    currentScore: Math.round(currentScore),
                    previousScore: Math.round(previousScore),
                    totalDrop: Math.round(totalDrop),
                    percentChange,
                    patternName: humanMsg.title,
                    message: `üìâ ${humanMsg.title}`,
                    detail: `–ë—ã–ª–æ ${Math.round(previousScore)}, —Å—Ç–∞–ª–æ ${Math.round(currentScore)} (‚àí${percentChange}% –∑–∞ 7 –¥–Ω–µ–π)`,
                    insight: humanMsg.insight,
                    science: humanMsg.science,
                    actionable: true
                };
            }

            console.log('ews / detect ‚ûñ health score stable (drop < threshold)');
            return null;

        } catch (e) {
            console.error('ews / detect ‚ùå error calculating health score decline:', e);
            return null;
        }
    }

    /**
     * Warning 2: Critical pattern degraded significantly OR current low scores
     * @param {object[]} days
     * @param {object} profile
     * @param {object} pIndex
     * @param {object} previousPatterns - patterns from 7 days ago (optional)
     * @param {object} currentPatterns - patterns from today (required)
     * @returns {object[]|null}
     */
    function checkCriticalPatternDegradation(days, profile, pIndex, previousPatterns, currentPatterns) {
        if (!currentPatterns) return null;

        const warnings = [];

        // Check 1: Pattern score degradation (change over time) - ONLY if we have previous data
        if (previousPatterns) {
            for (const patternId of CRITICAL_PATTERNS) {
                const prev = previousPatterns[patternId];
                const curr = currentPatterns[patternId];

                if (!prev || !curr || !prev.available || !curr.available) continue;

                const prevScore = prev.score || 0;
                const currScore = curr.score || 0;

                if (prevScore === 0) continue; // Avoid division by zero

                const relativeChange = (currScore - prevScore) / prevScore;

                if (relativeChange <= THRESHOLDS.CRITICAL_PATTERN_DEGRADATION) {
                    const absoluteChange = currScore - prevScore;

                    warnings.push({
                        type: 'CRITICAL_PATTERN_DEGRADATION',
                        severity: relativeChange <= -0.3 ? 'high' : 'medium',
                        pattern: patternId,
                        patternName: prev.pattern || patternId,
                        previousScore: Math.round(prevScore),
                        currentScore: Math.round(currScore),
                        absoluteChange: Math.round(absoluteChange),
                        relativeChange: Math.round(relativeChange * 100),
                        message: `‚ö†Ô∏è ${prev.pattern || patternId} —É—Ö—É–¥—à–∏–ª—Å—è –Ω–∞ ${Math.abs(Math.round(relativeChange * 100))}%`,
                        detail: `–° ${Math.round(prevScore)} –¥–æ ${Math.round(currScore)} –∑–∞ 7 –¥–Ω–µ–π`,
                        action: `–ò–∑—É—á–∏—Ç—å insight: ¬´${curr.insight || 'N/A'}¬ª`,
                        actionable: true
                    });
                }
            }
        }

        // Check 2: Current low pattern scores (absolute values) - ALWAYS check this
        console.log('ews / detect üîç checking current pattern scores...');

        // Convert patterns array to id-indexed object for easier lookup
        const patternsById = {};
        if (Array.isArray(currentPatterns)) {
            for (const p of currentPatterns) {
                if (p.pattern) patternsById[p.pattern] = p;
            }
        } else {
            // Already an object
            Object.assign(patternsById, currentPatterns);
        }

        const allPatternIds = Object.keys(patternsById);

        for (const patternId of allPatternIds) {
            const pattern = patternsById[patternId];
            if (!pattern || !pattern.available) continue;

            const score = pattern.score || 0;
            const isCritical = CRITICAL_PATTERNS.includes(patternId);

            console.log(`ews / detect üìä ${patternId}: score=${score}, critical=${isCritical}`);

            // Get human-friendly messages
            const humanMsg = PATTERN_HUMAN_MESSAGES[patternId] || {
                title: pattern.pattern || patternId,
                message: `–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è (score ${Math.round(score)})`,
                insight: pattern.insight || '–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç –∞—Å–ø–µ–∫—Ç –ø–∏—Ç–∞–Ω–∏—è',
                science: '–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ Insights'
            };

            // Critical patterns: HIGH severity if below 35, MEDIUM if 35-50
            if (isCritical && score > 0 && score < PATTERN_LOW_SCORE_THRESHOLDS.critical) {
                warnings.push({
                    type: 'LOW_PATTERN_SCORE',
                    severity: 'high',
                    pattern: patternId,
                    patternName: humanMsg.title,
                    currentScore: Math.round(score),
                    threshold: PATTERN_LOW_SCORE_THRESHOLDS.critical,
                    message: `üö® ${humanMsg.title}`,
                    detail: humanMsg.message,
                    insight: humanMsg.insight,
                    science: humanMsg.science,
                    actionable: true
                });
            }
            // Critical patterns: MEDIUM severity if 35-50 (still needs attention)
            else if (isCritical && score >= PATTERN_LOW_SCORE_THRESHOLDS.critical && score < 50) {
                warnings.push({
                    type: 'LOW_PATTERN_SCORE',
                    severity: 'medium',
                    pattern: patternId,
                    patternName: humanMsg.title,
                    currentScore: Math.round(score),
                    threshold: 50,
                    message: `‚ö†Ô∏è ${humanMsg.title}`,
                    detail: humanMsg.message,
                    insight: humanMsg.insight,
                    science: humanMsg.science,
                    actionable: true
                });
            }
            // Non-critical patterns: warn if below 45
            else if (!isCritical && score > 0 && score < PATTERN_LOW_SCORE_THRESHOLDS.important) {
                warnings.push({
                    type: 'LOW_PATTERN_SCORE',
                    severity: 'medium',
                    pattern: patternId,
                    patternName: humanMsg.title,
                    currentScore: Math.round(score),
                    threshold: PATTERN_LOW_SCORE_THRESHOLDS.important,
                    message: `‚ö†Ô∏è ${humanMsg.title}`,
                    detail: humanMsg.message,
                    insight: humanMsg.insight,
                    science: humanMsg.science,
                    actionable: true
                });
            }
        }

        console.log(`ews / detect ‚úÖ found ${warnings.length} pattern-related warnings`);

        return warnings.length > 0 ? warnings : null;
    }

    /**
     * Warning 3: Status Score decline
     * @param {object[]} days - Array of day objects with statusScore property
     * @returns {object|null}
     */
    function checkStatusScoreDecline(days) {
        console.log('ews / detect üìä checking status score decline...');

        if (days.length < THRESHOLDS.STATUS_SCORE_DECLINE_DAYS) {
            console.log('ews / detect ‚è≠Ô∏è skip: insufficient days', days.length, '<', THRESHOLDS.STATUS_SCORE_DECLINE_DAYS);
            return null;
        }

        // Get Status Score for recent days
        const recentDays = days.slice(-7); // Most recent 7 days
        const statusScores = [];

        for (const day of recentDays) {
            // Try to get cached status or calculate
            let status = null;

            if (day.statusScore !== undefined) {
                status = day.statusScore;
            } else if (day._statusCalculated && day._statusCalculated.score !== undefined) {
                status = day._statusCalculated.score;
            } else if (typeof HEYS !== 'undefined' && HEYS.Status && typeof HEYS.Status.calculate === 'function') {
                // Try to calculate status Score on the fly
                try {
                    const result = HEYS.Status.calculate({ dayData: day });
                    if (result && result.score !== undefined) {
                        status = result.score;
                    }
                } catch (e) {
                    console.warn('ews / detect ‚ö†Ô∏è failed to calculate status for day', day.date, e.message);
                }
            }

            if (status !== null && status !== undefined) {
                statusScores.push({
                    date: day.date,
                    score: status
                });
            }
        }

        console.log(`ews / detect üìä collected ${statusScores.length} status scores from ${recentDays.length} days`);

        if (statusScores.length < THRESHOLDS.STATUS_SCORE_DECLINE_DAYS) {
            console.log('ews / detect ‚è≠Ô∏è skip: not enough status scores', statusScores.length, '<', THRESHOLDS.STATUS_SCORE_DECLINE_DAYS);
            return null;
        }

        // Check consecutive decline
        const recent = statusScores.slice(-THRESHOLDS.STATUS_SCORE_DECLINE_DAYS);
        const scores = recent.map(d => d.score);
        const isDecline = isConsecutiveDecline(scores, THRESHOLDS.STATUS_SCORE_DECLINE_DAYS);

        console.log(`ews / detect üìä status scores (${recent.length}d):`, scores.map(s => Math.round(s)));

        if (isDecline) {
            const totalDrop = scores[0] - scores[scores.length - 1];
            const avgDailyDrop = calculateDeclineRate(scores);

            console.log(`ews / detect üìâ decline detected: totalDrop=${totalDrop.toFixed(1)}, avgDaily=${avgDailyDrop.toFixed(1)}`);

            if (totalDrop >= THRESHOLDS.STATUS_SCORE_MIN_DELTA) {
                const startScore = Math.round(scores[0]);
                const endScore = Math.round(scores[scores.length - 1]);

                const humanMsg = WARNING_HUMAN_MESSAGES.STATUS_SCORE_DECLINE;

                const warning = {
                    type: 'STATUS_SCORE_DECLINE',
                    severity: totalDrop >= 20 ? 'high' : (totalDrop >= 15 ? 'medium' : 'low'),
                    days: THRESHOLDS.STATUS_SCORE_DECLINE_DAYS,
                    startScore,
                    endScore,
                    totalDrop: Math.round(totalDrop),
                    avgDailyDrop: Math.round(avgDailyDrop * 10) / 10,
                    patternName: humanMsg.title,
                    message: `üìä ${humanMsg.title}`,
                    detail: `–° ${startScore} –¥–æ ${endScore} (–ø–∞–¥–µ–Ω–∏–µ ${Math.round(totalDrop)} –±–∞–ª–ª–æ–≤ –∑–∞ ${THRESHOLDS.STATUS_SCORE_DECLINE_DAYS} –¥–Ω—è)`,
                    insight: humanMsg.insight,
                    science: humanMsg.science,
                    currentScore: endScore,
                    actionable: true
                };

                console.log(`ews / detect ‚úÖ STATUS_SCORE_DECLINE warning: severity=${warning.severity}, drop=${warning.totalDrop}`);
                return warning;
            }
        }

        console.log('ews / detect ‚ûñ no status score decline detected');
        return null;
    }

    /**
     * Warning 4: Sleep debt accumulation
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkSleepDebt(days, profile) {
        console.log('ews / detect üõå checking sleep debt...');
        if (days.length < THRESHOLDS.SLEEP_DEFICIT_DAYS) {
            console.log('ews / detect ‚è≠Ô∏è skip: insufficient days', days.length, '<', THRESHOLDS.SLEEP_DEFICIT_DAYS);
            return null;
        }

        const targetSleep = profile?.sleepHours || 8;
        const recentDays = days.slice(-7); // Most recent first

        const sleepData = recentDays.map(day => {
            const sleep = day.sleepHours || (day.sleepStart && day.sleepEnd
                ? calculateSleepHours(day.sleepStart, day.sleepEnd)
                : null);
            return { date: day.date, sleep, deficit: sleep ? Math.max(0, targetSleep - sleep) : 0 };
        }).filter(d => d.sleep !== null);

        if (sleepData.length < THRESHOLDS.SLEEP_DEFICIT_DAYS) {
            console.log('ews / detect ‚è≠Ô∏è skip: not enough sleep data after filter', sleepData.length, '<', THRESHOLDS.SLEEP_DEFICIT_DAYS);
            return null;
        }

        // Check last N consecutive days (most recent first)
        const recent = sleepData.slice(0, THRESHOLDS.SLEEP_DEFICIT_DAYS);
        const allDeficit = recent.every(d => d.sleep < THRESHOLDS.SLEEP_DEFICIT_HOURS);

        console.log(`ews / detect üìä sleep stats: recent=${recent.length}d, avgSleep=${(recent.reduce((s, d) => s + d.sleep, 0) / recent.length).toFixed(1)}h, target=${targetSleep}h, allDeficit=${allDeficit}`);

        if (allDeficit) {
            const totalDeficit = recent.reduce((sum, d) => sum + d.deficit, 0);
            const avgSleep = recent.reduce((sum, d) => sum + d.sleep, 0) / recent.length;

            const humanMsg = WARNING_HUMAN_MESSAGES.SLEEP_DEBT;

            // Sleep quality score: 0-100 based on how close to target
            // If avgSleep < target: score shows percentage of target met
            // If avgSleep >= target: score is 100 (fully met)
            const sleepQualityScore = Math.min(100, Math.round((avgSleep / targetSleep) * 100));

            const warning = {
                type: 'SLEEP_DEBT',
                severity: totalDeficit > 6 ? 'high' : 'medium',
                days: THRESHOLDS.SLEEP_DEFICIT_DAYS,
                avgSleep: Math.round(avgSleep * 10) / 10,
                targetSleep,
                totalDeficit: Math.round(totalDeficit * 10) / 10,
                patternName: humanMsg.title,
                message: `üí§ ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω–∏–π —Å–æ–Ω: ${Math.round(avgSleep * 10) / 10}—á (—Ü–µ–ª—å: ${targetSleep}—á), –¥–µ—Ñ–∏—Ü–∏—Ç: ${Math.round(totalDeficit * 10) / 10}—á`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: sleepQualityScore,
                actionable: true
            };
            console.log(`ews / detect ‚úÖ SLEEP_DEBT warning: severity=${warning.severity}, totalDeficit=${warning.totalDeficit}h`);
            return warning;
        }

        console.log('ews / detect ‚ûñ no sleep debt detected');
        return null;
    }

    /**
     * Warning 4: Caloric debt accumulation
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object|null}
     */
    function checkCaloricDebt(days, profile, pIndex) {
        console.log('ews / detect üçΩÔ∏è checking caloric debt...');
        if (days.length < THRESHOLDS.CALORIC_DEBT_DAYS) {
            console.log('ews / detect ‚è≠Ô∏è skip: insufficient days', days.length, '<', THRESHOLDS.CALORIC_DEBT_DAYS);
            return null;
        }

        const calculateItemKcal = HEYS.InsightsPI?.calculations?.calculateItemKcal;
        if (!calculateItemKcal) {
            console.warn('ews / detect ‚è≠Ô∏è skip: calculateItemKcal not available');
            return null;
        }

        const recentDays = days.slice(-7); // Most recent first
        const optimum = profile?.optimum || profile?.norm?.kcal || 2000;

        const caloricData = recentDays.map(day => {
            let eaten = day.savedEatenKcal || 0;

            if (!eaten && day.meals) {
                eaten = day.meals.reduce((sum, meal) => {
                    if (!meal.items) return sum;
                    return sum + meal.items.reduce((mealSum, item) => {
                        return mealSum + calculateItemKcal(item, pIndex);
                    }, 0);
                }, 0);
            }

            const debt = Math.max(0, optimum - eaten);
            return { date: day.date, eaten, optimum, debt };
        });

        // Check last N consecutive days (most recent first)
        const recent = caloricData.slice(0, THRESHOLDS.CALORIC_DEBT_DAYS);
        const totalDebt = recent.reduce((sum, d) => sum + d.debt, 0);

        console.log(`ews / detect üìä caloric stats: recent=${recent.length}d, optimum=${optimum}kcal, totalDebt=${Math.round(totalDebt)}kcal, threshold=${THRESHOLDS.CALORIC_DEBT_THRESHOLD}kcal`);

        if (totalDebt > THRESHOLDS.CALORIC_DEBT_THRESHOLD) {
            const avgEaten = recent.reduce((sum, d) => sum + d.eaten, 0) / recent.length;
            const avgDebt = totalDebt / recent.length;

            const humanMsg = WARNING_HUMAN_MESSAGES.CALORIC_DEBT;

            // Caloric intake score: 0-100 based on how close to optimum
            // Shows percentage of target calories consumed
            const calorieIntakeScore = Math.min(100, Math.round((avgEaten / optimum) * 100));

            const warning = {
                type: 'CALORIC_DEBT',
                severity: totalDebt > 2500 ? 'high' : 'medium',
                days: THRESHOLDS.CALORIC_DEBT_DAYS,
                avgEaten: Math.round(avgEaten),
                optimum,
                totalDebt: Math.round(totalDebt),
                avgDebt: Math.round(avgDebt),
                patternName: humanMsg.title,
                message: `üçΩÔ∏è ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω–∏–π –Ω–µ–¥–æ–±–æ—Ä: ${Math.round(avgDebt)} –∫–∫–∞–ª/–¥–µ–Ω—å (–≤—Å–µ–≥–æ ${Math.round(totalDebt)} –∫–∫–∞–ª)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: calorieIntakeScore,
                actionable: true
            };
            console.log(`ews / detect ‚úÖ CALORIC_DEBT warning: severity=${warning.severity}, totalDebt=${warning.totalDebt}kcal`);
            return warning;
        }

        console.log('ews / detect ‚ûñ no caloric debt detected');
        return null;
    }

    /**
     * Warning 6: Weight spike (Tier 1 ‚Äî v2.0)
     * Detects rapid weight gain (1+ kg in 1-2 days)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkWeightSpike(days, profile) {
        console.info('ews / detect üîç checking weight spike...');
        if (days.length < 3) {
            console.info('ews / detect ‚è≠Ô∏è skip weight spike: insufficient days', days.length);
            return null;
        }

        const recentDays = days.slice(-3).reverse(); // Most recent first
        const weightData = recentDays
            .map(day => ({
                date: day.date,
                weight: day.weightMorning || null
            }))
            .filter(d => d.weight !== null && d.weight > 0);

        if (weightData.length < 2) {
            console.info('ews / detect ‚è≠Ô∏è skip weight spike: insufficient weight data', weightData.length);
            return null;
        }

        // Check difference between most recent and previous
        const current = weightData[0].weight;
        const previous = weightData[1].weight;
        const delta = current - previous;
        const daysDiff = 1; // –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ: —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –∑–∞ 1-2 –¥–Ω—è

        console.info('ews / detect üìä weight data:', {
            current: current.toFixed(1),
            previous: previous.toFixed(1),
            delta: delta.toFixed(2),
            daysDiff
        });

        // Threshold: +1 kg or more
        if (delta >= 1.0) {
            const humanMsg = WARNING_HUMAN_MESSAGES.WEIGHT_SPIKE;
            const percentChange = Math.round((delta / previous) * 100 * 10) / 10;

            // Score: 100 = no spike, lower = bigger spike
            // Formula: max(0, 100 - (delta * 30)) where delta in kg
            const spikeScore = Math.max(0, Math.round(100 - (delta * 30)));

            const warning = {
                type: 'WEIGHT_SPIKE',
                severity: delta >= 1.5 ? 'high' : 'medium',
                delta: Math.round(delta * 10) / 10,
                current: Math.round(current * 10) / 10,
                previous: Math.round(previous * 10) / 10,
                percentChange,
                patternName: humanMsg.title,
                message: `‚öñÔ∏è ${humanMsg.title}`,
                detail: `–í–µ—Å –≤—ã—Ä–æ—Å —Å ${previous.toFixed(1)} –¥–æ ${current.toFixed(1)} –∫–≥ (+${delta.toFixed(1)} –∫–≥, +${percentChange}%)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: spikeScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ WEIGHT_SPIKE warning:', {
                severity: warning.severity,
                delta: warning.delta,
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no weight spike detected');
        return null;
    }

    /**
     * Warning 7: Hydration deficit (Tier 1 ‚Äî v2.0)
     * Detects consistently low water intake (<1.5L for 3+ days)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkHydrationDeficit(days, profile) {
        console.info('ews / detect üíß checking hydration deficit...');
        if (days.length < 3) {
            console.info('ews / detect ‚è≠Ô∏è skip hydration: insufficient days', days.length);
            return null;
        }

        const targetWater = profile?.waterTarget || 2000; // ml
        const minThreshold = 1500; // ml (critical minimum)
        const consecutiveDays = 3;

        const recentDays = days.slice(-7); // Check last week
        const hydrationData = recentDays
            .map(day => ({
                date: day.date,
                water: day.waterMl || 0
            }))
            .filter(d => d.water >= 0); // Keep even 0 values (logged but no water)

        if (hydrationData.length < consecutiveDays) {
            console.info('ews / detect ‚è≠Ô∏è skip hydration: insufficient data', hydrationData.length);
            return null;
        }

        // Check last N consecutive days
        const recent = hydrationData.slice(-consecutiveDays);
        const allBelowThreshold = recent.every(d => d.water < minThreshold);

        console.info('ews / detect üìä hydration data:', {
            recent: recent.length,
            avgWater: Math.round(recent.reduce((s, d) => s + d.water, 0) / recent.length),
            target: targetWater,
            threshold: minThreshold,
            allBelow: allBelowThreshold
        });

        if (allBelowThreshold) {
            const avgWater = recent.reduce((s, d) => s + d.water, 0) / recent.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.HYDRATION_DEFICIT;

            // Score: 0-100 based on % of target met
            const hydrationScore = Math.min(100, Math.round((avgWater / targetWater) * 100));

            const warning = {
                type: 'HYDRATION_DEFICIT',
                severity: avgWater < 1000 ? 'high' : 'medium',
                days: consecutiveDays,
                avgWater: Math.round(avgWater),
                targetWater,
                deficit: Math.round(targetWater - avgWater),
                patternName: humanMsg.title,
                message: `üíß ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º: ${Math.round(avgWater)} –º–ª (—Ü–µ–ª—å: ${targetWater} –º–ª, –¥–µ—Ñ–∏—Ü–∏—Ç: ${Math.round(targetWater - avgWater)} –º–ª)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: hydrationScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ HYDRATION_DEFICIT warning:', {
                severity: warning.severity,
                avgWater: warning.avgWater,
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no hydration deficit detected');
        return null;
    }

    /**
     * Warning 8: Logging gap (Tier 1 ‚Äî v2.0)
     * Detects missing food diary entries (2+ consecutive days)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkLoggingGap(days, profile) {
        console.info('ews / detect üìù checking logging gap...');
        if (days.length < 2) {
            console.info('ews / detect ‚è≠Ô∏è skip logging gap: insufficient days', days.length);
            return null;
        }

        const minConsecutiveGap = 2;
        const recentDays = days.slice(-7); // Check last week

        // Determine if a day has meaningful food logging
        const loggingData = recentDays.map(day => {
            const hasMeals = day.meals && day.meals.length > 0;
            const hasItems = hasMeals && day.meals.some(meal => meal.items && meal.items.length > 0);
            const logged = hasItems || (day.savedEatenKcal && day.savedEatenKcal > 0);
            return {
                date: day.date,
                logged
            };
        });

        // Find consecutive gaps (most recent first)
        let consecutiveGap = 0;
        const reversed = loggingData.slice().reverse();
        for (const entry of reversed) {
            if (!entry.logged) {
                consecutiveGap++;
            } else {
                break; // Stop at first logged day
            }
        }

        console.info('ews / detect üìä logging data:', {
            totalDays: loggingData.length,
            loggedDays: loggingData.filter(d => d.logged).length,
            consecutiveGap,
            threshold: minConsecutiveGap
        });

        if (consecutiveGap >= minConsecutiveGap) {
            const humanMsg = WARNING_HUMAN_MESSAGES.LOGGING_GAP;

            // Score: 100 = no gap, decreases with gap size
            // Formula: max(0, 100 - (gap * 20))
            const consistencyScore = Math.max(0, Math.round(100 - (consecutiveGap * 20)));

            const warning = {
                type: 'LOGGING_GAP',
                severity: consecutiveGap >= 4 ? 'high' : 'medium',
                consecutiveGap,
                patternName: humanMsg.title,
                message: `üìù ${humanMsg.title}`,
                detail: `–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π ${consecutiveGap} ${consecutiveGap === 2 ? '–¥–Ω—è' : '–¥–Ω–µ–π'} –ø–æ–¥—Ä—è–¥`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: consistencyScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ LOGGING_GAP warning:', {
                severity: warning.severity,
                gap: warning.consecutiveGap,
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no logging gap detected');
        return null;
    }

    /**
     * Warning 9: Protein deficit (Tier 2 ‚Äî v2.0)
     * Detects insufficient protein intake (<1.2 g/kg for 3+ days)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object|null}
     */
    function checkProteinDeficit(days, profile, pIndex) {
        // v2.0: Phenotype-aware protein target
        const proteinMultiplier = getEwsThreshold('proteinTarget', 1.0, profile);
        const targetProtein = 1.2 * proteinMultiplier; // g/kg (minimum for muscle preservation)

        console.info('ews / detect ü•© checking protein deficit...', {
            proteinMultiplier,
            targetProtein: targetProtein.toFixed(2)
        });

        if (days.length < 3) {
            console.info('ews / detect ‚è≠Ô∏è skip protein: insufficient days', days.length);
            return null;
        }

        const weight = profile?.weight || 70;
        // targetProtein defined at start of function
        const minProteinGrams = weight * targetProtein;
        const consecutiveDays = 3;

        const recentDays = days.slice(-7);
        const proteinData = recentDays.map(day => {
            const protein = day.savedEatenProt || 0;
            return {
                date: day.date,
                protein,
                deficit: protein < minProteinGrams
            };
        }).filter(d => d.protein > 0); // Only days with data

        if (proteinData.length < consecutiveDays) {
            console.info('ews / detect ‚è≠Ô∏è skip protein: insufficient data', proteinData.length);
            return null;
        }

        const recent = proteinData.slice(-consecutiveDays);
        const allDeficit = recent.every(d => d.deficit);

        console.info('ews / detect üìä protein data:', {
            recent: recent.length,
            avgProtein: Math.round(recent.reduce((s, d) => s + d.protein, 0) / recent.length),
            target: Math.round(minProteinGrams),
            allDeficit
        });

        if (allDeficit) {
            const avgProtein = recent.reduce((s, d) => s + d.protein, 0) / recent.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.PROTEIN_DEFICIT;

            // Score: 0-100 based on % of target met
            const proteinScore = Math.min(100, Math.round((avgProtein / minProteinGrams) * 100));

            const warning = {
                type: 'PROTEIN_DEFICIT',
                severity: avgProtein < (minProteinGrams * 0.8) ? 'high' : 'medium',
                days: consecutiveDays,
                avgProtein: Math.round(avgProtein),
                targetProtein: Math.round(minProteinGrams),
                deficit: Math.round(minProteinGrams - avgProtein),
                patternName: humanMsg.title,
                message: `ü•© ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω–∏–π –±–µ–ª–æ–∫: ${Math.round(avgProtein)}–≥ (—Ü–µ–ª—å: ${Math.round(minProteinGrams)}–≥, –¥–µ—Ñ–∏—Ü–∏—Ç: ${Math.round(minProteinGrams - avgProtein)}–≥)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: proteinScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ PROTEIN_DEFICIT warning:', {
                severity: warning.severity,
                avgProtein: warning.avgProtein,
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no protein deficit detected');
        return null;
    }

    /**
     * Warning 10: Stress accumulation (Tier 2 ‚Äî v2.0)
     * Detects high stress without recovery (stress score or low recovery days)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkStressAccumulation(days, profile) {
        // v2.0: Phenotype-aware sensitivity
        const sensitivity = getEwsThreshold('stressEatingThreshold', 1.0, profile);
        // Lower limit = higher sensitivity
        const STRESS_LEVEL_LIMIT = 7 * sensitivity; // e.g. 5.6 for stress_eater
        const STATUS_SCORE_LIMIT = 50 / sensitivity; // e.g. 62.5 for stress_eater (easier to satisfy <62.5)

        console.info('ews / detect üò∞ checking stress accumulation...', {
            sensitivity,
            limits: { stress: STRESS_LEVEL_LIMIT.toFixed(1), status: STATUS_SCORE_LIMIT.toFixed(0) }
        });

        if (days.length < 5) {
            console.info('ews / detect ‚è≠Ô∏è skip stress: insufficient days', days.length);
            return null;
        }

        const recentDays = days.slice(-7);
        const stressData = recentDays.map(day => {
            // Multiple signals of stress:
            // 1. Explicit stress field
            const explicitStress = day.stress || 0;
            // 2. Poor sleep (<6h)
            const poorSleep = day.sleepHours && day.sleepHours < 6;
            // 3. High training load without recovery
            const highTraining = day.training && day.training.duration > 90;
            // 4. Low status score (<50 or dynamic)
            const lowStatus = day.statusScore !== undefined && day.statusScore < STATUS_SCORE_LIMIT;

            const stressSignals = [
                explicitStress > STRESS_LEVEL_LIMIT,
                poorSleep,
                highTraining,
                lowStatus
            ].filter(Boolean).length;

            return {
                date: day.date,
                stressLevel: explicitStress,
                stressSignals,
                highStress: stressSignals >= 2
            };
        });

        // Check for 3+ days with 2+ stress signals
        const consecutiveStress = 3;
        const recent = stressData.slice(-consecutiveStress);
        const highStressDays = recent.filter(d => d.highStress).length;

        console.info('ews / detect üìä stress data:', {
            recent: recent.length,
            highStressDays,
            avgSignals: (recent.reduce((s, d) => s + d.stressSignals, 0) / recent.length).toFixed(1),
            threshold: consecutiveStress
        });

        if (highStressDays >= consecutiveStress) {
            const avgStressLevel = recent.reduce((s, d) => s + d.stressLevel, 0) / recent.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.STRESS_ACCUMULATION;

            // Score: 100 = no stress, decreases with stress signals
            const avgSignals = recent.reduce((s, d) => s + d.stressSignals, 0) / recent.length;
            const recoveryScore = Math.max(0, Math.round(100 - (avgSignals * 25)));

            const warning = {
                type: 'STRESS_ACCUMULATION',
                severity: avgSignals >= 3 ? 'high' : 'medium',
                days: highStressDays,
                avgStressLevel: Math.round(avgStressLevel),
                avgSignals: Math.round(avgSignals * 10) / 10,
                patternName: humanMsg.title,
                message: `üò∞ ${humanMsg.title}`,
                detail: `${highStressDays} –¥–Ω–µ–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ —Å—Ç—Ä–µ—Å—Å–∞ (—Å–æ–Ω, –Ω–∞–≥—Ä—É–∑–∫–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: recoveryScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ STRESS_ACCUMULATION warning:', {
                severity: warning.severity,
                highStressDays: warning.days,
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no stress accumulation detected');
        return null;
    }

    /**
     * Warning 11: Meal skip pattern (Tier 2 ‚Äî v2.0)
     * Detects frequent meal skipping (irregular meal timing or missing meals)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkMealSkipPattern(days, profile) {
        // v2.0: Phenotype-aware tolerance
        const tolerance = getEwsThreshold('mealSkipTolerance', 1.0, profile);
        const GAP_THRESHOLD = 8 * tolerance; // Base 8h

        console.info('ews / detect üçΩÔ∏è checking meal skip pattern...', {
            tolerance,
            GAP_THRESHOLD
        });

        if (days.length < 5) {
            console.info('ews / detect ‚è≠Ô∏è skip meal pattern: insufficient days', days.length);
            return null;
        }

        const recentDays = days.slice(-7);
        const mealData = recentDays.map(day => {
            const meals = day.meals || [];
            const mealCount = meals.length;
            const hasMeals = mealCount > 0;

            // Check for long gaps (>8h) between meals
            let longGaps = 0;
            if (meals.length >= 2) {
                for (let i = 1; i < meals.length; i++) {
                    const prevTime = meals[i - 1].time;
                    const currTime = meals[i].time;
                    if (prevTime && currTime) {
                        const gap = calculateTimeGap(prevTime, currTime); // Helper function
                        // v2.0: Use dynamic gap threshold
                        if (gap > GAP_THRESHOLD) longGaps++;
                    }
                }
            }

            const irregular = mealCount < 2 || longGaps > 0;

            return {
                date: day.date,
                mealCount,
                longGaps,
                irregular
            };
        }).filter(d => d.mealCount > 0); // Only days with logged meals

        if (mealData.length < 5) {
            console.info('ews / detect ‚è≠Ô∏è skip meal pattern: insufficient meal data', mealData.length);
            return null;
        }

        const irregularDays = mealData.filter(d => d.irregular).length;
        const irregularRate = irregularDays / mealData.length;

        console.info('ews / detect üìä meal pattern data:', {
            totalDays: mealData.length,
            irregularDays,
            irregularRate: (irregularRate * 100).toFixed(0) + '%',
            threshold: '60%'
        });

        // Warning if >60% of days have irregular patterns
        if (irregularRate > 0.6 * tolerance) {
            const avgMealCount = mealData.reduce((s, d) => s + d.mealCount, 0) / mealData.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.MEAL_SKIP_PATTERN;

            // Score: 100 = regular, decreases with irregularity
            const regularityScore = Math.max(0, Math.round((1 - irregularRate) * 100));

            const warning = {
                type: 'MEAL_SKIP_PATTERN',
                severity: irregularRate > 0.8 ? 'high' : 'medium',
                irregularDays,
                totalDays: mealData.length,
                irregularRate: Math.round(irregularRate * 100),
                avgMealCount: Math.round(avgMealCount * 10) / 10,
                patternName: humanMsg.title,
                message: `üçΩÔ∏è ${humanMsg.title}`,
                detail: `${irregularDays} –∏–∑ ${mealData.length} –¥–Ω–µ–π —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ –∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏ (>8—á)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: regularityScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ MEAL_SKIP_PATTERN warning:', {
                severity: warning.severity,
                irregularRate: warning.irregularRate + '%',
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no meal skip pattern detected');
        return null;
    }

    /**
     * Warning 12: Binge risk (Tier 2 ‚Äî v2.0)
     * Detects binge eating patterns (large portions after long gaps)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object|null}
     */
    function checkBingeRisk(days, profile, pIndex) {
        // v5.0: Phenotype-aware binge sensitivity
        const bingeLimitMultiplier = getEwsThreshold('bingeVolume', 1.0, profile);
        const SINGLE_MEAL_PERCENT = 40 * bingeLimitMultiplier; // default 40%
        const EXTREME_OVEREAT_PERCENT = 1.5 * bingeLimitMultiplier; // default 150%

        console.info('ews / detect üçî checking binge risk...', {
            bingeLimitMultiplier,
            SINGLE_MEAL_PERCENT: `${SINGLE_MEAL_PERCENT}%`,
            EXTREME_OVEREAT_PERCENT: `${(EXTREME_OVEREAT_PERCENT * 100).toFixed(0)}%`
        });

        if (days.length < 5) {
            console.info('ews / detect ‚è≠Ô∏è skip binge: insufficient days', days.length);
            return null;
        }

        const calculateItemKcal = HEYS.InsightsPI?.calculations?.calculateItemKcal;
        if (!calculateItemKcal) {
            console.info('ews / detect ‚è≠Ô∏è skip binge: calculateItemKcal not available');
            return null;
        }

        const optimum = profile?.optimum || profile?.norm?.kcal || 2000;
        const recentDays = days.slice(-7);

        const bingeData = recentDays.map(day => {
            const meals = day.meals || [];
            let bingeMeals = 0;

            // Check each meal for binge characteristics:
            // 1. Large meal (>40% daily optimum in one meal)
            // 2. Multiple large meals in same day
            meals.forEach(meal => {
                if (!meal.items) return;
                const mealKcal = meal.items.reduce((sum, item) => sum + calculateItemKcal(item, pIndex), 0);
                const mealPercent = (mealKcal / optimum) * 100;
                if (mealPercent > SINGLE_MEAL_PERCENT) {
                    bingeMeals++;
                }
            });

            const totalKcal = day.savedEatenKcal || meals.reduce((sum, meal) => {
                if (!meal.items) return sum;
                return sum + meal.items.reduce((mealSum, item) => mealSum + calculateItemKcal(item, pIndex), 0);
            }, 0);

            // Binge indicators:
            // - 2+ large meals in one day
            // - OR single huge meal (>50% optimum)
            // - OR extreme overeating (>150% optimum) after restriction
            const extremeOvereat = totalKcal > (optimum * EXTREME_OVEREAT_PERCENT);
            const bingeDay = bingeMeals >= 2 || extremeOvereat;

            return {
                date: day.date,
                bingeMeals,
                totalKcal,
                bingeDay
            };
        }).filter(d => d.totalKcal > 0);

        if (bingeData.length < 3) {
            console.info('ews / detect ‚è≠Ô∏è skip binge: insufficient data', bingeData.length);
            return null;
        }

        const bingeDays = bingeData.filter(d => d.bingeDay).length;
        const bingeRate = bingeDays / bingeData.length;

        console.info('ews / detect üìä binge data:', {
            totalDays: bingeData.length,
            bingeDays,
            bingeRate: (bingeRate * 100).toFixed(0) + '%',
            threshold: '30%'
        });

        // Warning if >30% of days show binge patterns
        if (bingeRate > 0.3) {
            const avgBingeMeals = bingeData.reduce((s, d) => s + d.bingeMeals, 0) / bingeData.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.BINGE_RISK;

            // Score: 100 = no binge, decreases with binge frequency
            const controlScore = Math.max(0, Math.round((1 - bingeRate) * 100));

            const warning = {
                type: 'BINGE_RISK',
                severity: bingeRate > 0.5 ? 'high' : 'medium',
                bingeDays,
                totalDays: bingeData.length,
                bingeRate: Math.round(bingeRate * 100),
                avgBingeMeals: Math.round(avgBingeMeals * 10) / 10,
                patternName: humanMsg.title,
                message: `üçî ${humanMsg.title}`,
                detail: `${bingeDays} –∏–∑ ${bingeData.length} –¥–Ω–µ–π —Å –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è (–∫—Ä—É–ø–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏ >40% –Ω–æ—Ä–º—ã)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: controlScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ BINGE_RISK warning:', {
                severity: warning.severity,
                bingeRate: warning.bingeRate + '%',
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no binge risk detected');
        return null;
    }

    /**
     * Warning 13: Mood/wellbeing decline (Tier 3 ‚Äî v3.0)
     * Detects prolonged mood or wellbeing decline (7+ days)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkMoodWellbeingDecline(days, profile) {
        console.info('ews / detect üòî checking mood/wellbeing decline...');
        if (days.length < 7) {
            console.info('ews / detect ‚è≠Ô∏è skip mood: insufficient days', days.length);
            return null;
        }

        const recentDays = days.slice(-14); // Check last 2 weeks
        const moodData = recentDays.map(day => ({
            date: day.date,
            mood: day.mood || null,
            wellbeing: day.wellbeing || null,
            energy: day.energy || null
        })).filter(d => d.mood !== null || d.wellbeing !== null || d.energy !== null);

        if (moodData.length < 7) {
            console.info('ews / detect ‚è≠Ô∏è skip mood: insufficient mood data', moodData.length);
            return null;
        }

        // Check for consecutive decline trend (7+ days)
        const recent = moodData.slice(-7);
        const avgMood = recent.filter(d => d.mood !== null).length > 0
            ? recent.filter(d => d.mood !== null).reduce((s, d) => s + d.mood, 0) / recent.filter(d => d.mood !== null).length
            : null;

        const avgWellbeing = recent.filter(d => d.wellbeing !== null).length > 0
            ? recent.filter(d => d.wellbeing !== null).reduce((s, d) => s + d.wellbeing, 0) / recent.filter(d => d.wellbeing !== null).length
            : null;

        console.info('ews / detect üìä mood data:', {
            recent: recent.length,
            avgMood: avgMood !== null ? avgMood.toFixed(1) : 'N/A',
            avgWellbeing: avgWellbeing !== null ? avgWellbeing.toFixed(1) : 'N/A',
            threshold: '< 5.0'
        });

        // Warning if average mood or wellbeing <5 over 7 days (scale 1-10)
        const lowMood = avgMood !== null && avgMood < 5;
        const lowWellbeing = avgWellbeing !== null && avgWellbeing < 5;

        if (lowMood || lowWellbeing) {
            const humanMsg = WARNING_HUMAN_MESSAGES.MOOD_WELLBEING_DECLINE;
            const score = avgMood !== null ? Math.round(avgMood * 10) : Math.round(avgWellbeing * 10);

            const warning = {
                type: 'MOOD_WELLBEING_DECLINE',
                severity: score < 40 ? 'high' : 'medium',
                days: 7,
                avgMood: avgMood !== null ? Math.round(avgMood * 10) / 10 : null,
                avgWellbeing: avgWellbeing !== null ? Math.round(avgWellbeing * 10) / 10 : null,
                patternName: humanMsg.title,
                message: `üòî ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å: ${avgMood !== null ? 'mood ' + avgMood.toFixed(1) : ''}${avgMood && avgWellbeing ? ', ' : ''}${avgWellbeing !== null ? 'wellbeing ' + avgWellbeing.toFixed(1) : ''} (–Ω–æ—Ä–º–∞: ‚â•5)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: score,
                actionable: true
            };
            console.info('ews / detect ‚úÖ MOOD_WELLBEING_DECLINE warning:', {
                severity: warning.severity,
                score: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no mood/wellbeing decline detected');
        return null;
    }

    /**
     * Warning 14: Weight plateau (Tier 3 ‚Äî v3.0)
     * Detects weight not changing for 14+ days when goal is weight loss
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @returns {object|null}
     */
    function checkWeightPlateau(days, profile) {
        console.info('ews / detect ‚öñÔ∏è checking weight plateau...');
        if (days.length < 14) {
            console.info('ews / detect ‚è≠Ô∏è skip plateau: insufficient days', days.length);
            return null;
        }

        // Only check if goal is weight loss
        const goal = profile?.goal;
        if (!goal || goal !== 'loss') {
            console.info('ews / detect ‚è≠Ô∏è skip plateau: goal is not weight loss', goal);
            return null;
        }

        const recentDays = days.slice(-21); // Check last 3 weeks
        const weightData = recentDays.map(day => ({
            date: day.date,
            weight: day.weightMorning || null
        })).filter(d => d.weight !== null && d.weight > 0);

        if (weightData.length < 14) {
            console.info('ews / detect ‚è≠Ô∏è skip plateau: insufficient weight data', weightData.length);
            return null;
        }

        // Check if weight variation is <1kg over 14 days
        const recent = weightData.slice(-14);
        const weights = recent.map(d => d.weight);
        const minWeight = Math.min(...weights);
        const maxWeight = Math.max(...weights);
        const variation = maxWeight - minWeight;

        console.info('ews / detect üìä weight plateau data:', {
            days: recent.length,
            minWeight: minWeight.toFixed(1),
            maxWeight: maxWeight.toFixed(1),
            variation: variation.toFixed(2),
            threshold: '< 1.0 kg'
        });

        // Warning if variation <1kg (plateau)
        if (variation < 1.0) {
            const humanMsg = WARNING_HUMAN_MESSAGES.WEIGHT_PLATEAU;
            const avgWeight = weights.reduce((s, w) => s + w, 0) / weights.length;

            // Score: lower = plateau (less variation)
            // 100 = normal progress (>2kg variation), 0 = complete plateau
            const progressScore = Math.min(100, Math.round(variation * 50));

            const warning = {
                type: 'WEIGHT_PLATEAU',
                severity: variation < 0.5 ? 'high' : 'medium',
                days: 14,
                variation: Math.round(variation * 100) / 100,
                avgWeight: Math.round(avgWeight * 10) / 10,
                patternName: humanMsg.title,
                message: `‚öñÔ∏è ${humanMsg.title}`,
                detail: `–í–µ—Å –∫–æ–ª–µ–±–ª–µ—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ${variation.toFixed(1)} –∫–≥ –∑–∞ 14 –¥–Ω–µ–π (—Å—Ä–µ–¥–Ω–µ–µ: ${avgWeight.toFixed(1)} –∫–≥)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: progressScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ WEIGHT_PLATEAU warning:', {
                severity: warning.severity,
                variation: warning.variation,
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no weight plateau detected');
        return null;
    }

    /**
     * Warning 15: Weekend pattern (Tier 3 ‚Äî v3.0)
     * Detects worse nutrition patterns on Sat/Sun (excess calories, alcohol, carbs)
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object|null}
     */
    function checkWeekendPattern(days, profile, pIndex) {
        console.info('ews / detect üçª checking weekend pattern...');
        if (days.length < 14) {
            console.info('ews / detect ‚è≠Ô∏è skip weekend: insufficient days', days.length);
            return null;
        }

        const calculateItemKcal = HEYS.InsightsPI?.calculations?.calculateItemKcal;
        if (!calculateItemKcal) {
            console.info('ews / detect ‚è≠Ô∏è skip weekend: calculateItemKcal not available');
            return null;
        }

        const optimum = profile?.optimum || profile?.norm?.kcal || 2000;
        const recentDays = days.slice(-21); // Last 3 weeks

        const weekdayData = [];
        const weekendData = [];

        recentDays.forEach(day => {
            const dayOfWeek = new Date(day.date).getDay(); // 0=Sun, 6=Sat
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

            let totalKcal = day.savedEatenKcal || 0;
            if (!totalKcal && day.meals) {
                totalKcal = day.meals.reduce((sum, meal) => {
                    if (!meal.items) return sum;
                    return sum + meal.items.reduce((mealSum, item) => mealSum + calculateItemKcal(item, pIndex), 0);
                }, 0);
            }

            const excessKcal = totalKcal > optimum ? totalKcal - optimum : 0;

            const dataPoint = {
                date: day.date,
                totalKcal,
                excessKcal,
                hasAlcohol: day.alcohol || false
            };

            if (isWeekend) {
                weekendData.push(dataPoint);
            } else {
                weekdayData.push(dataPoint);
            }
        });

        if (weekendData.length < 4 || weekdayData.length < 10) {
            console.info('ews / detect ‚è≠Ô∏è skip weekend: insufficient data', {
                weekendDays: weekendData.length,
                weekdays: weekdayData.length
            });
            return null;
        }

        const avgWeekendKcal = weekendData.reduce((s, d) => s + d.totalKcal, 0) / weekendData.length;
        const avgWeekdayKcal = weekdayData.reduce((s, d) => s + d.totalKcal, 0) / weekdayData.length;
        const weekendExcess = avgWeekendKcal - avgWeekdayKcal;
        const weekendExcessPercent = (weekendExcess / avgWeekdayKcal) * 100;

        const weekendAlcoholDays = weekendData.filter(d => d.hasAlcohol).length;
        const weekendAlcoholRate = weekendAlcoholDays / weekendData.length;

        console.info('ews / detect üìä weekend pattern data:', {
            avgWeekendKcal: Math.round(avgWeekendKcal),
            avgWeekdayKcal: Math.round(avgWeekdayKcal),
            weekendExcess: Math.round(weekendExcess),
            weekendExcessPercent: weekendExcessPercent.toFixed(0) + '%',
            alcoholRate: (weekendAlcoholRate * 100).toFixed(0) + '%',
            threshold: '+20% or alcohol >50%'
        });

        // Warning if weekend excess >20% OR alcohol >50% of weekends
        if (weekendExcessPercent > 20 || weekendAlcoholRate > 0.5) {
            const humanMsg = WARNING_HUMAN_MESSAGES.WEEKEND_PATTERN;

            // Score: 100 = consistent week, lower = worse weekends
            const consistencyScore = Math.max(0, Math.round(100 - weekendExcessPercent));

            const warning = {
                type: 'WEEKEND_PATTERN',
                severity: weekendExcessPercent > 30 || weekendAlcoholRate > 0.7 ? 'high' : 'medium',
                avgWeekendKcal: Math.round(avgWeekendKcal),
                avgWeekdayKcal: Math.round(avgWeekdayKcal),
                weekendExcess: Math.round(weekendExcess),
                weekendExcessPercent: Math.round(weekendExcessPercent),
                weekendAlcoholRate: Math.round(weekendAlcoholRate * 100),
                patternName: humanMsg.title,
                message: `üçª ${humanMsg.title}`,
                detail: `–í—ã—Ö–æ–¥–Ω—ã–µ: ${Math.round(avgWeekendKcal)} –∫–∫–∞–ª (–±—É–¥–Ω–∏: ${Math.round(avgWeekdayKcal)} –∫–∫–∞–ª, +${Math.round(weekendExcessPercent)}%), –∞–ª–∫–æ–≥–æ–ª—å: ${Math.round(weekendAlcoholRate * 100)}% –¥–Ω–µ–π`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                currentScore: consistencyScore,
                actionable: true
            };
            console.info('ews / detect ‚úÖ WEEKEND_PATTERN warning:', {
                severity: warning.severity,
                excess: warning.weekendExcessPercent + '%',
                currentScore: warning.currentScore
            });
            return warning;
        }

        console.info('ews / detect ‚ûñ no weekend pattern detected');
        return null;
    }

    // ========================================
    // Warning 16: Fiber deficit (v3.2)
    // ========================================
    function checkFiberDeficit(days, profile) {
        console.info('ews / detect check_16:', { name: 'FiberDeficit', days: days.length });

        const MIN_DAYS = 5;
        // v5.0: Phenotype-aware threshold
        const FIBER_THRESHOLD = getEwsThreshold('fiberTarget', 15, profile); // default 15g
        console.info('ews / detect üåæ fiber params:', { FIBER_THRESHOLD: `${FIBER_THRESHOLD}g` });

        if (days.length < MIN_DAYS) return null;

        const lowFiberDays = [];
        for (const day of days) {
            const fiber = day.dayTot?.fiber || 0;
            if (fiber < FIBER_THRESHOLD) {
                lowFiberDays.push({ date: day.date, fiber });
            }
        }

        if (lowFiberDays.length >= MIN_DAYS) {
            const avgFiber = lowFiberDays.reduce((sum, d) => sum + d.fiber, 0) / lowFiberDays.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.FIBER_DEFICIT;
            const fiberScore = Math.min(100, Math.round((avgFiber / 30) * 100)); // Optimal target: 30g
            console.info('ews / detect üî∂ FiberDeficit:', { lowDays: lowFiberDays.length, avgFiber: avgFiber.toFixed(1) });

            return {
                type: 'FIBER_DEFICIT',
                severity: 'medium',
                patternName: humanMsg.title,
                message: `üìä ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω—è—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞: ${avgFiber.toFixed(1)}–≥ (—Ü–µ–ª—å: ${FIBER_THRESHOLD}+–≥)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: lowFiberDays.map(d => d.date),
                metrics: {
                    avgFiber: Math.round(avgFiber * 10) / 10,
                    threshold: FIBER_THRESHOLD,
                    lowDays: lowFiberDays.length
                },
                currentScore: fiberScore,
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 17: Sodium excess (v3.2)
    // ========================================
    function checkSodiumExcess(days, profile) {
        console.info('ews / detect check_17:', { name: 'SodiumExcess', days: days.length });

        const MIN_DAYS = 3;
        // v5.0: Phenotype-aware threshold
        const SODIUM_THRESHOLD = getEwsThreshold('sodiumLimit', 4000, profile); // default 4000mg
        console.info('ews / detect üßÇ sodium params:', { SODIUM_THRESHOLD: `${SODIUM_THRESHOLD}mg` });

        if (days.length < MIN_DAYS) return null;

        const highSodiumDays = [];
        for (const day of days) {
            const sodium = day.dayTot?.sodium || 0;
            if (sodium > SODIUM_THRESHOLD) {
                highSodiumDays.push({ date: day.date, sodium });
            }
        }

        if (highSodiumDays.length >= MIN_DAYS) {
            const avgSodium = highSodiumDays.reduce((sum, d) => sum + d.sodium, 0) / highSodiumDays.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.SODIUM_EXCESS;
            const sodiumScore = Math.max(0, Math.round((1 - (avgSodium - 2300) / 2300) * 100)); // Optimal: 2300mg
            console.info('ews / detect üî∂ SodiumExcess:', { highDays: highSodiumDays.length, avgSodium: avgSodium.toFixed(0) });

            return {
                type: 'SODIUM_EXCESS',
                severity: 'medium',
                patternName: humanMsg.title,
                message: `üßÇ ${humanMsg.title}`,
                detail: `–°—Ä–µ–¥–Ω–∏–π –Ω–∞—Ç—Ä–∏–π: ${Math.round(avgSodium)} –º–≥ (—Ü–µ–ª—å: <${SODIUM_THRESHOLD} –º–≥)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: highSodiumDays.map(d => d.date),
                metrics: {
                    avgSodium: Math.round(avgSodium),
                    threshold: SODIUM_THRESHOLD,
                    highDays: highSodiumDays.length
                },
                currentScore: sodiumScore,
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 18: Circadian disruption (v3.2)
    // ========================================
    function checkCircadianDisruption(days, profile) {
        console.info('ews / detect check_18:', { name: 'CircadianDisruption', days: days.length });

        const MIN_DAYS = 7;

        // v5.0: Phenotype-aware late meal threshold
        const lateHourDecimal = getEwsThreshold('lateEatingHour', 22.0, profile); // default 22:00
        const lateH = Math.floor(lateHourDecimal);
        const lateM = Math.round((lateHourDecimal % 1) * 60);
        const LATE_MEAL_TIME = `${String(lateH).padStart(2, '0')}:${String(lateM).padStart(2, '0')}`;

        const varianceThresholdBase = 2.0;
        // Apply sleep variability multiplier (if defined in phenotype)
        const SLEEP_VARIANCE_THRESHOLD = getEwsThreshold('sleepVariabilityHours', varianceThresholdBase, profile);
        console.info('ews / detect üåô circadian params:', { LATE_MEAL_TIME, SLEEP_VARIANCE_THRESHOLD: `${SLEEP_VARIANCE_THRESHOLD}h` });

        if (days.length < MIN_DAYS) return null;

        let lateMealCount = 0;
        const sleepTimes = [];

        for (const day of days) {
            // Check for late meals
            if (day.meals && Array.isArray(day.meals)) {
                for (const meal of day.meals) {
                    if (meal.time && meal.time >= LATE_MEAL_TIME) {
                        lateMealCount++;
                        break; // Count day once
                    }
                }
            }

            // Check sleep time
            if (day.sleep?.time) {
                const [h, m] = day.sleep.time.split(':').map(Number);
                sleepTimes.push(h + m / 60);
            }
        }

        const lateMealRatio = lateMealCount / days.length;

        let sleepVariance = 0;
        if (sleepTimes.length >= 3) {
            const avgSleep = sleepTimes.reduce((sum, t) => sum + t, 0) / sleepTimes.length;
            const maxDiff = Math.max(...sleepTimes.map(t => Math.abs(t - avgSleep)));
            sleepVariance = maxDiff;
        }

        const isDisrupted = (lateMealRatio >= 4 / 7) || (sleepVariance > SLEEP_VARIANCE_THRESHOLD);

        if (isDisrupted) {
            const humanMsg = WARNING_HUMAN_MESSAGES.CIRCADIAN_DISRUPTION;
            const circadianScore = Math.max(0, Math.round(100 - (lateMealRatio * 100 + sleepVariance * 10)));
            console.info('ews / detect üî∂ CircadianDisruption:', {
                lateMeals: lateMealCount,
                lateMealRatio: lateMealRatio.toFixed(2),
                sleepVariance: sleepVariance.toFixed(1)
            });

            return {
                type: 'CIRCADIAN_DISRUPTION',
                severity: 'high',
                patternName: humanMsg.title,
                message: `üåô ${humanMsg.title}`,
                detail: `–ü–æ–∑–¥–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏: ${lateMealCount} –¥–Ω–µ–π, —Ä–∞–∑–±—Ä–æ—Å —Å–Ω–∞: ${sleepVariance.toFixed(1)}—á`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: days.map(d => d.date),
                metrics: {
                    lateMealCount,
                    sleepVariance: Math.round(sleepVariance * 10) / 10
                },
                currentScore: circadianScore,
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 19: Training without recovery (v3.2)
    // ========================================
    function checkTrainingWithoutRecovery(days, profile) {
        console.info('ews / detect check_19:', { name: 'TrainingWithoutRecovery', days: days.length });

        const MIN_DAYS = 5;
        const TRAINING_THRESHOLD = 3; // trainings in 5 days
        const SLEEP_THRESHOLD = 6.5; // hours
        const STRESS_THRESHOLD = 7;

        if (days.length < MIN_DAYS) return null;

        const recentDays = days.slice(-MIN_DAYS);
        let trainingCount = 0;
        let poorRecoveryCount = 0;

        for (const day of recentDays) {
            if (day.training?.duration && day.training.duration > 0) {
                trainingCount++;

                const sleepHours = calculateSleepHours(day.sleep?.duration);
                const stress = day.stress || 0;

                if (sleepHours < SLEEP_THRESHOLD || stress > STRESS_THRESHOLD) {
                    poorRecoveryCount++;
                }
            }
        }

        if (trainingCount >= TRAINING_THRESHOLD && poorRecoveryCount >= 2) {
            const humanMsg = WARNING_HUMAN_MESSAGES.TRAINING_WITHOUT_RECOVERY;
            const recoveryScore = Math.max(0, Math.round(100 - (poorRecoveryCount / trainingCount) * 100));
            console.info('ews / detect üî¥ TrainingWithoutRecovery:', {
                trainings: trainingCount,
                poorRecovery: poorRecoveryCount
            });

            return {
                type: 'TRAINING_WITHOUT_RECOVERY',
                severity: 'high',
                patternName: humanMsg.title,
                message: `üí™ ${humanMsg.title}`,
                detail: `${trainingCount} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ ${MIN_DAYS} –¥–Ω–µ–π –ø—Ä–∏ ${poorRecoveryCount} –¥–Ω—è—Ö –ø–ª–æ—Ö–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: recentDays.map(d => d.date),
                metrics: {
                    trainingCount,
                    poorRecoveryCount,
                    windowDays: MIN_DAYS
                },
                currentScore: recoveryScore,
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 20: Fat quality decline (v3.2)
    // ========================================
    function checkFatQualityDecline(days, profile, pIndex) {
        console.info('ews / detect check_20:', { name: 'FatQualityDecline', days: days.length });

        const MIN_DAYS = 7;
        const SCORE_THRESHOLD = 40;

        if (days.length < MIN_DAYS) return null;

        let lowScoreDays = 0;
        let totalScore = 0;

        for (const day of days) {
            const score = day.patterns?.omega_balancer?.score;
            if (typeof score === 'number') {
                totalScore += score;
                if (score < SCORE_THRESHOLD) {
                    lowScoreDays++;
                }
            }
        }

        if (lowScoreDays >= MIN_DAYS) {
            const avgScore = totalScore / days.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.FAT_QUALITY_DECLINE;
            console.info('ews / detect üî∂ FatQualityDecline:', { lowDays: lowScoreDays, avgScore: avgScore.toFixed(1) });

            return {
                type: 'FAT_QUALITY_DECLINE',
                severity: 'medium',
                patternName: humanMsg.title,
                message: `ü•ë ${humanMsg.title}`,
                detail: `Omega Balancer: ${Math.round(avgScore)} –±–∞–ª–ª–æ–≤ (—Ü–µ–ª—å: ${SCORE_THRESHOLD}+)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: days.map(d => d.date),
                metrics: {
                    avgScore: Math.round(avgScore),
                    threshold: SCORE_THRESHOLD,
                    lowDays: lowScoreDays
                },
                currentScore: Math.round(avgScore),
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 21: Sugar dependency (v3.2)
    // ========================================
    function checkSugarDependency(days, profile) {
        console.info('ews / detect check_21:', { name: 'SugarDependency', days: days.length });

        const MIN_DAYS = 7;

        // v5.0: Phenotype-aware sensitivity
        // Logic: Lower sugar limit (e.g. 0.5 multiplier for IR) -> Higher score threshold required
        // If multiplier < 1 (strict), we divide base threshold by it to raise the bar
        // Base threshold 35 / 0.5 = 70 (warn if score < 70)

        const sugarLimitMultiplier = getEwsThreshold('sugarLimit', 1.0, profile);
        const SCORE_THRESHOLD = Math.round(35 / (sugarLimitMultiplier > 0 ? sugarLimitMultiplier : 1));
        console.info('ews / detect üç¨ sugar params:', { sugarLimitMultiplier, SCORE_THRESHOLD });

        if (days.length < MIN_DAYS) return null;

        let lowScoreDays = 0;
        let totalScore = 0;

        for (const day of days) {
            const score = day.patterns?.added_sugar_dependency?.score;
            if (typeof score === 'number') {
                totalScore += score;
                if (score < SCORE_THRESHOLD) {
                    lowScoreDays++;
                }
            }
        }

        if (lowScoreDays >= MIN_DAYS) {
            const avgScore = totalScore / days.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.SUGAR_DEPENDENCY;
            console.info('ews / detect üî∂ SugarDependency:', { lowDays: lowScoreDays, avgScore: avgScore.toFixed(1) });

            return {
                type: 'SUGAR_DEPENDENCY',
                severity: 'medium',
                patternName: humanMsg.title,
                message: `üç¨ ${humanMsg.title}`,
                detail: `Added Sugar Dependency: ${Math.round(avgScore)} –±–∞–ª–ª–æ–≤ (—Ü–µ–ª—å: ${SCORE_THRESHOLD}+)`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: days.map(d => d.date),
                metrics: {
                    avgScore: Math.round(avgScore),
                    threshold: SCORE_THRESHOLD,
                    lowDays: lowScoreDays
                },
                currentScore: Math.round(avgScore),
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 22: Micronutrient gap (v3.2)
    // ========================================
    function checkMicronutrientGap(days, profile) {
        console.info('ews / detect check_22:', { name: 'MicronutrientGap', days: days.length });

        const MIN_DAYS = 7;
        const SCORE_THRESHOLD = 50;
        const MIN_LOW_PATTERNS = 2;

        if (days.length < MIN_DAYS) return null;

        const microPatterns = ['vitamin_d', 'magnesium', 'zinc', 'iron', 'calcium'];
        const patternScores = {};

        for (const pattern of microPatterns) {
            let totalScore = 0;
            let count = 0;
            for (const day of days) {
                const score = day.patterns?.[pattern]?.score;
                if (typeof score === 'number') {
                    totalScore += score;
                    count++;
                }
            }
            if (count > 0) {
                patternScores[pattern] = totalScore / count;
            }
        }

        const lowPatterns = Object.entries(patternScores)
            .filter(([_, score]) => score < SCORE_THRESHOLD)
            .map(([name, score]) => ({ name, score }));

        if (lowPatterns.length >= MIN_LOW_PATTERNS) {
            const humanMsg = WARNING_HUMAN_MESSAGES.MICRONUTRIENT_GAP;
            const avgLowScore = lowPatterns.reduce((sum, p) => sum + p.score, 0) / lowPatterns.length;
            console.info('ews / detect üî∂ MicronutrientGap:', {
                lowPatterns: lowPatterns.length,
                patterns: lowPatterns.map(p => p.name)
            });

            return {
                type: 'MICRONUTRIENT_GAP',
                severity: 'medium',
                patternName: humanMsg.title,
                message: `üî¨ ${humanMsg.title}`,
                detail: `${lowPatterns.length} –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ —Å –Ω–∏–∑–∫–∏–º score: ${lowPatterns.map(p => p.name).join(', ')}`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: days.map(d => d.date),
                metrics: {
                    lowPatternCount: lowPatterns.length,
                    patterns: lowPatterns
                },
                currentScore: Math.round(avgLowScore),
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 23: Step decline (v3.2)
    // ========================================
    function checkStepDecline(days, profile) {
        console.info('ews / detect check_23:', { name: 'StepDecline', days: days.length });

        const MIN_DAYS = 30;
        const RECENT_WINDOW = 7;
        const DECLINE_THRESHOLD = 0.5; // 50% decline

        if (days.length < MIN_DAYS) return null;

        const recentDays = days.slice(-RECENT_WINDOW);
        const allDays = days.slice(-MIN_DAYS);

        let recentSteps = 0;
        let recentCount = 0;
        for (const day of recentDays) {
            if (day.steps && day.steps > 0) {
                recentSteps += day.steps;
                recentCount++;
            }
        }

        let allSteps = 0;
        let allCount = 0;
        for (const day of allDays) {
            if (day.steps && day.steps > 0) {
                allSteps += day.steps;
                allCount++;
            }
        }

        if (recentCount < 3 || allCount < 15) return null;

        const recentAvg = recentSteps / recentCount;
        const allAvg = allSteps / allCount;

        const declineRatio = recentAvg / allAvg;

        if (declineRatio < DECLINE_THRESHOLD) {
            const humanMsg = WARNING_HUMAN_MESSAGES.STEP_DECLINE;
            const declinePercent = Math.round((1 - declineRatio) * 100);
            const stepScore = Math.max(0, Math.round(100 - declinePercent));
            console.info('ews / detect üî∂ StepDecline:', {
                recentAvg: recentAvg.toFixed(0),
                allAvg: allAvg.toFixed(0),
                decline: declinePercent + '%'
            });

            return {
                type: 'STEP_DECLINE',
                severity: 'low',
                patternName: humanMsg.title,
                message: `üö∂ ${humanMsg.title}`,
                detail: `–®–∞–≥–∏ —É–ø–∞–ª–∏ –Ω–∞ ${declinePercent}%: —Å ${Math.round(allAvg)} –¥–æ ${Math.round(recentAvg)} —à–∞–≥–æ–≤/–¥–µ–Ω—å`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: recentDays.map(d => d.date),
                metrics: {
                    recentAvg: Math.round(recentAvg),
                    normalAvg: Math.round(allAvg),
                    declinePercent
                },
                currentScore: stepScore,
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 24: Meal timing drift (v3.2)
    // ========================================
    function checkMealTimingDrift(days, profile) {
        console.info('ews / detect check_24:', { name: 'MealTimingDrift', days: days.length });

        const MIN_DAYS = 7;

        // v5.0: Phenotype-aware stability check
        // Smaller window (e.g. 0.9 for IR) -> Stricter variance 
        const VARIANCE_THRESHOLD = getEwsThreshold('mealTimeWindow', 2.5, profile); // default 2.5h
        console.info('ews / detect ‚è∞ timing params:', { VARIANCE_THRESHOLD: `${VARIANCE_THRESHOLD}h` });

        if (days.length < MIN_DAYS) return null;

        const breakfastTimes = [];

        for (const day of days) {
            if (day.meals && Array.isArray(day.meals) && day.meals.length > 0) {
                const firstMeal = day.meals[0];
                if (firstMeal.time) {
                    const [h, m] = firstMeal.time.split(':').map(Number);
                    breakfastTimes.push(h + m / 60);
                }
            }
        }

        if (breakfastTimes.length < MIN_DAYS) return null;

        const avgTime = breakfastTimes.reduce((sum, t) => sum + t, 0) / breakfastTimes.length;
        const maxDiff = Math.max(...breakfastTimes.map(t => Math.abs(t - avgTime)));

        if (maxDiff > VARIANCE_THRESHOLD) {
            const humanMsg = WARNING_HUMAN_MESSAGES.MEAL_TIMING_DRIFT;
            const timingScore = Math.max(0, Math.round(100 - (maxDiff / 4) * 100)); // Score decreases with variance
            console.info('ews / detect üî∂ MealTimingDrift:', { variance: maxDiff.toFixed(1) });

            return {
                type: 'MEAL_TIMING_DRIFT',
                severity: 'low',
                patternName: humanMsg.title,
                message: `‚è∞ ${humanMsg.title}`,
                detail: `–í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –∫–æ–ª–µ–±–ª–µ—Ç—Å—è –Ω–∞ ${maxDiff.toFixed(1)} —á–∞—Å–∞`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: days.map(d => d.date),
                metrics: {
                    variance: Math.round(maxDiff * 10) / 10,
                    threshold: VARIANCE_THRESHOLD
                },
                currentScore: timingScore,
                actionable: true
            };
        }

        return null;
    }

    // ========================================
    // Warning 25: Electrolyte imbalance (v3.2)
    // ========================================
    function checkElectrolyteImbalance(days, profile) {
        console.info('ews / detect check_25:', { name: 'ElectrolyteImbalance', days: days.length });

        const MIN_DAYS = 5;
        const SCORE_THRESHOLD = 40;
        const MIN_TRAININGS = 2;

        if (days.length < MIN_DAYS) return null;

        let lowScoreDays = 0;
        let trainingCount = 0;
        let totalScore = 0;

        for (const day of days) {
            const score = day.patterns?.electrolyte_homeostasis?.score;
            if (typeof score === 'number') {
                totalScore += score;
                if (score < SCORE_THRESHOLD) {
                    lowScoreDays++;
                }
            }
            if (day.training?.duration && day.training.duration > 0) {
                trainingCount++;
            }
        }

        if (lowScoreDays >= 3 && trainingCount >= MIN_TRAININGS) {
            const avgScore = totalScore / days.length;
            const humanMsg = WARNING_HUMAN_MESSAGES.ELECTROLYTE_IMBALANCE;
            console.info('ews / detect üî∂ ElectrolyteImbalance:', {
                lowDays: lowScoreDays,
                trainings: trainingCount,
                avgScore: avgScore.toFixed(1)
            });

            return {
                type: 'ELECTROLYTE_IMBALANCE',
                severity: 'medium',
                patternName: humanMsg.title,
                message: `‚ö° ${humanMsg.title}`,
                detail: `Electrolyte Homeostasis: ${Math.round(avgScore)} –±–∞–ª–ª–æ–≤ –ø—Ä–∏ ${trainingCount} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö`,
                insight: humanMsg.insight,
                science: humanMsg.science,
                dates: days.map(d => d.date),
                metrics: {
                    avgScore: Math.round(avgScore),
                    threshold: SCORE_THRESHOLD,
                    lowDays: lowScoreDays,
                    trainingCount
                },
                currentScore: Math.round(avgScore),
                actionable: true
            };
        }

        return null;
    }

    /**
     * Helper: Calculate time gap between two time strings
     * @param {string} time1 - "08:30"
     * @param {string} time2 - "18:45"
     * @returns {number} - Hours between times
     */
    function calculateTimeGap(time1, time2) {
        if (!time1 || !time2) return 0;
        try {
            const [h1, m1] = time1.split(':').map(Number);
            const [h2, m2] = time2.split(':').map(Number);
            const minutes1 = h1 * 60 + m1;
            const minutes2 = h2 * 60 + m2;
            let diff = minutes2 - minutes1;
            if (diff < 0) diff += 24 * 60; // Handle overnight
            return diff / 60;
        } catch (e) {
            return 0;
        }
    }

    /**
     * Helper: Calculate sleep hours from start/end time
     * @param {string} start - "23:00"
     * @param {string} end - "07:30"
     * @returns {number}
     */
    function calculateSleepHours(start, end) {
        if (!start || !end) return 0;

        try {
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);

            let hours = endH - startH;
            let minutes = endM - startM;

            if (hours < 0) hours += 24; // Overnight
            if (minutes < 0) {
                hours -= 1;
                minutes += 60;
            }

            return hours + minutes / 60;
        } catch (e) {
            return 0;
        }
    }

    /**
     * Calculate EWS Global Score (0-100) - Single summary metric of overall risk
     * Formula: Aggregate severity √ó healthImpact √ó chronicity, normalized to 0-100
     * Higher score = higher risk
     * 
     * @param {object[]} warnings - Array of detected warnings
     * @param {object} trends - Trends object with chronicWarnings and allTrends
     * @returns {object} { score: number, breakdown: object }
     */
    function calculateEwsGlobalScore(warnings, trends) {
        const LOG_PREFIX = 'ews / global_score';

        console.info(`${LOG_PREFIX} üöÄ start`, { warningsCount: warnings.length });

        // Graceful fallback for empty warnings
        if (!warnings || warnings.length === 0) {
            console.info(`${LOG_PREFIX} ‚úÖ result`, { score: 0, reason: 'no_warnings' });
            return { score: 0, breakdown: { totalWeight: 0, components: [] } };
        }

        console.info(`${LOG_PREFIX} üì• input`, {
            warnings: warnings.length,
            hasHighSeverity: warnings.filter(w => w.severity === 'high').length,
            hasChronicWarnings: trends?.chronicWarnings?.length || 0
        });

        // Severity weights
        const SEVERITY_WEIGHTS = { high: 3, medium: 2, low: 1 };

        // Calculate weighted score for each warning
        const components = warnings.map(w => {
            const severityWeight = SEVERITY_WEIGHTS[w.severity] || 1;
            const healthImpact = w.healthImpact || HEALTH_IMPACT_SCORES[w.type] || 50;

            // Chronicity factor from trends (1.0 baseline, up to 2.0 for chronic)
            let chronicityFactor = 1.0;
            if (trends?.allTrends && trends.allTrends[w.type]) {
                const trend = trends.allTrends[w.type];
                if (trend.chronic) chronicityFactor = 2.0;
                else if (trend.frequent) chronicityFactor = 1.5;
            }

            const componentWeight = severityWeight * (healthImpact / 100) * chronicityFactor;

            return {
                type: w.type,
                severity: w.severity,
                healthImpact,
                chronicityFactor,
                weight: componentWeight
            };
        });

        const totalWeight = components.reduce((sum, c) => sum + c.weight, 0);

        console.info(`${LOG_PREFIX} üßÆ compute`, {
            components: components.length,
            totalWeight: totalWeight.toFixed(2),
            maxTheoreticalPerWarning: 3 * 1.0 * 2.0, // high severity √ó max impact √ó max chronicity
            topContributors: components.sort((a, b) => b.weight - a.weight).slice(0, 3).map(c => c.type)
        });

        // Normalize to 0-100 scale
        // Max theoretical: if all warnings were high severity (3) √ó max health impact (1.0) √ó chronic (2.0) = 6 per warning
        // We'll use a more conservative normalization: score = totalWeight √ó 10, capped at 100
        // This gives meaningful scores: 1 high-impact chronic warning ‚âà 60 score
        const rawScore = Math.min(100, totalWeight * 10);
        const finalScore = Math.round(rawScore);

        console.info(`${LOG_PREFIX} ‚úÖ result`, {
            score: finalScore,
            totalWeight: totalWeight.toFixed(2),
            warningsCount: warnings.length,
            chronicCount: trends?.chronicWarnings?.length || 0
        });

        return {
            score: finalScore,
            breakdown: {
                totalWeight,
                components,
                normalizationFactor: 10
            }
        };
    }

    /**
     * Get phenotype-adjusted threshold for EWS check
     * @param {string} key - Threshold key (e.g., 'sodiumLimit')
     * @param {number} defaultVal - Default value if no adjustment
     * @param {object} profile - User profile
     * @returns {number} - Adjusted threshold
     */
    let _phenotypeHintShown = false; // Show friendly hint only once per session
    function getEwsThreshold(key, defaultVal, profile) {
        // v2.1: Smart auto-detection on first real usage (no setTimeout guessing!)
        const isFirstCall = !_phenotypeHintShown;

        // If no phenotype module or profile, return default
        if (!HEYS.InsightsPI?.phenotype?.applyMultipliers || !profile?.phenotype) {
            if (!_phenotypeHintShown) {
                console.warn(`%c[HEYS.ews.phenotype] ‚ö†Ô∏è Using DEFAULT thresholds (no phenotype set)`, 'color: #ffaa00; font-weight: bold');
                console.info(`%c  üí° Tip: Set phenotype for personalized thresholds:`, 'color: #ffaa00');
                console.info(`     HEYS.InsightsPI.phenotype.setPreset('IR_EVENING')  // insulin resistant + evening type`);
                console.info(`     HEYS.InsightsPI.phenotype.setPreset('OPTIMAL')     // optimal metabolism`);
                console.info(`  Then reload page to see üß¨ Adjusted thresholds in action`);
                _phenotypeHintShown = true;
            }
            return defaultVal;
        }

        // First call with active phenotype - show success message
        if (isFirstCall) {
            console.info('%c[HEYS.ews.phenotype] üß¨ Active phenotype detected:', 'color: #00ff00; font-weight: bold', profile.phenotype);
            console.info('%c  ‚úÖ Personalized thresholds enabled. Expected adjustments:', 'color: #00ff00');
            if (profile.phenotype.metabolic === 'insulin_resistant') {
                console.info('     ‚Ä¢ Fiber target: 15g ‚Üí ~23g (+56%)');
                console.info('     ‚Ä¢ Sodium limit: 4000mg ‚Üí ~3200mg (-20%)');
                console.info('     ‚Ä¢ Sugar tolerance: 1.0x ‚Üí ~0.3x (-70%)');
                console.info('     ‚Ä¢ Protein target: 1.0x ‚Üí ~1.4x (+40%)');
            }
            if (profile.phenotype.circadian === 'evening_type') {
                console.info('     ‚Ä¢ Late eating: 22:00 ‚Üí ~20:36 (-1.4h)');
                console.info('     ‚Ä¢ Sleep variability: 2h ‚Üí ~2.3h (+15%)');
            }
            if (profile.phenotype.satiety === 'low_satiety') {
                console.info('     ‚Ä¢ Meal skip tolerance: 1.0x ‚Üí ~0.8x (-20% stricter)');
                console.info('     ‚Ä¢ Binge volume: 1.0x ‚Üí ~0.7x (-30% stricter)');
            }
            if (profile.phenotype.stress === 'stress_eater') {
                console.info('     ‚Ä¢ Stress sensitivity: 1.0x ‚Üí ~1.3x (+30% more sensitive)');
            }
            _phenotypeHintShown = true;
        }

        // Apply multipliers
        const thresholds = { [key]: defaultVal };
        const adjusted = HEYS.InsightsPI.phenotype.applyMultipliers(thresholds, profile.phenotype);
        const result = adjusted[key];

        // Show individual adjustment (every time, for transparency)
        if (result !== defaultVal) {
            const categories = [
                profile.phenotype.metabolic,
                profile.phenotype.circadian,
                profile.phenotype.satiety,
                profile.phenotype.stress
            ].filter(Boolean).join('/');
            console.info(`[HEYS.ews.phenotype] üß¨ Adjusted ${key}: ${defaultVal} ‚Üí ${result} (${categories})`);
        }

        return result;
    }

    /**
     * Main API: Detect all early warning signals
     * @param {object[]} days - Array of day objects (sorted oldest to newest)
     * @param {object} profile - User profile
     * @param {object} pIndex - Product index
     * @param {object} [options] - Optional config: { mode: 'acute'|'full', includeDetails, currentPatterns, previousPatterns }
     * @returns {object}
     */
    function detectEarlyWarnings(days, profile, pIndex, options = {}) {
        // Mode validation & default
        const mode = options.mode || 'full';
        if (!['acute', 'full'].includes(mode)) {
            console.warn('ews / detect ‚ö†Ô∏è invalid mode:', mode, '‚Üí defaulting to "full"');
            mode = 'full';
        }

        const checksCount = mode === 'acute' ? 10 : 25;

        console.info('ews / detect üöÄ start:', {
            mode: mode,
            windowDays: days?.length || 0,
            checks: checksCount,
            tiers: mode === 'acute'
                ? '10 Acute (Health, Status, Sleep, Caloric, Weight, Hydration, Logging, Protein, Stress, Training)'
                : '25 Full (5 Baseline + 3 Tier1 + 4 Tier2 + 3 Tier3 + 10 Advanced)'
        });
        console.info('ews / detect üì• received options:', {
            mode: mode,
            includeDetails: options?.includeDetails || false,
            hasCurrentPatterns: !!options?.currentPatterns,
            patternsCount: options?.currentPatterns ? Object.keys(options.currentPatterns).length : 0,
            patternNames: options?.currentPatterns ? Object.keys(options.currentPatterns).slice(0, 5) : []
        });

        if (!Array.isArray(days) || days.length < THRESHOLDS.MIN_DAYS_FOR_ANALYSIS) {
            console.warn('ews / detect ‚ö†Ô∏è input.invalid:', {
                reason: 'insufficient_data',
                daysReceived: days?.length || 0,
                minRequired: THRESHOLDS.MIN_DAYS_FOR_ANALYSIS
            });
            return {
                available: false,
                reason: 'insufficient_data',
                minDaysRequired: THRESHOLDS.MIN_DAYS_FOR_ANALYSIS,
                warnings: [],
                trends: null
            };
        }

        console.info('ews / detect üì• input.valid:', {
            daysCount: days.length,
            profileId: profile?.id,
            hasPIndex: !!pIndex,
            hasPatternSnapshot: !!options.previousPatterns
        });

        const warnings = [];

        console.info('ews / detect üßÆ compute:', { phase: 'running_checks', checksTotal: checksCount, mode: mode });

        // Warning 1: Health Score decline (ACUTE)
        const scoreWarning = checkHealthScoreDecline(days, profile, pIndex, options);
        if (scoreWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_1:', { name: 'HealthScore', status: 'WARNING' });
            warnings.push(scoreWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_1:', { name: 'HealthScore', status: 'clean' });
        }

        // Warning 2: Critical pattern degradation OR low pattern scores (FULL-only)
        if ((mode === 'full') && options.currentPatterns) {
            const patternWarnings = checkCriticalPatternDegradation(
                days,
                profile,
                pIndex,
                options.previousPatterns,  // optional
                options.currentPatterns    // required
            );
            if (patternWarnings) {
                console.info(`ews / detect üßÆ   ‚úÖ check_2:`, { name: 'Patterns', status: 'WARNING', count: patternWarnings.length });
                warnings.push(...patternWarnings);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_2:', { name: 'Patterns', status: 'clean' });
            }
        } else {
            const skipReason = mode === 'acute' ? 'acute_mode' : 'no_currentPatterns';
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_2:', { name: 'Patterns', status: 'skipped', reason: skipReason });
        }

        // Warning 3: Status Score decline (ACUTE)
        const statusWarning = checkStatusScoreDecline(days);
        if (statusWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_3:', { name: 'Status', status: 'WARNING' });
            warnings.push(statusWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_3:', { name: 'Status', status: 'clean' });
        }

        // Warning 4: Sleep debt
        const sleepWarning = checkSleepDebt(days, profile);
        if (sleepWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_4:', { name: 'Sleep', status: 'WARNING' });
            warnings.push(sleepWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_4:', { name: 'Sleep', status: 'clean' });
        }

        // Warning 5: Caloric debt
        const caloricWarning = checkCaloricDebt(days, profile, pIndex);
        if (caloricWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_5:', { name: 'Caloric', status: 'WARNING' });
            warnings.push(caloricWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_5:', { name: 'Caloric', status: 'clean' });
        }

        // === Tier 1 Warnings (v2.0) ===

        // Warning 6: Weight spike
        const weightWarning = checkWeightSpike(days, profile);
        if (weightWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_6:', { name: 'WeightSpike', status: 'WARNING' });
            warnings.push(weightWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_6:', { name: 'WeightSpike', status: 'clean' });
        }

        // Warning 7: Hydration deficit
        const hydrationWarning = checkHydrationDeficit(days, profile);
        if (hydrationWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_7:', { name: 'Hydration', status: 'WARNING' });
            warnings.push(hydrationWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_7:', { name: 'Hydration', status: 'clean' });
        }

        // Warning 8: Logging gap
        const loggingWarning = checkLoggingGap(days, profile);
        if (loggingWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_8:', { name: 'LoggingGap', status: 'WARNING' });
            warnings.push(loggingWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_8:', { name: 'LoggingGap', status: 'clean' });
        }

        // === Tier 2 Warnings (v2.5) ===

        // Warning 9: Protein deficit
        const proteinWarning = checkProteinDeficit(days, profile, pIndex);
        if (proteinWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_9:', { name: 'ProteinDeficit', status: 'WARNING' });
            warnings.push(proteinWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_9:', { name: 'ProteinDeficit', status: 'clean' });
        }

        // Warning 10: Stress accumulation
        const stressWarning = checkStressAccumulation(days, profile);
        if (stressWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_10:', { name: 'Stress', status: 'WARNING' });
            warnings.push(stressWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_10:', { name: 'Stress', status: 'clean' });
        }

        // Warning 11: Meal skip pattern (FULL-only)
        if (mode === 'full') {
            const mealSkipWarning = checkMealSkipPattern(days, profile);
            if (mealSkipWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_11:', { name: 'MealSkip', status: 'WARNING' });
                warnings.push(mealSkipWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_11:', { name: 'MealSkip', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_11:', { name: 'MealSkip', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 12: Binge risk (FULL-only)
        if (mode === 'full') {
            const bingeWarning = checkBingeRisk(days, profile, pIndex);
            if (bingeWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_12:', { name: 'BingeRisk', status: 'WARNING' });
                warnings.push(bingeWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_12:', { name: 'BingeRisk', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_12:', { name: 'BingeRisk', status: 'skipped', reason: 'acute_mode' });
        }

        // === Tier 3 Warnings (v3.0) ===

        // Warning 13: Mood/wellbeing decline (FULL-only)
        if (mode === 'full') {
            const moodWarning = checkMoodWellbeingDecline(days, profile);
            if (moodWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_13:', { name: 'MoodDecline', status: 'WARNING' });
                warnings.push(moodWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_13:', { name: 'MoodDecline', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_13:', { name: 'MoodDecline', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 14: Weight plateau (FULL-only)
        if (mode === 'full') {
            const plateauWarning = checkWeightPlateau(days, profile);
            if (plateauWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_14:', { name: 'WeightPlateau', status: 'WARNING' });
                warnings.push(plateauWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_14:', { name: 'WeightPlateau', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_14:', { name: 'WeightPlateau', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 15: Weekend pattern (FULL-only)
        if (mode === 'full') {
            const weekendWarning = checkWeekendPattern(days, profile, pIndex);
            if (weekendWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_15:', { name: 'WeekendPattern', status: 'WARNING' });
                warnings.push(weekendWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_15:', { name: 'WeekendPattern', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_15:', { name: 'WeekendPattern', status: 'skipped', reason: 'acute_mode' });
        }

        // ========================================
        // Advanced Warnings (v3.2)
        // ========================================

        // Warning 16: Fiber deficit (FULL-only)
        if (mode === 'full') {
            const fiberWarning = checkFiberDeficit(days, profile);
            if (fiberWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_16:', { name: 'FiberDeficit', status: 'WARNING' });
                warnings.push(fiberWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_16:', { name: 'FiberDeficit', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_16:', { name: 'FiberDeficit', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 17: Sodium excess (FULL-only)
        if (mode === 'full') {
            const sodiumWarning = checkSodiumExcess(days, profile);
            if (sodiumWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_17:', { name: 'SodiumExcess', status: 'WARNING' });
                warnings.push(sodiumWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_17:', { name: 'SodiumExcess', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_17:', { name: 'SodiumExcess', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 18: Circadian disruption (FULL-only)
        if (mode === 'full') {
            const circadianWarning = checkCircadianDisruption(days, profile);
            if (circadianWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_18:', { name: 'CircadianDisruption', status: 'WARNING' });
                warnings.push(circadianWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_18:', { name: 'CircadianDisruption', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_18:', { name: 'CircadianDisruption', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 19: Training without recovery
        const trainingRecoveryWarning = checkTrainingWithoutRecovery(days, profile);
        if (trainingRecoveryWarning) {
            console.info('ews / detect üßÆ   ‚úÖ check_19:', { name: 'TrainingWithoutRecovery', status: 'WARNING' });
            warnings.push(trainingRecoveryWarning);
        } else {
            console.info('ews / detect üßÆ   ‚ûñ check_19:', { name: 'TrainingWithoutRecovery', status: 'clean' });
        }

        // Warning 20: Fat quality decline (FULL-only)
        if (mode === 'full') {
            const fatQualityWarning = checkFatQualityDecline(days, profile, pIndex);
            if (fatQualityWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_20:', { name: 'FatQualityDecline', status: 'WARNING' });
                warnings.push(fatQualityWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_20:', { name: 'FatQualityDecline', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_20:', { name: 'FatQualityDecline', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 21: Sugar dependency (FULL-only)
        if (mode === 'full') {
            const sugarWarning = checkSugarDependency(days, profile);
            if (sugarWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_21:', { name: 'SugarDependency', status: 'WARNING' });
                warnings.push(sugarWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_21:', { name: 'SugarDependency', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_21:', { name: 'SugarDependency', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 22: Micronutrient gap (FULL-only)
        if (mode === 'full') {
            const microWarning = checkMicronutrientGap(days, profile);
            if (microWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_22:', { name: 'MicronutrientGap', status: 'WARNING' });
                warnings.push(microWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_22:', { name: 'MicronutrientGap', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_22:', { name: 'MicronutrientGap', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 23: Step decline (FULL-only)
        if (mode === 'full') {
            const stepWarning = checkStepDecline(days, profile);
            if (stepWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_23:', { name: 'StepDecline', status: 'WARNING' });
                warnings.push(stepWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_23:', { name: 'StepDecline', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_23:', { name: 'StepDecline', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 24: Meal timing drift (FULL-only)
        if (mode === 'full') {
            const mealTimingWarning = checkMealTimingDrift(days, profile);
            if (mealTimingWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_24:', { name: 'MealTimingDrift', status: 'WARNING' });
                warnings.push(mealTimingWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_24:', { name: 'MealTimingDrift', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_24:', { name: 'MealTimingDrift', status: 'skipped', reason: 'acute_mode' });
        }

        // Warning 25: Electrolyte imbalance (FULL-only)
        if (mode === 'full') {
            const electrolyteWarning = checkElectrolyteImbalance(days, profile);
            if (electrolyteWarning) {
                console.info('ews / detect üßÆ   ‚úÖ check_25:', { name: 'ElectrolyteImbalance', status: 'WARNING' });
                warnings.push(electrolyteWarning);
            } else {
                console.info('ews / detect üßÆ   ‚ûñ check_25:', { name: 'ElectrolyteImbalance', status: 'clean' });
            }
        } else {
            console.info('ews / detect üßÆ   ‚è≠Ô∏è check_25:', { name: 'ElectrolyteImbalance', status: 'skipped', reason: 'acute_mode' });
        }

        // Sort by severity
        warnings.sort((a, b) => {
            const severityOrder = { high: 0, medium: 1, low: 2 };
            return severityOrder[a.severity] - severityOrder[b.severity];
        });

        console.info('ews / detect ‚úÖ result:', {
            warningsDetected: warnings.length,
            types: warnings.map(w => w.type),
            severities: warnings.map(w => w.severity),
            highSeverity: warnings.filter(w => w.severity === 'high').length,
            mediumSeverity: warnings.filter(w => w.severity === 'medium').length,
            lowSeverity: warnings.filter(w => w.severity === 'low').length
        });

        // Visual summary table of all 15 checks (v3.0 verification +  pipeline logs v3.1)
        console.group('ews / detect üñ•Ô∏è ui.summary - All 25 Checks');
        const checkMapping = [
            { num: 1, name: 'Health Score Decline', tier: 'Baseline', types: ['HEALTH_SCORE_DECLINE'] },
            { num: 2, name: 'Pattern Issues', tier: 'Baseline', types: ['CRITICAL_PATTERN_DEGRADATION', 'LOW_PATTERN_SCORE'] },
            { num: 3, name: 'Status Score Decline', tier: 'Baseline', types: ['STATUS_SCORE_DECLINE'] },
            { num: 4, name: 'Sleep Debt', tier: 'Baseline', types: ['SLEEP_DEBT'] },
            { num: 5, name: 'Caloric Debt', tier: 'Baseline', types: ['CALORIC_DEBT'] },
            { num: 6, name: 'Weight Spike', tier: 'Tier 1', types: ['WEIGHT_SPIKE'] },
            { num: 7, name: 'Hydration Deficit', tier: 'Tier 1', types: ['HYDRATION_DEFICIT'] },
            { num: 8, name: 'Logging Gap', tier: 'Tier 1', types: ['LOGGING_GAP'] },
            { num: 9, name: 'Protein Deficit', tier: 'Tier 2', types: ['PROTEIN_DEFICIT'] },
            { num: 10, name: 'Stress Accumulation', tier: 'Tier 2', types: ['STRESS_ACCUMULATION'] },
            { num: 11, name: 'Meal Skip Pattern', tier: 'Tier 2', types: ['MEAL_SKIP_PATTERN'] },
            { num: 12, name: 'Binge Risk', tier: 'Tier 2', types: ['BINGE_RISK'] },
            { num: 13, name: 'Mood/Wellbeing Decline', tier: 'Tier 3', types: ['MOOD_WELLBEING_DECLINE'] },
            { num: 14, name: 'Weight Plateau', tier: 'Tier 3', types: ['WEIGHT_PLATEAU'] },
            { num: 15, name: 'Weekend Pattern', tier: 'Tier 3', types: ['WEEKEND_PATTERN'] },
            { num: 16, name: 'Fiber Deficit', tier: 'Advanced', types: ['FIBER_DEFICIT'] },
            { num: 17, name: 'Sodium Excess', tier: 'Advanced', types: ['SODIUM_EXCESS'] },
            { num: 18, name: 'Circadian Disruption', tier: 'Advanced', types: ['CIRCADIAN_DISRUPTION'] },
            { num: 19, name: 'Training w/o Recovery', tier: 'Advanced', types: ['TRAINING_WITHOUT_RECOVERY'] },
            { num: 20, name: 'Fat Quality Decline', tier: 'Advanced', types: ['FAT_QUALITY_DECLINE'] },
            { num: 21, name: 'Sugar Dependency', tier: 'Advanced', types: ['SUGAR_DEPENDENCY'] },
            { num: 22, name: 'Micronutrient Gap', tier: 'Advanced', types: ['MICRONUTRIENT_GAP'] },
            { num: 23, name: 'Step Decline', tier: 'Advanced', types: ['STEP_DECLINE'] },
            { num: 24, name: 'Meal Timing Drift', tier: 'Advanced', types: ['MEAL_TIMING_DRIFT'] },
            { num: 25, name: 'Electrolyte Imbalance', tier: 'Advanced', types: ['ELECTROLYTE_IMBALANCE'] }
        ];
        const warningTypes = new Set(warnings.map(function (w) { return w.type; }));
        const checkSummary = checkMapping.map(function (check) {
            var hasWarning = check.types.some(function (t) { return warningTypes.has(t); });
            return {
                '#': check.num,
                'Check Name': check.name,
                'Tier': check.tier,
                'Status': hasWarning ? '‚ö†Ô∏è WARNING' : '‚úì Clean'
            };
        });
        console.table(checkSummary);
        console.info('ews / detect üñ•Ô∏è ui.legend:', 'Baseline(5) + Tier1(3) + Tier2(4) + Tier3(3) + Advanced(10) = 25 checks total');
        console.groupEnd();
        console.info('ews / detect üñ•Ô∏è ui.complete:', { warningsDisplayed: warnings.length, checksTotal: 25 });

        // Track warning trends (v3.1)
        const trendsResult = trackWarningTrends(warnings);

        // Prioritize warnings by severity √ó frequency √ó health impact (v3.1)
        const prioritizedWarnings = prioritizeWarnings(warnings, trendsResult.allTrends);

        // Calculate EWS Global Score (v4.0)
        const globalScoreResult = calculateEwsGlobalScore(prioritizedWarnings, trendsResult);

        console.info('ews / global_score üñ•Ô∏è ui', {
            score: globalScoreResult.score,
            interpretation: globalScoreResult.score >= 70 ? 'HIGH_RISK'
                : globalScoreResult.score >= 40 ? 'MEDIUM_RISK'
                    : globalScoreResult.score >= 20 ? 'LOW_RISK'
                        : 'MINIMAL_RISK'
        });

        // Calculate Weekly Progress Tracking (v4.1, Wave 3.1 + cloud sync)
        // Fire-and-forget: weekly progress runs in background (detect() must stay sync for callers)
        const weeklyProgressDefault = { weeks: [], trend: 'stable', currentWeek: null };
        calculateWeeklyProgress(prioritizedWarnings, globalScoreResult.score)
            .then(result => {
                console.info('ews / weekly ‚úÖ Background weekly progress computed:', {
                    weeks: result.weeks?.length || 0,
                    trend: result.trend
                });
            })
            .catch(err => {
                console.warn('ews / weekly ‚ö†Ô∏è Background weekly progress failed:', err?.message);
            });

        // Detect Causal Chains (v4.0)
        let causalChainsResult = [];
        if (typeof HEYS.InsightsPI?.causalChains?.detect === 'function') {
            causalChainsResult = HEYS.InsightsPI.causalChains.detect({
                warnings: prioritizedWarnings,
                patterns: options.currentPatterns || {},
                trends: trendsResult
            });

            console.info('ews / causal_chain üñ•Ô∏è ui', {
                chainsDetected: causalChainsResult.length,
                topChains: causalChainsResult.slice(0, 3).map(c => ({
                    id: c.chainId,
                    confidence: c.adjustedConfidence,
                    coverage: c.matchRatio + '%'
                }))
            });
        } else {
            console.info('ews / causal_chain ‚ö†Ô∏è skipped', { reason: 'module_not_loaded' });
        }

        return {
            available: true,
            count: warnings.length,
            warnings: prioritizedWarnings, // Prioritized warnings with scores
            summary: warnings.length === 0
                ? '‚úÖ –ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'
                : `‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${warnings.length} warning signal${warnings.length > 1 ? 's' : ''}`,
            highSeverityCount: warnings.filter(w => w.severity === 'high').length,
            mediumSeverityCount: warnings.filter(w => w.severity === 'medium').length,
            // Trends tracking (v3.1)
            trends: {
                chronicWarnings: trendsResult.chronicWarnings,
                allTrends: trendsResult.allTrends
            },
            // Priority queue (v3.1)
            criticalPriority: prioritizedWarnings.filter(w => w.criticalPriority),
            // Global Score (v4.0)
            globalScore: globalScoreResult.score,
            globalScoreBreakdown: globalScoreResult.breakdown,
            // Causal Chains (v4.0)
            causalChains: causalChainsResult,
            // Weekly Progress (v4.1, Wave 3.1)
            weeklyProgress: weeklyProgressDefault
        };
    }



    // Export API
    HEYS.InsightsPI.earlyWarning = {
        detect: detectEarlyWarnings,
        trackTrends: trackWarningTrends,
        prioritize: prioritizeWarnings,
        calculateGlobalScore: calculateEwsGlobalScore,
        calculateWeeklyProgress: calculateWeeklyProgress,
        backfillWeeklySnapshots: backfillWeeklySnapshots,
        thresholds: THRESHOLDS,
        healthImpact: HEALTH_IMPACT_SCORES,
        version: '4.2.0'
    };

    console.log('[HEYS.InsightsPI] ‚úÖ Early Warning System v4.2 loaded (25 checks + trends + priority + global score + weekly progress + cloud sync)');
    console.info('[HEYS.InsightsPI.earlyWarning] üéØ Module ready:', {
        detect: typeof HEYS.InsightsPI.earlyWarning.detect,
        trackTrends: typeof HEYS.InsightsPI.earlyWarning.trackTrends,
        calculateWeeklyProgress: typeof HEYS.InsightsPI.earlyWarning.calculateWeeklyProgress,
        backfillWeeklySnapshots: typeof HEYS.InsightsPI.earlyWarning.backfillWeeklySnapshots,
        version: HEYS.InsightsPI.earlyWarning.version,
        checks: 25,
        cloudSyncEnabled: CLOUD_SYNC_CONFIG.ENABLED
    });

    // === PHENOTYPE QUICK HELPERS (console API) ===
    if (!HEYS.InsightsPI.phenotype.set) {
        const PRESETS = {
            IR_EVENING: { metabolic: 'insulin_resistant', circadian: 'evening_type', satiety: 'low_satiety', stress: 'stress_eater' },
            IR_MORNING: { metabolic: 'insulin_resistant', circadian: 'morning_type', satiety: 'high_satiety', stress: 'neutral' },
            METABOLIC_SYNDROME: { metabolic: 'metabolic_syndrome_risk', circadian: 'evening_type', satiety: 'volume_eater', stress: 'stress_eater' },
            OPTIMAL: { metabolic: 'insulin_sensitive', circadian: 'flexible', satiety: 'normal', stress: 'neutral' }
        };

        HEYS.InsightsPI.phenotype.set = function (metabolic, circadian, satiety, stress) {
            const utils = window.HEYS?.utils;
            if (!utils || !utils.lsGet || !utils.lsSet) {
                console.error('‚ùå HEYS.utils not available');
                return false;
            }
            const profile = utils.lsGet('heys_profile', {});
            if (!profile || Object.keys(profile).length === 0) {
                console.error('‚ùå Profile not found');
                return false;
            }
            profile.phenotype = { metabolic, circadian, satiety, stress };
            utils.lsSet('heys_profile', profile);
            console.info('‚úÖ Phenotype set:', profile.phenotype);
            console.info('üîÑ Refresh page or re-run EWS detect() to apply');
            return true;
        };

        HEYS.InsightsPI.phenotype.setPreset = function (presetName) {
            const preset = PRESETS[presetName];
            if (!preset) {
                console.error('‚ùå Unknown preset. Available:', Object.keys(PRESETS));
                return false;
            }
            return HEYS.InsightsPI.phenotype.set(preset.metabolic, preset.circadian, preset.satiety, preset.stress);
        };

        HEYS.InsightsPI.phenotype.clear = function () {
            const utils = window.HEYS?.utils;
            if (!utils || !utils.lsGet || !utils.lsSet) return false;
            const profile = utils.lsGet('heys_profile', {});
            if (!profile) return false;
            delete profile.phenotype;
            utils.lsSet('heys_profile', profile);
            console.info('‚úÖ Phenotype cleared (defaults restored)');
            return true;
        };

        HEYS.InsightsPI.phenotype.status = function () {
            const utils = window.HEYS?.utils;
            if (!utils || !utils.lsGet) return null;
            const profile = utils.lsGet('heys_profile', {});
            if (!profile || !profile.phenotype) {
                console.info('‚ö†Ô∏è No phenotype set (using defaults)');
                return null;
            }
            console.info('üß¨ Current phenotype:', profile.phenotype);
            return profile.phenotype;
        };

        console.info('[HEYS.InsightsPI.phenotype] üõ†Ô∏è Quick API loaded:');
        console.info('  ‚Ä¢ HEYS.InsightsPI.phenotype.set(metabolic, circadian, satiety, stress)');
        console.info('  ‚Ä¢ HEYS.InsightsPI.phenotype.setPreset("IR_EVENING" | "IR_MORNING" | "METABOLIC_SYNDROME" | "OPTIMAL")');
        console.info('  ‚Ä¢ HEYS.InsightsPI.phenotype.clear()');
        console.info('  ‚Ä¢ HEYS.InsightsPI.phenotype.status()');
    }

    // Dispatch event for components waiting for EWS module
    if (typeof window !== 'undefined') {
        window.dispatchEvent(new CustomEvent('heys-ews-ready', {
            detail: { version: '4.2.0', timestamp: Date.now() }
        }));
        console.info('[HEYS.InsightsPI.earlyWarning] üì° Dispatched heys-ews-ready event');
        // Note: Phenotype status auto-displays on first detect() via getEwsThreshold() smart logging
    }

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_whatif.js ===== */
/**
 * HEYS Predictive Insights ‚Äî What-If Scenarios v2.0
 * 
 * Realistic action-level simulations: predict pattern changes from specific actions.
 * Uses actual pattern scores (0-100 scale), evidence-based impact coefficients,
 * and real baseline data from HEYS.InsightsPI analysis.
 * 
 * v2.0 changes:
 * - Score scale: 0-100 (matching real pattern scores)
 * - 15+ patterns covered in prediction engine
 * - Fixed param name mismatches with UI (targetGapHours, targetSteps, etc.)
 * - Realistic deltas: 3-15 points per action
 * - Evidence-based impact coefficients
 * - Comprehensive practical tips for all 10 action types
 * - Health score delta: weighted average across affected patterns
 * 
 * Dependencies: pi_patterns.js, pi_calculations.js
 * @param global
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    /**
     * Available action types
     */
    const ACTION_TYPES = {
        // Meal composition
        ADD_PROTEIN: 'add_protein',
        ADD_FIBER: 'add_fiber',
        REDUCE_CARBS: 'reduce_carbs',

        // Meal timing
        INCREASE_MEAL_GAP: 'increase_meal_gap',
        SHIFT_MEAL_TIME: 'shift_meal_time',
        SKIP_LATE_MEAL: 'skip_late_meal',

        // Sleep
        INCREASE_SLEEP: 'increase_sleep',
        ADJUST_BEDTIME: 'adjust_bedtime',

        // Activity
        ADD_TRAINING: 'add_training',
        INCREASE_STEPS: 'increase_steps'
    };

    /**
     * Impact rules: which patterns are affected by each action.
     * delta = base points change (0-100 scale) for PRIMARY patterns.
     * Secondary patterns get 40-60% of the delta.
     * Each rule has a coefficient function that scales the delta based on actionParams.
     */
    const IMPACT_RULES = {
        [ACTION_TYPES.ADD_PROTEIN]: {
            primary: [
                { pattern: 'protein_satiety', delta: 12, desc: '–ù–∞—Å—ã—â–µ–Ω–∏–µ —Ä–∞—Å—Ç—ë—Ç —Å –±–µ–ª–∫–æ–º' },
                { pattern: 'meal_quality', delta: 8, desc: '–ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–∞ –ø–æ–≤—ã—à–∞–µ—Ç—Å—è' },
                { pattern: 'protein_distribution', delta: 10, desc: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ —É–ª—É—á—à–∞–µ—Ç—Å—è' },
                { pattern: 'nutrition_quality', delta: 6, desc: '–û–±—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤' }
            ],
            secondary: [
                { pattern: 'training_recovery', delta: 5, desc: '–õ—É—á—à–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ' },
                { pattern: 'nutrient_density', delta: 4, desc: '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤' }
            ],
            coeff: (params) => {
                const grams = params.proteinGrams || 30;
                return Math.min(grams / 30, 1.5); // 30g=1x, 45g=1.5x, 15g=0.5x
            }
        },
        [ACTION_TYPES.ADD_FIBER]: {
            primary: [
                { pattern: 'fiber_regularity', delta: 14, desc: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ' },
                { pattern: 'gut_health', delta: 10, desc: '–ó–¥–æ—Ä–æ–≤—å–µ –ñ–ö–¢ —É–ª—É—á—à–∞–µ—Ç—Å—è' },
                { pattern: 'meal_quality', delta: 6, desc: '–ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞ –ø–æ–≤—ã—à–∞–µ—Ç—Å—è' }
            ],
            secondary: [
                { pattern: 'nutrition_quality', delta: 5, desc: '–û–±—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è' },
                { pattern: 'glycemic_load', delta: 4, desc: '–°–Ω–∏–∂–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É' },
                { pattern: 'nutrient_density', delta: 3, desc: '–ì–æ—Ç–æ–≤–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤' }
            ],
            coeff: (params) => {
                const grams = params.fiberGrams || 15;
                return Math.min(grams / 15, 1.8); // 15g=1x, 30g=2x clamp 1.8
            }
        },
        [ACTION_TYPES.REDUCE_CARBS]: {
            primary: [
                { pattern: 'glycemic_load', delta: 12, desc: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç—Å—è' },
                { pattern: 'insulin_sensitivity', delta: 8, desc: '–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É' },
                { pattern: 'added_sugar_dependency', delta: 10, desc: '–°–∞—Ö–∞—Ä–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è' }
            ],
            secondary: [
                { pattern: 'meal_quality', delta: 5, desc: '–ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Ü–∏–æ–Ω–∞' },
                { pattern: 'nutrition_quality', delta: 4, desc: '–ù—É—Ç—Ä–∏—Ç–∏–≤–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å' },
                { pattern: 'sleep_weight', delta: 3, desc: '–°–æ–Ω –∏ –º–∞—Å—Å–∞ —Ç–µ–ª–∞' }
            ],
            coeff: (params) => {
                const pct = params.carbsPercent || 25;
                return Math.min(pct / 25, 1.6); // 25%=1x, 50%=2x clamp 1.6
            }
        },
        [ACTION_TYPES.INCREASE_MEAL_GAP]: {
            primary: [
                { pattern: 'wave_overlap', delta: 10, desc: '–ú–µ–Ω—å—à–µ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω' },
                { pattern: 'meal_timing', delta: 7, desc: '–£–ª—É—á—à–µ–Ω–∏–µ —Ç–∞–π–º–∏–Ω–≥–∞ –ø—Ä–∏—ë–º–æ–≤' },
                { pattern: 'insulin_sensitivity', delta: 6, desc: '–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É' }
            ],
            secondary: [
                { pattern: 'circadian', delta: 4, desc: '–¶–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã' },
                { pattern: 'nutrient_timing', delta: 3, desc: '–¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤' }
            ],
            coeff: (params) => {
                const targetGap = params.targetGapHours || 4;
                // Bigger gap = bigger effect, but diminishing returns
                return 0.5 + (targetGap - 3) * 0.5; // 3h=0.5x, 4h=1x, 5h=1.5x
            }
        },
        [ACTION_TYPES.SHIFT_MEAL_TIME]: {
            primary: [
                { pattern: 'meal_timing', delta: 8, desc: '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∏–Ω–≥–∞ –ø—Ä–∏—ë–º–æ–≤' },
                { pattern: 'circadian', delta: 7, desc: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ü–∏—Ä–∫–∞–¥–Ω—ã–º —Ä–∏—Ç–º–æ–º' },
                { pattern: 'late_eating', delta: 6, desc: '–£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–æ–∑–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤' }
            ],
            secondary: [
                { pattern: 'nutrient_timing', delta: 4, desc: '–¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤' },
                { pattern: 'insulin_sensitivity', delta: 3, desc: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å' }
            ],
            coeff: (params) => {
                const shiftMin = Math.abs(params.shiftMinutes || 30);
                return Math.min(shiftMin / 30, 2.0); // 30min=1x, 60min=2x
            }
        },
        [ACTION_TYPES.SKIP_LATE_MEAL]: {
            primary: [
                { pattern: 'late_eating', delta: 15, desc: '–ù–µ—Ç –ø–æ–∑–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤' },
                { pattern: 'sleep_weight', delta: 8, desc: '–°–æ–Ω –±–µ–∑ —Ç—è–∂–µ—Å—Ç–∏' },
                { pattern: 'circadian', delta: 7, desc: '–¶–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º –≤ –Ω–æ—Ä–º–µ' }
            ],
            secondary: [
                { pattern: 'sleep_quality', delta: 5, desc: '–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ —É–ª—É—á—à–∞–µ—Ç—Å—è' },
                { pattern: 'insulin_sensitivity', delta: 4, desc: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å' },
                { pattern: 'wave_overlap', delta: 3, desc: '–ú–µ–Ω—å—à–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–π –≤–æ–ª–Ω' }
            ],
            coeff: () => 1.0 // Fixed action, no params
        },
        [ACTION_TYPES.INCREASE_SLEEP]: {
            primary: [
                { pattern: 'sleep_quality', delta: 12, desc: '–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ —Ä–∞—Å—Ç—ë—Ç' },
                { pattern: 'sleep_weight', delta: 8, desc: '–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è —Å–≤—è–∑—å —Å–Ω–∞ –∏ –≤–µ—Å–∞' },
                { pattern: 'training_recovery', delta: 7, desc: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫' }
            ],
            secondary: [
                { pattern: 'mood_trajectory', delta: 5, desc: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è' },
                { pattern: 'wellbeing_correlation', delta: 4, desc: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ —É–ª—É—á—à–∞–µ—Ç—Å—è' },
                { pattern: 'insulin_sensitivity', delta: 3, desc: '–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É' }
            ],
            coeff: (params) => {
                const target = params.targetSleepHours || 8;
                // 7h‚Üí8h = 1x, 7h‚Üí9h = 1.5x, 7h‚Üí10h = 1.8x
                return 0.5 + (target - 7) * 0.5;
            }
        },
        [ACTION_TYPES.ADJUST_BEDTIME]: {
            primary: [
                { pattern: 'sleep_quality', delta: 10, desc: '–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–±–æ—è' },
                { pattern: 'circadian', delta: 9, desc: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ —Ä–∏—Ç–º–∞' },
                { pattern: 'sleep_weight', delta: 6, desc: '–£–ª—É—á—à–µ–Ω–∏–µ —Å–≤—è–∑–∏ —Å–Ω–∞ –∏ –≤–µ—Å–∞' }
            ],
            secondary: [
                { pattern: 'late_eating', delta: 4, desc: '–†–∞–Ω–Ω–∏–π –æ—Ç–±–æ–π = —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–æ–∑–¥–Ω–µ–π –µ–¥—ã' },
                { pattern: 'training_recovery', delta: 3, desc: '–õ—É—á—à–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ' },
                { pattern: 'mood_trajectory', delta: 3, desc: '–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ' }
            ],
            coeff: (params) => {
                const targetBedtime = params.targetBedtime || '22:30';
                const hour = parseTime(targetBedtime);
                // –û–ø—Ç–∏–º—É–º 22-23: —á–µ–º –±–ª–∏–∂–µ –∫ 22, —Ç–µ–º –ª—É—á—à–µ
                if (hour >= 21.5 && hour <= 23) return 1.2;
                if (hour >= 23 && hour <= 23.5) return 1.0;
                if (hour < 21.5) return 0.8; // –°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
                return 0.6; // –ü–æ—Å–ª–µ 23:30
            }
        },
        [ACTION_TYPES.ADD_TRAINING]: {
            primary: [
                { pattern: 'training_kcal', delta: 12, desc: '–ë–æ–ª—å—à–µ —Å–∂–∏–≥–∞–µ–º—ã—Ö –∫–∞–ª–æ—Ä–∏–π' },
                { pattern: 'training_recovery', delta: 8, desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞' },
                { pattern: 'training_type_match', delta: 7, desc: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∏—Ç–∞–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ' }
            ],
            secondary: [
                { pattern: 'steps_weight', delta: 5, desc: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–µ—Å' },
                { pattern: 'sleep_quality', delta: 4, desc: '–§–∏–∑–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å —É–ª—É—á—à–∞–µ—Ç —Å–æ–Ω' },
                { pattern: 'heart_health', delta: 3, desc: '–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–¥—Ü–∞' }
            ],
            coeff: (params) => {
                const duration = params.durationMinutes || 45;
                const intensity = params.intensity || 1;
                const intensityMult = [0.7, 1.0, 1.3][intensity] || 1.0;
                return Math.min((duration / 45) * intensityMult, 2.0);
            }
        },
        [ACTION_TYPES.INCREASE_STEPS]: {
            primary: [
                { pattern: 'steps_weight', delta: 10, desc: 'NEAT-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–µ—Å' },
                { pattern: 'heart_health', delta: 7, desc: '–ö–∞—Ä–¥–∏–æ-–∑–¥–æ—Ä–æ–≤—å–µ' },
                { pattern: 'training_kcal', delta: 5, desc: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –∫–∞–ª–æ—Ä–∏–π' }
            ],
            secondary: [
                { pattern: 'sleep_quality', delta: 4, desc: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å–Ω—É' },
                { pattern: 'mood_trajectory', delta: 3, desc: '–ü—Ä–æ–≥—É–ª–∫–∏ —É–ª—É—á—à–∞—é—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ' },
                { pattern: 'wellbeing_correlation', delta: 3, desc: '–û–±—â–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ' }
            ],
            coeff: (params) => {
                const target = params.targetSteps || 10000;
                // 8000=0.8x, 10000=1x, 15000=1.5x, 20000=1.8x
                return Math.min(target / 10000, 1.8);
            }
        }
    };

    /**
     * Category weights for health score calculation (must sum to 1.0)
     */
    const CATEGORY_WEIGHTS = {
        nutrition: 0.25,
        timing: 0.2,
        recovery: 0.2,
        activity: 0.15,
        metabolism: 0.2
    };

    /**
     * Pattern ‚Üí category mapping for weighted health score
     */
    const PATTERN_CATEGORY = {
        protein_satiety: 'nutrition',
        meal_quality: 'nutrition',
        nutrition_quality: 'nutrition',
        fiber_regularity: 'nutrition',
        protein_distribution: 'nutrition',
        nutrient_density: 'nutrition',
        glycemic_load: 'metabolism',
        insulin_sensitivity: 'metabolism',
        added_sugar_dependency: 'metabolism',
        meal_timing: 'timing',
        wave_overlap: 'timing',
        late_eating: 'timing',
        circadian: 'timing',
        nutrient_timing: 'timing',
        sleep_quality: 'recovery',
        sleep_weight: 'recovery',
        training_recovery: 'recovery',
        mood_trajectory: 'recovery',
        wellbeing_correlation: 'recovery',
        gut_health: 'recovery',
        steps_weight: 'activity',
        training_kcal: 'activity',
        training_type_match: 'activity',
        heart_health: 'activity'
    };

    /**
     * Simulate an action and predict pattern changes
     * @param {string} actionType - One of ACTION_TYPES
     * @param {object} actionParams - Action parameters from UI
     * @param {object[]} days - Historical days
     * @param {object} profile
     * @param {object} pIndex
     * @returns {object} - Simulation result with predictions
     */
    function simulateAction(actionType, actionParams, days, profile, pIndex) {
        console.info('[WhatIf] üîÆ simulateAction called:', {
            actionType,
            actionParams,
            daysCount: days?.length || 0,
            profileId: profile?.id
        });

        // Validate action type
        const validActionTypes = Object.values(ACTION_TYPES);
        if (!validActionTypes.includes(actionType)) {
            console.warn('[WhatIf] ‚ùå Unknown action type:', actionType);
            return { available: false, error: 'Unknown action type' };
        }

        if (!days || days.length < 7) {
            return { available: false, error: 'Need at least 7 days of data' };
        }

        const rules = IMPACT_RULES[actionType];
        if (!rules) {
            return { available: false, error: 'No impact rules for action' };
        }

        // 1. Get current pattern scores (baseline) ‚Äî real 0-100 scores
        const baseline = collectBaselineScores(days, profile, pIndex);

        // 2. Calculate coefficient from action params
        const coeff = typeof rules.coeff === 'function' ? rules.coeff(actionParams || {}) : 1.0;

        // 3. Predict pattern score changes
        const predicted = {};
        const impact = [];

        // Process primary impacts
        rules.primary.forEach(rule => {
            const baseScore = baseline[rule.pattern];
            if (baseScore === null || baseScore === undefined) return; // Pattern not available

            const rawDelta = Math.round(rule.delta * coeff);
            const newScore = clampScore(baseScore + rawDelta);
            const actualDelta = newScore - baseScore;

            if (actualDelta !== 0) {
                predicted[rule.pattern] = newScore;
                impact.push({
                    pattern: rule.pattern,
                    baseline: baseScore,
                    predicted: newScore,
                    delta: actualDelta,
                    percentChange: baseScore > 0 ? Math.round((actualDelta / baseScore) * 100) : actualDelta,
                    significance: Math.abs(actualDelta) >= 10 ? 'high' : Math.abs(actualDelta) >= 5 ? 'medium' : 'low',
                    desc: rule.desc,
                    tier: 'primary'
                });
            }
        });

        // Process secondary impacts (reduced effect: 40-60%)
        rules.secondary.forEach(rule => {
            const baseScore = baseline[rule.pattern];
            if (baseScore === null || baseScore === undefined) return;

            const secondaryMult = 0.5; // 50% of primary effect
            const rawDelta = Math.round(rule.delta * coeff * secondaryMult);
            const newScore = clampScore(baseScore + rawDelta);
            const actualDelta = newScore - baseScore;

            if (actualDelta !== 0) {
                predicted[rule.pattern] = newScore;
                impact.push({
                    pattern: rule.pattern,
                    baseline: baseScore,
                    predicted: newScore,
                    delta: actualDelta,
                    percentChange: baseScore > 0 ? Math.round((actualDelta / baseScore) * 100) : actualDelta,
                    significance: Math.abs(actualDelta) >= 8 ? 'medium' : 'low',
                    desc: rule.desc,
                    tier: 'secondary'
                });
            }
        });

        // Sort by absolute delta descending
        impact.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));

        const result = {
            available: true,
            actionType,
            actionParams,
            baseline,
            predicted,
            impact,
            sideBenefits: identifySideBenefits(impact),
            healthScoreChange: calculateHealthScoreChange(impact, baseline),
            practicalTips: generatePracticalTips(actionType, actionParams, impact)
        };

        console.info('[WhatIf] ‚úÖ Simulation complete:', {
            actionType,
            coeff: coeff.toFixed(2),
            impactCount: impact.length,
            topImpact: impact[0] ? `${impact[0].pattern}: +${impact[0].delta}` : 'none',
            sideBenefitsCount: result.sideBenefits.length,
            healthScoreDelta: result.healthScoreChange.delta
        });

        return result;
    }

    /**
     * Collect baseline pattern scores from latest insights analysis (0-100 scale).
     * Uses cached pattern results if available, or falls back to direct analysis.
     * @private
     */
    function collectBaselineScores(days, profile, pIndex) {
        const scores = {};

        // Try to get scores from latest insights analysis (cached results)
        const cachedPatterns = HEYS.InsightsPI?._lastPatterns || HEYS.InsightsPI?._patterns;
        if (cachedPatterns && Array.isArray(cachedPatterns)) {
            cachedPatterns.forEach(p => {
                if (p.available && typeof p.score === 'number') {
                    scores[p.pattern] = p.score;
                }
            });

            if (Object.keys(scores).length >= 5) {
                console.info('[WhatIf] üìä Baseline from cached patterns:', {
                    count: Object.keys(scores).length,
                    sample: Object.entries(scores).slice(0, 5).map(([k, v]) => `${k}:${v}`)
                });
                return scores;
            }
        }

        // Fallback: compute key patterns directly
        const patterns = HEYS.InsightsPI?.patterns;
        if (!patterns) {
            console.warn('[WhatIf] ‚ö†Ô∏è No patterns module, using moderate defaults');
            return getDefaultBaseline();
        }

        try {
            const recentDays = days.slice(-14);

            const runners = [
                { key: 'meal_timing', fn: () => patterns.analyzeMealTiming?.(recentDays, profile, pIndex) },
                { key: 'wave_overlap', fn: () => patterns.analyzeWaveOverlap?.(recentDays, profile) },
                { key: 'late_eating', fn: () => patterns.analyzeLateEating?.(recentDays, profile, pIndex) },
                { key: 'meal_quality', fn: () => patterns.analyzeMealQualityTrend?.(recentDays, pIndex) },
                { key: 'nutrition_quality', fn: () => patterns.analyzeNutritionQuality?.(recentDays, pIndex) },
                { key: 'protein_satiety', fn: () => patterns.analyzeProteinSatiety?.(recentDays, profile, pIndex) },
                { key: 'fiber_regularity', fn: () => patterns.analyzeFiberRegularity?.(recentDays, pIndex) },
                { key: 'sleep_weight', fn: () => patterns.analyzeSleepWeight?.(recentDays, profile, pIndex) },
                { key: 'sleep_quality', fn: () => patterns.analyzeSleepQuality?.(recentDays, pIndex) },
                { key: 'training_kcal', fn: () => patterns.analyzeTrainingKcal?.(recentDays, pIndex) },
                { key: 'training_recovery', fn: () => patterns.analyzeTrainingRecovery?.(recentDays) },
                { key: 'steps_weight', fn: () => patterns.analyzeStepsWeight?.(recentDays, profile, pIndex) },
                { key: 'circadian', fn: () => patterns.analyzeCircadianTiming?.(recentDays, profile, pIndex) },
                { key: 'nutrient_timing', fn: () => patterns.analyzeNutrientTiming?.(recentDays, pIndex) },
                { key: 'insulin_sensitivity', fn: () => patterns.analyzeInsulinSensitivity?.(recentDays, pIndex, profile) },
                { key: 'gut_health', fn: () => patterns.analyzeGutHealth?.(recentDays, pIndex) },
                { key: 'glycemic_load', fn: () => patterns.analyzeGlycemicLoad?.(recentDays, pIndex) },
                { key: 'protein_distribution', fn: () => patterns.analyzeProteinDistribution?.(recentDays, profile, pIndex) },
                { key: 'added_sugar_dependency', fn: () => patterns.analyzeAddedSugarDependency?.(recentDays, pIndex) },
                { key: 'heart_health', fn: () => patterns.analyzeHeartHealth?.(recentDays, pIndex) },
                { key: 'training_type_match', fn: () => patterns.analyzeTrainingTypeMatch?.(recentDays, profile, pIndex) },
                { key: 'nutrient_density', fn: () => patterns.analyzeNutrientDensity?.(recentDays, pIndex) },
                { key: 'mood_trajectory', fn: () => patterns.analyzeMoodTrajectory?.(recentDays, pIndex) },
                { key: 'wellbeing_correlation', fn: () => patterns.analyzeWellbeing?.(recentDays, pIndex) }
            ];

            runners.forEach(({ key, fn }) => {
                try {
                    const result = fn();
                    if (result && result.available && typeof result.score === 'number') {
                        scores[key] = result.score;
                    }
                } catch (e) {
                    // Silently skip failed pattern
                }
            });

            console.info('[WhatIf] üìä Baseline computed:', {
                count: Object.keys(scores).length,
                sample: Object.entries(scores).slice(0, 5).map(([k, v]) => `${k}:${v}`)
            });
        } catch (e) {
            console.warn('[WhatIf] ‚ö†Ô∏è Error computing baseline:', e.message);
        }

        return scores;
    }

    /**
     * Default baseline scores for common patterns (when no data available)
     * @private
     */
    function getDefaultBaseline() {
        return {
            meal_timing: 60, wave_overlap: 50, late_eating: 50,
            meal_quality: 55, nutrition_quality: 45, protein_satiety: 40,
            fiber_regularity: 40, sleep_weight: 50, sleep_quality: 50,
            training_kcal: 50, training_recovery: 55, steps_weight: 45,
            circadian: 60, nutrient_timing: 50, insulin_sensitivity: 50,
            gut_health: 50, glycemic_load: 55, protein_distribution: 45,
            added_sugar_dependency: 40, heart_health: 60, training_type_match: 40,
            nutrient_density: 50, mood_trajectory: 55, wellbeing_correlation: 50
        };
    }

    /**
     * Identify side benefits (positive impacts from secondary patterns)
     * @private
     */
    function identifySideBenefits(impact) {
        return impact
            .filter(i => i.tier === 'secondary' && i.delta > 0)
            .map(i => ({
                pattern: i.pattern,
                improvement: `+${i.delta} –±–∞–ª–ª–æ–≤`,
                desc: i.desc
            }));
    }

    /**
     * Calculate overall Health Score change (weighted by category importance)
     * @private
     */
    function calculateHealthScoreChange(impact, baseline) {
        if (impact.length === 0) {
            return { delta: 0, percent: 0 };
        }

        // Weighted sum by category
        let totalWeightedDelta = 0;
        let totalWeight = 0;

        impact.forEach(i => {
            const category = PATTERN_CATEGORY[i.pattern] || 'nutrition';
            const categoryWeight = CATEGORY_WEIGHTS[category] || 0.15;
            // Each pattern gets equal share within its category
            const patternWeight = categoryWeight * (i.tier === 'primary' ? 1.0 : 0.5);

            totalWeightedDelta += i.delta * patternWeight;
            totalWeight += patternWeight;
        });

        // Normalize to approximate health score delta (0-100 scale)
        const delta = totalWeight > 0 ? Math.round(totalWeightedDelta / totalWeight) : 0;
        const percent = delta; // Already on 0-100 scale

        return { delta, percent };
    }

    /**
     * Generate practical tips for action (all 10 types covered)
     * @private
     */
    function generatePracticalTips(actionType, params, impact) {
        const tips = [];
        const p = params || {};

        switch (actionType) {
            case ACTION_TYPES.ADD_PROTEIN: {
                const grams = p.proteinGrams || 30;
                const meal = getMealName(p.mealIndex || 0);
                tips.push(`–î–æ–±–∞–≤—å—Ç–µ ${grams}–≥ –±–µ–ª–∫–∞ –≤ ${meal}`);
                tips.push('ü•ö –Ø–π—Ü–∞, —Ç–≤–æ—Ä–æ–≥ 5%, –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –∏–ª–∏ –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å');
                if (grams >= 30) {
                    tips.push('–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –±–µ–ª–æ–∫ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è (25-35–≥ –Ω–∞ –ø—Ä–∏—ë–º)');
                }
                break;
            }
            case ACTION_TYPES.ADD_FIBER: {
                const grams = p.fiberGrams || 15;
                tips.push(`–î–æ–±–∞–≤—å—Ç–µ ${grams}–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –≤ —Ä–∞—Ü–∏–æ–Ω`);
                tips.push('ü•¶ –ë—Ä–æ–∫–∫–æ–ª–∏, –æ–≤—ë—Å, —á–µ—á–µ–≤–∏—Ü–∞, —è–≥–æ–¥—ã, –∞–≤–æ–∫–∞–¥–æ');
                tips.push('–£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –∫–ª–µ—Ç—á–∞—Ç–∫—É –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (+5–≥/–Ω–µ–¥–µ–ª—é) –∏ –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã');
                break;
            }
            case ACTION_TYPES.REDUCE_CARBS: {
                const pct = p.carbsPercent || 25;
                tips.push(`–°–Ω–∏–∑–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –Ω–∞ ~${pct}%`);
                tips.push('üçû –ó–∞–º–µ–Ω–∏—Ç–µ –±–µ–ª—ã–π —Ö–ª–µ–± ‚Üí —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π, —Å–∞—Ö–∞—Ä ‚Üí —Å—Ç–µ–≤–∏—è');
                tips.push('–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–≥—Ä–µ—á–∫–∞, –±—É—Ä—ã–π —Ä–∏—Å) –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è');
                break;
            }
            case ACTION_TYPES.INCREASE_MEAL_GAP: {
                const gap = p.targetGapHours || 4;
                tips.push(`–£–≤–µ–ª–∏—á—å—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –¥–æ ${gap}—á`);
                tips.push('‚òï –ú–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ ‚Äî –≤–æ–¥–∞, —á–∞–π, —á—ë—Ä–Ω—ã–π –∫–æ—Ñ–µ (–±–µ–∑ —Å–∞—Ö–∞—Ä–∞)');
                tips.push('–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∏–Ω—Å—É–ª–∏–Ω—É –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±–∞–∑–∞–ª—å–Ω–æ–º—É —É—Ä–æ–≤–Ω—é');
                break;
            }
            case ACTION_TYPES.SHIFT_MEAL_TIME: {
                const shiftMin = Math.abs(p.shiftMinutes || 30);
                const direction = (p.shiftMinutes || -30) < 0 ? '—Ä–∞–Ω—å—à–µ' : '–ø–æ–∑–∂–µ';
                const meal = getMealName(p.mealIndex || 0);
                tips.push(`–°–¥–≤–∏–Ω—å—Ç–µ ${meal} –Ω–∞ ${shiftMin} –º–∏–Ω ${direction}`);
                tips.push('üïê –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –∑–∞–≤—Ç—Ä–∞–∫ 7-9, –æ–±–µ–¥ 12-14, —É–∂–∏–Ω 18-19:30');
                tips.push('–ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å');
                break;
            }
            case ACTION_TYPES.SKIP_LATE_MEAL:
                tips.push('–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏ ‚Äî –Ω–µ –ø–æ–∑–∂–µ 19:00-20:00');
                tips.push('üåô –ï—Å–ª–∏ –≥–æ–ª–æ–¥–Ω—ã –≤–µ—á–µ—Ä–æ–º ‚Äî —Ç—Ä–∞–≤—è–Ω–æ–π —á–∞–π –∏–ª–∏ –∫–µ—Ñ–∏—Ä 1%');
                tips.push('–ü–∏—â–µ–≤–æ–µ –æ–∫–Ω–æ 10-12—á (–Ω–∞–ø—Ä. 8:00-20:00) –¥–ª—è —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ —Ä–∏—Ç–º–∞');
                break;

            case ACTION_TYPES.INCREASE_SLEEP: {
                const target = p.targetSleepHours || 8;
                tips.push(`–¶–µ–ª–µ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞: ${target}—á`);
                tips.push('üò¥ –õ–æ–∂–∏—Ç–µ—Å—å –Ω–∞ 30-60 –º–∏–Ω —Ä–∞–Ω—å—à–µ –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ');
                tips.push('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—É–¥–∏–ª—å–Ω–∏–∫-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ¬´–ø–æ—Ä–∞ —Å–ø–∞—Ç—å¬ª –∑–∞ 30 –º–∏–Ω');
                if (target >= 9) {
                    tips.push('9+ —á–∞—Å–æ–≤ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö');
                }
                break;
            }
            case ACTION_TYPES.ADJUST_BEDTIME: {
                const bt = p.targetBedtime || '22:30';
                tips.push(`–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–±–æ—è: ${bt}`);
                tips.push('üõèÔ∏è –ó–∞ 1 —á–∞—Å –¥–æ —Å–Ω–∞: –Ω–µ—Ç —ç–∫—Ä–∞–Ω–æ–≤, —Ç—ë–ø–ª—ã–π –¥—É—à, –ª—ë–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞');
                tips.push('–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–±–æ—è ¬±15 –º–∏–Ω, –≤–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ');
                break;
            }
            case ACTION_TYPES.ADD_TRAINING: {
                const dur = p.durationMinutes || 45;
                const intensityLabels = ['–ª—ë–≥–∫–∞—è', '—Å—Ä–µ–¥–Ω—è—è', '–≤—ã—Å–æ–∫–∞—è'];
                const intLabel = intensityLabels[p.intensity || 1] || '—Å—Ä–µ–¥–Ω—è—è';
                tips.push(`–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ${dur} –º–∏–Ω, –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${intLabel}`);
                tips.push('üèãÔ∏è –°–∏–ª–æ–≤–∞—è 2-3 —Ä–∞–∑–∞/–Ω–µ–¥ + –∫–∞—Ä–¥–∏–æ 2 —Ä–∞–∑–∞/–Ω–µ–¥ = –æ–ø—Ç–∏–º—É–º');
                tips.push('–ü—Ä–∏—ë–º –±–µ–ª–∫–∞ 25-30–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 2—á –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
                break;
            }
            case ACTION_TYPES.INCREASE_STEPS: {
                const target = p.targetSteps || 10000;
                tips.push(`–¶–µ–ª—å: ${target.toLocaleString('ru')} —à–∞–≥–æ–≤ –≤ –¥–µ–Ω—å`);
                tips.push('üö∂ –ü—Ä–æ–≥—É–ª–∫–∞ 20 –º–∏–Ω –ø–æ—Å–ª–µ –æ–±–µ–¥–∞ = ~2000 —à–∞–≥–æ–≤');
                tips.push('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ—Å—Ç–Ω–∏—Ü—É –≤–º–µ—Å—Ç–æ –ª–∏—Ñ—Ç–∞, –ø–∞—Ä–∫—É–π—Ç–µ—Å—å –¥–∞–ª—å—à–µ');
                break;
            }
        }

        // Add impact-based tip if significant improvement expected
        const topImpact = impact[0];
        if (topImpact && topImpact.delta >= 8) {
            tips.push(`üìà –ù–∞–∏–±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞: ${topImpact.desc} (+${topImpact.delta} –±–∞–ª–ª–æ–≤)`);
        }

        return tips;
    }

    /**
     * Helper: parse time string to hours
     * @private
     */
    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours + (minutes || 0) / 60;
    }

    /**
     * Helper: get meal name by index
     * @private
     */
    function getMealName(index) {
        const names = ['–∑–∞–≤—Ç—Ä–∞–∫', '–æ–±–µ–¥', '—É–∂–∏–Ω', '–ø–µ—Ä–µ–∫—É—Å'];
        return names[index] || '–ø—Ä–∏—ë–º –ø–∏—â–∏';
    }

    /**
     * Clamp score to 0-100 range
     * @private
     */
    function clampScore(score) {
        return Math.max(0, Math.min(100, Math.round(score)));
    }

    // Export API
    HEYS.InsightsPI.whatif = {
        ACTION_TYPES,
        simulate: simulateAction
    };

    console.info('[HEYS.InsightsPI.whatif] ‚úÖ What-If Scenarios v2.0 initialized (realistic predictions)');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_ui_phenotype.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Phenotype Classifier UI v1.0.0
 *
 * UI widgets for phenotype auto-detection and threshold multiplier preview.
 * Dependencies: pi_phenotype.js, pi_thresholds.js, React
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const { createElement: h, useEffect, useMemo, useState } = global.React || {};

    const PHENOTYPE_LABELS = {
        metabolic: {
            insulin_sensitive: '–ò–Ω—Å—É–ª–∏–Ω-—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π',
            insulin_resistant: '–ò–Ω—Å—É–ª–∏–Ω-—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π',
            metabolic_syndrome_risk: '–†–∏—Å–∫ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–Ω–¥—Ä–æ–º–∞',
            neutral: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π'
        },
        circadian: {
            morning_type: '–£—Ç—Ä–µ–Ω–Ω–∏–π —Ç–∏–ø',
            evening_type: '–í–µ—á–µ—Ä–Ω–∏–π —Ç–∏–ø',
            flexible: '–ì–∏–±–∫–∏–π'
        },
        satiety: {
            high_satiety: '–í—ã—Å–æ–∫–∞—è —Å—ã—Ç–æ—Å—Ç—å',
            low_satiety: '–ù–∏–∑–∫–∞—è —Å—ã—Ç–æ—Å—Ç—å',
            volume_eater: '–û–±—ä—ë–º–Ω—ã–π –µ–¥–æ–∫',
            normal: '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π'
        },
        stress: {
            stress_eater: '–ó–∞–µ–¥–∞–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞',
            stress_anorexic: '–ê–Ω–æ—Ä–µ–∫—Å–∏—á–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å—Ç—Ä–µ—Å—Å',
            neutral: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π'
        }
    };

    const CATEGORY_META = {
        metabolic: { emoji: 'üß™', title: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π' },
        circadian: { emoji: 'üåô', title: '–¶–∏—Ä–∫–∞–¥–Ω—ã–π' },
        satiety: { emoji: 'üçΩÔ∏è', title: '–°—ã—Ç–æ—Å—Ç—å' },
        stress: { emoji: 'üß†', title: '–°—Ç—Ä–µ—Å—Å' }
    };

    const PREVIEW_THRESHOLDS = [
        'lateEatingHour',
        'proteinPerMealG',
        'mealFrequency',
        'carbPerMealG',
        'sleepVariabilityHours'
    ];

    function formatConfidence(confidence) {
        if (typeof confidence !== 'number') return '‚Äî';
        return `${Math.round(confidence * 100)}%`;
    }

    function getConfidenceClass(confidence) {
        if (confidence >= 0.7) return 'high';
        if (confidence >= 0.5) return 'medium';
        return 'low';
    }

    function getPhenotypeLabel(category, key) {
        return PHENOTYPE_LABELS[category]?.[key] || key || '‚Äî';
    }

    function PhenotypeClassifierCard({ onClick }) {
        const handleClick = () => {
            console.info('[HEYS.insights.phenotype.ui] üñ±Ô∏è CTA clicked: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–µ–Ω–æ—Ç–∏–ø"');
            if (typeof onClick === 'function') onClick();
        };

        return h('div', {
            className: 'insights-card phenotype-card',
            onClick: handleClick,
            role: 'button',
            tabIndex: 0,
            onKeyDown: (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleClick();
                }
            }
        },
            h('div', { className: 'insights-card__header' },
                h('span', { className: 'insights-card__icon' }, 'üß¨'),
                h('h3', { className: 'insights-card__title' }, 'Phenotype Classifier'),
                h('span', { className: 'insights-card__badge' }, 'Beta')
            ),
            h('div', { className: 'insights-card__body' },
                h('p', { className: 'insights-card__description' },
                    '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∞—à –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ—Ä–æ–≥–æ–≤.'
                ),
                h('div', { className: 'phenotype-card__chips' },
                    ['üß™', 'üåô', 'üçΩÔ∏è', 'üß†'].map((emoji, idx) =>
                        h('span', { key: idx, className: 'phenotype-card__chip' }, emoji)
                    )
                )
            ),
            h('div', { className: 'insights-card__footer' },
                h('span', { className: 'insights-card__cta' }, '–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–µ–Ω–æ—Ç–∏–ø ‚Üí')
            )
        );
    }

    function PhenotypeClassifierPanel({ onClose, profile, pIndex }) {
        const [isDetecting, setIsDetecting] = useState(false);
        const [result, setResult] = useState(null);
        const [error, setError] = useState(null);

        const daysData = useMemo(() => {
            console.info('[HEYS.insights.phenotype.ui] üìä Collecting days data...');
            const start = performance.now();

            const getDaysHistory = HEYS.Metabolic?.getDaysHistory;
            if (typeof getDaysHistory !== 'function') {
                console.warn('[HEYS.insights.phenotype.ui] ‚ö†Ô∏è HEYS.Metabolic.getDaysHistory not available');
                return [];
            }

            const days = getDaysHistory(60);
            console.info('[HEYS.insights.phenotype.ui] ‚úÖ Days collected:', {
                count: days.length,
                durationMs: (performance.now() - start).toFixed(2)
            });
            return days;
        }, []);

        useEffect(() => {
            console.info('[HEYS.insights.phenotype.ui] ‚úÖ Phenotype panel opened', {
                daysCount: daysData.length,
                hasProfile: !!profile,
                hasPIndex: !!pIndex
            });

            return () => {
                console.info('[HEYS.insights.phenotype.ui] ‚Ü©Ô∏è Phenotype panel closed');
            };
        }, [daysData.length, profile, pIndex]);

        const runDetection = async () => {
            setIsDetecting(true);
            setError(null);

            try {
                const phenotypeApi = HEYS.InsightsPI?.phenotype;
                if (!phenotypeApi?.autoDetect || !phenotypeApi?.applyMultipliers) {
                    throw new Error('Phenotype module not available');
                }

                if (daysData.length < 30) {
                    throw new Error(`–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 30 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö (—Å–µ–π—á–∞—Å ${daysData.length})`);
                }

                const start = performance.now();
                const phenotype = phenotypeApi.autoDetect(daysData, profile, pIndex);

                if (!phenotype) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–µ–Ω–æ—Ç–∏–ø');
                }

                const thresholdResult = HEYS.InsightsPI?.thresholds?.get
                    ? HEYS.InsightsPI.thresholds.get(daysData, profile, pIndex)
                    : null;

                const baseThresholds = thresholdResult?.thresholds || {
                    lateEatingHour: 21,
                    proteinPerMealG: 25,
                    mealFrequency: 4,
                    trainingProximityHours: 2,
                    carbPerMealG: 60,
                    sleepVariabilityHours: 1
                };

                const adjustedThresholds = phenotypeApi.applyMultipliers(baseThresholds, phenotype);

                const changed = Object.keys(adjustedThresholds)
                    .filter((k) => adjustedThresholds[k] !== baseThresholds[k])
                    .map((k) => ({
                        key: k,
                        before: baseThresholds[k],
                        after: adjustedThresholds[k]
                    }));

                const payload = {
                    phenotype,
                    baseThresholds,
                    adjustedThresholds,
                    changed
                };

                setResult(payload);

                console.info('[HEYS.insights.phenotype.ui] ‚úÖ Phenotype detected:', {
                    metabolic: phenotype.metabolic,
                    circadian: phenotype.circadian,
                    satiety: phenotype.satiety,
                    stress: phenotype.stress,
                    changedThresholds: changed.length,
                    durationMs: (performance.now() - start).toFixed(2)
                });
            } catch (e) {
                console.error('[HEYS.insights.phenotype.ui] ‚ùå Detection failed:', e.message);
                setError(e.message || '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–µ–Ω–æ—Ç–∏–ø–∞');
            } finally {
                setIsDetecting(false);
            }
        };

        const phenotypeBlocks = result?.phenotype && h('div', { className: 'phenotype-panel__grid' },
            Object.keys(CATEGORY_META).map((category) => {
                const current = result.phenotype[category];
                const confidence = result.phenotype.confidence?.[category] ?? 0;
                const confidenceClass = getConfidenceClass(confidence);
                return h('div', { key: category, className: 'phenotype-panel__item' },
                    h('div', { className: 'phenotype-panel__item-title' },
                        h('span', { className: 'phenotype-panel__item-emoji' }, CATEGORY_META[category].emoji),
                        h('span', {}, CATEGORY_META[category].title)
                    ),
                    h('div', { className: 'phenotype-panel__item-value' }, getPhenotypeLabel(category, current)),
                    h('div', { className: `phenotype-panel__confidence phenotype-panel__confidence--${confidenceClass}` },
                        `Confidence: ${formatConfidence(confidence)}`
                    )
                );
            })
        );

        const thresholdPreview = result?.changed?.length > 0 && h('div', { className: 'phenotype-panel__thresholds' },
            h('h4', { className: 'phenotype-panel__section-title' }, '‚öôÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏'),
            h('div', { className: 'phenotype-panel__threshold-list' },
                result.changed
                    .filter((item) => PREVIEW_THRESHOLDS.includes(item.key))
                    .slice(0, 6)
                    .map((item) => {
                        const isUp = item.after > item.before;
                        return h('div', { key: item.key, className: 'phenotype-panel__threshold-item' },
                            h('span', { className: 'phenotype-panel__threshold-key' }, item.key),
                            h('span', { className: 'phenotype-panel__threshold-values' },
                                `${item.before} ‚Üí ${item.after}`
                            ),
                            h('span', {
                                className: `phenotype-panel__threshold-delta ${isUp ? 'positive' : 'negative'}`
                            }, `${isUp ? '+' : ''}${(item.after - item.before).toFixed(1)}`)
                        );
                    })
            )
        );

        return h('div', {
            className: 'phenotype-panel',
            onClick: onClose
        },
            h('div', {
                className: 'phenotype-panel__dialog',
                onClick: (e) => e.stopPropagation()
            },
                h('div', { className: 'phenotype-panel__header' },
                    h('h2', { className: 'phenotype-panel__title' }, 'üß¨ Phenotype Classifier'),
                    h('button', {
                        className: 'phenotype-panel__close',
                        onClick: onClose,
                        type: 'button',
                        'aria-label': '–ó–∞–∫—Ä—ã—Ç—å —Ñ–µ–Ω–æ—Ç–∏–ø'
                    }, '‚úï')
                ),

                h('div', { className: 'phenotype-panel__body' },
                    h('p', { className: 'phenotype-panel__description' },
                        '–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 30+ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ —Ñ–µ–Ω–æ—Ç–∏–ø–∞.'
                    ),

                    h('button', {
                        className: 'phenotype-panel__run-btn',
                        onClick: runDetection,
                        disabled: isDetecting || daysData.length < 30
                    }, isDetecting ? '‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º...' : 'üß¨ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–µ–Ω–æ—Ç–∏–ø'),

                    daysData.length < 30 && h('p', { className: 'phenotype-panel__warning' },
                        `‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö: –Ω—É–∂–Ω–æ 30 –¥–Ω–µ–π, —Å–µ–π—á–∞—Å ${daysData.length}`
                    ),

                    error && h('div', { className: 'phenotype-panel__error' }, `‚ùå ${error}`),

                    result && h('div', { className: 'phenotype-panel__result' },
                        h('h4', { className: 'phenotype-panel__section-title' }, '–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏'),
                        phenotypeBlocks,
                        thresholdPreview
                    )
                )
            )
        );
    }

    HEYS.InsightsPI.PhenotypeClassifierCard = PhenotypeClassifierCard;
    HEYS.InsightsPI.PhenotypeClassifierPanel = PhenotypeClassifierPanel;

    console.info('[HEYS.InsightsPI] ‚úÖ Phenotype UI components loaded (v1.0.0)');

})(window);


/* ===== insights/pi_ui_whatif_scenarios.js ===== */
/**
 * HEYS Predictive Insights ‚Äî What-If Scenarios Panel UI v1.0
 * 
 * –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ impact —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∑–¥–æ—Ä–æ–≤—å—è.
 * –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–±—Ä–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ.
 * 
 * Dependencies: pi_whatif.js (backend simulator), React
 * 
 * @version 1.0.0
 * @date 2026-02-15
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};
    const DEV = global.DEV || {};
    const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

    // React imports
    const { createElement: h, useState, useMemo, useEffect } = window.React || {};

    /**
     * ACTION_TYPES mirror from pi_whatif.js –¥–ª—è UI labels
     */
    const ACTION_CONFIG = {
        // Meal composition
        add_protein: {
            category: 'meal',
            emoji: 'ü•©',
            label: '–î–æ–±–∞–≤–∏—Ç—å –±–µ–ª–æ–∫',
            description: '–£–≤–µ–ª–∏—á–∏—Ç—å –±–µ–ª–æ–∫ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–∏—ë–º–µ',
            params: [
                { key: 'proteinGrams', label: '–ì—Ä–∞–º–º –±–µ–ª–∫–∞', type: 'number', min: 10, max: 100, default: 30, step: 5 },
                { key: 'mealIndex', label: '–ü—Ä–∏—ë–º –ø–∏—â–∏', type: 'select', options: ['–ó–∞–≤—Ç—Ä–∞–∫', '–û–±–µ–¥', '–£–∂–∏–Ω'], default: 0 }
            ]
        },
        add_fiber: {
            category: 'meal',
            emoji: 'ü•¶',
            label: '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–µ—Ç—á–∞—Ç–∫—É',
            description: '–£–≤–µ–ª–∏—á–∏—Ç—å –∫–ª–µ—Ç—á–∞—Ç–∫—É –≤ —Ä–∞—Ü–∏–æ–Ω–µ',
            params: [
                { key: 'fiberGrams', label: '–ì—Ä–∞–º–º –∫–ª–µ—Ç—á–∞—Ç–∫–∏', type: 'number', min: 5, max: 40, default: 15, step: 5 },
                { key: 'mealIndex', label: '–ü—Ä–∏—ë–º –ø–∏—â–∏', type: 'select', options: ['–ó–∞–≤—Ç—Ä–∞–∫', '–û–±–µ–¥', '–£–∂–∏–Ω'], default: 1 }
            ]
        },
        reduce_carbs: {
            category: 'meal',
            emoji: 'üçû',
            label: '–°–Ω–∏–∑–∏—Ç—å —É–≥–ª–µ–≤–æ–¥—ã',
            description: '–£–º–µ–Ω—å—à–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã',
            params: [
                { key: 'carbsPercent', label: '–°–Ω–∏–∂–µ–Ω–∏–µ (%)', type: 'number', min: 10, max: 50, default: 25, step: 5 },
                { key: 'mealIndex', label: '–ü—Ä–∏—ë–º –ø–∏—â–∏', type: 'select', options: ['–ó–∞–≤—Ç—Ä–∞–∫', '–û–±–µ–¥', '–£–∂–∏–Ω'], default: 2 }
            ]
        },

        // Meal timing
        increase_meal_gap: {
            category: 'timing',
            emoji: '‚è≥',
            label: '–£–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫',
            description: '–†–∞—Å—Ç—è–Ω—É—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏',
            params: [
                { key: 'targetGapHours', label: '–¶–µ–ª–µ–≤–æ–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ (—á)', type: 'number', min: 3, max: 6, default: 4, step: 0.5 }
            ]
        },
        shift_meal_time: {
            category: 'timing',
            emoji: 'üïê',
            label: '–°–¥–≤–∏–Ω—É—Ç—å –≤—Ä–µ–º—è',
            description: '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ø—Ä–∏—ë–º –ø–∏—â–∏',
            params: [
                { key: 'mealIndex', label: '–ü—Ä–∏—ë–º –ø–∏—â–∏', type: 'select', options: ['–ó–∞–≤—Ç—Ä–∞–∫', '–û–±–µ–¥', '–£–∂–∏–Ω'], default: 0 },
                { key: 'shiftMinutes', label: '–°–¥–≤–∏–≥ (–º–∏–Ω)', type: 'number', min: -120, max: 120, default: -30, step: 15 }
            ]
        },
        skip_late_meal: {
            category: 'timing',
            emoji: 'üö´',
            label: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–∑–¥–Ω–∏–π –ø—Ä–∏—ë–º',
            description: '–£–±—Ä–∞—Ç—å –ø—Ä–∏—ë–º –ø–æ—Å–ª–µ 19:00',
            params: []
        },

        // Sleep
        increase_sleep: {
            category: 'sleep',
            emoji: 'üò¥',
            label: '–£–≤–µ–ª–∏—á–∏—Ç—å —Å–æ–Ω',
            description: '–°–ø–∞—Ç—å –±–æ–ª—å—à–µ —á–∞—Å–æ–≤',
            params: [
                { key: 'targetSleepHours', label: '–¶–µ–ª–µ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á)', type: 'number', min: 7, max: 10, default: 8, step: 0.5 }
            ]
        },
        adjust_bedtime: {
            category: 'sleep',
            emoji: 'üõèÔ∏è',
            label: '–°–¥–≤–∏–Ω—É—Ç—å –æ—Ç–±–æ–π',
            description: '–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è',
            params: [
                { key: 'targetBedtime', label: '–ù–æ–≤–æ–µ –≤—Ä–µ–º—è –æ—Ç–±–æ—è', type: 'time', default: '22:30' }
            ]
        },

        // Activity
        add_training: {
            category: 'activity',
            emoji: 'üèãÔ∏è',
            label: '–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
            description: '–í–∫–ª—é—á–∏—Ç—å —Å–∏–ª–æ–≤—É—é/–∫–∞—Ä–¥–∏–æ',
            params: [
                { key: 'durationMinutes', label: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)', type: 'number', min: 20, max: 120, default: 45, step: 15 },
                { key: 'intensity', label: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å', type: 'select', options: ['–õ—ë–≥–∫–∞—è', '–°—Ä–µ–¥–Ω—è—è', '–í—ã—Å–æ–∫–∞—è'], default: 1 }
            ]
        },
        increase_steps: {
            category: 'activity',
            emoji: 'üö∂',
            label: '–£–≤–µ–ª–∏—á–∏—Ç—å —à–∞–≥–∏',
            description: '–ë–æ–ª—å—à–µ —Ö–æ–¥—å–±—ã',
            params: [
                { key: 'targetSteps', label: '–¶–µ–ª–µ–≤—ã–µ —à–∞–≥–∏', type: 'number', min: 5000, max: 20000, default: 10000, step: 1000 }
            ]
        }
    };

    const CATEGORY_CONFIG = {
        meal: { emoji: 'üçΩÔ∏è', label: '–ü–∏—Ç–∞–Ω–∏–µ', color: '#10b981' },
        timing: { emoji: '‚è∞', label: '–¢–∞–π–º–∏–Ω–≥', color: '#f59e0b' },
        sleep: { emoji: 'üò¥', label: '–°–æ–Ω', color: '#6366f1' },
        activity: { emoji: 'üí™', label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', color: '#ec4899' }
    };

    /**
     * –ß–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
     */
    const PATTERN_LABELS = {
        protein_satiety: '–ù–∞—Å—ã—â–µ–Ω–∏–µ –±–µ–ª–∫–æ–º',
        meal_timing: '–¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤',
        late_eating: '–ü–æ–∑–¥–Ω–∏–µ –ø—Ä–∏—ë–º—ã',
        sleep_weight: '–°–æ–Ω –∏ –≤–µ—Å',
        steps_weight: '–®–∞–≥–∏ –∏ –≤–µ—Å',
        fiber_regularity: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞',
        meal_quality: '–ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã',
        wave_overlap: '–ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–ª–Ω',
        training_kcal: '–ö–∞–ª–æ—Ä–∏–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
        training_recovery: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
        sleep_quality: '–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞',
        insulin_sensitivity: '–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É',
        mood_trajectory: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
        nutrient_timing: '–ù—É—Ç—Ä–∏–µ–Ω—Ç-—Ç–∞–π–º–∏–Ω–≥',
        gut_health: '–ó–¥–æ—Ä–æ–≤—å–µ –ñ–ö–¢',
        glycemic_load: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
        added_sugar_dependency: '–°–∞—Ö–∞—Ä–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å',
        protein_distribution: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞',
        nutrient_density: '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
        heart_health: '–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–¥—Ü–∞',
        training_type_match: '–ü–∏—Ç–∞–Ω–∏–µ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
        circadian: '–¶–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º',
        nutrition_quality: '–ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è',
        wellbeing_correlation: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ'
    };

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
     */
    function getPatternLabel(patternKey) {
        return PATTERN_LABELS[patternKey] || patternKey.replace(/_/g, ' ');
    }

    /**
     * WhatIfScenariosCard ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ InsightsTab
     */
    function WhatIfScenariosCard({ onClick }) {
        const handleCardClick = () => {
            console.info('[HEYS.insights.whatif.ui] üñ±Ô∏è CTA clicked: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π"');
            if (typeof onClick === 'function') onClick();
        };

        return h('div', {
            className: 'insights-card whatif-scenarios-card',
            onClick: handleCardClick,
            style: { cursor: 'pointer' }
        },
            // Header
            h('div', { className: 'insights-card__header' },
                h('span', { className: 'insights-card__icon' }, 'üîÆ'),
                h('h3', { className: 'insights-card__title' }, 'What-If Scenarios'),
                h('span', { className: 'insights-card__badge' }, 'Beta')
            ),

            // Body
            h('div', { className: 'insights-card__body' },
                h('p', { className: 'insights-card__description' },
                    '–ü—Ä–µ–¥—Å–∫–∞–∂–∏ –∫–∞–∫ –∏–∑–º–µ–Ω—è—Ç—Å—è —Ç–≤–æ–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –±–µ–ª–æ–∫, —Å–¥–≤–∏–Ω—É—Ç—å –ø—Ä–∏—ë–º –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω.'
                ),
                h('div', { className: 'whatif-scenarios-card__preview' },
                    ['ü•©', '‚è∞', 'üò¥', 'üí™'].map((emoji, idx) =>
                        h('div', {
                            key: idx,
                            className: 'whatif-scenarios-card__preview-icon'
                        }, emoji)
                    )
                )
            ),

            // Footer
            h('div', { className: 'insights-card__footer' },
                h('span', { className: 'insights-card__cta' }, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Üí')
            )
        );
    }

    /**
     * WhatIfScenariosPanel ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å —Å–∏–º—É–ª—è—Ç–æ—Ä–æ–º
     */
    function WhatIfScenariosPanel({ onClose, lsGet, profile, pIndex }) {
        const [selectedAction, setSelectedAction] = useState(null);
        const [actionParams, setActionParams] = useState({});
        const [simulation, setSimulation] = useState(null);
        const [isSimulating, setIsSimulating] = useState(false);
        const [activeCategory, setActiveCategory] = useState('meal');

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞ 14-30 –¥–Ω–µ–π
        const daysData = useMemo(() => {
            console.log('[WhatIfScenarios] üìä Collecting days data...');
            const start = performance.now();

            if (!HEYS.Metabolic?.getDaysHistory) {
                console.warn('[WhatIfScenarios] ‚ö†Ô∏è HEYS.Metabolic.getDaysHistory not available');
                return [];
            }

            const days = HEYS.Metabolic.getDaysHistory(30);
            const duration = (performance.now() - start).toFixed(2);

            console.log('[WhatIfScenarios] ‚úÖ Days collected:', {
                count: days.length,
                durationMs: duration,
                dateRange: days.length > 0 ? [days[0].date, days[days.length - 1].date] : []
            });

            return days;
        }, []);

        useEffect(() => {
            console.info('[HEYS.insights.whatif.ui] ‚úÖ What-If panel opened', {
                daysCount: daysData.length,
                hasProfile: !!profile,
                hasPIndex: !!pIndex
            });

            return () => {
                console.info('[HEYS.insights.whatif.ui] ‚Ü©Ô∏è What-If panel closed');
            };
        }, [daysData.length, profile, pIndex]);

        // –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const filteredActions = useMemo(() => {
            return Object.entries(ACTION_CONFIG)
                .filter(([key, config]) => config.category === activeCategory)
                .map(([key, config]) => ({ key, ...config }));
        }, [activeCategory]);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è
        const handleActionSelect = (actionKey) => {
            console.log('[WhatIfScenarios] üéØ Action selected:', actionKey);
            setSelectedAction(actionKey);
            setSimulation(null);

            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const config = ACTION_CONFIG[actionKey];
            const defaults = {};
            config.params.forEach(param => {
                defaults[param.key] = param.default;
            });
            setActionParams(defaults);
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        const handleParamChange = (paramKey, value) => {
            setActionParams(prev => ({
                ...prev,
                [paramKey]: value
            }));
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—É—Å–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏
        const handleRunSimulation = async () => {
            if (!selectedAction) return;

            console.log('[WhatIfScenarios] üöÄ Running simulation:', {
                action: selectedAction,
                params: actionParams,
                daysCount: daysData.length
            });

            setIsSimulating(true);
            const start = performance.now();

            try {
                // –í—ã–∑–æ–≤ backend —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
                const simulate = HEYS.InsightsPI?.whatif?.simulate || HEYS.InsightsPI?.whatif?.simulateAction;
                if (!simulate) {
                    throw new Error('HEYS.InsightsPI.whatif.simulate not available');
                }

                const result = await simulate(
                    selectedAction,
                    actionParams,
                    daysData,
                    profile,
                    pIndex
                );

                const duration = (performance.now() - start).toFixed(2);

                console.log('[WhatIfScenarios] ‚úÖ Simulation complete:', {
                    action: selectedAction,
                    durationMs: duration,
                    impactCount: result.impact?.length || 0,
                    healthScoreDelta: result.healthScoreChange?.delta
                });

                console.log('[WhatIfScenarios] üìä Detailed result structure:', {
                    impactSample: result.impact?.[0],
                    sideBenefitsSample: result.sideBenefits?.[0],
                    tipsSample: result.practicalTips?.[0],
                    healthScore: result.healthScoreChange
                });

                setSimulation(result);
            } catch (error) {
                console.error('[WhatIfScenarios] ‚ùå Simulation failed:', error);
                setSimulation({ available: false, error: error.message });
            } finally {
                setIsSimulating(false);
            }
        };

        // UI: Category tabs
        const categoryTabs = h('div', { className: 'whatif-scenarios-panel__categories' },
            Object.entries(CATEGORY_CONFIG).map(([key, config]) =>
                h('button', {
                    key: key,
                    className: `whatif-scenarios-panel__category ${activeCategory === key ? 'active' : ''}`,
                    onClick: () => {
                        setActiveCategory(key);
                        setSelectedAction(null);
                        setSimulation(null);
                    },
                    style: { '--category-color': config.color }
                },
                    h('span', { className: 'whatif-scenarios-panel__category-emoji' }, config.emoji),
                    h('span', { className: 'whatif-scenarios-panel__category-label' }, config.label)
                )
            )
        );

        // UI: Action buttons
        const actionButtons = h('div', { className: 'whatif-scenarios-panel__actions' },
            filteredActions.map(action =>
                h('button', {
                    key: action.key,
                    className: `whatif-scenarios-panel__action ${selectedAction === action.key ? 'active' : ''}`,
                    onClick: () => handleActionSelect(action.key)
                },
                    h('span', { className: 'whatif-scenarios-panel__action-emoji' }, action.emoji),
                    h('div', { className: 'whatif-scenarios-panel__action-content' },
                        h('span', { className: 'whatif-scenarios-panel__action-label' }, action.label),
                        h('span', { className: 'whatif-scenarios-panel__action-description' }, action.description)
                    )
                )
            )
        );

        // UI: Parameters form
        const paramsForm = selectedAction && h('div', { className: 'whatif-scenarios-panel__params' },
            h('h4', { className: 'whatif-scenarios-panel__params-title' }, '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'),
            ACTION_CONFIG[selectedAction].params.map(param => {
                if (param.type === 'number') {
                    return h('div', { key: param.key, className: 'whatif-scenarios-panel__param' },
                        h('label', { className: 'whatif-scenarios-panel__param-label' }, param.label),
                        h('input', {
                            type: 'number',
                            className: 'whatif-scenarios-panel__param-input',
                            min: param.min,
                            max: param.max,
                            step: param.step,
                            value: actionParams[param.key] || param.default,
                            onChange: (e) => handleParamChange(param.key, parseFloat(e.target.value))
                        })
                    );
                } else if (param.type === 'select') {
                    return h('div', { key: param.key, className: 'whatif-scenarios-panel__param' },
                        h('label', { className: 'whatif-scenarios-panel__param-label' }, param.label),
                        h('select', {
                            className: 'whatif-scenarios-panel__param-select',
                            value: actionParams[param.key] !== undefined ? actionParams[param.key] : param.default,
                            onChange: (e) => handleParamChange(param.key, parseInt(e.target.value))
                        },
                            param.options.map((option, idx) =>
                                h('option', { key: idx, value: idx }, option)
                            )
                        )
                    );
                } else if (param.type === 'time') {
                    return h('div', { key: param.key, className: 'whatif-scenarios-panel__param' },
                        h('label', { className: 'whatif-scenarios-panel__param-label' }, param.label),
                        h('input', {
                            type: 'time',
                            className: 'whatif-scenarios-panel__param-input',
                            value: actionParams[param.key] || param.default,
                            onChange: (e) => handleParamChange(param.key, e.target.value)
                        })
                    );
                }
            }),
            h('button', {
                className: 'whatif-scenarios-panel__run-btn',
                onClick: handleRunSimulation,
                disabled: isSimulating || daysData.length < 7
            },
                isSimulating ? '‚è≥ –°–∏–º—É–ª–∏—Ä—É–µ–º...' : 'üîÆ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é'
            ),
            daysData.length < 7 && h('p', {
                className: 'whatif-scenarios-panel__warning'
            }, `‚ö†Ô∏è –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 7 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö (—Å–µ–π—á–∞—Å ${daysData.length})`)
        );

        // UI: Simulation results
        const simulationResults = simulation && simulation.available && h('div', { className: 'whatif-scenarios-panel__results' },
            h('h4', { className: 'whatif-scenarios-panel__results-title' }, 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π'),

            // Prediction cards: baseline ‚Üí predicted
            simulation.impact && simulation.impact.length > 0 && h('div', { className: 'whatif-scenarios-panel__predictions' },
                simulation.impact.slice(0, 6).map((item, idx) => {
                    const isPositive = item.delta > 0;

                    return h('div', {
                        key: idx,
                        className: `whatif-scenarios-panel__prediction ${isPositive ? 'positive' : 'negative'}`
                    },
                        h('div', { className: 'whatif-scenarios-panel__prediction-header' },
                            h('span', { className: 'whatif-scenarios-panel__prediction-name' }, getPatternLabel(item.pattern)),
                            h('span', {
                                className: `whatif-scenarios-panel__prediction-delta ${isPositive ? 'positive' : 'negative'}`
                            }, `${isPositive ? '+' : ''}${item.delta} –±–∞–ª–ª–æ–≤`),
                            item.significance === 'high' && h('span', { className: 'whatif-scenarios-panel__prediction-badge' }, 'üî•')
                        ),
                        item.desc && h('div', { className: 'whatif-scenarios-panel__prediction-desc' }, item.desc),
                        h('div', { className: 'whatif-scenarios-panel__prediction-bar' },
                            h('div', { className: 'whatif-scenarios-panel__prediction-baseline' },
                                h('span', { className: 'whatif-scenarios-panel__prediction-label' }, `–°–µ–π—á–∞—Å: ${item.baseline}`),
                                h('div', {
                                    className: 'whatif-scenarios-panel__prediction-bar-fill',
                                    style: { width: `${Math.min(item.baseline, 100)}%` }
                                })
                            ),
                            h('div', { className: 'whatif-scenarios-panel__prediction-predicted' },
                                h('span', { className: 'whatif-scenarios-panel__prediction-label' }, `–ü—Ä–æ–≥–Ω–æ–∑: ${item.predicted}`),
                                h('div', {
                                    className: 'whatif-scenarios-panel__prediction-bar-fill predicted',
                                    style: { width: `${Math.min(item.predicted, 100)}%` }
                                })
                            )
                        )
                    );
                })
            ),

            // Summary block
            h('div', { className: 'whatif-scenarios-panel__summary' },
                // Health Score delta
                simulation.healthScoreChange && h('div', { className: 'whatif-scenarios-panel__summary-health' },
                    h('span', { className: 'whatif-scenarios-panel__summary-label' }, '–ò–∑–º–µ–Ω–µ–Ω–∏–µ Health Score'),
                    h('span', {
                        className: `whatif-scenarios-panel__summary-value ${simulation.healthScoreChange.delta >= 0 ? 'positive' : 'negative'}`
                    }, `${simulation.healthScoreChange.delta >= 0 ? '+' : ''}${simulation.healthScoreChange.delta} –±–∞–ª–ª–æ–≤`)
                ),

                // Side benefits
                simulation.sideBenefits && simulation.sideBenefits.length > 0 && h('div', { className: 'whatif-scenarios-panel__summary-benefits' },
                    h('span', { className: 'whatif-scenarios-panel__summary-label' }, '‚ú® –ë–æ–Ω—É—Å—ã'),
                    h('ul', { className: 'whatif-scenarios-panel__summary-list' },
                        simulation.sideBenefits.slice(0, 3).map((benefit, idx) =>
                            h('li', { key: idx }, `${getPatternLabel(benefit.pattern)}: ${benefit.improvement}`)
                        )
                    )
                ),

                // Practical tips
                simulation.practicalTips && simulation.practicalTips.length > 0 && h('div', { className: 'whatif-scenarios-panel__summary-tips' },
                    h('span', { className: 'whatif-scenarios-panel__summary-label' }, 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'),
                    h('ul', { className: 'whatif-scenarios-panel__summary-list' },
                        simulation.practicalTips.slice(0, 5).map((tip, idx) =>
                            h('li', { key: idx }, tip)
                        )
                    )
                )
            )
        );

        // Error state
        const errorState = simulation && !simulation.available && h('div', { className: 'whatif-scenarios-panel__error' },
            h('p', {}, `‚ùå ${simulation.error || '–û—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏'}`)
        );

        // Main panel
        return h('div', {
            className: 'whatif-scenarios-panel',
            onClick: onClose
        },
            h('div', {
                className: 'whatif-scenarios-panel__dialog',
                onClick: (e) => e.stopPropagation()
            },
                // Header
                h('div', { className: 'whatif-scenarios-panel__header' },
                    h('h2', { className: 'whatif-scenarios-panel__title' }, 'üîÆ What-If Scenarios'),
                    h('button', {
                        className: 'whatif-scenarios-panel__close',
                        onClick: onClose,
                        type: 'button',
                        'aria-label': '–ó–∞–∫—Ä—ã—Ç—å —Å–∏–º—É–ª—è—Ç–æ—Ä'
                    }, '‚úï')
                ),

                // Body
                h('div', { className: 'whatif-scenarios-panel__body' },
                    categoryTabs,
                    actionButtons,
                    paramsForm,
                    simulationResults,
                    errorState
                )
            )
        );
    }

    // Export components
    HEYS.InsightsPI.WhatIfScenariosCard = WhatIfScenariosCard;
    HEYS.InsightsPI.WhatIfScenariosPanel = WhatIfScenariosPanel;

    console.info('[HEYS.InsightsPI] ‚úÖ What-If Scenarios UI components loaded (v2.0.0)');

})(window);


/* ===== insights/pi_product_picker.js ===== */
/**
 * HEYS Insights ‚Äî Smart Product Picker v4.0.5
 * –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–∏—Ç–∞–Ω–∏—è (30 –¥–Ω–µ–π)
 *
 * v4.0.0: S10 "Smart Scoring" Refactor (19.02.2026)
 * v4.0.1: Fix macro alignment ‚Äî SCENARIO_IDEAL_MACRO_PROFILES (flat scoring root cause)
 * v4.0.2: Fix P0/C0/F0 ‚Äî enrich history product macros from sharedProducts (MealItem has no prot/carb/fat)
 * v4.0.3: Fix enrichMacros field names ‚Äî sharedProducts use protein100/simple100/complex100/badfat100 (not prot/carb/fat)
 * v4.0.4: Fix topFactors display ‚Äî sort by weighted contribution (score√óweight) so macro factors appear first
 * v4.0.5: Fix LATE_EVENING ‚Äî add category override (DAIRY+PROTEIN, no GRAINS) + extend sleepGIPenalty
 *   - determineCategoryMix(): LATE_EVENING ‚Üí [DAIRY, DAIRY, PROTEIN] (light dairy before sleep)
 *   - sleepGIPenalty: now applies to LATE_EVENING too (GRAINS‚Üí0, DAIRY‚Üí100, PROTEIN‚Üí90)
 *   - Bug: LATE_EVENING fell through to proportional calc ‚Üí GRAINS slot appeared
 *   - Bug: sleepGIPenalty only checked PRE_SLEEP ‚Üí GRAINS scored neutral 50 in LATE_EVENING
 *   - Rebalanced Weights: Macro alignment 49% (prot 0.25+carb0.14+fat0.10+kcal0.10), Binary 6% (tie-breakers)
 *   - New Math: Alignments use Energy% (TEF-adj: prot√ó3, carb√ó4, fat√ó9) ‚Äî same scale both sides
 *   - Fat Alignment: new factor 0.10 (was blind spot ‚Äî zero weight on fat profile mismatch)
 *   - KcalFit: soft linear penalty, 0 only at ratio>1.2 (was hard 0 at 0.80)
 *   - Neutral baselines: sleepGIPenalty/glPenalty/workoutCarbBoost ‚Üí 50 (was 75, widened dynamic range)
 *
 * v3.6.0: F4 Feedback ML weights (19.02.2026)
 *   - generateProductSuggestions(): –ø—Ä–∏–Ω–∏–º–∞–µ—Ç profile ‚Äî –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ scenarioContext
 *   - calculateProductScore(): mlWeightMultiplier —á–∏—Ç–∞–µ—Ç feedbackLoop.getProductWeight(profile, productId, scenario)
 *   - –î–∏–∞–ø–∞–∑–æ–Ω: 0.5‚Äì2.0 (EMA Œ±=0.1, ¬±5% –∑–∞ –∫–∞–∂–¥—ã–π üëç/üëé)
 *   - –ö–ª—é—á–∏: "PROTEIN_DEFICIT_productId", "PRE_SLEEP_productId" –∏ —Ç.–¥.
 *
 * v3.5.0: POST_WORKOUT carb boost (F3) (19.02.2026)
 *   - determineCategoryMix(): POST_WORKOUT ‚Üí GRAINS-first mix [GRAINS, GRAINS, PROTEIN]
 *     (–ê–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ 2—á: –±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —Ä–µ—Å–∏–Ω—Ç–µ–∑–∞ –≥–ª–∏–∫–æ–≥–µ–Ω–∞, –±–µ–ª–æ–∫ –¥–ª—è MPS)
 *   - calculateProductScore(): factor 14 ‚Äî workoutCarbBoost (0.05 weight)
 *     GRAINS ‚Üí score=100; FRUITS ‚Üí 90; PROTEIN ‚Üí 85; DAIRY ‚Üí 70; other ‚Üí 40
 *     (Ivy 2004: 1.0–≥/–∫–≥ —É–≥–ª–µ–≤–æ–¥—ã + 0.35–≥/–∫–≥ –±–µ–ª–æ–∫ –≤ –∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ)
 *   - SCORING_WEIGHTS: 14 —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (sum=1.00)
 *
 * v3.4.0: targetGL scoring factor (F2) (19.02.2026)
 *   - calculateProductScore(): factor 13 ‚Äî glPenalty (0.05 weight)
 *     –û—Ü–µ–Ω–∏–≤–∞–µ—Ç GL –ø—Ä–æ–¥—É–∫—Ç–∞ (GI √ó carbs_–≤_–ø–æ—Ä—Ü–∏–∏ / 100) vs targetGL –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
 *     targetGL=20 (–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∏—ë–º—ã), targetGL=10 (PRE_SLEEP, Ludwig 2002)
 *
 * v3.3.0: PRE_SLEEP category override + sleep GI penalty (20.02.2026)
 *   - determineCategoryMix(): PRE_SLEEP scenario ‚Üí DAIRY-first mix (casein, kefir) instead of GRAINS
 *   - calculateProductScore(): factor 12 ‚Äî sleep GI penalty (0.06 weight)
 *     GRAINS –ø–µ—Ä–µ–¥ —Å–Ω–æ–º ‚Üí score=0; DAIRY ‚Üí score=100; PROTEIN ‚Üí score=90
 *     (Halson 2014: casein pre-sleep ‚Üí MPS without insulin spike)
 *   - mapScenarioToCategory(): added PRE_SLEEP ‚Üí DAIRY mapping
 *
 * v3.2.1: Fat category guaranteed slot (17.02.2026)
 *   - –ì–∞—Ä–∞–Ω—Ç–∏—è –º–∏–Ω–∏–º—É–º 1 —Å–ª–æ—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∂–∏—Ä–æ–≤ –µ—Å–ª–∏ >= 5% –æ—Ç –º–∞–∫—Ä–æ—Å–æ–≤
 *   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∂–∏—Ä—ã (9%) –∏—Å—á–µ–∑–∞–ª–∏ –ø—Ä–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–∏ (0.09 * 5 = 0.45 ‚Üí 0)
 *   - –¢–µ–ø–µ—Ä—å: fatPct >= 5% ‚Üí –º–∏–Ω–∏–º—É–º 1 —Å–ª–æ—Ç ‚Üí DAIRY –≥—Ä—É–ø–ø–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞
 * 
 * v3.2: LATE_EVENING grouped mode (17.02.2026)
 *   - –î–æ–±–∞–≤–ª–µ–Ω LATE_EVENING –≤ BALANCED_SCENARIOS
 *   - –ü—Ä–∏ –ª—é–±–æ–º –æ—Å—Ç–∞—Ç–∫–µ –∫–∞–ª–æ—Ä–∏–π –¥–ª—è –ø–æ–∑–¥–Ω–µ–≥–æ –≤–µ—á–µ—Ä–∞ ‚Üí grouped products (–±–µ–ª–∫–∏ + —É–≥–ª–µ–≤–æ–¥—ã + –∂–∏—Ä—ã)
 *   - –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π –º–æ–ª–æ—á–∫–∏
 * 
 * v3.1: Balanced product mix (17.02.2026)
 *   - determineCategoryMix(): –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è–º –º–∞–∫—Ä–æ—Å–æ–≤
 *   - pickProductsMix(): –ø–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –†–ê–ó–ù–´–• –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
 *   - –î–ª—è PROTEIN_DEFICIT (59g –±–µ–ª–∫–∞, 23g —É–≥–ª–µ–≤–æ–¥–æ–≤) ‚Üí 2 –±–µ–ª–∫–æ–≤—ã—Ö + 1 —É–≥–ª–µ–≤–æ–¥–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
 *   - –ò–∑–±–µ–≥–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ü–∏–∏ (–∫—É—Ä–∏—Ü–∞ + –∏–Ω–¥–µ–π–∫–∞ ‚Üí –∫—É—Ä–∏—Ü–∞ + –≥—Ä–µ—á–∞)
 * 
 * v3.0: 11-factor scoring system (Phase A/B/C patterns integration)
 *   - Phase A (Core): C37 sugar, caffeine-awareness
 *   - Phase B (Context): C10 fiber boost
 *   - Phase C (Micronutrients): C26 minerals, C29 NOVA quality
 * 
 * @module pi_product_picker
 * @version 3.6.0
 * @date 19.02.2026
 */

(function (global) {
    'use strict';

    const MODULE_NAME = 'HEYS.InsightsPI.productPicker';
    const LOG_FILTER = 'MEALREC';
    const LOG_PREFIX = `[${LOG_FILTER}][${MODULE_NAME}]`;

    // ============================================================================
    // Constants
    // ============================================================================

    const HISTORY_DAYS = 30;
    const MIN_PRODUCTS_PER_CATEGORY = 5;

    const PRODUCT_CATEGORIES = {
        DAIRY: 'dairy',
        PROTEIN: 'protein',
        VEGETABLES: 'vegetables',
        FRUITS: 'fruits',
        GRAINS: 'grains',
        SNACKS: 'snacks',
        OTHER: 'other',
    };

    // Caffeine keywords for time-aware filtering (v2.6 feature - prevents coffee before sleep)
    const CAFFEINE_KEYWORDS = [
        '–∫–æ—Ñ–µ', 'coffee', '—ç—Å–ø—Ä–µ—Å—Å–æ', 'espresso', '–∫–∞–ø—É—á–∏–Ω–æ', 'cappuccino', '–ª–∞—Ç—Ç–µ', 'latte',
        '—á–∞–π —á–µ—Ä–Ω—ã–π', '—á—ë—Ä–Ω—ã–π —á–∞–π', 'black tea', '—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫', 'energy drink', '—ç–Ω–µ—Ä–¥–∂–∏'
    ];

    // Added sugar cues for dependency-aware penalty (Phase A: C37)
    const ADDED_SUGAR_KEYWORDS = [
        '—Å–∞—Ö–∞—Ä', 'sugar', '—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç', '–ø–µ—á–µ–Ω—å–µ', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–∂', '—Å–∏—Ä–æ–ø',
        '–≥–∞–∑–∏—Ä–æ–≤–∫–∞', 'cola', '–∫–æ–∫–∞-–∫–æ–ª–∞', '—Å–æ–∫', 'juice', '–º–æ—Ä–æ–∂–µ–Ω–æ–µ', '–≤–∞—Ä–µ–Ω—å–µ', '–º–µ–¥'
    ];

    const EVENING_CAFFEINE_CUTOFF_HOUR = 20; // After 20:00, penalize caffeine heavily

    // Category keywords –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    const CATEGORY_KEYWORDS = {
        dairy: ['–º–æ–ª–æ–∫–æ', '—Ç–≤–æ—Ä–æ–≥', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '—Å—ã—Ä', '—Ä—è–∂–µ–Ω–∫–∞', '—Å–º–µ—Ç–∞–Ω–∞'],
        protein: ['–∫—É—Ä–∏—Ü–∞', '–∫—É—Ä–∏—Ü', '–∫—É—Ä–∏–Ω', '–º—è—Å–æ', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '—Ä—ã–±–∞', '—è–π—Ü', '—è–π–∫–æ', '—è–π', '–∏–Ω–¥–µ–π–∫–∞', '—Ç—É–Ω–µ—Ü', '–≥—Ä—É–¥–∫–∞'],
        vegetables: ['–æ–≥—É—Ä–µ—Ü', '–æ–≥—É—Ä—Ü', '–ø–æ–º–∏–¥–æ—Ä', '–∫–∞–ø—É—Å—Ç–∞', '–º–æ—Ä–∫–æ–≤—å', '—Å–∞–ª–∞—Ç', '–ø–µ—Ä–µ—Ü', '–±—Ä–æ–∫–∫–æ–ª–∏'],
        fruits: ['—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–≥—Ä—É—à–∞', '–∫–∏–≤–∏', '—è–≥–æ–¥', '–≤–∏–Ω–æ–≥—Ä–∞–¥'],
        grains: ['—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–æ–≤—Å—è–Ω–∫–∞', '—Ö–ª–µ–±', '–º–∞–∫–∞—Ä–æ–Ω', '–∫—Ä—É–ø–∞', '–∫–∞—à–∞'],
        snacks: ['–æ—Ä–µ—Ö', '–±–∞—Ç–æ–Ω—á–∏–∫', '–ø–µ—á–µ–Ω—å–µ', '–∫—Ä–µ–∫–µ—Ä', '—á–∏–ø—Å—ã'],
    };

    // Scoring weights for v4.0.0 (S10 "Smart Scoring")
    // Macro alignment total: 0.49 (prot+carb+fat+kcal). Binary total: 0.06 (tie-breakers). Sum=1.00
    const SCORING_WEIGHTS = {
        proteinAlignment: 0.25, // ‚Üë was 0.20 ‚Äî –≥–ª–∞–≤–Ω—ã–π –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞—Ç–æ—Ä
        carbAlignment: 0.14, // ‚Üë was 0.11
        fatAlignment: 0.10, // NEW ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–ª–µ–ø—É—é –∑–æ–Ω—É –∂–∏—Ä–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
        kcalFit: 0.10, // was 0.11 (soft linear penalty)
        caffeineAwareness: 0.03, // ‚Üì was 0.08 (tie-breaker)
        sugarAwareness: 0.03, // ‚Üì was 0.08 (tie-breaker)
        fiberBoost: 0.06, // ‚Üì was 0.07
        micronutrientBoost: 0.06, // ‚Üì was 0.09
        novaQuality: 0.05, // ‚Üì was 0.07
        harmMinimization: 0.03, // ‚Üë was 0.02
        familiarityBoost: 0.02, // ‚Üë was 0.01
        sleepGIPenalty: 0.05, // ‚Üì was 0.06
        glPenalty: 0.04, // ‚Üì was 0.05
        workoutCarbBoost: 0.04, // ‚Üì was 0.05
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Spam-safe grouped logging for hottest paths (macro + GL warnings)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _activePickerLogCycle = null;

    function startPickerLogCycle(meta) {
        _activePickerLogCycle = {
            meta: meta || {},
            macroRows: [],
            glWarnings: [],
            highScoreRows: [],
            pickedRows: [],
        };
    }

    function pushPickerLogRow(type, payload) {
        if (!_activePickerLogCycle) return;
        if (type === 'macro') {
            _activePickerLogCycle.macroRows.push(payload);
            return;
        }
        if (type === 'glWarning') {
            _activePickerLogCycle.glWarnings.push(payload);
            return;
        }
        if (type === 'highScore') {
            _activePickerLogCycle.highScoreRows.push(payload);
            return;
        }
        if (type === 'picked') {
            _activePickerLogCycle.pickedRows.push(payload);
        }
    }

    function flushPickerLogCycle() {
        if (!_activePickerLogCycle) return;
        const cycle = _activePickerLogCycle;
        _activePickerLogCycle = null;

        // 1) Macro rows: very noisy. Group by scenario and print compact top set.
        if (cycle.macroRows.length > 0) {
            const byScenario = {};
            cycle.macroRows.forEach((row) => {
                const key = row.scenario || 'UNKNOWN';
                byScenario[key] = byScenario[key] || { count: 0, rows: [] };
                byScenario[key].count += 1;
                if (byScenario[key].rows.length < 8) byScenario[key].rows.push(row);
            });

            const summary = Object.entries(byScenario).map(([scenario, info]) => ({
                scenario,
                total: info.count,
                shown: info.rows.length,
            }));
            console.info(`${LOG_PREFIX} üß™ [macro] grouped summary:`, {
                groups: summary,
                cycle: cycle.meta,
            });

            Object.entries(byScenario).forEach(([scenario, info]) => {
                console.group(`${LOG_PREFIX} üß™ [macro] ${scenario}: showing ${info.rows.length}/${info.count}`);
                console.table(info.rows);
                console.groupEnd();
            });
        }

        // 2) GL warnings: keep signal, collapse duplicates.
        if (cycle.glWarnings.length > 0) {
            const top = cycle.glWarnings
                .slice()
                .sort((a, b) => b.glOverflow - a.glOverflow)
                .slice(0, 10)
                .map((w) => ({
                    product: w.product,
                    scenario: w.scenario,
                    productGL: w.productGL,
                    targetGL: w.targetGL,
                    overflow: w.glOverflow,
                    glPenaltyScore: w.glPenaltyScore,
                }));
            console.warn(`${LOG_PREFIX} üìä [GL] grouped warnings:`, {
                total: cycle.glWarnings.length,
                shown: top.length,
                cycle: cycle.meta,
            });
            console.table(top);
        }

        // 3) Picked tables: collapse repeated per-category dumps into one compact summary.
        if (cycle.pickedRows.length > 0) {
            const grouped = cycle.pickedRows.map((r) => ({
                scenario: r.scenario,
                category: r.category,
                strategy: r.strategy,
                evaluated: r.evaluated,
                selected: r.selected,
                sampleTop: r.sampleTop,
            }));

            console.info(`${LOG_PREFIX} ü•á [picked] grouped summary:`, {
                totalGroups: grouped.length,
                cycle: cycle.meta,
            });
            console.table(grouped);
        }
    }

    function buildLocalStorageFallbackLsGet() {
        return function (key, fallback = null) {
            try {
                const raw = localStorage.getItem(key);
                if (raw === null || raw === undefined) return fallback;
                return JSON.parse(raw);
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è localStorage fallback read failed:`, {
                    key,
                    message: err?.message,
                });
                return fallback;
            }
        };
    }

    function resolveLsGet(lsGetFromParams) {
        if (typeof lsGetFromParams === 'function') return lsGetFromParams;
        if (typeof global.U?.lsGet === 'function') return global.U.lsGet.bind(global.U);
        if (typeof global.HEYS?.utils?.lsGet === 'function') return global.HEYS.utils.lsGet.bind(global.HEYS.utils);
        return buildLocalStorageFallbackLsGet();
    }

    // v4.0.0: S10 fix ‚Äî Scenario-based ideal macro profiles
    // Root cause of flat scoring: computing Enegy% target as targetProteinG/targetKcal
    // gives 21% for PROTEIN_DEFICIT (73g/1026kcal) ‚Üí chicken (58%) scores 0, bread (14%) scores 79 ‚Äî WRONG.
    // Fix: use scenario-specific IDEAL product composition profiles (what type of product helps this scenario).
    // Based on nutritional science (TEF-adjusted protein=3 kcal/g: Livesey 2001)
    const SCENARIO_IDEAL_MACRO_PROFILES = {
        // PROTEIN_DEFICIT: need protein-rich products ‚Üí high protein En%, moderate fat, low carbs
        PROTEIN_DEFICIT: { protPct: 45, carbPct: 15, fatPct: 40 },  // Chicken=58%‚Üídiff13 | Bread=14%‚Üídiff31
        // STRESS_EATING: same logic ‚Äî protein helps satiety and reduces cortisol-driven cravings
        STRESS_EATING: { protPct: 40, carbPct: 20, fatPct: 40 },
        // POST_WORKOUT: anabolic window ‚Äî fast carbs + protein (Ivy 2004: ~3:1 carb:protein)
        POST_WORKOUT: { protPct: 25, carbPct: 55, fatPct: 20 },
        // PRE_SLEEP: casein-friendly, low GI, low carbs (Halson 2014)
        PRE_SLEEP: { protPct: 35, carbPct: 15, fatPct: 50 },  // Dairy=fat+prot | Bread=carbs ‚Üí penalized
        // LATE_EVENING: light, moderate protein, lower carbs
        LATE_EVENING: { protPct: 35, carbPct: 20, fatPct: 45 },
        // LIGHT_SNACK: volume food, high water content, moderate everything
        LIGHT_SNACK: { protPct: 25, carbPct: 40, fatPct: 35 },
        // BALANCED / default: standard healthy plate (~30/40/30)
        BALANCED: { protPct: 30, carbPct: 40, fatPct: 30 },
        DEFAULT: { protPct: 30, carbPct: 40, fatPct: 30 },
    };

    /**
     * –°–æ–±–∏—Ä–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å—ä–µ–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
     * @param {number} days - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
     * @param {Function} lsGet - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
     * @returns {Object} –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
     */
    function analyzeProductHistory(days, lsGet) {
        const dateOffsetStr = global.HEYS?.utils?.dateOffsetStr || function (offset) {
            const d = new Date();
            d.setDate(d.getDate() + offset);
            return d.toISOString().split('T')[0];
        };

        const productMap = new Map(); // productName -> stats

        for (let i = 0; i < days; i++) {
            const date = dateOffsetStr(-i);
            const dayData = lsGet(`heys_dayv2_${date}`);
            if (!dayData || !dayData.meals) continue;

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø—Ä–∏—ë–º–∞–º –ø–∏—â–∏
            dayData.meals.forEach((meal) => {
                if (!meal.items) return;

                meal.items.forEach((item) => {
                    const productName = item.title || item.name;
                    if (!productName) return;

                    if (!productMap.has(productName)) {
                        productMap.set(productName, {
                            name: productName,
                            product_id: item.product_id,
                            frequency: 0,
                            totalGrams: 0,
                            avgGrams: 0,
                            lastEaten: date,
                            timesOfDay: [],
                            macros: {
                                protein: item.prot || 0,
                                carbs: item.carb || 0,
                                fat: item.fat || 0,
                                kcal: item.kcal || 0,
                            },
                            harm: item.harm || 0,
                            gi: item.gi || 50, // default medium GI
                        });
                    }

                    const stats = productMap.get(productName);
                    stats.frequency += 1;
                    stats.totalGrams += item.grams || 100;
                    stats.timesOfDay.push(meal.time || '12:00');

                    // Update macros (weighted average)
                    if (item.prot) stats.macros.protein = item.prot;
                    if (item.carb) stats.macros.carbs = item.carb;
                    if (item.fat) stats.macros.fat = item.fat;
                    if (item.kcal) stats.macros.kcal = item.kcal;
                });
            });
        }

        // Calculate averages and familiarity scores
        const products = Array.from(productMap.values()).map((p) => {
            p.avgGrams = p.totalGrams / p.frequency;
            p.familiarityScore = calculateFamiliarityScore(p.frequency, days);
            p.category = detectCategory(p.name);
            return p;
        });

        const grouped = groupByCategory(products);
        const avgFrequency = products.reduce((sum, p) => sum + p.frequency, 0) / products.length || 0;

        console.info(`${LOG_PREFIX} üìä History analyzed:`, {
            daysAnalyzed: days,
            totalProducts: products.length,
            avgFrequency: Math.round(avgFrequency * 10) / 10,
            byCategory: {
                dairy: grouped.dairy?.length || 0,
                protein: grouped.protein?.length || 0,
                vegetables: grouped.vegetables?.length || 0,
                fruits: grouped.fruits?.length || 0,
                grains: grouped.grains?.length || 0,
                snacks: grouped.snacks?.length || 0,
                other: grouped.other?.length || 0,
            },
            topProducts: products
                .sort((a, b) => b.frequency - a.frequency)
                .slice(0, 3)
                .map(p => ({ name: p.name, frequency: p.frequency, category: p.category }))
        });

        return {
            products,
            totalProducts: products.length,
            byCategory: grouped,
            avgFrequency,
        };
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç familiarity score (1-10) –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞—Å—Ç–æ—Ç—ã —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
     * @param {number} frequency - —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å—ä–µ–¥–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥
     * @param {number} totalDays - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –ø–µ—Ä–∏–æ–¥–µ
     * @returns {number} score –æ—Ç 1 –¥–æ 10
     */
    function calculateFamiliarityScore(frequency, totalDays) {
        const ratio = frequency / totalDays;
        // 0.03 (1x/month) -> 3, 0.1 (3x/month) -> 5, 0.2 (6x/month) -> 7, 0.5+ (15x/month) -> 10
        if (ratio >= 0.5) return 10;
        if (ratio >= 0.3) return 9;
        if (ratio >= 0.2) return 7;
        if (ratio >= 0.1) return 5;
        if (ratio >= 0.05) return 3;
        return 1;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
     * @param {string} productName - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
     * @returns {string} –∫–∞—Ç–µ–≥–æ—Ä–∏—è
     */
    function detectCategory(productName) {
        const normalized = productName.toLowerCase();

        for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
            if (keywords.some((kw) => normalized.includes(kw))) {
                return category;
            }
        }

        return PRODUCT_CATEGORIES.OTHER;
    }

    /**
     * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
     * @param {Array} products - —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     * @returns {Object} –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
     */
    function groupByCategory(products) {
        const grouped = {};
        Object.values(PRODUCT_CATEGORIES).forEach((cat) => {
            grouped[cat] = [];
        });

        products.forEach((p) => {
            const cat = p.category || PRODUCT_CATEGORIES.OTHER;
            grouped[cat].push(p);
        });

        return grouped;
    }

    // ============================================================================
    // Multi-Factor Scoring System
    // ============================================================================

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∫–æ—Ñ–µ–∏–Ω
     * @param {string} productName - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
     * @returns {boolean} true –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ñ–µ–∏–Ω
     */
    function containsCaffeine(productName) {
        const normalized = productName.toLowerCase();
        return CAFFEINE_KEYWORDS.some((kw) => normalized.includes(kw));
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)
     * @param {string} productName
     * @returns {boolean}
     */
    function containsAddedSugar(productName) {
        const normalized = productName.toLowerCase();
        return ADDED_SUGAR_KEYWORDS.some((kw) => normalized.includes(kw));
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç multi-factor score –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
     * @param {Object} product - –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
     * @param {Object} scenario - –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è (remainingKcal, targetProtein, currentTime, etc.)
     * @param {number} typicalPortion - —Ç–∏–ø–∏—á–Ω–∞—è –ø–æ—Ä—Ü–∏—è (grams) –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
     * @returns {number} score –æ—Ç 0 –¥–æ 100
     */
    function calculateProductScore(product, scenario, typicalPortion = 100) {
        const scores = {};

        // S10 v4.0.1: Scenario Ideal Profile approach ‚Äî FIX for flat scoring.
        // Root cause: derived target (73g prot / 1026kcal = 21%) made chicken(58%) score 0, bread(14%) score 79 ‚Äî inverted!
        // Fix: use SCENARIO_IDEAL_MACRO_PROFILES ‚Äî what TYPE of product density helps this scenario.
        const prodKcal = product.macros.kcal || 1; // Avoid div/0
        const scenarioType = scenario.scenario || scenario.type || 'DEFAULT';
        const idealProfile = SCENARIO_IDEAL_MACRO_PROFILES[scenarioType] || SCENARIO_IDEAL_MACRO_PROFILES.DEFAULT;

        // 1. Protein Alignment (25%) ‚Äî product protein% vs scenario ideal protein% (TEF-adjusted 3 kcal/g)
        const proteinEnPct = (product.macros.protein * 3 / prodKcal) * 100;
        const proteinDiff = Math.abs(proteinEnPct - idealProfile.protPct);
        scores.proteinAlignment = Math.max(0, 100 - proteinDiff * 2.0); // √ó2: 20%diff‚Üí60, 50%diff‚Üí0

        // 2. Carb Alignment (14%) ‚Äî 4 kcal/g
        const carbEnPct = (product.macros.carbs * 4 / prodKcal) * 100;
        const carbDiff = Math.abs(carbEnPct - idealProfile.carbPct);
        scores.carbAlignment = Math.max(0, 100 - carbDiff * 2.0);

        // 3. Fat Alignment (10%) ‚Äî Atwater 9 kcal/g (no TEF correction for fat)
        const fatEnPct = (product.macros.fat * 9 / prodKcal) * 100;
        const fatDiff = Math.abs(fatEnPct - idealProfile.fatPct);
        scores.fatAlignment = Math.max(0, 100 - fatDiff * 1.5); // √ó1.5: softer ‚Äî fat varies widely

        pushPickerLogRow('macro', {
            product: product.name.substring(0, 32),
            scenario: scenarioType,
            ideal: `P${idealProfile.protPct}/C${idealProfile.carbPct}/F${idealProfile.fatPct}`,
            prod: `P${Math.round(proteinEnPct)}/C${Math.round(carbEnPct)}/F${Math.round(fatEnPct)}`,
            scores: `prot=${Math.round(scores.proteinAlignment)},carb=${Math.round(scores.carbAlignment)},fat=${Math.round(scores.fatAlignment)}`,
        });

        // 4. Kcal Fit (10%) ‚Äî Soft Linear Penalty (v4.0.0)
        // Plan: ratio ‚â§ 0.8 ‚Üí 100 (ideal), > 0.8 ‚Üí linear decline, 0 at ratio = 1.2
        // Ensures multi-meal portions (each ~50% budget) score 100, not penalised
        const portionKcal = (prodKcal * typicalPortion) / 100;
        const remainingKcal = scenario.remainingKcal || 400;
        const kcalRatio = portionKcal / remainingKcal;

        if (kcalRatio <= 0.8) {
            scores.kcalFit = 100; // Ideal: portion fits within 80% of remaining budget
        } else {
            // Linear decline from 100 at 0.80 to 0 at 1.20 (slope = -250)
            scores.kcalFit = Math.max(0, 100 - (kcalRatio - 0.8) * 250);
        }

        // 5. Caffeine Awareness (3%) ‚Äî binary tie-breaker, v2.6 time-sensitive filter
        const hasCaffeine = containsCaffeine(product.name);
        const currentHour = scenario.currentTime ? Math.floor(scenario.currentTime) : 12;
        if (hasCaffeine && currentHour >= EVENING_CAFFEINE_CUTOFF_HOUR) {
            scores.caffeineAwareness = 0; // Hard penalty after 20:00
        } else if (hasCaffeine) {
            scores.caffeineAwareness = 80;
        } else {
            scores.caffeineAwareness = 100;
        }

        // 6. Sugar Awareness (2%) - Tie-breaker
        const hasAddedSugar = containsAddedSugar(product.name);
        const dependencyRisk = !!scenario.sugarDependencyRisk;
        if (dependencyRisk && hasAddedSugar) {
            scores.sugarAwareness = 0; // Avoid triggers
        } else if (hasAddedSugar) {
            scores.sugarAwareness = 60; // Moderate penalty
        } else {
            scores.sugarAwareness = 100;
        }

        // 6. GI Awareness (—É–¥–∞–ª–µ–Ω–∞, merged –≤ –¥—Ä—É–≥–∏–µ factors)

        // 7. Fiber Boost (8%) - Phase B C10: boost high-fiber products if deficit
        const fiberRegScore = Number(scenario.fiberRegularityScore);
        const fiber100g = Number(product.fiber || product.cellulose || 0); // fiber per 100g
        if (Number.isFinite(fiberRegScore) && fiberRegScore < 0.6) {
            // Fiber deficit detected ‚Üí boost fiber-rich products exponentially
            if (fiber100g >= 10) {
                scores.fiberBoost = 100; // Very high fiber (10g+/100g)
            } else if (fiber100g >= 5) {
                scores.fiberBoost = 80; // High fiber (5-10g/100g)
            } else if (fiber100g >= 2) {
                scores.fiberBoost = 50; // Medium fiber (2-5g/100g)
            } else {
                scores.fiberBoost = 20; // Low fiber (<2g/100g)
            }
        } else {
            scores.fiberBoost = 70; // Default neutral score (no fiber penalty)
        }

        // 8. Micronutrient Boost (10%) - Phase C C26: boost products rich in deficit minerals
        const microDeficits = scenario.micronutrientDeficits || []; // array: [{nutrient: 'iron', avgPct: 45}, ...]
        let microBoost = 50; // Default neutral
        if (microDeficits.length > 0) {
            // Check if product is rich in deficient minerals
            const productMinerals = {
                iron: Number(product.iron || product.fe || 0),
                magnesium: Number(product.magnesium || product.mg || 0),
                zinc: Number(product.zinc || product.zn || 0),
                calcium: Number(product.calcium || product.ca || 0)
            };

            const richInDeficit = microDeficits.some(d => {
                const mineralKey = d.nutrient;
                const richThreshold = mineralKey === 'iron' ? 3 : mineralKey === 'magnesium' ? 50 : mineralKey === 'zinc' ? 2 : 150; // per 100g
                return productMinerals[mineralKey] >= richThreshold;
            });

            if (richInDeficit) {
                microBoost = 100; // Strong boost for products rich in deficit minerals
            } else {
                microBoost = 40; // Penalty if not addressing deficits
            }
        }
        scores.micronutrientBoost = microBoost;

        // 9. NOVA Quality (8%) - Phase C C29: penalty for ultra-processed (NOVA-4)
        const novaQualityScore = Number(scenario.novaQualityScore);
        const productNova = Number(product.nova_group || product.novaGroup || 3); // Default to NOVA-3
        let novaPenalty = 70; // Default neutral
        if (Number.isFinite(novaQualityScore) && novaQualityScore < 0.6) {
            // High ultra-processed share ‚Üí strongly prefer NOVA 1-2
            if (productNova === 4) {
                novaPenalty = 0; // Hard penalty for NOVA-4 when quality is low
            } else if (productNova === 3) {
                novaPenalty = 50; // Moderate penalty for NOVA-3
            } else {
                novaPenalty = 100; // Reward NOVA 1-2
            }
        } else {
            // Normal quality ‚Üí mild preference for lower NOVA
            novaPenalty = productNova === 4 ? 30 : productNova === 3 ? 60 : 90;
        }
        scores.novaQuality = novaPenalty;

        // 10. Harm Minimization (4%)
        const harmScore = product.harm || 0;
        scores.harmMinimization = Math.max(0, 100 - harmScore * 10); // harm 0-10 scale

        // 11. Familiarity Boost (1%)
        scores.familiarityBoost = product.familiarityScore * 10; // 1-10 -> 10-100

        // 12. Sleep GI Penalty (6%) - v3.3+v4.0.5: PRE_SLEEP & LATE_EVENING avoid high-GI carbs (Halson 2014)
        // Casein/dairy pre-sleep ‚Üí steady amino acid release without blood sugar spike
        // GRAINS (bread, pasta, rice) ‚Üí rapid glucose ‚Üí disrupts deep sleep architecture
        // v4.0.5: Extended to LATE_EVENING ‚Äî same sleep-disruption risk after 21:00
        const mealScenarioType = scenario.scenario || scenario.type;
        const isPreSleepScenario = mealScenarioType === 'PRE_SLEEP' || mealScenarioType === 'LATE_EVENING';
        if (isPreSleepScenario) {
            const productCat = product.category || 'other';
            if (productCat === PRODUCT_CATEGORIES.GRAINS) {
                scores.sleepGIPenalty = 0; // Hard penalty: high-GI carbs disrupt sleep
                console.warn(`${LOG_PREFIX} üåô‚ùå GRAINS penalized (PRE_SLEEP scenario):`, { product: product.name });
            } else if (productCat === PRODUCT_CATEGORIES.DAIRY) {
                scores.sleepGIPenalty = 100; // Boost: casein/kefir optimal pre-sleep
            } else if (productCat === PRODUCT_CATEGORIES.PROTEIN) {
                scores.sleepGIPenalty = 90; // Good: lean protein (poultry, eggs)
            } else {
                scores.sleepGIPenalty = 65; // Neutral for other categories
            }
        } else {
            scores.sleepGIPenalty = 50; // Neutral baseline for non-sleep meals (50=symmetric, widened dynamic range)
        }

        // 13. Glycemic Load Penalty (5%) - v3.4: F2 penalise products pushing GL over targetGL (Ludwig, 2002)
        // GL = GI √ó carbs_in_portion / 100; targetGL from planner (20=day, 10=PRE_SLEEP)
        const targetGLValue = scenario.targetGL;
        if (targetGLValue != null && Number.isFinite(targetGLValue) && targetGLValue > 0) {
            // Fallback GI by category when product lacks explicit .gi field
            const GI_BY_CATEGORY = {
                [PRODUCT_CATEGORIES.GRAINS]: 65,
                [PRODUCT_CATEGORIES.FRUITS]: 52,
                [PRODUCT_CATEGORIES.SNACKS]: 60,
                [PRODUCT_CATEGORIES.DAIRY]: 30,
                [PRODUCT_CATEGORIES.VEGETABLES]: 25,
                [PRODUCT_CATEGORIES.PROTEIN]: 5,
                [PRODUCT_CATEGORIES.OTHER]: 50,
            };
            const productGI = Number(product.gi || product.glycemicIndex ||
                GI_BY_CATEGORY[product.category] || GI_BY_CATEGORY[PRODUCT_CATEGORIES.OTHER]);
            const carbsInPortion = (product.macros.carbs * typicalPortion) / 100;
            const productGL = (productGI * carbsInPortion) / 100;

            if (productGL <= targetGLValue) {
                scores.glPenalty = 100; // Within target ‚Äî perfect
            } else if (productGL <= targetGLValue * 1.5) {
                scores.glPenalty = 70; // 0-50% over target ‚Äî mild penalty
            } else if (productGL <= targetGLValue * 2.5) {
                scores.glPenalty = 40; // 50-150% over target ‚Äî significant penalty
            } else {
                scores.glPenalty = 10; // >150% over target ‚Äî strong penalty
            }

            if (scores.glPenalty < 70) {
                const roundedGL = Math.round(productGL * 10) / 10;
                pushPickerLogRow('glWarning', {
                    product: product.name,
                    scenario: mealScenarioType || 'UNKNOWN',
                    productGI,
                    carbsInPortion: Math.round(carbsInPortion),
                    productGL: roundedGL,
                    targetGL: targetGLValue,
                    glOverflow: Math.round((roundedGL - targetGLValue) * 10) / 10,
                    glPenaltyScore: scores.glPenalty,
                });
            }
        } else {
            scores.glPenalty = 50; // No targetGL available ‚Äî neutral baseline (50=symmetric, widened dynamic range)
        }

        // 14. Workout Carb Boost (5%) - v3.5: F3 POST_WORKOUT anabolic window (Ivy 2004)
        // Within 2h after training: fast carbs replenish glycogen + blunt cortisol spike
        // GRAINS (rice, oats, potato) ‚Üí ideal; FRUITS (banana) ‚Üí good; PROTEIN ‚Üí necessary for MPS
        // DAIRY ‚Üí moderate (casein too slow); fats ‚Üí penalise (delay gastric emptying)
        const isPostWorkoutScenario = mealScenarioType === 'POST_WORKOUT';
        if (isPostWorkoutScenario) {
            const productCatPW = product.category || 'other';
            if (productCatPW === PRODUCT_CATEGORIES.GRAINS) {
                scores.workoutCarbBoost = 100; // Ideal: fast carbs for glycogen replenishment
            } else if (productCatPW === PRODUCT_CATEGORIES.FRUITS) {
                scores.workoutCarbBoost = 90;  // Good: fructose+glucose (banana, etc.)
            } else if (productCatPW === PRODUCT_CATEGORIES.PROTEIN) {
                scores.workoutCarbBoost = 85;  // Necessary: MPS (0.35g/kg, Ivy 2004)
            } else if (productCatPW === PRODUCT_CATEGORIES.DAIRY) {
                scores.workoutCarbBoost = 70;  // Moderate: casein too slow for anabolic window
            } else {
                scores.workoutCarbBoost = 40;  // Low: fats/snacks slow absorption
            }
            if (scores.workoutCarbBoost >= 90) {
                console.info(`${LOG_PREFIX} üèãÔ∏è POST_WORKOUT carb boost:`, {
                    product: product.name,
                    category: productCatPW,
                    score: scores.workoutCarbBoost,
                });
            }
        } else {
            scores.workoutCarbBoost = 50; // Neutral baseline for non-workout meals (50=symmetric, widened dynamic range)
        }

        // Weighted sum (15 factors v4.0.0, sum=1.00)
        const totalScore =
            scores.proteinAlignment * SCORING_WEIGHTS.proteinAlignment +
            scores.carbAlignment * SCORING_WEIGHTS.carbAlignment +
            scores.fatAlignment * SCORING_WEIGHTS.fatAlignment +
            scores.kcalFit * SCORING_WEIGHTS.kcalFit +
            scores.caffeineAwareness * SCORING_WEIGHTS.caffeineAwareness +
            scores.sugarAwareness * SCORING_WEIGHTS.sugarAwareness +
            scores.fiberBoost * SCORING_WEIGHTS.fiberBoost +
            scores.micronutrientBoost * SCORING_WEIGHTS.micronutrientBoost +
            scores.novaQuality * SCORING_WEIGHTS.novaQuality +
            scores.harmMinimization * SCORING_WEIGHTS.harmMinimization +
            scores.familiarityBoost * SCORING_WEIGHTS.familiarityBoost +
            scores.sleepGIPenalty * SCORING_WEIGHTS.sleepGIPenalty +
            scores.glPenalty * SCORING_WEIGHTS.glPenalty +
            scores.workoutCarbBoost * SCORING_WEIGHTS.workoutCarbBoost;

        // Apply ML weight multiplier from feedback loop (R2.7)
        let mlWeightMultiplier = 1.0;
        if (global.HEYS?.InsightsPI?.feedbackLoop?.getProductWeight) {
            const rawProfile = scenario.profile || global.HEYS?.profile;
            // v3.6: F4 fix ‚Äî profile.id –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ heys_profile; –∏—Å–ø–æ–ª—å–∑—É–µ–º currentClientId –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            const profileWithId = rawProfile
                ? { ...rawProfile, id: rawProfile.id || global.HEYS?.currentClientId || 'default' }
                : (global.HEYS?.currentClientId ? { id: global.HEYS.currentClientId } : null);
            const productId = product.id || product.product_id; // v3.6: F4 fix ‚Äî history uses .product_id, fallback uses .id
            const scenarioType = scenario.scenario || scenario.type || 'UNKNOWN'; // v3.6: F4 fix ‚Äî scenario stored in .scenario, not .type

            // v3.6: F4 ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ID –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã)
            if (!window._f4DiagLogged) {
                window._f4DiagLogged = true;
                console.info(`${LOG_PREFIX} üîç [F4] EMA system state:`, {
                    hasProfile: !!profileWithId,
                    clientId: profileWithId?.id || null,
                    hasProductId: !!productId,
                    scenarioType,
                    storageKey: `heys_meal_rec_weights_${profileWithId?.id || 'default'}`,
                    note: 'multiplier=1.0 until first üëç/üëé feedback',
                });
            }

            if (profileWithId && productId) {
                mlWeightMultiplier = global.HEYS.InsightsPI.feedbackLoop.getProductWeight(
                    profileWithId,
                    productId,
                    scenarioType
                );
                if (mlWeightMultiplier !== 1.0) {
                    console.info(`${LOG_PREFIX} ü§ñ [F4] ML weight applied:`, {
                        product: product.name,
                        scenario: scenarioType,
                        multiplier: mlWeightMultiplier.toFixed(3),
                        clientId: profileWithId.id,
                    });
                }
            }
        }

        const mlAdjustedScore = totalScore * mlWeightMultiplier;
        const finalScore = Math.round(mlAdjustedScore);

        // Phase B/C verification logging (once per pick cycle)
        if (!window._phaseVerifyLogged && finalScore > 60) {
            window._phaseVerifyLogged = true;
            console.info(`${LOG_PREFIX} üî¨ Phase B/C Scoring Factors (v3.0):`, {
                product: product.name,
                fiberBoost: scores.fiberBoost,
                fiberRegScore,
                micronutrientBoost: scores.micronutrientBoost,
                microDeficits: microDeficits.length,
                novaQuality: scores.novaQuality,
                novaQualityScore,
                productNova,
                mlWeightMultiplier: mlWeightMultiplier !== 1.0 ? mlWeightMultiplier.toFixed(3) : undefined
            });
        }

        // Verbose logging only for high scores (> 70) to avoid spam
        if (finalScore > 70) {
            // Sort by weighted contribution (score √ó weight) to show differentiating factors,
            // not universal-100 factors like kcalFit/caffeineAwareness/sugarAwareness
            const topFactors = Object.entries(scores)
                .filter(([key]) => SCORING_WEIGHTS[key] != null)
                .sort((a, b) => (b[1] * (SCORING_WEIGHTS[b[0]] || 0)) - (a[1] * (SCORING_WEIGHTS[a[0]] || 0)))
                .slice(0, 4)
                .map(([key, val]) => `${key}=${Math.round(val)}`)
                .join(', ');
            pushPickerLogRow('highScore', {
                product: product.name,
                score: finalScore,
                topFactors,
                scenario: scenarioType,
            });
        }

        return {
            totalScore: finalScore,
            breakdown: scores,
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç mix –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –º–∞–∫—Ä–æ—Å–æ–≤
     * v3.3: PRE_SLEEP —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Üí sleep-friendly override (DAIRY-first, no GRAINS)
     *
     * –ü—Ä–∏–º–µ—Ä: targetProteinG=59, targetCarbsG=23, targetFatG=3
     * ‚Üí ~66% –±–µ–ª–æ–∫, ~26% —É–≥–ª–µ–≤–æ–¥—ã, ~8% –∂–∏—Ä
     * ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç [PROTEIN, PROTEIN, GRAINS] (2 –±–µ–ª–∫–æ–≤—ã—Ö + 1 —É–≥–ª–µ–≤–æ–¥–Ω—ã–π)
     * PRE_SLEEP: ‚Üí [DAIRY, PROTEIN, PROTEIN] (1 –º–æ–ª–æ—á–Ω—ã–π + 2 –±–µ–ª–∫–æ–≤—ã—Ö, –±–µ–∑ –∫—Ä—É–ø)
     *
     * @param {number} targetProteinG - —Ü–µ–ª–µ–≤–æ–π –±–µ–ª–æ–∫ –≤ –≥—Ä–∞–º–º–∞—Ö
     * @param {number} targetCarbsG - —Ü–µ–ª–µ–≤—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –≤ –≥—Ä–∞–º–º–∞—Ö
     * @param {number} targetFatG - —Ü–µ–ª–µ–≤–æ–π –∂–∏—Ä –≤ –≥—Ä–∞–º–º–∞—Ö
     * @param {number} limit - —Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–∫—Å (–æ–±—ã—á–Ω–æ 3)
     * @param {string|null} scenarioType - —Ç–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è ('PRE_SLEEP', 'PROTEIN_DEFICIT', etc.)
     * @returns {Array<string>} –º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–æ–¥–±–æ—Ä–∞
     */
    function determineCategoryMix(targetProteinG, targetCarbsG, targetFatG, limit = 3, scenarioType = null) {
        // v3.5: POST_WORKOUT override ‚Äî fast carbs first (Ivy 2004 anabolic window)
        // Glycogen replenishment: 1.0g/kg carbs + 0.35g/kg protein within 2h post-workout
        // GRAINS (rice, potato, oats, pasta) replenish muscle glycogen rapidly
        if (scenarioType === 'POST_WORKOUT') {
            const workoutMix = [];
            const carbSlots = Math.ceil(limit * 2 / 3); // 2/3 carbs slots (Ivy 2004 ~3:1 ratio)
            for (let i = 0; i < limit; i++) {
                workoutMix.push(i < carbSlots ? PRODUCT_CATEGORIES.GRAINS : PRODUCT_CATEGORIES.PROTEIN);
            }
            console.info(`${LOG_PREFIX} üèãÔ∏è POST_WORKOUT category override:`, {
                categories: workoutMix,
                reason: 'Ivy 2004: anabolic window 2h ‚Äî fast carbs for glycogen + protein for MPS',
                limit
            });
            return workoutMix;
        }

        // v3.3: PRE_SLEEP override ‚Äî sleep-friendly categories (Halson 2014)
        // Casein/kefir/cottage cheese: slow-digesting, no insulin spike, supports MPS during sleep
        // Avoid GRAINS (bread, pasta, rice): rapid glucose ‚Üí disrupts deep sleep architecture
        if (scenarioType === 'PRE_SLEEP') {
            const sleepMix = [];
            for (let i = 0; i < limit; i++) {
                sleepMix.push(i === 0 ? PRODUCT_CATEGORIES.DAIRY : PRODUCT_CATEGORIES.PROTEIN);
            }
            console.info(`${LOG_PREFIX} üåô PRE_SLEEP category override:`, {
                categories: sleepMix,
                reason: 'Halson 2014: casein pre-sleep ‚Üí MPS without insulin spike',
                limit
            });
            return sleepMix;
        }

        // v4.0.5: LATE_EVENING override ‚Äî light dairy-protein mix (Halson 2014)
        // Same rationale as PRE_SLEEP but with 2 dairy slots (more variety from yogurt/kefir/cottage cheese)
        // "–õ—ë–≥–∫–∏–π –±–µ–ª–æ–∫ (—Ç–≤–æ—Ä–æ–≥, –∫–µ—Ñ–∏—Ä) ‚Äî –ª—É—á—à–µ –¥–ª—è —Å–Ω–∞ / –ò–∑–±–µ–≥–∞–π —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ –±–æ–ª—å—à–∏—Ö –ø–æ—Ä—Ü–∏–π"
        if (scenarioType === 'LATE_EVENING') {
            const eveningMix = [];
            for (let i = 0; i < limit; i++) {
                eveningMix.push(i < 2 ? PRODUCT_CATEGORIES.DAIRY : PRODUCT_CATEGORIES.PROTEIN);
            }
            console.info(`${LOG_PREFIX} üåô LATE_EVENING category override:`, {
                categories: eveningMix,
                reason: 'Halson 2014: light dairy-protein before sleep, avoid GRAINS',
                limit
            });
            return eveningMix;
        }
        // –ö–∞–ª–æ—Ä–∏–∏ –∏–∑ –º–∞–∫—Ä–æ—Å–æ–≤ (—Å TEF adjustment: –±–µ–ª–æ–∫ 3kcal/g)
        const protKcal = targetProteinG * 3;
        const carbKcal = targetCarbsG * 4;
        const fatKcal = targetFatG * 9;
        const totalKcal = protKcal + carbKcal + fatKcal;

        if (totalKcal === 0) {
            // Fallback –¥–ª—è edge case
            return [PRODUCT_CATEGORIES.PROTEIN, PRODUCT_CATEGORIES.GRAINS, PRODUCT_CATEGORIES.VEGETABLES];
        }

        // –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏
        const protPct = protKcal / totalKcal;
        const carbPct = carbKcal / totalKcal;
        const fatPct = fatKcal / totalKcal;

        console.info(`${LOG_PREFIX} üßÆ Macro proportions:`, {
            protein: `${(protPct * 100).toFixed(0)}%`,
            carbs: `${(carbPct * 100).toFixed(0)}%`,
            fat: `${(fatPct * 100).toFixed(0)}%`,
            targetMacros: { protein: targetProteinG, carbs: targetCarbsG, fat: targetFatG }
        });

        // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        const categories = [];
        const slots = { protein: protPct * limit, carbs: carbPct * limit, fat: fatPct * limit };

        // –û–∫—Ä—É–≥–ª—è–µ–º –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–∏–Ω–∏–º—É–º 1 —Å–ª–æ—Ç –¥–ª—è –º–∞–∫—Ä–æ—Å–∞ >= 5%
        let protSlots = Math.round(slots.protein);
        let carbSlots = Math.round(slots.carbs);
        let fatSlots = Math.round(slots.fat);

        // v3.2.1: –ú–∏–Ω–∏–º—É–º 1 —Å–ª–æ—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ >= 5%
        if (protPct >= 0.05 && protSlots === 0) protSlots = 1;
        if (carbPct >= 0.05 && carbSlots === 0) carbSlots = 1;
        if (fatPct >= 0.05 && fatSlots === 0) fatSlots = 1;

        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –µ—Å–ª–∏ —Å—É–º–º–∞ –Ω–µ —Ä–∞–≤–Ω–∞ limit
        let totalSlots = protSlots + carbSlots + fatSlots;
        if (totalSlots < limit) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ—Ç dominant –º–∞–∫—Ä–æ—Å—É
            if (protPct >= carbPct && protPct >= fatPct) protSlots++;
            else if (carbPct >= fatPct) carbSlots++;
            else fatSlots++;
        } else if (totalSlots > limit) {
            // –£–±–∏—Ä–∞–µ–º —Å–ª–æ—Ç —É –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ (–Ω–æ –Ω–µ –¥–æ –Ω—É–ª—è –µ—Å–ª–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª >= 5%)
            if (fatPct <= protPct && fatPct <= carbPct && (fatSlots > 1 || fatPct < 0.05)) fatSlots--;
            else if (carbPct <= protPct && (carbSlots > 1 || carbPct < 0.05)) carbSlots--;
            else if (protSlots > 1 || protPct < 0.05) protSlots--;
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
        for (let i = 0; i < protSlots; i++) categories.push(PRODUCT_CATEGORIES.PROTEIN);
        for (let i = 0; i < carbSlots; i++) categories.push(PRODUCT_CATEGORIES.GRAINS);
        for (let i = 0; i < fatSlots; i++) categories.push(PRODUCT_CATEGORIES.DAIRY); // –ú–æ–ª–æ—á–∫–∞ —á–∞—Å—Ç–æ –∂–∏—Ä–Ω–∞—è

        // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã ‚Üí –æ–≤–æ—â–∏ (–∫–ª–µ—Ç—á–∞—Ç–∫–∞!)
        while (categories.length < limit) {
            categories.push(PRODUCT_CATEGORIES.VEGETABLES);
        }

        console.info(`${LOG_PREFIX} üéØ Category mix:`, {
            categories,
            slots: { protein: protSlots, carbs: carbSlots, fat: fatSlots }
        });

        return categories;
    }

    // ============================================================================
    // Main Picker Logic
    // ============================================================================

    /**
     * –ü–æ–¥–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ fallback
     * @param {Object} scenario - –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
     * @param {Object} history - –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∏–∑ analyzeProductHistory)
     * @param {Array} fallbackProducts - –æ–±—â–∞—è –±–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–µ—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞)
     * @param {number} limit - –º–∞–∫—Å–∏–º—É–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
     * @returns {Array} —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     */
    function pickProducts(scenario, history, fallbackProducts = [], limit = 3) {
        const targetCategory = scenario.category || PRODUCT_CATEGORIES.PROTEIN;
        const historyProducts = history.byCategory[targetCategory] || [];

        let candidates = [];

        // Build lookup index from sharedProducts (fallback) by product_id or name
        // Needed to enrich history products with real macros (MealItem only stores grams+product_id, not prot/carb/fat)
        const sharedIndex = new Map();
        for (const sp of fallbackProducts) {
            if (sp.id) sharedIndex.set(sp.id, sp);
            if (sp.product_id) sharedIndex.set(sp.product_id, sp);
            if (sp.title) sharedIndex.set(sp.title.toLowerCase(), sp);
            if (sp.name) sharedIndex.set(sp.name.toLowerCase(), sp);
        }

        /**
         * Enrich history product macros from sharedProducts when item.prot/carb/fat = 0
         * Root cause: MealItem stores only grams+product_id, macros must come from sharedProducts (per 100g)
         */
        function enrichMacros(p) {
            if (p.macros.kcal > 0) return p; // Already has macros (e.g. from explicit item fields)
            const byId = sharedIndex.get(p.product_id);
            const nameKey = (p.name || '').toLowerCase();
            const byName = sharedIndex.get(nameKey);
            const sp = byId || byName;

            if (!sp) return p;

            // sharedProducts DB format: protein100, simple100+complex100=carbs, badfat100+goodfat100+trans100=fat
            // (no prot/carb/fat/kcal shorthand ‚Äî those are legacy aliases not present in HEYS.products.getAll())
            const prot = sp.protein100 || sp.prot || 0;
            const carb = sp.carbs100 != null
                ? sp.carbs100
                : (sp.carb || (sp.simple100 || 0) + (sp.complex100 || 0));
            const fat = sp.fat100 != null
                ? sp.fat100
                : (sp.fat || (sp.badfat100 || sp.badFat100 || 0) + (sp.goodfat100 || sp.goodFat100 || 0) + (sp.trans100 || 0));
            // TEF-adjusted Atwater: protein=3 kcal/g, carbs=4, fat=9
            const kcal = sp.kcal100 || sp.kcal || Math.round(prot * 3 + carb * 4 + fat * 9);

            return {
                ...p,
                macros: { protein: prot, carbs: carb, fat, kcal },
                gi: sp.gi || p.gi || 50,
                harm: sp.harm != null ? sp.harm : (p.harm || 0),
            };
        }

        // Strategy 1: Use history if sufficient
        if (historyProducts.length >= MIN_PRODUCTS_PER_CATEGORY) {
            candidates = historyProducts.map((p) => {
                const enriched = enrichMacros(p);
                const score = calculateProductScore(enriched, scenario, enriched.avgGrams || 100);
                return {
                    ...enriched,
                    score: score.totalScore,
                    scoreBreakdown: score.breakdown,
                    source: 'history',
                };
            });
        }
        // Strategy 2: Fallback to general product base
        else if (fallbackProducts.length > 0) {
            const fallbackCandidates = fallbackProducts
                .filter((p) => detectCategory(p.name || p.title) === targetCategory)
                .map((p) => {
                    const product = {
                        name: p.title || p.name,
                        product_id: p.id || p.product_id,
                        avgGrams: 100, // Default portion size for fallback
                        macros: {
                            protein: p.prot || 0,
                            carbs: p.carb || 0,
                            fat: p.fat || 0,
                            kcal: p.kcal || 0,
                        },
                        harm: p.harm || 0,
                        gi: p.gi || 50,
                        familiarityScore: 0, // Unknown product
                        category: targetCategory,
                    };
                    const score = calculateProductScore(product, scenario, 100);
                    return {
                        ...product,
                        score: score.totalScore,
                        scoreBreakdown: score.breakdown,
                        source: 'fallback',
                    };
                });

            candidates = fallbackCandidates;
        }
        // Strategy 3: Use whatever history we have (even if < MIN_PRODUCTS_PER_CATEGORY)
        else if (historyProducts.length > 0) {
            candidates = historyProducts.map((p) => {
                const enriched = enrichMacros(p);
                const score = calculateProductScore(enriched, scenario, enriched.avgGrams || 100);
                return {
                    ...enriched,
                    score: score.totalScore,
                    scoreBreakdown: score.breakdown,
                    source: 'history',
                };
            });
        }

        // Sort by score descending and take top N
        candidates.sort((a, b) => b.score - a.score);
        const picked = candidates.slice(0, limit);

        const topPicks = picked.map(p => ({
            name: p.name,
            score: p.score,
            source: p.source,
            grams: Math.round(p.avgGrams || 100),
            caffeineAwareness: p.scoreBreakdown?.caffeineAwareness, // v2.6: show caffeine penalty
            topFactors: Object.entries(p.scoreBreakdown || {})
                .filter(([key]) => SCORING_WEIGHTS[key] != null)
                .sort((a, b) => (b[1] * (SCORING_WEIGHTS[b[0]] || 0)) - (a[1] * (SCORING_WEIGHTS[a[0]] || 0)))
                .slice(0, 4)
                .map(([key, val]) => `${key}=${Math.round(val)}`)
                .join(', ')
        }));

        const strategy = historyProducts.length >= MIN_PRODUCTS_PER_CATEGORY
            ? 'HISTORY'
            : (fallbackProducts.length > 0 ? 'FALLBACK' : 'LIMITED_HISTORY');

        pushPickerLogRow('picked', {
            scenario: scenario.scenario || scenario.type || 'UNKNOWN',
            category: targetCategory.toUpperCase(),
            strategy,
            evaluated: candidates.length,
            selected: picked.length,
            sampleTop: topPicks.slice(0, 3).map((p) => `${p.name} (${p.score})`).join(' | '),
        });

        return picked;
    }

    /**
     * –ü–æ–¥–±–∏—Ä–∞–µ—Ç MIX –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
     * v3.1: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –°–¢–†–£–ö–¢–£–†–£ –° –ì–†–£–ü–ü–ê–ú–ò –¥–ª—è UI —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
     * 
     * @param {Array<string>} categories - –º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä [PROTEIN, PROTEIN, GRAINS])
     * @param {Object} scenario - –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
     * @param {Object} history - –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     * @param {Array} fallbackProducts - fallback –±–∞–∑–∞
     * @param {number} productsPerCategory - —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤—ã–±—Ä–∞—Ç—å –∏–∑ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     * @returns {Object} { groups: [{ category, categoryName, emoji, products: [] }] }
     */
    function pickProductsMix(categories, scenario, history, fallbackProducts = [], productsPerCategory = 5, excludeProductIds = null) {
        const categoryGroups = new Map(); // category ‚Üí products[]
        // P3 fix: pre-populate from cross-meal exclusion set to deduplicate products across meals
        const usedProductIds = excludeProductIds instanceof Set ? new Set(excludeProductIds) : new Set();

        console.info(`${LOG_PREFIX} üé® Picking mix from categories:`, { categories, productsPerCategory, excludedCount: usedProductIds.size });

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–º–æ–∂–µ—Ç –±—ã—Ç—å [PROTEIN, PROTEIN, GRAINS] ‚Üí {PROTEIN: 2, GRAINS: 1})
        const categoryCount = {};
        for (const cat of categories) {
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        }

        // –î–ª—è –∫–∞–∂–¥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–µ—Ä—ë–º –¢–û–ü-N –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        for (const [category, count] of Object.entries(categoryCount)) {
            const categorizedScenario = { ...scenario, category };
            // P3 fix v2: request extra products to compensate for cross-meal excluded slots
            const extraBuffer = usedProductIds.size > 0 ? Math.ceil(usedProductIds.size / Object.keys(categoryCount).length) + productsPerCategory : productsPerCategory;
            const categoryPicks = pickProducts(categorizedScenario, history, fallbackProducts, Math.min(extraBuffer, 20));

            const uniquePicks = [];
            for (const pick of categoryPicks) {
                if (!usedProductIds.has(pick.product_id) && uniquePicks.length < productsPerCategory) {
                    uniquePicks.push(pick);
                    usedProductIds.add(pick.product_id);
                }
            }

            if (uniquePicks.length > 0) {
                categoryGroups.set(category, {
                    category,
                    categoryName: getCategoryDisplayName(category),
                    emoji: getCategoryEmoji(category),
                    products: uniquePicks,
                    importance: count // –°–∫–æ–ª—å–∫–æ —Å–ª–æ—Ç–æ–≤ –∑–∞–Ω–∏–º–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è—Ö
                });
            }
        }

        const groups = Array.from(categoryGroups.values());

        console.info(`${LOG_PREFIX} ‚úÖ Mix picked:`, {
            groupsCount: groups.length,
            totalProducts: groups.reduce((sum, g) => sum + g.products.length, 0),
            breakdown: groups.map(g => `${g.categoryName}: ${g.products.length}`)
        });

        return { groups };
    }

    /**
     * –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     */
    function getCategoryDisplayName(category) {
        const names = {
            protein: '–ë–µ–ª–∫–∏',
            grains: '–£–≥–ª–µ–≤–æ–¥—ã',
            dairy: '–ñ–∏—Ä—ã/–ú–æ–ª–æ—á–∫–∞',
            vegetables: '–û–≤–æ—â–∏',
            fruits: '–§—Ä—É–∫—Ç—ã',
            snacks: '–°–Ω–µ–∫–∏',
            other: '–î—Ä—É–≥–æ–µ'
        };
        return names[category] || category;
    }

    /**
     * Emoji –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     */
    function getCategoryEmoji(category) {
        const emojis = {
            protein: 'ü•©',
            grains: 'üåæ',
            dairy: 'ü•õ',
            vegetables: 'ü•ó',
            fruits: 'üçé',
            snacks: 'üç™',
            other: 'üçΩÔ∏è'
        };
        return emojis[category] || 'üç¥';
    }

    // ============================================================================
    // Public API
    // ============================================================================

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è meal recommendation
     * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
     * @returns {Array} —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     */
    function generateProductSuggestions(params) {
        const {
            scenario,
            remainingKcal,
            targetProteinG = 30,
            targetCarbsG = 40,
            targetFatG = 10,
            idealGI = 50,
            targetGL = null,   // v3.4: F2 ‚Äî GL target from planner (20=day, 10=PRE_SLEEP, Ludwig 2002)
            currentTime, // v2.6: for caffeine-awareness filtering
            addedSugarScore,
            sugarDependencyRisk,
            fiberRegularityScore,
            micronutrientDeficits = [],
            novaQualityScore,
            lsGet,
            sharedProducts = [],
            limit = 3,
            excludeProductIds = null,
            profile = null,    // v3.6: F4 ‚Äî needed for feedbackLoop.getProductWeight() ML multiplier
        } = params;

        const safeLsGet = resolveLsGet(lsGet);

        startPickerLogCycle({ scenario, limit, targetGL: targetGL ?? null });

        // Phase B/C Integration Summary (logged once per session)
        if (!window._mealRecPhaseSummaryLogged) {
            window._mealRecPhaseSummaryLogged = true;
            console.group(`${LOG_PREFIX} üìã Phase A/B/C Integration Summary (v3.0)`);
            console.info('Phase A (Core): C37 sugar filtering, caffeine-awareness');
            console.info('Phase B (Context): C10 fiber boost (8% weight)');
            console.info('Phase C (Micronutrients): C26 minerals boost (10%), C29 NOVA filtering (8%)');
            console.info('v3.3: PRE_SLEEP GI penalty (6% weight) ‚Äî DAIRY boost, GRAINS penalty before sleep');
            console.info('v3.4: GL Penalty (5% weight) ‚Äî targetGL=20/10 from planner (Ludwig 2002)');
            console.info('v3.5: Workout Carb Boost (5% weight) ‚Äî GRAINS boost for POST_WORKOUT (Ivy 2004)');
            console.info('v3.6: F4 Feedback ML weights ‚Äî EMA multiplier [0.5-2.0] per product+scenario (üëçüëé ‚Üí score)');
            console.info('Total: 14 scoring factors √ó ML multiplier (EMA feedback loop active)');
            console.groupEnd();
        }

        console.info(`${LOG_PREFIX} üöÄ Generating suggestions:`, {
            scenario,
            remainingKcal,
            targetMacros: { protein: targetProteinG, carbs: targetCarbsG, fat: targetFatG },
            idealGI,
            targetGL,          // v3.4: F2
            addedSugarScore,
            sugarDependencyRisk,
            fiberRegularityScore,
            micronutrientDeficits,
            novaQualityScore,
            limit,
            hasLsGet: typeof safeLsGet === 'function',
        });

        // 1. Analyze history
        const history = analyzeProductHistory(HISTORY_DAYS, safeLsGet);

        // 2. Build scenario context
        const scenarioContext = {
            scenario,
            remainingKcal,
            targetProteinG,
            targetCarbsG,
            targetFatG,
            targetKcal: remainingKcal,
            idealGI,
            targetGL,          // v3.4: F2 ‚Äî GL target for factor 13 scoring (Ludwig 2002)
            currentTime, // v2.6: pass time for caffeine-awareness
            addedSugarScore,
            sugarDependencyRisk,
            fiberRegularityScore,
            micronutrientDeficits,
            novaQualityScore,
            category: mapScenarioToCategory(scenario), // legacy –¥–ª—è fallback
            profile,           // v3.6: F4 ‚Äî for feedbackLoop.getProductWeight() ML multiplier
        };

        // v3.4: F2 ‚Äî log GL scoring activation (once per pick cycle)
        if (targetGL != null && Number.isFinite(targetGL)) {
            console.info(`${LOG_PREFIX} üìä [F2] GL scoring active:`, {
                targetGL,
                scenario,
                note: targetGL <= 10 ? 'PRE_SLEEP strict (GL<10)' : 'Day target (GL<20)',
            });
        }

        // 3. Pick products
        // v3.1: –ò—Å–ø–æ–ª—å–∑—É–µ–º balanced mix –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏—ë–º
        // v3.2: –î–æ–±–∞–≤–ª–µ–Ω LATE_EVENING –¥–ª—è —Å–ª—É—á–∞–µ–≤ —Å –±–æ–ª—å—à–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º –∫–∞–ª–æ—Ä–∏–π
        const BALANCED_SCENARIOS = ['PROTEIN_DEFICIT', 'BALANCED', 'POST_WORKOUT', 'PRE_WORKOUT', 'LATE_EVENING', 'PRE_SLEEP'];
        let picks;
        let isGroupedMode = false;

        if (BALANCED_SCENARIOS.includes(scenario)) {
            // Balanced mode: mix –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è–º –º–∞–∫—Ä–æ—Å–æ–≤
            // v3.3: pass scenario type so PRE_SLEEP gets sleep-friendly category override
            const categories = determineCategoryMix(targetProteinG, targetCarbsG, targetFatG, limit, scenario);
            picks = pickProductsMix(categories, scenarioContext, history, sharedProducts, 5, excludeProductIds instanceof Set ? excludeProductIds : null);
            isGroupedMode = true;
        } else {
            // Legacy mode: –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è (–¥–ª—è —Å–Ω–µ–∫–æ–≤, —Å—Ç—Ä–µ—Å—Å-–µ–¥—ã –∏ —Ç.–¥.)
            picks = pickProducts(scenarioContext, history, sharedProducts, limit);
            isGroupedMode = false;
        }

        // 4. Format output
        if (isGroupedMode && picks.groups) {
            // Grouped mode response (v3.1)
            const formattedGroups = picks.groups.map(group => ({
                category: group.category,
                categoryName: group.categoryName,
                emoji: group.emoji,
                importance: group.importance,
                products: group.products.map((pick) => ({
                    product: pick.name,
                    productId: pick.product_id,
                    grams: Math.round(pick.avgGrams || 100),
                    reason: generateProductReason(pick, scenarioContext),
                    score: pick.score,
                    source: pick.source,
                    macros: {
                        protein: Math.round((pick.macros.protein * (pick.avgGrams || 100)) / 100 || 0),
                        carbs: Math.round((pick.macros.carbs * (pick.avgGrams || 100)) / 100 || 0),
                        fat: Math.round((pick.macros.fat * (pick.avgGrams || 100)) / 100 || 0),
                        kcal: Math.round((pick.macros.kcal * (pick.avgGrams || 100)) / 100 || 0),
                    },
                })),
            }));

            const totalProducts = formattedGroups.reduce((sum, g) => sum + g.products.length, 0);
            const historyCount = formattedGroups.reduce((sum, g) =>
                sum + g.products.filter(p => p.source === 'history').length, 0
            );

            console.info(`${LOG_PREFIX} ‚úÖ Grouped selection:`, {
                scenario,
                groupsCount: formattedGroups.length,
                totalProducts,
                historyUsed: historyCount,
                breakdown: formattedGroups.map(g => `${g.categoryName}: ${g.products.length}`),
            });

            flushPickerLogCycle();
            return {
                mode: 'grouped',
                groups: formattedGroups,
                totalProducts,
                historyUsed: historyCount,
            };
        }

        // Legacy flat mode response
        const suggestions = picks.map((pick) => ({
            product: pick.name,
            productId: pick.product_id,
            grams: Math.round(pick.avgGrams || 100),
            reason: generateProductReason(pick, scenarioContext),
            score: pick.score,
            source: pick.source,
            macros: {
                protein: Math.round((pick.macros.protein * pick.avgGrams) / 100 || 0),
                carbs: Math.round((pick.macros.carbs * pick.avgGrams) / 100 || 0),
                fat: Math.round((pick.macros.fat * pick.avgGrams) / 100 || 0),
                kcal: Math.round((pick.macros.kcal * pick.avgGrams) / 100 || 0),
            },
        }));

        const historyCount = suggestions.filter((s) => s.source === 'history').length;
        const fallbackCount = suggestions.filter((s) => s.source === 'fallback').length;
        const avgScore = suggestions.length > 0
            ? Math.round(suggestions.reduce((sum, s) => sum + s.score, 0) / suggestions.length)
            : 0;
        const totalMacros = suggestions.reduce((sum, s) => ({
            protein: sum.protein + s.macros.protein,
            carbs: sum.carbs + s.macros.carbs,
            kcal: sum.kcal + s.macros.kcal
        }), { protein: 0, carbs: 0, kcal: 0 });

        console.info(`${LOG_PREFIX} ‚úÖ Selected products:`, {
            scenario,
            count: suggestions.length,
            historyUsed: historyCount,
            fallbackUsed: fallbackCount,
            avgScore,
            totalMacros: {
                protein: Math.round(totalMacros.protein),
                carbs: Math.round(totalMacros.carbs),
                kcal: Math.round(totalMacros.kcal)
            },
            products: suggestions.map(s => `${s.product} (${s.grams}–≥, score=${s.score})`)
        });

        flushPickerLogCycle();
        return {
            mode: 'flat',
            suggestions,
            count: suggestions.length,
            historyUsed: historyCount,
            fallbackUsed: fallbackCount,
            avgScore,
        };
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è
     */
    function mapScenarioToCategory(scenario) {
        const categoryMap = {
            GOAL_REACHED: PRODUCT_CATEGORIES.SNACKS,
            LIGHT_SNACK: PRODUCT_CATEGORIES.FRUITS,
            LATE_EVENING: PRODUCT_CATEGORIES.DAIRY,
            PRE_SLEEP: PRODUCT_CATEGORIES.DAIRY,  // v3.3: casein/kefir pre-sleep (Halson 2014)
            PRE_WORKOUT: PRODUCT_CATEGORIES.GRAINS,
            POST_WORKOUT: PRODUCT_CATEGORIES.PROTEIN,
            PROTEIN_DEFICIT: PRODUCT_CATEGORIES.PROTEIN,
            STRESS_EATING: PRODUCT_CATEGORIES.SNACKS,
            BALANCED: PRODUCT_CATEGORIES.PROTEIN,
        };
        return categoryMap[scenario] || PRODUCT_CATEGORIES.PROTEIN;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
     */
    function generateProductReason(pick, scenario) {
        if (pick.scoreBreakdown.proteinAlignment > 80) {
            return '–í—ã—Å–æ–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–µ–ª–∫–∞';
        }
        if (pick.scoreBreakdown.kcalFit > 80) {
            return '–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å';
        }
        if (pick.scoreBreakdown.giAwareness > 80) {
            return scenario.idealGI < 50 ? '–ù–∏–∑–∫–∏–π –ì–ò' : '–ú–µ–¥–ª–µ–Ω–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã';
        }
        if (pick.source === 'history') {
            return '–ò–∑ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏';
        }
        return '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å';
    }

    // ============================================================================
    // Module Export
    // ============================================================================

    global.HEYS = global.HEYS || {};
    global.HEYS.InsightsPI = global.HEYS.InsightsPI || {};
    global.HEYS.InsightsPI.productPicker = {
        generateProductSuggestions,
        analyzeProductHistory,
        calculateProductScore,
        // Exports for testing
        _internal: {
            detectCategory,
            calculateFamiliarityScore,
            mapScenarioToCategory,
        },
    };

    console.info(`${LOG_PREFIX} ‚úÖ Smart Product Picker v4.0.5 initialized (LATE_EVENING: DAIRY+PROTEIN category override, sleepGIPenalty extended)`);
    console.info(`${LOG_PREFIX} üìä SCENARIO_IDEAL_MACRO_PROFILES loaded:`, Object.keys(SCENARIO_IDEAL_MACRO_PROFILES).join(', '));
    console.info(`${LOG_PREFIX} üìä v4.0: Rebalanced scoring ‚Äî macro alignment 49% (prot√ó3+carb√ó4+fat√ó9 Energy%), binary reduced to 6%, fat alignment added, kcalFit soft 0‚Üí1.2, neutral baselines 50`);
})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_meal_rec_patterns.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Meal Recommender √ó Deep Patterns Integration v1.0
 * 
 * –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è 41 pattern score, insulin wave predictions, phenotype adjustments
 * –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ meal recommendations.
 * 
 * Part of R2.6 Deep Insights Integration release.
 * 
 * Dependencies: pi_patterns.js, pi_phenotype.js, pi_stats.js
 * @param global
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    // Unified logging filter for console filtering (supports quick filters: "mealrec" and "dynamic")
    const LOG_FILTER = 'MEALREC|dynamic';

    // Critical patterns that affect meal recommendations
    const CRITICAL_PATTERNS = {
        C09_PROTEIN_SATIETY: 'protein_satiety',
        C11_STRESS_EATING: 'stress_eating',
        C13_CIRCADIAN: 'circadian_timing',
        C30_TRAINING_RECOVERY: 'training_recovery',
        C01_MEAL_TIMING: 'meal_timing',
        C02_WAVE_OVERLAP: 'wave_overlap',
        C15_INSULIN_SENSITIVITY: 'insulin_sensitivity',
        C34_GLYCEMIC_LOAD: 'glycemic_load',
        C35_PROTEIN_DISTRIBUTION: 'protein_distribution',
        C37_ADDED_SUGAR_DEPENDENCY: 'added_sugar_dependency'
    };

    /**
     * Normalize pattern score to 0..1 regardless of source scale (0..1 or 0..100)
     * @param {number} score
     * @returns {number}
     */
    function normalizeScore(score) {
        const s = Number(score);
        if (!Number.isFinite(s)) return 0.5;
        if (s > 1) return Math.max(0, Math.min(1, s / 100));
        return Math.max(0, Math.min(1, s));
    }

    /**
     * Get current pattern scores for meal-relevant patterns
     * @param {object[]} days - Recent days (7-14d recommended)
     * @param {object} profile - User profile
     * @param {object} pIndex - Product index
     * @returns {object|null} - Pattern scores or null if unavailable
     */
    function getCurrentPatternScores(days, profile, pIndex) {
        if (!days || days.length < 7) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Insufficient data for pattern scores (<7 days)`);
            return null;
        }

        const patterns = HEYS.InsightsPI?.patterns;
        if (!patterns) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è PI Patterns module not loaded`);
            return null;
        }

        const scores = {};

        // C09: Protein Satiety (–≤–ª–∏—è–µ—Ç –Ω–∞ PROTEIN_DEFICIT —Å—Ü–µ–Ω–∞—Ä–∏–π)
        try {
            const proteinSatiety = patterns.analyzeProteinSatiety?.(days, pIndex, profile);
            if (proteinSatiety?.available) {
                scores.proteinSatiety = {
                    score: normalizeScore(proteinSatiety.score),
                    scoreRaw: Number(proteinSatiety.score) || 0,
                    confidence: proteinSatiety.confidence || 0.7,
                    avgProtein: proteinSatiety.avgProteinG,
                    satietyScore: proteinSatiety.satietyScore
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get protein_satiety:`, err.message);
        }

        // C11: Stress Eating (–≤–ª–∏—è–µ—Ç –Ω–∞ STRESS_EATING —Å—Ü–µ–Ω–∞—Ä–∏–π)
        try {
            const stressEating = patterns.analyzeStressEating?.(days, pIndex, profile);
            if (stressEating?.available) {
                scores.stressEating = {
                    score: normalizeScore(stressEating.score),
                    scoreRaw: Number(stressEating.score) || 0,
                    confidence: stressEating.confidence || 0.7,
                    correlation: stressEating.correlation,
                    stressDays: stressEating.stressDays
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get stress_eating:`, err.message);
        }

        // C13: Circadian Timing (–≤–ª–∏—è–µ—Ç –Ω–∞ LATE_EVENING threshold)
        try {
            const circadian = patterns.analyzeCircadianTiming?.(days, pIndex, profile);
            if (circadian?.available) {
                scores.circadian = {
                    score: normalizeScore(circadian.score),
                    scoreRaw: Number(circadian.score) || 0,
                    confidence: circadian.confidence || 0.7,
                    earlyDistribution: circadian.earlyDistribution,
                    peakHour: circadian.peakHour
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get circadian_timing:`, err.message);
        }

        // C30: Training Recovery (–≤–ª–∏—è–µ—Ç –Ω–∞ PRE/POST_WORKOUT macros)
        try {
            const recovery = patterns.analyzeTrainingRecovery?.(days, pIndex, profile);
            if (recovery?.available) {
                scores.trainingRecovery = {
                    score: normalizeScore(recovery.score),
                    scoreRaw: Number(recovery.score) || 0,
                    confidence: recovery.confidence || 0.7,
                    recoveryRate: recovery.recoveryRate
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get training_recovery:`, err.message);
        }

        // C01: Meal Timing (–≤–ª–∏—è–µ—Ç –Ω–∞ timing window)
        try {
            const mealTiming = patterns.analyzeMealTiming?.(days, profile, pIndex);
            if (mealTiming?.available) {
                scores.mealTiming = {
                    score: normalizeScore(mealTiming.score),
                    scoreRaw: Number(mealTiming.score) || 0,
                    confidence: mealTiming.confidence || 0.7,
                    avgGapMinutes: mealTiming.avgGapMinutes,
                    idealGapMinutes: mealTiming.idealGapMinutes,
                    overlapCount: mealTiming.overlapCount || 0
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get meal_timing:`, err.message);
        }

        // C02: Wave Overlap (–≤–ª–∏—è–µ—Ç –Ω–∞ timing + GI moderation)
        try {
            const waveOverlap = patterns.analyzeWaveOverlap?.(days, profile);
            if (waveOverlap?.available) {
                scores.waveOverlap = {
                    score: normalizeScore(waveOverlap.score),
                    scoreRaw: Number(waveOverlap.score) || 0,
                    confidence: waveOverlap.confidence || 0.7,
                    overlapCount: waveOverlap.overlapCount || 0,
                    avgOverlapPct: waveOverlap.avgOverlapPct || 0,
                    hasOverlaps: !!waveOverlap.hasOverlaps
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get wave_overlap:`, err.message);
        }

        // C15: Insulin Sensitivity (–≤–ª–∏—è–µ—Ç –Ω–∞ carb ratios)
        try {
            const insulinSensitivity = patterns.analyzeInsulinSensitivity?.(days, pIndex, profile);
            if (insulinSensitivity?.available) {
                scores.insulinSensitivity = {
                    score: normalizeScore(insulinSensitivity.score),
                    scoreRaw: Number(insulinSensitivity.score) || 0,
                    confidence: insulinSensitivity.confidence || 0.7,
                    avgGI: insulinSensitivity.avgGI,
                    avgFiberPer1000: insulinSensitivity.avgFiberPer1000
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get insulin_sensitivity:`, err.message);
        }

        // C34: Glycemic Load (–≤–ª–∏—è–µ—Ç –Ω–∞ idealGI)
        try {
            const glycemicLoad = patterns.analyzeGlycemicLoad?.(days, pIndex);
            if (glycemicLoad?.available) {
                scores.glycemicLoad = {
                    score: normalizeScore(glycemicLoad.score),
                    scoreRaw: Number(glycemicLoad.score) || 0,
                    confidence: glycemicLoad.confidence || 0.7,
                    avgDailyGL: glycemicLoad.avgDailyGL,
                    avgEveningRatio: glycemicLoad.avgEveningRatio,
                    dailyClass: glycemicLoad.dailyClass
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get glycemic_load:`, err.message);
        }

        // C35: Protein Distribution (–≤–ª–∏—è–µ—Ç –Ω–∞ protein target)
        try {
            const proteinDistribution = patterns.analyzeProteinDistribution?.(days, profile, pIndex);
            if (proteinDistribution?.available) {
                scores.proteinDistribution = {
                    score: normalizeScore(proteinDistribution.score),
                    scoreRaw: Number(proteinDistribution.score) || 0,
                    confidence: proteinDistribution.confidence || 0.7,
                    distributionScore: proteinDistribution.distributionScore,
                    subthresholdMeals: proteinDistribution.subthresholdMeals,
                    excessMeals: proteinDistribution.excessMeals
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get protein_distribution:`, err.message);
        }

        // C37: Added Sugar Dependency (–≤–ª–∏—è–µ—Ç –Ω–∞ product penalties)
        try {
            const sugarDependency = patterns.analyzeAddedSugarDependency?.(days, pIndex);
            if (sugarDependency?.available) {
                scores.addedSugarDependency = {
                    score: normalizeScore(sugarDependency.score),
                    scoreRaw: Number(sugarDependency.score) || 0,
                    confidence: sugarDependency.confidence || 0.7,
                    avgDailySugar: sugarDependency.avgDailySugar,
                    maxStreak: sugarDependency.maxStreak,
                    dependencyRisk: !!sugarDependency.dependencyRisk
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get added_sugar_dependency:`, err.message);
        }

        // === PHASE B: CONTEXT MODIFIERS (4 patterns) ===

        // C06: Sleep ‚Üí Hunger (–≤–ª–∏—è–µ—Ç –Ω–∞ POOR_SLEEP scenario modifier)
        try {
            const sleepHunger = patterns.analyzeSleepHunger?.(days, profile, pIndex);
            if (sleepHunger?.available) {
                scores.sleepHunger = {
                    score: normalizeScore(sleepHunger.score),
                    scoreRaw: Number(sleepHunger.score) || 0,
                    confidence: sleepHunger.confidence || 0.7,
                    correlation: sleepHunger.correlation,
                    poorSleepDays: sleepHunger.poorSleepDays || 0,
                    avgLag: sleepHunger.lagEffect || 0
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get sleep_hunger:`, err.message);
        }

        // C14: Nutrient Timing (–≤–ª–∏—è–µ—Ç –Ω–∞ PRE/POST_WORKOUT macro fine-tuning)
        try {
            const nutrientTiming = patterns.analyzeNutrientTiming?.(days, pIndex, profile);
            if (nutrientTiming?.available) {
                scores.nutrientTiming = {
                    score: normalizeScore(nutrientTiming.score),
                    scoreRaw: Number(nutrientTiming.score) || 0,
                    confidence: nutrientTiming.confidence || 0.7,
                    carbTimingScore: nutrientTiming.carbTimingScore || 0,
                    proteinTimingScore: nutrientTiming.proteinTimingScore || 0,
                    optimalWindow: nutrientTiming.optimalWindow || 'N/A'
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get nutrient_timing:`, err.message);
        }

        // C10: Fiber Regularity (–≤–ª–∏—è–µ—Ç –Ω–∞ product picker fiber boost)
        try {
            const fiberRegularity = patterns.analyzeFiberRegularity?.(days, pIndex);
            if (fiberRegularity?.available) {
                scores.fiberRegularity = {
                    score: normalizeScore(fiberRegularity.score),
                    scoreRaw: Number(fiberRegularity.score) || 0,
                    confidence: fiberRegularity.confidence || 0.7,
                    avgFiberG: fiberRegularity.avgFiberG || 0,
                    targetFiberG: fiberRegularity.targetFiberG || 25,
                    fiberPer1000: fiberRegularity.fiberPer1000 || 0
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get fiber_regularity:`, err.message);
        }

        // C12: Mood ‚Üî Food (–≤–ª–∏—è–µ—Ç –Ω–∞ STRESS_EATING macro strategy)
        try {
            const optimum = profile?.optimum || 2000;
            const moodFood = patterns.analyzeMoodFood?.(days, pIndex, optimum);
            if (moodFood?.available) {
                scores.moodFood = {
                    score: normalizeScore(moodFood.score),
                    scoreRaw: Number(moodFood.score) || 0,
                    confidence: moodFood.confidence || 0.7,
                    correlation: moodFood.correlation || 0,
                    bestFoods: moodFood.bestFoods || [],
                    worstFoods: moodFood.worstFoods || []
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get mood_food:`, err.message);
        }

        // === PHASE C: MICRONUTRIENT INTELLIGENCE (2 patterns) ===

        // C26: Micronutrient Radar (–≤–ª–∏—è–µ—Ç –Ω–∞ product boost for Fe/Mg/Zn/Ca sources)
        try {
            const micronutrients = patterns.analyzeMicronutrients?.(days, pIndex, profile);
            if (micronutrients?.available) {
                scores.micronutrients = {
                    score: normalizeScore(micronutrients.score),
                    scoreRaw: Number(micronutrients.score) || 0,
                    confidence: micronutrients.confidence || 0.7,
                    deficits: micronutrients.deficits || [],
                    avgIntake: micronutrients.avgIntake || {}
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get micronutrients:`, err.message);
        }

        // C29: NOVA Quality (–≤–ª–∏—è–µ—Ç –Ω–∞ product filter - penalty NOVA-4)
        try {
            const novaQuality = patterns.analyzeNOVAQuality?.(days, pIndex);
            if (novaQuality?.available) {
                scores.novaQuality = {
                    score: normalizeScore(novaQuality.score),
                    scoreRaw: Number(novaQuality.score) || 0,
                    confidence: novaQuality.confidence || 0.7,
                    nova4Share: novaQuality.nova4SharePct || 0,
                    avgNOVA: novaQuality.avgNOVA || 2.5
                };
            }
        } catch (err) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Failed to get nova_quality:`, err.message);
        }

        const availableCount = Object.keys(scores).length;
        if (availableCount === 0) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è No pattern scores available`);
            return null;
        }

        // Format patterns for table display
        const patternTable = Object.entries(scores).map(([name, data]) => {
            const row = {
                pattern: name,
                score: data.score,
                scoreRaw: data.scoreRaw,
                confidence: data.confidence.toFixed(2)
            };
            // Add pattern-specific metrics
            if (data.avgProtein !== undefined) row.avgProtein = Math.round(data.avgProtein);
            if (data.satietyScore !== undefined) row.satietyScore = Math.round(data.satietyScore);
            if (data.correlation !== undefined) row.correlation = data.correlation.toFixed(2);
            if (data.stressDays !== undefined) row.stressDays = data.stressDays;
            if (data.earlyDistribution !== undefined) row.earlyDistrib = data.earlyDistribution.toFixed(2);
            if (data.peakHour !== undefined) row.peakHour = data.peakHour;
            if (data.recoveryRate !== undefined) row.recoveryRate = data.recoveryRate.toFixed(2);
            if (data.avgGapMinutes !== undefined) row.avgGapMin = data.avgGapMinutes;
            if (data.idealGapMinutes !== undefined) row.idealGapMin = data.idealGapMinutes;
            if (data.overlapCount !== undefined) row.overlapCount = data.overlapCount;
            if (data.avgOverlapPct !== undefined) row.avgOverlapPct = data.avgOverlapPct;
            if (data.avgGI !== undefined) row.avgGI = data.avgGI;
            if (data.avgFiberPer1000 !== undefined) row.avgFiberPer1000 = data.avgFiberPer1000;
            if (data.avgDailyGL !== undefined) row.avgDailyGL = data.avgDailyGL;
            if (data.avgEveningRatio !== undefined) row.avgEveningRatio = data.avgEveningRatio;
            if (data.distributionScore !== undefined) row.distributionScore = data.distributionScore;
            if (data.avgDailySugar !== undefined) row.avgDailySugar = data.avgDailySugar;
            if (data.maxStreak !== undefined) row.sugarStreak = data.maxStreak;
            if (data.dependencyRisk !== undefined) row.sugarRisk = data.dependencyRisk;
            // Phase B specific metrics
            if (data.poorSleepDays !== undefined) row.poorSleepDays = data.poorSleepDays;
            if (data.avgLag !== undefined) row.sleepLag = data.avgLag;
            if (data.carbTimingScore !== undefined) row.carbTiming = data.carbTimingScore;
            if (data.proteinTimingScore !== undefined) row.proteinTiming = data.proteinTimingScore;
            if (data.avgFiberG !== undefined) row.avgFiberG = data.avgFiberG;
            if (data.fiberPer1000 !== undefined) row.fiberPer1000 = data.fiberPer1000;
            if (data.bestFoods !== undefined) row.bestFoodCount = data.bestFoods.length;
            if (data.worstFoods !== undefined) row.worstFoodCount = data.worstFoods.length;
            // Phase C specific metrics
            if (data.deficits !== undefined) row.deficitCount = data.deficits.length;
            if (data.avgIntake !== undefined && data.avgIntake.iron) row.avgFe = data.avgIntake.iron;
            if (data.nova4Share !== undefined) row.nova4Pct = data.nova4Share;
            if (data.avgNOVA !== undefined) row.avgNOVA = data.avgNOVA;
            return row;
        });

        console.group(`[${LOG_FILTER}] ‚úÖ Pattern scores loaded: ${availableCount} patterns used for confidence calculation`);
        console.table(patternTable);
        console.groupEnd();

        return scores;
    }

    /**
     * Calculate dynamic confidence score based on multiple factors
     * @param {string} scenario - Detected scenario
     * @param {object} patternScores - Pattern scores from getCurrentPatternScores()
     * @param {number} daysCount - Number of historical days available
     * @param {object} thresholds - Adaptive thresholds (for source check)
     * @returns {number} - Confidence 0.0-1.0
     */
    function calculateDynamicConfidence(scenario, patternScores, daysCount, thresholds) {
        // Factor 1: Scenario detection confidence (0.4 weight)
        let scenarioConf = 0.7; // Base confidence for rule-based scenarios

        // Boost confidence if relevant pattern supports the scenario
        let boostPattern = null;
        let baseScenarioConf = 0.7;
        if (scenario === 'PROTEIN_DEFICIT' && patternScores?.proteinSatiety) {
            scenarioConf = Math.min(0.95, 0.7 + patternScores.proteinSatiety.confidence * 0.2);
            boostPattern = 'proteinSatiety';
        } else if (scenario === 'STRESS_EATING' && patternScores?.stressEating) {
            scenarioConf = Math.min(0.95, 0.7 + patternScores.stressEating.confidence * 0.2);
            boostPattern = 'stressEating';
        } else if (scenario === 'LATE_EVENING' && patternScores?.circadian) {
            scenarioConf = Math.min(0.95, 0.7 + patternScores.circadian.confidence * 0.2);
            boostPattern = 'circadian';
        } else if ((scenario === 'PRE_WORKOUT' || scenario === 'POST_WORKOUT') && patternScores?.trainingRecovery) {
            scenarioConf = Math.min(0.95, 0.7 + patternScores.trainingRecovery.confidence * 0.2);
            boostPattern = 'trainingRecovery';
        }

        // Factor 2: Pattern score average (0.3 weight)
        // P0 Fix: Normalize pattern scores (0-100 scale) to 0-1 range
        let patternAvg = 0.5; // Default if no patterns
        if (patternScores) {
            const scores = Object.values(patternScores).map(p => p.score); // already normalized to 0..1
            patternAvg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0.5;
        }

        // Factor 3: Data quality (0.3 weight)
        let dataQuality = 0.5;
        if (daysCount >= 30) {
            dataQuality = 1.0;
        } else if (daysCount >= 14) {
            dataQuality = 0.85;
        } else if (daysCount >= 7) {
            dataQuality = 0.7;
        }

        // Boost for high-quality thresholds
        if (thresholds?.source === 'FULL') {
            dataQuality = Math.min(1.0, dataQuality + 0.1);
        }

        // Weighted average (0.4 + 0.3 + 0.3 = 1.0)
        const confidence = (scenarioConf * 0.4) + (patternAvg * 0.3) + (dataQuality * 0.3);

        // Build confidence breakdown table
        const confidenceBreakdown = [
            {
                factor: 'Scenario Confidence',
                value: scenarioConf.toFixed(2),
                weight: '40%',
                contribution: (scenarioConf * 0.4).toFixed(2),
                note: boostPattern ? `‚úÖ Boosted by ${boostPattern}` : 'Base 0.7 (rule-based)'
            },
            {
                factor: 'Pattern Avg Score',
                value: patternAvg.toFixed(2),
                weight: '30%',
                contribution: (patternAvg * 0.3).toFixed(2),
                note: patternScores ? `${Object.keys(patternScores).length} patterns` : 'Default'
            },
            {
                factor: 'Data Quality',
                value: dataQuality.toFixed(2),
                weight: '30%',
                contribution: (dataQuality * 0.3).toFixed(2),
                note: `${daysCount}d, thresholds=${thresholds?.source || 'N/A'}`
            },
            {
                factor: 'üéØ FINAL CONFIDENCE',
                value: confidence.toFixed(2),
                weight: '100%',
                contribution: confidence.toFixed(2),
                note: 'Weighted sum (clamped 0.5-1.0)'
            }
        ];

        console.group(`[${LOG_FILTER}] üìä Dynamic confidence calculated: ${scenario} ‚Üí ${confidence.toFixed(2)}`);
        console.table(confidenceBreakdown);
        console.groupEnd();

        return Math.max(0.5, Math.min(1.0, confidence)); // Clamp to [0.5, 1.0]
    }

    /**
     * Adjust scenario priority based on pattern scores
     * @param {string} scenario - Detected scenario
     * @param {object} patternScores - Pattern scores
     * @returns {number} - Priority multiplier 0.7-1.3 (1.0 = neutral)
     */
    function getScenarioPriorityMultiplier(scenario, patternScores) {
        if (!patternScores) return 1.0;

        let multiplier = 1.0;

        // PROTEIN_DEFICIT: –µ—Å–ª–∏ C09 score –Ω–∏–∑–∫–∏–π ‚Üí –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        if (scenario === 'PROTEIN_DEFICIT' && patternScores.proteinSatiety) {
            if (patternScores.proteinSatiety.score < 0.5) {
                multiplier = 1.3; // +30% priority
            } else if (patternScores.proteinSatiety.score < 0.7) {
                multiplier = 1.15; // +15% priority
            }
        }

        // STRESS_EATING: –µ—Å–ª–∏ C11 correlation –≤—ã—Å–æ–∫–∏–π ‚Üí –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        if (scenario === 'STRESS_EATING' && patternScores.stressEating) {
            const absCorr = Math.abs(patternScores.stressEating.correlation || 0);
            if (absCorr > 0.5) {
                multiplier = 1.25; // +25% priority
            } else if (absCorr > 0.3) {
                multiplier = 1.1; // +10% priority
            }
        }

        // LATE_EVENING: –µ—Å–ª–∏ C13 circadian –ø–ª–æ—Ö–æ–π ‚Üí –ø–æ–≤—ã—Å–∏—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å
        if (scenario === 'LATE_EVENING' && patternScores.circadian) {
            if (patternScores.circadian.score < 0.5) {
                multiplier = 1.2; // +20% priority (–±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –ø–æ–∑–¥–Ω–µ–º—É –ø—Ä–∏—ë–º—É)
            }
        }

        // LATE_EVENING/BALANCED: high glycemic load history ‚Üí more conservative priority
        if ((scenario === 'LATE_EVENING' || scenario === 'BALANCED') && patternScores.glycemicLoad) {
            if (patternScores.glycemicLoad.score < 0.45) {
                multiplier = Math.max(multiplier, 1.15);
            }
        }

        // PRE/POST_WORKOUT: –µ—Å–ª–∏ C30 recovery –Ω–∏–∑–∫–∏–π ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
        if ((scenario === 'PRE_WORKOUT' || scenario === 'POST_WORKOUT') && patternScores.trainingRecovery) {
            if (patternScores.trainingRecovery.score < 0.6) {
                multiplier = 1.15; // +15% priority (–Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –∫ recovery)
            }
        }

        return multiplier;
    }

    /**
     * Get phenotype-adjusted macro ratios for scenario
     * @param {string} scenario - Meal scenario
     * @param {object} baseMacros - Base macro ratios {protein%, carbs%, fat%}
     * @param {object} phenotype - User phenotype profile
     * @returns {object} - Adjusted macro ratios
     */
    function getPhenotypeAdjustedMacros(scenario, baseMacros, phenotype) {
        if (!phenotype || !HEYS.InsightsPI?.phenotype) {
            return baseMacros; // No adjustment
        }

        const adjusted = { ...baseMacros };

        // Insulin resistance ‚Üí reduce carbs, increase protein
        if (phenotype.metabolic === 'insulin_resistant' || phenotype.metabolic === 'metabolic_syndrome_risk') {
            const carbReduction = phenotype.metabolic === 'metabolic_syndrome_risk' ? 0.75 : 0.85;
            adjusted.carbsRatio = (adjusted.carbsRatio || 0.4) * carbReduction;
            adjusted.proteinRatio = (adjusted.proteinRatio || 0.35) * 1.15;
            adjusted.fatRatio = 1.0 - adjusted.proteinRatio - adjusted.carbsRatio;
        }

        // Insulin sensitive ‚Üí –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ PRE/POST_WORKOUT
        if (phenotype.metabolic === 'insulin_sensitive' && (scenario === 'PRE_WORKOUT' || scenario === 'POST_WORKOUT')) {
            adjusted.carbsRatio = (adjusted.carbsRatio || 0.5) * 1.15;
            adjusted.proteinRatio = (adjusted.proteinRatio || 0.35) * 0.95;
            adjusted.fatRatio = 1.0 - adjusted.proteinRatio - adjusted.carbsRatio;
        }

        // Low satiety ‚Üí –±–æ–ª—å—à–µ –±–µ–ª–∫–∞ –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
        if (phenotype.satiety === 'low_satiety') {
            adjusted.proteinRatio = (adjusted.proteinRatio || 0.35) * 1.15;
            adjusted.carbsRatio = (adjusted.carbsRatio || 0.4) * 0.95;
            adjusted.fatRatio = 1.0 - adjusted.proteinRatio - adjusted.carbsRatio;
        }

        // Evening type ‚Üí LATE_EVENING –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∏–º (–Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –º–∞–∫—Ä–æ—Å—ã, –Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ threshold)
        // Morning type ‚Üí –Ω–∞–æ–±–æ—Ä–æ—Ç, LATE_EVENING —Å—Ç—Ä–æ–∂–µ

        console.info(`[${LOG_FILTER}] üß¨ Phenotype-adjusted macros:`, {
            scenario,
            phenotype,
            baseMacros,
            adjusted
        });

        return adjusted;
    }

    /**
     * Main integration function: enhance recommendation with pattern insights
     * @param {object} contextAnalysis - Current scenario analysis
     * @param {object} recommendation - Base recommendation
     * @param {object[]} days - Historical days
     * @param {object} profile - User profile
     * @param {object} pIndex - Product index
     * @param {object} thresholds - Adaptive thresholds
     * @returns {object} - Enhanced recommendation
     */
    function enhanceRecommendation(contextAnalysis, recommendation, days, profile, pIndex, thresholds) {
        console.info(`[${LOG_FILTER}] üöÄ enhanceRecommendation called`);

        // 1. Load pattern scores
        const patternScores = getCurrentPatternScores(days, profile, pIndex);

        // 2. Calculate dynamic confidence
        const dynamicConfidence = calculateDynamicConfidence(
            contextAnalysis.scenario,
            patternScores,
            days.length,
            thresholds
        );

        // 3. Get scenario priority multiplier
        const priorityMultiplier = getScenarioPriorityMultiplier(
            contextAnalysis.scenario,
            patternScores
        );

        // 4. Get phenotype-adjusted macros
        let adjustedMacros = recommendation.macros;
        if (profile.phenotype) {
            const baseMacroRatios = {
                proteinRatio: recommendation.macros.protein / recommendation.macros.kcal * 3, // NET Atwater: protein 3 kcal/g (TEF built-in)
                carbsRatio: recommendation.macros.carbs / recommendation.macros.kcal * 4,
                fatRatio: recommendation.macros.fat / recommendation.macros.kcal * 9
            };
            const adjustedRatios = getPhenotypeAdjustedMacros(
                contextAnalysis.scenario,
                baseMacroRatios,
                profile.phenotype
            );

            // Recalculate macros from adjusted ratios, preserving metadata fields
            const totalKcal = recommendation.macros.kcal;
            adjustedMacros = {
                ...recommendation.macros, // preserve remainingKcal, remainingMeals, ranges
                kcal: totalKcal,
                protein: Math.round((totalKcal * adjustedRatios.proteinRatio) / 3), // TEF-adjusted 3 kcal/g
                carbs: Math.round((totalKcal * adjustedRatios.carbsRatio) / 4),
                fat: Math.round((totalKcal * adjustedRatios.fatRatio) / 9)
            };
        }

        // 5. Construct enhanced result
        const enhanced = {
            ...recommendation,
            confidence: dynamicConfidence,
            macros: adjustedMacros,
            insights: {
                // Return patternScores as object { C09: 0.7, C11: 0.65, ... } not array
                patternScores: patternScores ? Object.keys(patternScores).reduce((acc, k) => {
                    acc[k] = patternScores[k].score;
                    return acc;
                }, {}) : {},
                priorityMultiplier: priorityMultiplier !== 1.0 ? priorityMultiplier : undefined,
                phenotypeApplied: !!profile.phenotype
            }
        };

        console.info(`[${LOG_FILTER}] ‚úÖ Recommendation enhanced:`, {
            confidence: dynamicConfidence.toFixed(2),
            priorityMultiplier: priorityMultiplier.toFixed(2),
            phenotypeApplied: !!profile.phenotype,
            patternsUsed: patternScores ? Object.keys(patternScores).length : 0
        });

        return enhanced;
    }

    // Public API
    HEYS.InsightsPI.mealRecPatterns = {
        getCurrentPatternScores,
        calculateDynamicConfidence,
        getScenarioPriorityMultiplier,
        getPhenotypeAdjustedMacros,
        enhanceRecommendation
    };

    console.info(`[${LOG_FILTER}] ‚úÖ Module loaded (v3.0 - Phase A/B/C: 12 patterns integrated)`);

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_meal_planner.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Multi-Meal Timeline Planner v2.3.0
 * 
 * –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –¥–æ —Å–Ω–∞ —Å —É—á—ë—Ç–æ–º:
 * - –ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã—Ö –≤–æ–ª–Ω (HEYS.InsulinWave.calculate)
 * - –û–∫–æ–Ω –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è (+30 –º–∏–Ω –ø–æ—Å–ª–µ –≤–æ–ª–Ω—ã)
 * - –ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ (sleepTarget - buffer)
 * - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Å–Ω–∞ (sleepStart –∏–∑ —á–µ–∫-–∏–Ω–∞)
 * - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞–∫—Ä–æ—Å–æ–≤ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏
 * - Hunger trade-off: –±–æ–ª—å—à–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç ‚Üí –ª—É—á—à–µ –ø–æ–µ—Å—Ç—å, —á–µ–º –ª–µ—á—å –≥–æ–ª–æ–¥–Ω—ã–º
 * - First meal of day: no lastMeal ‚Üí no wave, start from now (v2.3.0)
 *
 * v2.3.0 changes (20.02.2026):
 * - FIX: planRemainingMeals no longer requires lastMeal.time ‚Äî supports "first meal of day"
 *   When no meals eaten today, planner skips insulin wave and fat burn window,
 *   starts planning from currentTime. Enables 3-4 meal day plans from first meal.
 * - LOG: [PLANNER.wave] üåÖ First meal of day ‚Äî no active insulin wave
 *
 * v2.2.0 changes (19.02.2026):
 * - FIX: waveMinutes ‚Üí duration property name in InsulinWave.calculate() return object
 *   (was always undefined ‚Üí planner always used 3h fallback instead of real wave ~4.5h)
 *   Real fix: currentWaveData.duration (minutes), currentWaveData.remaining (remaining minutes)
 * - LOG: Added waveRemaining + endTimeDisplay to wave calculation log
 *
 * v2.1.0 changes (19.02.2026):
 * - S8: Volume-adjusted personal wave for forceMultiMeal ‚Äî smaller meal ‚Üí shorter wave
 *   (Louis-Sylvestre & Le Magnen, 1980: meal size correlates with insulin response duration)
 *   Personal wave scaled by sqrt(mealKcal / typicalMealKcal), clamped [0.7, 1.0]
 * - Updated estimateWaveDuration signature to accept optional totalBudgetKcal for scaling
 * 
 * v2.0.0 changes (19.02.2026):
 * - FIX: PRE_SLEEP threshold raised from 4h to 5h so meals 4-5h before sleep
 *   (e.g. 21:50 when sleep at 02:00 = 4.17h) get sleep-friendly products
 *   (connects to Sprint 5: pi_product_picker.js PRE_SLEEP category override)
 *
 * v1.9.0 changes (19.02.2026):
 * - NEW: estimateSleepTarget uses real sleepStart check-in data (top priority)
 *   ‚Üí personal sleep pattern: if user sleeps at 1-2 AM, deadline extends accordingly
 * - NEW: Hunger trade-off (Kinsey & Ormsbee, 2015): when budget is large but
 *   deadline has passed, reduce pre-sleep buffer (3h‚Üí2h or 1.5h) instead of
 *   refusing to plan meals. Going to bed hungry with a deficit > starving metabolism.
 * - FIX: clamp raised from [22:00, 00:30] to [22:00, 02:00] for late sleepers
 *
 * v1.8.0 changes (19.02.2026):
 * - FIX: while-loop used `cursor < lastMealDeadline` but fitsAnotherMeal used
 *   relaxed `deadlineForCheck = lastMealDeadline + 0.5`. After meal 1 added,
 *   cursor=21:33 > deadline=21:30 ‚Üí loop exited before creating meal 2.
 *   Now while-loop uses `effectiveDeadline` (relaxed when forceMultiMeal).
 *
 * v1.7.0 changes (19.02.2026):
 * - FIX: distributeBudget chrono/adaptive blend inverted from 70/30 to 30/70
 *   (chrono ratios designed for full-day distribution inverted remaining-meal split:
 *    EVENING=0.28 > SNACK=0.20 made late meal larger ‚Äî wrong for remaining budget)
 * - NEW: Monotonicity guard ‚Äî chrono never inverts adaptive "earlier = bigger" rule
 *   (Garaulet 2014: earlier meals ‚Üí better insulin sensitivity, lower postprandial glycemia)
 *
 * v1.6.0 changes (19.02.2026):
 * - NEW: MAX_MEAL_KCAL=900 cap ‚Äî force meal splitting when single meal > 900 kcal
 *   (Mifflin-St Jeor, 2003; >800-900 kcal/meal ‚Üí excessive insulin spike + poor MPS)
 * - FIX: estimateWaveDuration ‚Äî skip macro-composition modifiers when personalWaveHours
 *   is used (was double-counting: personal median already includes fat/protein effects)
 * - FIX: reduced FAT_BURN_WINDOW to 20min when forceMultiMeal to fit 2nd meal
 * - FIX: relaxed `fitsAnotherMeal` hoursToSleep threshold to 1.5h when forceMultiMeal
 * 
 * v1.4.0 changes (18.02.2026):
 * - Fixed: fitsAnotherMeal –∫—Ä–∏—Ç–µ—Ä–∏–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (–±—ã–ª–æ: <lastMealDeadline=sleepTarget-3h,
 *   —Ç—Ä–µ–±–æ–≤–∞–ª–æ 5h –¥–æ —Å–Ω–∞; —Å—Ç–∞–ª–æ: <lastMealDeadline –ò >=2h –¥–æ sleepTarget)
 * - Adaptive distributeBudget: –¥–ª—è 2 –ø—Ä–∏—ë–º–æ–≤ —Å–ø–ª–∏—Ç –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ hoursToSleep –≤—Ç–æ—Ä–æ–≥–æ
 *   (>=4h‚Üí60/40, >=3h‚Üí65/35, >=2.5h‚Üí70/30, >=2h‚Üí75/25)
 * - Step 6: –ø–µ—Ä–µ–¥–∞—ë–º hoursToSleepPerMeal –≤ distributeBudget –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–ª–∏—Ç–∞
 * 
 * v1.3.1 changes (17.02.2026):
 * - Fixed: avgBudget ‚Üí budgetForThisMeal (was ReferenceError in production)
 * 
 * v1.3 changes (17.02.2026):
 * - –û—Ü–µ–Ω–∏–≤–∞–µ–º –≤–æ–ª–Ω—É –¥–ª—è –†–ï–ê–õ–¨–ù–û —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –ø—Ä–∏—ë–º–∞ (distributeBudget)
 * - –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 2 –ø—Ä–∏—ë–º–∞ ‚Üí –±–µ—Ä—ë–º –±—é–¥–∂–µ—Ç –ø–µ—Ä–≤–æ–≥–æ ‚Üí –æ—Ü–µ–Ω–∏–≤–∞–µ–º –≤–æ–ª–Ω—É –¥–ª—è –Ω–µ–≥–æ
 * - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤–º–µ—Å—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞
 * 
 * v1.2 changes:
 * - –°–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ fitsAnotherMeal —Å 2.5h –¥–æ 2.0h
 * 
 * v1.1 changes:
 * - –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–π budget –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–ª–Ω—ã (–Ω–µ –≤–µ—Å—å –æ—Å—Ç–∞–≤—à–∏–π—Å—è)
 * - –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
 * 
 * @module pi_meal_planner
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};
    const LOG_PREFIX = '[MEALREC][HEYS.mealRec.planner]';

    // === Constants ===
    const FAT_BURN_WINDOW_MIN = 30; // –º–∏–Ω –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è –ø–æ—Å–ª–µ –≤–æ–ª–Ω—ã
    const FAT_BURN_WINDOW_MIN_TIGHT = 20; // —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ forceMultiMeal (v1.6)
    const PRE_SLEEP_BUFFER_HOURS = 3; // –Ω–µ –µ—Å—Ç—å –∑–∞ 3—á –¥–æ —Å–Ω–∞
    const DEFAULT_WAVE_ESTIMATE_HOURS = 3.5; // —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞
    const MIN_MEAL_GAP_MIN = 240; // –º–∏–Ω–∏–º—É–º 4—á –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏
    const MAX_MEALS_LIMIT = 4; // –º–∞–∫—Å –ø—Ä–∏—ë–º–æ–≤ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
    // v1.6: Max kcal per single meal (Mifflin-St Jeor, 2003; MPS saturation, insulin overload)
    // >800-900 kcal = diminishing returns for protein synthesis, excessive glycemic load
    const MAX_MEAL_KCAL = 900;

    // === Scientific constants (Sprint 3 / v1.5.0) ===
    // S1: Chrono-Nutrition ‚Äî Garaulet & G√≥mez-Abell√°n, 2014
    const CHRONO_RATIO_MORNING = 0.33;  // 06:00‚Äì10:59 (–∫–æ—Ä—Ç–∏–∑–æ–ª –ø–∏–∫, max –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
    const CHRONO_RATIO_LUNCH = 0.38;  // 11:00‚Äì14:59 (–ø–∏–∫ –ø–∏—â–µ–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
    const CHRONO_RATIO_SNACK = 0.20;  // 15:00‚Äì18:59 (–ø–æ–ª–¥–Ω–∏–∫)
    const CHRONO_RATIO_EVENING = 0.28;  // 19:00+ (—Å–Ω–∏–∂–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ —Å–Ω—É)

    // S2: Muscle Protein Synthesis ‚Äî Areta et al., 2013
    const MPS_PROT_PER_KG = 0.4; // –≥/–∫–≥ –Ω–∞ –ø—Ä–∏—ë–º –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ MPS
    const MPS_PROT_MAX_G = 40;  // –ø–æ—Ç–æ–ª–æ–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (>40–≥ –Ω–µ –ª—É—á—à–µ)

    // S3: Glycemic Load ‚Äî Ludwig, 2002
    const GL_TARGET_DAY = 20; // GL < 20 –Ω–∞ –¥–Ω–µ–≤–Ω–æ–π –ø—Ä–∏—ë–º
    const GL_TARGET_PRE_SLEEP = 10; // GL < 10 –∑–∞ ‚â§ 3—á –¥–æ —Å–Ω–∞

    // S5: Sleep-quality foods ‚Äî Halson, 2014
    const SLEEP_FRIENDLY_CATEGORIES = ['dairy', 'nuts', 'legumes', 'poultry'];

    // S6: Personal wave estimation
    const PERSONAL_WAVE_MIN_SAMPLES = 5;
    const PERSONAL_WAVE_DAYS_LOOKBACK = 14;

    // === Utility functions ===

    /**
     * Parse time string to hours (decimal)
     * @param {string} time - "HH:MM" format
     * @returns {number} - hours as decimal (e.g., 18.5 = 18:30)
     */
    function parseTime(time) {
        if (!time || typeof time !== 'string') return 0;
        const [h, m] = time.split(':').map(Number);
        if (isNaN(h) || isNaN(m)) return 0;
        return h + m / 60;
    }

    /**
     * Convert decimal hours to "HH:MM" string
     * @param {number} hours - decimal hours
     * @returns {string} - "HH:MM"
     */
    function formatTime(hours) {
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    /**
     * Convert minutes to decimal hours
     * @param {number} minutes
     * @returns {number}
     */
    function minutesToHours(minutes) {
        return minutes / 60;
    }

    /**
     * Estimate wave duration for a future meal based on macros
     * @param {object} macros - { prot, carbs, fat, kcal }
     * @param {object} profile - user profile
     * @param {number} [totalBudgetKcal] - total remaining kcal budget (for volume scaling in forceMultiMeal)
     * @returns {number} - estimated wave duration in hours
     */
    function estimateWaveDuration(macros, profile, totalBudgetKcal) {
        // –ë–∞–∑–æ–≤–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
        const baseWaveHours = profile?.insulinWaveHours || DEFAULT_WAVE_ESTIMATE_HOURS;
        const isPersonalWave = !!profile?.insulinWaveHours;

        // v1.6: –ï—Å–ª–∏ personalWaveHours (–º–µ–¥–∏–∞–Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –≥—ç–ø–æ–≤) ‚Äî –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã.
        // –ú–µ–¥–∏–∞–Ω–∞ —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç –∂–∏—Ä–æ–≤/–±–µ–ª–∫–∞ –≤ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–∏—ë–º–∞—Ö ‚Äî –Ω–µ –Ω—É–∂–Ω–æ –¥–≤–æ–∏—Ç—å.
        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è DEFAULT_WAVE_ESTIMATE_HOURS (–∫–æ–≥–¥–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏).
        if (isPersonalWave) {
            let wave = baseWaveHours;

            // S8 (v2.1.0): Volume-adjusted wave for split meals
            // Personal wave = median of typical meal gaps. If this meal is smaller than typical,
            // wave should be proportionally shorter. Louis-Sylvestre & Le Magnen, 1980:
            // insulin response amplitude and duration correlate with meal caloric load.
            // Use sqrt scaling (sublinear ‚Äî 50% calories ‚âà 71% wave, not 50%)
            if (totalBudgetKcal && macros.kcal && macros.kcal < totalBudgetKcal * 0.85) {
                // Typical meal ‚âà totalBudget / 2 or 3 (but personal wave was calibrated on full meals)
                // Scale: ratio = mealKcal / totalBudgetKcal, factor = sqrt(ratio), clamp [0.7, 1.0]
                const ratio = macros.kcal / totalBudgetKcal;
                const scaleFactor = Math.max(0.7, Math.min(1.0, Math.sqrt(ratio)));
                wave = baseWaveHours * scaleFactor;
                console.info(`${LOG_PREFIX} [wave] üìê S8: Volume-scaled personal wave: ${baseWaveHours.toFixed(2)}h √ó ${scaleFactor.toFixed(2)} = ${wave.toFixed(2)}h (meal ${Math.round(macros.kcal)} / total ${Math.round(totalBudgetKcal)} kcal)`);
            }

            return Math.max(2.5, Math.min(5.0, wave));
        }

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–∞–≤–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
        let multiplier = 1.0;

        const gi = macros.gi || 50; // —Å—Ä–µ–¥–Ω–∏–π GI
        const carbsG = macros.carbs || 0;
        const protG = macros.prot || 0;
        const fatG = macros.fat || 0;

        // –í—ã—Å–æ–∫–∏–π GI ‚Üí –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞
        if (gi > 70) multiplier *= 0.9;
        else if (gi < 40) multiplier *= 1.1;

        // –í—ã—Å–æ–∫–∏–µ –∂–∏—Ä—ã ‚Üí –¥–ª–∏–Ω–Ω–µ–µ –≤–æ–ª–Ω–∞
        if (fatG > 20) multiplier *= 1.15;
        else if (fatG > 30) multiplier *= 1.25;

        // –í—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫ ‚Üí —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç
        if (protG > 30) multiplier *= 1.05;

        const estimated = baseWaveHours * multiplier;
        return Math.max(2.5, Math.min(5.0, estimated)); // clamp 2.5-5h
    }

    /**
     * S1: Chrono-Nutrition ratio by time of day (Garaulet & G√≥mez-Abell√°n, 2014)
     * @param {number} mealTimeHours - decimal hours (e.g. 13.5 = 13:30)
     * @returns {number} - energy ratio weight
     */
    function getChronoRatio(mealTimeHours) {
        if (mealTimeHours < 11) return CHRONO_RATIO_MORNING;
        if (mealTimeHours < 15) return CHRONO_RATIO_LUNCH;
        if (mealTimeHours < 19) return CHRONO_RATIO_SNACK;
        return CHRONO_RATIO_EVENING;
    }

    /**
     * S6: Estimate personal insulin wave duration from historical meal gaps
     * @param {Array<object>} days - historical days
     * @returns {number|null} - median gap in hours, or null if insufficient data
     */
    function estimatePersonalWaveHours(days) {
        const gaps = [];
        days.slice(-PERSONAL_WAVE_DAYS_LOOKBACK).forEach(d => {
            const meals = d?.meals || [];
            for (let i = 1; i < meals.length; i++) {
                const gap = parseTime(meals[i].time) - parseTime(meals[i - 1].time);
                if (gap >= 2 && gap <= 6) gaps.push(gap); // —Ñ–∏–ª—å—Ç—Ä –∞–Ω–æ–º–∞–ª–∏–π
            }
        });
        if (gaps.length < PERSONAL_WAVE_MIN_SAMPLES) return null;
        gaps.sort((a, b) => a - b);
        return gaps[Math.floor(gaps.length / 2)]; // –º–µ–¥–∏–∞–Ω–∞
    }

    /**
     * –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–π—Å—è –±—é–¥–∂–µ—Ç –º–µ–∂–¥—É N –ø—Ä–∏—ë–º–∞–º–∏
     * @param {object} remainingBudget - { prot, carbs, fat, kcal }
     * @param {number} mealsCount - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–æ–≤
     * @param {Array<number>} [hoursToSleepPerMeal] - —á–∞—Å–æ–≤ –¥–æ —Å–Ω–∞ —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
     * @param {Array<number>} [mealTimes] - –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–æ–≤ –≤ —á–∞—Å–∞—Ö (S1: chrono-nutrition)
     * @returns {Array<object>} - –º–∞—Å—Å–∏–≤ –±—é–¥–∂–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
     */
    function distributeBudget(remainingBudget, mealsCount, hoursToSleepPerMeal, mealTimes) {
        if (mealsCount === 1) {
            return [remainingBudget];
        }

        // Ratios: –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–æ–±–æ–ª—å—à–µ, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–µ–≥—á–µ
        const ratios = {
            1: [1.0],
            2: [0.60, 0.40], // –¥–µ—Ñ–æ–ª—Ç –¥–ª—è 2 –ø—Ä–∏—ë–º–æ–≤
            3: [0.45, 0.35, 0.20],
            4: [0.35, 0.30, 0.20, 0.15]
        };

        let ratio = ratios[mealsCount] || ratios[4];

        // üÜï v1.4: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Å–ø–ª–∏—Ç –¥–ª—è 2 –ø—Ä–∏—ë–º–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ hoursToSleep –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏—ë–º–∞
        // –ß–µ–º –±–ª–∏–∂–µ –≤—Ç–æ—Ä–æ–π –ø—Ä–∏—ë–º –∫ —Å–Ω—É ‚Üí —Ç–µ–º –º–µ–Ω—å—à–µ –µ–≥–æ –¥–æ–ª—è (–Ω–µ–ª—å–∑—è –µ—Å—Ç—å –º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º)
        if (mealsCount === 2 && hoursToSleepPerMeal?.length >= 2) {
            const h2 = hoursToSleepPerMeal[1]; // —á–∞—Å–æ–≤ –¥–æ —Å–Ω–∞ —É –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏—ë–º–∞
            if (h2 >= 4.0) {
                ratio = [0.60, 0.40]; // —Å—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî –æ–±–∞ –±–æ–ª—å—à–∏–µ
            } else if (h2 >= 3.0) {
                ratio = [0.65, 0.35]; // –≤—Ç–æ—Ä–æ–π —á—É—Ç—å –º–µ–Ω—å—à–µ
            } else if (h2 >= 2.5) {
                ratio = [0.70, 0.30]; // –≤—Ç–æ—Ä–æ–π –ª—ë–≥–∫–∏–π
            } else {
                ratio = [0.75, 0.25]; // –≤—Ç–æ—Ä–æ–π —Å–æ–≤—Å–µ–º –ª—ë–≥–∫–∏–π (–±–ª–∏–∑–∫–æ –∫–æ —Å–Ω—É)
            }
            console.info(`${LOG_PREFIX} [PLANNER.split] ‚öñÔ∏è Adaptive 2-meal split: h2Sleep=${h2.toFixed(1)}h ‚Üí ${(ratio[0] * 100).toFixed(0)}/${(ratio[1] * 100).toFixed(0)}`);
        }

        // üÜï v1.5/v1.7: S1 Chrono-Nutrition ‚Äî —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ratio –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (Garaulet 2014)
        // v1.7: Chrono ratios designed for FULL-DAY distribution (EVENING=0.28 > SNACK=0.20).
        //   For REMAINING-meal distribution, adaptive split (hoursToSleep-based) is primary.
        //   Blend: 30% chrono + 70% adaptive (was 70/30 ‚Äî caused late meal > early meal inversion)
        if (mealTimes?.length >= mealsCount) {
            const chronoRaw = mealTimes.slice(0, mealsCount).map(t => getChronoRatio(t));
            const chronoSum = chronoRaw.reduce((a, b) => a + b, 0);
            const chronoNorm = chronoRaw.map(r => r / chronoSum); // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí —Å—É–º–º–∞ = 1.0
            const chronoMin = Math.min(...chronoNorm);
            const chronoMax = Math.max(...chronoNorm);
            if (chronoMax - chronoMin > 0.05) {
                // v1.7: 30% chrono + 70% adaptive (adaptive is primary for remaining meals)
                const adaptiveRatio = [...ratio]; // save pre-chrono adaptive ratio
                const blended = chronoNorm.map((c, i) => c * 0.3 + (ratio[i] || 1 / mealsCount) * 0.7);
                const blendedSum = blended.reduce((a, b) => a + b, 0);
                const blendedNorm = blended.map(r => r / blendedSum);

                // v1.7: Monotonicity guard ‚Äî chrono must NOT invert "earlier = bigger" rule.
                // If adaptive says meal[0] > meal[last] but chrono blend reverses it ‚Üí skip chrono.
                // Science: earlier meals have better insulin sensitivity (Garaulet 2014),
                //   lower postprandial glycemia, and more time for TEF.
                const adaptiveDecreasing = adaptiveRatio[0] >= adaptiveRatio[adaptiveRatio.length - 1];
                const blendedDecreasing = blendedNorm[0] >= blendedNorm[blendedNorm.length - 1];

                if (adaptiveDecreasing && !blendedDecreasing) {
                    // Chrono would invert the order ‚Üí skip it, keep adaptive
                    console.info(`${LOG_PREFIX} [chrono] ‚è∞ Chrono-Nutrition SKIPPED (would invert early>late rule):`,
                        `chrono=[${chronoNorm.map(r => (r * 100).toFixed(0) + '%').join(',')}]`,
                        `adaptive=[${adaptiveRatio.map(r => (r * 100).toFixed(0) + '%').join(',')}]`,
                        `blended=[${blendedNorm.map(r => (r * 100).toFixed(0) + '%').join(',')}]`,
                        '‚Üí keeping adaptive'
                    );
                } else {
                    ratio = blendedNorm;
                    console.info(`${LOG_PREFIX} [chrono] ‚è∞ Chrono-Nutrition ratios applied (30/70 blend):`,
                        ratio.map((r, i) => `Meal${i + 1}@${(mealTimes[i] || 0).toFixed(1)}h=${(r * 100).toFixed(0)}%`).join(', ')
                    );
                }
            }
        }

        const budgets = [];

        for (let i = 0; i < mealsCount; i++) {
            const r = ratio[i] || (1 / mealsCount);
            const mealProt = Math.round(remainingBudget.prot * r);
            const mealCarbs = Math.round(remainingBudget.carbs * r);
            const mealFat = Math.round(remainingBudget.fat * r);
            // S7 (Sprint 6): TEF-Aware effectiveKcal ‚Äî protein counted at 3 kcal/g (TEF ~25%)
            // Halton & Hu, 2004: protein TEF is 20-30%; HEYS convention uses 3 kcal/g
            // effectiveKcal represents net metabolic energy available after digestion
            const effectiveKcal = mealProt * 3 + mealCarbs * 4 + mealFat * 9;
            budgets.push({
                prot: mealProt,
                carbs: mealCarbs,
                fat: mealFat,
                kcal: Math.round(remainingBudget.kcal * r),
                effectiveKcal // S7: TEF-adjusted energy (protein=3kcal/g)
            });
        }

        console.info(`${LOG_PREFIX} [PLANNER.budget] üß† TEF-adjusted budgets (S7):`, budgets.map((b, i) =>
            `Meal${i + 1}: ${b.kcal}kcal nominal ‚Üí ${b.effectiveKcal}kcal effective (P${b.prot}g√ó3+C${b.carbs}g√ó4+F${b.fat}g√ó9)`
        ));

        return budgets;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
     * @param {number} index - –∏–Ω–¥–µ–∫—Å –ø—Ä–∏—ë–º–∞ (0-based)
     * @param {number} totalMeals - –≤—Å–µ–≥–æ –ø—Ä–∏—ë–º–æ–≤
     * @param {object} mealBudget - –±—é–¥–∂–µ—Ç —ç—Ç–æ–≥–æ –ø—Ä–∏—ë–º–∞
     * @param {number} hoursToSleep - —á–∞—Å–æ–≤ –¥–æ —Å–Ω–∞
     * @returns {string} - scenario code
     */
    function detectMealScenario(index, totalMeals, mealBudget, hoursToSleep) {
        const isLast = (index === totalMeals - 1);
        const kcal = mealBudget.kcal || 0;
        const prot = mealBudget.prot || 0;

        // üÜï S5: –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–µ—Ä–µ–¥ —Å–Ω–æ–º ‚Üí PRE_SLEEP (sleep-quality foods, Halson 2014)
        // v1.9.1: raised threshold 4h‚Üí5h (research: 4-5h pre-sleep = still relevant for GI/protein choice)
        if (isLast && hoursToSleep < 5) {
            return 'PRE_SLEEP';
        }

        // –ù–∏–∑–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π ‚Üí –ø–µ—Ä–µ–∫—É—Å
        if (kcal < 150) {
            return 'LIGHT_SNACK';
        }

        // –í—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫ –≤ –ø—Ä–∏—ë–º–µ
        if (prot > 30) {
            return 'PROTEIN_DEFICIT';
        }

        // –î–µ—Ñ–æ–ª—Ç
        return 'BALANCED';
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–Ω–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
     * @param {Array<object>} days - –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–Ω–∏
     * @param {object} profile - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @returns {number} - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–Ω–∞ –≤ —á–∞—Å–∞—Ö (decimal)
     */
    function estimateSleepTarget(days, profile) {
        // === –ü–æ–ø—ã—Ç–∫–∞ 0 (v1.9): –°—Ä–µ–¥–Ω–µ–µ sleepStart –∏–∑ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫-–∏–Ω–∞ (—Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫) ===
        // –ê–Ω–∞–ª–æ–≥ getAverageBedtime() –∏–∑ advice_bundle ‚Äî —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–∂–∏—Ç—Å—è –≤ 1-2 –Ω–æ—á–∏, —ç—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—á—Ç–µ–Ω–æ
        if (days.length >= 3) {
            const sleepStarts = days
                .slice(-14) // 2 –Ω–µ–¥–µ–ª–∏ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
                .map(d => d.sleepStart)
                .filter(t => t && typeof t === 'string' && t.includes(':'));

            if (sleepStarts.length >= 3) {
                const minutesFromMidnight = sleepStarts.map(t => {
                    const [h, m] = t.split(':').map(Number);
                    // h < 12 = –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ (01:00 ‚Üí 25—á, 02:00 ‚Üí 26—á)
                    return h < 12 ? (h + 24) * 60 + m : h * 60 + m;
                });
                const avgMinutes = minutesFromMidnight.reduce((a, b) => a + b, 0) / minutesFromMidnight.length;
                const sleepHours = avgMinutes / 60; // –≤ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö —á–∞—Å–∞—Ö (25.0 = 01:00)
                // Clamp [22:00, 02:00] ‚Äî —Ä–∞–∑—É–º–Ω—ã–µ –ø—Ä–µ–¥–µ–ª—ã –¥–∞–∂–µ –¥–ª—è —Å–æ–≤
                const clamped = Math.min(26.0, Math.max(22.0, sleepHours));
                console.info(`${LOG_PREFIX} üìä Sleep target from check-in data (sleepStart):`, {
                    sampleSize: sleepStarts.length,
                    avgSleepTime: formatTime(sleepHours),
                    sleepTarget: formatTime(clamped),
                    wasClamped: Math.abs(sleepHours - clamped) > 0.01,
                    source: 'sleepStart_checkin'
                });
                return clamped;
            }
        }

        // === –ü–æ–ø—ã—Ç–∫–∞ 1: profile.sleepHours + –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º ‚Üí –≤—Ä–µ–º—è —Å–Ω–∞ ===
        if (profile?.sleepHours && days.length >= 3) {
            const lastMealTimes = days
                .slice(-7) // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
                .map(d => {
                    const meals = d?.meals || [];
                    if (meals.length === 0) return null;
                    const last = meals[meals.length - 1];
                    return last?.time ? parseTime(last.time) : null;
                })
                .filter(t => t !== null && t > 0);

            if (lastMealTimes.length >= 3) {
                const avgLastMeal = lastMealTimes.reduce((a, b) => a + b) / lastMealTimes.length;
                // sleepTarget ‚âà –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º + 3—á
                const estimatedRaw = avgLastMeal + 3;
                // v1.9: raised upper clamp from 00:30 to 02:00 for late sleepers
                // 26.0 = 02:00 next day (upper), 22.0 = 22:00 (lower)
                const estimated = Math.min(26.0, Math.max(22.0, estimatedRaw));
                console.info(`${LOG_PREFIX} üìä Estimated sleep target from meal data:`, {
                    avgLastMeal: formatTime(avgLastMeal),
                    sleepTargetRaw: formatTime(estimatedRaw),
                    sleepTarget: formatTime(estimated),
                    clamped: estimatedRaw !== estimated,
                    sampleSize: lastMealTimes.length,
                    source: 'avgLastMeal+3h'
                });
                return estimated;
            }
        }

        // –ü–æ–ø—ã—Ç–∫–∞ 2: –∏–∑ profile.sleepTarget –µ—Å–ª–∏ –µ—Å—Ç—å
        if (profile?.sleepTarget) {
            return parseTime(profile.sleepTarget);
        }

        // –§–æ–ª–ª–±–µ–∫: 23:00
        return 23.0;
    }

    /**
     * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–∏—ë–º–æ–≤ –¥–æ —Å–Ω–∞
     * 
     * @param {object} params
     * @param {string} params.currentTime - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è "HH:MM"
     * @param {object} params.lastMeal - –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º { time, items, totals }
     * @param {object} params.dayTarget - –¥–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å { prot, carbs, fat, kcal }
     * @param {object} params.dayEaten - —É–∂–µ —Å—ä–µ–¥–µ–Ω–æ { prot, carbs, fat, kcal }
     * @param {object} params.profile - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param {Array<object>} params.days - –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–Ω–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
     * @param {object} params.pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     * @returns {object} - { available, meals: PlannedMeal[], summary }
     */
    function planRemainingMeals(params) {
        const {
            currentTime,
            lastMeal,
            dayTarget = {},
            dayEaten = {},
            profile = {},
            days = [],
            pIndex = {}
        } = params;

        console.info(`${LOG_PREFIX} [PLANNER.entry] üçΩÔ∏è planRemainingMeals called:`, {
            currentTime,
            lastMealTime: lastMeal?.time,
            lastMealTotals: lastMeal?.totals,
            hasInsulinWave: !!HEYS.InsulinWave,
            daysCount: days.length,
            dayTarget,
            dayEaten
        });

        // Validate
        if (!currentTime) {
            console.warn(`${LOG_PREFIX} ‚ùå Missing currentTime`);
            return { available: false, error: 'Missing required data' };
        }

        // v2.3.0: Support "first meal of day" ‚Äî no lastMeal means no active wave
        const hasLastMeal = !!lastMeal?.time;

        if (!HEYS.InsulinWave?.calculate) {
            console.warn(`${LOG_PREFIX} ‚ùå InsulinWave module not available`);
            return { available: false, error: 'InsulinWave module missing' };
        }

        const currentTimeHours = parseTime(currentTime);
        const lastMealTimeHours = hasLastMeal ? parseTime(lastMeal.time) : null;

        // === –®–∞–≥ 1: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã ===
        let currentWaveEnd = null;
        let currentWaveData = null;

        if (hasLastMeal) {
            try {
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
                const lastMealNutrients = {
                    kcal: lastMeal.totals?.kcal || 0,
                    protein: lastMeal.totals?.prot || 0,
                    carbs: lastMeal.totals?.carbs || 0,
                    fat: lastMeal.totals?.fat || 0,
                    glycemicLoad: lastMeal.totals?.glycemicLoad || 0
                };

                currentWaveData = HEYS.InsulinWave.calculate({
                    lastMealTime: lastMeal.time,
                    nutrients: lastMealNutrients,
                    profile: profile,
                    baseWaveHours: profile?.insulinWaveHours || 3
                });

                if (currentWaveData?.duration) {
                    const waveEndMinutes = HEYS.utils?.timeToMinutes(lastMeal.time) + currentWaveData.duration;
                    currentWaveEnd = minutesToHours(waveEndMinutes);
                    console.info(`${LOG_PREFIX} [PLANNER.wave] üìä Current insulin wave calculated:`, {
                        lastMeal: lastMeal.time,
                        waveDuration: currentWaveData.duration,
                        waveEnd: formatTime(currentWaveEnd),
                        remaining: currentWaveData.remaining,
                        progress: currentWaveData.progress?.toFixed(1) + '%',
                        endTimeDisplay: currentWaveData.endTimeDisplay,
                        nutrients: lastMealNutrients
                    });
                }
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Failed to calculate current wave:`, err.message);
            }

            // –§–æ–ª–ª–±–µ–∫: –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å, –±–µ—Ä—ë–º –±–∞–∑–æ–≤—É—é –¥–ª–∏–Ω—É –≤–æ–ª–Ω—ã
            if (!currentWaveEnd) {
                const baseWave = profile?.insulinWaveHours || 3;
                currentWaveEnd = lastMealTimeHours + baseWave;
                console.info(`${LOG_PREFIX} üìä Using fallback wave estimate:`, {
                    lastMeal: formatTime(lastMealTimeHours),
                    waveEnd: formatTime(currentWaveEnd),
                    baseWaveHours: baseWave
                });
            }
        } else {
            // v2.3.0: No last meal ‚Äî first meal of day, no active insulin wave
            console.info(`${LOG_PREFIX} [PLANNER.wave] üåÖ First meal of day ‚Äî no active insulin wave, starting from now`);
        }

        // === –®–∞–≥ 2: +30 –º–∏–Ω –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è ===
        // v2.3.0: When no lastMeal, skip fat burn window ‚Äî just start from currentTime
        const fatBurnEnd = currentWaveEnd ? currentWaveEnd + minutesToHours(FAT_BURN_WINDOW_MIN) : currentTimeHours;
        const nextMealEarliest = Math.max(currentTimeHours, fatBurnEnd);

        console.info(`${LOG_PREFIX} [PLANNER.fatburn] üî• Fat burn window calculated:`, {
            waveEnd: formatTime(currentWaveEnd),
            fatBurnWindowMin: FAT_BURN_WINDOW_MIN,
            fatBurnEnd: formatTime(fatBurnEnd),
            currentTime: formatTime(currentTimeHours),
            nextMealEarliest: formatTime(nextMealEarliest)
        });

        // === –®–∞–≥ 3: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è —Å–Ω–∞ –∏ deadline –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ ===
        const sleepTarget = estimateSleepTarget(days, profile);
        let lastMealDeadline = sleepTarget - PRE_SLEEP_BUFFER_HOURS;
        let hungerTradeoffApplied = false;
        let effectiveBuffer = PRE_SLEEP_BUFFER_HOURS;

        console.info(`${LOG_PREFIX} [PLANNER.sleep] üåô Sleep planning:`, {
            sleepTarget: formatTime(sleepTarget),
            preSleepBuffer: PRE_SLEEP_BUFFER_HOURS,
            lastMealDeadline: formatTime(lastMealDeadline),
            availableWindow: `${formatTime(nextMealEarliest)} ‚Üí ${formatTime(lastMealDeadline)}`
        });

        // === S4: POST_WORKOUT detection (Ivy, 2004) ===
        // –ê–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ 2—á: 0.35 –≥/–∫–≥ –±–µ–ª–∫–∞ + 1.0 –≥/–∫–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
        const recentWorkout = params.currentDay?.workouts?.find(
            w => w.endTime && (currentTimeHours - parseTime(w.endTime)) >= 0 && (currentTimeHours - parseTime(w.endTime)) < 2
        );
        if (recentWorkout) {
            console.info(`${LOG_PREFIX} [workout] üí™ Recent workout detected (anabolic window active):`, {
                endTime: recentWorkout.endTime,
                hoursAgo: (currentTimeHours - parseTime(recentWorkout.endTime)).toFixed(1),
                type: recentWorkout.type || 'unknown'
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞?
        if (nextMealEarliest >= lastMealDeadline) {
            // === v1.9: Hunger trade-off (Kinsey & Ormsbee, 2015) ===
            // –õ—É—á—à–µ –ø–æ–µ—Å—Ç—å –ª—ë–≥–∫–∏–π –±–µ–ª–∫–æ–≤—ã–π –ø—Ä–∏—ë–º –∑–∞ 1.5-2—á –¥–æ —Å–Ω–∞, —á–µ–º –ª–µ—á—å –≥–æ–ª–æ–¥–Ω—ã–º.
            // –ë–æ–ª—å—à–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç ‚Üí –∫–æ—Ä—Ç–∏–∑–æ–ª ‚Üë, –∫–∞—Ç–∞–±–æ–ª–∏–∑–º, –ø–ª–æ—Ö–æ–π —Å–æ–Ω.
            // Pre-sleep protein (–∫–∞–∑–µ–∏–Ω, —Ç–≤–æ—Ä–æ–≥) –£–õ–£–ß–®–ê–ï–¢ MPS –±–µ–∑ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
            const quickBudgetKcal = Math.max(0, (dayTarget.kcal || 0) - (dayEaten.kcal || 0));

            if (quickBudgetKcal >= 800) {
                // –°–µ—Ä—å—ë–∑–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç: –±—É—Ñ–µ—Ä 3h ‚Üí 1.5h
                const reducedDeadline = sleepTarget - 1.5;
                if (nextMealEarliest < reducedDeadline) {
                    lastMealDeadline = reducedDeadline;
                    hungerTradeoffApplied = true;
                    effectiveBuffer = 1.5;
                    console.info(`${LOG_PREFIX} [PLANNER.hunger] ‚ö†Ô∏è Severe deficit ${Math.round(quickBudgetKcal)} kcal ‚Üí buffer 3h‚Üí1.5h (eating > starving; Kinsey & Ormsbee, 2015)`, {
                        newDeadline: formatTime(reducedDeadline),
                        sleepTarget: formatTime(sleepTarget),
                        hoursBeforeSleep: (sleepTarget - nextMealEarliest).toFixed(1)
                    });
                }
            } else if (quickBudgetKcal >= 400) {
                // –£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç: –±—É—Ñ–µ—Ä 3h ‚Üí 2h
                const reducedDeadline = sleepTarget - 2.0;
                if (nextMealEarliest < reducedDeadline) {
                    lastMealDeadline = reducedDeadline;
                    hungerTradeoffApplied = true;
                    effectiveBuffer = 2.0;
                    console.info(`${LOG_PREFIX} [PLANNER.hunger] ‚ö†Ô∏è Moderate deficit ${Math.round(quickBudgetKcal)} kcal ‚Üí buffer 3h‚Üí2h`, {
                        newDeadline: formatTime(reducedDeadline),
                        sleepTarget: formatTime(sleepTarget)
                    });
                }
            }

            if (!hungerTradeoffApplied) {
                console.info(`${LOG_PREFIX} ‚ÑπÔ∏è No time for additional meals (nextMeal >= deadline, deficit ${Math.round(quickBudgetKcal || 0)} kcal)`);
                return {
                    available: true,
                    meals: [],
                    summary: {
                        totalMeals: 0,
                        reason: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–Ω–∞ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤'
                    }
                };
            }
        }

        // === –®–∞–≥ 4: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ—Å—Ç–∞–≤—à–∏–π—Å—è –±—é–¥–∂–µ—Ç ===
        const remainingBudget = {
            prot: Math.max(0, (dayTarget.prot || 0) - (dayEaten.prot || 0)),
            carbs: Math.max(0, (dayTarget.carbs || 0) - (dayEaten.carbs || 0)),
            fat: Math.max(0, (dayTarget.fat || 0) - (dayEaten.fat || 0)),
            kcal: Math.max(0, (dayTarget.kcal || 0) - (dayEaten.kcal || 0))
        };

        // –§–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π minimum: –µ—Å–ª–∏ –∫–∫–∞–ª –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äî
        // –ø—Ä–∏–º–µ–Ω—è–µ–º floor —á—Ç–æ–±—ã product picker –ø—Ä–µ–¥–ª–∞–≥–∞–ª —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        if (remainingBudget.kcal >= 200) {
            // –ú–∏–Ω–∏–º—É–º 20% –∫–∫–∞–ª –∏–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤ (~4 –∫–∫–∞–ª/–≥)
            const minCarbs = Math.round(remainingBudget.kcal * 0.20 / 4);
            if (remainingBudget.carbs < minCarbs) {
                console.info(`${LOG_PREFIX} [PLANNER.budget] ‚ö†Ô∏è Carbs floor applied: goal met, using min ${minCarbs}g for product variety (was ${remainingBudget.carbs}g)`);
                remainingBudget.carbs = minCarbs;
            }
            // –ú–∏–Ω–∏–º—É–º 15% –∫–∫–∞–ª –∏–∑ –∂–∏—Ä–æ–≤ (~9 –∫–∫–∞–ª/–≥)
            const minFat = Math.round(remainingBudget.kcal * 0.15 / 9);
            if (remainingBudget.fat < minFat) {
                console.info(`${LOG_PREFIX} [PLANNER.budget] ‚ö†Ô∏è Fat floor applied: goal met, using min ${minFat}g for product variety (was ${remainingBudget.fat}g)`);
                remainingBudget.fat = minFat;
            }
        }

        console.info(`${LOG_PREFIX} [PLANNER.budget] üí∞ Remaining budget:`, {
            ...remainingBudget,
            percentOfTarget: {
                prot: ((remainingBudget.prot / (dayTarget.prot || 1)) * 100).toFixed(0) + '%',
                kcal: ((remainingBudget.kcal / (dayTarget.kcal || 1)) * 100).toFixed(0) + '%'
            }
        });

        // –ï—Å–ª–∏ –±—é–¥–∂–µ—Ç <50 kcal ‚Üí –Ω–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º
        if (remainingBudget.kcal < 50) {
            console.info(`${LOG_PREFIX} ‚ÑπÔ∏è Insufficient remaining budget (< 50 kcal)`);
            return {
                available: true,
                meals: [],
                summary: {
                    totalMeals: 0,
                    reason: '–î–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'
                }
            };
        }

        // === S6: Adaptive wave from personal history (estimate) ===
        const personalWaveHours = estimatePersonalWaveHours(days);
        const effectiveProfile = personalWaveHours
            ? { ...profile, insulinWaveHours: personalWaveHours }
            : profile;
        if (personalWaveHours) {
            console.info(`${LOG_PREFIX} [wave] üß¨ Personal wave estimated from history:`, {
                personalWaveHours: personalWaveHours.toFixed(2),
                defaultWave: DEFAULT_WAVE_ESTIMATE_HOURS,
                sampleDays: Math.min(days.length, PERSONAL_WAVE_DAYS_LOOKBACK)
            });
        }

        // === –®–∞–≥ 5: –¶–∏–∫–ª –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏—ë–º–æ–≤ ===
        const plannedMeals = [];
        let cursor = nextMealEarliest;
        let iteration = 0;

        // v1.6: Force multi-meal when total remaining budget exceeds safe single-meal threshold
        //   (Mifflin-St Jeor, 2003; MPS: Areta et al., 2013; GL: Ludwig, 2002)
        //   >900 kcal in one sitting = excessive insulin spike, poor protein synthesis distribution
        const forceMultiMeal = remainingBudget.kcal > MAX_MEAL_KCAL;
        // When forcing multi-meal, use tighter wave estimate and smaller fat burn window
        const effectiveFatBurnMin = forceMultiMeal ? FAT_BURN_WINDOW_MIN_TIGHT : FAT_BURN_WINDOW_MIN;

        // v1.8: while-loop must also use relaxed deadline when forceMultiMeal.
        // Without this, fitsAnotherMeal=true (relaxed deadline) adds meal 1 ‚Üí cursor moves
        // past lastMealDeadline ‚Üí while exits before creating meal 2.
        const effectiveDeadline = forceMultiMeal ? lastMealDeadline + 0.5 : lastMealDeadline;

        if (forceMultiMeal) {
            console.info(`${LOG_PREFIX} [PLANNER.split] ‚ö†Ô∏è Force multi-meal: remaining ${Math.round(remainingBudget.kcal)} kcal > ${MAX_MEAL_KCAL} cap, deadline relaxed ${formatTime(lastMealDeadline)} ‚Üí ${formatTime(effectiveDeadline)}`);
        }

        console.info(`${LOG_PREFIX} [PLANNER.loop] üîÑ Starting meal placement loop:`, {
            startCursor: formatTime(cursor),
            deadline: formatTime(effectiveDeadline),
            availableHours: (effectiveDeadline - cursor).toFixed(1)
        });

        while (cursor < effectiveDeadline && iteration < MAX_MEALS_LIMIT) {
            iteration++;

            // üÜï v1.3: –û—Ü–µ–Ω–∏–≤–∞–µ–º –≤–æ–ª–Ω—É –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –ø—Ä–∏—ë–º–∞
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –º–æ–∂–µ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë 2 –ø—Ä–∏—ë–º–∞ ‚Üí —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º budget –Ω–∞ 2
            // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –∏ –æ—Ü–µ–Ω–∏–≤–∞–µ–º –≤–æ–ª–Ω—É –¥–ª—è –ù–ï–Å
            const mealsEstimate = Math.min(2, MAX_MEALS_LIMIT - plannedMeals.length);
            const budgetsEstimate = distributeBudget(remainingBudget, mealsEstimate);
            const budgetForThisMeal = budgetsEstimate[0];

            const estimatedWave = estimateWaveDuration(budgetForThisMeal, effectiveProfile, forceMultiMeal ? remainingBudget.kcal : undefined);
            const waveEndTime = cursor + estimatedWave;
            const fatBurnWindowEnd = waveEndTime + minutesToHours(effectiveFatBurnMin);

            console.info(`${LOG_PREFIX} [PLANNER.loop.${iteration}] üßÆ Evaluating meal slot:`, {
                cursor: formatTime(cursor),
                mealsEstimate,
                thisMealKcal: Math.round(budgetForThisMeal.kcal),
                remainingKcal: Math.round(remainingBudget.kcal),
                estimatedWaveHours: estimatedWave.toFixed(1),
                waveEnd: formatTime(waveEndTime),
                fatBurnEnd: formatTime(fatBurnWindowEnd)
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤–ª–µ–∑–∞–µ—Ç –ª–∏ –µ—â—ë –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ?
            // S8 (v2.1.0): When forceMultiMeal on first iteration, use a minimum fixed gap (2h)
            // instead of waiting for full wave + fat burn. Rationale:
            // - Eating 1465 kcal in one sitting ‚Üí excessive insulin spike, poor MPS distribution
            // - Two meals with 2h gap ‚Üí partial insulin overlap, but MUCH better protein synthesis
            //   and glycemic load distribution (Areta et al., 2013; Ludwig, 2002)
            // - Personal wave (median meal gap) INCLUDES fat burn + buffer already ‚Üí double-counting
            // The min gap of 2h allows ~50% insulin decay before second meal (sufficient for physiology)
            const MIN_FORCE_MULTI_GAP_H = 2.0;
            const nextPossibleStart = forceMultiMeal && plannedMeals.length === 0
                ? cursor + Math.min(estimatedWave, MIN_FORCE_MULTI_GAP_H)  // S8: tight 2h gap
                : fatBurnWindowEnd;
            // üÜï v1.4: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π:
            //   1. nextPossibleStart –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–û deadline (sleepTarget - 3h)
            //   2. –û—Ç nextPossibleStart –¥–æ sleepTarget –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >=2h (—á—Ç–æ–±—ã —É—Å–ø–µ–ª–∞ –ø—Ä–æ–π—Ç–∏ —Ö–æ—Ç—å —á–∞—Å—Ç—å –≤–æ–ª–Ω—ã)
            // üÜï v1.6: When forceMultiMeal ‚Äî relax hoursToSleep to 1.5h and accept nextMealStart <= deadline + 0.5h
            //   (scientific basis: a smaller 2nd meal has shorter wave, and eating 1600 kcal at once is worse
            //    for health than a slightly late 2nd meal close to sleep)
            const hoursToSleepIfNextMeal = sleepTarget - nextPossibleStart;
            const minHoursToSleep = forceMultiMeal && plannedMeals.length === 0 ? 1.5 : 2.0;
            const deadlineForCheck = forceMultiMeal && plannedMeals.length === 0
                ? lastMealDeadline + 0.5  // relax deadline by 30min for forced split
                : lastMealDeadline;
            const fitsAnotherMeal = nextPossibleStart < deadlineForCheck && hoursToSleepIfNextMeal >= minHoursToSleep;

            console.info(`${LOG_PREFIX} [PLANNER.loop.${iteration}] ü§î Can fit another meal?`, {
                nextPossibleStart: formatTime(nextPossibleStart),
                deadline: formatTime(lastMealDeadline),
                hoursToSleepIfNext: hoursToSleepIfNextMeal.toFixed(1),
                fitsAnotherMeal,
                forceMultiMeal
            });

            if (!fitsAnotherMeal) {
                // –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–∏—ë–º
                plannedMeals.push({
                    index: plannedMeals.length,
                    timeStart: formatTime(cursor),
                    timeEnd: formatTime(cursor + 1), // –æ–∫–Ω–æ 1—á
                    estimatedWaveEnd: formatTime(waveEndTime),
                    fatBurnWindow: {
                        start: formatTime(waveEndTime),
                        end: formatTime(fatBurnWindowEnd)
                    },
                    macros: budgetForThisMeal, // –≤—Ä–µ–º–µ–Ω–Ω–æ, –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –Ω–∞ —à–∞–≥–µ 6
                    isActionable: plannedMeals.length === 0, // –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ
                    isLast: true,
                    scenario: 'PRE_SLEEP',
                    hoursToSleep: sleepTarget - cursor
                });
                console.info(`${LOG_PREFIX} [PLANNER.loop.${iteration}] ‚úÖ Added LAST meal (no more time)`);
                break;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏—ë–º
            plannedMeals.push({
                index: plannedMeals.length,
                timeStart: formatTime(cursor),
                timeEnd: formatTime(cursor + 1),
                estimatedWaveEnd: formatTime(waveEndTime),
                fatBurnWindow: {
                    start: formatTime(waveEndTime),
                    end: formatTime(fatBurnWindowEnd)
                },
                macros: budgetForThisMeal, // –≤—Ä–µ–º–µ–Ω–Ω–æ, –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –Ω–∞ —à–∞–≥–µ 6
                isActionable: plannedMeals.length === 0,
                isLast: false,
                scenario: 'BALANCED',
                hoursToSleep: sleepTarget - cursor
            });
            console.info(`${LOG_PREFIX} [PLANNER.loop.${iteration}] ‚úÖ Added meal, moving cursor forward`);

            // –î–≤–∏–≥–∞–µ–º –∫—É—Ä—Å–æ—Ä ‚Äî S8: use same tight gap as fitsAnotherMeal check
            cursor = forceMultiMeal ? nextPossibleStart : fatBurnWindowEnd;
        }

        // === –®–∞–≥ 6: –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—é–¥–∂–µ—Ç –º–µ–∂–¥—É –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏—ë–º–∞–º–∏ ===
        // v1.5.0: S1 chrono-nutrition + S2 MPS + S3 GL + S4 POST_WORKOUT
        const hoursToSleepPerMeal = plannedMeals.map(m => m.hoursToSleep);
        const mealTimesHours = plannedMeals.map(m => parseTime(m.timeStart));
        const finalBudgets = distributeBudget(remainingBudget, plannedMeals.length, hoursToSleepPerMeal, mealTimesHours);

        for (let i = 0; i < plannedMeals.length; i++) {
            plannedMeals[i].macros = finalBudgets[i];
            // S3: Glycemic Load target (Ludwig, 2002)
            plannedMeals[i].targetGL = plannedMeals[i].hoursToSleep < PRE_SLEEP_BUFFER_HOURS
                ? GL_TARGET_PRE_SLEEP
                : GL_TARGET_DAY;
            // S5: sleep-friendly categories hint
            plannedMeals[i].sleepFriendlyCategories = plannedMeals[i].hoursToSleep < PRE_SLEEP_BUFFER_HOURS
                ? SLEEP_FRIENDLY_CATEGORIES
                : null;
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π
            plannedMeals[i].scenario = detectMealScenario(
                i,
                plannedMeals.length,
                finalBudgets[i],
                plannedMeals[i].hoursToSleep
            );
        }

        // S2: Protein-per-Meal MPS Optimization (Areta et al., 2013)
        const optimalProtPerMeal = Math.min(MPS_PROT_MAX_G, Math.round((profile.weight || 70) * MPS_PROT_PER_KG));
        let mpsBoostCount = 0;
        for (const meal of plannedMeals) {
            if (meal.macros.prot < optimalProtPerMeal && meal.macros.kcal > 200) {
                const protDelta = Math.min(optimalProtPerMeal - meal.macros.prot, 15); // cap delta
                meal.macros.prot += protDelta;
                meal.macros.carbs = Math.max(10, meal.macros.carbs - protDelta);
                mpsBoostCount++;
            }
        }
        if (mpsBoostCount > 0) {
            console.info(`${LOG_PREFIX} [mps] üí™ MPS protein boost (${optimalProtPerMeal}–≥/–ø—Ä–∏—ë–º) applied to ${mpsBoostCount} meals`);
        }

        // S4: POST_WORKOUT ‚Äî override first meal if anabolic window active (Ivy, 2004)
        if (recentWorkout && plannedMeals.length > 0) {
            const postProt = Math.min(Math.round((profile.weight || 70) * 0.35), Math.round(remainingBudget.prot * 0.85));
            const postCarbs = Math.min(Math.round((profile.weight || 70) * 1.0), Math.round(remainingBudget.carbs * 0.85));
            plannedMeals[0].macros.prot = postProt;
            plannedMeals[0].macros.carbs = postCarbs;
            plannedMeals[0].scenario = 'POST_WORKOUT';
            console.info(`${LOG_PREFIX} [workout] üèãÔ∏è POST_WORKOUT macros applied to meal 1:`, {
                prot: postProt, carbs: postCarbs, hoursAgo: (currentTimeHours - parseTime(recentWorkout.endTime)).toFixed(1)
            });
        }

        console.info(`${LOG_PREFIX} [PLANNER.result] ‚úÖ Planned meals:`, {
            count: plannedMeals.length,
            timeline: plannedMeals.map(m => `${m.timeStart}-${m.timeEnd}`).join(' ‚Üí '),
            macrosPerMeal: plannedMeals.map((m, i) => `Meal ${i + 1}: –ë${Math.round(m.macros.prot)}–≥ –£${Math.round(m.macros.carbs)}–≥ –∫–∫–∞–ª${Math.round(m.macros.kcal)}`)
        });

        plannedMeals.forEach((meal, idx) => {
            console.info(`${LOG_PREFIX} [PLANNER.meal${idx + 1}] üçΩÔ∏è Meal ${meal.index + 1}:`, {
                time: `${meal.timeStart}-${meal.timeEnd}`,
                macros: meal.macros,
                waveEnd: meal.estimatedWaveEnd,
                fatBurnWindow: meal.fatBurnWindow,
                isActionable: meal.isActionable,
                scenario: meal.scenario,
                hoursToSleep: meal.hoursToSleep.toFixed(1)
            });
        });

        // === –®–∞–≥ 7: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ summary ===
        const summary = {
            totalMeals: plannedMeals.length,
            timelineStart: plannedMeals[0]?.timeStart,
            timelineEnd: plannedMeals[plannedMeals.length - 1]?.timeEnd,
            totalMacros: {
                prot: finalBudgets.reduce((sum, b) => sum + b.prot, 0),
                carbs: finalBudgets.reduce((sum, b) => sum + b.carbs, 0),
                kcal: finalBudgets.reduce((sum, b) => sum + b.kcal, 0)
            },
            sleepTarget: formatTime(sleepTarget),
            lastMealDeadline: formatTime(lastMealDeadline)
        };

        return {
            available: true,
            meals: plannedMeals,
            summary
        };
    }

    // === Export ===
    HEYS.InsightsPI.mealPlanner = {
        planRemainingMeals,
        estimateSleepTarget,
        estimateWaveDuration,
        distributeBudget,
        estimatePersonalWaveHours, // S6
        getChronoRatio,            // S1
        // Utilities
        parseTime,
        formatTime,
        minutesToHours
    };

    console.info(`${LOG_PREFIX} üì¶ Module loaded v2.2.0 (v2.2.0: wave.duration fix, S8: volume-scaled personal wave, S7: TEF-aware effectiveKcal, PRE_SLEEP threshold 5h, MAX_MEAL_KCAL=${MAX_MEAL_KCAL})`);
    console.info(`${LOG_PREFIX} ‚úÖ Sprint 3 science engine active:`, {
        'S1-Chrono-Nutrition': `Garaulet & G√≥mez-Abell√°n, 2014 ‚Äî MORNING=${CHRONO_RATIO_MORNING} LUNCH=${CHRONO_RATIO_LUNCH} SNACK=${CHRONO_RATIO_SNACK} EVENING=${CHRONO_RATIO_EVENING}`,
        'S2-MPS-Protein': `Areta et al., 2013 ‚Äî ${MPS_PROT_PER_KG}–≥/–∫–≥ –Ω–∞ –ø—Ä–∏—ë–º, ceiling ${MPS_PROT_MAX_G}–≥`,
        'S3-GlycemicLoad': `Ludwig, 2002 ‚Äî GL<${GL_TARGET_DAY} (–¥–µ–Ω—å), GL<${GL_TARGET_PRE_SLEEP} (pre-sleep)`,
        'S4-POST_WORKOUT': 'Ivy, 2004 ‚Äî –∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ 2—á: 0.35–≥/–∫–≥ –±–µ–ª–æ–∫ + 1.0–≥/–∫–≥ —É–≥–ª–µ–≤–æ–¥—ã',
        'S5-PRE_SLEEP': `Halson, 2014 ‚Äî sleep-friendly foods: ${SLEEP_FRIENDLY_CATEGORIES.join(', ')}; –ø–æ—Ä–æ–≥ ${PRE_SLEEP_BUFFER_HOURS}—á`,
        'S6-AdaptiveWave': `–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –º–µ–¥–∏–∞–Ω–∞ gap –∏–∑ ${PERSONAL_WAVE_DAYS_LOOKBACK}–¥ –∏—Å—Ç–æ—Ä–∏–∏, min ${PERSONAL_WAVE_MIN_SAMPLES} –∑–∞–º–µ—Ä–æ–≤`,
        'S7-HungerTradeoff': 'Kinsey & Ormsbee, 2015 ‚Äî deficit‚â•800‚Üí1.5h buffer; ‚â•400‚Üí2h; pre-sleep protein improves MPS',
        'S8-PersonalSleep': 'sleepStart check-in data ‚Üí real bedtime (supports 1-2 AM owls, clamp [22:00, 02:00])'
    });

})(window);


/* ===== insights/pi_meal_recommender.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Next Meal Recommender v3.7.0
 * 
 * Context-aware meal guidance with 9 scenarios + 12 Pattern Integration (Phase A/B/C).
 * 
 * Scenarios:
 * - GOAL_REACHED: day target met (<50 kcal remaining)
 * - LIGHT_SNACK: low budget (50-150 kcal) or late hour
 * - LATE_EVENING: after adaptive late_eating_hour threshold
 * - PRE_SLEEP: last meal 4-5h before sleep (from planner) ‚Äî v3.3.1
 * - PRE_WORKOUT: training in 1-2h
 * - POST_WORKOUT: training was 0-2h ago
 * - PROTEIN_DEFICIT: protein <50% target (only when meals already eaten)
 * - STRESS_EATING: stress >3 OR mood <3
 * - BALANCED: default scenario
 *
 * v3.7.0 (20.02.2026):
 * - FIX: "First meal of day" ‚Äî when eatenKcal < 100, PROTEIN_DEFICIT no longer fires
 *   (every nutrient is at 0% when no meals eaten ‚Äî this is NOT a protein deficit)
 *   Falls through to BALANCED: proper kcal split (remainingKcal / mealsRemaining)
 * - FIX: Planner now called even without lastMeal.time ‚Äî enables multi-meal day planning
 *   when opening app with 0 meals eaten (was: single 300 kcal "–î–æ–±–∏—Ä–∞–µ–º –±–µ–ª–æ–∫")
 * - LOG: [MEALREC] noMealsEatenToday flag in scenario evaluation
 *
 * v3.6.0 (19.02.2026):
 * - FIX: calculateOptimalTiming() now respects active insulin wave (v4.0.6)
 *   Before: timing was purely gap-based (lastMeal + 4h gap), completely ignoring wave
 *   After: idealStart = max(gap-based, waveEnd + 30min fat burn)
 *   ‚Äî uses HEYS.InsulinWave.calculate() with last meal nutrients
 * - FIX: After planner runs, timing sync ‚Äî if planner first meal is later than recommender
 *   timing, update timingRec with planner's computed start so card shows correct time
 *   (was: card showed 22:44-23:00 naive gap time; now: card shows planner's 23:35-24:35)
 * - LOG: [MEALREC / timing] üåä Insulin wave constraint: logs waveEnd, remaining, fatBurnEnd
 * - LOG: [MEALREC.planner] üîÑ Timing sync: logs before/after when sync applied
 *
 * v3.3.1 (20.02.2026):
 * - NEW: PRE_SLEEP scenario added to SCENARIOS constant + SCENARIO_ICONS
 * - NEW: idealGI=25 for PRE_SLEEP (was defaulting to 50)
 *        (Halson 2014: low-GI pre-sleep ‚Üí sustains deep sleep architecture)
 * - CONNECTS: pi_meal_planner.js v1.9.1 (PRE_SLEEP threshold 5h)
 *           + pi_product_picker.js v3.3.0 (PRE_SLEEP category override)
 *
 * v3.3.0 (18.02.2026):
 * - NEW: Per-meal product generation for multi-meal plans
 * - ISSUE: When planner returns 2+ meals, products were generated only for meal[0]
 *   using wrong (scenario-overridden) macros, so 2nd meal had no products
 * - SOLUTION: For mealsPlan.meals.length > 1, loop through all meals and call
 *   generateSmartMealSuggestions for each with that meal's actual macros budget
 * - IMPACT: Each planned meal now has correct products matching its real kcal/BJU
 * 
 * v3.2.0 CRITICAL FIX (17.02.2026):
 * - NEW: "Last meal override" ‚Äî if mealsRemaining === 1 && remainingKcal > 300, use 90% of remainder
 * - ISSUE: LATE_EVENING caps at 200 kcal even when it's the LAST meal with 764 kcal remaining
 * - SOLUTION: Detect last meal context, override scenario cap with actual budget (90% to leave buffer)
 * - EXAMPLE: LATE_EVENING 21:49, 764 kcal left, 1 meal remaining ‚Üí 688 kcal (not 200)
 * - IMPACT: All scenarios with caps (LATE_EVENING, LIGHT_SNACK, etc.) now adapt to last meal reality
 * 
 * v3.1.1 Bugfix (17.02.2026):
 * - FIXED: Product Picker now receives target meal kcal instead of day remaining kcal
 * - ISSUE: LATE_EVENING recommended 200 kcal but generated products for 764 kcal (full day remainder)
 * - SOLUTION: Pass macrosRec.kcal (meal target) instead of macrosRec.remainingKcal (day remainder)
 * - IMPACT: Product selection now matches recommended meal size for all scenarios with kcal limits
 * 
 * v3.0 Features (R2.7 Full Pattern Integration):
 * - Phase A (Core): 6 patterns (C01, C02, C15, C34, C35, C37)
 *   ‚Üí Timing shifts, macro tuning, GI moderation, sugar filtering
 * - Phase B (Context): 4 patterns (C06, C14, C10, C12)
 *   ‚Üí Sleep recovery, nutrient timing, fiber boost, mood-food
 * - Phase C (Micronutrients): 2 patterns (C26, C29)
 *   ‚Üí Mineral boosts (Fe/Mg/Zn/Ca), NOVA quality filtering
 * - 11-factor Product Picker scoring system
 * - Pattern impact tracking + observability logging
 * 
 * Dependencies: pi_thresholds.js, pi_phenotype.js, pi_meal_rec_patterns.js, pi_patterns.js, pi_product_picker.js
 * @param global
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};
    const LOG_FILTER = 'MEALREC';
    const LOG_PREFIX = `[${LOG_FILTER}][MealRec]`;

    // Scenario constants (priority order)
    const SCENARIOS = {
        GOAL_REACHED: 'GOAL_REACHED',
        LIGHT_SNACK: 'LIGHT_SNACK',
        LATE_EVENING: 'LATE_EVENING',
        PRE_SLEEP: 'PRE_SLEEP',      // v3.3: from planner when hoursToSleep < 5h
        PRE_WORKOUT: 'PRE_WORKOUT',
        POST_WORKOUT: 'POST_WORKOUT',
        PROTEIN_DEFICIT: 'PROTEIN_DEFICIT',
        STRESS_EATING: 'STRESS_EATING',
        BALANCED: 'BALANCED'
    };

    // Scenario icons for UI
    const SCENARIO_ICONS = {
        [SCENARIOS.GOAL_REACHED]: 'üéØ',
        [SCENARIOS.LIGHT_SNACK]: '‚òï',
        [SCENARIOS.LATE_EVENING]: 'üåô',
        [SCENARIOS.PRE_SLEEP]: 'üí§',   // v3.3
        [SCENARIOS.PRE_WORKOUT]: '‚ö°',
        [SCENARIOS.POST_WORKOUT]: 'üí™',
        [SCENARIOS.PROTEIN_DEFICIT]: 'ü•©',
        [SCENARIOS.STRESS_EATING]: 'üßò',
        [SCENARIOS.BALANCED]: 'üçΩÔ∏è'
    };

    /**
     * Analyze current context to determine meal scenario
     * @param {object} context - Current day context
     * @param {object} dayTarget - Day nutrient targets
     * @param {object} dayEaten - Already consumed nutrients
     * @param {object} profile - User profile
     * @param {number} currentTime - Current time (decimal hours)
     * @param {object} thresholds - Adaptive thresholds (optional)
     * @returns {object} - Scenario + metadata
     * @private
     */
    function analyzeCurrentContext(context, dayTarget, dayEaten, profile, currentTime, thresholds) {
        const targetKcal = dayTarget.kcal || profile.optimum || 2000;
        const targetProtein = dayTarget.protein || profile.norm?.prot || 120;
        const eatenKcal = dayEaten.kcal || 0;
        const eatenProtein = dayEaten.protein || 0;

        const remainingKcal = Math.max(0, targetKcal - eatenKcal);
        const remainingProtein = Math.max(0, targetProtein - eatenProtein);
        const proteinProgress = eatenProtein / targetProtein;

        // Adaptive thresholds (fallback to defaults)
        const lateEatingHour = thresholds?.lateEatingHour || 21;
        const currentHour = Math.floor(currentTime);

        // Training context
        const training = context.training;
        let hoursToTraining = null;
        if (training && training.time) {
            const trainingTime = parseTime(training.time);
            hoursToTraining = trainingTime - currentTime;
        }

        // Mood/stress context (try context first, then lastMeal)
        const lastMeal = context.lastMeal || {};
        const mood = context.mood || lastMeal.mood || 3; // 1-5 scale
        const stress = context.stress || lastMeal.stress || 3; // 1-5 scale

        console.info(`${LOG_PREFIX} üéØ Context analysis:`, {
            remainingKcal,
            proteinProgress: Math.round(proteinProgress * 100) + '%',
            currentHour,
            lateEatingHour,
            hoursToTraining,
            mood,
            stress
        });

        // Scenario decision tree (priority order)
        // Collect all scenario evaluations for debugging
        const scenarioCandidates = [];

        // 1. GOAL_REACHED (highest priority)
        const goalReachedApplicable = remainingKcal < 50;
        scenarioCandidates.push({
            priority: 1,
            scenario: SCENARIOS.GOAL_REACHED,
            applicable: goalReachedApplicable,
            reason: goalReachedApplicable ? '–î–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' : `–û—Å—Ç–∞—Ç–æ–∫ ${remainingKcal} –∫–∫–∞–ª > 50`,
            metadata: { remainingKcal }
        });
        if (goalReachedApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true; // Mark as winner
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.GOAL_REACHED} (priority 1)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.GOAL_REACHED,
                reason: '–î–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞',
                icon: SCENARIO_ICONS[SCENARIOS.GOAL_REACHED],
                metadata: { remainingKcal }
            };
        }

        // 2. LIGHT_SNACK
        const lightSnackApplicable = remainingKcal >= 50 && remainingKcal < 150;
        scenarioCandidates.push({
            priority: 2,
            scenario: SCENARIOS.LIGHT_SNACK,
            applicable: lightSnackApplicable,
            reason: lightSnackApplicable ? '–ú–∞–ª–æ –∫–∞–ª–æ—Ä–∏–π –¥–æ —Ü–µ–ª–∏' : `–û—Å—Ç–∞—Ç–æ–∫ ${remainingKcal} –∫–∫–∞–ª –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 50-150`,
            metadata: { remainingKcal }
        });
        if (lightSnackApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true;
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.LIGHT_SNACK} (priority 2)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.LIGHT_SNACK,
                reason: '–ú–∞–ª–æ –∫–∞–ª–æ—Ä–∏–π –¥–æ —Ü–µ–ª–∏',
                icon: SCENARIO_ICONS[SCENARIOS.LIGHT_SNACK],
                metadata: { remainingKcal }
            };
        }

        // 3. PRE_WORKOUT (within 1-2h)
        const preWorkoutApplicable = hoursToTraining !== null && hoursToTraining > 0 && hoursToTraining <= 2;
        scenarioCandidates.push({
            priority: 3,
            scenario: SCENARIOS.PRE_WORKOUT,
            applicable: preWorkoutApplicable,
            reason: preWorkoutApplicable ? `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${Math.round(hoursToTraining * 60)} –º–∏–Ω` : (hoursToTraining === null ? '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å–µ–≥–æ–¥–Ω—è' : `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${Math.round(hoursToTraining * 60)} –º–∏–Ω (–Ω–µ –≤ –æ–∫–Ω–µ 1-2h)`),
            metadata: { hoursToTraining, trainingTime: training?.time }
        });
        if (preWorkoutApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true;
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.PRE_WORKOUT} (priority 3)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.PRE_WORKOUT,
                reason: `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${Math.round(hoursToTraining * 60)} –º–∏–Ω`,
                icon: SCENARIO_ICONS[SCENARIOS.PRE_WORKOUT],
                metadata: { hoursToTraining, trainingTime: training.time }
            };
        }

        // 4. POST_WORKOUT (within 0-2h after)
        const postWorkoutApplicable = hoursToTraining !== null && hoursToTraining < 0 && hoursToTraining > -2;
        scenarioCandidates.push({
            priority: 4,
            scenario: SCENARIOS.POST_WORKOUT,
            applicable: postWorkoutApplicable,
            reason: postWorkoutApplicable ? '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ' : (hoursToTraining === null ? '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å–µ–≥–æ–¥–Ω—è' : `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ${hoursToTraining < 0 ? '–±—ã–ª–∞ –¥–∞–≤–Ω–æ' : '–µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å'}`),
            metadata: { hoursToTraining, hoursSinceTraining: hoursToTraining ? Math.abs(hoursToTraining) : null }
        });
        if (postWorkoutApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true;
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.POST_WORKOUT} (priority 4)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.POST_WORKOUT,
                reason: '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
                icon: SCENARIO_ICONS[SCENARIOS.POST_WORKOUT],
                metadata: { hoursSinceTraining: Math.abs(hoursToTraining) }
            };
        }

        // 5. LATE_EVENING (checked before PROTEIN_DEFICIT by design)
        // Priority: Sleep quality > Protein goal completion
        // Rationale: After lateEatingHour, even with protein deficit,
        // recommend light meal to avoid heavy digestion before sleep
        const lateEveningApplicable = currentHour >= lateEatingHour && remainingKcal > 150;
        scenarioCandidates.push({
            priority: 5,
            scenario: SCENARIOS.LATE_EVENING,
            applicable: lateEveningApplicable,
            reason: lateEveningApplicable ? '–ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä ‚Äî –ª—ë–≥–∫–∏–π –ø—Ä–∏—ë–º' : (currentHour < lateEatingHour ? `–ï—â–µ —Ä–∞–Ω–æ (${currentHour}:00 < ${lateEatingHour}:00)` : `–û—Å—Ç–∞—Ç–æ–∫ ${remainingKcal} –∫–∫–∞–ª <= 150`),
            metadata: { currentHour, lateEatingHour, remainingKcal }
        });
        if (lateEveningApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true;
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.LATE_EVENING} (priority 5)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.LATE_EVENING,
                reason: '–ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä ‚Äî –ª—ë–≥–∫–∏–π –ø—Ä–∏—ë–º',
                icon: SCENARIO_ICONS[SCENARIOS.LATE_EVENING],
                metadata: { currentHour, lateEatingHour, remainingKcal }
            };
        }

        // 6. STRESS_EATING (higher priority than PROTEIN_DEFICIT)
        const stressEatingApplicable = stress >= 4 || mood <= 2;
        scenarioCandidates.push({
            priority: 6,
            scenario: SCENARIOS.STRESS_EATING,
            applicable: stressEatingApplicable,
            reason: stressEatingApplicable ? (stress >= 4 ? '–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å' : '–ù–∏–∑–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ') : `–°—Ç—Ä–µ—Å—Å ${stress}/5, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ${mood}/5 –≤ –Ω–æ—Ä–º–µ`,
            metadata: { stress, mood }
        });
        if (stressEatingApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true;
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.STRESS_EATING} (priority 6)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.STRESS_EATING,
                reason: stress >= 4 ? '–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å' : '–ù–∏–∑–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
                icon: SCENARIO_ICONS[SCENARIOS.STRESS_EATING],
                metadata: { stress, mood }
            };
        }

        // 7. PROTEIN_DEFICIT (< 50% of daily target)
        // v3.7.0: When no meals eaten today (eatenKcal < 100), this is NOT a "protein deficit" ‚Äî
        // every nutrient is at 0%. Use BALANCED instead for proper meal sizing.
        const noMealsEatenToday = eatenKcal < 100;
        const proteinDeficitApplicable = proteinProgress < 0.5 && remainingProtein > 10 && !noMealsEatenToday;
        scenarioCandidates.push({
            priority: 7,
            scenario: SCENARIOS.PROTEIN_DEFICIT,
            applicable: proteinDeficitApplicable,
            reason: proteinDeficitApplicable ? `–ë–µ–ª–æ–∫ ${Math.round(proteinProgress * 100)}% –æ—Ç —Ü–µ–ª–∏` : (noMealsEatenToday ? `–ù–µ—Ç –ø—Ä–∏—ë–º–æ–≤ —Å–µ–≥–æ–¥–Ω—è (${Math.round(eatenKcal)} kcal) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º BALANCED` : (proteinProgress >= 0.5 ? `–ë–µ–ª–æ–∫ ${Math.round(proteinProgress * 100)}% >= 50%` : `–û—Å—Ç–∞—Ç–æ–∫ –±–µ–ª–∫–∞ ${remainingProtein}–≥ <= 10–≥`)),
            metadata: { proteinProgress, remainingProtein, noMealsEatenToday }
        });
        if (proteinDeficitApplicable) {
            scenarioCandidates[scenarioCandidates.length - 1].winner = true;
            console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.PROTEIN_DEFICIT} (priority 7)`);
            console.table(scenarioCandidates);
            console.groupEnd();
            return {
                scenario: SCENARIOS.PROTEIN_DEFICIT,
                reason: `–ë–µ–ª–æ–∫ ${Math.round(proteinProgress * 100)}% –æ—Ç —Ü–µ–ª–∏`,
                icon: SCENARIO_ICONS[SCENARIOS.PROTEIN_DEFICIT],
                metadata: { proteinProgress, remainingProtein }
            };
        }

        // 8. BALANCED (default)
        scenarioCandidates.push({
            priority: 8,
            scenario: SCENARIOS.BALANCED,
            applicable: true,
            reason: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (fallback)',
            metadata: { remainingKcal },
            winner: true // Always wins if we get here
        });
        console.group(`${LOG_PREFIX} üèÜ Scenario evaluation (ALL 8): Winner: ${SCENARIOS.BALANCED} (priority 8 - fallback)`);
        console.table(scenarioCandidates);
        console.groupEnd();
        return {
            scenario: SCENARIOS.BALANCED,
            reason: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏',
            icon: SCENARIO_ICONS[SCENARIOS.BALANCED],
            metadata: { remainingKcal }
        };
    }

    /**
     * Recommend next meal timing and macros
     * @param {object} context - Current day context
     * @param {object} profile - User profile
     * @param {object} pIndex - Product index
     * @param {object[]} days - Historical days (for ML in future)
     * @returns {object} - Recommendation result
     */
    function recommendNextMeal(context, profile, pIndex, days = []) {
        console.info(`${LOG_PREFIX} üçΩÔ∏è recommendNextMeal v3.6.0 called:`, {
            contextTime: context?.currentTime,
            lastMealTime: context?.lastMeal?.time,
            hasTraining: !!context?.training,
            profileId: profile?.id || profile?.clientId || global.HEYS?.currentClientId || 'n/a',
            daysCount: days?.length || 0,
            hasPatternsModule: !!HEYS.InsightsPI?.mealRecPatterns
        });

        if (!context || !profile) {
            console.warn(`${LOG_PREFIX} ‚ùå Missing context or profile`);
            return { available: false, error: 'Missing context or profile' };
        }

        // S9 (v3.5.0): Auto-detect phenotype if missing and sufficient data
        // Phenotype enriches Phase A macro modifiers with metabolic/circadian/satiety adjustments
        if (!profile.phenotype && days.length >= 30 && HEYS.InsightsPI?.phenotype?.autoDetect) {
            try {
                const detected = HEYS.InsightsPI.phenotype.autoDetect(days, profile, pIndex);
                if (detected) {
                    profile.phenotype = detected;
                    console.info(`${LOG_PREFIX} üß¨ S9: Auto-detected phenotype:`, {
                        metabolic: detected.metabolic,
                        circadian: detected.circadian,
                        satiety: detected.satiety,
                        stress: detected.stress,
                        confidence: detected.confidence
                    });
                }
            } catch (e) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è S9: Phenotype auto-detect failed:`, e.message);
            }
        }

        // Extract context
        const currentTime = parseTime(context.currentTime || getCurrentTime());
        const lastMeal = context.lastMeal || {};
        const dayTarget = context.dayTarget || profile.norm || {};
        const dayEaten = context.dayEaten || {};
        const training = context.training;
        const sleepTarget = parseTime(context.sleepTarget || '23:00');

        // Load adaptive thresholds (v2.4 feature)
        let thresholds = null;
        if (HEYS.InsightsPI?.thresholds?.getAdaptiveThresholds && days.length > 0) {
            try {
                thresholds = HEYS.InsightsPI.thresholds.getAdaptiveThresholds(days, profile, pIndex);
                console.info(`${LOG_PREFIX} üìä Adaptive thresholds loaded:`, {
                    lateEatingHour: thresholds.lateEatingHour,
                    mealGapHours: thresholds.idealMealGapMin / 60,
                    source: thresholds.source
                });
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Failed to load thresholds, using defaults:`, err.message);
            }
        }

        // Phase A/B (v3.1): Load pattern hints for timing/macros/picker modifiers
        const patternHints = loadPatternHints(days, profile, pIndex);

        // Analyze context ‚Üí determine scenario (v2.4 feature)
        const contextAnalysis = analyzeCurrentContext(context, dayTarget, dayEaten, profile, currentTime, thresholds);
        console.info(`${LOG_PREFIX} üéØ Scenario detected:`, {
            scenario: contextAnalysis.scenario,
            reason: contextAnalysis.reason,
            metadata: contextAnalysis.metadata
        });

        // Track applied pattern impacts for MEALREC observability
        const patternImpact = [];

        // Calculate timing recommendation
        const timingRec = calculateOptimalTiming(currentTime, lastMeal, training, sleepTarget, thresholds, patternHints, patternImpact);

        // Calculate macros recommendation (scenario-aware v2.4)
        const macrosRec = calculateOptimalMacros(contextAnalysis, dayTarget, dayEaten, training, profile, timingRec, patternHints, patternImpact);

        // Generate meal suggestions (Smart Product Picker v2.5)
        const suggestionsResult = generateSmartMealSuggestions(contextAnalysis, macrosRec, context, profile, pIndex, patternHints, patternImpact);

        // v3.1: Handle both grouped and flat modes
        let suggestions, mode, groups;
        if (suggestionsResult && typeof suggestionsResult === 'object' && suggestionsResult.mode) {
            // v3.1: Structured response from Product Picker
            mode = suggestionsResult.mode;
            if (mode === 'grouped') {
                groups = suggestionsResult.groups;
                suggestions = undefined; // No flat array in grouped mode
            } else {
                suggestions = suggestionsResult.suggestions || [];
                groups = undefined;
            }
        } else {
            // Legacy: direct array
            mode = 'flat';
            suggestions = Array.isArray(suggestionsResult) ? suggestionsResult : [];
            groups = undefined;
        }

        console.info(`${LOG_PREFIX} [MEALREC.suggestions] üì¶ Suggestions mode:`, {
            mode,
            hasSuggestions: !!suggestions,
            suggestionsCount: suggestions?.length || 0,
            hasGroups: !!groups,
            groupsCount: groups?.length || 0,
        });

        // Generate reasoning (scenario-aware v2.4)
        const reasoning = generateReasoning(contextAnalysis, timingRec, macrosRec, dayTarget, dayEaten, training);

        // üÜï v3.1: Multi-Meal Planning (Phase 1)
        // –í—ã–∑—ã–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–∏—ë–º–æ–≤ –¥–æ —Å–Ω–∞
        let mealsPlan = null;

        console.info(`${LOG_PREFIX} [MEALREC.planner] üîç Checking multi-meal conditions:`, {
            hasPlanner: !!HEYS.InsightsPI?.mealPlanner?.planRemainingMeals,
            hasLastMealTime: !!lastMeal?.time,
            daysCount: days.length,
            dayTarget: dayTarget,
            dayEaten: dayEaten,
            remainingKcal: (dayTarget?.kcal || 0) - (dayEaten?.kcal || 0)
        });

        // v3.7.0: Allow planner without lastMeal ‚Äî "first meal of day" scenario
        // When no meals eaten today, planner can still plan 3-4 meals from now to sleep
        const hasEnoughHistory = days.length >= 3;
        const hasPlanner = !!HEYS.InsightsPI?.mealPlanner?.planRemainingMeals;
        const hasLastMealTime = !!lastMeal?.time;

        if (hasPlanner && hasEnoughHistory) {
            console.info(`${LOG_PREFIX} [MEALREC.planner] ‚úÖ Calling planRemainingMeals...`, {
                mode: hasLastMealTime ? 'wave-aware' : 'first-meal-of-day'
            });
            try {
                mealsPlan = HEYS.InsightsPI.mealPlanner.planRemainingMeals({
                    currentTime: context.currentTime || getCurrentTime(),
                    lastMeal: lastMeal,
                    dayTarget: dayTarget,
                    dayEaten: dayEaten,
                    profile: profile,
                    days: days,
                    pIndex: pIndex
                });

                if (mealsPlan?.available && mealsPlan.meals?.length > 0) {
                    console.info(`${LOG_PREFIX} [MEALREC.planner] üçΩÔ∏è Multi-meal plan generated:`, {
                        totalMeals: mealsPlan.meals.length,
                        timeline: mealsPlan.meals.map(m => m.timeStart).join(' ‚Üí '),
                        totalKcal: Math.round(mealsPlan.summary?.totalMacros?.kcal || 0),
                        firstMealMacros: mealsPlan.meals[0]?.macros
                    });

                    if (mealsPlan.meals.length > 1) {
                        // üÜï v3.3: Multi-meal mode ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –ö–ê–ñ–î–û–ì–û –ø—Ä–∏—ë–º–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
                        // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—á–µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –∫–∫–∞–ª/–ë–ñ–£ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
                        console.info(`${LOG_PREFIX} [MEALREC.planner] üîÑ Generating per-meal products for ${mealsPlan.meals.length} meals...`);

                        // P3 fix: accumulate used product IDs to prevent identical products across meals
                        const crossMealExcludeIds = new Set();

                        for (let mealIdx = 0; mealIdx < mealsPlan.meals.length; mealIdx++) {
                            const plannedMeal = mealsPlan.meals[mealIdx];
                            // –°—Ç—Ä–æ–∏–º macrosRec –∏–∑ –±—é–¥–∂–µ—Ç–∞ —ç—Ç–æ–≥–æ –ø—Ä–∏—ë–º–∞ (prot‚Üíprotein, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
                            const mealMacrosRec = {
                                ...macrosRec,
                                protein: plannedMeal.macros.prot,
                                carbs: plannedMeal.macros.carbs,
                                fat: plannedMeal.macros.fat,
                                kcal: plannedMeal.macros.kcal,
                                remainingKcal: plannedMeal.macros.kcal,
                                remainingMeals: mealsPlan.meals.length - mealIdx,
                                // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º isLastMeal ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ª–µ–≥—á–µ
                                isLastMeal: mealIdx === mealsPlan.meals.length - 1,
                                // v3.4: F2 ‚Äî GL target from planner (20=day, 10=PRE_SLEEP, Ludwig 2002)
                                targetGL: plannedMeal.targetGL ?? null,
                            };
                            // contextAnalysis –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∏—ë–º–∞ ‚Äî –±–µ—Ä—ë–º —Å—Ü–µ–Ω–∞—Ä–∏–π –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
                            const mealContextAnalysis = {
                                ...contextAnalysis,
                                scenario: plannedMeal.scenario || contextAnalysis.scenario
                            };

                            try {
                                const mealProducts = generateSmartMealSuggestions(
                                    mealContextAnalysis,
                                    mealMacrosRec,
                                    context,
                                    profile,
                                    pIndex,
                                    patternHints || [],
                                    undefined, // patternImpact
                                    crossMealExcludeIds // P3: pass exclusion set
                                );

                                if (mealProducts?.mode === 'grouped' && mealProducts.groups) {
                                    plannedMeal.groups = mealProducts.groups;
                                    plannedMeal.productMode = 'grouped';
                                    // P3: collect product IDs to exclude from next meal
                                    mealProducts.groups.forEach(g =>
                                        g.products.forEach(p => { if (p.productId) crossMealExcludeIds.add(p.productId); })
                                    );
                                    console.info(`${LOG_PREFIX} [MEALREC.planner] üìã Meal ${mealIdx + 1}: assigned ${mealProducts.groups.length} groups (${Math.round(mealMacrosRec.kcal)} kcal, scenario=${plannedMeal.scenario}, targetGL=${plannedMeal.targetGL ?? 'n/a'}), excluded=${crossMealExcludeIds.size}`);
                                } else if (mealProducts?.mode === 'flat' && mealProducts.suggestions?.length > 0) {
                                    // flat mode object { mode, suggestions }
                                    plannedMeal.suggestions = mealProducts.suggestions;
                                    plannedMeal.productMode = 'flat';
                                    mealProducts.suggestions.forEach(s => { if (s.productId) crossMealExcludeIds.add(s.productId); });
                                    console.info(`${LOG_PREFIX} [MEALREC.planner] üìã Meal ${mealIdx + 1}: assigned ${mealProducts.suggestions.length} flat suggestions (${Math.round(mealMacrosRec.kcal)} kcal), excluded=${crossMealExcludeIds.size}`);
                                } else if (mealProducts?.suggestions) {
                                    plannedMeal.suggestions = mealProducts.suggestions;
                                    plannedMeal.productMode = 'flat';
                                    // P3: collect product IDs from flat suggestions
                                    mealProducts.suggestions.forEach(s => { if (s.productId) crossMealExcludeIds.add(s.productId); });
                                    console.info(`${LOG_PREFIX} [MEALREC.planner] üìã Meal ${mealIdx + 1}: assigned ${mealProducts.suggestions.length} suggestions (${Math.round(mealMacrosRec.kcal)} kcal), excluded=${crossMealExcludeIds.size}`);
                                } else if (Array.isArray(mealProducts) && mealProducts.length > 0) {
                                    // legacy plain array return
                                    plannedMeal.suggestions = mealProducts;
                                    plannedMeal.productMode = 'flat';
                                    mealProducts.forEach(s => { if (s.productId) crossMealExcludeIds.add(s.productId); });
                                    console.info(`${LOG_PREFIX} [MEALREC.planner] üìã Meal ${mealIdx + 1}: assigned ${mealProducts.length} legacy suggestions (${Math.round(mealMacrosRec.kcal)} kcal), excluded=${crossMealExcludeIds.size}`);
                                } else {
                                    console.warn(`${LOG_PREFIX} [MEALREC.planner] ‚ö†Ô∏è Meal ${mealIdx + 1}: no products generated`);
                                }
                            } catch (mealErr) {
                                console.warn(`${LOG_PREFIX} [MEALREC.planner] ‚ö†Ô∏è Meal ${mealIdx + 1}: product generation failed:`, mealErr.message);
                            }
                        }

                        console.info(`${LOG_PREFIX} [MEALREC.planner] ‚úÖ Per-meal products generated:`, {
                            meals: mealsPlan.meals.map((m, i) => ({
                                meal: i + 1,
                                kcal: Math.round(m.macros.kcal),
                                scenario: m.scenario,
                                hasGroups: !!m.groups,
                                hasSuggestions: !!m.suggestions
                            }))
                        });

                    } else if (mealsPlan.meals[0]) {
                        // Single meal from planner ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
                        if (mode === 'grouped' && groups) {
                            mealsPlan.meals[0].groups = groups;
                            console.info(`${LOG_PREFIX} [MEALREC.planner] üìã Assigned ${groups.length} groups to single planned meal`);
                        } else if (suggestions) {
                            mealsPlan.meals[0].suggestions = suggestions;
                            console.info(`${LOG_PREFIX} [MEALREC.planner] üìã Assigned ${suggestions.length} suggestions to single planned meal`);
                        }
                    }
                } else {
                    console.info(`${LOG_PREFIX} [MEALREC.planner] ‚ÑπÔ∏è Planner returned no meals:`, mealsPlan);
                }
            } catch (err) {
                console.warn(`${LOG_PREFIX} [MEALREC.planner] ‚ö†Ô∏è Failed to generate meal plan:`, err.message);
                mealsPlan = null;
            }
        } else {
            console.info(`${LOG_PREFIX} [MEALREC.planner] ‚ùå Conditions NOT met for multi-meal planning`);
        }

        // v4.0.6: Synchronize timing with planner's first meal if planner computed a later start
        // This ensures the card header shows wave-aware timing instead of naive gap-based timing
        if (mealsPlan?.available && mealsPlan.meals?.length > 0) {
            const firstPlannedMeal = mealsPlan.meals[0];
            if (firstPlannedMeal.timeStart) {
                const plannerStartHours = parseTime(firstPlannedMeal.timeStart);
                if (plannerStartHours > timingRec.idealStart) {
                    const plannerEndHours = firstPlannedMeal.timeEnd ? parseTime(firstPlannedMeal.timeEnd) : plannerStartHours + 1;
                    console.info(`${LOG_PREFIX} [MEALREC.planner] üîÑ Timing sync: planner start is later than recommender`, {
                        recommenderTiming: timingRec.ideal,
                        plannerStart: firstPlannedMeal.timeStart,
                        plannerEnd: firstPlannedMeal.timeEnd,
                        action: 'updating timingRec to planner timing'
                    });
                    timingRec.idealStart = plannerStartHours;
                    timingRec.idealEnd = plannerEndHours;
                    timingRec.ideal = `${formatTime(plannerStartHours)}-${formatTime(plannerEndHours)}`;
                    timingRec.reason = `–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –ø–æ—Å–ª–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã + –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ`;
                    timingRec.plannerSynced = true;
                }
            }
        }

        const result = {
            available: true,
            scenario: contextAnalysis.scenario,
            scenarioIcon: contextAnalysis.icon,
            scenarioReason: contextAnalysis.reason,
            timing: timingRec,
            macros: macrosRec,
            // v3.1: Support both grouped and flat modes
            mode,
            suggestions,
            groups,
            reasoning,
            confidence: 0.75, // Base confidence, will be enhanced below
            method: 'context_engine', // Context-aware pipeline
            version: '3.6', // v3.6.0: wave-aware timing + timing sync after planner
            // üÜï Multi-meal plan
            mealsPlan: mealsPlan?.available ? mealsPlan : null
        };

        // MEALREC / impact: show what pattern modifiers were actually applied in this recommendation
        if (patternImpact.length > 0) {
            console.group(`${LOG_PREFIX} [MEALREC / impact] ‚úÖ Pattern ‚Üí recommendation impact (${patternImpact.length})`);
            console.table(patternImpact);
            console.groupEnd();

            // Compact summary string for quick scanning (without expanding tables)
            const impactSummary = patternImpact.map(i => {
                if (i.area === 'timing') return `‚è∞ ${i.before} ‚Üí ${i.after}`;
                if (i.area === 'macros') return `üçΩÔ∏è ${i.before} ‚Üí ${i.after}`;
                if (i.area === 'productPicker') return `üõí ${i.before} ‚Üí ${i.after}`;
                return `${i.pattern}: ${i.before} ‚Üí ${i.after}`;
            }).join(' | ');
            console.info(`${LOG_PREFIX} [MEALREC / impact] üìã Summary: ${impactSummary}`);
        } else {
            console.info(`${LOG_PREFIX} [MEALREC / impact] ‚ö†Ô∏è No pattern modifiers applied (insufficient data or neutral scores)`);
        }

        // Attach pattern impact to result for downstream UI display
        result.insights = result.insights || {};
        result.insights.patternImpact = patternImpact;

        // R2.6: Deep Insights Integration (pattern scores + phenotype + dynamic confidence)
        let enhanced = result;
        if (HEYS.InsightsPI?.mealRecPatterns && days.length >= 7) {
            try {
                enhanced = HEYS.InsightsPI.mealRecPatterns.enhanceRecommendation(
                    contextAnalysis,
                    result,
                    days,
                    profile,
                    pIndex,
                    thresholds
                );
                console.info(`${LOG_PREFIX} ‚úÖ Enhanced with Deep Insights:`, {
                    confidenceBase: result.confidence,
                    confidenceEnhanced: enhanced.confidence,
                    patternsUsed: enhanced.insights?.patternScores ? Object.keys(enhanced.insights.patternScores).length : 0,
                    phenotypeApplied: enhanced.insights?.phenotypeApplied || false
                });

                // Preserve direct phase-A impact trace in insights
                enhanced.insights = {
                    ...(enhanced.insights || {}),
                    patternImpact,
                };
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Failed to enhance with patterns:`, err.message);
                // Fallback to base result
            }
        }

        if (!enhanced.insights) enhanced.insights = {};
        if (!enhanced.insights.patternImpact) enhanced.insights.patternImpact = patternImpact;

        // R2.7: ML Feedback Adjustment (user feedback learning)
        if (HEYS.InsightsPI?.mealRecFeedback) {
            try {
                const adjustmentFactor = HEYS.InsightsPI.mealRecFeedback.calculateAdjustmentFactor(
                    enhanced.scenario
                );
                if (adjustmentFactor !== 1.0) {
                    const confidenceBefore = enhanced.confidence;
                    enhanced.confidence = Math.max(0.3, Math.min(1.0, enhanced.confidence * adjustmentFactor));
                    console.info(`${LOG_PREFIX} ‚úÖ Applied ML Feedback adjustment:`, {
                        scenario: enhanced.scenario,
                        adjustmentFactor: adjustmentFactor.toFixed(2),
                        confidenceBefore: confidenceBefore.toFixed(2),
                        confidenceAfter: enhanced.confidence.toFixed(2)
                    });
                }
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Failed to apply feedback adjustment:`, err.message);
            }
        }

        console.info(`${LOG_PREFIX} ‚úÖ Recommendation generated:`, {
            scenario: enhanced.scenario,
            timingIdeal: enhanced.timing?.ideal,
            macrosKcal: enhanced.macros?.kcal,
            mode: enhanced.mode,
            suggestionsCount: enhanced.suggestions?.length || 0,
            groupsCount: enhanced.groups?.length || 0,
            confidence: enhanced.confidence
        });

        return enhanced;
    }

    /**
     * Load pattern hints (Phase A + B: 10 patterns total)
     * Phase A (Core): C01, C02, C15, C34, C35, C37
     * Phase B (Context): C06, C14, C10, C12
     * @private
     */
    function loadPatternHints(days, profile, pIndex) {
        if (!Array.isArray(days) || days.length < 7 || !HEYS.InsightsPI?.patterns) {
            return null;
        }

        const patterns = HEYS.InsightsPI.patterns;
        const hints = {};

        const normalize = (score) => {
            const s = Number(score);
            if (!Number.isFinite(s)) return 0.5;
            return s > 1 ? Math.max(0, Math.min(1, s / 100)) : Math.max(0, Math.min(1, s));
        };

        try {
            const mealTiming = patterns.analyzeMealTiming?.(days, profile, pIndex);
            if (mealTiming?.available) {
                hints.mealTiming = {
                    score: normalize(mealTiming.score),
                    avgGapMinutes: mealTiming.avgGapMinutes,
                    idealGapMinutes: mealTiming.idealGapMinutes,
                    overlapCount: mealTiming.overlapCount || 0,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase A hint failed: mealTiming`, err.message);
        }

        try {
            const waveOverlap = patterns.analyzeWaveOverlap?.(days, profile);
            if (waveOverlap?.available) {
                hints.waveOverlap = {
                    score: normalize(waveOverlap.score),
                    overlapCount: waveOverlap.overlapCount || 0,
                    avgOverlapPct: waveOverlap.avgOverlapPct || 0,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase A hint failed: waveOverlap`, err.message);
        }

        try {
            const insulinSensitivity = patterns.analyzeInsulinSensitivity?.(days, pIndex, profile);
            if (insulinSensitivity?.available) {
                hints.insulinSensitivity = {
                    score: normalize(insulinSensitivity.score),
                    avgGI: insulinSensitivity.avgGI,
                    avgFiberPer1000: insulinSensitivity.avgFiberPer1000,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase A hint failed: insulinSensitivity`, err.message);
        }

        try {
            const glycemicLoad = patterns.analyzeGlycemicLoad?.(days, pIndex);
            if (glycemicLoad?.available) {
                hints.glycemicLoad = {
                    score: normalize(glycemicLoad.score),
                    avgDailyGL: glycemicLoad.avgDailyGL,
                    avgEveningRatio: glycemicLoad.avgEveningRatio,
                    dailyClass: glycemicLoad.dailyClass,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase A hint failed: glycemicLoad`, err.message);
        }

        try {
            const proteinDistribution = patterns.analyzeProteinDistribution?.(days, profile, pIndex);
            if (proteinDistribution?.available) {
                hints.proteinDistribution = {
                    score: normalize(proteinDistribution.score),
                    distributionScore: proteinDistribution.distributionScore,
                    subthresholdMeals: proteinDistribution.subthresholdMeals,
                    excessMeals: proteinDistribution.excessMeals,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase A hint failed: proteinDistribution`, err.message);
        }

        try {
            const addedSugar = patterns.analyzeAddedSugarDependency?.(days, pIndex);
            if (addedSugar?.available) {
                hints.addedSugarDependency = {
                    score: normalize(addedSugar.score),
                    avgDailySugar: addedSugar.avgDailySugar,
                    maxStreak: addedSugar.maxStreak,
                    dependencyRisk: !!addedSugar.dependencyRisk,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase A hint failed: addedSugarDependency`, err.message);
        }

        // === PHASE B: CONTEXT MODIFIERS (4 patterns) ===

        // C06: Sleep ‚Üí Hunger (poor sleep recovery modifier)
        try {
            const sleepHunger = patterns.analyzeSleepHunger?.(days, profile, pIndex);
            if (sleepHunger?.available) {
                hints.sleepHunger = {
                    score: normalize(sleepHunger.score),
                    correlation: sleepHunger.correlation || 0,
                    poorSleepDays: sleepHunger.poorSleepDays || 0,
                    lagEffect: sleepHunger.lagEffect || 0,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase B hint failed: sleepHunger`, err.message);
        }

        // C14: Nutrient Timing (PRE/POST workout fine-tuning)
        try {
            const nutrientTiming = patterns.analyzeNutrientTiming?.(days, pIndex, profile);
            if (nutrientTiming?.available) {
                hints.nutrientTiming = {
                    score: normalize(nutrientTiming.score),
                    carbTimingScore: nutrientTiming.carbTimingScore || 0,
                    proteinTimingScore: nutrientTiming.proteinTimingScore || 0,
                    optimalWindow: nutrientTiming.optimalWindow || 'N/A',
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase B hint failed: nutrientTiming`, err.message);
        }

        // C10: Fiber Regularity (product picker fiber boost)
        try {
            const fiberRegularity = patterns.analyzeFiberRegularity?.(days, pIndex);
            if (fiberRegularity?.available) {
                hints.fiberRegularity = {
                    score: normalize(fiberRegularity.score),
                    avgFiberG: fiberRegularity.avgFiberG || 0,
                    targetFiberG: fiberRegularity.targetFiberG || 25,
                    fiberPer1000: fiberRegularity.fiberPer1000 || 0,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase B hint failed: fiberRegularity`, err.message);
        }

        // C12: Mood ‚Üî Food (STRESS_EATING enhancement)
        try {
            const optimum = profile?.optimum || 2000;
            const moodFood = patterns.analyzeMoodFood?.(days, pIndex, optimum);
            if (moodFood?.available) {
                hints.moodFood = {
                    score: normalize(moodFood.score),
                    correlation: moodFood.correlation || 0,
                    bestFoods: moodFood.bestFoods || [],
                    worstFoods: moodFood.worstFoods || [],
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase B hint failed: moodFood`, err.message);
        }

        // === PHASE C: MICRONUTRIENT INTELLIGENCE (2 patterns) ===

        // C26: Micronutrient Radar (product boost for Fe/Mg/Zn/Ca deficit)
        try {
            const micronutrients = patterns.analyzeMicronutrients?.(days, pIndex, profile);
            if (micronutrients?.available) {
                hints.micronutrients = {
                    score: normalize(micronutrients.score),
                    deficits: micronutrients.deficits || [],
                    avgIntake: micronutrients.avgIntake || {},
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase C hint failed: micronutrients`, err.message);
        }

        // C29: NOVA Quality (penalty for ultra-processed)
        try {
            const novaQuality = patterns.analyzeNOVAQuality?.(days, pIndex);
            if (novaQuality?.available) {
                hints.novaQuality = {
                    score: normalize(novaQuality.score),
                    nova4SharePct: novaQuality.nova4SharePct || 0,
                    avgNOVA: novaQuality.avgNOVA || 2.5,
                };
            }
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Phase C hint failed: novaQuality`, err.message);
        }

        const keys = Object.keys(hints);
        if (keys.length > 0) {
            const phaseACount = ['mealTiming', 'waveOverlap', 'insulinSensitivity', 'glycemicLoad', 'proteinDistribution', 'addedSugarDependency'].filter(k => hints[k]).length;
            const phaseBCount = ['sleepHunger', 'nutrientTiming', 'fiberRegularity', 'moodFood'].filter(k => hints[k]).length;
            const phaseCCount = ['micronutrients', 'novaQuality'].filter(k => hints[k]).length;
            console.group(`${LOG_PREFIX} [MEALREC / patterns] ‚úÖ Pattern hints loaded: ${keys.length} (A:${phaseACount}, B:${phaseBCount}, C:${phaseCCount})`);
            console.table(keys.map((k) => ({ pattern: k, score: hints[k].score, ...hints[k] })));
            console.groupEnd();
            return hints;
        }

        return null;
    }

    /**
     * Calculate optimal meal timing (threshold-aware v2.4, wave-aware v4.0.6)
     * @private
     */
    function calculateOptimalTiming(currentTime, lastMeal, training, sleepTarget, thresholds, patternHints, patternImpact = []) {
        // P0 Fix: Check if lastMeal actually exists (not empty object)
        const hasLastMeal = lastMeal && lastMeal.time;
        const lastMealTime = hasLastMeal ? parseTime(lastMeal.time) : 0;
        const hoursSinceLastMeal = hasLastMeal ? Math.max(0, currentTime - lastMealTime) : 0;

        // v4.0.6: Calculate insulin wave end time for timing constraint
        let waveEndHours = null;
        const FAT_BURN_WINDOW_HOURS = 0.5; // 30 min fat burn after wave ends
        if (hasLastMeal && HEYS.InsulinWave?.calculate) {
            try {
                const waveData = HEYS.InsulinWave.calculate({
                    lastMealTime: lastMeal.time,
                    nutrients: {
                        kcal: lastMeal.totals?.kcal || 0,
                        protein: lastMeal.totals?.prot || lastMeal.totals?.protein || 0,
                        carbs: lastMeal.totals?.carbs || 0,
                        fat: lastMeal.totals?.fat || 0,
                        glycemicLoad: lastMeal.totals?.glycemicLoad || 0
                    },
                    profile: null, // minimal call ‚Äî profile not always available here
                    baseWaveHours: 3
                });
                if (waveData?.duration) {
                    waveEndHours = lastMealTime + waveData.duration / 60;
                    console.info(`${LOG_PREFIX} [MEALREC / timing] üåä Insulin wave constraint:`, {
                        lastMeal: lastMeal.time,
                        waveDuration: waveData.duration + 'min',
                        waveEnd: formatTime(waveEndHours),
                        waveRemaining: waveData.remaining + 'min',
                        fatBurnEnd: formatTime(waveEndHours + FAT_BURN_WINDOW_HOURS)
                    });
                }
            } catch (err) {
                console.warn(`${LOG_PREFIX} [MEALREC / timing] ‚ö†Ô∏è InsulinWave calc failed:`, err.message);
            }
        }

        // Adaptive meal gap (v2.4)
        const idealGapMin = thresholds?.idealMealGapMin || 240; // fallback 4h
        const idealGapHours = idealGapMin / 60;
        const minGap = idealGapHours * 0.75; // 75% of ideal
        const maxGap = idealGapHours * 1.25; // 125% of ideal

        // Base time for calculations (currentTime if first meal, lastMealTime otherwise)
        const baseTime = hasLastMeal ? lastMealTime : currentTime;

        let idealStart, idealEnd, reason;

        // Special case: First meal of day
        if (!hasLastMeal) {
            idealStart = currentTime;
            idealEnd = currentTime + 1;
            reason = `–ü–µ—Ä–≤—ã–π –ø—Ä–∏–µ–º –¥–Ω—è ‚Äî –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å`;
            console.info(`[${LOG_FILTER}] ‚è∞ First meal timing:`, { idealStart, idealEnd, currentTime });
            return {
                ideal: `${formatTime(idealStart)}-${formatTime(idealEnd)}`,
                idealStart,
                idealEnd,
                currentTime,
                hoursSinceLastMeal: 0,
                reason
            };
        }

        // Phase A: C01/C02 timing adjustments (small, safe deltas)
        let phaseATimingShiftMin = 0;
        if (patternHints?.mealTiming?.score !== undefined && patternHints.mealTiming.score < 0.45) {
            phaseATimingShiftMin += 20;
        }
        if (patternHints?.waveOverlap?.avgOverlapPct !== undefined && patternHints.waveOverlap.avgOverlapPct > 25) {
            phaseATimingShiftMin += 20;
        }
        if (phaseATimingShiftMin > 0) {
            console.info(`${LOG_PREFIX} [MEALREC / timing] üßÆ Phase A timing modifier:`, {
                shiftMinutes: phaseATimingShiftMin,
                mealTimingScore: patternHints?.mealTiming?.score,
                waveOverlapPct: patternHints?.waveOverlap?.avgOverlapPct,
            });
        }

        // Case 1: Training soon (within 2h)
        if (training && training.time) {
            const trainingTime = parseTime(training.time);
            const hoursToTraining = trainingTime - currentTime;

            if (hoursToTraining > 0 && hoursToTraining <= 2) {
                // Pre-workout meal
                idealStart = Math.max(currentTime, trainingTime - 1.5);
                idealEnd = trainingTime - 1;
                reason = `Pre-workout –∑–∞ 1-1.5—á –¥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏`;
            } else if (hoursToTraining < 0 && hoursToTraining > -2) {
                // Post-workout meal
                idealStart = currentTime;
                idealEnd = currentTime + 0.5;
                reason = `Post-workout —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏`;
            } else {
                // Regular meal timing
                idealStart = baseTime + idealGapHours;
                idealEnd = baseTime + maxGap;
                reason = `–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π gap ${Math.round(idealGapMin)}–º–∏–Ω –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞`;
            }
        } else {
            // No training nearby ‚Äî standard meal timing
            idealStart = baseTime + idealGapHours;
            idealEnd = baseTime + maxGap;
            reason = `–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π gap ${Math.round(idealGapMin)}–º–∏–Ω`;
        }

        if (phaseATimingShiftMin > 0) {
            idealStart += phaseATimingShiftMin / 60;
            idealEnd += phaseATimingShiftMin / 60;
            reason += ` (Phase A: +${phaseATimingShiftMin}–º–∏–Ω –∏–∑ C01/C02)`;
            patternImpact.push({
                pattern: 'C01/C02',
                area: 'timing',
                before: `${formatTime(idealStart - phaseATimingShiftMin / 60)}-${formatTime(idealEnd - phaseATimingShiftMin / 60)}`,
                after: `${formatTime(idealStart)}-${formatTime(idealEnd)}`,
                reason: `Shift +${phaseATimingShiftMin}min (mealTiming/waveOverlap)`
            });
        }

        // v4.0.6: Enforce insulin wave constraint ‚Äî don't suggest eating during active wave
        if (waveEndHours !== null) {
            const waveConstraintEnd = waveEndHours + FAT_BURN_WINDOW_HOURS;
            if (idealStart < waveConstraintEnd) {
                const prevStart = idealStart;
                idealStart = waveConstraintEnd;
                idealEnd = Math.max(idealEnd, idealStart + 0.5);
                reason = `–ñ–¥—ë–º –∫–æ–Ω–µ—Ü –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã + –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ (${formatTime(waveEndHours)})`;
                console.info(`${LOG_PREFIX} [MEALREC / timing] üåä Wave constraint applied:`, {
                    prevStart: formatTime(prevStart),
                    waveEnd: formatTime(waveEndHours),
                    fatBurnEnd: formatTime(waveConstraintEnd),
                    newIdealStart: formatTime(idealStart),
                    newIdealEnd: formatTime(idealEnd)
                });
                patternImpact.push({
                    pattern: 'InsulinWave',
                    area: 'timing',
                    before: formatTime(prevStart),
                    after: formatTime(idealStart),
                    reason: `Wave ends ${formatTime(waveEndHours)} + 30min fat burn`
                });
            }
        }

        // P0 Fix: Ensure timing never in past
        if (idealStart < currentTime) {
            console.warn(`[${LOG_FILTER}] ‚ö†Ô∏è Adjusted timing to current time (was in past):`, {
                originalStart: formatTime(idealStart),
                adjustedStart: formatTime(currentTime),
                hoursSinceLastMeal: hoursSinceLastMeal.toFixed(1)
            });
            idealStart = currentTime;
            idealEnd = Math.max(idealEnd, currentTime + 0.5);
            reason = `–°–µ–π—á–∞—Å ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–ø—Ä–æ—à–ª–æ ${hoursSinceLastMeal.toFixed(1)}—á)`;
        }

        // Adjust for sleep target (no eating 3h before sleep)
        const mealDeadline = sleepTarget - 3;
        if (idealStart > mealDeadline) {
            if (currentTime >= mealDeadline) {
                // Already past ideal meal window ‚Äî suggest eating now with short window
                idealStart = currentTime;
                idealEnd = Math.min(currentTime + 0.5, sleepTarget);
                reason = `‚ö†Ô∏è –ü–æ–∑–¥–Ω–∏–π –ø—Ä–∏—ë–º ‚Äî –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –¥–æ ${formatTime(sleepTarget)}`;
            } else {
                idealStart = Math.max(currentTime, mealDeadline - 1);
                idealEnd = mealDeadline;
                reason = `–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º ‚Äî –∑–∞ 3—á –¥–æ —Å–Ω–∞`;
            }
        }

        return {
            ideal: `${formatTime(idealStart)}-${formatTime(idealEnd)}`,
            idealStart,
            idealEnd,
            currentTime,
            hoursSinceLastMeal: Math.round(hoursSinceLastMeal * 10) / 10,
            reason
        };
    }

    /**
     * Calculate optimal macros (scenario-aware v2.4)
     * @private
     */
    function calculateOptimalMacros(contextAnalysis, dayTarget, dayEaten, training, profile, timingRec, patternHints, patternImpact = []) {
        const scenario = contextAnalysis.scenario;
        const targetKcal = dayTarget.kcal || profile.optimum || 2000;
        const targetProtein = dayTarget.protein || profile.norm?.prot || 120;
        const targetCarbs = dayTarget.carbs || profile.norm?.carb || 200;

        const eatenKcal = dayEaten.kcal || 0;
        const eatenProtein = dayEaten.protein || 0;
        const eatenCarbs = dayEaten.carbs || 0;

        const remainingKcal = Math.max(0, targetKcal - eatenKcal);
        const remainingProtein = Math.max(0, targetProtein - eatenProtein);
        const remainingCarbs = Math.max(0, targetCarbs - eatenCarbs);

        console.info(`${LOG_PREFIX} üìä Remaining today:`, {
            kcal: remainingKcal,
            protein: remainingProtein,
            carbs: remainingCarbs,
            scenario
        });

        // Estimate meals remaining today
        const hoursUntilSleep = timingRec.idealStart ? (parseTime('23:00') - timingRec.idealStart) : 8;
        const mealsRemaining = Math.max(1, Math.floor(hoursUntilSleep / 4));
        console.info(`${LOG_PREFIX} ‚è±Ô∏è Meals remaining estimate:`, {
            hoursUntilSleep: Math.round(hoursUntilSleep * 10) / 10,
            mealsRemaining,
            avgKcalPerMeal: mealsRemaining > 0 ? Math.round(remainingKcal / mealsRemaining) : 0
        });

        // v3.2.0: Last meal override ‚Äî if this is the LAST meal with substantial budget remaining,
        // ignore scenario caps and use actual remaining budget (with 10% buffer for flexibility)
        const isLastMeal = mealsRemaining === 1 && remainingKcal > 300;
        const lastMealKcalTarget = isLastMeal ? Math.round(remainingKcal * 0.90) : null;
        if (isLastMeal) {
            console.info(`${LOG_PREFIX} üéØ LAST MEAL OVERRIDE detected:`, {
                remainingKcal,
                targetKcal: lastMealKcalTarget,
                reason: `Last meal of day with ${remainingKcal} kcal remaining ‚Äî using 90% of budget instead of scenario cap`
            });
        }

        let mealKcal, mealProtein, mealCarbs, mealFat;
        let macroStrategy = ''; // For detailed logging

        // Scenario-specific macro strategies (v3.2.0: with last meal override)
        switch (scenario) {
            case SCENARIOS.GOAL_REACHED:
                // No meal recommended
                mealKcal = 0;
                mealProtein = 0;
                mealCarbs = 0;
                mealFat = 0;
                macroStrategy = 'Goal reached - no meal recommended';
                break;

            case SCENARIOS.LIGHT_SNACK:
                // Small snack: 50-150 kcal (or last meal override)
                mealKcal = lastMealKcalTarget || Math.min(remainingKcal, 150);
                if (isLastMeal) {
                    // R4: use actual remaining protein need ‚Äî avoids P5-cap trigger
                    mealProtein = Math.round(Math.min(remainingProtein, 100));
                    const _protKcalLS = mealProtein * 3;
                    const _restKcalLS = Math.max(0, mealKcal - _protKcalLS);
                    mealCarbs = Math.round(_restKcalLS * 0.57 / 4); // 57% of rest (original 40:30 carbs:fat)
                    mealFat = Math.max(5, Math.round((_restKcalLS - mealCarbs * 4) / 9));
                    macroStrategy = `Last meal: ${mealKcal} kcal (90% of ${remainingKcal} remaining), protein=${mealProtein}g (actual need from ${Math.round(remainingProtein)}g deficit), carbs+fat fill rest`;
                } else {
                    mealProtein = Math.round(mealKcal * 0.3 / 3); // 30% from protein
                    mealCarbs = Math.round(mealKcal * 0.4 / 4); // 40% from carbs
                    mealFat = Math.round(mealKcal * 0.3 / 9); // 30% from fat
                    macroStrategy = 'Light snack: max 150 kcal, 30% protein, 40% carbs, 30% fat';
                }
                break;

            case SCENARIOS.LATE_EVENING:
                // Light evening meal: max 200 kcal, high protein (slow digestion) ‚Äî OR last meal override
                mealKcal = lastMealKcalTarget || Math.min(remainingKcal, 200);
                if (isLastMeal) {
                    // R4: use actual remaining protein need ‚Äî avoids P5-cap trigger
                    mealProtein = Math.round(Math.min(remainingProtein, 100));
                    const _protKcalLE = mealProtein * 3;
                    const _restKcalLE = Math.max(0, mealKcal - _protKcalLE);
                    // Evening: low carbs, moderate fat for slow digestion (original 20:20 = 1:1)
                    mealCarbs = Math.round(_restKcalLE * 0.50 / 4); // 50% of rest
                    mealFat = Math.max(5, Math.round((_restKcalLE - mealCarbs * 4) / 9));
                    macroStrategy = `Last meal: ${mealKcal} kcal (90% of ${remainingKcal} remaining), protein=${mealProtein}g (actual need from ${Math.round(remainingProtein)}g deficit), evening carbs+fat fill rest`;
                } else {
                    mealProtein = Math.round(mealKcal * 0.6 / 3); // 60% from protein (casein)
                    mealCarbs = Math.round(mealKcal * 0.2 / 4); // 20% from carbs
                    mealFat = Math.round(mealKcal * 0.2 / 9); // 20% from fat
                    macroStrategy = 'Late evening: max 200 kcal (sleep quality), 60% protein (casein), 20% carbs, 20% fat';
                }
                break;

            case SCENARIOS.PRE_WORKOUT:
                // Pre-workout: max 300 kcal, high carbs for energy (or last meal override)
                mealKcal = lastMealKcalTarget || Math.min(remainingKcal, 300);
                if (isLastMeal) {
                    // R4: use actual remaining protein need ‚Äî avoids P5-cap trigger
                    mealProtein = Math.round(Math.min(remainingProtein, 100));
                    const _protKcalPre = mealProtein * 3;
                    const _restKcalPre = Math.max(0, mealKcal - _protKcalPre);
                    // Pre-workout: carbs dominant for glycogen (original 60:15 = 4:1)
                    mealCarbs = Math.round(_restKcalPre * 0.80 / 4); // 80% of rest
                    mealFat = Math.max(5, Math.round((_restKcalPre - mealCarbs * 4) / 9));
                    macroStrategy = `Last meal: ${mealKcal} kcal (90% of ${remainingKcal} remaining), protein=${mealProtein}g (actual need from ${Math.round(remainingProtein)}g deficit), glycogen carbs fill rest`;
                } else {
                    mealProtein = Math.round(mealKcal * 0.25 / 3); // 25% from protein
                    mealCarbs = Math.round(mealKcal * 0.60 / 4); // 60% from carbs (fast)
                    mealFat = Math.round(mealKcal * 0.15 / 9); // 15% from fat
                    macroStrategy = 'Pre-workout: max 300 kcal, 60% fast carbs, 25% protein, 15% fat';
                }
                break;

            case SCENARIOS.POST_WORKOUT:
                // Post-workout: max 400 kcal, high protein + carbs (or last meal override)
                mealKcal = lastMealKcalTarget || Math.min(remainingKcal, 400);
                if (isLastMeal) {
                    // R1 fix (Sprint 6): use actual remaining protein need ‚Äî avoids P5-cap trigger
                    // Physiological ceiling: Areta et al., 2013 ‚Äî ~100g absorbed per meal
                    mealProtein = Math.round(Math.min(remainingProtein, 100));
                    const _protKcalPW = mealProtein * 3;
                    const _restKcalPW = Math.max(0, mealKcal - _protKcalPW);
                    mealCarbs = Math.round(_restKcalPW * 0.75 / 4); // 75% of rest (glycogen priority, original 45:15 = 3:1 ratio)
                    mealFat = Math.max(5, Math.round((_restKcalPW - mealCarbs * 4) / 9));
                    macroStrategy = `Last meal: ${mealKcal} kcal (90% of ${remainingKcal} remaining), protein=${mealProtein}g (actual need from ${Math.round(remainingProtein)}g deficit), glycogen carbs fill rest`;
                } else {
                    mealProtein = Math.round(mealKcal * 0.40 / 3); // 40% from protein (recovery)
                    mealCarbs = Math.round(mealKcal * 0.45 / 4); // 45% from carbs (glycogen)
                    mealFat = Math.round(mealKcal * 0.15 / 9); // 15% from fat
                    macroStrategy = 'Post-workout: max 400 kcal, 40% protein (recovery), 45% carbs (glycogen), 15% fat';
                }
                break;

            case SCENARIOS.PROTEIN_DEFICIT:
                // High protein meal: max 300 kcal (or last meal override)
                mealKcal = lastMealKcalTarget || Math.min(remainingKcal, 300);
                if (isLastMeal) {
                    // R1 fix (Sprint 6): use actual remaining protein need ‚Äî avoids P5-cap trigger
                    // Physiological ceiling: Areta et al., 2013 ‚Äî ~100g absorbed per meal
                    mealProtein = Math.round(Math.min(remainingProtein, 100));
                    const _protKcalPD = mealProtein * 3;
                    const _restKcalPD = Math.max(0, mealKcal - _protKcalPD);
                    mealCarbs = Math.round(_restKcalPD * 0.60 / 4); // 60% of rest (original 30:20 carbs:fat ratio)
                    mealFat = Math.max(5, Math.round((_restKcalPD - mealCarbs * 4) / 9));
                    macroStrategy = `Last meal: ${mealKcal} kcal (90% of ${remainingKcal} remaining), protein=${mealProtein}g (actual need from ${Math.round(remainingProtein)}g deficit), carbs+fat fill rest`;
                } else {
                    mealProtein = Math.round(mealKcal * 0.50 / 3); // 50% from protein
                    mealCarbs = Math.round(mealKcal * 0.30 / 4); // 30% from carbs
                    mealFat = Math.round(mealKcal * 0.20 / 9); // 20% from fat
                    macroStrategy = 'Protein deficit: max 300 kcal, 50% protein, 30% carbs, 20% fat';
                }
                break;

            case SCENARIOS.STRESS_EATING:
                // Comfort food (healthy): max 250 kcal, balanced with omega-3 (or last meal override)
                mealKcal = lastMealKcalTarget || Math.min(remainingKcal, 250);
                if (isLastMeal) {
                    // R1 fix (Sprint 6): use actual remaining protein need ‚Äî avoids P5-cap trigger
                    mealProtein = Math.round(Math.min(remainingProtein, 100));
                    const _protKcalSE = mealProtein * 3;
                    const _restKcalSE = Math.max(0, mealKcal - _protKcalSE);
                    mealCarbs = Math.round(_restKcalSE * 0.57 / 4); // 57% of rest (carbs:fat ‚âà 4:3, original serotonin+omega3)
                    mealFat = Math.max(5, Math.round((_restKcalSE - mealCarbs * 4) / 9));
                    macroStrategy = `Last meal: ${mealKcal} kcal (90% of ${remainingKcal} remaining), protein=${mealProtein}g (actual need from ${Math.round(remainingProtein)}g deficit), serotonin+omega-3 carbs/fat fill rest`;
                } else {
                    mealProtein = Math.round(mealKcal * 0.30 / 3); // 30% from protein
                    mealCarbs = Math.round(mealKcal * 0.40 / 4); // 40% from carbs (serotonin)
                    mealFat = Math.round(mealKcal * 0.30 / 9); // 30% from fat (omega-3)
                    macroStrategy = 'Stress eating: max 250 kcal, 40% carbs (serotonin), 30% protein, 30% fat (omega-3)';
                }
                break;

            case SCENARIOS.BALANCED:
            default:
                // Standard balanced meal
                mealKcal = Math.round(remainingKcal / mealsRemaining);
                mealProtein = Math.round(remainingProtein / mealsRemaining);
                mealCarbs = Math.round(remainingCarbs / mealsRemaining);
                mealFat = Math.max(0, Math.round((mealKcal - mealProtein * 3 - mealCarbs * 4) / 9));
                macroStrategy = `Balanced: split remaining evenly across ${mealsRemaining} meal(s)`;
                break;
        }

        const beforePhenotype = {
            kcal: mealKcal,
            protein: mealProtein,
            carbs: mealCarbs,
            fat: mealFat,
            percentages: {
                proteinPct: mealKcal > 0 ? Math.round((mealProtein * 3 / mealKcal) * 100) : 0,
                carbsPct: mealKcal > 0 ? Math.round((mealCarbs * 4 / mealKcal) * 100) : 0,
                fatPct: mealKcal > 0 ? Math.round((mealFat * 9 / mealKcal) * 100) : 0
            }
        };

        console.group(`${LOG_PREFIX} üçΩÔ∏è Macro strategy: [${scenario}] ${macroStrategy}`);
        console.table([beforePhenotype]);
        console.groupEnd();

        // Apply phenotype multipliers (if available, but stay within budget)
        if (profile.phenotype && scenario === SCENARIOS.BALANCED) {
            const phenotype = profile.phenotype;
            if (phenotype.satiety === 'low_satiety') {
                mealProtein = Math.round(mealProtein * 1.15);
            }
            if (phenotype.metabolic === 'insulin_resistant') {
                mealCarbs = Math.round(mealCarbs * 0.85);
                mealProtein = Math.round(mealProtein * 1.1);
            }
        }

        // Phase B: C06 Sleep‚ÜíHunger modifier (poor sleep recovery ‚Üí more protein, less simple carbs)
        if (patternHints?.sleepHunger?.score !== undefined && patternHints.sleepHunger.score < 0.5 && scenario === SCENARIOS.BALANCED) {
            const before = { protein: mealProtein, carbs: mealCarbs };
            mealProtein = Math.round(mealProtein * 1.12); // +12% protein
            mealCarbs = Math.round(mealCarbs * 0.92); // -8% carbs (reduce simple carbs craving)
            console.info(`${LOG_PREFIX} [MEALREC / macros] üßÆ Phase B C06 (poor sleep recovery):`, {
                scenario,
                sleepHungerScore: patternHints.sleepHunger.score,
                proteinBefore: before.protein,
                proteinAfter: mealProtein,
                carbsBefore: before.carbs,
                carbsAfter: mealCarbs
            });
            patternImpact.push({
                pattern: 'C06',
                area: 'macros',
                before: `P${before.protein}/C${before.carbs}`,
                after: `P${mealProtein}/C${mealCarbs}`,
                reason: `sleepHunger=${patternHints.sleepHunger.score} (poor sleep recovery)`
            });
        }

        // Phase B: C14 Nutrient Timing fine-tuning for PRE/POST WORKOUT
        if (patternHints?.nutrientTiming && (scenario === SCENARIOS.PRE_WORKOUT || scenario === SCENARIOS.POST_WORKOUT)) {
            const carbTiming = patternHints.nutrientTiming.carbTimingScore || 0;
            const proteinTiming = patternHints.nutrientTiming.proteinTimingScore || 0;
            const before = { protein: mealProtein, carbs: mealCarbs };

            // Good carb timing ‚Üí can increase carbs slightly for PRE
            if (scenario === SCENARIOS.PRE_WORKOUT && carbTiming > 0.7) {
                mealCarbs = Math.round(mealCarbs * 1.08);
            }

            // Poor protein timing ‚Üí increase protein for POST
            if (scenario === SCENARIOS.POST_WORKOUT && proteinTiming < 0.5) {
                mealProtein = Math.round(mealProtein * 1.1);
            }

            if (before.protein !== mealProtein || before.carbs !== mealCarbs) {
                console.info(`${LOG_PREFIX} [MEALREC / macros] üßÆ Phase B C14 (nutrient timing):`, {
                    scenario,
                    carbTimingScore: carbTiming,
                    proteinTimingScore: proteinTiming,
                    delta: `P ${before.protein}‚Üí${mealProtein}, C ${before.carbs}‚Üí${mealCarbs}`
                });
                patternImpact.push({
                    pattern: 'C14',
                    area: 'macros',
                    before: `P${before.protein}/C${before.carbs}`,
                    after: `P${mealProtein}/C${mealCarbs}`,
                    reason: `nutrientTiming: carb=${carbTiming}, protein=${proteinTiming}`
                });
            }
        }

        // Phase B: C12 Mood‚ÜîFood enhancement for STRESS_EATING
        if (patternHints?.moodFood && scenario === SCENARIOS.STRESS_EATING) {
            const moodCorr = Math.abs(patternHints.moodFood.correlation || 0);
            const before = { protein: mealProtein, carbs: mealCarbs };

            // Strong mood-food correlation ‚Üí optimize for serotonin boost (complex carbs + omega-3)
            if (moodCorr > 0.4) {
                mealCarbs = Math.round(mealCarbs * 1.1); // +10% carbs (complex for serotonin)
                mealProtein = Math.round(mealProtein * 1.05); // +5% protein (amino acids)
                console.info(`${LOG_PREFIX} [MEALREC / macros] üßÆ Phase B C12 (mood-food):`, {
                    scenario,
                    moodCorrelation: moodCorr,
                    delta: `P ${before.protein}‚Üí${mealProtein}, C ${before.carbs}‚Üí${mealCarbs}`
                });
                patternImpact.push({
                    pattern: 'C12',
                    area: 'macros',
                    before: `P${before.protein}/C${before.carbs}`,
                    after: `P${mealProtein}/C${mealCarbs}`,
                    reason: `moodFood correlation=${moodCorr} (serotonin optimization)`
                });
            }
        }

        // Phase A: C15 + C35 macro tuning
        if (patternHints?.insulinSensitivity?.score !== undefined || patternHints?.proteinDistribution?.score !== undefined) {
            const before = { protein: mealProtein, carbs: mealCarbs, fat: mealFat };

            // C15: insulin sensitivity low -> lower carbs, increase protein slightly
            // Sprint 6 R3: skip protein boost for isLastMeal (protein already set from remainingProtein)
            if (patternHints?.insulinSensitivity?.score < 0.45) {
                mealCarbs = Math.round(mealCarbs * 0.9);
                if (!isLastMeal) {
                    mealProtein = Math.round(mealProtein * 1.08);
                }
            }

            // C35: poor protein distribution -> stronger scenario-aware protein push
            // Sprint 6 R3: skip protein boost for isLastMeal ‚Äî protein already set from remainingProtein (R1 fix)
            const proteinDistributionScore = patternHints?.proteinDistribution?.score;
            if (proteinDistributionScore !== undefined && mealProtein > 0 && !isLastMeal) {
                let c35Multiplier = 1.0;
                if (proteinDistributionScore < 0.35) c35Multiplier = 1.20;
                else if (proteinDistributionScore < 0.5) c35Multiplier = 1.12;

                if (c35Multiplier > 1.0) {
                    if (scenario === SCENARIOS.PROTEIN_DEFICIT) c35Multiplier += 0.05;
                    if (scenario === SCENARIOS.POST_WORKOUT) c35Multiplier += 0.03;
                    if (scenario === SCENARIOS.LATE_EVENING) c35Multiplier += 0.02;

                    // Cap multiplier for safety
                    c35Multiplier = Math.min(c35Multiplier, 1.3);
                    mealProtein = Math.round(mealProtein * c35Multiplier);
                }
            } else if (isLastMeal && proteinDistributionScore !== undefined) {
                // R3: log that C35 was intentionally skipped for last meal
                console.info(`${LOG_PREFIX} [MEALREC / macros] ‚úÖ R3: C35 protein boost skipped (isLastMeal=true, protein already from remainingProtein: ${mealProtein}g)`);
            }

            // Recompute fat to maintain kcal budget approximation
            mealFat = Math.max(0, Math.round((mealKcal - mealProtein * 3 - mealCarbs * 4) / 9));

            console.info(`${LOG_PREFIX} [MEALREC / macros] ‚úÖ Phase A macro modifiers applied:`, {
                scenario,
                before,
                after: { protein: mealProtein, carbs: mealCarbs, fat: mealFat },
                insulinSensitivityScore: patternHints?.insulinSensitivity?.score,
                proteinDistributionScore: patternHints?.proteinDistribution?.score,
            });

            patternImpact.push({
                pattern: 'C15/C35',
                area: 'macros',
                before: `P${before.protein}/C${before.carbs}/F${before.fat}`,
                after: `P${mealProtein}/C${mealCarbs}/F${mealFat}`,
                reason: `insulin=${patternHints?.insulinSensitivity?.score ?? 'n/a'}, proteinDist=${patternHints?.proteinDistribution?.score ?? 'n/a'}`
            });
        }

        // P5 fix (v3.3.1): Physiological protein cap ‚Äî max 100g absorbed per meal (Areta et al., 2013)
        const PROTEIN_CAP_PER_MEAL_G = 100;
        if (mealProtein > PROTEIN_CAP_PER_MEAL_G) {
            const cappedFrom = mealProtein;
            const protDeltaG = cappedFrom - PROTEIN_CAP_PER_MEAL_G;
            mealProtein = PROTEIN_CAP_PER_MEAL_G;
            // Transfer excess protein kcal to carbs (protein 3kcal/g ‚Üí carbs 4kcal/g ‚Üí 0.75 carb equivalent)
            mealCarbs = Math.round(mealCarbs + protDeltaG * 0.75);
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è P5-cap: Protein ${cappedFrom}g ‚Üí ${PROTEIN_CAP_PER_MEAL_G}g (physiological max per meal), carbs compensated to ${mealCarbs}g`);
        }

        // FINAL SAFETY: Never exceed remaining kcal
        const estimatedKcal = mealProtein * 3 + mealCarbs * 4 + mealFat * 9;
        if (estimatedKcal > remainingKcal) {
            const scale = remainingKcal / estimatedKcal;
            mealProtein = Math.round(mealProtein * scale);
            mealCarbs = Math.round(mealCarbs * scale);
            mealFat = Math.round(mealFat * scale);
            mealKcal = remainingKcal;
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Scaled down to fit remaining kcal:`, {
                scale: Math.round(scale * 100) + '%',
                finalKcal: mealKcal
            });
        }

        console.info(`${LOG_PREFIX} ‚úÖ Final meal macros:`, {
            scenario,
            kcal: mealKcal,
            protein: mealProtein,
            carbs: mealCarbs,
            fat: mealFat
        });

        return {
            protein: mealProtein,
            carbs: mealCarbs,
            fat: mealFat,
            kcal: mealKcal,
            proteinRange: `${Math.max(0, mealProtein - 5)}-${mealProtein + 5}`,
            carbsRange: `${Math.max(0, mealCarbs - 10)}-${mealCarbs + 10}`,
            kcalRange: `${Math.max(0, mealKcal - 50)}-${mealKcal + 50}`,
            remainingMeals: mealsRemaining,
            remainingKcal: remainingKcal
        };
    }

    /**
     * Generate smart meal suggestions using Product Picker v2.5
     * Falls back to rule-based suggestions if Product Picker unavailable
     * @private
     */
    function generateSmartMealSuggestions(contextAnalysis, macrosRec, context, profile, pIndex, patternHints, patternImpact = [], excludeProductIds = null) {
        const scenario = contextAnalysis.scenario;

        // Extract currentTime from context for caffeine-awareness (v2.6)
        const currentTime = parseTime(context.currentTime || getCurrentTime());

        // Special case: GOAL_REACHED - no computation needed
        if (scenario === SCENARIOS.GOAL_REACHED) {
            return [{
                product: '–í–æ–¥–∞',
                grams: 250,
                reason: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è ‚Äî —Ü–µ–ª—å –¥–Ω—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞'
            }];
        }

        // Check if Product Picker v2.5 is available
        if (!global.HEYS?.InsightsPI?.productPicker?.generateProductSuggestions) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Product Picker unavailable, falling back to rule-based suggestions`);
            return generateMealSuggestions(contextAnalysis, macrosRec, profile, pIndex);
        }

        try {
            // Determine ideal GI based on scenario
            let idealGI = 50; // Medium by default
            if (scenario === SCENARIOS.PRE_WORKOUT) {
                idealGI = 70; // High GI for quick energy
            } else if (scenario === SCENARIOS.POST_WORKOUT) {
                idealGI = 65; // v3.5: moderate-high GI ‚Äî fast carbs for glycogen (Ivy 2004)
            } else if (scenario === SCENARIOS.LATE_EVENING) {
                idealGI = 30; // Low GI for sustained release
            } else if (scenario === SCENARIOS.PRE_SLEEP) {
                idealGI = 25; // v3.3: very low GI pre-sleep (Halson 2014: casein/dairy)
            }

            // Phase A: C34 glycemic load ‚Üí dynamic GI moderation
            if (patternHints?.glycemicLoad?.score !== undefined) {
                const glScore = patternHints.glycemicLoad.score;
                const eveningRatio = patternHints.glycemicLoad.avgEveningRatio || 0;
                const idealGiBefore = idealGI;

                if (glScore < 0.45) {
                    idealGI = Math.max(20, idealGI - 15);
                } else if (glScore < 0.6) {
                    idealGI = Math.max(25, idealGI - 10);
                }

                if ((scenario === SCENARIOS.LATE_EVENING || scenario === SCENARIOS.BALANCED) && eveningRatio > 0.5) {
                    idealGI = Math.min(idealGI, 25);
                }

                if (idealGiBefore !== idealGI) {
                    console.info(`${LOG_PREFIX} [MEALREC / productPicker] üßÆ GI adjusted by C34:`, {
                        scenario,
                        idealGiBefore,
                        idealGiAfter: idealGI,
                        glycemicLoadScore: glScore,
                        eveningRatio,
                    });

                    patternImpact.push({
                        pattern: 'C34',
                        area: 'productPicker',
                        before: `idealGI=${idealGiBefore}`,
                        after: `idealGI=${idealGI}`,
                        reason: `glycemicLoad=${glScore}, eveningRatio=${eveningRatio}`
                    });
                }
            }

            const resolvedLsGet =
                (typeof context?.lsGet === 'function' && context.lsGet) ||
                (typeof global.U?.lsGet === 'function' && global.U.lsGet.bind(global.U)) ||
                (typeof global.HEYS?.utils?.lsGet === 'function' && global.HEYS.utils.lsGet.bind(global.HEYS.utils));

            // Get shared products (from context or global)
            const sharedProducts = context.sharedProducts || global.HEYS?.products?.getAll?.() || [];

            console.info(`${LOG_PREFIX} üîç Product Picker deps:`, {
                hasLsGet: typeof resolvedLsGet === 'function',
                sharedProductsCount: sharedProducts.length,
            });

            // Call Product Picker with full Phase A/B/C context
            // v3.1.1: Pass target meal kcal (not day remaining) for correct product selection
            const pickerResult = global.HEYS.InsightsPI.productPicker.generateProductSuggestions({
                scenario,
                remainingKcal: macrosRec.kcal, // v3.1.1: Use meal target kcal (200 for LATE_EVENING) not day remainder (764)
                targetProteinG: macrosRec.protein,
                targetCarbsG: macrosRec.carbs,
                targetFatG: macrosRec.fat,
                idealGI,
                targetGL: macrosRec.targetGL ?? null, // v3.4: F2 ‚Äî GL target from planner (Ludwig 2002)
                currentTime: currentTime, // v2.6: Pass time for caffeine-awareness
                addedSugarScore: patternHints?.addedSugarDependency?.score, // Phase A: C37
                sugarDependencyRisk: patternHints?.addedSugarDependency?.dependencyRisk, // Phase A: C37
                fiberRegularityScore: patternHints?.fiberRegularity?.score, // Phase B: C10
                micronutrientDeficits: patternHints?.micronutrients?.deficits, // Phase C: C26
                novaQualityScore: patternHints?.novaQuality?.score, // Phase C: C29
                lsGet: resolvedLsGet,
                sharedProducts,
                limit: 3,
                excludeProductIds: excludeProductIds instanceof Set ? excludeProductIds : null, // P3: cross-meal dedup
                profile, // v3.6: F4 ‚Äî feedback weights (ML EMA multiplier per product+scenario)
            });

            // Handle both modes: flat (legacy) vs grouped (v3.1)
            let suggestions;
            if (pickerResult.mode === 'grouped' && pickerResult.groups) {
                // v3.1: Return groups structure for UI
                console.info(`${LOG_PREFIX} ‚úÖ Smart suggestions via Product Picker v3.1 (grouped):`, {
                    scenario,
                    groupsCount: pickerResult.groups.length,
                    totalProducts: pickerResult.totalProducts,
                    historyUsed: pickerResult.historyUsed,
                });
                return pickerResult; // Return full structure with groups
            } else if (pickerResult.mode === 'flat' && pickerResult.suggestions) {
                suggestions = pickerResult.suggestions;
            } else {
                // Legacy format (direct array) - for backward compatibility
                suggestions = Array.isArray(pickerResult) ? pickerResult : [];
            }

            // If insufficient suggestions, fallback
            if (!suggestions || suggestions.length === 0) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Product Picker returned no results, falling back`);
                return generateMealSuggestions(contextAnalysis, macrosRec, profile, pIndex);
            }

            console.info(`${LOG_PREFIX} ‚úÖ Smart suggestions via Product Picker (flat mode):`, {
                scenario,
                count: suggestions.length,
                sources: suggestions.map(s => s.source),
            });

            return suggestions;

        } catch (error) {
            console.error(`${LOG_PREFIX} ‚ùå Product Picker error:`, error);
            return generateMealSuggestions(contextAnalysis, macrosRec, profile, pIndex);
        }
    }

    /**
     * Generate meal suggestions (scenario-aware v2.4 ‚Äî FALLBACK)
     * Used when Product Picker v2.5 is unavailable or returns insufficient results
     * @private
     */
    function generateMealSuggestions(contextAnalysis, macrosRec, profile, pIndex) {
        const scenario = contextAnalysis.scenario;
        const suggestions = [];

        const proteinTarget = macrosRec.protein;
        const carbsTarget = macrosRec.carbs;
        const kcalTarget = macrosRec.kcal;

        console.info(`${LOG_PREFIX} ü•ò Generating suggestions for:`, {
            scenario,
            protein: proteinTarget,
            carbs: carbsTarget,
            kcal: kcalTarget
        });

        // Scenario-specific suggestions (v2.4)
        switch (scenario) {
            case SCENARIOS.GOAL_REACHED:
                // No food, just hydration
                suggestions.push({
                    product: '–í–æ–¥–∞',
                    grams: 250,
                    reason: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è ‚Äî —Ü–µ–ª—å –¥–Ω—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞'
                });
                return suggestions;

            case SCENARIOS.LIGHT_SNACK:
                // Light snacks: kefir, yogurt, fruit
                if (proteinTarget > 5) {
                    const gramsNeeded = Math.round((proteinTarget / 3.2) * 100); // kefir 3.2g per 100ml
                    suggestions.push({
                        product: '–ö–µ—Ñ–∏—Ä',
                        grams: Math.min(gramsNeeded, 200),
                        reason: '–õ–µ–≥–∫–æ—É—Å–≤–æ—è–µ–º—ã–π –±–µ–ª–æ–∫, –ø—Ä–æ–±–∏–æ—Ç–∏–∫–∏'
                    });
                }
                if (carbsTarget > 10) {
                    suggestions.push({
                        product: '–Ø–±–ª–æ–∫–æ',
                        grams: 100,
                        reason: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞, –Ω–∏–∑–∫–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å'
                    });
                }
                break;

            case SCENARIOS.LATE_EVENING:
                // Light evening protein: cottage cheese case in, kefir
                if (proteinTarget > 10) {
                    const gramsNeeded = Math.round((proteinTarget / 18) * 100); // cottage cheese 18g/100g
                    suggestions.push({
                        product: '–¢–≤–æ—Ä–æ–≥',
                        grams: Math.min(gramsNeeded, 150),
                        reason: '–ö–∞–∑–µ–∏–Ω ‚Äî –º–µ–¥–ª–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫ –Ω–∞ –Ω–æ—á—å'
                    });
                }
                if (carbsTarget > 5) {
                    suggestions.push({
                        product: '–û–≥—É—Ä—Ü—ã',
                        grams: 100,
                        reason: '–ú–∏–Ω–∏–º—É–º –∫–∞–ª–æ—Ä–∏–π, –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è'
                    });
                }
                break;

            case SCENARIOS.PRE_WORKOUT:
                // Fast carbs + some protein
                if (carbsTarget >= 30) {
                    suggestions.push({
                        product: '–ë–∞–Ω–∞–Ω',
                        grams: Math.round((carbsTarget / 23) * 100),
                        reason: '–ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏'
                    });
                }
                if (proteinTarget >= 15) {
                    const gramsNeeded = Math.round((proteinTarget / 13) * 100);
                    suggestions.push({
                        product: '–Ø–π—Ü–∞',
                        grams: Math.min(gramsNeeded, 100),
                        reason: '–õ–µ–≥–∫–æ—É—Å–≤–æ—è–µ–º—ã–π –±–µ–ª–æ–∫'
                    });
                }
                break;

            case SCENARIOS.POST_WORKOUT:
                // High protein + carbs for recovery
                if (proteinTarget >= 25) {
                    const gramsNeeded = Math.round((proteinTarget / 23) * 100);
                    suggestions.push({
                        product: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞',
                        grams: gramsNeeded,
                        reason: '–í—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'
                    });
                }
                if (carbsTarget >= 40) {
                    const gramsNeeded = Math.round((carbsTarget / 23) * 100);
                    suggestions.push({
                        product: '–ë—É—Ä—ã–π —Ä–∏—Å (–≥–æ—Ç–æ–≤—ã–π)',
                        grams: gramsNeeded,
                        reason: '–í–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–ª–∏–∫–æ–≥–µ–Ω–∞'
                    });
                }
                break;

            case SCENARIOS.PROTEIN_DEFICIT:
                // High-protein foods
                if (proteinTarget >= 25) {
                    const gramsNeeded = Math.round((proteinTarget / 23) * 100);
                    suggestions.push({
                        product: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞',
                        grams: gramsNeeded,
                        reason: '–í—ã—Å–æ–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–µ–ª–∫–∞'
                    });
                } else if (proteinTarget >= 15) {
                    const gramsNeeded = Math.round((proteinTarget / 18) * 100);
                    suggestions.push({
                        product: '–¢–≤–æ—Ä–æ–≥',
                        grams: gramsNeeded,
                        reason: '–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫'
                    });
                }
                break;

            case SCENARIOS.STRESS_EATING:
                // Comfort foods with nutrients: dark chocolate, nuts, berries
                suggestions.push({
                    product: '–¢—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥ (70%)',
                    grams: 20,
                    reason: '–ú–∞–≥–Ω–∏–π, –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã, —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω'
                });
                if (proteinTarget > 10) {
                    suggestions.push({
                        product: '–ì—Ä–µ—Ü–∫–∏–µ –æ—Ä–µ—Ö–∏',
                        grams: 30,
                        reason: 'Omega-3, –º–∞–≥–Ω–∏–π, –±–µ–ª–æ–∫'
                    });
                }
                break;

            case SCENARIOS.BALANCED:
            default:
                // Standard suggestions
                if (proteinTarget >= 25) {
                    const gramsNeeded = Math.round((proteinTarget / 23) * 100);
                    suggestions.push({
                        product: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞',
                        grams: gramsNeeded,
                        reason: '–í—ã—Å–æ–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–µ–ª–∫–∞'
                    });
                } else if (proteinTarget >= 15) {
                    const gramsNeeded = Math.round((proteinTarget / 13) * 100);
                    suggestions.push({
                        product: '–Ø–π—Ü–∞',
                        grams: gramsNeeded,
                        reason: '–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫'
                    });
                }

                if (carbsTarget >= 40) {
                    const gramsNeeded = Math.round((carbsTarget / 23) * 100);
                    suggestions.push({
                        product: '–ë—É—Ä—ã–π —Ä–∏—Å (–≥–æ—Ç–æ–≤—ã–π)',
                        grams: gramsNeeded,
                        reason: '–ú–µ–¥–ª–µ–Ω–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã'
                    });
                } else if (carbsTarget >= 20) {
                    const gramsNeeded = Math.round((carbsTarget / 20) * 100);
                    suggestions.push({
                        product: '–ë–∞—Ç–∞—Ç',
                        grams: gramsNeeded,
                        reason: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã, –≤–∏—Ç–∞–º–∏–Ω A'
                    });
                }
                break;
        }

        return suggestions;
    }

    /**
     * Generate reasoning (scenario-aware v2.4)
     * @private
     */
    function generateReasoning(contextAnalysis, timingRec, macrosRec, dayTarget, dayEaten, training) {
        const scenario = contextAnalysis.scenario;
        const reasoning = [];

        // Scenario-specific reasoning (v2.4)
        switch (scenario) {
            case SCENARIOS.GOAL_REACHED:
                reasoning.push('üéØ –î–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ ‚Äî –ø–æ–ø–µ–π –≤–æ–¥—ã üíß');
                reasoning.push('‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–ª–æ—Ä–∏–π —Å–µ–≥–æ–¥–Ω—è!');
                break;

            case SCENARIOS.LIGHT_SNACK:
                reasoning.push(`‚òï –û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ ${Math.round(macrosRec.remainingKcal)} –∫–∫–∞–ª ‚Äî –ª—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å`);
                reasoning.push('‚ú® –í—ã–±–∏—Ä–∞–π –ª—ë–≥–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã: –∫–µ—Ñ–∏—Ä, —Ñ—Ä—É–∫—Ç—ã, –π–æ–≥—É—Ä—Ç');
                break;

            case SCENARIOS.LATE_EVENING:
                reasoning.push(`üåô –ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä (${Math.floor(timingRec.currentTime)}:00)`);
                reasoning.push('ü•õ –õ—ë–≥–∫–∏–π –±–µ–ª–æ–∫ (—Ç–≤–æ—Ä–æ–≥, –∫–µ—Ñ–∏—Ä) ‚Äî –ª—É—á—à–µ –¥–ª—è —Å–Ω–∞');
                reasoning.push('‚ö†Ô∏è –ò–∑–±–µ–≥–∞–π —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ –±–æ–ª—å—à–∏—Ö –ø–æ—Ä—Ü–∏–π');
                break;

            case SCENARIOS.PRE_WORKOUT:
                reasoning.push(`‚ö° –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${Math.round(contextAnalysis.metadata.hoursToTraining * 60)} –º–∏–Ω`);
                reasoning.push('üçå –ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏');
                reasoning.push('ü•ö –ù–µ–º–Ω–æ–≥–æ –±–µ–ª–∫–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º—ã—à—Ü');
                break;

            case SCENARIOS.POST_WORKOUT:
                reasoning.push('üí™ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
                reasoning.push('ü•© –í—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º—ã—à—Ü');
                reasoning.push('üçö –£–≥–ª–µ–≤–æ–¥—ã –¥–ª—è –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≥–ª–∏–∫–æ–≥–µ–Ω–∞');
                break;

            case SCENARIOS.PROTEIN_DEFICIT:
                const proteinProgress = ((dayEaten.protein || 0) / (dayTarget.protein || 120)) * 100;
                reasoning.push(`ü•© –ë–µ–ª–æ–∫: ${Math.round(proteinProgress)}% –æ—Ç —Ü–µ–ª–∏`);
                reasoning.push('üêü –£–¥–µ–ª–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –±–µ–ª–∫–æ–≤—ã–º –ø—Ä–æ–¥—É–∫—Ç–∞–º');
                reasoning.push(`üéØ –ù—É–∂–Ω–æ –¥–æ–±—Ä–∞—Ç—å ${macrosRec.protein}–≥ –±–µ–ª–∫–∞`);
                break;

            case SCENARIOS.STRESS_EATING:
                reasoning.push('‚Äçüßò –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞');
                reasoning.push('üç´ –ó–¥–æ—Ä–æ–≤—ã–µ comfort foods: —Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥, –æ—Ä–µ—Ö–∏, –º–∞–≥–Ω–∏–π');
                reasoning.push('‚òï –ò–ª–∏ —Ç–µ–ø–ª—ã–π —á–∞–π —Å –º—ë–¥–æ–º –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è');
                break;

            case SCENARIOS.BALANCED:
            default:
                // Standard reasoning
                if (timingRec.reason) {
                    reasoning.push(`‚è∞ ${timingRec.reason}`);
                }

                const remainingKcal = macrosRec.remainingKcal || 0;
                if (remainingKcal < 200) {
                    reasoning.push(`‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å ${Math.round(remainingKcal)} –∫–∫–∞–ª`);
                } else {
                    reasoning.push(`‚ÑπÔ∏è –û—Å—Ç–∞–ª–æ—Å—å ${Math.round(remainingKcal)} –∫–∫–∞–ª (${macrosRec.remainingMeals} –ø—Ä–∏—ë–º(–∞) –¥–æ —Å–Ω–∞)`);
                }

                const proteinPercent = ((dayEaten.protein || 0) / (dayTarget.protein || 120)) * 100;
                if (proteinPercent < 80) {
                    reasoning.push(`ü•© –ë–µ–ª–æ–∫: ${Math.round(proteinPercent)}% –æ—Ç —Ü–µ–ª–∏`);
                }

                if (training && training.time) {
                    reasoning.push(`üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ ${training.time}`);
                }
                break;
        }

        return reasoning;
    }

    /**
     * Helper: parse time string to hours (decimal)
     * @private
     */
    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours + (minutes || 0) / 60;
    }

    /**
     * Helper: format decimal hours to HH:MM string
     * @private
     */
    function formatTime(decimalHours) {
        const hours = Math.floor(decimalHours);
        const minutes = Math.round((decimalHours - hours) * 60);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    /**
     * Helper: get current time
     * @private
     */
    function getCurrentTime() {
        const now = new Date();
        return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    // Export API
    HEYS.InsightsPI.mealRecommender = {
        recommend: recommendNextMeal
    };

    console.info(`[${LOG_FILTER}][HEYS.InsightsPI.mealRecommender] ‚úÖ Smart Meal Recommender v3.6.0 initialized (v3.6.0: wave-aware timing + timing sync after planner, 9 scenarios + Phase A/B/C + S9 phenotype auto-detect)`);

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_feedback_loop.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Feedback Loop v1.2.1
 * 
 * Outcome learning: collect user feedback on recommendations and patterns.
 * ML weight adjustment via exponential moving average (EMA).
 * 
 * v1.2.1: extractProductIds handles flat/grouped/multi-meal formats.
 *         Fixes empty productIds in grouped mode (groups[] not extracted).
 * v1.2: Trimmed storage ‚Äî only scenario + productIds stored (not full products).
 *       Max history reduced 100‚Üí50. Size guard: prune if > 200KB.
 *       Fixes localStorage overflow (693KB single key).
 * 
 * Flow:
 * 1. Recommendation given ‚Üí store with ID
 * 2. User follows/ignores ‚Üí track
 * 3. User provides outcome feedback (satiety, energy, mood)
 * 4. ML weight adjustment: EMA (Œ±=0.1, ¬±5% boost/penalty, range 0.5-2.0)
 * 5. Product Picker reads learned weights for scoring
 * 
 * Dependencies: pi_meal_recommender.js, pi_whatif.js
 * @param global
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const STORAGE_KEY_PREFIX = 'heys_insights_feedback_';
    const MAX_HISTORY = 50; // v1.2: was 100, trimmed for localStorage budget
    const MAX_STORAGE_KB = 200; // Max size per feedback key in KB

    /**
     * v1.2.1: Extract product IDs from any recommendation format.
     * Handles flat suggestions, grouped mode, and multi-meal plans.
     * @private
     * @param {object} rec - Recommendation (or recommendation sub-object)
     * @returns {string[]} - Unique product IDs (max 20)
     */
    function extractProductIds(rec) {
        if (!rec) return [];
        var ids = [];

        // Flat suggestions / products
        var suggestions = rec.suggestions || rec.products;
        if (Array.isArray(suggestions)) {
            suggestions.forEach(function (s) {
                var id = s && (s.id || s.product_id || s.productId);
                if (id) ids.push(id);
            });
        }

        // Grouped mode: groups[].products[]
        if (Array.isArray(rec.groups)) {
            rec.groups.forEach(function (g) {
                var prods = g && (g.products || g.items);
                if (Array.isArray(prods)) {
                    prods.forEach(function (p) {
                        var id = p && (p.id || p.product_id || p.productId);
                        if (id) ids.push(id);
                    });
                }
            });
        }

        // Multi-meal: mealPlan[].groups[].products[]
        var mealPlan = rec.mealPlan || rec.meals;
        if (Array.isArray(mealPlan)) {
            mealPlan.forEach(function (meal) {
                if (!meal) return;
                var mGroups = meal.groups;
                if (Array.isArray(mGroups)) {
                    mGroups.forEach(function (g) {
                        var prods = g && (g.products || g.items);
                        if (Array.isArray(prods)) {
                            prods.forEach(function (p) {
                                var id = p && (p.id || p.product_id || p.productId);
                                if (id) ids.push(id);
                            });
                        }
                    });
                }
            });
        }

        // Deduplicate & cap
        var seen = {};
        return ids.filter(function (id) {
            if (seen[id]) return false;
            seen[id] = true;
            return true;
        }).slice(0, 20);
    }

    /**
     * Store recommendation for tracking
     * @param {object} recommendation - Recommendation object
     * @param {string} type - 'meal' | 'whatif' | 'pattern'
     * @param {object} profile
     * @returns {string} - Recommendation ID
     */
    function storeRecommendation(recommendation, type, profile) {
        console.log('[MEALREC][FeedbackLoop] üíæ storeRecommendation called:', {
            type,
            profileId: profile?.id,
            hasRecommendation: !!recommendation
        });

        const recId = generateRecommendationId(type);
        const timestamp = new Date().toISOString();

        // v1.2.1: Extract product IDs from any format (flat, grouped, multi-meal)
        const productIds = extractProductIds(recommendation);

        const record = {
            id: recId,
            type,
            timestamp,
            clientId: profile?.id || 'unknown',
            recommendation: {
                scenario: recommendation?.scenario || 'UNKNOWN',
                productIds: productIds,
                score: recommendation?.score,
                mealType: recommendation?.mealType || recommendation?.meal_type
            },
            followed: null, // Will be updated later
            outcome: null,  // Will be updated later
            context: {
                date: new Date().toISOString().split('T')[0]
            }
        };

        saveRecommendationRecord(record, profile);
        console.log('[MEALREC][FeedbackLoop] ‚úÖ Recommendation stored:', { recId, type });
        return recId;
    }

    /**
     * Mark recommendation as followed/ignored
     * @param {string} recId - Recommendation ID
     * @param {boolean} followed - True if user followed recommendation
     * @param {object} profile
     */
    function markRecommendationFollowed(recId, followed, profile) {
        const record = getRecommendationRecord(recId, profile);
        if (!record) {
            console.warn('[MEALREC][FeedbackLoop] Recommendation not found:', recId);
            return;
        }

        record.followed = followed;
        record.followedAt = new Date().toISOString();

        saveRecommendationRecord(record, profile);
        console.info(`[MEALREC][FeedbackLoop] Recommendation ${recId} marked as ${followed ? 'followed' : 'ignored'}`);
    }

    /**
     * Submit outcome feedback for recommendation
     * @param {string} recId - Recommendation ID
     * @param {object} outcome - User feedback { satiety: 1-5, energy: 1-5, mood: 1-5 }
     * @param {object} profile
     */
    function submitOutcomeFeedback(recId, outcome, profile) {
        const record = getRecommendationRecord(recId, profile);
        if (!record) {
            console.warn('[MEALREC][FeedbackLoop] Recommendation not found:', recId);
            return;
        }

        record.outcome = {
            ...outcome,
            submittedAt: new Date().toISOString()
        };

        saveRecommendationRecord(record, profile);
        console.info('[MEALREC][FeedbackLoop] Outcome feedback submitted for:', recId);

        // Trigger learning update (placeholder for ML integration)
        updateRecommendationWeights(record, profile);
    }

    /**
     * Get recommendation history
     * @param {object} profile
     * @param {number} limit - Max records to return
     * @returns {object[]} - Array of recommendation records
     */
    function getRecommendationHistory(profile, limit = 50) {
        const U = global.HEYS.dayUtils;
        if (!U) return [];

        const storageKey = getStorageKey(profile);
        const history = U.lsGet(storageKey) || [];

        return history.slice(-limit);
    }

    /**
     * Analyze outcomes for pattern reinforcement
     * @param {object} profile
     * @param {number} daysBack - Analyze last N days
     * @returns {object} - Analysis result
     */
    function analyzeOutcomes(profile, daysBack = 7) {
        console.log('[MEALREC][FeedbackLoop] üìä analyzeOutcomes called:', {
            profileId: profile?.id,
            daysBack
        });

        const history = getRecommendationHistory(profile, 100);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - daysBack);

        const recent = history.filter(rec =>
            rec.timestamp && new Date(rec.timestamp) >= cutoff
        );

        const followed = recent.filter(rec => rec.followed === true);
        const withOutcome = followed.filter(rec => rec.outcome);

        const analysis = {
            total: recent.length,
            followed: followed.length,
            followRate: recent.length > 0 ? (followed.length / recent.length) : 0,
            withFeedback: withOutcome.length,
            feedbackRate: followed.length > 0 ? (withOutcome.length / followed.length) : 0,
            avgSatiety: 0,
            avgEnergy: 0,
            avgMood: 0,
            positiveOutcomes: 0,
            recommendations: {}
        };

        // Calculate averages
        if (withOutcome.length > 0) {
            let totalSatiety = 0, totalEnergy = 0, totalMood = 0;

            withOutcome.forEach(rec => {
                totalSatiety += rec.outcome.satiety || 0;
                totalEnergy += rec.outcome.energy || 0;
                totalMood += rec.outcome.mood || 0;

                // Positive outcome: satiety >= 4, energy >= 4, mood >= 4
                if ((rec.outcome.satiety || 0) >= 4 &&
                    (rec.outcome.energy || 0) >= 4 &&
                    (rec.outcome.mood || 0) >= 4) {
                    analysis.positiveOutcomes++;
                }
            });

            analysis.avgSatiety = Math.round((totalSatiety / withOutcome.length) * 10) / 10;
            analysis.avgEnergy = Math.round((totalEnergy / withOutcome.length) * 10) / 10;
            analysis.avgMood = Math.round((totalMood / withOutcome.length) * 10) / 10;
        }

        console.log('[MEALREC][FeedbackLoop] ‚úÖ Analysis complete:', {
            total: analysis.total,
            followed: analysis.followed,
            positiveOutcomes: analysis.positiveOutcomes,
            avgSatiety: analysis.avgSatiety
        });

        return analysis;
    }

    /**
     * Update recommendation weights based on outcomes
     * Uses exponential moving average to adjust product scoring weights
     * @private
     */
    function updateRecommendationWeights(record, profile) {
        const outcome = record.outcome;
        if (!outcome) {
            console.warn('[MEALREC][FeedbackLoop] ‚ö†Ô∏è No outcome data, skipping weight update');
            return;
        }

        // Handle quick feedback (üëç/üëé) vs full outcome (satiety/energy/mood)
        let isPositive;
        let avgScore;

        if (outcome.quickRating !== undefined) {
            // Quick feedback: 1 = positive (üëç), -1 = negative (üëé)
            isPositive = outcome.quickRating === 1;
            avgScore = isPositive ? 5 : 2; // Map to outcome scale for logging
        } else {
            // Full outcome: calculate average of 3 dimensions
            avgScore = (outcome.satiety + outcome.energy + outcome.mood) / 3;
            isPositive = avgScore >= 3.5;
        }

        console.info('[MEALREC][FeedbackLoop] üßÆ Processing outcome:', {
            type: outcome.quickRating !== undefined ? 'quick' : 'full',
            avgScore: avgScore.toFixed(2),
            isPositive,
            quickRating: outcome.quickRating,
            satiety: outcome.satiety,
            energy: outcome.energy,
            mood: outcome.mood
        });

        // Extract features from recommendation
        const recommendation = record.recommendation;
        if (!recommendation) {
            console.warn('[MEALREC][FeedbackLoop] ‚ö†Ô∏è No recommendation data in record');
            return;
        }

        const scenario = recommendation.scenario || 'UNKNOWN';
        // v1.2.1: Support trimmed (productIds), flat (suggestions), grouped, multi-meal
        var productIds = recommendation.productIds;
        if (!productIds || productIds.length === 0) {
            productIds = extractProductIds(recommendation);
        }

        if (productIds.length === 0) {
            console.warn('[MEALREC][FeedbackLoop] ‚ö†Ô∏è Cannot extract product IDs from recommendation');
            return;
        }

        console.info('[MEALREC][FeedbackLoop] üì¶ Adjusting weights for:', {
            scenario,
            productCount: productIds.length,
            recId: record.id
        });

        // Load current weights
        const weights = loadProductWeights(profile);

        // Exponential moving average parameters
        const ALPHA = 0.1; // Learning rate (0.1 = slow, stable learning)
        const BOOST_FACTOR = 1.05; // +5% for positive outcomes
        const PENALTY_FACTOR = 0.95; // -5% for negative outcomes

        const adjustmentFactor = isPositive ? BOOST_FACTOR : PENALTY_FACTOR;
        let updatedCount = 0;

        // Update weights for each product in this scenario
        productIds.forEach(productId => {
            const key = `${scenario}_${productId}`;
            const currentWeight = weights[key] || 1.0;

            // EMA: new_weight = old_weight * (1 - Œ±) + (old_weight * adjustment) * Œ±
            const targetWeight = currentWeight * adjustmentFactor;
            const newWeight = currentWeight * (1 - ALPHA) + targetWeight * ALPHA;

            // Clamp weights to reasonable range [0.5, 2.0]
            const clampedWeight = Math.max(0.5, Math.min(2.0, newWeight));

            weights[key] = clampedWeight;
            updatedCount++;

            console.info(`[MEALREC][FeedbackLoop] üìä ${key}: ${currentWeight.toFixed(3)} ‚Üí ${clampedWeight.toFixed(3)}`);
        });

        // Save updated weights
        saveProductWeights(profile, weights);

        console.info('[MEALREC][FeedbackLoop] ‚úÖ Weights updated:', {
            updatedCount,
            direction: isPositive ? 'boost (+5%)' : 'reduce (-5%)',
            scenario,
            recId: record.id
        });
    }

    /**
     * Load product weights from localStorage
     * @private
     * @returns {object} - Weight map: { "SCENARIO_productId": weight }
     */
    function loadProductWeights(profile) {
        const U = global.HEYS.dayUtils;
        if (!U) return {};

        const storageKey = `heys_meal_rec_weights_${profile?.id || 'default'}`;
        const weights = U.lsGet(storageKey) || {};

        return weights;
    }

    /**
     * Save product weights to localStorage
     * @private
     */
    function saveProductWeights(profile, weights) {
        const U = global.HEYS.dayUtils;
        if (!U) {
            console.warn('[MEALREC][FeedbackLoop] ‚ö†Ô∏è Cannot save weights: dayUtils unavailable');
            return;
        }

        const storageKey = `heys_meal_rec_weights_${profile?.id || 'default'}`;
        U.lsSet(storageKey, weights);

        console.info('[MEALREC][FeedbackLoop] üíæ Weights saved to localStorage:', storageKey);
    }

    /**
     * Get product weight for scoring (used by Product Picker)
     * @param {object} profile
     * @param {string} productId
     * @param {string} scenario
     * @returns {number} - Weight multiplier (default 1.0)
     */
    function getProductWeight(profile, productId, scenario) {
        const weights = loadProductWeights(profile);
        const key = `${scenario}_${productId}`;
        return weights[key] || 1.0;
    }

    /**
     * Get all weights for debugging
     * @param {object} profile
     * @returns {object} - All weights
     */
    function getAllWeights(profile) {
        return loadProductWeights(profile);
    }

    /**
     * Reset weights to default (1.0 for all)
     * @param {object} profile
     */
    function resetWeights(profile) {
        const U = global.HEYS.dayUtils;
        if (!U) return;

        const storageKey = `heys_meal_rec_weights_${profile?.id || 'default'}`;
        U.lsSet(storageKey, {});

        console.info('[MEALREC][FeedbackLoop] üîÑ Weights reset to default');
    }

    /**
     * Generate unique recommendation ID
     * @private
     */
    function generateRecommendationId(type) {
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000);
        return `rec_${type}_${timestamp}_${random}`;
    }

    /**
     * Get storage key for profile
     * @private
     */
    function getStorageKey(profile) {
        const clientId = profile?.id || 'default';
        return `${STORAGE_KEY_PREFIX}${clientId}`;
    }

    /**
     * v1.2: Trim legacy records that stored full recommendation objects.
     * Converts them to trimmed format (scenario + productIds only).
     * @private
     */
    function trimLegacyRecords(history) {
        var trimmed = false;
        for (var i = 0; i < history.length; i++) {
            var rec = history[i];
            if (!rec.recommendation) continue;
            var r = rec.recommendation;
            // Detect legacy format: has full product objects in suggestions/groups/mealPlan
            var hasLegacySug = Array.isArray(r.suggestions) && r.suggestions.length > 0 && typeof r.suggestions[0] === 'object' && r.suggestions[0] !== null;
            var hasLegacyGroups = Array.isArray(r.groups) && r.groups.length > 0;
            var hasLegacyMealPlan = Array.isArray(r.mealPlan || r.meals);
            var hasLegacyProducts = Array.isArray(r.products) && r.products.length > 0 && typeof r.products[0] === 'object' && r.products[0] !== null;
            if (hasLegacySug || hasLegacyGroups || hasLegacyMealPlan || hasLegacyProducts) {
                var productIds = extractProductIds(r);
                rec.recommendation = {
                    scenario: r.scenario || 'UNKNOWN',
                    productIds: productIds,
                    score: r.score,
                    mealType: r.mealType || r.meal_type
                };
                trimmed = true;
            }
        }
        if (trimmed) {
            console.info('[MEALREC][FeedbackLoop] ‚úÖ Migrated legacy records to trimmed format');
        }
        return history;
    }

    /**
     * Save recommendation record to localStorage
     * @private
     */
    function saveRecommendationRecord(record, profile) {
        const U = global.HEYS.dayUtils;
        if (!U) {
            console.warn('[MEALREC][FeedbackLoop] HEYS.dayUtils not available');
            return;
        }

        const storageKey = getStorageKey(profile);
        var history = U.lsGet(storageKey) || [];

        // v1.2: One-time migration ‚Äî trim legacy bloated records
        history = trimLegacyRecords(history);

        // Update existing record or add new
        const existingIndex = history.findIndex(r => r.id === record.id);
        if (existingIndex >= 0) {
            history[existingIndex] = record;
        } else {
            history.push(record);
        }

        // v1.2: Keep last MAX_HISTORY recommendations (was 100)
        if (history.length > MAX_HISTORY) {
            history.splice(0, history.length - MAX_HISTORY);
        }

        // v1.2: Size guard ‚Äî if serialized > MAX_STORAGE_KB, prune oldest half
        var serialized = JSON.stringify(history);
        if (serialized.length > MAX_STORAGE_KB * 1024) {
            var pruneCount = Math.ceil(history.length / 2);
            history.splice(0, pruneCount);
            console.warn('[MEALREC][FeedbackLoop] ‚ö†Ô∏è Pruned ' + pruneCount + ' old records (size guard: ' + Math.round(serialized.length / 1024) + 'KB)');
        }

        U.lsSet(storageKey, history);
    }

    /**
     * Get recommendation record from localStorage
     * @private
     */
    function getRecommendationRecord(recId, profile) {
        const U = global.HEYS.dayUtils;
        if (!U) return null;

        const storageKey = getStorageKey(profile);
        const history = U.lsGet(storageKey) || [];

        return history.find(r => r.id === recId);
    }

    /**
     * Mark reminder as shown (prevent duplicate prompts)
     * @param {string} recId - Recommendation ID
     * @param {number} daysThreshold - Days since recommendation (3, 7, or 14)
     * @param {object} profile
     */
    function markReminderShown(recId, daysThreshold, profile) {
        const record = getRecommendationRecord(recId, profile);
        if (!record) {
            console.warn('[MEALREC][FeedbackLoop] Recommendation not found:', recId);
            return;
        }

        if (!record.reminders) {
            record.reminders = {};
        }

        record.reminders[`day${daysThreshold}`] = {
            shown: true,
            shownAt: new Date().toISOString()
        };

        saveRecommendationRecord(record, profile);
        console.info(`[MEALREC][FeedbackLoop] ‚úÖ Reminder marked as shown:`, { recId, days: daysThreshold });
    }

    /**
     * Get recommendation history (public wrapper)
     * @param {object} profile
     * @returns {object[]} - Array of recommendation records
     */
    function getRecommendationHistoryPublic(profile) {
        return getRecommendationHistory(profile);
    }

    // Export API
    HEYS.InsightsPI.feedbackLoop = {
        storeRecommendation,
        markFollowed: markRecommendationFollowed,
        submitFeedback: submitOutcomeFeedback,
        getHistory: getRecommendationHistory,
        getRecommendationHistory: getRecommendationHistoryPublic,
        analyzeOutcomes,
        markReminderShown,
        // ML Weight API (for Product Picker integration)
        getProductWeight,
        getAllWeights,
        resetWeights
    };

    console.info('[MEALREC][HEYS.InsightsPI.feedbackLoop] ‚úÖ Feedback Loop v1.2.1 initialized (trimmed storage + size guard)');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_outcome_modal.js ===== */
/**
 * HEYS Predictive Insights ‚Äî Outcome Tracking Modal v1.0
 * 
 * –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–±–æ—Ä–∞ feedback –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 3/7/14 –¥–Ω–µ–π.
 * –°–æ–±–∏—Ä–∞–µ—Ç: satiety (–Ω–∞—Å—ã—â–µ–Ω–∏–µ), energy (—ç–Ω–µ—Ä–≥–∏—è), mood (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ) –ø–æ —à–∫–∞–ª–µ 1-5.
 * 
 * Integration: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ HEYS.InsightsPI.outcomeModal.show(recId)
 * Dependencies: ModalManager, feedbackLoop
 */
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    const { React, ReactDOM } = global;
    if (!React || !ReactDOM) {
        console.warn('[OutcomeModal] React/ReactDOM not available');
        return;
    }

    const h = React.createElement;
    const { useState, useEffect } = React;

    const MODAL_ID = 'outcome-tracking-modal';
    const LOG_PREFIX = '[HEYS.outcomeModal]';

    /**
     * Slider Component –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–æ —à–∫–∞–ª–µ 1-5
     */
    function RatingSlider({ label, emoji, value, onChange, name }) {
        const labels = ['–ü–ª–æ—Ö–æ', '–ù–µ–≤–∞–∂–Ω–æ', '–ù–æ—Ä–º–∞–ª—å–Ω–æ', '–•–æ—Ä–æ—à–æ', '–û—Ç–ª–∏—á–Ω–æ'];

        return h('div', { className: 'outcome-modal__field' },
            h('label', { className: 'outcome-modal__label' },
                h('span', { className: 'outcome-modal__emoji' }, emoji),
                ' ',
                label
            ),
            h('div', { className: 'outcome-modal__slider-container' },
                h('input', {
                    type: 'range',
                    min: 1,
                    max: 5,
                    step: 1,
                    value: value,
                    onChange: (e) => onChange(name, parseInt(e.target.value)),
                    className: 'outcome-modal__slider'
                }),
                h('div', { className: 'outcome-modal__value' },
                    h('span', { className: 'outcome-modal__value-number' }, value),
                    ' ‚Äî ',
                    h('span', { className: 'outcome-modal__value-label' }, labels[value - 1])
                )
            )
        );
    }

    /**
     * Outcome Modal Component
     */
    function OutcomeModal({ recId, onSubmit, onClose }) {
        const [values, setValues] = useState({
            satiety: 3,
            energy: 3,
            mood: 3
        });
        const [submitting, setSubmitting] = useState(false);

        // Register with ModalManager
        useEffect(() => {
            const cleanup = global.HEYS.ModalManager?.register?.(MODAL_ID, onClose);
            return cleanup;
        }, [onClose]);

        // Handle keyboard events
        useEffect(() => {
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') onClose();
            };
            document.addEventListener('keydown', handleKeyDown);
            return () => document.removeEventListener('keydown', handleKeyDown);
        }, [onClose]);

        const handleChange = (name, value) => {
            setValues(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = async () => {
            if (submitting) return;

            setSubmitting(true);
            console.info(`[MEALREC]${LOG_PREFIX} ‚úÖ Submitting outcome:`, { recId, values });

            try {
                await onSubmit(recId, values);

                // Show success briefly
                setTimeout(() => {
                    onClose();
                }, 800);
            } catch (error) {
                console.error(`[MEALREC]${LOG_PREFIX} ‚ùå Submit failed:`, error);
                setSubmitting(false);
            }
        };

        const handleBackdropClick = (e) => {
            if (e.target.classList.contains('modal-backdrop')) {
                onClose();
            }
        };

        return h('div', {
            className: 'modal-backdrop outcome-modal-backdrop',
            onClick: handleBackdropClick
        },
            h('div', { className: 'modal-content outcome-modal' },
                // Header
                h('div', { className: 'outcome-modal__header' },
                    h('h3', { className: 'outcome-modal__title' },
                        'üåü –ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å?'
                    ),
                    h('button', {
                        className: 'outcome-modal__close-btn',
                        onClick: onClose,
                        'aria-label': '–ó–∞–∫—Ä—ã—Ç—å'
                    }, '√ó')
                ),

                // Description
                h('p', { className: 'outcome-modal__description' },
                    '–ü–æ–º–æ–≥–∏—Ç–µ –Ω–∞–º —É–ª—É—á—à–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏! –û—Ü–µ–Ω–∏—Ç–µ, –∫–∞–∫ –ø—Ä–æ—à—ë–ª –≤–∞—à –¥–µ–Ω—å –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã —Å–ª–µ–¥–æ–≤–∞–ª–∏ –Ω–∞—à–µ–º—É —Å–æ–≤–µ—Ç—É.'
                ),

                // Form
                h('div', { className: 'outcome-modal__form' },
                    h(RatingSlider, {
                        label: '–ù–∞—Å—ã—â–µ–Ω–∏–µ',
                        emoji: 'üòã',
                        name: 'satiety',
                        value: values.satiety,
                        onChange: handleChange
                    }),
                    h(RatingSlider, {
                        label: '–≠–Ω–µ—Ä–≥–∏—è',
                        emoji: '‚ö°',
                        name: 'energy',
                        value: values.energy,
                        onChange: handleChange
                    }),
                    h(RatingSlider, {
                        label: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
                        emoji: 'üòä',
                        name: 'mood',
                        value: values.mood,
                        onChange: handleChange
                    })
                ),

                // Footer
                h('div', { className: 'outcome-modal__footer' },
                    h('button', {
                        className: 'btn outcome-modal__btn outcome-modal__btn--cancel',
                        onClick: onClose,
                        disabled: submitting
                    }, '–û—Ç–º–µ–Ω–∞'),
                    h('button', {
                        className: 'btn acc outcome-modal__btn outcome-modal__btn--submit',
                        onClick: handleSubmit,
                        disabled: submitting
                    }, submitting ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å ‚úì')
                )
            )
        );
    }

    /**
     * Show outcome modal
     * @param {string} recId - Recommendation ID
     * @param {object} profile - User profile
     * @returns {Promise<object|null>} - Submitted values or null if cancelled
     */
    function show(recId, profile) {
        return new Promise((resolve) => {
            const container = document.createElement('div');
            container.id = 'outcome-modal-container';
            document.body.appendChild(container);

            const handleClose = () => {
                console.info(`[MEALREC]${LOG_PREFIX} ‚èπÔ∏è Modal closed without submission`);
                ReactDOM.unmountComponentAtNode(container);
                document.body.removeChild(container);
                resolve(null);
            };

            const handleSubmit = async (recId, values) => {
                console.info(`[MEALREC]${LOG_PREFIX} üì§ Submitting outcome feedback:`, { recId, values });

                // Submit to feedback loop
                if (global.HEYS.InsightsPI?.feedbackLoop?.submitFeedback) {
                    try {
                        await global.HEYS.InsightsPI.feedbackLoop.submitFeedback(recId, values, profile);
                        console.info(`[MEALREC]${LOG_PREFIX} ‚úÖ Feedback submitted successfully`);
                    } catch (error) {
                        console.error(`[MEALREC]${LOG_PREFIX} ‚ùå Feedback submission failed:`, error);
                        throw error;
                    }
                }

                // Trigger cloud sync
                if (global.HEYS.InsightsPI?.mealRecFeedback?.syncWithCloud) {
                    global.HEYS.InsightsPI.mealRecFeedback.syncWithCloud({
                        reason: 'outcome_submit',
                        clientId: profile?.id
                    }).catch(err => {
                        console.warn(`[MEALREC]${LOG_PREFIX} ‚ö†Ô∏è Cloud sync failed:`, err);
                    });
                }

                ReactDOM.unmountComponentAtNode(container);
                document.body.removeChild(container);
                resolve(values);
            };

            ReactDOM.render(
                h(OutcomeModal, { recId, onSubmit: handleSubmit, onClose: handleClose }),
                container
            );
        });
    }

    /**
     * Check if it's time to show reminder for a recommendation
     * @param {object} record - Feedback record
     * @param {number} daysThreshold - Days since recommendation (3, 7, or 14)
     * @returns {boolean}
     */
    function shouldShowReminder(record, daysThreshold) {
        if (!record || record.outcome) return false; // Already has outcome
        if (!record.followed) return false; // Didn't follow recommendation

        const recDate = new Date(record.timestamp);
        const now = new Date();
        const daysDiff = Math.floor((now - recDate) / (1000 * 60 * 60 * 24));

        return daysDiff >= daysThreshold;
    }

    /**
     * Check for pending reminders and show modal if needed
     * Called on app startup/page load
     * @param {object} profile - User profile
     */
    async function checkPendingReminders(profile) {
        if (!profile?.id) return;

        console.info(`[MEALREC]${LOG_PREFIX} üîî Checking pending reminders for client ${profile.id}`);

        // Get feedback history
        const feedbackLoop = global.HEYS.InsightsPI?.feedbackLoop;
        if (!feedbackLoop) {
            console.warn(`[MEALREC]${LOG_PREFIX} ‚ö†Ô∏è FeedbackLoop module not available`);
            return;
        }

        const history = feedbackLoop.getRecommendationHistory?.(profile);
        if (!history || history.length === 0) return;

        // Check for records needing reminder (3/7/14 days)
        const thresholds = [14, 7, 3]; // Check in reverse order (oldest first)

        for (const threshold of thresholds) {
            const needsReminder = history.find(record =>
                shouldShowReminder(record, threshold) && !record.reminderShown
            );

            if (needsReminder) {
                console.info(`[MEALREC]${LOG_PREFIX} üì¨ Showing ${threshold}-day reminder for:`, needsReminder.id);

                // Mark reminder as shown (prevent duplicate prompts)
                feedbackLoop.markReminderShown?.(needsReminder.id, threshold);

                // Show modal
                await show(needsReminder.id, profile);

                // Show only one reminder at a time
                break;
            }
        }
    }

    // Export API
    HEYS.InsightsPI.outcomeModal = {
        show,
        checkPendingReminders,
        shouldShowReminder,
        MODAL_ID
    };

    console.info(`[MEALREC]${LOG_PREFIX} ‚úÖ Outcome Modal v1.0 loaded`);

    // Auto-check reminders on app ready (after profile loads)
    // Wait 10 seconds to ensure profile and all dependencies are loaded
    setTimeout(() => {
        const profile = global.HEYS?.profile;
        if (profile) {
            checkPendingReminders(profile).catch(err => {
                console.warn(`[MEALREC]${LOG_PREFIX} ‚ö†Ô∏è Auto-check reminders failed:`, err);
            });
        } else {
            console.info(`[MEALREC]${LOG_PREFIX} ‚ÑπÔ∏è Profile not loaded yet, skipping auto-check reminders`);
        }
    }, 10000); // 10 seconds after module load

})(window);


/* ===== insights/pi_meal_rec_feedback.js ===== */
/**
 * Meal Recommender Feedback Module (R2.7 ML)
 * v1.0.0 ‚Äî Machine Learning via User Feedback
 * 
 * –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
 * - –°–±–æ—Ä –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (üëç/üëé)
 * - –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ feedback –≤ localStorage (–ø–æ clientId)
 * - –ê–≥—Ä–µ–≥–∞—Ü–∏—è feedback –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º
 * - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ confidence –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
 * - Exponential Moving Average –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
 * - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (retention: 90 –¥–Ω–µ–π)
 * 
 * –§–æ—Ä–º—É–ª–∞ adjustment:
 * confidence_adjusted = confidence_base √ó adjustment_factor
 * adjustment_factor = 0.5 + (successRate √ó decay)
 * –≥–¥–µ decay = exp(-age/halfLife), halfLife = 14 –¥–Ω–µ–π
 * 
 * @author HEYS Insights Team
 * @since 2026-02-15
 */

(function () {
    'use strict';

    const globalObj = typeof window !== 'undefined' ? window : global;

    if (!globalObj.HEYS) globalObj.HEYS = {};
    if (!globalObj.HEYS.InsightsPI) globalObj.HEYS.InsightsPI = {};
    if (!globalObj.HEYS.InsightsPI.mealRecFeedback) {
        globalObj.HEYS.InsightsPI.mealRecFeedback = {};
    }

    const MODULE_NAME = 'HEYS.InsightsPI.mealRecFeedback';
    const STORAGE_KEY = 'heys_meal_feedback';
    const CLOUD_KV_KEY = 'meal_rec_feedback_v1';
    const RETENTION_DAYS = 90;
    const HALF_LIFE_DAYS = 14; // –ø–µ—Ä–∏–æ–¥ –ø–æ–ª—É—Ä–∞—Å–ø–∞–¥–∞ –¥–ª—è exponential decay

    // Unified logging filter for console filtering
    const LOG_FILTER = 'MEALREC';
    const LOG_PREFIX = `[${LOG_FILTER}][${MODULE_NAME}]`;

    // Cloud sync runtime state (best effort, non-blocking)
    const syncState = {
        lastSyncAt: null,
        lastSyncStatus: 'idle', // idle | syncing | success | error | skipped
        lastSyncReason: null,
        lastError: null,
    };

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π clientId –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
     */
    function getCurrentClientId() {
        try {
            const profile = globalObj.U?.lsGet('heys_profile');
            return profile?.id || null;
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Cannot get clientId:`, err?.message);
            return null;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ cloud KV API
     */
    function canUseCloudKV() {
        return !!(
            globalObj.HEYS?.YandexAPI &&
            typeof globalObj.HEYS.YandexAPI.getKV === 'function' &&
            typeof globalObj.HEYS.YandexAPI.saveKV === 'function'
        );
    }

    /**
     * –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID feedback-–∑–∞–ø–∏—Å–∏
     */
    function makeFeedbackId() {
        return `fb_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
    }

    /**
     * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ feedback (backward compatibility)
     */
    function normalizeFeedbackEntry(item) {
        if (!item || typeof item !== 'object') return null;
        if (!item.timestamp) return null;

        return {
            id: item.id || makeFeedbackId(),
            timestamp: item.timestamp,
            scenario: item.scenario || 'UNKNOWN',
            rating: item.rating === 1 ? 1 : -1,
            products: Array.isArray(item.products) ? item.products : [],
            confidence: Number.isFinite(Number(item.confidence)) ? Number(item.confidence) : 0,
            context: item.context || null,
        };
    }

    /**
     * –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –∏ –æ–±–ª–∞—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –¥—É–±–ª–µ–π
     */
    function mergeHistories(localHistory, cloudHistory) {
        const byId = new Map();
        const byFingerprint = new Set();

        const add = (entry) => {
            const normalized = normalizeFeedbackEntry(entry);
            if (!normalized) return;

            if (normalized.id && byId.has(normalized.id)) return;

            const fingerprint = `${normalized.timestamp}|${normalized.scenario}|${normalized.rating}|${(normalized.products || []).join(',')}`;
            if (byFingerprint.has(fingerprint)) return;

            if (normalized.id) byId.set(normalized.id, normalized);
            byFingerprint.add(fingerprint);
        };

        (localHistory || []).forEach(add);
        (cloudHistory || []).forEach(add);

        return Array.from(byId.values()).sort((a, b) => a.timestamp - b.timestamp);
    }

    /**
     * –ü–æ—Å—Ç—Ä–æ–∏—Ç—å namespace –∫–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (legacy compatibility)
     */
    function buildLegacyStorageKey(clientId) {
        if (!clientId) return STORAGE_KEY;
        return `heys_${clientId}_${STORAGE_KEY}`;
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ feedback –∏–∑ localStorage
     * P2 Fix: Uses U.lsGet with backward-compatible read-through
     */
    function loadFeedbackHistory(clientId) {
        try {
            // Try new U.lsGet approach (namespaced by clientId automatically)
            const U = globalObj.U;
            let data = null;

            if (U && typeof U.lsGet === 'function') {
                data = U.lsGet(STORAGE_KEY); // U.lsGet handles clientId namespace
            }

            // Backward-compatible read: check old key format if no data
            if (!data && clientId) {
                const legacyKey = buildLegacyStorageKey(clientId);
                const raw = localStorage.getItem(legacyKey);
                if (raw) {
                    data = JSON.parse(raw);
                    // Migrate to new format
                    if (U && typeof U.lsSet === 'function') {
                        U.lsSet(STORAGE_KEY, data);
                        localStorage.removeItem(legacyKey); // Clean up old key
                        console.info(`${LOG_PREFIX} üîÑ Migrated feedback from legacy key`);
                    }
                }
            }

            if (!data || !Array.isArray(data)) return [];

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (retention: 90 –¥–Ω–µ–π)
            const now = Date.now();
            const retentionMs = RETENTION_DAYS * 24 * 60 * 60 * 1000;
            const filtered = data
                .map(normalizeFeedbackEntry)
                .filter(Boolean)
                .filter(item => (now - item.timestamp) < retentionMs);

            return filtered;
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Cannot load feedback history:`, err?.message);
            return [];
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å feedback –≤ localStorage
     * P2 Fix: Uses U.lsSet with automatic clientId namespacing
     */
    function saveFeedbackHistory(clientId, feedback) {
        try {
            const U = globalObj.U;
            if (U && typeof U.lsSet === 'function') {
                U.lsSet(STORAGE_KEY, feedback); // U.lsSet handles clientId namespace
            } else {
                // Fallback to direct localStorage (shouldn't happen in production)
                const legacyKey = buildLegacyStorageKey(clientId);
                localStorage.setItem(legacyKey, JSON.stringify(feedback));
            }
        } catch (err) {
            console.error(`${LOG_PREFIX} ‚ùå Cannot save feedback:`, err?.message);
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é feedback –∏–∑ cloud KV (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
     */
    async function loadCloudHistory(clientId) {
        if (!clientId || !canUseCloudKV()) return [];

        try {
            const result = await globalObj.HEYS.YandexAPI.getKV(clientId, CLOUD_KV_KEY);
            if (result?.error) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Cloud getKV failed:`, result.error);
                return [];
            }

            const payload = result?.data;
            if (!payload) return [];

            const cloudItems = Array.isArray(payload?.items)
                ? payload.items
                : Array.isArray(payload)
                    ? payload
                    : [];

            return cloudItems.map(normalizeFeedbackEntry).filter(Boolean);
        } catch (err) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Cloud history load error:`, err?.message);
            return [];
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é feedback –≤ cloud KV (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
     */
    async function saveCloudHistory(clientId, history, reason = 'manual') {
        if (!clientId || !canUseCloudKV()) return { success: false, skipped: true };

        try {
            const payload = {
                version: '1.1.0',
                updatedAt: Date.now(),
                reason,
                items: Array.isArray(history) ? history : [],
            };

            const result = await globalObj.HEYS.YandexAPI.saveKV(clientId, CLOUD_KV_KEY, payload);
            if (!result?.success) {
                return { success: false, error: result?.error || 'Unknown saveKV error' };
            }

            return { success: true };
        } catch (err) {
            return { success: false, error: err?.message || 'Cloud save failed' };
        }
    }

    /**
     * –í—ã–ø–æ–ª–Ω–∏—Ç—å cloud sync (pull + merge + push), –Ω–µ –ª–æ–º–∞—è –ª–æ–∫–∞–ª—å–Ω—ã–π UX
     */
    async function syncWithCloud(options = {}) {
        const reason = options.reason || 'manual';
        const clientId = options.clientId || getCurrentClientId();

        if (!clientId) {
            syncState.lastSyncStatus = 'skipped';
            syncState.lastSyncReason = reason;
            syncState.lastError = 'No clientId';
            console.info(`${LOG_PREFIX} ‚ÑπÔ∏è Cloud sync skipped: no clientId`);
            return { success: false, skipped: true, reason: 'no_client' };
        }

        if (!canUseCloudKV()) {
            syncState.lastSyncStatus = 'skipped';
            syncState.lastSyncReason = reason;
            syncState.lastError = 'YandexAPI KV unavailable';
            console.info(`${LOG_PREFIX} ‚ÑπÔ∏è Cloud sync skipped: YandexAPI KV unavailable`);
            return { success: false, skipped: true, reason: 'no_api' };
        }

        syncState.lastSyncStatus = 'syncing';
        syncState.lastSyncReason = reason;
        syncState.lastError = null;

        try {
            const localHistory = loadFeedbackHistory(clientId);
            const cloudHistory = await loadCloudHistory(clientId);
            const merged = mergeHistories(localHistory, cloudHistory);

            saveFeedbackHistory(clientId, merged);

            const pushResult = await saveCloudHistory(clientId, merged, reason);
            if (!pushResult.success) {
                syncState.lastSyncStatus = 'error';
                syncState.lastError = pushResult.error || 'push failed';
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Cloud sync push failed:`, pushResult.error);
                return { success: false, error: pushResult.error || 'push failed' };
            }

            syncState.lastSyncStatus = 'success';
            syncState.lastSyncAt = Date.now();
            syncState.lastError = null;

            console.info(`${LOG_PREFIX} ‚úÖ Cloud sync completed:`, {
                reason,
                localCount: localHistory.length,
                cloudCount: cloudHistory.length,
                mergedCount: merged.length,
            });

            return {
                success: true,
                localCount: localHistory.length,
                cloudCount: cloudHistory.length,
                mergedCount: merged.length,
            };
        } catch (err) {
            syncState.lastSyncStatus = 'error';
            syncState.lastError = err?.message || 'sync failed';
            console.error(`${LOG_PREFIX} ‚ùå Cloud sync error:`, err?.message);
            return { success: false, error: err?.message || 'sync failed' };
        }
    }

    /**
     * –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
     */
    function getSyncStatus() {
        return {
            ...syncState,
        };
    }

    /**
     * –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π feedback
     * @param {Object} feedbackData - –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
     * @param {string} feedbackData.scenario - –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
     * @param {number} feedbackData.rating - 1 (üëç) –∏–ª–∏ -1 (üëé)
     * @param {Array<string>} feedbackData.products - –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     * @param {number} feedbackData.confidence - –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è confidence
     * @param {Object} feedbackData.context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
     * @param {string} [feedbackData.clientId] - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π clientId (fallback –∫ –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é)
     */
    function addFeedback(feedbackData) {
        const clientId = feedbackData.clientId || getCurrentClientId();
        if (!clientId) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Cannot add feedback: no clientId`);
            return false;
        }

        if (!feedbackData || !feedbackData.scenario || !feedbackData.rating) {
            console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Invalid feedback data:`, feedbackData);
            return false;
        }

        try {
            const history = loadFeedbackHistory(clientId);
            const newEntry = {
                id: makeFeedbackId(),
                timestamp: Date.now(),
                scenario: feedbackData.scenario,
                rating: feedbackData.rating, // 1 or -1
                products: feedbackData.products || [],
                confidence: feedbackData.confidence || 0,
                context: feedbackData.context || null
            };

            history.push(newEntry);
            saveFeedbackHistory(clientId, history);

            console.info(`${LOG_PREFIX} ‚úÖ Feedback added:`, {
                scenario: newEntry.scenario,
                rating: newEntry.rating === 1 ? 'üëç' : 'üëé',
                totalFeedback: history.length
            });

            // Best-effort cloud sync, no blocking UI
            syncWithCloud({ clientId, reason: 'add_feedback' })
                .catch((err) => console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Async sync failed:`, err?.message));

            return true;
        } catch (err) {
            console.error(`${LOG_PREFIX} ‚ùå Cannot add feedback:`, err?.message);
            return false;
        }
    }

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å adjustment factor –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ feedback
     * @param {string} scenario - –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
     * @param {Array} history - –ò—Å—Ç–æ—Ä–∏—è feedback (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ null - –∑–∞–≥—Ä—É–∑–∏—Ç —Å–∞–º)
     * @returns {number} - Adjustment factor (0.5-1.5)
     */
    function calculateAdjustmentFactor(scenario, history = null) {
        const clientId = getCurrentClientId();
        if (!clientId) return 1.0; // neutral –µ—Å–ª–∏ –Ω–µ—Ç clientId

        if (!history) {
            history = loadFeedbackHistory(clientId);
        }

        if (!history || history.length === 0) {
            return 1.0; // neutral –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º feedback –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        const scenarioFeedback = history.filter(item => item.scenario === scenario);
        if (scenarioFeedback.length === 0) {
            return 1.0; // neutral –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        }

        // –í—ã—á–∏—Å–ª—è–µ–º weighted success rate —Å exponential decay
        const now = Date.now();
        const halfLifeMs = HALF_LIFE_DAYS * 24 * 60 * 60 * 1000;

        let weightedSum = 0;
        let weightTotal = 0;

        scenarioFeedback.forEach(item => {
            const age = now - item.timestamp;
            const decay = Math.exp(-age / halfLifeMs); // exponential decay
            const weight = decay;
            const score = item.rating === 1 ? 1 : 0; // 1 –¥–ª—è üëç, 0 –¥–ª—è üëé

            weightedSum += score * weight;
            weightTotal += weight;
        });

        if (weightTotal === 0) return 1.0;

        const successRate = weightedSum / weightTotal; // 0.0-1.0

        // Adjustment factor: 0.5-1.5 (–±–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω)
        // successRate=1.0 (–≤—Å–µ üëç) ‚Üí adjustment=1.5
        // successRate=0.5 (50/50) ‚Üí adjustment=1.0
        // successRate=0.0 (–≤—Å–µ üëé) ‚Üí adjustment=0.5
        const adjustmentFactor = 0.5 + (successRate * 1.0);

        console.info(`${LOG_PREFIX} üìä Adjustment calculated:`, {
            scenario,
            feedbackCount: scenarioFeedback.length,
            successRate: successRate.toFixed(2),
            adjustmentFactor: adjustmentFactor.toFixed(2)
        });

        return adjustmentFactor;
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É feedback –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
     */
    function getFeedbackStats() {
        const clientId = getCurrentClientId();
        if (!clientId) return null;

        const history = loadFeedbackHistory(clientId);
        if (!history || history.length === 0) {
            return {
                totalFeedback: 0,
                scenarios: {}
            };
        }

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º
        const scenarios = {};
        history.forEach(item => {
            if (!scenarios[item.scenario]) {
                scenarios[item.scenario] = {
                    total: 0,
                    positive: 0,
                    negative: 0,
                    successRate: 0,
                    adjustment: 1.0
                };
            }
            scenarios[item.scenario].total++;
            if (item.rating === 1) scenarios[item.scenario].positive++;
            if (item.rating === -1) scenarios[item.scenario].negative++;
        });

        // –í—ã—á–∏—Å–ª—è–µ–º success rate –∏ adjustment –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        Object.keys(scenarios).forEach(scenario => {
            const stats = scenarios[scenario];
            stats.successRate = stats.total > 0 ? (stats.positive / stats.total) : 0;
            stats.adjustment = calculateAdjustmentFactor(scenario, history);
        });

        return {
            totalFeedback: history.length,
            scenarios
        };
    }

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é feedback (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
     */
    function clearFeedbackHistory() {
        const clientId = getCurrentClientId();
        if (!clientId) return false;

        try {
            const U = globalObj.U;
            if (U && typeof U.lsSet === 'function') {
                U.lsSet(STORAGE_KEY, null);
            } else {
                const legacyKey = buildLegacyStorageKey(clientId);
                localStorage.removeItem(legacyKey);
            }
            console.info(`${LOG_PREFIX} ‚úÖ Feedback history cleared`);
            return true;
        } catch (err) {
            console.error(`${LOG_PREFIX} ‚ùå Cannot clear feedback:`, err?.message);
            return false;
        }
    }

    // Initial cloud bootstrap (non-blocking): pull+merge+push once on module load
    setTimeout(() => {
        syncWithCloud({ reason: 'bootstrap' })
            .catch((err) => console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Bootstrap sync failed:`, err?.message));
    }, 0);

    // –ü—É–±–ª–∏—á–Ω–æ–µ API
    globalObj.HEYS.InsightsPI.mealRecFeedback = {
        addFeedback,
        calculateAdjustmentFactor,
        getFeedbackStats,
        clearFeedbackHistory,
        syncWithCloud,
        getSyncStatus,
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        _loadHistory: loadFeedbackHistory,
        _saveHistory: saveFeedbackHistory,
        _getCurrentClientId: getCurrentClientId,
        _mergeHistories: mergeHistories,
    };

    console.info(`${LOG_PREFIX} üì¶ Module loaded (v1.1.0 hybrid local+cloud)`);
})();


/* ===== insights/pi_ui_meal_rec_card.js ===== */
/**
 * Meal Recommender Card ‚Äî Compact UI for Day View
 * v27.8 ‚Äî useMemo dep stabilization + render log throttle
 * –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ
 * –ü–æ–∑–∏—Ü–∏—è: –º–µ–∂–¥—É refeedCard –∏ supplementsCard (–≤—ã—à–µ –≤–∏—Ç–∞–º–∏–Ω–æ–≤)
 * 
 * v27.7 changes (18.02.2026):
 * - ENHANCED: Multi-meal subtitle now shows friendly prompt:
 *   "–ù–µ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–µ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è? –£–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–¥—Å–∫–∞–∂–µ—Ç –≤–∞–º. 
 *    –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å –µ–≥–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º, –∏ –≤–∞—à –¥–µ–Ω—å –±—É–¥–µ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–º –ø–æ –ø–∏—Ç–∞–Ω–∏—é!"
 * - REASONING: More engaging and informative introduction to the smart planner feature
 * 
 * v27.5 changes (17.02.2026):
 * - NEW: Bulk add button "–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" after grouped products
 * - STATES: Gray dashed border (no selection) ‚Üí Blue solid bg+border (has selection)
 * - FUNCTION: handleAddSelectedProducts() ‚Äî adds all checked products sequentially
 * - UI: Shows count "(3)" when products selected, disabled when none
 * - REASONING: Increased font size (12px), darker color, no background (transparent)
 * 
 * v27.4 changes (17.02.2026):
 * - SEPARATED: Product selection (card click) from adding to meal (+ button click)
 * - NEW: Round green + button on the right side of each product card
 * - Card click: Visual selection only (toggle green border/bg, no auto-add)
 * - Button click: Adds product to current meal via handleAddSuggestion
 * - Button style: 28px circle, green bg, hover scale 1.1, active scale 0.9
 * - CSS: .meal-rec-card__product-add-btn (consistent with __suggestion-add)
 * 
 * v27.3 changes (17.02.2026):
 * - REMOVED: Checkboxes (replaced with full-card click like vitamins)
 * - NEW: Clickable product cards with border + box-shadow when selected
 * - SELECTED state: Green border (#10b981) + light green bg + 2px shadow (light/dark theme)
 * - REDUCED: Gap between products (2px‚Üí6px for better click targets)
 * - IMPROVED: Hover states with border color change
 * - Toggle behavior: Click to select, click again to deselect (visual only, products remain in meal)
 * - CSS: .meal-rec-card__product-item, __product-item--selected (vitamin pattern)
 * 
 * v26.3 changes (17.02.2026):
 * - Fixed: pIndex now properly passed to buildRecommendationContext
 * - Fixed: lastMealTotals computed from items (was broken in v26.2)
 * 
 * v26.2 changes (17.02.2026):
 * - Fixed: lastMealTotals now computed from lastMeal.items using HEYS.models.mealTotals
 * - Fallback: manual calculation if mealTotals unavailable
 * - Now properly passes nutrient data to InsulinWave.calculate()
 * 
 * v26.1 changes:
 * - Fixed: lastMeal now includes items[] and totals{} (was only time)
 * - Fixed: dayTarget/dayEaten now include fat macros + aliases (prot/carb)
 * - Enhanced logging: shows lastMealItems, lastMealTotals in context
 * 
 * v26 features:
 * - Multi-meal timeline planning (via pi_meal_planner.js)
 * - Insulin wave-aware scheduling: meals after wave ends + 30min fat-burn window
 * - Pre-sleep buffer (3h): last meal before bedtime
 * - Budget distribution across N meals (ratios: 2=[60/40], 3=[45/35/20], 4=[35/30/20/15])
 * - Collapsed state: "2 –ø—Ä–∏—ë–º–∞ –¥–æ —Å–Ω–∞ ¬∑ 18:30-22:30"
 * - Expanded state: Sub-cards for each meal with wave info + macros
 * - Only first meal actionable (shows [+] buttons), others show "(–¥–æ–±–∞–≤–∏—Ç—å –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ)"
 * - Summary macros: shows totals across all meals
 * 
 * v25.9.2 (previous):
 * - UX: green card background, '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º' badge, friendlier copy
 * 
 * v2.4 features:
 * - Scenario-specific icons and titles
 * - Conditional rendering for GOAL_REACHED (water instead of macros)
 * - Adaptive header text based on detected scenario
 * 
 * v2.6 features (R2.6):
 * - Historical days loading (30d from localStorage)
 * - Deep Insights enhancement via pi_meal_rec_patterns.js
 * - Dynamic confidence display (0.5-1.0)
 * 
 * v2.7-2.9 fixes:
 * - Added resolveLsGet() with localStorage fallback
 * - Fixed parameter order: recommend(context, profile, pIndex, days)
 * - Fixed profile/pIndex parameters
 * 
 * v21-23 (deprecated):
 * - Custom meal picker modal with time + "Add new meal" button
 * - REMOVED: Users cannot add food to past meals, modal was unnecessary UX
 * 
 * v24 (deprecated):
 * - Smart active meal detection: use last meal if created < 30 min ago
 * - Removed modal entirely ‚Äî caused flash before auto-selection
 * 
 * v25.0:
 * - Intentional modal with 2 buttons:
 *   1. Active meal (< 30 min): "ü•ó –ü–µ—Ä–µ–∫—É—Å ‚Ä¢ 13:55 ‚Ä¢ 2 –ø—Ä–æ–¥—É–∫—Ç–∞ ‚Ä¢ 12 –º–∏–Ω –Ω–∞–∑–∞–¥"
 *   2. Create new meal: "‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º"
 * - If no active meal (> 30 min): show only "Create new meal" button
 * - Eliminates flash issue: modal shown deliberately, not as async side-effect
 * 
 * v25.1:
 * - Empty meal support: shows "–ø—É—Å—Ç–æ–π ‚Ä¢ X –º–∏–Ω –Ω–∞–∑–∞–¥" instead of "0 –ø—Ä–æ–¥—É–∫—Ç–æ–≤"
 * - Active meal shown even if empty (no items added yet)
 * 
 * v25.2:
 * - FIX: New meal index calculation (was `length`, now `length - 1`)
 * - Products now correctly added to created meal
 * 
 * v25.3:
 * - FIX: Use `HEYS.day.meals.length` instead of closure `day` variable
 * - Closure `day` is stale after addMeal(), global object is fresh
 * 
 * v25.4:
 * - FIX: Read from localStorage with retry logic (3 attempts, 50-150ms)
 * - Handle async React state ‚Üí localStorage sync delay
 * 
 * v25.5:
 * - FIX: Extended retry (5 attempts √ó 100-500ms = 1500ms max)
 * - Still insufficient: localStorage updates async via fetchDays
 * 
 * v25.6:
 * - FIX: Changed to setInterval polling (every 100ms up to 3000ms)
 * - Still failed: 30 attempts all returned mealsCount: 0
 * 
 * v25.7:
 * - FIX: Poll `HEYS.day.meals` directly instead of localStorage
 * - React state updates synchronously, localStorage updates async
 * - Faster polling: 50ms intervals, 2s max wait
 * - FAILED: `HEYS.day` doesn't exist (hasHEYSDay: false in all 37 attempts)
 * 
 * v25.8 (2026-02-17):
 * - FIX: Use `HEYS.MealStep.showAddMeal()` ‚Äî reuse FAB button logic
 * - Same mechanism as working "+ –ü—Ä–∏—ë–º –ø–∏—â–∏" button
 * - No polling needed: onComplete callback provides mealIndex immediately
 * 
 * v25.8.1 (2026-02-17):
 * - CRITICAL FIX: Missing return after showAddMeal() in empty day case
 * - Caused "Cannot read property 'time' of undefined" ‚Üí module crash
 * - Removed orphaned code that modified button style after modal removal
 * 
 * v25.8.2 (2026-02-17):
 * - FIX: Missing 'date' variable definition ‚Üí showAddMeal received undefined dateKey
 * - Added detailed logging of all parameters before MealStep call
 * - Added try-catch for error handling in MealStep invocation
 * 
 * v25.8.3 (2026-02-17):
 * - FIX: Dispatch 'heys:day-updated' event after product added
 * - Meal created successfully but page didn't re-render ‚Üí React state not updated
 * - Forces parent component to refresh and show new meal in diary
 * 
 * v25.8.4 (current - 2026-02-17):
 * - FIX: Add 300ms delay before dispatching event
 * - Event fired too early ‚Üí MealStep hasn't saved to localStorage yet
 * - handleDayUpdated checks updatedAt timestamp before updating state
 */
(function (global) {
    'use strict';

    const { React } = global;
    if (!React) return;

    const h = React.createElement;
    const { useState, useMemo, useRef, useEffect } = React;
    const LOG_FILTER = 'MEALREC';
    const LOG_PREFIX = `[${LOG_FILTER}][HEYS.mealRec.card]`;

    /**
     * Fallback lsGet ‚Äî –ø—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ –∏–∑ localStorage (–µ—Å–ª–∏ global.U –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
     */
    function buildLocalStorageFallbackLsGet() {
        return function (key, fallback = null) {
            try {
                const raw = localStorage.getItem(key);
                if (raw === null || raw === undefined) return fallback;
                return JSON.parse(raw);
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è localStorage fallback read failed:`, {
                    key,
                    message: err?.message,
                });
                return fallback;
            }
        };
    }

    /**
     * Resolve lsGet function (try global.U, then global.HEYS.utils, then fallback)
     */
    function resolveLsGet() {
        if (typeof global.U?.lsGet === 'function') return global.U.lsGet.bind(global.U);
        if (typeof global.HEYS?.utils?.lsGet === 'function') return global.HEYS.utils.lsGet.bind(global.HEYS.utils);
        return buildLocalStorageFallbackLsGet();
    }

    /**
     * –°–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è recommend() –∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
     */
    function buildRecommendationContext(day, dayTot, normAbs, prof, optimum, pIndex) {
        console.info(`${LOG_PREFIX} üîç buildContext called:`, {
            hasDay: !!day,
            hasDayTot: !!dayTot,
            hasNormAbs: !!normAbs,
            hasProf: !!prof,
            mealsCount: day?.meals?.length || 0,
            trainingsCount: day?.trainings?.length || 0
        });

        if (!day || !dayTot || !normAbs) {
            console.warn(`${LOG_PREFIX} ‚ùå Missing required data:`, {
                hasDay: !!day,
                hasDayTot: !!dayTot,
                hasNormAbs: !!normAbs
            });
            return null;
        }

        const currentTime = new Date();
        const currentHour = currentTime.getHours();
        const currentMinute = currentTime.getMinutes();
        const currentTimeStr = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`;

        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏
        const meals = day.meals || [];
        const lastMeal = meals.length > 0 ? meals[meals.length - 1] : null;

        // –í—ã—á–∏—Å–ª–∏—Ç—å totals –¥–ª—è lastMeal (–µ—Å–ª–∏ –µ—Å—Ç—å items)
        let lastMealTotals = null;
        if (lastMeal && lastMeal.items && lastMeal.items.length > 0) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.models.mealTotals –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            if (global.HEYS?.models?.mealTotals && pIndex) {
                lastMealTotals = global.HEYS.models.mealTotals(lastMeal, pIndex);
            } else {
                // Fallback: –≤—ã—á–∏—Å–ª—è–µ–º –≤—Ä—É—á–Ω—É—é
                lastMealTotals = { kcal: 0, prot: 0, carbs: 0, carb: 0, fat: 0 };
                lastMeal.items.forEach(item => {
                    const product = pIndex[item.productId];
                    if (product) {
                        const factor = (item.grams || 0) / 100;
                        lastMealTotals.kcal += (product.kcal || 0) * factor;
                        lastMealTotals.prot += (product.prot || 0) * factor;
                        lastMealTotals.carbs += (product.carb || 0) * factor;
                        lastMealTotals.carb += (product.carb || 0) * factor;
                        lastMealTotals.fat += (product.fat || 0) * factor;
                    }
                });
            }
        }

        // –ë–ª–∏–∂–∞–π—à–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
        const trainings = day.trainings || [];
        const training = trainings.length > 0 ? trainings[0] : null;

        // –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è —Å–Ω–∞
        const sleepTarget = prof?.sleepTarget || '23:00';

        const resolvedLsGet =
            (typeof global.U?.lsGet === 'function' && global.U.lsGet.bind(global.U)) ||
            (typeof global.HEYS?.utils?.lsGet === 'function' && global.HEYS.utils.lsGet.bind(global.HEYS.utils)) ||
            function (key, fallback = null) {
                try {
                    const raw = localStorage.getItem(key);
                    if (raw === null || raw === undefined) return fallback;
                    return JSON.parse(raw);
                } catch (err) {
                    console.warn(`${LOG_PREFIX} ‚ö†Ô∏è localStorage fallback read failed:`, { key, message: err?.message });
                    return fallback;
                }
            };

        const context = {
            currentTime: currentTimeStr,
            lastMeal: lastMeal ? {
                time: lastMeal.time,
                items: lastMeal.items || [],
                totals: lastMealTotals || {}
            } : null,
            dayTarget: {
                kcal: optimum || normAbs.kcal || 0,
                protein: normAbs.prot || 0,
                carbs: normAbs.carb || 0,
                fat: normAbs.fat || 0,
                // Aliases for planner
                prot: normAbs.prot || 0,
                carb: normAbs.carb || 0
            },
            dayEaten: {
                kcal: dayTot.kcal || 0,
                protein: dayTot.prot || 0,
                carbs: dayTot.carb || 0,
                fat: dayTot.fat || 0,
                // Aliases for planner
                prot: dayTot.prot || 0,
                carb: dayTot.carb || 0
            },
            training: training ? {
                time: training.time,
                type: training.type || 'general'
            } : null,
            sleepTarget,
            lsGet: resolvedLsGet,
            sharedProducts: global.HEYS?.products?.getAll?.() || []
        };

        console.info(`${LOG_PREFIX} ‚úÖ Context built:`, {
            currentTime: currentTimeStr,
            lastMealTime: lastMeal?.time || 'none',
            lastMealItems: lastMeal?.items?.length || 0,
            lastMealTotals: lastMealTotals,
            mealsToday: meals.length,
            dayEaten: `${Math.round(dayTot.kcal)}–∫–∫–∞–ª, ${Math.round(dayTot.prot)}–≥ –±–µ–ª–∫–∞`,
            dayTarget: `${Math.round(optimum || normAbs.kcal)}–∫–∫–∞–ª (optimum=${optimum || 'N/A'}, normAbs=${normAbs.kcal}), ${Math.round(normAbs.prot)}–≥ –±–µ–ª–∫–∞`,
            hasTraining: !!training,
            trainingTime: training?.time || 'none',
            hasLsGet: typeof context.lsGet === 'function',
            sharedProductsCount: context.sharedProducts.length
        });

        return context;
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è UI
     */
    function formatTime(timeStr) {
        if (!timeStr) return '‚Äî';
        return timeStr; // —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –º–∞–∫—Ä–æ—Å–æ–≤
     */
    function formatMacroRange(value, range) {
        if (!range) return `${Math.round(value)}`;
        return `${range}`;
    }

    /**
     * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
     */
    // P3-card: render counter for log throttle (suppresses duplicate card render logs)
    var _mealRecCardRenderCount = 0;

    function MealRecommenderCard({ React, day, prof, pIndex, dayTot, normAbs, optimum }) {
        const [expanded, setExpanded] = useState(false);
        const [userFeedback, setUserFeedback] = useState(null); // null | 'positive' | 'negative'
        const [checkedProducts, setCheckedProducts] = useState({}); // v27: { productId: boolean } for grouped mode
        const [thresholdsUpdateTick, setThresholdsUpdateTick] = useState(0); // v28: SWR trigger
        const [recommendation, setRecommendation] = useState(null); // üöÄ PERF v6.0: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç
        const [isCalculating, setIsCalculating] = useState(true); // üöÄ PERF v6.0: –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏

        // Listen for SWR background updates
        useEffect(() => {
            const handleThresholdsUpdate = (e) => {
                console.info(`${LOG_PREFIX} ‚ö° SWR: Received heysThresholdsUpdated event, triggering re-render`);
                setThresholdsUpdateTick(t => t + 1);
            };
            window.addEventListener('heysThresholdsUpdated', handleThresholdsUpdate);
            return () => window.removeEventListener('heysThresholdsUpdated', handleThresholdsUpdate);
        }, []);

        // v25.8.2: Use U.getProductFromItem if not passed in props
        const getProductFromItem = global.U?.getProductFromItem || global.HEYS?.getProductFromItem || (() => null);

        // R2.7: Store recommendation ID for ML feedback loop
        const recIdRef = useRef(null);

        // v3.6: F4 ‚Äî heys_profile has no .id; always inject currentClientId for feedbackLoop calls
        const getProfileWithId = () => prof
            ? { ...prof, id: prof?.id || global.HEYS?.currentClientId || 'default' }
            : (global.HEYS?.currentClientId ? { id: global.HEYS.currentClientId } : null);
        const followedRef = useRef(false);
        const prevRecommendationRef = useRef(null);

        // Stable primitive deps to prevent excessive re-renders (30+ ‚Üí ~3)
        const mealsCount = day?.meals?.length || 0;
        const lastMealTime = day?.meals?.[mealsCount - 1]?.time || '';
        const eatenKcal = Math.round(dayTot?.kcal || 0);
        const eatenProt = Math.round(dayTot?.prot || 0);
        const targetKcal = Math.round(optimum || normAbs?.kcal || 0);
        const targetProt = Math.round(normAbs?.prot || 0);

        // Handler –¥–ª—è feedback –∫–Ω–æ–ø–æ–∫ (R2.7)
        const handleFeedback = (rating) => {
            if (!global.HEYS?.InsightsPI?.mealRecFeedback) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Feedback module not loaded`);
                return;
            }

            if (!recommendation) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è No recommendation to give feedback on`);
                return;
            }

            const feedbackData = {
                scenario: recommendation.scenario || 'UNKNOWN',
                rating: rating, // 1 for üëç, -1 for üëé
                products: (recommendation.suggestions || []).map(s => s.product),
                confidence: recommendation.confidence || 0,
                clientId: global.HEYS?.currentClientId, // –Ø–≤–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º clientId
                context: {
                    time: new Date().toISOString(),
                    mealsCount: mealsCount,
                    eatenKcal: eatenKcal,
                    targetKcal: targetKcal
                }
            };

            const success = global.HEYS.InsightsPI.mealRecFeedback.addFeedback(feedbackData);
            if (success) {
                setUserFeedback(rating === 1 ? 'positive' : 'negative');
                console.info(`${LOG_PREFIX} ‚úÖ Feedback submitted:`, rating === 1 ? 'üëç' : 'üëé');

                // R2.7: best-effort cloud sync (non-blocking)
                if (typeof global.HEYS?.InsightsPI?.mealRecFeedback?.syncWithCloud === 'function') {
                    global.HEYS.InsightsPI.mealRecFeedback
                        .syncWithCloud({ reason: 'ui_feedback' })
                        .catch((err) => console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Feedback cloud sync failed:`, err?.message));
                }

                // R2.7 Step 5: Submit quick feedback to feedbackLoop for ML weight updates
                if (recIdRef.current && global.HEYS?.InsightsPI?.feedbackLoop?.submitFeedback) {
                    try {
                        global.HEYS.InsightsPI.feedbackLoop.submitFeedback(
                            recIdRef.current,
                            { quickRating: rating },
                            getProfileWithId()
                        );
                        console.info(`${LOG_PREFIX} ‚úÖ Quick feedback sent to ML loop:`, rating);
                    } catch (err) {
                        console.warn(`${LOG_PREFIX} ‚ö†Ô∏è feedbackLoop.submitFeedback failed:`, err?.message);
                    }
                }
            }
        };

        // R2.7 Step 3: Handler for adding suggestion to diary
        // v24: Smart active meal detection (< 30 min) ‚Äî no modal needed
        const handleAddSuggestion = (suggestion) => {
            if (!suggestion) return;

            // Sprint 2 verification ‚Äî filter in browser console: [MEALREC]
            console.info(`${LOG_PREFIX} [sprint2] ‚ñ∂ handleAddSuggestion triggered:`, {
                product: suggestion.product,
                grams: suggestion.grams,
                productId: suggestion.productId,
                isAlreadyProcessing: !!handleAddSuggestion._isProcessing
            });

            // üÜï Sprint 2C: Race condition guard ‚Äî prevent double-click
            if (handleAddSuggestion._isProcessing) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Already processing, ignoring duplicate click`);
                return;
            }
            handleAddSuggestion._isProcessing = true;
            const _releaseProcessing = () => { handleAddSuggestion._isProcessing = false; };
            setTimeout(_releaseProcessing, 8000); // auto-release safety net

            const { HEYS } = global;

            // Guard: Check AddProductStep availability
            if (!HEYS?.AddProductStep?.show) {
                console.error(`${LOG_PREFIX} ‚ùå AddProductStep not available`);
                return;
            }

            if (!pIndex) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è pIndex not available`);
                return;
            }

            // Find product in index (–¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏–º–µ–Ω–∏ –≤ –º–æ–¥–∞–ª–∫—É —á–µ—Ä–µ–∑ initialSearch)
            let productForSearch = null;
            if (suggestion.productId && pIndex.byId) {
                productForSearch = pIndex.byId.get(String(suggestion.productId).toLowerCase());
            }
            if (!productForSearch && pIndex.byName) {
                const normalizedName = (suggestion.product || '').toLowerCase().trim();
                productForSearch = pIndex.byName.get(normalizedName);
            }

            // üÜï Sprint 2A: Normalize search (—ë‚Üí–µ, lowercase, trim) for better product match rate
            const normalizeSearch = (name) =>
                name.toLowerCase().replace(/—ë/g, '–µ').replace(/\s+/g, ' ').trim();
            const _rawName = productForSearch?.name || suggestion.product || '';
            const searchQuery = normalizeSearch(_rawName);
            console.info(`${LOG_PREFIX} [sprint2A] üî§ normalizeSearch:`, {
                raw: _rawName,
                normalized: searchQuery,
                yoFixed: _rawName.toLowerCase().includes('—ë')
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–∞–ª–∫—É: –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∏—ë–º (< 30 –º–∏–Ω) –ò–õ–ò –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º
            const showSmartMealPicker = (onMealSelected) => {
                // v25.8.2: Determine date from day.date or current date
                const date = day?.date || new Date().toISOString().slice(0, 10);

                if (!day?.meals || day.meals.length === 0) {
                    // –ù–µ—Ç –ø—Ä–∏—ë–º–æ–≤ ‚Üí —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —á–µ—Ä–µ–∑ HEYS.MealStep (v25.8)
                    console.info(`${LOG_PREFIX} ‚û°Ô∏è No meals in day, using HEYS.MealStep.showAddMeal`);

                    if (!HEYS?.MealStep?.showAddMeal) {
                        console.error(`${LOG_PREFIX} ‚ùå HEYS.MealStep.showAddMeal not available`);
                        // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º AddProduct –¥–ª—è meal 0
                        onMealSelected(0);
                        return;
                    }

                    // v25.8.2: Log all parameters before call
                    console.info(`${LOG_PREFIX} üìã MealStep params:`, {
                        dateKey: date,
                        mealsLength: day.meals?.length || 0,
                        hasIndex: !!pIndex,
                        hasGetProductFromItem: typeof getProductFromItem === 'function',
                        trainingsCount: day.trainings?.length || 0,
                        deficitPct: Number(day.deficitPct ?? prof?.deficitPctTarget ?? 0),
                        hasProf: !!prof,
                        hasDayData: !!day
                    });

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –º–µ—Ö–∞–Ω–∏–∑–º, —á—Ç–æ –∏ FAB –∫–Ω–æ–ø–∫–∞
                    try {
                        HEYS.MealStep.showAddMeal({
                            dateKey: date,
                            meals: day.meals || [],
                            pIndex,
                            getProductFromItem,
                            trainings: day.trainings || [],
                            deficitPct: Number(day.deficitPct ?? prof?.deficitPctTarget ?? 0),
                            prof,
                            dayData: day,
                            onComplete: (newMeal) => {
                                console.info(`[MEAL] ‚úÖ Meal created (no meals case):`, newMeal.name, `id=${newMeal.id}`);

                                // v25.8.6.7: Use HEYS.Day.addMealDirect ‚Äî direct setDay + lsSet
                                if (HEYS?.Day?.addMealDirect) {
                                    HEYS.Day.addMealDirect(newMeal);
                                    console.info(`[MEAL] ‚úÖ addMealDirect succeeded (no meals case)`);
                                } else {
                                    // Fallback: save to localStorage manually + dispatch event
                                    console.warn(`[MEAL] ‚ö†Ô∏è addMealDirect not available, fallback to manual save`);
                                    const dateKey = day?.date || new Date().toISOString().slice(0, 10);
                                    const key = 'heys_dayv2_' + dateKey;
                                    const updatedMeals = [...(day.meals || []), newMeal];
                                    const nowTs = Date.now();
                                    const updatedDay = { ...(day || {}), date: dateKey, meals: updatedMeals, updatedAt: nowTs };
                                    try {
                                        if (HEYS?.utils?.lsSet) HEYS.utils.lsSet(key, updatedDay);
                                        else if (HEYS?.store?.set) HEYS.store.set(key, updatedDay);
                                        else localStorage.setItem(key, JSON.stringify(updatedDay));
                                    } catch (e) { console.error('[MEAL] ‚ùå Fallback save failed:', e); }
                                    if (HEYS?.Day?.setBlockCloudUpdates) HEYS.Day.setBlockCloudUpdates(nowTs + 3000);
                                    if (HEYS?.Day?.setLastLoadedUpdatedAt) HEYS.Day.setLastLoadedUpdatedAt(nowTs);
                                    window.dispatchEvent(new CustomEvent('heys:day-updated', {
                                        detail: { date: dateKey, source: 'meal-rec-card-local', forceReload: true }
                                    }));
                                }

                                // –ù–∞–π–¥—ë–º –∏–Ω–¥–µ–∫—Å –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ –≤ —Å–ø–∏—Å–∫–µ
                                const updatedMeals = [...(day.meals || []), newMeal];
                                const mealIndex = updatedMeals.findIndex(m => m.id === newMeal.id);

                                if (mealIndex >= 0) {
                                    console.info(`${LOG_PREFIX} üìç Found new meal at index ${mealIndex}`);
                                    onMealSelected(mealIndex);
                                } else {
                                    console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Meal not found, using index 0`);
                                    onMealSelected(0);
                                }
                            }
                        });
                    } catch (err) {
                        console.error(`${LOG_PREFIX} ‚ùå MealStep.showAddMeal failed:`, err);
                        console.error(`${LOG_PREFIX} üìã Error stack:`, err?.stack);
                        // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º AddProduct –¥–ª—è meal 0
                        onMealSelected(0);
                    }
                    return; // ‚Üê v25.8.1 FIX: Stop execution, don't try to access lastMeal when day.meals is empty
                }

                // –ï—Å—Ç—å –ø—Ä–∏—ë–º—ã ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Å –≤—ã–±–æ—Ä–æ–º
                const lastMeal = day.meals[day.meals.length - 1];
                const now = new Date();

                // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ (—Ñ–æ—Ä–º–∞—Ç HH:MM)
                let isActiveMeal = false;
                let minutesAgo = 0;

                if (lastMeal.time) {
                    const [hours, minutes] = lastMeal.time.split(':').map(Number);
                    const lastMealDate = new Date();
                    lastMealDate.setHours(hours, minutes, 0, 0);
                    minutesAgo = (now - lastMealDate) / 1000 / 60;
                    isActiveMeal = minutesAgo < 30 && minutesAgo >= 0;
                }

                console.info(`${LOG_PREFIX} üçΩÔ∏è Showing smart meal picker:`, {
                    hasActiveMeal: isActiveMeal,
                    minutesAgo: Math.round(minutesAgo),
                    lastMealTime: lastMeal.time,
                    lastMealName: lastMeal.name
                });

                // Inject CSS animations
                if (!document.getElementById('meal-picker-animations')) {
                    const style = document.createElement('style');
                    style.id = 'meal-picker-animations';
                    style.textContent = `
                        @keyframes fadeIn {
                            to { opacity: 1; }
                        }
                        @keyframes slideUp {
                            from { 
                                opacity: 0;
                                transform: translateY(20px); 
                            }
                            to { 
                                opacity: 1;
                                transform: translateY(0); 
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    opacity: 0;
                    animation: fadeIn 0.3s ease-out forwards;
                `;

                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: var(--bg-primary, #fff);
                    border-radius: 16px;
                    padding: 24px;
                    max-width: 320px;
                    width: 90%;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.3s ease-out;
                `;

                const title = document.createElement('h3');
                title.textContent = '–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å?';
                title.style.cssText = `
                    margin: 0 0 16px 0;
                    font-size: 20px;
                    font-weight: 600;
                    color: var(--text-primary, #000);
                    text-align: center;
                `;

                const subtitle = document.createElement('p');
                subtitle.textContent = `"${suggestion.product}"`;
                subtitle.style.cssText = `
                    margin: 0 0 20px 0;
                    font-size: 14px;
                    color: var(--text-secondary, #666);
                    text-align: center;
                `;

                const buttonsContainer = document.createElement('div');
                buttonsContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                `;

                // –ö–Ω–æ–ø–∫–∞ 1: –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–∏—ë–º (–µ—Å–ª–∏ < 30 –º–∏–Ω)
                if (isActiveMeal) {
                    const emojis = ['üç≥', 'ü•ó', 'üç≤', 'üç±', 'ü•§'];
                    const lastMealIndex = day.meals.length - 1;
                    const mealName = lastMeal.name || `–ü—Ä–∏—ë–º ${day.meals.length}`;
                    const itemsCount = lastMeal.items?.length || 0;
                    const emoji = emojis[lastMealIndex] || 'üçΩÔ∏è';

                    // –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞: "–ø—É—Å—Ç–æ–π" –∏–ª–∏ "X –ø—Ä–æ–¥—É–∫—Ç–æ–≤"
                    let statusText;
                    if (itemsCount === 0) {
                        statusText = '–ø—É—Å—Ç–æ–π';
                    } else if (itemsCount === 1) {
                        statusText = '1 –ø—Ä–æ–¥—É–∫—Ç';
                    } else if (itemsCount > 1 && itemsCount < 5) {
                        statusText = `${itemsCount} –ø—Ä–æ–¥—É–∫—Ç–∞`;
                    } else {
                        statusText = `${itemsCount} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
                    }

                    const activeBtn = document.createElement('button');
                    activeBtn.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>${emoji} ${mealName}</span>
                            <span style="font-size: 13px; opacity: 0.7;">${lastMeal.time || '‚Äî'}</span>
                        </div>
                        <div style="font-size: 13px; opacity: 0.7; margin-top: 4px;">
                            ${statusText} ‚Ä¢ ${Math.round(minutesAgo)} –º–∏–Ω –Ω–∞–∑–∞–¥
                        </div>
                    `;
                    activeBtn.style.cssText = `
                        padding: 14px 20px;
                        border: 2px solid var(--primary-color, #3b82f6);
                        border-radius: 12px;
                        background: var(--primary-bg, #eff6ff);
                        color: var(--text-primary, #000);
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        text-align: left;
                    `;

                    activeBtn.onclick = () => {
                        console.info(`${LOG_PREFIX} ‚úÖ Active meal selected:`, {
                            mealIndex: lastMealIndex,
                            mealName,
                            minutesAgo: Math.round(minutesAgo)
                        });
                        document.body.removeChild(overlay);
                        onMealSelected(lastMealIndex);
                    };

                    activeBtn.onmouseover = () => {
                        activeBtn.style.transform = 'translateY(-2px)';
                        activeBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                    };

                    activeBtn.onmouseout = () => {
                        activeBtn.style.transform = 'translateY(0)';
                        activeBtn.style.boxShadow = 'none';
                    };

                    buttonsContainer.appendChild(activeBtn);
                }

                // –ö–Ω–æ–ø–∫–∞ 2: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º (–≤—Å–µ–≥–¥–∞)
                const newBtn = document.createElement('button');
                newBtn.textContent = '‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º';
                newBtn.style.cssText = `
                    padding: 14px 20px;
                    border: 2px dashed var(--border-color, #e5e7eb);
                    border-radius: 12px;
                    background: transparent;
                    color: var(--text-secondary, #666);
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                `;

                newBtn.onclick = () => {
                    document.body.removeChild(overlay);

                    if (!HEYS?.MealStep?.showAddMeal) {
                        console.error(`${LOG_PREFIX} ‚ùå HEYS.MealStep.showAddMeal not available`);
                        return;
                    }

                    console.info(`${LOG_PREFIX} ‚û°Ô∏è Creating new meal via MealStep`);
                    console.info(`${LOG_PREFIX} üìã MealStep params (new meal btn):`, {
                        dateKey: date,
                        mealsLength: day.meals?.length || 0,
                        hasIndex: !!pIndex,
                        hasGetProductFromItem: typeof getProductFromItem === 'function'
                    });

                    // v25.8: –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.MealStep.showAddMeal (—Ç–æ—Ç –∂–µ –º–µ—Ö–∞–Ω–∏–∑–º, —á—Ç–æ –∏ FAB)
                    try {
                        HEYS.MealStep.showAddMeal({
                            dateKey: date,
                            meals: day.meals || [],
                            pIndex,
                            getProductFromItem,
                            trainings: day.trainings || [],
                            deficitPct: Number(day.deficitPct ?? prof?.deficitPctTarget ?? 0),
                            prof,
                            dayData: day,
                            onComplete: (newMeal) => {
                                console.info(`[MEAL] ‚úÖ Meal created (new meal btn):`, newMeal.name, `id=${newMeal.id}`);

                                // v25.8.6.7: Use HEYS.Day.addMealDirect ‚Äî direct setDay + lsSet
                                // This is the SAME pattern as the FAB's addMeal in heys_day_meal_handlers.js
                                if (HEYS?.Day?.addMealDirect) {
                                    HEYS.Day.addMealDirect(newMeal);
                                    console.info(`[MEAL] ‚úÖ addMealDirect succeeded`);
                                } else {
                                    // Fallback: save to localStorage manually + dispatch event
                                    console.warn(`[MEAL] ‚ö†Ô∏è addMealDirect not available, fallback to manual save`);
                                    const dateKey = day?.date || new Date().toISOString().slice(0, 10);
                                    const key = 'heys_dayv2_' + dateKey;
                                    const updatedMeals = [...(day.meals || []), newMeal];
                                    const nowTs = Date.now();
                                    const updatedDay = { ...(day || {}), date: dateKey, meals: updatedMeals, updatedAt: nowTs };
                                    try {
                                        if (HEYS?.utils?.lsSet) HEYS.utils.lsSet(key, updatedDay);
                                        else if (HEYS?.store?.set) HEYS.store.set(key, updatedDay);
                                        else localStorage.setItem(key, JSON.stringify(updatedDay));
                                    } catch (e) { console.error('[MEAL] ‚ùå Fallback save failed:', e); }
                                    if (HEYS?.Day?.setBlockCloudUpdates) HEYS.Day.setBlockCloudUpdates(nowTs + 3000);
                                    if (HEYS?.Day?.setLastLoadedUpdatedAt) HEYS.Day.setLastLoadedUpdatedAt(nowTs);
                                    window.dispatchEvent(new CustomEvent('heys:day-updated', {
                                        detail: { date: dateKey, source: 'meal-rec-card-local', forceReload: true }
                                    }));
                                }

                                // –ù–∞–π–¥—ë–º –∏–Ω–¥–µ–∫—Å –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ (after state update)
                                const updatedMeals = [...(day.meals || []), newMeal];
                                const mealIndex = updatedMeals.findIndex(m => m.id === newMeal.id);

                                if (mealIndex >= 0) {
                                    console.info(`${LOG_PREFIX} üìç Found new meal at index ${mealIndex}`);
                                    onMealSelected(mealIndex);
                                } else {
                                    console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Meal not found, using last index`);
                                    onMealSelected(updatedMeals.length - 1);
                                }
                            }
                        });
                    } catch (err) {
                        console.error(`${LOG_PREFIX} ‚ùå MealStep.showAddMeal failed (new meal btn):`, err);
                        console.error(`${LOG_PREFIX} üìã Error stack:`, err?.stack);
                    }
                };

                newBtn.onmouseout = () => {
                    newBtn.style.borderColor = 'var(--border-color, #e5e7eb)';
                    newBtn.style.color = 'var(--text-secondary, #666)';
                };

                buttonsContainer.appendChild(newBtn);

                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
                cancelBtn.style.cssText = `
                    margin-top: 8px;
                    padding: 12px 20px;
                    border: none;
                    border-radius: 12px;
                    background: transparent;
                    color: var(--text-secondary, #666);
                    font-size: 16px;
                    cursor: pointer;
                `;

                cancelBtn.onclick = () => {
                    document.body.removeChild(overlay);
                };

                modal.appendChild(title);
                modal.appendChild(subtitle);
                modal.appendChild(buttonsContainer);
                modal.appendChild(cancelBtn);
                overlay.appendChild(modal);

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                };

                document.body.appendChild(overlay);
            };

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—ë–º–∞
            showSmartMealPicker((selectedMealIndex) => {
                // üÜï v14: R6 (Sprint 1) ‚Äî Smart Grams Pre-fill verification
                console.info(`${LOG_PREFIX} üìä Opening AddProductStep:`, {
                    initialSearch: searchQuery,
                    initialGrams: suggestion.grams || 100,
                    suggestedGrams: suggestion.grams,
                    usingMLGrams: !!suggestion.grams,
                    mealIndex: selectedMealIndex
                });

                // üÜï Sprint 2B: Guard against empty products (race condition on first load)
                const _products = HEYS?.products?.getAll?.() || [];
                if (_products.length === 0) {
                    console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Products list empty ‚Äî retrying in 1s`);
                    _releaseProcessing();
                    setTimeout(() => {
                        const retryProducts = HEYS?.products?.getAll?.() || [];
                        if (retryProducts.length === 0) {
                            if (HEYS?.Toast?.error) {
                                HEYS.Toast.error('–ü—Ä–æ–¥—É–∫—Ç—ã –µ—â—ë –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.');
                            }
                            return;
                        }
                        handleAddSuggestion(suggestion);
                    }, 1000);
                    return;
                }

                console.info(`${LOG_PREFIX} [sprint2B] ‚úÖ Products ready: ${_products.length} items, searchQuery="${searchQuery}"`);

                // –û—Ç–∫—Ä—ã—Ç—å AddProductStep —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–∏—Å–∫–æ–º (–ë–ª–æ–∫–µ—Ä 1 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
                HEYS.AddProductStep.show({
                    mealIndex: selectedMealIndex,
                    multiProductMode: false,
                    products: _products,
                    day: day,
                    dateKey: day?.date || new Date().toISOString().slice(0, 10),
                    initialSearch: searchQuery, // üÜï –ë–ª–æ–∫–µ—Ä 1: –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
                    initialGrams: suggestion.grams || 100, // üÜï v14: R6 (Sprint 1) ‚Äî –ø–µ—Ä–µ–¥–∞—ë–º —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ ML –≥—Ä–∞–º–º—ã
                    onAdd: ({ product: addedProduct, grams, mealIndex }) => {
                        _releaseProcessing();
                        console.info(`[MEAL] ‚úÖ Product selected:`, addedProduct.name, `(${grams}–≥) to meal ${mealIndex}`);

                        // v25.8.6.7: Use HEYS.Day.addProductToMeal ‚Äî direct setDay + item creation
                        // This is the SAME handler used by the regular diary flow.
                        // It handles: shared product cloning, harm normalization, setDay, animation, heysProductAdded event
                        if (HEYS?.Day?.addProductToMeal) {
                            const success = HEYS.Day.addProductToMeal(mealIndex, addedProduct, grams);
                            if (success) {
                                console.info(`[MEAL] ‚úÖ addProductToMeal succeeded for meal ${mealIndex}`);
                            } else {
                                console.error(`[MEAL] ‚ùå addProductToMeal returned false for meal ${mealIndex}`);
                            }
                        } else {
                            console.error(`[MEAL] ‚ùå HEYS.Day.addProductToMeal not available!`);
                        }

                        // Feedback: markFollowed
                        if (recIdRef.current && !followedRef.current && HEYS?.InsightsPI?.feedbackLoop?.markFollowed) {
                            HEYS.InsightsPI.feedbackLoop.markFollowed(recIdRef.current, true, getProfileWithId());
                            followedRef.current = true;
                            console.info(`[MEAL] üéØ Marked as followed: recId=${recIdRef.current}`);
                        }

                        // Haptic feedback
                        if (window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred) {
                            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                        }

                        // Toast
                        const mealName = day?.meals?.[mealIndex]?.name || `–ü—Ä–∏—ë–º ${mealIndex + 1}`;
                        if (HEYS?.Toast?.success) {
                            HEYS.Toast.success(`‚úÖ ${addedProduct.name} (${grams}–≥) ‚Üí ${mealName}`);
                        }
                    },
                    onClose: () => {
                        _releaseProcessing();
                        console.info(`[MEAL] ‚ùå AddProductStep cancelled (meal already created, product not added)`);
                        console.info(`${LOG_PREFIX} ‚ùå AddProductStep cancelled, markFollowed not called`);

                        // v25.8.6.3: Keep block active even on cancel (meal exists, needs protection)
                        const blockUntil = Date.now() + 3000;
                        if (HEYS?.Day?.setBlockCloudUpdates) {
                            HEYS.Day.setBlockCloudUpdates(blockUntil);
                            const blockTime = new Date(blockUntil).toLocaleTimeString('ru-RU', { hour12: false });
                            console.info(`[MEAL] üîí Refreshed block until ${blockTime} (cancelled)`);
                        }
                    }
                });
            });
        };

        /**
         * v27.4: Handle product selection (visual only, no auto-add)
         */
        const handleProductSelect = (product) => {
            const productKey = `${product.productId || product.product}`;
            const isCurrentlySelected = checkedProducts[productKey] || false;
            const newState = !isCurrentlySelected;

            // Update selection state (visual only)
            setCheckedProducts(prev => ({
                ...prev,
                [productKey]: newState
            }));

            console.info(
                `${LOG_PREFIX} [PRODUCT] ${newState ? '‚úÖ' : '‚¨ú'} ${newState ? 'Selected' : 'Deselected'}:`,
                product.product
            );
        };

        /**
         * v27.5: Add all selected products at once
         */
        const handleAddSelectedProducts = (groups) => {
            if (!groups || groups.length === 0) return;

            const selectedProducts = [];

            // Collect all selected products from all groups
            groups.forEach(group => {
                if (group.products) {
                    group.products.forEach(product => {
                        const productKey = `${product.productId || product.product}`;
                        if (checkedProducts[productKey]) {
                            selectedProducts.push(product);
                        }
                    });
                }
            });

            if (selectedProducts.length === 0) {
                console.warn(`${LOG_PREFIX} [BULK ADD] ‚ö†Ô∏è No products selected`);
                return;
            }

            console.info(`${LOG_PREFIX} [BULK ADD] üéÅ Adding ${selectedProducts.length} selected products`);

            // Add each product sequentially (opens smart meal picker for each)
            selectedProducts.forEach((product, idx) => {
                setTimeout(() => {
                    handleAddSuggestion(product);
                }, idx * 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è–º–∏
            });

            // Clear selection after adding
            setCheckedProducts({});

            console.info(`${LOG_PREFIX} [BULK ADD] ‚úÖ Cleared selection`);
        };

        /**
         * v27: Render grouped products (categories with checkboxes)
         */
        const renderGroupedProducts = (groups) => {
            if (!groups || groups.length === 0) return null;

            return groups.map((group, groupIdx) =>
                h('div', { className: 'meal-rec-card__product-group', key: groupIdx },
                    // Group header: emoji + categoryName
                    h('div', { className: 'meal-rec-card__group-header' },
                        h('span', { className: 'meal-rec-card__group-emoji' }, group.emoji),
                        h('span', { className: 'meal-rec-card__group-name' }, group.categoryName)
                    ),
                    // Products in this group
                    h('div', { className: 'meal-rec-card__group-products' },
                        ...group.products.map((product, pIdx) => {
                            const productKey = `${product.productId || product.product}`;
                            const isSelected = checkedProducts[productKey] || false;
                            const wrapperClass = isSelected
                                ? 'meal-rec-card__product-item meal-rec-card__product-item--selected'
                                : 'meal-rec-card__product-item';

                            return h('div', {
                                className: wrapperClass,
                                key: pIdx,
                                onClick: (e) => {
                                    // Only toggle selection if clicking on card itself (not button)
                                    if (e.target.tagName !== 'BUTTON') {
                                        e.stopPropagation();
                                        handleProductSelect(product);
                                    }
                                }
                            },
                                h('div', { className: 'meal-rec-card__product-content' },
                                    h('div', { className: 'meal-rec-card__product-main' },
                                        h('div', { className: 'meal-rec-card__product-name-wrapper' },
                                            h('span', { className: 'meal-rec-card__product-name' }, product.product),
                                            // Badge: üë§ (history) –∏–ª–∏ üåê (general)
                                            h('span', {
                                                className: 'meal-rec-card__product-badge'
                                            }, product.source === 'history' ? 'üë§' : 'üåê')
                                        ),
                                        h('span', { className: 'meal-rec-card__product-grams' }, `${product.grams} –≥`)
                                    )
                                ),
                                // Add button (like in flat suggestions mode)
                                h('button', {
                                    className: 'meal-rec-card__product-add-btn',
                                    onClick: (e) => {
                                        e.stopPropagation();
                                        handleAddSuggestion(product);
                                    },
                                    title: '–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫'
                                }, '+')
                            );
                        })
                    )
                )
            );
        };

        // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (üöÄ PERF v6.0: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ useEffect)
        useEffect(() => {
            setIsCalculating(true);

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout —á—Ç–æ–±—ã –¥–∞—Ç—å React –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å Skeleton –∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å UI
            const timerId = setTimeout(() => {
                console.info(`${LOG_PREFIX} üé¨ useEffect triggered (async)`);

                if (!global.HEYS?.InsightsPI?.mealRecommender?.recommend) {
                    console.warn(`${LOG_PREFIX} ‚ùå Backend not loaded`);
                    setRecommendation(null);
                    setIsCalculating(false);
                    return;
                }

                console.info(`${LOG_PREFIX} ‚úÖ Backend available`);

                const context = buildRecommendationContext(day, dayTot, normAbs, prof, optimum, pIndex);
                if (!context) {
                    console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Insufficient data for context`);
                    setRecommendation(null);
                    setIsCalculating(false);
                    return;
                }

                console.info(`${LOG_PREFIX} üöÄ Calling recommend()...`);

                try {
                    // R2.6: Load historical days for Deep Insights enhancement
                    const historicalDays = [];
                    const today = new Date();

                    // Resolve lsGet (with fallback to direct localStorage access)
                    const safeLsGet = resolveLsGet();

                    // Load last 30 days from localStorage (lsGet auto-scopes by HEYS.currentClientId)
                    for (let i = 0; i < 30; i++) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        const dayKey = `heys_dayv2_${dateStr}`;
                        const dayData = safeLsGet(dayKey); // lsGet auto-scopes by currentClientId
                        if (dayData && dayData.date) {
                            historicalDays.push(dayData);
                        }
                    }

                    console.info(`${LOG_PREFIX} üìä Historical days loaded:`, {
                        count: historicalDays.length,
                        currentClientId: global.HEYS?.currentClientId || 'none'
                    });

                    // Call recommend with historical days for R2.6 enhancement
                    // Signature: recommend(context, profile, pIndex, days)
                    const result = global.HEYS.InsightsPI.mealRecommender.recommend(
                        context,
                        prof,           // profile (required for validation)
                        pIndex,         // product index (for smart suggestions)
                        historicalDays  // days for R2.6 Deep Insights enhancement
                    );

                    if (!result || !result.available) {
                        console.info(`${LOG_PREFIX} ‚ö†Ô∏è Hidden:`, {
                            reason: result?.error || 'Not available'
                        });
                        setRecommendation(null);
                    } else {
                        console.info(`${LOG_PREFIX} ‚úÖ Rendered:`, {
                            idealTime: result.timing?.ideal || '‚Äî',
                            protein: result.macros?.protein || 0,
                            carbs: result.macros?.carbs || 0,
                            kcal: result.macros?.kcal || 0,
                            confidence: result.confidence || 0
                        });
                        setRecommendation(result);
                    }
                } catch (err) {
                    console.error(`${LOG_PREFIX} ‚ùå Error:`, err);
                    setRecommendation(null);
                } finally {
                    setIsCalculating(false);
                }
            }, 0);

            return () => clearTimeout(timerId);
        }, [mealsCount, lastMealTime, eatenKcal, eatenProt, targetKcal, targetProt, pIndex?.length || 0]);

        // R2.7 Step 2: Store recommendation in feedbackLoop when it's generated (new or changed)
        useEffect(() => {
            if (!recommendation || !recommendation.available) return;
            if (!global.HEYS?.InsightsPI?.feedbackLoop?.storeRecommendation) return;

            // Check if this is a new recommendation (not a re-render of the same one)
            const recKey = JSON.stringify({
                scenario: recommendation.scenario,
                time: recommendation.timing?.ideal,
                kcal: recommendation.macros?.kcal
            });

            if (prevRecommendationRef.current === recKey) return;

            try {
                const recId = global.HEYS.InsightsPI.feedbackLoop.storeRecommendation(
                    recommendation,
                    'meal',
                    getProfileWithId()
                );
                recIdRef.current = recId;
                followedRef.current = false;
                prevRecommendationRef.current = recKey;

                console.info(`${LOG_PREFIX} ‚úÖ Recommendation stored, recId:`, recId);
            } catch (err) {
                console.warn(`${LOG_PREFIX} ‚ö†Ô∏è Failed to store recommendation:`, err?.message);
            }
        }, [recommendation, prof]);

        // R2.7 Step 4: Auto-track when user adds a product matching recommendation
        useEffect(() => {
            if (!recommendation || !recommendation.suggestions) return;

            const handleProductAdded = (event) => {
                if (followedRef.current) return; // Already tracked
                if (!recIdRef.current) return;
                if (!event.detail?.product) return;

                const addedProduct = event.detail.product;
                const addedName = (addedProduct.name || addedProduct.title || '').toLowerCase().trim();

                // Check if added product matches any suggestion
                const matched = recommendation.suggestions.some((s) => {
                    const suggestionName = (s.product || '').toLowerCase().trim();
                    return suggestionName === addedName;
                });

                if (matched && global.HEYS?.InsightsPI?.feedbackLoop?.markFollowed) {
                    try {
                        global.HEYS.InsightsPI.feedbackLoop.markFollowed(recIdRef.current, true, getProfileWithId());
                        followedRef.current = true;
                        console.info(`${LOG_PREFIX} ‚úÖ Auto-tracked: user added recommended product:`, addedName);
                    } catch (err) {
                        console.warn(`${LOG_PREFIX} ‚ö†Ô∏è markFollowed failed:`, err?.message);
                    }
                }
            };

            window.addEventListener('heysProductAdded', handleProductAdded);
            return () => window.removeEventListener('heysProductAdded', handleProductAdded);
        }, [recommendation, prof]);

        // üöÄ PERF v6.0: Skeleton –ø–æ–∫–∞ –∏–¥—ë—Ç async —Ä–∞—Å—á—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (useEffect)
        if (isCalculating) {
            return h('div', { className: 'meal-rec-card meal-rec-card--skeleton', 'aria-busy': true },
                h('div', { className: 'meal-rec-card__skeleton-pulse' })
            );
        }

        // –ï—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—Ç–æ—á–∫—É
        if (!recommendation) {
            console.warn(`${LOG_PREFIX} üö´ Card NOT rendered (recommendation is null)`);
            return null;
        }

        // P2-card: throttle render logs ‚Äî only first time per page session
        _mealRecCardRenderCount++;
        if (_mealRecCardRenderCount === 1) {
            console.info(`${LOG_PREFIX} üé® Rendering card UI...`);
        }

        // v27: Extract mode and groups for grouped product selection
        const { timing, macros, suggestions, reasoning, confidence, scenario, scenarioIcon, scenarioReason, mealsPlan, mode, groups } = recommendation;

        // üÜï v26: Multi-meal mode detection
        const isMultiMeal = mealsPlan && mealsPlan.available && mealsPlan.meals && mealsPlan.meals.length > 1;

        if (_mealRecCardRenderCount === 1) console.info(`${LOG_PREFIX} [CARD.mode] üé® Rendering mode:`, {
            isMultiMeal,
            mealsCount: mealsPlan?.meals?.length || 0,
            productMode: mode || 'legacy',
            hasSuggestions: suggestions?.length || 0,
            hasGroups: groups?.length || 0,
            scenario,
            timing,
            macros: isMultiMeal ? mealsPlan.summary?.totalMacros : macros
        });

        if (isMultiMeal) {
            console.info(`${LOG_PREFIX} [CARD.multi] üìã Multi-meal plan:`, {
                totalMeals: mealsPlan.summary?.totalMeals,
                timeline: `${mealsPlan.summary?.timelineStart} ‚Üí ${mealsPlan.summary?.timelineEnd}`,
                totalMacros: mealsPlan.summary?.totalMacros,
                sleepTarget: mealsPlan.summary?.sleepTarget,
                meals: mealsPlan.meals.map((m, i) => ({
                    index: i + 1,
                    time: m.timeStart,
                    macros: m.macros,
                    isActionable: m.isActionable
                }))
            });
        }

        if (_mealRecCardRenderCount === 1) console.info(`${LOG_PREFIX} üé® Rendering mode:`, {
            isMultiMeal,
            mealsCount: isMultiMeal ? mealsPlan.meals.length : 1
        });

        // Scenario-aware visibility (v2.4)
        // GOAL_REACHED: show water recommendation, hide macros
        // Other scenarios: show if has macros
        const isGoalReached = scenario === 'GOAL_REACHED';
        const remainingKcal = macros?.remainingKcal || 0;

        if (!isGoalReached && (remainingKcal < 50 || (macros?.protein <= 0 && macros?.carbs <= 0))) {
            console.info(`${LOG_PREFIX} ‚ÑπÔ∏è Budget exhausted ‚Äî showing water card:`, {
                scenario,
                remainingKcal,
                protein: macros?.protein,
                carbs: macros?.carbs
            });
            // Show "goal complete, drink water" card instead of hiding
            return h('div', { className: 'meal-rec-card p-4 rounded-2xl bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-100' },
                h('div', { className: 'flex items-center gap-3 mb-2' },
                    h('span', { className: 'text-3xl' }, 'üíß'),
                    h('div', null,
                        h('div', { className: 'meal-rec-card__badge mb-1' }, '–£–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫'),
                        h('div', { className: 'font-semibold text-blue-800 text-base' }, '–¶–µ–ª—å –¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!'),
                    )
                ),
                h('div', { className: 'text-sm text-blue-700 leading-relaxed' },
                    '–í—ã –Ω–∞–±—Ä–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–∞–ª–æ—Ä–∏–π –∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. ',
                    '–î–∞–ª—å—à–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤–æ–¥–∞ ',
                    h('span', { className: 'text-base' }, 'üíß'),
                    '. –•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å!'
                )
            );
        }

        // Scenario-aware header titles (v2.4)
        const SCENARIO_TITLES = {
            'GOAL_REACHED': '–¶–µ–ª—å –¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞',
            'LIGHT_SNACK': '–õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å',
            'LATE_EVENING': '–í–µ—á–µ—Ä–Ω–∏–π –ø—Ä–∏—ë–º',
            'PRE_WORKOUT': '–ü–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π',
            'POST_WORKOUT': '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
            'PROTEIN_DEFICIT': '–î–æ–±–∏—Ä–∞–µ–º –±–µ–ª–æ–∫',
            'STRESS_EATING': '–ó–¥–æ—Ä–æ–≤—ã–π –∞–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å',
            'BALANCED': '–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º'
        };

        const scenarioTitle = SCENARIO_TITLES[scenario] || '–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º';
        const displayIcon = scenarioIcon || 'üçΩÔ∏è';

        // üÜï v26: Multi-meal header content
        // v27.7 (2026-02-18): Enhanced prompt with user-friendly description
        let headerTitle, headerTimeRange, headerSubtitle;

        if (isMultiMeal) {
            const mealsCount = mealsPlan.meals.length;
            const pluralMeals = mealsCount === 2 ? '–ø—Ä–∏—ë–º–∞' : mealsCount >= 5 ? '–ø—Ä–∏—ë–º–æ–≤' : '–ø—Ä–∏—ë–º–∞';
            headerTitle = `${mealsCount} ${pluralMeals} –¥–æ —Å–Ω–∞`;
            headerTimeRange = `${mealsPlan.summary.timelineStart}-${mealsPlan.summary.timelineEnd}`;
            headerSubtitle = '–°–ª–µ–¥—É–π—Ç–µ –ø–ª–∞–Ω—É ‚Äî –∏ –≤–∞—à –¥–µ–Ω—å –±—É–¥–µ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–º –ø–æ –ø–∏—Ç–∞–Ω–∏—é';
        } else {
            headerTitle = scenarioTitle;
            headerTimeRange = !isGoalReached && timing?.ideal ? timing.ideal : null;
            headerSubtitle = scenarioReason || timing?.reason || '–ü–æ–¥–æ–±—Ä–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –¥–Ω—è –∏ –ø—Ä–∏–≤—ã—á–µ–∫';
        }

        // Compact header (collapsed state)
        // üÜï v27.9: Extracted science badge to top-right corner
        const cardHeader = h('div', {
            className: 'meal-rec-card__header',
            onClick: () => setExpanded(!expanded)
        },
            h('div', { className: 'meal-rec-card__title' },
                h('div', { className: 'meal-rec-card__badge-wrap' },
                    h('div', { className: 'meal-rec-card__badge' }, '–£–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫')
                ),
                h('div', { className: 'meal-rec-card__subtitle' },
                    headerSubtitle
                ),
                h('div', { className: 'meal-rec-card__time' },
                    headerTitle,
                    headerTimeRange && h('span', { className: 'meal-rec-card__time-value' },
                        ` ¬∑ ${headerTimeRange}`
                    )
                )
            ),
            h('div', { className: 'meal-rec-card__expand-icon' },
                expanded ? '‚ñ≤' : '‚ñº'
            )
        );

        // üÜï v27.9: Separate Scientific Approach Badge (Top Right)
        const scienceBadge = (() => {
            const InfoBtn = global.HEYS?.InsightsPI?.uiDashboard?.InfoButton;
            if (!InfoBtn) return null;

            return h('div', {
                className: 'meal-rec-card__science-corner',
                onClick: (e) => e.stopPropagation() // Prevent card expansion
            },
                h('span', { className: 'meal-rec-card__science-label' }, '–ù–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥'),
                h(InfoBtn, { infoKey: 'SMART_PLANNER', size: 'small' })
            );
        })();

        // –ú–∞–∫—Ä–æ-—á–∏–ø—ã (skip for GOAL_REACHED)
        // üÜï v26: –í multi-meal —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã –∏–∑ –ø–ª–∞–Ω–∞
        let macroChips = null;
        if (!isGoalReached) {
            const displayMacros = isMultiMeal ? mealsPlan.summary.totalMacros : macros;

            macroChips = h('div', { className: 'meal-rec-card__macros' },
                h('div', { className: 'meal-rec-card__macro-chip meal-rec-card__macro-chip--protein' },
                    h('span', { className: 'meal-rec-card__macro-label' }, '–ë'),
                    h('span', { className: 'meal-rec-card__macro-value' },
                        isMultiMeal ? displayMacros.prot : formatMacroRange(displayMacros?.protein, displayMacros?.proteinRange)
                    ),
                    h('span', { className: 'meal-rec-card__macro-unit' }, '–≥')
                ),
                h('div', { className: 'meal-rec-card__macro-chip meal-rec-card__macro-chip--carbs' },
                    h('span', { className: 'meal-rec-card__macro-label' }, '–£'),
                    h('span', { className: 'meal-rec-card__macro-value' },
                        isMultiMeal ? displayMacros.carbs : formatMacroRange(displayMacros?.carbs, displayMacros?.carbsRange)
                    ),
                    h('span', { className: 'meal-rec-card__macro-unit' }, '–≥')
                ),
                h('div', { className: 'meal-rec-card__macro-chip meal-rec-card__macro-chip--kcal' },
                    h('span', { className: 'meal-rec-card__macro-label' }, '–∫–∫–∞–ª'),
                    h('span', { className: 'meal-rec-card__macro-value' },
                        isMultiMeal ? displayMacros.kcal : formatMacroRange(displayMacros?.kcal, displayMacros?.kcalRange)
                    )
                )
            );
        }

        // Smart meal name by time of day
        function getMealNameByTime(timeStr) {
            if (!timeStr) return '–ü—Ä–∏—ë–º –ø–∏—â–∏';
            const h = parseInt(timeStr.split(':')[0], 10);
            if (h < 10) return '–ó–∞–≤—Ç—Ä–∞–∫';
            if (h < 12) return '–í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫';
            if (h < 15) return '–û–±–µ–¥';
            if (h < 17) return '–ü–æ–ª–¥–Ω–∏–∫';
            if (h < 21) return '–£–∂–∏–Ω';
            return '–ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω';
        }

        // Scenario badge config: text + CSS modifier
        const SCENARIO_BADGE = {
            'PROTEIN_DEFICIT': { text: '–ë–µ–ª–æ–∫', mod: 'protein' },
            'LATE_EVENING': { text: '–õ—ë–≥–∫–∏–π', mod: 'light' },
            'BALANCED': { text: '–ë–∞–ª–∞–Ω—Å', mod: 'balanced' },
            'LIGHT_SNACK': { text: '–ü–µ—Ä–µ–∫—É—Å', mod: 'light' },
            'POST_WORKOUT': { text: '–í–æ—Å—Å—Ç.', mod: 'sport' },
            'PRE_SLEEP': { text: '–ü—Ä–µ—Å–æ–Ω', mod: 'light' },
            'PRE_WORKOUT': { text: '–ü–µ—Ä–µ–¥ –¢', mod: 'sport' },
            'STRESS_EATING': { text: '–ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å', mod: 'balanced' },
        };

        // Expanded details ‚Äî v26: multi-meal support –∏–ª–∏ original compact layout
        let expandedDetails = null;
        if (expanded) {
            if (isMultiMeal) {
                // üÜï Multi-meal mode: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º sub-cards –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
                const mealSubCards = mealsPlan.meals.map((meal, mealIdx) => {
                    const mealName = getMealNameByTime(meal.timeStart);
                    const badge = SCENARIO_BADGE[meal.scenario] || { text: '–ü—Ä–∏—ë–º –ø–∏—â–∏', mod: 'balanced' };
                    const waveInfo = `–í–æ–ª–Ω–∞ –¥–æ ${meal.estimatedWaveEnd} ¬∑ –∂–∏—Ä–æ—Å–∂. ${meal.fatBurnWindow.start}‚Äì${meal.fatBurnWindow.end}`;

                    return h('div', { className: 'meal-rec-card__meal-subcard', key: mealIdx },
                        // –®–∞–ø–∫–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ + –≤—Ä–µ–º—è + badge —Å—Ü–µ–Ω–∞—Ä–∏—è
                        h('div', { className: 'meal-rec-card__meal-header' },
                            h('div', { className: 'meal-rec-card__meal-header-left' },
                                h('div', { className: 'meal-rec-card__meal-title' }, mealName),
                                h('div', { className: 'meal-rec-card__meal-time' }, `${meal.timeStart}‚Äì${meal.timeEnd}`)
                            ),
                            h('div', { className: `meal-rec-card__meal-badge meal-rec-card__meal-badge--${badge.mod}` }, badge.text)
                        ),
                        // –ú–∞–∫—Ä–æ-—á–∏–ø—ã –≤ —Å—Ç–∏–ª–µ –≥–ª–∞–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                        h('div', { className: 'meal-rec-card__meal-chips' },
                            h('div', { className: 'meal-rec-card__macro-chip meal-rec-card__macro-chip--protein' },
                                h('span', { className: 'meal-rec-card__macro-label' }, '–ë'),
                                h('span', { className: 'meal-rec-card__macro-value' }, Math.round(meal.macros.prot)),
                                h('span', { className: 'meal-rec-card__macro-unit' }, '–≥')
                            ),
                            h('div', { className: 'meal-rec-card__macro-chip meal-rec-card__macro-chip--carbs' },
                                h('span', { className: 'meal-rec-card__macro-label' }, '–£'),
                                h('span', { className: 'meal-rec-card__macro-value' }, Math.round(meal.macros.carbs)),
                                h('span', { className: 'meal-rec-card__macro-unit' }, '–≥')
                            ),
                            h('div', { className: 'meal-rec-card__macro-chip meal-rec-card__macro-chip--kcal' },
                                h('span', { className: 'meal-rec-card__macro-label' }, '–∫–∫–∞–ª'),
                                h('span', { className: 'meal-rec-card__macro-value' }, Math.round(meal.macros.kcal))
                            )
                        ),

                        // –ü—Ä–æ–¥—É–∫—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è actionable –ø—Ä–∏—ë–º–∞)
                        meal.isActionable && meal.groups && meal.groups.length > 0 ?
                            h('div', { className: 'meal-rec-card__grouped-products' },
                                ...renderGroupedProducts(meal.groups)
                            )
                            :
                            meal.isActionable && meal.suggestions && meal.suggestions.length > 0 && h('div', { className: 'meal-rec-card__suggestions' },
                                ...meal.suggestions.map((s, idx) =>
                                    h('div', { className: 'meal-rec-card__suggestion', key: idx },
                                        h('button', {
                                            className: 'meal-rec-card__suggestion-add',
                                            onClick: (e) => {
                                                e.stopPropagation();
                                                handleAddSuggestion(s);
                                            },
                                            title: '–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫'
                                        }, '+'),
                                        h('div', { className: 'meal-rec-card__suggestion-info' },
                                            h('div', { className: 'meal-rec-card__suggestion-main' },
                                                h('span', { className: 'meal-rec-card__suggestion-product' }, s.product),
                                                h('span', { className: 'meal-rec-card__suggestion-grams' }, `${s.grams} –≥`)
                                            ),
                                            s.reason && h('div', { className: 'meal-rec-card__suggestion-reason' }, s.reason)
                                        )
                                    )
                                )
                            ),

                        // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞
                        h('div', { className: 'meal-rec-card__meal-wave' }, waveInfo),

                        // –î–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–∏—ë–º–æ–≤: –ø–æ–¥—Å–∫–∞–∑–∫–∞
                        !meal.isActionable && h('div', { className: 'meal-rec-card__meal-hint' }, '(–¥–æ–±–∞–≤–∏—Ç—å –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ)')
                    );
                });

                expandedDetails = h('div', { className: 'meal-rec-card__details meal-rec-card__details--multi' },
                    ...mealSubCards,

                    // Footer —Å feedback
                    h('div', { className: 'meal-rec-card__footer' },
                        h('div', { className: 'meal-rec-card__feedback-inline' },
                            !userFeedback && h('span', { className: 'meal-rec-card__feedback-label' }, '–ü–æ–ª–µ–∑–Ω–æ?'),
                            h('button', {
                                className: `meal-rec-card__feedback-btn ${userFeedback === 'positive' ? 'meal-rec-card__feedback-btn--selected' : ''}`,
                                onClick: (e) => {
                                    e.stopPropagation();
                                    handleFeedback(1);
                                },
                                disabled: userFeedback !== null,
                                title: '–î–∞, –ø–æ–º–æ–≥–ª–∞'
                            }, 'üëç'),
                            h('button', {
                                className: `meal-rec-card__feedback-btn ${userFeedback === 'negative' ? 'meal-rec-card__feedback-btn--selected' : ''}`,
                                onClick: (e) => {
                                    e.stopPropagation();
                                    handleFeedback(-1);
                                },
                                disabled: userFeedback !== null,
                                title: '–ù–µ—Ç, –Ω–µ –ø–æ–º–æ–≥–ª–∞'
                            }, 'üëé'),
                            userFeedback && h('span', { className: 'meal-rec-card__feedback-thanks' }, 'üíö')
                        )
                    )
                );
            } else {
                // Original single-meal layout (v25.9)
                expandedDetails = h('div', { className: 'meal-rec-card__details' },
                    // v27: Grouped products mode (multiple products per category with checkboxes)
                    mode === 'grouped' && groups && groups.length > 0 ?
                        h('div', { className: 'meal-rec-card__grouped-products' },
                            ...renderGroupedProducts(groups),
                            // v27.5: Bulk add button (appears after groups)
                            (() => {
                                const selectedCount = Object.values(checkedProducts).filter(Boolean).length;
                                const hasSelection = selectedCount > 0;
                                return h('button', {
                                    className: hasSelection
                                        ? 'meal-rec-card__add-selected-btn meal-rec-card__add-selected-btn--active'
                                        : 'meal-rec-card__add-selected-btn',
                                    disabled: !hasSelection,
                                    onClick: (e) => {
                                        e.stopPropagation();
                                        handleAddSelectedProducts(groups);
                                    }
                                }, hasSelection
                                    ? `–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${selectedCount})`
                                    : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
                                );
                            })()
                        )
                        :
                        // Legacy: Flat suggestions mode (single products with + buttons)
                        suggestions && suggestions.length > 0 && h('div', { className: 'meal-rec-card__suggestions' },
                            ...suggestions.map((s, idx) =>
                                h('div', { className: 'meal-rec-card__suggestion', key: idx },
                                    h('button', {
                                        className: 'meal-rec-card__suggestion-add',
                                        onClick: (e) => {
                                            e.stopPropagation();
                                            handleAddSuggestion(s);
                                        },
                                        title: '–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫'
                                    }, '+'),
                                    h('div', { className: 'meal-rec-card__suggestion-info' },
                                        h('div', { className: 'meal-rec-card__suggestion-main' },
                                            h('span', { className: 'meal-rec-card__suggestion-product' }, s.product),
                                            h('span', { className: 'meal-rec-card__suggestion-grams' }, `${s.grams} –≥`)
                                        ),
                                        s.reason && h('div', { className: 'meal-rec-card__suggestion-reason' }, s.reason)
                                    )
                                )
                            )
                        ),

                    // Reasoning ‚Äî compact tags
                    reasoning && reasoning.length > 0 && h('div', { className: 'meal-rec-card__reasoning' },
                        ...reasoning.map((r, idx) =>
                            h('span', { className: 'meal-rec-card__reason-tag', key: idx }, r)
                        )
                    ),

                    // Footer: confidence + feedback inline
                    h('div', { className: 'meal-rec-card__footer' },
                        confidence !== undefined && h('span', { className: 'meal-rec-card__confidence' },
                            `${Math.round(confidence * 100)}%`
                        ),
                        h('div', { className: 'meal-rec-card__feedback-inline' },
                            !userFeedback && h('span', { className: 'meal-rec-card__feedback-label' }, '–ü–æ–ª–µ–∑–Ω–æ?'),
                            h('button', {
                                className: `meal-rec-card__feedback-btn ${userFeedback === 'positive' ? 'meal-rec-card__feedback-btn--selected' : ''}`,
                                onClick: (e) => {
                                    e.stopPropagation();
                                    handleFeedback(1);
                                },
                                disabled: userFeedback !== null,
                                title: '–î–∞, –ø–æ–º–æ–≥–ª–∞'
                            }, 'üëç'),
                            h('button', {
                                className: `meal-rec-card__feedback-btn ${userFeedback === 'negative' ? 'meal-rec-card__feedback-btn--selected' : ''}`,
                                onClick: (e) => {
                                    e.stopPropagation();
                                    handleFeedback(-1);
                                },
                                disabled: userFeedback !== null,
                                title: '–ù–µ—Ç, –Ω–µ –ø–æ–º–æ–≥–ª–∞'
                            }, 'üëé'),
                            userFeedback && h('span', { className: 'meal-rec-card__feedback-thanks' }, 'üíö')
                        )
                    )
                );
            }
        }

        // Main card container
        const cardElement = h('div', {
            className: `meal-rec-card ${expanded ? 'meal-rec-card--expanded' : ''}`,
            'data-testid': 'meal-rec-card',
            style: { position: 'relative' }
        },
            scienceBadge,
            cardHeader,
            macroChips,
            expandedDetails
        );

        console.info(`${LOG_PREFIX} ‚úÖ Card element created successfully`);

        return cardElement;
    }

    // Memoized component ‚Äî prevents 30+ re-renders per page load
    const MemoizedMealRecommenderCard = React.memo(MealRecommenderCard, (prev, next) => {
        // Return true = skip re-render (props are equal)
        // P2 Fix: Added day.date check to detect date changes (prevents double recommendation cycle)
        // v28: SWR trigger is handled internally via state, so we don't need to check it here
        return (
            prev.day?.date === next.day?.date &&
            (prev.day?.meals?.length || 0) === (next.day?.meals?.length || 0) &&
            (prev.day?.meals?.[(prev.day?.meals?.length || 1) - 1]?.time || '') ===
            (next.day?.meals?.[(next.day?.meals?.length || 1) - 1]?.time || '') &&
            Math.round(prev.dayTot?.kcal || 0) === Math.round(next.dayTot?.kcal || 0) &&
            Math.round(prev.dayTot?.prot || 0) === Math.round(next.dayTot?.prot || 0) &&
            Math.round(prev.normAbs?.kcal || 0) === Math.round(next.normAbs?.kcal || 0) &&
            prev.optimum === next.optimum
        );
    });

    /**
     * Render function –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ diary section
     */
    function renderCard(props) {
        if (!props || !props.React) {
            console.warn(`${LOG_PREFIX} ‚ùå renderCard: missing props or React`);
            return null;
        }

        return h(MemoizedMealRecommenderCard, props);
    }

    // Export to global
    global.HEYS = global.HEYS || {};
    global.HEYS.MealRecCard = {
        renderCard
    };

    console.info(`${LOG_PREFIX} üì¶ Module loaded (v27.8: useMemo pIndex dep fix + render log throttle)`);

})(window);


/* ===== insights/pi_ui_helpers.js ===== */
// pi_ui_helpers.js ‚Äî Shared UI helpers for Insights modules
// Centralized fallback getters to avoid duplication across dashboard/cards/rings/what-if
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.InsightsPI = HEYS.InsightsPI || {};

    function getInfoButton(hFactory) {
        return HEYS.InsightsPI?.uiDashboard?.InfoButton ||
            HEYS.PredictiveInsights?.components?.InfoButton ||
            HEYS.day?.InfoButton ||
            HEYS.InfoButton ||
            global.InfoButton ||
            function InfoButtonFallback({ infoKey }) {
                return hFactory
                    ? hFactory('span', {
                        className: 'info-button-placeholder',
                        title: infoKey,
                        style: { cursor: 'help', opacity: 0.5 }
                    }, '‚ÑπÔ∏è')
                    : null;
            };
    }

    const FALLBACK_PRIORITY_LEVELS = {
        CRITICAL: { level: 1, name: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', emoji: 'üî¥', color: '#ef4444' },
        HIGH: { level: 2, name: '–í—ã—Å–æ–∫–∏–π', emoji: 'üü†', color: '#f97316' },
        MEDIUM: { level: 3, name: '–°—Ä–µ–¥–Ω–∏–π', emoji: 'üü°', color: '#eab308' },
        LOW: { level: 4, name: '–ù–∏–∑–∫–∏–π', emoji: 'üü¢', color: '#22c55e' },
        INFO: { level: 5, name: '–°–ø—Ä–∞–≤–æ—á–Ω—ã–π', emoji: 'üîµ', color: '#3b82f6' }
    };

    const FALLBACK_CATEGORIES = {
        METABOLISM: { id: 'metabolism', name: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', emoji: 'üî•', color: '#f97316' },
        NUTRITION: { id: 'nutrition', name: '–ü–∏—Ç–∞–Ω–∏–µ', emoji: 'üçΩÔ∏è', color: '#22c55e' },
        TIMING: { id: 'timing', name: '–¢–∞–π–º–∏–Ω–≥', emoji: '‚è∞', color: '#8b5cf6' },
        RECOVERY: { id: 'recovery', name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', emoji: 'üò¥', color: '#6366f1' },
        RISK: { id: 'risk', name: '–†–∏—Å–∫–∏', emoji: '‚ö†Ô∏è', color: '#ef4444' },
        PREDICTION: { id: 'prediction', name: '–ü—Ä–æ–≥–Ω–æ–∑—ã', emoji: 'üîÆ', color: '#a855f7' },
        PATTERNS: { id: 'patterns', name: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', emoji: 'üß¨', color: '#ec4899' },
        COMPOSITE: { id: 'composite', name: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ', emoji: 'üìä', color: '#14b8a6' },
        STATISTICS: { id: 'statistics', name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', emoji: 'üìà', color: '#64748b' }
    };

    function getPriorityLevels(constants) {
        return constants?.PRIORITY_LEVELS || HEYS.InsightsPI?.constants?.PRIORITY_LEVELS || FALLBACK_PRIORITY_LEVELS;
    }

    function getCategories(constants) {
        return constants?.CATEGORIES || HEYS.InsightsPI?.constants?.CATEGORIES || FALLBACK_CATEGORIES;
    }

    HEYS.InsightsPI.uiHelpers = {
        getInfoButton,
        getPriorityLevels,
        getCategories
    };

    global.piUIHelpers = HEYS.InsightsPI.uiHelpers;
})(typeof window !== 'undefined' ? window : global);

/* ===== insights/pi_ui_rings.js ===== */
// pi_ui_rings.js ‚Äî Ring UI Components v3.0.1
// Extracted from heys_predictive_insights_v1.js (Phase 7)
// –ö–æ–ª—å—Ü–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
// v3.0.1: Lazy getter –¥–ª—è InfoButton (fix load order issues)
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};

  // React imports
  const { createElement: h, useState, useEffect } = window.React || {};
  const piUIHelpers = HEYS.InsightsPI?.uiHelpers || window.piUIHelpers || {};
  const piConst = HEYS.InsightsPI?.constants || window.piConst || {};

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (reserved for future use)
  const _SCIENCE_INFO = piConst.SCIENCE_INFO || HEYS.InsightsPI?.science || window.piScience || {}; // eslint-disable-line no-unused-vars

  // === LAZY GETTER –¥–ª—è InfoButton (fix load order) ===
  // InfoButton –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ pi_ui_dashboard.js –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ü–û–°–õ–ï —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
  const getInfoButton = () => {
    if (typeof piUIHelpers.getInfoButton === 'function') {
      return piUIHelpers.getInfoButton(h);
    }
    return HEYS.InsightsPI?.uiDashboard?.InfoButton ||
      HEYS.PredictiveInsights?.components?.InfoButton ||
      HEYS.day?.InfoButton ||
      HEYS.InfoButton ||
      window.InfoButton ||
      // Fallback: –ø—Ä–æ—Å—Ç–∞—è –∫–Ω–æ–ø–∫–∞ –µ—Å–ª–∏ InfoButton –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      function InfoButtonFallback({ infoKey, size: _size }) { // eslint-disable-line no-unused-vars
        return h('span', {
          className: 'info-button-placeholder',
          title: infoKey,
          style: { cursor: 'help', opacity: 0.5 }
        }, '‚ÑπÔ∏è');
      };
  };

  /**
   * HealthRing ‚Äî –∫–æ–ª—å—Ü–æ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * –ö–æ–ª—å—Ü–µ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π InfoButton –∏ emotional warnings
   */
  function HealthRing({ score, category, label, color, size = 80, onClick, infoKey, debugData, emotionalWarning }) {
    const radius = (size - 16) / 2;
    const circumference = 2 * Math.PI * radius;
    const progress = Math.min(100, Math.max(0, score || 0));
    const offset = circumference - (progress / 100) * circumference;

    const [showTooltip, setShowTooltip] = useState(false);
    const [isPressed, setIsPressed] = useState(false);

    // üÜï v3.22.0: emotionalWarning –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–≤–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const hasEmotionalRisk = emotionalWarning?.hasRisk;
    const effectiveColor = hasEmotionalRisk ? '#f87171' : color;

    const handleClick = () => {
      // Haptic feedback
      if (navigator.vibrate) navigator.vibrate(10);
      setShowTooltip(!showTooltip);
      if (onClick) onClick(category);
    };

    return h('div', {
      className: `insights-ring insights-ring--${category} ${showTooltip ? 'insights-ring--active' : ''} ${isPressed ? 'insights-ring--pressed' : ''} ${hasEmotionalRisk ? 'insights-ring--emotional-warning' : ''}`,
      onClick: handleClick,
      onTouchStart: () => setIsPressed(true),
      onTouchEnd: () => setIsPressed(false),
      onMouseDown: () => setIsPressed(true),
      onMouseUp: () => setIsPressed(false)
    },
      h('svg', {
        className: 'insights-ring__svg',
        width: size,
        height: size
      },
        h('circle', {
          className: 'insights-ring__track',
          cx: size / 2,
          cy: size / 2,
          r: radius
        }),
        h('circle', {
          className: 'insights-ring__fill',
          cx: size / 2,
          cy: size / 2,
          r: radius,
          style: {
            strokeDasharray: circumference,
            strokeDashoffset: offset,
            stroke: effectiveColor
          }
        })
      ),
      h('div', { className: 'insights-ring__center' },
        h('span', { className: 'insights-ring__score' }, score || '‚Äî'),
        h('span', { className: 'insights-ring__label' }, label
          // InfoButton removed ‚Äî TotalHealthRing is h()-factory (no hooks allowed)
        ),
        // üÜï v3.22.0: Emotional risk badge –≤ –∫–æ–ª—å—Ü–µ
        hasEmotionalRisk && h('div', { className: 'insights-ring__emotional' },
          h('span', {
            className: 'insights-ring__emotional-badge',
            title: `–≠–º–æ—Ü. —Ä–∏—Å–∫: ${emotionalWarning.bingeRisk}%\n–§–∞–∫—Ç–æ—Ä—ã: ${emotionalWarning.factors.join(', ')}`
          }, 'üß†'),
          h('span', { className: 'insights-ring__emotional-pct' }, `${emotionalWarning.bingeRisk}%`),
          // PMID link
          emotionalWarning.level !== 'low' && h('a', {
            href: 'https://pubmed.ncbi.nlm.nih.gov/11070333/',
            target: '_blank',
            className: 'insights-ring__pmid',
            title: 'Epel 2001 ‚Äî –∫–æ—Ä—Ç–∏–∑–æ–ª –∏ –ø–∏—â–µ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ',
            onClick: (e) => e.stopPropagation()
          }, 'üî¨')
        )
      ),
      showTooltip && h('div', { className: 'insights-ring__tooltip' },
        hasEmotionalRisk
          ? `${label}: ${score}/100\nüß† –≠–º–æ—Ü. —Ä–∏—Å–∫: ${emotionalWarning.bingeRisk}%`
          : `${label}: ${score}/100`
      )
    );
  }

  /**
   * Total Health Score ‚Äî –±–æ–ª—å—à–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (v2.0: —Å InfoButton)
   */
  function TotalHealthRing({ score, label = 'Health Score', size = 120, strokeWidth = 20, debugData, onClick }) {
    const radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const progress = Math.min(100, Math.max(0, score || 0));
    const offset = circumference - (progress / 100) * circumference;

    const handleClick = () => {
      // Haptic feedback
      if (navigator.vibrate) navigator.vibrate(10);
      if (onClick) onClick();
    };

    return h('div', {
      className: `insights-total ${onClick ? 'insights-total--clickable' : ''}`,
      onClick: handleClick,
      style: { cursor: onClick ? 'pointer' : 'default' }
    },
      h('div', { className: 'insights-total__ring' },
        h('svg', {
          className: 'insights-total__svg',
          width: size,
          height: size
        },
          h('defs', null,
            h('linearGradient', { id: 'totalGradient', x1: '0%', y1: '0%', x2: '100%', y2: '100%' },
              h('stop', { offset: '0%', stopColor: '#10b981' }),
              h('stop', { offset: '100%', stopColor: '#3b82f6' })
            )
          ),
          h('circle', {
            className: 'insights-total__track',
            cx: size / 2,
            cy: size / 2,
            r: radius,
            strokeWidth: strokeWidth
          }),
          h('circle', {
            className: 'insights-total__fill',
            cx: size / 2,
            cy: size / 2,
            r: radius,
            strokeWidth: strokeWidth,
            style: {
              strokeDasharray: circumference,
              strokeDashoffset: offset
            }
          })
        ),
        h('div', { className: 'insights-total__center' },
          h('span', { className: 'insights-total__score' }, score || '‚Äî'),
          h('span', { className: 'insights-total__label' },
            label,
            h(getInfoButton(), { infoKey: 'HEALTH_SCORE', debugData })
          )
        )
      )
    );
  }

  /**
   * Health Rings Grid ‚Äî 4 –∫–æ–ª—å—Ü–∞ –≤ —Ä—è–¥
   */
  /**
   * CollapsibleSection ‚Äî —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è (v2.1: —Å InfoButton)
   */
  function StatusProgressRing({ score, size = 120, strokeWidth = 10 }) {
    const [displayScore, setDisplayScore] = useState(0);
    const radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const progress = (displayScore / 100) * circumference;
    const offset = circumference - progress;

    // Count-up –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ score
    useEffect(() => {
      const duration = 1500; // ms
      const start = displayScore;
      const diff = score - start;
      const startTime = performance.now();

      const animate = (currentTime) => {
        const elapsed = currentTime - startTime;
        const t = Math.min(elapsed / duration, 1);
        // Ease out cubic
        const eased = 1 - Math.pow(1 - t, 3);
        const current = Math.round(start + diff * eased);
        setDisplayScore(current);

        if (t < 1) {
          requestAnimationFrame(animate);
        }
      };

      requestAnimationFrame(animate);
    }, [score]);

    // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –ø–æ score (0-100)
    const getGradientColor = (s) => {
      if (s >= 85) return { start: '#10b981', end: '#22c55e' }; // emerald ‚Üí green
      if (s >= 70) return { start: '#22c55e', end: '#84cc16' }; // green ‚Üí lime
      if (s >= 50) return { start: '#eab308', end: '#f59e0b' }; // yellow ‚Üí amber
      if (s >= 30) return { start: '#f59e0b', end: '#ef4444' }; // amber ‚Üí red
      return { start: '#ef4444', end: '#dc2626' }; // red shades
    };

    const colors = getGradientColor(displayScore);
    const gradientId = 'statusGradient' + Math.random().toString(36).substr(2, 9);

    return h('svg', {
      width: size,
      height: size,
      className: 'status-progress-ring',
      viewBox: `0 0 ${size} ${size}`
    },
      // Gradient definition
      h('defs', null,
        h('linearGradient', { id: gradientId, x1: '0%', y1: '0%', x2: '100%', y2: '100%' },
          h('stop', { offset: '0%', stopColor: colors.start }),
          h('stop', { offset: '100%', stopColor: colors.end })
        )
      ),
      // Background circle
      h('circle', {
        cx: size / 2,
        cy: size / 2,
        r: radius,
        fill: 'none',
        stroke: 'var(--border-color, #e2e8f0)',
        strokeWidth: strokeWidth
      }),
      // Progress circle
      h('circle', {
        cx: size / 2,
        cy: size / 2,
        r: radius,
        fill: 'none',
        stroke: `url(#${gradientId})`,
        strokeWidth: strokeWidth,
        strokeLinecap: 'round',
        strokeDasharray: circumference,
        strokeDashoffset: offset,
        transform: `rotate(-90 ${size / 2} ${size / 2})`,
        style: { transition: 'stroke-dashoffset 0.1s ease' }
      }),
      // Score text
      h('text', {
        x: size / 2,
        y: size / 2,
        textAnchor: 'middle',
        dominantBaseline: 'middle',
        className: 'status-progress-ring__score',
        style: {
          fontSize: size * 0.28,
          fontWeight: 700,
          fill: 'var(--text-primary, #0f172a)'
        }
      }, displayScore),
      // Label
      h('text', {
        x: size / 2,
        y: size / 2 + size * 0.18,
        textAnchor: 'middle',
        className: 'status-progress-ring__label',
        style: {
          fontSize: size * 0.1,
          fill: 'var(--text-secondary, #64748b)'
        }
      }, '–∏–∑ 100')
    );
  }

  /**
   * StatusTrendBadge ‚Äî —Ç—Ä–µ–Ω–¥ ‚Üë/‚Üì –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—á–µ—Ä–∞
   */
  function MiniRiskMeter({ risk, riskLevel, size = 120 }) {
    const safeRisk = typeof risk === 'number' && !isNaN(risk) ? Math.min(100, Math.max(0, risk)) : 0;
    const strokeWidth = 10;
    const radius = (size - strokeWidth) / 2;
    const halfCircumference = Math.PI * radius;
    const progress = (safeRisk / 100) * halfCircumference;
    const offset = halfCircumference - progress;

    const colors = {
      low: '#22c55e',
      medium: '#eab308',
      high: '#ef4444'
    };

    return h('div', { className: 'mini-risk-meter', style: { width: size, height: size / 2 + 25 } },
      h('svg', {
        viewBox: `0 0 ${size} ${size / 2 + 15}`,
        className: 'mini-risk-meter__svg'
      },
        // Background arc
        h('path', {
          d: `M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`,
          fill: 'none',
          stroke: 'var(--border-color, #e2e8f0)',
          strokeWidth: strokeWidth,
          strokeLinecap: 'round'
        }),
        // Progress arc
        h('path', {
          d: `M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`,
          fill: 'none',
          stroke: colors[riskLevel] || colors.medium,
          strokeWidth: strokeWidth,
          strokeLinecap: 'round',
          strokeDasharray: halfCircumference,
          strokeDashoffset: offset,
          style: { transition: 'stroke-dashoffset 0.6s ease' }
        }),
        // Value text
        h('text', {
          x: size / 2,
          y: size / 2 - 2,
          textAnchor: 'middle',
          style: {
            fontSize: 28,
            fontWeight: 700,
            fill: colors[riskLevel] || 'var(--text-primary)'
          }
        }, `${safeRisk}%`),
        // Label
        h('text', {
          x: size / 2,
          y: size / 2 + 14,
          textAnchor: 'middle',
          style: { fontSize: 10, fill: 'var(--text-secondary, #64748b)' }
        }, '–†–∏—Å–∫ —Å—Ä—ã–≤–∞')
      )
    );
  }

  /**
   * MetabolicStateRing ‚Äî –∫–æ–ª—å—Ü–æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π —Ñ–∞–∑—ã
   */
  function MetabolicStateRing({ phase, size = 120, strokeWidth = 10, showLabel = true }) {
    if (!phase || !phase.phase) {
      return h('div', { className: 'metabolic-ring metabolic-ring--empty' },
        h('div', { className: 'metabolic-ring__placeholder' }, '‚ùì')
      );
    }

    const phaseColors = {
      anabolic: { primary: '#3b82f6', secondary: '#93c5fd', gradient: 'linear-gradient(135deg, #3b82f6, #60a5fa)' },
      transitional: { primary: '#f59e0b', secondary: '#fcd34d', gradient: 'linear-gradient(135deg, #f59e0b, #fbbf24)' },
      catabolic: { primary: '#22c55e', secondary: '#86efac', gradient: 'linear-gradient(135deg, #22c55e, #4ade80)' },
      unknown: { primary: '#6b7280', secondary: '#d1d5db', gradient: 'linear-gradient(135deg, #6b7280, #9ca3af)' }
    };

    const colors = phaseColors[phase.phase] || phaseColors.unknown;

    // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–∑—ã (–¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏)
    let progress = 0;
    if (phase.phase === 'anabolic') {
      progress = Math.min(100, (phase.hoursInPhase / 3) * 100);
    } else if (phase.phase === 'transitional') {
      progress = Math.min(100, ((phase.hoursInPhase - 3) / 2) * 100);
    } else if (phase.phase === 'catabolic') {
      progress = Math.min(100, ((phase.hoursInPhase - 5) / 3) * 100);
    }

    const radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (progress / 100) * circumference;

    return h('div', { className: `metabolic-ring metabolic-ring--${phase.phase}`, style: { width: size, height: size } },
      h('svg', {
        className: 'metabolic-ring__svg',
        viewBox: `0 0 ${size} ${size}`,
        style: { transform: 'rotate(-90deg)' }
      },
        // Background circle
        h('circle', {
          className: 'metabolic-ring__bg',
          cx: size / 2,
          cy: size / 2,
          r: radius,
          stroke: colors.secondary,
          strokeWidth: strokeWidth,
          fill: 'transparent',
          opacity: 0.3
        }),
        // Progress circle
        h('circle', {
          className: 'metabolic-ring__progress',
          cx: size / 2,
          cy: size / 2,
          r: radius,
          stroke: colors.primary,
          strokeWidth: strokeWidth,
          fill: 'transparent',
          strokeLinecap: 'round',
          strokeDasharray: circumference,
          strokeDashoffset: strokeDashoffset,
          style: { transition: 'stroke-dashoffset 0.5s ease-in-out' }
        })
      ),
      // Center content
      h('div', { className: 'metabolic-ring__center' },
        h('div', { className: 'metabolic-ring__emoji' }, phase.emoji),
        showLabel && h('div', { className: 'metabolic-ring__label' }, phase.label),
        phase.timeToLipolysis > 0 && h('div', { className: 'metabolic-ring__time' },
          `${Math.round(phase.timeToLipolysis * 60)} –º–∏–Ω`
        ),
        phase.isLipolysis && h('div', { className: 'metabolic-ring__lipolysis' }, 'üî• –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ!')
      )
    );
  }

  // === TRAFFIC LIGHT ‚Äî —Å–≤–µ—Ç–æ—Ñ–æ—Ä –¥–ª—è —Ä–∏—Å–∫–æ–≤ ===

  /**
   * RiskTrafficLight ‚Äî —Å–≤–µ—Ç–æ—Ñ–æ—Ä —Ä–∏—Å–∫–∞ —Å—Ä—ã–≤–∞
   * Low = –∑–µ–ª—ë–Ω—ã–π, Medium = –∂—ë–ª—Ç—ã–π, High = –∫—Ä–∞—Å–Ω—ã–π
   */
  function RiskTrafficLight({ riskLevel, riskValue, _factors, description, compact = false }) {
    const lights = [
      { level: 'low', color: '#22c55e', label: '–ù–∏–∑–∫–∏–π', emoji: '‚úÖ' },
      { level: 'medium', color: '#eab308', label: '–°—Ä–µ–¥–Ω–∏–π', emoji: '‚ö†Ô∏è' },
      { level: 'high', color: '#ef4444', label: '–í—ã—Å–æ–∫–∏–π', emoji: 'üö®' }
    ];

    const currentLevel = riskLevel || 'low';
    const currentLight = lights.find(l => l.level === currentLevel) || lights[0];

    if (compact) {
      return h('div', { className: `risk-traffic-light risk-traffic-light--compact risk-traffic-light--${currentLevel}` },
        h('div', { className: 'risk-traffic-light__indicator', style: { backgroundColor: currentLight.color } },
          currentLight.emoji
        ),
        h('span', { className: 'risk-traffic-light__label' }, currentLight.label),
        riskValue !== undefined && h('span', { className: 'risk-traffic-light__value' }, `${riskValue}%`)
      );
    }

    // –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (–Ω–µ compact)
    return h('div', { className: `risk-traffic-light risk-traffic-light--${currentLevel}` },
      h('div', { className: 'risk-traffic-light__header' },
        h('div', { className: 'risk-traffic-light__indicator', style: { backgroundColor: currentLight.color } },
          currentLight.emoji
        ),
        h('span', { className: 'risk-traffic-light__label' }, currentLight.label)
      ),
      riskValue !== undefined && h('div', { className: 'risk-traffic-light__value' }, `${riskValue}%`),
      description && h('div', { className: 'risk-traffic-light__description' }, description)
    );
  }


  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsightsPI.uiRings = {
    HealthRing,
    TotalHealthRing,
    StatusProgressRing,
    MiniRiskMeter,
    MetabolicStateRing,
    RiskTrafficLight
  };

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piUIRings = HEYS.InsightsPI.uiRings;

  // v3.0.1: 6 ring components (added RiskTrafficLight)

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_ui_cards.js ===== */
/**
 * HEYS Predictive Insights ‚Äî UI Card Components Module v3.0.2
 * Extracted UI card components for clean architecture
 * v3.0.2: Fixed analytics API access via getAnalyticsFn safe accessor
 */

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = HEYS.dev || global.HEYS?.dev || {};
  const devLog = DEV.log ? DEV.log.bind(DEV) : () => { };

  // React imports with retry mechanism for CDN loading
  function initModule() {
    const React = window.React;
    if (!React || !React.createElement) {
      // React not ready yet - retry in 50ms (CDN may still be loading)
      setTimeout(initModule, 50);
      return;
    }

    const { createElement: h, useState, useEffect, useMemo, Component } = React;

    const piStats = HEYS.InsightsPI?.stats || window.piStats || {};
    const piScience = HEYS.InsightsPI?.constants?.SCIENCE_INFO || window.piConst?.SCIENCE_INFO || HEYS.InsightsPI?.science || window.piScience || {};
    const piUIHelpers = HEYS.InsightsPI?.uiHelpers || window.piUIHelpers || {};

    // Safe accessor for analytics functions (may be in InsightsPI.analyticsAPI or PredictiveInsights)
    const getAnalyticsFn = (fnName) => {
      return HEYS.InsightsPI?.analyticsAPI?.[fnName] ||
        HEYS.InsightsPI?.[fnName] ||
        HEYS.PredictiveInsights?.[fnName] ||
        (() => ({ hasData: false, error: `${fnName} not loaded` }));
    };

    // Safe products index builder (buildIndex is not always available on HEYS.products)
    const getProductsList = (lsGet) => {
      let products = HEYS.products?.getAll?.() || [];
      if (!Array.isArray(products) || products.length === 0) {
        const storeGet = HEYS?.store?.get;
        if (storeGet) products = storeGet('heys_products', []);
        else if (lsGet) products = lsGet('heys_products', []);
        else products = HEYS?.utils?.lsGet?.('heys_products', []) || [];
      }
      if (products && !Array.isArray(products) && Array.isArray(products.products)) {
        products = products.products;
      }
      return Array.isArray(products) ? products : [];
    };

    const buildProductsIndex = (lsGet) => {
      const buildIndex = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
      if (!buildIndex) return null;
      const products = getProductsList(lsGet);
      return buildIndex(products);
    };

    const getMetabolismDate = (lsGet, selectedDate) => {
      const getter = lsGet || window.HEYS?.utils?.lsGet;
      const today = HEYS.dayUtils?.todayISO?.() || new Date().toISOString().split('T')[0];
      const baseDate = selectedDate || today;
      const canFallback = !selectedDate || selectedDate === today;
      if (!getter || !canFallback) return baseDate;

      const hasMetabolismData = (day) => {
        if (!day || typeof day !== 'object') return false;
        if ((day.meals || []).length > 0) return true;
        if ((day.trainings || []).length > 0) return true;
        if ((day.sleepHours || 0) > 0) return true;
        if (day.sleepStart || day.sleepEnd) return true;
        return false;
      };

      const baseDay = getter(`heys_dayv2_${baseDate}`, {});
      if (hasMetabolismData(baseDay)) return baseDate;

      for (let i = 1; i <= 14; i++) {
        const d = new Date(baseDate);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const day = getter(`heys_dayv2_${dateStr}`, {});
        if (hasMetabolismData(day)) return dateStr;
      }

      return baseDate;
    };

    // InfoButton is defined in pi_ui_dashboard.js which loads AFTER this module
    // Use lazy getter to defer resolution until runtime
    const getInfoButton = () => {
      if (typeof piUIHelpers.getInfoButton === 'function') {
        return piUIHelpers.getInfoButton(h);
      }
      return HEYS.InsightsPI?.uiDashboard?.InfoButton ||
        HEYS.PredictiveInsights?.components?.InfoButton ||
        // Fallback: simple button that does nothing if InfoButton not loaded
        function InfoButtonFallback({ infoKey, size }) {
          return h('span', {
            className: 'info-button-placeholder',
            title: infoKey,
            style: { cursor: 'help', opacity: 0.5 }
          }, '‚ÑπÔ∏è');
        };
    };

    // HealthRing is defined in pi_ui_rings.js - use lazy getter for load order
    const getHealthRing = () => {
      return HEYS.InsightsPI?.uiRings?.HealthRing ||
        function HealthRingFallback({ score, label, color }) {
          return h('div', { style: { color } }, label, ': ', score);
        };
    };
    // Create proxy to use HealthRing naturally in render
    const HealthRing = new Proxy({}, {
      apply: (_, thisArg, args) => h(getHealthRing(), args[0])
    });

    /**
     * CollapsibleSection ‚Äî —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è (v2.1: —Å InfoButton)
     * CRITICAL FIX: Always render InfoButton unconditionally to avoid hooks count changes
     */
    function CollapsibleSection({ title, icon, badge, children, defaultOpen = false, compact = false, infoKey }) {
      const [isOpen, setIsOpen] = useState(defaultOpen);

      const InfoButtonComp = getInfoButton();

      return h('div', { className: `insights-collapsible ${isOpen ? 'insights-collapsible--open' : ''} ${compact ? 'insights-collapsible--compact' : ''}` },
        h('div', {
          className: 'insights-collapsible__header',
          onClick: () => setIsOpen(!isOpen)
        },
          h('div', { className: 'insights-collapsible__title' },
            icon && h('span', { className: 'insights-collapsible__icon' }, icon),
            h('span', { className: 'insights-collapsible__text' }, title),
            // ALWAYS render InfoButton (even if infoKey is falsy) ‚Äî it will return null internally after hooks
            h(InfoButtonComp, { infoKey, size: 'small' })
          ),
          badge && h('span', { className: 'insights-collapsible__badge' }, badge),
          h('span', { className: 'insights-collapsible__chevron' }, '‚Ä∫')
        ),
        h('div', { className: 'insights-collapsible__content' }, children)
      );
    }

    /**
     * AdvancedAnalyticsCard ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ v3.0
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: Scientific Confidence, Correlations, Patterns, Risk, Energy + 6 –Ω–∞—É—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
     */
    function AdvancedAnalyticsCard({ lsGet, profile, pIndex, selectedDate }) {
      const [activeTab, setActiveTab] = useState('overview');

      // –í—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∫–ª—é—á–∞—è –Ω–∞—É—á–Ω—ã–µ v3.0
      const analytics = useMemo(() => {
        const opts = {
          lsGet: lsGet || window.HEYS?.utils?.lsGet,
          profile: profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          pIndex: pIndex || buildProductsIndex(lsGet || window.HEYS?.utils?.lsGet),
          selectedDate
        };

        return {
          confidence: getAnalyticsFn('calculateConfidenceScore')(opts),
          correlations: getAnalyticsFn('calculateCorrelationMatrix')(opts),
          patterns: getAnalyticsFn('detectMetabolicPatterns')(opts),
          risk: getAnalyticsFn('calculatePredictiveRisk')(opts),
          energy: getAnalyticsFn('forecastEnergy')(opts),
          // === SCIENTIFIC v3.0 ===
          bayesian: getAnalyticsFn('calculateBayesianConfidence')(opts),
          timeLag: getAnalyticsFn('calculateTimeLaggedCorrelations')(opts),
          gvi: getAnalyticsFn('calculateGlycemicVariability')(opts),
          allostatic: getAnalyticsFn('calculateAllostaticLoad')(opts),
          ews: getAnalyticsFn('detectEarlyWarningSignals')(opts),
          twoProcess: getAnalyticsFn('calculate2ProcessModel')(opts)
        };
      }, [lsGet, profile, pIndex, selectedDate]);

      const { confidence, correlations, patterns, risk, energy, bayesian, timeLag, gvi, allostatic, ews, twoProcess } = analytics;

      // Tabs ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ
      const tabs = [
        { id: 'overview', label: 'üìä', title: '–û–±–∑–æ—Ä' },
        { id: 'science', label: 'üî¨', title: '–ù–∞—É—á–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞' },
        { id: 'correlations', label: 'üîó', title: '–°–≤—è–∑–∏' },
        { id: 'patterns', label: 'üß¨', title: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã' },
        { id: 'risk', label: '‚ö†Ô∏è', title: '–†–∏—Å–∫–∏' },
        { id: 'energy', label: '‚ö°', title: '–≠–Ω–µ—Ä–≥–∏—è' }
      ];

      // Render Overview Tab
      const renderOverview = () => {
        return h('div', { className: 'adv-analytics__overview' },
          // Bayesian Confidence Badge (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
          bayesian.hasData ? h('div', { className: `adv-analytics__confidence adv-analytics__confidence--${bayesian.qualityGrade}` },
            h('div', { className: 'adv-analytics__confidence-score' },
              h('span', { className: 'adv-analytics__confidence-emoji' }, bayesian.gradeEmoji),
              h('span', { className: 'adv-analytics__confidence-value' }, `${bayesian.confidencePercent}%`),
              h('span', { className: 'adv-analytics__confidence-label' }, '–ë–∞–π–µ—Å–æ–≤—Å–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å')
            ),
            h('div', { className: 'adv-analytics__confidence-factors' },
              bayesian.mape !== null && h('div', { className: 'adv-analytics__factor' },
                h('span', null, 'üìâ MAPE'),
                h('span', null, `${bayesian.mape}%`)
              ),
              h('div', { className: 'adv-analytics__factor' },
                h('span', null, 'üìä –¢–æ—á–Ω–æ—Å—Ç—å'),
                h('span', null, `${bayesian.components.mapeLikelihood}%`)
              ),
              h('div', { className: 'adv-analytics__factor' },
                h('span', null, 'üìà –û–±—ä—ë–º'),
                h('span', null, `${bayesian.components.nLikelihood}%`)
              )
            ),
            h('div', { className: 'adv-analytics__confidence-advice' }, bayesian.message)
          ) :
            // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é confidence
            h('div', { className: `adv-analytics__confidence adv-analytics__confidence--${confidence.level}` },
              h('div', { className: 'adv-analytics__confidence-score' },
                h('span', { className: 'adv-analytics__confidence-emoji' }, confidence.levelEmoji),
                h('span', { className: 'adv-analytics__confidence-value' }, `${confidence.score}%`),
                h('span', { className: 'adv-analytics__confidence-label' }, confidence.levelLabel)
              ),
              h('div', { className: 'adv-analytics__confidence-factors' },
                h('div', { className: 'adv-analytics__factor' },
                  h('span', null, 'üìÖ –î–∞–Ω–Ω—ã–µ'),
                  h('span', null, `${confidence.factors.volume}%`)
                ),
                h('div', { className: 'adv-analytics__factor' },
                  h('span', null, 'üìã –ü–æ–ª–Ω–æ—Ç–∞'),
                  h('span', null, `${confidence.factors.completeness}%`)
                ),
                h('div', { className: 'adv-analytics__factor' },
                  h('span', null, 'üìà –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å'),
                  h('span', null, `${confidence.factors.consistency}%`)
                )
              ),
              h('div', { className: 'adv-analytics__confidence-advice' }, confidence.advice)
            ),

          // Quick Stats Row ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è
          h('div', { className: 'adv-analytics__quick-stats' },
            // EWS Score (–µ—Å–ª–∏ –µ—Å—Ç—å)
            ews.hasData && h('div', { className: `adv-analytics__stat adv-analytics__stat--${ews.criticalTransitionRisk}` },
              h('div', { className: 'adv-analytics__stat-icon' }, ews.riskEmoji),
              h('div', { className: 'adv-analytics__stat-value' }, `${ews.ewsScore}%`),
              h('div', { className: 'adv-analytics__stat-label' }, 'EWS —Ä–∏—Å–∫')
            ),
            // Allostatic Load
            allostatic.hasData && h('div', { className: `adv-analytics__stat adv-analytics__stat--${allostatic.riskLevel}` },
              h('div', { className: 'adv-analytics__stat-icon' }, allostatic.riskEmoji),
              h('div', { className: 'adv-analytics__stat-value' }, allostatic.alScore),
              h('div', { className: 'adv-analytics__stat-label' }, 'AL –Ω–∞–≥—Ä—É–∑–∫–∞')
            ),
            // GVI
            gvi.hasData && h('div', { className: `adv-analytics__stat adv-analytics__stat--${gvi.riskCategory}` },
              h('div', { className: 'adv-analytics__stat-icon' }, gvi.riskEmoji),
              h('div', { className: 'adv-analytics__stat-value' }, `${gvi.gvi}%`),
              h('div', { className: 'adv-analytics__stat-label' }, 'GVI')
            ),
            // 2-Process Alertness
            twoProcess.hasData && h('div', { className: `adv-analytics__stat adv-analytics__stat--${twoProcess.alertnessLevel}` },
              h('div', { className: 'adv-analytics__stat-icon' }, twoProcess.alertnessEmoji),
              h('div', { className: 'adv-analytics__stat-value' }, `${twoProcess.alertness}%`),
              h('div', { className: 'adv-analytics__stat-label' }, '–ë–æ–¥—Ä–æ—Å—Ç—å')
            )
          ),

          // Legacy Quick Stats
          h('div', { className: 'adv-analytics__quick-stats' },
            // Risk Score
            h('div', { className: `adv-analytics__stat adv-analytics__stat--${risk.riskLevel}` },
              h('div', { className: 'adv-analytics__stat-icon' }, risk.riskEmoji),
              h('div', { className: 'adv-analytics__stat-value' }, `${risk.riskScore}%`),
              h('div', { className: 'adv-analytics__stat-label' }, '–†–∏—Å–∫ —Å—Ä—ã–≤–∞')
            ),
            // Patterns Found
            h('div', { className: 'adv-analytics__stat' },
              h('div', { className: 'adv-analytics__stat-icon' }, 'üß¨'),
              h('div', { className: 'adv-analytics__stat-value' }, patterns.patterns.length),
              h('div', { className: 'adv-analytics__stat-label' }, '–ü–∞—Ç—Ç–µ—Ä–Ω–æ–≤')
            ),
            // Correlations Found
            h('div', { className: 'adv-analytics__stat' },
              h('div', { className: 'adv-analytics__stat-icon' }, 'üîó'),
              h('div', { className: 'adv-analytics__stat-value' }, correlations.correlations.filter(c => c.strength !== 'none').length),
              h('div', { className: 'adv-analytics__stat-label' }, '–°–≤—è–∑–µ–π')
            ),
            // Causality
            timeLag.hasData && h('div', { className: 'adv-analytics__stat' },
              h('div', { className: 'adv-analytics__stat-icon' }, '‚è≥'),
              h('div', { className: 'adv-analytics__stat-value' }, timeLag.confirmedCount),
              h('div', { className: 'adv-analytics__stat-label' }, '–ü—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç–µ–π')
            )
          )
        );
      };

      // === RENDER SCIENCE TAB (–Ω–æ–≤—ã–π) ===
      const renderScience = () => {
        return h('div', { className: 'adv-analytics__science' },

          // Bayesian Section
          bayesian.hasData && h('div', { className: 'adv-analytics__science-section' },
            h('div', { className: 'adv-analytics__science-header' },
              h('span', null, 'üìä –ë–∞–π–µ—Å–æ–≤—Å–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å'),
              h(getInfoButton(), { infoKey: 'BAYESIAN_CONFIDENCE' })
            ),
            h('div', { className: `adv-analytics__science-card adv-analytics__science-card--${bayesian.qualityGrade}` },
              h('div', { className: 'adv-analytics__science-main' },
                h('span', { className: 'adv-analytics__science-emoji' }, bayesian.gradeEmoji),
                h('span', { className: 'adv-analytics__science-value' }, `${bayesian.confidencePercent}%`)
              ),
              bayesian.mape !== null && h('div', { className: 'adv-analytics__science-detail' },
                `MAPE: ${bayesian.mape}% | R¬≤: ${bayesian.crossValidation?.r2?.toFixed(2) || 'N/A'}`
              ),
              h('div', { className: 'adv-analytics__science-insight' }, bayesian.message)
            )
          ),

          // GVI Section
          gvi.hasData && h('div', { className: 'adv-analytics__science-section' },
            h('div', { className: 'adv-analytics__science-header' },
              h('span', null, 'üìà –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å'),
              h(getInfoButton(), { infoKey: 'GLYCEMIC_VARIABILITY' })
            ),
            h('div', { className: `adv-analytics__science-card adv-analytics__science-card--${gvi.riskCategory}` },
              h('div', { className: 'adv-analytics__science-main' },
                h('span', { className: 'adv-analytics__science-emoji' }, gvi.riskEmoji),
                h('span', { className: 'adv-analytics__science-value' }, `CV ${gvi.gvi}%`)
              ),
              h('div', { className: 'adv-analytics__science-detail' },
                `CONGA: ${gvi.conga} | Mean GL: ${gvi.mealGLMean}`
              ),
              h('div', { className: 'adv-analytics__science-insight' }, gvi.riskLabel),
              gvi.recommendations.length > 0 && h('div', { className: 'adv-analytics__science-recs' },
                gvi.recommendations.map((r, i) => h('div', { key: i }, r))
              )
            )
          ),

          // Allostatic Load Section
          allostatic.hasData && h('div', { className: 'adv-analytics__science-section' },
            h('div', { className: 'adv-analytics__science-header' },
              h('span', null, 'üß† –ê–ª–ª–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞'),
              h(getInfoButton(), { infoKey: 'ALLOSTATIC_LOAD' })
            ),
            h('div', { className: `adv-analytics__science-card adv-analytics__science-card--${allostatic.riskLevel}` },
              h('div', { className: 'adv-analytics__science-main' },
                h('span', { className: 'adv-analytics__science-emoji' }, allostatic.riskEmoji),
                h('span', { className: 'adv-analytics__science-value' }, allostatic.alScore)
              ),
              h('div', { className: 'adv-analytics__science-detail' }, allostatic.riskLabel),
              // Components
              h('div', { className: 'adv-analytics__science-components' },
                Object.entries(allostatic.components).map(([key, comp]) =>
                  h('div', {
                    key,
                    className: `adv-analytics__al-component ${comp.status === 'elevated' ? 'adv-analytics__al-component--elevated' : ''}`
                  },
                    h('span', null, comp.label),
                    h('span', null, `${comp.score}%`)
                  )
                )
              ),
              allostatic.recovery.length > 0 && h('div', { className: 'adv-analytics__science-recs' },
                allostatic.recovery.map((r, i) => h('div', { key: i }, r))
              )
            )
          ),

          // Early Warning Signals Section
          ews.hasData && h('div', { className: 'adv-analytics__science-section' },
            h('div', { className: 'adv-analytics__science-header' },
              h('span', null, '‚ö†Ô∏è –†–∞–Ω–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã —Å—Ä—ã–≤–∞'),
              h(getInfoButton(), { infoKey: 'EARLY_WARNING_SIGNALS' })
            ),
            h('div', { className: `adv-analytics__science-card adv-analytics__science-card--${ews.criticalTransitionRisk}` },
              h('div', { className: 'adv-analytics__science-main' },
                h('span', { className: 'adv-analytics__science-emoji' }, ews.riskEmoji),
                h('span', { className: 'adv-analytics__science-value' }, `EWS ${ews.ewsScore}%`)
              ),
              h('div', { className: 'adv-analytics__science-detail' }, ews.prediction),
              // Signals
              h('div', { className: 'adv-analytics__ews-signals' },
                ews.signals.map((s, i) =>
                  h('div', {
                    key: i,
                    className: `adv-analytics__ews-signal ${s.detected ? 'adv-analytics__ews-signal--active' : ''}`
                  },
                    h('span', null, s.label),
                    h('span', null, s.detected ? '‚ö†Ô∏è' : '‚úÖ'),
                    h('div', { className: 'adv-analytics__ews-insight' }, s.insight)
                  )
                )
              )
            )
          ),

          // 2-Process Model Section
          twoProcess.hasData && h('div', { className: 'adv-analytics__science-section' },
            h('div', { className: 'adv-analytics__science-header' },
              h('span', null, 'üí§ –ú–æ–¥–µ–ª—å –±–æ–¥—Ä–æ—Å—Ç–∏ (Borb√©ly)'),
              h(getInfoButton(), { infoKey: 'TWO_PROCESS_MODEL' })
            ),
            h('div', { className: `adv-analytics__science-card adv-analytics__science-card--${twoProcess.alertnessLevel}` },
              h('div', { className: 'adv-analytics__science-main' },
                h('span', { className: 'adv-analytics__science-emoji' }, twoProcess.alertnessEmoji),
                h('span', { className: 'adv-analytics__science-value' }, `${twoProcess.alertness}%`)
              ),
              h('div', { className: 'adv-analytics__science-detail' },
                `Process S: ${twoProcess.processS}% | Process C: ${twoProcess.processC}%`
              ),
              h('div', { className: 'adv-analytics__science-detail' },
                `–ë–æ–¥—Ä—Å—Ç–≤—É–µ—à—å: ${twoProcess.hoursAwake}—á | –î–æ–ª–≥ —Å–Ω–∞: ${twoProcess.sleepDebt}—á`
              ),
              // Peak/Dip windows
              h('div', { className: 'adv-analytics__2p-windows' },
                h('div', { className: 'adv-analytics__2p-window adv-analytics__2p-window--peak' },
                  'üî• –ü–∏–∫: ', twoProcess.peakWindow.hour, ':00 (', twoProcess.peakWindow.alertness, '%)'
                ),
                h('div', { className: 'adv-analytics__2p-window adv-analytics__2p-window--dip' },
                  'üò¥ –°–ø–∞–¥: ', twoProcess.dipWindow.hour, ':00 (', twoProcess.dipWindow.alertness, '%)'
                )
              ),
              twoProcess.recommendations.length > 0 && h('div', { className: 'adv-analytics__science-recs' },
                twoProcess.recommendations.map((r, i) => h('div', { key: i }, r))
              )
            )
          ),

          // Time-Lagged Correlations Section
          timeLag.hasData && h('div', { className: 'adv-analytics__science-section' },
            h('div', { className: 'adv-analytics__science-header' },
              h('span', null, '‚è≥ –ü—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å (Time-Lag)'),
              h(getInfoButton(), { infoKey: 'TIME_LAGGED_CORRELATIONS' })
            ),
            h('div', { className: 'adv-analytics__science-card' },
              timeLag.strongest && h('div', { className: 'adv-analytics__science-main' },
                h('span', { className: 'adv-analytics__science-emoji' },
                  timeLag.strongest.hasCausality ? '‚úÖ' : 'üìä'
                ),
                h('span', { className: 'adv-analytics__science-value' }, timeLag.strongest.label)
              ),
              h('div', { className: 'adv-analytics__science-detail' },
                `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π: ${timeLag.confirmedCount} –∏–∑ ${timeLag.totalAnalyzed}`
              ),
              // Causal Links
              h('div', { className: 'adv-analytics__causality-list' },
                timeLag.lagAnalysis.slice(0, 5).map((link, i) =>
                  h('div', {
                    key: i,
                    className: `adv-analytics__causality-item ${link.hasCausality ? 'adv-analytics__causality-item--confirmed' : ''}`
                  },
                    h('div', { className: 'adv-analytics__causality-label' }, link.label),
                    h('div', { className: 'adv-analytics__causality-detail' },
                      `r=${link.bestCorrelation} (–ª–∞–≥ ${link.bestLag}–¥)`
                    ),
                    h('div', { className: 'adv-analytics__causality-strength' },
                      link.causalStrength === 'confirmed' ? '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' :
                        link.causalStrength === 'possible' ? 'üìä –í–æ–∑–º–æ–∂–Ω–æ' : '‚ö™ –°–ª–∞–±–æ'
                    )
                  )
                )
              )
            )
          )
        );
      };

      // Render Correlations Tab
      const renderCorrelations = () => {
        if (!correlations.hasData) {
          return h('div', { className: 'adv-analytics__empty' },
            h('div', null, 'üìä'),
            h('div', null, '–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 7 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö')
          );
        }

        return h('div', { className: 'adv-analytics__correlations' },
          // Insights
          correlations.insights.map((insight, i) =>
            h('div', { key: i, className: 'adv-analytics__insight' }, insight)
          ),

          // Correlation List
          h('div', { className: 'adv-analytics__corr-list' },
            correlations.correlations.slice(0, 6).map((corr, i) =>
              h('div', {
                key: i,
                className: `adv-analytics__corr-item adv-analytics__corr-item--${corr.strength}`
              },
                h('div', { className: 'adv-analytics__corr-label' }, corr.label),
                h('div', { className: 'adv-analytics__corr-bar' },
                  h('div', {
                    className: `adv-analytics__corr-fill adv-analytics__corr-fill--${corr.direction}`,
                    style: { width: `${Math.abs(corr.correlation) * 100}%` }
                  })
                ),
                h('div', { className: 'adv-analytics__corr-value' },
                  `${corr.correlation > 0 ? '+' : ''}${Math.round(corr.correlation * 100)}%`
                )
              )
            )
          )
        );
      };

      // Render Patterns Tab
      const renderPatterns = () => {
        if (!patterns.hasData) {
          return h('div', { className: 'adv-analytics__empty' },
            h('div', null, 'üß¨'),
            h('div', null, '–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤–µ—Å—Ç–∏ —É—á—ë—Ç –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤')
          );
        }

        return h('div', { className: 'adv-analytics__patterns' },
          patterns.patterns.map((pattern, i) =>
            h('div', { key: i, className: `adv-analytics__pattern adv-analytics__pattern--${pattern.level}` },
              h('div', { className: 'adv-analytics__pattern-header' },
                h('span', { className: 'adv-analytics__pattern-label' }, pattern.label),
                h('span', { className: 'adv-analytics__pattern-level' }, pattern.level)
              ),
              h('div', { className: 'adv-analytics__pattern-insight' }, pattern.insight)
            )
          ),

          // Recommendations
          patterns.recommendations.length > 0 && h('div', { className: 'adv-analytics__recommendations' },
            h('div', { className: 'adv-analytics__recommendations-title' }, 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'),
            patterns.recommendations.map((rec, i) =>
              h('div', { key: i, className: 'adv-analytics__recommendation' }, rec)
            )
          )
        );
      };

      // Render Risk Tab
      const renderRisk = () => {
        return h('div', { className: 'adv-analytics__risk' },
          // Main Risk Score
          h('div', { className: `adv-analytics__risk-main adv-analytics__risk-main--${risk.riskLevel}` },
            h('div', { className: 'adv-analytics__risk-score' },
              h('span', { className: 'adv-analytics__risk-emoji' }, risk.riskEmoji),
              h('span', { className: 'adv-analytics__risk-value' }, `${risk.riskScore}%`)
            ),
            h('div', { className: 'adv-analytics__risk-label' }, risk.riskLabel + ' —Ä–∏—Å–∫'),
            h('div', { className: 'adv-analytics__risk-prediction' }, risk.prediction)
          ),

          // Risk Factors
          h('div', { className: 'adv-analytics__risk-factors' },
            risk.factors.map((factor, i) =>
              h('div', {
                key: i,
                className: `adv-analytics__risk-factor ${factor.risk > 50 ? 'adv-analytics__risk-factor--high' : ''}`
              },
                h('div', { className: 'adv-analytics__risk-factor-header' },
                  h('span', null, factor.name),
                  h('span', null, `${factor.risk}%`)
                ),
                h('div', { className: 'adv-analytics__risk-factor-bar' },
                  h('div', {
                    className: 'adv-analytics__risk-factor-fill',
                    style: { width: `${factor.risk}%` }
                  })
                ),
                h('div', { className: 'adv-analytics__risk-factor-insight' }, factor.insight)
              )
            )
          )
        );
      };

      // Render Energy Tab
      const renderEnergy = () => {
        const { hourlyForecast, currentHour, peakWindow, dipWindow, recommendations } = energy;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ —á–∞—Å—ã + —Ç–µ–∫—É—â–∏–π
        const visibleHours = hourlyForecast.filter(h => h.hour >= currentHour && h.hour <= 23);

        return h('div', { className: 'adv-analytics__energy' },
          // Energy Graph (simplified bar chart)
          h('div', { className: 'adv-analytics__energy-graph' },
            visibleHours.map((hr, i) =>
              h('div', {
                key: i,
                className: `adv-analytics__energy-bar adv-analytics__energy-bar--${hr.level}`,
                style: { height: `${hr.energy}%` },
                title: `${hr.hour}:00 ‚Äî ${hr.energy}%`
              },
                h('span', { className: 'adv-analytics__energy-label' }, hr.hour)
              )
            )
          ),

          // Peak & Dip Windows
          h('div', { className: 'adv-analytics__energy-windows' },
            h('div', { className: 'adv-analytics__energy-window adv-analytics__energy-window--peak' },
              h('span', null, 'üî•'),
              h('span', null, `–ü–∏–∫: ${peakWindow.hour}:00`),
              h('span', null, `${peakWindow.energy}%`)
            ),
            h('div', { className: 'adv-analytics__energy-window adv-analytics__energy-window--dip' },
              h('span', null, 'üò¥'),
              h('span', null, `–°–ø–∞–¥: ${dipWindow.hour}:00`),
              h('span', null, `${dipWindow.energy}%`)
            )
          ),

          // Recommendations
          h('div', { className: 'adv-analytics__energy-recs' },
            recommendations.map((rec, i) =>
              h('div', { key: i, className: 'adv-analytics__energy-rec' }, rec)
            )
          )
        );
      };

      // Tab content mapping
      const tabContent = {
        overview: renderOverview,
        science: renderScience,
        correlations: renderCorrelations,
        patterns: renderPatterns,
        risk: renderRisk,
        energy: renderEnergy
      };

      return h('div', { className: 'adv-analytics-card' },
        // Header
        h('div', { className: 'adv-analytics-card__header' },
          h('div', { className: 'adv-analytics-card__title' },
            h('span', null, 'üî¨'),
            h('span', null, '–ù–∞—É—á–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ v3'),
            h(getInfoButton(), { infoKey: 'ADVANCED_ANALYTICS' })
          ),
          // Confidence Badge (mini)
          h('div', { className: `adv-analytics-card__confidence-mini adv-analytics-card__confidence-mini--${bayesian.hasData ? bayesian.qualityGrade : confidence.level}` },
            bayesian.hasData ? bayesian.gradeEmoji : confidence.levelEmoji,
            ` ${bayesian.hasData ? bayesian.confidencePercent : confidence.score}%`
          )
        ),

        // Tabs
        h('div', { className: 'adv-analytics-card__tabs' },
          tabs.map(tab =>
            h('button', {
              key: tab.id,
              className: `adv-analytics-card__tab ${activeTab === tab.id ? 'adv-analytics-card__tab--active' : ''}`,
              onClick: () => setActiveTab(tab.id),
              title: tab.title
            }, tab.label)
          )
        ),

        // Content
        h('div', { className: 'adv-analytics-card__content' },
          tabContent[activeTab]?.()
        )
      );
    }

    /**
     * MetabolismCard ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –æ–¥–Ω–æ–≥–æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è (v2.0: —Å InfoButton)
     */
    function MetabolismCard({ title, icon, value, unit, quality, insight, pmid, details, infoKey, debugData }) {
      const [showDetails, setShowDetails] = useState(false);

      const qualityColors = {
        excellent: '#22c55e',
        good: '#10b981',
        normal: '#3b82f6',
        low: '#f59e0b',
        warning: '#ef4444'
      };
      const color = qualityColors[quality] || qualityColors.normal;

      const InfoButtonComp = getInfoButton();

      return h('div', {
        className: `insights-metabolism-card insights-metabolism-card--${quality} ${showDetails ? 'insights-metabolism-card--expanded' : ''}`,
        onClick: () => setShowDetails(!showDetails)
      },
        h('div', { className: 'insights-metabolism-card__header' },
          h('div', { className: 'insights-metabolism-card__icon', style: { color } }, icon),
          h('div', { className: 'insights-metabolism-card__info' },
            h('div', { className: 'insights-metabolism-card__title' },
              title,
              // ALWAYS render InfoButton to avoid hooks count changes
              h(InfoButtonComp, { infoKey, debugData })
            ),
            h('div', { className: 'insights-metabolism-card__value' },
              h('span', { style: { color, fontWeight: 700 } }, value),
              unit && h('span', { className: 'insights-metabolism-card__unit' }, ' ', unit)
            )
          ),
          pmid && h('a', {
            className: 'insights-metabolism-card__pmid',
            href: `https://pubmed.ncbi.nlm.nih.gov/${pmid}`,
            target: '_blank',
            rel: 'noopener',
            onClick: e => e.stopPropagation()
          }, 'üìö')
        ),
        showDetails && h('div', { className: 'insights-metabolism-card__details' },
          h('div', { className: 'insights-metabolism-card__insight' }, insight),
          details && h('div', { className: 'insights-metabolism-card__breakdown' }, details)
        )
      );
    }

    /**
     * MetabolismSection ‚Äî —Å–µ–∫—Ü–∏—è –Ω–∞—É—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (v2.0: —Å InfoButtons)
     */
    function MetabolismSection({ lsGet, profile, pIndex, selectedDate }) {
      const resolvedDate = useMemo(() => {
        return getMetabolismDate(lsGet || window.HEYS?.utils?.lsGet, selectedDate);
      }, [lsGet, selectedDate]);

      const metabolism = useMemo(() => {
        return getAnalyticsFn('analyzeMetabolism')({
          lsGet: lsGet || window.HEYS?.utils?.lsGet,
          profile: profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          pIndex: pIndex || buildProductsIndex(lsGet || window.HEYS?.utils?.lsGet),
          selectedDate: resolvedDate
        });
      }, [lsGet, profile, pIndex, resolvedDate]);

      if (!metabolism || !metabolism.hasData) {
        return h('div', { className: 'insights-metabolism-empty' },
          h('div', { className: 'insights-metabolism-empty__icon' }, 'üìä'),
          '–î–æ–±–∞–≤—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞'
        );
      }

      const { tefAnalysis, epocAnalysis, hormonalBalance, adaptiveThermogenesis } = metabolism;

      // –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å–≤–æ–¥–∫–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const summaryParts = [];
      if (tefAnalysis.percent > 0) summaryParts.push(`TEF ${tefAnalysis.percent}%`);
      if (epocAnalysis.kcal > 0) summaryParts.push(`EPOC +${epocAnalysis.kcal}`);
      if (hormonalBalance.isDisrupted) summaryParts.push('‚ö†Ô∏è –ì–æ—Ä–º–æ–Ω—ã');
      else summaryParts.push('‚úì –ì–æ—Ä–º–æ–Ω—ã');

      const today = HEYS.dayUtils?.todayISO?.() || new Date().toISOString().split('T')[0];
      const baseDate = selectedDate || today;
      const isFallbackDate = resolvedDate && resolvedDate !== baseDate;
      if (isFallbackDate) {
        const shortDate = resolvedDate.split('-').reverse().slice(0, 2).join('.');
        summaryParts.push(`–¥–∞–Ω–Ω—ã–µ –∑–∞ ${shortDate}`);
      }

      return h('div', { className: 'metabolism-section' },
        // Header —Å InfoButton
        h('div', { className: 'metabolism-section__header' },
          h('div', { className: 'metabolism-section__title' },
            h('span', { className: 'metabolism-section__icon' }, 'üî•'),
            h('span', null, '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º'),
            h(getInfoButton(), { infoKey: 'TEF' })
          ),
          h('div', { className: 'metabolism-section__badge' }, summaryParts.join(' ‚Ä¢ '))
        ),
        // Content
        h('div', { className: 'insights-metabolism' },
          // TEF ‚Äî v2.0: –¥–æ–±–∞–≤–ª–µ–Ω infoKey –∏ debugData
          h(MetabolismCard, {
            title: '–¢–µ—Ä–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç (TEF)',
            icon: 'üî•',
            value: tefAnalysis.total,
            unit: '–∫–∫–∞–ª',
            quality: tefAnalysis.quality,
            insight: tefAnalysis.insight,
            pmid: tefAnalysis.pmid,
            details: `–ë–µ–ª–æ–∫: ${tefAnalysis.breakdown.protein} | –£–≥–ª–µ–≤–æ–¥—ã: ${tefAnalysis.breakdown.carbs} | –ñ–∏—Ä—ã: ${tefAnalysis.breakdown.fat}`,
            infoKey: 'TEF',
            debugData: {
              breakdown: tefAnalysis.breakdown,
              percent: tefAnalysis.percent,
              quality: tefAnalysis.quality
            }
          }),

          // EPOC ‚Äî v2.0: –¥–æ–±–∞–≤–ª–µ–Ω infoKey –∏ debugData
          epocAnalysis.hasTraining && h(MetabolismCard, {
            title: '–î–æ–∂–∏–≥ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (EPOC)',
            icon: '‚ö°',
            value: epocAnalysis.kcal > 0 ? `+${epocAnalysis.kcal}` : '‚Äî',
            unit: '–∫–∫–∞–ª',
            quality: epocAnalysis.kcal > 50 ? 'excellent' : epocAnalysis.kcal > 20 ? 'good' : 'normal',
            insight: epocAnalysis.insight,
            pmid: epocAnalysis.pmid,
            details: `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${epocAnalysis.trainingKcal} –∫–∫–∞–ª`,
            infoKey: 'EPOC',
            debugData: {
              epocKcal: epocAnalysis.kcal,
              trainingKcal: epocAnalysis.trainingKcal,
              hasTraining: epocAnalysis.hasTraining
            }
          }),

          // –ì–æ—Ä–º–æ–Ω—ã ‚Äî v2.0: –¥–æ–±–∞–≤–ª–µ–Ω infoKey –∏ debugData
          h(MetabolismCard, {
            title: '–ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å',
            icon: 'üò¥',
            value: hormonalBalance.isDisrupted ? `+${hormonalBalance.ghrelinIncrease}%` : '‚úì',
            unit: hormonalBalance.isDisrupted ? '–≥–æ–ª–æ–¥' : '–Ω–æ—Ä–º–∞',
            quality: hormonalBalance.ghrelinIncrease > 15 ? 'warning' : hormonalBalance.ghrelinIncrease > 0 ? 'low' : 'good',
            insight: hormonalBalance.insight,
            pmid: hormonalBalance.pmid,
            details: hormonalBalance.sleepDebt > 0 ? `–ù–µ–¥–æ—Å—ã–ø: ${hormonalBalance.sleepDebt} —á` : '–°–æ–Ω –≤ –Ω–æ—Ä–º–µ',
            infoKey: 'HORMONES',
            debugData: {
              sleepDebt: hormonalBalance.sleepDebt,
              ghrelinIncrease: hormonalBalance.ghrelinIncrease,
              leptinDecrease: hormonalBalance.leptinDecrease
            }
          }),

          // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑ ‚Äî v2.0: –¥–æ–±–∞–≤–ª–µ–Ω infoKey –∏ debugData
          adaptiveThermogenesis.isAdapted && h(MetabolismCard, {
            title: '–ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞',
            icon: 'üìâ',
            value: `-${Math.round(adaptiveThermogenesis.metabolicReduction * 100)}%`,
            unit: '–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ',
            quality: 'warning',
            insight: adaptiveThermogenesis.insight,
            pmid: adaptiveThermogenesis.pmid,
            details: `–î–Ω–µ–π –≤ –∂—ë—Å—Ç–∫–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ: ${adaptiveThermogenesis.chronicDeficitDays}`,
            infoKey: 'ADAPTIVE',
            debugData: {
              chronicDeficitDays: adaptiveThermogenesis.chronicDeficitDays,
              metabolicReduction: adaptiveThermogenesis.metabolicReduction
            }
          })
        )
      );
    }

    /**
     * HealthRingsGrid ‚Äî —Å–µ—Ç–∫–∞ –∫–æ–ª–µ—Ü –∑–¥–æ—Ä–æ–≤—å—è
     * v3.22.0: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è emotionalRisk overlay –¥–ª—è Recovery
     */
    function HealthRingsGrid({ healthScore, onCategoryClick, compact, lsGet }) {
      if (!healthScore || !healthScore.breakdown) return null;

      // üÜï v3.22.0: –í—ã—á–∏—Å–ª—è–µ–º emotionalRisk –¥–ª—è Recovery overlay
      const emotionalRiskData = useMemo(() => {
        const U = window.HEYS?.utils;
        const getter = lsGet || U?.lsGet || ((k, d) => {
          try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
        });
        const profile = getter('heys_profile', {});
        const todayDate = new Date().toISOString().split('T')[0];
        const day = getter(`heys_dayv2_${todayDate}`, {});

        const stressAvg = day.stressAvg || 0;
        const factors = [];
        let bingeRisk = 0;

        if (stressAvg >= 6) { factors.push('–°—Ç—Ä–µ—Å—Å'); bingeRisk += 35; }
        else if (stressAvg >= 4) { factors.push('–°—Ç—Ä–µ—Å—Å'); bingeRisk += 15; }

        const hour = new Date().getHours();
        if (hour >= 20) bingeRisk += 20;

        const sleepDeficit = (profile.sleepHours || 8) - (day.sleepHours || 0);
        if (sleepDeficit > 2) { factors.push('–ù–µ–¥–æ—Å—ã–ø'); bingeRisk += 15; }

        return {
          hasRisk: bingeRisk >= 30,
          bingeRisk: Math.min(90, bingeRisk),
          factors,
          level: bingeRisk >= 60 ? 'high' : bingeRisk >= 40 ? 'medium' : 'low'
        };
      }, [lsGet]);

      const categories = [
        { key: 'nutrition', label: '–ü–∏—Ç–∞–Ω–∏–µ', color: '#22c55e', infoKey: 'CATEGORY_NUTRITION' },
        { key: 'timing', label: '–¢–∞–π–º–∏–Ω–≥', color: '#3b82f6', infoKey: 'CATEGORY_TIMING' },
        { key: 'activity', label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', color: '#f59e0b', infoKey: 'CATEGORY_ACTIVITY' },
        { key: 'recovery', label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', color: '#8b5cf6', infoKey: 'CATEGORY_RECOVERY' },
        { key: 'metabolism', label: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', color: '#f43f5e', infoKey: 'CATEGORY_METABOLISM' }
      ];

      // Compact mode: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
      if (compact) {
        return h('div', { className: 'insights-rings-compact' },
          categories.map(cat => {
            const score = healthScore.breakdown[cat.key]?.score || 0;
            const radius = 15;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score / 100) * circumference;

            // üÜï emotionalRisk overlay –¥–ª—è Recovery
            const hasEmotionalWarning = cat.key === 'recovery' && emotionalRiskData.hasRisk;

            // üé® –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è "—Å–≤–µ—Ç–æ—Ñ–æ—Ä" (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω)
            const getScoreColor = (s) => {
              if (s >= 80) return 'excellent'; // –ó–µ–ª–µ–Ω—ã–π
              if (s >= 60) return 'good';      // –ñ–µ–ª—Ç—ã–π
              if (s >= 40) return 'fair';      // –û—Ä–∞–Ω–∂–µ–≤—ã–π
              return 'poor';                   // –ö—Ä–∞—Å–Ω—ã–π
            };

            return h('div', {
              key: cat.key,
              className: 'insights-ring-mini-wrapper'
            },
              // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–µ—Ä—Ö—É (–±–µ–∑ info-–∫–Ω–æ–ø–∫–∏)
              h('div', { className: 'insights-ring-mini-header' },
                h('span', { className: 'insights-ring-mini-header__name' }, cat.label)
              ),
              // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–ª—å—Ü–æ–º + —Ü–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
              h('div', {
                className: `insights-ring-mini insights-ring-mini--${cat.key} insights-ring-mini--${getScoreColor(score)} ${hasEmotionalWarning ? 'insights-ring-mini--warning' : ''}`,
                onClick: () => onCategoryClick && onCategoryClick(cat.key)
              },
                // Mini ring (36x36)
                h('div', { className: 'insights-ring-mini__ring' },
                  h('svg', { width: 36, height: 36, viewBox: '0 0 36 36' },
                    h('circle', {
                      cx: 18, cy: 18, r: radius,
                      fill: 'none',
                      stroke: 'rgba(0,0,0,0.06)',
                      strokeWidth: 3
                    }),
                    h('circle', {
                      cx: 18, cy: 18, r: radius,
                      fill: 'none',
                      stroke: hasEmotionalWarning ? '#f87171' : cat.color,
                      strokeWidth: 3,
                      strokeLinecap: 'round',
                      strokeDasharray: circumference,
                      strokeDashoffset: offset,
                      style: { transition: 'stroke-dashoffset 0.8s ease' }
                    })
                  ),
                  h('span', { className: 'insights-ring-mini__value' }, Math.round(score)),
                  hasEmotionalWarning && h('span', {
                    className: 'insights-ring-mini__badge',
                    title: `–≠–º–æ—Ü. —Ä–∏—Å–∫: ${emotionalRiskData.bingeRisk}%\n${emotionalRiskData.factors.join(', ')}`
                  }, 'üß†')
                ),
                // Status (–∫–æ—Ä–æ—Ç–∫–∏–π —ç–º–æ–¥–∑–∏)
                h('div', { className: 'insights-ring-mini__status' },
                  hasEmotionalWarning
                    ? '‚ö†Ô∏è'
                    : score >= 80 ? '‚úÖ' : score >= 60 ? 'üëç' : score >= 40 ? '‚ûñ' : '‚ö°'
                )
              ),
              // Info-–∫–Ω–æ–ø–∫–∞ —Å–Ω–∏–∑—É (–ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π)
              h('div', { className: 'insights-ring-mini-footer' },
                h(getInfoButton(), { infoKey: cat.infoKey, size: 'small' })
              )
            );
          })
        );
      }

      // Full mode: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–ª—å—Ü–∞
      return h('div', { className: 'insights-rings' },
        categories.map(cat =>
          h(HealthRing, {
            key: cat.key,
            score: healthScore.breakdown[cat.key]?.score,
            category: cat.key,
            label: cat.label,
            color: cat.key === 'recovery' && emotionalRiskData.hasRisk ? '#f87171' : cat.color,
            onClick: onCategoryClick,
            infoKey: cat.infoKey,
            debugData: healthScore.breakdown[cat.key],
            emotionalWarning: cat.key === 'recovery' ? emotionalRiskData : null
          })
        )
      );
    }

    /**
     * Pattern Card ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –æ–¥–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (v2.0: —Å InfoButton)
     */
    function PatternCard({ pattern }) {
      if (!pattern || !pattern.available) return null;

      const iconClass = pattern.score >= 70 ? 'good' : pattern.score >= 40 ? 'warn' : 'bad';
      const icon = pattern.score >= 70 ? '‚úì' : pattern.score >= 40 ? '!' : '‚úó';

      const patternLabels = {
        meal_timing: '‚è±Ô∏è –¢–∞–π–º–∏–Ω–≥ –µ–¥—ã',
        wave_overlap: 'üåä –ü–µ—Ä–µ—Ö–ª—ë—Å—Ç –≤–æ–ª–Ω',
        late_eating: 'üåô –ü–æ–∑–¥–Ω—è—è –µ–¥–∞',
        meal_quality: 'üçΩÔ∏è –ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã',
        sleep_weight: 'üí§ –°–æ–Ω ‚Üí –í–µ—Å',
        sleep_hunger: 'üò¥ –°–æ–Ω ‚Üí –ì–æ–ª–æ–¥',
        training_kcal: 'üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
        steps_weight: 'üëü –®–∞–≥–∏ ‚Üí –í–µ—Å',
        protein_satiety: 'ü•© –ë–µ–ª–æ–∫',
        fiber_regularity: 'ü•ó –ö–ª–µ—Ç—á–∞—Ç–∫–∞',
        stress_eating: 'üò∞ –°—Ç—Ä–µ—Å—Å ‚Üí –ï–¥–∞',
        mood_food: 'üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
        // v2.0: –Ω–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        circadian: 'üåÖ –¶–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã',
        nutrient_timing: '‚è∞ –¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
        insulin_sensitivity: 'üìâ –ò–Ω—Å—É–ª–∏–Ω. —á—É–≤—Å—Ç–≤.',
        gut_health: 'ü¶† –ó–¥–æ—Ä–æ–≤—å–µ –ñ–ö–¢',
        // v4.0: B1-B6 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        sleep_quality: 'üí§ –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞',
        wellbeing_correlation: 'üå°Ô∏è –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ',
        hydration: 'üíß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è',
        body_composition: 'üìê –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ–ª–∞',
        cycle_impact: 'üîÑ –í–ª–∏—è–Ω–∏–µ —Ü–∏–∫–ª–∞',
        weekend_effect: 'üìÖ –≠—Ñ—Ñ–µ–∫—Ç –≤—ã—Ö–æ–¥–Ω—ã—Ö',
        // v4.0: C1-C6 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        nutrition_quality: 'ü•ó –ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è',
        neat_activity: 'üèÉ NEAT-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        mood_trajectory: 'üòä –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è',
        // v5.0: C7-C12 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        micronutrient_radar: 'üß™ –ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã',
        omega_balancer: 'üßà –û–º–µ–≥–∞-–±–∞–ª–∞–Ω—Å',
        heart_health: '‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
        nova_quality: 'ü•´ –ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã (NOVA)',
        training_recovery: 'üèãÔ∏è –ù–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
        hypertrophy: 'üí™ –ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è',
        // v6.0: C13-C22 –ø–∞—Ç—Ç–µ—Ä–Ω—ã (Phase 1-4)
        vitamin_defense: 'üõ°Ô∏è –†–∞–¥–∞—Ä 11 –≤–∏—Ç–∞–º–∏–Ω–æ–≤',
        b_complex_anemia: '‚ö° B-–∫–æ–º–ø–ª–µ–∫—Å + –∞–Ω–µ–º–∏—è',
        glycemic_load: 'üçö –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (GL)',
        protein_distribution: 'ü•© –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞',
        antioxidant_defense: 'üõ°Ô∏è –ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞',
        added_sugar_dependency: 'üç¨ –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä',
        bone_health: 'ü¶¥ –ó–¥–æ—Ä–æ–≤—å–µ –∫–æ—Å—Ç–µ–π',
        training_type_match: 'üèãÔ∏è –ü–∏—Ç–∞–Ω–∏–µ –ø–æ–¥ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
        electrolyte_homeostasis: '‚ö° –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å',
        nutrient_density: 'ü•ó –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤'
      };

      // v2.0: –ú–∞–ø–ø–∏–Ω–≥ pattern ‚Üí SCIENCE_INFO –∫–ª—é—á
      const patternToInfoKey = {
        // Core v2-v3 –ø–∞—Ç—Ç–µ—Ä–Ω—ã (12.02.2026 enrichment)
        meal_timing: 'MEAL_TIMING',
        wave_overlap: 'WAVE_OVERLAP',
        late_eating: 'LATE_EATING',
        meal_quality: 'MEAL_QUALITY_TREND',
        sleep_weight: 'SLEEP_WEIGHT',
        sleep_hunger: 'SLEEP_HUNGER',
        training_kcal: 'TRAINING_KCAL',
        steps_weight: 'STEPS_WEIGHT',
        protein_satiety: 'PROTEIN_SATIETY',
        fiber_regularity: 'FIBER_REGULARITY',
        stress_eating: 'STRESS_EATING',
        mood_food: 'MOOD_FOOD',
        // v2.0 extended
        circadian: 'CIRCADIAN',
        nutrient_timing: 'NUTRIENT_TIMING',
        insulin_sensitivity: 'INSULIN_SENSITIVITY',
        gut_health: 'GUT_HEALTH',
        // v4.0: B1-B6 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        sleep_quality: 'SLEEP_QUALITY',
        wellbeing_correlation: 'WELLBEING_CORRELATION',
        hydration: 'HYDRATION',
        body_composition: 'BODY_COMPOSITION',
        cycle_impact: 'CYCLE_IMPACT',
        weekend_effect: 'WEEKEND_EFFECT',
        // v4.0: C1-C6 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        nutrition_quality: 'NUTRITION_QUALITY',
        neat_activity: 'NEAT_ACTIVITY',
        mood_trajectory: 'MOOD_TRAJECTORY',
        // v5.0: C7-C12 –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        micronutrient_radar: 'MICRONUTRIENT_RADAR',
        omega_balancer: 'OMEGA_BALANCER',
        heart_health: 'HEART_HEALTH',
        nova_quality: 'NOVA_QUALITY',
        training_recovery: 'TRAINING_RECOVERY',
        hypertrophy: 'HYPERTROPHY',
        // v6.0: C13-C22 –ø–∞—Ç—Ç–µ—Ä–Ω—ã (Phase 1-4)
        vitamin_defense: 'VITAMIN_DEFENSE',
        b_complex_anemia: 'B_COMPLEX_ANEMIA',
        glycemic_load: 'GLYCEMIC_LOAD',
        protein_distribution: 'PROTEIN_DISTRIBUTION',
        antioxidant_defense: 'ANTIOXIDANT_DEFENSE',
        added_sugar_dependency: 'ADDED_SUGAR_DEPENDENCY',
        bone_health: 'BONE_HEALTH',
        training_type_match: 'TRAINING_TYPE_MATCH',
        electrolyte_homeostasis: 'ELECTROLYTE_HOMEOSTASIS',
        nutrient_density: 'NUTRIENT_DENSITY'
      };

      const infoKey = patternToInfoKey[pattern.pattern];

      return h('div', { className: 'insights-pattern' },
        h('div', { className: `insights-pattern__icon insights-pattern__icon--${iconClass}` }, icon),
        h('div', { className: 'insights-pattern__content' },
          h('div', { className: 'insights-pattern__title' },
            patternLabels[pattern.pattern] || pattern.pattern
            // InfoButton removed ‚Äî PatternCard is h()-factory (no hooks allowed)
          ),
          h('div', { className: 'insights-pattern__insight' }, pattern.insight),
          pattern.confidence && h('div', { className: 'insights-pattern__confidence' },
            `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${Math.round(pattern.confidence * 100)}%`
          )
        )
      );
    }

    /**
     * Patterns List ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
     */
    function PatternsList({ patterns }) {
      if (!patterns || patterns.length === 0) return null;

      const availablePatterns = patterns.filter(p => p.available);

      return h('div', { className: 'insights-patterns' },
        availablePatterns.map((p, i) =>
          h(PatternCard, { key: p.pattern || i, pattern: p })
        )
      );
    }

    /**
     * What-If Scenario Card
     */
    function ScenarioCard({ scenario }) {
      if (!scenario) return null;

      const diff = scenario.projectedScore - scenario.currentScore;
      const arrowClass = diff > 0 ? 'up' : diff < 0 ? 'down' : 'stable';
      const arrow = diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : '‚Üí';

      return h('div', { className: `insights-scenario insights-scenario--${scenario.id}` },
        h('div', { className: 'insights-scenario__icon' }, scenario.icon),
        h('div', { className: 'insights-scenario__content' },
          h('div', { className: 'insights-scenario__name' }, scenario.name),
          h('div', { className: 'insights-scenario__desc' }, scenario.description)
        ),
        h('div', { className: `insights-scenario__arrow insights-scenario__arrow--${arrowClass}` },
          scenario.currentScore, ' ', arrow, ' ', scenario.projectedScore
        )
      );
    }

    // ============================================================
    // üß™ WHAT-IF SIMULATOR v1.0.0
    // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä: "–ß—Ç–æ –µ—Å–ª–∏ —è —Å—ä–µ–º X?"
    // ============================================================

    /**
     * Preset-–ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
     * –†–µ–∞–ª—å–Ω—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∏–∑ –±–∞–∑—ã –∏–ª–∏ —Ç–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
     */
    const WHATIF_PRESETS = [
      // –ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–≤—ã—Å–æ–∫–∏–π GI, –∫–æ—Ä–æ—Ç–∫–∞—è —Å—ã—Ç–æ—Å—Ç—å)
      { id: 'pizza', name: '–ü–∏—Ü—Ü–∞', emoji: 'üçï', kcal: 400, prot: 15, carbs: 45, fat: 18, gi: 65, category: 'fast' },
      { id: 'chocolate', name: '–®–æ–∫–æ–ª–∞–¥', emoji: 'üç´', kcal: 250, prot: 3, carbs: 28, fat: 14, gi: 70, category: 'fast' },
      { id: 'cookie', name: '–ü–µ—á–µ–Ω—å–µ', emoji: 'üç™', kcal: 200, prot: 2, carbs: 30, fat: 8, gi: 75, category: 'fast' },
      { id: 'icecream', name: '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ', emoji: 'üç®', kcal: 250, prot: 3, carbs: 30, fat: 12, gi: 62, category: 'fast' },
      { id: 'soda', name: '–ì–∞–∑–∏—Ä–æ–≤–∫–∞ 330–º–ª', emoji: 'ü•§', kcal: 140, prot: 0, carbs: 35, fat: 0, gi: 90, category: 'fast' },

      // –ó–¥–æ—Ä–æ–≤—ã–µ –æ–ø—Ü–∏–∏ (–Ω–∏–∑–∫–∏–π GI, –≤—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫/–∫–ª–µ—Ç—á–∞—Ç–∫–∞)
      { id: 'salad', name: '–°–∞–ª–∞—Ç', emoji: 'ü•ó', kcal: 200, prot: 5, carbs: 15, fat: 12, gi: 25, fiber: 5, category: 'healthy' },
      { id: 'chicken', name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', emoji: 'üçó', kcal: 250, prot: 35, carbs: 0, fat: 10, gi: 0, category: 'healthy' },
      { id: 'eggs', name: '–Ø–π—Ü–∞ (2 —à—Ç)', emoji: 'ü•ö', kcal: 180, prot: 14, carbs: 1, fat: 12, gi: 0, category: 'healthy' },
      { id: 'cottage', name: '–¢–≤–æ—Ä–æ–≥', emoji: 'üßÄ', kcal: 180, prot: 25, carbs: 5, fat: 5, gi: 30, category: 'healthy' },
      { id: 'nuts', name: '–û—Ä–µ—Ö–∏ 50–≥', emoji: 'ü•ú', kcal: 300, prot: 10, carbs: 10, fat: 28, gi: 15, fiber: 4, category: 'healthy' },

      // –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –ø—Ä–∏—ë–º—ã
      { id: 'breakfast', name: '–û–≤—Å—è–Ω–∫–∞ + –±–∞–Ω–∞–Ω', emoji: 'ü•£', kcal: 350, prot: 10, carbs: 55, fat: 8, gi: 55, fiber: 6, category: 'meal' },
      { id: 'lunch', name: '–†–∏—Å + –∫—É—Ä–∏—Ü–∞ + —Å–∞–ª–∞—Ç', emoji: 'üç±', kcal: 500, prot: 35, carbs: 50, fat: 15, gi: 50, fiber: 5, category: 'meal' },
      { id: 'dinner', name: '–†—ã–±–∞ + –æ–≤–æ—â–∏', emoji: 'üêü', kcal: 400, prot: 30, carbs: 20, fat: 18, gi: 35, fiber: 8, category: 'meal' }
    ];

    /**
     * –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ preset-–æ–≤
     */
    const WHATIF_CATEGORIES = {
      fast: { name: '–ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã', emoji: '‚ö°', color: '#ef4444' },
      healthy: { name: '–ü–æ–ª–µ–∑–Ω—ã–µ –æ–ø—Ü–∏–∏', emoji: 'üíö', color: '#22c55e' },
      meal: { name: '–ü–æ–ª–Ω—ã–µ –ø—Ä–∏—ë–º—ã', emoji: 'üçΩÔ∏è', color: '#3b82f6' }
    };

    /**
     * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç –µ–¥—ã (—Å–∏–º—É–ª—è—Ü–∏—è)
     * @param {Object} food - –ø—Ä–æ–¥—É–∫—Ç { kcal, prot, carbs, fat, gi, fiber }
     * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç { currentWave, currentRisk, dayTot, optimum, profile, trainings }
     * @returns {Object} —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–º—É–ª—è—Ü–∏–∏
     */
    function simulateFood(food, context) {
      const { currentWave, currentRisk, dayTot, optimum, profile, trainings } = context;

      // 1. –†–∞—Å—á—ë—Ç –Ω–æ–≤–æ–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
      const gl = ((food.gi || 50) * (food.carbs || 0)) / 100;
      const baseWaveHours = profile?.insulinWaveHours || 3;

      // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤–æ–ª–Ω—ã (–∏–∑ InsulinWave module)
      let waveMultiplier = 1.0;

      // GI –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä
      if (food.gi >= 70) waveMultiplier *= 1.2;
      else if (food.gi >= 55) waveMultiplier *= 1.1;
      else if (food.gi <= 35) waveMultiplier *= 0.85;

      // GL –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–ø–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è)
      const glMult = 0.15 + (Math.min(gl, 40) / 40) ** 0.6 * 1.15;
      waveMultiplier *= Math.min(1.3, Math.max(0.2, glMult));

      // –ë–µ–ª–æ–∫ —É–¥–ª–∏–Ω—è–µ—Ç (–∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
      if (food.prot >= 30) waveMultiplier *= 1.10;
      else if (food.prot >= 20) waveMultiplier *= 1.05;

      // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç
      if (food.fiber >= 8) waveMultiplier *= 0.85;
      else if (food.fiber >= 5) waveMultiplier *= 0.92;

      // –ñ–∏—Ä—ã —É–¥–ª–∏–Ω—è—é—Ç
      if (food.fat >= 20) waveMultiplier *= 1.10;
      else if (food.fat >= 10) waveMultiplier *= 1.05;

      // Activity Context (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞)
      let activityBonus = 0;
      if (trainings && trainings.length > 0) {
        const nowMin = new Date().getHours() * 60 + new Date().getMinutes();
        for (const t of trainings) {
          const tMin = parseInt((t.time || '').split(':')[0]) * 60 + parseInt((t.time || '').split(':')[1] || 0);
          const gap = Math.abs(nowMin - tMin);
          if (gap <= 120) {
            activityBonus = -0.25; // POST-workout
            break;
          }
        }
      }
      waveMultiplier *= (1 + activityBonus);

      const newWaveMinutes = Math.round(baseWaveHours * 60 * waveMultiplier);
      const newWaveEndTime = new Date(Date.now() + newWaveMinutes * 60 * 1000);
      const newWaveEndStr = newWaveEndTime.toTimeString().slice(0, 5);

      // 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–µ–π –≤–æ–ª–Ω–æ–π
      let waveImpact = 'neutral';
      let waveCompare = null;

      if (currentWave && currentWave.status !== 'lipolysis') {
        // –°–µ–π—á–∞—Å –≤–æ–ª–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–¥—ã –ø—Ä–æ–¥–ª–∏—Ç –µ—ë
        waveImpact = 'extends';
        waveCompare = {
          before: currentWave.remaining || 0,
          after: newWaveMinutes,
          diff: newWaveMinutes - (currentWave.remaining || 0)
        };
      } else if (currentWave && currentWave.status === 'lipolysis') {
        // –°–µ–π—á–∞—Å –ª–∏–ø–æ–ª–∏–∑ ‚Äî –µ–¥–∞ –ø—Ä–µ—Ä–≤—ë—Ç –µ–≥–æ
        waveImpact = 'interrupts';
        waveCompare = {
          lipolysisLost: currentWave.lipolysisMinutes || 0,
          newWaveMinutes
        };
      }

      // 3. –†–∞—Å—á—ë—Ç –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞
      const newDayKcal = (dayTot?.kcal || 0) + food.kcal;
      const newRatio = optimum ? newDayKcal / optimum : 1;

      let riskDelta = 0;
      let riskReason = null;

      // –†–∏—Å–∫ —Ä–∞—Å—Ç—ë—Ç –µ—Å–ª–∏:
      if (food.gi >= 70) {
        riskDelta += 8; // –í—ã—Å–æ–∫–∏–π GI ‚Üí –±—ã—Å—Ç—Ä—ã–π –≥–æ–ª–æ–¥ –ø–æ–∑–∂–µ
        riskReason = '–í—ã—Å–æ–∫–∏–π –ì–ò ‚Üí –±—ã—Å—Ç—Ä—ã–π –≥–æ–ª–æ–¥ —á–µ—Ä–µ–∑ 2-3—á';
      }
      if (newRatio > 1.1 && newRatio < 1.3) {
        riskDelta += 5; // –õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä ‚Üí –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å
      } else if (newRatio >= 1.3) {
        riskDelta += 15; // –°–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä ‚Üí —Å—Ç—Ä–µ—Å—Å –∏ "–¥–∞ –≥–æ—Ä–∏ –æ–Ω–æ –≤—Å—ë"
        riskReason = '–°–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π ‚Üí –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ä—ã–≤';
      }

      // –†–∏—Å–∫ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –µ—Å–ª–∏:
      if (food.prot >= 25 && food.gi <= 40) {
        riskDelta -= 10; // –ë–µ–ª–æ–∫ + –Ω–∏–∑–∫–∏–π GI = –¥–æ–ª–≥–∞—è —Å—ã—Ç–æ—Å—Ç—å
        riskReason = '–ú–Ω–æ–≥–æ –±–µ–ª–∫–∞ + –Ω–∏–∑–∫–∏–π –ì–ò ‚Üí –¥–æ–ª–≥–∞—è —Å—ã—Ç–æ—Å—Ç—å';
      }
      if (food.fiber >= 5) {
        riskDelta -= 5; // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ = —Å—ã—Ç–æ—Å—Ç—å
      }

      const newRisk = Math.min(100, Math.max(0, (currentRisk || 0) + riskDelta));

      // 4. –°–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–º—É–ª—è—Ü–∏–∏
      const advice = [];

      // –°–æ–≤–µ—Ç –ø—Ä–æ —Ç–∞–π–º–∏–Ω–≥
      if (currentWave && currentWave.status !== 'lipolysis' && currentWave.remaining >= 60) {
        advice.push({
          type: 'timing',
          icon: '‚è≥',
          text: `–ü–æ–¥–æ–∂–¥–∏ ${Math.round(currentWave.remaining / 60 * 10) / 10}—á –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–π –≤–æ–ª–Ω—ã`,
          priority: 1
        });
      }

      // –°–æ–≤–µ—Ç –ø—Ä–æ –∑–∞–º–µ–Ω—É
      if (food.gi >= 65 && food.category === 'fast') {
        const healthyAlt = WHATIF_PRESETS.find(p => p.category === 'healthy' && Math.abs(p.kcal - food.kcal) < 100);
        if (healthyAlt) {
          advice.push({
            type: 'alternative',
            icon: 'üí°',
            text: `–ó–∞–º–µ–Ω–∏ –Ω–∞ ${healthyAlt.emoji} ${healthyAlt.name} ‚Äî –≤–æ–ª–Ω–∞ –Ω–∞ ${Math.round((waveMultiplier - 0.85) / waveMultiplier * 100)}% –∫–æ—Ä–æ—á–µ`,
            priority: 2,
            altPreset: healthyAlt
          });
        }
      }

      // –°–æ–≤–µ—Ç –ø—Ä–æ –±–µ–ª–æ–∫
      if (food.prot < 15 && food.kcal >= 300) {
        advice.push({
          type: 'add_protein',
          icon: 'ü•ö',
          text: '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫ ‚Äî –¥–æ–ª—å—à–µ —Å—ã—Ç–æ—Å—Ç—å',
          priority: 3
        });
      }

      // –°–æ–≤–µ—Ç –ø—Ä–æ –∫–∞–ª–æ—Ä–∏–∏
      if (newRatio >= 1.3) {
        advice.push({
          type: 'warning',
          icon: '‚ö†Ô∏è',
          text: '–ü–µ—Ä–µ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π! –†–∞—Å—Å–º–æ—Ç—Ä–∏ –º–µ–Ω—å—à—É—é –ø–æ—Ä—Ü–∏—é',
          priority: 0
        });
      } else if (newRatio >= 0.9 && newRatio <= 1.1) {
        advice.push({
          type: 'success',
          icon: '‚úÖ',
          text: '–ö–∞–ª–æ—Ä–∏–∏ –±—É–¥—É—Ç –≤ –Ω–æ—Ä–º–µ',
          priority: 4
        });
      }

      // 5. –°–∞—Ç–∏–∞—Ü–∏—è (–Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–æ–ª–≥–æ –±—É–¥–µ—Ç —Å—ã—Ç–æ)
      let satietyHours = 2; // –±–∞–∑–æ–≤–∞—è
      satietyHours += food.prot * 0.03; // +0.03—á –Ω–∞ –≥—Ä–∞–º–º –±–µ–ª–∫–∞
      satietyHours += (food.fiber || 0) * 0.05; // +0.05—á –Ω–∞ –≥—Ä–∞–º–º –∫–ª–µ—Ç—á–∞—Ç–∫–∏
      satietyHours -= (food.gi - 50) * 0.01; // -0.01—á –∑–∞ –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç GI –≤—ã—à–µ 50
      satietyHours = Math.max(1, Math.min(6, satietyHours));

      return {
        food,
        wave: {
          minutes: newWaveMinutes,
          hours: Math.round(newWaveMinutes / 60 * 10) / 10,
          endTime: newWaveEndStr,
          impact: waveImpact,
          compare: waveCompare,
          multiplier: waveMultiplier,
          gl
        },
        risk: {
          before: currentRisk || 0,
          after: newRisk,
          delta: riskDelta,
          reason: riskReason
        },
        calories: {
          add: food.kcal,
          newTotal: newDayKcal,
          ratio: Math.round(newRatio * 100),
          optimum
        },
        satiety: {
          hours: Math.round(satietyHours * 10) / 10,
          desc: satietyHours >= 4 ? '–î–æ–ª–≥–∞—è —Å—ã—Ç–æ—Å—Ç—å' : satietyHours >= 2.5 ? '–°—Ä–µ–¥–Ω—è—è —Å—ã—Ç–æ—Å—Ç—å' : '–ë—ã—Å—Ç—Ä–æ –∑–∞—Ö–æ—á–µ—Ç—Å—è –µ—Å—Ç—å'
        },
        advice: advice.sort((a, b) => a.priority - b.priority),
        verdict: newRatio <= 1.1 && riskDelta <= 0 ? 'good' : newRatio <= 1.2 && riskDelta <= 10 ? 'neutral' : 'bad'
      };
    }

    /**
     * WhatIfSimulator ‚Äî –≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
     * @param {Object} props - { context, onClose }
     */
    function WhatIfSimulator({ context, onClose, expanded = false }) {
      const [selectedPreset, setSelectedPreset] = React.useState(null);
      const [customFood, setCustomFood] = React.useState(null);
      const [simulation, setSimulation] = React.useState(null);
      const [activeCategory, setActiveCategory] = React.useState('fast');
      const [isCustomMode, setIsCustomMode] = React.useState(false);
      const [customValues, setCustomValues] = React.useState({ kcal: 300, prot: 15, carbs: 30, fat: 10, gi: 50, name: '' });

      // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ preset
      React.useEffect(() => {
        if (selectedPreset && context) {
          const result = simulateFood(selectedPreset, context);
          setSimulation(result);
        }
      }, [selectedPreset, context]);

      // –°–∏–º—É–ª—è—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –µ–¥—ã
      React.useEffect(() => {
        if (isCustomMode && customValues.kcal > 0 && context) {
          const food = {
            ...customValues,
            id: 'custom',
            emoji: 'üçΩÔ∏è',
            category: 'custom'
          };
          const result = simulateFood(food, context);
          setSimulation(result);
        }
      }, [customValues, isCustomMode, context]);

      const handlePresetClick = (preset) => {
        setSelectedPreset(preset);
        setIsCustomMode(false);
      };

      const handleCustomToggle = () => {
        setIsCustomMode(!isCustomMode);
        setSelectedPreset(null);
        if (!isCustomMode) {
          setSimulation(null);
        }
      };

      const handleCustomChange = (field, value) => {
        setCustomValues(prev => ({ ...prev, [field]: parseFloat(value) || 0 }));
      };

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      const filteredPresets = WHATIF_PRESETS.filter(p => p.category === activeCategory);

      return h('div', { className: `whatif-simulator ${expanded ? 'whatif-simulator--expanded' : ''}` },
        // Header
        h('div', { className: 'whatif-simulator__header' },
          h('div', { className: 'whatif-simulator__title' },
            h('span', { className: 'whatif-simulator__emoji' }, 'üß™'),
            '–ß—Ç–æ –µ—Å–ª–∏ —Å—ä–µ—Å—Ç—å?'
          ),
          h('div', { className: 'whatif-simulator__subtitle' },
            '–°–∏–º—É–ª—è—Ü–∏—è –≤–ª–∏—è–Ω–∏—è –µ–¥—ã –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–º'
          )
        ),

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ preset-–æ–≤
        h('div', { className: 'whatif-simulator__categories' },
          Object.entries(WHATIF_CATEGORIES).map(([key, cat]) =>
            h('button', {
              key,
              className: `whatif-simulator__category ${activeCategory === key ? 'whatif-simulator__category--active' : ''}`,
              onClick: () => setActiveCategory(key),
              style: activeCategory === key ? { borderColor: cat.color, color: cat.color } : {}
            },
              h('span', null, cat.emoji),
              h('span', null, cat.name)
            )
          ),
          h('button', {
            className: `whatif-simulator__category ${isCustomMode ? 'whatif-simulator__category--active' : ''}`,
            onClick: handleCustomToggle
          },
            h('span', null, '‚úèÔ∏è'),
            h('span', null, '–°–≤–æ—ë')
          )
        ),

        // Preset-—ã –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π –≤–≤–æ–¥
        !isCustomMode ? h('div', { className: 'whatif-simulator__presets' },
          filteredPresets.map(preset =>
            h('button', {
              key: preset.id,
              className: `whatif-preset ${selectedPreset?.id === preset.id ? 'whatif-preset--selected' : ''}`,
              onClick: () => handlePresetClick(preset)
            },
              h('span', { className: 'whatif-preset__emoji' }, preset.emoji),
              h('div', { className: 'whatif-preset__info' },
                h('div', { className: 'whatif-preset__name' }, preset.name),
                h('div', { className: 'whatif-preset__kcal' }, preset.kcal, ' –∫–∫–∞–ª')
              )
            )
          )
        ) : h('div', { className: 'whatif-simulator__custom' },
          h('div', { className: 'whatif-custom__row' },
            h('label', { className: 'whatif-custom__field' },
              h('span', null, '–ö–∫–∞–ª'),
              h('input', {
                type: 'number',
                value: customValues.kcal,
                onChange: (e) => handleCustomChange('kcal', e.target.value),
                min: 0,
                max: 2000
              })
            ),
            h('label', { className: 'whatif-custom__field' },
              h('span', null, '–ë–µ–ª–æ–∫'),
              h('input', {
                type: 'number',
                value: customValues.prot,
                onChange: (e) => handleCustomChange('prot', e.target.value),
                min: 0,
                max: 100
              })
            )
          ),
          h('div', { className: 'whatif-custom__row' },
            h('label', { className: 'whatif-custom__field' },
              h('span', null, '–£–≥–ª–µ–≤–æ–¥—ã'),
              h('input', {
                type: 'number',
                value: customValues.carbs,
                onChange: (e) => handleCustomChange('carbs', e.target.value),
                min: 0,
                max: 200
              })
            ),
            h('label', { className: 'whatif-custom__field' },
              h('span', null, '–ñ–∏—Ä—ã'),
              h('input', {
                type: 'number',
                value: customValues.fat,
                onChange: (e) => handleCustomChange('fat', e.target.value),
                min: 0,
                max: 100
              })
            )
          ),
          h('div', { className: 'whatif-custom__row' },
            h('label', { className: 'whatif-custom__field whatif-custom__field--wide' },
              h('span', null, '–ì–ò (0-100)'),
              h('input', {
                type: 'range',
                value: customValues.gi,
                onChange: (e) => handleCustomChange('gi', e.target.value),
                min: 0,
                max: 100
              }),
              h('span', { className: 'whatif-custom__gi-value' }, customValues.gi)
            )
          )
        ),

        // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏
        simulation && h('div', { className: 'whatif-simulator__results' },
          // Verdict banner
          h('div', { className: `whatif-result__verdict whatif-result__verdict--${simulation.verdict}` },
            simulation.verdict === 'good' ? '‚úÖ –•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä!' :
              simulation.verdict === 'neutral' ? 'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ' :
                '‚ö†Ô∏è –†–∏—Å–∫–æ–≤–∞–Ω–Ω–æ'
          ),

          // Metrics grid
          h('div', { className: 'whatif-result__grid' },
            // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞
            h('div', { className: 'whatif-result__card' },
              h('div', { className: 'whatif-result__card-header' },
                h('span', { className: 'whatif-result__card-emoji' }, 'üåä'),
                h('span', null, '–í–æ–ª–Ω–∞')
              ),
              h('div', { className: 'whatif-result__card-value' },
                simulation.wave.hours, '—á'
              ),
              h('div', { className: 'whatif-result__card-detail' },
                '–¥–æ ', simulation.wave.endTime
              ),
              simulation.wave.impact === 'interrupts' && h('div', { className: 'whatif-result__card-warning' },
                '‚ö†Ô∏è –ü—Ä–µ—Ä–≤—ë—Ç –ª–∏–ø–æ–ª–∏–∑!'
              )
            ),

            // –†–∏—Å–∫ —Å—Ä—ã–≤–∞
            h('div', { className: 'whatif-result__card' },
              h('div', { className: 'whatif-result__card-header' },
                h('span', { className: 'whatif-result__card-emoji' }, '‚ö†Ô∏è'),
                h('span', null, '–†–∏—Å–∫')
              ),
              h('div', { className: `whatif-result__card-value ${simulation.risk.delta > 0 ? 'whatif-result__card-value--bad' : simulation.risk.delta < 0 ? 'whatif-result__card-value--good' : ''}` },
                simulation.risk.before, '%',
                simulation.risk.delta !== 0 && h('span', { className: 'whatif-result__delta' },
                  ' ‚Üí ', simulation.risk.after, '%'
                )
              ),
              simulation.risk.delta !== 0 && h('div', { className: `whatif-result__card-detail ${simulation.risk.delta > 0 ? 'whatif-result__card-detail--bad' : 'whatif-result__card-detail--good'}` },
                simulation.risk.delta > 0 ? '+' : '', simulation.risk.delta, '%'
              )
            ),

            // –ö–∞–ª–æ—Ä–∏–∏
            h('div', { className: 'whatif-result__card' },
              h('div', { className: 'whatif-result__card-header' },
                h('span', { className: 'whatif-result__card-emoji' }, 'üî•'),
                h('span', null, '–ö–∞–ª–æ—Ä–∏–∏')
              ),
              h('div', { className: 'whatif-result__card-value' },
                '+', simulation.calories.add
              ),
              h('div', { className: `whatif-result__card-detail ${simulation.calories.ratio > 110 ? 'whatif-result__card-detail--bad' : simulation.calories.ratio >= 90 ? 'whatif-result__card-detail--good' : ''}` },
                simulation.calories.ratio, '% –æ—Ç –Ω–æ—Ä–º—ã'
              )
            ),

            // –°—ã—Ç–æ—Å—Ç—å
            h('div', { className: 'whatif-result__card' },
              h('div', { className: 'whatif-result__card-header' },
                h('span', { className: 'whatif-result__card-emoji' }, 'üòã'),
                h('span', null, '–°—ã—Ç–æ—Å—Ç—å')
              ),
              h('div', { className: 'whatif-result__card-value' },
                '~', simulation.satiety.hours, '—á'
              ),
              h('div', { className: 'whatif-result__card-detail' },
                simulation.satiety.desc
              )
            )
          ),

          // –°–æ–≤–µ—Ç—ã
          simulation.advice.length > 0 && h('div', { className: 'whatif-result__advice' },
            h('div', { className: 'whatif-result__advice-title' }, 'üí° –°–æ–≤–µ—Ç—ã'),
            simulation.advice.map((adv, i) =>
              h('div', {
                key: i,
                className: `whatif-result__advice-item whatif-result__advice-item--${adv.type}`,
                onClick: adv.altPreset ? () => handlePresetClick(adv.altPreset) : undefined
              },
                h('span', { className: 'whatif-result__advice-icon' }, adv.icon),
                h('span', null, adv.text)
              )
            )
          ),

          // Debug: GL –∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å
          h('div', { className: 'whatif-result__debug' },
            'GL: ', Math.round(simulation.wave.gl * 10) / 10,
            ' | –ú–Ω–æ–∂–∏—Ç–µ–ª—å: √ó', Math.round(simulation.wave.multiplier * 100) / 100
          )
        ),

        // Footer —Å –∫–Ω–æ–ø–∫–æ–π
        expanded && onClose && h('div', { className: 'whatif-simulator__footer' },
          h('button', {
            className: 'whatif-simulator__close',
            onClick: onClose
          }, '–ó–∞–∫—Ä—ã—Ç—å')
        )
      );
    }

    /**
     * WhatIfCard ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Insights
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∏–Ω–∏-—Å–∏–º—É–ª—è—Ç–æ—Ä —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ preset-–∞–º–∏
     */
    function WhatIfCard({ context }) {
      const [isExpanded, setIsExpanded] = React.useState(false);
      const [quickResult, setQuickResult] = React.useState(null);
      const [selectedQuick, setSelectedQuick] = React.useState(null);

      // –ë—ã—Å—Ç—Ä—ã–µ preset-—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
      const quickPresets = WHATIF_PRESETS.slice(0, 4);

      const handleQuickSelect = (preset) => {
        setSelectedQuick(preset);
        if (context) {
          const result = simulateFood(preset, context);
          setQuickResult(result);
        }
      };

      return h('div', { className: 'whatif-card' },
        h('div', { className: 'whatif-card__header' },
          h('div', { className: 'whatif-card__title' },
            h('span', null, 'üß™'),
            ' –ß—Ç–æ –µ—Å–ª–∏ —Å—ä–µ—Å—Ç—å?'
          ),
          h(getInfoButton(), { infoKey: 'WHATIF_SIMULATOR' }),
          h('button', {
            className: 'whatif-card__expand',
            onClick: () => setIsExpanded(true)
          }, '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚Üí')
        ),

        // Quick presets
        h('div', { className: 'whatif-card__quick' },
          quickPresets.map(preset =>
            h('button', {
              key: preset.id,
              className: `whatif-card__quick-btn ${selectedQuick?.id === preset.id ? 'whatif-card__quick-btn--selected' : ''}`,
              onClick: () => handleQuickSelect(preset)
            },
              h('span', null, preset.emoji),
              h('span', null, preset.kcal, ' –∫–∫–∞–ª')
            )
          )
        ),

        // Quick result
        quickResult && h('div', { className: 'whatif-card__result' },
          h('div', { className: `whatif-card__verdict whatif-card__verdict--${quickResult.verdict}` },
            quickResult.verdict === 'good' ? '‚úÖ' : quickResult.verdict === 'neutral' ? 'üòê' : '‚ö†Ô∏è',
            ' –í–æ–ª–Ω–∞ ', quickResult.wave.hours, '—á',
            ' | –†–∏—Å–∫ ', quickResult.risk.delta > 0 ? '+' : '', quickResult.risk.delta, '%'
          ),
          quickResult.advice[0] && h('div', { className: 'whatif-card__advice' },
            quickResult.advice[0].icon, ' ', quickResult.advice[0].text
          )
        ),

        // Modal
        isExpanded && h('div', { className: 'whatif-modal-overlay', onClick: () => setIsExpanded(false) },
          h('div', { className: 'whatif-modal', onClick: (e) => e.stopPropagation() },
            h(WhatIfSimulator, {
              context,
              expanded: true,
              onClose: () => setIsExpanded(false)
            })
          )
        )
      );
    }

    /**
     * What-If Section (v2.0: —Å InfoButton)
     */
    function WhatIfSection({ scenarios }) {
      if (!scenarios || scenarios.length === 0) return null;

      return h('div', { className: 'insights-whatif' },
        h('div', { className: 'insights-whatif__header' },
          h('span', { className: 'insights-whatif__title' }, 'üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏'),
          h(getInfoButton(), {
            infoKey: 'WHATIF',
            debugData: { scenariosCount: scenarios.length }
          })
        ),
        h('div', { className: 'insights-whatif__list' },
          scenarios.map((s, i) =>
            h(ScenarioCard, { key: s.id || i, scenario: s })
          )
        )
      );
    }

    /**
     * DataCompletenessCard ‚Äî –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö (v5.1.0)
     */
    function DataCompletenessCard({ days }) {
      if (!days || days.length === 0) return null;

      const analysis = React.useMemo(() => {
        const totalDays = days.length;
        const daysWithMeals = days.filter(d => d.meals && d.meals.length > 0).length;
        const daysWithWeight = days.filter(d => d.weight && d.weight > 0).length;
        const daysWithSleep = days.filter(d => d.sleepHours && d.sleepHours > 0).length;
        const daysWithSteps = days.filter(d => d.steps && d.steps > 0).length;
        const daysWithTraining = days.filter(d => d.hasTraining).length;

        return {
          totalDays,
          daysWithMeals,
          daysWithWeight,
          daysWithSleep,
          daysWithSteps,
          daysWithTraining,
          completeness: {
            meals: Math.round((daysWithMeals / totalDays) * 100),
            weight: Math.round((daysWithWeight / totalDays) * 100),
            sleep: Math.round((daysWithSleep / totalDays) * 100),
            activity: Math.round((daysWithSteps / totalDays) * 100)
          }
        };
      }, [days]);

      const { completeness } = analysis;
      const avgCompleteness = Math.round((completeness.meals + completeness.weight + completeness.sleep + completeness.activity) / 4);

      return h('div', { className: 'pi-card pi-card--low data-completeness-card' },
        h('div', { className: 'data-completeness-card__header' },
          h('h3', null, 'üìä –ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö'),
          h('div', { className: 'data-completeness-card__score' },
            h('span', { className: `completeness-score completeness-score--${avgCompleteness >= 80 ? 'good' : avgCompleteness >= 60 ? 'medium' : 'low'}` },
              avgCompleteness, '%'
            )
          )
        ),
        h('div', { className: 'data-completeness-card__metrics' },
          [
            { key: 'meals', label: '–ü—Ä–∏—ë–º—ã –ø–∏—â–∏', value: completeness.meals, icon: 'üçΩÔ∏è' },
            { key: 'weight', label: '–í–µ—Å', value: completeness.weight, icon: '‚öñÔ∏è' },
            { key: 'sleep', label: '–°–æ–Ω', value: completeness.sleep, icon: 'üò¥' },
            { key: 'activity', label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', value: completeness.activity, icon: 'üëü' }
          ].map(metric =>
            h('div', { key: metric.key, className: 'completeness-metric' },
              h('div', { className: 'completeness-metric__bar-container' },
                h('div', { className: 'completeness-metric__bar-bg' }),
                h('div', {
                  className: `completeness-metric__bar completeness-metric__bar--${metric.value >= 80 ? 'good' : metric.value >= 60 ? 'medium' : 'low'}`,
                  style: { width: `${metric.value}%` }
                })
              ),
              h('div', { className: 'completeness-metric__label' },
                h('span', null, metric.icon, ' ', metric.label),
                h('span', { className: 'completeness-metric__value' }, metric.value, '%')
              )
            )
          )
        ),
        h('div', { className: 'data-completeness-card__suggestions' },
          completeness.weight < 80 && h('p', { className: 'completeness-suggestion' },
            '‚ö†Ô∏è –î–æ–±–∞–≤—å –≤–µ—Å ‚Äî –∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ç–æ—á–Ω–µ–µ –Ω–∞ 35%'
          ),
          completeness.sleep < 70 && h('p', { className: 'completeness-suggestion' },
            '‚ö†Ô∏è –û—Ç–º–µ—á–∞–π —Å–æ–Ω ‚Äî —Ä–∞—Å–∫—Ä–æ–µ—Ç 6 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'
          ),
          completeness.meals < 90 && h('p', { className: 'completeness-suggestion' },
            'üí° –ü–æ–ª–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è = –º–∞–∫—Å–∏–º—É–º –∏–Ω—Å–∞–π—Ç–æ–≤'
          )
        )
      );
    }

    // === EXPORT ===
    HEYS.InsightsPI = HEYS.InsightsPI || {};
    HEYS.InsightsPI.uiCards = {
      CollapsibleSection,
      AdvancedAnalyticsCard,
      MetabolismCard,
      MetabolismSection,
      HealthRingsGrid,
      PatternCard,
      PatternsList,
      ScenarioCard,
      WhatIfSimulator,
      WhatIfCard,
      WhatIfSection,
      DataCompletenessCard
    };

    // Backward compatibility fallback
    window.piUICards = HEYS.InsightsPI.uiCards;

    devLog('[PI UI Cards] v3.0.2 loaded ‚Äî', Object.keys(HEYS.InsightsPI.uiCards).length, 'card components');
  }

  // Start initialization (will retry until React is available)
  initModule();

})(window);


/* ===== insights/pi_ui_whatif.js ===== */
// pi_ui_whatif.js ‚Äî What-If Simulator UI Components v3.0.1
// Extracted from heys_predictive_insights_v1.js (Phase 9a)
// What-If —Å–∏–º—É–ª—è—Ç–æ—Ä - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –≤–ª–∏—è–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ
// v3.0.1: Lazy getters for InfoButton (script order fix)
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

  // React imports
  const { createElement: h, useState, useEffect, useMemo } = window.React || {};

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  const piAdvanced = HEYS.InsightsPI?.advanced || window.piAdvanced || {};
  const piUICards = HEYS.InsightsPI?.uiCards || window.piUICards || {};
  const piUIHelpers = HEYS.InsightsPI?.uiHelpers || window.piUIHelpers || {};

  // –ò–º–ø–æ—Ä—Ç –∏–∑ pi_ui_cards.js (lazy-–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ namespace)
  const getWhatIfDeps = () => {
    const cards = HEYS.InsightsPI?.uiCards || piUICards || {};
    return {
      WHATIF_PRESETS: cards.WHATIF_PRESETS || [],
      WHATIF_CATEGORIES: cards.WHATIF_CATEGORIES || {},
      simulateFood: cards.simulateFood || function () { return { verdict: 'neutral', wave: { hours: 3, endTime: '--:--', gl: 0, multiplier: 1 }, risk: { before: 0, after: 0, delta: 0 }, calories: { add: 0, ratio: 0 }, satiety: { hours: 2, desc: '' }, advice: [] }; }
    };
  };

  // Lazy getter –¥–ª—è InfoButton (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–∑–∂–µ –≤ pi_ui_dashboard.js)
  function getInfoButton() {
    if (typeof piUIHelpers.getInfoButton === 'function') {
      return piUIHelpers.getInfoButton(h);
    }
    return HEYS.InsightsPI?.uiDashboard?.InfoButton ||
      HEYS.PredictiveInsights?.components?.InfoButton ||
      HEYS.day?.InfoButton ||
      HEYS.InfoButton ||
      window.InfoButton ||
      // Fallback: –ø—Ä–æ—Å—Ç–∞—è –∫–Ω–æ–ø–∫–∞ –µ—Å–ª–∏ InfoButton –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      function InfoButtonFallback({ infoKey, size }) {
        return h('span', {
          className: 'info-button-placeholder',
          title: infoKey,
          style: { cursor: 'help', opacity: 0.5 }
        }, '?');
      };
  }

  // Import generateWhatIfScenarios
  const generateWhatIfScenarios = piAdvanced.generateWhatIfScenarios || function () { return []; };

  function WhatIfSimulator({ context, onClose, expanded = false }) {
    const { WHATIF_PRESETS, WHATIF_CATEGORIES, simulateFood } = getWhatIfDeps();
    const [selectedPreset, setSelectedPreset] = useState(null);
    const [customFood, setCustomFood] = useState(null);
    const [simulation, setSimulation] = useState(null);
    const [activeCategory, setActiveCategory] = useState('fast');
    const [isCustomMode, setIsCustomMode] = useState(false);
    const [customValues, setCustomValues] = useState({ kcal: 300, prot: 15, carbs: 30, fat: 10, gi: 50, name: '' });

    // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ preset
    useEffect(() => {
      if (selectedPreset && context) {
        const result = simulateFood(selectedPreset, context);
        setSimulation(result);
      }
    }, [selectedPreset, context]);

    // –°–∏–º—É–ª—è—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –µ–¥—ã
    useEffect(() => {
      if (isCustomMode && customValues.kcal > 0 && context) {
        const food = {
          ...customValues,
          id: 'custom',
          emoji: 'üçΩÔ∏è',
          category: 'custom'
        };
        const result = simulateFood(food, context);
        setSimulation(result);
      }
    }, [customValues, isCustomMode, context]);

    const handlePresetClick = (preset) => {
      setSelectedPreset(preset);
      setIsCustomMode(false);
    };

    const handleCustomToggle = () => {
      setIsCustomMode(!isCustomMode);
      setSelectedPreset(null);
      if (!isCustomMode) {
        setSimulation(null);
      }
    };

    const handleCustomChange = (field, value) => {
      setCustomValues(prev => ({ ...prev, [field]: parseFloat(value) || 0 }));
    };

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const filteredPresets = WHATIF_PRESETS.filter(p => p.category === activeCategory);

    return h('div', { className: `whatif-simulator ${expanded ? 'whatif-simulator--expanded' : ''}` },
      // Header
      h('div', { className: 'whatif-simulator__header' },
        h('div', { className: 'whatif-simulator__title' },
          h('span', { className: 'whatif-simulator__emoji' }, 'üß™'),
          '–ß—Ç–æ –µ—Å–ª–∏ —Å—ä–µ—Å—Ç—å?'
        ),
        h('div', { className: 'whatif-simulator__subtitle' },
          '–°–∏–º—É–ª—è—Ü–∏—è –≤–ª–∏—è–Ω–∏—è –µ–¥—ã –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–º'
        )
      ),

      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ preset-–æ–≤
      h('div', { className: 'whatif-simulator__categories' },
        Object.entries(WHATIF_CATEGORIES).map(([key, cat]) =>
          h('button', {
            key,
            className: `whatif-simulator__category ${activeCategory === key ? 'whatif-simulator__category--active' : ''}`,
            onClick: () => setActiveCategory(key),
            style: activeCategory === key ? { borderColor: cat.color, color: cat.color } : {}
          },
            h('span', null, cat.emoji),
            h('span', null, cat.name)
          )
        ),
        h('button', {
          className: `whatif-simulator__category ${isCustomMode ? 'whatif-simulator__category--active' : ''}`,
          onClick: handleCustomToggle
        },
          h('span', null, '‚úèÔ∏è'),
          h('span', null, '–°–≤–æ—ë')
        )
      ),

      // Preset-—ã –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π –≤–≤–æ–¥
      !isCustomMode ? h('div', { className: 'whatif-simulator__presets' },
        filteredPresets.map(preset =>
          h('button', {
            key: preset.id,
            className: `whatif-preset ${selectedPreset?.id === preset.id ? 'whatif-preset--selected' : ''}`,
            onClick: () => handlePresetClick(preset)
          },
            h('span', { className: 'whatif-preset__emoji' }, preset.emoji),
            h('div', { className: 'whatif-preset__info' },
              h('div', { className: 'whatif-preset__name' }, preset.name),
              h('div', { className: 'whatif-preset__kcal' }, preset.kcal, ' –∫–∫–∞–ª')
            )
          )
        )
      ) : h('div', { className: 'whatif-simulator__custom' },
        h('div', { className: 'whatif-custom__row' },
          h('label', { className: 'whatif-custom__field' },
            h('span', null, '–ö–∫–∞–ª'),
            h('input', {
              type: 'number',
              value: customValues.kcal,
              onChange: (e) => handleCustomChange('kcal', e.target.value),
              min: 0,
              max: 2000
            })
          ),
          h('label', { className: 'whatif-custom__field' },
            h('span', null, '–ë–µ–ª–æ–∫'),
            h('input', {
              type: 'number',
              value: customValues.prot,
              onChange: (e) => handleCustomChange('prot', e.target.value),
              min: 0,
              max: 100
            })
          )
        ),
        h('div', { className: 'whatif-custom__row' },
          h('label', { className: 'whatif-custom__field' },
            h('span', null, '–£–≥–ª–µ–≤–æ–¥—ã'),
            h('input', {
              type: 'number',
              value: customValues.carbs,
              onChange: (e) => handleCustomChange('carbs', e.target.value),
              min: 0,
              max: 200
            })
          ),
          h('label', { className: 'whatif-custom__field' },
            h('span', null, '–ñ–∏—Ä—ã'),
            h('input', {
              type: 'number',
              value: customValues.fat,
              onChange: (e) => handleCustomChange('fat', e.target.value),
              min: 0,
              max: 100
            })
          )
        ),
        h('div', { className: 'whatif-custom__row' },
          h('label', { className: 'whatif-custom__field whatif-custom__field--wide' },
            h('span', null, '–ì–ò (0-100)'),
            h('input', {
              type: 'range',
              value: customValues.gi,
              onChange: (e) => handleCustomChange('gi', e.target.value),
              min: 0,
              max: 100
            }),
            h('span', { className: 'whatif-custom__gi-value' }, customValues.gi)
          )
        )
      ),

      // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏
      simulation && h('div', { className: 'whatif-simulator__results' },
        // Verdict banner
        h('div', { className: `whatif-result__verdict whatif-result__verdict--${simulation.verdict}` },
          simulation.verdict === 'good' ? '‚úÖ –•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä!' :
            simulation.verdict === 'neutral' ? 'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ' :
              '‚ö†Ô∏è –†–∏—Å–∫–æ–≤–∞–Ω–Ω–æ'
        ),

        // Metrics grid
        h('div', { className: 'whatif-result__grid' },
          // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞
          h('div', { className: 'whatif-result__card' },
            h('div', { className: 'whatif-result__card-header' },
              h('span', { className: 'whatif-result__card-emoji' }, 'üåä'),
              h('span', null, '–í–æ–ª–Ω–∞')
            ),
            h('div', { className: 'whatif-result__card-value' },
              simulation.wave.hours, '—á'
            ),
            h('div', { className: 'whatif-result__card-detail' },
              '–¥–æ ', simulation.wave.endTime
            ),
            simulation.wave.impact === 'interrupts' && h('div', { className: 'whatif-result__card-warning' },
              '‚ö†Ô∏è –ü—Ä–µ—Ä–≤—ë—Ç –ª–∏–ø–æ–ª–∏–∑!'
            )
          ),

          // –†–∏—Å–∫ —Å—Ä—ã–≤–∞
          h('div', { className: 'whatif-result__card' },
            h('div', { className: 'whatif-result__card-header' },
              h('span', { className: 'whatif-result__card-emoji' }, '‚ö†Ô∏è'),
              h('span', null, '–†–∏—Å–∫')
            ),
            h('div', { className: `whatif-result__card-value ${simulation.risk.delta > 0 ? 'whatif-result__card-value--bad' : simulation.risk.delta < 0 ? 'whatif-result__card-value--good' : ''}` },
              simulation.risk.before, '%',
              simulation.risk.delta !== 0 && h('span', { className: 'whatif-result__delta' },
                ' ‚Üí ', simulation.risk.after, '%'
              )
            ),
            simulation.risk.delta !== 0 && h('div', { className: `whatif-result__card-detail ${simulation.risk.delta > 0 ? 'whatif-result__card-detail--bad' : 'whatif-result__card-detail--good'}` },
              simulation.risk.delta > 0 ? '+' : '', simulation.risk.delta, '%'
            )
          ),

          // –ö–∞–ª–æ—Ä–∏–∏
          h('div', { className: 'whatif-result__card' },
            h('div', { className: 'whatif-result__card-header' },
              h('span', { className: 'whatif-result__card-emoji' }, 'üî•'),
              h('span', null, '–ö–∞–ª–æ—Ä–∏–∏')
            ),
            h('div', { className: 'whatif-result__card-value' },
              '+', simulation.calories.add
            ),
            h('div', { className: `whatif-result__card-detail ${simulation.calories.ratio > 110 ? 'whatif-result__card-detail--bad' : simulation.calories.ratio >= 90 ? 'whatif-result__card-detail--good' : ''}` },
              simulation.calories.ratio, '% –æ—Ç –Ω–æ—Ä–º—ã'
            )
          ),

          // –°—ã—Ç–æ—Å—Ç—å
          h('div', { className: 'whatif-result__card' },
            h('div', { className: 'whatif-result__card-header' },
              h('span', { className: 'whatif-result__card-emoji' }, 'üòã'),
              h('span', null, '–°—ã—Ç–æ—Å—Ç—å')
            ),
            h('div', { className: 'whatif-result__card-value' },
              '~', simulation.satiety.hours, '—á'
            ),
            h('div', { className: 'whatif-result__card-detail' },
              simulation.satiety.desc
            )
          )
        ),

        // –°–æ–≤–µ—Ç—ã
        simulation.advice.length > 0 && h('div', { className: 'whatif-result__advice' },
          h('div', { className: 'whatif-result__advice-title' }, 'üí° –°–æ–≤–µ—Ç—ã'),
          simulation.advice.map((adv, i) =>
            h('div', {
              key: i,
              className: `whatif-result__advice-item whatif-result__advice-item--${adv.type}`,
              onClick: adv.altPreset ? () => handlePresetClick(adv.altPreset) : undefined
            },
              h('span', { className: 'whatif-result__advice-icon' }, adv.icon),
              h('span', null, adv.text)
            )
          )
        ),

        // Debug: GL –∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å
        h('div', { className: 'whatif-result__debug' },
          'GL: ', Math.round(simulation.wave.gl * 10) / 10,
          ' | –ú–Ω–æ–∂–∏—Ç–µ–ª—å: √ó', Math.round(simulation.wave.multiplier * 100) / 100
        )
      ),

      // Footer —Å –∫–Ω–æ–ø–∫–æ–π
      expanded && onClose && h('div', { className: 'whatif-simulator__footer' },
        h('button', {
          className: 'whatif-simulator__close',
          onClick: onClose
        }, '–ó–∞–∫—Ä—ã—Ç—å')
      )
    );
  }

  /**
   * WhatIfCard ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Insights
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∏–Ω–∏-—Å–∏–º—É–ª—è—Ç–æ—Ä —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ preset-–∞–º–∏
   */
  function WhatIfCard({ context }) {
    const { WHATIF_PRESETS, simulateFood } = getWhatIfDeps();
    const [isExpanded, setIsExpanded] = useState(false);
    const [quickResult, setQuickResult] = useState(null);
    const [selectedQuick, setSelectedQuick] = useState(null);

    // –ë—ã—Å—Ç—Ä—ã–µ preset-—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
    const quickPresets = WHATIF_PRESETS.slice(0, 4);

    const handleQuickSelect = (preset) => {
      setSelectedQuick(preset);
      if (context) {
        const result = simulateFood(preset, context);
        setQuickResult(result);
      }
    };

    return h('div', { className: 'whatif-card' },
      h('div', { className: 'whatif-card__header' },
        h('div', { className: 'whatif-card__title' },
          h('span', null, 'üß™'),
          ' –ß—Ç–æ –µ—Å–ª–∏ —Å—ä–µ—Å—Ç—å?'
        ),
        h(getInfoButton(), { infoKey: 'WHATIF_SIMULATOR' }),
        h('button', {
          className: 'whatif-card__expand',
          onClick: () => setIsExpanded(true)
        }, '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚Üí')
      ),

      // Quick presets
      h('div', { className: 'whatif-card__quick' },
        quickPresets.map(preset =>
          h('button', {
            key: preset.id,
            className: `whatif-card__quick-btn ${selectedQuick?.id === preset.id ? 'whatif-card__quick-btn--selected' : ''}`,
            onClick: () => handleQuickSelect(preset)
          },
            h('span', null, preset.emoji),
            h('span', null, preset.kcal, ' –∫–∫–∞–ª')
          )
        )
      ),

      // Quick result
      quickResult && h('div', { className: 'whatif-card__result' },
        h('div', { className: `whatif-card__verdict whatif-card__verdict--${quickResult.verdict}` },
          quickResult.verdict === 'good' ? '‚úÖ' : quickResult.verdict === 'neutral' ? 'üòê' : '‚ö†Ô∏è',
          ' –í–æ–ª–Ω–∞ ', quickResult.wave.hours, '—á',
          ' | –†–∏—Å–∫ ', quickResult.risk.delta > 0 ? '+' : '', quickResult.risk.delta, '%'
        ),
        quickResult.advice[0] && h('div', { className: 'whatif-card__advice' },
          quickResult.advice[0].icon, ' ', quickResult.advice[0].text
        )
      ),

      // Modal
      isExpanded && h('div', { className: 'whatif-modal-overlay', onClick: () => setIsExpanded(false) },
        h('div', { className: 'whatif-modal', onClick: (e) => e.stopPropagation() },
          h(WhatIfSimulator, {
            context,
            expanded: true,
            onClose: () => setIsExpanded(false)
          })
        )
      )
    );
  }

  /**
   * What-If Scenario Card
   */
  function ScenarioCard({ scenario }) {
    if (!scenario) return null;

    const diff = scenario.projectedScore - scenario.currentScore;
    const arrowClass = diff > 0 ? 'up' : diff < 0 ? 'down' : 'stable';
    const arrow = diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : '‚Üí';

    return h('div', { className: `insights-scenario insights-scenario--${scenario.id}` },
      h('div', { className: 'insights-scenario__icon' }, scenario.icon),
      h('div', { className: 'insights-scenario__content' },
        h('div', { className: 'insights-scenario__name' }, scenario.name),
        h('div', { className: 'insights-scenario__desc' }, scenario.description)
      ),
      h('div', { className: `insights-scenario__arrow insights-scenario__arrow--${arrowClass}` },
        scenario.currentScore, ' ', arrow, ' ', scenario.projectedScore
      )
    );
  }

  /**
   * What-If Section (v2.0: —Å InfoButton)
   */
  function WhatIfSection({ scenarios }) {
    if (!scenarios || scenarios.length === 0) return null;

    return h('div', { className: 'insights-whatif' },
      h('div', { className: 'insights-whatif__header' },
        h('span', { className: 'insights-whatif__title' }, 'üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏'),
        h(getInfoButton(), {
          infoKey: 'WHATIF',
          debugData: { scenariosCount: scenarios.length }
        })
      ),
      h('div', { className: 'insights-whatif__list' },
        scenarios.map((s, i) =>
          h(ScenarioCard, { key: s.id || i, scenario: s })
        )
      )
    );
  }

  /**
   * Weight Prediction Card (v2.0: —Å InfoButton)
   */
  function WeightPrediction({ prediction }) {
    if (!prediction) return null;
    return h('div', { className: 'insights-whatif__weight-prediction' },
      h('h3', null, '–ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞'),
      h('div', { className: 'weight-prediction-value' }, prediction)
    );
  }


  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsightsPI.uiWhatIf = {
    WhatIfSimulator,
    WhatIfCard,
    ScenarioCard,
    WhatIfSection
  };

  // Fallback –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  global.piUIWhatIf = HEYS.InsightsPI.uiWhatIf;

  devLog('[PI UI WhatIf] v3.0.0 loaded ‚Äî 4 What-If components');

})(typeof window !== 'undefined' ? window : global);


/* ===== insights/pi_ui_dashboard.js ===== */
/**
 * HEYS Predictive Insights ‚Äî UI Dashboard Components Module v3.0.1
 * Extracted UI dashboard components for clean architecture
 * v3.0.1: Fixed React guard - retry mechanism instead of early return
 */

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};
  const DEV = HEYS.dev || global.HEYS?.dev || {};
  const devLog = DEV.log ? DEV.log.bind(DEV) : () => { };
  const devWarn = DEV.warn ? DEV.warn.bind(DEV) : () => { };
  const trackError = HEYS.analytics?.trackError ? HEYS.analytics.trackError.bind(HEYS.analytics) : () => { };

  // React imports with retry mechanism for CDN loading
  function initModule() {
    const React = window.React;
    if (!React || !React.createElement) {
      // React not ready yet - retry in 50ms (CDN may still be loading)
      setTimeout(initModule, 50);
      return;
    }

    const { createElement: h, useState, useEffect, useMemo, Component, useCallback, useRef } = React;

    const piStats = HEYS.InsightsPI?.stats || window.piStats || {};
    const piAdvanced = HEYS.InsightsPI?.advanced || {};
    const piUICards = HEYS.InsightsPI?.uiCards || {};
    const piUIRings = HEYS.InsightsPI?.uiRings || {};
    const piConstants = HEYS.InsightsPI?.constants || {};
    const piUIHelpers = HEYS.InsightsPI?.uiHelpers || window.piUIHelpers || {};

    // Lazy getter –¥–ª—è InfoButton —Å –ø–æ–ª–Ω–æ–π fallback —Ü–µ–ø–æ—á–∫–æ–π (fix load order)
    function getInfoButton() {
      if (typeof piUIHelpers.getInfoButton === 'function') {
        return piUIHelpers.getInfoButton(h);
      }
      return HEYS.InsightsPI?.uiDashboard?.InfoButton ||
        HEYS.PredictiveInsights?.components?.InfoButton ||
        HEYS.day?.InfoButton ||
        HEYS.InfoButton ||
        window.InfoButton ||
        (() => h('span', { className: 'info-btn-placeholder' }, '?'));
    }

    // –ü–æ–ª—É—á–∞–µ–º UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ piUICards
    const {
      AdvancedAnalyticsCard,
      HealthRingsGrid,
      CollapsibleSection,
      MetabolismCard,
      MetabolismSection,
      PatternCard,
      PatternsList,
      ScenarioCard,
      WhatIfSimulator,
      WhatIfCard,
      WhatIfSection,
    } = piUICards;

    // –ü–æ–ª—É—á–∞–µ–º Ring –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ piUIRings
    const { TotalHealthRing } = piUIRings;

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ shared helpers (—É–º–µ–Ω—å—à–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏)
    const PRIORITY_LEVELS = typeof piUIHelpers.getPriorityLevels === 'function'
      ? piUIHelpers.getPriorityLevels(piConstants)
      : (piConstants.PRIORITY_LEVELS || {});
    const CATEGORIES = typeof piUIHelpers.getCategories === 'function'
      ? piUIHelpers.getCategories(piConstants)
      : (piConstants.CATEGORIES || {});
    const SCIENCE_INFO = piConstants.SCIENCE_INFO || {};
    const ACTIONABILITY = piConstants.ACTIONABILITY || {};
    const computeDynamicPriority = piConstants.computeDynamicPriority || ((opts) => {
      const section = piConstants.SECTIONS_CONFIG?.[opts?.sectionId];
      return section?.priority || 'INFO';
    });
    const PRIORITY_CONTEXT_LABELS = piConstants.PRIORITY_CONTEXT_LABELS || {};
    const DYNAMIC_LOG_PREFIX = 'priority /';
    const getAllMetricsByPriority = piConstants.getAllMetricsByPriority || function () {
      devWarn('[pi_ui_dashboard] getAllMetricsByPriority not available, returning empty array');
      return [];
    };

    /**
     * getMetabolismDate ‚Äî fallback –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
     * –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö (0 meals/trainings/sleep), –∏—â–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ 14 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
     */
    function getMetabolismDate(lsGet, selectedDate) {
      const getter = lsGet || window.HEYS?.utils?.lsGet;
      const today = HEYS.dayUtils?.todayISO?.() || new Date().toISOString().split('T')[0];
      const baseDate = selectedDate || today;
      // Fallback —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è (–Ω–µ –¥–ª—è —è–≤–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã)
      const canFallback = !selectedDate || selectedDate === today;
      if (!getter || !canFallback) return baseDate;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
      const hasMetabolismData = (day) => {
        if (!day || typeof day !== 'object') return false;
        if ((day.meals || []).length > 0) return true;
        if ((day.trainings || []).length > 0) return true;
        if ((day.sleepHours || 0) > 0) return true;
        return false;
      };

      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é –¥–∞—Ç—É
      const baseDay = getter(`heys_dayv2_${baseDate}`, {});
      if (hasMetabolismData(baseDay)) return baseDate;

      // Fallback: –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ 14 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
      for (let i = 1; i <= 14; i++) {
        const d = new Date(baseDate);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const day = getter(`heys_dayv2_${dateStr}`, {});
        if (hasMetabolismData(day)) return dateStr;
      }

      return baseDate; // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é –¥–∞—Ç—É
    }

    function WeightPrediction({ prediction }) {
      if (!prediction || !prediction.available) return null;

      const changeClass = prediction.weeklyChange < -0.1 ? 'down'
        : prediction.weeklyChange > 0.1 ? 'up'
          : 'stable';
      const changeSign = prediction.weeklyChange > 0 ? '+' : '';

      return h('div', { className: 'insights-weight' },
        h('div', { className: 'insights-weight__header' },
          h('span', null, '‚öñÔ∏è –ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞')
        ),
        h('div', { className: 'insights-weight__body' },
          h('div', { className: 'insights-weight__current' },
            h('div', { className: 'insights-weight__label' }, '–°–µ–π—á–∞—Å'),
            h('div', { className: 'insights-weight__value' }, prediction.currentWeight, ' –∫–≥')
          ),
          h('div', { className: 'insights-weight__arrow' },
            '‚Üí',
            h('div', { className: `insights-weight__change insights-weight__change--${changeClass}` },
              changeSign, Math.round(prediction.weeklyChange * 10) / 10, ' –∫–≥/–Ω–µ–¥'
            )
          ),
          h('div', { className: 'insights-weight__projected' },
            h('div', { className: 'insights-weight__label' }, '–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é'),
            h('div', { className: 'insights-weight__value' }, prediction.projectedWeight, ' –∫–≥')
          )
        )
      );
    }

    class InsightsErrorBoundary extends Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false };
      }

      static getDerivedStateFromError() {
        return { hasError: true };
      }

      componentDidCatch(error, errorInfo) {
        devWarn('[InsightsErrorBoundary] render failure:', error, errorInfo);
        trackError(error, {
          scope: 'PI UI Dashboard',
          action: 'render_boundary',
          componentStack: errorInfo?.componentStack
        });
      }

      render() {
        if (this.state.hasError) {
          return h('div', { className: 'insights-tab' },
            h('div', { className: 'insights-empty' },
              h('div', { className: 'insights-empty__icon' }, '‚ö†Ô∏è'),
              h('div', { className: 'insights-empty__title' }, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã'),
              h('div', { className: 'insights-empty__subtitle' }, '–û–±–Ω–æ–≤–∏ —ç–∫—Ä–∞–Ω ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã')
            )
          );
        }

        return this.props.children;
      }
    }

    /**
     * Weekly Wrap ‚Äî –∏—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏ (v2.0: —Å InfoButton)
     */
    /**
     * WeeklyWrap ‚Äî –∏—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏
     * v3.22.0: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Extended Analytics summary
     */
    function WeeklyWrap({ wrap, lsGet }) {
      if (!wrap) return null;

      // üÜï v3.22.0: Extended Analytics Summary –∑–∞ –Ω–µ–¥–µ–ª—é
      // NOTE: Removed useMemo ‚Äî this is called via h(), not a real React component
      const U = window.HEYS?.utils;
      const getter = lsGet || U?.lsGet || ((k, d) => {
        try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
      });
      const profile = getter('heys_profile', {});
      const pIndex = window.HEYS?.products?.getIndex?.();

      let proteinDeficitDays = 0;
      let highStressDays = 0;
      let trainingDays = 0;
      let avgEmotionalRisk = 0;
      let totalDays = 0;

      // –ê–Ω–∞–ª–∏–∑ –∑–∞ 7 –¥–Ω–µ–π
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const day = getter(`heys_dayv2_${dateStr}`, {});

        if (!day.meals || day.meals.length === 0) continue;
        totalDays++;

        // Protein analysis
        let dayProtein = 0;
        let dayKcal = 0;

        for (const meal of day.meals) {
          for (const item of (meal.items || [])) {
            const product = pIndex?.byId?.get(item.product_id) || item;
            const grams = item.grams || 0;
            dayProtein += (product.protein100 || 0) * grams / 100;
            dayKcal += (product.kcal100 || 0) * grams / 100;
          }
        }

        const targetProtein = (dayKcal * 0.25) / 4;
        if (targetProtein > 0 && dayProtein < targetProtein * 0.8) {
          proteinDeficitDays++;
        }

        // Stress
        if (day.stressAvg >= 6) highStressDays++;

        // Training
        if (day.trainings?.length > 0) trainingDays++;

        // Emotional risk accumulator
        let dayRisk = 0;
        if (day.stressAvg >= 6) dayRisk += 35;
        else if (day.stressAvg >= 4) dayRisk += 15;
        const sleepDef = (profile.sleepHours || 8) - (day.sleepHours || 0);
        if (sleepDef > 2) dayRisk += 15;
        avgEmotionalRisk += dayRisk;
      }

      if (totalDays > 0) {
        avgEmotionalRisk = Math.round(avgEmotionalRisk / totalDays);
      }

      const extendedSummary = {
        proteinDeficitDays,
        highStressDays,
        trainingDays,
        avgEmotionalRisk,
        totalDays,
        hasData: totalDays >= 3
      };

      return h('div', { className: 'insights-wrap' },
        h('div', { className: 'insights-wrap__header' },
          h('span', { className: 'insights-wrap__title' }, 'üìã –ò—Ç–æ–≥–∏')
        ),
        h('div', { className: 'insights-wrap__summary' },
          h('div', { className: 'insights-wrap__stat' },
            h('div', { className: 'insights-wrap__stat-value' }, wrap.daysWithData),
            h('div', { className: 'insights-wrap__stat-label' }, '–¥–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏')
          ),
          h('div', { className: 'insights-wrap__stat' },
            h('div', { className: 'insights-wrap__stat-container' },
              h('div', { className: 'insights-wrap__stat-value' }, wrap.healthScore),
              wrap.scoreChange !== 0 && h('span', {
                className: `insights-wrap__stat-change insights-wrap__stat-change--${wrap.scoreChange > 0 ? 'up' : 'down'}`,
                title: `–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ –Ω–µ–¥–µ–ª—é: ${wrap.scoreChange > 0 ? '+' : ''}${wrap.scoreChange}`
              },
                wrap.scoreChange > 0 ? 'üìà' : 'üìâ',
                ' ',
                wrap.scoreChange > 0 ? `+${wrap.scoreChange}` : wrap.scoreChange
              )
            ),
            h('div', { className: 'insights-wrap__stat-label' }, 'Health Score')
          )
        ),

        // üÜï v3.22.0: Extended Analytics Summary
        extendedSummary.hasData && h('div', { className: 'insights-wrap__extended' },
          h('div', { className: 'insights-wrap__extended-title' }, 'üß† –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞'),
          h('div', { className: 'insights-wrap__extended-grid' },
            // Protein Debt Days
            h('div', {
              className: `insights-wrap__extended-item ${extendedSummary.proteinDeficitDays >= 3 ? 'insights-wrap__extended-item--warning' : ''}`
            },
              h('span', { className: 'insights-wrap__extended-value' },
                extendedSummary.proteinDeficitDays === 0 ? '‚úÖ' : extendedSummary.proteinDeficitDays
              ),
              h('span', { className: 'insights-wrap__extended-label' },
                extendedSummary.proteinDeficitDays === 0 ? '–ë–µ–ª–æ–∫ –û–ö' : '–¥–Ω. –º–∞–ª–æ –±–µ–ª–∫–∞'
              ),
              extendedSummary.proteinDeficitDays >= 3 && h('a', {
                href: 'https://pubmed.ncbi.nlm.nih.gov/20095013/',
                target: '_blank',
                className: 'insights-wrap__extended-pmid',
                title: 'Mettler 2010 ‚Äî –±–µ–ª–æ–∫ –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ'
              }, 'üî¨')
            ),

            // High Stress Days
            h('div', {
              className: `insights-wrap__extended-item ${extendedSummary.highStressDays >= 3 ? 'insights-wrap__extended-item--warning' : ''}`
            },
              h('span', { className: 'insights-wrap__extended-value' },
                extendedSummary.highStressDays === 0 ? 'üòå' : extendedSummary.highStressDays
              ),
              h('span', { className: 'insights-wrap__extended-label' },
                extendedSummary.highStressDays === 0 ? '–°—Ç—Ä–µ—Å—Å –û–ö' : '–¥–Ω. —Å—Ç—Ä–µ—Å—Å ‚â•6'
              ),
              extendedSummary.highStressDays >= 3 && h('a', {
                href: 'https://pubmed.ncbi.nlm.nih.gov/11070333/',
                target: '_blank',
                className: 'insights-wrap__extended-pmid',
                title: 'Epel 2001 ‚Äî —Å—Ç—Ä–µ—Å—Å –∏ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ'
              }, 'üî¨')
            ),

            // Training Days
            h('div', { className: 'insights-wrap__extended-item insights-wrap__extended-item--positive' },
              h('span', { className: 'insights-wrap__extended-value' },
                extendedSummary.trainingDays === 0 ? '‚Äî' : `üí™ ${extendedSummary.trainingDays}`
              ),
              h('span', { className: 'insights-wrap__extended-label' }, '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫')
            ),

            // Avg Emotional Risk
            h('div', {
              className: `insights-wrap__extended-item ${extendedSummary.avgEmotionalRisk >= 40 ? 'insights-wrap__extended-item--warning' : ''}`
            },
              h('span', { className: 'insights-wrap__extended-value' },
                extendedSummary.avgEmotionalRisk < 20 ? 'üßò' : `${extendedSummary.avgEmotionalRisk}%`
              ),
              h('span', { className: 'insights-wrap__extended-label' },
                extendedSummary.avgEmotionalRisk < 20 ? '–≠–º–æ—Ü. –û–ö' : '—Å—Ä. —ç–º–æ—Ü.—Ä–∏—Å–∫'
              )
            )
          )
        ),

        // üÜï v5.2.0: Scientific Week-Over-Week Analysis
        wrap.weekOverWeekStats && h('div', { className: 'insights-wrap__scientific' },
          h('div', { className: 'insights-wrap__scientific-header' },
            h('span', { className: 'insights-wrap__scientific-title' }, 'üìä –ù–∞—É—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑'),
            h('span', {
              className: `insights-wrap__significance-badge insights-wrap__significance-badge--${wrap.weekOverWeekStats.isSignificant ? 'sig' : 'nonsig'}`,
              title: `p-value: ${wrap.weekOverWeekStats.pValue.toFixed(3)}, t-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${wrap.weekOverWeekStats.tStat}`
            },
              wrap.weekOverWeekStats.isSignificant ? '‚úì –ó–Ω–∞—á–∏–º–æ' : '‚Äî –ù–µ –∑–Ω–∞—á–∏–º–æ'
            )
          ),

          h('div', { className: 'insights-wrap__scientific-grid' },
            // Change direction & magnitude
            h('div', { className: 'insights-wrap__scientific-item' },
              h('div', { className: 'insights-wrap__scientific-label' }, '–ò–∑–º–µ–Ω–µ–Ω–∏–µ'),
              h('div', {
                className: `insights-wrap__scientific-value insights-wrap__scientific-value--${wrap.weekOverWeekStats.direction}`
              },
                wrap.weekOverWeekStats.direction === 'increase' ? 'üìà' : (wrap.weekOverWeekStats.direction === 'decrease' ? 'üìâ' : '‚Äî'),
                ' ',
                wrap.weekOverWeekStats.change > 0 ? `+${wrap.weekOverWeekStats.change}` : wrap.weekOverWeekStats.change,
                ' ',
                h('span', { className: 'insights-wrap__scientific-percent' },
                  `(${wrap.weekOverWeekStats.changePercent > 0 ? '+' : ''}${wrap.weekOverWeekStats.changePercent}%)`
                )
              )
            ),

            // Effect size
            h('div', { className: 'insights-wrap__scientific-item' },
              h('div', { className: 'insights-wrap__scientific-label' }, '–†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞'),
              h('div', { className: 'insights-wrap__scientific-value' },
                `Cohen's d = ${wrap.weekOverWeekStats.effectSize}`,
                ' ',
                h('span', {
                  className: `insights-wrap__effect-badge insights-wrap__effect-badge--${wrap.weekOverWeekStats.effectSizeInterpretation}`,
                  title: 'small(<0.5) | medium(0.5-0.8) | large(‚â•0.8)'
                },
                  wrap.weekOverWeekStats.effectSizeInterpretation === 'large' ? 'üî•' :
                    (wrap.weekOverWeekStats.effectSizeInterpretation === 'medium' ? '‚ö°' : '~')
                )
              )
            ),

            // Statistical power
            h('div', { className: 'insights-wrap__scientific-item' },
              h('div', { className: 'insights-wrap__scientific-label' }, '–ú–æ—â–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞'),
              h('div', { className: 'insights-wrap__scientific-value' },
                `${(wrap.weekOverWeekStats.power * 100).toFixed(0)}%`,
                ' ',
                wrap.weekOverWeekStats.power < 0.5 && h('span', {
                  className: 'insights-wrap__power-warning',
                  title: '–ù–∏–∑–∫–∞—è –º–æ—â–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞ - –≤–æ–∑–º–æ–∂–Ω—ã –ª–æ–∂–Ω–æ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'
                }, '‚ö†Ô∏è')
              )
            ),

            // p-value
            h('div', { className: 'insights-wrap__scientific-item' },
              h('div', { className: 'insights-wrap__scientific-label' }, 'p-–∑–Ω–∞—á–µ–Ω–∏–µ'),
              h('div', { className: 'insights-wrap__scientific-value' },
                wrap.weekOverWeekStats.pValue < 0.001 ? '<0.001' : wrap.weekOverWeekStats.pValue.toFixed(3),
                ' ',
                h('a', {
                  href: 'https://en.wikipedia.org/wiki/P-value',
                  target: '_blank',
                  className: 'insights-wrap__scientific-link',
                  title: 'p < 0.05 = —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ'
                }, '‚ÑπÔ∏è')
              )
            )
          ),

          // Confidence intervals visualization
          h('div', { className: 'insights-wrap__ci-comparison' },
            h('div', { className: 'insights-wrap__ci-title' }, '–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (95%)'),

            // Previous week CI
            h('div', { className: 'insights-wrap__ci-row' },
              h('div', { className: 'insights-wrap__ci-label' }, '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è'),
              h('div', { className: 'insights-wrap__ci-bar' },
                h('div', {
                  className: 'insights-wrap__ci-range',
                  style: { width: `${Math.min(100, wrap.weekOverWeekStats.prevWeekCI.margin / 5 * 100)}%` },
                  title: `${wrap.weekOverWeekStats.prevWeekCI.lower}-${wrap.weekOverWeekStats.prevWeekCI.upper} (¬±${wrap.weekOverWeekStats.prevWeekCI.margin})`
                }),
                h('span', { className: 'insights-wrap__ci-value' },
                  `${wrap.weekOverWeekStats.prevWeekAvg} ¬± ${wrap.weekOverWeekStats.prevWeekCI.margin}`,
                  ' ',
                  h('span', { className: 'insights-wrap__ci-n' }, `(n=${wrap.weekOverWeekStats.prevWeekN})`)
                )
              )
            ),

            // Current week CI
            h('div', { className: 'insights-wrap__ci-row' },
              h('div', { className: 'insights-wrap__ci-label' }, '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è'),
              h('div', { className: 'insights-wrap__ci-bar' },
                h('div', {
                  className: 'insights-wrap__ci-range insights-wrap__ci-range--current',
                  style: { width: `${Math.min(100, wrap.weekOverWeekStats.currentWeekCI.margin / 5 * 100)}%` },
                  title: `${wrap.weekOverWeekStats.currentWeekCI.lower}-${wrap.weekOverWeekStats.currentWeekCI.upper} (¬±${wrap.weekOverWeekStats.currentWeekCI.margin})`
                }),
                h('span', { className: 'insights-wrap__ci-value' },
                  `${wrap.weekOverWeekStats.currentWeekAvg} ¬± ${wrap.weekOverWeekStats.currentWeekCI.margin}`,
                  ' ',
                  h('span', { className: 'insights-wrap__ci-n' }, `(n=${wrap.weekOverWeekStats.currentWeekN})`)
                )
              )
            )
          )
        ),

        wrap.bestDay && h('div', { className: 'insights-wrap__highlight' },
          h('div', { className: 'insights-wrap__highlight-title' }, 'üèÜ –õ—É—á—à–∏–π –¥–µ–Ω—å'),
          h('div', { className: 'insights-wrap__highlight-value' },
            wrap.bestDay.date, ' ‚Äî ', wrap.bestDay.kcal, ' –∫–∫–∞–ª'
          )
        ),
        wrap.hiddenWins && wrap.hiddenWins.length > 0 && h('div', { className: 'insights-wins' },
          h('div', { className: 'insights-wins__title' }, 'üéØ –°–∫—Ä—ã—Ç—ã–µ –ø–æ–±–µ–¥—ã'),
          wrap.hiddenWins.map((win, i) =>
            h('div', { key: i, className: 'insights-win' }, win)
          )
        )
      );
    }

    /**
     * EarlyWarningCard ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ –ø–æ–¥ Health Score Ring
     * 
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç summary warnings count —Å severity badges.
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç EarlyWarningPanel modal –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.
     * 
     * @param {function} lsGet - localStorage getter (namespace-aware)
     * @param {object} profile - User profile
     * @param {object} pIndex - Product index
     */
    function EarlyWarningCard({ lsGet, profile, pIndex }) {
      const [warnings, setWarnings] = useState([]);
      const [loading, setLoading] = useState(true);
      const [panelOpen, setPanelOpen] = useState(false);

      // Load warnings on mount + day updates
      useEffect(() => {
        if (!HEYS.InsightsPI?.earlyWarning) {
          setLoading(false);
          return;
        }

        const checkWarnings = async () => {
          try {
            performance.mark('ews_card_detect_start');

            // Load 30 days of data (namespace-aware via lsGet)
            const days = [];
            const U = window.HEYS?.utils || {};
            const fmtDate = HEYS.dayUtils?.fmtDate || U.fmtDate;
            if (!fmtDate) {
              console.warn('[EarlyWarningCard] fmtDate not available');
              setLoading(false);
              return;
            }

            for (let i = 0; i < 30; i++) {
              const d = new Date();
              d.setDate(d.getDate() - i);
              const dateStr = fmtDate(d);
              const dayData = lsGet(`heys_dayv2_${dateStr}`);
              if (dayData) days.push({ ...dayData, date: dateStr });
            }

            if (days.length < 7) {
              console.info('[EarlyWarningCard] ‚è∏Ô∏è Insufficient data:', days.length, 'days');
              setLoading(false);
              return;
            }

            // Get current patterns (7 days) for context
            const currentInsights = HEYS.PredictiveInsights?.analyze?.({
              daysBack: 7,
              profile,
              pIndex,
              lsGet
            });

            console.info('[EarlyWarningCard] üì§ calling detect:', {
              daysCount: days.length,
              hasProfile: !!profile,
              pIndexCount: pIndex?.length || 0,
              hasCurrentPatterns: !!currentInsights?.patterns,
              patternsCount: currentInsights?.patterns ? Object.keys(currentInsights.patterns).length : 0
            });

            // Detect warnings
            const result = HEYS.InsightsPI.earlyWarning.detect(
              days,
              profile,
              pIndex,
              { currentPatterns: currentInsights?.patterns }
            );

            performance.mark('ews_card_detect_end');
            performance.measure('ews_card_detect', 'ews_card_detect_start', 'ews_card_detect_end');

            if (result.available && result.warnings) {
              setWarnings(result.warnings);

              console.info('[EarlyWarningCard] ‚úÖ Warnings loaded:', {
                total: result.warnings.length,
                high: result.warnings.filter(w => w.severity === 'high').length,
                medium: result.warnings.filter(w => w.severity === 'medium').length,
                low: result.warnings.filter(w => w.severity === 'low').length
              });
            }

            setLoading(false);
          } catch (err) {
            console.error('[EarlyWarningCard] ‚ùå Detection failed:', err);
            setLoading(false);
          }
        };

        checkWarnings();
        window.addEventListener('day-updated', checkWarnings);
        window.addEventListener('heys-sync-complete', checkWarnings);

        return () => {
          window.removeEventListener('day-updated', checkWarnings);
          window.removeEventListener('heys-sync-complete', checkWarnings);
        };
      }, [lsGet, profile, pIndex]);

      // Don't show card if no module or no warnings
      if (!HEYS.InsightsPI?.earlyWarning) return null;
      if (loading) return null;
      if (warnings.length === 0) {
        // Show success state briefly
        return h('div', { className: 'early-warning-card early-warning-card--success' },
          h('div', { className: 'early-warning-card__icon' }, '‚úÖ'),
          h('div', { className: 'early-warning-card__text' }, '–í—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π')
        );
      }

      // Group warnings by severity
      const severityCounts = {
        high: warnings.filter(w => w.severity === 'high').length,
        medium: warnings.filter(w => w.severity === 'medium').length,
        low: warnings.filter(w => w.severity === 'low').length
      };

      return h('div', null,
        // Compact warning card
        h('div', {
          className: 'early-warning-card early-warning-card--has-warnings',
          onClick: () => setPanelOpen(true)
        },
          h('div', { className: 'early-warning-card__header' },
            h('span', { className: 'early-warning-card__icon' }, '‚ö†Ô∏è'),
            h('span', { className: 'early-warning-card__title' },
              `${warnings.length} ${warnings.length === 1 ? '–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ' : warnings.length < 5 ? '–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è' : '–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π'}`
            )
          ),
          h('div', { className: 'early-warning-card__badges' },
            severityCounts.high > 0 && h('span', { className: 'early-warning-badge early-warning-badge--high' },
              'üö® ', severityCounts.high
            ),
            severityCounts.medium > 0 && h('span', { className: 'early-warning-badge early-warning-badge--medium' },
              '‚ö†Ô∏è ', severityCounts.medium
            ),
            severityCounts.low > 0 && h('span', { className: 'early-warning-badge early-warning-badge--low' },
              '‚ÑπÔ∏è ', severityCounts.low
            )
          ),
          h('div', { className: 'early-warning-card__cta' },
            '–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí'
          )
        ),

        // Early Warning Panel Modal
        panelOpen && HEYS.EarlyWarningPanel && h(HEYS.EarlyWarningPanel, {
          isOpen: panelOpen,
          onClose: () => setPanelOpen(false),
          warnings,
          mode: 'full'  // Insights dashboard shows comprehensive 30-day audit
        })
      );
    }

    /**
     * Empty State ‚Äî –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
     */
    function EmptyState({ daysAnalyzed, minRequired }) {
      const progress = Math.min(100, Math.round((daysAnalyzed / minRequired) * 100));
      const daysLeft = Math.max(0, minRequired - daysAnalyzed);

      // –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      const getMessage = () => {
        if (daysAnalyzed === 0) return '–ù–∞—á–Ω–∏—Ç–µ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫ ‚Äî –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç!';
        if (progress < 50) return '–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫';
        if (progress < 100) return '–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ! –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ';
        return '–î–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
      };

      return h('div', { className: 'insights-empty' },
        // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞
        h('div', { className: 'insights-empty__icon' }, 'üîÆ'),

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        h('div', { className: 'insights-empty__title' }, '–°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏'),

        // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π
        h('div', { className: 'insights-empty__subtitle' }, getMessage()),

        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        h('div', { className: 'insights-empty__progress' },
          h('div', {
            className: 'insights-empty__progress-fill',
            style: { width: `${progress}%` }
          })
        ),

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        h('div', { className: 'insights-empty__stats' },
          h('div', { style: { textAlign: 'center' } },
            h('div', { className: 'insights-empty__stat-value insights-empty__stat-value--primary' }, daysAnalyzed),
            h('div', { className: 'insights-empty__stat-label' }, '–¥–Ω–µ–π –µ—Å—Ç—å')
          ),
          h('div', { style: { textAlign: 'center' } },
            h('div', { className: 'insights-empty__stat-value insights-empty__stat-value--secondary' }, daysLeft),
            h('div', { className: 'insights-empty__stat-label' }, '–æ—Å—Ç–∞–ª–æ—Å—å')
          )
        ),

        // –ß—Ç–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ
        h('div', { className: 'insights-empty__features' },
          h('div', { className: 'insights-empty__features-title' }, '‚ú® –°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ:'),
          h('div', { className: 'insights-empty__feature-list' },
            h('div', { className: 'insights-empty__feature-item' },
              h('span', null, 'üìä'), '–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è 0-100'
            ),
            h('div', { className: 'insights-empty__feature-item' },
              h('span', null, 'üß¨'), '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø'
            ),
            h('div', { className: 'insights-empty__feature-item' },
              h('span', null, 'üí°'), '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'
            ),
            h('div', { className: 'insights-empty__feature-item' },
              h('span', null, 'üìà'), '–ü—Ä–æ–≥–Ω–æ–∑—ã –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã'
            )
          )
        )
      );
    }

    /**
     * Main Insights Card ‚Äî –≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
     */
    function InsightsCard({ lsGet, profile, pIndex, optimum }) {
      const [activeTab, setActiveTab] = useState('today');
      const [selectedCategory, setSelectedCategory] = useState(null);

      const insights = useMemo(() => {
        // üîß v6.0.2: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π daysBack –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞–±–∞
        const daysBack = activeTab === 'today' ? 7 : 30;
        return HEYS.PredictiveInsights.analyze({
          daysBack,
          lsGet,
          profile,
          pIndex,
          optimum
        });
      }, [activeTab, lsGet, profile, pIndex, optimum]);

      // –°–æ–±–∏—Ä–∞–µ–º context –¥–ª—è What-If —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
      const whatIfContext = useMemo(() => {
        if (!lsGet) return null;

        const todayKey = new Date().toISOString().slice(0, 10);
        const today = lsGet(`heys_dayv2_${todayKey}`, {});
        const dayTot = today.dayTot || { kcal: 0, prot: 0, carbs: 0, fat: 0 };

        // –¢–µ–∫—É—â–∞—è –≤–æ–ª–Ω–∞
        let currentWave = null;
        if (HEYS.InsulinWave?.calculate && today.meals?.length > 0) {
          try {
            currentWave = HEYS.InsulinWave.calculate({
              meals: today.meals,
              pIndex,
              getProductFromItem: (item) => pIndex?.byId?.get(item.product_id) || item,
              baseWaveHours: profile?.insulinWaveHours || 3,
              trainings: today.trainings || [],
              dayData: {
                sleepHours: today.sleepHours,
                sleepQuality: today.sleepQuality,
                waterMl: today.waterMl,
                stressAvg: today.stressAvg,
                householdMin: today.householdMin,
                steps: today.steps,
                profile
              }
            });
          } catch (e) {
            devWarn('[WhatIfSimulator] Failed to calculate wave:', e);
            trackError(e, { scope: 'PI UI Dashboard', action: 'calculate_wave' });
          }
        }

        // –¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞
        let currentRisk = 0;
        if (HEYS.Metabolic?.calculateCrashRisk24h) {
          try {
            const riskData = HEYS.Metabolic.calculateCrashRisk24h({
              today,
              profile,
              kcalPct: optimum ? dayTot.kcal / optimum : 0,
              proteinPct: dayTot.prot ? dayTot.prot / ((optimum || 2000) * 0.25 / 4) : 0
            });
            currentRisk = riskData?.risk || 0;
          } catch (e) { }
        }

        return {
          currentWave,
          currentRisk,
          dayTot,
          optimum,
          profile,
          trainings: today.trainings || []
        };
      }, [lsGet, profile, pIndex, optimum]);

      if (!insights.available) {
        return h('div', { className: 'insights-card' },
          h('div', { className: 'insights-card__header' },
            h('div', { className: 'insights-card__title' }, 'üìä –ò–Ω—Å–∞–π—Ç—ã –Ω–µ–¥–µ–ª–∏')
          ),
          h(EmptyState, {
            daysAnalyzed: insights.daysAnalyzed,
            minRequired: insights.minDaysRequired
          })
        );
      }

      return h('div', { className: 'insights-card' },
        h('div', { className: 'insights-card__header' },
          h('div', { className: 'insights-card__title' },
            'üìä –ò–Ω—Å–∞–π—Ç—ã –Ω–µ–¥–µ–ª–∏',
            h('span', { className: 'insights-card__badge' }, insights.healthScore.total)
          )
        ),
        h('div', { className: 'insights-card__tabs' },
          h('button', {
            className: `insights-card__tab ${activeTab === 'today' ? 'insights-card__tab--active' : ''}`,
            onClick: () => setActiveTab('today')
          }, '–°–µ–≥–æ–¥–Ω—è'),
          h('button', {
            className: `insights-card__tab ${activeTab === 'week' ? 'insights-card__tab--active' : ''}`,
            onClick: () => setActiveTab('week')
          }, '–ù–µ–¥–µ–ª—è')
        ),

        // Health Score –∫–æ–ª—å—Ü–∞
        h(TotalHealthRing, { score: insights.healthScore.total }),
        h(HealthRingsGrid, {
          healthScore: insights.healthScore,
          onCategoryClick: setSelectedCategory
        }),

        // üß™ What-If Simulator (–Ω–æ–≤—ã–π!)
        activeTab === 'today' && whatIfContext && h(WhatIfCard, { context: whatIfContext }),

        // –°—Ç–∞—Ä–∞—è What-If —Å–µ–∫—Ü–∏—è (—Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏)
        h(WhatIfSection, { scenarios: insights.whatIf }),

        // Weight Prediction
        h(WeightPrediction, { prediction: insights.weightPrediction }),

        // –ü–∞—Ç—Ç–µ—Ä–Ω—ã (—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π —Å–ø–∏—Å–æ–∫)
        activeTab === 'week' && h(PatternsList, { patterns: insights.patterns }),

        // Weekly Wrap
        activeTab === 'week' && h(WeeklyWrap, { wrap: insights.weeklyWrap })
      );
    }

    // === PRIORITY UI COMPONENTS ===

    /**
     * PriorityBadge ‚Äî –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —Å emoji –∏ —Ü–≤–µ—Ç–æ–º
     */
    function PriorityBadge({ priority, showLabel = false, size = 'normal', contextLabels = null }) {
      const config = PRIORITY_LEVELS[priority] || PRIORITY_LEVELS.INFO;
      const label = contextLabels?.[priority] || config.name;
      const lastBadgeLogRef = useRef(null);

      useEffect(() => {
        if (typeof console === 'undefined' || !console.info || !contextLabels) return;

        const signature = `${priority || 'INFO'}|${label}|${config.color}|${size}|${showLabel ? '1' : '0'}`;
        if (lastBadgeLogRef.current === signature) return;

        lastBadgeLogRef.current = signature;
        console.info(`${DYNAMIC_LOG_PREFIX} üè∑Ô∏è badge:`, {
          priority: priority || 'INFO',
          label,
          color: config.color,
          size,
          showLabel
        });
      }, [priority, label, config.color, size, showLabel, contextLabels]);

      return h('span', {
        className: `priority-badge priority-badge--${priority?.toLowerCase() || 'info'} priority-badge--${size}`,
        style: {
          '--priority-color': config.color,
          backgroundColor: config.color + '20',
          color: config.color,
          borderColor: config.color + '40'
        },
        title: config.description
      },
        h('span', { className: 'priority-badge__emoji' }, config.emoji),
        showLabel && h('span', { className: 'priority-badge__label' }, label)
      );
    }

    /**
     * CategoryBadge ‚Äî –±–µ–π–¥–∂ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     */
    function CategoryBadge({ category, showLabel = true }) {
      const config = CATEGORIES[category] || CATEGORIES.STATISTICS;

      return h('span', {
        className: `category-badge category-badge--${category?.toLowerCase() || 'statistics'}`,
        style: {
          '--category-color': config.color,
          backgroundColor: config.color + '15',
          color: config.color
        },
        title: config.description
      },
        h('span', { className: 'category-badge__emoji' }, config.emoji),
        showLabel && h('span', { className: 'category-badge__label' }, config.name)
      );
    }

    /**
     * ActionabilityBadge ‚Äî —Å—Ä–æ—á–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è
     */
    function ActionabilityBadge({ actionability }) {
      const config = ACTIONABILITY[actionability] || ACTIONABILITY.INFORMATIONAL;

      return h('span', {
        className: `actionability-badge actionability-badge--${actionability?.toLowerCase() || 'informational'}`,
        title: config.description
      },
        h('span', { className: 'actionability-badge__emoji' }, config.emoji),
        h('span', { className: 'actionability-badge__label' }, config.name)
      );
    }

    /**
     * CategoryFilterBar ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
     */
    function CategoryFilterBar({ selectedCategory, onCategoryChange, metrics }) {
      // –ü–æ–¥—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      const categoryCounts = useMemo(() => {
        const counts = {};
        for (const cat of Object.keys(CATEGORIES)) {
          counts[cat] = metrics?.filter(m => m.category === cat).length || 0;
        }
        return counts;
      }, [metrics]);

      return h('div', { className: 'category-filter-bar' },
        // All button
        h('button', {
          className: `category-filter-bar__btn ${!selectedCategory ? 'active' : ''}`,
          onClick: () => onCategoryChange(null)
        },
          h('span', { className: 'category-filter-bar__emoji' }, 'üìä'),
          h('span', { className: 'category-filter-bar__label' }, '–í—Å–µ'),
          h('span', { className: 'category-filter-bar__count' }, metrics?.length || 0)
        ),

        // Category buttons
        Object.entries(CATEGORIES).map(([key, config]) => {
          const count = categoryCounts[key];
          if (count === 0) return null;

          return h('button', {
            key,
            className: `category-filter-bar__btn ${selectedCategory === key ? 'active' : ''}`,
            onClick: () => onCategoryChange(key),
            style: { '--cat-color': config.color }
          },
            h('span', { className: 'category-filter-bar__emoji' }, config.emoji),
            h('span', { className: 'category-filter-bar__label' }, config.name),
            h('span', { className: 'category-filter-bar__count' }, count)
          );
        })
      );
    }

    /**
     * PriorityFilterBar ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
     */
    function PriorityFilterBar({ selectedPriority, onPriorityChange, metrics }) {
      // –ü–æ–¥—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ
      const priorityCounts = useMemo(() => {
        const counts = {};
        for (const pri of Object.keys(PRIORITY_LEVELS)) {
          counts[pri] = metrics?.filter(m => m.priority === pri).length || 0;
        }
        return counts;
      }, [metrics]);

      return h('div', { className: 'priority-filter-bar' },
        // All button
        h('button', {
          className: `priority-filter-bar__btn ${!selectedPriority ? 'active' : ''}`,
          onClick: () => onPriorityChange(null)
        },
          'üîÆ –í—Å—ë'
        ),

        // Priority buttons (—Ç–æ–ª—å–∫–æ CRITICAL, HIGH, MEDIUM ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–¥–∫–æ –Ω—É–∂–Ω—ã –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä)
        ['CRITICAL', 'HIGH', 'MEDIUM'].map(key => {
          const config = PRIORITY_LEVELS[key];
          const count = priorityCounts[key];
          if (count === 0) return null;

          return h('button', {
            key,
            className: `priority-filter-bar__btn ${selectedPriority === key ? 'active' : ''}`,
            onClick: () => onPriorityChange(key),
            style: { '--pri-color': config.color }
          },
            h('span', null, config.emoji),
            h('span', null, ` ${config.name}`),
            h('span', { className: 'priority-filter-bar__count' }, count)
          );
        })
      );
    }

    /**
     * SectionHeader ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
     * NOTE: This is a h()-factory (not a React component), so NO HOOKS allowed!
     * Using simple placeholder instead of InfoButton
     */
    function SectionHeader({ title, icon, priority, infoKey, badge }) {
      const priorityConfig = PRIORITY_LEVELS[priority] || PRIORITY_LEVELS.INFO;

      return h('div', { className: 'section-header section-header--with-priority' },
        h('div', { className: 'section-header__left' },
          icon && h('span', { className: 'section-header__icon' }, icon),
          h('span', { className: 'section-header__title' }, title),
          priority && h(PriorityBadge, { priority, size: 'small' })
        ),
        h('div', { className: 'section-header__right' },
          badge && h('span', { className: 'section-header__badge' }, badge)
          // infoKey removed ‚Äî InfoButton has hooks, can't use in h()-factory
        )
      );
    }

    // === INSIGHTS TAB ‚Äî –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ ===
    // –°–µ–∫—Ü–∏–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É: CRITICAL ‚Üí HIGH ‚Üí MEDIUM ‚Üí LOW
    // üé≠ –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç—É—Ä–∞ –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    const DEMO_INSIGHTS = {
      available: true,
      isDemo: true,
      daysAnalyzed: 7,
      daysWithData: 7,
      confidence: 85,
      isFullAnalysis: false,
      patterns: [
        {
          id: 'demo_meal_timing',
          type: 'timing',
          name: '–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–æ–≤',
          priority: 'HIGH',
          confidence: 0.82,
          impact: 0.7,
          desc: '–í–∞—à–∏ –∑–∞–≤—Ç—Ä–∞–∫–∏ –≤ 8-9 —É—Ç—Ä–∞ –∏–¥–µ–∞–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å —Ü–∏—Ä–∫–∞–¥–Ω—ã–º–∏ —Ä–∏—Ç–º–∞–º–∏',
          recommendation: '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∑–∞–≤—Ç—Ä–∞–∫–∞—Ç—å –≤ —ç—Ç–æ –≤—Ä–µ–º—è ‚Äî –º–µ—Ç–∞–±–æ–ª–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ',
          trend: 'stable',
          science: { pmid: '9331550', category: 'TIMING' }
        },
        {
          id: 'demo_protein',
          type: 'nutrition',
          name: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞',
          priority: 'MEDIUM',
          confidence: 0.75,
          impact: 0.6,
          desc: '–ë–µ–ª–æ–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ: ~30–≥ –Ω–∞ –ø—Ä–∏—ë–º',
          recommendation: '–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å! –≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à–µ—á–Ω–æ–≥–æ –±–µ–ª–∫–∞',
          trend: 'improving',
          science: { pmid: '23360586', category: 'NUTRITION' }
        }
      ],
      healthScore: {
        total: 78,
        trend: 'improving',
        categories: {
          nutrition: { score: 82, trend: 'stable' },
          timing: { score: 75, trend: 'improving' },
          recovery: { score: 72, trend: 'stable' },
          activity: { score: 80, trend: 'improving' }
        }
      },
      whatIf: [
        {
          id: 'demo_whatif_1',
          title: '+30 –º–∏–Ω —Ö–æ–¥—å–±—ã',
          impact: '+5% –∫ —Å–∂–∏–≥–∞–Ω–∏—é',
          desc: '–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≥—É–ª–∫—É –ø–æ—Å–ª–µ –æ–±–µ–¥–∞',
          priority: 'MEDIUM'
        }
      ],
      weightPrediction: {
        available: true,
        currentTrend: -0.3,
        weeklyRate: -0.3,
        projectedDays: 60,
        confidence: 0.7
      },
      weeklyWrap: {
        highlights: ['–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è', '–•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å –ë–ñ–£'],
        improvements: ['–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏'],
        avgScore: 78
      }
    };

    // üé≠ –î–µ–º–æ-—Å—Ç–∞—Ç—É—Å –¥–ª—è —Ç—É—Ä–∞
    const DEMO_STATUS = {
      score: 78,
      level: {
        id: 'good',
        label: '–•–æ—Ä–æ—à–æ',
        emoji: '‚úì',
        color: '#22c55e'
      },
      factorScores: {
        kcal: 85,
        protein: 80,
        timing: 70,
        steps: 75,
        training: 60,
        household: 50,
        sleep: 85,
        stress: 70,
        water: 90
      },
      categoryScores: {
        nutrition: { score: 78, label: '–ü–∏—Ç–∞–Ω–∏–µ', icon: 'üçΩÔ∏è', color: '#22c55e' },
        activity: { score: 62, label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', icon: 'üèÉ', color: '#eab308' },
        recovery: { score: 77, label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', icon: 'üò¥', color: '#22c55e' },
        hydration: { score: 90, label: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è', icon: 'üíß', color: '#22c55e' }
      },
      topIssues: [
        { factor: { icon: 'üèãÔ∏è', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏' }, score: 60 },
        { factor: { icon: '‚è∞', label: '–¢–∞–π–º–∏–Ω–≥' }, score: 70 }
      ],
      topActions: [
        '–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
        '–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–æ–≤'
      ]
    };

    function InsightsTab({ lsGet, profile, pIndex, optimum, selectedDate, dayData, dayTot, normAbs, waterGoal }) {
      const [activeTab, setActiveTab] = useState('today');
      const [selectedCategory, setSelectedCategory] = useState(null);
      const [priorityFilter, setPriorityFilter] = useState(null); // null = –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë
      const [showPatternDebug, setShowPatternDebug] = useState(false); // Pattern Transparency Modal
      const [showPhenotypeClassifier, setShowPhenotypeClassifier] = useState(false); // Phenotype Classifier Panel
      const [showWhatIfScenarios, setShowWhatIfScenarios] = useState(false); // What-If Scenarios Panel
      const [ewsWarnings, setEwsWarnings] = useState([]);

      // üéØ State –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç—É—Ä–∞ (–Ω—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)
      // üîß v1.13 FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º –û–ë–ê –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Äî scoped (HEYS.store) –ò unscoped (localStorage)
      const readInsightsTourCompleted = () => {
        try {
          const scopedValue = HEYS.store?.get?.('heys_insights_tour_completed');
          if (scopedValue === true || scopedValue === 'true') return true;
          if (scopedValue === false || scopedValue === 'false') return false;
          return localStorage.getItem('heys_insights_tour_completed') === 'true';
        } catch { return true; }
      };

      const [insightsTourCompleted, setInsightsTourCompleted] = useState(() => readInsightsTourCompleted());

      // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è localStorage –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞
      useEffect(() => {
        const handleStorageChange = () => {
          try {
            // üîß v1.13: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            const scopedValue = HEYS.store?.get?.('heys_insights_tour_completed');
            const unscopedValue = localStorage.getItem('heys_insights_tour_completed') === 'true';
            const completed = scopedValue === true || scopedValue === 'true' || scopedValue === false || scopedValue === 'false'
              ? scopedValue === true || scopedValue === 'true'
              : unscopedValue;
            if (completed !== insightsTourCompleted) {
              devLog('[InsightsTab] Tour status changed:', completed, '(scoped:', scopedValue, ', unscoped:', unscopedValue, ')');
              setInsightsTourCompleted(completed);
            }
          } catch { /* –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º */ }
        };

        // –°–ª—É—à–∞–µ–º storage event (work inside same tab thanks to dispatch in InsightsTour)
        window.addEventListener('storage', handleStorageChange);

        return () => {
          window.removeEventListener('storage', handleStorageChange);
        };
      }, [insightsTourCompleted]);

      // üîß –ü–æ–ª—É—á–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã
      const effectiveData = useMemo(() => {
        const U = window.HEYS?.utils;
        const getter = lsGet || U?.lsGet || ((k, d) => {
          try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
        });

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
        const currentDayData = dayData || getter(`heys_dayv2_${selectedDate}`, {});

        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        const currentProfile = profile || getter('heys_profile', {});

        // üÜï –î–æ–±–∞–≤–ª—è–µ–º clientId –≤ –ø—Ä–æ—Ñ–∏–ª—å (–¥–ª—è –∫—ç—à–∞ adaptive thresholds)
        if (currentProfile && !currentProfile.id) {
          const clientId = window.HEYS?.cloud?.getPinAuthClient?.();
          if (clientId) {
            currentProfile.id = clientId;
          }
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        let currentPIndex = pIndex || window.HEYS?.products?.getIndex?.();

        // –ï—Å–ª–∏ getIndex –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å—Ç—Ä–æ–∏–º –∏–Ω–¥–µ–∫—Å –∏–∑ –º–∞—Å—Å–∏–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        if (!currentPIndex || !currentPIndex.byId) {
          const products = window.HEYS?.products?.getAll?.() || [];
          const buildIndex = window.HEYS?.dayUtils?.buildProductIndex
            || window.HEYS?.models?.buildProductIndex;
          if (buildIndex && products.length > 0) {
            currentPIndex = buildIndex(products);
          } else if (products.length > 0) {
            // Fallback: —Å—Ç—Ä–æ–∏–º –ø—Ä–æ—Å—Ç–æ–π –∏–Ω–¥–µ–∫—Å –≤—Ä—É—á–Ω—É—é
            const byId = new Map();
            const byName = new Map();
            for (const p of products) {
              if (p.id) byId.set(String(p.id).toLowerCase(), p);
              if (p.name) byName.set(p.name.toLowerCase(), p);
            }
            currentPIndex = { byId, byName };
          }
        }

        // –í—ã—á–∏—Å–ª—è–µ–º dayTot –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
        let currentDayTot = dayTot;
        if (!currentDayTot && currentDayData.meals?.length > 0 && window.HEYS?.Day?.computeDayTot) {
          currentDayTot = window.HEYS.Day.computeDayTot(currentDayData, currentPIndex);
        }

        // –í—ã—á–∏—Å–ª—è–µ–º normAbs –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
        let currentNormAbs = normAbs;
        if (!currentNormAbs && currentProfile && window.HEYS?.Day?.calcNormAbs) {
          currentNormAbs = window.HEYS.Day.calcNormAbs(currentProfile);
        }

        // –í—ã—á–∏—Å–ª—è–µ–º optimum –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
        const currentOptimum = optimum || currentNormAbs?.kcal || 2000;

        // –í—ã—á–∏—Å–ª—è–µ–º waterGoal –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
        const currentWaterGoal = waterGoal || (currentProfile.weight ? currentProfile.weight * 30 : 2000);

        return {
          dayData: currentDayData,
          profile: currentProfile,
          pIndex: currentPIndex,
          dayTot: currentDayTot,
          normAbs: currentNormAbs,
          optimum: currentOptimum,
          waterGoal: currentWaterGoal
        };
      }, [dayData, profile, pIndex, dayTot, normAbs, optimum, waterGoal, selectedDate, lsGet]);

      // –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
      const realInsights = useMemo(() => {
        // üîß v6.0.2: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π daysBack –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞–±–∞
        const daysBack = activeTab === 'today' ? 7 : 30;
        return HEYS.PredictiveInsights.analyze({
          lsGet: lsGet || (window.HEYS?.utils?.lsGet),
          daysBack,
          profile: effectiveData.profile,
          pIndex: effectiveData.pIndex,
          optimum: effectiveData.optimum
        });
      }, [lsGet, activeTab, selectedDate, effectiveData.profile, effectiveData.pIndex, effectiveData.optimum]);

      // üé≠ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Ç—É—Ä –Ω–µ –ø—Ä–æ–π–¥–µ–Ω –ò —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
      const showDemoMode = !insightsTourCompleted && !realInsights.available;
      const insights = showDemoMode ? DEMO_INSIGHTS : realInsights;

      // üÜï –†–∞—Å—á—ë—Ç —Å—Ç–∞—Ç—É—Å–∞ 0-100 (–∏–ª–∏ –¥–µ–º–æ)
      const status = useMemo(() => {
        if (showDemoMode) return DEMO_STATUS;
        if (!HEYS.Status?.calculateStatus) return null;
        return HEYS.Status.calculateStatus({
          dayData: effectiveData.dayData,
          profile: effectiveData.profile,
          dayTot: effectiveData.dayTot,
          normAbs: effectiveData.normAbs,
          waterGoal: effectiveData.waterGoal
        });
      }, [effectiveData, showDemoMode]);

      // üÜï EWS warnings –Ω–∞ —É—Ä–æ–≤–Ω–µ InsightsTab ‚Äî –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ priority badge
      useEffect(() => {
        let cancelled = false;

        const collectWarnings = () => {
          try {
            console.info(`${DYNAMIC_LOG_PREFIX} üöÄ start:`, { scope: 'InsightsTab', section: 'STATUS_SCORE' });

            const earlyWarning = HEYS.InsightsPI?.earlyWarning;
            const getter = lsGet || window.HEYS?.utils?.lsGet;
            const fmtDate = HEYS.dayUtils?.fmtDate || window.HEYS?.utils?.fmtDate;

            if (!earlyWarning || typeof earlyWarning.detect !== 'function' || !getter || !fmtDate) {
              if (!cancelled) setEwsWarnings([]);
              console.info(`${DYNAMIC_LOG_PREFIX} ‚ö†Ô∏è skipped:`, {
                reason: 'EWS module or storage utils unavailable',
                hasDetect: !!earlyWarning?.detect,
                hasGetter: !!getter,
                hasFmtDate: !!fmtDate
              });
              return;
            }

            const days = [];
            for (let i = 0; i < 30; i++) {
              const d = new Date();
              d.setDate(d.getDate() - i);
              const dateStr = fmtDate(d);
              const dayData = getter(`heys_dayv2_${dateStr}`);
              if (dayData) days.push({ ...dayData, date: dateStr });
            }

            if (days.length < 7) {
              if (!cancelled) setEwsWarnings([]);
              console.info(`${DYNAMIC_LOG_PREFIX} ‚ö†Ô∏è skipped:`, {
                reason: 'insufficient days for EWS',
                days: days.length
              });
              return;
            }

            const currentInsights = HEYS.PredictiveInsights?.analyze?.({
              daysBack: 7,
              profile: effectiveData.profile,
              pIndex: effectiveData.pIndex,
              lsGet: getter
            });

            const result = earlyWarning.detect(days, effectiveData.profile, effectiveData.pIndex, {
              currentPatterns: currentInsights?.patterns
            });

            const warnings = result?.available && Array.isArray(result?.warnings)
              ? result.warnings
              : [];

            if (!cancelled) setEwsWarnings(warnings);

            console.info(`${DYNAMIC_LOG_PREFIX} üì• input:`, {
              score: insights?.healthScore?.total,
              warningsCount: warnings.length,
              highWarnings: warnings.filter(w => w.severity === 'high').length
            });
          } catch (error) {
            if (!cancelled) setEwsWarnings([]);
            console.error(`${DYNAMIC_LOG_PREFIX} ‚ùå failed:`, { scope: 'InsightsTab', error: error?.message || error });
          }
        };

        collectWarnings();
        const interval = setInterval(collectWarnings, 5 * 60 * 1000);
        window.addEventListener('day-updated', collectWarnings);
        window.addEventListener('heys-sync-complete', collectWarnings);

        return () => {
          cancelled = true;
          clearInterval(interval);
          window.removeEventListener('day-updated', collectWarnings);
          window.removeEventListener('heys-sync-complete', collectWarnings);
        };
      }, [lsGet, effectiveData.profile, effectiveData.pIndex, insights?.healthScore?.total]);

      // 1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è STATUS_SCORE (–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å)
      const statusSectionPriority = useMemo(() => {
        const score = insights?.healthScore?.total;
        const trend = insights?.healthScore?.trend7d ?? insights?.healthScore?.trend ?? null;
        return computeDynamicPriority({
          sectionId: 'STATUS_SCORE',
          score,
          trend,
          warnings: ewsWarnings,
          patterns: insights?.patterns ?? [] // #12 pattern degradation boost
        });
      }, [computeDynamicPriority, insights?.healthScore?.total, insights?.healthScore?.trend7d, insights?.healthScore?.trend, ewsWarnings, insights?.patterns]);

      // 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è CRASH_RISK (–†–∏—Å–∫ —Å—Ä—ã–≤–∞)
      const crashRiskPriority = useMemo(() => {
        // –ü–æ–ª—É—á–∞–µ–º —Å—ã—Ä–æ–π % —Ä–∏—Å–∫–∞ –∏–∑ —Ç–µ—Ö –∂–µ –º–µ—Ç—Ä–∏–∫, —á—Ç–æ —Å—á–∏—Ç–∞–µ—Ç MetabolicQuickStatus
        // (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏, —Ç–∞–∫ –∫–∞–∫ —Å–∞–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∑–¥–µ—Å—å)
        // –ù–æ –ª—É—á—à–µ –ø–µ—Ä–µ–¥–∞—Ç—å warnings —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤!

        // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: —Å—á–∏—Ç–∞–µ–º –ø–æ warnings, —Ç–∞–∫ –∫–∞–∫ crashRiskScore –µ—â—ë –Ω–µ –ø—Ä–æ–∫–∏–Ω—É—Ç –≤ props
        // TODO: –ü—Ä–æ–∫–∏–Ω—É—Ç—å crashRiskScore –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—è

        return computeDynamicPriority({
          sectionId: 'CRASH_RISK',
          crashRiskScore: null, // –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å—Ä–∞–±–æ—Ç–∞–µ—Ç fallback –Ω–∞ warnings
          warnings: ewsWarnings
        });
      }, [computeDynamicPriority, ewsWarnings]);

      // 3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è PRIORITY_ACTIONS (–í–∞–∂–Ω—ã–µ —à–∞–≥–∏)
      const actionsPriority = useMemo(() => {
        // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ High/Critical warnings
        const urgentCount = ewsWarnings ? ewsWarnings.filter(w => w.severity === 'high').length : 0;
        const totalCount = ewsWarnings ? ewsWarnings.length : 0;

        return computeDynamicPriority({
          sectionId: 'PRIORITY_ACTIONS',
          urgentActionsCount: urgentCount,
          actionsCount: totalCount
        });
      }, [computeDynamicPriority, ewsWarnings]);


      useEffect(() => {
        const urgentCount = ewsWarnings ? ewsWarnings.filter(w => w.severity === 'high').length : 0;
        console.info(`${DYNAMIC_LOG_PREFIX} üñ•Ô∏è sections_priority:`, {
          STATUS_SCORE: `${statusSectionPriority}  ‚Üí "${PRIORITY_CONTEXT_LABELS?.STATUS_SCORE?.[statusSectionPriority] ?? ''}"`,
          CRASH_RISK: `${crashRiskPriority}  ‚Üí "${PRIORITY_CONTEXT_LABELS?.CRASH_RISK?.[crashRiskPriority] ?? ''}"`,
          PRIORITY_ACTIONS: `${actionsPriority}  ‚Üí "${PRIORITY_CONTEXT_LABELS?.PRIORITY_ACTIONS?.[actionsPriority] ?? ''}"`,
          filter: priorityFilter || 'ALL',
          ewsWarnings: ewsWarnings?.length ?? 0,
          urgentWarnings: urgentCount,
        });
      }, [statusSectionPriority, crashRiskPriority, actionsPriority, priorityFilter, ewsWarnings]);

      // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
      const allMetrics = useMemo(() => getAllMetricsByPriority(), []);

      // üéØ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º–∏–Ω–∏-—Ç—É—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏ Insights
      useEffect(() => {
        // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä —Å–µ–∫—Ü–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç—É—Ä–∞
        const timer = setTimeout(() => {
          if (HEYS.InsightsTour?.shouldShow?.() && HEYS.InsightsTour.start) {
            HEYS.InsightsTour.start();
          }
        }, 800);
        return () => clearTimeout(timer);
      }, []); // –¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

      // EmptyState –µ—Å–ª–∏ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö –ò —Ç—É—Ä —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω
      if (!insights.available && insightsTourCompleted) {
        return h(InsightsErrorBoundary, null,
          h('div', { className: 'insights-tab' },
            h('div', { className: 'insights-tab__hero' },
              h('div', { className: 'insights-tab__header' },
                h('h2', { className: 'insights-tab__title' }, 'üîÆ –£–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞')
              )
            ),
            h('div', { className: 'insights-tab__content' },
              h(EmptyState, {
                daysAnalyzed: realInsights.daysAnalyzed || realInsights.daysWithData || 0,
                minRequired: realInsights.minDaysRequired || 3
              })
            )
          )
        );
      }

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —Å–µ–∫—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      const shouldShowSection = (sectionPriority) => {
        if (!priorityFilter) return true;
        return sectionPriority === priorityFilter;
      };

      return h(InsightsErrorBoundary, null,
        h('div', { className: 'insights-tab' },
          // === HERO HEADER ===
          h('div', { className: 'insights-tab__hero' },
            h('div', { className: 'insights-tab__header' },
              h('h2', { className: 'insights-tab__title' }, 'üîÆ –£–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞'),
              h('div', { className: 'insights-tab__subtitle' },
                activeTab === 'today'
                  ? `–ê–Ω–∞–ª–∏–∑ –∑–∞ ${insights.daysAnalyzed || 7} –¥–Ω–µ–π`
                  : `–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞ ${insights.daysAnalyzed || 30} –¥–Ω–µ–π`
              )
            ),

            // Glass Tabs –≤–Ω—É—Ç—Ä–∏ hero
            h('div', { className: 'insights-tab__tabs' },
              h('button', {
                className: 'insights-tab__tab' + (activeTab === 'today' ? ' active' : ''),
                onClick: () => setActiveTab('today')
              }, 'üìÖ 7 –¥–Ω–µ–π'),
              h('button', {
                className: 'insights-tab__tab' + (activeTab === 'week' ? ' active' : ''),
                onClick: () => setActiveTab('week')
              }, 'üìä 30 –¥–Ω–µ–π')
            ),

            // üéØ Demo Mode Banner ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –¥–µ–º–æ —Ä–µ–∂–∏–º–µ
            showDemoMode && h('div', {
              className: 'insights-tab__demo-banner'
            },
              h('span', { className: 'insights-tab__demo-banner-icon' }, '‚ú®'),
              h('div', null,
                h('div', { className: 'insights-tab__demo-banner-title' },
                  '–î–µ–º–æ-—Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏—Ç–∏–∫–∏'
                ),
                h('div', { className: 'insights-tab__demo-banner-desc' },
                  '–≠—Ç–æ –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö. –ü–æ—Å–ª–µ 3 –¥–Ω–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –≤–∞—à–∞ —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'
                )
              )
            ),

            // Priority Filter (compact)
            h('div', { className: 'insights-tab__filters' },
              h('button', {
                className: `insights-tab__filter-btn ${!priorityFilter ? 'active' : ''}`,
                onClick: () => setPriorityFilter(null)
              }, 'üéØ –í—Å—ë'),
              h('button', {
                className: `insights-tab__filter-btn ${priorityFilter === 'CRITICAL' ? 'active' : ''}`,
                onClick: () => setPriorityFilter(priorityFilter === 'CRITICAL' ? null : 'CRITICAL'),
                style: { '--filter-color': PRIORITY_LEVELS.CRITICAL.color }
              }, 'üî¥ –í–∞–∂–Ω–æ–µ'),
              h('button', {
                className: `insights-tab__filter-btn ${priorityFilter === 'HIGH' ? 'active' : ''}`,
                onClick: () => setPriorityFilter(priorityFilter === 'HIGH' ? null : 'HIGH'),
                style: { '--filter-color': PRIORITY_LEVELS.HIGH.color }
              }, 'üü† –ü–æ–ª–µ–∑–Ω–æ–µ')
            )
          ),

          // === MAIN CONTENT (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É) ===
          h('div', { className: 'insights-tab__content' },

            // L0: Status 0-100 Card (dynamic priority)
            shouldShowSection(statusSectionPriority) && h('div', {
              className: `insights-tab__section insights-tab__section--${statusSectionPriority.toLowerCase()}`,
              id: 'tour-insights-status' // üéØ Mini-tour target
            },
              h('div', { className: 'insights-tab__section-badge' },
                h(PriorityBadge, {
                  priority: statusSectionPriority,
                  showLabel: true,
                  contextLabels: PRIORITY_CONTEXT_LABELS.STATUS_SCORE
                })
              ),

            // üÜï StatusCard –≤–º–µ—Å—Ç–æ TotalHealthRing + HealthRingsGrid
            /* status && HEYS.Status?.StatusCard
              ? h(HEYS.Status.StatusCard, { status })
              : */ h('div', { className: 'insights-tab__score-card' },
                h('div', { className: 'insights-tab__score' },
                  h(TotalHealthRing, {
                    score: insights.healthScore.total,
                    size: 140,
                    strokeWidth: 12,
                    debugData: insights.healthScore.debug || {
                      mode: insights.healthScore.mode,
                      weights: insights.healthScore.weights,
                      breakdown: insights.healthScore.breakdown
                    },
                    onClick: () => {
                      // üÜï v3.5.0: Early Warning System Check –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ Health Score
                      console.group('üö® [HEYS Early Warning System] HEALTH SCORE CLICK');
                      try {
                        const earlyWarning = HEYS.InsightsPI?.earlyWarning;
                        if (earlyWarning && typeof earlyWarning.detect === 'function') {
                          const U = window.HEYS?.dayUtils || window.HEYS?.utils;
                          if (!U || !U.fmtDate || !U.lsGet) {
                            console.error('‚ùå HEYS.dayUtils not available for Early Warning');
                            console.groupEnd();
                            return;
                          }

                          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º
                          const dateOffsetStr = (offset) => {
                            const d = new Date();
                            d.setDate(d.getDate() + offset);
                            return U.fmtDate(d);
                          };

                          // –°–æ–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π lsGet (—É—á–∏—Ç—ã–≤–∞–µ—Ç namespace)
                          const daysBack = 30;
                          const days = [];
                          for (let i = 0; i < daysBack; i++) {
                            const date = dateOffsetStr(-i);
                            const dayKey = `heys_dayv2_${date}`;
                            const dayData = U.lsGet(dayKey);
                            if (dayData) days.push({ ...dayData, date });
                          }

                          // –ò—Å–ø–æ–ª—å–∑—É–µ–º effectiveData –¥–ª—è profile –∏ pIndex (–∫–∞–∫ –≤ –æ—Å—Ç–∞–ª—å–Ω–æ–º –∫–æ–¥–µ)
                          const profile = effectiveData.profile;
                          const pIndex = effectiveData.pIndex;

                          console.log('üîç Running Early Warning detection:', {
                            daysAvailable: days.length,
                            datesRange: days.length > 0 ? `${days[days.length - 1].date} ‚Üí ${days[0].date}` : 'none',
                            hasProfile: !!profile,
                            profileId: profile?.id,
                            hasPIndex: !!pIndex,
                            pIndexSize: pIndex?.byId?.size || 0
                          });

                          // Get current patterns for warning detection
                          let currentPatterns = null;
                          let previousPatterns = null;

                          if (days.length >= 7 && HEYS.PredictiveInsights?.analyze) {
                            try {
                              // Get insights for last 7 days (current period)
                              const currentInsights = HEYS.PredictiveInsights.analyze({
                                daysBack: 7,
                                profile,
                                pIndex,
                                lsGet: U.lsGet
                              });
                              currentPatterns = currentInsights?.patterns || null;

                              // For health score decline detection, we'd need patterns from 2 different periods
                              // For now, focus on current low pattern scores (more actionable)
                              // TODO: Implement time-based pattern comparison when we have historical pattern data

                              console.log('ews / dashboard üìä pattern data collected:', {
                                currentPatternsCount: currentPatterns ? currentPatterns.length : 0,
                                period: '7 days',
                                hasHealthScore: !!currentInsights?.healthScore
                              });
                            } catch (e) {
                              console.warn('ews / dashboard ‚ö†Ô∏è failed to get pattern data:', e.message);
                            }
                          }

                          const result = earlyWarning.detect(days, profile, pIndex, {
                            currentPatterns,
                            previousPatterns
                          });

                          console.log('‚úÖ Early Warning result:', {
                            available: result.available,
                            warningCount: result.warnings?.length || 0,
                            highSeverity: result.warnings?.filter(w => w.severity === 'high').length || 0,
                            mediumSeverity: result.warnings?.filter(w => w.severity === 'medium').length || 0,
                            lowSeverity: result.warnings?.filter(w => w.severity === 'low').length || 0,
                            warnings: result.warnings
                          });

                          if (result.warnings && result.warnings.length > 0) {
                            console.log('‚ö†Ô∏è Detected warnings:');
                            result.warnings.forEach((w, i) => {
                              console.log(`  ${i + 1}. [${w.severity.toUpperCase()}] ${w.message}`);
                              console.log(`     ${w.detail}`);
                              if (w.action) console.log(`     ‚Üí Action: ${w.action}`);
                            });
                          } else {
                            console.log('‚úÖ No warnings detected - all metrics healthy!');
                          }
                        } else {
                          console.warn('‚ö†Ô∏è Early Warning module not loaded or not available');
                        }
                      } catch (err) {
                        console.error('‚ùå Early Warning detection error:', err);
                      }
                      console.groupEnd();

                      // üî¨ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª–∞
                      console.group('ü©∫ [HEYS Adaptive Thresholds] AUTO DIAGNOSTIC');

                      try {
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ HEYS.dayUtils
                        const U = HEYS.dayUtils || window.HEYS?.dayUtils;
                        if (!U || !U.fmtDate || !U.lsGet) {
                          console.error('‚ùå HEYS.dayUtils or required methods not available:', {
                            hasU: !!U,
                            hasFmtDate: !!U?.fmtDate,
                            hasLsGet: !!U?.lsGet
                          });
                          console.groupEnd();
                          setShowPatternDebug(true);
                          return;
                        }

                        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º
                        const dateOffsetStr = (offset) => {
                          const d = new Date();
                          d.setDate(d.getDate() + offset);
                          return U.fmtDate(d);
                        };

                        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π
                        const daysBack = 7;
                        const days = [];
                        for (let i = 0; i < daysBack; i++) {
                          const date = dateOffsetStr(-i);
                          const dayKey = `heys_dayv2_${date}`;
                          const dayData = U.lsGet(dayKey);
                          if (dayData) days.push({ ...dayData, date });
                        }
                        console.log('üìÖ Days collected:', {
                          requested: daysBack,
                          found: days.length,
                          dates: days.map(d => d.date),
                          firstDay: days[0]
                        });

                        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ profile (–∏—Å–ø–æ–ª—å–∑—É–µ–º effectiveData, –∞ –Ω–µ HEYS.c)
                        const profile = effectiveData.profile;
                        const clientId = HEYS.cloud?.getPinAuthClient?.();
                        console.log('üë§ Profile:', {
                          exists: !!profile,
                          id: profile?.id,
                          clientId: clientId,
                          weight: profile?.weight,
                          goal: profile?.goal,
                          allKeys: profile ? Object.keys(profile) : []
                        });

                        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ pIndex (–∏—Å–ø–æ–ª—å–∑—É–µ–º effectiveData)
                        const pIndex = effectiveData.pIndex;
                        console.log('üóÇÔ∏è Product Index:', {
                          exists: !!pIndex,
                          byIdSize: pIndex?.byId?.size || 0,
                          byNameSize: pIndex?.byName?.size || 0,
                          sampleIds: pIndex?.byId ? Array.from(pIndex.byId.keys()).slice(0, 3) : []
                        });

                        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª—è thresholds
                        const hasThresholdsModule = typeof HEYS.InsightsPI?.thresholds?.get === 'function';
                        console.log('üß© Thresholds Module:', {
                          loaded: hasThresholdsModule,
                          methods: HEYS.InsightsPI?.thresholds ? Object.keys(HEYS.InsightsPI.thresholds) : []
                        });

                        // 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ get (cascade strategy)
                        if (hasThresholdsModule) {
                          console.log('üî¨ Calling thresholds.get() with cascade strategy...');
                          const result = HEYS.InsightsPI.thresholds.get(days, profile, pIndex);
                          console.log('‚úÖ Thresholds result:', {
                            confidence: result.confidence,
                            daysUsed: result.daysUsed,
                            requestedDays: days.length,
                            thresholdsCount: Object.keys(result.thresholds || {}).length,
                            thresholds: result.thresholds,
                            meta: result.meta,
                            tier: result.meta?.partial ? 'PARTIAL (7-13d)' :
                              result.meta?.default ? 'DEFAULT (<7d)' :
                                result.confidence >= 1.0 ? 'FULL (14+d)' : 'UNKNOWN',
                            fromCache: result.meta?.dateRange ? '‚ôªÔ∏è (possibly from cache)' : '‚ú® (freshly computed)'
                          });
                        } else {
                          console.warn('‚ö†Ô∏è Thresholds module not loaded');
                        }

                        // 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Pattern Debugger –ø–æ–ª—É—á–∏—Ç
                        console.log('ü™ü Pattern Debugger will receive:', {
                          profile: !!profile,
                          profileId: profile?.id,
                          clientId: clientId,
                          lsGet: typeof U?.lsGet,
                          pIndex: !!pIndex,
                          dayUtils: !!HEYS.dayUtils,
                          fmtDate: typeof HEYS.dayUtils?.fmtDate
                        });

                      } catch (err) {
                        console.error('‚ùå Diagnostic error:', err);
                      }

                      console.groupEnd();

                      // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª
                      setShowPatternDebug(true);
                    } // üîç –û—Ç–∫—Ä—ã—Ç—å Pattern Transparency Modal —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
                  })
                ),
                h('div', { className: 'insights-tab__rings' },
                  h(HealthRingsGrid, {
                    healthScore: insights.healthScore,
                    onCategoryClick: setSelectedCategory,
                    compact: true
                  })
                )
              ),

              // Early Warning Card (–ø–æ–¥ —Å–∫–æ—Ä–æ–º –∏ –∫–æ–ª—å—Ü–∞–º–∏)
              h(EarlyWarningCard, { lsGet, profile, pIndex }),

              // Phenotype Classifier Card
              HEYS.InsightsPI?.PhenotypeClassifierCard && h(HEYS.InsightsPI.PhenotypeClassifierCard, {
                onClick: () => setShowPhenotypeClassifier(true)
              }),

              // What-If Scenarios Card
              HEYS.InsightsPI?.WhatIfScenariosCard && h(HEYS.InsightsPI.WhatIfScenariosCard, {
                onClick: () => setShowWhatIfScenarios(true)
              })
            ),

            // Metabolic Status + Risk (CRITICAL) ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏
            shouldShowSection('CRITICAL') && h('div', {
              className: 'insights-tab__section insights-tab__section--critical insights-tab__section--no-header',
              id: 'tour-insights-metabolic' // üéØ Mini-tour target
            },
              h(MetabolicQuickStatus, {
                lsGet,
                profile,
                pIndex,
                selectedDate
              })
            ),

            // Divider –º–µ–∂–¥—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏ –≤–∞–∂–Ω—ã–º–∏
            shouldShowSection('CRITICAL') && h('div', { className: 'insights-tab__divider insights-tab__divider--priority' },
              h('span', null, '‚Üì –í–∞–∂–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã ‚Üì')
            ),

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üü† –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ ‚Äî –í–∞–∂–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            // Predictive Dashboard (HIGH) ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏
            shouldShowSection('HIGH') && h('div', {
              className: 'insights-tab__section insights-tab__section--high insights-tab__section--no-header',
              id: 'tour-insights-prediction' // üéØ Mini-tour target
            },
              h(PredictiveDashboard, {
                lsGet,
                profile,
                selectedDate
              })
            ),

            // Phenotype Card (HIGH) ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è expandable –∫–∞—Ä—Ç–æ—á–∫–∞
            // –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder –µ—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            shouldShowSection('HIGH') && h('div', {
              className: 'insights-tab__section insights-tab__section--high insights-tab__section--no-header',
              id: 'tour-insights-phenotype' // üéØ Mini-tour target
            },
              HEYS.Phenotype?.PhenotypeExpandableCard
                ? h(HEYS.Phenotype.PhenotypeExpandableCard, { profile })
                : showDemoMode && h('div', {
                  className: 'insights-card insights-tab__phenotype-placeholder'
                },
                  h('div', { className: 'insights-tab__phenotype-placeholder-header' },
                    h('span', { className: 'insights-tab__phenotype-placeholder-icon' }, 'üß¨'),
                    h('span', { className: 'insights-tab__phenotype-placeholder-title' }, '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø')
                  ),
                  h('div', { className: 'insights-tab__phenotype-placeholder-text' },
                    '–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ 7+ –¥–Ω–µ–π —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ç–∏–ø –∏ –¥–∞—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.'
                  )
                )
            ),

            // Advanced Analytics (HIGH) ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏
            shouldShowSection('HIGH') && h('div', {
              className: 'insights-tab__section insights-tab__section--high insights-tab__section--no-header',
              id: 'tour-insights-analytics' // üéØ Mini-tour target
            },
              h(AdvancedAnalyticsCard, {
                lsGet,
                profile,
                pIndex,
                selectedDate
              })
            ),

            // Metabolism Section (HIGH) ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏
            shouldShowSection('HIGH') && h('div', {
              className: 'insights-tab__section insights-tab__section--high insights-tab__section--no-header',
              id: 'tour-insights-metabolism' // üéØ Mini-tour target
            },
              h(MetabolismSection, {
                lsGet,
                profile,
                pIndex,
                selectedDate
              })
            ),

            // Meal Timing (HIGH) ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏
            shouldShowSection('HIGH') && h('div', {
              className: 'insights-tab__section insights-tab__section--high insights-tab__section--no-header',
              id: 'tour-insights-timing' // üéØ Mini-tour target
            },
              h(MealTimingCard, {
                lsGet,
                profile,
                pIndex,
                selectedDate
              })
            ),

            // Divider –º–µ–∂–¥—É –≤–∞–∂–Ω—ã–º–∏ –∏ —Å—Ä–µ–¥–Ω–∏–º–∏
            (shouldShowSection('HIGH') || shouldShowSection('CRITICAL')) && shouldShowSection('MEDIUM') &&
            h('div', { className: 'insights-tab__divider insights-tab__divider--priority' },
              h('span', null, '‚Üì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Üì')
            ),

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üü° –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ ‚Äî –ü–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            // What-If (MEDIUM)
            shouldShowSection('MEDIUM') && h(CollapsibleSection, {
              title: '–ß—Ç–æ –µ—Å–ª–∏...',
              icon: 'üéØ',
              badge: insights.whatIf?.length > 0 ? `${insights.whatIf.length} —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤` : null,
              defaultOpen: true,
              infoKey: 'WHATIF',
              priority: 'MEDIUM'
            },
              h(WhatIfSection, { scenarios: insights.whatIf })
            ),

            // Patterns (MEDIUM)
            shouldShowSection('MEDIUM') && insights.patterns?.length > 0 && h(CollapsibleSection, {
              title: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã',
              icon: 'üîç',
              badge: `${insights.patterns.filter(p => p.available).length} –Ω–∞–π–¥–µ–Ω–æ`,
              defaultOpen: false,
              infoKey: 'PATTERNS',
              priority: 'MEDIUM'
            },
              h(PatternsList, { patterns: insights.patterns })
            ),

            // Weight Prediction (MEDIUM)
            shouldShowSection('MEDIUM') && insights.weightPrediction && h(CollapsibleSection, {
              title: '–ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞',
              icon: '‚öñÔ∏è',
              badge: insights.weightPrediction.weeklyChange ?
                `${insights.weightPrediction.weeklyChange > 0 ? '+' : ''}${insights.weightPrediction.weeklyChange.toFixed(1)} –∫–≥/–Ω–µ–¥` : null,
              defaultOpen: false,
              infoKey: 'WEIGHT_PREDICTION',
              priority: 'MEDIUM'
            },
              h(WeightPrediction, { prediction: insights.weightPrediction })
            ),

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üü¢ –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ ‚Äî –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            // Weekly Report Card (LOW ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ù–µ–¥–µ–ª—è")
            shouldShowSection('LOW') && activeTab === 'week' && HEYS.weeklyReports?.WeeklyReportCard && h('div', {
              className: 'insights-tab__section insights-tab__section--low'
            },
              h(HEYS.weeklyReports.WeeklyReportCard, {
                lsGet,
                profile,
                pIndex,
                anchorDate: selectedDate
              })
            ),

            // Weekly Wrap (LOW ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ù–µ–¥–µ–ª—è")
            shouldShowSection('LOW') && activeTab === 'week' && insights.weeklyWrap && h(CollapsibleSection, {
              title: '–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏',
              icon: 'üìã',
              defaultOpen: true,
              infoKey: 'WEEKLY_WRAP',
              priority: 'LOW'
            },
              h(WeeklyWrap, { wrap: insights.weeklyWrap })
            ),

            // Data Completeness (LOW)
            shouldShowSection('LOW') && h('div', { className: 'insights-tab__section insights-tab__section--low' },
              h(SectionHeader, {
                title: '–ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö',
                icon: 'üìä',
                priority: 'LOW',
                infoKey: 'DATA_COMPLETENESS'
              }),
              h(DataCompletenessCard, { lsGet, profile })
            ),

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üîµ FOOTER ‚Äî –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            // Footer: Confidence
            h('div', { className: 'insights-tab__confidence' },
              h('span', { className: 'insights-tab__confidence-icon' }, 'üìä'),
              h('span', { className: 'insights-tab__confidence-text' },
                `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${insights.confidence || 50}% (${insights.daysWithData || 0} –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö)`
              ),
              h(getInfoButton(), {
                infoKey: 'CONFIDENCE',
                debugData: {
                  confidence: insights.confidence,
                  daysWithData: insights.daysWithData,
                  daysAnalyzed: insights.daysAnalyzed
                }
              })
            )

          ) // –∑–∞–∫—Ä—ã—Ç–∏–µ insights-tab__content
          ,

          // Pattern Debug Modal ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ Health Score
          showPatternDebug && window.PatternDebugModal && h(window.PatternDebugModal, {
            lsGet: lsGet || (window.HEYS?.utils?.lsGet),
            profile: effectiveData.profile,
            pIndex: effectiveData.pIndex,
            optimum: effectiveData.optimum,
            onClose: () => setShowPatternDebug(false)
          }),

          // What-If Scenarios Panel
          showWhatIfScenarios && HEYS.InsightsPI?.WhatIfScenariosPanel && h(HEYS.InsightsPI.WhatIfScenariosPanel, {
            lsGet: lsGet || (window.HEYS?.utils?.lsGet),
            profile: effectiveData.profile,
            pIndex: effectiveData.pIndex,
            onClose: () => setShowWhatIfScenarios(false)
          }),

          // Phenotype Classifier Panel
          showPhenotypeClassifier && HEYS.InsightsPI?.PhenotypeClassifierPanel && h(HEYS.InsightsPI.PhenotypeClassifierPanel, {
            profile: effectiveData.profile,
            pIndex: effectiveData.pIndex,
            onClose: () => setShowPhenotypeClassifier(false)
          })

        )
      );
    }

    // === INFO BUTTON ‚Äî –ö–Ω–æ–ø–∫–∞ ? —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º—É–ª—ã ===

    /**
     * InfoButton ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –∫–Ω–æ–ø–∫–∞ (?) —Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–∏–∫–æ–π
     * @param {string} infoKey ‚Äî –∫–ª—é—á –∏–∑ SCIENCE_INFO
     * @param {Object} debugData ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
     * @param {string} size ‚Äî 'small' –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –∫–Ω–æ–ø–∫–∏ (–≤ –∫–æ–ª—å—Ü–∞—Ö)
     */
    function InfoButton({ infoKey, debugData, size }) {
      const [isOpen, setIsOpen] = useState(false);
      const [isDetailsOpen, setIsDetailsOpen] = useState(true);
      const [isFormulaOpen, setIsFormulaOpen] = useState(true);
      const [isSourcesOpen, setIsSourcesOpen] = useState(true);

      const info = SCIENCE_INFO[infoKey];
      if (!info) return null;

      const handleButtonClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (navigator.vibrate) navigator.vibrate(10);
        setIsOpen(true);
      };

      const handleOverlayClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsOpen(false);
      };

      const handleModalClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
      };

      const handleCloseClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsOpen(false);
      };

      const categoryFallbackSources = {
        METABOLISM: [
          { label: 'Hall et al., 2012 ‚Äî Energy balance and body weight dynamics', pmid: '22522362' }
        ],
        NUTRITION: [
          { label: 'WHO Healthy Diet guidance', url: 'https://www.who.int/news-room/fact-sheets/detail/healthy-diet' }
        ],
        TIMING: [
          { label: 'Sutton et al., 2018 ‚Äî Early Time-Restricted Feeding', pmid: '29754952' }
        ],
        RECOVERY: [
          { label: 'Walker, 2017 ‚Äî Why We Sleep (overview)', url: 'https://www.sleepdiplomat.com/' }
        ],
        RISK: [
          { label: 'Marlatt & Gordon ‚Äî Relapse prevention framework', url: 'https://psycnet.apa.org/record/1986-97729-000' }
        ],
        PREDICTION: [
          { label: 'Hyndman & Athanasopoulos ‚Äî Forecasting principles', url: 'https://otexts.com/fpp3/' }
        ],
        PATTERNS: [
          { label: 'Zeevi et al., 2015 ‚Äî Personalized nutrition by glycemic response', pmid: '26590418' }
        ],
        COMPOSITE: [
          { label: 'NASEM framework ‚Äî integrated health behavior indicators', url: 'https://nap.nationalacademies.org/' }
        ],
        STATISTICS: [
          { label: 'Pearson correlation basics (NIST)', url: 'https://www.itl.nist.gov/div898/handbook/' }
        ]
      };

      const rawSources = Array.isArray(info.sources)
        ? info.sources
        : (info.source ? [{ label: info.source, pmid: info.pmid, url: info.url }] : []);

      const sources = rawSources.length > 0
        ? rawSources
        : (categoryFallbackSources[info.category] || categoryFallbackSources.STATISTICS || []);

      const simplifyText = (text) => {
        if (!text || typeof text !== 'string') return '';
        return text
          .replace(/\s+/g, ' ')
          .replace(/[;]+/g, ', ')
          .replace(/–∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç[—å–∏]/gi, '—Å–Ω–∏–∂–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫ –∏–Ω—Å—É–ª–∏–Ω—É')
          .replace(/–∫–∞—Ä–¥–∏–æ–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫[–∞-—è]+/gi, '—Å–µ—Ä–¥–µ—á–Ω–æ-–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö')
          .replace(/—É–ª—å—Ç—Ä–∞[-\s]?–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω[–∞-—è]+/gi, '—Å–∏–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ')
          .replace(/–ª–∏–ø–æ–ª–∏–∑/gi, '—Å–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞')
          .replace(/–ø—Ä–æ–∫—Å–∏/gi, '–∫–æ—Å–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞')
          .replace(/HbA1c/gi, '–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Å–∞—Ö–∞—Ä –∫—Ä–æ–≤–∏ (HbA1c)')
          .replace(/LDL/gi, '¬´–ø–ª–æ—Ö–æ–π¬ª —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω (LDL)')
          .replace(/HDL/gi, '¬´—Ö–æ—Ä–æ—à–∏–π¬ª —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω (HDL)')
          .replace(/TEF/gi, '—Ç–µ—Ä–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç –ø–∏—â–∏ (TEF)')
          .replace(/\s+,/g, ',')
          .replace(/\s+\./g, '.')
          .trim();
      };

      const splitSentences = (text) => simplifyText(text)
        .split(/(?<=[.!?])\s+/)
        .map(s => s.trim())
        .filter(Boolean);

      const simplifyDetailedText = (text) => {
        if (!text || typeof text !== 'string') return '';
        return text
          .split(/\n+/)
          .map((line) => simplifyText(line))
          .filter(Boolean)
          .join('\n\n');
      };

      const capSentence = (sentence, maxLen = 170) => {
        if (!sentence) return '';
        if (sentence.length <= maxLen) return sentence;
        const sliced = sentence.slice(0, maxLen);
        const cutAt = Math.max(sliced.lastIndexOf('. '), sliced.lastIndexOf(', '), sliced.lastIndexOf(' '));
        const base = cutAt > 60 ? sliced.slice(0, cutAt) : sliced;
        return `${base.trim()}‚Ä¶`;
      };

      const buildShortSummary = (meta) => {
        if (meta.short && typeof meta.short === 'string' && meta.short.trim()) {
          return capSentence(simplifyText(meta.short.trim()), 190);
        }

        const candidatePool = [meta.whyImportant, meta.interpretation, meta.formula]
          .flatMap(splitSentences)
          .filter(s => !/[=/*^]|>=|<=|\+\d+%|\b[A-Z]{3,}\b/.test(s))
          .map(s => capSentence(s))
          .filter(s => s.length >= 28);

        const unique = [];
        const seen = new Set();
        for (const sentence of candidatePool) {
          const key = sentence.toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          unique.push(sentence);
          if (unique.length >= 2) break;
        }

        if (unique.length > 0) {
          const summary = unique.join(' ').trim();
          return /[.!?]$/.test(summary) ? summary : `${summary}.`;
        }

        const fallbackName = simplifyText(meta.name || '–≠—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å');
        return `${fallbackName} –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —É–ª—É—á—à–∏—Ç—å –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–∫–∞—Ö.`;
      };

      const shortText = buildShortSummary(info);

      const buildDetailsFallback = (meta) => {
        const interpretation = simplifyText(meta.interpretation || '');
        const whyImportant = simplifyText(meta.whyImportant || '');
        const formulaLead = meta.formula ? '–ú–µ—Ç—Ä–∏–∫–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ –Ω–∏–∂–µ –∏ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å–æ–≤–æ–∫—É–ø–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤.' : '';
        const actionLead = meta.actionability
          ? `–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç: ${meta.actionability.toLowerCase()}. –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –æ–¥–Ω–æ–º-–¥–≤—É—Ö –≥–ª–∞–≤–Ω—ã—Ö —Ä—ã—á–∞–≥–∞—Ö, –∞ –Ω–µ –Ω–∞ –≤—Å—ë–º —Å—Ä–∞–∑—É.`
          : '';

        const paragraphOne = [
          shortText,
          whyImportant && whyImportant !== shortText ? whyImportant : ''
        ].filter(Boolean).join(' ');

        const paragraphTwo = [
          interpretation,
          formulaLead,
          actionLead
        ].filter(Boolean).join(' ');

        return [paragraphOne, paragraphTwo].filter(Boolean).join('\n\n');
      };

      const detailsText = simplifyDetailedText(
        info.details || info.interpretation || info.whyImportant || buildDetailsFallback(info)
      );

      // –†–µ–Ω–¥–µ—Ä–∏–º –º–æ–¥–∞–ª–∫—É —á–µ—Ä–µ–∑ Portal –≤ body
      const modal = isOpen && ReactDOM.createPortal(
        h('div', {
          className: 'info-modal-overlay',
          onClick: handleOverlayClick,
          onTouchEnd: handleOverlayClick
        },
          h('div', {
            className: 'info-modal',
            onClick: handleModalClick,
            onTouchEnd: handleModalClick
          },
            // Header
            h('div', { className: 'info-modal__header' },
              h('span', { className: 'info-modal__title' }, info.name),
              h('button', {
                className: 'info-modal__close',
                onClick: handleCloseClick,
                onTouchEnd: handleCloseClick,
                type: 'button'
              }, '√ó')
            ),

            // Short version
            shortText && h('div', { className: 'info-modal__section' },
              h('div', { className: 'info-modal__label' }, 'üß† –ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É'),
              h('div', { className: 'info-modal__text' }, shortText)
            ),

            // Detailed version (accordion)
            detailsText && detailsText !== shortText && h('div', { className: 'info-modal__section' },
              h('button', {
                className: `info-modal__accordion-trigger ${isDetailsOpen ? 'is-open' : ''}`,
                type: 'button',
                onClick: (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setIsDetailsOpen(prev => !prev);
                }
              },
                h('span', { className: 'info-modal__accordion-title' }, 'üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –∏ –Ω–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ'),
                h('span', { className: 'info-modal__accordion-chevron' }, isDetailsOpen ? '‚ñæ' : '‚ñ∏')
              ),
              isDetailsOpen && h('div', { className: 'info-modal__accordion-content' },
                h('div', { className: 'info-modal__text', style: { whiteSpace: 'pre-line' } }, detailsText)
              )
            ),

            // Formula (accordion)
            info.formula && h('div', { className: 'info-modal__section' },
              h('button', {
                className: `info-modal__accordion-trigger ${isFormulaOpen ? 'is-open' : ''}`,
                type: 'button',
                onClick: (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setIsFormulaOpen(prev => !prev);
                }
              },
                h('span', { className: 'info-modal__accordion-title' }, 'üìê –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞'),
                h('span', { className: 'info-modal__accordion-chevron' }, isFormulaOpen ? '‚ñæ' : '‚ñ∏')
              ),
              isFormulaOpen && h('div', { className: 'info-modal__accordion-content' },
                h('pre', { className: 'info-modal__formula' }, info.formula)
              )
            ),

            // Sources (accordion)
            sources.length > 0 && h('div', { className: 'info-modal__section' },
              h('button', {
                className: `info-modal__accordion-trigger ${isSourcesOpen ? 'is-open' : ''}`,
                type: 'button',
                onClick: (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setIsSourcesOpen(prev => !prev);
                }
              },
                h('span', { className: 'info-modal__accordion-title' }, 'üìö –ù–∞—É—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏'),
                h('span', { className: 'info-modal__accordion-chevron' }, isSourcesOpen ? '‚ñæ' : '‚ñ∏')
              ),
              isSourcesOpen && h('div', { className: 'info-modal__accordion-content' },
                h('div', { className: 'info-modal__sources-list' },
                  sources.map((source, index) => {
                    const link = source.url || (source.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${source.pmid}/` : null);
                    const label = source.label || source.source || '';
                    return h('div', { key: `${label}_${index}`, className: 'info-modal__source-card' },
                      h('div', { className: 'info-modal__source-index' }, `${index + 1}`),
                      h('div', { className: 'info-modal__source-main' },
                        link
                          ? h('a', {
                            href: link,
                            target: '_blank',
                            rel: 'noopener noreferrer',
                            className: 'info-modal__link',
                            onClick: (e) => e.stopPropagation()
                          }, label)
                          : h('span', { className: 'info-modal__source-text' }, label),
                        source.pmid && h('span', { className: 'info-modal__source-pmid' }, `PMID: ${source.pmid}`)
                      )
                    );
                  })
                )
              )
            ),

            // Debug data (for testing)
            debugData && h('div', { className: 'info-modal__section info-modal__section--debug' },
              h('div', { className: 'info-modal__label' }, 'üîß Debug'),
              h('pre', { className: 'info-modal__debug' },
                JSON.stringify(debugData, null, 2)
              )
            )
          )
        ),
        document.body
      );

      return h('span', { className: 'info-button-wrapper' },
        // –ö–Ω–æ–ø–∫–∞ (?)
        h('button', {
          className: `info-button ${size === 'small' ? 'info-button--small' : ''}`,
          onClick: handleButtonClick,
          onTouchEnd: handleButtonClick,
          type: 'button',
          title: '–ö–∞–∫ —ç—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è?'
        }, '?'),
        modal
      );
    }

    /**
     * –ú–µ—Ç—Ä–∏–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π info ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
     * NOTE: This is a h()-factory (not a React component), so NO HOOKS allowed!
     */
    function MetricWithInfo({ label, value, unit, infoKey, debugData, color, className }) {
      return h('div', { className: `metric-with-info ${className || ''}` },
        h('div', { className: 'metric-with-info__row' },
          h('span', { className: 'metric-with-info__label' }, label)
          // InfoButton removed ‚Äî has hooks, can't use in h()-factory
        ),
        h('div', { className: 'metric-with-info__value', style: color ? { color } : null },
          value,
          unit && h('span', { className: 'metric-with-info__unit' }, ` ${unit}`)
        )
      );
    }

    // === METABOLIC INTELLIGENCE UI COMPONENTS ===

    /**
     * StatusProgressRing ‚Äî SVG –∫–æ–ª—å—Ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ 0-100 —Å count-up –∞–Ω–∏–º–∞—Ü–∏–µ–π
     */
    function StatusProgressRing({ score, size = 120, strokeWidth = 10 }) {
      const [displayScore, setDisplayScore] = useState(0);
      const radius = (size - strokeWidth) / 2;
      const circumference = 2 * Math.PI * radius;
      const progress = (displayScore / 100) * circumference;
      const offset = circumference - progress;

      // Count-up –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ score
      useEffect(() => {
        const duration = 1500; // ms
        const start = displayScore;
        const diff = score - start;
        const startTime = performance.now();

        const animate = (currentTime) => {
          const elapsed = currentTime - startTime;
          const t = Math.min(elapsed / duration, 1);
          // Ease out cubic
          const eased = 1 - Math.pow(1 - t, 3);
          const current = Math.round(start + diff * eased);
          setDisplayScore(current);

          if (t < 1) {
            requestAnimationFrame(animate);
          }
        };

        requestAnimationFrame(animate);
      }, [score]);

      // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –ø–æ score (0-100)
      const getGradientColor = (s) => {
        if (s >= 85) return { start: '#10b981', end: '#22c55e' }; // emerald ‚Üí green
        if (s >= 70) return { start: '#22c55e', end: '#84cc16' }; // green ‚Üí lime
        if (s >= 50) return { start: '#eab308', end: '#f59e0b' }; // yellow ‚Üí amber
        if (s >= 30) return { start: '#f59e0b', end: '#ef4444' }; // amber ‚Üí red
        return { start: '#ef4444', end: '#dc2626' }; // red shades
      };

      const colors = getGradientColor(displayScore);
      const gradientId = 'statusGradient' + Math.random().toString(36).substr(2, 9);

      return h('svg', {
        width: size,
        height: size,
        className: 'status-progress-ring',
        viewBox: `0 0 ${size} ${size}`
      },
        // Gradient definition
        h('defs', null,
          h('linearGradient', { id: gradientId, x1: '0%', y1: '0%', x2: '100%', y2: '100%' },
            h('stop', { offset: '0%', stopColor: colors.start }),
            h('stop', { offset: '100%', stopColor: colors.end })
          )
        ),
        // Background circle
        h('circle', {
          cx: size / 2,
          cy: size / 2,
          r: radius,
          fill: 'none',
          stroke: 'var(--border-color, #e2e8f0)',
          strokeWidth: strokeWidth
        }),
        // Progress circle
        h('circle', {
          cx: size / 2,
          cy: size / 2,
          r: radius,
          fill: 'none',
          stroke: `url(#${gradientId})`,
          strokeWidth: strokeWidth,
          strokeLinecap: 'round',
          strokeDasharray: circumference,
          strokeDashoffset: offset,
          transform: `rotate(-90 ${size / 2} ${size / 2})`,
          style: { transition: 'stroke-dashoffset 0.1s ease' }
        }),
        // Score text
        h('text', {
          x: size / 2,
          y: size / 2,
          textAnchor: 'middle',
          dominantBaseline: 'middle',
          className: 'status-progress-ring__score',
          style: {
            fontSize: size * 0.28,
            fontWeight: 700,
            fill: 'var(--text-primary, #0f172a)'
          }
        }, displayScore),
        // Label
        h('text', {
          x: size / 2,
          y: size / 2 + size * 0.18,
          textAnchor: 'middle',
          className: 'status-progress-ring__label',
          style: {
            fontSize: size * 0.1,
            fill: 'var(--text-secondary, #64748b)'
          }
        }, '–∏–∑ 100')
      );
    }

    /**
     * StatusTrendBadge ‚Äî —Ç—Ä–µ–Ω–¥ ‚Üë/‚Üì –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—á–µ—Ä–∞
     */
    function StatusTrendBadge({ currentScore, prevScore }) {
      if (prevScore === null || prevScore === undefined) return null;

      const diff = currentScore - prevScore;
      if (diff === 0) return null;

      const isUp = diff > 0;
      const absDiff = Math.abs(diff);

      return h('div', {
        className: `status-trend-badge status-trend-badge--${isUp ? 'up' : 'down'}`
      },
        h('span', { className: 'status-trend-badge__arrow' }, isUp ? '‚Üë' : '‚Üì'),
        h('span', { className: 'status-trend-badge__value' }, absDiff),
        h('span', { className: 'status-trend-badge__label' }, 'vs –≤—á–µ—Ä–∞')
      );
    }

    /**
     * PillarBreakdownBars ‚Äî breakdown –ø–æ —Å—Ç–æ–ª–ø–∞–º (nutrition/timing/activity/recovery)
     */
    function PillarBreakdownBars({ pillars }) {
      if (!pillars || Object.keys(pillars).length === 0) return null;

      const pillarConfig = {
        nutrition: { label: '–ü–∏—Ç–∞–Ω–∏–µ', icon: 'üçΩÔ∏è', color: '#22c55e' },
        timing: { label: '–¢–∞–π–º–∏–Ω–≥', icon: '‚è∞', color: '#3b82f6' },
        activity: { label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', icon: 'üèÉ', color: '#f59e0b' },
        recovery: { label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', icon: 'üò¥', color: '#8b5cf6' }
      };

      return h('div', { className: 'pillar-breakdown-bars' },
        Object.entries(pillars).map(([key, value]) => {
          const config = pillarConfig[key] || { label: key, icon: 'üìä', color: '#64748b' };
          const pct = Math.min(100, Math.max(0, value));

          return h('div', { key, className: 'pillar-breakdown-bars__item' },
            h('div', { className: 'pillar-breakdown-bars__header' },
              h('span', { className: 'pillar-breakdown-bars__icon' }, config.icon),
              h('span', { className: 'pillar-breakdown-bars__label' }, config.label),
              h('span', { className: 'pillar-breakdown-bars__value' }, `${Math.round(pct)}%`)
            ),
            h('div', { className: 'pillar-breakdown-bars__track' },
              h('div', {
                className: 'pillar-breakdown-bars__fill',
                style: {
                  width: `${pct}%`,
                  backgroundColor: config.color
                }
              })
            )
          );
        })
      );
    }

    /**
     * ConfidenceBadge ‚Äî –±–µ–π–¥–∂ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (low/medium/high)
     */
    function ConfidenceBadge({ confidence, completeness }) {
      const config = {
        high: { label: '–í—ã—Å–æ–∫–∞—è', color: '#22c55e', icon: '‚úì' },
        medium: { label: '–°—Ä–µ–¥–Ω—è—è', color: '#eab308', icon: '~' },
        low: { label: '–ù–∏–∑–∫–∞—è', color: '#ef4444', icon: '?' }
      };

      const c = config[confidence] || config.low;
      const level = confidence === 'high' ? 'high' : (confidence === 'medium' ? 'medium' : 'low');

      return h('div', {
        className: `confidence-badge confidence-badge--${level}`
      },
        h('span', {
          className: 'confidence-badge__icon'
        }, c.icon),
        h('span', { className: 'confidence-badge__label' },
          `${c.label} —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å`
        ),
        completeness !== undefined && h('span', { className: 'confidence-badge__pct' },
          ` (${completeness}% –¥–∞–Ω–Ω—ã—Ö)`
        )
      );
    }

    /**
     * MetabolicQuickStatus ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ + —Ä–∏—Å–∫–∞
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: Score 0-100, —Ñ–∞–∑—É –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞, —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞
     */
    function MetabolicQuickStatus({ lsGet, profile, pIndex, selectedDate }) {
      // Fallback: –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –¥–∞–Ω–Ω—ã–º–∏
      const resolvedDate = useMemo(() => {
        return getMetabolismDate(lsGet || window.HEYS?.utils?.lsGet, selectedDate);
      }, [lsGet, selectedDate]);

      const status = useMemo(() => {
        if (!HEYS.Metabolic?.getStatus) return null;

        return HEYS.Metabolic.getStatus({
          dateStr: resolvedDate,
          pIndex: pIndex || null,
          profile: profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          forceRefresh: false
        });
      }, [lsGet, profile, pIndex, resolvedDate]);

      // üÜï v3.22.0: Extended Analytics (proteinDebt, emotionalRisk, trainingContext)
      const extendedAnalytics = useMemo(() => {
        const getter = lsGet || window.HEYS?.utils?.lsGet;
        if (!getter) return null;

        const dateStr = selectedDate || new Date().toISOString().split('T')[0];
        const prof = profile || getter('heys_profile', {});
        const day = getter('heys_dayv2_' + dateStr, {});

        // Protein Debt: –∞–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 –¥–Ω–µ–π
        let proteinDebt = { hasDebt: false, severity: 'none', avgProteinPct: 0 };
        try {
          const proteinDays = [];
          for (let i = 1; i <= 3; i++) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() - i);
            const dStr = d.toISOString().split('T')[0];
            const dData = getter('heys_dayv2_' + dStr, {});
            if (dData.meals?.length > 0) {
              const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
              const idx = pIndex || (buildIdx ? buildIdx(HEYS.products?.getAll?.() || []) : null);
              let prot = 0, kcal = 0;
              (dData.meals || []).forEach(m => {
                (m.items || []).forEach(item => {
                  const prod = idx?.byId?.get?.(item.product_id) || item;
                  const g = item.grams || 0;
                  prot += (prod.protein100 || 0) * g / 100;
                  kcal += (prod.kcal100 || 0) * g / 100;
                });
              });
              if (kcal > 500) proteinDays.push({ prot, kcal, protPct: prot * 3 / kcal });
            }
          }
          if (proteinDays.length >= 2) {
            const avgPct = proteinDays.reduce((s, d) => s + d.protPct, 0) / proteinDays.length;
            proteinDebt.avgProteinPct = Math.round(avgPct * 100);
            if (avgPct < 0.18) {
              proteinDebt = { hasDebt: true, severity: 'critical', avgProteinPct: Math.round(avgPct * 100), pmid: '20095013' };
            } else if (avgPct < 0.21) {
              proteinDebt = { hasDebt: true, severity: 'moderate', avgProteinPct: Math.round(avgPct * 100), pmid: '20095013' };
            }
          }
        } catch (e) {
          devWarn('[ExtendedAnalytics] proteinDebt error:', e);
          trackError(e, { scope: 'PI UI Dashboard', action: 'protein_debt' });
        }

        // Emotional Risk: —Å—Ç—Ä–µ—Å—Å + –Ω–µ–¥–æ–±–æ—Ä + –≤—Ä–µ–º—è
        let emotionalRisk = { level: 'low', bingeRisk: 0, factors: [] };
        try {
          const avgStress = (day.meals || []).reduce((s, m) => s + (m.stress || 0), 0) / Math.max(1, (day.meals || []).length);
          const currentHour = new Date().getHours();
          const isEvening = currentHour >= 18;

          if (avgStress >= 6) emotionalRisk.factors.push('–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å');
          if (isEvening) emotionalRisk.factors.push('–í–µ—á–µ—Ä (–ø–∏–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–∏)');

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–æ–±–æ—Ä –∑–∞ –≤—á–µ—Ä–∞
          const yesterday = new Date(dateStr);
          yesterday.setDate(yesterday.getDate() - 1);
          const yData = getter('heys_dayv2_' + yesterday.toISOString().split('T')[0], {});
          if (yData.meals?.length > 0) {
            const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
            const idx = pIndex || (buildIdx ? buildIdx(HEYS.products?.getAll?.() || []) : null);
            let yKcal = 0;
            (yData.meals || []).forEach(m => {
              (m.items || []).forEach(item => {
                const prod = idx?.byId?.get?.(item.product_id) || item;
                yKcal += (prod.kcal100 || 0) * (item.grams || 0) / 100;
              });
            });
            const normAbs = prof.normAbs?.kcal || 2000;
            if (yKcal < normAbs * 0.7) emotionalRisk.factors.push('–í—á–µ—Ä–∞—à–Ω–∏–π –Ω–µ–¥–æ–±–æ—Ä');
          }

          emotionalRisk.bingeRisk = Math.min(100, emotionalRisk.factors.length * 25);
          if (emotionalRisk.bingeRisk >= 75) emotionalRisk.level = 'critical';
          else if (emotionalRisk.bingeRisk >= 50) emotionalRisk.level = 'high';
          else if (emotionalRisk.bingeRisk >= 25) emotionalRisk.level = 'medium';
          emotionalRisk.pmid = '11070333'; // Epel 2001
        } catch (e) {
          devWarn('[ExtendedAnalytics] emotionalRisk error:', e);
          trackError(e, { scope: 'PI UI Dashboard', action: 'emotional_risk' });
        }

        // Training Day Context
        let trainingContext = { isTrainingDay: false, type: null, intensity: 'none' };
        if (day.trainings?.length > 0) {
          trainingContext.isTrainingDay = true;
          const types = { strength: 0, cardio: 0, hobby: 0 };
          let totalMin = 0, highMin = 0;
          day.trainings.forEach(t => {
            types[t.type || 'hobby']++;
            if (t.z) {
              const total = t.z.reduce((s, m) => s + (+m || 0), 0);
              totalMin += total;
              highMin += (+t.z[2] || 0) + (+t.z[3] || 0);
            }
          });
          trainingContext.type = Object.entries(types).sort((a, b) => b[1] - a[1])[0]?.[0] || 'hobby';
          if (totalMin >= 60 || highMin >= 20) trainingContext.intensity = 'high';
          else if (totalMin >= 30) trainingContext.intensity = 'moderate';
          else trainingContext.intensity = 'light';
        }

        return { proteinDebt, emotionalRisk, trainingContext };
      }, [lsGet, profile, pIndex, selectedDate]);

      // Use riskLevel from status (same source as PredictiveDashboard)
      const risk = useMemo(() => {
        const riskData = {
          low: { level: 'low', emoji: '‚úÖ', label: '–ù–∏–∑–∫–∏–π', color: '#22c55e' },
          medium: { level: 'medium', emoji: '‚ö†Ô∏è', label: '–°—Ä–µ–¥–Ω–∏–π', color: '#eab308' },
          high: { level: 'high', emoji: 'üö®', label: '–í—ã—Å–æ–∫–∏–π', color: '#ef4444' }
        };

        // Use status.riskLevel from Metabolic module (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
        const level = status?.riskLevel || 'low';
        return riskData[level] || riskData.low;
      }, [status]);

      // Phase data
      const phase = status?.metabolicPhase || null;

      // Empty state
      if (!status?.available) {
        return h('div', { className: 'metabolic-quick-status metabolic-quick-status--empty' },
          h('div', { className: 'metabolic-quick-status__title-header' },
            h('div', { className: 'metabolic-quick-status__title' },
              h('span', { className: 'metabolic-quick-status__title-icon' }, '‚ö†Ô∏è'),
              h('span', null, '–°—Ç–∞—Ç—É—Å –∏ —Ä–∏—Å–∫–∏'),
              h(getInfoButton(), { infoKey: 'CRASH_RISK' })
            )
          ),
          h('div', { className: 'metabolic-quick-status__cards' },
            h('div', { className: 'metabolic-quick-status__card' },
              h('div', { className: 'metabolic-quick-status__empty-icon' }, 'üìä'),
              h('div', { className: 'metabolic-quick-status__empty-text' }, '–î–æ–±–∞–≤—å –¥–∞–Ω–Ω—ã–µ')
            ),
            h('div', { className: 'metabolic-quick-status__card' },
              h('div', { className: 'metabolic-quick-status__empty-icon' }, '‚úÖ'),
              h('div', { className: 'metabolic-quick-status__empty-text' }, '–†–∏—Å–∫ —Å—Ä—ã–≤–∞'),
              h('div', { className: 'metabolic-quick-status__empty-label' }, '–ù–∏–∑–∫–∏–π')
            )
          )
        );
      }

      // Score color
      const getScoreColor = (score) => {
        if (score >= 80) return '#22c55e';
        if (score >= 60) return '#84cc16';
        if (score >= 40) return '#eab308';
        return '#ef4444';
      };

      return h('div', { className: 'metabolic-quick-status' },
        // Header
        h('div', { className: 'metabolic-quick-status__title-header' },
          h('div', { className: 'metabolic-quick-status__title' },
            h('span', { className: 'metabolic-quick-status__title-icon' }, '‚ö†Ô∏è'),
            h('span', null, '–°—Ç–∞—Ç—É—Å –∏ —Ä–∏—Å–∫–∏'),
            h(getInfoButton(), { infoKey: 'CRASH_RISK' })
          )
        ),
        // Cards container
        h('div', { className: 'metabolic-quick-status__cards' },
          // Card 1: Status Score
          h('div', { className: 'metabolic-quick-status__card' },
            h('div', { className: 'metabolic-quick-status__header' },
              h('div', { className: 'metabolic-quick-status__score', style: { color: getScoreColor(status.score) } },
                status.score
              ),
              h(getInfoButton(), { infoKey: 'STATUS_SCORE', size: 'small' })
            ),
            h('div', { className: 'metabolic-quick-status__score-label' }, '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º'),
            phase && h('div', { className: 'metabolic-quick-status__phase' },
              h('span', { className: 'metabolic-quick-status__phase-emoji' }, phase.emoji || '‚ö°'),
              h('span', { className: 'metabolic-quick-status__phase-text' }, phase.label || phase.phase)
            ),
            phase?.timeToLipolysis > 0 && h('div', { className: 'metabolic-quick-status__time' },
              `‚Üí ${Math.round(phase.timeToLipolysis * 60)} –º–∏–Ω`
            ),
            phase?.isLipolysis && h('div', { className: 'metabolic-quick-status__lipolysis' }, 'üî• –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ')
          ),

          // Card 2: Risk
          h('div', { className: `metabolic-quick-status__card metabolic-quick-status__card--${risk.level}` },
            h('div', { className: 'metabolic-quick-status__risk-header' },
              h('div', { className: 'metabolic-quick-status__risk-indicator' },
                h('div', {
                  className: 'metabolic-quick-status__light metabolic-quick-status__light--green',
                  style: { opacity: risk.level === 'low' ? 1 : 0.2 }
                }),
                h('div', {
                  className: 'metabolic-quick-status__light metabolic-quick-status__light--yellow',
                  style: { opacity: risk.level === 'medium' ? 1 : 0.2 }
                }),
                h('div', {
                  className: 'metabolic-quick-status__light metabolic-quick-status__light--red',
                  style: { opacity: risk.level === 'high' ? 1 : 0.2 }
                })
              ),
              h(getInfoButton(), { infoKey: 'CRASH_RISK_QUICK', size: 'small' })
            ),
            h('div', { className: 'metabolic-quick-status__risk-label' },
              h('span', null, risk.emoji),
              '–†–∏—Å–∫ —Å—Ä—ã–≤–∞'
            ),
            h('div', { className: 'metabolic-quick-status__risk-level', style: { color: risk.color } },
              risk.label
            )
          )
        ), // Close __cards

        // üÜï v3.22.0: Extended Analytics Row (proteinDebt, emotionalRisk, trainingContext)
        (extendedAnalytics?.proteinDebt?.hasDebt || extendedAnalytics?.emotionalRisk?.level !== 'low' || extendedAnalytics?.trainingContext?.isTrainingDay) &&
        h('div', { className: 'metabolic-quick-status__extended' },
          // Protein Debt Badge
          extendedAnalytics?.proteinDebt?.hasDebt && h('div', {
            className: `metabolic-quick-status__badge metabolic-quick-status__badge--${extendedAnalytics.proteinDebt.severity}`,
            title: `–°—Ä–µ–¥–Ω–∏–π –±–µ–ª–æ–∫ –∑–∞ 3 –¥–Ω—è: ${extendedAnalytics.proteinDebt.avgProteinPct}% (–Ω–æ—Ä–º–∞ 25%)\nüî¨ PMID: ${extendedAnalytics.proteinDebt.pmid}`
          },
            h('span', { className: 'metabolic-quick-status__badge-icon' }, 'ü•©'),
            h('span', { className: 'metabolic-quick-status__badge-text' },
              extendedAnalytics.proteinDebt.severity === 'critical' ? '–ë–µ–ª–æ–∫ ‚Üì‚Üì' : '–ë–µ–ª–æ–∫ ‚Üì'
            ),
            h('a', {
              href: `https://pubmed.ncbi.nlm.nih.gov/${extendedAnalytics.proteinDebt.pmid}/`,
              target: '_blank',
              className: 'metabolic-quick-status__pmid',
              onClick: (e) => e.stopPropagation()
            }, '?')
          ),

          // Emotional Risk Badge
          extendedAnalytics?.emotionalRisk?.level !== 'low' && h('div', {
            className: `metabolic-quick-status__badge metabolic-quick-status__badge--${extendedAnalytics.emotionalRisk.level}`,
            title: `–†–∏—Å–∫ —Å—Ä—ã–≤–∞: ${extendedAnalytics.emotionalRisk.bingeRisk}%\n–§–∞–∫—Ç–æ—Ä—ã: ${extendedAnalytics.emotionalRisk.factors.join(', ')}\nüî¨ PMID: ${extendedAnalytics.emotionalRisk.pmid}`
          },
            h('span', { className: 'metabolic-quick-status__badge-icon' }, 'üò∞'),
            h('span', { className: 'metabolic-quick-status__badge-text' },
              `${extendedAnalytics.emotionalRisk.bingeRisk}%`
            ),
            h('a', {
              href: `https://pubmed.ncbi.nlm.nih.gov/${extendedAnalytics.emotionalRisk.pmid}/`,
              target: '_blank',
              className: 'metabolic-quick-status__pmid',
              onClick: (e) => e.stopPropagation()
            }, '?')
          ),

          // Training Context Badge
          extendedAnalytics?.trainingContext?.isTrainingDay && h('div', {
            className: `metabolic-quick-status__badge metabolic-quick-status__badge--training metabolic-quick-status__badge--${extendedAnalytics.trainingContext.intensity}`,
            title: `–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å: ${extendedAnalytics.trainingContext.type}\n–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${extendedAnalytics.trainingContext.intensity}`
          },
            h('span', { className: 'metabolic-quick-status__badge-icon' },
              extendedAnalytics.trainingContext.type === 'strength' ? 'üí™' :
                extendedAnalytics.trainingContext.type === 'cardio' ? 'üèÉ' : '‚öΩ'
            ),
            h('span', { className: 'metabolic-quick-status__badge-text' },
              extendedAnalytics.trainingContext.intensity === 'high' ? '–ò–Ω—Ç–µ–Ω—Å–∏–≤' : '–¢—Ä–µ–Ω–∏'
            )
          )
        )
      );
    }

    /**
     * MetabolicStatusCard ‚Äî –≥–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ 0-100
     * v2.0: —Å ring animation, trend, breakdown bars, confidence badge
     */
    function MetabolicStatusCard({ lsGet, profile, pIndex, selectedDate }) {
      const [showDetails, setShowDetails] = useState(false);

      // Fallback: –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –¥–∞–Ω–Ω—ã–º–∏
      const resolvedDate = useMemo(() => {
        return getMetabolismDate(lsGet || window.HEYS?.utils?.lsGet, selectedDate);
      }, [lsGet, selectedDate]);

      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      const status = useMemo(() => {
        if (!HEYS.Metabolic?.getStatus) return null;

        return HEYS.Metabolic.getStatus({
          dateStr: resolvedDate,
          pIndex: pIndex || null,
          profile: profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          forceRefresh: false
        });
      }, [lsGet, profile, pIndex, resolvedDate]);

      // –ü–æ–ª—É—á–∞–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–π —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
      const prevStatus = useMemo(() => {
        if (!HEYS.Metabolic?.getStatus) return null;

        const today = selectedDate || new Date().toISOString().split('T')[0];
        const prevDate = new Date(today);
        prevDate.setDate(prevDate.getDate() - 1);
        const prevDateStr = prevDate.toISOString().split('T')[0];

        try {
          return HEYS.Metabolic.getStatus({
            dateStr: prevDateStr,
            pIndex: pIndex || null,
            profile: profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
            forceRefresh: false
          });
        } catch {
          return null;
        }
      }, [lsGet, profile, pIndex, selectedDate]);

      // –í—ã—á–∏—Å–ª—è–µ–º breakdown –ø–æ —Å—Ç–æ–ª–ø–∞–º –∏–∑ reasons
      const pillarScores = useMemo(() => {
        if (!status?.reasons?.length) return null;

        const pillars = { nutrition: 100, timing: 100, activity: 100, recovery: 100 };
        status.reasons.forEach(r => {
          if (r.pillar && pillars[r.pillar] !== undefined) {
            pillars[r.pillar] = Math.max(0, pillars[r.pillar] - (r.impact || 10));
          }
        });
        return pillars;
      }, [status]);

      if (!status || !status.available) {
        return h('div', { className: 'metabolic-status-card metabolic-status-card--empty' },
          h('div', { className: 'metabolic-status-card__icon' }, 'üìä'),
          h('div', { className: 'metabolic-status-card__message' },
            status?.message || '–î–æ–±–∞–≤—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∞—Ç—É—Å–∞'
          )
        );
      }

      // –≠–º–æ–¥–∑–∏ –ø–æ risk level
      const riskEmojis = {
        low: '‚úÖ',
        medium: '‚ö†Ô∏è',
        high: 'üö®'
      };

      return h('div', { className: `metabolic-status-card metabolic-status-card--v2 ${showDetails ? 'metabolic-status-card--expanded' : ''}` },
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å ring –∏ trend
        h('div', {
          className: 'metabolic-status-card__header metabolic-status-card__header--v2',
          onClick: () => setShowDetails(!showDetails)
        },
          h('div', { className: 'metabolic-status-card__ring-container' },
            h(StatusProgressRing, { score: status.score, size: 100, strokeWidth: 8 }),
            prevStatus?.available && h(StatusTrendBadge, {
              currentScore: status.score,
              prevScore: prevStatus.score
            })
          ),
          h('div', { className: 'metabolic-status-card__info' },
            h('div', { className: 'metabolic-status-card__title-v2' }, '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –°—Ç–∞—Ç—É—Å'),
            // Metabolic Phase
            status.metabolicPhase && h('div', { className: 'metabolic-status-card__phase' },
              h('span', { className: 'metabolic-status-card__phase-emoji' }, status.metabolicPhase.emoji),
              h('span', { className: 'metabolic-status-card__phase-label' }, status.metabolicPhase.label),
              status.metabolicPhase.timeToLipolysis > 0 && h('span', { className: 'metabolic-status-card__phase-time' },
                ` ‚Üí ${Math.round(status.metabolicPhase.timeToLipolysis * 60)} –º–∏–Ω`
              )
            ),
            // Risk Level
            h('div', { className: `metabolic-status-card__risk metabolic-status-card__risk--${status.riskLevel}` },
              h('span', { className: 'metabolic-status-card__risk-emoji' }, riskEmojis[status.riskLevel]),
              h('span', { className: 'metabolic-status-card__risk-label' },
                status.riskLevel === 'low' ? '–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫' :
                  status.riskLevel === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫' :
                    '–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫'
              )
            )
          ),
          h('span', { className: 'metabolic-status-card__chevron' }, showDetails ? '‚ñº' : '‚ñ∂')
        ),

        // Breakdown –ø–æ —Å—Ç–æ–ª–ø–∞–º (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º)
        pillarScores && h('div', { className: 'metabolic-status-card__breakdown' },
          h(PillarBreakdownBars, { pillars: pillarScores })
        ),

        // –î–µ—Ç–∞–ª–∏ (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ)
        showDetails && h('div', { className: 'metabolic-status-card__details' },
          // –ü—Ä–∏—á–∏–Ω—ã —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
          status.reasons && status.reasons.length > 0 && h('div', { className: 'metabolic-status-card__section' },
            h('div', { className: 'metabolic-status-card__section-header' },
              h('span', { className: 'metabolic-status-card__section-title' }, 'üìâ –ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∞—Ç—É—Å'),
              h(getInfoButton(), { infoKey: 'STATUS_INFLUENCES', size: 'small' })
            ),
            h('div', { className: 'metabolic-status-card__reasons' },
              status.reasons.map((reason, idx) =>
                h(ReasonCard, { key: reason.id || idx, reason })
              )
            )
          ),

          // –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
          status.nextSteps && status.nextSteps.length > 0 && h('div', { className: 'metabolic-status-card__section' },
            h('div', { className: 'metabolic-status-card__section-header' },
              h('span', { className: 'metabolic-status-card__section-title' }, 'üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è'),
              h(getInfoButton(), { infoKey: 'PRIORITY_ACTIONS', size: 'small' })
            ),
            h('div', { className: 'metabolic-status-card__steps' },
              status.nextSteps.slice(0, 3).map((step, idx) =>
                h(ActionCard, { key: step.id || idx, step })
              )
            )
          ),

          // –†–∏—Å–∫ —Ñ–∞–∫—Ç–æ—Ä—ã
          status.riskFactors && status.riskFactors.length > 0 && h('div', { className: 'metabolic-status-card__section' },
            h('div', { className: 'metabolic-status-card__section-header' },
              h('span', { className: 'metabolic-status-card__section-title' },
                `${riskEmojis[status.riskLevel]} –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞`
              ),
              h(getInfoButton(), { infoKey: 'STATUS_RISK_FACTORS', size: 'small' })
            ),
            h('div', { className: 'metabolic-status-card__risk-factors' },
              status.riskFactors.map((factor, idx) =>
                h('div', { key: factor.id || idx, className: 'metabolic-status-card__risk-factor' },
                  h('span', { className: 'metabolic-status-card__risk-factor-label' }, factor.label),
                  h('span', { className: 'metabolic-status-card__risk-factor-impact' }, `+${factor.impact}`)
                )
              )
            )
          ),

          // Confidence Badge
          h('div', { className: 'metabolic-status-card__confidence-section' },
            h(ConfidenceBadge, {
              confidence: status.confidence,
              completeness: status.debug?.inventory?.completeness
            })
          )
        )
      );
    }

    /**
     * ReasonCard ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–∏—á–∏–Ω—ã —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
     */
    function ReasonCard({ reason }) {
      const [showScience, setShowScience] = useState(false);

      const pillarIcons = {
        nutrition: 'üçΩÔ∏è',
        timing: '‚è∞',
        activity: 'üèÉ',
        recovery: 'üò¥'
      };

      return h('div', { className: `reason-card reason-card--${reason.pillar}` },
        h('div', { className: 'reason-card__header' },
          h('span', { className: 'reason-card__icon' }, pillarIcons[reason.pillar] || 'üìä'),
          h('span', { className: 'reason-card__label' }, reason.label),
          h('span', { className: 'reason-card__impact' }, `-${reason.impact}`)
        ),
        h('div', { className: 'reason-card__short' }, reason.short),
        reason.details && h('div', { className: 'reason-card__details' }, reason.details),
        reason.scientificBasis && h('div', { className: 'reason-card__science' },
          h('button', {
            className: 'reason-card__science-toggle',
            onClick: () => setShowScience(!showScience)
          }, showScience ? 'üìñ –°–∫—Ä—ã—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ' : 'üìñ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ'),
          showScience && h('div', { className: 'reason-card__science-text' }, reason.scientificBasis)
        )
      );
    }

    /**
     * ActionCard ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
     */
    function ActionCard({ step }) {
      const priorityLabels = {
        0: '–°–†–û–ß–ù–û',
        1: '–í–∞–∂–Ω–æ',
        2: '–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ',
        3: '–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ'
      };

      return h('div', { className: 'action-card' },
        h('div', { className: 'action-card__header' },
          h('span', { className: 'action-card__label' }, step.label),
          h('span', {
            className: `action-card__priority action-card__priority--${step.priority || 3}`
          }, priorityLabels[step.priority || 3])
        ),
        step.why && h('div', { className: 'action-card__why' }, step.why),
        h('div', { className: 'action-card__footer' },
          step.etaMin && h('span', { className: 'action-card__eta' },
            `‚è±Ô∏è ${step.etaMin < 60 ? `${step.etaMin} –º–∏–Ω` : `${Math.round(step.etaMin / 60)} —á`}`
          ),
          step.expectedEffect && h('span', { className: 'action-card__effect' },
            `üí´ ${step.expectedEffect}`
          )
        )
      );
    }

    /**
     * PredictiveDashboard ‚Äî –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å —Ç–∞–±–∞–º–∏ (Risk | Forecast | Phenotype)
     * v3.0: Dual Risk Meter (—Å–µ–≥–æ–¥–Ω—è + –∑–∞–≤—Ç—Ä–∞), –±–µ–∑ timeline –¥–ª—è risk –∏ phenotype
     */
    function PredictiveDashboard({ lsGet, profile, selectedDate, pIndex }) {
      const [activeTab, setActiveTab] = useState('risk');
      const [dateOffset, setDateOffset] = useState(0); // -7..+7 –¥–Ω–µ–π ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è forecast

      // –ë–∞–∑–æ–≤–∞—è –¥–∞—Ç–∞ (—Å–µ–≥–æ–¥–Ω—è)
      const todayDate = useMemo(() => {
        return selectedDate || new Date().toISOString().split('T')[0];
      }, [selectedDate]);

      // –ó–∞–≤—Ç—Ä–∞
      const tomorrowDate = useMemo(() => {
        const d = new Date(todayDate);
        d.setDate(d.getDate() + 1);
        return d.toISOString().split('T')[0];
      }, [todayDate]);

      // –î–∞—Ç–∞ –¥–ª—è forecast (—Å offset)
      const forecastDate = useMemo(() => {
        const base = new Date(todayDate);
        base.setDate(base.getDate() + dateOffset);
        return base.toISOString().split('T')[0];
      }, [todayDate, dateOffset]);

      const isForecastToday = dateOffset === 0;
      const isForecastFuture = dateOffset > 0;
      const isForecastPast = dateOffset < 0;

      // –†–∏—Å–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      const predictionToday = useMemo(() => {
        if (!HEYS.Metabolic?.calculateCrashRisk24h) return null;

        const history = HEYS.Metabolic.getDaysHistory ? HEYS.Metabolic.getDaysHistory(30) : [];

        return HEYS.Metabolic.calculateCrashRisk24h(
          todayDate,
          profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          history
        );
      }, [lsGet, profile, todayDate]);

      // –†–∏—Å–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
      const predictionTomorrow = useMemo(() => {
        if (!HEYS.Metabolic?.calculateCrashRisk24h) return null;

        const history = HEYS.Metabolic.getDaysHistory ? HEYS.Metabolic.getDaysHistory(30) : [];

        return HEYS.Metabolic.calculateCrashRisk24h(
          tomorrowDate,
          profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          history
        );
      }, [lsGet, profile, tomorrowDate]);

      // –ü—Ä–æ–≥–Ω–æ–∑ (—Å offset –¥–ª—è timeline)
      const forecast = useMemo(() => {
        if (!HEYS.Metabolic?.calculatePerformanceForecast) return null;

        const history = HEYS.Metabolic.getDaysHistory ? HEYS.Metabolic.getDaysHistory(30) : [];

        return HEYS.Metabolic.calculatePerformanceForecast(
          forecastDate,
          profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          history
        );
      }, [lsGet, profile, forecastDate]);

      // Phenotype —Ç–µ–ø–µ—Ä—å –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ HEYS.Phenotype.PhenotypeWidget

      const riskColors = {
        low: '#22c55e',
        medium: '#eab308',
        high: '#ef4444'
      };


      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è timeline (—Ç–æ–ª—å–∫–æ –¥–ª—è forecast)
      const formatTimelineDate = (offset) => {
        const d = new Date(todayDate);
        d.setDate(d.getDate() + offset);
        const day = d.getDate();
        const weekday = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'][d.getDay()];
        if (offset === 0) return '–°–µ–≥–æ–¥–Ω—è';
        if (offset === 1) return '–ó–∞–≤—Ç—Ä–∞';
        if (offset === -1) return '–í—á–µ—Ä–∞';
        return `${weekday}`;
      };

      // Badge –¥–ª—è —Ä–∏—Å–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –∑–∞–≤—Ç—Ä–∞)
      const maxRisk = Math.max(predictionToday?.risk || 0, predictionTomorrow?.risk || 0);

      // Tabs ‚Äî —Ç–æ–ª—å–∫–æ Risk –∏ Forecast (Phenotype —Ç–µ–ø–µ—Ä—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞)
      const tabs = [
        { id: 'risk', label: 'üö® –†–∏—Å–∫', badge: maxRisk > 30 ? maxRisk + '%' : null },
        { id: 'forecast', label: 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑', badge: null }
      ];

      // Timeline –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è forecast
      const showTimeline = activeTab === 'forecast';

      return h('div', { className: 'predictive-dashboard predictive-dashboard--v2' },
        // Header —Å InfoButton
        h('div', { className: 'predictive-dashboard__header' },
          h('div', { className: 'predictive-dashboard__title' },
            h('span', { className: 'predictive-dashboard__title-icon' }, 'üîÆ'),
            h('span', null, '–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'),
            h(getInfoButton(), { infoKey: 'PREDICTIVE_RISK' })
          )
        ),

        // Tabs
        h('div', { className: 'predictive-dashboard__tabs' },
          tabs.map(tab =>
            h('button', {
              key: tab.id,
              className: `predictive-dashboard__tab ${activeTab === tab.id ? 'predictive-dashboard__tab--active' : ''}`,
              onClick: () => setActiveTab(tab.id)
            },
              h('span', { className: 'predictive-dashboard__tab-label' }, tab.label),
              tab.badge && h('span', { className: 'predictive-dashboard__tab-badge' }, tab.badge)
            )
          )
        ),

        // Timeline Navigation ‚Äî –¢–û–õ–¨–ö–û –¥–ª—è Forecast
        showTimeline && h('div', { className: 'predictive-dashboard__timeline' },
          h('button', {
            className: 'predictive-dashboard__timeline-btn',
            disabled: dateOffset <= -7,
            onClick: () => setDateOffset(d => Math.max(-7, d - 1))
          }, '‚Üê'),
          h('div', { className: 'predictive-dashboard__timeline-dates' },
            [-3, -2, -1, 0, 1, 2, 3].map(offset =>
              h('button', {
                key: offset,
                className: `predictive-dashboard__timeline-date ${dateOffset === offset ? 'predictive-dashboard__timeline-date--active' : ''} ${offset === 0 ? 'predictive-dashboard__timeline-date--today' : ''}`,
                onClick: () => setDateOffset(offset)
              }, formatTimelineDate(offset))
            )
          ),
          h('button', {
            className: 'predictive-dashboard__timeline-btn',
            disabled: dateOffset >= 7,
            onClick: () => setDateOffset(d => Math.min(7, d + 1))
          }, '‚Üí')
        ),

        // Tab Content
        h('div', { className: 'predictive-dashboard__content' },
          // RISK TAB ‚Äî Dual meters (—Å–µ–≥–æ–¥–Ω—è + –∑–∞–≤—Ç—Ä–∞)
          activeTab === 'risk' && h('div', { className: 'predictive-dashboard__panel' },
            (predictionToday || predictionTomorrow)
              ? h(DualRiskPanel, {
                predictionToday,
                predictionTomorrow,
                riskColors
              })
              : h('div', { className: 'predictive-dashboard__empty' }, '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–∞')
          ),

          // FORECAST TAB ‚Äî —Å timeline
          activeTab === 'forecast' && h('div', { className: 'predictive-dashboard__panel' },
            forecast ? h(ForecastPanel, { forecast, isPast: isForecastPast }) :
              h('div', { className: 'predictive-dashboard__empty' }, '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞')
          )
        )
      );
    }

    /**
     * DualRiskPanel ‚Äî –¥–≤–∞ –ø–æ–ª—É–∫—Ä—É–≥–∞ —Ä—è–¥–æ–º: –°–µ–≥–æ–¥–Ω—è + –ó–∞–≤—Ç—Ä–∞
     * v3.0: –£–±—Ä–∞–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º, —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ –æ–±–∞ —Ä–∏—Å–∫–∞
     * v3.22.0: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è emotionalRisk –≤ —Ñ–∞–∫—Ç–æ—Ä—ã (Epel 2001, PMID: 11070333)
     */
    function DualRiskPanel({ predictionToday, predictionTomorrow, riskColors }) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π —Ä–∏—Å–∫ –≤—ã—à–µ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞
      const todayRisk = predictionToday?.risk || 0;
      const tomorrowRisk = predictionTomorrow?.risk || 0;
      const maxRisk = Math.max(todayRisk, tomorrowRisk);

      // –ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Ç –≥–¥–µ —Ä–∏—Å–∫ –≤—ã—à–µ, –µ—Å–ª–∏ –æ–±–∞ –µ—Å—Ç—å)
      const [activePrediction, setActivePrediction] = useState(tomorrowRisk > todayRisk ? 'tomorrow' : 'today');

      // üÜï v3.22.0: Extended Analytics –¥–ª—è emotional risk
      const extendedAnalytics = useMemo(() => {
        const U = window.HEYS?.utils;
        const lsGet = U?.lsGet || ((k, d) => {
          try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
        });
        const profile = lsGet('heys_profile', {});
        const todayDate = new Date().toISOString().split('T')[0];
        const dayKey = `heys_dayv2_${todayDate}`;
        const day = lsGet(dayKey, {});

        // Emotional Risk (Epel 2001, PMID: 11070333)
        const stressAvg = day.stressAvg || 0;
        const factors = [];
        let bingeRisk = 0;

        if (stressAvg >= 6) {
          factors.push('–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å');
          bingeRisk += 35;
        } else if (stressAvg >= 4) {
          factors.push('–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å');
          bingeRisk += 15;
        }

        const hour = new Date().getHours();
        if (hour >= 20) {
          factors.push('–í–µ—á–µ—Ä');
          bingeRisk += 20;
        } else if (hour >= 18) {
          bingeRisk += 10;
        }

        const sleepDeficit = (profile.sleepHours || 8) - (day.sleepHours || 0);
        if (sleepDeficit > 2) {
          factors.push('–ù–µ–¥–æ—Å—ã–ø');
          bingeRisk += 15;
        }

        // –î–µ–Ω—å –¥–µ—Ñ–∏—Ü–∏—Ç–∞? (–Ω–µ–¥–æ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π)
        const deficitDays = [];
        for (let i = 1; i <= 3; i++) {
          const d = new Date(todayDate);
          d.setDate(d.getDate() - i);
          const pastDay = lsGet(`heys_dayv2_${d.toISOString().split('T')[0]}`, {});
          const optimum = 2000; // –ø—Ä–∏–º–µ—Ä–Ω–æ
          const eaten = pastDay.meals?.reduce((sum, m) => {
            return sum + (m.items?.reduce((s, item) => s + (item.kcal || 0), 0) || 0);
          }, 0) || 0;
          if (eaten > 0 && eaten < optimum * 0.75) deficitDays.push(i);
        }
        if (deficitDays.length >= 2) {
          factors.push('–ö–∞–ª–æ—Ä–∏–π–Ω—ã–π –¥–æ–ª–≥');
          bingeRisk += 20;
        }

        const emotionalRisk = {
          hasRisk: bingeRisk >= 30 || factors.length >= 2,
          level: bingeRisk >= 60 ? 'high' : bingeRisk >= 40 ? 'medium' : 'low',
          bingeRisk: Math.min(90, bingeRisk),
          factors,
          stressLevel: stressAvg,
          pmid: '11070333'
        };

        // Training Context (Aragon 2013, PMID: 23360586)
        const trainings = day.trainings || [];
        const isTrainingDay = trainings.length > 0;
        let trainingType = null;
        let trainingIntensity = 'moderate';

        if (isTrainingDay) {
          const t = trainings[0];
          trainingType = t.type || 'cardio';
          const totalMins = (t.z || []).reduce((a, b) => a + b, 0);
          const highZoneMins = (t.z?.[2] || 0) + (t.z?.[3] || 0);
          if (highZoneMins > totalMins * 0.4) trainingIntensity = 'high';
          else if (totalMins < 30) trainingIntensity = 'light';
        }

        return { emotionalRisk, isTrainingDay, trainingType, trainingIntensity };
      }, []);

      // –†–∞—Å—à–∏—Ä—è–µ–º factors emotionalRisk –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫
      const getEnhancedFactors = (prediction) => {
        if (!prediction?.factors) return [];
        const factors = [...prediction.factors];

        // –î–æ–±–∞–≤–ª—è–µ–º emotionalRisk –µ—Å–ª–∏ –≤—ã—Å–æ–∫–∏–π
        if (extendedAnalytics.emotionalRisk.hasRisk) {
          const { bingeRisk, factors: riskFactors } = extendedAnalytics.emotionalRisk;
          factors.push({
            label: `üß† –≠–º–æ—Ü. —Ä–∏—Å–∫: ${riskFactors.slice(0, 2).join(', ')}`,
            weight: Math.round(bingeRisk * 0.3), // –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ +weight
            pmid: '11070333',
            isEmotional: true
          });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º training context –∫–∞–∫ –∑–∞—â–∏—Ç–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å)
        if (extendedAnalytics.isTrainingDay) {
          const typeLabels = { strength: 'üí™ –°–∏–ª–æ–≤–∞—è', cardio: 'üèÉ –ö–∞—Ä–¥–∏–æ', hobby: '‚öΩ –•–æ–±–±–∏' };
          factors.push({
            label: `${typeLabels[extendedAnalytics.trainingType] || 'üèãÔ∏è –¢—Ä–µ–Ω.'} —Å–µ–≥–æ–¥–Ω—è`,
            weight: extendedAnalytics.trainingIntensity === 'high' ? -15 : -10,
            isProtective: true
          });
        }

        return factors;
      };

      const basePredictionData = activePrediction === 'today' ? predictionToday : predictionTomorrow;
      const activePredictionData = basePredictionData ? {
        ...basePredictionData,
        factors: getEnhancedFactors(basePredictionData)
      } : null;
      const activeLabel = activePrediction === 'today' ? '–°–µ–≥–æ–¥–Ω—è' : '–ó–∞–≤—Ç—Ä–∞';

      const getRiskLevel = (risk) => risk < 30 ? 'low' : risk < 60 ? 'medium' : 'high';

      return h('div', { className: 'dual-risk-panel' },
        // –î–≤–∞ –ø–æ–ª—É–∫—Ä—É–≥–∞ —Ä—è–¥–æ–º
        h('div', { className: 'dual-risk-panel__meters' },
          // –°–µ–≥–æ–¥–Ω—è
          h('div', {
            className: `dual-risk-panel__meter-card ${activePrediction === 'today' ? 'dual-risk-panel__meter-card--active' : ''}`,
            onClick: () => setActivePrediction('today')
          },
            h('div', { className: 'dual-risk-panel__meter-label' }, '–°–µ–≥–æ–¥–Ω—è'),
            h(MiniRiskMeter, {
              risk: todayRisk,
              riskLevel: getRiskLevel(todayRisk),
              size: 120
            }),
            todayRisk < 30 && h('div', { className: 'dual-risk-panel__ok-badge' }, '‚úÖ')
          ),

          // –ó–∞–≤—Ç—Ä–∞
          h('div', {
            className: `dual-risk-panel__meter-card ${activePrediction === 'tomorrow' ? 'dual-risk-panel__meter-card--active' : ''}`,
            onClick: () => setActivePrediction('tomorrow')
          },
            h('div', { className: 'dual-risk-panel__meter-label' }, '–ó–∞–≤—Ç—Ä–∞'),
            h(MiniRiskMeter, {
              risk: tomorrowRisk,
              riskLevel: getRiskLevel(tomorrowRisk),
              size: 120
            }),
            tomorrowRisk >= 30 && h('div', { className: 'dual-risk-panel__warning-badge' }, '‚ö†Ô∏è')
          )
        ),

        // –°—Ç–∞—Ç—É—Å —Å—Ç—Ä–æ–∫–∞
        h('div', { className: 'dual-risk-panel__status' },
          maxRisk < 30
            ? h('span', { className: 'dual-risk-panel__status-ok' }, '‚úÖ –í—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º')
            : tomorrowRisk > todayRisk
              ? h('span', { className: 'dual-risk-panel__status-warn' }, 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±—É–¥—É—â–µ–µ')
              : h('span', { className: 'dual-risk-panel__status-warn' }, '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è')
        ),

        // –î–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
        activePredictionData && h('div', { className: 'dual-risk-panel__details' },
          // Hint - –∫–∞–∫–æ–π –¥–µ–Ω—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
          h('div', { className: 'dual-risk-panel__details-hint' },
            `–î–µ—Ç–∞–ª–∏: ${activeLabel} (–Ω–∞–∂–º–∏ –Ω–∞ –ø–æ–ª—É–∫—Ä—É–≥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è)`
          ),

          // Primary Trigger
          activePredictionData.primaryTrigger && h('div', { className: 'risk-panel__trigger' },
            h('div', { className: 'risk-panel__trigger-label' }, '–ì–ª–∞–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä:'),
            h('div', { className: 'risk-panel__trigger-value' }, activePredictionData.primaryTrigger.label)
          ),

          // Prevention Strategies
          activePredictionData.preventionStrategy && activePredictionData.preventionStrategy.length > 0 &&
          h('div', { className: 'risk-panel__prevention' },
            h('div', { className: 'risk-panel__prevention-header' },
              h('span', { className: 'risk-panel__prevention-title' }, 'üõ°Ô∏è –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞'),
              h(getInfoButton(), { infoKey: 'PREVENTION_STRATEGY', size: 'small' })
            ),
            activePredictionData.preventionStrategy.slice(0, 3).map((strategy, idx) =>
              h('div', { key: idx, className: 'risk-panel__strategy' },
                h('span', { className: 'risk-panel__strategy-num' }, idx + 1),
                h('div', { className: 'risk-panel__strategy-content' },
                  h('div', { className: 'risk-panel__strategy-action' }, strategy.action),
                  h('div', { className: 'risk-panel__strategy-reason' }, strategy.reason)
                )
              )
            )
          ),

          // Risk Factors ‚Äî üÜï v3.22.0: —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å PMID –∏ –∑–∞—â–∏—Ç–Ω—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏
          activePredictionData.factors && activePredictionData.factors.length > 0 &&
          h('div', { className: 'risk-panel__factors' },
            h('div', { className: 'risk-panel__factors-header' },
              h('span', { className: 'risk-panel__factors-title' }, 'üìã –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞'),
              h(getInfoButton(), { infoKey: 'RISK_FACTORS', size: 'small' })
            ),
            activePredictionData.factors.slice(0, 6).map((factor, idx) =>
              h('div', {
                key: idx,
                className: `risk-panel__factor ${factor.isProtective ? 'risk-panel__factor--protective' : ''} ${factor.isEmotional ? 'risk-panel__factor--emotional' : ''}`
              },
                h('span', { className: 'risk-panel__factor-label' }, factor.label),
                h('span', {
                  className: `risk-panel__factor-weight ${factor.weight < 0 ? 'risk-panel__factor-weight--negative' : ''}`
                }, factor.weight < 0 ? factor.weight : `+${factor.weight || factor.impact}`),
                factor.pmid && h('a', {
                  href: `https://pubmed.ncbi.nlm.nih.gov/${factor.pmid}/`,
                  target: '_blank',
                  rel: 'noopener noreferrer',
                  className: 'risk-panel__factor-pmid',
                  title: `PMID: ${factor.pmid}`,
                  onClick: (e) => e.stopPropagation()
                }, 'üî¨')
              )
            )
          )
        )
      );
    }

    /**
     * MiniRiskMeter ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø–æ–ª—É–∫—Ä—É–≥ –¥–ª—è dual view
     */
    function MiniRiskMeter({ risk, riskLevel, size = 120 }) {
      const safeRisk = typeof risk === 'number' && !isNaN(risk) ? Math.min(100, Math.max(0, risk)) : 0;
      const strokeWidth = 10;
      const radius = (size - strokeWidth) / 2;
      const halfCircumference = Math.PI * radius;
      const progress = (safeRisk / 100) * halfCircumference;
      const offset = halfCircumference - progress;

      const colors = {
        low: '#22c55e',
        medium: '#eab308',
        high: '#ef4444'
      };

      return h('div', { className: 'mini-risk-meter', style: { width: size, height: size / 2 + 25 } },
        h('svg', {
          viewBox: `0 0 ${size} ${size / 2 + 15}`,
          className: 'mini-risk-meter__svg'
        },
          // Background arc
          h('path', {
            d: `M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`,
            fill: 'none',
            stroke: 'var(--border-color, #e2e8f0)',
            strokeWidth: strokeWidth,
            strokeLinecap: 'round'
          }),
          // Progress arc
          h('path', {
            d: `M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`,
            fill: 'none',
            stroke: colors[riskLevel] || colors.medium,
            strokeWidth: strokeWidth,
            strokeLinecap: 'round',
            strokeDasharray: halfCircumference,
            strokeDashoffset: offset,
            style: { transition: 'stroke-dashoffset 0.6s ease' }
          }),
          // Value text
          h('text', {
            x: size / 2,
            y: size / 2 - 2,
            textAnchor: 'middle',
            style: {
              fontSize: 28,
              fontWeight: 700,
              fill: colors[riskLevel] || 'var(--text-primary)'
            }
          }, `${safeRisk}%`),
          // Label
          h('text', {
            x: size / 2,
            y: size / 2 + 14,
            textAnchor: 'middle',
            style: { fontSize: 10, fill: 'var(--text-secondary, #64748b)' }
          }, '–†–∏—Å–∫ —Å—Ä—ã–≤–∞')
        )
      );
    }

    /**
     * RiskPanel ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–∞ Risk (legacy, –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
     */
    function RiskPanel({ prediction, riskColors, isPast, isFuture }) {
      const riskLevel = prediction.riskLevel || (prediction.risk < 30 ? 'low' : prediction.risk < 60 ? 'medium' : 'high');

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º predictionId –¥–ª—è feedback
      const predictionId = prediction.id || `risk_${prediction.date || Date.now()}`;

      return h('div', { className: 'risk-panel' },
        // Risk Meter (gauge) with InfoButton
        h('div', { className: 'risk-panel__meter-wrapper' },
          h('div', { className: 'risk-panel__meter' },
            h(RiskMeter, { risk: prediction.risk, riskLevel })
          ),
          h('div', { className: 'risk-panel__meter-info' },
            h(getInfoButton(), {
              infoKey: 'CRASH_RISK',
              size: 'small',
              debugData: {
                risk: prediction.risk,
                riskLevel,
                factors: prediction.factors?.length || 0
              }
            })
          )
        ),

        // Status with inline feedback
        h('div', { className: 'risk-panel__status-row' },
          h('div', { className: 'risk-panel__status' },
            isPast ? 'üìä –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è' :
              isFuture ? 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±—É–¥—É—â–µ–µ' :
                prediction.risk >= 30 ? '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è' : '‚úÖ –í—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º'
          ),
          // Inline feedback –¥–ª—è –ø—Ä–æ—à–ª—ã—Ö –¥–Ω–µ–π
          isPast && h(FeedbackPrompt, { predictionId, type: 'risk', compact: true })
        ),

        // Primary Trigger
        prediction.primaryTrigger && h('div', { className: 'risk-panel__trigger' },
          h('div', { className: 'risk-panel__trigger-label' }, '–ì–ª–∞–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä:'),
          h('div', { className: 'risk-panel__trigger-value' }, prediction.primaryTrigger.label)
        ),

        // Prevention Strategies
        prediction.preventionStrategy && prediction.preventionStrategy.length > 0 && h('div', { className: 'risk-panel__prevention' },
          h('div', { className: 'risk-panel__prevention-header' },
            h('span', { className: 'risk-panel__prevention-title' }, 'üõ°Ô∏è –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞'),
            h(getInfoButton(), { infoKey: 'PREVENTION_STRATEGY', size: 'small' })
          ),
          prediction.preventionStrategy.slice(0, 3).map((strategy, idx) =>
            h('div', { key: idx, className: 'risk-panel__strategy' },
              h('span', { className: 'risk-panel__strategy-num' }, idx + 1),
              h('div', { className: 'risk-panel__strategy-content' },
                h('div', { className: 'risk-panel__strategy-action' }, strategy.action),
                h('div', { className: 'risk-panel__strategy-reason' }, strategy.reason)
              )
            )
          )
        ),

        // Risk Factors
        prediction.factors && prediction.factors.length > 0 && h('div', { className: 'risk-panel__factors' },
          h('div', { className: 'risk-panel__factors-header' },
            h('span', { className: 'risk-panel__factors-title' }, 'üìã –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞'),
            h(getInfoButton(), { infoKey: 'RISK_FACTORS', size: 'small' })
          ),
          prediction.factors.slice(0, 5).map((factor, idx) =>
            h('div', { key: idx, className: 'risk-panel__factor' },
              h('span', { className: 'risk-panel__factor-label' }, factor.label),
              h('span', { className: 'risk-panel__factor-weight' }, `+${factor.weight || factor.impact}`)
            )
          )
        ),

        // Full feedback widget for past days
        isPast && prediction.risk >= 30 && h(FeedbackWidget, {
          predictionType: 'crash_risk',
          predictionId
        })
      );
    }

    /**
     * RiskMeter ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å–ø–∏–¥–æ–º–µ—Ç—Ä —Ä–∏—Å–∫–∞ 0-100%
     */
    function RiskMeter({ risk, riskLevel }) {
      // üîß FIX: –∑–∞—â–∏—Ç–∞ –æ—Ç NaN
      const safeRisk = typeof risk === 'number' && !isNaN(risk) ? Math.min(100, Math.max(0, risk)) : 0;
      const size = 160;
      const strokeWidth = 12;
      const radius = (size - strokeWidth) / 2;
      // –ü–æ–ª—É–∫—Ä—É–≥ (180 –≥—Ä–∞–¥—É—Å–æ–≤)
      const halfCircumference = Math.PI * radius;
      const progress = (safeRisk / 100) * halfCircumference;
      const offset = halfCircumference - progress;

      const colors = {
        low: '#22c55e',
        medium: '#eab308',
        high: '#ef4444'
      };

      return h('div', { className: 'risk-meter', style: { width: size, height: size / 2 + 30 } },
        h('svg', {
          viewBox: `0 0 ${size} ${size / 2 + 20}`,
          className: 'risk-meter__svg'
        },
          // Background arc
          h('path', {
            d: `M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`,
            fill: 'none',
            stroke: 'var(--border-color, #e2e8f0)',
            strokeWidth: strokeWidth,
            strokeLinecap: 'round'
          }),
          // Progress arc
          h('path', {
            d: `M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`,
            fill: 'none',
            stroke: colors[riskLevel] || colors.medium,
            strokeWidth: strokeWidth,
            strokeLinecap: 'round',
            strokeDasharray: halfCircumference,
            strokeDashoffset: offset,
            style: { transition: 'stroke-dashoffset 0.6s ease' }
          }),
          // Value text
          h('text', {
            x: size / 2,
            y: size / 2 - 5,
            textAnchor: 'middle',
            className: 'risk-meter__value',
            style: {
              fontSize: 36,
              fontWeight: 700,
              fill: colors[riskLevel] || 'var(--text-primary)'
            }
          }, `${safeRisk}%`),
          // Label
          h('text', {
            x: size / 2,
            y: size / 2 + 20,
            textAnchor: 'middle',
            className: 'risk-meter__label',
            style: { fontSize: 12, fill: 'var(--text-secondary, #64748b)' }
          }, '–†–∏—Å–∫ —Å—Ä—ã–≤–∞')
        )
      );
    }

    /**
     * ForecastPanel ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–∞ Forecast
     * –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å InsulinWave –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–∫–æ–Ω –µ–¥—ã
     */
    function ForecastPanel({ forecast, isPast }) {
      // üÜï –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
      const [insulinWaveData, setInsulinWaveData] = useState(null);

      useEffect(() => {
        if (window.HEYS?.InsulinWave?.calculate) {
          try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ–ª–Ω—ã
            const waveData = window.HEYS.InsulinWave.getLatestWaveData?.() || null;
            setInsulinWaveData(waveData);
          } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
          }
        }
      }, []);

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ–ª–Ω—ã
      const getWaveEndInfo = () => {
        if (!insulinWaveData) return null;

        const { status, remaining, endTime, currentPhase } = insulinWaveData;

        if (status === 'lipolysis') {
          return {
            status: 'burning',
            label: 'üî• –õ–∏–ø–æ–ª–∏–∑ –∞–∫—Ç–∏–≤–µ–Ω',
            desc: '–°–µ–π—á–∞—Å –∏–¥—ë—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ',
            tone: 'success'
          };
        }

        if (status === 'active' && remaining > 0) {
          return {
            status: 'wave',
            label: `‚è≥ ${remaining} –º–∏–Ω –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ–ª–Ω—ã`,
            desc: `–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤ ${endTime}${currentPhase ? ` ‚Ä¢ –§–∞–∑–∞: ${currentPhase}` : ''}`,
            tone: 'warning'
          };
        }

        if (status === 'almost') {
          return {
            status: 'almost',
            label: `‚ö° ${remaining} –º–∏–Ω –¥–æ –ª–∏–ø–æ–ª–∏–∑–∞`,
            desc: '–°–∫–æ—Ä–æ –Ω–∞—á–Ω—ë—Ç—Å—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ',
            tone: 'info'
          };
        }

        return null;
      };

      const waveEndInfo = getWaveEndInfo();

      return h('div', { className: 'forecast-panel' },
        isPast && h('div', { className: 'forecast-panel__note' },
          'üìä –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è'
        ),

        // üÜï Insulin Wave Status
        waveEndInfo && h('div', {
          className: `forecast-panel__wave-status forecast-panel__wave-status--${waveEndInfo.tone || 'info'}`
        },
          h('div', { className: 'forecast-panel__wave-header' },
            h('div', {
              className: `forecast-panel__wave-label forecast-panel__wave-label--${waveEndInfo.tone || 'info'}`
            },
              waveEndInfo.label
            ),
            h(getInfoButton(), { infoKey: 'INSULIN_WAVE_STATUS', size: 'small' })
          ),
          h('div', { className: 'forecast-panel__wave-desc' }, waveEndInfo.desc)
        ),

        // Energy Windows
        forecast.energyWindows && forecast.energyWindows.length > 0 && h('div', { className: 'forecast-panel__section' },
          h('div', { className: 'forecast-panel__section-header' },
            h('span', { className: 'forecast-panel__section-title' }, '‚ö° –û–∫–Ω–∞ —ç–Ω–µ—Ä–≥–∏–∏'),
            h(getInfoButton(), { infoKey: 'ENERGY_WINDOWS', size: 'small' })
          ),
          h('div', { className: 'forecast-panel__windows' },
            forecast.energyWindows.map((window, idx) =>
              h('div', {
                key: idx,
                className: `forecast-panel__window ${window.optimal ? 'forecast-panel__window--optimal' : ''}`
              },
                h('div', { className: 'forecast-panel__window-period' }, window.period),
                h('div', { className: 'forecast-panel__window-label' }, window.label),
                window.optimal && h('span', { className: 'forecast-panel__window-badge' }, '‚≠ê –û–ø—Ç–∏–º–∞–ª—å–Ω–æ'),
                h('div', { className: 'forecast-panel__window-rec' }, window.recommendation)
              )
            )
          )
        ),

        // Training Window
        forecast.trainingWindow && h('div', { className: 'forecast-panel__section' },
          h('div', { className: 'forecast-panel__section-header' },
            h('span', { className: 'forecast-panel__section-title' }, 'üèãÔ∏è –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏'),
            h(getInfoButton(), { infoKey: 'TRAINING_WINDOW', size: 'small' })
          ),
          h('div', { className: 'forecast-panel__training' },
            h('div', { className: 'forecast-panel__training-time' }, forecast.trainingWindow.time),
            h('div', { className: 'forecast-panel__training-reason' }, forecast.trainingWindow.reason)
          )
        ),

        // üÜï Next Meal Recommendation based on insulin wave
        insulinWaveData && insulinWaveData.status !== 'lipolysis' && h('div', { className: 'forecast-panel__section' },
          h('div', { className: 'forecast-panel__section-header' },
            h('span', { className: 'forecast-panel__section-title' }, 'üçΩÔ∏è –°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏'),
            h(getInfoButton(), { infoKey: 'NEXT_MEAL', size: 'small' })
          ),
          h('div', { className: 'forecast-panel__next-meal' },
            h('div', { className: 'forecast-panel__next-meal-time' },
              insulinWaveData.remaining < 30
                ? '‚ö° –°–∫–æ—Ä–æ –º–æ–∂–Ω–æ –µ—Å—Ç—å!'
                : `–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ—Å–ª–µ ${insulinWaveData.endTime}`
            ),
            h('div', { className: 'forecast-panel__next-meal-tip' },
              insulinWaveData.remaining < 60
                ? '–ü–æ–¥–≥–æ—Ç–æ–≤—å –ª—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å —Å –±–µ–ª–∫–æ–º'
                : '–î–æ–∂–¥–∏—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ–ª–Ω—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —É—Å–≤–æ–µ–Ω–∏—è'
            )
          )
        ),

        // What-if scenarios (placeholder)
        h('div', { className: 'forecast-panel__scenarios' },
          h('div', { className: 'forecast-panel__scenarios-header' },
            h('span', { className: 'forecast-panel__scenarios-title' }, 'üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏'),
            h(getInfoButton(), { infoKey: 'WHATIF_SCENARIOS', size: 'small' })
          ),
          h('div', { className: 'forecast-panel__scenario forecast-panel__scenario--likely' },
            h('span', { className: 'forecast-panel__scenario-emoji' }, 'üìä'),
            h('span', { className: 'forecast-panel__scenario-label' }, '–í–µ—Ä–æ—è—Ç–Ω—ã–π'),
            h('span', { className: 'forecast-panel__scenario-desc' }, forecast.likelyOutcome || '–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–µ–Ω—å')
          ),
          h('div', { className: 'forecast-panel__scenario forecast-panel__scenario--optimistic' },
            h('span', { className: 'forecast-panel__scenario-emoji' }, 'üåü'),
            h('span', { className: 'forecast-panel__scenario-label' }, '–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π'),
            h('span', { className: 'forecast-panel__scenario-desc' }, forecast.optimisticOutcome || '–ü—Ä–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞')
          )
        )
      );
    }

    // PhenotypePanel –∏ PhenotypeRadar –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ heys_phenotype_v1.js
    // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.Phenotype.PhenotypeWidget

    /**
     * FeedbackWidget ‚Äî –≤–∏–¥–∂–µ—Ç –¥–ª—è —Å–±–æ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø–æ –ø—Ä–æ–≥–Ω–æ–∑–∞–º
     * –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å HEYS.Metabolic.submitFeedback
     */
    function FeedbackWidget({ predictionType, predictionId, onSubmit }) {
      const [submitted, setSubmitted] = useState(false);
      const [showDetails, setShowDetails] = useState(false);
      const [detailText, setDetailText] = useState('');

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
      const stats = useMemo(() => {
        if (HEYS.Metabolic?.getFeedbackStats) {
          return HEYS.Metabolic.getFeedbackStats();
        }
        return { total: 0, accuracy: 0 };
      }, []);

      const handleFeedback = (correct) => {
        if (HEYS.Metabolic?.submitFeedback) {
          const details = detailText ? { comment: detailText } : {};
          HEYS.Metabolic.submitFeedback(predictionId, correct, {
            ...details,
            type: predictionType
          });
        }
        setSubmitted(true);
        if (onSubmit) onSubmit(correct);
      };

      if (submitted) {
        return h('div', { className: 'feedback-widget feedback-widget--submitted' },
          h('span', { className: 'feedback-widget__thanks' }, '‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!'),
          stats.total > 5 && h('span', { className: 'feedback-widget__accuracy' },
            `–¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: ${stats.accuracy}%`
          )
        );
      }

      return h('div', { className: 'feedback-widget' },
        h('div', { className: 'feedback-widget__question' },
          'üéØ –ü—Ä–æ–≥–Ω–æ–∑ –æ–∫–∞–∑–∞–ª—Å—è —Ç–æ—á–Ω—ã–º?'
        ),

        h('div', { className: 'feedback-widget__buttons' },
          h('button', {
            className: 'feedback-widget__btn feedback-widget__btn--yes',
            onClick: () => handleFeedback(true)
          }, 'üëç –î–∞'),
          h('button', {
            className: 'feedback-widget__btn feedback-widget__btn--no',
            onClick: () => setShowDetails(true)
          }, 'üëé –ù–µ—Ç'),
          h('button', {
            className: 'feedback-widget__btn feedback-widget__btn--skip',
            onClick: () => setSubmitted(true)
          }, '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å')
        ),

        showDetails && h('div', { className: 'feedback-widget__details' },
          h('textarea', {
            className: 'feedback-widget__textarea',
            placeholder: '–ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)',
            value: detailText,
            onChange: (e) => setDetailText(e.target.value),
            rows: 2
          }),
          h('button', {
            className: 'feedback-widget__submit',
            onClick: () => handleFeedback(false)
          }, '–û—Ç–ø—Ä–∞–≤–∏—Ç—å')
        ),

        stats.total > 0 && h('div', { className: 'feedback-widget__stats' },
          `üìä –û—Ç–∑—ã–≤–æ–≤: ${stats.total} ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: ${stats.accuracy}%`
        )
      );
    }

    /**
     * FeedbackPrompt ‚Äî inline prompt –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
     * –ú–µ–Ω—å—à–µ —á–µ–º FeedbackWidget, –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∏
     */
    function FeedbackPrompt({ predictionId, type, compact = false }) {
      const [voted, setVoted] = useState(false);

      const handleVote = (correct) => {
        if (HEYS.Metabolic?.submitFeedback) {
          HEYS.Metabolic.submitFeedback(predictionId, correct, { type });
        }
        setVoted(true);
      };

      if (voted) {
        return h('span', { className: 'feedback-prompt feedback-prompt--voted' }, '‚úì');
      }

      return h('div', { className: `feedback-prompt ${compact ? 'feedback-prompt--compact' : ''}` },
        h('button', {
          className: 'feedback-prompt__btn feedback-prompt__btn--up',
          onClick: () => handleVote(true),
          title: '–ü—Ä–æ–≥–Ω–æ–∑ —Ç–æ—á–Ω—ã–π'
        }, 'üëç'),
        h('button', {
          className: 'feedback-prompt__btn feedback-prompt__btn--down',
          onClick: () => handleVote(false),
          title: '–ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ—Ç–æ—á–Ω—ã–π'
        }, 'üëé')
      );
    }

    /**
     * AccuracyBadge ‚Äî –±–µ–π–¥–∂ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é —Å–∏—Å—Ç–µ–º—ã
     */
    function AccuracyBadge() {
      const stats = useMemo(() => {
        if (HEYS.Metabolic?.getFeedbackStats) {
          return HEYS.Metabolic.getFeedbackStats();
        }
        return { total: 0, accuracy: 0 };
      }, []);

      if (stats.total < 5) return null;

      const color = stats.accuracy >= 80 ? '#22c55e' : stats.accuracy >= 60 ? '#eab308' : '#ef4444';

      return h('div', {
        className: 'accuracy-badge',
        style: { borderColor: color },
        title: `–ù–∞ –æ—Å–Ω–æ–≤–µ ${stats.total} –æ—Ç–∑—ã–≤–æ–≤`
      },
        h('span', { className: 'accuracy-badge__icon' }, 'üéØ'),
        h('span', { className: 'accuracy-badge__value', style: { color } }, `${stats.accuracy}%`),
        h('span', { className: 'accuracy-badge__label' }, '—Ç–æ—á–Ω–æ—Å—Ç—å')
      );
    }

    // Legacy PredictiveDashboard wrapper for backward compatibility (stub for now)
    function PredictiveDashboardLegacy({ lsGet, profile, selectedDate }) {
      // Legacy stub - main dashboard logic in main file
      return null;
    }

    /**
     * DataCompletenessCard ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
     * –∏ –∫–∞–∫–∏–µ —Ñ–∏—á–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏
     */
    function DataCompletenessCard({ lsGet, profile, daysRequired = 30 }) {
      const completeness = useMemo(() => {
        if (!HEYS.Metabolic?.getDaysHistory) return null;

        const history = HEYS.Metabolic.getDaysHistory(daysRequired);
        const daysWithData = history.length;
        const percentage = Math.round((daysWithData / daysRequired) * 100);
        const daysRemaining = Math.max(0, daysRequired - daysWithData);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–Ω–æ—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è (—Å–µ–≥–æ–¥–Ω—è)
        const today = new Date().toISOString().split('T')[0];
        const inventory = HEYS.Metabolic.inventoryData ? HEYS.Metabolic.inventoryData(today) : null;
        const todayCompleteness = inventory ? HEYS.Metabolic.calculateDataCompleteness(inventory) : 0;

        // üÜï v3.22.0: Extended Analytics features —Å –Ω–∞—É—á–Ω—ã–º–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è–º–∏
        const features = [
          { name: '–ë–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å', required: 1, emoji: 'üìä', unlocked: daysWithData >= 1 },
          { name: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞', required: 3, emoji: '‚ö†Ô∏è', unlocked: daysWithData >= 3 },
          { name: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', required: 7, emoji: 'üîç', unlocked: daysWithData >= 7 },
          {
            name: 'üß† –≠–º–æ—Ü. —Ä–∏—Å–∫',
            required: 7,
            emoji: 'üß†',
            unlocked: daysWithData >= 7,
            pmid: '11070333',
            science: 'Epel 2001 ‚Äî —Å—Ç—Ä–µ—Å—Å-–ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ'
          },
          {
            name: 'ü•© –ë–µ–ª–∫–æ–≤—ã–π –¥–æ–ª–≥',
            required: 7,
            emoji: 'ü•©',
            unlocked: daysWithData >= 7,
            pmid: '20095013',
            science: 'Mettler 2010 ‚Äî –±–µ–ª–æ–∫ –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ'
          },
          { name: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏', required: 14, emoji: 'üéØ', unlocked: daysWithData >= 14 },
          {
            name: 'üî¨ –¶–∏—Ä–∫–∞–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç',
            required: 14,
            emoji: 'üåÖ',
            unlocked: daysWithData >= 14,
            pmid: '9331550',
            science: 'Van Cauter 1997 ‚Äî —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã'
          },
          { name: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø', required: 30, emoji: 'üß¨', unlocked: daysWithData >= 30 }
        ];

        const nextFeature = features.find(f => !f.unlocked);

        // üÜï –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ extended analytics —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
        const extendedFeatures = features.filter(f => f.pmid);
        const extendedUnlocked = extendedFeatures.filter(f => f.unlocked).length;
        const extendedTotal = extendedFeatures.length;

        return {
          daysWithData,
          daysRequired,
          percentage,
          daysRemaining,
          todayCompleteness,
          features,
          nextFeature,
          extendedUnlocked,
          extendedTotal
        };
      }, [lsGet, daysRequired]);

      if (!completeness) {
        return null;
      }

      return h('div', { className: 'data-completeness-card' },
        h('div', { className: 'data-completeness-card__header' },
          h('span', { className: 'data-completeness-card__icon' }, 'üìä'),
          h('span', { className: 'data-completeness-card__title' }, '–î–∞–Ω–Ω—ã–µ'),
          h('span', { className: 'data-completeness-card__count' },
            `${completeness.daysWithData}/${completeness.daysRequired} –¥–Ω–µ–π`
          )
        ),

        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        h('div', { className: 'data-completeness-card__progress' },
          h('div', { className: 'data-completeness-card__progress-bar' },
            h('div', {
              className: 'data-completeness-card__progress-fill',
              style: { width: `${completeness.percentage}%` }
            })
          ),
          h('span', { className: 'data-completeness-card__progress-text' }, `${completeness.percentage}%`)
        ),

        // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –ø–æ–ª–Ω–æ—Ç–∞
        h('div', { className: 'data-completeness-card__today' },
          h('span', { className: 'data-completeness-card__today-label' }, '–°–µ–≥–æ–¥–Ω—è: '),
          h('span', {
            className: `data-completeness-card__today-value data-completeness-card__today-value--${completeness.todayCompleteness >= 80 ? 'high' : completeness.todayCompleteness >= 50 ? 'medium' : 'low'}`
          }, `${completeness.todayCompleteness}% –∑–∞–ø–æ–ª–Ω–µ–Ω–æ`)
        ),

        // üÜï v3.22.0: Extended Analytics Status
        h('div', { className: 'data-completeness-card__extended' },
          h('span', { className: 'data-completeness-card__extended-label' }, 'üß† Extended Analytics: '),
          h('span', {
            className: `data-completeness-card__extended-value data-completeness-card__extended-value--${completeness.extendedUnlocked === completeness.extendedTotal ? 'complete' : 'partial'}`
          }, `${completeness.extendedUnlocked}/${completeness.extendedTotal}`),
          completeness.extendedUnlocked === completeness.extendedTotal && h('span', { className: 'data-completeness-card__extended-badge' }, '‚úì')
        ),

        // –°–ª–µ–¥—É—é—â–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
        completeness.nextFeature && h('div', { className: 'data-completeness-card__next' },
          h('span', { className: 'data-completeness-card__next-emoji' }, completeness.nextFeature.emoji),
          h('span', { className: 'data-completeness-card__next-text' },
            `${completeness.nextFeature.name} —á–µ—Ä–µ–∑ ${completeness.nextFeature.required - completeness.daysWithData} –¥–Ω.`
          ),
          completeness.nextFeature.pmid && h('a', {
            href: `https://pubmed.ncbi.nlm.nih.gov/${completeness.nextFeature.pmid}/`,
            target: '_blank',
            className: 'data-completeness-card__next-pmid',
            title: completeness.nextFeature.science
          }, 'üî¨')
        ),

        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏—á–∏ (–∏–∫–æ–Ω–∫–∏) ‚Äî üÜï —Å tooltip –¥–ª—è extended
        h('div', { className: 'data-completeness-card__features' },
          completeness.features.map((feature, idx) =>
            h('div', {
              key: idx,
              className: `data-completeness-card__feature ${feature.unlocked ? 'data-completeness-card__feature--unlocked' : ''} ${feature.pmid ? 'data-completeness-card__feature--science' : ''}`,
              title: `${feature.name} (${feature.required} –¥–Ω–µ–π)${feature.science ? '\n' + feature.science : ''}`
            }, feature.emoji)
          )
        )
      );
    }

    /**
     * MealTimingCard v2 ‚Äî WOW –¥–∏–∑–∞–π–Ω —Å timeline –∏ –∏–∫–æ–Ω–∫–∞–º–∏
     */
    function MealTimingCard({ lsGet, profile, selectedDate }) {
      const timing = useMemo(() => {
        if (!HEYS.Metabolic?.calculatePerformanceForecast) return null;

        const history = HEYS.Metabolic.getDaysHistory ? HEYS.Metabolic.getDaysHistory(7) : [];

        return HEYS.Metabolic.calculatePerformanceForecast(
          selectedDate || new Date().toISOString().split('T')[0],
          profile || window.HEYS?.utils?.lsGet?.('heys_profile', {}),
          history
        );
      }, [lsGet, profile, selectedDate]);

      if (!timing || !timing.optimalMeals) {
        return null;
      }

      // –ö–æ–Ω—Ñ–∏–≥ –∏–∫–æ–Ω–æ–∫ –∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Ç–∏–ø–æ–≤ –ø—Ä–∏—ë–º–æ–≤
      const mealConfig = {
        '–ó–∞–≤—Ç—Ä–∞–∫': { icon: 'üåÖ', gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)', lightBg: '#fef3c7' },
        '–û–±–µ–¥': { icon: '‚òÄÔ∏è', gradient: 'linear-gradient(135deg, #34d399 0%, #10b981 100%)', lightBg: '#d1fae5' },
        '–£–∂–∏–Ω': { icon: 'üåô', gradient: 'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)', lightBg: '#e0e7ff' },
        '–ü–µ—Ä–µ–∫—É—Å': { icon: 'üçé', gradient: 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)', lightBg: '#fce7f3' }
      };

      const getMealConfig = (name) => {
        for (const [key, config] of Object.entries(mealConfig)) {
          if (name.toLowerCase().includes(key.toLowerCase())) return config;
        }
        return { icon: 'üçΩÔ∏è', gradient: 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)', lightBg: '#f1f5f9' };
      };

      // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ "—Å–µ–π—á–∞—Å"
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();

      return h('div', { className: 'meal-timing-v2' },
        // Header —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
        h('div', { className: 'meal-timing-v2__header' },
          h('div', { className: 'meal-timing-v2__header-icon' }, '‚è∞'),
          h('div', { className: 'meal-timing-v2__header-content' },
            h('h3', { className: 'meal-timing-v2__title' }, '–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å'),
            h('p', { className: 'meal-timing-v2__subtitle' }, '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–≥–æ —Ä–∏—Ç–º–∞')
          )
        ),

        // Timeline —Å –ø—Ä–∏—ë–º–∞–º–∏
        h('div', { className: 'meal-timing-v2__timeline' },
          timing.optimalMeals.filter(m => m.priority !== 'low').map((meal, idx, arr) => {
            const config = getMealConfig(meal.name);
            const [startHour] = meal.time.split('-')[0].split(':').map(Number);
            const isNow = currentHour >= startHour && currentHour < startHour + 2;
            const isPast = currentHour > startHour + 2;

            return h('div', {
              key: idx,
              className: `meal-timing-v2__item ${isNow ? 'meal-timing-v2__item--active' : ''} ${isPast ? 'meal-timing-v2__item--past' : ''}`
            },
              // Timeline connector
              idx < arr.length - 1 && h('div', { className: 'meal-timing-v2__connector' }),

              // Time badge
              h('div', { className: 'meal-timing-v2__time-badge', style: { background: config.gradient } },
                h('span', { className: 'meal-timing-v2__time' }, meal.time.split('-')[0])
              ),

              // Card content
              h('div', { className: 'meal-timing-v2__card', style: { '--accent-bg': config.lightBg } },
                h('div', { className: 'meal-timing-v2__card-header' },
                  h('span', { className: 'meal-timing-v2__card-icon' }, config.icon),
                  h('div', { className: 'meal-timing-v2__card-title' },
                    h('span', { className: 'meal-timing-v2__card-name' }, meal.name),
                    isNow && h('span', { className: 'meal-timing-v2__now-badge' }, '‚óè –°–ï–ô–ß–ê–°')
                  )
                ),
                h('div', { className: 'meal-timing-v2__card-body' },
                  h('p', { className: 'meal-timing-v2__card-focus' }, meal.focus),
                  h('div', { className: 'meal-timing-v2__card-meta' },
                    h('span', { className: 'meal-timing-v2__card-pct' },
                      h('span', { className: 'meal-timing-v2__pct-value' }, `${meal.caloriesPct}%`),
                      ' –¥–Ω–µ–≤–Ω—ã—Ö –∫–∫–∞–ª'
                    ),
                    meal.priority === 'high' && h('span', { className: 'meal-timing-v2__priority-badge' }, '‚≠ê –í–∞–∂–Ω–æ')
                  )
                )
              )
            );
          })
        ),

        // –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–µ –æ–∫–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        timing.trainingWindow && h('div', { className: 'meal-timing-v2__training' },
          h('div', { className: 'meal-timing-v2__training-icon' }, 'üí™'),
          h('div', { className: 'meal-timing-v2__training-content' },
            h('div', { className: 'meal-timing-v2__training-title' }, '–ü–∏–∫ —Å–∏–ª—ã –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏'),
            h('div', { className: 'meal-timing-v2__training-time' }, timing.trainingWindow.time),
            h('div', { className: 'meal-timing-v2__training-reason' }, timing.trainingWindow.reason)
          )
        ),

        // Sleep impact chip
        h('div', { className: `meal-timing-v2__sleep meal-timing-v2__sleep--${timing.sleepImpact}` },
          h('span', { className: 'meal-timing-v2__sleep-icon' },
            timing.sleepImpact === 'positive' ? 'üò¥' : '‚ö†Ô∏è'
          ),
          h('span', { className: 'meal-timing-v2__sleep-text' },
            timing.sleepImpact === 'positive'
              ? '–°–æ–Ω –≤ –Ω–æ—Ä–º–µ ‚Äî —ç–Ω–µ—Ä–≥–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å'
              : '–ù–µ–¥–æ—Å—ã–ø ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ª—ë–≥–∫–∏–π –¥–µ–Ω—å'
          ),
          timing.sleepImpact === 'positive' && h('span', { className: 'meal-timing-v2__sleep-check' }, '‚úì')
        )
      );
    }

    /**
     * üÜï Early Warning Badge ‚Äî notification badge for health warnings
     * v3.5.0: Integrated with pi_early_warning.js module
     */
    function EarlyWarningBadge({ onClick }) {
      const [warnings, setWarnings] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadWarnings();
        // Refresh every 5 minutes
        const interval = setInterval(loadWarnings, 5 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      function loadWarnings() {
        try {
          const earlyWarning = HEYS.InsightsPI?.earlyWarning;
          if (!earlyWarning || typeof earlyWarning.detect !== 'function') {
            devWarn('[EarlyWarningBadge] earlyWarning module not loaded');
            setLoading(false);
            return;
          }

          const U = window.HEYS?.utils;
          const getter = U?.lsGet || ((k, d) => {
            try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
          });
          const days = Object.keys(localStorage)
            .filter(k => k.startsWith('heys_dayv2_'))
            .map(k => getter(k, {}))
            .filter(d => d && d.date);
          const profile = getter('heys_profile', {});
          const pIndex = window.HEYS?.products?.getIndex?.();

          const result = earlyWarning.detect(days, profile, pIndex);
          devLog('[EarlyWarningBadge] Detected warnings:', result);

          if (result.available) {
            setWarnings(result.warnings || []);
          }
        } catch (error) {
          devWarn('[EarlyWarningBadge] Error detecting warnings:', error);
        } finally {
          setLoading(false);
        }
      }

      const warningCount = warnings.length;
      if (warningCount === 0 || loading) return null;

      const severityColors = {
        high: 'bg-red-500 text-white',
        medium: 'bg-yellow-500 text-white',
        low: 'bg-gray-400 text-white'
      };

      const highCount = warnings.filter(w => w.severity === 'high').length;
      const mediumCount = warnings.filter(w => w.severity === 'medium').length;
      const badgeColor = highCount > 0 ? 'bg-red-500' : 'bg-yellow-500';

      return h('button', {
        className: `relative px-3 py-1.5 rounded-lg ${badgeColor} text-white text-sm font-medium flex items-center gap-2 hover:opacity-90 transition-opacity`,
        onClick: onClick,
        'aria-label': `${warningCount} health warnings`
      },
        h('span', { className: 'text-lg' }, 'üö®'),
        h('span', null, warningCount),
        (highCount > 0 || mediumCount > 0) && h('div', { className: 'absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center text-xs font-bold text-red-600' },
          highCount || mediumCount
        )
      );
    }

    /**
     * üÜï Early Warning Panel ‚Äî detailed view of health warnings
     * v3.5.0: Integrated with pi_early_warning.js module
     */
    function EarlyWarningPanel({ warnings, onClose }) {
      if (!warnings || warnings.length === 0) {
        return h('div', { className: 'early-warning-panel' },
          h('div', { className: 'text-center p-8 text-gray-500' },
            h('div', { className: 'text-4xl mb-2' }, '‚úÖ'),
            h('div', { className: 'text-lg font-medium' }, 'All clear!'),
            h('div', { className: 'text-sm mt-1' }, 'No health warnings detected')
          )
        );
      }

      const grouped = warnings.reduce((acc, w) => {
        acc[w.severity] = acc[w.severity] || [];
        acc[w.severity].push(w);
        return acc;
      }, {});

      const severityOrder = ['high', 'medium', 'low'];
      const severityConfig = {
        high: { icon: 'üî¥', label: 'High Priority', border: 'border-red-500', bg: 'bg-red-50' },
        medium: { icon: 'üü°', label: 'Medium Priority', border: 'border-yellow-500', bg: 'bg-yellow-50' },
        low: { icon: '‚ö™', label: 'Low Priority', border: 'border-gray-400', bg: 'bg-gray-50' }
      };

      return h('div', { className: 'early-warning-panel space-y-4 p-6 bg-white rounded-lg shadow-lg max-w-2xl mx-auto' },
        // Header
        h('div', { className: 'flex items-center justify-between mb-4' },
          h('h3', { className: 'text-xl font-bold text-gray-900' }, 'üö® Health Warnings'),
          onClose && h('button', {
            onClick: onClose,
            className: 'text-gray-400 hover:text-gray-600'
          }, '‚úï')
        ),

        // Grouped warnings by severity
        severityOrder.filter(s => grouped[s]).map(severity => {
          const config = severityConfig[severity];
          return h('div', { key: severity, className: `border-l-4 ${config.border} ${config.bg} p-4 rounded-r-lg space-y-3` },
            h('div', { className: 'flex items-center gap-2 font-medium text-gray-900 mb-2' },
              h('span', null, config.icon),
              h('span', null, config.label),
              h('span', { className: 'text-sm text-gray-500' }, `(${grouped[severity].length})`)
            ),

            grouped[severity].map((warning, idx) =>
              h('div', { key: idx, className: 'bg-white p-3 rounded border border-gray-200' },
                h('div', { className: 'font-medium text-gray-900 mb-1' }, warning.message),
                h('div', { className: 'text-sm text-gray-600 mb-2' }, warning.detail),
                warning.action && h('button', {
                  className: 'text-sm text-blue-600 hover:text-blue-800 font-medium',
                  onClick: () => devLog('[EarlyWarning] Action clicked:', warning.action)
                }, `‚Üí ${warning.action}`)
              )
            )
          );
        })
      );
    }

    // === EXPORT ===
    HEYS.InsightsPI = HEYS.InsightsPI || {};
    HEYS.InsightsPI.uiDashboard = {
      // Main entry points
      InsightsTab,
      PredictiveDashboard,
      // Weekly/Weight
      WeeklyWrap,
      WeightPrediction,
      // Filters & Bars
      PriorityFilterBar,
      PillarBreakdownBars,
      // Risk components
      DualRiskPanel,
      RiskPanel,
      RiskMeter,
      // Forecast & Feedback
      ForecastPanel,
      FeedbackPrompt,
      FeedbackWidget,
      AccuracyBadge,
      // Legacy
      PredictiveDashboardLegacy,
      EmptyState,
      // Cards
      MealTimingCard,
      DataCompletenessCard,
      InsightsCard,
      // Badges
      PriorityBadge,
      CategoryBadge,
      ActionabilityBadge,
      ConfidenceBadge,
      // UI helpers
      SectionHeader,
      InfoButton,
      MetricWithInfo,
      // Metabolic cards
      MetabolicStatusCard,
      ReasonCard,
      ActionCard,
      // üÜï v3.5.0: Early Warning System (EWS)
      EarlyWarningBadge,
      EarlyWarningPanel
    };

    // Backward compatibility fallback
    window.piUIDashboard = HEYS.InsightsPI.uiDashboard;

    devLog('[PI UI Dashboard] v3.0.1 loaded ‚Äî', Object.keys(HEYS.InsightsPI.uiDashboard).length, 'dashboard components');
  }

  // Start initialization (will retry until React is available)
  initModule();

})(window);


/* ===== insights/pi_pattern_debugger.js ===== */
// pi_pattern_debugger.js ‚Äî Pattern Transparency Modal v1.0.0
// –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –º–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏–Ω—Å–∞–π—Ç–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∏—Ö —Å—Ç–∞—Ç—É—Å—ã –∏ –¥–∞–Ω–Ω—ã–µ
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.InsightsPI = HEYS.InsightsPI || {};

  // React imports
  const { createElement: h, useState, useMemo } = window.React || {};

  /**
   * Pattern metadata ‚Äî –º–∞–ø–ø–∏–Ω–≥ ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
   */
  const PATTERN_METADATA = {
    // Nutrition
    meal_quality: { name: '–î–∏–Ω–∞–º–∏–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞', category: 'nutrition', emoji: 'üìà' },
    nutrition_quality: { name: '–ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è', category: 'nutrition', emoji: 'ü•ó' },
    protein_satiety: { name: '–ë–µ–ª–æ–∫ –∏ —Å—ã—Ç–æ—Å—Ç—å', category: 'nutrition', emoji: 'ü•©' },
    fiber_regularity: { name: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞', category: 'nutrition', emoji: 'ü•¨' },
    gut_health: { name: '–ó–¥–æ—Ä–æ–≤—å–µ –∫–∏—à–µ—á–Ω–∏–∫–∞', category: 'nutrition', emoji: 'ü¶†' },
    hydration: { name: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è', category: 'nutrition', emoji: 'üíß' },
    micronutrient_radar: { name: '–ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã', category: 'nutrition', emoji: 'üéØ' },
    omega_balancer: { name: '–û–º–µ–≥–∞-–±–∞–ª–∞–Ω—Å', category: 'nutrition', emoji: 'üêü' },
    nova_quality: { name: 'NOVA –∫–∞—á–µ—Å—Ç–≤–æ', category: 'nutrition', emoji: 'üè≠' },

    // Timing
    meal_timing: { name: '–¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤', category: 'timing', emoji: '‚è∞' },
    wave_overlap: { name: '–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –≤–æ–ª–Ω', category: 'timing', emoji: 'üåä' },
    late_eating: { name: '–ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω', category: 'timing', emoji: 'üåô' },
    circadian: { name: '–¶–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º', category: 'timing', emoji: '‚òÄÔ∏è' },
    nutrient_timing: { name: '–ù—É—Ç—Ä–∏–µ–Ω—Ç-—Ç–∞–π–º–∏–Ω–≥', category: 'timing', emoji: '‚ö°' },
    weekend_effect: { name: '–≠—Ñ—Ñ–µ–∫—Ç –≤—ã—Ö–æ–¥–Ω—ã—Ö', category: 'timing', emoji: 'üéâ' },

    // Activity
    training_kcal: { name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫–∫–∞–ª', category: 'activity', emoji: 'üèãÔ∏è' },
    steps_weight: { name: '–®–∞–≥–∏ –∏ –≤–µ—Å', category: 'activity', emoji: 'üë£' },
    neat_activity: { name: 'NEAT –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', category: 'activity', emoji: 'üö∂' },
    training_recovery: { name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', category: 'activity', emoji: 'üí™' },

    // Recovery
    sleep_weight: { name: '–°–æ–Ω –∏ –≤–µ—Å', category: 'recovery', emoji: 'üò¥' },
    sleep_hunger: { name: '–°–æ–Ω –∏ –≥–æ–ª–æ–¥', category: 'recovery', emoji: 'üõå' },
    stress_eating: { name: '–°—Ç—Ä–µ—Å—Å-–µ–¥–∞', category: 'recovery', emoji: 'üò∞' },
    mood_food: { name: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ-–µ–¥–∞', category: 'recovery', emoji: 'üòä' },
    mood_trajectory: { name: '–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', category: 'recovery', emoji: 'üìâ' },
    sleep_quality: { name: '–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞', category: 'recovery', emoji: 'üåü' },
    wellbeing_correlation: { name: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ', category: 'recovery', emoji: '‚ú®' },
    cycle_impact: { name: '–¶–∏–∫–ª (–∂–µ–Ω—â–∏–Ω—ã)', category: 'recovery', emoji: 'üå∏' },

    // Metabolism
    insulin_sensitivity: { name: '–ò–Ω—Å—É–ª–∏–Ω', category: 'metabolism', emoji: 'üíâ' },
    body_composition: { name: '–°–æ—Å—Ç–∞–≤ —Ç–µ–ª–∞', category: 'metabolism', emoji: '‚öñÔ∏è' },
    heart_health: { name: '–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–¥—Ü–∞', category: 'metabolism', emoji: '‚ù§Ô∏è' },
    hypertrophy: { name: '–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è (—Å–ø–æ—Ä—Ç)', category: 'metabolism', emoji: 'üí™' },

    // NEW v6.0 (C13-C22)
    vitamin_defense: { name: '–í–∏—Ç–∞–º–∏–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞', category: 'nutrition', emoji: 'üõ°Ô∏è' },
    b_complex_anemia: { name: 'B-–∫–æ–º–ø–ª–µ–∫—Å –∏ –∞–Ω–µ–º–∏—è', category: 'metabolism', emoji: 'ü©∏' },
    glycemic_load: { name: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞', category: 'metabolism', emoji: 'üìä' },
    protein_distribution: { name: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞', category: 'nutrition', emoji: 'üç≥' },
    antioxidant_defense: { name: '–ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã', category: 'recovery', emoji: 'ü´ê' },
    added_sugar_dependency: { name: '–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä', category: 'metabolism', emoji: 'üç¨' },
    bone_health: { name: '–ó–¥–æ—Ä–æ–≤—å–µ –∫–æ—Å—Ç–µ–π', category: 'recovery', emoji: 'ü¶¥' },
    training_type_match: { name: '–ü–∏—Ç–∞–Ω–∏–µ –ø–æ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', category: 'activity', emoji: 'üéØ' },
    electrolyte_homeostasis: { name: '–≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å', category: 'recovery', emoji: '‚ö°' },
    nutrient_density: { name: '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤', category: 'nutrition', emoji: 'üî¨' }
  };

  const CATEGORY_LABELS = {
    nutrition: { label: '–ü–∏—Ç–∞–Ω–∏–µ', emoji: 'ü•ó', color: '#10b981' },
    timing: { label: '–¢–∞–π–º–∏–Ω–≥', emoji: '‚è∞', color: '#3b82f6' },
    activity: { label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', emoji: 'üèÉ', color: '#f59e0b' },
    recovery: { label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', emoji: 'üò¥', color: '#8b5cf6' },
    metabolism: { label: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', emoji: 'üî•', color: '#ef4444' }
  };

  /**
   * –ú–∞–ø–ø–∏–Ω–≥ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ adaptive thresholds
   */
  const PATTERN_THRESHOLDS_MAP = {
    meal_timing: ['idealMealGapMin'],
    late_eating: ['lateEatingHour'],
    nutrition_quality: ['fiberTarget'],
    circadian: ['circadianShift'],
    nutrient_timing: ['morningProteinG'],
    insulin_sensitivity: ['giOptimal'],
    protein_distribution: ['proteinPerMealG']
  };

  /**
   * –ö—Ä–∞—Å–∏–≤—ã–µ –ª–µ–π–±–ª—ã –¥–ª—è –ø–æ—Ä–æ–≥–æ–≤
   */
  const THRESHOLD_LABELS = {
    lateEatingHour: '–ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω',
    idealMealGapMin: '–ò–Ω—Ç–µ—Ä–≤–∞–ª',
    giOptimal: 'GI‚Üì',
    morningProteinG: '–ë–µ–ª–æ–∫üåÖ',
    fiberTarget: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞',
    proteinPerMealG: '–ë–µ–ª–æ–∫/–ø—Ä–∏—ë–º',
    circadianShift: '–•—Ä–æ–Ω–æ—Ç–∏–ø'
  };

  const REASON_LABELS = {
    'module_not_loaded': '–ú–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω',
    'insufficient_data': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö',
    'not_enough_days': '–ú–∞–ª–æ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö',
    'min_days_required': '–ú–∞–ª–æ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö',
    'min-data': '–ú–∞–ª–æ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö',
    'min-products': '–ú–∞–ª–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ —Ä–∞—Ü–∏–æ–Ω–µ',
    'min_meals_required': '–ú–∞–ª–æ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏',
    'min_trainings_required': '–ú–∞–ª–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
    'no_meals': '–ù–µ—Ç –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏',
    'no_training': '–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
    'no_sleep': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–Ω–µ',
    'no_weight': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ',
    'no_measurements': '–ù–µ—Ç –∑–∞–º–µ—Ä–æ–≤ —Ç–µ–ª–∞',
    'no_cycle_data': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ü–∏–∫–ª–µ',
    'no_micronutrients': '–ù–µ—Ç –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
    'no_quality_function': '–§—É–Ω–∫—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞',
    'no_mood_data': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏',
    'no_stress_data': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç—Ä–µ—Å—Å–µ',
    'no_steps_data': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —à–∞–≥–∞—Ö',
    'no_household_data': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
    'no_sleep_quality': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—á–µ—Å—Ç–≤–µ —Å–Ω–∞',
    'male_only': '–¢–æ–ª—å–∫–æ –¥–ª—è –º—É–∂—á–∏–Ω',
    'female_only': '–¢–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω',
    'pindex_required': '–¢—Ä–µ–±—É–µ—Ç—Å—è pIndex'
  };

  const REASON_SHORT = {
    module_not_loaded: '–º–æ–¥—É–ª—å',
    insufficient_data: '–º–∞–ª–æ',
    not_enough_days: '–º–∞–ª–æ',
    min_days_required: '–º–∞–ª–æ',
    min_data: '–º–∞–ª–æ',
    min_products: '–º–∞–ª–æ',
    min_meals_required: '–º–∞–ª–æ',
    min_trainings_required: '–º–∞–ª–æ',
    no_meals: '–Ω–µ—Ç –µ–¥—ã',
    no_training: '–Ω–µ—Ç —Ç—Ä–µ–Ω.',
    no_sleep: '–Ω–µ—Ç —Å–Ω–∞',
    no_weight: '–Ω–µ—Ç –≤–µ—Å–∞',
    no_measurements: '–Ω–µ—Ç –∑–∞–º.',
    no_cycle_data: '–Ω–µ—Ç —Ü–∏–∫–ª–∞',
    no_micronutrients: '–Ω–µ—Ç –º–∏–∫—Ä–æ',
    no_mood_data: '–Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ—è',
    no_stress_data: '–Ω–µ—Ç —Å—Ç—Ä–µ—Å—Å–∞',
    no_steps_data: '–Ω–µ—Ç —à–∞–≥–æ–≤',
    no_household_data: '–Ω–µ—Ç –±—ã—Ç–∞',
    no_sleep_quality: '–Ω–µ—Ç —Å–Ω–∞',
    male_only: '–º—É–∂.',
    female_only: '–∂–µ–Ω.',
    pindex_required: 'pIndex'
  };

  const QUICK_ACTIONS_BY_REASON = {
    no_training: { action: 'open_training', label: '–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É' },
    no_steps_data: { action: 'open_steps', label: '–£–∫–∞–∑–∞—Ç—å —à–∞–≥–∏' },
    no_household_data: { action: 'open_household', label: '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
    no_sleep_quality: { action: 'open_sleep_quality', label: '–û—Ü–µ–Ω–∏—Ç—å —Å–æ–Ω' },
    no_measurements: { action: 'open_measurements', label: '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä—ã' },
    no_weight: { action: 'open_weight', label: '–£–∫–∞–∑–∞—Ç—å –≤–µ—Å' }
  };

  const QUICK_ACTION_META = {
    open_training: { emoji: 'üèãÔ∏è', noun: '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏' },
    open_steps: { emoji: 'üë£', noun: '—à–∞–≥–æ–≤' },
    open_household: { emoji: 'üö∂', noun: '–±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏' },
    open_sleep_quality: { emoji: 'üåô', noun: '–∫–∞—á–µ—Å—Ç–≤–∞ —Å–Ω–∞' },
    open_measurements: { emoji: 'üìè', noun: '–∑–∞–º–µ—Ä–æ–≤ —Ç–µ–ª–∞' },
    open_weight: { emoji: '‚öñÔ∏è', noun: '–≤–µ—Å–∞' }
  };

  /**
   * PatternDebugModal ‚Äî –º–æ–¥–∞–ª–∫–∞ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ–π –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
   * v3.0: —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –ø–µ—Ä–∏–æ–¥–æ–≤ 7/30 –¥–Ω–µ–π
   * @param {object} root0
   * @param {Function} root0.lsGet
   * @param {object} root0.profile
   * @param {object} root0.pIndex
   * @param {object} root0.optimum
   * @param {Function} root0.onClose
   * @returns {object}
   */
  function PatternDebugModal({ lsGet, profile, pIndex, optimum, onClose }) {
    // State: activeTab ‚Äî –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ ('today' = 7 –¥–Ω–µ–π, 'week' = 30 –¥–Ω–µ–π)
    const [activeTab, setActiveTab] = useState('today');

    // State: expandedCategories ‚Äî Set —Å ID —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const [expandedCategories, setExpandedCategories] = useState(() => new Set(['nutrition', 'timing', 'activity', 'recovery', 'metabolism']));

    // State: unlockPlanCollapsed ‚Äî –±–ª–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–µ—Ä–Ω—É—Ç
    const [unlockPlanCollapsed, setUnlockPlanCollapsed] = useState(true);

    // üîß –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç insights –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∞–±–∞
    const insights = useMemo(() => {
      const daysBack = activeTab === 'today' ? 7 : 30;
      return HEYS.PredictiveInsights.analyze({
        daysBack,
        lsGet,
        profile,
        pIndex,
        optimum
      });
    }, [activeTab, lsGet, profile, pIndex, optimum]);

    const patterns = insights.patterns || [];
    const healthScore = insights.healthScore;

    // üéØ Adaptive thresholds ‚Äî –ø–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
    const adaptiveThresholds = useMemo(() => {
      console.log('[PatternDebug] üîç Computing adaptive thresholds...', {
        hasThresholdsModule: !!HEYS.InsightsPI?.thresholds?.get,
        patternsCount: patterns.length,
        activeTab,
        profileId: profile?.id,
        hasLsGet: typeof lsGet === 'function',
        hasProfile: !!profile,
        hasPIndex: !!pIndex,
        hasDayUtils: !!HEYS.dayUtils,
        hasFmtDate: typeof HEYS.dayUtils?.fmtDate === 'function'
      });

      if (typeof HEYS.InsightsPI?.thresholds?.get !== 'function') {
        console.warn('[PatternDebug] ‚ö†Ô∏è Thresholds module not loaded');
        return null;
      }

      try {
        const daysBack = activeTab === 'today' ? 7 : 30;
        const days = [];

        // üîç Debug: –ø—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–±–æ—Ä–∞ –¥–Ω–µ–π
        console.log('[PatternDebug] üî¨ Before days collection:', {
          daysBack,
          hasLsGet: typeof lsGet === 'function',
          hasProfile: !!profile,
          hasDayUtils: !!HEYS.dayUtils,
          hasFmtDate: typeof HEYS.dayUtils?.fmtDate === 'function'
        });

        // –°–æ–±–∏—Ä–∞–µ–º –¥–Ω–∏ –∏–∑ localStorage (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ analyze)
        const U = HEYS.dayUtils || window.HEYS?.dayUtils;
        if (lsGet && profile && U?.fmtDate) {
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º
          const dateOffsetStr = (offset) => {
            const d = new Date();
            d.setDate(d.getDate() + offset);
            return U.fmtDate(d);
          };

          for (let i = 0; i < daysBack; i++) {
            const date = dateOffsetStr(-i);
            const dayKey = `heys_dayv2_${date}`;
            const dayData = lsGet(dayKey);
            if (dayData) {
              days.push({ ...dayData, date });
            }
          }
          console.log('[PatternDebug] üìÖ Collected days:', days.length, 'sample:', days[0]?.date);
        } else {
          console.warn('[PatternDebug] ‚ö†Ô∏è Cannot collect days:', {
            lsGet: !!lsGet,
            profile: !!profile,
            hasDayUtils: !!U,
            fmtDate: !!U?.fmtDate
          });
        }

        const result = HEYS.InsightsPI.thresholds.get(days, profile, pIndex);
        console.log('[PatternDebug] ‚úÖ Adaptive thresholds:', result);
        return result;
      } catch (err) {
        console.error('[PatternDebug] ‚ùå Failed to load adaptive thresholds:', err);
        return null;
      }
    }, [activeTab, profile, lsGet, pIndex, patterns.length]); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–µ—Ä–∏–æ–¥–∞ –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è

    const contributionByPattern = useMemo(() => {
      const map = new Map();
      if (!Array.isArray(patterns) || !healthScore?.breakdown) return map;

      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const getPatternReliability = (p) => {
        let baseConfidence = Number(p?.confidence);
        if (!Number.isFinite(baseConfidence)) baseConfidence = 0.5;
        if (baseConfidence > 1 && baseConfidence <= 100) baseConfidence = baseConfidence / 100;
        baseConfidence = clamp(baseConfidence, 0.15, 1);

        if (p?.isPreliminary) {
          baseConfidence = Math.min(baseConfidence, 0.55);
        }

        const dataPoints = Number(p?.dataPoints);
        const requiredDataPoints = Number(p?.requiredDataPoints);
        if (Number.isFinite(dataPoints) && Number.isFinite(requiredDataPoints) && requiredDataPoints > 0) {
          const completionRatio = clamp(dataPoints / requiredDataPoints, 0.25, 1);
          baseConfidence *= completionRatio;
        }

        return clamp(baseConfidence, 0.1, 1);
      };

      const byCategory = {
        nutrition: [],
        timing: [],
        activity: [],
        recovery: [],
        metabolism: []
      };

      patterns.forEach((p) => {
        if (!p?.available || p.score == null) return;
        const category = PATTERN_METADATA[p.pattern]?.category;
        if (!category || !byCategory[category]) return;

        byCategory[category].push({
          pattern: p.pattern,
          reliability: getPatternReliability(p)
        });
      });

      Object.entries(byCategory).forEach(([category, items]) => {
        if (!items.length) return;

        const catBreakdown = healthScore.breakdown[category] || {};
        const baseWeight = Number(catBreakdown.weight) || 0;
        const categoryReliability = Number(catBreakdown.reliability);
        const effectiveWeight = baseWeight * (0.4 + 0.6 * (Number.isFinite(categoryReliability) ? clamp(categoryReliability, 0, 1) : 1));

        const reliabilitySum = items.reduce((sum, item) => sum + item.reliability, 0);
        if (reliabilitySum <= 0 || effectiveWeight <= 0) return;

        items.forEach((item) => {
          const share = item.reliability / reliabilitySum;
          const contributionCategoryPct = share * 100;
          const contributionOverallPct = effectiveWeight * share * 100;

          map.set(item.pattern, {
            contributionCategoryPct: Math.round(contributionCategoryPct * 10) / 10,
            contributionOverallPct: Math.round(contributionOverallPct * 10) / 10,
            reliability: item.reliability,
            reliabilityLabel: item.reliability >= 0.75
              ? '–í—ã—Å–æ–∫–∞—è'
              : item.reliability >= 0.5
                ? '–°—Ä–µ–¥–Ω—è—è'
                : '–ù–∏–∑–∫–∞—è'
          });
        });
      });

      return map;
    }, [patterns, healthScore]);

    const runQuickAction = (actionId) => {
      const ui = HEYS.ui = HEYS.ui || {};
      const openFromInsights = ui.openDataEntryFromInsights;

      // 1) –ï—Å–ª–∏ –¥–Ω–µ–≤–Ω–∏–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º —Å—Ä–∞–∑—É
      if (typeof openFromInsights === 'function' && openFromInsights(actionId) === true) {
        onClose?.();
        return;
      }

      // 2) –ò–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º pending action –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –î–Ω–µ–≤–Ω–∏–∫
      ui.pendingDataEntryAction = actionId;
      if (typeof ui.switchTab === 'function') {
        ui.switchTab('diary');
      }

      HEYS.Toast?.tip?.('–û—Ç–∫—Ä—ã–ª –î–Ω–µ–≤–Ω–∏–∫ ‚Äî —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∂–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö');
      onClose?.();
    };

    // Toggle –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const toggleCategory = (categoryId) => {
      setExpandedCategories(prev => {
        const newSet = new Set(prev);
        if (newSet.has(categoryId)) {
          newSet.delete(categoryId);
        } else {
          newSet.add(categoryId);
        }
        return newSet;
      });
    };

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const groupedData = useMemo(() => {
      if (!patterns || !Array.isArray(patterns)) return {};

      const groups = {};

      patterns.forEach(p => {
        const meta = PATTERN_METADATA[p.pattern] || { name: p.pattern, category: 'unknown', emoji: '‚ùì' };
        const cat = meta.category;

        if (!groups[cat]) groups[cat] = [];

        const categoryInfo = CATEGORY_LABELS[cat] || { label: cat, emoji: '', color: '#6b7280' };

        const daysCount = Number.isFinite(p.days)
          ? p.days
          : Number.isFinite(p.dataPoints)
            ? p.dataPoints
            : Number.isFinite(p.daysAnalyzed)
              ? p.daysAnalyzed
              : null;

        groups[cat].push({
          id: p.pattern,
          name: meta.name,
          emoji: meta.emoji,
          category: cat,
          categoryLabel: categoryInfo.label,
          categoryColor: categoryInfo.color,
          available: p.available || false,
          score: p.score !== undefined ? p.score : null,
          days: daysCount,
          priority: p.priority || '‚Äî',
          reason: p.reason || null,
          isPreliminary: !!p.isPreliminary,
          requiredDataPoints: p.requiredDataPoints || null,
          confidence: p.confidence,
          dataPoints: p.dataPoints || null,
          contributionCategoryPct: contributionByPattern.get(p.pattern)?.contributionCategoryPct ?? null,
          contributionOverallPct: contributionByPattern.get(p.pattern)?.contributionOverallPct ?? null,
          reliability: contributionByPattern.get(p.pattern)?.reliability ?? null,
          reliabilityLabel: contributionByPattern.get(p.pattern)?.reliabilityLabel ?? null,
          message: p.message || p.insight || null,
          // Statistical significance fields (v3.4.0+)
          correlation: p.correlation ?? null,
          pValue: p.pValue ?? null,
          isSignificant: p.isSignificant ?? null,
          effectSize: p.effectSize ?? null
        });
      });

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —Å–∫–æ—Ä—É (desc)
      Object.values(groups).forEach(group => {
        group.sort((a, b) => (b.score || 0) - (a.score || 0));
      });

      // üìä –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø –û–¢–õ–ê–î–ö–ò
      console.group('üîç [Pattern Debug] –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö');
      console.log('üì¶ –í—Å–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:', patterns?.length || 0);

      Object.entries(groups).forEach(([catId, items]) => {
        const catInfo = CATEGORY_LABELS[catId] || { label: catId, emoji: '‚ùì' };
        const available = items.filter(x => x.available).length;
        const total = items.length;
        const percentage = total > 0 ? Math.round((available / total) * 100) : 0;

        console.group(`${catInfo.emoji} ${catInfo.label}: ${available}/${total} (${percentage}%)`);

        items.forEach(item => {
          const status = item.available ? '‚úÖ' : '‚è∏Ô∏è';
          const scoreStr = item.score !== null ? `score=${item.score}` : '–Ω/–¥';
          const daysStr = item.days > 0 ? `${item.days}–¥–Ω` : '0–¥–Ω';
          const reasonLabel = item.reason ? REASON_LABELS[item.reason] || item.reason : '';
          const reasonStr = !item.available && reasonLabel ? ` ‚Üí ${reasonLabel}` : '';

          console.log(
            `${status} ${item.emoji} ${item.name}`,
            `| ${scoreStr} | ${daysStr}${reasonStr}`,
            item.message ? `| ${item.message}` : ''
          );
        });

        console.groupEnd();
      });

      console.groupEnd();

      return groups;
    }, [patterns, contributionByPattern]);

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const stats = useMemo(() => {
      const total = patterns?.length || 0;
      const active = patterns?.filter(p => p.available && p.score !== null).length || 0;
      const avgScore = active > 0
        ? patterns
          ?.filter(p => p.available && p.score !== null)
          .reduce((sum, p) => sum + (p.score || 0), 0) / active
        : 0;

      return { total, active, avgScore: Math.round(avgScore) };
    }, [patterns]);

    const unlockPlan = useMemo(() => {
      const actionMap = new Map();

      patterns.forEach((p) => {
        if (p?.available) return;

        const quickAction = QUICK_ACTIONS_BY_REASON[p.reason];
        if (!quickAction) return;

        const actionId = quickAction.action;
        const meta = QUICK_ACTION_META[actionId] || { emoji: '‚ú®', noun: '–¥–∞–Ω–Ω—ã—Ö' };
        const existing = actionMap.get(actionId) || {
          actionId,
          label: quickAction.label,
          emoji: meta.emoji,
          noun: meta.noun,
          count: 0,
          patternIds: []
        };

        existing.count += 1;
        existing.patternIds.push(p.pattern);
        actionMap.set(actionId, existing);
      });

      const items = Array.from(actionMap.values())
        .sort((a, b) => b.count - a.count || a.label.localeCompare(b.label, 'ru'));

      const totalUnlockable = items.reduce((sum, item) => sum + item.count, 0);
      const topItems = items.slice(0, 3);

      return {
        totalUnlockable,
        topItems,
        hasPlan: totalUnlockable > 0
      };
    }, [patterns]);

    return h('div', {
      className: 'pattern-debug-modal',
      onClick: (e) => { if (e.target === e.currentTarget) onClose(); }
    },
      h('div', {
        className: 'pattern-debug-modal__content',
        onClick: (e) => e.stopPropagation()
      },
        // Header
        h('div', { className: 'pattern-debug-modal__header' },
          h('div', { className: 'pattern-debug-modal__title' },
            h('span', { className: 'pattern-debug-modal__emoji' }, 'üîç'),
            h('span', null, '–ü–∞—Ç—Ç–µ—Ä–Ω—ã')
          ),
          h('div', { className: 'pattern-debug-modal__header-right' },
            // Tab Switcher (–ù–µ–¥–µ–ª—è / –ú–µ—Å—è—Ü)
            h('div', { className: 'pattern-debug-modal__tabs' },
              h('button', {
                className: `pattern-debug-modal__tab-button ${activeTab === 'today' ? 'pattern-debug-modal__tab-button--active' : ''}`,
                onClick: () => setActiveTab('today')
              }, '–ù–µ–¥–µ–ª—è'),
              h('button', {
                className: `pattern-debug-modal__tab-button ${activeTab === 'week' ? 'pattern-debug-modal__tab-button--active' : ''}`,
                onClick: () => setActiveTab('week')
              }, '–ú–µ—Å—è—Ü')
            ),
            h('button', {
              className: 'pattern-debug-modal__close',
              onClick: onClose,
              'aria-label': '–ó–∞–∫—Ä—ã—Ç—å'
            }, '‚úï')
          )
        ),

        // Stats Summary
        h('div', { className: 'pattern-debug-modal__stats' },
          h('div', { className: 'pattern-debug-modal__stat' },
            h('span', { className: 'pattern-debug-modal__stat-label' }, 'Health Score'),
            h('span', { className: 'pattern-debug-modal__stat-value pattern-debug-modal__stat-value--score' },
              healthScore?.total || '‚Äî'
            )
          ),
          h('div', { className: 'pattern-debug-modal__stat' },
            h('span', { className: 'pattern-debug-modal__stat-label' }, '–í—Å–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤'),
            h('span', { className: 'pattern-debug-modal__stat-value' }, stats.total)
          ),
          h('div', { className: 'pattern-debug-modal__stat' },
            h('span', { className: 'pattern-debug-modal__stat-label' }, '–ê–∫—Ç–∏–≤–Ω—ã—Ö'),
            h('span', { className: 'pattern-debug-modal__stat-value pattern-debug-modal__stat-value--active' },
              stats.active
            )
          ),
          h('div', { className: 'pattern-debug-modal__stat' },
            h('span', { className: 'pattern-debug-modal__stat-label' }, '–°—Ä–µ–¥–Ω–∏–π —Å–∫–æ—Ä'),
            h('span', { className: 'pattern-debug-modal__stat-value' }, stats.avgScore)
          )
        ),

        // Accordions –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        h('div', { className: 'pattern-debug-modal__accordions' },
          Object.entries(CATEGORY_LABELS).map(([catId, catInfo]) => {
            const categoryPatterns = groupedData[catId] || [];
            if (categoryPatterns.length === 0) return null;

            const isExpanded = expandedCategories.has(catId);
            const activeCount = categoryPatterns.filter(p => p.available && p.score !== null).length;

            // üîß v6.0.1: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ healthScore.categories –Ω–∞–ø—Ä—è–º—É—é
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —Å hero –±–ª–æ–∫–∞–º–∏ –≤–Ω–∏–∑—É (–≤–∫–ª–∞–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
            const avgScore = healthScore?.categories?.[catId] ?? 0;

            return h('div', {
              key: catId,
              className: 'pattern-debug-modal__accordion'
            },
              // Accordion Header
              h('div', {
                className: `pattern-debug-modal__accordion-header ${isExpanded ? 'pattern-debug-modal__accordion-header--expanded' : ''}`,
                onClick: () => toggleCategory(catId),
                style: { borderLeftColor: catInfo.color }
              },
                h('div', { className: 'pattern-debug-modal__accordion-header-left' },
                  h('span', { className: 'pattern-debug-modal__accordion-icon' },
                    isExpanded ? '‚ñº' : '‚ñ∂'
                  ),
                  h('span', { className: 'pattern-debug-modal__accordion-emoji' }, catInfo.emoji),
                  h('span', { className: 'pattern-debug-modal__accordion-title' }, catInfo.label),
                  h('span', { className: 'pattern-debug-modal__accordion-count' },
                    `${activeCount}/${categoryPatterns.length}`
                  )
                ),
                h('div', { className: 'pattern-debug-modal__accordion-header-right' },
                  activeCount > 0 && h('span', {
                    className: `pattern-debug-modal__accordion-score ${avgScore >= 80 ? 'pattern-debug-modal__score--excellent' :
                      avgScore >= 60 ? 'pattern-debug-modal__score--good' :
                        avgScore >= 40 ? 'pattern-debug-modal__score--fair' :
                          'pattern-debug-modal__score--poor'
                      }`
                  }, avgScore)
                )
              ),

              // Accordion Content
              isExpanded && h('div', { className: 'pattern-debug-modal__accordion-content' },
                h('div', { className: 'pattern-debug-modal__table-wrap' },
                  h('table', { className: 'pattern-debug-modal__table' },
                    h('thead', null,
                      h('tr', null,
                        h('th', null, '–ü–∞—Ç—Ç–µ—Ä–Ω'),
                        h('th', null, '–°—Ç–∞—Ç—É—Å'),
                        h('th', null, '–°–∫–æ—Ä'),
                        h('th', { className: 'pattern-debug-modal__th--correlation', title: '–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å (p-value)' }, 'üìä r / p'),
                        h('th', { className: 'pattern-debug-modal__th--adaptive', title: '–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ 14-21 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö' }, 'üéØ Adaptive'),
                        h('th', null,
                          h('span', null, '–í–∫–ª–∞–¥'),
                          h('span', { className: 'pattern-debug-modal__th-hint' }, '(% –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)')
                        ),
                        h('th', null, '–î–Ω–µ–π'),
                        h('th', { className: 'pattern-debug-modal__th--reason' }, '–ü—Ä–∏—á–∏–Ω–∞')
                      )
                    ),
                    h('tbody', null,
                      categoryPatterns.map(row => h('tr', {
                        key: row.id,
                        className: `pattern-debug-modal__row ${!row.available ? 'pattern-debug-modal__row--inactive' : ''}`
                      },
                        // Pattern name
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--pattern' },
                          h('span', { className: 'pattern-debug-modal__emoji' }, row.emoji),
                          h('span', {
                            className: 'pattern-debug-modal__pattern-name',
                            title: row.name
                          }, row.name),
                          row.isPreliminary && h('span', {
                            className: 'pattern-debug-modal__preview-badge',
                            title: `–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞. –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ ${row.requiredDataPoints || 3}+ –∑–∞–º–µ—Ä–æ–≤.`
                          }, 'P')
                        ),
                        // Status
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--status' },
                          row.available
                            ? h('span', { className: 'pattern-debug-modal__status pattern-debug-modal__status--active' }, '‚úÖ')
                            : h('span', { className: 'pattern-debug-modal__status pattern-debug-modal__status--inactive' }, '‚è∏Ô∏è')
                        ),
                        // Score
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--score' },
                          row.score !== null
                            ? h('span', {
                              className: `pattern-debug-modal__score ${row.score >= 80 ? 'pattern-debug-modal__score--excellent' :
                                row.score >= 60 ? 'pattern-debug-modal__score--good' :
                                  row.score >= 40 ? 'pattern-debug-modal__score--fair' :
                                    'pattern-debug-modal__score--poor'
                                }`
                            }, row.score)
                            : h('span', { className: 'pattern-debug-modal__score pattern-debug-modal__score--na' }, '‚Äî')
                        ),
                        // Correlation + p-value (statistical significance)
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--correlation' },
                          row.correlation !== null && row.pValue !== null
                            ? h('div', { className: 'pattern-debug-modal__correlation' },
                              h('span', {
                                className: `pattern-debug-modal__correlation-r ${row.isSignificant ? 'pattern-debug-modal__correlation-r--significant' : 'pattern-debug-modal__correlation-r--nonsignificant'
                                  }`,
                                title: `Effect size: ${row.effectSize || 'unknown'}`
                              },
                                `r=${row.correlation.toFixed(2)}`
                              ),
                              h('span', {
                                className: `pattern-debug-modal__correlation-p ${row.isSignificant ? 'pattern-debug-modal__correlation-p--significant' : 'pattern-debug-modal__correlation-p--nonsignificant'
                                  }`,
                                title: row.isSignificant ? 'Statistically significant' : 'Not significant'
                              },
                                row.pValue < 0.001 ? 'p<0.001' :
                                  row.pValue < 0.01 ? 'p<0.01' :
                                    row.pValue < 0.05 ? 'p<0.05' :
                                      `p=${row.pValue.toFixed(3)}`
                              )
                            )
                            : h('span', { className: 'pattern-debug-modal__correlation-na' }, '‚Äî')
                        ),
                        // Adaptive Thresholds
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--adaptive' },
                          (() => {
                            const patternId = row.id;
                            const thresholdKeys = PATTERN_THRESHOLDS_MAP[patternId];

                            if (!thresholdKeys) {
                              return h('span', { className: 'pattern-debug-modal__adaptive-na' }, '‚Äî');
                            }

                            if (!adaptiveThresholds?.thresholds) {
                              console.log(`[PatternDebug] ‚ö†Ô∏è Pattern ${patternId} has threshold keys but no thresholds computed`);
                              return h('span', { className: 'pattern-debug-modal__adaptive-na', title: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞' }, '‚Äî');
                            }

                            // Debug log only on first render (avoid 70+ repeated logs)
                            if (!window.__patternDebugLoggedThresholds) window.__patternDebugLoggedThresholds = {};
                            if (!window.__patternDebugLoggedThresholds[patternId]) {
                              window.__patternDebugLoggedThresholds[patternId] = true;
                              console.log(`[PatternDebug] üéØ Rendering thresholds for ${patternId}:`, {
                                keys: thresholdKeys,
                                values: thresholdKeys.map(k => ({ [k]: adaptiveThresholds.thresholds[k] }))
                              });
                            }

                            const thresholdBadges = thresholdKeys.map(key => {
                              const value = adaptiveThresholds.thresholds[key];
                              if (value == null) return null;

                              const label = THRESHOLD_LABELS[key] || key;
                              let displayValue = value;

                              // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                              if (key === 'lateEatingHour') {
                                displayValue = `${Math.round(value)}:00`;
                              } else if (key === 'idealMealGapMin') {
                                displayValue = `${Math.round(value / 60)}—á`;
                              } else if (key === 'chronotype') {
                                displayValue = value; // lark/owl/neutral
                              } else {
                                displayValue = Math.round(value);
                              }

                              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º tier –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                              const meta = adaptiveThresholds.meta || {};
                              const tier = meta.partial ? 'PARTIAL (7-13d)' :
                                meta.default ? 'DEFAULT (<7d)' :
                                  adaptiveThresholds.confidence >= 0.9 ? 'FULL (14+d)' : 'COMPUTING';
                              const tierEmoji = meta.partial ? '‚ö†Ô∏è' : meta.default ? 'üõ†Ô∏è' : adaptiveThresholds.confidence >= 0.9 ? '‚úÖ' : 'üîÑ';
                              const cacheInfo = meta.dateRange ? ` | ‚ôªÔ∏è Cache: ${meta.dateRange.from}..${meta.dateRange.to}` : '';

                              return h('div', {
                                key,
                                className: 'pattern-debug-modal__threshold-badge',
                                title: `${label}: ${displayValue}\n${tierEmoji} Tier: ${tier}\nDays: ${adaptiveThresholds.daysUsed || '?'} | Confidence: ${Math.round((adaptiveThresholds.confidence || 0) * 100)}%${cacheInfo}`
                              }, `${label}: ${displayValue}`);
                            }).filter(Boolean);

                            if (thresholdBadges.length === 0) {
                              return h('span', { className: 'pattern-debug-modal__adaptive-na' }, '‚Äî');
                            }

                            return h('div', { className: 'pattern-debug-modal__adaptive-wrap' }, thresholdBadges);
                          })()
                        ),
                        // Contribution
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--contribution' },
                          row.available && row.contributionCategoryPct !== null
                            ? h('span', {
                              className: `pattern-debug-modal__contribution-badge ${row.reliability >= 0.75
                                ? 'pattern-debug-modal__contribution-badge--high'
                                : row.reliability >= 0.5
                                  ? 'pattern-debug-modal__contribution-badge--medium'
                                  : 'pattern-debug-modal__contribution-badge--low'
                                }`,
                              title: `–í–∫–ª–∞–¥ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${row.contributionCategoryPct}%. –í –æ–±—â–∏–π score: ${row.contributionOverallPct ?? '‚Äî'}%. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å: ${row.reliabilityLabel || '‚Äî'} (${Math.round((row.reliability || 0) * 100)}%)`
                            },
                              `${row.contributionCategoryPct}%`
                            )
                            : h('span', { className: 'pattern-debug-modal__score pattern-debug-modal__score--na' }, '‚Äî')
                        ),
                        // Days
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--days' },
                          Number.isFinite(row.days) && row.days > 0 ? `${row.days} –¥–Ω` : '‚Äî'
                        ),
                        // Reason
                        h('td', { className: 'pattern-debug-modal__cell pattern-debug-modal__cell--reason' },
                          !row.available
                            ? h('div', { className: 'pattern-debug-modal__reason-wrap' },
                              h('span', {
                                className: `pattern-debug-modal__reason-badge pattern-debug-modal__reason-badge--unavailable ${row.reason ? `pattern-debug-modal__reason--${row.reason}` : ''}`,
                                title: REASON_LABELS[row.reason] || row.message || row.reason || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                              },
                                REASON_SHORT[row.reason] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                              ),
                              QUICK_ACTIONS_BY_REASON[row.reason] && h('button', {
                                type: 'button',
                                className: 'pattern-debug-modal__quick-action-btn',
                                title: QUICK_ACTIONS_BY_REASON[row.reason].label,
                                onClick: (e) => {
                                  e.stopPropagation();
                                  runQuickAction(QUICK_ACTIONS_BY_REASON[row.reason].action);
                                }
                              }, '‚ûï')
                            )
                            : h('span', { className: 'pattern-debug-modal__reason pattern-debug-modal__reason--available' }, '‚úì')
                        )
                      ))
                    )
                  )
                )
              )
            );
          })
        ),

        unlockPlan.hasPlan && h('div', {
          className: `pattern-debug-modal__unlock-plan ${unlockPlanCollapsed ? 'pattern-debug-modal__unlock-plan--collapsed' : ''}`
        },
          h('div', { className: 'pattern-debug-modal__unlock-plan-header' },
            h('div', { className: 'pattern-debug-modal__unlock-plan-title' },
              'üöÄ –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å –∫ –ø–æ–ª–Ω—ã–º –∏–Ω—Å–∞–π—Ç–∞–º'
            ),
            h('div', { className: 'pattern-debug-modal__unlock-plan-header-right' },
              h('div', { className: 'pattern-debug-modal__unlock-plan-total' },
                `+${unlockPlan.totalUnlockable} –ø–∞—Ç—Ç.`
              ),
              h('button', {
                type: 'button',
                className: 'pattern-debug-modal__unlock-plan-toggle',
                onClick: (e) => {
                  e.stopPropagation();
                  setUnlockPlanCollapsed(prev => !prev);
                },
                'aria-expanded': !unlockPlanCollapsed,
                'aria-label': unlockPlanCollapsed
                  ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–ª–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π'
                  : '–°–≤–µ—Ä–Ω—É—Ç—å –±–ª–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π'
              }, unlockPlanCollapsed ? '‚ñ∂' : '‚ñº')
            )
          ),
          !unlockPlanCollapsed && h('div', { className: 'pattern-debug-modal__unlock-plan-subtitle' },
            '–î–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –∏ —ç—Ç–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è'
          ),
          !unlockPlanCollapsed && h('div', { className: 'pattern-debug-modal__unlock-plan-actions' },
            unlockPlan.topItems.map((item) => h('button', {
              key: item.actionId,
              type: 'button',
              className: 'pattern-debug-modal__unlock-plan-btn',
              onClick: () => runQuickAction(item.actionId)
            },
              h('span', { className: 'pattern-debug-modal__unlock-plan-btn-icon' }, item.emoji),
              h('span', { className: 'pattern-debug-modal__unlock-plan-btn-text' }, `${item.label}`),
              h('span', { className: 'pattern-debug-modal__unlock-plan-btn-badge' }, `+${item.count}`)
            ))
          )
        ),

        // Footer with category breakdown
        healthScore?.breakdown && h('div', { className: 'pattern-debug-modal__breakdown' },
          h('div', { className: 'pattern-debug-modal__breakdown-title' }, '–í–∫–ª–∞–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:'),
          h('div', { className: 'pattern-debug-modal__breakdown-grid' },
            Object.entries(healthScore.breakdown).map(([key, cat]) => {
              const catInfo = CATEGORY_LABELS[key];
              if (!catInfo) return null;

              return h('div', {
                key,
                className: 'pattern-debug-modal__breakdown-item',
                style: { borderColor: catInfo.color }
              },
                h('div', { className: 'pattern-debug-modal__breakdown-icon' }, catInfo.emoji),
                h('div', { className: 'pattern-debug-modal__breakdown-label' }, cat.label || key),
                h('div', { className: 'pattern-debug-modal__breakdown-score' },
                  cat.score !== null ? cat.score : '‚Äî'
                ),
                h('div', { className: 'pattern-debug-modal__breakdown-weight' },
                  `${Math.round((cat.weight || 0) * 100)}% –≤–µ—Å–∞`
                )
              );
            })
          )
        )
      )
    );
  }

  // Export
  HEYS.InsightsPI.patternDebugger = {
    PatternDebugModal,
    PATTERN_METADATA,
    CATEGORY_LABELS
  };

  global.PatternDebugModal = PatternDebugModal;

})(typeof window !== 'undefined' ? window : this);
