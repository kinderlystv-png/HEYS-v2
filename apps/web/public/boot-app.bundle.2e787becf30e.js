
/* ===== heys_user_tab_impl_v1.js ===== */
// heys_user_tab_impl_v1.js ‚Äî User profile, BMI/BMR calculations, HR zones (extracted)
// üÜï PERF v9.2: –ú–µ—Ç–∫–∞ –º–æ–º–µ–Ω—Ç–∞ –∫–æ–≥–¥–∞ boot-app –Ω–∞—á–∞–ª –∏—Å–ø–æ–ª–Ω—è—Ç—å—Å—è
window.__heysPerfMark && window.__heysPerfMark('boot-app: execute start');
(function (global) {
    const HEYS = global.HEYS = global.HEYS || {};
    const React = global.React;

    // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ HEYS.utils –∑–∞–≥—Ä—É–∂–µ–Ω
    if (!HEYS.utils || !HEYS.utils.lsGet) {
        console.error('[heys_user_v12] ‚ùå HEYS.utils.lsGet –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω! –≠—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —Å–±—Ä–æ—Å—É –ø—Ä–æ—Ñ–∏–ª—è');
    }
    // else { console.log('[heys_user_v12] ‚úÖ HEYS.utils.lsGet –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, __clientScoped:', HEYS.utils.__clientScoped); }

    const { lsGet, lsSet, toNum, round1, getEmojiStyle, setEmojiStyle } = HEYS.utils || {
        lsGet: (k, d) => d, lsSet: () => { }, toNum: (x) => Number(x) || 0, round1: (v) => Math.round(v * 10) / 10,
        getEmojiStyle: () => 'android', setEmojiStyle: () => { }
    };

    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
    const DEFAULT_PROFILE = {
        firstName: '', lastName: '', gender: '–ú—É–∂—Å–∫–æ–π',
        weight: 70, height: 175, age: 30,
        birthDate: '', // YYYY-MM-DD, –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –≤–æ–∑—Ä–∞—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ
        weightGoal: 0, // —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å (–∫–≥)
        sleepHours: 8, insulinWaveHours: 3,
        deficitPctTarget: 0,
        stepsGoal: 10000, // —Ü–µ–ª–µ–≤–∞—è –¥–Ω–µ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —à–∞–≥–∞–º
        cycleTrackingEnabled: false, // —Ä—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–µ–∫–∏–Ω–≥–∞ —Ü–∏–∫–ª–∞ (–¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª–∞)
        profileCompleted: false, // —Ñ–ª–∞–≥ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è (–¥–ª—è wizard –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞)
        desktopAllowed: false, // üñ•Ô∏è –†–∞–∑—Ä–µ—à—ë–Ω –ª–∏ –¥–æ—Å—Ç—É–ø —Å –¥–µ—Å–∫—Ç–æ–ø–∞ (–∫—É—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å)

        // üíä –í–∏—Ç–∞–º–∏–Ω—ã / –¥–æ–±–∞–≤–∫–∏
        // plannedSupplements –æ—Å—Ç–∞—ë—Ç—Å—è string[] ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ UI
        plannedSupplements: [],
        // supplementSettings ‚Äî –∫–∞—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ ID –¥–æ–±–∞–≤–∫–∏ (—Ñ–æ—Ä–º–∞, –¥–æ–∑–∏—Ä–æ–≤–∫–∞, override —Ç–∞–π–º–∏–Ω–≥–∞)
        supplementSettings: {},
        // supplementHistory ‚Äî –ª—ë–≥–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—ë–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–æ–∫ –¥–∞—Ç) –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø–æ –∫—É—Ä—Å—É/–ª–∏–º–∏—Ç–∞–º
        supplementHistory: {}
    };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –º—è–≥–∫–∞—è (—Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥, –Ω–µ —Ñ–æ—Ä—Å–∏—Ä—É–µ–º fallback)
    // Fallback –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –Ω–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
    const PROFILE_VALIDATORS = {
        weight: v => {
            if (v === '' || v === null || v === undefined) return v; // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Å—Ç–æ–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
            const n = Number(v);
            return isNaN(n) ? v : Math.max(0, Math.min(500, n));
        },
        weightGoal: v => {
            if (v === '' || v === null || v === undefined) return 0;
            const n = Number(v);
            return isNaN(n) ? 0 : Math.max(0, Math.min(500, n));
        },
        height: v => {
            if (v === '' || v === null || v === undefined) return v;
            const n = Number(v);
            return isNaN(n) ? v : Math.max(0, Math.min(300, n));
        },
        age: v => {
            if (v === '' || v === null || v === undefined) return v;
            const n = Number(v);
            return isNaN(n) ? v : Math.max(0, Math.min(150, n));
        },
        sleepHours: v => {
            if (v === '' || v === null || v === undefined) return v;
            const n = Number(v);
            return isNaN(n) ? v : Math.max(0, Math.min(24, n));
        },
        insulinWaveHours: v => {
            if (v === '' || v === null || v === undefined) return v;
            const n = Number(v);
            return isNaN(n) ? v : Math.max(0.5, Math.min(12, n));
        },
        deficitPctTarget: v => {
            if (v === '' || v === null || v === undefined) return 0;
            const n = Number(v);
            return isNaN(n) ? 0 : Math.max(-50, Math.min(50, n));
        },
        stepsGoal: v => {
            if (v === '' || v === null || v === undefined) return 10000;
            const n = Number(v);
            return isNaN(n) ? 10000 : Math.max(0, Math.min(50000, n));
        }
    };

    // –†–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
    function calcAgeFromBirthDate(birthDate) {
        if (!birthDate) return 0;
        const birth = new Date(birthDate);
        if (isNaN(birth.getTime())) return 0;
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return Math.max(0, age);
    }

    // –†–∞—Å—á—ë—Ç –Ω–æ—Ä–º—ã —Å–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ –ø–æ–ª—É (Sleep Foundation + NSF)
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { hours, range, explanation }
    function calcSleepNorm(age, gender) {
        let baseMin, baseMax, explanation;

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (Sleep Foundation / AASM)
        if (age < 13) {
            baseMin = 9; baseMax = 12;
            explanation = '–¥–µ—Ç–∏ 6-12 –ª–µ—Ç: 9-12—á';
        } else if (age < 18) {
            baseMin = 8; baseMax = 10;
            explanation = '–ø–æ–¥—Ä–æ—Å—Ç–∫–∏ 13-17: 8-10—á';
        } else if (age < 26) {
            baseMin = 7; baseMax = 9;
            explanation = '–º–æ–ª–æ–¥—ã–µ 18-25: 7-9—á';
        } else if (age < 65) {
            baseMin = 7; baseMax = 9;
            explanation = '–≤–∑—Ä–æ—Å–ª—ã–µ 26-64: 7-9—á';
        } else {
            baseMin = 7; baseMax = 8;
            explanation = '–ø–æ–∂–∏–ª—ã–µ 65+: 7-8—á';
        }

        // –ñ–µ–Ω—â–∏–Ω—ã –≤ —Å—Ä–µ–¥–Ω–µ–º –Ω—É–∂–¥–∞—é—Ç—Å—è –Ω–∞ ~20 –º–∏–Ω –±–æ–ª—å—à–µ (Duke University)
        const genderBonus = gender === '–ñ–µ–Ω—Å–∫–∏–π' ? 0.3 : 0;

        const recommended = Math.round(((baseMin + baseMax) / 2 + genderBonus) * 2) / 2; // –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 0.5

        return {
            hours: recommended,
            range: `${baseMin}-${baseMax}`,
            explanation: explanation + (genderBonus > 0 ? ' +20–º–∏–Ω –∂–µ–Ω.' : '')
        };
    }

    // Emoji Style Selector Component
    function EmojiStyleSelector() {
        const [style, setStyle] = React.useState(() => getEmojiStyle());

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        const platformInfo = React.useMemo(() => {
            if (typeof window === 'undefined') return { needsTwemoji: false, name: 'Unknown' };
            const ua = navigator.userAgent || '';
            const isWindows = /Windows/i.test(ua);
            const isLinux = /Linux/i.test(ua) && !/Android/i.test(ua);
            const isMac = /Macintosh|Mac OS/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);
            const isAndroid = /Android/i.test(ua);

            let name = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
            if (isWindows) name = 'Windows';
            else if (isMac) name = 'Mac';
            else if (isIOS) name = 'iPhone/iPad';
            else if (isAndroid) name = 'Android';
            else if (isLinux) name = 'Linux';

            return {
                needsTwemoji: isWindows || isLinux,
                name: name,
                twemojiAvailable: !!window.twemoji
            };
        }, []);

        const handleChange = (e) => {
            const newStyle = e.target.value;
            setStyle(newStyle);
            setEmojiStyle(newStyle);
        };

        // –ï—Å–ª–∏ Twemoji –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (Mac/iOS/Android), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ-–±–ª–æ–∫
        if (!platformInfo.twemojiAvailable) {
            return React.createElement('div', { className: 'inline-field' },
                React.createElement('label', null, '–°—Ç–∏–ª—å —ç–º–æ–¥–∑–∏ üòÄ'),
                React.createElement('span', { className: 'sep' }, '-'),
                React.createElement('span', { style: { color: 'var(--gray-500)', fontSize: '0.875rem' } },
                    `–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç–º–æ–¥–∑–∏ ${platformInfo.name}`
                )
            );
        }

        return React.createElement('div', { className: 'inline-field' },
            React.createElement('label', null, '–°—Ç–∏–ª—å —ç–º–æ–¥–∑–∏ üòÄ'),
            React.createElement('span', { className: 'sep' }, '-'),
            React.createElement('select', { value: style, onChange: handleChange },
                React.createElement('option', { value: 'twemoji' }, 'üê¶ Twitter/Android'),
                React.createElement('option', { value: 'system' }, `üíª ${platformInfo.name}`)
            )
        );
    }

    // === SubscriptionStatusSection ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ===
    function SubscriptionStatusSection() {
        const [statusData, setStatusData] = React.useState(null);
        const [loading, setLoading] = React.useState(true);

        React.useEffect(() => {
            if (!window.HEYS?.Subscription) {
                setLoading(false);
                return;
            }

            window.HEYS.Subscription.getStatus(true).then(data => {
                setStatusData(data);
                setLoading(false);
            }).catch(() => setLoading(false));
        }, []);

        if (loading) {
            return React.createElement('div', { className: 'profile-section__fields' },
                React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--gray-500)' } },
                    '–ó–∞–≥—Ä—É–∑–∫–∞...'
                )
            );
        }

        if (!window.HEYS?.Subscription) {
            return React.createElement('div', { className: 'profile-section__fields' },
                React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--gray-500)' } },
                    '–ú–æ–¥—É–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'
                )
            );
        }

        const status = statusData?.status || 'none';
        const meta = window.HEYS.Subscription.getStatusMeta(status);
        const daysLeft = statusData?.days_left || 0;

        return React.createElement('div', { className: 'profile-section__fields' },
            // –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∞
            React.createElement('div', {
                className: 'profile-field-group',
                style: {
                    backgroundColor: meta?.bg || 'var(--gray-100)',
                    borderRadius: '12px',
                    padding: '16px',
                    border: `2px solid ${meta?.color || 'var(--gray-300)'}`
                }
            },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' } },
                    React.createElement('span', { style: { fontSize: '32px' } }, meta?.emoji || 'üíé'),
                    React.createElement('div', null,
                        React.createElement('div', { style: { fontSize: '18px', fontWeight: '600', color: meta?.color || 'inherit' } },
                            meta?.label || '–ü–æ–¥–ø–∏—Å–∫–∞'
                        ),
                        React.createElement('div', { style: { fontSize: '14px', color: 'var(--gray-600)' } },
                            meta?.desc || ''
                        )
                    )
                ),

                // –î–Ω–∏ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                (status === 'trial' || status === 'active') && daysLeft > 0 &&
                React.createElement('div', {
                    style: {
                        backgroundColor: 'rgba(0,0,0,0.05)',
                        borderRadius: '8px',
                        padding: '12px',
                        textAlign: 'center',
                        marginBottom: '12px'
                    }
                },
                    React.createElement('div', { style: { fontSize: '24px', fontWeight: '700', color: meta?.color } },
                        daysLeft
                    ),
                    React.createElement('div', { style: { fontSize: '12px', color: 'var(--gray-600)' } },
                        daysLeft === 1 ? '–¥–µ–Ω—å –æ—Å—Ç–∞–ª–æ—Å—å' : (daysLeft < 5 ? '–¥–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å' : '–¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å')
                    )
                ),

                // –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã (–¥–ª—è read_only –∏–ª–∏ none)
                (status === 'read_only' || status === 'none') &&
                React.createElement('button', {
                    className: 'btn btn-primary',
                    style: { width: '100%', marginTop: '8px' },
                    onClick: () => {
                        if (window.HEYS?.Paywall?.show) {
                            window.HEYS.Paywall.show();
                        } else {
                            alert('–û–ø–ª–∞—Ç–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞! üíé');
                        }
                    }
                }, status === 'read_only' ? 'üîì –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É' : 'üöÄ –ù–∞—á–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥')
            )
        );
    }

    // === ProfileSection ‚Äî FAQ-style collapsible section ===
    function ProfileSection({
        id,
        icon,
        title,
        subtitle,
        badge,
        tone = 'blue',
        expanded,
        onToggle,
        children
    }) {
        const handleClick = () => {
            if (onToggle) onToggle(id);
        };

        const sectionClass = [
            'profile-section',
            `tone-${tone}`,
            expanded ? 'profile-section--expanded' : 'profile-section--collapsed'
        ].join(' ');

        return React.createElement('div', { className: sectionClass },
            // Header (always visible)
            React.createElement('div', {
                className: 'profile-section__header',
                onClick: handleClick
            },
                React.createElement('div', { className: 'profile-section__header-left' },
                    React.createElement('div', { className: 'profile-section__icon' }, icon),
                    React.createElement('div', null,
                        React.createElement('div', { className: 'profile-section__title' }, title),
                        subtitle && React.createElement('div', { className: 'profile-section__subtitle' }, subtitle)
                    )
                ),
                React.createElement('div', { className: 'profile-section__header-right' },
                    badge && React.createElement('span', { className: 'profile-section__badge' }, badge),
                    React.createElement('span', { className: 'profile-section__chevron' }, '‚ñº')
                )
            ),
            // Content (only when expanded)
            expanded && React.createElement('div', { className: 'profile-section__content' }, children)
        );
    }

    // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä—É–ø–ø—ã –ø–æ–ª–µ–π (–ø–ª–∞—à–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏) ===
    function ProfileFieldGroup({ icon, title, children }) {
        return React.createElement('div', { className: 'profile-field-group' },
            React.createElement('div', { className: 'profile-field-group__header' },
                React.createElement('span', { className: 'profile-field-group__icon' }, icon),
                React.createElement('span', { className: 'profile-field-group__title' }, title)
            ),
            children
        );
    }

    function UserTabBase() {
        // Twemoji: reparse emoji after render
        React.useEffect(() => {
            if (window.scheduleTwemojiParse) window.scheduleTwemojiParse();
        });

        const [profile, setProfile] = React.useState(() => {
            return lsGet('heys_profile', DEFAULT_PROFILE);
        });
        const [profileSaved, setProfileSaved] = React.useState(false);

        // –°–º–µ–Ω–∞ PIN
        const [pinForm, setPinForm] = React.useState({ pin: '', confirm: '' });
        const [pinStatus, setPinStatus] = React.useState('idle'); // idle | pending | success | error
        const [pinMessage, setPinMessage] = React.useState('');

        // === Accordion state (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ localStorage) ===
        const SECTIONS_KEY = 'heys_profile_sections';
        const [expandedSections, setExpandedSections] = React.useState(() => {
            try {
                if (HEYS.store?.get) {
                    const saved = HEYS.store.get(SECTIONS_KEY, null);
                    if (saved) return typeof saved === 'string' ? JSON.parse(saved) : saved;
                }
                const saved = lsGet ? lsGet(SECTIONS_KEY, null) : null;
                if (saved) return saved;
                const raw = localStorage.getItem(SECTIONS_KEY);
                return raw ? JSON.parse(raw) : { basic: true };
            } catch { return { basic: true }; }
        });
        const toggleSection = (id) => {
            setExpandedSections(prev => {
                const next = { ...prev, [id]: !prev[id] };
                try {
                    if (HEYS.store?.set) HEYS.store.set(SECTIONS_KEY, next);
                    else if (lsSet) lsSet(SECTIONS_KEY, next);
                    else localStorage.setItem(SECTIONS_KEY, JSON.stringify(next));
                } catch { }
                return next;
            });
        };

        const getCurrentClientId = () => {
            let cid = (window.HEYS && window.HEYS.currentClientId) || localStorage.getItem('heys_client_current') || '';
            if (cid && typeof cid === 'string' && cid.startsWith('"')) {
                try { cid = JSON.parse(cid); } catch (_) { }
            }
            return cid || '';
        };

        const getShortClientId = (id) => id ? String(id).slice(0, 8) : '‚Äî';

        const handlePinUpdate = async () => {
            const auth = window.HEYS && window.HEYS.auth;
            const clientId = getCurrentClientId();
            setPinMessage('');

            if (!clientId) {
                setPinStatus('error');
                setPinMessage('–ö–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —à–∞–ø–∫–µ.');
                return;
            }

            if (!auth || typeof auth.resetClientPin !== 'function' || typeof auth.validatePin !== 'function') {
                setPinStatus('error');
                setPinMessage('–ú–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.');
                return;
            }

            if (!auth.validatePin(pinForm.pin) || !auth.validatePin(pinForm.confirm)) {
                setPinStatus('error');
                setPinMessage('PIN –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä.');
                return;
            }

            if (pinForm.pin !== pinForm.confirm) {
                setPinStatus('error');
                setPinMessage('PIN –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.');
                return;
            }

            setPinStatus('pending');
            try {
                const res = await auth.resetClientPin({ clientId, newPin: pinForm.pin });
                if (!res || !res.ok) {
                    const msg = res && res.message ? res.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å PIN';
                    setPinStatus('error');
                    setPinMessage(msg);
                    if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.trackError) {
                        window.HEYS.analytics.trackError('pin_change_failed', { clientId: getShortClientId(clientId), message: msg });
                    }
                    return;
                }
                setPinStatus('success');
                setPinMessage('PIN –æ–±–Ω–æ–≤–ª—ë–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ–æ–±—â–∏—Ç—å –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.');
                setPinForm({ pin: '', confirm: '' });
                setTimeout(() => { setPinStatus('idle'); setPinMessage(''); }, 2000);
            } catch (e) {
                setPinStatus('error');
                setPinMessage(e?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ PIN');
                if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.trackError) {
                    window.HEYS.analytics.trackError('pin_change_exception', { clientId: getShortClientId(clientId), message: e?.message });
                }
            }
        };

        // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã, MET —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
        const defaultZones = React.useMemo(() => {
            return [
                { name: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (—Ö–æ–¥—å–±–∞)', hrFrom: 85, hrTo: 99, MET: 2 },
                { name: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–µ–¥–ª–µ–Ω–Ω—ã–π –±–µ–≥)', hrFrom: 100, hrTo: 119, MET: 3 },
                { name: '–ê—ç—Ä–æ–±–Ω–∞—è (–∫–∞—Ä–¥–∏–æ)', hrFrom: 120, hrTo: 139, MET: 5 },
                { name: '–ê–Ω–∞—ç—Ä–æ–±–Ω–∞—è (–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, –∫–æ–≥–¥–∞ —Ç—è–∂–µ–ª–æ)', hrFrom: 140, hrTo: 181, MET: 8 }
            ];
        }, []);

        const [zones, setZones] = React.useState(lsGet('heys_hr_zones', defaultZones));
        const [zonesSaved, setZonesSaved] = React.useState(false);

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è)
        React.useEffect(() => {
            let cancelled = false;
            const clientId = window.HEYS && window.HEYS.currentClientId;
            const cloud = window.HEYS && window.HEYS.cloud;

            const reloadData = () => {
                if (cancelled) return;

                const newProfile = lsGet('heys_profile', DEFAULT_PROFILE);
                newProfile.revision = newProfile.revision || 0;
                newProfile.updatedAt = newProfile.updatedAt || 0;

                // üîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ—Ñ–∏–ª—è
                const isDefault = newProfile.weight === 70 && newProfile.height === 175 && newProfile.age === 30;
                console.log('[Profile Load] clientId:', (window.HEYS?.currentClientId || '').substring(0, 8),
                    '| isDefault:', isDefault,
                    '| weight:', newProfile.weight, '| height:', newProfile.height, '| age:', newProfile.age,
                    '| updatedAt:', newProfile.updatedAt, '| revision:', newProfile.revision);

                // –£–º–Ω—ã–π reload: –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ
                setProfile(prev => {
                    const prevUpdatedAt = prev.updatedAt || 0;
                    const newUpdatedAt = newProfile.updatedAt || 0;
                    if (prevUpdatedAt > newUpdatedAt) {
                        return prev; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
                    }
                    return newProfile;
                });

                const newZones = lsGet('heys_hr_zones', defaultZones);
                newZones.revision = newZones.revision || 0;
                newZones.updatedAt = newZones.updatedAt || 0;

                setZones(prev => {
                    const prevUpdatedAt = prev.updatedAt || 0;
                    const newUpdatedAt = newZones.updatedAt || 0;
                    if (prevUpdatedAt > newUpdatedAt) {
                        return prev;
                    }
                    return newZones;
                });
            };

            if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
                if (typeof cloud.shouldSyncClient === 'function' ? cloud.shouldSyncClient(clientId, 4000) : true) {
                    cloud.bootstrapClientSync(clientId)
                        .then(() => {
                            setTimeout(reloadData, 150); // –ö–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
                        })
                        .catch((err) => {
                            console.warn('[HEYS] Profile sync failed, using local cache:', err?.message || err);
                            reloadData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        });
                } else {
                    reloadData();
                }
            } else {
                reloadData();
            }

            return () => { cancelled = true; };
        }, [window.HEYS && window.HEYS.currentClientId]);

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ wizard'–∞
        React.useEffect(() => {
            const handleProfileUpdate = (e) => {
                console.log('[Profile] Received profile-updated event from:', e?.detail?.source);
                const newProfile = lsGet('heys_profile', DEFAULT_PROFILE);
                setProfile(newProfile);
            };

            window.addEventListener('heys:profile-updated', handleProfileUpdate);
            return () => window.removeEventListener('heys:profile-updated', handleProfileUpdate);
        }, []);

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ "–∏–¥—ë—Ç –≤–≤–æ–¥" –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
        const [profilePending, setProfilePending] = React.useState(false);
        const [zonesPending, setZonesPending] = React.useState(false);
        const profileInitRef = React.useRef(true);
        const zonesInitRef = React.useRef(true);

        React.useEffect(() => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
            if (profileInitRef.current) {
                profileInitRef.current = false;
                return;
            }
            // Debounced —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (1000ms ‚Äî —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ)
            setProfilePending(true);
            setProfileSaved(false);
            setFieldStatus('pending');
            const timer = setTimeout(() => {
                // üîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                const clientId = (window.HEYS && window.HEYS.currentClientId) || '';
                console.log('[Profile Save] clientId:', clientId?.substring(0, 8), '| weight:', profile.weight, '| height:', profile.height, '| age:', profile.age, '| updatedAt:', profile.updatedAt);
                lsSet('heys_profile', profile);

                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Å —Å–ø–∏—Å–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
                let currentClientId = localStorage.getItem('heys_client_current');
                // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ JSON string
                if (currentClientId && currentClientId.startsWith('"')) {
                    try { currentClientId = JSON.parse(currentClientId); } catch (e) { }
                }
                if (currentClientId && profile.firstName) {
                    try {
                        const clientsRaw = localStorage.getItem('heys_clients');
                        const clients = clientsRaw ? JSON.parse(clientsRaw) : [];
                        const updatedClients = clients.map(c =>
                            c.id === currentClientId ? { ...c, name: profile.firstName } : c
                        );
                        localStorage.setItem('heys_clients', JSON.stringify(updatedClients));

                        // –°–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                        window.dispatchEvent(new CustomEvent('heys:clients-updated', {
                            detail: { clients: updatedClients, source: 'profile-settings' }
                        }));

                        // ‚ö†Ô∏è Cloud sync –∏–º–µ–Ω–∏ –æ—Ç–∫–ª—é—á—ë–Ω:
                        // - REST API read-only (PATCH –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è CORS)
                        // - clients.name —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫—É—Ä–∞—Ç–æ—Ä–æ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
                        // - –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage
                    } catch (e) {
                        console.warn('[Profile] Failed to sync client name:', e);
                    }
                }

                setProfilePending(false);
                setProfileSaved(true);
                setFieldStatus('saved');
                setTimeout(() => {
                    setProfileSaved(false);
                    setFieldStatus('idle');
                    setLastEditedField(null);
                }, 2000);
            }, 1000);
            return () => clearTimeout(timer);
        }, [profile]);
        React.useEffect(() => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
            if (zonesInitRef.current) {
                zonesInitRef.current = false;
                return;
            }
            // Debounced —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–æ–Ω (1000ms)
            setZonesPending(true);
            setZonesSaved(false);
            const timer = setTimeout(() => {
                lsSet('heys_hr_zones', zones);
                setZonesPending(false);
                setZonesSaved(true);
                setTimeout(() => setZonesSaved(false), 2000);
            }, 1000);
            return () => clearTimeout(timer);
        }, [zones]);

        const maxHR = Math.max(0, 220 - toNum(profile.age || 0));
        const calPerMinPerMET = round1(toNum(profile.weight || 0) * 0.0175); // –∫–∞–ª/–º–∏–Ω –Ω–∞ 1 MET

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
        const [lastEditedField, setLastEditedField] = React.useState(null);
        const [fieldStatus, setFieldStatus] = React.useState('idle'); // 'idle' | 'pending' | 'saved'

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º
        const FieldStatus = ({ fieldKey }) => {
            if (lastEditedField !== fieldKey) return null;
            if (fieldStatus === 'pending') {
                return React.createElement('span', {
                    style: { marginLeft: '6px', color: '#f59e0b', fontSize: '12px', fontWeight: 500 }
                }, '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...');
            }
            if (fieldStatus === 'saved') {
                return React.createElement('span', {
                    style: { marginLeft: '6px', color: '#22c55e', fontSize: '12px', fontWeight: 500 }
                }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }
            return null;
        };

        function updateProfileField(key, value) {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
            const validator = PROFILE_VALIDATORS[key];
            const validatedValue = validator ? validator(value) : value;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "pending" –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—è
            setLastEditedField(key);
            setFieldStatus('pending');

            const newProfile = {
                ...profile,
                [key]: validatedValue,
                revision: (profile.revision || 0) + 1,
                updatedAt: Date.now()
            };
            setProfile(newProfile);
        }
        function updateZone(i, patch) {
            setZones(prev => {
                const updated = prev.map((z, idx) => idx === i ? { ...z, ...patch } : z);
                // –î–æ–±–∞–≤–ª—è–µ–º revision/updatedAt –∫ –º–∞—Å—Å–∏–≤—É (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è JSON)
                updated.revision = (prev.revision || 0) + 1;
                updated.updatedAt = Date.now();
                return updated;
            });
        }
        function resetZones() { if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã –∫ —à–∞–±–ª–æ–Ω—É?')) setZones(defaultZones); }

        // –ü—Ä–µ—Å–µ—Ç—ã –¥–µ—Ñ–∏—Ü–∏—Ç–∞/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞ –∫–∞–ª–æ—Ä–∏–π
        const DEFICIT_PRESETS = [
            { value: -20, label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üî•üî•', color: '#ef4444' },
            { value: -15, label: '–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üî•', color: '#f97316' },
            { value: -10, label: '–£–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üéØ', color: '#eab308' },
            { value: 0, label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞', emoji: '‚öñÔ∏è', color: '#22c55e' },
            { value: 10, label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™', color: '#3b82f6' },
            { value: 15, label: '–ê–∫—Ç–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™üí™', color: '#3b82f6' }
        ];

        const getDeficitInfo = (val) => {
            const preset = DEFICIT_PRESETS.find(p => p.value === val);
            if (preset) return preset;
            // –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            if (val < -10) return { emoji: 'üî•üî•', color: '#ef4444', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç' };
            if (val < 0) return { emoji: 'üî•', color: '#f97316', label: '–î–µ—Ñ–∏—Ü–∏—Ç' };
            if (val === 0) return { emoji: '‚öñÔ∏è', color: '#22c55e', label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ' };
            if (val <= 10) return { emoji: 'üí™', color: '#3b82f6', label: '–ü—Ä–æ—Ñ–∏—Ü–∏—Ç' };
            return { emoji: 'üí™üí™', color: '#3b82f6', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä' };
        };

        return React.createElement('div', { className: 'page page-user' },
            React.createElement('div', { className: 'profile-accordion' },

                // === –°–ï–ö–¶–ò–Ø 1: –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
                React.createElement(ProfileSection, {
                    id: 'basic',
                    icon: 'üë§',
                    title: '–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
                    subtitle: '–†–æ—Å—Ç, –≤–µ—Å, –≤–æ–∑—Ä–∞—Å—Ç, —Ü–µ–ª–∏',
                    tone: 'blue',
                    expanded: expandedSections.basic,
                    onToggle: () => toggleSection('basic')
                },
                    React.createElement('div', { className: 'profile-section__fields' },

                        // === –ì–†–£–ü–ü–ê 1: –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ===
                        React.createElement(ProfileFieldGroup, { icon: 'üë§', title: '–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' },
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ò–º—è'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { value: profile.firstName, onChange: e => updateProfileField('firstName', e.target.value) }), React.createElement(FieldStatus, { fieldKey: 'firstName' })),
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–§–∞–º–∏–ª–∏—è'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { value: profile.lastName, onChange: e => updateProfileField('lastName', e.target.value) }), React.createElement(FieldStatus, { fieldKey: 'lastName' })),
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ü–æ–ª'), React.createElement('span', { className: 'sep' }, '-'),
                                React.createElement('select', { value: profile.gender, onChange: e => updateProfileField('gender', e.target.value) },
                                    React.createElement('option', { value: '–ú—É–∂—Å–∫–æ–π' }, '–ú—É–∂—Å–∫–æ–π'),
                                    React.createElement('option', { value: '–ñ–µ–Ω—Å–∫–∏–π' }, '–ñ–µ–Ω—Å–∫–∏–π'),
                                    React.createElement('option', { value: '–î—Ä—É–≥–æ–µ' }, '–î—Ä—É–≥–æ–µ')
                                ),
                                React.createElement(FieldStatus, { fieldKey: 'gender' })
                            ),
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è'), React.createElement('span', { className: 'sep' }, '-'),
                                React.createElement('input', { type: 'date', value: profile.birthDate || '', onChange: e => updateProfileField('birthDate', e.target.value), style: { width: '140px' } }),
                                React.createElement(FieldStatus, { fieldKey: 'birthDate' }),
                                profile.birthDate && React.createElement('span', { style: { marginLeft: '8px', color: 'var(--gray-600)' } }, `(${calcAgeFromBirthDate(profile.birthDate)} –ª–µ—Ç)`)
                            ),
                            !profile.birthDate && React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', value: profile.age, onChange: e => updateProfileField('age', Number(e.target.value) || 0), onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'age' })),
                            // –¢—Ä–µ–∫–∏–Ω–≥ –æ—Å–æ–±–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω)
                            profile.gender === '–ñ–µ–Ω—Å–∫–∏–π' && React.createElement('div', { className: 'inline-field cycle-tracking-toggle' },
                                React.createElement('label', null, 'üå∏ –û—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥'),
                                React.createElement('span', { className: 'sep' }, '-'),
                                React.createElement('label', { className: 'toggle-switch' },
                                    React.createElement('input', {
                                        type: 'checkbox',
                                        checked: !!profile.cycleTrackingEnabled,
                                        onChange: e => updateProfileField('cycleTrackingEnabled', e.target.checked)
                                    }),
                                    React.createElement('span', { className: 'toggle-slider' })
                                ),
                                React.createElement('span', { className: 'cycle-toggle-hint' },
                                    profile.cycleTrackingEnabled ? '–í–∫–ª—é—á—ë–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'
                                )
                            )
                        ),

                        // === –ì–†–£–ü–ü–ê 2: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ª–∞ ===
                        React.createElement(ProfileFieldGroup, { icon: 'üìè', title: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ª–∞' },
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–†–æ—Å—Ç (—Å–º)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', value: profile.height, onChange: e => updateProfileField('height', Number(e.target.value) || 0), onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'height' })),
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ë–∞–∑–æ–≤—ã–π –≤–µ—Å (–∫–≥)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', step: '1', value: profile.baseWeight || profile.weight, onChange: e => updateProfileField('baseWeight', Number(e.target.value) || 0), onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'baseWeight' })),
                            // –¢–µ–∫—É—â–∏–π –≤–µ—Å (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞)
                            (() => {
                                // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –≤–µ—Å–æ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
                                let currentWeight = null;
                                let weightDate = null;
                                const today = new Date();
                                for (let i = 0; i < 30; i++) {
                                    const d = new Date(today);
                                    d.setDate(d.getDate() - i);
                                    const key = 'heys_dayv2_' + d.toISOString().slice(0, 10);
                                    const dayData = lsGet(key, null);
                                    if (dayData && dayData.weightMorning > 0) {
                                        currentWeight = dayData.weightMorning;
                                        weightDate = d.toISOString().slice(0, 10);
                                        break;
                                    }
                                }
                                const baseWeight = profile.baseWeight || profile.weight;
                                const diff = currentWeight && baseWeight ? round1(currentWeight - baseWeight) : null;
                                return React.createElement('div', { className: 'inline-field' },
                                    React.createElement('label', null, '‚öñÔ∏è –¢–µ–∫—É—â–∏–π –≤–µ—Å'),
                                    React.createElement('span', { className: 'sep' }, '-'),
                                    currentWeight
                                        ? React.createElement('span', { style: { fontWeight: 600 } },
                                            `${currentWeight} –∫–≥`,
                                            diff !== null && diff !== 0 && React.createElement('span', { style: { marginLeft: '8px', fontSize: '13px', color: diff < 0 ? '#22c55e' : diff > 0 ? '#f97316' : 'var(--gray-500)' } },
                                                diff > 0 ? `+${diff}` : diff, ' –æ—Ç –±–∞–∑—ã'
                                            )
                                        )
                                        : React.createElement('span', { style: { color: 'var(--gray-400)', fontStyle: 'italic' } }, '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'),
                                    weightDate && React.createElement('span', { style: { marginLeft: '8px', fontSize: '12px', color: 'var(--gray-400)' } },
                                        `(${new Date(weightDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })})`
                                    )
                                );
                            })(),
                            React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–¶–µ–ª–µ–≤–æ–π –≤–µ—Å (–∫–≥)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', step: '1', value: profile.weightGoal || 0, onChange: e => updateProfileField('weightGoal', Number(e.target.value) || 0), placeholder: '0 = –Ω–µ –∑–∞–¥–∞–Ω', onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'weightGoal' })),

                            // === –ü–†–û–î–í–ò–ù–£–¢–´–ô –†–ê–°–ß–Å–¢ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –¶–ï–õ–ò ===
                            (() => {
                                const startWeight = toNum(profile.baseWeight || profile.weight || 70);
                                const goalWeight = toNum(profile.weightGoal);
                                const deficitPct = toNum(profile.deficitPctTarget) || 0;
                                const height = toNum(profile.height || 175) / 100;
                                const age = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : toNum(profile.age || 30);
                                const gender = profile.gender;

                                // –ï—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–∏ –∏–ª–∏ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                                if (!goalWeight || goalWeight <= 0) return null;

                                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–µ—Å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞
                                let currentWeight = startWeight;
                                for (let i = 0; i < 30; i++) {
                                    const d = new Date();
                                    d.setDate(d.getDate() - i);
                                    const key = 'heys_dayv2_' + d.toISOString().slice(0, 10);
                                    const dayData = lsGet(key, null);
                                    if (dayData && dayData.weightMorning > 0) {
                                        currentWeight = dayData.weightMorning;
                                        break;
                                    }
                                }

                                const weightToLose = round1(currentWeight - goalWeight);
                                if (weightToLose <= 0) {
                                    return React.createElement('div', {
                                        className: 'goal-calculator', style: {
                                            marginTop: '12px', padding: '12px 14px', background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)',
                                            borderRadius: '10px', border: '1px solid #86efac'
                                        }
                                    },
                                        React.createElement('div', { style: { fontWeight: 600, color: '#15803d', display: 'flex', alignItems: 'center', gap: '6px' } },
                                            'üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!',
                                            React.createElement('span', { style: { fontWeight: 400, fontSize: '13px', color: '#166534' } },
                                                weightToLose < 0 ? `–í—ã –Ω–∞ ${Math.abs(weightToLose)} –∫–≥ –Ω–∏–∂–µ —Ü–µ–ª–∏` : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!'
                                            )
                                        )
                                    );
                                }

                                // === –ù–ê–£–ß–ù–´–ô –†–ê–°–ß–Å–¢ ===
                                // BMR –ø–æ Mifflin-St Jeor (Mifflin MD et al., Am J Clin Nutr 1990)
                                // –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω ADA –∫–∞–∫ –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –¥–ª—è –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥–µ–π
                                const bmr = gender === '–ñ–µ–Ω—Å–∫–∏–π'
                                    ? round1(447.593 + 9.247 * currentWeight + 3.098 * (height * 100) - 4.330 * age)
                                    : round1(88.362 + 13.397 * currentWeight + 4.799 * (height * 100) - 5.677 * age);

                                // === –ê–î–ê–ü–¢–ò–í–ù–´–ô TDEE ===
                                // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
                                // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (‚â•3 –¥–Ω–µ–π) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π TDEE
                                // –ò–Ω–∞—á–µ ‚Äî —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ –º–Ω–æ–∂–∏—Ç–µ–ª—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

                                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ 7 –¥–Ω–µ–π
                                const activityDays = [];
                                for (let i = 0; i < 7; i++) {
                                    const d = new Date();
                                    d.setDate(d.getDate() - i);
                                    const dateKey = d.toISOString().split('T')[0];
                                    const dayData = lsGet(`heys_dayv2_${dateKey}`, null);
                                    if (dayData) {
                                        // –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç –±–µ–∑ MET)
                                        const trainings = dayData.trainings || [];
                                        let trainKcal = 0;
                                        trainings.forEach(t => {
                                            const zones = t.z || [0, 0, 0, 0];
                                            const mets = [2.5, 6, 8, 10]; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ MET –ø–æ –∑–æ–Ω–∞–º
                                            zones.forEach((min, zi) => {
                                                trainKcal += (min || 0) * ((mets[zi] * currentWeight * 0.0175) - 1);
                                            });
                                        });

                                        // –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç —à–∞–≥–æ–≤
                                        const stepsKcal = (dayData.steps || 0) * 0.7 / 1000 * currentWeight * (gender === '–ñ–µ–Ω—Å–∫–∏–π' ? 0.5 : 0.57);

                                        // –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                                        const householdMin = (dayData.householdActivities || []).reduce((s, h) => s + (+h.minutes || 0), dayData.householdMin || 0);
                                        const householdKcal = householdMin * ((2.5 * currentWeight * 0.0175) - 1);

                                        const totalActivityKcal = Math.round(trainKcal + stepsKcal + householdKcal);

                                        // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–Ω–∏ —Å —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏–ª–∏ –¥–∞–Ω–Ω—ã–º–∏
                                        if (dayData.steps > 0 || trainings.length > 0 || householdMin > 0) {
                                            activityDays.push({
                                                date: dateKey,
                                                activityKcal: totalActivityKcal,
                                                tdee: bmr + totalActivityKcal
                                            });
                                        }
                                    }
                                }

                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º TDEE
                                let tdee, tdeeSource;
                                const MIN_DAYS_FOR_REAL_TDEE = 3;

                                if (activityDays.length >= MIN_DAYS_FOR_REAL_TDEE) {
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî —Å—Ä–µ–¥–Ω–∏–π TDEE –∑–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–Ω–∏
                                    const avgTdee = activityDays.reduce((s, d) => s + d.tdee, 0) / activityDays.length;
                                    tdee = round1(avgTdee);
                                    tdeeSource = 'real';
                                } else {
                                    // –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π TDEE –ø–æ –º–Ω–æ–∂–∏—Ç–µ–ª—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (FAO/WHO/UNU 2001)
                                    const activityMultipliers = {
                                        'sedentary': 1.2,       // –°–∏–¥—è—á–∏–π (–æ—Ñ–∏—Å, –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)
                                        'light': 1.375,         // –õ—ë–≥–∫–∞—è (1-3 —Ç—Ä–µ–Ω/–Ω–µ–¥)
                                        'moderate': 1.55,       // –£–º–µ—Ä–µ–Ω–Ω–∞—è (3-5 —Ç—Ä–µ–Ω/–Ω–µ–¥)
                                        'active': 1.725,        // –í—ã—Å–æ–∫–∞—è (6-7 —Ç—Ä–µ–Ω/–Ω–µ–¥)
                                        'very_active': 1.9      // –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è (–∞—Ç–ª–µ—Ç—ã)
                                    };
                                    const profileActivity = profile?.activityLevel || 'moderate';
                                    const activityMultiplier = activityMultipliers[profileActivity] || 1.55;
                                    tdee = round1(bmr * activityMultiplier);
                                    tdeeSource = 'theoretical';
                                }

                                // –î–Ω–µ–≤–Ω–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π
                                const dailyDeficit = Math.abs(deficitPct) > 0 ? round1(tdee * Math.abs(deficitPct) / 100) : 0;

                                // === –°–û–°–¢–ê–í –ü–û–¢–ï–†–ò –í–ï–°–ê ===
                                // Forbes GB (1987, 2000): —Å–æ—Å—Ç–∞–≤ –ø–æ—Ç–µ—Ä–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
                                // Lean mass = –º—ã—à—Ü—ã + –≥–ª–∏–∫–æ–≥–µ–Ω + —Å–≤—è–∑–∞–Ω–Ω–∞—è –≤–æ–¥–∞
                                // –ü—Ä–∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ + —Å–∏–ª–æ–≤—ã–µ: –¥–æ 90% –∂–∏—Ä–∞ –≤–æ–∑–º–æ–∂–Ω–æ
                                // –ë–µ–∑ —Å–∏–ª–æ–≤—ã—Ö: 75-80% –∂–∏—Ä, 20-25% lean mass (–∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö ~50% –≤–æ–¥–∞ –≥–ª–∏–∫–æ–≥–µ–Ω–∞)
                                const isAggressive = Math.abs(deficitPct) > 20; // –ü–æ—Ä–æ–≥ —Å–Ω–∏–∂–µ–Ω –¥–æ 20% (–Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω)
                                const isVeryAggressive = Math.abs(deficitPct) > 30;

                                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: —Ä–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∂–∏—Ä, –≥–ª–∏–∫–æ–≥–µ–Ω+–≤–æ–¥—É, –∏ —á–∏—Å—Ç—ã–µ –º—ã—à—Ü—ã
                                // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ –≤–µ—Å–∞ —Å–Ω–∞—á–∞–ª–∞ —É—Ö–æ–¥–∏—Ç –≥–ª–∏–∫–æ–≥–µ–Ω (—Å 3-4–≥ –≤–æ–¥—ã –Ω–∞ 1–≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞)
                                let fatPercent, glycogenWaterPercent, leanMusclePercent;
                                if (isVeryAggressive) {
                                    fatPercent = 0.55;           // –°–∏–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç: –±–æ–ª—å—à–µ –º—ã—à—Ü —Ç–µ—Ä—è–µ—Ç—Å—è
                                    glycogenWaterPercent = 0.25; // –ì–ª–∏–∫–æ–≥–µ–Ω + —Å–≤—è–∑–∞–Ω–Ω–∞—è –≤–æ–¥–∞
                                    leanMusclePercent = 0.20;    // –ß–∏—Å—Ç–∞—è –º—ã—à–µ—á–Ω–∞—è —Ç–∫–∞–Ω—å
                                } else if (isAggressive) {
                                    fatPercent = 0.65;
                                    glycogenWaterPercent = 0.22;
                                    leanMusclePercent = 0.13;
                                } else {
                                    fatPercent = 0.77;           // Hall KD (2008): ~77% –ø—Ä–∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ
                                    glycogenWaterPercent = 0.18; // ~400–≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ + 1.2-1.6–∫–≥ –≤–æ–¥—ã
                                    leanMusclePercent = 0.05;    // –ú–∏–Ω–∏–º—É–º –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ + —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö
                                }

                                // –ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–∫–∫–∞–ª/–∫–≥) ‚Äî –Ω–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                const KCAL_PER_KG_FAT = 7700;           // Hall KD (2008): –∂–∏—Ä–æ–≤–∞—è —Ç–∫–∞–Ω—å ~7700 –∫–∫–∞–ª/–∫–≥
                                const KCAL_PER_KG_LEAN_MUSCLE = 1100;   // Forbes GB (2000): ~20% –±–µ–ª–æ–∫, ~75% –≤–æ–¥–∞
                                const KCAL_PER_KG_GLYCOGEN_WATER = 700; // –ì–ª–∏–∫–æ–≥–µ–Ω 4–∫–∫–∞–ª/–≥, –Ω–æ 1–≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ —Å–≤—è–∑—ã–≤–∞–µ—Ç 3-4–≥ –≤–æ–¥—ã

                                // –°–∫–æ–ª—å–∫–æ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å
                                const fatToLose = round1(weightToLose * fatPercent);
                                const glycogenWaterToLose = round1(weightToLose * glycogenWaterPercent);
                                const leanMuscleToLose = round1(weightToLose * leanMusclePercent);

                                // –û–±—â–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π –Ω—É–∂–Ω—ã–π (Hall KD, 2011)
                                // –ñ–∏—Ä: 7700 –∫–∫–∞–ª/–∫–≥, –º—ã—à—Ü—ã: 1100 –∫–∫–∞–ª/–∫–≥, –≥–ª–∏–∫–æ–≥–µ–Ω+–≤–æ–¥–∞: ~700 –∫–∫–∞–ª/–∫–≥
                                const totalKcalDeficit = Math.round(
                                    fatToLose * KCAL_PER_KG_FAT +
                                    leanMuscleToLose * KCAL_PER_KG_LEAN_MUSCLE +
                                    glycogenWaterToLose * KCAL_PER_KG_GLYCOGEN_WATER
                                );

                                // –î–Ω–µ–π –¥–æ —Ü–µ–ª–∏
                                const daysToGoal = dailyDeficit > 0 ? Math.ceil(totalKcalDeficit / dailyDeficit) : null;
                                const weeksToGoal = daysToGoal ? Math.ceil(daysToGoal / 7) : null;
                                const monthsToGoal = daysToGoal ? round1(daysToGoal / 30) : null;

                                // –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞)
                                // –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –Ω–µ –≤—Å—è –ø–æ—Ç–µ—Ä—è = –∂–∏—Ä
                                const effectiveKcalPerKg = fatPercent * KCAL_PER_KG_FAT +
                                    glycogenWaterPercent * KCAL_PER_KG_GLYCOGEN_WATER +
                                    leanMusclePercent * KCAL_PER_KG_LEAN_MUSCLE;
                                const kgPerWeek = dailyDeficit > 0 ? round1((dailyDeficit * 7) / effectiveKcalPerKg) : 0;

                                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (ACSM Position Stand 2009)
                                const warnings = [];
                                if (isVeryAggressive) {
                                    warnings.push({ icon: '‚ö†Ô∏è', text: '–î–µ—Ñ–∏—Ü–∏—Ç >30% ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –º—ã—à—Ü –∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏', color: '#dc2626' });
                                } else if (isAggressive) {
                                    warnings.push({ icon: '‚ö°', text: '–î–µ—Ñ–∏—Ü–∏—Ç >20% ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—à—Ü', color: '#f97316' });
                                }
                                if (kgPerWeek > 1) {
                                    warnings.push({ icon: 'üèÉ', text: `${kgPerWeek} –∫–≥/–Ω–µ–¥ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è ACSM: 0.5-0.9 –∫–≥/–Ω–µ–¥`, color: '#eab308' });
                                }
                                if (kgPerWeek > 1.5) {
                                    warnings.push({ icon: 'üö®', text: '–ü–æ—Ç–µ—Ä—è >1.5 –∫–≥/–Ω–µ–¥ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –º—ã—à—Ü –Ω–∞ 20-30%', color: '#dc2626' });
                                }
                                if (deficitPct === 0) {
                                    warnings.push({ icon: 'üìä', text: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–µ—Ñ–∏—Ü–∏—Ç –≤ "–¶–µ–ª–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º" –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞', color: '#6b7280' });
                                }

                                // –î–∞—Ç–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
                                const targetDate = daysToGoal ? new Date(Date.now() + daysToGoal * 24 * 60 * 60 * 1000) : null;

                                return React.createElement('div', {
                                    className: 'goal-calculator', style: {
                                        marginTop: '12px', padding: '14px 16px',
                                        background: 'linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%)',
                                        borderRadius: '12px', border: '1px solid #bfdbfe',
                                        position: 'relative'
                                    }
                                },
                                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                                    React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' } },
                                        React.createElement('span', {
                                            style: { fontWeight: 600, color: '#1e40af', fontSize: '14px' },
                                            title: '–ò—Å—Ç–æ—á–Ω–∏–∫–∏: Mifflin (1990), Hall KD (2008), Forbes GB (2000), ACSM (2009)'
                                        }, 'üìê –†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏'),
                                        daysToGoal && React.createElement('span', {
                                            style: {
                                                padding: '4px 10px', background: '#3b82f6', color: '#fff', borderRadius: '12px', fontSize: '12px', fontWeight: 600
                                            }
                                        },
                                            weeksToGoal <= 4 ? `~${weeksToGoal} –Ω–µ–¥.` :
                                                monthsToGoal <= 12 ? `~${monthsToGoal} –º–µ—Å.` :
                                                    `~${round1(monthsToGoal / 12)} –≥.`
                                        )
                                    ),

                                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ TDEE
                                    React.createElement('div', {
                                        style: {
                                            display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '10px',
                                            padding: '6px 10px', borderRadius: '8px',
                                            background: tdeeSource === 'real' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(234, 179, 8, 0.1)',
                                            border: `1px solid ${tdeeSource === 'real' ? '#10b981' : '#eab308'}`
                                        }
                                    },
                                        React.createElement('span', { style: { fontSize: '12px' } },
                                            tdeeSource === 'real' ? 'üìä' : 'üìê'
                                        ),
                                        React.createElement('span', {
                                            style: {
                                                fontSize: '12px',
                                                color: tdeeSource === 'real' ? '#059669' : '#b45309'
                                            }
                                        },
                                            tdeeSource === 'real'
                                                ? `TDEE ${tdee} –∫–∫–∞–ª ‚Äî –ø–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º (${activityDays.length} –¥–Ω–µ–π)`
                                                : `TDEE ${tdee} –∫–∫–∞–ª ‚Äî —Ç–µ–æ—Ä–∏—è (–Ω—É–∂–Ω–æ ‚â•3 –¥–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)`
                                        )
                                    ),

                                    // –†–∞–∑–±–∏–≤–∫–∞ –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ (–Ω–∞—É—á–Ω–∞—è –º–æ–¥–µ–ª—å: –∂–∏—Ä + –≥–ª–∏–∫–æ–≥–µ–Ω/–≤–æ–¥–∞ + –º—ã—à—Ü—ã)
                                    React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', marginBottom: '10px' } },
                                        React.createElement('div', { style: { textAlign: 'center', padding: '8px', background: 'rgba(251, 191, 36, 0.15)', borderRadius: '8px' } },
                                            React.createElement('div', { style: { fontSize: '18px', fontWeight: 700, color: '#b45309' } }, `${fatToLose} –∫–≥`),
                                            React.createElement('div', { style: { fontSize: '11px', color: '#92400e' } }, `üî• –ñ–∏—Ä (${Math.round(fatPercent * 100)}%)`)
                                        ),
                                        React.createElement('div', { style: { textAlign: 'center', padding: '8px', background: 'rgba(59, 130, 246, 0.15)', borderRadius: '8px' } },
                                            React.createElement('div', { style: { fontSize: '18px', fontWeight: 700, color: '#1d4ed8' } }, `${glycogenWaterToLose} –∫–≥`),
                                            React.createElement('div', { style: { fontSize: '11px', color: '#1e40af' } }, `üíß –ì–ª–∏–∫–æ–≥–µ–Ω+–≤–æ–¥–∞`)
                                        ),
                                        React.createElement('div', { style: { textAlign: 'center', padding: '8px', background: 'rgba(239, 68, 68, 0.15)', borderRadius: '8px' } },
                                            React.createElement('div', { style: { fontSize: '18px', fontWeight: 700, color: '#dc2626' } }, `${leanMuscleToLose} –∫–≥`),
                                            React.createElement('div', { style: { fontSize: '11px', color: '#b91c1c' } }, `üí™ –ú—ã—à—Ü—ã (${Math.round(leanMusclePercent * 100)}%)`)
                                        )
                                    ),

                                    // –ö–∞–ª–æ—Ä–∏–∏ –∏ —Å—Ä–æ–∫–∏
                                    React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '10px' } },
                                        React.createElement('span', { className: 'pill', style: { fontSize: '12px' } },
                                            `üîã –ù—É–∂–Ω–æ —Å–∂–µ—á—å: ${(totalKcalDeficit / 1000).toFixed(0)}–∫ –∫–∫–∞–ª`
                                        ),
                                        dailyDeficit > 0 && React.createElement('span', { className: 'pill', style: { fontSize: '12px' } },
                                            `üìâ –î–µ—Ñ–∏—Ü–∏—Ç: ${dailyDeficit} –∫–∫–∞–ª/–¥–µ–Ω—å`
                                        ),
                                        kgPerWeek > 0 && React.createElement('span', { className: 'pill', style: { fontSize: '12px', background: kgPerWeek > 1 ? '#fef3c7' : '#dcfce7' } },
                                            `‚öñÔ∏è ~${kgPerWeek} –∫–≥/–Ω–µ–¥`
                                        ),
                                        targetDate && React.createElement('span', { className: 'pill', style: { fontSize: '12px' } },
                                            `üìÖ ${targetDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' })}`
                                        )
                                    ),

                                    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                                    warnings.length > 0 && React.createElement('div', { style: { marginTop: '8px' } },
                                        warnings.map((w, i) =>
                                            React.createElement('div', { key: i, style: { fontSize: '12px', color: w.color, display: 'flex', alignItems: 'center', gap: '4px', marginTop: '4px' } },
                                                w.icon, w.text
                                            )
                                        )
                                    ),

                                    // –§–æ—Ä–º—É–ª–∞
                                    React.createElement('div', { style: { marginTop: '10px', paddingTop: '8px', borderTop: '1px solid rgba(0,0,0,0.06)', fontSize: '11px', color: 'var(--gray-500)' } },
                                        `–§–æ—Ä–º—É–ª–∞: TDEE ${tdee} –∫–∫–∞–ª √ó ${Math.abs(deficitPct)}% –¥–µ—Ñ–∏—Ü–∏—Ç = ${dailyDeficit} –∫–∫–∞–ª/–¥–µ–Ω—å. `,
                                        `–ñ–∏—Ä 7700 –∫–∫–∞–ª/–∫–≥, –º—ã—à—Ü—ã 1100 –∫–∫–∞–ª/–∫–≥.`
                                    )
                                );
                            })()
                        ),

                        // === –ì–†–£–ü–ü–ê 3: –¶–µ–ª–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º ===
                        React.createElement(ProfileFieldGroup, { icon: 'üéØ', title: '–¶–µ–ª–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º' },
                            // –¶–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç: –ø—Ä–µ—Å–µ—Ç—ã + —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ
                            (() => {
                                const currentVal = toNum(profile.deficitPctTarget || 0);
                                const isCustom = !DEFICIT_PRESETS.some(p => p.value === currentVal);
                                const info = getDeficitInfo(currentVal);

                                return React.createElement('div', { className: 'inline-field', style: { flexWrap: 'wrap', gap: '8px' } },
                                    React.createElement('label', { style: { fontWeight: 600 } }, '–¶–µ–ª—å –ø–æ –∫–∞–ª–æ—Ä–∏—è–º'),
                                    React.createElement('span', { className: 'sep' }, '-'),
                                    React.createElement('select', {
                                        value: isCustom ? 'custom' : String(currentVal),
                                        onChange: e => {
                                            if (e.target.value !== 'custom') {
                                                updateProfileField('deficitPctTarget', Number(e.target.value));
                                            }
                                        },
                                        style: { width: '200px', fontWeight: 600 }
                                    },
                                        ...DEFICIT_PRESETS.map(p =>
                                            React.createElement('option', { key: p.value, value: String(p.value) },
                                                `${p.emoji} ${p.value > 0 ? '+' : ''}${p.value}% ‚Äî ${p.label}`
                                            )
                                        ),
                                        React.createElement('option', { value: 'custom' }, '‚úèÔ∏è –°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ...')
                                    ),
                                    isCustom && React.createElement('input', {
                                        type: 'number',
                                        step: '1',
                                        min: '-50',
                                        max: '50',
                                        value: currentVal,
                                        onChange: e => updateProfileField('deficitPctTarget', Number(e.target.value) || 0),
                                        style: { width: '60px', marginLeft: '4px', fontWeight: 700, textAlign: 'center' }
                                    }),
                                    React.createElement('span', { style: { color: info.color, fontWeight: 600, marginLeft: '6px' } },
                                        isCustom ? `${info.emoji} ${currentVal > 0 ? '+' : ''}${currentVal}%` : ''
                                    ),
                                    React.createElement(FieldStatus, { fieldKey: 'deficitPctTarget' })
                                );
                            })(),
                            // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞: –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ + —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ
                            (() => {
                                const INSULIN_PRESETS = [
                                    { value: 2.5, label: '–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º', desc: '—Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã, –Ω–∏–∑–∫–æ—É–≥–ª–µ–≤–æ–¥–∫–∞' },
                                    { value: 3, label: '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π', desc: '–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π' },
                                    { value: 4, label: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π', desc: '—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –ø–æ–ª–Ω–æ—Ç–µ' },
                                    { value: 4.5, label: '–ò–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å', desc: '–ø—Ä–µ–¥–¥–∏–∞–±–µ—Ç, –°–ü–ö–Ø' }
                                ];
                                const currentVal = toNum(profile.insulinWaveHours || 3);
                                const isCustom = !INSULIN_PRESETS.some(p => p.value === currentVal);
                                const currentPreset = INSULIN_PRESETS.find(p => p.value === currentVal);

                                return React.createElement('div', { className: 'inline-field', style: { flexWrap: 'wrap', gap: '8px' } },
                                    React.createElement('label', null, '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞'),
                                    React.createElement('span', { className: 'sep' }, '-'),
                                    React.createElement('select', {
                                        value: isCustom ? 'custom' : String(currentVal),
                                        onChange: e => {
                                            if (e.target.value === 'custom') {
                                                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ custom
                                            } else {
                                                updateProfileField('insulinWaveHours', Number(e.target.value));
                                            }
                                        },
                                        style: { width: '180px' }
                                    },
                                        ...INSULIN_PRESETS.map(p =>
                                            React.createElement('option', { key: p.value, value: String(p.value) }, `${p.value} —á ‚Äî ${p.label}`)
                                        ),
                                        React.createElement('option', { value: 'custom' }, '–°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ...')
                                    ),
                                    isCustom && React.createElement('input', {
                                        type: 'number',
                                        step: '0.5',
                                        min: '1',
                                        max: '8',
                                        value: currentVal,
                                        onChange: e => updateProfileField('insulinWaveHours', Number(e.target.value) || 3),
                                        style: { width: '60px', marginLeft: '4px' }
                                    }),
                                    React.createElement('span', { style: { color: 'var(--gray-500)', fontSize: '12px', marginLeft: '4px' } },
                                        currentPreset ? `(${currentPreset.desc})` : `(${currentVal} —á ‚Äî —Å–≤–æ—ë)`
                                    ),
                                    React.createElement(FieldStatus, { fieldKey: 'insulinWaveHours' })
                                );
                            })(),
                            // –ù–æ—Ä–º–∞ —Å–Ω–∞: –∞–≤—Ç–æ—Ä–∞—Å—á—ë—Ç —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π
                            (() => {
                                const age = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : toNum(profile.age || 30);
                                const sleepNorm = calcSleepNorm(age, profile.gender);
                                return React.createElement('div', { className: 'inline-field' },
                                    React.createElement('label', null, '–ù–æ—Ä–º–∞ —Å–Ω–∞'),
                                    React.createElement('span', { className: 'sep' }, '-'),
                                    React.createElement('span', { style: { fontWeight: 600, minWidth: '50px' } }, `${sleepNorm.hours} —á`),
                                    React.createElement('span', { style: { marginLeft: '8px', color: 'var(--gray-500)', fontSize: '13px' } },
                                        `(${sleepNorm.explanation})`
                                    )
                                );
                            })(),
                            React.createElement(EmojiStyleSelector, null)
                        ),
                        // BMI/BMR —Ä–∞—Å—á—ë—Ç + –Ω–æ—Ä–º–∞ –≤–æ–¥—ã + –ø—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏
                        (() => {
                            const w = toNum(profile.weight || 70);
                            const h = toNum(profile.height || 175) / 100; // –≤ –º–µ—Ç—Ä–∞—Ö
                            // –í–æ–∑—Ä–∞—Å—Ç: –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
                            const a = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : toNum(profile.age || 30);
                            const bmi = h > 0 ? round1(w / (h * h)) : 0;
                            const bmr = profile.gender === '–ñ–µ–Ω—Å–∫–∏–π'
                                ? round1(447.593 + 9.247 * w + 3.098 * (h * 100) - 4.330 * a)
                                : round1(88.362 + 13.397 * w + 4.799 * (h * 100) - 5.677 * a);
                            // BMI –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                            let bmiCat = '', bmiColor = '#6b7280';
                            if (bmi < 18.5) { bmiCat = '–Ω–µ–¥–æ–≤–µ—Å'; bmiColor = '#eab308'; }
                            else if (bmi < 25) { bmiCat = '–Ω–æ—Ä–º–∞'; bmiColor = '#22c55e'; }
                            else if (bmi < 30) { bmiCat = '–∏–∑–±—ã—Ç–æ–∫'; bmiColor = '#f97316'; }
                            else { bmiCat = '–æ–∂–∏—Ä–µ–Ω–∏–µ'; bmiColor = '#ef4444'; }

                            // –ù–æ—Ä–º–∞ –≤–æ–¥—ã: 30 –º–ª –Ω–∞ –∫–≥ –≤–µ—Å–∞
                            const waterNorm = round1(w * 30 / 1000); // –≤ –ª–∏—Ç—Ä–∞—Ö

                            // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–µ–≤–æ–º—É –≤–µ—Å—É
                            const wGoal = toNum(profile.weightGoal);
                            const weightDiff = wGoal > 0 ? round1(w - wGoal) : 0;
                            const deficitPct = toNum(profile.deficitPctTarget) || 0;

                            // –†–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç –∏ —Ü–µ–ª—å)
                            // 1 –∫–≥ –∂–∏—Ä–∞ ‚âà 7700 –∫–∫–∞–ª, –¥–µ—Ñ–∏—Ü–∏—Ç/–¥–µ–Ω—å = BMR * deficitPct%
                            let weeksToGoal = null;
                            if (wGoal > 0 && weightDiff !== 0 && deficitPct !== 0) {
                                const dailyDeficit = bmr * Math.abs(deficitPct) / 100;
                                const kgPerWeek = (dailyDeficit * 7) / 7700;
                                if (kgPerWeek > 0) {
                                    weeksToGoal = Math.ceil(Math.abs(weightDiff) / kgPerWeek);
                                }
                            }

                            return React.createElement('div', { style: { marginTop: '10px' } },
                                // –ü–∏–ª—é–ª–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
                                React.createElement('div', { className: 'row', style: { gap: '12px', flexWrap: 'wrap' } },
                                    React.createElement('div', { className: 'pill' }, `–ú–∞–∫—Å. –ø—É–ª—å—Å: ${maxHR} —É–¥/–º–∏–Ω`),
                                    React.createElement('div', { className: 'pill' }, `–ö–∞–ª/–º–∏–Ω –Ω–∞ 1 MET: ${calPerMinPerMET}`),
                                    React.createElement('div', { className: 'pill', style: { background: '#f0fdf4', border: '1px solid #86efac' } }, `BMR: ${bmr} –∫–∫–∞–ª/—Å—É—Ç`),
                                    React.createElement('div', { className: 'pill', style: { background: '#f0f9ff', border: `1px solid ${bmiColor}` } },
                                        `BMI: ${bmi}`,
                                        React.createElement('span', { style: { marginLeft: '4px', color: bmiColor, fontSize: '12px' } }, `(${bmiCat})`)
                                    ),
                                    React.createElement('div', { className: 'pill', style: { background: '#eff6ff', border: '1px solid #93c5fd' } }, `üíß –ù–æ—Ä–º–∞ –≤–æ–¥—ã: ${waterNorm} –ª/—Å—É—Ç`)
                                ),
                                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å)
                                wGoal > 0 && React.createElement('div', { style: { marginTop: '12px', padding: '10px 12px', background: 'var(--gray-50)', borderRadius: '8px' } },
                                    React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' } },
                                        React.createElement('span', { style: { fontWeight: 500 } }, `üéØ –¶–µ–ª—å: ${wGoal} –∫–≥`),
                                        React.createElement('span', { style: { color: weightDiff === 0 ? '#22c55e' : 'var(--gray-600)', fontWeight: weightDiff === 0 ? 600 : 400 } },
                                            weightDiff === 0 ? '‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ!' :
                                                weightDiff > 0 ? `–û—Å—Ç–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å: ${weightDiff} –∫–≥` :
                                                    `–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞–±—Ä–∞—Ç—å: ${Math.abs(weightDiff)} –∫–≥`
                                        )
                                    ),
                                    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                                    (() => {
                                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –≤–µ—Å–∞ (–±–∞–∑–æ–≤—ã–π –≤–µ—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ)
                                        const progressPct = weightDiff === 0 ? 100 : Math.max(0, Math.min(100, 100 - Math.abs(weightDiff) / Math.abs(w - wGoal) * 100)) || 0;
                                        const barColor = weightDiff === 0 ? '#22c55e' : weightDiff > 0 ? '#3b82f6' : '#3b82f6';
                                        return React.createElement('div', { style: { height: '8px', background: 'var(--gray-200)', borderRadius: '4px', overflow: 'hidden' } },
                                            React.createElement('div', { style: { height: '100%', width: (weightDiff === 0 ? 100 : 50) + '%', background: barColor, borderRadius: '4px', transition: 'width 0.3s' } })
                                        );
                                    })(),
                                    // –í—Ä–µ–º—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                                    weeksToGoal && deficitPct !== 0 && React.createElement('div', { style: { marginTop: '6px', fontSize: '13px', color: 'var(--gray-500)' } },
                                        `‚è± –ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ ${Math.abs(deficitPct)}%: ~${weeksToGoal} –Ω–µ–¥.`
                                    )
                                )
                            );
                        })(),
                        React.createElement('div', { className: 'muted', style: { marginTop: '6px' } },
                            '–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.'
                        )
                    ) // end profile-section__fields
                ), // end ProfileSection basic

                // === –°–ï–ö–¶–ò–Ø 2: –ü—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã ===
                React.createElement(ProfileSection, {
                    id: 'hrZones',
                    icon: 'üíì',
                    title: '–ü—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã',
                    subtitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–æ–Ω –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
                    badge: `${zones.length} –∑–æ–Ω`,
                    tone: 'rose',
                    expanded: expandedSections.hrZones,
                    onToggle: () => toggleSection('hrZones')
                },
                    React.createElement('div', { className: 'profile-section__fields' },
                        React.createElement('div', { className: 'row', style: { justifyContent: 'flex-end', marginBottom: '8px' } },
                            React.createElement('button', { className: 'btn btn-sm', onClick: resetZones }, '–°–±—Ä–æ—Å–∏—Ç—å')
                        ),
                        // –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—É–ª—å—Å–æ–≤—ã—Ö –∑–æ–Ω
                        React.createElement('div', { className: 'hr-zones-list' },
                            zones.map((z, i) => {
                                const calPerMin = round1((toNum(z.MET || 0) * calPerMinPerMET) - 1);
                                return React.createElement('div', {
                                    key: i, className: 'hr-zone-row', style: {
                                        display: 'flex', flexDirection: 'column', gap: '8px',
                                        padding: '12px 14px', marginBottom: '8px',
                                        background: 'rgba(255,255,255,0.7)', borderRadius: '12px',
                                        border: '1px solid rgba(244,63,94,0.15)'
                                    }
                                },
                                    // –ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã
                                    React.createElement('input', {
                                        value: z.name,
                                        onChange: e => updateZone(i, { name: e.target.value }),
                                        onFocus: e => e.target.select(),
                                        style: {
                                            width: '100%', padding: '8px 12px', fontSize: '14px', fontWeight: 600,
                                            border: '1px solid rgba(0,0,0,0.08)', borderRadius: '8px',
                                            background: 'rgba(255,255,255,0.9)'
                                        }
                                    }),
                                    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Ä—è–¥
                                    React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '8px', alignItems: 'center' } },
                                        // –ü—É–ª—å—Å –æ—Ç-–¥–æ
                                        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: 'rgba(244,63,94,0.08)', borderRadius: '8px' } },
                                            React.createElement('span', { style: { fontSize: '12px', color: 'var(--gray-500)' } }, 'üíì'),
                                            React.createElement('input', {
                                                type: 'number', value: z.hrFrom, onChange: e => updateZone(i, { hrFrom: Number(e.target.value) || 0 }), onFocus: e => e.target.select(),
                                                style: { width: '50px', padding: '4px 6px', fontSize: '13px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '6px' }
                                            }),
                                            React.createElement('span', { style: { color: 'var(--gray-400)' } }, '‚Äî'),
                                            React.createElement('input', {
                                                type: 'number', value: z.hrTo, onChange: e => updateZone(i, { hrTo: Number(e.target.value) || 0 }), onFocus: e => e.target.select(),
                                                style: { width: '50px', padding: '4px 6px', fontSize: '13px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '6px' }
                                            }),
                                            React.createElement('span', { style: { fontSize: '11px', color: 'var(--gray-400)' } }, '—É–¥/–º–∏–Ω')
                                        ),
                                        // MET
                                        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: 'rgba(59,130,246,0.08)', borderRadius: '8px' } },
                                            React.createElement('span', { style: { fontSize: '12px', color: 'var(--gray-500)' } }, '‚ö°'),
                                            React.createElement('span', { style: { fontSize: '12px', color: 'var(--gray-500)' } }, 'MET'),
                                            React.createElement('input', {
                                                type: 'number', step: '0.1', value: z.MET, onChange: e => updateZone(i, { MET: Number(e.target.value) || 0 }), onFocus: e => e.target.select(),
                                                style: { width: '45px', padding: '4px 6px', fontSize: '13px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '6px' }
                                            })
                                        ),
                                        // –ö–∞–ª–æ—Ä–∏–∏ –≤ –º–∏–Ω—É—Ç—É (computed)
                                        React.createElement('div', { style: { padding: '6px 12px', background: 'rgba(34,197,94,0.1)', borderRadius: '8px', marginLeft: 'auto' } },
                                            React.createElement('span', { style: { fontSize: '13px', fontWeight: 600, color: '#15803d' } }, `${calPerMin} –∫–∞–ª/–º–∏–Ω`)
                                        )
                                    )
                                );
                            })
                        ),
                        React.createElement('div', { className: 'muted', style: { marginTop: '8px', display: 'flex', alignItems: 'center', gap: '8px' } },
                            '–ú–∞–∫—Å –ø—É–ª—å—Å = 220 ‚àí –≤–æ–∑—Ä–∞—Å—Ç. –ö–∞–ª/–º–∏–Ω = MET √ó (–≤–µ—Å √ó 0.0175) ‚àí 1.',
                            zonesPending && React.createElement('span', { style: { color: '#f59e0b', fontSize: '13px', fontWeight: 500 } }, '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...'),
                            zonesSaved && React.createElement('span', { style: { color: '#22c55e', fontSize: '13px', fontWeight: 500 } }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
                        )
                    ) // end profile-section__fields
                ), // end ProfileSection hrZones

                // === –°–ï–ö–¶–ò–Ø 3: –ù–æ—Ä–º—ã –∏ –∑–æ–Ω—ã ===
                React.createElement(ProfileSection, {
                    id: 'norms',
                    icon: 'üìä',
                    title: '–ù–æ—Ä–º—ã –ø–∏—Ç–∞–Ω–∏—è',
                    subtitle: '–ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ë–ñ–£',
                    tone: 'violet',
                    expanded: expandedSections.norms,
                    onToggle: () => toggleSection('norms')
                },
                    React.createElement('div', { className: 'profile-section__fields' },
                        // –ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ (ratio zones)
                        React.createElement(HEYS_RatioZonesCard, null),
                        React.createElement(HEYS_NormsCard, null)
                    )
                ), // end ProfileSection norms

                // === –°–ï–ö–¶–ò–Ø 4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (PIN) ===
                React.createElement(ProfileSection, {
                    id: 'security',
                    icon: 'üîí',
                    title: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
                    subtitle: '–°–º–µ–Ω–∞ PIN –¥–ª—è –≤—Ö–æ–¥–∞',
                    tone: 'amber',
                    expanded: expandedSections.security,
                    onToggle: () => toggleSection('security')
                },
                    React.createElement('div', { className: 'profile-section__fields' },
                        React.createElement('div', { className: 'profile-field-group' },
                            React.createElement('div', { className: 'profile-field-group__header', style: { alignItems: 'center', gap: '8px' } },
                                React.createElement('span', { className: 'profile-field-group__icon' }, 'üìû'),
                                React.createElement('span', { className: 'profile-field-group__title' }, 'PIN –∫–ª–∏–µ–Ω—Ç–∞'),
                                React.createElement('span', { className: 'profile-field-group__badge' }, `Client ID: ${getShortClientId(getCurrentClientId())}`)
                            ),
                            React.createElement('div', { className: 'muted', style: { marginBottom: '8px' } }, '–ù–æ–≤—ã–π PIN –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä. –°—Ç–∞—Ä—ã–π PIN –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä—É.'),
                            React.createElement('div', { className: 'field-list' },
                                React.createElement('div', { className: 'inline-field' },
                                    React.createElement('label', null, '–ù–æ–≤—ã–π PIN'),
                                    React.createElement('span', { className: 'sep' }, '-'),
                                    React.createElement('input', {
                                        type: 'password',
                                        inputMode: 'numeric',
                                        pattern: '\\d*',
                                        maxLength: 4,
                                        value: pinForm.pin,
                                        onChange: e => setPinForm(prev => ({ ...prev, pin: e.target.value.replace(/[^0-9]/g, '').slice(0, 4) })),
                                        placeholder: '4 —Ü–∏—Ñ—Ä—ã',
                                        style: { width: '120px' }
                                    })
                                ),
                                React.createElement('div', { className: 'inline-field' },
                                    React.createElement('label', null, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ'),
                                    React.createElement('span', { className: 'sep' }, '-'),
                                    React.createElement('input', {
                                        type: 'password',
                                        inputMode: 'numeric',
                                        pattern: '\\d*',
                                        maxLength: 4,
                                        value: pinForm.confirm,
                                        onChange: e => setPinForm(prev => ({ ...prev, confirm: e.target.value.replace(/[^0-9]/g, '').slice(0, 4) })),
                                        placeholder: '–ï—â—ë —Ä–∞–∑',
                                        style: { width: '120px' }
                                    })
                                )
                            ),
                            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginTop: '10px' } },
                                React.createElement('button', {
                                    className: 'btn',
                                    onClick: handlePinUpdate,
                                    disabled: pinStatus === 'pending',
                                    style: { minWidth: '140px' }
                                }, pinStatus === 'pending' ? '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶' : '–û–±–Ω–æ–≤–∏—Ç—å PIN'),
                                pinStatus === 'pending' && React.createElement('span', { style: { color: '#f59e0b' } }, '‚è≥'),
                                pinStatus === 'success' && React.createElement('span', { style: { color: '#22c55e' } }, '‚úì –ì–æ—Ç–æ–≤–æ'),
                                pinStatus === 'error' && React.createElement('span', { style: { color: '#ef4444' } }, '‚ö†Ô∏è –û—à–∏–±–∫–∞')
                            ),
                            pinMessage && React.createElement('div', { className: 'muted', style: { marginTop: '6px', color: pinStatus === 'error' ? '#ef4444' : 'var(--gray-600)' } }, pinMessage)
                        )
                    )
                ), // end ProfileSection security

                // === –°–ï–ö–¶–ò–Ø 5: –ü–æ–¥–ø–∏—Å–∫–∞ (–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å HEYS.Subscription) ===
                React.createElement(ProfileSection, {
                    id: 'subscription',
                    icon: 'üíé',
                    title: '–ü–æ–¥–ø–∏—Å–∫–∞',
                    subtitle: (() => {
                        const cached = window.HEYS?.Subscription?.getCachedStatus?.();
                        if (!cached) return '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        const meta = window.HEYS.Subscription.getStatusMeta(cached.status);
                        return meta?.label || '–¢–∞—Ä–∏—Ñ –∏ –æ–ø–ª–∞—Ç–∞';
                    })(),
                    tone: 'emerald',
                    expanded: expandedSections.subscription,
                    onToggle: () => toggleSection('subscription')
                },
                    // –ü—Ä–æ—Å—Ç–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                    React.createElement(SubscriptionStatusSection)
                ),

                // === –°–ï–ö–¶–ò–Ø 6: –°–∏—Å—Ç–µ–º–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ===
                React.createElement(ProfileSection, {
                    id: 'system',
                    icon: '‚öôÔ∏è',
                    title: '–°–∏—Å—Ç–µ–º–∞',
                    subtitle: '–°–æ–≤–µ—Ç—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞',
                    tone: 'slate',
                    expanded: expandedSections.system,
                    onToggle: () => toggleSection('system')
                },
                    React.createElement('div', { className: 'profile-section__fields' },
                        // üñ•Ô∏è –î–æ—Å—Ç—É–ø —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
                        React.createElement('div', { className: 'profile-field-group' },
                            React.createElement('div', { className: 'profile-field-group__header' },
                                React.createElement('span', { className: 'profile-field-group__icon' }, 'üñ•Ô∏è'),
                                React.createElement('span', { className: 'profile-field-group__title' }, '–î–æ—Å—Ç—É–ø —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞')
                            ),
                            React.createElement('div', { style: { marginTop: '8px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
                                React.createElement('span', { style: { color: 'var(--gray-600)' } },
                                    '–†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ —Å –¥–µ—Å–∫—Ç–æ–ø–∞'
                                ),
                                React.createElement('label', { className: 'toggle-switch' },
                                    React.createElement('input', {
                                        type: 'checkbox',
                                        checked: !!profile.desktopAllowed,
                                        onChange: e => updateProfileField('desktopAllowed', e.target.checked)
                                    }),
                                    React.createElement('span', { className: 'toggle-slider' })
                                )
                            ),
                            React.createElement('div', { className: 'muted', style: { marginTop: '6px', fontSize: '13px' } },
                                profile.desktopAllowed
                                    ? '‚úì –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ'
                                    : '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ'
                            )
                        ),
                        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è (Onboarding Tour)
                        React.createElement('div', { className: 'profile-field-group' },
                            React.createElement('div', { className: 'profile-field-group__header' },
                                React.createElement('span', { className: 'profile-field-group__icon' }, 'üéì'),
                                React.createElement('span', { className: 'profile-field-group__title' }, '–û–±—É—á–µ–Ω–∏–µ')
                            ),
                            React.createElement('div', { style: { marginTop: 8 } },
                                React.createElement('button', {
                                    className: 'btn btn--secondary btn--full',
                                    style: { justifyContent: 'center' },
                                    onClick: () => {
                                        if (window.HEYS.OnboardingTour) {
                                            window.HEYS.OnboardingTour.start({ force: true });
                                        } else {
                                            window.alert('–ú–æ–¥—É–ª—å –æ–±—É—á–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                                        }
                                    }
                                }, '–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ')
                            )
                        ),

                        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–≤–µ—Ç–æ–≤
                        React.createElement(HEYS_AdviceStatsCard, null),
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤
                        React.createElement(HEYS_AdviceSettingsCard, null),
                        // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ hdr-top)
                        window.HEYS.analyticsUI
                            ? React.createElement('div', { className: 'profile-field-group' },
                                React.createElement('div', { className: 'profile-field-group__header' },
                                    React.createElement('span', { className: 'profile-field-group__icon' }, 'üìä'),
                                    React.createElement('span', { className: 'profile-field-group__title' }, '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞')
                                ),
                                React.createElement('div', { style: { marginTop: '8px' } },
                                    React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                                )
                            )
                            : null
                    ) // end profile-section__fields
                ) // end ProfileSection system

            ) // end profile-accordion
        );
    }

    // === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–≤–µ—Ç–æ–≤ ===
    function HEYS_AdviceStatsCard() {
        const [stats, setStats] = React.useState({ totalAdvicesRead: 0 });

        React.useEffect(() => {
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏
            if (window.HEYS?.game?.getStats) {
                const gameStats = window.HEYS.game.getStats();
                setStats(gameStats.stats || { totalAdvicesRead: 0 });
            }

            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const handleUpdate = () => {
                if (window.HEYS?.game?.getStats) {
                    const gameStats = window.HEYS.game.getStats();
                    setStats(gameStats.stats || { totalAdvicesRead: 0 });
                }
            };
            window.addEventListener('heysGameUpdate', handleUpdate);
            return () => window.removeEventListener('heysGameUpdate', handleUpdate);
        }, []);

        const total = stats.totalAdvicesRead || 0;

        // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é
        let nextMilestone, progress, remaining;
        if (total < 50) {
            nextMilestone = 50;
            progress = (total / 50) * 100;
            remaining = 50 - total;
        } else if (total < 200) {
            nextMilestone = 200;
            progress = (total / 200) * 100;
            remaining = 200 - total;
        } else {
            nextMilestone = null;
            progress = 100;
            remaining = 0;
        }

        return React.createElement('div', { className: 'profile-field-group' },
            React.createElement('div', { className: 'profile-field-group__header' },
                React.createElement('span', { className: 'profile-field-group__icon' }, 'üí°'),
                React.createElement('span', { className: 'profile-field-group__title' }, '–°–æ–≤–µ—Ç—ã')
            ),
            React.createElement('div', { style: { marginTop: '8px' } },
                React.createElement('div', {
                    style: {
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        marginBottom: '8px'
                    }
                },
                    React.createElement('span', { style: { color: 'var(--gray-600)' } }, '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å–æ–≤–µ—Ç–æ–≤:'),
                    React.createElement('span', { style: { fontWeight: 600, fontSize: '18px' } }, total)
                ),
                nextMilestone && React.createElement('div', null,
                    React.createElement('div', {
                        style: {
                            display: 'flex',
                            justifyContent: 'space-between',
                            fontSize: '13px',
                            color: 'var(--gray-500)',
                            marginBottom: '4px'
                        }
                    },
                        React.createElement('span', null, `–î–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "${nextMilestone === 50 ? 'üí° –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π' : 'üß† –ú—É–¥—Ä–µ—Ü'}"`),
                        React.createElement('span', null, `${remaining} –æ—Å—Ç–∞–ª–æ—Å—å`)
                    ),
                    React.createElement('div', {
                        style: {
                            height: '8px',
                            background: 'var(--gray-200)',
                            borderRadius: '4px',
                            overflow: 'hidden'
                        }
                    },
                        React.createElement('div', {
                            style: {
                                height: '100%',
                                width: progress + '%',
                                background: 'linear-gradient(90deg, var(--blue-400), var(--blue-500))',
                                borderRadius: '4px',
                                transition: 'width 0.3s ease'
                            }
                        })
                    )
                ),
                !nextMilestone && React.createElement('div', {
                    style: {
                        padding: '8px 12px',
                        background: 'var(--green-50)',
                        borderRadius: '8px',
                        color: 'var(--green-700)',
                        fontSize: '14px'
                    }
                }, 'üèÜ –í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ —Å–æ–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã!')
            )
        );
    }

    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤ ===
    function HEYS_AdviceSettingsCard() {
        const advice = window.HEYS?.advice;
        if (!advice?.getAdviceSettings) return null;

        const [settings, setSettings] = React.useState(function () { return advice.getAdviceSettings(); });
        const [saved, setSaved] = React.useState(false);

        const categories = advice.CATEGORY_LABELS || {};

        var toggleCategory = function (cat, enabled) {
            var newSettings = {
                ...settings,
                categories: { ...settings.categories, [cat]: enabled }
            };
            setSettings(newSettings);
            advice.setAdviceSettings(newSettings);
            setSaved(true);
            setTimeout(function () { setSaved(false); }, 1500);
        };

        var updateSetting = function (key, value) {
            var newSettings = { ...settings, [key]: value };
            setSettings(newSettings);
            advice.setAdviceSettings(newSettings);
            setSaved(true);
            setTimeout(function () { setSaved(false); }, 1500);
        };

        var catEntries = Object.entries(categories);

        return React.createElement('div', { className: 'profile-field-group' },
            React.createElement('div', { className: 'profile-field-group__header' },
                React.createElement('span', { className: 'profile-field-group__icon' }, '‚öôÔ∏è'),
                React.createElement('span', { className: 'profile-field-group__title' }, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤')
            ),

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π grid 3 –∫–æ–ª–æ–Ω–∫–∏
            React.createElement('div', {
                style: {
                    display: 'flex',
                    flexWrap: 'wrap',
                    gap: '8px',
                    marginTop: '12px'
                }
            },
                catEntries.map(function (entry) {
                    var cat = entry[0];
                    var info = entry[1];
                    var isEnabled = settings.categories?.[cat] !== false;

                    return React.createElement('div', {
                        key: cat,
                        title: info.desc,
                        onClick: function () { toggleCategory(cat, !isEnabled); },
                        style: {
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            padding: '8px 14px',
                            background: isEnabled ? 'rgba(59, 130, 246, 0.08)' : 'var(--gray-50)',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            fontSize: '14px',
                            fontWeight: 500,
                            color: isEnabled ? 'var(--blue-600)' : 'var(--gray-500)',
                            border: isEnabled ? '2px solid var(--blue-400)' : '2px solid var(--gray-200)',
                            userSelect: 'none'
                        }
                    },
                        React.createElement('span', { style: { fontSize: '16px' } }, info.icon),
                        React.createElement('span', null, info.name)
                    );
                })
            ),

            // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
            React.createElement('div', {
                style: {
                    display: 'flex',
                    flexWrap: 'wrap',
                    alignItems: 'center',
                    gap: '16px',
                    marginTop: '16px',
                    paddingTop: '12px',
                    borderTop: '1px solid var(--gray-200)'
                }
            },
                // Haptic
                React.createElement('label', {
                    style: {
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        cursor: 'pointer',
                        fontSize: '13px'
                    }
                },
                    React.createElement('input', {
                        type: 'checkbox',
                        checked: settings.hapticEnabled !== false,
                        onChange: function (e) { updateSetting('hapticEnabled', e.target.checked); },
                        style: { width: '16px', height: '16px' }
                    }),
                    React.createElement('span', null, 'üì≥ –í–∏–±—Ä–∞—Ü–∏—è')
                ),

                // Sound
                React.createElement('label', {
                    style: {
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        cursor: 'pointer',
                        fontSize: '13px'
                    }
                },
                    React.createElement('input', {
                        type: 'checkbox',
                        checked: settings.soundEnabled !== false,
                        onChange: function (e) { updateSetting('soundEnabled', e.target.checked); },
                        style: { width: '16px', height: '16px' }
                    }),
                    React.createElement('span', null, 'üîî –ó–≤—É–∫')
                ),

                // Show details
                React.createElement('label', {
                    style: {
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        cursor: 'pointer',
                        fontSize: '13px'
                    }
                },
                    React.createElement('input', {
                        type: 'checkbox',
                        checked: settings.showDetails !== false,
                        onChange: function (e) { updateSetting('showDetails', e.target.checked); },
                        style: { width: '16px', height: '16px' }
                    }),
                    React.createElement('span', null, 'üìñ –î–µ—Ç–∞–ª–∏')
                ),

                // Max per day
                React.createElement('label', {
                    style: {
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        fontSize: '13px'
                    }
                },
                    React.createElement('span', null, 'üìä –ú–∞–∫—Å:'),
                    React.createElement('input', {
                        type: 'number',
                        min: 5,
                        max: 50,
                        value: settings.maxPerDay || 20,
                        onChange: function (e) { updateSetting('maxPerDay', parseInt(e.target.value) || 20); },
                        style: {
                            width: '50px',
                            padding: '4px 6px',
                            borderRadius: '6px',
                            border: '1px solid var(--gray-300)',
                            textAlign: 'center',
                            fontSize: '13px'
                        }
                    })
                )
            ),

            saved && React.createElement('div', {
                style: { marginTop: '8px', color: 'var(--green-600)', fontSize: '12px', textAlign: 'center' }
            }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
        );
    }

    // === –ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ (ratio zones) ===
    function HEYS_RatioZonesCard() {
        const rz = HEYS.ratioZones;
        const [zones, setZones] = React.useState(() => rz ? rz.getZones() : []);
        const [saved, setSaved] = React.useState(false);

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º
        React.useEffect(() => {
            if (rz) setZones(rz.getZones());
        }, []);

        const updateZone = (i, field, value) => {
            const newZones = zones.map((z, idx) => {
                if (idx !== i) return z;
                const updated = { ...z, [field]: value };
                return updated;
            });

            // –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü —Å–æ—Å–µ–¥–Ω–∏—Ö –∑–æ–Ω
            if (field === 'to' && i < newZones.length - 1) {
                newZones[i + 1] = { ...newZones[i + 1], from: value };
            }
            if (field === 'from' && i > 0) {
                newZones[i - 1] = { ...newZones[i - 1], to: value };
            }

            setZones(newZones);
            if (rz) {
                rz.setZones(newZones);
                setSaved(true);
                setTimeout(() => setSaved(false), 1500);
            }
        };

        const resetZones = () => {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –∑–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                if (rz) {
                    const def = rz.resetZones();
                    setZones(def);
                }
            }
        };

        // –§–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const fmtPct = (v) => {
            if (v === 0) return '0%';
            if (v === Infinity || v > 100) return '‚àû';
            return Math.round(v * 100) + '%';
        };

        if (!rz) {
            return React.createElement('div', { className: 'profile-field-group' },
                React.createElement('div', { className: 'muted' }, '–ú–æ–¥—É–ª—å ratioZones –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω')
            );
        }

        return React.createElement('div', { className: 'profile-field-group' },
            React.createElement('div', { className: 'profile-field-group__header', style: { justifyContent: 'space-between' } },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                    React.createElement('span', { className: 'profile-field-group__icon' }, 'üé®'),
                    React.createElement('span', { className: 'profile-field-group__title' }, '–ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏')
                ),
                React.createElement('button', { className: 'btn btn-sm', onClick: resetZones, style: { marginLeft: 'auto' } }, '–°–±—Ä–æ—Å–∏—Ç—å')
            ),
            React.createElement('div', { className: 'muted', style: { marginBottom: '12px' } },
                '–û–ø—Ä–µ–¥–µ–ª—è—é—Ç —Ü–≤–µ—Ç–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, –≥—Ä–∞—Ñ–∏–∫–∞—Ö –∏ —Å–æ–≤–µ—Ç–∞—Ö. Ratio = —Å—ä–µ–¥–µ–Ω–æ / –Ω–æ—Ä–º–∞.'
            ),
            React.createElement('div', { className: 'ratio-zones-list' },
                zones.map((z, i) => {
                    const demoRatio = z.to === Infinity ? z.from + 0.2 : (z.from + z.to) / 2;
                    const bgColor = rz.getGradientColor(demoRatio, 0.5);
                    const fromVal = i === 0 ? null : z.from;
                    const toVal = i === zones.length - 1 ? null : z.to;

                    return React.createElement('div', {
                        key: z.id,
                        style: {
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            padding: '10px 12px',
                            marginBottom: '6px',
                            background: 'rgba(255,255,255,0.6)',
                            borderRadius: '10px',
                            border: '1px solid rgba(0,0,0,0.05)'
                        }
                    },
                        React.createElement('div', {
                            style: {
                                width: '28px',
                                height: '28px',
                                borderRadius: '6px',
                                background: z.color,
                                flexShrink: 0,
                                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                            }
                        }),
                        React.createElement('input', {
                            value: z.name,
                            onChange: function (e) { updateZone(i, 'name', e.target.value); },
                            style: {
                                flex: 1,
                                minWidth: 0,
                                padding: '6px 10px',
                                fontSize: '13px',
                                border: '1px solid rgba(0,0,0,0.08)',
                                borderRadius: '6px',
                                background: 'rgba(255,255,255,0.8)',
                                fontWeight: 500
                            }
                        }),
                        React.createElement('div', {
                            style: {
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                                flexShrink: 0
                            }
                        },
                            fromVal === null
                                ? React.createElement('span', { style: { width: '45px', textAlign: 'center', fontSize: '12px', color: 'var(--gray-400)' } }, '0%')
                                : React.createElement('input', {
                                    type: 'number',
                                    step: '0.05',
                                    min: '0',
                                    max: '2',
                                    value: fromVal,
                                    onChange: function (e) { updateZone(i, 'from', parseFloat(e.target.value) || 0); },
                                    style: { width: '45px', padding: '5px', fontSize: '12px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '5px' }
                                }),
                            React.createElement('span', { style: { color: 'var(--gray-400)', fontSize: '11px' } }, '‚Üí'),
                            toVal === null
                                ? React.createElement('span', { style: { width: '45px', textAlign: 'center', fontSize: '12px', color: 'var(--gray-400)' } }, '‚àû')
                                : React.createElement('input', {
                                    type: 'number',
                                    step: '0.05',
                                    min: '0',
                                    max: '2',
                                    value: toVal,
                                    onChange: function (e) { updateZone(i, 'to', parseFloat(e.target.value) || 0); },
                                    style: { width: '45px', padding: '5px', fontSize: '12px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '5px' }
                                })
                        ),
                        React.createElement('div', {
                            style: {
                                padding: '4px 10px',
                                borderRadius: '6px',
                                background: bgColor,
                                textAlign: 'center',
                                fontSize: '11px',
                                fontWeight: 600,
                                flexShrink: 0,
                                minWidth: '45px'
                            }
                        }, fmtPct(demoRatio))
                    );
                })
            ),
            React.createElement('div', { className: 'muted', style: { marginTop: '8px', display: 'flex', alignItems: 'center', gap: '8px' } },
                '–ó–æ–Ω—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤–µ–∑–¥–µ: –∫–∞–ª–µ–Ω–¥–∞—Ä—å, sparkline, heatmap, —Å–æ–≤–µ—Ç—ã.',
                saved && React.createElement('span', { style: { color: '#22c55e', fontSize: '13px', fontWeight: 500 } }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
            )
        );
    }


    // === –ù–æ—Ä–º—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±–ª–æ–∫) ===
    function HEYS_NormsCard() {
        const U = HEYS.utils || {};
        const clamp = (v) => Math.max(0, Math.min(100, (U.toNum ? U.toNum(v) : Number(v) || 0)));
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ lsGet/lsSet –∏–∑ –Ω–∞—á–∞–ª–∞ –º–æ–¥—É–ª—è
        const [norms, setNorms] = React.useState(() => {
            const val = lsGet('heys_norms', {
                carbsPct: 0, proteinPct: 0, badFatPct: 0, superbadFatPct: 0, simpleCarbPct: 0, giPct: 0, harmPct: 0, fiberPct: 0
            });
            // –°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π —Å –æ–±–ª–∞–∫–æ–º
            return { revision: 0, updatedAt: 0, ...val };
        });
        // Debounced —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º (1000ms)
        const [normsSaved, setNormsSaved] = React.useState(false);
        const [normsPending, setNormsPending] = React.useState(false);
        const [lastEditedNorm, setLastEditedNorm] = React.useState(null);
        const normsInitRef = React.useRef(true);

        React.useEffect(() => {
            if (normsInitRef.current) {
                normsInitRef.current = false;
                return;
            }
            setNormsPending(true);
            setNormsSaved(false);
            const timer = setTimeout(() => {
                lsSet('heys_norms', { ...norms, updatedAt: Date.now() });
                setNormsPending(false);
                setNormsSaved(true);
                setTimeout(() => {
                    setNormsSaved(false);
                    setLastEditedNorm(null);
                }, 2000);
            }, 300);
            return () => clearTimeout(timer);
        }, [norms]);

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è)
        React.useEffect(() => {
            let cancelled = false;
            const clientId = window.HEYS && window.HEYS.currentClientId;
            const cloud = window.HEYS && window.HEYS.cloud;

            const reloadNorms = () => {
                if (cancelled) return;

                const newNorms = lsGet('heys_norms', {
                    carbsPct: 0, proteinPct: 0, badFatPct: 0, superbadFatPct: 0, simpleCarbPct: 0, giPct: 0, harmPct: 0, fiberPct: 0
                });
                newNorms.revision = newNorms.revision || 0;
                newNorms.updatedAt = newNorms.updatedAt || 0;

                // –£–º–Ω—ã–π reload: –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ
                setNorms(prev => {
                    const prevUpdatedAt = prev.updatedAt || 0;
                    const newUpdatedAt = newNorms.updatedAt || 0;
                    if (prevUpdatedAt > newUpdatedAt) {
                        return prev; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
                    }
                    return newNorms;
                });
            };

            if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
                if (typeof cloud.shouldSyncClient === 'function' ? cloud.shouldSyncClient(clientId, 4000) : true) {
                    cloud.bootstrapClientSync(clientId)
                        .then(() => {
                            setTimeout(reloadNorms, 150); // –ö–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
                        })
                        .catch((err) => {
                            console.warn('[HEYS] Norms sync failed, using local cache:', err?.message || err);
                            reloadNorms(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        });
                } else {
                    reloadNorms();
                }
            } else {
                reloadNorms();
            }

            return () => { cancelled = true; };
        }, [window.HEYS && window.HEYS.currentClientId]);

        const carb = clamp(norms.carbsPct);
        const prot = clamp(norms.proteinPct);
        const fatAuto = clamp(100 - carb - prot);

        const badF = clamp(norms.badFatPct);
        const superBadF = clamp(norms.superbadFatPct);
        const goodFAuto = clamp(100 - badF - superBadF);

        const simpleC = clamp(norms.simpleCarbPct);
        const complexCAuto = clamp(100 - simpleC);

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –Ω–æ—Ä–º
        const NormFieldStatus = ({ fieldKey }) => {
            if (lastEditedNorm !== fieldKey) return null;
            if (normsPending) {
                return React.createElement('span', {
                    style: { marginLeft: '6px', color: '#f59e0b', fontSize: '12px', fontWeight: 500 }
                }, '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...');
            }
            if (normsSaved) {
                return React.createElement('span', {
                    style: { marginLeft: '6px', color: '#22c55e', fontSize: '12px', fontWeight: 500 }
                }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }
            return null;
        };

        const update = (k, v) => {
            const clamped = clamp(v);
            setLastEditedNorm(k);
            setNormsPending(true);
            setNorms(prev => ({
                ...prev,
                [k]: clamped,
                revision: (prev.revision || 0) + 1,
                updatedAt: Date.now()
            }));
        };

        const overMacro = (carb + prot) > 100;
        const overFatSplit = (badF + superBadF) > 100;
        const overCarbSplit = simpleC > 100;

        return React.createElement('div', { className: 'profile-field-group' },
            React.createElement('div', { className: 'profile-field-group__header' },
                React.createElement('span', { className: 'profile-field-group__icon' }, 'üìä'),
                React.createElement('span', { className: 'profile-field-group__title' }, '–ù–æ—Ä–º—ã')
            ),
            React.createElement('div', { className: 'field-list' },
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–£–≥–ª–µ–≤–æ–¥—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: carb, onChange: e => update('carbsPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'carbsPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ë–µ–ª–∫–∏ (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: prot, onChange: e => update('proteinPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'proteinPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ñ–∏—Ä—ã (%) ‚Äî –∞–≤—Ç–æ = 100 ‚àí –£ ‚àí –ë'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { className: 'readOnly', readOnly: true, value: fatAuto })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: badF, onChange: e => update('badFatPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'badFatPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: superBadF, onChange: e => update('superbadFatPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'superbadFatPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (%) ‚Äî –∞–≤—Ç–æ = 100 ‚àí –≤—Ä–µ–¥–Ω—ã–µ ‚àí —Å—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { className: 'readOnly', readOnly: true, value: goodFAuto })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: simpleC, onChange: e => update('simpleCarbPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'simpleCarbPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (%) ‚Äî –∞–≤—Ç–æ = 100 ‚àí –ø—Ä–æ—Å—Ç—ã–µ'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { className: 'readOnly', readOnly: true, value: complexCAuto })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ì–ò (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: clamp(norms.giPct), onChange: e => update('giPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'giPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–í—Ä–µ–¥–Ω–æ—Å—Ç—å (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: clamp(norms.harmPct), onChange: e => update('harmPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'harmPct' })),
                React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (–≥/1000 –∫–∫–∞–ª) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: clamp(norms.fiberPct), onChange: e => update('fiberPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'fiberPct' }))
            ),
            (overMacro || overFatSplit || overCarbSplit) ?
                React.createElement('div', { className: 'muted', style: { marginTop: '6px', color: '#dc2626' } },
                    (overMacro ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –£% + –ë% –ø—Ä–µ–≤—ã—à–∞—é—Ç 100. –ñ–∏—Ä—ã –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã. ' : ''),
                    (overFatSplit ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í—Ä–µ–¥–Ω—ã–µ% + –°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ% > 100. –ü–æ–ª–µ–∑–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã. ' : ''),
                    (overCarbSplit ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—Ä–æ—Å—Ç—ã–µ% > 100. –°–ª–æ–∂–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã.' : '')
                )
                : null,
            React.createElement('div', { className: 'muted', style: { marginTop: '6px' } },
                '–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ñ–∏—Ä—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ 9 –∫–∫–∞–ª/–≥, –∫–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Äî –≤ –≥—Ä–∞–º–º–∞—Ö –Ω–∞ 1000 –∫–∫–∞–ª.'
            )
        );
    }

    function UserTab(props) {
        return React.createElement(UserTabBase, props);
    }

    HEYS.UserTab = UserTab;
    HEYS.UserTabImpl = HEYS.UserTabImpl || {};
    HEYS.UserTabImpl.createUserTab = function createUserTab() {
        if (!HEYS.UserTab._memoized && window.React?.memo) {
            const MemoTab = React.memo(HEYS.UserTab);
            MemoTab.displayName = 'UserTab';
            HEYS.UserTab._memoized = MemoTab;
        }
        return HEYS.UserTab._memoized || HEYS.UserTab;
    };
    HEYS.UserTabImpl.calcSleepNorm = calcSleepNorm;
    HEYS.UserTabImpl.calcAgeFromBirthDate = calcAgeFromBirthDate;

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
    HEYS.calcSleepNorm = calcSleepNorm;
    HEYS.calcAgeFromBirthDate = calcAgeFromBirthDate;

})(window);


/* ===== heys_user_v12.js ===== */
// heys_user_v12.js ‚Äî proxy to heys_user_tab_impl_v1.js
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  if (HEYS.UserTabImpl && typeof HEYS.UserTabImpl.createUserTab === 'function') {
    HEYS.UserTab = HEYS.UserTabImpl.createUserTab();
    HEYS.calcSleepNorm = HEYS.calcSleepNorm || HEYS.UserTabImpl.calcSleepNorm;
    HEYS.calcAgeFromBirthDate = HEYS.calcAgeFromBirthDate || HEYS.UserTabImpl.calcAgeFromBirthDate;
    return;
  }
  const React = global.React;

  // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ HEYS.utils –∑–∞–≥—Ä—É–∂–µ–Ω
  if (!HEYS.utils || !HEYS.utils.lsGet) {
    console.error('[heys_user_v12] ‚ùå HEYS.utils.lsGet –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω! –≠—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —Å–±—Ä–æ—Å—É –ø—Ä–æ—Ñ–∏–ª—è');
  }
  // else { console.log('[heys_user_v12] ‚úÖ HEYS.utils.lsGet –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, __clientScoped:', HEYS.utils.__clientScoped); }

  const { lsGet, lsSet, toNum, round1, getEmojiStyle, setEmojiStyle } = HEYS.utils || {
    lsGet: (k, d) => d, lsSet: () => { }, toNum: (x) => Number(x) || 0, round1: (v) => Math.round(v * 10) / 10,
    getEmojiStyle: () => 'android', setEmojiStyle: () => { }
  };

  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
  const DEFAULT_PROFILE = {
    firstName: '', lastName: '', gender: '–ú—É–∂—Å–∫–æ–π',
    weight: 70, height: 175, age: 30,
    birthDate: '', // YYYY-MM-DD, –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –≤–æ–∑—Ä–∞—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ
    weightGoal: 0, // —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å (–∫–≥)
    sleepHours: 8, insulinWaveHours: 3,
    deficitPctTarget: 0,
    stepsGoal: 10000, // —Ü–µ–ª–µ–≤–∞—è –¥–Ω–µ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —à–∞–≥–∞–º
    cycleTrackingEnabled: false, // —Ä—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–µ–∫–∏–Ω–≥–∞ —Ü–∏–∫–ª–∞ (–¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª–∞)
    profileCompleted: false, // —Ñ–ª–∞–≥ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è (–¥–ª—è wizard –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞)
    desktopAllowed: false, // üñ•Ô∏è –†–∞–∑—Ä–µ—à—ë–Ω –ª–∏ –¥–æ—Å—Ç—É–ø —Å –¥–µ—Å–∫—Ç–æ–ø–∞ (–∫—É—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å)

    // üíä –í–∏—Ç–∞–º–∏–Ω—ã / –¥–æ–±–∞–≤–∫–∏
    // plannedSupplements –æ—Å—Ç–∞—ë—Ç—Å—è string[] ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ UI
    plannedSupplements: [],
    // supplementSettings ‚Äî –∫–∞—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ ID –¥–æ–±–∞–≤–∫–∏ (—Ñ–æ—Ä–º–∞, –¥–æ–∑–∏—Ä–æ–≤–∫–∞, override —Ç–∞–π–º–∏–Ω–≥–∞)
    supplementSettings: {},
    // supplementHistory ‚Äî –ª—ë–≥–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–∏—ë–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–æ–∫ –¥–∞—Ç) –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø–æ –∫—É—Ä—Å—É/–ª–∏–º–∏—Ç–∞–º
    supplementHistory: {}
  };

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –º—è–≥–∫–∞—è (—Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥, –Ω–µ —Ñ–æ—Ä—Å–∏—Ä—É–µ–º fallback)
  // Fallback –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –Ω–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
  const PROFILE_VALIDATORS = {
    weight: v => {
      if (v === '' || v === null || v === undefined) return v; // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Å—Ç–æ–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
      const n = Number(v);
      return isNaN(n) ? v : Math.max(0, Math.min(500, n));
    },
    weightGoal: v => {
      if (v === '' || v === null || v === undefined) return 0;
      const n = Number(v);
      return isNaN(n) ? 0 : Math.max(0, Math.min(500, n));
    },
    height: v => {
      if (v === '' || v === null || v === undefined) return v;
      const n = Number(v);
      return isNaN(n) ? v : Math.max(0, Math.min(300, n));
    },
    age: v => {
      if (v === '' || v === null || v === undefined) return v;
      const n = Number(v);
      return isNaN(n) ? v : Math.max(0, Math.min(150, n));
    },
    sleepHours: v => {
      if (v === '' || v === null || v === undefined) return v;
      const n = Number(v);
      return isNaN(n) ? v : Math.max(0, Math.min(24, n));
    },
    insulinWaveHours: v => {
      if (v === '' || v === null || v === undefined) return v;
      const n = Number(v);
      return isNaN(n) ? v : Math.max(0.5, Math.min(12, n));
    },
    deficitPctTarget: v => {
      if (v === '' || v === null || v === undefined) return 0;
      const n = Number(v);
      return isNaN(n) ? 0 : Math.max(-50, Math.min(50, n));
    },
    stepsGoal: v => {
      if (v === '' || v === null || v === undefined) return 10000;
      const n = Number(v);
      return isNaN(n) ? 10000 : Math.max(0, Math.min(50000, n));
    }
  };

  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const readStoredValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      if (typeof lsGet === 'function') {
        const legacy = lsGet(key, fallback);
        if (legacy !== null && legacy !== undefined) return legacy;
      }
      const raw = localStorage.getItem(key);
      return tryParseStoredValue(raw, fallback);
    } catch (_) {
      return fallback;
    }
  };

  const readGlobalValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      const raw = localStorage.getItem(key);
      return tryParseStoredValue(raw, fallback);
    } catch (_) {
      return fallback;
    }
  };

  const writeStoredValue = (key, value) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(key, value);
        return;
      }
      if (typeof lsSet === 'function') {
        lsSet(key, value);
        return;
      }
      const serialized = typeof value === 'string' ? value : JSON.stringify(value);
      localStorage.setItem(key, serialized);
    } catch (_) { }
  };

  const writeGlobalValue = (key, value) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(key, value);
        return;
      }
      const serialized = typeof value === 'string' ? value : JSON.stringify(value);
      localStorage.setItem(key, serialized);
    } catch (_) { }
  };

  // –†–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
  function calcAgeFromBirthDate(birthDate) {
    if (!birthDate) return 0;
    const birth = new Date(birthDate);
    if (isNaN(birth.getTime())) return 0;
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return Math.max(0, age);
  }

  // –†–∞—Å—á—ë—Ç –Ω–æ—Ä–º—ã —Å–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ –ø–æ–ª—É (Sleep Foundation + NSF)
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { hours, range, explanation }
  function calcSleepNorm(age, gender) {
    let baseMin, baseMax, explanation;

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (Sleep Foundation / AASM)
    if (age < 13) {
      baseMin = 9; baseMax = 12;
      explanation = '–¥–µ—Ç–∏ 6-12 –ª–µ—Ç: 9-12—á';
    } else if (age < 18) {
      baseMin = 8; baseMax = 10;
      explanation = '–ø–æ–¥—Ä–æ—Å—Ç–∫–∏ 13-17: 8-10—á';
    } else if (age < 26) {
      baseMin = 7; baseMax = 9;
      explanation = '–º–æ–ª–æ–¥—ã–µ 18-25: 7-9—á';
    } else if (age < 65) {
      baseMin = 7; baseMax = 9;
      explanation = '–≤–∑—Ä–æ—Å–ª—ã–µ 26-64: 7-9—á';
    } else {
      baseMin = 7; baseMax = 8;
      explanation = '–ø–æ–∂–∏–ª—ã–µ 65+: 7-8—á';
    }

    // –ñ–µ–Ω—â–∏–Ω—ã –≤ —Å—Ä–µ–¥–Ω–µ–º –Ω—É–∂–¥–∞—é—Ç—Å—è –Ω–∞ ~20 –º–∏–Ω –±–æ–ª—å—à–µ (Duke University)
    const genderBonus = gender === '–ñ–µ–Ω—Å–∫–∏–π' ? 0.3 : 0;

    const recommended = Math.round(((baseMin + baseMax) / 2 + genderBonus) * 2) / 2; // –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 0.5

    return {
      hours: recommended,
      range: `${baseMin}-${baseMax}`,
      explanation: explanation + (genderBonus > 0 ? ' +20–º–∏–Ω –∂–µ–Ω.' : '')
    };
  }

  // Emoji Style Selector Component
  function EmojiStyleSelector() {
    const [style, setStyle] = React.useState(() => getEmojiStyle());

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
    const platformInfo = React.useMemo(() => {
      if (typeof window === 'undefined') return { needsTwemoji: false, name: 'Unknown' };
      const ua = navigator.userAgent || '';
      const isWindows = /Windows/i.test(ua);
      const isLinux = /Linux/i.test(ua) && !/Android/i.test(ua);
      const isMac = /Macintosh|Mac OS/i.test(ua);
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isAndroid = /Android/i.test(ua);

      let name = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
      if (isWindows) name = 'Windows';
      else if (isMac) name = 'Mac';
      else if (isIOS) name = 'iPhone/iPad';
      else if (isAndroid) name = 'Android';
      else if (isLinux) name = 'Linux';

      return {
        needsTwemoji: isWindows || isLinux,
        name: name,
        twemojiAvailable: !!window.twemoji
      };
    }, []);

    const handleChange = (e) => {
      const newStyle = e.target.value;
      setStyle(newStyle);
      setEmojiStyle(newStyle);
    };

    // –ï—Å–ª–∏ Twemoji –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (Mac/iOS/Android), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ-–±–ª–æ–∫
    if (!platformInfo.twemojiAvailable) {
      return React.createElement('div', { className: 'inline-field' },
        React.createElement('label', null, '–°—Ç–∏–ª—å —ç–º–æ–¥–∑–∏ üòÄ'),
        React.createElement('span', { className: 'sep' }, '-'),
        React.createElement('span', { style: { color: 'var(--gray-500)', fontSize: '0.875rem' } },
          `–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç–º–æ–¥–∑–∏ ${platformInfo.name}`
        )
      );
    }

    return React.createElement('div', { className: 'inline-field' },
      React.createElement('label', null, '–°—Ç–∏–ª—å —ç–º–æ–¥–∑–∏ üòÄ'),
      React.createElement('span', { className: 'sep' }, '-'),
      React.createElement('select', { value: style, onChange: handleChange },
        React.createElement('option', { value: 'twemoji' }, 'üê¶ Twitter/Android'),
        React.createElement('option', { value: 'system' }, `üíª ${platformInfo.name}`)
      )
    );
  }

  // === SubscriptionStatusSection ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ===
  function SubscriptionStatusSection() {
    const [statusData, setStatusData] = React.useState(null);
    const [loading, setLoading] = React.useState(true);

    React.useEffect(() => {
      if (!window.HEYS?.Subscription) {
        setLoading(false);
        return;
      }

      window.HEYS.Subscription.getStatus(true).then(data => {
        setStatusData(data);
        setLoading(false);
      }).catch(() => setLoading(false));
    }, []);

    if (loading) {
      return React.createElement('div', { className: 'profile-section__fields' },
        React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--gray-500)' } },
          '–ó–∞–≥—Ä—É–∑–∫–∞...'
        )
      );
    }

    if (!window.HEYS?.Subscription) {
      return React.createElement('div', { className: 'profile-section__fields' },
        React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--gray-500)' } },
          '–ú–æ–¥—É–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'
        )
      );
    }

    const status = statusData?.status || 'none';
    const meta = window.HEYS.Subscription.getStatusMeta(status);
    const daysLeft = statusData?.days_left || 0;

    return React.createElement('div', { className: 'profile-section__fields' },
      // –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∞
      React.createElement('div', {
        className: 'profile-field-group',
        style: {
          backgroundColor: meta?.bg || 'var(--gray-100)',
          borderRadius: '12px',
          padding: '16px',
          border: `2px solid ${meta?.color || 'var(--gray-300)'}`
        }
      },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' } },
          React.createElement('span', { style: { fontSize: '32px' } }, meta?.emoji || 'üíé'),
          React.createElement('div', null,
            React.createElement('div', { style: { fontSize: '18px', fontWeight: '600', color: meta?.color || 'inherit' } },
              meta?.label || '–ü–æ–¥–ø–∏—Å–∫–∞'
            ),
            React.createElement('div', { style: { fontSize: '14px', color: 'var(--gray-600)' } },
              meta?.desc || ''
            )
          )
        ),

        // –î–Ω–∏ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        (status === 'trial' || status === 'active') && daysLeft > 0 &&
        React.createElement('div', {
          style: {
            backgroundColor: 'rgba(0,0,0,0.05)',
            borderRadius: '8px',
            padding: '12px',
            textAlign: 'center',
            marginBottom: '12px'
          }
        },
          React.createElement('div', { style: { fontSize: '24px', fontWeight: '700', color: meta?.color } },
            daysLeft
          ),
          React.createElement('div', { style: { fontSize: '12px', color: 'var(--gray-600)' } },
            daysLeft === 1 ? '–¥–µ–Ω—å –æ—Å—Ç–∞–ª–æ—Å—å' : (daysLeft < 5 ? '–¥–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å' : '–¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å')
          )
        ),

        // –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã (–¥–ª—è read_only –∏–ª–∏ none)
        (status === 'read_only' || status === 'none') &&
        React.createElement('button', {
          className: 'btn btn-primary',
          style: { width: '100%', marginTop: '8px' },
          onClick: () => {
            if (window.HEYS?.Paywall?.show) {
              window.HEYS.Paywall.show();
            } else {
              alert('–û–ø–ª–∞—Ç–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞! üíé');
            }
          }
        }, status === 'read_only' ? 'üîì –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É' : 'üöÄ –ù–∞—á–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥')
      )
    );
  }

  // === ProfileSection ‚Äî FAQ-style collapsible section ===
  function ProfileSection({
    id,
    icon,
    title,
    subtitle,
    badge,
    tone = 'blue',
    expanded,
    onToggle,
    children
  }) {
    const handleClick = () => {
      if (onToggle) onToggle(id);
    };

    const sectionClass = [
      'profile-section',
      `tone-${tone}`,
      expanded ? 'profile-section--expanded' : 'profile-section--collapsed'
    ].join(' ');

    return React.createElement('div', { className: sectionClass },
      // Header (always visible)
      React.createElement('div', {
        className: 'profile-section__header',
        onClick: handleClick
      },
        React.createElement('div', { className: 'profile-section__header-left' },
          React.createElement('div', { className: 'profile-section__icon' }, icon),
          React.createElement('div', null,
            React.createElement('div', { className: 'profile-section__title' }, title),
            subtitle && React.createElement('div', { className: 'profile-section__subtitle' }, subtitle)
          )
        ),
        React.createElement('div', { className: 'profile-section__header-right' },
          badge && React.createElement('span', { className: 'profile-section__badge' }, badge),
          React.createElement('span', { className: 'profile-section__chevron' }, '‚ñº')
        )
      ),
      // Content (only when expanded)
      expanded && React.createElement('div', { className: 'profile-section__content' }, children)
    );
  }

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä—É–ø–ø—ã –ø–æ–ª–µ–π (–ø–ª–∞—à–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏) ===
  function ProfileFieldGroup({ icon, title, children }) {
    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', { className: 'profile-field-group__header' },
        React.createElement('span', { className: 'profile-field-group__icon' }, icon),
        React.createElement('span', { className: 'profile-field-group__title' }, title)
      ),
      children
    );
  }

  function UserTabBase() {
    // Twemoji: reparse emoji after render
    React.useEffect(() => {
      if (window.scheduleTwemojiParse) window.scheduleTwemojiParse();
    });

    const [profile, setProfile] = React.useState(() => {
      return readStoredValue('heys_profile', DEFAULT_PROFILE);
    });
    const [profileSaved, setProfileSaved] = React.useState(false);

    // –°–º–µ–Ω–∞ PIN
    const [pinForm, setPinForm] = React.useState({ pin: '', confirm: '' });
    const [pinStatus, setPinStatus] = React.useState('idle'); // idle | pending | success | error
    const [pinMessage, setPinMessage] = React.useState('');

    // === Accordion state (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ localStorage) ===
    const SECTIONS_KEY = 'heys_profile_sections';
    const [expandedSections, setExpandedSections] = React.useState(() => {
      try {
        return readStoredValue(SECTIONS_KEY, { basic: true }) || { basic: true };
      } catch { return { basic: true }; }
    });
    const toggleSection = (id) => {
      setExpandedSections(prev => {
        const next = { ...prev, [id]: !prev[id] };
        writeStoredValue(SECTIONS_KEY, next);
        return next;
      });
    };

    const getCurrentClientId = () => {
      let cid = (window.HEYS && window.HEYS.currentClientId) || readGlobalValue('heys_client_current', '') || '';
      if (cid && typeof cid === 'string' && cid.startsWith('"')) {
        try { cid = JSON.parse(cid); } catch (_) { }
      }
      return cid || '';
    };

    const getShortClientId = (id) => id ? String(id).slice(0, 8) : '‚Äî';

    const handlePinUpdate = async () => {
      const auth = window.HEYS && window.HEYS.auth;
      const clientId = getCurrentClientId();
      setPinMessage('');

      if (!clientId) {
        setPinStatus('error');
        setPinMessage('–ö–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —à–∞–ø–∫–µ.');
        return;
      }

      if (!auth || typeof auth.resetClientPin !== 'function' || typeof auth.validatePin !== 'function') {
        setPinStatus('error');
        setPinMessage('–ú–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.');
        return;
      }

      if (!auth.validatePin(pinForm.pin) || !auth.validatePin(pinForm.confirm)) {
        setPinStatus('error');
        setPinMessage('PIN –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä.');
        return;
      }

      if (pinForm.pin !== pinForm.confirm) {
        setPinStatus('error');
        setPinMessage('PIN –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.');
        return;
      }

      setPinStatus('pending');
      try {
        const res = await auth.resetClientPin({ clientId, newPin: pinForm.pin });
        if (!res || !res.ok) {
          const msg = res && res.message ? res.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å PIN';
          setPinStatus('error');
          setPinMessage(msg);
          if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.trackError) {
            window.HEYS.analytics.trackError('pin_change_failed', { clientId: getShortClientId(clientId), message: msg });
          }
          return;
        }
        setPinStatus('success');
        setPinMessage('PIN –æ–±–Ω–æ–≤–ª—ë–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ–æ–±—â–∏—Ç—å –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.');
        setPinForm({ pin: '', confirm: '' });
        setTimeout(() => { setPinStatus('idle'); setPinMessage(''); }, 2000);
      } catch (e) {
        setPinStatus('error');
        setPinMessage(e?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ PIN');
        if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.trackError) {
          window.HEYS.analytics.trackError('pin_change_exception', { clientId: getShortClientId(clientId), message: e?.message });
        }
      }
    };

    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã, MET —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
    const defaultZones = React.useMemo(() => {
      return [
        { name: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (—Ö–æ–¥—å–±–∞)', hrFrom: 85, hrTo: 99, MET: 2 },
        { name: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–µ–¥–ª–µ–Ω–Ω—ã–π –±–µ–≥)', hrFrom: 100, hrTo: 119, MET: 3 },
        { name: '–ê—ç—Ä–æ–±–Ω–∞—è (–∫–∞—Ä–¥–∏–æ)', hrFrom: 120, hrTo: 139, MET: 5 },
        { name: '–ê–Ω–∞—ç—Ä–æ–±–Ω–∞—è (–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, –∫–æ–≥–¥–∞ —Ç—è–∂–µ–ª–æ)', hrFrom: 140, hrTo: 181, MET: 8 }
      ];
    }, []);

    const [zones, setZones] = React.useState(readStoredValue('heys_hr_zones', defaultZones));
    const [zonesSaved, setZonesSaved] = React.useState(false);

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è)
    React.useEffect(() => {
      let cancelled = false;
      const clientId = window.HEYS && window.HEYS.currentClientId;
      const cloud = window.HEYS && window.HEYS.cloud;

      const reloadData = () => {
        if (cancelled) return;

        const newProfile = readStoredValue('heys_profile', DEFAULT_PROFILE);
        newProfile.revision = newProfile.revision || 0;
        newProfile.updatedAt = newProfile.updatedAt || 0;

        // –£–º–Ω—ã–π reload: –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ
        setProfile(prev => {
          const prevUpdatedAt = prev.updatedAt || 0;
          const newUpdatedAt = newProfile.updatedAt || 0;
          if (prevUpdatedAt > newUpdatedAt) {
            return prev; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
          }
          return newProfile;
        });

        const newZones = readStoredValue('heys_hr_zones', defaultZones);
        newZones.revision = newZones.revision || 0;
        newZones.updatedAt = newZones.updatedAt || 0;

        setZones(prev => {
          const prevUpdatedAt = prev.updatedAt || 0;
          const newUpdatedAt = newZones.updatedAt || 0;
          if (prevUpdatedAt > newUpdatedAt) {
            return prev;
          }
          return newZones;
        });
      };

      if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
        if (typeof cloud.shouldSyncClient === 'function' ? cloud.shouldSyncClient(clientId, 4000) : true) {
          cloud.bootstrapClientSync(clientId)
            .then(() => {
              setTimeout(reloadData, 150); // –ö–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
            })
            .catch((err) => {
              console.warn('[HEYS] Profile sync failed, using local cache:', err?.message || err);
              reloadData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –ø—Ä–∏ –æ—à–∏–±–∫–µ
            });
        } else {
          reloadData();
        }
      } else {
        reloadData();
      }

      return () => { cancelled = true; };
    }, [window.HEYS && window.HEYS.currentClientId]);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ wizard'–∞
    React.useEffect(() => {
      const handleProfileUpdate = (e) => {
        const newProfile = readStoredValue('heys_profile', DEFAULT_PROFILE);
        setProfile(newProfile);
      };

      window.addEventListener('heys:profile-updated', handleProfileUpdate);
      return () => window.removeEventListener('heys:profile-updated', handleProfileUpdate);
    }, []);

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ "–∏–¥—ë—Ç –≤–≤–æ–¥" –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
    const [profilePending, setProfilePending] = React.useState(false);
    const [zonesPending, setZonesPending] = React.useState(false);
    const profileInitRef = React.useRef(true);
    const zonesInitRef = React.useRef(true);

    React.useEffect(() => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
      if (profileInitRef.current) {
        profileInitRef.current = false;
        return;
      }
      // Debounced —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (1000ms ‚Äî —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ)
      setProfilePending(true);
      setProfileSaved(false);
      setFieldStatus('pending');
      const timer = setTimeout(() => {
        writeStoredValue('heys_profile', profile);

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Å —Å–ø–∏—Å–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
        let currentClientId = readGlobalValue('heys_client_current', '');
        // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ JSON string
        if (currentClientId && currentClientId.startsWith('"')) {
          try { currentClientId = JSON.parse(currentClientId); } catch (e) { }
        }
        if (currentClientId && profile.firstName) {
          try {
            const clients = readGlobalValue('heys_clients', []);
            const safeClients = Array.isArray(clients) ? clients : [];
            const updatedClients = safeClients.map(c =>
              c.id === currentClientId ? { ...c, name: profile.firstName } : c
            );
            writeGlobalValue('heys_clients', updatedClients);

            // –°–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            window.dispatchEvent(new CustomEvent('heys:clients-updated', {
              detail: { clients: updatedClients, source: 'profile-settings' }
            }));

            // ‚ö†Ô∏è Cloud sync –∏–º–µ–Ω–∏ –æ—Ç–∫–ª—é—á—ë–Ω:
            // - REST API read-only (PATCH –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è CORS)
            // - clients.name —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫—É—Ä–∞—Ç–æ—Ä–æ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
            // - –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage
          } catch (e) {
            console.warn('[Profile] Failed to sync client name:', e);
          }
        }

        setProfilePending(false);
        setProfileSaved(true);
        setFieldStatus('saved');
        setTimeout(() => {
          setProfileSaved(false);
          setFieldStatus('idle');
          setLastEditedField(null);
        }, 2000);
      }, 1000);
      return () => clearTimeout(timer);
    }, [profile]);
    React.useEffect(() => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
      if (zonesInitRef.current) {
        zonesInitRef.current = false;
        return;
      }
      // Debounced —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–æ–Ω (1000ms)
      setZonesPending(true);
      setZonesSaved(false);
      const timer = setTimeout(() => {
        writeStoredValue('heys_hr_zones', zones);
        setZonesPending(false);
        setZonesSaved(true);
        setTimeout(() => setZonesSaved(false), 2000);
      }, 1000);
      return () => clearTimeout(timer);
    }, [zones]);

    const maxHR = Math.max(0, 220 - toNum(profile.age || 0));
    const calPerMinPerMET = round1(toNum(profile.weight || 0) * 0.0175); // –∫–∞–ª/–º–∏–Ω –Ω–∞ 1 MET

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
    const [lastEditedField, setLastEditedField] = React.useState(null);
    const [fieldStatus, setFieldStatus] = React.useState('idle'); // 'idle' | 'pending' | 'saved'

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º
    const FieldStatus = ({ fieldKey }) => {
      if (lastEditedField !== fieldKey) return null;
      if (fieldStatus === 'pending') {
        return React.createElement('span', {
          style: { marginLeft: '6px', color: '#f59e0b', fontSize: '12px', fontWeight: 500 }
        }, '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...');
      }
      if (fieldStatus === 'saved') {
        return React.createElement('span', {
          style: { marginLeft: '6px', color: '#22c55e', fontSize: '12px', fontWeight: 500 }
        }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      }
      return null;
    };

    function updateProfileField(key, value) {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
      const validator = PROFILE_VALIDATORS[key];
      const validatedValue = validator ? validator(value) : value;

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "pending" –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—è
      setLastEditedField(key);
      setFieldStatus('pending');

      const newProfile = {
        ...profile,
        [key]: validatedValue,
        revision: (profile.revision || 0) + 1,
        updatedAt: Date.now()
      };
      setProfile(newProfile);
    }
    function updateZone(i, patch) {
      setZones(prev => {
        const updated = prev.map((z, idx) => idx === i ? { ...z, ...patch } : z);
        // –î–æ–±–∞–≤–ª—è–µ–º revision/updatedAt –∫ –º–∞—Å—Å–∏–≤—É (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è JSON)
        updated.revision = (prev.revision || 0) + 1;
        updated.updatedAt = Date.now();
        return updated;
      });
    }
    function resetZones() { if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã –∫ —à–∞–±–ª–æ–Ω—É?')) setZones(defaultZones); }

    // –ü—Ä–µ—Å–µ—Ç—ã –¥–µ—Ñ–∏—Ü–∏—Ç–∞/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞ –∫–∞–ª–æ—Ä–∏–π
    const DEFICIT_PRESETS = [
      { value: -20, label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üî•üî•', color: '#ef4444' },
      { value: -15, label: '–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üî•', color: '#f97316' },
      { value: -10, label: '–£–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üéØ', color: '#eab308' },
      { value: 0, label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞', emoji: '‚öñÔ∏è', color: '#22c55e' },
      { value: 10, label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™', color: '#3b82f6' },
      { value: 15, label: '–ê–∫—Ç–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™üí™', color: '#3b82f6' }
    ];

    const getDeficitInfo = (val) => {
      const preset = DEFICIT_PRESETS.find(p => p.value === val);
      if (preset) return preset;
      // –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
      if (val < -10) return { emoji: 'üî•üî•', color: '#ef4444', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç' };
      if (val < 0) return { emoji: 'üî•', color: '#f97316', label: '–î–µ—Ñ–∏—Ü–∏—Ç' };
      if (val === 0) return { emoji: '‚öñÔ∏è', color: '#22c55e', label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ' };
      if (val <= 10) return { emoji: 'üí™', color: '#3b82f6', label: '–ü—Ä–æ—Ñ–∏—Ü–∏—Ç' };
      return { emoji: 'üí™üí™', color: '#3b82f6', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä' };
    };

    return React.createElement('div', { className: 'page page-user' },
      React.createElement('div', { className: 'profile-accordion' },

        // === –°–ï–ö–¶–ò–Ø 1: –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
        React.createElement(ProfileSection, {
          id: 'basic',
          icon: 'üë§',
          title: '–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
          subtitle: '–†–æ—Å—Ç, –≤–µ—Å, –≤–æ–∑—Ä–∞—Å—Ç, —Ü–µ–ª–∏',
          tone: 'blue',
          expanded: expandedSections.basic,
          onToggle: () => toggleSection('basic')
        },
          React.createElement('div', { className: 'profile-section__fields' },

            // === –ì–†–£–ü–ü–ê 1: –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ===
            React.createElement(ProfileFieldGroup, { icon: 'üë§', title: '–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' },
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ò–º—è'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { value: profile.firstName, onChange: e => updateProfileField('firstName', e.target.value) }), React.createElement(FieldStatus, { fieldKey: 'firstName' })),
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–§–∞–º–∏–ª–∏—è'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { value: profile.lastName, onChange: e => updateProfileField('lastName', e.target.value) }), React.createElement(FieldStatus, { fieldKey: 'lastName' })),
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ü–æ–ª'), React.createElement('span', { className: 'sep' }, '-'),
                React.createElement('select', { value: profile.gender, onChange: e => updateProfileField('gender', e.target.value) },
                  React.createElement('option', { value: '–ú—É–∂—Å–∫–æ–π' }, '–ú—É–∂—Å–∫–æ–π'),
                  React.createElement('option', { value: '–ñ–µ–Ω—Å–∫–∏–π' }, '–ñ–µ–Ω—Å–∫–∏–π'),
                  React.createElement('option', { value: '–î—Ä—É–≥–æ–µ' }, '–î—Ä—É–≥–æ–µ')
                ),
                React.createElement(FieldStatus, { fieldKey: 'gender' })
              ),
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è'), React.createElement('span', { className: 'sep' }, '-'),
                React.createElement('input', { type: 'date', value: profile.birthDate || '', onChange: e => updateProfileField('birthDate', e.target.value), style: { width: '140px' } }),
                React.createElement(FieldStatus, { fieldKey: 'birthDate' }),
                profile.birthDate && React.createElement('span', { style: { marginLeft: '8px', color: 'var(--gray-600)' } }, `(${calcAgeFromBirthDate(profile.birthDate)} –ª–µ—Ç)`)
              ),
              !profile.birthDate && React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', value: profile.age, onChange: e => updateProfileField('age', Number(e.target.value) || 0), onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'age' })),
              // –¢—Ä–µ–∫–∏–Ω–≥ –æ—Å–æ–±–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω)
              profile.gender === '–ñ–µ–Ω—Å–∫–∏–π' && React.createElement('div', { className: 'inline-field cycle-tracking-toggle' },
                React.createElement('label', null, 'üå∏ –û—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥'),
                React.createElement('span', { className: 'sep' }, '-'),
                React.createElement('label', { className: 'toggle-switch' },
                  React.createElement('input', {
                    type: 'checkbox',
                    checked: !!profile.cycleTrackingEnabled,
                    onChange: e => updateProfileField('cycleTrackingEnabled', e.target.checked)
                  }),
                  React.createElement('span', { className: 'toggle-slider' })
                ),
                React.createElement('span', { className: 'cycle-toggle-hint' },
                  profile.cycleTrackingEnabled ? '–í–∫–ª—é—á—ë–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'
                )
              )
            ),

            // === –ì–†–£–ü–ü–ê 2: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ª–∞ ===
            React.createElement(ProfileFieldGroup, { icon: 'üìè', title: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ª–∞' },
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–†–æ—Å—Ç (—Å–º)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', value: profile.height, onChange: e => updateProfileField('height', Number(e.target.value) || 0), onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'height' })),
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ë–∞–∑–æ–≤—ã–π –≤–µ—Å (–∫–≥)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', step: '1', value: profile.baseWeight || profile.weight, onChange: e => updateProfileField('baseWeight', Number(e.target.value) || 0), onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'baseWeight' })),
              // –¢–µ–∫—É—â–∏–π –≤–µ—Å (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞)
              (() => {
                // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –≤–µ—Å–æ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
                let currentWeight = null;
                let weightDate = null;
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                  const d = new Date(today);
                  d.setDate(d.getDate() - i);
                  const key = 'heys_dayv2_' + d.toISOString().slice(0, 10);
                  const dayData = readStoredValue(key, null);
                  if (dayData && dayData.weightMorning > 0) {
                    currentWeight = dayData.weightMorning;
                    weightDate = d.toISOString().slice(0, 10);
                    break;
                  }
                }
                const baseWeight = profile.baseWeight || profile.weight;
                const diff = currentWeight && baseWeight ? round1(currentWeight - baseWeight) : null;
                return React.createElement('div', { className: 'inline-field' },
                  React.createElement('label', null, '‚öñÔ∏è –¢–µ–∫—É—â–∏–π –≤–µ—Å'),
                  React.createElement('span', { className: 'sep' }, '-'),
                  currentWeight
                    ? React.createElement('span', { style: { fontWeight: 600 } },
                      `${currentWeight} –∫–≥`,
                      diff !== null && diff !== 0 && React.createElement('span', { style: { marginLeft: '8px', fontSize: '13px', color: diff < 0 ? '#22c55e' : diff > 0 ? '#f97316' : 'var(--gray-500)' } },
                        diff > 0 ? `+${diff}` : diff, ' –æ—Ç –±–∞–∑—ã'
                      )
                    )
                    : React.createElement('span', { style: { color: 'var(--gray-400)', fontStyle: 'italic' } }, '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'),
                  weightDate && React.createElement('span', { style: { marginLeft: '8px', fontSize: '12px', color: 'var(--gray-400)' } },
                    `(${new Date(weightDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })})`
                  )
                );
              })(),
              React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–¶–µ–ª–µ–≤–æ–π –≤–µ—Å (–∫–≥)'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', step: '1', value: profile.weightGoal || 0, onChange: e => updateProfileField('weightGoal', Number(e.target.value) || 0), placeholder: '0 = –Ω–µ –∑–∞–¥–∞–Ω', onFocus: e => e.target.select() }), React.createElement(FieldStatus, { fieldKey: 'weightGoal' })),

              // === –ü–†–û–î–í–ò–ù–£–¢–´–ô –†–ê–°–ß–Å–¢ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –¶–ï–õ–ò ===
              (() => {
                const startWeight = toNum(profile.baseWeight || profile.weight || 70);
                const goalWeight = toNum(profile.weightGoal);
                const deficitPct = toNum(profile.deficitPctTarget) || 0;
                const height = toNum(profile.height || 175) / 100;
                const age = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : toNum(profile.age || 30);
                const gender = profile.gender;

                // –ï—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–∏ –∏–ª–∏ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                if (!goalWeight || goalWeight <= 0) return null;

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–µ—Å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞
                let currentWeight = startWeight;
                for (let i = 0; i < 30; i++) {
                  const d = new Date();
                  d.setDate(d.getDate() - i);
                  const key = 'heys_dayv2_' + d.toISOString().slice(0, 10);
                  const dayData = readStoredValue(key, null);
                  if (dayData && dayData.weightMorning > 0) {
                    currentWeight = dayData.weightMorning;
                    break;
                  }
                }

                const weightToLose = round1(currentWeight - goalWeight);
                if (weightToLose <= 0) {
                  return React.createElement('div', {
                    className: 'goal-calculator', style: {
                      marginTop: '12px', padding: '12px 14px', background: 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)',
                      borderRadius: '10px', border: '1px solid #86efac'
                    }
                  },
                    React.createElement('div', { style: { fontWeight: 600, color: '#15803d', display: 'flex', alignItems: 'center', gap: '6px' } },
                      'üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!',
                      React.createElement('span', { style: { fontWeight: 400, fontSize: '13px', color: '#166534' } },
                        weightToLose < 0 ? `–í—ã –Ω–∞ ${Math.abs(weightToLose)} –∫–≥ –Ω–∏–∂–µ —Ü–µ–ª–∏` : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!'
                      )
                    )
                  );
                }

                // === –ù–ê–£–ß–ù–´–ô –†–ê–°–ß–Å–¢ ===
                // BMR –ø–æ Mifflin-St Jeor (Mifflin MD et al., Am J Clin Nutr 1990)
                // –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω ADA –∫–∞–∫ –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –¥–ª—è –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥–µ–π
                const bmr = gender === '–ñ–µ–Ω—Å–∫–∏–π'
                  ? round1(447.593 + 9.247 * currentWeight + 3.098 * (height * 100) - 4.330 * age)
                  : round1(88.362 + 13.397 * currentWeight + 4.799 * (height * 100) - 5.677 * age);

                // === –ê–î–ê–ü–¢–ò–í–ù–´–ô TDEE ===
                // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
                // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (‚â•3 –¥–Ω–µ–π) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π TDEE
                // –ò–Ω–∞—á–µ ‚Äî —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ –º–Ω–æ–∂–∏—Ç–µ–ª—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ 7 –¥–Ω–µ–π
                const activityDays = [];
                for (let i = 0; i < 7; i++) {
                  const d = new Date();
                  d.setDate(d.getDate() - i);
                  const dateKey = d.toISOString().split('T')[0];
                  const dayData = readStoredValue(`heys_dayv2_${dateKey}`, null);
                  if (dayData) {
                    // –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç –±–µ–∑ MET)
                    const trainings = dayData.trainings || [];
                    let trainKcal = 0;
                    trainings.forEach(t => {
                      const zones = t.z || [0, 0, 0, 0];
                      const mets = [2.5, 6, 8, 10]; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ MET –ø–æ –∑–æ–Ω–∞–º
                      zones.forEach((min, zi) => {
                        trainKcal += (min || 0) * ((mets[zi] * currentWeight * 0.0175) - 1);
                      });
                    });

                    // –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç —à–∞–≥–æ–≤
                    const stepsKcal = (dayData.steps || 0) * 0.7 / 1000 * currentWeight * (gender === '–ñ–µ–Ω—Å–∫–∏–π' ? 0.5 : 0.57);

                    // –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    const householdMin = (dayData.householdActivities || []).reduce((s, h) => s + (+h.minutes || 0), dayData.householdMin || 0);
                    const householdKcal = householdMin * ((2.5 * currentWeight * 0.0175) - 1);

                    const totalActivityKcal = Math.round(trainKcal + stepsKcal + householdKcal);

                    // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–Ω–∏ —Å —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏–ª–∏ –¥–∞–Ω–Ω—ã–º–∏
                    if (dayData.steps > 0 || trainings.length > 0 || householdMin > 0) {
                      activityDays.push({
                        date: dateKey,
                        activityKcal: totalActivityKcal,
                        tdee: bmr + totalActivityKcal
                      });
                    }
                  }
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º TDEE
                let tdee, tdeeSource;
                const MIN_DAYS_FOR_REAL_TDEE = 3;

                if (activityDays.length >= MIN_DAYS_FOR_REAL_TDEE) {
                  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî —Å—Ä–µ–¥–Ω–∏–π TDEE –∑–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–Ω–∏
                  const avgTdee = activityDays.reduce((s, d) => s + d.tdee, 0) / activityDays.length;
                  tdee = round1(avgTdee);
                  tdeeSource = 'real';
                } else {
                  // –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π TDEE –ø–æ –º–Ω–æ–∂–∏—Ç–µ–ª—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (FAO/WHO/UNU 2001)
                  const activityMultipliers = {
                    'sedentary': 1.2,       // –°–∏–¥—è—á–∏–π (–æ—Ñ–∏—Å, –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)
                    'light': 1.375,         // –õ—ë–≥–∫–∞—è (1-3 —Ç—Ä–µ–Ω/–Ω–µ–¥)
                    'moderate': 1.55,       // –£–º–µ—Ä–µ–Ω–Ω–∞—è (3-5 —Ç—Ä–µ–Ω/–Ω–µ–¥)
                    'active': 1.725,        // –í—ã—Å–æ–∫–∞—è (6-7 —Ç—Ä–µ–Ω/–Ω–µ–¥)
                    'very_active': 1.9      // –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è (–∞—Ç–ª–µ—Ç—ã)
                  };
                  const profileActivity = profile?.activityLevel || 'moderate';
                  const activityMultiplier = activityMultipliers[profileActivity] || 1.55;
                  tdee = round1(bmr * activityMultiplier);
                  tdeeSource = 'theoretical';
                }

                // –î–Ω–µ–≤–Ω–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π
                const dailyDeficit = Math.abs(deficitPct) > 0 ? round1(tdee * Math.abs(deficitPct) / 100) : 0;

                // === –°–û–°–¢–ê–í –ü–û–¢–ï–†–ò –í–ï–°–ê ===
                // Forbes GB (1987, 2000): —Å–æ—Å—Ç–∞–≤ –ø–æ—Ç–µ—Ä–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
                // Lean mass = –º—ã—à—Ü—ã + –≥–ª–∏–∫–æ–≥–µ–Ω + —Å–≤—è–∑–∞–Ω–Ω–∞—è –≤–æ–¥–∞
                // –ü—Ä–∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ + —Å–∏–ª–æ–≤—ã–µ: –¥–æ 90% –∂–∏—Ä–∞ –≤–æ–∑–º–æ–∂–Ω–æ
                // –ë–µ–∑ —Å–∏–ª–æ–≤—ã—Ö: 75-80% –∂–∏—Ä, 20-25% lean mass (–∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö ~50% –≤–æ–¥–∞ –≥–ª–∏–∫–æ–≥–µ–Ω–∞)
                const isAggressive = Math.abs(deficitPct) > 20; // –ü–æ—Ä–æ–≥ —Å–Ω–∏–∂–µ–Ω –¥–æ 20% (–Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω)
                const isVeryAggressive = Math.abs(deficitPct) > 30;

                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: —Ä–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∂–∏—Ä, –≥–ª–∏–∫–æ–≥–µ–Ω+–≤–æ–¥—É, –∏ —á–∏—Å—Ç—ã–µ –º—ã—à—Ü—ã
                // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ –≤–µ—Å–∞ —Å–Ω–∞—á–∞–ª–∞ —É—Ö–æ–¥–∏—Ç –≥–ª–∏–∫–æ–≥–µ–Ω (—Å 3-4–≥ –≤–æ–¥—ã –Ω–∞ 1–≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞)
                let fatPercent, glycogenWaterPercent, leanMusclePercent;
                if (isVeryAggressive) {
                  fatPercent = 0.55;           // –°–∏–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç: –±–æ–ª—å—à–µ –º—ã—à—Ü —Ç–µ—Ä—è–µ—Ç—Å—è
                  glycogenWaterPercent = 0.25; // –ì–ª–∏–∫–æ–≥–µ–Ω + —Å–≤—è–∑–∞–Ω–Ω–∞—è –≤–æ–¥–∞
                  leanMusclePercent = 0.20;    // –ß–∏—Å—Ç–∞—è –º—ã—à–µ—á–Ω–∞—è —Ç–∫–∞–Ω—å
                } else if (isAggressive) {
                  fatPercent = 0.65;
                  glycogenWaterPercent = 0.22;
                  leanMusclePercent = 0.13;
                } else {
                  fatPercent = 0.77;           // Hall KD (2008): ~77% –ø—Ä–∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ
                  glycogenWaterPercent = 0.18; // ~400–≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ + 1.2-1.6–∫–≥ –≤–æ–¥—ã
                  leanMusclePercent = 0.05;    // –ú–∏–Ω–∏–º—É–º –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ + —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö
                }

                // –ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–∫–∫–∞–ª/–∫–≥) ‚Äî –Ω–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const KCAL_PER_KG_FAT = 7700;           // Hall KD (2008): –∂–∏—Ä–æ–≤–∞—è —Ç–∫–∞–Ω—å ~7700 –∫–∫–∞–ª/–∫–≥
                const KCAL_PER_KG_LEAN_MUSCLE = 1100;   // Forbes GB (2000): ~20% –±–µ–ª–æ–∫, ~75% –≤–æ–¥–∞
                const KCAL_PER_KG_GLYCOGEN_WATER = 700; // –ì–ª–∏–∫–æ–≥–µ–Ω 4–∫–∫–∞–ª/–≥, –Ω–æ 1–≥ –≥–ª–∏–∫–æ–≥–µ–Ω–∞ —Å–≤—è–∑—ã–≤–∞–µ—Ç 3-4–≥ –≤–æ–¥—ã

                // –°–∫–æ–ª—å–∫–æ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å
                const fatToLose = round1(weightToLose * fatPercent);
                const glycogenWaterToLose = round1(weightToLose * glycogenWaterPercent);
                const leanMuscleToLose = round1(weightToLose * leanMusclePercent);

                // –û–±—â–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π –Ω—É–∂–Ω—ã–π (Hall KD, 2011)
                // –ñ–∏—Ä: 7700 –∫–∫–∞–ª/–∫–≥, –º—ã—à—Ü—ã: 1100 –∫–∫–∞–ª/–∫–≥, –≥–ª–∏–∫–æ–≥–µ–Ω+–≤–æ–¥–∞: ~700 –∫–∫–∞–ª/–∫–≥
                const totalKcalDeficit = Math.round(
                  fatToLose * KCAL_PER_KG_FAT +
                  leanMuscleToLose * KCAL_PER_KG_LEAN_MUSCLE +
                  glycogenWaterToLose * KCAL_PER_KG_GLYCOGEN_WATER
                );

                // –î–Ω–µ–π –¥–æ —Ü–µ–ª–∏
                const daysToGoal = dailyDeficit > 0 ? Math.ceil(totalKcalDeficit / dailyDeficit) : null;
                const weeksToGoal = daysToGoal ? Math.ceil(daysToGoal / 7) : null;
                const monthsToGoal = daysToGoal ? round1(daysToGoal / 30) : null;

                // –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞)
                // –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –Ω–µ –≤—Å—è –ø–æ—Ç–µ—Ä—è = –∂–∏—Ä
                const effectiveKcalPerKg = fatPercent * KCAL_PER_KG_FAT +
                  glycogenWaterPercent * KCAL_PER_KG_GLYCOGEN_WATER +
                  leanMusclePercent * KCAL_PER_KG_LEAN_MUSCLE;
                const kgPerWeek = dailyDeficit > 0 ? round1((dailyDeficit * 7) / effectiveKcalPerKg) : 0;

                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (ACSM Position Stand 2009)
                const warnings = [];
                if (isVeryAggressive) {
                  warnings.push({ icon: '‚ö†Ô∏è', text: '–î–µ—Ñ–∏—Ü–∏—Ç >30% ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –º—ã—à—Ü –∏ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏', color: '#dc2626' });
                } else if (isAggressive) {
                  warnings.push({ icon: '‚ö°', text: '–î–µ—Ñ–∏—Ü–∏—Ç >20% ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—à—Ü', color: '#f97316' });
                }
                if (kgPerWeek > 1) {
                  warnings.push({ icon: 'üèÉ', text: `${kgPerWeek} –∫–≥/–Ω–µ–¥ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è ACSM: 0.5-0.9 –∫–≥/–Ω–µ–¥`, color: '#eab308' });
                }
                if (kgPerWeek > 1.5) {
                  warnings.push({ icon: 'üö®', text: '–ü–æ—Ç–µ—Ä—è >1.5 –∫–≥/–Ω–µ–¥ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –º—ã—à—Ü –Ω–∞ 20-30%', color: '#dc2626' });
                }
                if (deficitPct === 0) {
                  warnings.push({ icon: 'üìä', text: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–µ—Ñ–∏—Ü–∏—Ç –≤ "–¶–µ–ª–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º" –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞', color: '#6b7280' });
                }

                // –î–∞—Ç–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
                const targetDate = daysToGoal ? new Date(Date.now() + daysToGoal * 24 * 60 * 60 * 1000) : null;

                return React.createElement('div', {
                  className: 'goal-calculator', style: {
                    marginTop: '12px', padding: '14px 16px',
                    background: 'linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%)',
                    borderRadius: '12px', border: '1px solid #bfdbfe',
                    position: 'relative'
                  }
                },
                  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                  React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' } },
                    React.createElement('span', {
                      style: { fontWeight: 600, color: '#1e40af', fontSize: '14px' },
                      title: '–ò—Å—Ç–æ—á–Ω–∏–∫–∏: Mifflin (1990), Hall KD (2008), Forbes GB (2000), ACSM (2009)'
                    }, 'üìê –†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏'),
                    daysToGoal && React.createElement('span', {
                      style: {
                        padding: '4px 10px', background: '#3b82f6', color: '#fff', borderRadius: '12px', fontSize: '12px', fontWeight: 600
                      }
                    },
                      weeksToGoal <= 4 ? `~${weeksToGoal} –Ω–µ–¥.` :
                        monthsToGoal <= 12 ? `~${monthsToGoal} –º–µ—Å.` :
                          `~${round1(monthsToGoal / 12)} –≥.`
                    )
                  ),

                  // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ TDEE
                  React.createElement('div', {
                    style: {
                      display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '10px',
                      padding: '6px 10px', borderRadius: '8px',
                      background: tdeeSource === 'real' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(234, 179, 8, 0.1)',
                      border: `1px solid ${tdeeSource === 'real' ? '#10b981' : '#eab308'}`
                    }
                  },
                    React.createElement('span', { style: { fontSize: '12px' } },
                      tdeeSource === 'real' ? 'üìä' : 'üìê'
                    ),
                    React.createElement('span', {
                      style: {
                        fontSize: '12px',
                        color: tdeeSource === 'real' ? '#059669' : '#b45309'
                      }
                    },
                      tdeeSource === 'real'
                        ? `TDEE ${tdee} –∫–∫–∞–ª ‚Äî –ø–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º (${activityDays.length} –¥–Ω–µ–π)`
                        : `TDEE ${tdee} –∫–∫–∞–ª ‚Äî —Ç–µ–æ—Ä–∏—è (–Ω—É–∂–Ω–æ ‚â•3 –¥–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)`
                    )
                  ),

                  // –†–∞–∑–±–∏–≤–∫–∞ –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ (–Ω–∞—É—á–Ω–∞—è –º–æ–¥–µ–ª—å: –∂–∏—Ä + –≥–ª–∏–∫–æ–≥–µ–Ω/–≤–æ–¥–∞ + –º—ã—à—Ü—ã)
                  React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', marginBottom: '10px' } },
                    React.createElement('div', { style: { textAlign: 'center', padding: '8px', background: 'rgba(251, 191, 36, 0.15)', borderRadius: '8px' } },
                      React.createElement('div', { style: { fontSize: '18px', fontWeight: 700, color: '#b45309' } }, `${fatToLose} –∫–≥`),
                      React.createElement('div', { style: { fontSize: '11px', color: '#92400e' } }, `üî• –ñ–∏—Ä (${Math.round(fatPercent * 100)}%)`)
                    ),
                    React.createElement('div', { style: { textAlign: 'center', padding: '8px', background: 'rgba(59, 130, 246, 0.15)', borderRadius: '8px' } },
                      React.createElement('div', { style: { fontSize: '18px', fontWeight: 700, color: '#1d4ed8' } }, `${glycogenWaterToLose} –∫–≥`),
                      React.createElement('div', { style: { fontSize: '11px', color: '#1e40af' } }, `üíß –ì–ª–∏–∫–æ–≥–µ–Ω+–≤–æ–¥–∞`)
                    ),
                    React.createElement('div', { style: { textAlign: 'center', padding: '8px', background: 'rgba(239, 68, 68, 0.15)', borderRadius: '8px' } },
                      React.createElement('div', { style: { fontSize: '18px', fontWeight: 700, color: '#dc2626' } }, `${leanMuscleToLose} –∫–≥`),
                      React.createElement('div', { style: { fontSize: '11px', color: '#b91c1c' } }, `üí™ –ú—ã—à—Ü—ã (${Math.round(leanMusclePercent * 100)}%)`)
                    )
                  ),

                  // –ö–∞–ª–æ—Ä–∏–∏ –∏ —Å—Ä–æ–∫–∏
                  React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '10px' } },
                    React.createElement('span', { className: 'pill', style: { fontSize: '12px' } },
                      `üîã –ù—É–∂–Ω–æ —Å–∂–µ—á—å: ${(totalKcalDeficit / 1000).toFixed(0)}–∫ –∫–∫–∞–ª`
                    ),
                    dailyDeficit > 0 && React.createElement('span', { className: 'pill', style: { fontSize: '12px' } },
                      `üìâ –î–µ—Ñ–∏—Ü–∏—Ç: ${dailyDeficit} –∫–∫–∞–ª/–¥–µ–Ω—å`
                    ),
                    kgPerWeek > 0 && React.createElement('span', { className: 'pill', style: { fontSize: '12px', background: kgPerWeek > 1 ? '#fef3c7' : '#dcfce7' } },
                      `‚öñÔ∏è ~${kgPerWeek} –∫–≥/–Ω–µ–¥`
                    ),
                    targetDate && React.createElement('span', { className: 'pill', style: { fontSize: '12px' } },
                      `üìÖ ${targetDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' })}`
                    )
                  ),

                  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                  warnings.length > 0 && React.createElement('div', { style: { marginTop: '8px' } },
                    warnings.map((w, i) =>
                      React.createElement('div', { key: i, style: { fontSize: '12px', color: w.color, display: 'flex', alignItems: 'center', gap: '4px', marginTop: '4px' } },
                        w.icon, w.text
                      )
                    )
                  ),

                  // –§–æ—Ä–º—É–ª–∞
                  React.createElement('div', { style: { marginTop: '10px', paddingTop: '8px', borderTop: '1px solid rgba(0,0,0,0.06)', fontSize: '11px', color: 'var(--gray-500)' } },
                    `–§–æ—Ä–º—É–ª–∞: TDEE ${tdee} –∫–∫–∞–ª √ó ${Math.abs(deficitPct)}% –¥–µ—Ñ–∏—Ü–∏—Ç = ${dailyDeficit} –∫–∫–∞–ª/–¥–µ–Ω—å. `,
                    `–ñ–∏—Ä 7700 –∫–∫–∞–ª/–∫–≥, –º—ã—à—Ü—ã 1100 –∫–∫–∞–ª/–∫–≥.`
                  )
                );
              })()
            ),

            // === –ì–†–£–ü–ü–ê 3: –¶–µ–ª–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º ===
            React.createElement(ProfileFieldGroup, { icon: 'üéØ', title: '–¶–µ–ª–∏ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º' },
              // –¶–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç: –ø—Ä–µ—Å–µ—Ç—ã + —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ
              (() => {
                const currentVal = toNum(profile.deficitPctTarget || 0);
                const isCustom = !DEFICIT_PRESETS.some(p => p.value === currentVal);
                const info = getDeficitInfo(currentVal);

                return React.createElement('div', { className: 'inline-field', style: { flexWrap: 'wrap', gap: '8px' } },
                  React.createElement('label', { style: { fontWeight: 600 } }, '–¶–µ–ª—å –ø–æ –∫–∞–ª–æ—Ä–∏—è–º'),
                  React.createElement('span', { className: 'sep' }, '-'),
                  React.createElement('select', {
                    value: isCustom ? 'custom' : String(currentVal),
                    onChange: e => {
                      if (e.target.value !== 'custom') {
                        updateProfileField('deficitPctTarget', Number(e.target.value));
                      }
                    },
                    style: { width: '200px', fontWeight: 600 }
                  },
                    ...DEFICIT_PRESETS.map(p =>
                      React.createElement('option', { key: p.value, value: String(p.value) },
                        `${p.emoji} ${p.value > 0 ? '+' : ''}${p.value}% ‚Äî ${p.label}`
                      )
                    ),
                    React.createElement('option', { value: 'custom' }, '‚úèÔ∏è –°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ...')
                  ),
                  isCustom && React.createElement('input', {
                    type: 'number',
                    step: '1',
                    min: '-50',
                    max: '50',
                    value: currentVal,
                    onChange: e => updateProfileField('deficitPctTarget', Number(e.target.value) || 0),
                    style: { width: '60px', marginLeft: '4px', fontWeight: 700, textAlign: 'center' }
                  }),
                  React.createElement('span', { style: { color: info.color, fontWeight: 600, marginLeft: '6px' } },
                    isCustom ? `${info.emoji} ${currentVal > 0 ? '+' : ''}${currentVal}%` : ''
                  ),
                  React.createElement(FieldStatus, { fieldKey: 'deficitPctTarget' })
                );
              })(),
              // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞: –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ + —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ
              (() => {
                const INSULIN_PRESETS = [
                  { value: 2.5, label: '–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º', desc: '—Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã, –Ω–∏–∑–∫–æ—É–≥–ª–µ–≤–æ–¥–∫–∞' },
                  { value: 3, label: '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π', desc: '–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π' },
                  { value: 4, label: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π', desc: '—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –ø–æ–ª–Ω–æ—Ç–µ' },
                  { value: 4.5, label: '–ò–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å', desc: '–ø—Ä–µ–¥–¥–∏–∞–±–µ—Ç, –°–ü–ö–Ø' }
                ];
                const currentVal = toNum(profile.insulinWaveHours || 3);
                const isCustom = !INSULIN_PRESETS.some(p => p.value === currentVal);
                const currentPreset = INSULIN_PRESETS.find(p => p.value === currentVal);

                return React.createElement('div', { className: 'inline-field', style: { flexWrap: 'wrap', gap: '8px' } },
                  React.createElement('label', null, '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞'),
                  React.createElement('span', { className: 'sep' }, '-'),
                  React.createElement('select', {
                    value: isCustom ? 'custom' : String(currentVal),
                    onChange: e => {
                      if (e.target.value === 'custom') {
                        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ custom
                      } else {
                        updateProfileField('insulinWaveHours', Number(e.target.value));
                      }
                    },
                    style: { width: '180px' }
                  },
                    ...INSULIN_PRESETS.map(p =>
                      React.createElement('option', { key: p.value, value: String(p.value) }, `${p.value} —á ‚Äî ${p.label}`)
                    ),
                    React.createElement('option', { value: 'custom' }, '–°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ...')
                  ),
                  isCustom && React.createElement('input', {
                    type: 'number',
                    step: '0.5',
                    min: '1',
                    max: '8',
                    value: currentVal,
                    onChange: e => updateProfileField('insulinWaveHours', Number(e.target.value) || 3),
                    style: { width: '60px', marginLeft: '4px' }
                  }),
                  React.createElement('span', { style: { color: 'var(--gray-500)', fontSize: '12px', marginLeft: '4px' } },
                    currentPreset ? `(${currentPreset.desc})` : `(${currentVal} —á ‚Äî —Å–≤–æ—ë)`
                  ),
                  React.createElement(FieldStatus, { fieldKey: 'insulinWaveHours' })
                );
              })(),
              // –ù–æ—Ä–º–∞ —Å–Ω–∞: –∞–≤—Ç–æ—Ä–∞—Å—á—ë—Ç —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π
              (() => {
                const age = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : toNum(profile.age || 30);
                const sleepNorm = calcSleepNorm(age, profile.gender);
                return React.createElement('div', { className: 'inline-field' },
                  React.createElement('label', null, '–ù–æ—Ä–º–∞ —Å–Ω–∞'),
                  React.createElement('span', { className: 'sep' }, '-'),
                  React.createElement('span', { style: { fontWeight: 600, minWidth: '50px' } }, `${sleepNorm.hours} —á`),
                  React.createElement('span', { style: { marginLeft: '8px', color: 'var(--gray-500)', fontSize: '13px' } },
                    `(${sleepNorm.explanation})`
                  )
                );
              })(),
              React.createElement(EmojiStyleSelector, null)
            ),
            // BMI/BMR —Ä–∞—Å—á—ë—Ç + –Ω–æ—Ä–º–∞ –≤–æ–¥—ã + –ø—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏
            (() => {
              const w = toNum(profile.weight || 70);
              const h = toNum(profile.height || 175) / 100; // –≤ –º–µ—Ç—Ä–∞—Ö
              // –í–æ–∑—Ä–∞—Å—Ç: –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
              const a = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : toNum(profile.age || 30);
              const bmi = h > 0 ? round1(w / (h * h)) : 0;
              const bmr = profile.gender === '–ñ–µ–Ω—Å–∫–∏–π'
                ? round1(447.593 + 9.247 * w + 3.098 * (h * 100) - 4.330 * a)
                : round1(88.362 + 13.397 * w + 4.799 * (h * 100) - 5.677 * a);
              // BMI –∫–∞—Ç–µ–≥–æ—Ä–∏—è
              let bmiCat = '', bmiColor = '#6b7280';
              if (bmi < 18.5) { bmiCat = '–Ω–µ–¥–æ–≤–µ—Å'; bmiColor = '#eab308'; }
              else if (bmi < 25) { bmiCat = '–Ω–æ—Ä–º–∞'; bmiColor = '#22c55e'; }
              else if (bmi < 30) { bmiCat = '–∏–∑–±—ã—Ç–æ–∫'; bmiColor = '#f97316'; }
              else { bmiCat = '–æ–∂–∏—Ä–µ–Ω–∏–µ'; bmiColor = '#ef4444'; }

              // –ù–æ—Ä–º–∞ –≤–æ–¥—ã: 30 –º–ª –Ω–∞ –∫–≥ –≤–µ—Å–∞
              const waterNorm = round1(w * 30 / 1000); // –≤ –ª–∏—Ç—Ä–∞—Ö

              // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–µ–≤–æ–º—É –≤–µ—Å—É
              const wGoal = toNum(profile.weightGoal);
              const weightDiff = wGoal > 0 ? round1(w - wGoal) : 0;
              const deficitPct = toNum(profile.deficitPctTarget) || 0;

              // –†–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç –∏ —Ü–µ–ª—å)
              // 1 –∫–≥ –∂–∏—Ä–∞ ‚âà 7700 –∫–∫–∞–ª, –¥–µ—Ñ–∏—Ü–∏—Ç/–¥–µ–Ω—å = BMR * deficitPct%
              let weeksToGoal = null;
              if (wGoal > 0 && weightDiff !== 0 && deficitPct !== 0) {
                const dailyDeficit = bmr * Math.abs(deficitPct) / 100;
                const kgPerWeek = (dailyDeficit * 7) / 7700;
                if (kgPerWeek > 0) {
                  weeksToGoal = Math.ceil(Math.abs(weightDiff) / kgPerWeek);
                }
              }

              return React.createElement('div', { style: { marginTop: '10px' } },
                // –ü–∏–ª—é–ª–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
                React.createElement('div', { className: 'row', style: { gap: '12px', flexWrap: 'wrap' } },
                  React.createElement('div', { className: 'pill' }, `–ú–∞–∫—Å. –ø—É–ª—å—Å: ${maxHR} —É–¥/–º–∏–Ω`),
                  React.createElement('div', { className: 'pill' }, `–ö–∞–ª/–º–∏–Ω –Ω–∞ 1 MET: ${calPerMinPerMET}`),
                  React.createElement('div', { className: 'pill', style: { background: '#f0fdf4', border: '1px solid #86efac' } }, `BMR: ${bmr} –∫–∫–∞–ª/—Å—É—Ç`),
                  React.createElement('div', { className: 'pill', style: { background: '#f0f9ff', border: `1px solid ${bmiColor}` } },
                    `BMI: ${bmi}`,
                    React.createElement('span', { style: { marginLeft: '4px', color: bmiColor, fontSize: '12px' } }, `(${bmiCat})`)
                  ),
                  React.createElement('div', { className: 'pill', style: { background: '#eff6ff', border: '1px solid #93c5fd' } }, `üíß –ù–æ—Ä–º–∞ –≤–æ–¥—ã: ${waterNorm} –ª/—Å—É—Ç`)
                ),
                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å)
                wGoal > 0 && React.createElement('div', { style: { marginTop: '12px', padding: '10px 12px', background: 'var(--gray-50)', borderRadius: '8px' } },
                  React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' } },
                    React.createElement('span', { style: { fontWeight: 500 } }, `üéØ –¶–µ–ª—å: ${wGoal} –∫–≥`),
                    React.createElement('span', { style: { color: weightDiff === 0 ? '#22c55e' : 'var(--gray-600)', fontWeight: weightDiff === 0 ? 600 : 400 } },
                      weightDiff === 0 ? '‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ!' :
                        weightDiff > 0 ? `–û—Å—Ç–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å: ${weightDiff} –∫–≥` :
                          `–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞–±—Ä–∞—Ç—å: ${Math.abs(weightDiff)} –∫–≥`
                    )
                  ),
                  // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                  (() => {
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –≤–µ—Å–∞ (–±–∞–∑–æ–≤—ã–π –≤–µ—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ)
                    const progressPct = weightDiff === 0 ? 100 : Math.max(0, Math.min(100, 100 - Math.abs(weightDiff) / Math.abs(w - wGoal) * 100)) || 0;
                    const barColor = weightDiff === 0 ? '#22c55e' : weightDiff > 0 ? '#3b82f6' : '#3b82f6';
                    return React.createElement('div', { style: { height: '8px', background: 'var(--gray-200)', borderRadius: '4px', overflow: 'hidden' } },
                      React.createElement('div', { style: { height: '100%', width: (weightDiff === 0 ? 100 : 50) + '%', background: barColor, borderRadius: '4px', transition: 'width 0.3s' } })
                    );
                  })(),
                  // –í—Ä–µ–º—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                  weeksToGoal && deficitPct !== 0 && React.createElement('div', { style: { marginTop: '6px', fontSize: '13px', color: 'var(--gray-500)' } },
                    `‚è± –ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ ${Math.abs(deficitPct)}%: ~${weeksToGoal} –Ω–µ–¥.`
                  )
                )
              );
            })(),
            React.createElement('div', { className: 'muted', style: { marginTop: '6px' } },
              '–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.'
            )
          ) // end profile-section__fields
        ), // end ProfileSection basic

        // === –°–ï–ö–¶–ò–Ø 2: –ü—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã ===
        React.createElement(ProfileSection, {
          id: 'hrZones',
          icon: 'üíì',
          title: '–ü—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã',
          subtitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–æ–Ω –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
          badge: `${zones.length} –∑–æ–Ω`,
          tone: 'rose',
          expanded: expandedSections.hrZones,
          onToggle: () => toggleSection('hrZones')
        },
          React.createElement('div', { className: 'profile-section__fields' },
            React.createElement('div', { className: 'row', style: { justifyContent: 'flex-end', marginBottom: '8px' } },
              React.createElement('button', { className: 'btn btn-sm', onClick: resetZones }, '–°–±—Ä–æ—Å–∏—Ç—å')
            ),
            // –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—É–ª—å—Å–æ–≤—ã—Ö –∑–æ–Ω
            React.createElement('div', { className: 'hr-zones-list' },
              zones.map((z, i) => {
                const calPerMin = round1((toNum(z.MET || 0) * calPerMinPerMET) - 1);
                return React.createElement('div', {
                  key: i, className: 'hr-zone-row', style: {
                    display: 'flex', flexDirection: 'column', gap: '8px',
                    padding: '12px 14px', marginBottom: '8px',
                    background: 'rgba(255,255,255,0.7)', borderRadius: '12px',
                    border: '1px solid rgba(244,63,94,0.15)'
                  }
                },
                  // –ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã
                  React.createElement('input', {
                    value: z.name,
                    onChange: e => updateZone(i, { name: e.target.value }),
                    onFocus: e => e.target.select(),
                    style: {
                      width: '100%', padding: '8px 12px', fontSize: '14px', fontWeight: 600,
                      border: '1px solid rgba(0,0,0,0.08)', borderRadius: '8px',
                      background: 'rgba(255,255,255,0.9)'
                    }
                  }),
                  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Ä—è–¥
                  React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '8px', alignItems: 'center' } },
                    // –ü—É–ª—å—Å –æ—Ç-–¥–æ
                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: 'rgba(244,63,94,0.08)', borderRadius: '8px' } },
                      React.createElement('span', { style: { fontSize: '12px', color: 'var(--gray-500)' } }, 'üíì'),
                      React.createElement('input', {
                        type: 'number', value: z.hrFrom, onChange: e => updateZone(i, { hrFrom: Number(e.target.value) || 0 }), onFocus: e => e.target.select(),
                        style: { width: '50px', padding: '4px 6px', fontSize: '13px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '6px' }
                      }),
                      React.createElement('span', { style: { color: 'var(--gray-400)' } }, '‚Äî'),
                      React.createElement('input', {
                        type: 'number', value: z.hrTo, onChange: e => updateZone(i, { hrTo: Number(e.target.value) || 0 }), onFocus: e => e.target.select(),
                        style: { width: '50px', padding: '4px 6px', fontSize: '13px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '6px' }
                      }),
                      React.createElement('span', { style: { fontSize: '11px', color: 'var(--gray-400)' } }, '—É–¥/–º–∏–Ω')
                    ),
                    // MET
                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: 'rgba(59,130,246,0.08)', borderRadius: '8px' } },
                      React.createElement('span', { style: { fontSize: '12px', color: 'var(--gray-500)' } }, '‚ö°'),
                      React.createElement('span', { style: { fontSize: '12px', color: 'var(--gray-500)' } }, 'MET'),
                      React.createElement('input', {
                        type: 'number', step: '0.1', value: z.MET, onChange: e => updateZone(i, { MET: Number(e.target.value) || 0 }), onFocus: e => e.target.select(),
                        style: { width: '45px', padding: '4px 6px', fontSize: '13px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '6px' }
                      })
                    ),
                    // –ö–∞–ª–æ—Ä–∏–∏ –≤ –º–∏–Ω—É—Ç—É (computed)
                    React.createElement('div', { style: { padding: '6px 12px', background: 'rgba(34,197,94,0.1)', borderRadius: '8px', marginLeft: 'auto' } },
                      React.createElement('span', { style: { fontSize: '13px', fontWeight: 600, color: '#15803d' } }, `${calPerMin} –∫–∞–ª/–º–∏–Ω`)
                    )
                  )
                );
              })
            ),
            React.createElement('div', { className: 'muted', style: { marginTop: '8px', display: 'flex', alignItems: 'center', gap: '8px' } },
              '–ú–∞–∫—Å –ø—É–ª—å—Å = 220 ‚àí –≤–æ–∑—Ä–∞—Å—Ç. –ö–∞–ª/–º–∏–Ω = MET √ó (–≤–µ—Å √ó 0.0175) ‚àí 1.',
              zonesPending && React.createElement('span', { style: { color: '#f59e0b', fontSize: '13px', fontWeight: 500 } }, '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...'),
              zonesSaved && React.createElement('span', { style: { color: '#22c55e', fontSize: '13px', fontWeight: 500 } }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
            )
          ) // end profile-section__fields
        ), // end ProfileSection hrZones

        // === –°–ï–ö–¶–ò–Ø 3: –ù–æ—Ä–º—ã –∏ –∑–æ–Ω—ã ===
        React.createElement(ProfileSection, {
          id: 'norms',
          icon: 'üìä',
          title: '–ù–æ—Ä–º—ã –ø–∏—Ç–∞–Ω–∏—è',
          subtitle: '–ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ë–ñ–£',
          tone: 'violet',
          expanded: expandedSections.norms,
          onToggle: () => toggleSection('norms')
        },
          React.createElement('div', { className: 'profile-section__fields' },
            // –ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ (ratio zones)
            React.createElement(HEYS_RatioZonesCard, null),
            React.createElement(HEYS_NormsCard, null)
          )
        ), // end ProfileSection norms

        // === –°–ï–ö–¶–ò–Ø 4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (PIN) ===
        React.createElement(ProfileSection, {
          id: 'security',
          icon: 'üîí',
          title: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
          subtitle: '–°–º–µ–Ω–∞ PIN –¥–ª—è –≤—Ö–æ–¥–∞',
          tone: 'amber',
          expanded: expandedSections.security,
          onToggle: () => toggleSection('security')
        },
          React.createElement('div', { className: 'profile-section__fields' },
            React.createElement('div', { className: 'profile-field-group' },
              React.createElement('div', { className: 'profile-field-group__header', style: { alignItems: 'center', gap: '8px' } },
                React.createElement('span', { className: 'profile-field-group__icon' }, 'üìû'),
                React.createElement('span', { className: 'profile-field-group__title' }, 'PIN –∫–ª–∏–µ–Ω—Ç–∞'),
                React.createElement('span', { className: 'profile-field-group__badge' }, `Client ID: ${getShortClientId(getCurrentClientId())}`)
              ),
              React.createElement('div', { className: 'muted', style: { marginBottom: '8px' } }, '–ù–æ–≤—ã–π PIN –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä. –°—Ç–∞—Ä—ã–π PIN –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä—É.'),
              React.createElement('div', { className: 'field-list' },
                React.createElement('div', { className: 'inline-field' },
                  React.createElement('label', null, '–ù–æ–≤—ã–π PIN'),
                  React.createElement('span', { className: 'sep' }, '-'),
                  React.createElement('input', {
                    type: 'password',
                    inputMode: 'numeric',
                    pattern: '\\d*',
                    maxLength: 4,
                    value: pinForm.pin,
                    onChange: e => setPinForm(prev => ({ ...prev, pin: e.target.value.replace(/[^0-9]/g, '').slice(0, 4) })),
                    placeholder: '4 —Ü–∏—Ñ—Ä—ã',
                    style: { width: '120px' }
                  })
                ),
                React.createElement('div', { className: 'inline-field' },
                  React.createElement('label', null, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ'),
                  React.createElement('span', { className: 'sep' }, '-'),
                  React.createElement('input', {
                    type: 'password',
                    inputMode: 'numeric',
                    pattern: '\\d*',
                    maxLength: 4,
                    value: pinForm.confirm,
                    onChange: e => setPinForm(prev => ({ ...prev, confirm: e.target.value.replace(/[^0-9]/g, '').slice(0, 4) })),
                    placeholder: '–ï—â—ë —Ä–∞–∑',
                    style: { width: '120px' }
                  })
                )
              ),
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginTop: '10px' } },
                React.createElement('button', {
                  className: 'btn',
                  onClick: handlePinUpdate,
                  disabled: pinStatus === 'pending',
                  style: { minWidth: '140px' }
                }, pinStatus === 'pending' ? '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶' : '–û–±–Ω–æ–≤–∏—Ç—å PIN'),
                pinStatus === 'pending' && React.createElement('span', { style: { color: '#f59e0b' } }, '‚è≥'),
                pinStatus === 'success' && React.createElement('span', { style: { color: '#22c55e' } }, '‚úì –ì–æ—Ç–æ–≤–æ'),
                pinStatus === 'error' && React.createElement('span', { style: { color: '#ef4444' } }, '‚ö†Ô∏è –û—à–∏–±–∫–∞')
              ),
              pinMessage && React.createElement('div', { className: 'muted', style: { marginTop: '6px', color: pinStatus === 'error' ? '#ef4444' : 'var(--gray-600)' } }, pinMessage)
            )
          )
        ), // end ProfileSection security

        // === –°–ï–ö–¶–ò–Ø 5: –ü–æ–¥–ø–∏—Å–∫–∞ (–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å HEYS.Subscription) ===
        React.createElement(ProfileSection, {
          id: 'subscription',
          icon: 'üíé',
          title: '–ü–æ–¥–ø–∏—Å–∫–∞',
          subtitle: (() => {
            const cached = window.HEYS?.Subscription?.getCachedStatus?.();
            if (!cached) return '–ó–∞–≥—Ä—É–∑–∫–∞...';
            const meta = window.HEYS.Subscription.getStatusMeta(cached.status);
            return meta?.label || '–¢–∞—Ä–∏—Ñ –∏ –æ–ø–ª–∞—Ç–∞';
          })(),
          tone: 'emerald',
          expanded: expandedSections.subscription,
          onToggle: () => toggleSection('subscription')
        },
          // –ü—Ä–æ—Å—Ç–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
          React.createElement(SubscriptionStatusSection)
        ),

        // === –°–ï–ö–¶–ò–Ø 6: –°–∏—Å—Ç–µ–º–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ===
        React.createElement(ProfileSection, {
          id: 'system',
          icon: '‚öôÔ∏è',
          title: '–°–∏—Å—Ç–µ–º–∞',
          subtitle: '–°–æ–≤–µ—Ç—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞',
          tone: 'slate',
          expanded: expandedSections.system,
          onToggle: () => toggleSection('system')
        },
          React.createElement('div', { className: 'profile-section__fields' },
            // üñ•Ô∏è –î–æ—Å—Ç—É–ø —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
            React.createElement('div', { className: 'profile-field-group' },
              React.createElement('div', { className: 'profile-field-group__header' },
                React.createElement('span', { className: 'profile-field-group__icon' }, 'üñ•Ô∏è'),
                React.createElement('span', { className: 'profile-field-group__title' }, '–î–æ—Å—Ç—É–ø —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞')
              ),
              React.createElement('div', { style: { marginTop: '8px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
                React.createElement('span', { style: { color: 'var(--gray-600)' } },
                  '–†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ —Å –¥–µ—Å–∫—Ç–æ–ø–∞'
                ),
                React.createElement('label', { className: 'toggle-switch' },
                  React.createElement('input', {
                    type: 'checkbox',
                    checked: !!profile.desktopAllowed,
                    onChange: e => updateProfileField('desktopAllowed', e.target.checked)
                  }),
                  React.createElement('span', { className: 'toggle-slider' })
                )
              ),
              React.createElement('div', { className: 'muted', style: { marginTop: '6px', fontSize: '13px' } },
                profile.desktopAllowed
                  ? '‚úì –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ'
                  : '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ'
              )
            ),
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è (Onboarding Tour)
            React.createElement('div', { className: 'profile-field-group' },
              React.createElement('div', { className: 'profile-field-group__header' },
                React.createElement('span', { className: 'profile-field-group__icon' }, 'üéì'),
                React.createElement('span', { className: 'profile-field-group__title' }, '–û–±—É—á–µ–Ω–∏–µ')
              ),
              React.createElement('div', { style: { marginTop: 8 } },
                React.createElement('button', {
                  className: 'btn btn--secondary btn--full',
                  style: { justifyContent: 'center' },
                  onClick: () => {
                    if (window.HEYS.OnboardingTour) {
                      window.HEYS.OnboardingTour.start({ force: true });
                    } else {
                      window.alert('–ú–æ–¥—É–ª—å –æ–±—É—á–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                  }
                }, '–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ')
              )
            ),

            // üîä –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            React.createElement(SoundSettingsCard, null),

            // üö´ –°–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç)
            React.createElement(DeletedProductsCard, null),

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–≤–µ—Ç–æ–≤
            React.createElement(HEYS_AdviceStatsCard, null),
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤
            React.createElement(HEYS_AdviceSettingsCard, null),
            // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ hdr-top)
            window.HEYS.analyticsUI
              ? React.createElement('div', { className: 'profile-field-group' },
                React.createElement('div', { className: 'profile-field-group__header' },
                  React.createElement('span', { className: 'profile-field-group__icon' }, 'üìä'),
                  React.createElement('span', { className: 'profile-field-group__title' }, '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞')
                ),
                React.createElement('div', { style: { marginTop: '8px' } },
                  React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                )
              )
              : null
          ) // end profile-section__fields
        ) // end ProfileSection system

      ) // end profile-accordion
    );
  }

  // === üîä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–æ–≤ ===
  function SoundSettingsCard() {
    const [settings, setSettings] = React.useState(() => {
      return window.HEYS?.game?.getSoundSettings?.() || { enabled: true, volume: 0.15 };
    });

    const handleToggle = (e) => {
      const newSettings = { ...settings, enabled: e.target.checked };
      setSettings(newSettings);
      if (window.HEYS?.game?.setSoundSettings) {
        window.HEYS.game.setSoundSettings(newSettings);
      }
    };

    const handleVolumeChange = (e) => {
      const volume = parseFloat(e.target.value);
      const newSettings = { ...settings, volume };
      setSettings(newSettings);
      if (window.HEYS?.game?.setSoundSettings) {
        window.HEYS.game.setSoundSettings(newSettings);
      }
    };

    // –¢–µ—Å—Ç –∑–≤—É–∫–∞
    const testSound = () => {
      if (window.HEYS?.game) {
        // –í—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ –¥–ª—è —Ç–µ—Å—Ç–∞
        const wasEnabled = settings.enabled;
        if (!wasEnabled) {
          window.HEYS.game.setSoundSettings({ ...settings, enabled: true });
        }
        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫ —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API
        if (typeof window.playXPSound === 'function') {
          window.playXPSound(true);
        }
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        if (!wasEnabled) {
          setTimeout(() => {
            window.HEYS.game.setSoundSettings({ ...settings, enabled: false });
          }, 500);
        }
      }
    };

    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', { className: 'profile-field-group__header' },
        React.createElement('span', { className: 'profile-field-group__icon' }, 'üîä'),
        React.createElement('span', { className: 'profile-field-group__title' }, '–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã')
      ),
      React.createElement('div', { style: { marginTop: '8px' } },
        // Toggle –≤–∫–ª—é—á–µ–Ω–∏—è
        React.createElement('div', {
          style: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            marginBottom: '12px'
          }
        },
          React.createElement('span', { style: { color: 'var(--gray-600)' } },
            '–ó–≤—É–∫–∏ XP –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π'
          ),
          React.createElement('label', { className: 'toggle-switch' },
            React.createElement('input', {
              type: 'checkbox',
              checked: settings.enabled,
              onChange: handleToggle
            }),
            React.createElement('span', { className: 'toggle-slider' })
          )
        ),
        // –ì—Ä–æ–º–∫–æ—Å—Ç—å (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        settings.enabled && React.createElement('div', {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            marginBottom: '12px'
          }
        },
          React.createElement('span', {
            style: { color: 'var(--gray-500)', fontSize: '13px', minWidth: '70px' }
          }, '–ì—Ä–æ–º–∫–æ—Å—Ç—å:'),
          React.createElement('input', {
            type: 'range',
            min: '0.05',
            max: '0.3',
            step: '0.05',
            value: settings.volume,
            onChange: handleVolumeChange,
            style: { flex: 1, accentColor: 'var(--primary-500)' }
          }),
          React.createElement('span', {
            style: { color: 'var(--gray-600)', fontSize: '13px', minWidth: '40px' }
          }, `${Math.round(settings.volume * 100)}%`)
        ),
        React.createElement('div', {
          className: 'muted',
          style: { fontSize: '13px' }
        },
          settings.enabled
            ? '‚úì –ó–≤—É–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã (–ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ XP –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π)'
            : '–ó–≤—É–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã'
        )
      )
    );
  }

  // === üö´ –°–∫—Ä—ã—Ç—ã–µ (—É–¥–∞–ª—ë–Ω–Ω—ã–µ) –ø—Ä–æ–¥—É–∫—Ç—ã ===
  function DeletedProductsCard() {
    const [products, setProducts] = React.useState([]);
    const [expanded, setExpanded] = React.useState(false);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    const loadProducts = React.useCallback(() => {
      if (window.HEYS?.deletedProducts?.getAll) {
        const all = window.HEYS.deletedProducts.getAll();
        setProducts(all);
      }
    }, []);

    React.useEffect(() => {
      loadProducts();
      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      const handleChange = () => loadProducts();
      window.addEventListener('heys:deleted-products-changed', handleChange);
      return () => window.removeEventListener('heys:deleted-products-changed', handleChange);
    }, [loadProducts]);

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç (—É–±—Ä–∞—Ç—å –∏–∑ –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç–∞)
    const handleRestore = (entry) => {
      if (!window.HEYS?.deletedProducts?.remove) return;

      if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "${entry.name}" –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö?\n\n–ü—Ä–æ–¥—É–∫—Ç —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ –ø–æ–∏—Å–∫–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –æ–±–ª–∞–∫–æ–º.`)) {
        return;
      }

      window.HEYS.deletedProducts.remove(entry.name, entry.id, entry.fingerprint);
      loadProducts();

      // Haptic feedback
      if (window.HEYS?.dayUtils?.haptic) {
        window.HEYS.dayUtils.haptic('light');
      }
    };

    // –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
    const handleClearAll = () => {
      if (products.length === 0) return;
      if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ ${products.length} —Å–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤?\n\n–û–Ω–∏ —Å–Ω–æ–≤–∞ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ –ø–æ–∏—Å–∫–µ.`)) {
        return;
      }
      if (window.HEYS?.deletedProducts?.clear) {
        window.HEYS.deletedProducts.clear();
        loadProducts();
      }
    };

    const count = products.length;
    const ttlDays = window.HEYS?.deletedProducts?.TTL_DAYS || 90;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã —É–¥–∞–ª–µ–Ω–∏—è
    const formatDeletedDate = (timestamp) => {
      if (!timestamp) return '';
      const now = Date.now();
      const daysAgo = Math.floor((now - timestamp) / (24 * 60 * 60 * 1000));
      if (daysAgo === 0) return '—Å–µ–≥–æ–¥–Ω—è';
      if (daysAgo === 1) return '–≤—á–µ—Ä–∞';
      if (daysAgo < 7) return `${daysAgo} –¥–Ω. –Ω–∞–∑–∞–¥`;
      if (daysAgo < 30) return `${Math.floor(daysAgo / 7)} –Ω–µ–¥. –Ω–∞–∑–∞–¥`;
      return `${Math.floor(daysAgo / 30)} –º–µ—Å. –Ω–∞–∑–∞–¥`;
    };

    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', {
        className: 'profile-field-group__header',
        style: { cursor: count > 0 ? 'pointer' : 'default' },
        onClick: () => count > 0 && setExpanded(!expanded)
      },
        React.createElement('span', { className: 'profile-field-group__icon' }, 'üö´'),
        React.createElement('span', { className: 'profile-field-group__title' }, '–°–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã'),
        count > 0 && React.createElement('span', {
          style: {
            marginLeft: 'auto',
            background: 'var(--gray-200)',
            color: 'var(--gray-600)',
            padding: '2px 8px',
            borderRadius: '10px',
            fontSize: '12px',
            fontWeight: '500'
          }
        }, count),
        count > 0 && React.createElement('span', {
          style: {
            marginLeft: '8px',
            color: 'var(--gray-400)',
            fontSize: '16px',
            transition: 'transform 0.2s',
            transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)'
          }
        }, '‚ñº')
      ),
      React.createElement('div', { style: { marginTop: '8px' } },
        count === 0
          ? React.createElement('div', {
            className: 'muted',
            style: { fontSize: '13px' }
          }, '‚úì –ù–µ—Ç —Å–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤')
          : React.createElement(React.Fragment, null,
            React.createElement('div', {
              className: 'muted',
              style: { fontSize: '13px', marginBottom: '8px' }
            }, `–ü—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —É–¥–∞–ª–∏–ª–∏. –û–Ω–∏ –Ω–µ –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –∏–∑ –æ–±–ª–∞–∫–∞. –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ ${ttlDays} –¥–Ω–µ–π.`),
            expanded && React.createElement('div', {
              style: {
                maxHeight: '200px',
                overflowY: 'auto',
                marginBottom: '8px',
                borderRadius: '8px',
                border: '1px solid var(--gray-200)'
              }
            },
              products.map((entry, i) =>
                React.createElement('div', {
                  key: entry.name + i,
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '8px 12px',
                    borderBottom: i < products.length - 1 ? '1px solid var(--gray-100)' : 'none',
                    background: i % 2 === 0 ? 'var(--gray-50)' : 'white'
                  }
                },
                  React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                    React.createElement('div', {
                      style: {
                        fontSize: '14px',
                        color: 'var(--gray-700)',
                        whiteSpace: 'nowrap',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis'
                      }
                    }, entry.name),
                    React.createElement('div', {
                      style: { fontSize: '11px', color: 'var(--gray-400)' }
                    }, `–£–¥–∞–ª—ë–Ω ${formatDeletedDate(entry.deletedAt)}`)
                  ),
                  React.createElement('button', {
                    style: {
                      background: 'var(--green-50)',
                      border: '1px solid var(--green-200)',
                      color: 'var(--green-600)',
                      padding: '4px 10px',
                      borderRadius: '6px',
                      fontSize: '12px',
                      cursor: 'pointer',
                      marginLeft: '8px',
                      whiteSpace: 'nowrap'
                    },
                    onClick: (e) => {
                      e.stopPropagation();
                      handleRestore(entry);
                    }
                  }, '‚Ü© –í–µ—Ä–Ω—É—Ç—å')
                )
              )
            ),
            expanded && count > 1 && React.createElement('button', {
              style: {
                width: '100%',
                background: 'var(--gray-100)',
                border: '1px solid var(--gray-200)',
                color: 'var(--gray-600)',
                padding: '8px',
                borderRadius: '8px',
                fontSize: '13px',
                cursor: 'pointer'
              },
              onClick: handleClearAll
            }, `‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ (${count})`)
          )
      )
    );
  }

  // === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–≤–µ—Ç–æ–≤ ===
  function HEYS_AdviceStatsCard() {
    const [stats, setStats] = React.useState({ totalAdvicesRead: 0 });

    React.useEffect(() => {
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏
      if (window.HEYS?.game?.getStats) {
        const gameStats = window.HEYS.game.getStats();
        setStats(gameStats.stats || { totalAdvicesRead: 0 });
      }

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      const handleUpdate = () => {
        if (window.HEYS?.game?.getStats) {
          const gameStats = window.HEYS.game.getStats();
          setStats(gameStats.stats || { totalAdvicesRead: 0 });
        }
      };
      window.addEventListener('heysGameUpdate', handleUpdate);
      return () => window.removeEventListener('heysGameUpdate', handleUpdate);
    }, []);

    const total = stats.totalAdvicesRead || 0;

    // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é
    let nextMilestone, progress, remaining;
    if (total < 50) {
      nextMilestone = 50;
      progress = (total / 50) * 100;
      remaining = 50 - total;
    } else if (total < 200) {
      nextMilestone = 200;
      progress = (total / 200) * 100;
      remaining = 200 - total;
    } else {
      nextMilestone = null;
      progress = 100;
      remaining = 0;
    }

    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', { className: 'profile-field-group__header' },
        React.createElement('span', { className: 'profile-field-group__icon' }, 'üí°'),
        React.createElement('span', { className: 'profile-field-group__title' }, '–°–æ–≤–µ—Ç—ã')
      ),
      React.createElement('div', { style: { marginTop: '8px' } },
        React.createElement('div', {
          style: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            marginBottom: '8px'
          }
        },
          React.createElement('span', { style: { color: 'var(--gray-600)' } }, '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å–æ–≤–µ—Ç–æ–≤:'),
          React.createElement('span', { style: { fontWeight: 600, fontSize: '18px' } }, total)
        ),
        nextMilestone && React.createElement('div', null,
          React.createElement('div', {
            style: {
              display: 'flex',
              justifyContent: 'space-between',
              fontSize: '13px',
              color: 'var(--gray-500)',
              marginBottom: '4px'
            }
          },
            React.createElement('span', null, `–î–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "${nextMilestone === 50 ? 'üí° –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π' : 'üß† –ú—É–¥—Ä–µ—Ü'}"`),
            React.createElement('span', null, `${remaining} –æ—Å—Ç–∞–ª–æ—Å—å`)
          ),
          React.createElement('div', {
            style: {
              height: '8px',
              background: 'var(--gray-200)',
              borderRadius: '4px',
              overflow: 'hidden'
            }
          },
            React.createElement('div', {
              style: {
                height: '100%',
                width: progress + '%',
                background: 'linear-gradient(90deg, var(--blue-400), var(--blue-500))',
                borderRadius: '4px',
                transition: 'width 0.3s ease'
              }
            })
          )
        ),
        !nextMilestone && React.createElement('div', {
          style: {
            padding: '8px 12px',
            background: 'var(--green-50)',
            borderRadius: '8px',
            color: 'var(--green-700)',
            fontSize: '14px'
          }
        }, 'üèÜ –í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ —Å–æ–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã!')
      )
    );
  }

  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤ ===
  function HEYS_AdviceSettingsCard() {
    const advice = window.HEYS?.advice;
    if (!advice?.getAdviceSettings) return null;

    const [settings, setSettings] = React.useState(function () { return advice.getAdviceSettings(); });
    const [saved, setSaved] = React.useState(false);

    const categories = advice.CATEGORY_LABELS || {};

    var toggleCategory = function (cat, enabled) {
      var newSettings = {
        ...settings,
        categories: { ...settings.categories, [cat]: enabled }
      };
      setSettings(newSettings);
      advice.setAdviceSettings(newSettings);
      setSaved(true);
      setTimeout(function () { setSaved(false); }, 1500);
    };

    var updateSetting = function (key, value) {
      var newSettings = { ...settings, [key]: value };
      setSettings(newSettings);
      advice.setAdviceSettings(newSettings);
      setSaved(true);
      setTimeout(function () { setSaved(false); }, 1500);
    };

    var catEntries = Object.entries(categories);

    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', { className: 'profile-field-group__header' },
        React.createElement('span', { className: 'profile-field-group__icon' }, '‚öôÔ∏è'),
        React.createElement('span', { className: 'profile-field-group__title' }, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤')
      ),

      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π grid 3 –∫–æ–ª–æ–Ω–∫–∏
      React.createElement('div', {
        style: {
          display: 'flex',
          flexWrap: 'wrap',
          gap: '8px',
          marginTop: '12px'
        }
      },
        catEntries.map(function (entry) {
          var cat = entry[0];
          var info = entry[1];
          var isEnabled = settings.categories?.[cat] !== false;

          return React.createElement('div', {
            key: cat,
            title: info.desc,
            onClick: function () { toggleCategory(cat, !isEnabled); },
            style: {
              display: 'flex',
              alignItems: 'center',
              gap: '6px',
              padding: '8px 14px',
              background: isEnabled ? 'rgba(59, 130, 246, 0.08)' : 'var(--gray-50)',
              borderRadius: '12px',
              cursor: 'pointer',
              transition: 'all 0.2s',
              fontSize: '14px',
              fontWeight: 500,
              color: isEnabled ? 'var(--blue-600)' : 'var(--gray-500)',
              border: isEnabled ? '2px solid var(--blue-400)' : '2px solid var(--gray-200)',
              userSelect: 'none'
            }
          },
            React.createElement('span', { style: { fontSize: '16px' } }, info.icon),
            React.createElement('span', null, info.name)
          );
        })
      ),

      // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
      React.createElement('div', {
        style: {
          display: 'flex',
          flexWrap: 'wrap',
          alignItems: 'center',
          gap: '16px',
          marginTop: '16px',
          paddingTop: '12px',
          borderTop: '1px solid var(--gray-200)'
        }
      },
        // Haptic
        React.createElement('label', {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
            cursor: 'pointer',
            fontSize: '13px'
          }
        },
          React.createElement('input', {
            type: 'checkbox',
            checked: settings.hapticEnabled !== false,
            onChange: function (e) { updateSetting('hapticEnabled', e.target.checked); },
            style: { width: '16px', height: '16px' }
          }),
          React.createElement('span', null, 'üì≥ –í–∏–±—Ä–∞—Ü–∏—è')
        ),

        // Sound
        React.createElement('label', {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
            cursor: 'pointer',
            fontSize: '13px'
          }
        },
          React.createElement('input', {
            type: 'checkbox',
            checked: settings.soundEnabled !== false,
            onChange: function (e) { updateSetting('soundEnabled', e.target.checked); },
            style: { width: '16px', height: '16px' }
          }),
          React.createElement('span', null, 'üîî –ó–≤—É–∫')
        ),

        // Show details
        React.createElement('label', {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
            cursor: 'pointer',
            fontSize: '13px'
          }
        },
          React.createElement('input', {
            type: 'checkbox',
            checked: settings.showDetails !== false,
            onChange: function (e) { updateSetting('showDetails', e.target.checked); },
            style: { width: '16px', height: '16px' }
          }),
          React.createElement('span', null, 'üìñ –î–µ—Ç–∞–ª–∏')
        ),

        // Max per day
        React.createElement('label', {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
            fontSize: '13px'
          }
        },
          React.createElement('span', null, 'üìä –ú–∞–∫—Å:'),
          React.createElement('input', {
            type: 'number',
            min: 5,
            max: 50,
            value: settings.maxPerDay || 20,
            onChange: function (e) { updateSetting('maxPerDay', parseInt(e.target.value) || 20); },
            style: {
              width: '50px',
              padding: '4px 6px',
              borderRadius: '6px',
              border: '1px solid var(--gray-300)',
              textAlign: 'center',
              fontSize: '13px'
            }
          })
        )
      ),

      saved && React.createElement('div', {
        style: { marginTop: '8px', color: 'var(--green-600)', fontSize: '12px', textAlign: 'center' }
      }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
    );
  }

  // === –ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ (ratio zones) ===
  function HEYS_RatioZonesCard() {
    const rz = HEYS.ratioZones;
    const [zones, setZones] = React.useState(() => rz ? rz.getZones() : []);
    const [saved, setSaved] = React.useState(false);

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º
    React.useEffect(() => {
      if (rz) setZones(rz.getZones());
    }, []);

    const updateZone = (i, field, value) => {
      const newZones = zones.map((z, idx) => {
        if (idx !== i) return z;
        const updated = { ...z, [field]: value };
        return updated;
      });

      // –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü —Å–æ—Å–µ–¥–Ω–∏—Ö –∑–æ–Ω
      if (field === 'to' && i < newZones.length - 1) {
        newZones[i + 1] = { ...newZones[i + 1], from: value };
      }
      if (field === 'from' && i > 0) {
        newZones[i - 1] = { ...newZones[i - 1], to: value };
      }

      setZones(newZones);
      if (rz) {
        rz.setZones(newZones);
        setSaved(true);
        setTimeout(() => setSaved(false), 1500);
      }
    };

    const resetZones = () => {
      if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –∑–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
        if (rz) {
          const def = rz.resetZones();
          setZones(def);
        }
      }
    };

    // –§–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const fmtPct = (v) => {
      if (v === 0) return '0%';
      if (v === Infinity || v > 100) return '‚àû';
      return Math.round(v * 100) + '%';
    };

    if (!rz) {
      return React.createElement('div', { className: 'profile-field-group' },
        React.createElement('div', { className: 'muted' }, '–ú–æ–¥—É–ª—å ratioZones –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω')
      );
    }

    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', { className: 'profile-field-group__header', style: { justifyContent: 'space-between' } },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
          React.createElement('span', { className: 'profile-field-group__icon' }, 'üé®'),
          React.createElement('span', { className: 'profile-field-group__title' }, '–ó–æ–Ω—ã –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏')
        ),
        React.createElement('button', { className: 'btn btn-sm', onClick: resetZones, style: { marginLeft: 'auto' } }, '–°–±—Ä–æ—Å–∏—Ç—å')
      ),
      React.createElement('div', { className: 'muted', style: { marginBottom: '12px' } },
        '–û–ø—Ä–µ–¥–µ–ª—è—é—Ç —Ü–≤–µ—Ç–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, –≥—Ä–∞—Ñ–∏–∫–∞—Ö –∏ —Å–æ–≤–µ—Ç–∞—Ö. Ratio = —Å—ä–µ–¥–µ–Ω–æ / –Ω–æ—Ä–º–∞.'
      ),
      React.createElement('div', { className: 'ratio-zones-list' },
        zones.map((z, i) => {
          const demoRatio = z.to === Infinity ? z.from + 0.2 : (z.from + z.to) / 2;
          const bgColor = rz.getGradientColor(demoRatio, 0.5);
          const fromVal = i === 0 ? null : z.from;
          const toVal = i === zones.length - 1 ? null : z.to;

          return React.createElement('div', {
            key: z.id,
            style: {
              display: 'flex',
              alignItems: 'center',
              gap: '10px',
              padding: '10px 12px',
              marginBottom: '6px',
              background: 'rgba(255,255,255,0.6)',
              borderRadius: '10px',
              border: '1px solid rgba(0,0,0,0.05)'
            }
          },
            React.createElement('div', {
              style: {
                width: '28px',
                height: '28px',
                borderRadius: '6px',
                background: z.color,
                flexShrink: 0,
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
              }
            }),
            React.createElement('input', {
              value: z.name,
              onChange: function (e) { updateZone(i, 'name', e.target.value); },
              style: {
                flex: 1,
                minWidth: 0,
                padding: '6px 10px',
                fontSize: '13px',
                border: '1px solid rgba(0,0,0,0.08)',
                borderRadius: '6px',
                background: 'rgba(255,255,255,0.8)',
                fontWeight: 500
              }
            }),
            React.createElement('div', {
              style: {
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                flexShrink: 0
              }
            },
              fromVal === null
                ? React.createElement('span', { style: { width: '45px', textAlign: 'center', fontSize: '12px', color: 'var(--gray-400)' } }, '0%')
                : React.createElement('input', {
                  type: 'number',
                  step: '0.05',
                  min: '0',
                  max: '2',
                  value: fromVal,
                  onChange: function (e) { updateZone(i, 'from', parseFloat(e.target.value) || 0); },
                  style: { width: '45px', padding: '5px', fontSize: '12px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '5px' }
                }),
              React.createElement('span', { style: { color: 'var(--gray-400)', fontSize: '11px' } }, '‚Üí'),
              toVal === null
                ? React.createElement('span', { style: { width: '45px', textAlign: 'center', fontSize: '12px', color: 'var(--gray-400)' } }, '‚àû')
                : React.createElement('input', {
                  type: 'number',
                  step: '0.05',
                  min: '0',
                  max: '2',
                  value: toVal,
                  onChange: function (e) { updateZone(i, 'to', parseFloat(e.target.value) || 0); },
                  style: { width: '45px', padding: '5px', fontSize: '12px', textAlign: 'center', border: '1px solid rgba(0,0,0,0.08)', borderRadius: '5px' }
                })
            ),
            React.createElement('div', {
              style: {
                padding: '4px 10px',
                borderRadius: '6px',
                background: bgColor,
                textAlign: 'center',
                fontSize: '11px',
                fontWeight: 600,
                flexShrink: 0,
                minWidth: '45px'
              }
            }, fmtPct(demoRatio))
          );
        })
      ),
      React.createElement('div', { className: 'muted', style: { marginTop: '8px', display: 'flex', alignItems: 'center', gap: '8px' } },
        '–ó–æ–Ω—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤–µ–∑–¥–µ: –∫–∞–ª–µ–Ω–¥–∞—Ä—å, sparkline, heatmap, —Å–æ–≤–µ—Ç—ã.',
        saved && React.createElement('span', { style: { color: '#22c55e', fontSize: '13px', fontWeight: 500 } }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
      )
    );
  }


  // === –ù–æ—Ä–º—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±–ª–æ–∫) ===
  function HEYS_NormsCard() {
    const U = HEYS.utils || {};
    const clamp = (v) => Math.max(0, Math.min(100, (U.toNum ? U.toNum(v) : Number(v) || 0)));
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ lsGet/lsSet –∏–∑ –Ω–∞—á–∞–ª–∞ –º–æ–¥—É–ª—è
    const [norms, setNorms] = React.useState(() => {
      const val = readStoredValue('heys_norms', {
        carbsPct: 0, proteinPct: 0, badFatPct: 0, superbadFatPct: 0, simpleCarbPct: 0, giPct: 0, harmPct: 0, fiberPct: 0
      });
      // –°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π —Å –æ–±–ª–∞–∫–æ–º
      return { revision: 0, updatedAt: 0, ...val };
    });
    // Debounced —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º (1000ms)
    const [normsSaved, setNormsSaved] = React.useState(false);
    const [normsPending, setNormsPending] = React.useState(false);
    const [lastEditedNorm, setLastEditedNorm] = React.useState(null);
    const normsInitRef = React.useRef(true);

    React.useEffect(() => {
      if (normsInitRef.current) {
        normsInitRef.current = false;
        return;
      }
      setNormsPending(true);
      setNormsSaved(false);
      const timer = setTimeout(() => {
        writeStoredValue('heys_norms', { ...norms, updatedAt: Date.now() });
        setNormsPending(false);
        setNormsSaved(true);
        setTimeout(() => {
          setNormsSaved(false);
          setLastEditedNorm(null);
        }, 2000);
      }, 300);
      return () => clearTimeout(timer);
    }, [norms]);

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è)
    React.useEffect(() => {
      let cancelled = false;
      const clientId = window.HEYS && window.HEYS.currentClientId;
      const cloud = window.HEYS && window.HEYS.cloud;

      const reloadNorms = () => {
        if (cancelled) return;

        const newNorms = readStoredValue('heys_norms', {
          carbsPct: 0, proteinPct: 0, badFatPct: 0, superbadFatPct: 0, simpleCarbPct: 0, giPct: 0, harmPct: 0, fiberPct: 0
        });
        newNorms.revision = newNorms.revision || 0;
        newNorms.updatedAt = newNorms.updatedAt || 0;

        // –£–º–Ω—ã–π reload: –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ
        setNorms(prev => {
          const prevUpdatedAt = prev.updatedAt || 0;
          const newUpdatedAt = newNorms.updatedAt || 0;
          if (prevUpdatedAt > newUpdatedAt) {
            return prev; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–µ–µ ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
          }
          return newNorms;
        });
      };

      if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
        if (typeof cloud.shouldSyncClient === 'function' ? cloud.shouldSyncClient(clientId, 4000) : true) {
          cloud.bootstrapClientSync(clientId)
            .then(() => {
              setTimeout(reloadNorms, 150); // –ö–∞–∫ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
            })
            .catch((err) => {
              console.warn('[HEYS] Norms sync failed, using local cache:', err?.message || err);
              reloadNorms(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –ø—Ä–∏ –æ—à–∏–±–∫–µ
            });
        } else {
          reloadNorms();
        }
      } else {
        reloadNorms();
      }

      return () => { cancelled = true; };
    }, [window.HEYS && window.HEYS.currentClientId]);

    const carb = clamp(norms.carbsPct);
    const prot = clamp(norms.proteinPct);
    const fatAuto = clamp(100 - carb - prot);

    const badF = clamp(norms.badFatPct);
    const superBadF = clamp(norms.superbadFatPct);
    const goodFAuto = clamp(100 - badF - superBadF);

    const simpleC = clamp(norms.simpleCarbPct);
    const complexCAuto = clamp(100 - simpleC);

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –Ω–æ—Ä–º
    const NormFieldStatus = ({ fieldKey }) => {
      if (lastEditedNorm !== fieldKey) return null;
      if (normsPending) {
        return React.createElement('span', {
          style: { marginLeft: '6px', color: '#f59e0b', fontSize: '12px', fontWeight: 500 }
        }, '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...');
      }
      if (normsSaved) {
        return React.createElement('span', {
          style: { marginLeft: '6px', color: '#22c55e', fontSize: '12px', fontWeight: 500 }
        }, '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      }
      return null;
    };

    const update = (k, v) => {
      const clamped = clamp(v);
      setLastEditedNorm(k);
      setNormsPending(true);
      setNorms(prev => ({
        ...prev,
        [k]: clamped,
        revision: (prev.revision || 0) + 1,
        updatedAt: Date.now()
      }));
    };

    const overMacro = (carb + prot) > 100;
    const overFatSplit = (badF + superBadF) > 100;
    const overCarbSplit = simpleC > 100;

    return React.createElement('div', { className: 'profile-field-group' },
      React.createElement('div', { className: 'profile-field-group__header' },
        React.createElement('span', { className: 'profile-field-group__icon' }, 'üìä'),
        React.createElement('span', { className: 'profile-field-group__title' }, '–ù–æ—Ä–º—ã')
      ),
      React.createElement('div', { className: 'field-list' },
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–£–≥–ª–µ–≤–æ–¥—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: carb, onChange: e => update('carbsPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'carbsPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ë–µ–ª–∫–∏ (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: prot, onChange: e => update('proteinPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'proteinPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ñ–∏—Ä—ã (%) ‚Äî –∞–≤—Ç–æ = 100 ‚àí –£ ‚àí –ë'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { className: 'readOnly', readOnly: true, value: fatAuto })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: badF, onChange: e => update('badFatPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'badFatPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: superBadF, onChange: e => update('superbadFatPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'superbadFatPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (%) ‚Äî –∞–≤—Ç–æ = 100 ‚àí –≤—Ä–µ–¥–Ω—ã–µ ‚àí —Å—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { className: 'readOnly', readOnly: true, value: goodFAuto })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: simpleC, onChange: e => update('simpleCarbPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'simpleCarbPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (%) ‚Äî –∞–≤—Ç–æ = 100 ‚àí –ø—Ä–æ—Å—Ç—ã–µ'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { className: 'readOnly', readOnly: true, value: complexCAuto })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ì–ò (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: clamp(norms.giPct), onChange: e => update('giPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'giPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–í—Ä–µ–¥–Ω–æ—Å—Ç—å (%) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: clamp(norms.harmPct), onChange: e => update('harmPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'harmPct' })),
        React.createElement('div', { className: 'inline-field' }, React.createElement('label', null, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (–≥/1000 –∫–∫–∞–ª) ‚Äî –≤—Ä—É—á–Ω—É—é'), React.createElement('span', { className: 'sep' }, '-'), React.createElement('input', { type: 'number', min: 0, max: 100, step: '1', value: clamp(norms.fiberPct), onChange: e => update('fiberPct', e.target.value), onFocus: e => e.target.select() }), React.createElement(NormFieldStatus, { fieldKey: 'fiberPct' }))
      ),
      (overMacro || overFatSplit || overCarbSplit) ?
        React.createElement('div', { className: 'muted', style: { marginTop: '6px', color: '#dc2626' } },
          (overMacro ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –£% + –ë% –ø—Ä–µ–≤—ã—à–∞—é—Ç 100. –ñ–∏—Ä—ã –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã. ' : ''),
          (overFatSplit ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í—Ä–µ–¥–Ω—ã–µ% + –°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ% > 100. –ü–æ–ª–µ–∑–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã. ' : ''),
          (overCarbSplit ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—Ä–æ—Å—Ç—ã–µ% > 100. –°–ª–æ–∂–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã.' : '')
        )
        : null,
      React.createElement('div', { className: 'muted', style: { marginTop: '6px' } },
        '–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ñ–∏—Ä—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ 9 –∫–∫–∞–ª/–≥, –∫–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Äî –≤ –≥—Ä–∞–º–º–∞—Ö –Ω–∞ 1000 –∫–∫–∞–ª.'
      )
    );
  }

  function UserTab(props) {
    return React.createElement(UserTabBase, props);
  }

  HEYS.UserTab = UserTab;

  // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
  HEYS.calcSleepNorm = calcSleepNorm;
  HEYS.calcAgeFromBirthDate = calcAgeFromBirthDate;

})(window);


/* ===== heys_auth_v1.js ===== */
// heys_auth_v1.js ‚Äî Phone+PIN auth helpers (client) + curator create/reset PIN
(function (global) {
  const HEYS = (global.HEYS = global.HEYS || {});

  const U = HEYS.utils || {
    lsGet: (k, d) => {
      try {
        const v = localStorage.getItem(k);
        return v == null ? d : JSON.parse(v);
      } catch (_) {
        return d;
      }
    },
    lsSet: (k, v) => {
      try {
        localStorage.setItem(k, JSON.stringify(v));
      } catch (_) { }
    },
  };

  const AUTH_RATE_KEY = 'heys_auth_rate_limit_v1';

  function nowMs() {
    return Date.now();
  }

  function sleep(ms) {
    return new Promise((r) => setTimeout(r, ms));
  }

  function normalizePhone(raw) {
    const s = String(raw || '').trim();
    const digits = s.replace(/\D/g, '');

    // RU-focused normalization:
    // - 8XXXXXXXXXX -> 7XXXXXXXXXX
    // - +7XXXXXXXXXX -> 7XXXXXXXXXX
    // - XXXXXXXXXX (10 digits) -> 7XXXXXXXXXX
    if (digits.length === 11 && digits[0] === '8') return '7' + digits.slice(1);
    if (digits.length === 11 && digits[0] === '7') return digits;
    if (digits.length === 10) return '7' + digits;

    return digits; // fallback (will fail validation)
  }

  function isValidPhone(raw) {
    const p = normalizePhone(raw);
    return /^7\d{10}$/.test(p);
  }

  function formatPhone(raw) {
    const p = normalizePhone(raw);
    if (!/^7\d{10}$/.test(p)) return raw || '';
    const d = p.slice(1);
    return `+7 (${d.slice(0, 3)}) ${d.slice(3, 6)}-${d.slice(6, 8)}-${d.slice(8, 10)}`;
  }

  function validatePin(pin) {
    const s = String(pin || '');
    return /^\d{4}$/.test(s);
  }

  function randomHex(bytes) {
    try {
      const arr = new Uint8Array(bytes);
      crypto.getRandomValues(arr);
      return Array.from(arr)
        .map((b) => b.toString(16).padStart(2, '0'))
        .join('');
    } catch (_) {
      // —Å–ª–∞–±—ã–π fallback (–∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π)
      let out = '';
      for (let i = 0; i < bytes * 2; i++) out += Math.floor(Math.random() * 16).toString(16);
      return out;
    }
  }

  function generateSalt() {
    return randomHex(16);
  }

  async function sha256Hex(str) {
    const data = new TextEncoder().encode(String(str));
    if (global.crypto && crypto.subtle && crypto.subtle.digest) {
      const buf = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(buf))
        .map((b) => b.toString(16).padStart(2, '0'))
        .join('');
    }
    // –ë–µ–∑ WebCrypto ‚Äî –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º (–ª—É—á—à–µ —É–ø–∞—Å—Ç—å, —á–µ–º —Å–¥–µ–ª–∞—Ç—å –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)
    throw new Error('WebCrypto –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: SHA-256 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
  }

  async function hashPin(pin, salt) {
    // –ü—Ä–æ—Å—Ç–∞—è —Å—Ö–µ–º–∞: sha256(pin + ':' + salt)
    // (–°–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–∏—Ç –∏ salt, –∏ hash)
    const p = String(pin || '');
    const s = String(salt || '');
    return sha256Hex(`${p}:${s}`);
  }

  function getRateState() {
    return U.lsGet(AUTH_RATE_KEY, {
      byKey: {},
    });
  }

  function setRateState(st) {
    U.lsSet(AUTH_RATE_KEY, st);
  }

  function getAttemptKey(kind, phoneNormalized) {
    return `${kind}:${phoneNormalized || ''}`;
  }

  function canAttempt(kind, phoneNormalized) {
    const st = getRateState();
    const key = getAttemptKey(kind, phoneNormalized);
    const rec = st.byKey[key] || { count: 0, resetAt: 0, lockedUntil: 0 };
    const t = nowMs();

    if (rec.lockedUntil && t < rec.lockedUntil) {
      return {
        ok: false,
        retryAfterMs: rec.lockedUntil - t,
      };
    }

    // –æ–∫–Ω–æ 10 –º–∏–Ω—É—Ç
    const WINDOW = 10 * 60 * 1000;
    const MAX = 10;

    if (!rec.resetAt || t > rec.resetAt) {
      rec.count = 0;
      rec.resetAt = t + WINDOW;
    }

    if (rec.count >= MAX) {
      // –ª–æ–∫–∞–ª—å–Ω—ã–π lock 10 –º–∏–Ω—É—Ç
      rec.lockedUntil = t + WINDOW;
      st.byKey[key] = rec;
      setRateState(st);
      return { ok: false, retryAfterMs: WINDOW };
    }

    return { ok: true };
  }

  function registerFail(kind, phoneNormalized) {
    const st = getRateState();
    const key = getAttemptKey(kind, phoneNormalized);
    const t = nowMs();
    const rec = st.byKey[key] || { count: 0, resetAt: 0, lockedUntil: 0 };

    const WINDOW = 10 * 60 * 1000;
    if (!rec.resetAt || t > rec.resetAt) {
      rec.count = 0;
      rec.resetAt = t + WINDOW;
    }
    rec.count += 1;
    if (rec.count >= 10) rec.lockedUntil = t + WINDOW;

    st.byKey[key] = rec;
    setRateState(st);
  }

  async function loginClient({ phone, pin }) {
    // üîß FIX: –û—á–∏—â–∞–µ–º curator —Ç–æ–∫–µ–Ω –ü–ï–†–ï–î PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
    // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π heys_supabase_auth_token –æ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞,
    // switchClient –æ—à–∏–±–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç hasCuratorSession=true –∏ –æ—á–∏—Å—Ç–∏—Ç _pinAuthClientId
    // –≠—Ç–æ –ª–æ–º–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è PIN-–∫–ª–∏–µ–Ω—Ç–æ–≤ (–¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –≤ –æ–±–ª–∞–∫–æ)
    try {
      localStorage.removeItem('heys_supabase_auth_token');
    } catch (_) { }

    const phoneNorm = normalizePhone(phone);

    if (!isValidPhone(phoneNorm)) {
      return { ok: false, error: 'invalid_phone' };
    }
    if (!validatePin(pin)) {
      return { ok: false, error: 'invalid_pin' };
    }

    const rate = canAttempt('login', phoneNorm);
    if (!rate.ok) {
      return { ok: false, error: 'rate_limited', retryAfterMs: rate.retryAfterMs };
    }

    // fake delay to reduce timing attacks
    await sleep(350 + Math.floor(Math.random() * 250));

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase
    const api = HEYS.YandexAPI;
    if (!api) {
      return { ok: false, error: 'api_not_ready', _debug: { stage: 'init' } };
    }

    try {
      // v3: –æ–¥–Ω–æ—à–∞–≥–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (—Å–µ—Ä–≤–µ—Ä —Å–∞–º —Ö–µ—à–∏—Ä—É–µ—Ç PIN)
      const vRes = await api.rpc('verify_client_pin_v3', {
        p_phone: phoneNorm,
        p_pin: pin,
      });

      if (vRes.error) {
        registerFail('login', phoneNorm);
        return {
          ok: false,
          error: vRes.error.message === 'rate_limited' ? 'rate_limited' : 'invalid_credentials',
          _debug: {
            stage: 'verify_pin',
            rpc: 'verify_client_pin_v3',
            code: vRes.error.code,
            message: vRes.error.message,
          },
        };
      }

      // YandexAPI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { verify_client_pin_v3: { success, client_id, ... } }
      const rawData = vRes.data;
      const vRow = rawData?.verify_client_pin_v3 || (Array.isArray(rawData) ? rawData[0] : rawData);

      // v3 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { success, client_id, session_token, error }
      if (!vRow?.success) {
        registerFail('login', phoneNorm);
        return {
          ok: false,
          error: vRow?.error === 'rate_limited' ? 'rate_limited' : 'invalid_credentials',
          _debug: {
            stage: 'verify_pin',
            rpc: 'verify_client_pin_v3',
            serverError: vRow?.error,
          },
        };
      }

      const clientId = vRow.client_id;
      const sessionToken = vRow.session_token;
      const clientName = vRow.name || vRow.client_name || ''; // –ò–º—è –≤–≤–µ–¥—ë–Ω–Ω–æ–µ –∫—É—Ä–∞—Ç–æ—Ä–æ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

      if (!clientId || !sessionToken) {
        registerFail('login', phoneNorm);
        return {
          ok: false,
          error: 'invalid_credentials',
          _debug: {
            stage: 'verify_pin',
            rpc: 'verify_client_pin_v3',
            hasClientId: !!clientId,
            hasSessionToken: !!sessionToken,
          },
        };
      }

      // üîê –°–æ—Ö—Ä–∞–Ω—è–µ–º session_token –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö RPC –≤—ã–∑–æ–≤–æ–≤
      setSessionToken(sessionToken);

      // üîê –°–æ—Ö—Ä–∞–Ω—è–µ–º PIN-–∫–ª–∏–µ–Ω—Ç–∞ –∑–∞—Ä–∞–Ω–µ–µ (–Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è switchClient)
      try {
        localStorage.setItem('heys_pin_auth_client', clientId);
      } catch (_) { }

      // üí° –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
      // ‚ö†Ô∏è v1.15 FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage.setItem –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ namespace),
      // —Ç.–∫. heys_profile_step_v1.js —á–∏—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ localStorage.getItem('heys_pending_client_name')
      if (clientName) {
        localStorage.setItem('heys_pending_client_name', JSON.stringify(clientName));
      }

      // üì° Notify components about auth state change (for curator status refresh)
      window.dispatchEvent(new Event('heys:auth-changed'));

      console.info(`[HEYS.auth] üîê –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${clientId.slice(0, 8)}***`);

      return { ok: true, clientId, sessionToken, clientName };
    } catch (e) {
      registerFail('login', phoneNorm);
      return {
        ok: false,
        error: 'exception',
        message: e?.message || String(e),
        _debug: { stage: 'exception' },
      };
    }
  }

  async function createClientWithPin({ name, phone, pin }) {
    const phoneNorm = normalizePhone(phone);

    if (!isValidPhone(phoneNorm)) {
      return { ok: false, error: 'invalid_phone' };
    }
    if (!validatePin(pin)) {
      return { ok: false, error: 'invalid_pin' };
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      return { ok: false, error: 'api_not_ready' };
    }

    const salt = generateSalt();
    const pinHash = await hashPin(pin, salt);

    const res = await api.rpc('create_client_with_pin', {
      p_name: String(name || '').trim(),
      p_phone: phoneNorm,
      p_pin_salt: salt,
      p_pin_hash: pinHash,
    });

    if (res.error) {
      return { ok: false, error: 'server_error', message: res.error.message };
    }

    const row = Array.isArray(res.data) ? res.data[0] : res.data;
    const clientId = row && (row.client_id || row.id);

    // üîî –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è RationTab –∏ –¥—Ä.)
    window.dispatchEvent(new Event('heys:auth-changed'));

    return {
      ok: true,
      client: res.data,
      clientId,
      phone: phoneNorm,
      pin,
    };
  }

  async function resetClientPin({ clientId, newPin }) {
    if (!clientId) return { ok: false, error: 'missing_client_id' };
    if (!validatePin(newPin)) return { ok: false, error: 'invalid_pin' };

    const api = HEYS.YandexAPI;
    if (!api) {
      return { ok: false, error: 'api_not_ready' };
    }

    const salt = generateSalt();
    const pinHash = await hashPin(newPin, salt);

    const res = await api.rpc('reset_client_pin', {
      p_client_id: clientId,
      p_pin_salt: salt,
      p_pin_hash: pinHash,
    });

    if (res.error) {
      return { ok: false, error: 'server_error', message: res.error.message };
    }

    return { ok: true };
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä—Å–∫–æ–π
   * –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã: heys_curator_session (JWT), fallback: legacy supabase token,
   * –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π fallback: HEYS.cloud.getUser()
   */
  function isCuratorSession() {
    try {
      const curatorSession = localStorage.getItem('heys_curator_session');
      if (curatorSession && curatorSession.length > 10) return true;
      const legacy = localStorage.getItem('heys_supabase_auth_token');
      if (legacy) {
        const parsed = JSON.parse(legacy);
        if (parsed?.access_token) return true;
      }
    } catch (_) { }
    try {
      return !!HEYS.cloud?.getUser?.();
    } catch (_) {
      return false;
    }
  }

  // === Session Token Management ===

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π session_token
   * üîß v55 FIX: –º–∏–≥—Ä–∞—Ü–∏—è –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ namespaced –∫–ª—é—á–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π
   */
  function getSessionToken() {
    // 1) –ü—Ä–æ–±—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ—Å–ª–µ v55)
    let token = U.lsGet('heys_session_token', null);
    if (token) return token;

    // 2) –ú–∏–≥—Ä–∞—Ü–∏—è: –∏—â–µ–º —Ç–æ–∫–µ–Ω –ø–æ–¥ —Å—Ç–∞—Ä—ã–º namespaced –∫–ª—é—á–æ–º
    //    –§–æ—Ä–º–∞—Ç –±—ã–ª: heys_{clientId}_session_token
    try {
      // üîê –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è PIN auth (–Ω–µ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
      const clientId = localStorage.getItem('heys_pin_auth_client');
      if (clientId) {
        const cid = clientId.replace(/"/g, ''); // —É–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ JSON.stringify
        const oldKey = `heys_${cid}_session_token`;
        const oldToken = localStorage.getItem(oldKey);
        if (oldToken) {
          // –ú–∏–≥—Ä–∏—Ä—É–µ–º –≤ –Ω–æ–≤—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á
          try {
            const parsed = JSON.parse(oldToken);
            localStorage.setItem('heys_session_token', oldToken);
            localStorage.removeItem(oldKey); // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π
            return parsed;
          } catch (e) {
            localStorage.setItem('heys_session_token', oldToken);
            localStorage.removeItem(oldKey);
            return oldToken;
          }
        }
      }
    } catch (e) {
      // Migration error - ignore
    }

    return null;
  }

  /**
   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å session token (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
   * @param {string} token - Session token
   */
  function setSessionToken(token) {
    if (!token) {
      return;
    }
    try {
      localStorage.setItem('heys_session_token', JSON.stringify(token));
    } catch (_) { }
    try {
      U.lsSet('heys_session_token', token);
    } catch (_) { }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å session token –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ revoke –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
   */
  function clearSessionToken() {
    try {
      localStorage.removeItem('heys_session_token');
    } catch (_) { }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è
   */
  function hasSession() {
    return !!getSessionToken();
  }

  /**
   * Logout ‚Äî –æ—Ç–æ–∑–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
   */
  async function logout() {
    const token = getSessionToken();

    if (token) {
      const api = HEYS.YandexAPI;
      if (api) {
        try {
          await api.rpc('revoke_session', { p_session_token: token });
        } catch (e) {
          // Revoke failed - continue with local cleanup
        }
      }
    }

    // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    try {
      localStorage.removeItem('heys_session_token');
      localStorage.removeItem('heys_client_current');
    } catch (_) { }

    console.info('[HEYS.auth] üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');

    // üì° Notify components about auth state change
    window.dispatchEvent(new Event('heys:auth-changed'));

    return { ok: true };
  }

  HEYS.auth = {
    normalizePhone,
    isValidPhone,
    formatPhone,
    validatePin,
    generateSalt,
    hashPin,
    loginClient,
    createClientWithPin,
    resetClientPin,
    isCuratorSession,
    // üîê Session management
    getSessionToken,
    setSessionToken,
    clearSessionToken,
    hasSession,
    logout,
  };
})(typeof window !== 'undefined' ? window : globalThis);


/* ===== heys_subscription_v1.js ===== */
// heys_subscription_v1.js ‚Äî Trial-–º–∞—à–∏–Ω–∞ + Read-only —Ä–µ–∂–∏–º
// –°—Ç–∞—Ç—É—Å—ã: none ‚Üí trial (7 –¥–Ω–µ–π) ‚Üí read_only ‚Üí active
// –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –≤—Å–µ RPC —á–µ—Ä–µ–∑ session_token (–Ω–µ client_id!)
(function (global) {
  const HEYS = (global.HEYS = global.HEYS || {});

  // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
  const STATUS = {
    NONE: 'none',                 // –ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏
    TRIAL_PENDING: 'trial_pending', // –ö—É—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä–∏–ª, –∂–¥—ë–º –ø–µ—Ä–≤—ã–π –ª–æ–≥–∏–Ω (—Ç–∞–π–º–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω)
    TRIAL: 'trial',               // –¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–µ–Ω (7 –¥–Ω–µ–π)
    ACTIVE: 'active',             // –û–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
    READ_ONLY: 'read_only',       // –¢—Ä–∏–∞–ª/–ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞
  };

  const TRIAL_DAYS = 7;
  const CACHE_KEY = 'heys_subscription_status';
  const CACHE_TTL_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const U = HEYS.utils || {};

  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const readCacheValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      if (U.lsGet) return U.lsGet(key, fallback);
      const raw = localStorage.getItem(key);
      if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
      return fallback;
    } catch (_) {
      return fallback;
    }
  };

  const writeCacheValue = (key, value) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(key, value);
        return;
      }
      if (U.lsSet) {
        U.lsSet(key, value);
        return;
      }
      localStorage.setItem(key, JSON.stringify(value));
    } catch (_) { }
  };

  const removeCacheValue = (key) => {
    try {
      if (HEYS.store?.set) HEYS.store.set(key, null);
    } catch (_) { }
    try { localStorage.removeItem(key); } catch (_) { }
  };

  // === –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ===
  let _cachedStatus = null;
  let _cachedAt = 0;

  function getCachedStatus() {
    if (_cachedStatus && Date.now() - _cachedAt < CACHE_TTL_MS) {
      return _cachedStatus;
    }
    // –ü—Ä–æ–±—É–µ–º localStorage
    const stored = readCacheValue(CACHE_KEY, null);
    if (stored && stored.status && stored.ts && Date.now() - stored.ts < CACHE_TTL_MS) {
      _cachedStatus = stored.status;
      _cachedAt = stored.ts;
      return _cachedStatus;
    }
    return null;
  }

  function setCachedStatus(status) {
    _cachedStatus = status;
    _cachedAt = Date.now();
    writeCacheValue(CACHE_KEY, { status, ts: _cachedAt });
  }

  function clearCache() {
    _cachedStatus = null;
    _cachedAt = 0;
    _inflightPromise = null; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º in-flight –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞
    removeCacheValue(CACHE_KEY);
  }

  // === In-flight deduplication (thundering herd prevention) ===
  let _inflightPromise = null;

  // === API –≤—ã–∑–æ–≤—ã ===

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
   * @param {boolean} forceRefresh - –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
   * @returns {Promise<string>} - 'none' | 'trial' | 'active' | 'read_only'
   */
  async function getStatus(forceRefresh = false) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    if (!forceRefresh) {
      const cached = getCachedStatus();
      if (cached) {
        return cached;
      }
    }

    // === DEDUPE: –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª—ë—Ç–µ ‚Äî –∂–¥—ë–º –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ===
    if (_inflightPromise && !forceRefresh) {
      return _inflightPromise;
    }

    // –ù–µ—Ç session_token ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 'none'
    const sessionToken = HEYS.auth?.getSessionToken?.();
    if (!sessionToken) {
      return STATUS.NONE;
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      console.warn('[Subscription] API –Ω–µ –≥–æ—Ç–æ–≤');
      return getCachedStatus() || STATUS.NONE;
    }

    // –°–æ–∑–¥–∞—ë–º promise –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
    _inflightPromise = (async () => {
      try {
        // üîá v4.7.0: –õ–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
        const res = await api.rpc('get_subscription_status_by_session', {
          p_session_token: sessionToken,
        });

        if (res.error) {
          // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ logout
          if (res.error.message?.includes('invalid_session')) {
            console.warn('[Subscription] –°–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞');
            clearCache();
            return STATUS.NONE;
          }
          throw new Error(res.error.message);
        }

        const status = res.data || STATUS.NONE;
        setCachedStatus(status);

        // üé´ v3.0: trial_pending = –∫—É—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä–∏–ª, –Ω–æ –¥–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ –≤ –±—É–¥—É—â–µ–º
        // –¢–∞–π–º–µ—Ä –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –∫—É—Ä–∞—Ç–æ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –¥–∞—Ç—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        // –ö–æ–≥–¥–∞ –¥–∞—Ç–∞ –Ω–∞—Å—Ç—É–ø–∏—Ç, –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω—ë—Ç status='trial'

        return status;
      } catch (e) {
        console.error('[Subscription] getStatus error:', e);
        return getCachedStatus() || STATUS.NONE;
      } finally {
        // –û—á–∏—â–∞–µ–º in-flight promise –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        _inflightPromise = null;
      }
    })();

    return _inflightPromise;
  }

  /**
   * @deprecated v5.0 ‚Äî –¢—Ä–∏–∞–ª —Ç–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ admin_activate_trial.
   * –¢–∞–π–º–µ—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ª–æ–≥–∏–Ω–µ —á–µ—Ä–µ–∑ activateTrialTimer().
   * –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
   */
  async function startTrial(days = TRIAL_DAYS) {
    console.warn('[Subscription] ‚ö†Ô∏è startTrial() deprecated ‚Äî —Ç—Ä–∏–∞–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä');
    return getCachedStatus() || STATUS.NONE;
  }

  /**
   * @deprecated v3.0 ‚Äî –¢–∞–π–º–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫—É—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ admin_activate_trial(start_date).
   * –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ‚Äî –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.
   * –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞: –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.
   * @returns {Promise<{success: boolean, message: string, trial_ends_at: string}>}
   */
  async function activateTrialTimer() {
    const sessionToken = HEYS.auth?.getSessionToken?.();
    if (!sessionToken) {
      console.warn('[Subscription] activateTrialTimer: –Ω–µ—Ç session_token');
      return { success: false, message: 'no_session' };
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      console.error('[Subscription] activateTrialTimer: API –Ω–µ –≥–æ—Ç–æ–≤');
      return { success: false, message: 'api_not_ready' };
    }

    try {
      const res = await api.rpc('activate_trial_timer_by_session', {
        p_session_token: sessionToken,
      });

      if (res.error) {
        if (res.error.message?.includes('invalid_session') || res.error.message?.includes('invalid_or_expired_session')) {
          console.warn('[Subscription] –°–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞');
          clearCache();
          return { success: false, message: 'invalid_session' };
        }
        throw new Error(res.error.message);
      }

      const result = res.data?.activate_trial_timer_by_session?.[0] || res.data?.[0] || res.data || {};

      if (result.success && result.message === 'trial_timer_started') {
        console.info('[HEYS.subscription] ‚úÖ Trial timer started, ends:', result.trial_ends_at);
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –Ω–∞ trial
        setCachedStatus(STATUS.TRIAL);
      }

      return result;
    } catch (e) {
      console.error('[Subscription] activateTrialTimer error:', e);
      return { success: false, message: e.message };
    }
  }

  // === –•–µ–ª–ø–µ—Ä—ã –¥–ª—è UI ===

  /**
   * –ú–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ?
   * trial_pending —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø–∏—Å—å (–∫—É—Ä–∞—Ç–æ—Ä —É–∂–µ –æ–¥–æ–±—Ä–∏–ª)
   */
  function canWrite(status) {
    return status === STATUS.TRIAL || status === STATUS.ACTIVE || status === STATUS.TRIAL_PENDING;
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ paywall?
   */
  function shouldShowPaywall(status) {
    return status === STATUS.READ_ONLY;
  }

  /**
   * –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç—Ä–∏–∞–ª –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞?
   */
  function isActive(status) {
    return status === STATUS.TRIAL || status === STATUS.ACTIVE || status === STATUS.TRIAL_PENDING;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å UI-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
   */
  function getStatusMeta(status) {
    switch (status) {
      case STATUS.TRIAL_PENDING:
        return {
          label: '–¢—Ä–∏–∞–ª –æ–¥–æ–±—Ä–µ–Ω',
          shortLabel: '–û–¥–æ–±—Ä–µ–Ω',
          color: '#3b82f6', // blue
          emoji: '‚úÖ',
          canWrite: true,
        };
      case STATUS.TRIAL:
        return {
          label: '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥',
          shortLabel: '–¢—Ä–∏–∞–ª',
          color: '#f59e0b', // amber
          emoji: '‚è≥',
          canWrite: true,
        };
      case STATUS.ACTIVE:
        return {
          label: '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞',
          shortLabel: 'Pro',
          color: '#22c55e', // green
          emoji: '‚ú®',
          canWrite: true,
        };
      case STATUS.READ_ONLY:
        return {
          label: '–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞',
          shortLabel: '–ò—Å—Ç–µ–∫–ª–∞',
          color: '#ef4444', // red
          emoji: 'üîí',
          canWrite: false,
        };
      case STATUS.NONE:
      default:
        return {
          label: '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏',
          shortLabel: '–ù–µ—Ç',
          color: '#6b7280', // gray
          emoji: 'üìã',
          canWrite: false,
        };
    }
  }

  // === React Hook (–µ—Å–ª–∏ React –¥–æ—Å—Ç—É–ø–µ–Ω) ===

  /**
   * useSubscription() ‚Äî React hook –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   * @returns {{ status, isLoading, isNone, isTrial, isActive, isReadOnly, canWrite, startTrial, refresh }}
   */
  function useSubscription() {
    const React = global.React;
    if (!React) {
      console.warn('[Subscription] React –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, useSubscription –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
      return {
        status: STATUS.NONE,
        isLoading: false,
        isNone: true,
        isTrial: false,
        isActive: false,
        isReadOnly: false,
        canWrite: false,
        meta: getStatusMeta(STATUS.NONE),
        startTrial: async () => STATUS.NONE,
        refresh: async () => STATUS.NONE,
      };
    }

    const { useState, useEffect, useCallback, useMemo } = React;

    const [status, setStatus] = useState(() => getCachedStatus() || STATUS.NONE);
    const [isLoading, setIsLoading] = useState(true);

    const refresh = useCallback(async (force = true) => {
      setIsLoading(true);
      try {
        const newStatus = await getStatus(force);
        setStatus(newStatus);
        return newStatus;
      } finally {
        setIsLoading(false);
      }
    }, []);

    /** @deprecated v5.0 ‚Äî —Ç—Ä–∏–∞–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä */
    const doStartTrial = useCallback(async () => {
      console.warn('[Subscription] useSubscription.startTrial() deprecated');
      return status;
    }, [status]);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    useEffect(() => {
      refresh(false);
    }, [refresh]);

    const meta = useMemo(() => getStatusMeta(status), [status]);

    return {
      status,
      isLoading,
      isNone: status === STATUS.NONE,
      isTrialPending: status === STATUS.TRIAL_PENDING,
      isTrial: status === STATUS.TRIAL,
      isActive: status === STATUS.ACTIVE,
      isReadOnly: status === STATUS.READ_ONLY,
      canWrite: canWrite(status),
      meta,
      startTrial: doStartTrial,
      refresh,
    };
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.Subscription = {
    STATUS,
    TRIAL_DAYS,

    // API
    getStatus,
    startTrial,            // @deprecated v5.0 ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π activateTrialTimer
    activateTrialTimer,    // v5.0: —Å—Ç–∞—Ä—Ç—É–µ—Ç 7-–¥–Ω–µ–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ª–æ–≥–∏–Ω–µ
    clearCache,
    getCachedStatus,       // –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ Paywall

    // Helpers
    canWrite,
    shouldShowPaywall,
    isActive,
    getStatusMeta,

    // React
    useSubscription,
  };

  // üîá v4.7.0: –õ–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∫–ª—é—á—ë–Ω
})(typeof window !== 'undefined' ? window : globalThis);


/* ===== heys_trial_queue_v1.js ===== */
// heys_trial_queue_v1.js ‚Äî –£–º–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Ç—Ä–∏–∞–ª + UI –≤–∏–¥–∂–µ—Ç—ã
// –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: –∑–∞—è–≤–∫–∞ ‚Üí –∫—É—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–∞–ª
// v2.0.0 | 2025-01-09
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;

  // ========================================
  // –ö–û–ù–°–¢–ê–ù–¢–´
  // ========================================

  const QUEUE_STATUS = {
    NOT_IN_QUEUE: 'not_in_queue',  // –ù–µ –≤ –æ—á–µ—Ä–µ–¥–∏
    PENDING: 'pending',            // –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –∂–¥—ë—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞
    ASSIGNED: 'assigned',          // –¢—Ä–∏–∞–ª —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª (–∫—É—Ä–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª)
    REJECTED: 'rejected',          // –ö—É—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É
    CANCELED: 'canceled',          // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –æ—Ç–º–µ–Ω–∏–ª
    // Legacy (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    QUEUED: 'queued',              // ‚Üí —Ç–µ–ø–µ—Ä—å pending
    OFFER: 'offer',                // ‚Üí —É–±—Ä–∞–Ω
    EXPIRED: 'expired',            // ‚Üí —Ç–µ–ø–µ—Ä—å rejected
    CANCELED_BY_PURCHASE: 'canceled_by_purchase',
  };

  const CACHE_KEY = 'heys_trial_queue_status';
  const CAPACITY_CACHE_KEY = 'heys_trial_capacity';
  const CACHE_TTL_MS = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏
  const CAPACITY_CACHE_TTL_MS = 30 * 1000; // 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è capacity

  // ========================================
  // –£–¢–ò–õ–ò–¢–´
  // ========================================

  const storeGet = (k, d) => {
    try {
      if (HEYS.store?.get) return HEYS.store.get(k, d);
      if (HEYS.utils?.lsGet) return HEYS.utils.lsGet(k, d);
      const v = localStorage.getItem(k);
      return v == null ? d : JSON.parse(v);
    } catch (_) {
      return d;
    }
  };

  const storeSet = (k, v) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(k, v);
        return;
      }
      if (HEYS.utils?.lsSet) {
        HEYS.utils.lsSet(k, v);
        return;
      }
      localStorage.setItem(k, JSON.stringify(v));
    } catch (_) { }
  };

  // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
  let _statusCache = null;
  let _statusCacheAt = 0;
  let _capacityCache = null;
  let _capacityCacheAt = 0;

  function getCachedStatus() {
    if (_statusCache && Date.now() - _statusCacheAt < CACHE_TTL_MS) {
      return _statusCache;
    }
    const stored = storeGet(CACHE_KEY, null);
    if (stored && stored.data && Date.now() - stored.ts < CACHE_TTL_MS) {
      _statusCache = stored.data;
      _statusCacheAt = stored.ts;
      return _statusCache;
    }
    return null;
  }

  function setCachedStatus(data) {
    _statusCache = data;
    _statusCacheAt = Date.now();
    storeSet(CACHE_KEY, { data, ts: _statusCacheAt });
  }

  function getCachedCapacity() {
    if (_capacityCache && Date.now() - _capacityCacheAt < CAPACITY_CACHE_TTL_MS) {
      return _capacityCache;
    }
    const stored = storeGet(CAPACITY_CACHE_KEY, null);
    if (stored && stored.data && Date.now() - stored.ts < CAPACITY_CACHE_TTL_MS) {
      _capacityCache = stored.data;
      _capacityCacheAt = stored.ts;
      return _capacityCache;
    }
    return null;
  }

  function setCachedCapacity(data) {
    _capacityCache = data;
    _capacityCacheAt = Date.now();
    storeSet(CAPACITY_CACHE_KEY, { data, ts: _capacityCacheAt });
  }

  function clearCache() {
    _statusCache = null;
    _statusCacheAt = 0;
    _capacityCache = null;
    _capacityCacheAt = 0;
    try {
      storeSet(CACHE_KEY, null);
      storeSet(CAPACITY_CACHE_KEY, null);
      localStorage.removeItem(CACHE_KEY);
      localStorage.removeItem(CAPACITY_CACHE_KEY);
    } catch (_) { }
  }

  // ========================================
  // API –§–£–ù–ö–¶–ò–ò
  // ========================================

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—É—é capacity (–±–µ–∑ auth)
   * @param {boolean} forceRefresh
   * @returns {Promise<{available_slots, total_slots, queue_size, is_accepting, offer_window_minutes, trial_days}>}
   */
  async function getCapacity(forceRefresh = false) {
    if (!forceRefresh) {
      const cached = getCachedCapacity();
      if (cached) return cached;
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      console.warn('[TrialQueue] API –Ω–µ –≥–æ—Ç–æ–≤');
      return getCachedCapacity() || {
        available_slots: 0,
        total_slots: 3,
        queue_size: 0,
        is_accepting: false,
        offer_window_minutes: 120,
        trial_days: 7
      };
    }

    try {
      const res = await api.rpc('get_public_trial_capacity', {});

      if (res.error) {
        throw new Error(res.error.message || 'Unknown error');
      }

      // API wraps response: {data: {get_public_trial_capacity: {...}}}
      const fnData = res.data?.get_public_trial_capacity || res.data || res;
      // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
      setCachedCapacity(fnData);
      return fnData;
    } catch (e) {
      console.error('[TrialQueue] getCapacity error:', e);
      return getCachedCapacity() || {
        available_slots: 0,
        total_slots: 3,
        queue_size: 0,
        is_accepting: false,
        offer_window_minutes: 120,
        trial_days: 7
      };
    }
  }

  /**
   * –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç—Ä–∏–∞–ª (offer –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å)
   * @param {string} source - –∏—Å—Ç–æ—á–Ω–∏–∫ ('app', 'landing', etc)
   * @returns {Promise<{success, status, position?, offer_expires_at?, message}>}
   */
  async function requestTrial(source = 'app') {
    const sessionToken = HEYS.auth?.getSessionToken?.();
    if (!sessionToken) {
      return { success: false, error: 'no_session', message: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' };
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
    }

    try {
      const res = await api.rpc('request_trial', {
        p_session_token: sessionToken,
        p_source: source
      });

      if (res.error) {
        return {
          success: false,
          error: res.error.code || 'unknown',
          message: res.error.message
        };
      }

      // v2.1: API wraps response in {request_trial: {...}}
      const data = res.data?.request_trial || res.data || res;
      // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
      setCachedStatus(data);

      // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º capacity cache
      _capacityCache = null;
      _capacityCacheAt = 0;

      return data;
    } catch (e) {
      console.error('[TrialQueue] requestTrial error:', e);
      return { success: false, error: 'request_failed', message: e.message };
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –æ—á–µ—Ä–µ–¥–∏
   * @param {boolean} forceRefresh
   * @returns {Promise<{success, status, position?, offer_expires_at?, queue_size}>}
   */
  async function getQueueStatus(forceRefresh = false) {
    if (!forceRefresh) {
      const cached = getCachedStatus();
      if (cached) return cached;
    }

    const sessionToken = HEYS.auth?.getSessionToken?.();
    if (!sessionToken) {
      return { success: true, status: QUEUE_STATUS.NOT_IN_QUEUE };
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      return getCachedStatus() || { success: true, status: QUEUE_STATUS.NOT_IN_QUEUE };
    }

    try {
      const res = await api.rpc('get_trial_queue_status', {
        p_session_token: sessionToken
      });

      if (res.error) {
        if (res.error.message?.includes('invalid_session')) {
          return { success: true, status: QUEUE_STATUS.NOT_IN_QUEUE };
        }
        throw new Error(res.error.message);
      }

      // v2.1: API wraps response in {get_trial_queue_status: {...}}
      const data = res.data?.get_trial_queue_status || res.data || res;
      // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
      setCachedStatus(data);
      return data;
    } catch (e) {
      console.error('[TrialQueue] getQueueStatus error:', e);
      return getCachedStatus() || { success: true, status: QUEUE_STATUS.NOT_IN_QUEUE };
    }
  }

  /**
   * @deprecated v2.0 ‚Äî –¢—Ä–∏–∞–ª —Ç–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ admin_activate_trial
   * –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
   */
  async function claimOffer() {
    console.warn('[TrialQueue] claimOffer() deprecated ‚Äî —Ç—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä');
    return {
      success: false,
      error: 'deprecated',
      message: '–¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞—è–≤–∫–∏'
    };
  }

  /**
   * –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∏–∞–ª
   * @returns {Promise<{success, message}>}
   */
  async function cancelQueue() {
    const sessionToken = HEYS.auth?.getSessionToken?.();
    if (!sessionToken) {
      return { success: false, error: 'no_session', message: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' };
    }

    const api = HEYS.YandexAPI;
    if (!api) {
      return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
    }

    try {
      const res = await api.rpc('cancel_trial_queue', {
        p_session_token: sessionToken
      });

      if (res.error) {
        return {
          success: false,
          error: res.error.code || 'unknown',
          message: res.error.message
        };
      }

      // –û—á–∏—â–∞–µ–º –∫—ç—à–∏
      clearCache();

      // v2.1: API wraps response in {cancel_trial_queue: {...}}
      const data = res.data?.cancel_trial_queue || res.data || res;
      // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
      return data;
    } catch (e) {
      console.error('[TrialQueue] cancelQueue error:', e);
      return { success: false, error: 'cancel_failed', message: e.message };
    }
  }

  // ========================================
  // –•–ï–õ–ü–ï–†–´
  // ========================================

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
   */
  function formatTimeRemaining(expiresAt) {
    if (!expiresAt) return '';

    const expires = new Date(expiresAt);
    const now = new Date();
    const diffMs = expires - now;

    if (diffMs <= 0) return '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ';

    const minutes = Math.floor(diffMs / 60000);
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;

    if (hours > 0) {
      return `${hours}—á ${mins}–º`;
    }
    return `${mins}–º`;
  }

  /**
   * @deprecated v2.0 ‚Äî Offer –º–µ—Ö–∞–Ω–∏–∫–∞ —É–±—Ä–∞–Ω–∞
   */
  function isOfferExpired(expiresAt) {
    if (!expiresAt) return true;
    return new Date(expiresAt) <= new Date();
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å UI-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –æ—á–µ—Ä–µ–¥–∏
   * v2.0: –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑ offer
   */
  function getQueueStatusMeta(status, position, offerExpiresAt) {
    switch (status) {
      // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
      case QUEUE_STATUS.PENDING:
      case QUEUE_STATUS.QUEUED: // Legacy ‚Üí pending
        return {
          label: '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞',
          shortLabel: '–û–∂–∏–¥–∞–Ω–∏–µ',
          color: '#f59e0b',
          emoji: '‚è≥',
          actionLabel: '–û—Ç–º–µ–Ω–∏—Ç—å',
          showTimer: false,
          description: '–ö—É—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–∏–∞–ª–∞'
        };

      // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: –∫—É—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª
      case QUEUE_STATUS.REJECTED:
      case QUEUE_STATUS.EXPIRED: // Legacy ‚Üí rejected
        return {
          label: '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞',
          shortLabel: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
          color: '#ef4444',
          emoji: '‚ùå',
          actionLabel: '–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞',
          showTimer: false,
          description: '–ö—É—Ä–∞—Ç–æ—Ä –Ω–µ —Å–º–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞—è–≤–∫—É'
        };

      // Legacy: offer ‚Üí —Ç–µ–ø–µ—Ä—å —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ pending
      case QUEUE_STATUS.OFFER:
        return {
          label: '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞',
          shortLabel: '–û–∂–∏–¥–∞–Ω–∏–µ',
          color: '#f59e0b',
          emoji: '‚è≥',
          actionLabel: '–û—Ç–º–µ–Ω–∏—Ç—å',
          showTimer: false,
          description: '–ö—É—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–∏–∞–ª–∞'
        };

      case QUEUE_STATUS.ASSIGNED:
        return {
          label: '–¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–µ–Ω',
          shortLabel: '–ê–∫—Ç–∏–≤–µ–Ω',
          color: '#22c55e',
          emoji: '‚úÖ',
          actionLabel: null,
          showTimer: false,
          description: '–ö—É—Ä–∞—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω, —Ç—Ä–∏–∞–ª –∏–¥—ë—Ç'
        };

      case QUEUE_STATUS.CANCELED:
      case QUEUE_STATUS.CANCELED_BY_PURCHASE:
        return {
          label: status === QUEUE_STATUS.CANCELED_BY_PURCHASE
            ? '–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞'
            : '–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω',
          shortLabel: status === QUEUE_STATUS.CANCELED_BY_PURCHASE ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–û—Ç–º–µ–Ω—ë–Ω',
          color: status === QUEUE_STATUS.CANCELED_BY_PURCHASE ? '#22c55e' : '#6b7280',
          emoji: status === QUEUE_STATUS.CANCELED_BY_PURCHASE ? 'üí≥' : '‚ùå',
          actionLabel: status === QUEUE_STATUS.CANCELED_BY_PURCHASE ? null : '–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞',
          showTimer: false,
        };

      case QUEUE_STATUS.NOT_IN_QUEUE:
      default:
        return {
          label: '–ù–µ –≤ –æ—á–µ—Ä–µ–¥–∏',
          shortLabel: '',
          color: '#6b7280',
          emoji: '',
          actionLabel: '–ù–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª',
          showTimer: false,
        };
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å UI-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è capacity –≤–∏–¥–∂–µ—Ç–∞
   * v2.1: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π API (is_accepting + queue_length)
   */
  function getCapacityMeta(capacity) {
    // API v2 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { is_accepting, queue_length }
    // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    const is_accepting = capacity.is_accepting;
    const queue_length = capacity.queue_length ?? capacity.queue_size ?? 0;
    const available_slots = capacity.available_slots; // –º–æ–∂–µ—Ç –±—ã—Ç—å undefined –≤ v2
    const total_slots = capacity.total_slots; // –º–æ–∂–µ—Ç –±—ã—Ç—å undefined –≤ v2

    if (!is_accepting) {
      return {
        status: 'paused',
        color: '#6b7280',
        emoji: '‚è∏Ô∏è',
        label: '–ü—Ä–∏—ë–º –Ω–∞ –ø–∞—É–∑–µ',
        sublabel: '–°–∫–æ—Ä–æ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è',
        actionLabel: '–ö—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è',
        showQueue: false,
      };
    }

    // v2: –ï—Å–ª–∏ is_accepting=true ‚Äî –º–µ—Å—Ç–∞ –µ—Å—Ç—å (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)
    // v1: –ü—Ä–æ–≤–µ—Ä—è–µ–º available_slots –µ—Å–ª–∏ –µ—Å—Ç—å
    if (is_accepting && (available_slots === undefined || available_slots > 0)) {
      const label = available_slots !== undefined
        ? `–°–≤–æ–±–æ–¥–Ω–æ ${available_slots} –∏–∑ ${total_slots}`
        : '–ü—Ä–∏—ë–º –æ—Ç–∫—Ä—ã—Ç';
      return {
        status: 'available',
        color: '#22c55e',
        emoji: 'üü¢',
        label: label,
        sublabel: '–ú–µ—Å—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!',
        actionLabel: '–ù–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª',
        showQueue: false,
      };
    }

    return {
      status: 'full',
      color: '#ef4444',
      emoji: 'üî¥',
      label: '–ú–µ—Å—Ç –Ω–µ—Ç',
      sublabel: queue_length > 0 ? `–í –æ—á–µ—Ä–µ–¥–∏: ${queue_length}` : '–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞',
      actionLabel: '–í—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å',
      showQueue: true,
      queueSize: queue_length,
    };
  }

  // ========================================
  // REACT –ö–û–ú–ü–û–ù–ï–ù–¢–´
  // ========================================

  /**
   * TrialCapacityWidget ‚Äî –≤–∏–¥–∂–µ—Ç –º–µ—Å—Ç –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ/–≤ app
   */
  function TrialCapacityWidget({
    onRequestTrial,
    onBuyNow,
    className = '',
    compact = false
  }) {
    if (!React) return null;

    const { useState, useEffect, useCallback } = React;

    const [capacity, setCapacity] = useState(getCachedCapacity());
    const [isLoading, setIsLoading] = useState(!capacity);

    const refresh = useCallback(async () => {
      setIsLoading(true);
      try {
        const data = await getCapacity(true);
        setCapacity(data);
      } finally {
        setIsLoading(false);
      }
    }, []);

    useEffect(() => {
      refresh();
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      const interval = setInterval(refresh, 30000);
      return () => clearInterval(interval);
    }, [refresh]);

    if (!capacity && isLoading) {
      return React.createElement('div', {
        className: `trial-capacity-widget loading ${className}`
      }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
    }

    const meta = getCapacityMeta(capacity || {});

    if (compact) {
      // –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
      return React.createElement('div', {
        className: `trial-capacity-widget compact ${className}`,
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          padding: '8px 12px',
          background: 'var(--bg-secondary, #f3f4f6)',
          borderRadius: '8px',
          fontSize: '14px'
        }
      },
        React.createElement('span', { style: { fontSize: '16px' } }, meta.emoji),
        React.createElement('span', { style: { fontWeight: 500 } }, meta.label),
        isLoading && React.createElement('span', {
          style: { opacity: 0.5, fontSize: '12px' }
        }, '...')
      );
    }

    // –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
    return React.createElement('div', {
      className: `trial-capacity-widget full ${className}`,
      style: {
        background: 'var(--bg-secondary, #f3f4f6)',
        borderRadius: '12px',
        padding: '16px',
        textAlign: 'center'
      }
    },
      // –°—Ç–∞—Ç—É—Å
      React.createElement('div', {
        style: {
          fontSize: '24px',
          marginBottom: '8px'
        }
      }, meta.emoji),

      React.createElement('div', {
        style: {
          fontWeight: 600,
          fontSize: '16px',
          color: meta.color,
          marginBottom: '4px'
        }
      }, meta.label),

      React.createElement('div', {
        style: {
          fontSize: '13px',
          color: 'var(--text-secondary, #6b7280)',
          marginBottom: '12px'
        }
      }, meta.sublabel),

      // –ö–Ω–æ–ø–∫–∏
      React.createElement('div', {
        style: {
          display: 'flex',
          gap: '8px',
          justifyContent: 'center'
        }
      },
        // –û—Å–Ω–æ–≤–Ω–∞—è CTA
        React.createElement('button', {
          onClick: onRequestTrial,
          disabled: isLoading,
          style: {
            padding: '10px 20px',
            borderRadius: '8px',
            border: 'none',
            background: meta.status === 'available'
              ? 'linear-gradient(135deg, #22c55e, #16a34a)'
              : 'linear-gradient(135deg, #3b82f6, #2563eb)',
            color: 'white',
            fontWeight: 600,
            cursor: 'pointer',
            fontSize: '14px'
          }
        }, meta.actionLabel),

        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
        onBuyNow && React.createElement('button', {
          onClick: onBuyNow,
          style: {
            padding: '10px 20px',
            borderRadius: '8px',
            border: '2px solid var(--border-color, #e5e7eb)',
            background: 'transparent',
            color: 'var(--text-primary, #1f2937)',
            fontWeight: 500,
            cursor: 'pointer',
            fontSize: '14px'
          }
        }, '–ö—É–ø–∏—Ç—å —Å—Ä–∞–∑—É')
      )
    );
  }

  /**
   * QueueStatusCard ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ –æ—á–µ—Ä–µ–¥–∏
   */
  function QueueStatusCard({
    onClaimOffer,
    onCancelQueue,
    onRequestAgain,
    onBuyNow,
    className = ''
  }) {
    if (!React) return null;

    const { useState, useEffect, useCallback } = React;

    const [queueStatus, setQueueStatus] = useState(getCachedStatus());
    const [isLoading, setIsLoading] = useState(!queueStatus);
    const [isActioning, setIsActioning] = useState(false);
    const [timeRemaining, setTimeRemaining] = useState('');

    const refresh = useCallback(async () => {
      setIsLoading(true);
      try {
        const data = await getQueueStatus(true);
        setQueueStatus(data);
      } finally {
        setIsLoading(false);
      }
    }, []);

    // –¢–∞–π–º–µ—Ä –¥–ª—è offer (–¥–µ–ø—Ä–µ–∫–µ–π—Ç–µ–¥, –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    useEffect(() => {
      setTimeRemaining('');
    }, [queueStatus?.status]);

    useEffect(() => {
      refresh();
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
      const interval = setInterval(refresh, 60000);
      return () => clearInterval(interval);
    }, [refresh]);

    const handleClaim = async () => {
      setIsActioning(true);
      try {
        const result = await claimOffer();
        if (result.success) {
          onClaimOffer?.(result);
          refresh();
        } else {
          alert(result.message || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
          refresh();
        }
      } finally {
        setIsActioning(false);
      }
    };

    const handleCancel = async () => {
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∏–∞–ª?')) return;

      setIsActioning(true);
      try {
        const result = await cancelQueue();
        if (result.success) {
          onCancelQueue?.(result);
          refresh();
        }
      } finally {
        setIsActioning(false);
      }
    };

    const handleRequestAgain = async () => {
      setIsActioning(true);
      try {
        const result = await requestTrial('app');
        if (result.success) {
          onRequestAgain?.(result);
          refresh();
        } else {
          alert(result.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
        }
      } finally {
        setIsActioning(false);
      }
    };

    if (!queueStatus && isLoading) {
      return React.createElement('div', {
        className: `queue-status-card loading ${className}`
      }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
    }

    const status = queueStatus?.status || QUEUE_STATUS.NOT_IN_QUEUE;
    const meta = getQueueStatusMeta(
      status,
      queueStatus?.position,
      queueStatus?.offer_expires_at
    );

    // –ï—Å–ª–∏ –Ω–µ –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    if (status === QUEUE_STATUS.NOT_IN_QUEUE) {
      return null;
    }

    return React.createElement('div', {
      className: `queue-status-card ${className}`,
      style: {
        background: 'var(--bg-secondary, #f3f4f6)',
        borderRadius: '12px',
        padding: '16px',
        border: status === QUEUE_STATUS.OFFER
          ? `2px solid ${meta.color}`
          : '1px solid var(--border-color, #e5e7eb)'
      }
    },
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          marginBottom: '12px'
        }
      },
        React.createElement('span', { style: { fontSize: '20px' } }, meta.emoji),
        React.createElement('span', {
          style: {
            fontWeight: 600,
            fontSize: '16px',
            color: meta.color
          }
        }, meta.label)
      ),

      // –¢–∞–π–º–µ—Ä (–¥–ª—è offer)
      meta.showTimer && timeRemaining && React.createElement('div', {
        style: {
          background: 'rgba(245, 158, 11, 0.1)',
          borderRadius: '8px',
          padding: '12px',
          textAlign: 'center',
          marginBottom: '12px'
        }
      },
        React.createElement('div', {
          style: { fontSize: '12px', color: '#92400e', marginBottom: '4px' }
        }, '–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏:'),
        React.createElement('div', {
          style: { fontSize: '24px', fontWeight: 700, color: '#f59e0b' }
        }, timeRemaining)
      ),

      // –î–µ–π—Å—Ç–≤–∏—è
      React.createElement('div', {
        style: { display: 'flex', gap: '8px', flexDirection: 'column' }
      },
        // –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞ (–¥–ª—è rejected/canceled)
        (status === QUEUE_STATUS.REJECTED || status === QUEUE_STATUS.EXPIRED || status === QUEUE_STATUS.CANCELED) &&
        React.createElement('button', {
          onClick: handleRequestAgain,
          disabled: isActioning,
          style: {
            padding: '12px',
            borderRadius: '8px',
            border: 'none',
            background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
            color: 'white',
            fontWeight: 600,
            cursor: 'pointer',
            fontSize: '15px'
          }
        }, isActioning ? '‚è≥...' : '–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞'),

        // –û—Ç–º–µ–Ω–∞ (–¥–ª—è pending)
        (status === QUEUE_STATUS.PENDING || status === QUEUE_STATUS.QUEUED) &&
        React.createElement('button', {
          onClick: handleCancel,
          disabled: isActioning,
          style: {
            padding: '10px',
            borderRadius: '8px',
            border: '1px solid var(--border-color, #e5e7eb)',
            background: 'transparent',
            color: 'var(--text-secondary, #6b7280)',
            cursor: 'pointer',
            fontSize: '13px'
          }
        }, '–û—Ç–º–µ–Ω–∏—Ç—å'),

        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Äî –∫—É–ø–∏—Ç—å
        onBuyNow && React.createElement('button', {
          onClick: onBuyNow,
          style: {
            padding: '10px',
            borderRadius: '8px',
            border: '2px solid var(--border-color, #e5e7eb)',
            background: 'transparent',
            color: 'var(--text-primary, #1f2937)',
            fontWeight: 500,
            cursor: 'pointer',
            fontSize: '14px',
            marginTop: '4px'
          }
        }, 'üí≥ –ö—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è')
      )
    );
  }

  // ========================================
  // REACT HOOK
  // ========================================

  /**
   * useTrialQueue() ‚Äî hook –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—å—é
   */
  function useTrialQueue() {
    if (!React) {
      console.warn('[TrialQueue] React –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
      return {
        capacity: null,
        queueStatus: null,
        isLoading: false,
        requestTrial: async () => ({ success: false }),
        claimOffer: async () => ({ success: false }),
        cancelQueue: async () => ({ success: false }),
        refreshCapacity: async () => { },
        refreshStatus: async () => { },
      };
    }

    const { useState, useCallback, useEffect } = React;

    const [capacity, setCapacity] = useState(getCachedCapacity());
    const [queueStatus, setQueueStatus] = useState(getCachedStatus());
    const [isLoading, setIsLoading] = useState(false);

    const refreshCapacity = useCallback(async () => {
      const data = await getCapacity(true);
      setCapacity(data);
      return data;
    }, []);

    const refreshStatus = useCallback(async () => {
      const data = await getQueueStatus(true);
      setQueueStatus(data);
      return data;
    }, []);

    const doRequestTrial = useCallback(async (source = 'app') => {
      setIsLoading(true);
      try {
        const result = await requestTrial(source);
        if (result.success) {
          setQueueStatus(result);
          await refreshCapacity();
        }
        return result;
      } finally {
        setIsLoading(false);
      }
    }, [refreshCapacity]);

    const doClaimOffer = useCallback(async () => {
      setIsLoading(true);
      try {
        const result = await claimOffer();
        if (result.success) {
          await refreshStatus();
          await refreshCapacity();
        }
        return result;
      } finally {
        setIsLoading(false);
      }
    }, [refreshStatus, refreshCapacity]);

    const doCancelQueue = useCallback(async () => {
      setIsLoading(true);
      try {
        const result = await cancelQueue();
        if (result.success) {
          await refreshStatus();
          await refreshCapacity();
        }
        return result;
      } finally {
        setIsLoading(false);
      }
    }, [refreshStatus, refreshCapacity]);

    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    useEffect(() => {
      refreshCapacity();
      refreshStatus();
    }, [refreshCapacity, refreshStatus]);

    return {
      capacity,
      queueStatus,
      isLoading,

      // –î–µ–π—Å—Ç–≤–∏—è
      requestTrial: doRequestTrial,
      claimOffer: doClaimOffer,  // @deprecated v5.0
      cancelQueue: doCancelQueue,

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      refreshCapacity,
      refreshStatus,

      // –•–µ–ª–ø–µ—Ä—ã
      isPending: queueStatus?.status === QUEUE_STATUS.PENDING ||
        queueStatus?.status === QUEUE_STATUS.QUEUED,
      isAssigned: queueStatus?.status === QUEUE_STATUS.ASSIGNED,
      position: queueStatus?.position,
      capacityMeta: capacity ? getCapacityMeta(capacity) : null,
      queueMeta: queueStatus ? getQueueStatusMeta(
        queueStatus.status,
        queueStatus.position,
        queueStatus.offer_expires_at
      ) : null,
    };
  }

  // ========================================
  // –°–¢–ò–õ–ò
  // ========================================

  const TRIAL_QUEUE_STYLES = `
    .trial-capacity-widget {
      transition: opacity 0.2s;
    }
    .trial-capacity-widget.loading {
      opacity: 0.7;
    }
    .trial-capacity-widget button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .queue-status-card {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .queue-status-card button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .queue-status-card button:active:not(:disabled) {
      transform: translateY(0);
    }
  `;

  // –ò–Ω–∂–µ–∫—Ç–∏–º —Å—Ç–∏–ª–∏
  if (typeof document !== 'undefined') {
    const styleId = 'heys-trial-queue-styles';
    if (!document.getElementById(styleId)) {
      const style = document.createElement('style');
      style.id = styleId;
      style.textContent = TRIAL_QUEUE_STYLES;
      document.head.appendChild(style);
    }
  }

  // ========================================
  // ADMIN API (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤)
  // ========================================

  const adminAPI = {
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–∏
     * @returns {Promise<{success, data: Array, total_count}>}
     */
    async getQueueList() {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      const curatorSession = localStorage.getItem('heys_curator_session');
      if (!curatorSession) {
        return { success: false, error: 'no_auth', message: '–ù–µ—Ç —Å–µ—Å—Å–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞' };
      }

      try {
        // p_curator_session_token removed ‚Äî JWT auth via Authorization header
        const res = await api.rpc('admin_get_trial_queue_list', {});

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ë—Ä—Ç–∫–æ–π {admin_get_trial_queue_list: {items, total, ...}}
        const fnData = res.data?.admin_get_trial_queue_list || res.data || res;
        const items = Array.isArray(fnData) ? fnData : (fnData.items || []);
        const total = fnData.total ?? items.length;

        return { success: true, data: items, total_count: total };
      } catch (e) {
        console.error('[TrialQueue.admin] getQueueList error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å
     * @param {string} clientId - UUID –∫–ª–∏–µ–Ω—Ç–∞
     * @param {string} source - –∏—Å—Ç–æ—á–Ω–∏–∫ ('admin', 'landing', etc)
     * @param {number} priority - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-10, 10 = –≤—ã—Å—à–∏–π)
     */
    async addToQueue(clientId, source = 'admin', priority = 5) {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      const curatorSession = localStorage.getItem('heys_curator_session');
      if (!curatorSession) {
        return { success: false, error: 'no_auth', message: '–ù–µ—Ç —Å–µ—Å—Å–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞' };
      }

      try {
        const res = await api.rpc('admin_add_to_queue', {
          p_client_id: clientId,
          p_source: source,
          p_priority: priority
          // p_curator_id injected by cloud function from JWT
        });

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const fnData = res.data?.admin_add_to_queue || res.data || res;
        return fnData;
      } catch (e) {
        console.error('[TrialQueue.admin] addToQueue error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
     * @param {string} clientId - UUID –∫–ª–∏–µ–Ω—Ç–∞
     * @param {string} reason - –ø—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è
     */
    async removeFromQueue(clientId, reason = 'admin_removed') {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      try {
        const res = await api.rpc('admin_remove_from_queue', {
          p_client_id: clientId,
          p_reason: reason
        });

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const fnData = res.data?.admin_remove_from_queue || res.data || res;
        return fnData;
      } catch (e) {
        console.error('[TrialQueue.admin] removeFromQueue error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * @deprecated v2.0 ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ offer'—ã —É–±—Ä–∞–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–π activateTrial()
     * –û—Ç–ø—Ä–∞–≤–∏—Ç—å offer –∫–ª–∏–µ–Ω—Ç—É (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å)
     */
    async sendOffer(clientId, windowMinutes = 120) {
      console.warn('[TrialQueue.admin] sendOffer() deprecated ‚Äî use activateTrial()');
      return { success: false, error: 'deprecated', message: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ activateTrial() –≤–º–µ—Å—Ç–æ sendOffer()' };
    },

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã —Å—Ç–∞—Ä—Ç–∞ (v4.0 JWT-only)
     * @param {string} clientId - UUID –∫–ª–∏–µ–Ω—Ç–∞
     * @param {string} [startDate] - –î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ (YYYY-MM-DD). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–µ–≥–æ–¥–Ω—è.
     * @returns {Promise<{success: boolean, status?: string, trial_ends_at?: string, error?: string}>}
     */
    async activateTrial(clientId, startDate) {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      // üîê v4.0: JWT —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ Authorization header (YandexAPI.rpc)
      // p_curator_session_token —É–¥–∞–ª—ë–Ω, p_curator_id –¥–æ–±–∞–≤–ª—è–µ—Ç cloud function
      const curatorSession = localStorage.getItem('heys_curator_session');
      if (!curatorSession) {
        return { success: false, error: 'no_auth', message: '–ù–µ—Ç —Å–µ—Å—Å–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞' };
      }

      try {
        const params = {
          p_client_id: clientId
        };
        if (startDate) {
          params.p_start_date = startDate;
        }
        // ‚ùå –£–±—Ä–∞–Ω–æ: p_curator_session_token (—Ç–µ–ø–µ—Ä—å JWT –≤ Authorization header)

        const res = await api.rpc('admin_activate_trial', params);

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const fnData = res.data?.admin_activate_trial || res.data || res;
        return fnData;
      } catch (e) {
        console.error('[TrialQueue.admin] activateTrial error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ç—Ä–∏–∞–ª
     * @param {string} clientId - UUID –∫–ª–∏–µ–Ω—Ç–∞
     * @param {string} reason - –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
     * @returns {Promise<{success: boolean, status?: string, error?: string}>}
     */
    async rejectApplication(clientId, reason = '') {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      const curatorSession = localStorage.getItem('heys_curator_session');
      if (!curatorSession) {
        return { success: false, error: 'no_auth', message: '–ù–µ—Ç —Å–µ—Å—Å–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞' };
      }

      try {
        const res = await api.rpc('admin_reject_request', {
          p_client_id: clientId,
          p_reason: reason
          // p_curator_id injected by cloud function from JWT
        });

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const fnData = res.data?.admin_reject_request || res.data || res;
        return fnData;
      } catch (e) {
        console.error('[TrialQueue.admin] rejectApplication error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—á–µ—Ä–µ–¥–∏
     */
    async getStats() {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      try {
        const res = await api.rpc('admin_get_queue_stats', {});

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        // API –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ –∫–ª—é—á —Å –∏–º–µ–Ω–µ–º —Ñ—É–Ω–∫—Ü–∏–∏: { admin_get_queue_stats: {...} }
        const fnData = res.data?.admin_get_queue_stats || res.data || res;
        return { success: true, ...fnData };
      } catch (e) {
        console.error('[TrialQueue.admin] getStats error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–µ—Ä–µ–¥–∏
     * @param {Object} settings - {is_accepting, max_concurrent_trials, offer_window_minutes}
     */
    async updateSettings(settings) {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      try {
        const res = await api.rpc('admin_update_queue_settings', {
          p_is_accepting: (settings.is_accepting_trials ?? settings.is_accepting) ?? null,
          p_max_active: (settings.max_active_trials ?? settings.max_concurrent_trials) ?? null,
          p_offer_window_minutes: settings.offer_window_minutes ?? null
        });

        // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {data: {admin_update_queue_settings: {success, settings}}, error: null}
        const result = res.data?.admin_update_queue_settings || res.admin_update_queue_settings || res;
        return result;
      } catch (e) {
        console.error('[TrialQueue.admin] updateSettings error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ª–∏–¥—ã —Å –ª–µ–Ω–¥–∏–Ω–≥–∞ (v3.0)
     * @param {string} [status='new'] - –§–∏–ª—å—Ç—Ä: 'new', 'converted', 'rejected', 'all'
     * @returns {Promise<{success: boolean, data?: Array, error?: string}>}
     */
    async getLeads(status = 'new') {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      try {
        const res = await api.rpc('admin_get_leads', { p_status: status });

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const data = res.data?.admin_get_leads || res.data || [];
        return { success: true, data: Array.isArray(data) ? data : [] };
      } catch (e) {
        console.error('[TrialQueue.admin] getLeads error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –°–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥ –≤ –∫–ª–∏–µ–Ω—Ç–∞ (v3.0)
     * –°–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç–∞, —Å—Ç–∞–≤–∏—Ç PIN, –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
     * @param {number} leadId - ID –ª–∏–¥–∞
     * @param {string} pin - PIN-–∫–æ–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (4-6 —Ü–∏—Ñ—Ä)
     * @param {string} [curatorId] - UUID –∫—É—Ä–∞—Ç–æ—Ä–∞
     * @returns {Promise<{success: boolean, client_id?: string, error?: string}>}
     */
    async convertLead(leadId, pin, curatorId) {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      try {
        const params = {
          p_lead_id: leadId,
          p_pin: pin
        };
        if (curatorId) {
          params.p_curator_id = curatorId;
        }

        const res = await api.rpc('admin_convert_lead', params);

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const fnData = res.data?.admin_convert_lead || res.data || res;
        return fnData;
      } catch (e) {
        console.error('[TrialQueue.admin] convertLead error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    },

    /**
     * –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ª–∏–¥–∞ (v3.0)
     * @param {string} leadId - UUID –ª–∏–¥–∞
     * @param {string} [reason] - –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
     * @returns {Promise<{success: boolean, error?: string}>}
     */
    async rejectLead(leadId, reason = 'rejected_by_curator') {
      const api = HEYS.YandexAPI;
      if (!api) {
        return { success: false, error: 'api_not_ready', message: 'API –Ω–µ –≥–æ—Ç–æ–≤' };
      }

      try {
        const res = await api.rpc('admin_update_lead_status', {
          p_lead_id: leadId,
          p_status: 'rejected',
          p_reason: reason
        });

        if (res.error) {
          return { success: false, error: res.error.code, message: res.error.message };
        }

        const fnData = res.data?.admin_update_lead_status || res.data || res;
        return fnData.success !== undefined ? fnData : { success: true };
      } catch (e) {
        console.error('[TrialQueue.admin] rejectLead error:', e);
        return { success: false, error: 'request_failed', message: e.message };
      }
    }
  };

  // ========================================
  // ADMIN UI –ö–û–ú–ü–û–ù–ï–ù–¢
  // ========================================

  /**
   * TrialQueueAdmin ‚Äî UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥—å—é
   * @param {Object} props - { onClose }
   */
  function TrialQueueAdmin({ onClose }) {
    const [queue, setQueue] = React.useState([]);
    const [stats, setStats] = React.useState(null);
    const [leads, setLeads] = React.useState([]);
    const [allClients, setAllClients] = React.useState([]); // –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –∫—É—Ä–∞—Ç–æ—Ä–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è trial –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏)
    const [loading, setLoading] = React.useState(true);
    const [error, setError] = React.useState(null);
    const [actionLoading, setActionLoading] = React.useState(null);
    const [activeTab, setActiveTab] = React.useState('new');
    // –î–∏–∞–ª–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–∏–∞–ª–∞ (v3.0: —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã)
    const [trialDialog, setTrialDialog] = React.useState(null); // { clientId, clientName }
    const [trialStartDate, setTrialStartDate] = React.useState('');
    // –î–∏–∞–ª–æ–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ª–∏–¥–∞ (v3.0)
    const [convertDialog, setConvertDialog] = React.useState(null); // { leadId, leadName, leadPhone }
    const [convertPin, setConvertPin] = React.useState('');

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    const loadData = React.useCallback(async (isSilent = false) => {
      if (!isSilent) setLoading(true);
      setError(null);

      try {
        const [queueRes, statsRes, leadsRes, clientsRes] = await Promise.all([
          adminAPI.getQueueList(),
          adminAPI.getStats(),
          adminAPI.getLeads('all'),
          HEYS.YandexAPI.getClients() // –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –∫—É—Ä–∞—Ç–æ—Ä–∞ (–¥–ª—è trial –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏)
        ]);

        if (queueRes.success) {
          // –ó–∞—â–∏—Ç–∞: data –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º
          const queueData = Array.isArray(queueRes.data) ? queueRes.data : [];
          setQueue(queueData);
        } else {
          setError(queueRes.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏');
        }

        if (statsRes.success) {
          setStats(statsRes);
        }

        if (leadsRes.success) {
          console.log('[TrialQueueAdmin] Loaded leads:', leadsRes.data);
          setLeads(leadsRes.data || []);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è trial –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏)
        if (!clientsRes.error && Array.isArray(clientsRes.data)) {
          setAllClients(clientsRes.data);
        }
      } catch (e) {
        setError(e.message);
      } finally {
        if (!isSilent) setLoading(false);
      }
    }, []);

    React.useEffect(() => {
      loadData(false);
    }, [loadData]);

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (v2.0: pending/rejected –≤–º–µ—Å—Ç–æ offer/queued)
    const grouped = React.useMemo(() => {
      const result = {
        assigned: [],   // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∏–∞–ª—ã
        pending: [],    // –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
        rejected: [],   // –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
        other: []       // –û—Å—Ç–∞–ª—å–Ω—ã–µ (canceled)
      };
      queue.forEach(item => {
        // –ú–∞–ø–ø–∏–Ω–≥ legacy —Å—Ç–∞—Ç—É—Å–æ–≤
        if (item.status === 'assigned') {
          result.assigned.push(item);
        } else if (item.status === 'pending' || item.status === 'queued' || item.status === 'offer') {
          result.pending.push(item);
        } else if (item.status === 'rejected' || item.status === 'expired') {
          result.rejected.push(item);
        } else {
          result.other.push(item);
        }
      });
      return result;
    }, [queue]);

    // –î–µ–π—Å—Ç–≤–∏—è
    const handleRemove = async (clientId, clientName) => {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${clientName}" –∏–∑ –æ—á–µ—Ä–µ–¥–∏?`)) return;

      setActionLoading(clientId);
      const res = await adminAPI.removeFromQueue(clientId, 'admin_removed');
      setActionLoading(null);

      if (res.success) {
        loadData(true);
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'));
      }
    };

    // –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–∏–∞–ª–∞ —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã (v3.0)
    const handleActivateTrial = async (clientId, clientName) => {
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      setTrialStartDate(today);
      setTrialDialog({ clientId, clientName });
    };

    // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é —Ç—Ä–∏–∞–ª–∞
    const confirmActivateTrial = async () => {
      if (!trialDialog) return;
      const { clientId, clientName } = trialDialog;

      setActionLoading(clientId);
      setTrialDialog(null);

      const res = await adminAPI.activateTrial(clientId, trialStartDate || undefined);
      setActionLoading(null);

      if (res.success) {
        loadData(true);
        setActiveTab('pending'); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ñ–¥—É—Ç —Ç—Ä–∏–∞–ª–∞"
        const isToday = !trialStartDate || trialStartDate === new Date().toISOString().split('T')[0];
        if (isToday) {
          alert('‚úÖ –¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π.');
        } else {
          alert(`‚úÖ –¢—Ä–∏–∞–ª –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω! –ù–∞—á–Ω—ë—Ç—Å—è ${trialStartDate}, –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π.`);
        }
      } else {
        const errorMessage = res?.message || res?.error?.message || res?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª';
        alert('–û—à–∏–±–∫–∞: ' + errorMessage);
        console.warn('[TrialQueue.admin] activateTrial failed', { response: res, message: errorMessage });
      }
    };

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥ –≤ –∫–ª–∏–µ–Ω—Ç–∞ (v3.0)
    const handleConvertLead = (lead) => {
      setConvertPin('');
      setConvertDialog({ leadId: lead.id, leadName: lead.name, leadPhone: lead.phone });
    };

    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ª–∏–¥–∞ (v3.0)
    const handleRejectLead = async (lead) => {
      const reason = prompt(`–û—Ç–∫–ª–æ–Ω–∏—Ç—å –ª–∏–¥–∞ "${lead.name}"?\n–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):`, '');
      if (reason === null) return; // –û—Ç–º–µ–Ω–∞

      setActionLoading('lead-reject-' + lead.id);
      const res = await adminAPI.rejectLead(lead.id, reason || 'rejected_by_curator');
      setActionLoading(null);

      if (res.success) {
        loadData(true);
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –ª–∏–¥–∞'));
      }
    };

    const confirmConvertLead = async () => {
      if (!convertDialog || !convertPin) return;

      if (convertPin.length < 4) {
        alert('PIN –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã');
        return;
      }

      setActionLoading('lead-' + convertDialog.leadId);
      setConvertDialog(null);

      const res = await adminAPI.convertLead(convertDialog.leadId, convertPin);
      setActionLoading(null);

      if (res.success) {
        loadData(true);
        setActiveTab('pending'); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ñ–¥—É—Ç —Ç—Ä–∏–∞–ª–∞", –∫—É–¥–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
        if (res.already_existed) {
          alert(`‚ÑπÔ∏è –ö–ª–∏–µ–Ω—Ç —Å —ç—Ç–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –õ–∏–¥ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π.`);
        } else {
          alert(`‚úÖ –ö–ª–∏–µ–Ω—Ç "${convertDialog.leadName}" —Å–æ–∑–¥–∞–Ω! PIN: ${convertPin}`);
        }
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞'));
      }
    };

    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É (v2.0)
    const handleReject = async (clientId, clientName) => {
      const reason = prompt(`–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É "${clientName}"?\n–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):`, '');
      if (reason === null) return; // –û—Ç–º–µ–Ω–∞

      setActionLoading(clientId);
      const res = await adminAPI.rejectApplication(clientId, reason || 'rejected_by_curator');
      setActionLoading(null);

      if (res.success) {
        loadData(true);
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É'));
      }
    };

    const [toggleLoading, setToggleLoading] = React.useState(false);

    const handleToggleAccepting = async () => {
      if (!stats || toggleLoading) return;

      setToggleLoading(true);
      const newValue = !stats.limits?.is_accepting_trials;
      const res = await adminAPI.updateSettings({ is_accepting_trials: newValue });
      setToggleLoading(false);

      if (res.success) {
        setStats(prev => ({
          ...prev,
          limits: { ...prev.limits, is_accepting_trials: newValue }
        }));
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'));
      }
    };

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    const formatDate = (dateStr) => {
      if (!dateStr) return '‚Äî';
      const d = new Date(dateStr);
      return d.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    // –í—Ä–µ–º—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è offer
    const getOfferTimeLeft = (expiresAt) => {
      if (!expiresAt) return null;
      const now = Date.now();
      const exp = new Date(expiresAt).getTime();
      const diff = exp - now;
      if (diff <= 0) return '–ò—Å—Ç—ë–∫';
      const mins = Math.floor(diff / 60000);
      if (mins < 60) return `${mins} –º–∏–Ω`;
      const hours = Math.floor(mins / 60);
      return `${hours}—á ${mins % 60}–º`;
    };

    // –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã
    const freeSlots = stats ? Math.max(0, (stats.limits?.max_active_trials || 3) - (grouped.assigned?.length || 0)) : 0;
    const isAccepting = stats?.limits?.is_accepting_trials ?? false;

    // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ª–∏–¥–æ–≤ (–≤–º–µ—Å—Ç–æ RPC ‚Äî –æ–±—Ö–æ–¥ –±–∞–≥–∞ —Å –ø—Ä–æ–ø–∞–¥–∞—é—â–∏–º–∏ –ª–∏–¥–∞–º–∏)
    const newLeads = leads.filter(l => l.status === 'new');
    const rejectedLeads = leads.filter(l => l.status === 'rejected');

    const getEffectiveSubscriptionStatus = (client) => {
      const statusRaw = client.subscription_status || 'none';
      const now = Date.now();
      const activeUntil = client.active_until ? new Date(client.active_until).getTime() : null;
      const trialEndsAt = client.trial_ends_at ? new Date(client.trial_ends_at).getTime() : null;
      const trialStartsAt = client.trial_started_at ? new Date(client.trial_started_at).getTime() : null;

      if (activeUntil && activeUntil > now) return 'active';
      if (trialStartsAt && trialStartsAt > now) return 'trial_pending';
      if (trialEndsAt && trialEndsAt > now) return 'trial';

      return statusRaw || 'none';
    };

    // –ö–ª–∏–µ–Ω—Ç—ã —Å –∞–∫—Ç–∏–≤–Ω—ã–º —Ç—Ä–∏–∞–ª–æ–º, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤ trial_queue (—Å—Ç–∞—Ä—ã–µ —Ç—Ä–∏–∞–ª—ã –¥–æ –≤–≤–µ–¥–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏)
    const queueClientIds = new Set(queue.map(q => q.client_id));
    const trialClients = allClients.filter(c =>
      (getEffectiveSubscriptionStatus(c) === 'trial' || getEffectiveSubscriptionStatus(c) === 'trial_pending') &&
      !queueClientIds.has(c.id)
    );

    const tabs = [
      { id: 'new', label: 'ÔøΩ –° –ª–µ–Ω–¥–∏–Ω–≥–∞', count: newLeads.length, hint: '–ó–∞—è–≤–∫–∏ —Å —Å–∞–π—Ç–∞ ‚Äî –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞' },
      { id: 'pending', label: '‚è≥ –ñ–¥—É—Ç —Ç—Ä–∏–∞–ª–∞', count: grouped.pending.length, hint: '–ö–ª–∏–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã ‚Äî –Ω—É–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª' },
      { id: 'active', label: 'üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ', count: grouped.assigned.length + trialClients.length, hint: '–¢—Ä–∏–∞–ª –∏–¥—ë—Ç (7 –¥–Ω–µ–π)' },
      { id: 'rejected', label: '‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ', count: rejectedLeads.length + grouped.rejected.length, hint: '–û—Ç–∫–∞–∑–∞–Ω–æ –≤ —Ç—Ä–∏–∞–ª–µ' }
    ];

    const LeadRow = ({ item }) => React.createElement('div', {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: 12,
        padding: '12px 14px',
        borderRadius: 12,
        background: '#fff',
        border: '1px solid var(--border, #e5e7eb)',
        transition: 'box-shadow 0.2s'
      },
      onMouseEnter: (e) => { e.currentTarget.style.boxShadow = '0 6px 16px -8px rgba(0,0,0,0.25)'; },
      onMouseLeave: (e) => { e.currentTarget.style.boxShadow = 'none'; }
    },
      React.createElement('div', {
        style: {
          width: 40,
          height: 40,
          borderRadius: '50%',
          background: item.messenger === 'telegram' ? '#0088cc'
            : item.messenger === 'whatsapp' ? '#25d366'
              : item.messenger === 'max' ? '#8b5cf6' : '#9ca3af',
          color: '#fff',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: 16,
          flexShrink: 0
        }
      }, item.messenger === 'telegram' ? 'üì±' : item.messenger === 'whatsapp' ? 'üí¨' : item.messenger === 'max' ? 'üü£' : 'üë§'),
      React.createElement('div', { style: { flex: 1, minWidth: 0, paddingRight: 8 } },
        React.createElement('div', {
          style: {
            fontWeight: 700,
            fontSize: 15,
            color: 'var(--text, #111827)',
            lineHeight: 1.2,
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            textOverflow: 'ellipsis'
          }
        }, item.name || '‚Äî'),
        React.createElement('div', {
          style: {
            fontSize: 13,
            color: '#6b7280',
            fontFamily: 'monospace',
            lineHeight: 1.3,
            marginTop: 2
          }
        }, item.phone || '‚Äî'),
        React.createElement('div', {
          style: {
            fontSize: 11,
            color: '#9ca3af',
            marginTop: 4,
            display: 'flex',
            alignItems: 'center',
            gap: 6,
            overflow: 'hidden'
          }
        },
          React.createElement('span', { style: { whiteSpace: 'nowrap' } }, formatDate(item.created_at)),
          item.utm_source && React.createElement('span', { style: { opacity: 0.5 } }, '|'),
          item.utm_source && React.createElement('span', {
            style: {
              overflow: 'hidden',
              textOverflow: 'ellipsis',
              whiteSpace: 'nowrap',
              maxWidth: 100
            }
          }, item.utm_source)
        )
      ),
      React.createElement('div', { style: { display: 'flex', gap: 6, flexShrink: 0 } },
        React.createElement('button', {
          onClick: () => handleConvertLead(item),
          disabled: actionLoading === 'lead-' + item.id || actionLoading === 'lead-reject-' + item.id,
          style: {
            padding: '8px 12px',
            borderRadius: 8,
            border: 'none',
            background: (actionLoading === 'lead-' + item.id || actionLoading === 'lead-reject-' + item.id)
              ? '#d1d5db'
              : 'linear-gradient(135deg, #6366f1, #8b5cf6)',
            color: '#fff',
            cursor: (actionLoading === 'lead-' + item.id || actionLoading === 'lead-reject-' + item.id) ? 'not-allowed' : 'pointer',
            fontSize: 13,
            fontWeight: 600,
            whiteSpace: 'nowrap'
          }
        }, actionLoading === 'lead-' + item.id ? '‚è≥' : '–°–æ–∑–¥–∞—Ç—å'),
        React.createElement('button', {
          onClick: () => handleRejectLead(item),
          disabled: actionLoading === 'lead-' + item.id || actionLoading === 'lead-reject-' + item.id,
          style: {
            padding: '8px 10px',
            borderRadius: 8,
            border: '1px solid #fecaca',
            background: '#fef2f2',
            color: '#dc2626',
            cursor: (actionLoading === 'lead-' + item.id || actionLoading === 'lead-reject-' + item.id) ? 'not-allowed' : 'pointer',
            fontSize: 13,
            fontWeight: 600
          }
        }, actionLoading === 'lead-reject-' + item.id ? '‚è≥' : '‚ùå')
      )
    );

    const ClientRow = ({ item, allowActions }) => {
      const statusColor = item.status === 'assigned'
        ? { bg: '#dcfce7', text: '#16a34a', label: '–ê–∫—Ç–∏–≤–µ–Ω' }
        : item.status === 'rejected' || item.status === 'expired'
          ? { bg: '#fee2e2', text: '#dc2626', label: '–û—Ç–∫–ª–æ–Ω—ë–Ω' }
          : { bg: '#fef9c3', text: '#ca8a04', label: '–û–∂–∏–¥–∞–µ—Ç' };

      return React.createElement('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: 12,
          padding: '14px 16px',
          borderRadius: 12,
          background: '#fff',
          border: '1px solid var(--border, #e5e7eb)',
          transition: 'box-shadow 0.2s'
        },
        onMouseEnter: (e) => { e.currentTarget.style.boxShadow = '0 6px 16px -8px rgba(0,0,0,0.25)'; },
        onMouseLeave: (e) => { e.currentTarget.style.boxShadow = 'none'; }
      },
        React.createElement('div', {
          style: {
            width: 42,
            height: 42,
            borderRadius: '50%',
            background: 'linear-gradient(135deg, #0ea5e9, #6366f1)',
            color: '#fff',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: 16,
            fontWeight: 700,
            flexShrink: 0
          }
        }, (item.client_name || item.name || '?')[0].toUpperCase()),
        React.createElement('div', { style: { flex: 1, minWidth: 0 } },
          React.createElement('div', {
            style: { fontWeight: 700, fontSize: 15, color: 'var(--text, #111827)' }
          }, item.client_name || item.name || '‚Äî'),
          React.createElement('div', {
            style: { fontSize: 13, color: '#6b7280', fontFamily: 'monospace' }
          }, item.client_phone || item.phone_normalized || '‚Äî'),
          React.createElement('div', {
            style: {
              display: 'inline-flex',
              alignItems: 'center',
              padding: '2px 8px',
              borderRadius: 6,
              background: statusColor.bg,
              color: statusColor.text,
              fontSize: 11,
              fontWeight: 700,
              marginTop: 4
            }
          }, statusColor.label)
        ),
        allowActions && React.createElement('div', { style: { display: 'flex', gap: 6 } },
          React.createElement('button', {
            onClick: () => handleActivateTrial(item.client_id, item.client_name || item.name),
            disabled: actionLoading === item.client_id,
            style: {
              padding: '8px 12px',
              borderRadius: 8,
              border: 'none',
              background: actionLoading === item.client_id
                ? '#d1d5db'
                : 'linear-gradient(135deg, #22c55e, #16a34a)',
              color: '#fff',
              cursor: actionLoading === item.client_id ? 'not-allowed' : 'pointer',
              fontSize: 12,
              fontWeight: 700
            }
          }, actionLoading === item.client_id ? '‚è≥' : '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'),
          React.createElement('button', {
            onClick: () => handleReject(item.client_id, item.client_name || item.name),
            disabled: actionLoading === item.client_id,
            style: {
              padding: '8px 10px',
              borderRadius: 8,
              border: '1px solid #fecaca',
              background: '#fef2f2',
              color: '#dc2626',
              cursor: actionLoading === item.client_id ? 'not-allowed' : 'pointer',
              fontSize: 12,
              fontWeight: 700
            }
          }, '‚ùå')
        )
      );
    };

    return React.createElement('div', {
      style: {
        height: '75vh',
        display: 'flex',
        flexDirection: 'column',
        background: '#f8fafc'
      }
    },
      React.createElement('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '12px 16px',
          background: '#fff',
          borderBottom: '1px solid #e5e7eb'
        }
      },
        React.createElement('div', {
          style: { display: 'flex', alignItems: 'center', gap: 10, fontSize: 13, color: '#6b7280' }
        },
          React.createElement('span', null, isAccepting ? 'üü¢ –û—á–µ—Ä–µ–¥—å –æ—Ç–∫—Ä—ã—Ç–∞' : 'üî¥ –û—á–µ—Ä–µ–¥—å –∑–∞–∫—Ä—ã—Ç–∞'),
          React.createElement('span', null, `–°–ª–æ—Ç–æ–≤: ${grouped.assigned.length}/${stats?.limits?.max_active_trials || 3}`)
        ),
        React.createElement('button', {
          onClick: handleToggleAccepting,
          disabled: toggleLoading || !stats,
          style: {
            padding: '6px 10px',
            borderRadius: 8,
            border: '1px solid #e5e7eb',
            background: '#fff',
            cursor: toggleLoading ? 'not-allowed' : 'pointer',
            fontSize: 12,
            fontWeight: 600
          }
        }, toggleLoading ? '‚è≥' : isAccepting ? '–ó–∞–∫—Ä—ã—Ç—å' : '–û—Ç–∫—Ä—ã—Ç—å')
      ),
      React.createElement('div', {
        style: {
          display: 'flex',
          gap: 6,
          padding: '10px 16px',
          background: '#fff',
          borderBottom: '1px solid #e5e7eb'
        }
      },
        tabs.map((tab) => React.createElement('button', {
          key: tab.id,
          onClick: () => setActiveTab(tab.id),
          title: tab.hint,
          style: {
            padding: '8px 12px',
            borderRadius: 8,
            border: 'none',
            background: activeTab === tab.id ? 'linear-gradient(135deg, #0ea5e9, #6366f1)' : 'transparent',
            color: activeTab === tab.id ? '#fff' : '#6b7280',
            cursor: 'pointer',
            fontSize: 12,
            fontWeight: 700
          }
        }, `${tab.label} (${tab.count})`))
      ),
      React.createElement('div', {
        style: {
          padding: '10px 16px',
          background: '#f0f9ff',
          borderBottom: '1px solid #bfdbfe',
          fontSize: 12,
          color: '#1e40af',
          lineHeight: 1.5
        }
      }, tabs.find(t => t.id === activeTab)?.hint || ''),
      React.createElement('div', {
        style: {
          flex: 1,
          overflowY: 'auto',
          padding: '16px',
          display: 'flex',
          flexDirection: 'column',
          gap: 10
        }
      },
        loading && React.createElement('div', {
          style: { textAlign: 'center', padding: '40px', color: '#9ca3af' }
        }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...'),
        !loading && error && React.createElement('div', {
          style: { padding: '12px 16px', background: '#fee2e2', color: '#b91c1c', borderRadius: 10, fontSize: 13 }
        }, '‚ùå ' + error),
        !loading && !error && activeTab === 'new' && (newLeads.length ? newLeads.map(item => React.createElement(LeadRow, { key: item.id, item })) : React.createElement('div', {
          style: { textAlign: 'center', padding: '40px', color: '#9ca3af', fontSize: 14 }
        }, 'üì≠ –ù–µ—Ç –∑–∞—è–≤–æ–∫ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞')),
        !loading && !error && activeTab === 'pending' && (grouped.pending.length ? grouped.pending.map(item => React.createElement(ClientRow, { key: item.client_id || item.queue_id, item, allowActions: true })) : React.createElement('div', {
          style: { textAlign: 'center', padding: '40px', color: '#9ca3af', fontSize: 14 }
        }, '‚è∏Ô∏è –ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ —Ç—Ä–∏–∞–ª')),
        !loading && !error && activeTab === 'active' && ((grouped.assigned.length + trialClients.length) ? [
          ...grouped.assigned.map(item => React.createElement(ClientRow, { key: item.client_id || item.queue_id, item })),
          ...trialClients.map(client => React.createElement(ClientRow, {
            key: 'trial-' + client.id, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
            item: {
              client_id: client.id,
              client_name: client.name || client.phone || '?', // –ò–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –µ—Å–ª–∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç
              client_phone: client.phone || '‚Äî',
              status: 'assigned', // –í–∏–∑—É–∞–ª—å–Ω–æ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
              created_at: client.created_at
            }
          }))
        ] : React.createElement('div', {
          style: { textAlign: 'center', padding: '40px', color: '#9ca3af', fontSize: 14 }
        }, 'üí§ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∏–∞–ª–æ–≤')),
        !loading && !error && activeTab === 'rejected' && (
          (rejectedLeads.length || grouped.rejected.length) ? [
            ...rejectedLeads.map(item => React.createElement(LeadRow, { key: 'lead-' + item.id, item })),
            ...grouped.rejected.map(item => React.createElement(ClientRow, { key: item.client_id || item.queue_id, item }))
          ] : React.createElement('div', {
            style: { textAlign: 'center', padding: '40px', color: '#9ca3af', fontSize: 14 }
          }, '‚úÖ –ù–µ—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫')
        )
      ),
      React.createElement('div', {
        style: {
          display: 'flex',
          justifyContent: 'flex-end',
          padding: '10px 16px',
          background: '#fff',
          borderTop: '1px solid #e5e7eb'
        }
      },
        React.createElement('button', {
          onClick: () => loadData(false),
          disabled: loading,
          style: {
            padding: '6px 12px',
            borderRadius: 8,
            border: '1px solid #e5e7eb',
            background: '#fff',
            cursor: loading ? 'not-allowed' : 'pointer',
            fontSize: 12,
            fontWeight: 600
          }
        }, loading ? '‚è≥' : 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å')
      ),

      // ========== –î–ò–ê–õ–û–ì: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–∏–∞–ª–∞ (v3.0 ‚Äî —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã) ==========
      trialDialog && React.createElement('div', {
        style: {
          position: 'fixed',
          top: 0, left: 0, right: 0, bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        },
        onClick: (e) => { if (e.target === e.currentTarget) setTrialDialog(null); }
      },
        React.createElement('div', {
          style: {
            background: 'var(--card, #fff)',
            borderRadius: '16px',
            padding: '24px',
            width: '340px',
            maxWidth: '90vw',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }
        },
          React.createElement('div', {
            style: { fontSize: '18px', fontWeight: 700, marginBottom: '16px', color: 'var(--text, #1f2937)' }
          }, 'üé´ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª'),
          React.createElement('div', {
            style: { fontSize: '14px', color: '#6b7280', marginBottom: '16px' }
          }, `–ö–ª–∏–µ–Ω—Ç: ${trialDialog.clientName}`),
          React.createElement('label', {
            style: { display: 'block', fontSize: '13px', fontWeight: 500, color: 'var(--text, #374151)', marginBottom: '6px' }
          }, '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç—Ä–∏–∞–ª–∞:'),
          React.createElement('input', {
            type: 'date',
            value: trialStartDate,
            onChange: (e) => setTrialStartDate(e.target.value),
            min: new Date().toISOString().split('T')[0],
            style: {
              width: '100%',
              padding: '10px 12px',
              borderRadius: '8px',
              border: '1px solid #d1d5db',
              fontSize: '14px',
              marginBottom: '8px',
              boxSizing: 'border-box'
            }
          }),
          React.createElement('div', {
            style: { fontSize: '12px', color: '#9ca3af', marginBottom: '20px' }
          }, trialStartDate === new Date().toISOString().split('T')[0]
            ? '‚ö° –¢—Ä–∏–∞–ª –Ω–∞—á–Ω—ë—Ç—Å—è —Å—Ä–∞–∑—É (7 –¥–Ω–µ–π)'
            : `üìÖ –¢—Ä–∏–∞–ª –Ω–∞—á–Ω—ë—Ç—Å—è ${trialStartDate}, –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π`
          ),
          React.createElement('div', {
            style: { display: 'flex', gap: '10px', justifyContent: 'flex-end' }
          },
            React.createElement('button', {
              onClick: () => setTrialDialog(null),
              style: {
                padding: '10px 20px',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                background: 'var(--card, #fff)',
                cursor: 'pointer',
                fontSize: '14px',
                color: 'var(--text, #374151)'
              }
            }, '–û—Ç–º–µ–Ω–∞'),
            React.createElement('button', {
              onClick: confirmActivateTrial,
              style: {
                padding: '10px 20px',
                borderRadius: '8px',
                border: 'none',
                background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                color: '#fff',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 600
              }
            }, '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å')
          )
        )
      ),

      // ========== –î–ò–ê–õ–û–ì: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ª–∏–¥–∞ (v3.0) ==========
      convertDialog && React.createElement('div', {
        style: {
          position: 'fixed',
          top: 0, left: 0, right: 0, bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        },
        onClick: (e) => { if (e.target === e.currentTarget) setConvertDialog(null); }
      },
        React.createElement('div', {
          style: {
            background: 'var(--card, #fff)',
            borderRadius: '16px',
            padding: '24px',
            width: '340px',
            maxWidth: '90vw',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }
        },
          React.createElement('div', {
            style: { fontSize: '18px', fontWeight: 700, marginBottom: '16px', color: 'var(--text, #1f2937)' }
          }, 'üë§ –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞'),
          React.createElement('div', {
            style: { fontSize: '14px', color: '#6b7280', marginBottom: '4px' }
          }, `–ò–º—è: ${convertDialog.leadName}`),
          React.createElement('div', {
            style: { fontSize: '14px', color: '#6b7280', marginBottom: '16px' }
          }, `–¢–µ–ª–µ—Ñ–æ–Ω: ${convertDialog.leadPhone}`),
          React.createElement('label', {
            style: { display: 'block', fontSize: '13px', fontWeight: 500, color: 'var(--text, #374151)', marginBottom: '6px' }
          }, 'PIN-–∫–æ–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:'),
          React.createElement('input', {
            type: 'text',
            inputMode: 'numeric',
            pattern: '[0-9]*',
            maxLength: 6,
            placeholder: '1234',
            value: convertPin,
            onChange: (e) => setConvertPin(e.target.value.replace(/\D/g, '')),
            style: {
              width: '100%',
              padding: '10px 12px',
              borderRadius: '8px',
              border: '1px solid #d1d5db',
              fontSize: '18px',
              textAlign: 'center',
              letterSpacing: '8px',
              marginBottom: '8px',
              boxSizing: 'border-box'
            }
          }),
          React.createElement('div', {
            style: { fontSize: '12px', color: '#9ca3af', marginBottom: '20px' }
          }, '–ú–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã. –°–æ–æ–±—â–∏—Ç–µ PIN –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è –≤—Ö–æ–¥–∞.'),
          React.createElement('div', {
            style: { display: 'flex', gap: '10px', justifyContent: 'flex-end' }
          },
            React.createElement('button', {
              onClick: () => setConvertDialog(null),
              style: {
                padding: '10px 20px',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                background: 'var(--card, #fff)',
                cursor: 'pointer',
                fontSize: '14px',
                color: 'var(--text, #374151)'
              }
            }, '–û—Ç–º–µ–Ω–∞'),
            React.createElement('button', {
              onClick: confirmConvertLead,
              disabled: convertPin.length < 4,
              style: {
                padding: '10px 20px',
                borderRadius: '8px',
                border: 'none',
                background: convertPin.length >= 4
                  ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)'
                  : '#d1d5db',
                color: '#fff',
                cursor: convertPin.length >= 4 ? 'pointer' : 'not-allowed',
                fontSize: '14px',
                fontWeight: 600
              }
            }, '‚úÖ –°–æ–∑–¥–∞—Ç—å')
          )
        )
      ),

      // ========== SETTINGS HINT ==========
      stats && React.createElement('div', {
        style: {
          marginTop: '24px',
          padding: '12px 16px',
          background: 'var(--bg-secondary, #f3f4f6)',
          borderRadius: '10px',
          fontSize: '12px',
          color: '#6b7280'
        }
      },
        React.createElement('strong', null, '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏: '),
        `–ú–∞–∫—Å. —Å–ª–æ—Ç–æ–≤: ${stats.limits?.max_active_trials || 3} | `,
        `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∏–∞–ª–∞: ${stats.limits?.trial_days || 7} –¥–Ω–µ–π`
      )
    );
  }

  // ========================================
  // –≠–ö–°–ü–û–†–¢
  // ========================================

  HEYS.TrialQueue = {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    STATUS: QUEUE_STATUS,

    // API
    getCapacity,
    requestTrial,
    getQueueStatus,
    claimOffer,
    cancelQueue,
    clearCache,

    // Admin API
    admin: adminAPI,

    // –•–µ–ª–ø–µ—Ä—ã
    formatTimeRemaining,
    isOfferExpired,
    getQueueStatusMeta,
    getCapacityMeta,

    // React
    useTrialQueue,
    TrialCapacityWidget,
    QueueStatusCard,
    TrialQueueAdmin, // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
  };

  // üîá v4.7.0: –õ–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∫–ª—é—á—ë–Ω

})(typeof window !== 'undefined' ? window : globalThis);


/* ===== heys_paywall_v1.js ===== */
// heys_paywall_v1.js ‚Äî Read-only gating + Paywall UI + Trial Queue integration
// v2.0.0 | 2025-12-25
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const ReactDOM = global.ReactDOM;
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };
  const devWarn = typeof DEV.warn === 'function' ? DEV.warn.bind(DEV) : function () { };
  const trackError = (error, context) => {
    if (!HEYS?.analytics?.trackError) return;
    try {
      const err = error instanceof Error ? error : new Error(String(error || 'Paywall error'));
      HEYS.analytics.trackError(err, context);
    } catch (_) { }
  };

  // ========================================
  // –ö–û–ù–°–¢–ê–ù–¢–´
  // ========================================

  const PAYWALL_CONFIG = {
    // –¶–µ–Ω—ã (–≤ —Ä—É–±–ª—è—Ö)
    prices: {
      base: 1990,
      pro: 12990,
      proPlus: 19990
    },
    // –¢—Ä–∏–∞–ª
    trialDays: 7,
    // –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã (–ø–æ–∫–∞ –±–µ–∑ –ÆKassa)
    contactTelegram: '@heyslab_support',
    contactEmail: 'pay@heyslab.ru'
  };

  // ========================================
  // –°–¢–ò–õ–ò
  // ========================================

  const PAYWALL_STYLES = `
    .paywall-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      animation: paywallFadeIn 0.2s ease-out;
    }
    
    @keyframes paywallFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .paywall-modal {
      background: var(--bg-primary, #fff);
      border-radius: 20px;
      max-width: 400px;
      width: 100%;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: paywallSlideUp 0.3s ease-out;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
    }
    
    @keyframes paywallSlideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .paywall-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .paywall-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    .paywall-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary, #1f2937);
      margin: 0 0 8px 0;
    }
    
    .paywall-subtitle {
      font-size: 14px;
      color: var(--text-secondary, #6b7280);
      margin: 0;
      line-height: 1.5;
    }
    
    .paywall-features {
      background: var(--bg-secondary, #f3f4f6);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .paywall-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      font-size: 14px;
      color: var(--text-primary, #1f2937);
    }
    
    .paywall-feature-icon {
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .paywall-plans {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .paywall-plan {
      border: 2px solid var(--border-color, #e5e7eb);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .paywall-plan:hover {
      border-color: var(--accent-color, #3b82f6);
      background: var(--bg-hover, #f9fafb);
    }
    
    .paywall-plan.selected {
      border-color: var(--accent-color, #3b82f6);
      background: rgba(59, 130, 246, 0.05);
    }
    
    .paywall-plan.popular {
      border-color: var(--success-color, #10b981);
    }
    
    .paywall-plan-badge {
      position: absolute;
      top: -10px;
      right: 12px;
      background: var(--success-color, #10b981);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
    }
    
    .paywall-plan-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary, #1f2937);
      margin-bottom: 4px;
    }
    
    .paywall-plan-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-color, #3b82f6);
    }
    
    .paywall-plan-period {
      font-size: 13px;
      color: var(--text-secondary, #6b7280);
      font-weight: 400;
    }
    
    .paywall-plan-desc {
      font-size: 13px;
      color: var(--text-secondary, #6b7280);
      margin-top: 6px;
    }
    
    .paywall-cta {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .paywall-cta:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .paywall-cta:active {
      transform: translateY(0);
    }
    
    .paywall-footer {
      text-align: center;
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-tertiary, #9ca3af);
    }
    
    .paywall-footer a {
      color: var(--accent-color, #3b82f6);
      text-decoration: none;
    }
    
    .paywall-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-secondary, #f3f4f6);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary, #6b7280);
      transition: background 0.2s;
    }
    
    .paywall-close:hover {
      background: var(--bg-tertiary, #e5e7eb);
    }
    
    /* Read-only banner */
    .readonly-banner {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-radius: 12px;
      padding: 12px 16px;
      margin: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .readonly-banner:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .readonly-banner-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .readonly-banner-content {
      flex: 1;
    }
    
    .readonly-banner-title {
      font-weight: 600;
      font-size: 14px;
      color: #92400e;
      margin-bottom: 2px;
    }
    
    .readonly-banner-text {
      font-size: 12px;
      color: #a16207;
    }
    
    .readonly-banner-arrow {
      font-size: 18px;
      color: #a16207;
    }
    
    /* Toast notification for blocked action */
    .readonly-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 10000;
      animation: toastSlideUp 0.3s ease-out;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      max-width: 320px;
    }
    
    @keyframes toastSlideUp {
      from { transform: translate(-50%, 20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    .readonly-toast-action {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
      white-space: nowrap;
    }
  `;

  // Inject styles
  function injectStyles() {
    if (document.getElementById('heys-paywall-styles')) return;
    const style = document.createElement('style');
    style.id = 'heys-paywall-styles';
    style.textContent = PAYWALL_STYLES;
    document.head.appendChild(style);
  }

  // ========================================
  // REACT –ö–û–ú–ü–û–ù–ï–ù–¢–´
  // ========================================

  /**
   * Paywall Modal ‚Äî –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏
   */
  function PaywallModal({ onClose, onSelectPlan, reason }) {
    const [selectedPlan, setSelectedPlan] = React.useState('pro');

    const plans = [
      {
        id: 'base',
        name: 'Base',
        price: PAYWALL_CONFIG.prices.base,
        desc: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + –ø–æ–¥—Å–∫–∞–∑–∫–∏ + 1 —á–µ–∫-–∏–Ω/–Ω–µ–¥–µ–ª—é',
        popular: false
      },
      {
        id: 'pro',
        name: 'Pro',
        price: PAYWALL_CONFIG.prices.pro,
        desc: '–ö—É—Ä–∞—Ç–æ—Ä –≤–µ–¥—ë—Ç –¥–Ω–µ–≤–Ω–∏–∫ + —á–∞—Ç + —Å–æ–∑–≤–æ–Ω/–Ω–µ–¥–µ–ª—é',
        popular: true
      },
      {
        id: 'proPlus',
        name: 'Pro+',
        price: PAYWALL_CONFIG.prices.proPlus,
        desc: '–ü–æ–ª–Ω—ã–π —Ä–µ–∂–∏–º 7/7 + –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π SLA',
        popular: false
      }
    ];

    const handleCTA = () => {
      // –ü–æ–∫–∞ –±–µ–∑ –ÆKassa ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º Telegram –¥–ª—è —Å–≤—è–∑–∏
      const message = encodeURIComponent(`–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É ${selectedPlan.toUpperCase()} –Ω–∞ HEYS`);
      window.open(`https://t.me/heyslab_support?text=${message}`, '_blank');
      if (onSelectPlan) onSelectPlan(selectedPlan);
    };

    return React.createElement('div', { className: 'paywall-overlay', onClick: (e) => e.target === e.currentTarget && onClose?.() },
      React.createElement('div', { className: 'paywall-modal', style: { position: 'relative' } },
        // Close button
        React.createElement('button', { className: 'paywall-close', onClick: onClose }, '‚úï'),

        // Header
        React.createElement('div', { className: 'paywall-header' },
          React.createElement('div', { className: 'paywall-icon' }, 'üîí'),
          React.createElement('h2', { className: 'paywall-title' },
            reason === 'trial_ended' ? '–¢—Ä–∏–∞–ª –∑–∞–∫–æ–Ω—á–∏–ª—Å—è' : '–ù—É–∂–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞'
          ),
          React.createElement('p', { className: 'paywall-subtitle' },
            reason === 'trial_ended'
              ? '–¢–≤–æ–∏ 7 –¥–Ω–µ–π Pro-–¥–æ—Å—Ç—É–ø–∞ –∏—Å—Ç–µ–∫–ª–∏. –û—Ñ–æ—Ä–º–∏ –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫.'
              : '–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.'
          )
        ),

        // Features
        React.createElement('div', { className: 'paywall-features' },
          React.createElement('div', { className: 'paywall-feature' },
            React.createElement('span', { className: 'paywall-feature-icon' }, 'üìä'),
            '–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π'
          ),
          React.createElement('div', { className: 'paywall-feature' },
            React.createElement('span', { className: 'paywall-feature-icon' }, 'üß†'),
            '182 —É–º–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö'
          ),
          React.createElement('div', { className: 'paywall-feature' },
            React.createElement('span', { className: 'paywall-feature-icon' }, 'üë®‚Äç‚öïÔ∏è'),
            '–ñ–∏–≤–æ–π –∫—É—Ä–∞—Ç–æ—Ä –¥–ª—è Pro —Ç–∞—Ä–∏—Ñ–æ–≤'
          )
        ),

        // Plans
        React.createElement('div', { className: 'paywall-plans' },
          plans.map(plan =>
            React.createElement('div', {
              key: plan.id,
              className: `paywall-plan ${selectedPlan === plan.id ? 'selected' : ''} ${plan.popular ? 'popular' : ''}`,
              onClick: () => setSelectedPlan(plan.id)
            },
              plan.popular && React.createElement('div', { className: 'paywall-plan-badge' }, '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π'),
              React.createElement('div', { className: 'paywall-plan-name' }, plan.name),
              React.createElement('div', { className: 'paywall-plan-price' },
                plan.price.toLocaleString('ru-RU'), ' ‚ÇΩ',
                React.createElement('span', { className: 'paywall-plan-period' }, ' / –º–µ—Å')
              ),
              React.createElement('div', { className: 'paywall-plan-desc' }, plan.desc)
            )
          )
        ),

        // CTA
        React.createElement('button', { className: 'paywall-cta', onClick: handleCTA },
          '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
        ),

        // === TRIAL QUEUE SECTION ===
        // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        React.createElement('div', {
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            margin: '20px 0 16px',
            color: 'var(--text-tertiary, #9ca3af)',
            fontSize: '13px'
          }
        },
          React.createElement('div', { style: { flex: 1, height: '1px', background: 'var(--border-color, #e5e7eb)' } }),
          '–∏–ª–∏',
          React.createElement('div', { style: { flex: 1, height: '1px', background: 'var(--border-color, #e5e7eb)' } })
        ),

        // Trial Queue –≤–∏–¥–∂–µ—Ç (–µ—Å–ª–∏ –º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω)
        HEYS.TrialQueue && React.createElement(TrialQueueSection, { onTrialStarted: onClose }),

        // Footer
        React.createElement('div', { className: 'paywall-footer' },
          '–í–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã? ',
          React.createElement('a', { href: 'https://t.me/heyslab_support', target: '_blank' }, '–ù–∞–ø–∏—à–∏ –Ω–∞–º')
        )
      )
    );
  }

  /**
   * TrialQueueSection ‚Äî —Å–µ–∫—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏ –≤–Ω—É—Ç—Ä–∏ Paywall
   */
  function TrialQueueSection({ onTrialStarted }) {
    const [capacity, setCapacity] = React.useState(null);
    const [queueStatus, setQueueStatus] = React.useState(null);
    const [isLoading, setIsLoading] = React.useState(true);
    const [isActioning, setIsActioning] = React.useState(false);
    const [timeRemaining, setTimeRemaining] = React.useState('');

    const refresh = React.useCallback(async () => {
      if (!HEYS.TrialQueue) return;

      setIsLoading(true);
      try {
        const [cap, status] = await Promise.all([
          HEYS.TrialQueue.getCapacity(true),
          HEYS.TrialQueue.getQueueStatus(true)
        ]);
        setCapacity(cap);
        setQueueStatus(status);
      } finally {
        setIsLoading(false);
      }
    }, []);

    // –¢–∞–π–º–µ—Ä –¥–ª—è offer
    React.useEffect(() => {
      if (queueStatus?.status !== 'offer' || !queueStatus?.offer_expires_at) {
        setTimeRemaining('');
        return;
      }

      const updateTimer = () => {
        setTimeRemaining(HEYS.TrialQueue.formatTimeRemaining(queueStatus.offer_expires_at));
      };

      updateTimer();
      const interval = setInterval(updateTimer, 1000);
      return () => clearInterval(interval);
    }, [queueStatus?.status, queueStatus?.offer_expires_at]);

    React.useEffect(() => {
      refresh();
      const interval = setInterval(refresh, 30000);
      return () => clearInterval(interval);
    }, [refresh]);

    const handleRequestTrial = async () => {
      setIsActioning(true);
      try {
        const result = await HEYS.TrialQueue.requestTrial('paywall');
        if (result.success || result.status) {
          await refresh();
        } else {
          alert(result.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
        }
      } finally {
        setIsActioning(false);
      }
    };

    const handleClaimOffer = async () => {
      setIsActioning(true);
      try {
        const result = await HEYS.TrialQueue.claimOffer();
        if (result.success) {
          // –¢—Ä–∏–∞–ª —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª!
          if (HEYS.Subscription?.clearCache) HEYS.Subscription.clearCache();
          window.dispatchEvent(new Event('heys:subscription-changed'));
          onTrialStarted?.();
        } else {
          alert(result.message || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
          await refresh();
        }
      } finally {
        setIsActioning(false);
      }
    };

    const handleCancelQueue = async () => {
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∏–∞–ª?')) return;
      setIsActioning(true);
      try {
        await HEYS.TrialQueue.cancelQueue();
        await refresh();
      } finally {
        setIsActioning(false);
      }
    };

    if (isLoading && !capacity) {
      return React.createElement('div', {
        style: { textAlign: 'center', padding: '16px', color: 'var(--text-secondary)' }
      }, '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—Ç–∞...');
    }

    const status = queueStatus?.status || 'not_in_queue';
    const isOffer = status === 'offer' && !HEYS.TrialQueue.isOfferExpired(queueStatus?.offer_expires_at);
    const isQueued = status === 'queued';

    // –í –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –µ—Å—Ç—å offer
    if (isQueued || isOffer) {
      const meta = HEYS.TrialQueue.getQueueStatusMeta(status, queueStatus?.position, queueStatus?.offer_expires_at);

      return React.createElement('div', {
        style: {
          background: isOffer ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : 'var(--bg-secondary, #f3f4f6)',
          borderRadius: '12px',
          padding: '16px',
          textAlign: 'center',
          border: isOffer ? '2px solid #f59e0b' : 'none'
        }
      },
        React.createElement('div', { style: { fontSize: '24px', marginBottom: '8px' } }, meta.emoji),
        React.createElement('div', { style: { fontWeight: 600, fontSize: '15px', marginBottom: '4px' } }, meta.label),

        // –¢–∞–π–º–µ—Ä
        isOffer && timeRemaining && React.createElement('div', {
          style: {
            fontSize: '20px',
            fontWeight: 700,
            color: '#f59e0b',
            margin: '12px 0',
            background: 'rgba(255,255,255,0.5)',
            borderRadius: '8px',
            padding: '8px'
          }
        }, '‚è∞ ', timeRemaining),

        // –ö–Ω–æ–ø–∫–∏
        React.createElement('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center', marginTop: '12px' } },
          isOffer && React.createElement('button', {
            onClick: handleClaimOffer,
            disabled: isActioning,
            style: {
              padding: '10px 20px',
              borderRadius: '8px',
              border: 'none',
              background: 'linear-gradient(135deg, #22c55e, #16a34a)',
              color: 'white',
              fontWeight: 600,
              cursor: 'pointer',
              fontSize: '14px'
            }
          }, isActioning ? '‚è≥...' : 'üéâ –ù–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª!'),

          isQueued && React.createElement('button', {
            onClick: handleCancelQueue,
            disabled: isActioning,
            style: {
              padding: '8px 16px',
              borderRadius: '8px',
              border: '1px solid var(--border-color, #e5e7eb)',
              background: 'transparent',
              color: 'var(--text-secondary)',
              cursor: 'pointer',
              fontSize: '13px'
            }
          }, '–û—Ç–º–µ–Ω–∏—Ç—å')
        )
      );
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –º–µ—Å—Ç
    const capMeta = capacity ? HEYS.TrialQueue.getCapacityMeta(capacity) : null;

    return React.createElement('div', {
      style: {
        background: 'var(--bg-secondary, #f3f4f6)',
        borderRadius: '12px',
        padding: '16px',
        textAlign: 'center'
      }
    },
      React.createElement('div', { style: { fontSize: '15px', fontWeight: 600, marginBottom: '8px' } },
        'üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç—Ä–∏–∞–ª 7 –¥–Ω–µ–π'
      ),

      capMeta && React.createElement('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '6px',
          fontSize: '13px',
          color: capMeta.color,
          marginBottom: '12px'
        }
      },
        React.createElement('span', null, capMeta.emoji),
        React.createElement('span', null, capMeta.label)
      ),

      capMeta?.showQueue && React.createElement('div', {
        style: { fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }
      }, capMeta.sublabel),

      React.createElement('button', {
        onClick: handleRequestTrial,
        disabled: isActioning || !capacity?.is_accepting,
        style: {
          padding: '10px 24px',
          borderRadius: '8px',
          border: 'none',
          background: capacity?.available_slots > 0
            ? 'linear-gradient(135deg, #22c55e, #16a34a)'
            : 'linear-gradient(135deg, #6b7280, #4b5563)',
          color: 'white',
          fontWeight: 600,
          cursor: 'pointer',
          fontSize: '14px'
        }
      }, isActioning ? '‚è≥...' : (capMeta?.actionLabel || '–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç—Ä–∏–∞–ª'))
    );
  }

  /**
   * Read-only Banner ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ UI
   */
  function ReadOnlyBanner({ onClick, compact = false }) {
    if (compact) {
      return React.createElement('div', {
        className: 'readonly-banner',
        onClick,
        style: { margin: '8px', padding: '10px 12px' }
      },
        React.createElement('span', { className: 'readonly-banner-icon' }, 'üîí'),
        React.createElement('div', { className: 'readonly-banner-content' },
          React.createElement('div', { className: 'readonly-banner-title' }, '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'),
          React.createElement('div', { className: 'readonly-banner-text' }, '–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å')
        ),
        React.createElement('span', { className: 'readonly-banner-arrow' }, '‚Üí')
      );
    }

    return React.createElement('div', { className: 'readonly-banner', onClick },
      React.createElement('span', { className: 'readonly-banner-icon' }, '‚è∞'),
      React.createElement('div', { className: 'readonly-banner-content' },
        React.createElement('div', { className: 'readonly-banner-title' }, '–¢—Ä–∏–∞–ª –∑–∞–∫–æ–Ω—á–∏–ª—Å—è'),
        React.createElement('div', { className: 'readonly-banner-text' },
          '–î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ù–∞–∂–º–∏ —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.'
        )
      ),
      React.createElement('span', { className: 'readonly-banner-arrow' }, '‚Üí')
    );
  }

  // ========================================
  // GATING LOGIC
  // ========================================

  let _paywallContainer = null;
  let _paywallRootInstance = null;

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å paywall –º–æ–¥–∞–ª–∫—É
   */
  function showPaywall(reason = 'subscription_required') {
    injectStyles();

    if (!_paywallContainer) {
      _paywallContainer = document.createElement('div');
      _paywallContainer.id = 'heys-paywall-container';
      document.body.appendChild(_paywallContainer);
    }

    const handleClose = () => {
      if (_paywallRootInstance) {
        _paywallRootInstance.unmount();
        _paywallRootInstance = null;
      }
    };

    if (!_paywallRootInstance) {
      _paywallRootInstance = ReactDOM.createRoot(_paywallContainer);
    }

    _paywallRootInstance.render(
      React.createElement(PaywallModal, {
        onClose: handleClose,
        reason
      })
    );
  }

  /**
   * –°–∫—Ä—ã—Ç—å paywall
   */
  function hidePaywall() {
    if (_paywallRootInstance) {
      _paywallRootInstance.unmount();
      _paywallRootInstance = null;
    }
  }

  let _toastTimeout = null;

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å toast –æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
   */
  function showBlockedToast(message = '–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞') {
    injectStyles();

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π toast
    const existing = document.querySelector('.readonly-toast');
    if (existing) existing.remove();
    if (_toastTimeout) clearTimeout(_toastTimeout);

    const toast = document.createElement('div');
    toast.className = 'readonly-toast';
    toast.innerHTML = `
      <span>üîí</span>
      <span>${message}</span>
      <button class="readonly-toast-action" onclick="HEYS.Paywall.show('trial_ended')">–ü–æ–¥–ø–∏—Å–∫–∞</button>
    `;
    document.body.appendChild(toast);

    _toastTimeout = setTimeout(() => {
      toast.remove();
    }, 4000);
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ –ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?
   * @returns {boolean} true –µ—Å–ª–∏ –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å
   */
  async function canWrite() {
    if (!HEYS.Subscription) {
      devWarn('[Paywall] Subscription module not loaded');
      return true; // Fallback: —Ä–∞–∑—Ä–µ—à–∞–µ–º –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    }

    try {
      const status = await HEYS.Subscription.getStatus();
      // –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –µ—Å–ª–∏: trial, active, –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
      if (!status || !status.status) return true; // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      return status.status === HEYS.Subscription.STATUS.TRIAL ||
        status.status === HEYS.Subscription.STATUS.ACTIVE ||
        status.status === HEYS.Subscription.STATUS.TRIAL_PENDING;
    } catch (err) {
      devWarn('[Paywall] Error checking status:', err);
      trackError(err, { scope: 'Paywall', action: 'checkStatus' });
      return true; // Fallback: —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
    }
  }

  /**
   * –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è canWrite (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à)
   * @returns {boolean}
   */
  function canWriteSync() {
    if (!HEYS.Subscription) return true;

    const cached = HEYS.Subscription.getCachedStatus?.();
    if (!cached || !cached.status) return true;

    return cached.status === HEYS.Subscription.STATUS.TRIAL ||
      cached.status === HEYS.Subscription.STATUS.ACTIVE ||
      cached.status === HEYS.Subscription.STATUS.TRIAL_PENDING;
  }

  /**
   * Gate wrapper –¥–ª—è write actions
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç toast –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –µ—Å–ª–∏ read-only
   * @param {Function} action - –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   * @param {string} actionName - –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ª–æ–≥–∞
   * @returns {Function} wrapped action
   */
  function gateWrite(action, actionName = 'action') {
    return async function (...args) {
      if (!canWriteSync()) {
        devLog(`[Paywall] Blocked ${actionName}: read-only mode`);
        showBlockedToast(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ`);
        return null;
      }
      return action.apply(this, args);
    };
  }

  /**
   * React Hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ write access
   * @returns {{ canWrite: boolean, isLoading: boolean, showPaywall: Function }}
   */
  function useWriteAccess() {
    const [canWriteState, setCanWrite] = React.useState(true);
    const [isLoading, setIsLoading] = React.useState(true);

    React.useEffect(() => {
      let mounted = true;

      canWrite().then(result => {
        if (mounted) {
          setCanWrite(result);
          setIsLoading(false);
        }
      });

      // Subscribe to subscription changes
      const handleChange = () => {
        canWrite().then(result => {
          if (mounted) setCanWrite(result);
        });
      };

      window.addEventListener('heys:subscription-changed', handleChange);
      return () => {
        mounted = false;
        window.removeEventListener('heys:subscription-changed', handleChange);
      };
    }, []);

    return {
      canWrite: canWriteState,
      isLoading,
      showPaywall: () => showPaywall('trial_ended')
    };
  }

  // ========================================
  // –≠–ö–°–ü–û–†–¢
  // ========================================

  HEYS.Paywall = {
    // UI
    show: showPaywall,
    hide: hidePaywall,
    showBlockedToast,

    // Components
    PaywallModal,
    ReadOnlyBanner,

    // Gating
    canWrite,
    canWriteSync,
    gateWrite,
    useWriteAccess,

    // Config
    CONFIG: PAYWALL_CONFIG,

    // Utils
    injectStyles
  };

  // Inject styles on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectStyles);
  } else {
    injectStyles();
  }

  devLog('[HEYS] Paywall module loaded v2.0.0 (Trial Queue integration)');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_login_screen_v1.js ===== */
// heys_login_screen_v1.js ‚Äî –ï–¥–∏–Ω—ã–π —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ (–∫–ª–∏–µ–Ω—Ç: —Ç–µ–ª–µ—Ñ–æ–Ω+PIN, –∫—É—Ä–∞—Ç–æ—Ä: email+–ø–∞—Ä–æ–ª—å)
(function (global) {
  const HEYS = (global.HEYS = global.HEYS || {});

  function clamp(v, a, b) {
    return Math.max(a, Math.min(b, v));
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç 10 —Ü–∏—Ñ—Ä –≤ (XXX) XXX-XX-XX
  function formatPhoneBody(digits) {
    const d = (digits || '').slice(0, 10);
    if (!d) return '';

    let result = '';
    if (d.length > 0) result += '(' + d.slice(0, 3);
    if (d.length >= 3) result += ') ';
    if (d.length > 3) result += d.slice(3, 6);
    if (d.length >= 6) result += '-';
    if (d.length > 6) result += d.slice(6, 8);
    if (d.length >= 8) result += '-';
    if (d.length > 8) result += d.slice(8, 10);

    return result;
  }

  // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  function maskPhone(raw) {
    const digits = String(raw || '').replace(/\D/g, '');
    let d = digits;
    if (d.length === 11 && d[0] === '8') d = '7' + d.slice(1);
    if (d.length === 10) d = '7' + d;
    d = d.slice(0, 11);
    return '+7' + d.slice(1);
  }

  function unmaskPhone(masked) {
    return String(masked || '').replace(/\D/g, '');
  }

  function LoginScreen(props) {
    const {
      onClientLogin,
      onCuratorLogin,
      initialMode = 'client',
    } = props || {};

    const React = global.React;
    const { useMemo, useState, useRef } = React;

    const [mode, setMode] = useState(initialMode);

    // client
    const [phoneMasked, setPhoneMasked] = useState('');
    const [pinDigits, setPinDigits] = useState(['', '', '', '']);
    const [pinOverlay, setPinOverlay] = useState([
      { d: '', k: 0 },
      { d: '', k: 0 },
      { d: '', k: 0 },
      { d: '', k: 0 },
    ]);
    const pinRefs = useRef([]);
    const pinHideTimers = useRef([null, null, null, null]);

    // curator
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const [busy, setBusy] = useState(false);
    const [err, setErr] = useState('');
    const [clientDiag, setClientDiag] = useState(null);

    const auth = HEYS.auth;

    // phoneMasked —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ 10 —Ü–∏—Ñ—Ä (–±–µ–∑ 7)
    // –î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º 7 –≤ –Ω–∞—á–∞–ª–æ
    const fullPhone = '7' + phoneMasked;
    const clientPhoneValid = useMemo(() => phoneMasked.length === 10, [phoneMasked]);
    const pin = useMemo(() => (pinDigits || []).join(''), [pinDigits]);
    const clientPinValid = useMemo(() => auth && auth.validatePin(pin), [auth, pin]);

    const canClientLogin = clientPhoneValid && clientPinValid && !busy;
    const canCuratorLogin = Boolean(email && password) && !busy;

    function showPinOverlayDigit(i, digit, totalMs = 700) {
      try {
        const t = pinHideTimers.current && pinHideTimers.current[i];
        if (t) clearTimeout(t);
      } catch (_) { }

      // –°—Ç–∞–≤–∏–º –æ–≤–µ—Ä–ª–µ–π-—Ü–∏—Ñ—Ä—É (–∞–Ω–∏–º–∞—Ü–∏—è —É span), –ø–æ–¥ –Ω–µ–π –æ—Å—Ç–∞—ë—Ç—Å—è ¬´—Ç–æ—á–∫–∞¬ª (password)
      setPinOverlay((prev) => {
        const next = (prev || []).slice(0, 4);
        while (next.length < 4) next.push({ d: '', k: 0 });
        next[i] = { d: String(digit || ''), k: Date.now() + Math.random() };
        return next;
      });

      // –ê–≤—Ç–æ—Å–±—Ä–æ—Å –æ–≤–µ—Ä–ª–µ—è –∫–∞–∫ fallback (–µ—Å–ª–∏ onAnimationEnd –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
      try {
        pinHideTimers.current[i] = setTimeout(() => {
          setPinOverlay((prev) => {
            const next = (prev || []).slice(0, 4);
            while (next.length < 4) next.push({ d: '', k: 0 });
            // –æ—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ –∫–ª—é—á (—á—Ç–æ–±—ã –Ω–µ —Å–±–∏—Ç—å –Ω–æ–≤—ã–π –≤–≤–æ–¥)
            if (next[i] && next[i].d && next[i].k) next[i] = { d: '', k: 0 };
            return next;
          });
        }, Math.max(300, totalMs + 150));
      } catch (_) { }
    }

    function clearHidePinDigit(i) {
      try {
        const t = pinHideTimers.current && pinHideTimers.current[i];
        if (t) clearTimeout(t);
        if (pinHideTimers.current) pinHideTimers.current[i] = null;
      } catch (_) { }
      setPinOverlay((prev) => {
        const next = (prev || []).slice(0, 4);
        while (next.length < 4) next.push({ d: '', k: 0 });
        next[i] = { d: '', k: 0 };
        return next;
      });
    }

    async function handleClientLogin(pinOverride) {
      if (!onClientLogin) return;
      setErr('');
      setClientDiag(null);
      setBusy(true);
      try {
        const phoneDigits = fullPhone; // 7 + 10 —Ü–∏—Ñ—Ä = 11 —Ü–∏—Ñ—Ä
        const effectivePin = typeof pinOverride === 'string' ? pinOverride : pin;
        const res = await onClientLogin({ phone: phoneDigits, pin: effectivePin });
        if (!res || res.ok === false) {
          const code = res && res.error;

          // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (—Ç–æ–ª—å–∫–æ localhost): –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å shape/rpc/stage
          try {
            const host = (global.location && global.location.hostname) || '';
            const isLocal = host === 'localhost' || host === '127.0.0.1';
            if (isLocal) {
              setClientDiag({
                code: code || 'unknown',
                message: res && res.message,
                debug: res && res._debug,
              });
            }
          } catch (_) { }

          if (code === 'rate_limited') {
            const sec = Math.ceil((res.retryAfterMs || 0) / 1000);
            setErr(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${sec}—Å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
          } else if (code === 'invalid_credentials') {
            setErr('–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ PIN –Ω–µ–≤–µ—Ä–Ω—ã–µ');
          } else if (code === 'cloud_not_ready') {
            setErr('–°–µ—Ä–≤–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.');
          } else if (code === 'invalid_phone') {
            setErr('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7');
          } else if (code === 'invalid_pin') {
            setErr('PIN –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä');
          } else {
            setErr(res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏');
          }
        }
      } finally {
        setBusy(false);
      }
    }

    async function handleCuratorLogin() {
      if (!onCuratorLogin) return;
      setErr('');
      setBusy(true);
      try {
        const res = await onCuratorLogin({ email: String(email).trim(), password });
        if (res && res.error) {
          setErr(typeof res.error === 'string' ? res.error : (res.error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'));
        }
      } finally {
        setBusy(false);
      }
    }

    const greeting = (() => {
      const h = new Date().getHours();
      if (h >= 5 && h < 12) return 'üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!';
      if (h >= 12 && h < 18) return '‚òÄÔ∏è –î–æ–±—Ä—ã–π –¥–µ–Ω—å!';
      if (h >= 18 && h < 23) return 'üåÜ –î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!';
      return 'üåô –î–æ–±—Ä–æ–π –Ω–æ—á–∏!';
    })();

    const Card = (...children) =>
      React.createElement(
        'div',
        { className: 'w-full max-w-[360px] rounded-2xl bg-white/95 p-7 shadow-2xl ring-1 ring-black/5' },
        ...children,
      );

    const Input = (p) =>
      React.createElement('input', {
        ...p,
        className:
          'w-full rounded-xl border-2 border-slate-200 bg-white px-4 py-3 text-[16px] outline-none transition focus:border-blue-400 focus:ring-4 focus:ring-blue-200/60 ' +
          (p.className || ''),
      });

    const PrimaryBtn = (p, children) =>
      React.createElement(
        'button',
        {
          ...p,
          className:
            'w-full rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-3 text-[16px] font-semibold text-white shadow-lg shadow-blue-500/30 transition active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60 ' +
            (p.className || ''),
        },
        children,
      );

    const SecondaryBtn = (p, children) =>
      React.createElement(
        'button',
        {
          ...p,
          className:
            'w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-[15px] font-semibold text-slate-800 shadow-sm transition hover:bg-slate-100 active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60 ' +
            (p.className || ''),
        },
        children,
      );

    const GhostBtn = (p, children) =>
      React.createElement(
        'button',
        {
          ...p,
          className:
            'w-full rounded-xl border border-white/30 bg-white/10 px-4 py-3 text-[15px] font-semibold text-white/95 backdrop-blur transition hover:bg-white/15 active:scale-[0.99] ' +
            (p.className || ''),
        },
        children,
      );

    function renderStart() {
      return Card(
        React.createElement(
          'div',
          { className: 'text-center' },
          React.createElement('div', { className: 'mb-2 text-5xl drop-shadow' }, 'üçé'),
          React.createElement('div', { className: 'text-3xl font-extrabold tracking-tight text-slate-900' }, 'HEYS'),
          React.createElement('div', { className: 'mt-1 text-sm text-slate-500' }, '–£–º–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è'),
        ),
        React.createElement('div', { className: 'mt-6 space-y-3' },
          PrimaryBtn(
            { onClick: () => setMode('client') },
            '–í–æ–π—Ç–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É ‚Üí',
          ),
          SecondaryBtn(
            { onClick: () => setMode('curator') },
            '–í—Ö–æ–¥ –∫—É—Ä–∞—Ç–æ—Ä–∞',
          ),
        ),
        React.createElement(
          'div',
          { className: 'mt-5 text-center text-sm text-slate-500' },
          greeting,
        ),
      );
    }

    function renderClientLogin() {
      // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ 10 —Ü–∏—Ñ—Ä (–±–µ–∑ 7)
      const phoneDigits = phoneMasked.replace(/\D/g, '').slice(0, 10);
      const isPhoneComplete = phoneDigits.length === 10;
      const isPinComplete = (pinDigits || []).every(Boolean);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const handlePhoneInput = (e) => {
        setErr('');
        const input = e.target.value;
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ —Ç–æ–≥–æ —á—Ç–æ –≤–≤–µ–ª–∏
        const newDigits = input.replace(/\D/g, '').slice(0, 10);
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî —Ö—Ä–∞–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è display
        setPhoneMasked(newDigits);
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ PIN –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ 10 —Ü–∏—Ñ—Ä
        if (newDigits.length === 10) {
          setTimeout(() => {
            try { pinRefs.current[0] && pinRefs.current[0].focus(); } catch (_) { }
          }, 50);
        }
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
      const handlePhoneKeyDown = (e) => {
        if (e.key === 'Backspace' && phoneDigits.length > 0) {
          e.preventDefault();
          setPhoneMasked(phoneDigits.slice(0, -1));
        }
      };

      return Card(
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        React.createElement(
          'div',
          { className: 'text-center mb-8' },
          React.createElement('div', { className: 'text-3xl font-extrabold text-slate-900 tracking-tight' }, 'üëã –ü—Ä–∏–≤–µ—Ç!'),
          React.createElement('div', { className: 'mt-1 text-base text-slate-500' }, '–í—Ö–æ–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤'),
        ),

        // –§–æ—Ä–º–∞
        React.createElement('div', { className: 'space-y-6' },
          // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º +7
          React.createElement('div', { className: 'space-y-3' },
            React.createElement('div', { className: 'text-center text-base font-semibold text-slate-700' }, '–¢–µ–ª–µ—Ñ–æ–Ω'),
            React.createElement('div', {
              className: 'flex items-center justify-center gap-2 rounded-2xl border-2 px-4 py-3 transition-all sm:px-5 sm:py-4 ' +
                (isPhoneComplete ? 'border-green-500 bg-green-50/50' : 'border-slate-200 bg-white focus-within:border-blue-500')
            },
              // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å +7 (—Ä–∞–∑–º–µ—Ä –∏ baseline —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å input)
              React.createElement('span', {
                className: 'phone-prefix-large flex-shrink-0 font-bold text-slate-700 select-none'
              }, '+7'),
              // –ü–æ–ª–µ –≤–≤–æ–¥–∞ ‚Äî —à–∏—Ä–∏–Ω–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
              React.createElement('input', {
                type: 'tel',
                inputMode: 'numeric',
                autoComplete: 'tel',
                placeholder: '(999) 123-45-67',
                value: formatPhoneBody(phoneDigits),
                onChange: handlePhoneInput,
                onKeyDown: handlePhoneKeyDown,
                className: 'phone-input-large font-bold text-slate-700 placeholder:text-slate-400 placeholder:font-bold',
                style: { width: '195px' }
              }),
            ),
          ),

          // PIN –≤–≤–æ–¥ ‚Äî 4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª—è (–∫–∞–∫ –≤ –º–æ–¥–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö)
          React.createElement('div', { className: 'space-y-3' },
            React.createElement('div', { className: 'text-center text-base font-semibold text-slate-700' }, 'PIN-–∫–æ–¥'),
            React.createElement('div', {
              className: 'flex items-center justify-between gap-3'
            },
              [0, 1, 2, 3].map((i) => {
                const digit = (pinDigits && pinDigits[i]) || '';
                const isFilled = Boolean(digit);
                const overlay = (pinOverlay && pinOverlay[i]) || { d: '', k: 0 };
                return React.createElement('div', {
                  key: 'pin_wrap_' + i,
                  className: 'relative w-14 h-[72px] sm:w-16 sm:h-20 flex-shrink-0',
                },
                  React.createElement('input', {
                    key: 'pin_' + i,
                    ref: (el) => { pinRefs.current[i] = el; },
                    type: 'password',
                    inputMode: 'numeric',
                    pattern: '[0-9]*',
                    autoComplete: i === 0 ? 'one-time-code' : 'off',
                    maxLength: 1,
                    value: digit,
                    // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç input –ø–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è overlay (–∏–Ω–∞—á–µ –≤–∏–¥–Ω–∞ ¬´–º–∞–ª–µ–Ω—å–∫–∞—è —Ü–∏—Ñ—Ä–∞¬ª –±—Ä–∞—É–∑–µ—Ä–∞)
                    style: overlay.d ? { color: 'transparent', caretColor: 'transparent' } : undefined,
                    onChange: (e) => {
                      setErr('');
                      const v = String(e.target.value || '').replace(/\D/g, '').slice(0, 1);
                      const arr = (pinDigits || []).slice(0, 4);
                      while (arr.length < 4) arr.push('');
                      arr[i] = v;
                      setPinDigits(arr);
                      if (v) showPinOverlayDigit(i, v, 1200);
                      else clearHidePinDigit(i);
                      if (v && i < 3) {
                        try { pinRefs.current[i + 1] && pinRefs.current[i + 1].focus(); } catch (_) { }
                      }
                      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ü–∏—Ñ—Ä—ã PIN
                      if (v && i === 3) {
                        const newPin = arr.join('');
                        const isPinValid = auth && auth.validatePin(newPin);
                        if (clientPhoneValid && isPinValid && !busy) {
                          setTimeout(() => handleClientLogin(newPin), 100);
                        }
                      }
                    },
                    onKeyDown: (e) => {
                      if (e.key === 'Backspace') {
                        const cur = (pinDigits && pinDigits[i]) || '';
                        if (!cur && i > 0) {
                          e.preventDefault();
                          const arr = (pinDigits || []).slice(0, 4);
                          while (arr.length < 4) arr.push('');
                          arr[i - 1] = '';
                          setPinDigits(arr);
                          clearHidePinDigit(i - 1);
                          try { pinRefs.current[i - 1] && pinRefs.current[i - 1].focus(); } catch (_) { }
                          return;
                        }
                        if (cur) {
                          e.preventDefault();
                          const arr = (pinDigits || []).slice(0, 4);
                          while (arr.length < 4) arr.push('');
                          arr[i] = '';
                          setPinDigits(arr);
                          clearHidePinDigit(i);
                          return;
                        }
                      }
                      if (e.key === 'ArrowLeft' && i > 0) {
                        e.preventDefault();
                        try { pinRefs.current[i - 1] && pinRefs.current[i - 1].focus(); } catch (_) { }
                      }
                      if (e.key === 'ArrowRight' && i < 3) {
                        e.preventDefault();
                        try { pinRefs.current[i + 1] && pinRefs.current[i + 1].focus(); } catch (_) { }
                      }
                      if (e.key === 'Enter' && canClientLogin) {
                        handleClientLogin();
                      }
                    },
                    onPaste: (e) => {
                      try {
                        const txt = (e.clipboardData && e.clipboardData.getData('text')) || '';
                        const digits = String(txt).replace(/\D/g, '').slice(0, 4);
                        if (digits) {
                          e.preventDefault();
                          setErr('');
                          const arr = ['', '', '', ''];
                          for (let k = 0; k < 4; k++) {
                            arr[k] = digits[k] || '';
                            if (arr[k]) showPinOverlayDigit(k, arr[k], 1400);
                            else clearHidePinDigit(k);
                          }
                          setPinDigits(arr);
                          const nextIdx = Math.min(3, digits.length);
                          try { pinRefs.current[nextIdx] && pinRefs.current[nextIdx].focus(); } catch (_) { }
                        }
                      } catch (_) { }
                    },
                    className:
                      'w-full h-full rounded-2xl border-2 bg-white text-center text-[32px] sm:text-[36px] leading-none font-bold outline-none transition ' +
                      (isPinComplete
                        ? 'border-green-400 bg-green-50/50'
                        : isFilled
                          ? 'border-slate-300'
                          : 'border-slate-200 focus:border-blue-400 focus:ring-4 focus:ring-blue-200/60'),
                  }),
                  (overlay && overlay.d)
                    ? React.createElement(
                      'span',
                      {
                        key: 'pin_overlay_' + i + '_' + overlay.k,
                        className:
                          'pin-digit-overlay absolute inset-0 flex items-center justify-center text-slate-800 text-[32px] sm:text-[36px] font-bold leading-none pointer-events-none',
                        onAnimationEnd: () => {
                          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ overlay
                          setPinOverlay((prev) => {
                            const next = (prev || []).slice(0, 4);
                            while (next.length < 4) next.push({ d: '', k: 0 });
                            if (next[i] && next[i].k === overlay.k) next[i] = { d: '', k: 0 };
                            return next;
                          });
                        },
                      },
                      overlay.d,
                    )
                    : null,
                );
              })
            ),
          ),

          err && React.createElement('div', { className: 'rounded-xl bg-red-50 px-4 py-3 text-center text-sm text-red-600' }, err),
          clientDiag && React.createElement(
            'div',
            { className: 'rounded-xl bg-black/5 px-3 py-2 text-left text-[12px] text-slate-700' },
            React.createElement('div', { className: 'font-semibold text-slate-800' }, '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (localhost)'),
            React.createElement(
              'pre',
              { className: 'mt-1 whitespace-pre-wrap break-words font-mono text-[11px] leading-snug text-slate-700' },
              (() => {
                try {
                  return JSON.stringify(clientDiag, null, 2);
                } catch (_) {
                  return String(clientDiag);
                }
              })(),
            ),
          ),
          PrimaryBtn(
            { onClick: handleClientLogin, disabled: !canClientLogin },
            busy ? '‚è≥ –í—Ö–æ–¥...' : '–í–æ–π—Ç–∏ ‚Üí',
          ),
        ),
        React.createElement(
          'div',
          { className: 'mt-6 space-y-3 text-center text-sm text-slate-500' },
          React.createElement('div', null, '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞? –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:'),
          React.createElement(
            'a',
            {
              href: 'tel:+79624556111',
              className: 'block font-semibold text-blue-600 hover:underline',
            },
            '+7 962 455-61-11',
          ),
          React.createElement(
            'button',
            { className: 'mt-3 font-medium text-blue-500 hover:text-blue-700 hover:underline', onClick: () => { setErr(''); setMode('curator'); } },
            '–í—Ö–æ–¥ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞ ‚Üí',
          ),
        ),
      );
    }

    function renderCuratorLogin() {
      return Card(
        React.createElement(
          'div',
          { className: 'text-center' },
          React.createElement('div', { className: 'mb-2 text-4xl drop-shadow' }, 'üçé'),
          React.createElement('div', { className: 'text-2xl font-extrabold tracking-tight text-slate-900' }, 'HEYS'),
          React.createElement('div', { className: 'mt-1 text-sm text-slate-500' }, '–í—Ö–æ–¥ –∫—É—Ä–∞—Ç–æ—Ä–∞'),
        ),
        React.createElement('div', { className: 'mt-5 space-y-3' },
          Input({
            type: 'email',
            autoComplete: 'email',
            placeholder: 'Email',
            value: email,
            onChange: (e) => { setErr(''); setEmail(e.target.value); },
          }),
          Input({
            type: 'password',
            autoComplete: 'current-password',
            placeholder: '–ü–∞—Ä–æ–ª—å',
            value: password,
            onChange: (e) => { setErr(''); setPassword(e.target.value); },
            onKeyDown: (e) => e.key === 'Enter' && canCuratorLogin && handleCuratorLogin(),
          }),
          err && React.createElement('div', { className: 'rounded-xl bg-red-50 px-3 py-2 text-center text-sm text-red-600' }, err),
          PrimaryBtn(
            { onClick: handleCuratorLogin, disabled: !canCuratorLogin },
            busy ? '‚è≥ –í—Ö–æ–¥...' : '–í–æ–π—Ç–∏ ‚Üí',
          ),
        ),
        React.createElement(
          'div',
          { className: 'mt-5 space-y-2 text-center text-sm text-slate-500' },
          React.createElement('div', null, greeting),
          React.createElement(
            'button',
            { className: 'text-blue-600 hover:underline', onClick: () => { setErr(''); setMode('start'); } },
            '‚Üê –ù–∞–∑–∞–¥',
          ),
        ),
      );
    }

    return React.createElement(
      'div',
      {
        className:
          'fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-gradient-to-br from-blue-500 to-blue-700 px-5 py-10',
      },
      mode === 'start'
        ? renderStart()
        : mode === 'client'
          ? renderClientLogin()
          : renderCuratorLogin(),
      React.createElement(
        'div',
        { className: 'mt-6 text-xs font-medium text-white/40 tracking-wider font-mono' },
        'v' + (HEYS.version || 'dev'),
      ),
    );
  }

  HEYS.LoginScreen = LoginScreen;
})(typeof window !== 'undefined' ? window : globalThis);


/* ===== heys_ui_onboarding_v1.js ===== */
// heys_ui_onboarding_v1.js ‚Äî –ú–æ–¥—É–ª—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç spotlight –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç –∏—Ö —Ñ—É–Ω–∫—Ü–∏—é
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç z-index 9000-9500 (–≤—ã—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –Ω–∏–∂–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥–∞–ª–æ–∫)
// v1.7: –í–∏–∑—É–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è ‚Äî pulse animation + backdrop blur + tooltip fade-in
// v1.6: Sync curator check via localStorage ‚Äî HEYS.cloud.role may not be set yet

(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};

  const trackTourEvent = (event, data) => {
    if (HEYS.analytics?.trackEvent) {
      HEYS.analytics.trackEvent(event, data);
    }
  };

  const trackTourError = (error, context) => {
    if (HEYS.analytics?.trackError) {
      HEYS.analytics.trackError(error, context);
    }
  };

  // === CONFIGURATION ===

  const TOUR_ID = 'onboarding_tour_v1';
  const STORAGE_KEY = 'heys_tour_completed';
  const HAPTIC_ENABLED = true; // navigator.vibrate –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö
  const HAPTIC_PATTERN = [15]; // –ö–æ—Ä–æ—Ç–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è 15ms

  const getStoredFlag = (key, fallback = false) => {
    const scoped = HEYS.store?.get?.(key, null);
    if (scoped === true || scoped === 'true') return true;
    if (scoped === false || scoped === 'false') return false;
    try {
      return localStorage.getItem(key) === 'true';
    } catch (e) {
      return fallback;
    }
  };

  // –®–∞–≥–∏ —Ç—É—Ä–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π
  const TOUR_STEPS = [
    {
      id: 'step_hero',
      targetId: 'tour-hero-stats',
      title: '–ì–ª–∞–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã',
      // text –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      getText: (name) => name
        ? `${name}, –∑–¥–µ—Å—å –≤–∞—à —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. "–°—ä–µ–¥–µ–Ω–æ" –∏ "–û—Å—Ç–∞–ª–æ—Å—å" –ø–æ–º–æ–≥—É—Ç –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å.`
        : '–ó–¥–µ—Å—å –≤–∞—à —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. "–°—ä–µ–¥–µ–Ω–æ" –∏ "–û—Å—Ç–∞–ª–æ—Å—å" –ø–æ–º–æ–≥—É—Ç –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å.',
      position: 'bottom',
      arrow: 'top',
      demoData: { eaten: 1450, goal: 2000, remaining: 550, ratio: 0.72 }
    },
    {
      id: 'step_sparkline',
      targetId: 'tour-calorie-graph',
      title: '–î–∏–Ω–∞–º–∏–∫–∞ –∏ –î–µ—Ñ–∏—Ü–∏—Ç',
      getText: () => '–ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –Ω–µ–¥–µ–ª—é. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ä–µ–¥–Ω–∏–º –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º!',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'step_insulin',
      targetId: 'tour-insulin-wave',
      title: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞',
      getText: () => '–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—à–∫–∞ HEYS. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (üî•).',
      position: 'bottom',
      arrow: 'top',
      forceExpand: true // –†–∞—Å–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç –µ—Å–ª–∏ —Å–≤–µ—Ä–Ω—É—Ç
    },
    {
      id: 'step_fab',
      targetId: 'tour-fab-buttons',
      title: '–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ',
      getText: () => '–ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ üçΩÔ∏è –¥–ª—è –µ–¥—ã –∏ ü•õ –¥–ª—è –≤–æ–¥—ã. –í—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π.',
      position: 'top',
      arrow: 'bottom'
    },
    // === –í–ö–õ–ê–î–ö–ò (–ø–æ –ø–æ—Ä—è–¥–∫—É) ===
    {
      id: 'step_widgets',
      targetId: 'tour-widgets-tab',
      title: 'üéõÔ∏è –í–∏–¥–∂–µ—Ç—ã',
      getText: () => '–í–∞—à–∞ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∏–¥–∂–µ—Ç—ã –ø–æ–¥ —Å–µ–±—è ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ, —É–¥–∞–ª—è–π—Ç–µ, –º–µ–Ω—è–π—Ç–µ —Ä–∞–∑–º–µ—Ä.',
      position: 'top',
      arrow: 'bottom',
      highlightTab: true
    },
    {
      id: 'step_stats',
      targetId: 'tour-stats-tab',
      title: 'üìä –ò—Ç–æ–≥–∏ –¥–Ω—è',
      getText: () => '–ó–¥–µ—Å—å –≤—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –º–∞–∫—Ä–æ—Å—ã, —Å–æ–Ω, —à–∞–≥–∏, –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –∏ —É–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.',
      position: 'top',
      arrow: 'bottom',
      highlightTab: true
    },
    {
      id: 'step_diary',
      targetId: 'tour-diary-tab',
      title: 'üç¥ –î–Ω–µ–≤–Ω–∏–∫ –µ–¥—ã',
      getText: () => '–í—Å–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ –¥–µ–Ω—å. –î–æ–±–∞–≤–ª—è–π—Ç–µ –µ–¥—É, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ, —Å–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª–∏.',
      position: 'top',
      arrow: 'bottom',
      highlightTab: true
    },
    {
      id: 'step_insights',
      targetId: 'tour-insights-tab',
      title: 'üîÆ –£–º–Ω—ã–µ –ò–Ω—Å–∞–π—Ç—ã',
      getText: () => '–ó–∞–≥–ª—è–Ω–∏—Ç–µ —Å—é–¥–∞! –ê–Ω–∞–ª–∏–∑ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞, –ø—Ä–æ–≥–Ω–æ–∑—ã –≤–µ—Å–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.',
      position: 'top',
      arrow: 'bottom',
      highlightTab: true
    }
  ];

  // Demo –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—É—Å—Ç–æ)
  const TOUR_DEMO_DATA = {
    hero: {
      tdee: 2150,
      optimum: 2000,
      eaten: 1450,
      remaining: 550,
      ratio: 0.72
    },
    sparkline: [
      { date: '–ü–Ω', kcal: 1800, target: 2000 },
      { date: '–í—Ç', kcal: 1950, target: 2000 },
      { date: '–°—Ä', kcal: 1700, target: 2000 },
      { date: '–ß—Ç', kcal: 2100, target: 2000 }, // –ø–µ—Ä–µ–±–æ—Ä
      { date: '–ü—Ç', kcal: 1850, target: 2000 },
      { date: '–°–±', kcal: 1750, target: 2000 },
      { date: '–í—Å', kcal: 0, target: 2000 }
    ]
  };

  // === MODULE STATE ===

  let state = {
    isActive: false,
    currentStepIndex: 0,
    stepStartTime: null, // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —à–∞–≥–∞ –¥–ª—è analytics
    overlayEl: null,
    tooltipEl: null,
    highlightEl: null,
    welcomeModalEl: null,
    onComplete: null,
    userName: null, // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    wasHidden: false // –§–ª–∞–≥ –¥–ª—è visibilitychange
  };

  // === HAPTIC FEEDBACK ===

  function triggerHaptic() {
    if (HAPTIC_ENABLED && navigator.vibrate) {
      navigator.vibrate(HAPTIC_PATTERN);
    }
  }

  // === VISIBILITY CHANGE HANDLER ===

  const INTERRUPTED_STEP_KEY = 'heys_tour_interrupted_step';
  let hiddenTimestamp = 0;
  const MIN_HIDDEN_DURATION = 500; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º "—Å–∫—Ä—ã—Ç–∏—è" –∫–æ—Ä–æ—á–µ 500–º—Å (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤)

  function handleVisibilityChange() {
    if (document.hidden && state.isActive) {
      hiddenTimestamp = Date.now();
      state.wasHidden = true;
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏
      try {
        localStorage.setItem(INTERRUPTED_STEP_KEY, String(state.currentStepIndex));
        trackTourEvent('onboarding_visibility_hidden', { step: state.currentStepIndex });
      } catch (e) {
        trackTourError(e, { scope: 'onboarding_save_interrupted_step' });
      }
    } else if (!document.hidden && state.wasHidden && state.isActive) {
      const hiddenDuration = Date.now() - hiddenTimestamp;
      state.wasHidden = false;

      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ "—Å–∫—Ä—ã—Ç–∏—è" ‚Äî —ç—Ç–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤/—Ä–µ–Ω–¥–µ—Ä–∞
      if (hiddenDuration < MIN_HIDDEN_DURATION) {
        trackTourEvent('onboarding_visibility_short_hide', { hiddenDurationMs: hiddenDuration });
        return;
      }

      trackTourEvent('onboarding_visibility_restore', { hiddenDurationMs: hiddenDuration });
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é highlight –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      OnboardingTour.renderStep();
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–π —à–∞–≥ –µ—Å–ª–∏ –µ—Å—Ç—å
   */
  function getInterruptedStep() {
    try {
      const saved = localStorage.getItem(INTERRUPTED_STEP_KEY);
      if (saved !== null) {
        const stepIndex = parseInt(saved, 10);
        if (!isNaN(stepIndex) && stepIndex >= 0 && stepIndex < TOUR_STEPS.length) {
          return stepIndex;
        }
      }
    } catch (e) {
      trackTourError(e, { scope: 'onboarding_read_interrupted_step' });
    }
    return null;
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–π —à–∞–≥
   */
  function clearInterruptedStep() {
    try {
      localStorage.removeItem(INTERRUPTED_STEP_KEY);
    } catch (e) {
      // ignore
    }
  }

  // === WELCOME MODAL ===

  function showWelcomeModal(options = {}) {
    return new Promise((resolve) => {
      const el = document.createElement('div');
      el.className = 'tour-welcome-modal';

      // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userName = getUserName();
      const greeting = userName ? `–ü—Ä–∏–≤–µ—Ç, ${userName}!` : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ HEYS!';

      el.innerHTML = `
        <div class="tour-welcome-backdrop"></div>
        <div class="tour-welcome-content">
          <div class="tour-welcome-icon">üëã</div>
          <h2 class="tour-welcome-title">${greeting}</h2>
          <p class="tour-welcome-text">
            –•–æ—Ç–∏—Ç–µ –±—ã—Å—Ç—Ä–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º?<br>
            –ü–æ–∫–∞–∂–µ–º –≥–ª–∞–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ 30 —Å–µ–∫—É–Ω–¥.
          </p>
          <div class="tour-welcome-buttons">
            <button class="tour-btn tour-btn-later">–ü–æ–∑–∂–µ</button>
            <button class="tour-btn tour-btn-start">–î–∞, –ø–æ–∫–∞–∑–∞—Ç—å! üöÄ</button>
          </div>
        </div>
      `;

      document.body.appendChild(el);
      state.welcomeModalEl = el;

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      requestAnimationFrame(() => {
        el.classList.add('tour-welcome-enter');
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      const startBtn = el.querySelector('.tour-btn-start');
      const laterBtn = el.querySelector('.tour-btn-later');
      const backdrop = el.querySelector('.tour-welcome-backdrop');

      const close = (result) => {
        el.classList.remove('tour-welcome-enter');
        el.classList.add('tour-welcome-exit');
        triggerHaptic();
        setTimeout(() => {
          el.remove();
          state.welcomeModalEl = null;
          resolve(result);
        }, 300);
      };

      startBtn.onclick = () => close('start');
      laterBtn.onclick = () => close('later');
      backdrop.onclick = () => close('later');
    });
  }

  function getUserName() {
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    try {
      // 1. –ò–∑ –ø—Ä–æ—Ñ–∏–ª—è HEYS
      if (HEYS.store && HEYS.store.get) {
        const profile = HEYS.store.get('heys_profile', null);
        if (profile && profile.firstName) return profile.firstName;
        if (profile && profile.name) return profile.name.split(' ')[0];
      }
      // 2. –ò–∑ localStorage –Ω–∞–ø—Ä—è–º—É—é
      const profileRaw = localStorage.getItem('heys_profile');
      if (profileRaw) {
        const profile = JSON.parse(profileRaw);
        if (profile.firstName) return profile.firstName;
        if (profile.name) return profile.name.split(' ')[0];
      }
    } catch (e) {
      trackTourError(e, { scope: 'onboarding_get_user_name' });
    }
    return null;
  }

  // === CSS ANIMATIONS (v1.7) ===

  let animationsInjected = false;

  function injectTourAnimations() {
    if (animationsInjected) return;

    const styleEl = document.createElement('style');
    styleEl.id = 'tour-animations';
    styleEl.textContent = `
      /* Tour Pulse Animation ‚Äî "–¥—ã—Ö–∞–Ω–∏–µ" –ø–æ–¥—Å–≤–µ—Ç–∫–∏ */
      @keyframes tourPulse {
        0%, 100% {
          box-shadow: 
            0 0 0 9999px rgba(0, 0, 0, 0.75),
            0 0 0 0 rgba(255, 255, 255, 0.3);
        }
        50% {
          box-shadow: 
            0 0 0 9999px rgba(0, 0, 0, 0.75),
            0 0 0 6px rgba(255, 255, 255, 0.1);
        }
      }
      
      /* Tour Tooltip Fade-in ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ .tour-tooltip-enter */
      @keyframes tourTooltipIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞ .tour-tooltip-enter */
      .tour-tooltip-enter {
        animation: tourTooltipIn 0.25s ease-out;
      }
      
      /* Highlight glow effect */
      .tour-highlight {
        border: 2px solid rgba(255, 255, 255, 0.15);
      }
    `;
    document.head.appendChild(styleEl);
    animationsInjected = true;
  }

  // === RENDER HELPERS ===

  function createOverlay() {
    if (state.overlayEl) return state.overlayEl;

    // –ò–Ω–∂–µ–∫—Ç–∏—Ä—É–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞
    injectTourAnimations();

    const el = document.createElement('div');
    el.className = 'tour-overlay';
    // –°—Ç–∏–ª–∏ –±—É–¥—É—Ç –≤ CSS, –Ω–æ –±–∞–∑–æ–≤—ã–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    el.style.position = 'fixed';
    el.style.inset = '0';
    el.style.zIndex = '9000';
    // –í–ê–ñ–ù–û: overlay –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π! –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ box-shadow —É highlight
    // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç highlight "–≤—ã—Ä–µ–∑–∞—Ç—å –¥—ã—Ä–∫—É" –≤ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–∏
    el.style.background = 'transparent';
    el.style.opacity = '1';
    // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º backdrop-filter ‚Äî –æ–Ω —Ä–∞–∑–º—ã–≤–∞–µ—Ç –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç!

    // Overlay —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø–æ–¥ –Ω–∏–º

    document.body.appendChild(el);

    state.overlayEl = el;
    return el;
  }

  function createHighlight(rect) {
    let el = state.highlightEl;
    if (!el) {
      el = document.createElement('div');
      el.className = 'tour-highlight';
      el.style.position = 'fixed';
      el.style.zIndex = '9001';
      // v1.7: –ë–∞–∑–æ–≤–∞—è —Ç–µ–Ω—å + –∞–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ CSS –∫–ª–∞—Å—Å
      el.style.boxShadow = '0 0 0 9999px rgba(0, 0, 0, 0.75)';
      el.style.borderRadius = '12px';
      el.style.pointerEvents = 'none'; // –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –∫–ª–∏–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–Ω–æ –æ–±—ã—á–Ω–æ –º—ã –Ω–µ –¥–∞–µ–º –∂–∞—Ç—å)
      el.style.transition = 'top 0.3s ease, left 0.3s ease, width 0.3s ease, height 0.3s ease';
      // v1.7: –ü—É–ª—å—Å–∞—Ü–∏—è –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
      el.style.animation = 'tourPulse 2s ease-in-out infinite';
      document.body.appendChild(el);
      state.highlightEl = el;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
    // –î–æ–±–∞–≤–ª—è–µ–º padding
    const padding = 4;
    el.style.top = (rect.top - padding) + 'px';
    el.style.left = (rect.left - padding) + 'px';
    el.style.width = (rect.width + padding * 2) + 'px';
    el.style.height = (rect.height + padding * 2) + 'px';

    return el;
  }

  function createTooltip(step, rect) {
    let el = state.tooltipEl;
    const isNewStep = state._lastAnimatedStep !== state.currentStepIndex;

    if (!el) {
      el = document.createElement('div');
      el.className = 'tour-tooltip';
      el.style.position = 'fixed';
      el.style.zIndex = '9002';
      document.body.appendChild(el);
      state.tooltipEl = el;
    }

    // –ö–æ–Ω—Ç–µ–Ω—Ç (–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —à–∞–≥–∞, –∏–Ω–∞—á–µ —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º)
    if (!isNewStep && el.innerHTML) {
      // –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏, –∫–æ–Ω—Ç–µ–Ω—Ç —É–∂–µ –µ—Å—Ç—å
      updateTooltipPosition(el, step, rect);
      return;
    }

    // –ö–æ–Ω—Ç–µ–Ω—Ç
    const isFirst = state.currentStepIndex === 0;
    const isLast = state.currentStepIndex === TOUR_STEPS.length - 1;

    const nextLabel = isLast ? '–ì–æ—Ç–æ–≤–æ! üéâ' : '–î–∞–ª–µ–µ ‚Üí';

    el.innerHTML = `
      <div class="tour-tooltip-content">
        <h3 class="tour-title">${step.title}</h3>
        <p class="tour-text">${step.text}</p>
        <div class="tour-footer">
          <div class="tour-indicators">
            ${TOUR_STEPS.map((_, i) =>
      `<span class="tour-dot ${i === state.currentStepIndex ? 'active' : ''}"></span>`
    ).join('')}
          </div>
          <div class="tour-buttons">
            ${!isLast ? `<button class="tour-btn tour-btn-skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>` : ''}
            <button class="tour-btn tour-btn-next ${isLast ? 'tour-btn-finish' : ''}">${nextLabel}</button>
          </div>
        </div>
        <div class="tour-arrow tour-arrow-${step.arrow}"></div>
      </div>
    `;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    const nextBtn = el.querySelector('.tour-btn-next');
    const skipBtn = el.querySelector('.tour-btn-skip');

    if (nextBtn) nextBtn.onclick = () => OnboardingTour.next();
    if (skipBtn) skipBtn.onclick = () => OnboardingTour.skip();

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    // –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ position: bottom/top
    const tooltipRect = el.getBoundingClientRect(); // –ù—É–∂–Ω–æ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–æ–≤—ã–π
    // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –ø–µ—Ä–µ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º
    el.style.top = '';
    el.style.bottom = '';
    el.style.left = '';
    el.style.right = '';

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–Ω–∏–º–∞—Ü–∏—è
    updateTooltipPosition(el, step, rect, true);

    // –û—Ç–º–µ—á–∞–µ–º —à–∞–≥ –∫–∞–∫ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
    state._lastAnimatedStep = state.currentStepIndex;
  }

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é —Ç—É–ª—Ç–∏–ø–∞ (–±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
   * @param {HTMLElement} el - —ç–ª–µ–º–µ–Ω—Ç —Ç—É–ª—Ç–∏–ø–∞
   * @param {Object} step - —Ç–µ–∫—É—â–∏–π —à–∞–≥
   * @param {DOMRect} rect - rect —Ü–µ–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
   * @param {boolean} animate - –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–∏ –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
   */
  function updateTooltipPosition(el, step, rect, animate = false) {
    // –ñ–¥–µ–º —Ä–µ–Ω–¥–µ—Ä–∞ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã
    requestAnimationFrame(() => {
      const ttW = el.offsetWidth;
      const ttH = el.offsetHeight;
      const gap = 12;

      let top, left;

      if (step.position === 'bottom') {
        top = rect.bottom + gap;
        left = rect.left + (rect.width / 2) - (ttW / 2);
      } else if (step.position === 'top') {
        top = rect.top - ttH - gap;
        left = rect.left + (rect.width / 2) - (ttW / 2);
      }

      // üîß v1.17 FIX: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü —ç–∫—Ä–∞–Ω–∞ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ò –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ
      const margin = 16;

      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
      if (left < margin) left = margin;
      if (left + ttW > window.innerWidth - margin) {
        left = window.innerWidth - ttW - margin;
        // üîß v1.20 FIX: –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç (–Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö), –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É
        if (left < margin) {
          left = margin;
          // –¢—É—Ç –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –º–µ–Ω—è—Ç—å —à–∏—Ä–∏–Ω—É —ç–ª–µ–º–µ–Ω—Ç–∞, –Ω–æ –æ–Ω —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ CSS.
          // –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º, –ø—É—Å—Ç—å –ª—É—á—à–µ –≤–ª–µ–∑–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
        }
      }

      // üîß v1.17 FIX: –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã (–Ω–µ –¥–∞–≤–∞—Ç—å —Ç—É–ª—Ç–∏–ø—É —É–µ–∑–∂–∞—Ç—å –∑–∞ —ç–∫—Ä–∞–Ω)
      // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –¥–ª—è FAB –∫–Ω–æ–ø–æ–∫ (–æ–Ω–∏ –≤–Ω–∏–∑—É, —Ç—É–ª—Ç–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ù–ê–î –Ω–∏–º–∏)
      if (step.position === 'top' && top + ttH > rect.top) { // –ï—Å–ª–∏ —Ç—É–ª—Ç–∏–ø –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç (–Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö)
        top = rect.top - ttH - gap;
      }

      if (top < margin) {
        // –ï—Å–ª–∏ —É–µ—Ö–∞–ª –≤–≤–µ—Ä—Ö ‚Äî —Å–¥–≤–∏–≥–∞–µ–º –≤–Ω–∏–∑ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞
        top = rect.bottom + gap;
      }
      // –ï—Å–ª–∏ —É–µ—Ö–∞–ª –≤–Ω–∏–∑ –∑–∞ —ç–∫—Ä–∞–Ω –ò–õ–ò –ø–µ—Ä–µ–∫—Ä—ã–ª –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π (–¥–ª—è safety)
      if (top + ttH > window.innerHeight - margin) {
        // –ï—Å–ª–∏ —É–µ—Ö–∞–ª –≤–Ω–∏–∑ ‚Äî —Å–¥–≤–∏–≥–∞–µ–º –≤–≤–µ—Ä—Ö –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞
        top = rect.top - ttH - gap;
        // –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç ‚Äî –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ –≤–µ—Ä—Ö—É (–≥—Ä—É–±—ã–π —Ñ–æ–ª–ª–±–µ–∫)
        if (top < margin) top = margin;
      }

      el.style.top = top + 'px';
      el.style.left = left + 'px';

      // üîß v1.21 FIX: –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —à–∞–≥–∞ (–Ω–µ –ø—Ä–∏ updatePosition)
      if (animate) {
        el.classList.remove('tour-tooltip-enter');
        void el.offsetWidth; // reflow
        el.classList.add('tour-tooltip-enter');
      }
    });
  }

  // === PUBLIC API ===

  const OnboardingTour = {

    /**
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É—Ä (—Å welcome modal)
     * @param {Object} options - { force: boolean, onComplete: func, skipWelcome: boolean }
     */
    async start(options = {}) {
      if (state.isActive) return;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª?
      const isCompleted = getStoredFlag(STORAGE_KEY, false);

      if (isCompleted && !options.force) return;

      // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
      state.userName = getUserName();

      // –ü–æ–∫–∞–∑–∞—Ç—å welcome modal –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–ø—É—â–µ–Ω
      if (!options.skipWelcome && !options.force) {
        const result = await showWelcomeModal();
        if (result === 'later') {
          trackTourEvent('onboarding_tour_deferred', { reason: 'user_later' });
          if (HEYS.analytics) {
            HEYS.analytics.trackEvent('tour_deferred');
          }
          return;
        }
      }

      trackTourEvent('onboarding_tour_starting', { hasUserName: !!state.userName });

      // FORCE SWITCH TO MAIN TAB before starting
      // This ensures elements like hero-stats are in the DOM
      if (HEYS.ui && HEYS.ui.switchTab) {
        // Check if we need to switch
        // We assume 'stats' is the tab where first steps are loccated.
        // Ideally we should check if the target element of the current step is visible.
        HEYS.ui.switchTab('stats');
      }

      // Temporarily suppress Morning Check-in using a global flag
      if (HEYS.ui) {
        HEYS.ui.suppressMorningCheckin = true;
        trackTourEvent('onboarding_checkin_suppressed', {});
      }

      // Wait for the target element of the first (or current) step to appear
      const initialStepIndex = getInterruptedStep() === null ? 0 : getInterruptedStep();
      const targetId = TOUR_STEPS[initialStepIndex]?.targetId;

      if (targetId) {
        trackTourEvent('onboarding_wait_for_element', { targetId });
        const waitForElement = (id, timeout = 2500) => {
          return new Promise(resolve => {
            const startTime = Date.now();
            const check = () => {
              const el = document.getElementById(id);
              if (el && el.offsetParent !== null) { // exists and visible (not display:none)
                trackTourEvent('onboarding_element_found', { targetId: id, ms: Date.now() - startTime });
                resolve(el);
              } else if (Date.now() - startTime > timeout) {
                trackTourEvent('onboarding_element_timeout', { targetId: id, ms: Date.now() - startTime });
                resolve(null);
              } else {
                requestAnimationFrame(check);
              }
            };
            check();
          });
        };
        await waitForElement(targetId);
        trackTourEvent('onboarding_wait_for_element_done', { targetId });
      } else {
        // Fallback just in case
        await new Promise(r => setTimeout(r, 500));
      }

      state.isActive = true;
      state.onComplete = options.onComplete;
      state.stepStartTime = Date.now(); // –î–ª—è time_on_step

      // üÜï –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–∏–¥–∂–µ—Ç—ã –æ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ)
      HEYS.Widgets?.emit?.('data:updated', {});

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–≥–æ —à–∞–≥–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
      const interruptedStep = getInterruptedStep();
      if (interruptedStep !== null && !options.force) {
        state.currentStepIndex = interruptedStep;
        trackTourEvent('onboarding_resume_interrupted_step', { step: interruptedStep });
      } else {
        state.currentStepIndex = 0;
      }

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ visibility change
      document.addEventListener('visibilitychange', handleVisibilityChange);

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è PWA –±–∞–Ω–Ω–µ—Ä–∞
      document.body.classList.add('tour-active');

      createOverlay();
      this.renderStep();
      triggerHaptic();

      // Analytics
      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('tour_started', {
          user_name: state.userName ? 'yes' : 'no'
        });
      }
    },

    /**
     * –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —à–∞–≥
     */
    renderStep() {
      if (!state.isActive) return;

      const step = TOUR_STEPS[state.currentStepIndex];
      const targetEl = document.getElementById(step.targetId);

      trackTourEvent('onboarding_render_step', { targetId: step.targetId, found: !!targetEl });

      if (!targetEl) {
        trackTourEvent('onboarding_target_missing', { targetId: step.targetId });
        this.next();
        return;
      }

      // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ highlight –∏ —Ç—É–ª—Ç–∏–ø–∞
      const updatePosition = () => {
        if (!state.isActive) return;
        const rect = targetEl.getBoundingClientRect();
        trackTourEvent('onboarding_update_position', { targetId: step.targetId });
        createHighlight(rect);
        // –ü–µ—Ä–µ–¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        const stepWithText = {
          ...step,
          text: step.getText ? step.getText(state.userName) : step.text
        };
        createTooltip(stepWithText, rect);
      };

      // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ —ç–ª–µ–º–µ–Ω—Ç—É (–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ ‚Äî —á—Ç–æ–±—ã highlight —Å—Ä–∞–∑—É –±—ã–ª –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ)
      targetEl.scrollIntoView({ behavior: 'instant', block: 'center' });

      // –†–∏—Å—É–µ–º –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–º–µ–Ω–∏–ª —Å–∫—Ä–æ–ª–ª (1 frame)
      requestAnimationFrame(() => {
        updatePosition();
        // –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 100ms –Ω–∞ —Å–ª—É—á–∞–π lazy-—Ä–µ–Ω–¥–µ—Ä–∞
        setTimeout(updatePosition, 100);
      });
    },

    next() {
      if (!state.isActive) return;

      // –¢—Ä–µ–∫–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —à–∞–≥–µ
      const timeOnStep = state.stepStartTime ? Date.now() - state.stepStartTime : 0;

      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('tour_step', {
          step_index: state.currentStepIndex,
          step_id: TOUR_STEPS[state.currentStepIndex]?.targetId,
          time_on_step_ms: timeOnStep
        });
      }

      triggerHaptic();

      if (state.currentStepIndex < TOUR_STEPS.length - 1) {
        state.currentStepIndex++;
        state.stepStartTime = Date.now(); // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —à–∞–≥–∞
        this.renderStep();
      } else {
        this.finish();
      }
    },

    skip() {
      const timeOnStep = state.stepStartTime ? Date.now() - state.stepStartTime : 0;

      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('tour_skipped', {
          step: state.currentStepIndex,
          time_on_step_ms: timeOnStep
        });
      }
      this.finish();
    },

    finish() {
      if (!state.isActive) return;

      trackTourEvent('onboarding_tour_finished', {});

      // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç visibility change
      document.removeEventListener('visibilitychange', handleVisibilityChange);

      // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è PWA –±–∞–Ω–Ω–µ—Ä–∞
      document.body.classList.remove('tour-active');

      // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è Morning Check-in
      if (HEYS.ui) {
        HEYS.ui.suppressMorningCheckin = false;
        trackTourEvent('onboarding_checkin_restored', {});
      }

      // Cleanup DOM
      if (state.overlayEl) state.overlayEl.remove();
      if (state.highlightEl) state.highlightEl.remove();
      if (state.tooltipEl) state.tooltipEl.remove();

      state.overlayEl = null;
      state.highlightEl = null;
      state.tooltipEl = null;
      state.isActive = false;
      state.stepStartTime = null;
      state.userName = null;
      state.wasHidden = false;

      // üÜï –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–∏–¥–∂–µ—Ç—ã –æ –≤—ã—Ö–æ–¥–µ –∏–∑ –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞ (—á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
      HEYS.Widgets?.emit?.('data:updated', {});

      // Save state
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(STORAGE_KEY, true);
      } else {
        localStorage.setItem(STORAGE_KEY, 'true');
      }

      // –û—á–∏—â–∞–µ–º –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–π —à–∞–≥ —Ç.–∫. —Ç—É—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
      clearInterruptedStep();

      triggerHaptic();

      // Analytics
      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('tour_completed', {
          total_steps: TOUR_STEPS.length
        });
      }

      // üéâ Gamification: –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å
      if (HEYS.game?.celebrate) {
        HEYS.game.celebrate();
      }

      // üèÜ Gamification: XP –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
      if (HEYS.game?.addXP) {
        HEYS.game.addXP(50, 'onboarding_completed');
      }

      if (state.onComplete) state.onComplete();
    },

    /**
     * –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç—É—Ä —Å–µ–π—á–∞—Å?
     * (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ demo-–¥–∞–Ω–Ω—ã—Ö)
     */
    isActive() {
      return state.isActive;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     * @param {string} componentId - 'hero' | 'sparkline'
     * @returns {Object|null}
     */
    getDemoData(componentId) {
      if (!state.isActive) return null;
      return TOUR_DEMO_DATA[componentId] || null;
    },

    /**
     * –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
     */
    reset() {
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(STORAGE_KEY, false);
      } else {
        localStorage.removeItem(STORAGE_KEY);
      }
      trackTourEvent('onboarding_tour_reset', {});
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîÆ INSIGHTS MINI-TOUR ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–∏–Ω–∏-—Ç—É—Ä –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ò–Ω—Å–∞–π—Ç–æ–≤
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const INSIGHTS_TOUR_ID = 'insights_tour_v1';
  const INSIGHTS_STORAGE_KEY = 'heys_insights_tour_completed';

  const INSIGHTS_TOUR_STEPS = [
    {
      id: 'insights_status',
      targetId: 'tour-insights-status',
      title: 'üìä –°—Ç–∞—Ç—É—Å –¥–Ω—è',
      getText: () => '–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ 0-100. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–µ–Ω—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º —Ü–µ–ª—è–º.',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'insights_metabolic',
      targetId: 'tour-insights-metabolic',
      title: '‚ö° –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å',
      getText: () => '–ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ —Å—Ä—ã–≤–∞ –∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞.',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'insights_prediction',
      targetId: 'tour-insights-prediction',
      title: 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑—ã',
      getText: () => 'AI-–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: —Ä–∏—Å–∫–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∏–Ω—Å–∞–π—Ç—ã.',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'insights_phenotype',
      targetId: 'tour-insights-phenotype',
      title: 'üß¨ –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø',
      getText: () => '–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–º —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –µ–¥—É –∏ –Ω–∞–≥—Ä—É–∑–∫–∏.',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'insights_analytics',
      targetId: 'tour-insights-analytics',
      title: 'üìà –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞',
      getText: () => '–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑: –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏, —Ç—Ä–µ–Ω–¥—ã, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤.',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'insights_metabolism',
      targetId: 'tour-insights-metabolism',
      title: 'üî• –ú–µ—Ç–∞–±–æ–ª–∏–∑–º',
      getText: () => '–î–µ—Ç–∞–ª–∏ —ç–Ω–µ—Ä–≥–æ–æ–±–º–µ–Ω–∞: BMR, TDEE, —Ç–µ—Ä–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç –ø–∏—â–∏.',
      position: 'bottom',
      arrow: 'top'
    },
    {
      id: 'insights_timing',
      targetId: 'tour-insights-timing',
      title: '‚è∞ –¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤',
      getText: () => '–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –µ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ —Ä–µ–∂–∏–º–∞.',
      position: 'bottom',
      arrow: 'top'
    }
  ];

  let insightsState = {
    isActive: false,
    currentStepIndex: 0,
    overlayEl: null,
    tooltipEl: null,
    highlightEl: null
  };

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–∏–Ω–∏-—Ç—É—Ä Insights
   */
  function shouldShowInsightsTour() {
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—É—Ä –µ—â—ë –Ω–µ –ø—Ä–æ–π–¥–µ–Ω
    const mainTourCompleted = getStoredFlag(STORAGE_KEY, false);
    if (!mainTourCompleted) return false;

    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –º–∏–Ω–∏-—Ç—É—Ä —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω
    const insightsTourCompleted = getStoredFlag(INSIGHTS_STORAGE_KEY, false);
    if (insightsTourCompleted) return false;

    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É—Ä–∞—Ç–æ—Ä–∞–º
    const isCurator = typeof HEYS.auth?.isCuratorSession === 'function'
      ? HEYS.auth.isCuratorSession()
      : !!HEYS.cloud?.getUser?.();
    if (isCurator) return false;

    return true;
  }

  /**
   * –†–µ–Ω–¥–µ—Ä —à–∞–≥–∞ –º–∏–Ω–∏-—Ç—É—Ä–∞ Insights
   */
  function renderInsightsStep() {
    const step = INSIGHTS_TOUR_STEPS[insightsState.currentStepIndex];
    if (!step) return;

    const target = document.getElementById(step.targetId);
    if (!target) {
      trackTourEvent('insights_tour_target_missing', { targetId: step.targetId });
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
      if (insightsState.currentStepIndex < INSIGHTS_TOUR_STEPS.length - 1) {
        insightsState.currentStepIndex++;
        renderInsightsStep();
      } else {
        InsightsTour.finish();
      }
      return;
    }

    // Scroll to target
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Wait for scroll and render
    setTimeout(() => {
      const rect = target.getBoundingClientRect();

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è overlay/highlight/tooltip
      if (insightsState.overlayEl) insightsState.overlayEl.remove();
      if (insightsState.highlightEl) insightsState.highlightEl.remove();
      if (insightsState.tooltipEl) insightsState.tooltipEl.remove();

      insightsState.overlayEl = createOverlay();
      insightsState.highlightEl = createHighlight(rect);
      insightsState.tooltipEl = createInsightsTooltip(step, rect);

      document.body.appendChild(insightsState.overlayEl);
      document.body.appendChild(insightsState.highlightEl);
      document.body.appendChild(insightsState.tooltipEl);

      // Fade-in –∞–Ω–∏–º–∞—Ü–∏—è ‚Äî –º–µ–Ω—è–µ–º inline opacity –Ω–∞–ø—Ä—è–º—É—é (—Ç.–∫. inline –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç CSS –∫–ª–∞—Å—Å)
      requestAnimationFrame(() => {
        insightsState.tooltipEl.style.opacity = '1';
        insightsState.tooltipEl.style.transform = 'translateY(0)';
      });
    }, 300);
  }

  /**
   * –°–æ–∑–¥–∞—ë–º tooltip –¥–ª—è –º–∏–Ω–∏-—Ç—É—Ä–∞ (—É–∫–æ—Ä–æ—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
   */
  function createInsightsTooltip(step, targetRect) {
    const el = document.createElement('div');
    el.className = 'tour-tooltip tour-tooltip--insights';
    el.style.cssText = `
      position: fixed;
      z-index: 9002;
      background: linear-gradient(135deg, #1e1e2f 0%, #2d2d44 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 14px 18px;
      max-width: 280px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(139, 92, 246, 0.2);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #fff;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.25s ease, transform 0.25s ease;
    `;

    const stepNumber = insightsState.currentStepIndex + 1;
    const totalSteps = INSIGHTS_TOUR_STEPS.length;
    const progress = Math.round((stepNumber / totalSteps) * 100);

    el.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span style="font-size: 13px; font-weight: 600; color: #a78bfa;">${step.title}</span>
        <span style="font-size: 11px; color: #888;">${stepNumber}/${totalSteps}</span>
      </div>
      <div style="font-size: 13px; line-height: 1.4; color: #ddd; margin-bottom: 12px;">
        ${step.getText()}
      </div>
      <div style="background: rgba(139,92,246,0.2); border-radius: 4px; height: 3px; margin-bottom: 12px;">
        <div style="background: #a78bfa; height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.3s ease;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; gap: 8px;">
        <button class="tour-skip-insights" style="
          flex: 1;
          padding: 8px 12px;
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 8px;
          background: transparent;
          color: #aaa;
          font-size: 12px;
          cursor: pointer;
        ">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        <button class="tour-next-insights" style="
          flex: 2;
          padding: 8px 16px;
          border: none;
          border-radius: 8px;
          background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
          color: white;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
        ">${stepNumber === totalSteps ? '‚ú® –ì–æ—Ç–æ–≤–æ' : '–î–∞–ª–µ–µ ‚Üí'}</button>
      </div>
    `;

    // Events
    el.querySelector('.tour-skip-insights').onclick = () => InsightsTour.skip();
    el.querySelector('.tour-next-insights').onclick = () => InsightsTour.next();

    // Position
    const padding = 16;
    let top, left;

    if (step.position === 'bottom') {
      top = targetRect.bottom + padding;
      left = targetRect.left + (targetRect.width / 2) - 140;
    } else {
      top = targetRect.top - 200 - padding;
      left = targetRect.left + (targetRect.width / 2) - 140;
    }

    // Clamp to screen
    left = Math.max(16, Math.min(left, window.innerWidth - 296));
    top = Math.max(16, Math.min(top, window.innerHeight - 220));

    el.style.top = `${top}px`;
    el.style.left = `${left}px`;

    return el;
  }

  const InsightsTour = {
    /**
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–Ω–∏-—Ç—É—Ä Insights
     */
    start() {
      if (insightsState.isActive) return;
      if (!shouldShowInsightsTour()) {
        trackTourEvent('insights_tour_skipped', { reason: 'not_needed' });
        return;
      }

      trackTourEvent('insights_tour_starting', {});
      insightsState.isActive = true;
      insightsState.currentStepIndex = 0;

      // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
      document.body.style.overflow = 'hidden';

      // üîß v1.16 FIX: –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è PWA –±–∞–Ω–Ω–µ—Ä–∞ (–∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ç—É—Ä–µ)
      document.body.classList.add('tour-active');

      triggerHaptic();
      renderInsightsStep();

      // Analytics
      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('insights_tour_started');
      }
    },

    /**
     * –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
     */
    next() {
      if (!insightsState.isActive) return;

      triggerHaptic();

      if (insightsState.currentStepIndex < INSIGHTS_TOUR_STEPS.length - 1) {
        insightsState.currentStepIndex++;
        renderInsightsStep();
      } else {
        InsightsTour.finish();
      }
    },

    /**
     * –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—É—Ä
     */
    skip() {
      trackTourEvent('insights_tour_skipped', { reason: 'user' });
      InsightsTour.cleanup();

      // üîß v1.12 FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –û–ë–ê –º–µ—Å—Ç–∞
      if (HEYS.store?.set) {
        HEYS.store.set(INSIGHTS_STORAGE_KEY, true);
      }
      // –í–°–ï–ì–î–ê —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ unscoped localStorage
      localStorage.setItem(INSIGHTS_STORAGE_KEY, 'true');

      // Dispatch —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      window.dispatchEvent(new Event('storage'));

      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('insights_tour_skipped', {
          step: insightsState.currentStepIndex
        });
      }
    },

    /**
     * –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä
     */
    finish() {
      trackTourEvent('insights_tour_completed', {});
      InsightsTour.cleanup();

      // üîß v1.12 FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –û–ë–ê –º–µ—Å—Ç–∞:
      // 1. HEYS.store (scoped —Å clientId) ‚Äî –¥–ª—è cloud sync
      // 2. localStorage –Ω–∞–ø—Ä—è–º—É—é (unscoped) ‚Äî –¥–ª—è React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é
      if (HEYS.store?.set) {
        HEYS.store.set(INSIGHTS_STORAGE_KEY, true);
      }
      // –í–°–ï–ì–î–ê —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ unscoped localStorage –¥–ª—è React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      localStorage.setItem(INSIGHTS_STORAGE_KEY, 'true');

      trackTourEvent('insights_tour_saved', { key: INSIGHTS_STORAGE_KEY });

      // üîß v1.17 FIX: –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–≤–µ—Ä—Ö —á—Ç–æ–±—ã –±—ã–ª–∞ –≤–∏–¥–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞ "3 –¥–Ω—è"
      setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        trackTourEvent('insights_tour_scrolled_top', {});
      }, 100);

      // Dispatch —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      window.dispatchEvent(new Event('storage'));

      triggerHaptic();

      if (HEYS.analytics) {
        HEYS.analytics.trackEvent('insights_tour_completed');
      }

      // –ù–µ–±–æ–ª—å—à–æ–π –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      if (HEYS.game?.celebrate) {
        HEYS.game.celebrate();
      }

      // üîß v1.19: WidgetsTour –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –≤–∏–¥–∂–µ—Ç–æ–≤
      // (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ InsightsTour –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ insights)
      // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —É–±—Ä–∞–Ω ‚Äî —Ç—É—Ä —Ç–µ–ø–µ—Ä—å —Å—Ç–∞—Ä—Ç—É–µ—Ç –≤ WidgetsTab useEffect
      trackTourEvent('insights_tour_next_widgets_hint', {});
    },

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å DOM
     */
    cleanup() {
      if (insightsState.overlayEl) insightsState.overlayEl.remove();
      if (insightsState.highlightEl) insightsState.highlightEl.remove();
      if (insightsState.tooltipEl) insightsState.tooltipEl.remove();

      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
      document.body.style.overflow = '';

      // üîß v1.16 FIX: –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å —Å–∫—Ä—ã—Ç–∏—è PWA –±–∞–Ω–Ω–µ—Ä–∞
      document.body.classList.remove('tour-active');

      insightsState.overlayEl = null;
      insightsState.highlightEl = null;
      insightsState.tooltipEl = null;
      insightsState.isActive = false;
    },

    /**
     * –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –º–∏–Ω–∏-—Ç—É—Ä
     */
    isActive() {
      return insightsState.isActive;
    },

    /**
     * –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
     */
    reset() {
      if (HEYS.store?.set) {
        HEYS.store.set(INSIGHTS_STORAGE_KEY, false);
      } else {
        localStorage.removeItem(INSIGHTS_STORAGE_KEY);
      }
      trackTourEvent('insights_tour_reset', {});
    },

    /**
     * –ù—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç—É—Ä
     */
    shouldShow: shouldShowInsightsTour
  };

  HEYS.OnboardingTour = OnboardingTour;
  HEYS.InsightsTour = InsightsTour;

  // =========================================================================
  // 4. WIDGETS TOUR (–ú–∏–Ω–∏-—Ç—É—Ä –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –≤–∏–¥–∂–µ—Ç–æ–≤)
  // =========================================================================

  const WIDGETS_TOUR_ID = 'widgets_tour_v1';
  const WIDGETS_STORAGE_KEY = 'heys_widgets_tour_completed';

  /**
   * –®–∞–≥–∏ –¥–µ–º–æ-–æ–±–∑–æ—Ä–∞ –≤–∏–¥–∂–µ—Ç–æ–≤ (–î–û —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
   * –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ –∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º–∏
   */
  const WIDGETS_DEMO_STEPS = [
    {
      id: 'demo_intro',
      targetSelector: '.widgets-grid',
      title: 'üìä –í–∞—à–∞ –ø–∞–Ω–µ–ª—å –≤–∏–¥–∂–µ—Ç–æ–≤',
      getText: () => '–≠—Ç–æ –≤–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å. –ó–¥–µ—Å—å –≤—ã –≤–∏–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–Ω—è.',
      demoData: 'üéØ –ö–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
      position: 'bottom',
      arrow: 'top',
      isDemo: true
    },
    {
      id: 'demo_calories',
      targetSelector: '[data-widget-type="calories"]',
      title: 'üî• –ö–∞–ª–æ—Ä–∏–∏',
      getText: () => '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à—É —Ü–µ–ª—å –Ω–∞ –¥–µ–Ω—å –∏ —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å.',
      demoData: 'üìä –ù–∞–ø—Ä–∏–º–µ—Ä: 750 –∏–∑ 2000 –∫–∫–∞–ª ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å 1250 –∫–∫–∞–ª',
      position: 'bottom',
      arrow: 'top',
      isDemo: true
    },
    {
      id: 'demo_water',
      targetSelector: '[data-widget-type="water"]',
      title: 'üíß –í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å',
      getText: () => '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—ã–ø–∏—Ç—É—é –≤–æ–¥—É –∑–∞ –¥–µ–Ω—å.',
      demoData: 'üíß –ù–∞–ø—Ä–∏–º–µ—Ä: 1.2 –ª –∏–∑ 2.5 –ª ‚Äî –µ—â—ë 5 —Å—Ç–∞–∫–∞–Ω–æ–≤',
      position: 'bottom',
      arrow: 'top',
      isDemo: true
    },
    {
      id: 'demo_weight',
      targetSelector: '[data-widget-type="weight"]',
      title: '‚öñÔ∏è –í–µ—Å –∏ —Ç—Ä–µ–Ω–¥',
      getText: () => '–¢–µ–∫—É—â–∏–π –≤–µ—Å, BMI –∏ –¥–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é.',
      demoData: '‚öñÔ∏è –ù–∞–ø—Ä–∏–º–µ—Ä: 72.3 –∫–≥, BMI 23.5, ‚Üì0.5 –∫–≥ –∑–∞ –Ω–µ–¥–µ–ª—é',
      position: 'bottom',
      arrow: 'top',
      isDemo: true
    },
    {
      id: 'demo_heatmap',
      targetSelector: '[data-widget-type="heatmap"]',
      title: 'üìÖ –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞',
      getText: () => '–¶–≤–µ—Ç–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è: üü¢ –Ω–æ—Ä–º–∞, üü° –Ω–µ–±–æ–ª—å—à–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, üî¥ —Å—Ä—ã–≤.',
      demoData: 'üìÖ –í–∏–¥–∏—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º —á–∞—â–µ –∂—ë–ª—Ç—ã–µ –¥–Ω–∏?',
      position: 'top',
      arrow: 'bottom',
      isDemo: true
    },
    {
      id: 'demo_crashRisk',
      targetSelector: '[data-widget-type="crashRisk"]',
      title: '‚ö†Ô∏è –†–∏—Å–∫ —Å—Ä—ã–≤–∞',
      getText: () => '–ò–ò –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ —Ä–∏—Å–∫–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è –∑–∞—Ä–∞–Ω–µ–µ.',
      demoData: 'ü§ñ –ù–∞–ø—Ä–∏–º–µ—Ä: –†–∏—Å–∫ 65% ‚Äî –º–∞–ª–æ —Å–Ω–∞ + —Å—Ç—Ä–µ—Å—Å',
      position: 'bottom',
      arrow: 'top',
      isDemo: true
    }
  ];

  /**
   * –®–∞–≥–∏ –º–∏–Ω–∏-—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤ (–ü–û–°–õ–ï –¥–µ–º–æ-–æ–±–∑–æ—Ä–∞)
   */
  const WIDGETS_EDIT_STEPS = [
    {
      id: 'widgets_edit',
      targetId: 'tour-widgets-edit',
      title: '‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
      getText: () => '–ù–∞–∂–º–∏—Ç–µ —ç—Ç—É –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤',
      position: 'top',
      arrow: 'bottom',
      requiresEditMode: true
    },
    {
      id: 'widgets_add',
      targetId: 'tour-widgets-add',
      title: '‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤',
      getText: () => '–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã –¥–ª—è –≤–∞—à–µ–π –ø–∞–Ω–µ–ª–∏',
      position: 'top',
      arrow: 'bottom',
      requiresEditMode: true
    },
    {
      id: 'widgets_size',
      targetId: 'tour-widgets-size',
      title: 'üìê –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞',
      getText: () => '–ü–æ—Ç—è–Ω–∏—Ç–µ –∑–∞ —É–≥–æ–ª –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –±–µ–π–¥–∂ —Ä–∞–∑–º–µ—Ä–∞. –ë–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä ‚Äî –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!',
      position: 'bottom',
      arrow: 'top',
      requiresEditMode: true
    },
    {
      id: 'widgets_settings',
      targetId: 'tour-widgets-settings',
      title: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞',
      getText: () => '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–∂–µ—Ç–∞ –ø–æ–¥ —Å–µ–±—è',
      position: 'bottom',
      arrow: 'top',
      requiresEditMode: true
    },
    {
      id: 'widgets_delete',
      targetId: 'tour-widgets-delete',
      title: 'üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤',
      getText: () => '–£–±–µ—Ä–∏—Ç–µ –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã ‚Äî –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞',
      position: 'bottom',
      arrow: 'top',
      requiresEditMode: true
    }
  ];

  /**
   * –í—Å–µ —à–∞–≥–∏ —Ç—É—Ä–∞ –≤–∏–¥–∂–µ—Ç–æ–≤ (–¥–µ–º–æ + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
   */
  const WIDGETS_TOUR_STEPS = [...WIDGETS_DEMO_STEPS, ...WIDGETS_EDIT_STEPS];

  /**
   * –°—Ç–µ–π—Ç –º–∏–Ω–∏-—Ç—É—Ä–∞ –≤–∏–¥–∂–µ—Ç–æ–≤
   */
  const widgetsState = {
    isActive: false,
    currentStepIndex: 0,
    overlayEl: null,
    tooltipEl: null,
    highlightEl: null,
    wasEditModeActive: false // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ edit mode
  };

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –º–∏–Ω–∏-—Ç—É—Ä –≤–∏–¥–∂–µ—Ç–æ–≤
   */
  function shouldShowWidgetsTour() {
    // –ì–ª–∞–≤–Ω—ã–π —Ç—É—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–π–¥–µ–Ω
    const mainCompleted = getStoredFlag(STORAGE_KEY, false);
    if (!mainCompleted) return false;

    // –¢—É—Ä –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω
    const widgetsCompleted = getStoredFlag(WIDGETS_STORAGE_KEY, false);
    if (widgetsCompleted) return false;

    // –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if (typeof HEYS.auth?.isCuratorSession === 'function') {
      if (HEYS.auth.isCuratorSession()) return false;
    } else if (HEYS.user?.isCurator?.()) {
      return false;
    }

    return true;
  }

  /**
   * –†–µ–Ω–¥–µ—Ä —à–∞–≥–∞ —Ç—É—Ä–∞ –≤–∏–¥–∂–µ—Ç–æ–≤
   */
  function renderWidgetsStep(stepIndex) {
    const step = WIDGETS_TOUR_STEPS[stepIndex];
    if (!step) return;

    // –ï—Å–ª–∏ —ç—Ç–æ edit step –∏ –º—ã –µ—â–µ –Ω–µ –≤ edit mode - –≤—Ö–æ–¥–∏–º
    if (step.requiresEditMode && !HEYS.Widgets?.isEditMode?.()) {
      trackTourEvent('widgets_tour_enter_edit_mode', {});
      if (HEYS.Widgets?.enterEditMode) {
        HEYS.Widgets.enterEditMode();
        // –î–∞–µ–º DOM –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ edit mode
        setTimeout(() => renderWidgetsStep(stepIndex), 150);
        return;
      }
    }

    // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç: –ø–æ selector (–¥–ª—è demo) –∏–ª–∏ –ø–æ id (–¥–ª—è edit)
    let targetEl;
    if (step.targetSelector) {
      targetEl = document.querySelector(step.targetSelector);
    } else if (step.targetId) {
      targetEl = document.getElementById(step.targetId);
    }

    if (!targetEl) {
      trackTourEvent('widgets_tour_target_missing', { targetId: step.targetSelector || step.targetId });
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
      if (stepIndex < WIDGETS_TOUR_STEPS.length - 1) {
        widgetsState.currentStepIndex++;
        renderWidgetsStep(widgetsState.currentStepIndex);
      } else {
        WidgetsTour.finish();
      }
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º overlay (—Å–æ–∑–¥–∞—ë–º —Å—Ä–∞–∑—É)
    if (!widgetsState.overlayEl) {
      widgetsState.overlayEl = document.createElement('div');
      widgetsState.overlayEl.className = 'tour-overlay tour-overlay--mini';
      document.body.appendChild(widgetsState.overlayEl);
    }

    // Highlight (—Å–æ–∑–¥–∞—ë–º —Å—Ä–∞–∑—É)
    if (!widgetsState.highlightEl) {
      widgetsState.highlightEl = document.createElement('div');
      widgetsState.highlightEl.className = 'tour-highlight';
      document.body.appendChild(widgetsState.highlightEl);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Ö–∞–π–ª–∞–π—Ç–∞ –∏ —Ç—É–ª—Ç–∏–ø–∞
    const updateHighlightPosition = () => {
      const rect = targetEl.getBoundingClientRect();
      const padding = 8;
      widgetsState.highlightEl.style.cssText = `
        position: fixed;
        top: ${rect.top - padding}px;
        left: ${rect.left - padding}px;
        width: ${rect.width + padding * 2}px;
        height: ${rect.height + padding * 2}px;
        border-radius: 8px;
        z-index: 9001;
        box-shadow: 0 0 0 9999px rgba(0,0,0,0.65);
        pointer-events: none;
      `;

      // Tooltip
      if (widgetsState.tooltipEl) widgetsState.tooltipEl.remove();
      widgetsState.tooltipEl = createWidgetsTooltip(step, stepIndex, rect);
      document.body.appendChild(widgetsState.tooltipEl);
    };

    // Scroll to element –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Å—Ä–∞–∑—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
    updateHighlightPosition();

    // –ò –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è smooth scroll (300-500ms)
    setTimeout(updateHighlightPosition, 350);
  }

  /**
   * –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É–ª—Ç–∏–ø–∞ –¥–ª—è —Ç—É—Ä–∞ –≤–∏–¥–∂–µ—Ç–æ–≤ (–±–∏—Ä—é–∑–æ–≤–∞—è —Ç–µ–º–∞)
   */
  function createWidgetsTooltip(step, stepIndex, targetRect) {
    const tooltip = document.createElement('div');
    // –°—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º tour-tooltip-enter –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ (–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è)
    tooltip.className = 'tour-tooltip tour-tooltip--mini tour-tooltip-enter';

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–∑—É —Ç—É—Ä–∞ (demo –∏–ª–∏ edit)
    const isDemo = step.isDemo === true;
    const demoStepsCount = WIDGETS_DEMO_STEPS.length;
    const editStepsCount = WIDGETS_EDIT_STEPS.length;

    // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–∑—ã
    let phaseLabel, phaseProgress;
    if (isDemo) {
      phaseLabel = 'üëÄ –û–±–∑–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤';
      phaseProgress = `${stepIndex + 1}/${demoStepsCount}`;
    } else {
      const editStepIndex = stepIndex - demoStepsCount;
      phaseLabel = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞';
      phaseProgress = `${editStepIndex + 1}/${editStepsCount}`;
    }

    const totalProgress = `${stepIndex + 1}/${WIDGETS_TOUR_STEPS.length}`;
    const isLast = stepIndex === WIDGETS_TOUR_STEPS.length - 1;

    // –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã
    const bgGradient = isDemo
      ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è demo
      : 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)'; // –±–∏—Ä—é–∑–æ–≤—ã–π –¥–ª—è edit
    const shadowColor = isDemo ? 'rgba(139, 92, 246, 0.3)' : 'rgba(6, 182, 212, 0.3)';
    const btnColor = isDemo ? '#7c3aed' : '#0891b2';

    // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const demoDataHtml = step.demoData
      ? `<div style="margin-top: 8px; padding: 8px 10px; background: rgba(255,255,255,0.15); border-radius: 8px; font-size: 12px; line-height: 1.4;">
          ${step.demoData}
        </div>`
      : '';

    tooltip.innerHTML = `
      <div style="background: ${bgGradient}; color: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 8px 32px ${shadowColor}; min-width: 220px; max-width: 280px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span style="font-size: 11px; opacity: 0.85;">${phaseLabel} ${phaseProgress}</span>
        </div>
        <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px;">${step.title}</div>
        <div style="font-size: 13px; opacity: 0.95; line-height: 1.4; max-height: 80px; overflow-y: auto;">${step.getText()}</div>
        ${demoDataHtml}
        <div style="display: flex; gap: 8px; margin-top: 12px; flex-shrink: 0;">
          <button class="widgets-tour-skip" style="flex: 1; padding: 8px 12px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: white; border-radius: 8px; cursor: pointer; font-size: 12px;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          <button class="widgets-tour-next" style="flex: 1; padding: 8px 12px; border: none; background: white; color: ${btnColor}; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">${isLast ? '–ì–æ—Ç–æ–≤–æ!' : '–î–∞–ª–µ–µ ‚Üí'}</button>
        </div>
        <div style="margin-top: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; height: 3px; overflow: hidden; flex-shrink: 0;">
          <div style="background: white; height: 100%; width: ${((stepIndex + 1) / WIDGETS_TOUR_STEPS.length) * 100}%; transition: width 0.3s;"></div>
        </div>
      </div>
    `;

    // Position
    const tooltipWidth = 280;
    const tooltipHeight = 220; // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Ç—É–ª—Ç–∏–ø–∞
    const gap = 12;
    let top, left;

    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ step.position
    if (step.position === 'top') {
      top = targetRect.top - gap - tooltipHeight;
      left = targetRect.left + targetRect.width / 2 - tooltipWidth / 2;
    } else {
      top = targetRect.bottom + gap;
      left = targetRect.left + targetRect.width / 2 - tooltipWidth / 2;
    }

    // Constrain to viewport
    left = Math.max(16, Math.min(left, window.innerWidth - tooltipWidth - 16));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É ‚Äî –µ—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ viewport, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞–≤–µ—Ä—Ö
    if (top + tooltipHeight > window.innerHeight - 16) {
      top = targetRect.top - gap - tooltipHeight;
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É
    top = Math.max(16, top);

    tooltip.style.cssText = `
      position: fixed;
      top: ${top}px;
      left: ${left}px;
      z-index: 9002;
    `;

    // Event listeners
    tooltip.querySelector('.widgets-tour-skip').onclick = () => WidgetsTour.skip();
    tooltip.querySelector('.widgets-tour-next').onclick = () => WidgetsTour.next();

    return tooltip;
  }

  /**
   * WidgetsTour API
   */
  const WidgetsTour = {
    /**
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–Ω–∏-—Ç—É—Ä –≤–∏–¥–∂–µ—Ç–æ–≤
     */
    start() {
      if (!shouldShowWidgetsTour()) {
        trackTourEvent('widgets_tour_skipped', { reason: 'not_ready' });
        return false;
      }

      trackTourEvent('widgets_tour_starting', {});
      widgetsState.isActive = true;
      widgetsState.currentStepIndex = 0;

      // üîß v1.19 FIX: –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É widgets, —á—Ç–æ–±—ã –≤–∏–¥–∂–µ—Ç—ã –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏–ª–∏—Å—å
      const currentTab = window.HEYS?.App?.getTab?.();
      if (currentTab !== 'widgets') {
        trackTourEvent('widgets_tour_switch_tab', { currentTab });
        if (window.HEYS?.App?.setTab) {
          window.HEYS.App.setTab('widgets');
          // –ñ–¥—ë–º –ø–æ–∫–∞ –≤–∏–¥–∂–µ—Ç—ã –æ—Ç—Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è (300ms –¥–ª—è React re-render)
          setTimeout(() => {
            this._startInternal();
          }, 400);
          return true;
        }
      }

      // –ï—Å–ª–∏ —É–∂–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ widgets - —Å—Ç–∞—Ä—Ç—É–µ–º —Å—Ä–∞–∑—É
      this._startInternal();
      return true;
    },

    /**
     * –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏
     */
    _startInternal() {
      trackTourEvent('widgets_tour_start_internal', {});

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ edit mode (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ)
      widgetsState.wasEditModeActive = HEYS.Widgets?.isEditMode?.() || false;

      // –ù–ï –≤—Ö–æ–¥–∏–º –≤ edit mode —Å—Ä–∞–∑—É - —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º demo —à–∞–≥–∏
      // Edit mode –≤–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–≥–¥–∞ –¥–æ–π–¥—ë–º –¥–æ —à–∞–≥–æ–≤ —Å requiresEditMode: true

      // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
      document.body.style.overflow = 'hidden';
      document.body.classList.add('tour-active');

      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏
      setTimeout(() => {
        renderWidgetsStep(0);
      }, 150);
    },

    /**
     * –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
     */
    next() {
      if (!widgetsState.isActive) return;

      if (widgetsState.currentStepIndex < WIDGETS_TOUR_STEPS.length - 1) {
        widgetsState.currentStepIndex++;
        renderWidgetsStep(widgetsState.currentStepIndex);
      } else {
        this.finish();
      }
    },

    /**
     * –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—É—Ä
     */
    skip() {
      trackTourEvent('widgets_tour_skipped', { reason: 'user' });

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥
      if (HEYS.store?.set) {
        HEYS.store.set(WIDGETS_STORAGE_KEY, true);
      }
      localStorage.setItem(WIDGETS_STORAGE_KEY, 'true');

      this.cleanup();
    },

    /**
     * –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä
     */
    finish() {
      trackTourEvent('widgets_tour_completed', {});

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥
      if (HEYS.store?.set) {
        HEYS.store.set(WIDGETS_STORAGE_KEY, true);
      }
      localStorage.setItem(WIDGETS_STORAGE_KEY, 'true');

      this.cleanup();

      // –ü—Ä–∞–∑–¥–Ω—É–µ–º
      if (HEYS.game?.celebrate) {
        HEYS.game.celebrate();
      }
    },

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å DOM
     */
    cleanup() {
      if (widgetsState.overlayEl) widgetsState.overlayEl.remove();
      if (widgetsState.highlightEl) widgetsState.highlightEl.remove();
      if (widgetsState.tooltipEl) widgetsState.tooltipEl.remove();

      document.body.style.overflow = '';
      document.body.classList.remove('tour-active');

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ edit mode
      if (!widgetsState.wasEditModeActive && HEYS.Widgets?.isEditMode?.()) {
        trackTourEvent('widgets_tour_restore_edit_mode', {});
        HEYS.Widgets.exitEditMode?.();
      }

      widgetsState.overlayEl = null;
      widgetsState.highlightEl = null;
      widgetsState.tooltipEl = null;
      widgetsState.isActive = false;
      widgetsState.wasEditModeActive = false;
    },

    /**
     * –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç—É—Ä
     */
    isActive() {
      return widgetsState.isActive;
    },

    /**
     * –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
     */
    reset() {
      if (HEYS.store?.set) {
        HEYS.store.set(WIDGETS_STORAGE_KEY, false);
      }
      // ALWAYS remove localStorage key (in case it was set directly)
      localStorage.removeItem(WIDGETS_STORAGE_KEY);

      trackTourEvent('widgets_tour_reset', {});
    },

    /**
     * –ù—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç—É—Ä
     */
    shouldShow: shouldShowWidgetsTour
  };

  HEYS.WidgetsTour = WidgetsTour;

})(window);


/* ===== heys_app_hooks_v1.js ===== */
// heys_app_hooks_v1.js ‚Äî App hooks extracted from heys_app_v12.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const U = HEYS.utils || {};

    const tryParseStoredValue = (raw, fallback) => {
        if (raw === null || raw === undefined) return fallback;
        if (typeof raw === 'string') {
            let str = raw;
            if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                try { str = HEYS.store.decompress(str); } catch (_) { }
            }
            try { return JSON.parse(str); } catch (_) { return str; }
        }
        return raw;
    };

    const readStoredValue = (key, fallback) => {
        try {
            if (HEYS.store?.get) {
                const stored = HEYS.store.get(key, null);
                if (stored !== null && stored !== undefined) {
                    return tryParseStoredValue(stored, fallback);
                }
            }
            if (U.lsGet) {
                const legacy = U.lsGet(key, fallback);
                if (legacy !== null && legacy !== undefined) return legacy;
            }
            const raw = localStorage.getItem(key);
            return tryParseStoredValue(raw, fallback);
        } catch {
            return fallback;
        }
    };

    const readGlobalValue = (key, fallback) => {
        try {
            if (HEYS.store?.get) {
                const stored = HEYS.store.get(key, null);
                if (stored !== null && stored !== undefined) {
                    return tryParseStoredValue(stored, fallback);
                }
            }
            const raw = localStorage.getItem(key);
            if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
            if (U.lsGet) return U.lsGet(key, fallback);
            return fallback;
        } catch {
            return fallback;
        }
    };

    const writeStoredValue = (key, value) => {
        try {
            if (HEYS.store?.set) {
                HEYS.store.set(key, value);
                return;
            }
            if (U.lsSet) {
                U.lsSet(key, value);
                return;
            }
            const serialized = typeof value === 'string' ? value : JSON.stringify(value);
            localStorage.setItem(key, serialized);
        } catch { }
    };

    const writeGlobalValue = (key, value) => {
        try {
            if (HEYS.store?.set) {
                HEYS.store.set(key, value);
                return;
            }
            const serialized = typeof value === 'string' ? value : JSON.stringify(value);
            localStorage.setItem(key, serialized);
        } catch { }
    };

    const removeGlobalValue = (key) => {
        try {
            if (HEYS.store?.set) HEYS.store.set(key, null);
        } catch { }
        try { localStorage.removeItem(key); } catch { }
    };

    // NET Atwater migration: recompute kcal100 = 3√ó–ë + 4√ó–£ + 9√ó–ñ
    // Fixes product list saved with old protein√ó4 formula (v3.9.0 regression)
    const migrateProductsKcalNetAtwater = (list) => {
        if (!Array.isArray(list) || list.length === 0) return list;
        const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
        const round1 = (v) => Math.round(v * 10) / 10;
        let changed = 0;
        const result = list.map((p) => {
            if (!p || p._kcalNetAtwater) return p;
            const carbs = p.carbs100 != null
                ? toNum(p.carbs100)
                : toNum(p.simple100) + toNum(p.complex100);
            const fat = p.fat100 != null
                ? toNum(p.fat100)
                : toNum(p.badFat100) + toNum(p.goodFat100) + toNum(p.trans100);
            const newKcal = round1(3 * toNum(p.protein100) + 4 * carbs + 9 * fat);
            if (newKcal !== toNum(p.kcal100)) changed++;
            return { ...p, kcal100: newKcal, _kcalNetAtwater: true };
        });
        if (changed > 0) {
            console.info('[HEYS.migration] ‚úÖ NET Atwater kcal migration:', { changed, total: list.length });
        }
        return result;
    };

    function useThemePreference() {
        const React = window.React;
        const { useState, useEffect, useMemo, useCallback } = React;
        const [theme, setTheme] = useState(() => {
            try {
                const saved = readGlobalValue('heys_theme', 'light');
                return ['light', 'dark', 'auto'].includes(saved) ? saved : 'light';
            } catch {
                return 'light';
            }
        });

        const resolvedTheme = useMemo(() => {
            if (theme === 'auto') {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            return theme;
        }, [theme]);

        useEffect(() => {
            document.documentElement.setAttribute('data-theme', resolvedTheme);
            try {
                writeGlobalValue('heys_theme', theme);
            } catch { }

            if (theme !== 'auto') return;

            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            const handler = () => {
                document.documentElement.setAttribute('data-theme', mq.matches ? 'dark' : 'light');
            };
            mq.addEventListener('change', handler);
            return () => mq.removeEventListener('change', handler);
        }, [theme, resolvedTheme]);

        const cycleTheme = useCallback(() => {
            setTheme(prev => prev === 'light' ? 'dark' : prev === 'dark' ? 'auto' : 'light');
        }, []);

        return { theme, resolvedTheme, cycleTheme };
    }

    function usePwaPrompts() {
        const React = window.React;
        const { useState, useEffect, useMemo, useCallback } = React;
        const [pwaInstallPrompt, setPwaInstallPrompt] = useState(null);
        const [showPwaBanner, setShowPwaBanner] = useState(false);
        const [showIosPwaBanner, setShowIosPwaBanner] = useState(false);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º iOS Safari
        const isIosSafari = useMemo(() => {
            const ua = navigator.userAgent || '';
            const isIos = /iPhone|iPad|iPod/.test(ua);
            const isWebkit = /WebKit/.test(ua);
            const isChrome = /CriOS/.test(ua);
            const isFirefox = /FxiOS/.test(ua);
            // iOS Safari = iOS + WebKit + –Ω–µ Chrome + –Ω–µ Firefox
            return isIos && isWebkit && !isChrome && !isFirefox;
        }, []);

        // –°–ª—É—à–∞–µ–º beforeinstallprompt —Å–æ–±—ã—Ç–∏–µ (Android/Desktop)
        useEffect(() => {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true;
            if (isStandalone) return;

            const dismissed = readGlobalValue('heys_pwa_banner_dismissed', null);
            if (dismissed) {
                const dismissedTime = parseInt(dismissed, 10);
                if (Date.now() - dismissedTime < 7 * 24 * 60 * 60 * 1000) return;
            }

            if (isIosSafari) {
                setTimeout(() => setShowIosPwaBanner(true), 3000);
                return;
            }

            const handler = (e) => {
                e.preventDefault();
                setPwaInstallPrompt(e);
                setTimeout(() => setShowPwaBanner(true), 3000);
            };

            window.addEventListener('beforeinstallprompt', handler);
            return () => window.removeEventListener('beforeinstallprompt', handler);
        }, [isIosSafari]);

        const handlePwaInstall = useCallback(async () => {
            if (!pwaInstallPrompt) return;
            pwaInstallPrompt.prompt();
            const { outcome } = await pwaInstallPrompt.userChoice;
            if (outcome === 'accepted') {
                setShowPwaBanner(false);
                writeGlobalValue('heys_pwa_installed', 'true');
            }
            setPwaInstallPrompt(null);
        }, [pwaInstallPrompt]);

        const dismissPwaBanner = useCallback(() => {
            setShowPwaBanner(false);
            writeGlobalValue('heys_pwa_banner_dismissed', Date.now().toString());
        }, []);

        const dismissIosPwaBanner = useCallback(() => {
            setShowIosPwaBanner(false);
            writeGlobalValue('heys_pwa_banner_dismissed', Date.now().toString());
        }, []);

        return { showPwaBanner, showIosPwaBanner, handlePwaInstall, dismissPwaBanner, dismissIosPwaBanner };
    }

    // === üì± Screen Wake Lock API ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ ===
    // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–∞–π–º–µ—Ä –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã, –≥–æ—Ç–æ–≤–∫–∞)
    function useWakeLock() {
        const React = window.React;
        const wakeLockRef = React.useRef(null);
        const [isWakeLockActive, setIsWakeLockActive] = React.useState(false);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        const isSupported = React.useMemo(() => {
            return 'wakeLock' in navigator;
        }, []);

        // –ó–∞–ø—Ä–æ—Å Wake Lock
        const requestWakeLock = React.useCallback(async () => {
            if (!isSupported) {
                console.warn('[WakeLock] Not supported in this browser');
                return false;
            }

            try {
                wakeLockRef.current = await navigator.wakeLock.request('screen');
                setIsWakeLockActive(true);
                console.log('[WakeLock] üîÜ Screen wake lock acquired');

                // –°–ª—É—à–∞–µ–º release (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
                wakeLockRef.current.addEventListener('release', () => {
                    console.log('[WakeLock] Wake lock released');
                    setIsWakeLockActive(false);
                });

                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate(10);

                return true;
            } catch (err) {
                console.warn('[WakeLock] Failed to acquire:', err.message);
                setIsWakeLockActive(false);
                return false;
            }
        }, [isSupported]);

        // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ Wake Lock
        const releaseWakeLock = React.useCallback(async () => {
            if (wakeLockRef.current) {
                try {
                    await wakeLockRef.current.release();
                    wakeLockRef.current = null;
                    setIsWakeLockActive(false);
                    console.log('[WakeLock] üîÖ Screen wake lock released manually');
                } catch (err) {
                    console.warn('[WakeLock] Failed to release:', err.message);
                }
            }
        }, []);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∑–∞–ø—Ä–∞—à–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        React.useEffect(() => {
            if (!isSupported || !isWakeLockActive) return;

            const handleVisibilityChange = async () => {
                if (document.visibilityState === 'visible' && !wakeLockRef.current) {
                    // –ü–µ—Ä–µ–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º wake lock –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                    await requestWakeLock();
                }
            };

            document.addEventListener('visibilitychange', handleVisibilityChange);
            return () => {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
            };
        }, [isSupported, isWakeLockActive, requestWakeLock]);

        // Cleanup –ø—Ä–∏ unmount
        React.useEffect(() => {
            return () => {
                if (wakeLockRef.current) {
                    wakeLockRef.current.release().catch(() => { });
                }
            };
        }, []);

        return {
            isSupported,
            isWakeLockActive,
            requestWakeLock,
            releaseWakeLock
        };
    }

    function useCloudSyncStatus() {
        const React = window.React;
        const { useState, useRef, useCallback, useEffect } = React;
        const [cloudStatus, setCloudStatus] = useState(() => navigator.onLine ? 'idle' : 'offline');
        const [pendingCount, setPendingCount] = useState(0);
        const [pendingDetails, setPendingDetails] = useState({ days: 0, products: 0, profile: 0, other: 0 });
        const [showOfflineBanner, setShowOfflineBanner] = useState(false);
        const [showOnlineBanner, setShowOnlineBanner] = useState(false);
        const [syncProgress, setSyncProgress] = useState({ synced: 0, total: 0 });
        const [retryCountdown, setRetryCountdown] = useState(0);
        // üÜï –í—Ä–µ–º—è –æ—Ñ–ª–∞–π–Ω –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ UX
        const [offlineDuration, setOfflineDuration] = useState(0);
        const offlineStartRef = useRef(null);
        const offlineDurationIntervalRef = useRef(null);

        const cloudSyncTimeoutRef = useRef(null);
        const pendingChangesRef = useRef(false);
        const syncingStartRef = useRef(null);
        const syncedTimeoutRef = useRef(null);
        const syncingDelayTimeoutRef = useRef(null);
        const initialCheckDoneRef = useRef(false);
        const retryIntervalRef = useRef(null);
        // ÔøΩ Debounce –¥–ª—è auth_required toast
        const authErrorShownRef = useRef(false);
        const authErrorTimeoutRef = useRef(null);
        // ÔøΩüîí Cooldown –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ sync ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "syncing" —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        const initialSyncCompletedAtRef = useRef(0);
        const INITIAL_SYNC_COOLDOWN_MS = 3000; // 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ sync –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º syncing

        const MIN_SYNCING_DURATION = 1500;
        const SYNCING_DELAY = 400;

        const showSyncedWithMinDuration = useCallback(() => {
            if (syncedTimeoutRef.current) return;

            const elapsed = syncingStartRef.current ? Date.now() - syncingStartRef.current : 0;
            const remaining = Math.max(0, MIN_SYNCING_DURATION - elapsed);

            syncedTimeoutRef.current = setTimeout(() => {
                syncedTimeoutRef.current = null;
                syncingStartRef.current = null;
                setCloudStatus('synced');
                // –ó–≤—É–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —É–±—Ä–∞–Ω ‚Äî —Ç–µ–ø–µ—Ä—å –∑–≤—É–∫–∏ —Ç–æ–ª—å–∫–æ –≤ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏
                setSyncProgress({ synced: 0, total: 0 });
                if (cloudSyncTimeoutRef.current) clearTimeout(cloudSyncTimeoutRef.current);
                cloudSyncTimeoutRef.current = setTimeout(() => {
                    setCloudStatus('idle');
                }, 2000);
            }, remaining);
        }, []);

        useEffect(() => {
            const handleSyncComplete = () => {
                // ‚ö°Ô∏è –ü–µ—Ä–≤—ã–π heysSyncCompleted –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –¥–æ–ª–∂–µ–Ω —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å UI
                // –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π/–æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–∏–Ω–∫–æ–≤ ‚Äî –∏–Ω–∞—á–µ –º–µ—Ä—Ü–∞–Ω–∏–µ
                const hadPendingWork =
                    syncingStartRef.current ||
                    pendingChangesRef.current ||
                    (syncProgress.total > 0) ||
                    (pendingCount > 0);
                if (!hadPendingWork) {
                    // üîí –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ sync –¥–ª—è cooldown
                    if (!initialSyncCompletedAtRef.current) {
                        initialSyncCompletedAtRef.current = Date.now();
                    }
                    return;
                }

                if (syncingDelayTimeoutRef.current) {
                    clearTimeout(syncingDelayTimeoutRef.current);
                    syncingDelayTimeoutRef.current = null;
                }
                if (cloudSyncTimeoutRef.current) {
                    clearTimeout(cloudSyncTimeoutRef.current);
                    cloudSyncTimeoutRef.current = null;
                }
                pendingChangesRef.current = false;
                if (navigator.onLine) {
                    showSyncedWithMinDuration();
                }
            };

            const handleDataSaved = () => {
                pendingChangesRef.current = true;

                if (!navigator.onLine) {
                    setCloudStatus('offline');
                    return;
                }

                if (syncedTimeoutRef.current) {
                    return;
                }

                // üîí Cooldown: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "syncing" —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ sync
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ –∫–æ–≥–¥–∞ merged –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ
                const timeSinceInitialSync = initialSyncCompletedAtRef.current
                    ? Date.now() - initialSyncCompletedAtRef.current
                    : Infinity;
                if (timeSinceInitialSync < INITIAL_SYNC_COOLDOWN_MS) {
                    // –¢–∏—Ö–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –±–µ–∑ UI-–∏–Ω–¥–∏–∫–∞—Ü–∏–∏
                    return;
                }

                if (cloudSyncTimeoutRef.current) {
                    clearTimeout(cloudSyncTimeoutRef.current);
                    cloudSyncTimeoutRef.current = null;
                }

                if (!syncingStartRef.current) {
                    syncingStartRef.current = Date.now();

                    if (!syncingDelayTimeoutRef.current) {
                        syncingDelayTimeoutRef.current = setTimeout(() => {
                            syncingDelayTimeoutRef.current = null;
                            if (syncingStartRef.current && !syncedTimeoutRef.current) {
                                setCloudStatus('syncing');
                            }
                        }, SYNCING_DELAY);
                    }
                }

                if (!cloudSyncTimeoutRef.current) {
                    cloudSyncTimeoutRef.current = setTimeout(() => {
                        pendingChangesRef.current = false;
                        showSyncedWithMinDuration();
                    }, 5000);
                }
            };

            const handlePendingChange = (e) => {
                const count = e.detail?.count || 0;
                const details = e.detail?.details || { days: 0, products: 0, profile: 0, other: 0 };
                setPendingCount(count);
                setPendingDetails(details);

                if (syncProgress.total > 0 && count < syncProgress.total) {
                    setSyncProgress(prev => ({ ...prev, synced: prev.total - count }));
                }

                if (count > 0 && !navigator.onLine) {
                    setCloudStatus('offline');
                }
            };

            const handleSyncProgress = (e) => {
                const { synced, total } = e.detail || {};
                if (typeof synced === 'number' && typeof total === 'number') {
                    setSyncProgress({ synced, total });
                }
            };

            const handleSyncError = (e) => {
                const code = e.detail?.error;
                const isPersistent = e.detail?.persistent || false;

                if (code === 'auth_required') {
                    setCloudStatus('offline');
                    setRetryCountdown(0);

                    // üî• Debounce: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º toast –∏ –¥–µ–ª–∞–µ–º logout —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –¥–µ–ª–∞–ª–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫
                    if (!authErrorShownRef.current) {
                        authErrorShownRef.current = true;
                        try { HEYS.Toast?.error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥'); } catch (_) { }

                        // üö™ FORCE LOGOUT: Dispatch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
                        window.dispatchEvent(new CustomEvent('heys:force-logout', {
                            detail: { reason: 'auth_required' }
                        }));

                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                        if (authErrorTimeoutRef.current) clearTimeout(authErrorTimeoutRef.current);
                        authErrorTimeoutRef.current = setTimeout(() => {
                            authErrorShownRef.current = false;
                        }, 10000);
                    }
                    return;
                }

                // üî• –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è (persistent), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç
                if (isPersistent) {
                    try { HEYS.Toast?.error(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${code}`) || console.error(`Sync error: ${code}`); } catch (_) { }
                }

                const retryIn = e.detail?.retryIn || 5;
                setCloudStatus('error');
                setRetryCountdown(retryIn);

                if (retryIntervalRef.current) clearInterval(retryIntervalRef.current);
                retryIntervalRef.current = setInterval(() => {
                    setRetryCountdown(prev => {
                        if (prev <= 1) {
                            clearInterval(retryIntervalRef.current);
                            retryIntervalRef.current = null;
                            if (navigator.onLine && window.HEYS?.cloud?.retrySync) {
                                window.HEYS.cloud.retrySync();
                                setCloudStatus('syncing');
                            }
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
            };

            const handleNetworkRestored = (e) => {
                const count = e.detail?.pendingCount || 0;
                if (count > 0) {
                    if (!syncingStartRef.current) {
                        syncingStartRef.current = Date.now();
                    }
                    setCloudStatus('syncing');
                }
            };

            const handleOnline = () => {
                // üÜï –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –æ—Ñ–ª–∞–π–Ω
                if (offlineDurationIntervalRef.current) {
                    clearInterval(offlineDurationIntervalRef.current);
                    offlineDurationIntervalRef.current = null;
                }
                const wasOfflineFor = offlineStartRef.current ? Math.floor((Date.now() - offlineStartRef.current) / 1000) : 0;
                offlineStartRef.current = null;
                setOfflineDuration(0);

                setShowOfflineBanner(false);
                setShowOnlineBanner(true);

                // üÜï Haptic feedback –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏
                if ('vibrate' in navigator) {
                    navigator.vibrate([50, 30, 50]); // –î–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–±—Ä–æ ‚Äî "–≤—Å—ë –æ–∫"
                }

                setTimeout(() => setShowOnlineBanner(false), 2000);

                if (pendingChangesRef.current || pendingCount > 0) {
                    if (!syncingStartRef.current) {
                        syncingStartRef.current = Date.now();
                    }
                    setCloudStatus('syncing');
                    if (cloudSyncTimeoutRef.current) clearTimeout(cloudSyncTimeoutRef.current);
                    cloudSyncTimeoutRef.current = setTimeout(() => {
                        pendingChangesRef.current = false;
                        showSyncedWithMinDuration();
                    }, 2000);
                } else {
                    setCloudStatus('idle');
                }

                // üÜï –õ–æ–≥–∏—Ä—É–µ–º –≤—Ä–µ–º—è –æ—Ñ–ª–∞–π–Ω –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                if (wasOfflineFor > 5 && window.HEYS?.analytics?.trackDataOperation) {
                    window.HEYS.analytics.trackDataOperation('offline_session', 1, wasOfflineFor * 1000);
                }
            };

            const handleOffline = () => {
                // üÜï –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä –æ—Ñ–ª–∞–π–Ω
                offlineStartRef.current = Date.now();
                setOfflineDuration(0);

                // –û–±–Ω–æ–≤–ª—è—Ç—å –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                if (offlineDurationIntervalRef.current) {
                    clearInterval(offlineDurationIntervalRef.current);
                }
                offlineDurationIntervalRef.current = setInterval(() => {
                    if (offlineStartRef.current) {
                        setOfflineDuration(Math.floor((Date.now() - offlineStartRef.current) / 1000));
                    }
                }, 1000);

                setShowOfflineBanner(true);
                setCloudStatus('offline');

                // üÜï Haptic feedback –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏
                if ('vibrate' in navigator) {
                    navigator.vibrate(100); // –û–¥–Ω–∞ –¥–ª–∏–Ω–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è ‚Äî –≤–Ω–∏–º–∞–Ω–∏–µ
                }

                // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –æ–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∫–æ–≥–¥–∞ —Å–≤—è–∑—å –≤–µ—Ä–Ω—ë—Ç—Å—è
            };

            window.addEventListener('heysSyncCompleted', handleSyncComplete);
            window.addEventListener('heys:data-uploaded', handleSyncComplete);
            window.addEventListener('heys:data-saved', handleDataSaved);
            window.addEventListener('heys:pending-change', handlePendingChange);
            window.addEventListener('heys:network-restored', handleNetworkRestored);
            window.addEventListener('heys:sync-progress', handleSyncProgress);
            window.addEventListener('heys:sync-error', handleSyncError);
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);

            if (!initialCheckDoneRef.current) {
                initialCheckDoneRef.current = true;
                if (!navigator.onLine) {
                    setCloudStatus('offline');
                    setShowOfflineBanner(true);
                    setTimeout(() => setShowOfflineBanner(false), 3000);
                } else {
                    setCloudStatus('idle');
                }
            }

            if (window.HEYS?.cloud?.getPendingCount) {
                setPendingCount(window.HEYS.cloud.getPendingCount());
            }
            if (window.HEYS?.cloud?.getPendingDetails) {
                setPendingDetails(window.HEYS.cloud.getPendingDetails());
            }

            return () => {
                window.removeEventListener('heysSyncCompleted', handleSyncComplete);
                window.removeEventListener('heys:data-uploaded', handleSyncComplete);
                window.removeEventListener('heys:data-saved', handleDataSaved);
                window.removeEventListener('heys:pending-change', handlePendingChange);
                window.removeEventListener('heys:network-restored', handleNetworkRestored);
                window.removeEventListener('heys:sync-progress', handleSyncProgress);
                window.removeEventListener('heys:sync-error', handleSyncError);
                window.removeEventListener('online', handleOnline);
                window.removeEventListener('offline', handleOffline);
                if (cloudSyncTimeoutRef.current) clearTimeout(cloudSyncTimeoutRef.current);
                if (retryIntervalRef.current) clearInterval(retryIntervalRef.current);
                // üÜï –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –æ—Ñ–ª–∞–π–Ω
                if (offlineDurationIntervalRef.current) clearInterval(offlineDurationIntervalRef.current);
                // üî• –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ auth error debounce
                if (authErrorTimeoutRef.current) clearTimeout(authErrorTimeoutRef.current);
            };
        }, [pendingCount, showSyncedWithMinDuration, syncProgress.total]);

        const handleRetrySync = useCallback(() => {
            if (window.HEYS?.cloud?.retrySync) {
                window.HEYS.cloud.retrySync();
                syncingStartRef.current = Date.now();
                setCloudStatus('syncing');
            }
        }, []);

        return {
            cloudStatus,
            pendingCount,
            pendingDetails,
            showOfflineBanner,
            showOnlineBanner,
            syncProgress,
            retryCountdown,
            handleRetrySync,
            offlineDuration, // üÜï –í—Ä–µ–º—è –æ—Ñ–ª–∞–π–Ω –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        };
    }

    function useClientState(cloud, U) {
        const React = window.React;
        const { useState } = React;
        const [status, setStatus] = useState(
            typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline',
        );
        const [syncVer, setSyncVer] = useState(0);
        const [calendarVer, setCalendarVer] = useState(0); // üóìÔ∏è –û—Ç–¥–µ–ª—å–Ω—ã–π state –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const [clients, setClients] = useState([]);
        const [clientsSource, setClientsSource] = useState(''); // 'cloud' | 'cache' | 'loading'
        const [clientId, setClientId] = useState('');
        const [newName, setNewName] = useState('');
        const [cloudUser, setCloudUser] = useState(null);
        const [isInitializing, setIsInitializing] = useState(true);
        const [products, setProducts] = useState([]);
        const [curatorTab, setCuratorTab] = useState('clients'); // üÜï Tab: 'clients' | 'queue'
        const [needsConsent, setNeedsConsent] = useState(false); // üìã –¢—Ä–µ–±—É—é—Ç—Å—è –ª–∏ —Å–æ–≥–ª–∞—Å–∏—è
        const [checkingConsent, setCheckingConsent] = useState(false); // üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π
        const [backupMeta, setBackupMeta] = useState(() => {
            return readStoredValue('heys_backup_meta', null);
        });
        const [backupBusy, setBackupBusy] = useState(false);

        return {
            status, setStatus,
            syncVer, setSyncVer,
            calendarVer, setCalendarVer,
            clients, setClients,
            clientsSource, setClientsSource,
            clientId, setClientId,
            needsConsent, setNeedsConsent,
            checkingConsent, setCheckingConsent,
            newName, setNewName,
            cloudUser, setCloudUser,
            isInitializing, setIsInitializing,
            products, setProducts,
            backupMeta, setBackupMeta,
            backupBusy, setBackupBusy,
            curatorTab, setCuratorTab, // üÜï
        };
    }

    function useCloudClients(cloud, U, {
        clients, setClients,
        clientsSource, setClientsSource,
        clientId, setClientId,
        cloudUser, setCloudUser,
        setProducts,
        setStatus,
        setSyncVer,
        setLoginError,
    }) {
        const React = window.React;
        const { useRef, useCallback, useEffect } = React;
        const ONE_CURATOR_MODE = false;
        const signInCooldownUntilRef = useRef(0);
        const fetchingClientsRef = useRef(false); // üîß FIX: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

        // Fallback –µ—Å–ª–∏ cloud.fetchWithRetry –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
        const defaultFetchWithRetry = async (fn, opts) => {
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Timeout')), opts.timeoutMs || 8000)
            );
            try {
                return await Promise.race([fn(), timeoutPromise]);
            } catch (e) {
                return { data: null, error: { message: e.message } };
            }
        };

        const fetchClientsFromCloud = useCallback(async (curatorId) => {
            if (!curatorId) {
                return { data: [], source: 'error' };
            }

            const curatorShortId = String(curatorId).slice(0, 8);
            const summarizeClients = (list) => {
                const now = Date.now();
                const statusCounts = {};
                let missingStatus = 0;
                let missingEndDate = 0;
                let expired = 0;
                const sample = [];

                (list || []).forEach((c, idx) => {
                    const status = c?.subscription_status || 'none';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                    if (!c?.subscription_status) missingStatus += 1;
                    if (!c?.trial_ends_at) missingEndDate += 1;

                    if (c?.trial_ends_at) {
                        const endTs = new Date(c.trial_ends_at).getTime();
                        if (!Number.isNaN(endTs) && endTs < now) expired += 1;
                    }

                    if (idx < 5 && c?.id) {
                        sample.push({
                            clientId: String(c.id).slice(0, 8),
                            status,
                            hasEndDate: !!c?.trial_ends_at,
                        });
                    }
                });

                return {
                    total: (list || []).length,
                    statusCounts,
                    missingStatus,
                    missingEndDate,
                    expired,
                    sample,
                };
            };

            // üîß FIX: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
            if (fetchingClientsRef.current) {
                console.info('[HEYS.clients] ‚è≠Ô∏è Skip fetch (already in progress)', { curatorId: curatorShortId });
                return { data: [], source: 'skip' };
            }
            fetchingClientsRef.current = true;

            setClientsSource('loading');

            console.info('[HEYS.clients] üîÑ Fetch clients start', { curatorId: curatorShortId });

            try {
                // üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase
                const result = await HEYS.YandexAPI.getClients(curatorId);

                fetchingClientsRef.current = false;

                if (result.error) {
                    // üè† –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –∫—ç—à
                    console.warn('[HEYS.clients] ‚ö†Ô∏è fetchClients error, using localStorage cache', {
                        curatorId: curatorShortId,
                        message: result.error?.message || 'unknown_error'
                    });
                    const cached = readGlobalValue('heys_clients', null);
                    if (cached) {
                        const data = Array.isArray(cached) ? cached : JSON.parse(cached);
                        const summary = summarizeClients(data);
                        console.info('[HEYS.clients] üì¶ Loaded clients from cache', {
                            curatorId: curatorShortId,
                            source: 'local',
                            ...summary
                        });
                        setClientsSource('local');
                        return { data, source: 'local' };
                    }
                    setClientsSource('error');
                    return { data: [], source: 'error' };
                }

                const data = result.data;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
                if (data && data.length > 0) writeGlobalValue('heys_clients', data);
                const summary = summarizeClients(data);
                console.info('[HEYS.clients] ‚úÖ Loaded clients from cloud', {
                    curatorId: curatorShortId,
                    source: 'cloud',
                    ...summary
                });
                setClientsSource('cloud');
                return { data: data || [], source: 'cloud' };
            } catch (e) {
                fetchingClientsRef.current = false;
                console.error('[HEYS.clients] ‚ùå fetchClientsFromCloud failed', {
                    curatorId: curatorShortId,
                    message: e.message || 'unknown_error'
                });
                // üè† –ü—Ä–∏ exception ‚Äî —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage
                const cached = readGlobalValue('heys_clients', null);
                if (cached) {
                    try {
                        const data = Array.isArray(cached) ? cached : JSON.parse(cached);
                        const summary = summarizeClients(data);
                        console.info('[HEYS.clients] üì¶ Loaded clients from cache after error', {
                            curatorId: curatorShortId,
                            source: 'local',
                            ...summary
                        });
                        setClientsSource('local');
                        return { data, source: 'local' };
                    } catch { }
                }
                setClientsSource('error');
                return { data: [], source: 'error' };
            }
        }, [cloud]);

        const addClientToCloud = useCallback(async (arg) => {
            const payload = typeof arg === 'string' ? { name: arg } : (arg || {});
            const clientName = (payload.name || '').trim() || `–ö–ª–∏–µ–Ω—Ç ${clients.length + 1}`;
            const clientPhone = (payload.phone || '').trim();
            const clientPin = (payload.pin || '').trim();

            if (!cloudUser || !cloudUser.id) {
                const newClient = {
                    id: `local-user-${Date.now()}`,
                    name: clientName,
                };
                const updatedClients = [...clients, newClient];
                setClients(updatedClients);
                writeGlobalValue('heys_clients', updatedClients);
                setClientId(newClient.id);
                writeGlobalValue('heys_client_current', newClient.id);
                return;
            }

            const userId = cloudUser.id;

            // üß© –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã RPC –¥–ª—è phone+PIN ‚Äî —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ –Ω–∏—Ö (–∫—É—Ä–∞—Ç–æ—Ä—Å–∫–∏–π —Ñ–ª–æ—É)
            // (–¢–µ–ª–µ—Ñ–æ–Ω/PIN –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã: –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã ‚Äî fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π insert)
            try {
                const auth = window.HEYS && window.HEYS.auth;
                const createWithPin = auth && auth.createClientWithPin;
                if (createWithPin && clientPhone && clientPin) {
                    const created = await createWithPin({ name: clientName, phone: clientPhone, pin: clientPin });
                    if (created && created.ok && created.clientId) {
                        const result = await fetchClientsFromCloud(userId);
                        setClients(result.data);
                        setClientId(created.clientId);
                        writeGlobalValue('heys_client_current', created.clientId);
                        // üÜï –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –¥–ª—è pre-fill –≤ –ø—Ä–æ—Ñ–∏–ª–µ (–±–µ–∑ namespace ‚Äî –Ω–∞–ø—Ä—è–º—É—é –≤ localStorage)
                        try {
                            writeGlobalValue('heys_pending_client_name', clientName);
                        } catch (_) { }
                        try {
                            HEYS.Toast?.success('–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ª–µ—Ñ–æ–Ω: ' + created.phone + ', PIN: ' + created.pin) || alert('‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω\n\n–¢–µ–ª–µ—Ñ–æ–Ω: ' + created.phone + '\nPIN: ' + created.pin);
                        } catch (_) { }
                        return;
                    }
                    if (created && created.error) {
                        HEYS.Toast?.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + created.error) || alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + created.error);
                        return;
                    }
                }
            } catch (e) {
                // –ü–∞–¥–∞–µ–º –≤ fallback insert –Ω–∏–∂–µ
            }

            // üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase
            try {
                const data = await HEYS.YandexAPI.createClient(clientName, userId);
                if (!data || !data.id) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞');
                    HEYS.Toast?.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞') || alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞');
                    return;
                }
                const result = await fetchClientsFromCloud(userId);
                setClients(result.data);
                setClientId(data.id);
                writeGlobalValue('heys_client_current', data.id);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:', error);
                HEYS.Toast?.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + error.message) || alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + error.message);
            }
        }, [clients, cloudUser, fetchClientsFromCloud, setClientId, setClients, U]);

        const renameClient = useCallback(async (id, name) => {
            if (!cloudUser || !cloudUser.id) {
                const updatedClients = clients.map((c) => (c.id === id ? { ...c, name } : c));
                setClients(updatedClients);
                writeGlobalValue('heys_clients', updatedClients);
                return;
            }

            const userId = cloudUser.id;
            // üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase
            await HEYS.YandexAPI.updateClient(id, { name });
            const result = await fetchClientsFromCloud(userId);
            setClients(result.data);
        }, [clients, cloudUser, fetchClientsFromCloud, setClients, U]);

        const removeClient = useCallback(async (id) => {
            if (!cloudUser || !cloudUser.id) {
                const updatedClients = clients.filter((c) => c.id !== id);
                setClients(updatedClients);
                writeGlobalValue('heys_clients', updatedClients);
                if (clientId === id) {
                    setClientId('');
                    writeGlobalValue('heys_client_current', '');
                }
                return;
            }

            const userId = cloudUser.id;
            // üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase
            await HEYS.YandexAPI.deleteClient(id);
            const result = await fetchClientsFromCloud(userId);
            setClients(result.data);
            if (clientId === id) {
                setClientId('');
                writeGlobalValue('heys_client_current', '');
            }
        }, [clientId, clients, cloudUser, fetchClientsFromCloud, setClientId, setClients, U]);

        const cloudSignIn = useCallback(async (email, password, opts = {}) => {
            if (!email || !password) {
                setLoginError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                setStatus('offline');
                return { error: 'missing_credentials' };
            }

            const now = Date.now();
            if (now < signInCooldownUntilRef.current) {
                setLoginError('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                setStatus('offline');
                return { error: 'cooldown' };
            }

            const rememberMe = opts.rememberMe === true;
            if (!cloud || typeof cloud.signIn !== 'function') {
                HEYS.Toast?.warning('–û–±–ª–∞—á–Ω—ã–π –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω') || alert('–û–±–ª–∞—á–Ω—ã–π –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            try {
                setStatus('signin');
                setLoginError(null);

                if (rememberMe) {
                    writeGlobalValue('heys_remember_me', 'true');
                    writeGlobalValue('heys_remember_email', email || '');
                } else {
                    removeGlobalValue('heys_remember_me');
                    removeGlobalValue('heys_remember_email');
                }

                const res = await cloud.signIn(email, password);
                if (!res || res.error) {
                    const message = res?.error?.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                    setLoginError(message);

                    // –ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π backoff –¥–ª—è 429
                    if (/Too Many Requests/i.test(message)) {
                        signInCooldownUntilRef.current = Date.now() + 30_000;
                    }
                    setStatus('offline');
                    return { error: message };
                }

                setCloudUser(res.user);
                setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'online');
                const loadedResult = await fetchClientsFromCloud(res.user.id);
                setClients(loadedResult.data);

                // –ù–µ –∞–≤—Ç–æ–≤—ã–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –∫—É—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å —Å–∞–º —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É
                // clientId –æ—Å—Ç–∞—ë—Ç—Å—è null ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞

                const rawProducts = Array.isArray(readStoredValue('heys_products', []))
                    ? readStoredValue('heys_products', [])
                    : [];
                const loadedProducts = migrateProductsKcalNetAtwater(rawProducts);
                if (loadedProducts !== rawProducts) writeStoredValue('heys_products', loadedProducts);
                setProducts(loadedProducts);
                setSyncVer((v) => v + 1);
            } catch (e) {
                setStatus('offline');
                setLoginError(e && e.message ? e.message : '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }, [cloud, fetchClientsFromCloud, setClientId, setClients, setCloudUser, setProducts, setStatus, setSyncVer, U]);

        const cloudSignOut = useCallback(async () => {
            try {
                if (cloud && typeof cloud.signOut === 'function') await cloud.signOut();
            } catch (_) { }
            if (window.HEYS) {
                window.HEYS.currentClientId = null;
                if (window.HEYS.store?.flushMemory) {
                    window.HEYS.store.flushMemory();
                }
            }
            // –í–∞–∂–Ω–æ: –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º ‚Äúclient mode‚Äù,
            // –∏–Ω–∞—á–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å—Å—è ConsentGate –ø–æ —Å—Ç–∞—Ä–æ–º—É clientId.
            removeGlobalValue('heys_client_current');
            removeGlobalValue('heys_pin_auth_client');
            removeGlobalValue('heys_client_phone');
            removeGlobalValue('heys_supabase_auth_token');
            // üîß v53 FIX: –û—á–∏—Å—Ç–∫–∞ session_token –¥–ª—è PIN auth
            removeGlobalValue('heys_session_token');
            setCloudUser(null);
            setClientId('');
            setClients([]);
            setProducts([]);
            setStatus('offline');
            setSyncVer((v) => v + 1);
            removeGlobalValue('heys_last_client_id');
        }, [cloud, setClientId, setClients, setCloudUser, setProducts, setStatus, setSyncVer]);

        // üö™ FORCE LOGOUT: –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
        useEffect(() => {
            const handleForceLogout = (e) => {
                console.info('[HEYS] üö™ Force logout triggered:', e.detail?.reason);
                // –ü–æ–ª–Ω—ã–π logout ‚Äî —Å–±—Ä–æ—Å–∏—Ç –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–æ–∫–∞–∂–µ—Ç LoginScreen
                cloudSignOut();
            };

            window.addEventListener('heys:force-logout', handleForceLogout);
            return () => {
                window.removeEventListener('heys:force-logout', handleForceLogout);
            };
        }, [cloudSignOut]);

        return {
            ONE_CURATOR_MODE,
            fetchClientsFromCloud,
            addClientToCloud,
            renameClient,
            removeClient,
            cloudSignIn,
            cloudSignOut,
        };
    }

    HEYS.AppHooks = {
        useThemePreference,
        usePwaPrompts,
        useWakeLock,
        useCloudSyncStatus,
        useClientState,
        useCloudClients,
    };
})();


/* ===== heys_app_tabs_v1.js ===== */
// heys_app_tabs_v1.js ‚Äî Tab wrappers and skeletons for HEYS app

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const React = window.React;
    if (!React) return;

    const TAB_SKELETON_DELAY_MS = 260;

    function useDelayedSkeleton(shouldShow, key) {
        const [visible, setVisible] = React.useState(false);

        React.useEffect(() => {
            if (!shouldShow) {
                if (window.__heysTabWrapSkeletonState?.[key] !== 'ready') {
                    window.__heysTabWrapSkeletonState = window.__heysTabWrapSkeletonState || Object.create(null);
                    window.__heysTabWrapSkeletonState[key] = 'ready';
                    console.info('[HEYS.sceleton] ‚úÖ tabwrap_ready', { key });
                }
                setVisible(false);
                return;
            }

            window.__heysTabWrapSkeletonState = window.__heysTabWrapSkeletonState || Object.create(null);
            if (window.__heysTabWrapSkeletonState[key] !== 'wait_delay') {
                window.__heysTabWrapSkeletonState[key] = 'wait_delay';
                console.info('[HEYS.sceleton] ‚è±Ô∏è tabwrap_wait_delay', {
                    key,
                    delayMs: TAB_SKELETON_DELAY_MS
                });
            }

            const t = setTimeout(() => {
                setVisible(true);
                if (window.__heysTabWrapSkeletonState[key] !== 'show_skeleton') {
                    window.__heysTabWrapSkeletonState[key] = 'show_skeleton';
                    console.info('[HEYS.sceleton] ü¶¥ tabwrap_show_skeleton', { key });
                }
            }, TAB_SKELETON_DELAY_MS);

            return () => clearTimeout(t);
        }, [shouldShow, key]);

        return visible;
    }

    // Skeleton –¥–ª—è DayTab ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è
    function DayTabSkeleton() {
        return React.createElement('div', { className: 'day-tab-skeleton', style: { padding: 16 } },
            // Sparkline skeleton
            React.createElement('div', {
                className: 'skeleton-sparkline',
                style: { height: 80, marginBottom: 16, borderRadius: 12 }
            }),
            // Cards skeleton
            React.createElement('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
                React.createElement('div', { className: 'skeleton-card', style: { flex: 1, height: 60 } }),
                React.createElement('div', { className: 'skeleton-card', style: { flex: 1, height: 60 } })
            ),
            // Progress skeleton
            React.createElement('div', { className: 'skeleton-progress', style: { height: 48, marginBottom: 16 } }),
            // Macros skeleton
            React.createElement('div', { className: 'skeleton-macros', style: { marginBottom: 16 } },
                React.createElement('div', { className: 'skeleton-ring' }),
                React.createElement('div', { className: 'skeleton-ring' }),
                React.createElement('div', { className: 'skeleton-ring' })
            )
        );
    }

    // v9.3: Non-blocking sync ‚Äî DayTab renders immediately, sync updates reactively
    // Previously: DayTab blocked on full syncClient (5-15s skeleton in incognito)
    // Now: fire-and-forget sync + heysSyncCompleted listener + fallback safety net
    // v9.5: Increased from 800ms to 5000ms ‚Äî Phase A (profile+products+dayv2_today)
    // typically arrives in 3-5s. 800ms fired BEFORE Phase A, causing empty render
    // followed by jarring full re-render. 5000ms lets Phase A unlock DayTab with real data.
    const DAYTAB_SYNC_FALLBACK_MS = 5000;

    function DayTabWithCloudSync(props) {
        const { clientId, products, selectedDate, setSelectedDate, subTab } = props;
        const [loading, setLoading] = React.useState(true);
        const needsSkeleton = !clientId || loading || !window.HEYS || !window.HEYS.DayTab;
        const showSkeleton = useDelayedSkeleton(needsSkeleton, 'daytab');

        React.useEffect(() => {
            let cancelled = false;
            let fallbackTimer = null;
            const cloud = window.HEYS && window.HEYS.cloud;

            const finish = (reason) => {
                if (cancelled) return;
                cancelled = true; // prevent double-fire from event + timer + catch
                if (fallbackTimer) clearTimeout(fallbackTimer);
                window.removeEventListener('heysSyncCompleted', onSyncCompleted);
                console.info('[HEYS.sceleton] ‚úÖ DayTab unlocked:', reason);
                setLoading(false);
            };

            // Listen for heysSyncCompleted ‚Äî dispatched by Phase A (critical keys)
            // or by full sync completion. Either way, data is ready to render.
            // v9.4: Filter by clientId ‚Äî ignore synthetic events from Gamification (no clientId)
            const onSyncCompleted = (event) => {
                const evClientId = event?.detail?.clientId;
                if (!evClientId) return; // synthetic event without clientId ‚Äî skip
                if (evClientId !== clientId && !clientId.startsWith(evClientId)) return; // different client
                finish('heysSyncCompleted (Phase A or full)');
            };

            if (!clientId || !cloud || typeof cloud.syncClient !== 'function') {
                finish('no cloud or clientId');
                return;
            }

            const need =
                typeof cloud.shouldSyncClient === 'function'
                    ? cloud.shouldSyncClient(clientId, 4000)
                    : true;

            // Fast path: sync not needed (completed < 4s ago)
            if (!need) {
                finish('sync not needed (cooldown)');
                return;
            }

            // Quick check: sync already completed for this client
            if (cloud._lastClientSync && cloud._lastClientSync.clientId === clientId) {
                finish('sync already completed');
                return;
            }

            setLoading(true);
            window.addEventListener('heysSyncCompleted', onSyncCompleted);

            // Fallback: don't block forever ‚Äî show DayTab with local data after timeout
            fallbackTimer = setTimeout(() => finish('fallback timeout (' + DAYTAB_SYNC_FALLBACK_MS + 'ms)'), DAYTAB_SYNC_FALLBACK_MS);

            // Fire sync non-blocking (switchClient may already have started it via bootstrapClientSync)
            cloud.syncClient(clientId).catch((err) => {
                console.warn('[HEYS] Sync failed, using local cache:', err?.message || err);
                finish('sync error');
            });

            return () => {
                if (!cancelled) {
                    cancelled = true;
                    if (fallbackTimer) clearTimeout(fallbackTimer);
                    window.removeEventListener('heysSyncCompleted', onSyncCompleted);
                }
            };
        }, [clientId]);

        // üîê –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º DayTab –ø–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –∏–Ω–∞—á–µ advice –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–æ –≤—Ö–æ–¥–∞!
        if (!clientId) {
            return showSkeleton ? React.createElement(DayTabSkeleton) : null;
        }

        if (loading || !window.HEYS || !window.HEYS.DayTab) {
            return showSkeleton ? React.createElement(DayTabSkeleton) : null;
        }
        return React.createElement(window.HEYS.DayTab, { products, selectedDate, setSelectedDate, subTab });
    }

    // Skeleton –¥–ª—è Ration/Products
    function RationSkeleton() {
        return React.createElement('div', { style: { padding: 16 } },
            React.createElement('div', { className: 'skeleton-header', style: { width: 150, marginBottom: 16 } }),
            ...Array.from({ length: 5 }, (_, i) =>
                React.createElement('div', {
                    key: i,
                    className: 'skeleton-block',
                    style: { height: 56, marginBottom: 8 }
                })
            )
        );
    }

    // –ö—ç—à —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏) ‚Äî –æ–±—ã—á–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–¥—É–ª—è
    const syncedClientsCache = new Set();
    const recoveryRunCache = new Set();

    function RationTabWithCloudSync(props) {
        const { clientId, setProducts, products } = props;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª –ª–∏ sync –¥–ª—è –≠–¢–û–ì–û –∫–ª–∏–µ–Ω—Ç–∞
        const alreadySynced = clientId && syncedClientsCache.has(clientId);
        const [loading, setLoading] = React.useState(!alreadySynced);
        const needsSkeleton = !clientId || loading || !window.HEYS || !window.HEYS.Ration;
        const showSkeleton = useDelayedSkeleton(needsSkeleton, 'rationtab');
        const getLatestProducts = (event) => {
            const fromEvent = event?.detail?.products;
            if (Array.isArray(fromEvent)) return fromEvent;
            const fromService = window.HEYS?.products?.getAll?.();
            if (Array.isArray(fromService)) return fromService;
            const fromStore = window.HEYS.store?.get?.('heys_products', []);
            if (Array.isArray(fromStore)) return fromStore;
            const fromLs = window.HEYS.utils?.lsGet?.('heys_products', []);
            return Array.isArray(fromLs) ? fromLs : [];
        };

        // üîê –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º Ration –ø–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞
        if (!clientId) {
            return showSkeleton ? React.createElement(RationSkeleton) : null;
        }

        // üì¶ –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        // üîí –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        const initialProductsSyncDoneRef = React.useRef(false);

        React.useEffect(() => {
            const handleProductsUpdated = (e) => {
                // üîí –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º heysSyncCompleted –ø—Ä–∏ –ü–ï–†–í–û–ô –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî products —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–∏—à–Ω–∏–π —Ä–µ-—Ä–µ–Ω–¥–µ—Ä –∏ –º–µ—Ä—Ü–∞–Ω–∏–µ UI
                if (e.type === 'heysSyncCompleted') {
                    if (!initialProductsSyncDoneRef.current) {
                        initialProductsSyncDoneRef.current = true;
                        // console.log('[HEYS] ‚è≠Ô∏è Products update skipped: initial sync');
                        return;
                    }
                }

                const latest = getLatestProducts(e);
                if (Array.isArray(latest) && latest.length > 0) {
                    // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ UI
                    // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–º–µ—Ä—Ü–∞–Ω–∏–µ" –∫–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ –æ–±–ª–∞–∫–∞
                    setProducts(prev => {
                        if (Array.isArray(prev) && prev.length > latest.length) {
                            // üîá v4.7.0: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
                            return prev;
                        }
                        // üîí –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ)
                        if (Array.isArray(prev) && prev.length === latest.length) {
                            return prev;
                        }
                        return latest;
                    });

                    // üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º orphan-–ø—Ä–æ–¥—É–∫—Ç—ã ‚Äî —Ç–µ–ø–µ—Ä—å –±–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                    if (window.HEYS?.orphanProducts?.recalculate) {
                        window.HEYS.orphanProducts.recalculate();
                    }
                }
            };

            window.addEventListener('heys:products-updated', handleProductsUpdated);
            window.addEventListener('heysProductsUpdated', handleProductsUpdated);
            window.addEventListener('heysSyncCompleted', handleProductsUpdated);

            return () => {
                window.removeEventListener('heys:products-updated', handleProductsUpdated);
                window.removeEventListener('heysProductsUpdated', handleProductsUpdated);
                window.removeEventListener('heysSyncCompleted', handleProductsUpdated);
            };
        }, [setProducts]);

        React.useEffect(() => {
            let cancelled = false;
            let recoveryScheduled = false; // üîí –§–ª–∞–≥: recovery —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ (debounce)
            let recoveryAttempts = 0;
            const MAX_RECOVERY_ATTEMPTS = 6;
            const RECOVERY_RETRY_MS = 600;

            // üõ°Ô∏è –•–µ–ª–ø–µ—Ä: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
            const safeSetProducts = (newProducts) => {
                if (!Array.isArray(newProducts)) return;
                setProducts(prev => {
                    if (Array.isArray(prev) && prev.length > newProducts.length) {
                        // üîá v4.7.0: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
                        return prev;
                    }
                    // üîí –ù–µ —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–∏–º –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ
                    if (Array.isArray(prev) && prev.length === newProducts.length) {
                        return prev;
                    }
                    return newProducts;
                });
            };

            // üîÑ –•–µ–ª–ø–µ—Ä: –∑–∞–ø—É—Å–∫ orphan recovery (—Å debounce —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥)
            const runOrphanRecovery = (options = {}) => {
                if (recoveryScheduled || cancelled) return;
                if (!window.HEYS.orphanProducts?.autoRecoverOnLoad) return;

                if (clientId && recoveryRunCache.has(clientId)) return;

                const currentProducts = getLatestProducts();
                const cachedShared = window.HEYS?.cloud?.getCachedSharedProducts?.() || [];
                const minReady = cachedShared.length > 0 ? 10 : 5;

                if (!Array.isArray(currentProducts) || currentProducts.length < minReady) {
                    recoveryAttempts += 1;
                    if (recoveryAttempts <= MAX_RECOVERY_ATTEMPTS) {
                        setTimeout(() => runOrphanRecovery(options), RECOVERY_RETRY_MS);
                    }
                    return;
                }

                recoveryScheduled = true;
                if (clientId) recoveryRunCache.add(clientId);
                const isFirstLoad = !syncedClientsCache.has(clientId);

                window.HEYS.orphanProducts.autoRecoverOnLoad({
                    verbose: isFirstLoad,
                    ...options
                }).then(result => {
                    if (result.recovered > 0 && !cancelled) {
                        const updatedProducts = window.HEYS.utils.lsGet('heys_products', []);
                        safeSetProducts(Array.isArray(updatedProducts) ? updatedProducts : []);

                        if (window.HEYS.Toast?.success) {
                            const msg = result.recovered === 1
                                ? 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω 1 –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏'
                                : `üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${result.recovered} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏`;
                            window.HEYS.Toast.success(msg);
                        }
                    }
                }).catch(() => { });
            };

            // –ï—Å–ª–∏ sync –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –±—ã–ª ‚Äî —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
            if (syncedClientsCache.has(clientId)) {
                const loadedProducts = getLatestProducts();
                safeSetProducts(Array.isArray(loadedProducts) ? loadedProducts : []);
                setLoading(false);

                // üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ orphan-–ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–≤ —Ñ–æ–Ω–µ)
                runOrphanRecovery();
                return;
            }

            if (
                clientId &&
                window.HEYS.cloud &&
                typeof window.HEYS.cloud.syncClient === 'function'
            ) {
                setLoading(true);

                // v9.4: Non-blocking sync for Ration tab ‚Äî filter by clientId
                const onSyncDone = (event) => {
                    const evClientId = event?.detail?.clientId;
                    if (!evClientId) return; // synthetic event ‚Äî skip
                    if (evClientId !== clientId && !clientId.startsWith(evClientId)) return;
                    if (!cancelled) {
                        syncedClientsCache.add(clientId);
                        const loadedProducts = getLatestProducts();
                        safeSetProducts(loadedProducts);
                        setLoading(false);
                        runOrphanRecovery();
                        window.removeEventListener('heysSyncCompleted', onSyncDone);
                        clearTimeout(rationFallback);
                    }
                };

                window.addEventListener('heysSyncCompleted', onSyncDone);

                const rationFallback = setTimeout(() => {
                    if (!cancelled) {
                        console.info('[HEYS.sceleton] ‚è±Ô∏è RationTab fallback timeout ‚Äî showing with local data');
                        syncedClientsCache.add(clientId);
                        const loadedProducts = getLatestProducts();
                        safeSetProducts(Array.isArray(loadedProducts) ? loadedProducts : []);
                        setLoading(false);
                        runOrphanRecovery({ tryShared: false });
                        window.removeEventListener('heysSyncCompleted', onSyncDone);
                    }
                }, DAYTAB_SYNC_FALLBACK_MS);

                window.HEYS.cloud.syncClient(clientId)
                    .catch((err) => {
                        console.warn('[HEYS] Sync failed, using local cache:', err?.message || err);
                        if (!cancelled) {
                            clearTimeout(rationFallback);
                            window.removeEventListener('heysSyncCompleted', onSyncDone);
                            const loadedProducts = getLatestProducts();
                            safeSetProducts(Array.isArray(loadedProducts) ? loadedProducts : []);
                            setLoading(false);
                            runOrphanRecovery({ tryShared: false });
                        }
                    });
            } else {
                // –ù–µ—Ç cloud ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                const loadedProducts = getLatestProducts();
                safeSetProducts(Array.isArray(loadedProducts) ? loadedProducts : []);
                setLoading(false);

                // üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ orphan-–ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–≤ —Ñ–æ–Ω–µ, –±–µ–∑ shared)
                runOrphanRecovery({ tryShared: false });
            }
            return () => {
                cancelled = true;
            };
        }, [clientId]);
        if (loading || !window.HEYS || !window.HEYS.Ration) {
            return showSkeleton ? React.createElement(RationSkeleton) : null;
        }
        return React.createElement(window.HEYS.Ration, { products, setProducts });
    }

    // Skeleton –¥–ª—è UserTab
    function UserSkeleton() {
        return React.createElement('div', { style: { padding: 16 } },
            React.createElement('div', { className: 'skeleton-header', style: { width: 120, marginBottom: 16 } }),
            React.createElement('div', { className: 'skeleton-block', style: { height: 100, marginBottom: 12 } }),
            React.createElement('div', { className: 'skeleton-block', style: { height: 80, marginBottom: 12 } }),
            React.createElement('div', { className: 'skeleton-block', style: { height: 80 } })
        );
    }

    function UserTabWithCloudSync(props) {
        const { clientId } = props;
        const [loading, setLoading] = React.useState(true);
        const needsSkeleton = !clientId || loading || !window.HEYS || !window.HEYS.UserTab;
        const showSkeleton = useDelayedSkeleton(needsSkeleton, 'usertab');

        // üîê –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º UserTab –ø–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞
        if (!clientId) {
            return showSkeleton ? React.createElement(UserSkeleton) : null;
        }

        React.useEffect(() => {
            let cancelled = false;
            if (
                clientId &&
                window.HEYS.cloud &&
                typeof window.HEYS.cloud.syncClient === 'function'
            ) {
                setLoading(true);

                // v9.4: Non-blocking sync for UserTab ‚Äî filter by clientId
                const onSyncDone = (event) => {
                    const evClientId = event?.detail?.clientId;
                    if (!evClientId) return; // synthetic event ‚Äî skip
                    if (evClientId !== clientId && !clientId.startsWith(evClientId)) return;
                    if (!cancelled) {
                        cancelled = true;
                        setLoading(false);
                        window.removeEventListener('heysSyncCompleted', onSyncDone);
                        clearTimeout(userFallback);
                    }
                };

                window.addEventListener('heysSyncCompleted', onSyncDone);

                const userFallback = setTimeout(() => {
                    if (!cancelled) {
                        console.info('[HEYS.sceleton] ‚è±Ô∏è UserTab fallback timeout ‚Äî showing with local data');
                        cancelled = true;
                        setLoading(false);
                        window.removeEventListener('heysSyncCompleted', onSyncDone);
                    }
                }, DAYTAB_SYNC_FALLBACK_MS);

                window.HEYS.cloud.syncClient(clientId)
                    .catch((err) => {
                        console.warn('[HEYS] Sync failed, using local cache:', err?.message || err);
                        if (!cancelled) {
                            cancelled = true;
                            clearTimeout(userFallback);
                            window.removeEventListener('heysSyncCompleted', onSyncDone);
                            setLoading(false);
                        }
                    });
            } else {
                setLoading(false);
            }
            return () => {
                if (!cancelled) {
                    cancelled = true;
                    // cleanup listeners if still active
                }
            };
        }, [clientId]);
        if (loading || !window.HEYS || !window.HEYS.UserTab) {
            return showSkeleton ? React.createElement(UserSkeleton) : null;
        }
        return React.createElement(window.HEYS.UserTab, {});
    }

    // –í–∫–ª–∞–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (heys_simple_analytics.js)
    function AnalyticsTab() {
        const [stats, setStats] = React.useState(null);
        const [autoRefresh, setAutoRefresh] = React.useState(true);

        const loadStats = () => {
            if (window.HEYS && window.HEYS.analytics) {
                const data = window.HEYS.analytics.getStats();
                setStats(data);
            }
        };

        React.useEffect(() => {
            loadStats();
            if (autoRefresh) {
                const interval = setInterval(loadStats, 5000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
                return () => clearInterval(interval);
            }
        }, [autoRefresh]);

        if (!stats) {
            return React.createElement('div', { style: { padding: 16 } },
                React.createElement('div', { className: 'skeleton-header', style: { width: 180, marginBottom: 16 } }),
                React.createElement('div', { className: 'skeleton-block', style: { height: 60, marginBottom: 12 } }),
                React.createElement('div', { className: 'skeleton-block', style: { height: 120 } })
            );
        }

        return React.createElement(
            'div',
            { style: { padding: 24, maxWidth: 900 } },
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            React.createElement(
                'div',
                {
                    style: {
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: 24,
                    },
                },
                React.createElement('h2', { style: { margin: 0 } }, 'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏'),
                React.createElement(
                    'div',
                    { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                    React.createElement(
                        'label',
                        null,
                        React.createElement('input', {
                            type: 'checkbox',
                            checked: autoRefresh,
                            onChange: (e) => setAutoRefresh(e.target.checked),
                            style: { marginRight: 4 },
                        }),
                        '–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
                    ),
                    React.createElement(
                        'button',
                        { className: 'btn', onClick: loadStats },
                        'üîÑ –û–±–Ω–æ–≤–∏—Ç—å',
                    ),
                ),
            ),

            // –í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
            React.createElement(
                'div',
                {
                    style: { marginBottom: 24, padding: 16, background: '#f8f9fa', borderRadius: 8 },
                },
                React.createElement(
                    'div',
                    { style: { fontSize: 14, color: '#666', marginBottom: 4 } },
                    '–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏',
                ),
                React.createElement(
                    'div',
                    { style: { fontSize: 24, fontWeight: 600 } },
                    stats.session.duration,
                ),
            ),

            // –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'üîç –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã'),
                React.createElement(
                    'div',
                    { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#e3f2fd', borderRadius: 8 } },
                        React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–í—Å–µ–≥–æ'),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.searches.total,
                        ),
                    ),
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#fff3e0', borderRadius: 8 } },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            '–ú–µ–¥–ª–µ–Ω–Ω—ã—Ö (>1s)',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.searches.slow,
                        ),
                    ),
                    React.createElement(
                        'div',
                        {
                            style: {
                                padding: 16,
                                background: stats.searches.slowRate === '0%' ? '#e8f5e9' : '#ffebee',
                                borderRadius: 8,
                            },
                        },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            'Slow Rate',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.searches.slowRate,
                        ),
                    ),
                ),
            ),

            // API –≤—ã–∑–æ–≤—ã
            React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'üåê API –≤—ã–∑–æ–≤—ã'),
                React.createElement(
                    'div',
                    { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 } },
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#e3f2fd', borderRadius: 8 } },
                        React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–í—Å–µ–≥–æ'),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.apiCalls.total,
                        ),
                    ),
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#fff3e0', borderRadius: 8 } },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            '–ú–µ–¥–ª–µ–Ω–Ω—ã—Ö (>2s)',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.apiCalls.slow,
                        ),
                    ),
                    React.createElement(
                        'div',
                        {
                            style: {
                                padding: 16,
                                background: stats.apiCalls.failed > 0 ? '#ffebee' : '#e8f5e9',
                                borderRadius: 8,
                            },
                        },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            '–û—à–∏–±–æ–∫',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.apiCalls.failed,
                        ),
                    ),
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#f3e5f5', borderRadius: 8 } },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            'Slow Rate',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.apiCalls.slowRate,
                        ),
                    ),
                ),
            ),

            // Cache —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'üíæ Cache —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'),
                React.createElement(
                    'div',
                    { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#e8f5e9', borderRadius: 8 } },
                        React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Hits'),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.cache.hits,
                        ),
                    ),
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#ffebee', borderRadius: 8 } },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            'Misses',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.cache.misses,
                        ),
                    ),
                    React.createElement(
                        'div',
                        { style: { padding: 16, background: '#e1f5fe', borderRadius: 8 } },
                        React.createElement(
                            'div',
                            { style: { fontSize: 12, color: '#666' } },
                            'Hit Rate',
                        ),
                        React.createElement(
                            'div',
                            { style: { fontSize: 20, fontWeight: 600 } },
                            stats.cache.hitRate,
                        ),
                    ),
                ),
            ),

            // –û—à–∏–±–∫–∏
            React.createElement(
                'div',
                { style: { marginBottom: 24 } },
                React.createElement('h3', null, 'üêõ –û—à–∏–±–∫–∏'),
                React.createElement(
                    'div',
                    {
                        style: {
                            padding: 16,
                            background: stats.errors.total > 0 ? '#ffebee' : '#e8f5e9',
                            borderRadius: 8,
                        },
                    },
                    React.createElement(
                        'div',
                        { style: { fontSize: 12, color: '#666' } },
                        '–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫ –≤ —Å–µ—Å—Å–∏–∏',
                    ),
                    React.createElement(
                        'div',
                        { style: { fontSize: 24, fontWeight: 600 } },
                        stats.errors.total,
                    ),
                ),
            ),

            // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
            React.createElement(
                'div',
                { style: { marginTop: 32, paddingTop: 24, borderTop: '1px solid #eee' } },
                React.createElement(
                    'button',
                    {
                        className: 'btn secondary',
                        onClick: () => {
                            if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.reset) {
                                if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Å—Å–∏–∏?')) {
                                    window.HEYS.analytics.reset();
                                    loadStats();
                                }
                            }
                        },
                    },
                    'üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É',
                ),
            ),
        );
    }

    HEYS.AppTabs = {
        DayTabWithCloudSync,
        RationTabWithCloudSync,
        UserTabWithCloudSync,
        AnalyticsTab,
    };
})();


/* ===== heys_early_warning_panel_v1.js ===== */
/**
 * HEYS Early Warning Panel v1.0
 * 
 * Modal panel –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Early Warning System –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π.
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ warnings —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ severity (HIGH/MEDIUM/LOW).
 * 
 * Features:
 * - Severity-based grouping (üö® HIGH ‚Üí ‚ö†Ô∏è MEDIUM ‚Üí ‚ÑπÔ∏è LOW)
 * - WarningCard component —Å pattern details + actionable advice
 * - Navigate to Pattern Debugger –¥–ª—è deep dive –∞–Ω–∞–ª–∏–∑–∞
 * 
 * Dependencies: React, heys_utils
 */

(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    const React = global.React;
    const { useState, useEffect, useCallback, useMemo } = React;
    const ReactDOM = global.ReactDOM;

    if (!React) {
        console.error('ews / panel ‚ùå React not found');
        return;
    }

    const h = React.createElement;

    /**
     * Severity config (emoji, color, priority)
     */
    const SEVERITY_CONFIG = {
        high: {
            emoji: 'üö®',
            label: '–ö—Ä–∏—Ç–∏—á–Ω–æ',
            color: '#dc2626',
            colorDark: '#fca5a5',
            bgColor: 'rgba(239, 68, 68, 0.1)',
            bgColorDark: 'rgba(239, 68, 68, 0.2)',
            borderColor: 'rgba(239, 68, 68, 0.3)',
            borderColorDark: 'rgba(239, 68, 68, 0.4)',
            priority: 1
        },
        medium: {
            emoji: '‚ö†Ô∏è',
            label: '–í–Ω–∏–º–∞–Ω–∏–µ',
            color: '#ea580c',
            colorDark: '#fdba74',
            bgColor: 'rgba(249, 115, 22, 0.1)',
            bgColorDark: 'rgba(249, 115, 22, 0.2)',
            borderColor: 'rgba(249, 115, 22, 0.3)',
            borderColorDark: 'rgba(249, 115, 22, 0.4)',
            priority: 2
        },
        low: {
            emoji: '‚ÑπÔ∏è',
            label: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è',
            color: '#2563eb',
            colorDark: '#93c5fd',
            bgColor: 'rgba(59, 130, 246, 0.1)',
            bgColorDark: 'rgba(59, 130, 246, 0.2)',
            borderColor: 'rgba(59, 130, 246, 0.3)',
            borderColorDark: 'rgba(59, 130, 246, 0.4)',
            priority: 3
        }
    };

    /**
     * WarningCard Component
     * 
     * Displays single warning with severity badge, message, detail, and actions
     */
    function WarningCard({ warning, onViewDetails }) {
        const [showScience, setShowScience] = useState(false);
        const severity = warning.severity || 'low';
        const config = SEVERITY_CONFIG[severity] || SEVERITY_CONFIG.low;

        const toggleScience = useCallback(() => {
            setShowScience(prev => !prev);
        }, []);

        return h('div', {
            className: `early-warning-modal-card early-warning-modal-card--${severity}`
        },
            // Header (severity badge + pattern name)
            h('div', { className: 'early-warning-modal-card__header' },
                h('div', { className: 'early-warning-modal-card__header-left' },
                    h('span', {
                        className: 'early-warning-modal-card__emoji',
                        'aria-label': config.label
                    }, config.emoji),
                    h('div', { className: 'early-warning-modal-card__header-text' },
                        warning.patternName && h('span', {
                            className: 'early-warning-modal-card__pattern-name'
                        }, warning.patternName),
                        h('span', {
                            className: 'early-warning-modal-card__severity-label'
                        }, config.label)
                    )
                )
            ),

            // Main message (–¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
            warning.detail && h('p', {
                className: 'early-warning-modal-card__message'
            }, warning.detail),

            // Insight (–±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)
            warning.insight && h('p', {
                className: 'early-warning-modal-card__detail'
            }, warning.insight),

            // Score info (if available)
            warning.currentScore !== undefined && h('p', {
                className: 'early-warning-modal-card__score'
            }, `–¢–µ–∫—É—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å: ${warning.currentScore} –∏–∑ 100`),

            // Science toggle button (show if science is available)
            warning.science && h('div', { className: 'early-warning-modal-card__actions' },
                h('button', {
                    className: 'early-warning-modal-card__action-btn',
                    onClick: toggleScience
                }, showScience ? 'üìñ –°–∫—Ä—ã—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ' : 'üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ')
            ),

            // Science explanation (collapsible)
            showScience && warning.science && h('div', {
                className: 'early-warning-modal-card__science-content'
            }, warning.science)
        );
    }

    /**
     * EarlyWarningPanel Component
     * 
     * Modal panel for displaying Early Warning System detections
     * 
     * @param {object} props
     * @param {boolean} props.isOpen - Panel visibility
     * @param {function} props.onClose - Close handler
     * @param {array} props.warnings - Array of warning objects from earlyWarning.detect()
     * @param {string} props.mode - Detection mode: 'acute' (10 checks, 7d) or 'full' (25 checks, 30d)
     */
    function EarlyWarningPanel({ isOpen, onClose, warnings = [], mode = 'full' }) {
        // Block body scroll when modal is open
        useEffect(() => {
            if (isOpen) {
                document.body.style.overflow = 'hidden';
                return () => {
                    document.body.style.overflow = '';
                };
            }
        }, [isOpen]);

        const activeWarnings = warnings;

        // Group warnings by severity
        const groupedWarnings = useMemo(() => {
            const groups = { high: [], medium: [], low: [] };

            activeWarnings.forEach(warning => {
                const severity = warning.severity || 'low';
                if (groups[severity]) {
                    groups[severity].push(warning);
                }
            });

            return groups;
        }, [activeWarnings]);

        // Close on Escape key
        useEffect(() => {
            if (!isOpen) return;

            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    onClose();
                }
            };

            document.addEventListener('keydown', handleEscape);
            return () => document.removeEventListener('keydown', handleEscape);
        }, [isOpen, onClose]);

        const handleViewDetails = useCallback((warning) => {
            if (!warning.pattern) return;

            // Navigate to Pattern Debugger with hash
            window.location.hash = `#pattern-${warning.pattern}`;

            // Close panel
            onClose();

            console.info('ews / panel üîç navigate to pattern:', warning.pattern);
        }, [onClose]);

        if (!isOpen) return null;

        const modalNode = h('div', {
            className: 'pattern-debug-modal early-warning-modal',
            onClick: onClose
        },
            h('div', {
                className: 'pattern-debug-modal__content early-warning-modal__content',
                onClick: (e) => e.stopPropagation()
            },
                // Header
                h('div', { className: 'pattern-debug-modal__header early-warning-modal__header' },
                    h('div', { className: 'pattern-debug-modal__title early-warning-modal__title' },
                        h('span', { className: 'pattern-debug-modal__emoji early-warning-modal__emoji' },
                            mode === 'acute' ? '‚ö°' : 'üìä'
                        ),
                        h('span', null,
                            mode === 'acute' ? '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è' : '–ê—É–¥–∏—Ç –∑–∞ 30 –¥–Ω–µ–π'
                        )
                    ),
                    h('button', {
                        className: 'pattern-debug-modal__close early-warning-modal__close',
                        onClick: onClose,
                        'aria-label': '–ó–∞–∫—Ä—ã—Ç—å'
                    }, '‚úï')
                ),

                // Stats summary (–∫–∞–∫ –≤ Pattern Debugger)
                h('div', { className: 'pattern-debug-modal__stats early-warning-modal__stats' },
                    h('div', { className: 'pattern-debug-modal__stat pattern-debug-modal__stat--total' },
                        h('span', { className: 'pattern-debug-modal__stat-icon' }, 'üìä'),
                        h('div', { className: 'pattern-debug-modal__stat-content' },
                            h('span', { className: 'pattern-debug-modal__stat-label' }, '–í—Å–µ–≥–æ'),
                            h('span', { className: 'pattern-debug-modal__stat-value' }, activeWarnings.length)
                        )
                    ),
                    h('div', { className: 'pattern-debug-modal__stat pattern-debug-modal__stat--high' },
                        h('span', { className: 'pattern-debug-modal__stat-icon' }, 'üö®'),
                        h('div', { className: 'pattern-debug-modal__stat-content' },
                            h('span', { className: 'pattern-debug-modal__stat-label' }, '–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö'),
                            h('span', { className: 'pattern-debug-modal__stat-value' }, groupedWarnings.high.length)
                        )
                    ),
                    h('div', { className: 'pattern-debug-modal__stat pattern-debug-modal__stat--medium' },
                        h('span', { className: 'pattern-debug-modal__stat-icon' }, '‚ö†Ô∏è'),
                        h('div', { className: 'pattern-debug-modal__stat-content' },
                            h('span', { className: 'pattern-debug-modal__stat-label' }, '–í–Ω–∏–º–∞–Ω–∏–µ'),
                            h('span', { className: 'pattern-debug-modal__stat-value' }, groupedWarnings.medium.length)
                        )
                    ),
                    h('div', { className: 'pattern-debug-modal__stat pattern-debug-modal__stat--low' },
                        h('span', { className: 'pattern-debug-modal__stat-icon' }, '‚ÑπÔ∏è'),
                        h('div', { className: 'pattern-debug-modal__stat-content' },
                            h('span', { className: 'pattern-debug-modal__stat-label' }, '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π'),
                            h('span', { className: 'pattern-debug-modal__stat-value' }, groupedWarnings.low.length)
                        )
                    )
                ),

                // Content (scrollable)
                h('div', { className: 'early-warning-modal__body' },
                    activeWarnings.length === 0
                        ? h('div', { className: 'early-warning-modal__empty' },
                            h('span', { className: 'early-warning-modal__empty-icon' }, '‚úÖ'),
                            h('p', { className: 'early-warning-modal__empty-title' }, '–í—Å—ë –æ—Ç–ª–∏—á–Ω–æ!'),
                            h('p', { className: 'early-warning-modal__empty-subtitle' }, '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π')
                        )
                        : h('div', { className: 'early-warning-modal__warnings' },
                            // High severity warnings
                            groupedWarnings.high.length > 0 && h('div', { className: 'early-warning-modal__section' },
                                h('h3', { className: 'early-warning-modal__section-title early-warning-modal__section-title--high' },
                                    'üö® –ö—Ä–∏—Ç–∏—á–Ω–æ'
                                ),
                                groupedWarnings.high.map((warning, idx) =>
                                    h(WarningCard, {
                                        key: idx,
                                        warning,
                                        onViewDetails: handleViewDetails
                                    })
                                )
                            ),

                            // Medium severity warnings
                            groupedWarnings.medium.length > 0 && h('div', { className: 'early-warning-modal__section' },
                                h('h3', { className: 'early-warning-modal__section-title early-warning-modal__section-title--medium' },
                                    '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ'
                                ),
                                groupedWarnings.medium.map((warning, idx) =>
                                    h(WarningCard, {
                                        key: idx,
                                        warning,
                                        onViewDetails: handleViewDetails
                                    })
                                )
                            ),

                            // Low severity warnings
                            groupedWarnings.low.length > 0 && h('div', { className: 'early-warning-modal__section' },
                                h('h3', { className: 'early-warning-modal__section-title early-warning-modal__section-title--low' },
                                    '‚ÑπÔ∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'
                                ),
                                groupedWarnings.low.map((warning, idx) =>
                                    h(WarningCard, {
                                        key: idx,
                                        warning,
                                        onViewDetails: handleViewDetails
                                    })
                                )
                            )
                        )
                ),

                // Footer (actions)
                activeWarnings.length > 0 && h('div', { className: 'early-warning-modal__footer' },
                    h('button', {
                        className: 'early-warning-modal__footer-btn early-warning-modal__footer-btn--primary',
                        onClick: onClose
                    }, '–ó–∞–∫—Ä—ã—Ç—å')
                )
            )
        );

        if (ReactDOM && typeof ReactDOM.createPortal === 'function' && global.document?.body) {
            return ReactDOM.createPortal(modalNode, global.document.body);
        }

        return modalNode;
    }

    // Global EWS Panel Manager ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª—å—é
    // –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (header badge, –≤–∏–¥–∂–µ—Ç—ã –∏ —Ç.–¥.)
    let globalPanelState = {
        isOpen: false,
        warnings: null,
        mode: 'full',
        container: null
    };

    /**
     * –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è EWS –ø–∞–Ω–µ–ª–∏ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏
     * @param {Array} warnings - –º–∞—Å—Å–∏–≤ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
     * @param {string} mode - 'acute' (10 checks, 7d badge) or 'full' (25 checks, 30d insights)
     */
    function showEWSPanel(warnings, mode = 'full') {
        if (!warnings || warnings.length === 0) {
            console.warn('ews / panel ‚ö†Ô∏è no warnings to display');
            return;
        }

        console.info('ews / panel üö® opening panel with', warnings.length, 'warnings, mode:', mode);
        globalPanelState.isOpen = true;
        globalPanelState.warnings = warnings;
        globalPanelState.mode = mode;
        renderGlobalPanel();
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–∞–Ω–µ–ª—å
     */
    function hideEWSPanel() {
        console.info('ews / panel closing panel');
        globalPanelState.isOpen = false;
        renderGlobalPanel();
    }

    /**
     * –†–µ–Ω–¥–µ—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏
     */
    function renderGlobalPanel() {
        if (!global.document || !ReactDOM) return;

        // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!globalPanelState.container) {
            globalPanelState.container = global.document.getElementById('ews-panel-root');
            if (!globalPanelState.container) {
                globalPanelState.container = global.document.createElement('div');
                globalPanelState.container.id = 'ews-panel-root';
                global.document.body.appendChild(globalPanelState.container);
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –ø–∞–Ω–µ–ª—å
        const root = ReactDOM.createRoot || ((container) => ({
            render: (element) => ReactDOM.render(element, container)
        }));

        if (ReactDOM.createRoot && !globalPanelState.container.__reactRoot) {
            globalPanelState.container.__reactRoot = ReactDOM.createRoot(globalPanelState.container);
        }

        const rootInstance = globalPanelState.container.__reactRoot || root(globalPanelState.container);
        rootInstance.render(
            globalPanelState.isOpen
                ? h(EarlyWarningPanel, {
                    isOpen: true,
                    onClose: hideEWSPanel,
                    warnings: globalPanelState.warnings || [],
                    mode: globalPanelState.mode || 'full'
                })
                : null
        );
    }

    // Export
    HEYS.EarlyWarningPanel = EarlyWarningPanel;
    HEYS.showEWSPanel = showEWSPanel;
    HEYS.hideEWSPanel = hideEWSPanel;

    // Event listener –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
    if (global.window) {
        window.addEventListener('heysShowEWSPanel', function (event) {
            const warnings = event.detail?.warnings;
            const mode = event.detail?.mode || 'full';  // Default to 'full' for backward compat

            if (warnings && warnings.length > 0) {
                showEWSPanel(warnings, mode);
            } else {
                console.warn('ews / panel ‚ö†Ô∏è event received but no warnings in event.detail');
            }
        });
    }

    console.info('ews / panel ‚úÖ component loaded + global panel manager');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_gamification_bar_v1.js ===== */
// heys_gamification_bar_v1.js ‚Äî GamificationBar extracted from heys_app_v12.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    /**
     * –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ streak —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç race condition.
     * @returns {number} –¢–µ–∫—É—â–∏–π streak –∏–ª–∏ 0 –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
     */
    function safeGetStreak() {
        try {
            return typeof HEYS.Day?.getStreak === 'function' ? HEYS.Day.getStreak() : 0;
        } catch {
            return 0;
        }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º helper –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    HEYS.utils = HEYS.utils || {};
    HEYS.utils.safeGetStreak = safeGetStreak;

    function GamificationBar() {
        const React = window.React;
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const AUDIT_LOG_PREFIX = '[HEYS.game.audit]';
        const GAME_SYNC_LOG_PREFIX = '[GAMESYNH]';
        const logAuditInfo = (...args) => console.info(AUDIT_LOG_PREFIX, ...args);
        const logAuditWarn = (...args) => console.warn(AUDIT_LOG_PREFIX, ...args);
        const logAuditError = (...args) => console.error(AUDIT_LOG_PREFIX, ...args);
        const logSyncInfo = (...args) => console.info(GAME_SYNC_LOG_PREFIX, ...args);

        const [stats, setStats] = useState(() => {
            return HEYS.game ? HEYS.game.getStats() : {
                totalXP: 0,
                level: 1,
                title: { icon: 'üå±', title: '–ù–æ–≤–∏—á–æ–∫', color: '#94a3b8' },
                progress: { current: 0, required: 100, percent: 0 },
                unlockedCount: 0,
                totalAchievements: 25
            };
        });
        const [streak, setStreak] = useState(() => safeGetStreak());
        const [streakJustGrew, setStreakJustGrew] = useState(false);
        const prevStreakRef = useRef(streak);
        const [expanded, setExpanded] = useState(false);
        const [notification, setNotification] = useState(null);
        const [isXPCounting, setIsXPCounting] = useState(false);
        const [isLevelUpFlash, setIsLevelUpFlash] = useState(false);
        const [dailyBonusAvailable, setDailyBonusAvailable] = useState(() => {
            return HEYS.game ? HEYS.game.canClaimDailyBonus() : false;
        });
        const [dailyBonusLoading, setDailyBonusLoading] = useState(false);
        const [justUnlockedAch, setJustUnlockedAch] = useState(null);
        const [dailyMultiplier, setDailyMultiplier] = useState(() => {
            return HEYS.game ? HEYS.game.getDailyMultiplier() : { multiplier: 1, actions: 0, label: '' };
        });
        const [weeklyChallenge, setWeeklyChallenge] = useState(() => {
            return HEYS.game ? HEYS.game.getWeeklyChallenge() : { earned: 0, target: 500, percent: 0, completed: false };
        });
        const [xpHistory, setXpHistory] = useState(() => {
            return HEYS.game && HEYS.game.getXPHistory ? HEYS.game.getXPHistory() : [];
        });
        const [levelGuardActive, setLevelGuardActive] = useState(true);
        const levelGuardTimerRef = useRef(null);
        const prevLevelRef = useRef(stats.level);

        // üîç DIAGLOG: –ª–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî —á—Ç–æ –±—ã–ª–æ –≤ localStorage –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        useEffect(() => {
            logSyncInfo('UI mount:initial-stats', {
                totalXP: stats.totalXP,
                level: stats.level,
                guard: levelGuardActive,
                gameReady: !!HEYS.game
            });
            // eslint-disable-next-line react-hooks/exhaustive-deps
        }, []);
        const [storyAchId, setStoryAchId] = useState(null);
        const [levelUpModal, setLevelUpModal] = useState(null);
        const levelUpTimerRef = useRef(null);
        const [xpBursts, setXpBursts] = useState([]);
        const xpBurstIdRef = useRef(0);
        const [notifPulse, setNotifPulse] = useState(false);
        const [confettiBurst, setConfettiBurst] = useState(null);
        const [weeklyCeremony, setWeeklyCeremony] = useState(null);
        const [progressMilestone, setProgressMilestone] = useState(null);
        const progressMilestoneTimerRef = useRef(null);
        const [bigXpGlow, setBigXpGlow] = useState(false);
        const [personalBestPulse, setPersonalBestPulse] = useState(false);
        const [xpHistoryAnimate, setXpHistoryAnimate] = useState(false);
        const [streakCelebration, setStreakCelebration] = useState(null);
        const streakMilestoneRef = useRef(0);
        const streakToastTimerRef = useRef(null);
        const [dailyMissions, setDailyMissions] = useState(() => {
            return HEYS.game?.getDailyMissions ? HEYS.game.getDailyMissions() : null;
        });
        const [isOnboardingTipOpen, setIsOnboardingTipOpen] = useState(false);
        const [auditOpen, setAuditOpen] = useState(false);
        const [auditEvents, setAuditEvents] = useState([]);
        const [auditLoading, setAuditLoading] = useState(false);
        const [auditError, setAuditError] = useState(null);

        // === Onboarding Fusion Ceremony ===
        const [fusionPhase, setFusionPhase] = useState(null); // null | 'gather' | 'merge' | 'medal' | 'fly' | 'done'
        const fusionMedalRef = useRef(null);
        const targetMedalRef = useRef(null);
        const fusionTimerRef = useRef(null);

        const ONBOARDING_ACHIEVEMENTS = useMemo(() => [
            'first_checkin',
            'first_meal',
            'first_product',
            'first_steps',
            'first_advice',
            'first_supplements',
            'first_water',
            'first_training',
            'first_household'
        ], []);

        const isOnboardingComplete = useCallback(() => {
            if (!HEYS.game) return false;
            return ONBOARDING_ACHIEVEMENTS.every((achId) => HEYS.game.isAchievementUnlocked(achId));
        }, [ONBOARDING_ACHIEVEMENTS]);

        // Track previous onboarding state to detect the moment it completes
        const prevOnboardingDoneRef = useRef(false);
        const fusionShownRef = useRef(false);

        const onboardingDone = isOnboardingComplete();

        useEffect(() => {
            if (HEYS.game) HEYS.game.useReactXPFX = true;
            return () => {
                if (HEYS.game) HEYS.game.useReactXPFX = false;
            };
        }, []);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º daily bonus –∏ streak –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ + —Å–ª—É—à–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Day
        useEffect(() => {
            const updateStreak = () => {
                const newStreak = safeGetStreak();
                setStreak(prev => prev === newStreak ? prev : newStreak);
            };

            const handleStreakEvent = (e) => {
                if (e.detail && typeof e.detail.streak === 'number') {
                    setStreak(e.detail.streak);
                }
            };

            if (HEYS.game) {
                setDailyBonusAvailable(HEYS.game.canClaimDailyBonus());
                if (HEYS.game.refreshDailyBonusFromAudit) {
                    HEYS.game.refreshDailyBonusFromAudit()
                        .then(() => {
                            setDailyBonusAvailable(HEYS.game.canClaimDailyBonus());
                        })
                        .catch(() => { });
                }
            }

            // –ü—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É
            updateStreak();

            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è streak –∏–∑ DayTab
            window.addEventListener('heysDayStreakUpdated', handleStreakEvent);

            return () => {
                window.removeEventListener('heysDayStreakUpdated', handleStreakEvent);
            };
        }, []);

        // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è XP
        useEffect(() => {
            // === ONBOARDING TOUR TRIGGER ===
            // üîê v1.7: –¢—É—Ä –¢–û–õ–¨–ö–û –¥–ª—è PIN-–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –ù–ï –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤/–≥–æ—Å—Ç–µ–π
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç, –Ω–æ–≤—ã–π (—É—Ä–æ–≤–µ–Ω—å 1, <50 XP) –∏ —Ç—É—Ä –Ω–µ –ø—Ä–æ–π–¥–µ–Ω
            const isClient = window.HEYS._tour?.isClientAuthorized?.();
            if (HEYS.OnboardingTour && HEYS.game && isClient) {
                const stats = HEYS.game.getStats();
                // üÜï v1.14: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≥–ª–∞—Å–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç—É—Ä–∞
                const consentsReady = HEYS._consentsChecked && HEYS._consentsValid;
                if (stats && stats.level === 1 && stats.totalXP < 50 && consentsReady) {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –≤—Å—ë –ø—Ä–æ–≥—Ä—É–∑–∏–ª–æ—Å—å
                    setTimeout(() => {
                        HEYS.OnboardingTour.start();
                    }, 2000);
                }
            }

            // üîç DIAGLOG: –ª–æ–≥–∏—Ä—É–µ–º –º–æ–º–µ–Ω—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–ª—É—à–∞—Ç–µ–ª—è
            logSyncInfo('UI heysGameUpdate:listener-registered', { at: new Date().toISOString() });

            const handleUpdate = (e) => {
                // üîç DIAGLOG + guard-release —Ä–∞–±–æ—Ç–∞—é—Ç –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç HEYS.game
                // RC fix v6.4: –µ—Å–ª–∏ gameReady:false (HEYS.game=null) ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–Ω–∏–º–∞–µ–º guard
                // –ø–æ —Å–æ–±—ã—Ç–∏—é cloud_load_complete, –∏—Å–ø–æ–ª—å–∑—É—è e.detail –Ω–∞–ø—Ä—è–º—É—é.
                const _evtReason = typeof e?.detail?.reason === 'string' ? e.detail.reason : '(no reason)';
                const _evtIsInitial = !!e?.detail?.isInitialLoad;
                const _evtXP = typeof e?.detail?.totalXP === 'number' ? e.detail.totalXP : (HEYS.game?.getStats?.()?.totalXP ?? 0);
                const _evtLevel = typeof e?.detail?.level === 'number' ? e.detail.level : (HEYS.game?.getStats?.()?.level ?? 1);
                logSyncInfo('UI heysGameUpdate:received', {
                    reason: _evtReason,
                    totalXP: _evtXP,
                    level: _evtLevel,
                    isInitialLoad: _evtIsInitial,
                    guardActive: levelGuardActive,
                    gameReady: !!HEYS.game
                });

                // üõ°Ô∏è Level Guard: —Å–Ω–∏–º–∞–µ–º –í–°–ï–ì–î–ê –ø—Ä–∏ –Ω—É–∂–Ω—ã—Ö reason ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ HEYS.game –µ—â—ë null
                const _hasXpGained = typeof e?.detail?.xpGained === 'number' && e.detail.xpGained > 0;
                if (_evtReason === 'xp_fast_sync' || _evtReason === 'xp_rebuild' ||
                    _evtReason === 'cloud_load_complete' || _evtReason === 'cloud_load_error' ||
                    (_hasXpGained && !_evtIsInitial)) {
                    logSyncInfo('UI guard:OFF', { reason: _evtReason, isInitialLoad: _evtIsInitial, hasXpGained: _hasXpGained });
                    // –û—Ç–º–µ–Ω—è–µ–º fallback-—Ç–∞–π–º–µ—Ä ‚Äî guard —Å–Ω—è—Ç event-driven, —Ç–∞–π–º–µ—Ä –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
                    if (levelGuardTimerRef.current) {
                        clearTimeout(levelGuardTimerRef.current);
                        levelGuardTimerRef.current = null;
                    }
                    setLevelGuardActive(false);
                }

                if (HEYS.game) {
                    const newStats = HEYS.game.getStats();

                    // XP counting animation
                    if (e.detail && e.detail.xpGained > 0) {
                        setIsXPCounting(true);
                        setTimeout(() => setIsXPCounting(false), 400);
                        if (e.detail.xpGained >= 50) {
                            setBigXpGlow(true);
                            setTimeout(() => setBigXpGlow(false), 900);
                        }
                    }

                    // Level up flash
                    const prevLevel = prevLevelRef.current;
                    const hasXpGained = typeof e?.detail?.xpGained === 'number' && e.detail.xpGained > 0;
                    const reason = typeof e?.detail?.reason === 'string' ? e.detail.reason : '';
                    const hasReason = reason.length > 0;
                    // üîí v4.0: isInitialLoad ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ/—Å–∏–Ω–∫–µ/—Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
                    const isInitialLoad = !!e?.detail?.isInitialLoad;
                    // üîí v4.1: xp_fast_sync ‚Äî reconciliation –ø—Ä–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ XP-–∫–µ—à–∞, –≤—Å–µ–≥–¥–∞ suppress
                    const isSyncUpdate = isInitialLoad || reason === 'xp_fast_sync' || (!hasXpGained && (!hasReason || reason === 'client_changed' || reason === 'xp_rebuild'));

                    if (newStats.level > prevLevel) {
                        if (!isSyncUpdate) {
                            console.info('[üéÆ GamificationBar] üéâ LEVEL UP modal! level:', prevLevel, '‚Üí', newStats.level,
                                '| xpGained:', e?.detail?.xpGained, '| reason:', reason, '| isInitialLoad:', isInitialLoad,
                                '| isSyncUpdate:', isSyncUpdate);
                            setIsLevelUpFlash(true);
                            setTimeout(() => setIsLevelUpFlash(false), 1000);

                            setLevelUpModal({
                                level: newStats.level,
                                title: newStats.title?.title || '–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å',
                                icon: newStats.title?.icon || 'üéâ',
                                color: newStats.title?.color || '#22c55e'
                            });

                            if (levelUpTimerRef.current) clearTimeout(levelUpTimerRef.current);
                            levelUpTimerRef.current = setTimeout(() => {
                                setLevelUpModal(null);
                            }, 2600);
                        } else {
                            console.info('[üéÆ GamificationBar] üîí Level up SUPPRESSED:', prevLevel, '‚Üí', newStats.level,
                                '| reason:', reason, '| isInitialLoad:', isInitialLoad, '| isSyncUpdate:', isSyncUpdate);
                        }

                        prevLevelRef.current = newStats.level;
                    }

                    // üîí –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º stats –µ—Å–ª–∏ –æ–Ω–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ)
                    setStats(prevStats => {
                        if (prevStats &&
                            prevStats.totalXP === newStats.totalXP &&
                            prevStats.level === newStats.level &&
                            prevStats.unlockedCount === newStats.unlockedCount &&
                            prevStats.progress?.percent === newStats.progress?.percent) {
                            return prevStats; // –ë–µ–∑ —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–∞
                        }
                        return newStats;
                    });
                } else if (e?.detail?.totalXP != null && e?.detail?.level != null) {
                    // RC fix v6.4: HEYS.game –µ—â—ë null (gameReady:false) ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º stats –∏–∑ e.detail
                    // —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è guard
                    const detailStats = {
                        totalXP: e.detail.totalXP,
                        level: e.detail.level,
                        title: e.detail.title || { icon: 'üå±', title: '–ù–æ–≤–∏—á–æ–∫', color: '#94a3b8' },
                        progress: e.detail.progress || { current: 0, required: 100, percent: 0 },
                        unlockedCount: e.detail.unlockedCount || 0,
                        totalAchievements: e.detail.totalAchievements || 25
                    };
                    logSyncInfo('UI stats:from-detail-fallback', { totalXP: detailStats.totalXP, level: detailStats.level });
                    setStats(detailStats);
                }
                setDailyBonusAvailable(prev => {
                    const next = HEYS.game ? HEYS.game.canClaimDailyBonus() : false;
                    return prev === next ? prev : next;
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º streak (–∏—Å–ø–æ–ª—å–∑—É–µ–º safeGetStreak –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç race condition)
                setStreak(prevStreak => {
                    const newStreak = safeGetStreak();
                    // Pulse –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ streak
                    if (newStreak > prevStreakRef.current) {
                        setStreakJustGrew(true);
                        setTimeout(() => setStreakJustGrew(false), 700);
                    }
                    prevStreakRef.current = newStreak;
                    return prevStreak === newStreak ? prevStreak : newStreak;
                });

                if (HEYS.game?.getDailyMissions) {
                    setDailyMissions(HEYS.game.getDailyMissions());
                }
            };

            const handleNotification = (e) => {
                setNotification(e.detail);
                setNotifPulse(true);
                setTimeout(() => setNotifPulse(false), 1200);
                setTimeout(() => setNotification(null), e.detail.type === 'level_up' ? 4000 : 3000);

                // Achievement unlock animation
                if (e.detail.type === 'achievement') {
                    setJustUnlockedAch(e.detail.data.achievement.id);
                    setTimeout(() => setJustUnlockedAch(null), 1000);

                    const rarity = e.detail.data.achievement?.rarity;
                    if (['rare', 'epic', 'legendary', 'mythic'].includes(rarity)) {
                        setConfettiBurst({ rarity });
                        setTimeout(() => setConfettiBurst(null), 1800);
                    }

                    // === Detect onboarding completion ‚Üí trigger fusion ceremony ===
                    const achId = e.detail.data.achievement?.id;
                    if (achId && ONBOARDING_ACHIEVEMENTS.includes(achId) && !fusionShownRef.current) {
                        // Check if this was the LAST onboarding achievement
                        setTimeout(() => {
                            if (isOnboardingComplete() && !prevOnboardingDoneRef.current && !fusionShownRef.current) {
                                fusionShownRef.current = true;
                                prevOnboardingDoneRef.current = true;
                                startFusionCeremony();
                            }
                        }, 1200); // Wait for single-achievement notification to finish
                    }
                }
            };

            const handleDailyMultiplierUpdate = (e) => {
                setDailyMultiplier(e.detail);
            };

            const handleWeeklyUpdate = () => {
                if (HEYS.game) {
                    // üîí –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º functional updates –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–∏—à–Ω–∏—Ö —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–æ–≤
                    const newChallenge = HEYS.game.getWeeklyChallenge();
                    setWeeklyChallenge(prev => {
                        if (prev && newChallenge &&
                            prev.type === newChallenge.type &&
                            prev.progress === newChallenge.progress) {
                            return prev;
                        }
                        return newChallenge;
                    });

                    const newMultiplier = HEYS.game.getDailyMultiplier();
                    setDailyMultiplier(prev => prev === newMultiplier ? prev : newMultiplier);

                    if (HEYS.game.getXPHistory) {
                        const newHistory = HEYS.game.getXPHistory();
                        setXpHistory(prev => {
                            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –¥–ª–∏–Ω–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                            if (prev && newHistory &&
                                prev.length === newHistory.length &&
                                JSON.stringify(prev[prev.length - 1]) === JSON.stringify(newHistory[newHistory.length - 1])) {
                                return prev;
                            }
                            return newHistory;
                        });
                    }
                }
            };

            window.addEventListener('heysGameUpdate', handleUpdate);

            window.addEventListener('heysGameNotification', handleNotification);
            window.addEventListener('heysProductAdded', handleUpdate);
            window.addEventListener('heysWaterAdded', handleUpdate);
            window.addEventListener('heysDailyMultiplierUpdate', handleDailyMultiplierUpdate);
            window.addEventListener('heysGameUpdate', handleWeeklyUpdate);

            return () => {
                window.removeEventListener('heysGameUpdate', handleUpdate);
                window.removeEventListener('heysGameNotification', handleNotification);
                window.removeEventListener('heysProductAdded', handleUpdate);
                window.removeEventListener('heysWaterAdded', handleUpdate);
                window.removeEventListener('heysDailyMultiplierUpdate', handleDailyMultiplierUpdate);
                window.removeEventListener('heysGameUpdate', handleWeeklyUpdate);
            };
        }, []);

        // üîí Guard –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —É—Ä–æ–≤–µ–Ω—å,
        // –ø–æ–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø–µ—Ä–≤–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.
        // RC-1 fix: —É–±—Ä–∞–Ω 1200ms timer –∏–∑ handleSyncCompleted ‚Äî –æ–Ω —Å–Ω–∏–º–∞–ª guard –†–ê–ù–¨–®–ï
        // —á–µ–º loadFromCloud –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è (~1400-1640ms). Guard —Ç–µ–ø–µ—Ä—å —Å–Ω–∏–º–∞–µ—Ç—Å—è event-driven
        // —á–µ—Ä–µ–∑ reason: 'cloud_load_complete' –≤ handleUpdate. –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ 15s safety fallback.
        useEffect(() => {
            const handleSyncCompleted = () => {
                logSyncInfo('UI event:heysSyncCompleted', { action: 'pipeline_started_data_driven_guard' });
                // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–¥–µ—Å—å ‚Äî guard —Å–Ω–∏–º–µ—Ç—Å—è —á–µ—Ä–µ–∑ heysGameUpdate(cloud_load_complete)
            };

            window.addEventListener('heysSyncCompleted', handleSyncCompleted);

            // RC-4 fix: Fallback –ø–æ–¥–Ω—è—Ç —Å 8s –¥–æ 15s ‚Äî –Ω–∞ —Å–ª—É—á–∞–π —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫ –∏–ª–∏ –∑–∞–≤–∏—Å—à–µ–≥–æ pipeline.
            if (levelGuardTimerRef.current) clearTimeout(levelGuardTimerRef.current);
            levelGuardTimerRef.current = setTimeout(() => {
                logSyncInfo('UI guard:OFF', { reason: 'fallback_timeout_45000ms' });
                setLevelGuardActive(false);
            }, 45000);

            return () => {
                window.removeEventListener('heysSyncCompleted', handleSyncCompleted);
                if (levelGuardTimerRef.current) {
                    clearTimeout(levelGuardTimerRef.current);
                    levelGuardTimerRef.current = null;
                }
            };
        }, []);

        // üîÑ v3.1: –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å UI –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –∫—É—Ä–∞—Ç–æ—Ä–æ–º
        useEffect(() => {
            const handleClientChanged = () => {
                logSyncInfo('UI guard:ON', { reason: 'client_changed' });
                setLevelGuardActive(true);
                // RC-4 fix: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º fallback-—Ç–∞–π–º–µ—Ä –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞.
                // Guard –≤–∫–ª—é—á–∏–ª—Å—è, –Ω–æ pipeline —Å—Ç–∞—Ä—Ç—É–µ—Ç –∑–∞–Ω–æ–≤–æ ‚Äî –Ω—É–∂–µ–Ω —Å–≤–µ–∂–∏–π safety timeout.
                if (levelGuardTimerRef.current) clearTimeout(levelGuardTimerRef.current);
                levelGuardTimerRef.current = setTimeout(() => {
                    logSyncInfo('UI guard:OFF', { reason: 'client_changed_fallback_timeout_45000ms' });
                    setLevelGuardActive(false);
                }, 45000);
                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω—É–ª—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ –¥–µ—Ñ–æ–ª—Ç–æ–≤, –ø–æ–∫–∞ –≥—Ä—É–∑—è—Ç—Å—è –Ω–æ–≤—ã–µ
                const freshStats = HEYS.game ? HEYS.game.getStats() : {
                    totalXP: 0, level: 1,
                    title: { icon: 'üå±', title: '–ù–æ–≤–∏—á–æ–∫', color: '#94a3b8' },
                    progress: { current: 0, required: 100, percent: 0 },
                    unlockedCount: 0, totalAchievements: 25
                };
                logSyncInfo('UI client_changed:freshStats', { totalXP: freshStats.totalXP, level: freshStats.level, gameReady: !!HEYS.game });
                setStats(freshStats);
                setStreak(safeGetStreak());
                setXpHistory(HEYS.game?.getXPHistory ? HEYS.game.getXPHistory() : []);
                setWeeklyChallenge(HEYS.game ? HEYS.game.getWeeklyChallenge() : { earned: 0, target: 500, percent: 0, completed: false });
                setDailyMultiplier(HEYS.game ? HEYS.game.getDailyMultiplier() : { multiplier: 1, actions: 0, label: '' });
                setDailyBonusAvailable(HEYS.game ? HEYS.game.canClaimDailyBonus() : false);
                if (HEYS.game?.refreshDailyBonusFromAudit) {
                    HEYS.game.refreshDailyBonusFromAudit()
                        .then(() => {
                            setDailyBonusAvailable(HEYS.game.canClaimDailyBonus());
                        })
                        .catch(() => { });
                }
                setDailyMissions(HEYS.game?.getDailyMissions ? HEYS.game.getDailyMissions() : null);
                prevLevelRef.current = freshStats.level;
                prevStreakRef.current = safeGetStreak();
            };

            window.addEventListener('heys:client-changed', handleClientChanged);
            return () => window.removeEventListener('heys:client-changed', handleClientChanged);
        }, []);

        useEffect(() => {
            const handleWeeklyComplete = (e) => {
                const detail = e?.detail || {};
                if (!detail.challenge) return;
                setWeeklyCeremony({
                    title: detail.challenge.title || detail.challenge.name || '–ù–µ–¥–µ–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂',
                    reward: detail.reward || detail.challenge.reward || 100,
                    icon: detail.challenge.icon || 'üèÜ'
                });
            };

            const handleMilestone = (e) => {
                const milestone = e?.detail?.milestone;
                if (!milestone) return;
                setProgressMilestone(milestone);
                if (progressMilestoneTimerRef.current) clearTimeout(progressMilestoneTimerRef.current);
                progressMilestoneTimerRef.current = setTimeout(() => setProgressMilestone(null), 900);
            };

            window.addEventListener('heysWeeklyChallengeComplete', handleWeeklyComplete);
            window.addEventListener('heysProgressMilestone', handleMilestone);

            return () => {
                window.removeEventListener('heysWeeklyChallengeComplete', handleWeeklyComplete);
                window.removeEventListener('heysProgressMilestone', handleMilestone);
            };
        }, []);

        useEffect(() => {
            const handleXpGained = (e) => {
                const detail = e?.detail || {};
                if (!detail.xp) return;

                const id = xpBurstIdRef.current++;
                setXpBursts(prev => ([
                    ...prev,
                    { id, xp: detail.xp, x: detail.x, y: detail.y }
                ]));

                setTimeout(() => {
                    setXpBursts(prev => prev.filter(item => item.id !== id));
                }, 900);
            };

            const handleDailyMissionsUpdate = (e) => {
                setDailyMissions(e?.detail || (HEYS.game?.getDailyMissions ? HEYS.game.getDailyMissions() : null));
            };

            window.addEventListener('heysXpGained', handleXpGained);
            window.addEventListener('heysDailyMissionsUpdate', handleDailyMissionsUpdate);

            return () => {
                window.removeEventListener('heysXpGained', handleXpGained);
                window.removeEventListener('heysDailyMissionsUpdate', handleDailyMissionsUpdate);
            };
        }, []);

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ streak (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
        useEffect(() => {
            const interval = setInterval(() => {
                const newStreak = safeGetStreak();
                setStreak(prev => prev === newStreak ? prev : newStreak);
            }, 30000);
            return () => clearInterval(interval);
        }, []);

        useEffect(() => {
            const milestones = [1, 2, 3, 5, 7];
            if (!milestones.includes(streak)) return;
            if (streak <= streakMilestoneRef.current) return;

            streakMilestoneRef.current = streak;
            setStreakCelebration(streak);
            if (streakToastTimerRef.current) clearTimeout(streakToastTimerRef.current);
            streakToastTimerRef.current = setTimeout(() => setStreakCelebration(null), 2200);

            if (HEYS.game?.isNewStreakRecord?.()) {
                setPersonalBestPulse(true);
                setTimeout(() => setPersonalBestPulse(false), 1000);
            }
        }, [streak]);

        useEffect(() => {
            if (!expanded) return;
            setXpHistoryAnimate(true);
            const timer = setTimeout(() => setXpHistoryAnimate(false), 900);
            return () => clearTimeout(timer);
        }, [expanded]);

        const loadAuditHistory = useCallback(async () => {
            if (!HEYS.game?.getAuditHistory) {
                logAuditWarn('load:skip', { reason: 'getAuditHistory_missing' });
                return;
            }
            const startedAt = Date.now();
            logAuditInfo('load:start', { limit: 50, offset: 0, expanded, auditOpen });
            setAuditLoading(true);
            setAuditError(null);

            const result = await HEYS.game.getAuditHistory({ limit: 50, offset: 0 });
            if (result?.error) {
                const message = result.error?.message || result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é';
                logAuditError('load:error', {
                    message,
                    code: result.error?.code,
                    tookMs: Date.now() - startedAt
                });
                setAuditError(message);
                setAuditEvents([]);
                setAuditLoading(false);
                return;
            }

            const items = Array.isArray(result?.items) ? result.items : [];
            logAuditInfo('load:success', {
                count: items.length,
                total: typeof result?.total === 'number' ? result.total : null,
                tookMs: Date.now() - startedAt
            });
            setAuditEvents(items);
            setAuditLoading(false);
        }, []);

        // üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        const copyFullAuditLog = useCallback(async () => {
            if (!HEYS.game?.getAuditHistory) {
                logAuditWarn('copy:skip', { reason: 'getAuditHistory_missing' });
                HEYS.Toast?.error?.('–ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                return;
            }

            logAuditInfo('copy:start');
            const startedAt = Date.now();
            const allEvents = [];
            const batchSize = 100;
            let offset = 0;
            let hasMore = true;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
            HEYS.Toast?.info?.('–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é...');

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–∞—á–∫–∞–º–∏
                while (hasMore) {
                    const result = await HEYS.game.getAuditHistory({ limit: batchSize, offset });

                    if (result?.error) {
                        throw new Error(result.error?.message || result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                    }

                    const items = Array.isArray(result?.items) ? result.items : [];
                    allEvents.push(...items);

                    logAuditInfo('copy:batch', { offset, loaded: items.length, total: allEvents.length });

                    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ —á–µ–º batchSize, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–∞—á–∫–∞
                    if (items.length < batchSize) {
                        hasMore = false;
                    } else {
                        offset += batchSize;
                    }

                    // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                    if (offset > 10000) {
                        logAuditWarn('copy:limit', { offset });
                        hasMore = false;
                    }
                }

                logAuditInfo('copy:loaded', { total: allEvents.length, tookMs: Date.now() - startedAt });

                // üîç –§–∏–ª—å—Ç—Ä—É–µ–º xp_rebuild +0 (—Å–ø–∞–º)
                const filteredEvents = allEvents.filter(e => {
                    if (e.action === 'xp_rebuild' && (e.xp_delta === 0 || !e.xp_delta)) return false;
                    return true;
                });
                const hiddenCount = allEvents.length - filteredEvents.length;

                // üîç –°—á—ë—Ç—á–∏–∫ –¥—É–±–ª–µ–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏)
                const achievementCounts = {};
                filteredEvents.forEach((e) => {
                    if (e.action === 'achievement_unlocked' && e.reason) {
                        achievementCounts[e.reason] = (achievementCounts[e.reason] || 0) + 1;
                    }
                });

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –≤ —Ç–µ–∫—Å—Ç
                const lines = [
                    '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                    'üéÆ –ò–°–¢–û–†–ò–Ø –û–ü–´–¢–ê HEYS',
                    `–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: ${filteredEvents.length}${hiddenCount > 0 ? ` (—Å–∫—Ä—ã—Ç–æ ${hiddenCount} rebuild +0)` : ''}`,
                    `–î–∞—Ç–∞ –≤—ã–≥—Ä—É–∑–∫–∏: ${new Date().toLocaleString('ru-RU')}`,
                    '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                    ''
                ];

                filteredEvents.forEach((event, idx) => {
                    const meta = event?.metadata || {};
                    const actionLabel = getAuditActionLabel(event.action, meta);
                    const reasonLabel = getAuditReasonLabel(event.reason);
                    const when = event.created_at
                        ? new Date(event.created_at).toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                        : '';
                    const actorLabel = event.actor_type === 'curator'
                        ? '–ö—É—Ä–∞—Ç–æ—Ä'
                        : event.actor_type === 'pin'
                            ? 'PIN'
                            : '–°–∏—Å—Ç–µ–º–∞';
                    const xpDelta = typeof event.xp_delta === 'number' ? event.xp_delta : null;
                    const levelBefore = event.level_before;
                    const levelAfter = event.level_after;

                    const isDupAchievement = event.action === 'achievement_unlocked' && event.reason && achievementCounts[event.reason] > 1;
                    const dupMark = isDupAchievement ? ' ‚ö†Ô∏è –¥—É–±–ª—å' : '';

                    lines.push(`${idx + 1}. ${actionLabel}${dupMark}`);
                    if (xpDelta !== null) lines.push(`   XP: +${xpDelta}`);
                    if (levelBefore && levelAfter && levelAfter !== levelBefore) {
                        lines.push(`   –£—Ä–æ–≤–µ–Ω—å: ${levelBefore} ‚Üí ${levelAfter}`);
                    }
                    if (reasonLabel) lines.push(`   –ü—Ä–∏—á–∏–Ω–∞: ${reasonLabel}`);
                    lines.push(`   –ö–µ–º: ${actorLabel} | –ö–æ–≥–¥–∞: ${when}`);
                    lines.push('');
                });

                lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                lines.push(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º:`);

                // –ü–æ–¥—Å—á—ë—Ç –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π
                const actionCounts = {};
                // FIX: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç XP ‚Äî —Ç–æ–ª—å–∫–æ xp_gain + daily_bonus + —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ achievement_unlocked
                // level_up –¥—É–±–ª–∏—Ä—É–µ—Ç xp_gain delta, xp_rebuild ‚Äî —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏, –Ω–µ –Ω–æ–≤—ã–π XP
                let totalXP = 0;
                const seenAchievements = new Set();
                filteredEvents.forEach(e => {
                    const label = getAuditActionLabel(e.action, e.metadata || {});
                    actionCounts[label] = (actionCounts[label] || 0) + 1;
                    const delta = typeof e.xp_delta === 'number' ? e.xp_delta : 0;
                    if ((e.action === 'xp_gain' || e.action === 'daily_bonus') && delta > 0) {
                        totalXP += delta;
                    } else if (e.action === 'achievement_unlocked' && e.reason && delta > 0) {
                        if (!seenAchievements.has(e.reason)) {
                            seenAchievements.add(e.reason);
                            totalXP += delta;
                        }
                    }
                });
                Object.entries(actionCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([label, count]) => {
                        lines.push(`  - ${label}: ${count} —Ä–∞–∑(–∞)`);
                    });

                // üîç –ü–æ–∫–∞–∑—ã–≤–∞–µ–º drift –µ—Å–ª–∏ –µ—Å—Ç—å
                const currentXP = HEYS.game?.getStats?.()?.totalXP || 0;
                const drift = currentXP - totalXP;
                const driftStr = drift !== 0 ? ` (Œ¥ ${drift > 0 ? '+' : ''}${drift})` : '';
                lines.push(`\n–ß–∏—Å—Ç—ã–π XP (audit): ${totalXP}`);
                lines.push(`UI XP: ${currentXP}${driftStr}`);
                lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                const text = lines.join('\n');

                // RC-7 fix: clipboard API —Ç—Ä–µ–±—É–µ—Ç —Ñ–æ–∫—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞.
                // –î–æ–±–∞–≤–ª–µ–Ω fallback —á–µ—Ä–µ–∑ execCommand –¥–ª—è —Å–ª—É—á–∞—è –∫–æ–≥–¥–∞ —Ñ–æ–∫—É—Å –ø–æ—Ç–µ—Ä—è–Ω (—Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞—è –ø–∞–Ω–µ–ª—å).
                try {
                    await navigator.clipboard.writeText(text);
                } catch (_clipErr) {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }

                logAuditInfo('copy:success', {
                    events: allEvents.length,
                    chars: text.length,
                    tookMs: Date.now() - startedAt
                });

                HEYS.Toast?.success?.(`–ò—Å—Ç–æ—Ä–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (${allEvents.length} —Å–æ–±—ã—Ç–∏–π)`);
            } catch (err) {
                logAuditError('copy:error', { message: err.message });
                HEYS.Toast?.error?.('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + err.message);
            }
        }, []);

        useEffect(() => {
            if (expanded && auditOpen) {
                logAuditInfo('auto-load', { expanded, auditOpen });
                loadAuditHistory();
                // üîç Auto-debug –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
                if (HEYS.game?.verifyXP) {
                    setTimeout(() => HEYS.game.verifyXP(), 500);
                }
            }
        }, [expanded, auditOpen, loadAuditHistory]);

        const toggleExpanded = () => {
            if (expanded) {
                setAuditOpen(false);
            }
            setExpanded(!expanded);
        };

        const { title, progress } = stats;
        const progressPercent = levelGuardActive ? 0 : Math.max(5, progress.percent); // Minimum 5% –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ feedback
        const avgDailyXP = xpHistory?.length
            ? Math.round(xpHistory.reduce((sum, d) => sum + (d?.xp || 0), 0) / xpHistory.length)
            : 0;
        const xpToNext = Math.max(0, progress.required - progress.current);
        const daysToNext = avgDailyXP > 0 ? Math.ceil(xpToNext / avgDailyXP) : null;
        const storyAchievement = storyAchId && HEYS.game?.ACHIEVEMENTS
            ? HEYS.game.ACHIEVEMENTS[storyAchId]
            : null;
        const storyUnlocked = storyAchId && HEYS.game?.isAchievementUnlocked
            ? HEYS.game.isAchievementUnlocked(storyAchId)
            : false;

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const isShimmering = progress.percent >= 80; // –ë–ª–∏–∫ –ø—Ä–∏ >80%
        const isPulsing = progress.percent >= 90;    // –ü—É–ª—å—Å–∞—Ü–∏—è –ø—Ä–∏ >90%
        const isGlowing = progress.percent >= 90;

        // Streak –∫–ª–∞—Å—Å –ø–æ —É—Ä–æ–≤–Ω—é
        const getStreakClass = (s) => {
            if (s >= 7) return 'streak-legendary';   // 7+ –¥–Ω–µ–π ‚Äî —Ä–∞–¥—É–∂–Ω—ã–π
            if (s >= 5) return 'streak-epic';        // 5+ –¥–Ω–µ–π ‚Äî –∑–æ–ª–æ—Ç–æ–π
            if (s >= 3) return 'streak-high';        // 3+ –¥–Ω–µ–π ‚Äî —è—Ä–∫–∏–π
            if (s >= 2) return 'streak-mid';         // 2 –¥–Ω—è ‚Äî –º–µ—Ä—Ü–∞—é—â–∏–π
            return 'streak-low';                     // 1 –¥–µ–Ω—å ‚Äî —Å—Ç–∞—Ç–∏—á–Ω—ã–π
        };

        const getStreakFlameClass = (s) => {
            if (s >= 30) return 'flame-legendary';
            if (s >= 14) return 'flame-epic';
            if (s >= 7) return 'flame-hot';
            if (s >= 3) return 'flame-warm';
            return 'flame-mild';
        };

        const handleOnboardingMedalToggle = (e) => {
            e.stopPropagation();
            setIsOnboardingTipOpen((prev) => !prev);
        };

        // === Onboarding Fusion Ceremony ===
        const ONBOARDING_ICONS = ['‚òÄÔ∏è', 'üçΩÔ∏è', 'ü•ó', 'üëü', 'üí°', 'üíä', 'üíß', 'üèÉ', 'üè†'];

        const startFusionCeremony = useCallback(() => {
            console.info('[üéÆ GamificationBar] üèÖ Starting onboarding fusion ceremony!');
            setFusionPhase('gather');

            // Timeline: gather (icons appear) ‚Üí merge (icons fly to center) ‚Üí medal (medal appears) ‚Üí subtitle/btn
            if (fusionTimerRef.current) clearTimeout(fusionTimerRef.current);

            // After icons have appeared (~1.5s) ‚Üí start merge
            fusionTimerRef.current = setTimeout(() => setFusionPhase('merge'), 2000);
        }, []);

        // Phase transitions via useEffect
        useEffect(() => {
            if (!fusionPhase) return;
            let t;
            if (fusionPhase === 'merge') {
                // After merge animation (~0.8s) ‚Üí show medal
                t = setTimeout(() => setFusionPhase('medal'), 800);
            } else if (fusionPhase === 'medal') {
                // Medal visible for 1.5s, then show button/text
                t = setTimeout(() => setFusionPhase('ready'), 600);
            }
            return () => { if (t) clearTimeout(t); };
        }, [fusionPhase]);

        // Init prevOnboardingDoneRef on mount (to avoid triggering on already-complete)
        useEffect(() => {
            if (isOnboardingComplete()) {
                prevOnboardingDoneRef.current = true;
                fusionShownRef.current = true;
            }
        }, []); // eslint-disable-line react-hooks/exhaustive-deps

        const handleFusionDismiss = useCallback(() => {
            // Expand gamification panel so the medal target is visible
            setExpanded(true);

            // Small delay to let DOM render the medal target
            setTimeout(() => {
                const targetEl = targetMedalRef.current || document.querySelector('.onboarding-medal');
                const medalEl = fusionMedalRef.current;

                const startFly = () => {
                    if (targetEl && medalEl) {
                        const targetRect = targetEl.getBoundingClientRect();
                        const medalRect = medalEl.getBoundingClientRect();

                        // Set initial position as fixed
                        setFusionPhase('fly');
                        medalEl.style.position = 'fixed';
                        medalEl.style.left = `${medalRect.left}px`;
                        medalEl.style.top = `${medalRect.top}px`;
                        medalEl.style.width = `${medalRect.width}px`;
                        medalEl.style.height = `${medalRect.height}px`;
                        medalEl.style.transform = 'none';
                        medalEl.style.transition = 'all 0.7s cubic-bezier(0.22, 1, 0.36, 1)';
                        medalEl.style.zIndex = '10080';

                        // Force reflow
                        medalEl.offsetHeight; // eslint-disable-line no-unused-expressions

                        // Fly to target
                        requestAnimationFrame(() => {
                            medalEl.style.left = `${targetRect.left}px`;
                            medalEl.style.top = `${targetRect.top}px`;
                            medalEl.style.width = `${targetRect.width}px`;
                            medalEl.style.height = `${targetRect.height}px`;
                            medalEl.style.fontSize = '26px';
                            medalEl.style.borderRadius = '14px';
                            medalEl.style.opacity = '0.8';
                        });

                        setTimeout(() => {
                            setFusionPhase(null);
                            // Add landing glow to the real medal
                            if (targetEl) {
                                targetEl.classList.add('fusion-landing');
                                setTimeout(() => targetEl.classList.remove('fusion-landing'), 800);
                            }
                        }, 750);
                    } else {
                        // No target element visible ‚Äî just close
                        setFusionPhase(null);
                    }

                    // Haptic feedback
                    if (HEYS.haptic) HEYS.haptic('success');
                };

                if (targetEl && typeof window !== 'undefined') {
                    const targetRect = targetEl.getBoundingClientRect();
                    const currentY = window.scrollY || window.pageYOffset || 0;
                    const targetY = Math.max(
                        0,
                        targetRect.top + currentY - (window.innerHeight / 2) + (targetRect.height / 2)
                    );
                    const distance = Math.abs(targetY - currentY);
                    const scrollDelay = Math.min(900, Math.max(300, Math.round(distance * 0.6)));

                    if (distance > 6) {
                        window.scrollTo({ top: targetY, behavior: 'smooth' });
                        setTimeout(startFly, scrollDelay);
                        return;
                    }
                }

                startFly();
            }, 100);
        }, []);

        // Generate confetti particles data
        const fusionConfetti = useMemo(() => {
            return Array.from({ length: 20 }, (_, i) => {
                const angle = (Math.PI * 2 * i) / 20 + Math.random() * 0.3;
                const distance = 80 + Math.random() * 60;
                const colors = ['#fbbf24', '#f59e0b', '#eab308', '#fcd34d', '#fef3c7', '#f97316', '#ef4444', '#22c55e', '#3b82f6'];
                return {
                    cx: `${Math.cos(angle) * distance}px`,
                    cy: `${Math.sin(angle) * distance}px`,
                    color: colors[i % colors.length],
                    delay: `${Math.random() * 0.3}s`,
                    size: 5 + Math.random() * 5
                };
            });
        }, []);

        // Calculate icon positions in a circle
        const fusionIconPositions = useMemo(() => {
            return ONBOARDING_ICONS.map((_, i) => {
                const angle = ((Math.PI * 2) / 9) * i - Math.PI / 2; // Start from top
                const radius = 90;
                return {
                    left: `${50 + (Math.cos(angle) * radius / 120) * 50}%`,
                    top: `${50 + (Math.sin(angle) * radius / 120) * 50}%`
                };
            });
        }, [ONBOARDING_ICONS]);

        // Ripple —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ —Ç–∞–ø–µ –ø–æ progress bar
        const handleProgressClick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.left = `${e.clientX - rect.left}px`;
            ripple.style.top = `${e.clientY - rect.top}px`;
            e.currentTarget.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        };

        const getAuditActionLabel = (action, metadata) => {
            const map = {
                xp_gain: '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ XP',
                level_up: '–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å',
                achievement_unlocked: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ',
                daily_bonus: '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å'
            };
            if (action === 'achievement_unlocked' && metadata?.achievementName) {
                return `–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${metadata.achievementName}`;
            }
            return map[action] || action || '–°–æ–±—ã—Ç–∏–µ';
        };

        const getAuditReasonLabel = (reason) => {
            if (!reason) return '';
            const actionLabel = HEYS.game?.XP_ACTIONS?.[reason]?.label;
            return actionLabel || reason;
        };

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–æ–ª–æ—Ç–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç ‚Äî —á–µ–º –±–ª–∏–∂–µ –∫ 100%, —Ç–µ–º —è—Ä—á–µ –∑–æ–ª–æ—Ç–æ
        const getProgressGradient = (percent) => {
            // –û—Ç –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω–æ–≥–æ (#b8860b / darkgoldenrod) –¥–æ —è—Ä–∫–æ–≥–æ (#ffd700 / gold)
            const t = percent / 100; // 0..1
            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è RGB: darkgoldenrod(184,134,11) ‚Üí gold(255,215,0)
            const r = Math.round(184 + (255 - 184) * t);
            const g = Math.round(134 + (215 - 134) * t);
            const b = Math.round(11 + (0 - 11) * t);
            const brightColor = `rgb(${r}, ${g}, ${b})`;
            // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –µ—â—ë —Ç–µ–º–Ω–µ–µ
            const startR = Math.round(140 + (184 - 140) * t);
            const startG = Math.round(100 + (134 - 100) * t);
            const startB = Math.round(20 + (11 - 20) * t);
            const startColor = `rgb(${startR}, ${startG}, ${startB})`;
            return `linear-gradient(90deg, ${startColor} 0%, ${brightColor} 100%)`;
        };

        return React.createElement('div', {
            className: `game-bar-container ${isLevelUpFlash ? 'level-up-flash' : ''}`
        },
            confettiBurst && React.createElement('div', {
                className: `game-confetti game-confetti--${confettiBurst.rarity}`
            },
                Array.from({ length: 24 }).map((_, i) =>
                    React.createElement('span', { key: i, className: 'game-confetti__piece' })
                )
            ),
            xpBursts.length > 0 && React.createElement('div', { className: 'flying-xp-layer' },
                xpBursts.map((item) => React.createElement('div', {
                    key: item.id,
                    className: 'flying-xp-item',
                    style: { '--x': `${item.x}px`, '--y': `${item.y}px` }
                }, `+${item.xp}`))
            ),
            // Main bar ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
            React.createElement('div', {
                className: 'game-bar',
                onClick: toggleExpanded
            },
                // Level + Rank Badge (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
                // –í—Å–µ–≥–¥–∞ —Ä–µ–Ω–¥–µ—Ä–∏–º text + badge ‚Äî —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º opacity/visibility, –±–µ–∑ layout shift
                React.createElement('div', {
                    className: `game-level-group${levelGuardActive ? ' is-syncing' : ''}`,
                    style: { color: levelGuardActive ? 'rgba(255,255,255,0.5)' : title.color }
                },
                    // –ú–∞–ª–µ–Ω—å–∫–∏–π dot-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (absolute, –Ω–µ –º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä group)
                    React.createElement('span', { className: 'game-level-sync-dot' }),
                    // Level text ‚Äî –≤—Å–µ–≥–¥–∞ –≤ DOM; skeleton-—Ç–µ–∫—Å—Ç –≤–æ –≤—Ä–µ–º—è guard
                    React.createElement('span', { className: 'game-level-text' },
                        levelGuardActive ? '¬∑ ¬∑ ¬∑' : `${title.icon} ${stats.level}`
                    ),
                    // Rank badge ‚Äî –≤—Å–µ–≥–¥–∞ –≤ DOM; opacity:0 –≤–æ –≤—Ä–µ–º—è guard ‚Üí –Ω–µ—Ç —Å–∫–∞—á–∫–∞
                    React.createElement('span', {
                        className: `game-rank-badge${levelGuardActive ? ' guard-hidden' : ''}`,
                        style: !levelGuardActive && HEYS.game ? {
                            background: `linear-gradient(135deg, ${HEYS.game.getRankBadge(stats.level).color}66 0%, ${HEYS.game.getRankBadge(stats.level).color} 100%)`,
                            color: stats.level >= 10 ? '#000' : '#fff'
                        } : undefined
                    }, !levelGuardActive && HEYS.game ? HEYS.game.getRankBadge(stats.level).rank : '¬∑¬∑¬∑'),
                    // Level Roadmap Tooltip ‚Äî –≤—Å–µ –∑–≤–∞–Ω–∏—è
                    HEYS.game && HEYS.game.getAllTitles && !levelGuardActive && React.createElement('div', {
                        className: 'game-level-roadmap'
                    },
                        React.createElement('div', { className: 'roadmap-title' }, 'üéÆ –ü—É—Ç—å —Ä–∞–∑–≤–∏—Ç–∏—è'),
                        HEYS.game.getAllTitles().map((t, i) => {
                            const isCurrent = stats.level >= t.min && stats.level <= t.max;
                            const isAchieved = stats.level > t.max;
                            const isFuture = stats.level < t.min;
                            return React.createElement('div', {
                                key: i,
                                className: `roadmap-item ${isCurrent ? 'current' : ''} ${isAchieved ? 'achieved' : ''} ${isFuture ? 'future' : ''}`
                            },
                                React.createElement('span', { className: 'roadmap-icon' }, t.icon),
                                React.createElement('span', { className: 'roadmap-name' }, t.title),
                                React.createElement('span', {
                                    className: 'roadmap-levels',
                                    style: { color: t.color }
                                }, `—É—Ä.${t.min}-${t.max}`),
                                isCurrent && React.createElement('span', { className: 'roadmap-you' }, '‚Üê —Ç—ã'),
                                isAchieved && React.createElement('span', { className: 'roadmap-check' }, '‚úì')
                            );
                        })
                    )
                ),

                // Progress bar
                React.createElement('div', {
                    className: `game-progress ${levelGuardActive ? 'syncing' : ''} ${isGlowing ? 'glowing' : ''} ${isShimmering ? 'shimmer' : ''} ${isPulsing ? 'pulse' : ''} ${!levelGuardActive && progress.percent >= 85 && progress.percent < 100 ? 'near-goal' : ''}`,
                    onClick: handleProgressClick
                },
                    React.createElement('div', {
                        className: 'game-progress-fill',
                        style: {
                            width: `${progressPercent}%`,
                            background: levelGuardActive ? 'transparent' : getProgressGradient(progress.percent)
                        }
                    }),
                    React.createElement('div', {
                        className: 'game-progress-milestones'
                    },
                        React.createElement('span', {
                            className: `game-progress-milestone ${progressMilestone === 25 ? 'hit' : ''}`,
                            'data-step': '25'
                        }),
                        React.createElement('span', {
                            className: `game-progress-milestone ${progressMilestone === 50 ? 'hit' : ''}`,
                            'data-step': '50'
                        }),
                        React.createElement('span', {
                            className: `game-progress-milestone ${progressMilestone === 75 ? 'hit' : ''}`,
                            'data-step': '75'
                        })
                    ),
                    // Tooltip ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–∫–∞ guard –∞–∫—Ç–∏–≤–µ–Ω
                    !levelGuardActive && React.createElement('span', { className: 'game-progress-tooltip' },
                        `–ï—â—ë ${progress.required - progress.current} XP –¥–æ —É—Ä.${stats.level + 1}`
                    )
                ),

                // ‚ïê‚ïê‚ïê –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å –±–∞—Ä–∞: —Å–ª–æ—Ç—ã –í–°–ï–ì–î–ê –≤ DOM, –ø–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚ïê‚ïê‚ïê
                // –û–±—ë—Ä–Ω—É—Ç—ã –≤ game-bar-slots ‚Äî —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –º–µ—Å—Ç–æ, opacity 0‚Üí1 —á–µ—Ä–µ–∑ CSS transition
                React.createElement('div', {
                    className: `game-bar-slots${levelGuardActive ? ' is-loading' : ' is-loaded'}`
                },
                    // Daily Multiplier
                    dailyMultiplier.actions > 0 && React.createElement('span', {
                        className: `game-daily-mult ${dailyMultiplier.multiplier >= 2 ? 'high' : dailyMultiplier.multiplier > 1 ? 'active' : ''}`,
                        title: dailyMultiplier.nextThreshold
                            ? `${dailyMultiplier.actions} –¥–µ–π—Å—Ç–≤–∏–π —Å–µ–≥–æ–¥–Ω—è. –ï—â—ë ${dailyMultiplier.nextThreshold - dailyMultiplier.actions} –¥–æ ${dailyMultiplier.nextMultiplier}x!`
                            : `${dailyMultiplier.actions} –¥–µ–π—Å—Ç–≤–∏–π —Å–µ–≥–æ–¥–Ω—è. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å!`
                    },
                        dailyMultiplier.multiplier > 1
                            ? React.createElement('span', { className: 'game-daily-mult-value' }, `${dailyMultiplier.multiplier}x`)
                            : `‚ö°${dailyMultiplier.actions}`
                    ),

                    // Streak
                    streak > 0 && React.createElement('span', {
                        className: `game-streak ${getStreakClass(streak)}${streakJustGrew ? ' just-grew' : ''}`,
                        title: `${streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –Ω–æ—Ä–º–µ (—Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –¥–Ω–∏)`
                    },
                        React.createElement('span', {
                            className: `game-streak__flame ${getStreakFlameClass(streak)}`
                        }, 'üî•'),
                        React.createElement('span', { className: 'game-streak__count' }, streak)
                    ),

                    // Personal Best
                    HEYS.game && HEYS.game.isNewStreakRecord() && streak > 0 && React.createElement('span', {
                        className: `game-personal-best${personalBestPulse ? ' pulse' : ''}`,
                        title: '–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ streak!'
                    }, 'üèÜ'),

                    // Daily Bonus
                    dailyBonusAvailable && React.createElement('button', {
                        className: 'game-daily-bonus',
                        onClick: async (e) => {
                            e.stopPropagation();
                            if (!HEYS.game || dailyBonusLoading) return;
                            setDailyBonusLoading(true);
                            try {
                                const claimed = await HEYS.game.claimDailyBonus();
                                if (claimed) {
                                    setDailyBonusAvailable(false);
                                    return;
                                }
                                setDailyBonusAvailable(HEYS.game.canClaimDailyBonus());
                            } finally {
                                setDailyBonusLoading(false);
                            }
                        },
                        title: '–ó–∞–±—Ä–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å!'
                    }, 'üéÅ'),

                    // XP counter
                    React.createElement('span', {
                        className: `game-xp ${!levelGuardActive && isXPCounting ? 'counting' : ''} ${!levelGuardActive && bigXpGlow ? 'big-gain' : ''}`
                    }, levelGuardActive
                        ? React.createElement('span', { className: 'game-xp__skeleton' }, '?/?')
                        : `${progress.current}/${progress.required}`
                    )
                ),

                // Expand button ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω
                React.createElement('button', {
                    className: `game-expand-btn ${expanded ? 'expanded' : ''} ${notifPulse ? 'has-notif' : ''}`,
                    title: expanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–¥—Ä–æ–±–Ω–µ–µ'
                }, expanded ? '‚ñ≤' : '‚ñº'),

                // Theme toggle button ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω
                React.createElement('button', {
                    className: 'hdr-theme-btn',
                    onClick: (e) => {
                        e.stopPropagation();
                        if (HEYS.cycleTheme) {
                            HEYS.cycleTheme();
                            return;
                        }
                        const html = document.documentElement;
                        const current = html.getAttribute('data-theme') || 'light';
                        const next = current === 'dark' ? 'light' : 'dark';
                        html.setAttribute('data-theme', next);
                        const U = window.HEYS?.utils || {};
                        U.lsSet ? U.lsSet('heys_theme', next) : localStorage.setItem('heys_theme', next);
                    },
                    title: '–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É'
                }, document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô')
            ),

            // Notification (level up / achievement / streak_shield)
            notification && React.createElement('div', {
                className: `game-notification ${notification.type}${notification.type === 'achievement' && notification.data.achievement?.rarity ? ' rarity-' + notification.data.achievement.rarity : ''}`,
                onClick: () => setNotification(null),
                onTouchStart: (e) => { e.currentTarget._touchStartY = e.touches[0].clientY; },
                onTouchMove: (e) => {
                    const deltaY = e.currentTarget._touchStartY - e.touches[0].clientY;
                    if (deltaY > 50) { setNotification(null); } // swipe up to dismiss
                }
            },
                notification.type === 'level_up'
                    ? React.createElement(React.Fragment, null,
                        React.createElement('span', { className: 'notif-icon' }, notification.data.icon),
                        React.createElement('div', { className: 'notif-content' },
                            React.createElement('div', { className: 'notif-title' }, `üéâ –£—Ä–æ–≤–µ–Ω—å ${notification.data.newLevel}!`),
                            React.createElement('div', { className: 'notif-subtitle' }, `–¢—ã —Ç–µ–ø–µ—Ä—å ${notification.data.title}`)
                        )
                    )
                    : notification.type === 'achievement'
                        ? React.createElement(React.Fragment, null,
                            React.createElement('span', { className: 'notif-icon' }, notification.data.achievement.icon),
                            React.createElement('div', { className: 'notif-content' },
                                React.createElement('div', { className: 'notif-title' }, notification.data.achievement.name),
                                React.createElement('div', { className: 'notif-subtitle' }, `+${notification.data.achievement.xp} XP`),
                                notification.data.firstInCategory && React.createElement('div', { className: 'notif-first-category' }, 'üÜï –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è')
                            )
                        )
                        : notification.type === 'daily_bonus'
                            ? React.createElement(React.Fragment, null,
                                React.createElement('span', { className: 'notif-icon' }, 'üéÅ'),
                                React.createElement('div', { className: 'notif-content' },
                                    React.createElement('div', { className: 'notif-title' }, '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å!'),
                                    React.createElement('div', { className: 'notif-subtitle' },
                                        notification.data.multiplier > 1
                                            ? `+${notification.data.xp} XP (${notification.data.multiplier}x –±–æ–Ω—É—Å!)`
                                            : `+${notification.data.xp} XP`
                                    )
                                )
                            )
                            : notification.type === 'weekly_complete'
                                ? React.createElement(React.Fragment, null,
                                    React.createElement('span', { className: 'notif-icon' }, 'üéØ'),
                                    React.createElement('div', { className: 'notif-content' },
                                        React.createElement('div', { className: 'notif-title' }, 'üéâ –ù–µ–¥–µ–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂!'),
                                        React.createElement('div', { className: 'notif-subtitle' }, `+${notification.data.reward || 100} XP –±–æ–Ω—É—Å!`)
                                    )
                                )
                                : notification.type === 'streak_shield'
                                    ? React.createElement(React.Fragment, null,
                                        React.createElement('span', { className: 'notif-icon' }, 'üõ°Ô∏è'),
                                        React.createElement('div', { className: 'notif-content' },
                                            React.createElement('div', { className: 'notif-title' }, 'Streak —Å–ø–∞—Å—ë–Ω!'),
                                            React.createElement('div', { className: 'notif-subtitle' }, notification.data.message || '–©–∏—Ç –∑–∞—â–∏—Ç–∏–ª —Ç–≤–æ—é —Å–µ—Ä–∏—é')
                                        )
                                    )
                                    : notification.type === 'mission_complete'
                                        ? React.createElement(React.Fragment, null,
                                            React.createElement('span', { className: 'notif-icon' }, '‚úÖ'),
                                            React.createElement('div', { className: 'notif-content' },
                                                React.createElement('div', { className: 'notif-title' }, '–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!'),
                                                React.createElement('div', { className: 'notif-subtitle' }, `${notification.data.name} ‚Äî +${notification.data.xp} XP`)
                                            )
                                        )
                                        : notification.type === 'all_missions_complete'
                                            ? React.createElement(React.Fragment, null,
                                                React.createElement('span', { className: 'notif-icon' }, 'üéâ'),
                                                React.createElement('div', { className: 'notif-content' },
                                                    React.createElement('div', { className: 'notif-title' }, '–í—Å–µ –º–∏—Å—Å–∏–∏ –¥–Ω—è!'),
                                                    React.createElement('div', { className: 'notif-subtitle' }, `–ë–æ–Ω—É—Å +${notification.data.bonus || 50} XP üéä`)
                                                )
                                            )
                                            : null
            ),

            // Expanded panel (backdrop + content)
            expanded && React.createElement(React.Fragment, null,
                // Backdrop
                React.createElement('div', {
                    className: 'game-panel-backdrop',
                    onClick: () => setExpanded(false)
                }),
                // Panel content
                React.createElement('div', { className: 'game-panel-expanded' },
                    // Weekly Challenge Section (–∫—Ä–∞—Å–∏–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞)
                    React.createElement('div', {
                        className: `game-weekly-card ${weeklyChallenge.completed ? 'completed' : ''} ${weeklyChallenge.percent >= 80 && !weeklyChallenge.completed ? 'almost-done' : ''}`
                    },
                        React.createElement('div', { className: 'weekly-header' },
                            React.createElement('span', {
                                className: `weekly-icon ${weeklyChallenge.completed ? 'pulse-glow' : ''}`
                            }, weeklyChallenge.completed ? 'üèÜ' : (weeklyChallenge.icon || 'üéØ')),
                            React.createElement('div', { className: 'weekly-title-group' },
                                React.createElement('span', { className: 'weekly-title' },
                                    weeklyChallenge.title || '–ù–µ–¥–µ–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂'
                                ),
                                React.createElement('span', { className: 'weekly-subtitle' },
                                    weeklyChallenge.completed
                                        ? '‚ú® –í—ã–ø–æ–ª–Ω–µ–Ω–æ! +100 XP –±–æ–Ω—É—Å'
                                        : weeklyChallenge.description || `${weeklyChallenge.target} –∑–∞ –Ω–µ–¥–µ–ª—é`
                                )
                            ),
                            // Days remaining badge
                            !weeklyChallenge.completed && React.createElement('div', {
                                className: 'weekly-days-left',
                                title: '–î–Ω–µ–π –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏'
                            }, `${7 - new Date().getDay() || 7}–¥`)
                        ),
                        React.createElement('div', { className: 'weekly-progress-container' },
                            React.createElement('div', { className: 'weekly-progress-bar' },
                                React.createElement('div', {
                                    className: `weekly-progress-fill ${weeklyChallenge.percent >= 80 ? 'near-complete' : ''}`,
                                    style: {
                                        width: `${weeklyChallenge.percent}%`,
                                        transition: 'width 0.5s ease-out'
                                    }
                                }),
                                // Milestone markers
                                React.createElement('div', {
                                    className: 'weekly-milestone',
                                    style: { left: '25%' },
                                    'data-reached': weeklyChallenge.percent >= 25
                                }),
                                React.createElement('div', {
                                    className: 'weekly-milestone',
                                    style: { left: '50%' },
                                    'data-reached': weeklyChallenge.percent >= 50
                                }),
                                React.createElement('div', {
                                    className: 'weekly-milestone',
                                    style: { left: '75%' },
                                    'data-reached': weeklyChallenge.percent >= 75
                                }),
                                weeklyChallenge.completed && React.createElement('div', { className: 'weekly-progress-glow' })
                            ),
                            React.createElement('div', { className: 'weekly-progress-labels' },
                                React.createElement('span', { className: 'weekly-earned' },
                                    `${weeklyChallenge.current || weeklyChallenge.earned || 0}${weeklyChallenge.unit || ''}`
                                ),
                                React.createElement('span', { className: 'weekly-target' },
                                    `${weeklyChallenge.target}${weeklyChallenge.unit || ''}`
                                )
                            )
                        ),
                        React.createElement('div', {
                            className: `weekly-percent ${weeklyChallenge.completed ? 'completed' : weeklyChallenge.percent >= 80 ? 'almost' : ''}`
                        },
                            weeklyChallenge.completed
                                ? 'üéâ 100%'
                                : weeklyChallenge.percent >= 80
                                    ? `üî• ${weeklyChallenge.percent}%`
                                    : `${weeklyChallenge.percent}%`
                        ),
                        // Reward preview
                        !weeklyChallenge.completed && React.createElement('div', { className: 'weekly-reward-preview' },
                            React.createElement('span', null, 'üéÅ –ù–∞–≥—Ä–∞–¥–∞: '),
                            React.createElement('span', { className: 'reward-xp' }, `+${weeklyChallenge.reward || 100} XP`)
                        )
                    ),

                    // XP History ‚Äî –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –∑–∞ 7 –¥–Ω–µ–π
                    xpHistory?.length > 0 && React.createElement('div', { className: 'xp-history-section' },
                        React.createElement('div', { className: 'xp-history-title' }, 'üìä XP –∑–∞ –Ω–µ–¥–µ–ª—é'),
                        React.createElement('div', { className: `xp-history-chart${xpHistoryAnimate ? ' animate' : ''}` },
                            (() => {
                                const maxXP = Math.max(...xpHistory.map(d => d.xp), 1);
                                return xpHistory.map((day, i) =>
                                    React.createElement('div', {
                                        key: i,
                                        className: `xp-history-bar ${i === 6 ? 'today' : ''}`,
                                        title: `${day.date}: ${day.xp} XP`
                                    },
                                        React.createElement('div', {
                                            className: 'xp-bar-fill',
                                            style: { height: `${(day.xp / maxXP) * 100}%` }
                                        }),
                                        React.createElement('span', { className: 'xp-bar-day' }, day.day),
                                        day.xp > 0 && React.createElement('span', { className: 'xp-bar-value' }, day.xp)
                                    )
                                );
                            })()
                        )
                    ),

                    // Stats section
                    React.createElement('div', { className: 'game-stats-section' },
                        React.createElement('div', { className: 'game-stat' },
                            // üõ°Ô∏è levelGuard: —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ç—É—Ö—à–∏–π XP –∏–∑ localStorage –ø–æ–∫–∞ pipeline –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
                            React.createElement('span', { className: 'stat-value' },
                                levelGuardActive
                                    ? React.createElement('span', { className: 'stat-value--syncing', title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è‚Ä¶' }, '‚Ä¶')
                                    : stats.totalXP
                            ),
                            React.createElement('span', { className: 'stat-label' }, '–í—Å–µ–≥–æ XP')
                        ),
                        React.createElement('div', { className: 'game-stat' },
                            React.createElement('span', { className: 'stat-value' },
                                levelGuardActive
                                    ? React.createElement('span', { className: 'stat-value--syncing', title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è‚Ä¶' }, '‚Ä¶')
                                    : `${stats.level}`
                            ),
                            React.createElement('span', { className: 'stat-label' }, '–£—Ä–æ–≤–µ–Ω—å')
                        ),
                        React.createElement('div', { className: 'game-stat' },
                            React.createElement('span', { className: 'stat-value' }, streak || 0),
                            React.createElement('span', { className: 'stat-label' }, 'Streak')
                        ),
                        React.createElement('div', { className: 'game-stat' },
                            React.createElement('span', { className: 'stat-value' }, `${stats.unlockedCount}/${stats.totalAchievements}`),
                            React.createElement('span', { className: 'stat-label' }, '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è')
                        )
                    ),

                    // Daily missions (expanded) ‚Äî full card UI
                    dailyMissions && React.createElement('div', {
                        className: 'game-missions-panel'
                    },
                        React.createElement('div', { className: 'game-missions-panel__title' }, 'üß≠ –ú–∏—Å—Å–∏–∏ –¥–Ω—è'),
                        React.createElement('div', { className: 'game-missions-list' },
                            (dailyMissions.missions || []).map((m, i) => {
                                const progressPct = m.target > 0 ? Math.min(100, Math.round((m.progress / m.target) * 100)) : 0;
                                const CATEGORY_META = HEYS.missions?.CATEGORY_META || {};
                                const categoryMeta = CATEGORY_META[m.category] || {};

                                // Progress text for missions with target > 1
                                let progressText = '';
                                if (!m.completed && m.target > 1) {
                                    if (m.type === 'water' || m.type === 'kcal' || m.type === 'fiber' ||
                                        m.type === 'protein' || m.type === 'complex_carbs' || m.type === 'harm') {
                                        progressText = `${m.progress || 0}%`;
                                    } else {
                                        progressText = `${m.progress || 0}/${m.target}`;
                                    }
                                }

                                return React.createElement('div', {
                                    key: m.id || i,
                                    className: `game-mission-card ${m.completed ? 'is-complete' : ''}`
                                },
                                    React.createElement('div', { className: 'game-mission-card__icon' }, m.completed ? '‚úÖ' : (m.icon || '‚ö™')),
                                    React.createElement('div', { className: 'game-mission-card__body' },
                                        React.createElement('div', { className: 'game-mission-card__header' },
                                            React.createElement('div', { className: 'game-mission-card__name' }, m.name || m.id),
                                            categoryMeta.label && React.createElement('div', {
                                                className: 'game-mission-card__category',
                                                style: {
                                                    fontSize: '10px',
                                                    padding: '2px 6px',
                                                    borderRadius: '4px',
                                                    backgroundColor: 'rgba(255,255,255,0.15)',
                                                    color: 'rgba(255,255,255,0.85)',
                                                    whiteSpace: 'nowrap'
                                                }
                                            }, `${categoryMeta.icon || ''} ${categoryMeta.label}`.trim())
                                        ),
                                        React.createElement('div', { className: 'game-mission-card__desc' }, m.desc || ''),
                                        !m.completed && React.createElement('div', { className: 'game-mission-card__bar-wrapper' },
                                            React.createElement('div', { className: 'game-mission-card__bar' },
                                                React.createElement('div', {
                                                    className: 'game-mission-card__bar-fill',
                                                    style: { width: progressPct + '%' }
                                                })
                                            ),
                                            progressText && React.createElement('div', {
                                                className: 'game-mission-card__progress-text',
                                                style: {
                                                    fontSize: '11px',
                                                    color: 'rgba(255,255,255,0.7)',
                                                    marginTop: '4px'
                                                }
                                            }, progressText)
                                        )
                                    ),
                                    React.createElement('div', { className: 'game-mission-card__xp' },
                                        m.completed ? `+${m.xp}` : `${m.xp} XP`
                                    )
                                );
                            })
                        ),
                        // –ë–æ–Ω—É—Å —Å—á—ë—Ç—á–∏–∫
                        React.createElement('div', { className: 'game-missions-panel__footer' },
                            dailyMissions.completedCount >= 3 && dailyMissions.bonusClaimed
                                ? React.createElement('span', { className: 'game-missions-bonus-done' }, 'üéâ –ë–æ–Ω—É—Å +50 XP –ø–æ–ª—É—á–µ–Ω!')
                                : React.createElement('span', { className: 'game-missions-bonus-hint' },
                                    `${dailyMissions.completedCount || 0}/3 ‚Äî –≤—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –¥–ª—è +50 XP üéÅ`
                                )
                        )
                    ),

                    // Title & next level
                    React.createElement('div', { className: 'game-title-section' },
                        React.createElement('div', { className: 'game-title-row' },
                            React.createElement('div', {
                                className: 'current-title',
                                style: { color: title.color }
                            }, `${title.icon} ${title.title}`),
                            React.createElement('div', { className: 'next-level-hint' },
                                `–î–æ —É—Ä–æ–≤–Ω—è ${stats.level + 1}: ${progress.required - progress.current} XP`
                            ),
                            onboardingDone && React.createElement('div', {
                                ref: targetMedalRef,
                                className: `onboarding-medal${isOnboardingTipOpen ? ' is-open' : ''}`,
                                role: 'button',
                                tabIndex: 0,
                                onClick: handleOnboardingMedalToggle,
                                onMouseEnter: () => setIsOnboardingTipOpen(true),
                                onMouseLeave: () => setIsOnboardingTipOpen(false),
                                onBlur: () => setIsOnboardingTipOpen(false),
                                onKeyDown: (e) => {
                                    if (e.key === 'Enter' || e.key === ' ') {
                                        e.preventDefault();
                                        handleOnboardingMedalToggle(e);
                                    }
                                }
                            },
                                'üèÖ',
                                React.createElement('span', { className: 'onboarding-medal__tooltip' },
                                    '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏: –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã'
                                )
                            )
                        ),
                        daysToNext && React.createElement('div', { className: 'game-forecast' },
                            `–ü—Ä–æ–≥–Ω–æ–∑: —É—Ä.${stats.level + 1} –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${daysToNext} –¥–Ω. (~${avgDailyXP} XP/–¥–µ–Ω—å)`
                        )
                    ),

                    // Achievements grid
                    React.createElement('div', { className: 'game-achievements-section' },
                        React.createElement('h4', null, 'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è'),
                        HEYS.game && HEYS.game.getAchievementCategories()
                            .filter((cat) => !(cat.id === 'onboarding' && onboardingDone))
                            .map(cat =>
                                React.createElement('div', { key: cat.id, className: 'achievement-category' },
                                    React.createElement('div', { className: 'category-name' }, cat.name),
                                    cat.id === 'streak' && React.createElement('div', {
                                        className: 'achievement-category-hint'
                                    }, '‚ö° –°—É–ø–µ—Ä—Ä–µ–¥–∫–æ ‚Üí –º–∞–∫—Å–∏–º—É–º XP'),
                                    React.createElement('div', { className: 'achievements-row' },
                                        cat.achievements.map(achId => {
                                            const ach = HEYS.game.ACHIEVEMENTS[achId];
                                            const unlocked = HEYS.game.isAchievementUnlocked(achId);
                                            const isJustUnlocked = justUnlockedAch === achId;
                                            const rarityClass = unlocked ? `rarity-${ach.rarity}` : '';

                                            // üÜï Get progress for locked achievements
                                            const progress = !unlocked && HEYS.game.getAchievementProgress
                                                ? HEYS.game.getAchievementProgress(achId)
                                                : null;
                                            const progressPct = progress ? Math.min(100, Math.round((progress.current / progress.target) * 100)) : 0;
                                            const isAlmostThere = progressPct >= 70 && progressPct < 100;

                                            return React.createElement('div', {
                                                key: achId,
                                                className: `achievement-badge ${unlocked ? 'unlocked' : 'locked'} ${rarityClass} ${isJustUnlocked ? 'just-unlocked' : ''} ${isAlmostThere ? 'almost-there' : ''}`,
                                                title: `${ach.name}: ${ach.desc}${progress ? ` (${progress.current}/${progress.target})` : ''}`,
                                                style: unlocked ? { borderColor: HEYS.game.RARITY_COLORS[ach.rarity] } : {},
                                                onClick: (e) => {
                                                    e.stopPropagation();
                                                    setStoryAchId(achId);
                                                }
                                            },
                                                React.createElement('span', { className: 'badge-icon' }, unlocked ? ach.icon : 'üîí'),
                                                unlocked
                                                    ? React.createElement('span', { className: 'badge-xp' }, `+${ach.xp}`)
                                                    : progress && progressPct > 0 && React.createElement('span', {
                                                        className: `badge-progress ${isAlmostThere ? 'almost' : ''}`
                                                    }, `${progressPct}%`),
                                                // üÜï Progress bar for locked achievements
                                                !unlocked && progress && progressPct > 0 && React.createElement('div', {
                                                    className: 'badge-progress-bar',
                                                    style: { width: `${progressPct}%` }
                                                })
                                            );
                                        })
                                    )
                                )
                            )
                    )
                    ,

                    React.createElement('div', { className: 'game-audit-section' },
                        React.createElement('div', { className: 'game-audit-title' }, 'üßæ –ò—Å—Ç–æ—Ä–∏—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏'),
                        React.createElement('div', { className: 'game-audit-subtitle' }, '–õ–µ–Ω—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π XP, —É—Ä–æ–≤–Ω–µ–π –∏ –Ω–∞–≥—Ä–∞–¥. –î–æ—Å—Ç—É–ø–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É –∏ –∫—É—Ä–∞—Ç–æ—Ä—É.'),
                        React.createElement('div', { className: 'game-audit-buttons' },
                            React.createElement('button', {
                                className: 'game-audit-btn',
                                onClick: (e) => {
                                    e.stopPropagation();
                                    const nextState = !auditOpen;
                                    logAuditInfo('toggle:click', { nextState, expanded, auditOpen });
                                    setAuditOpen(nextState);
                                    if (nextState) {
                                        loadAuditHistory();
                                    }
                                }
                            }, auditOpen ? '–°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é' : '–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é'),
                            React.createElement('button', {
                                className: 'game-audit-btn game-audit-btn--copy',
                                onClick: (e) => {
                                    e.stopPropagation();
                                    copyFullAuditLog();
                                },
                                title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –ª–æ–≥ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞'
                            }, 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥')
                        ),
                        auditOpen && React.createElement('div', { className: 'game-audit-list' },
                            auditLoading && React.createElement('div', { className: 'game-audit-loading' }, '–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é...'),
                            !auditLoading && auditError && React.createElement('div', { className: 'game-audit-error' }, auditError),
                            !auditLoading && !auditError && auditEvents.length === 0 && React.createElement('div', { className: 'game-audit-empty' }, '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π'),
                            !auditLoading && !auditError && auditEvents.map((event) => {
                                const meta = event?.metadata || {};
                                const actionLabel = getAuditActionLabel(event.action, meta);
                                const reasonLabel = getAuditReasonLabel(event.reason);
                                const when = event.created_at
                                    ? new Date(event.created_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
                                    : '';
                                const actorLabel = event.actor_type === 'curator'
                                    ? '–ö—É—Ä–∞—Ç–æ—Ä'
                                    : event.actor_type === 'pin'
                                        ? 'PIN'
                                        : '–°–∏—Å—Ç–µ–º–∞';
                                const xpDelta = typeof event.xp_delta === 'number' ? event.xp_delta : null;
                                const levelBefore = event.level_before;
                                const levelAfter = event.level_after;
                                const levelChange = levelBefore && levelAfter && levelAfter !== levelBefore
                                    ? `—É—Ä.${levelBefore} ‚Üí —É—Ä.${levelAfter}`
                                    : null;

                                return React.createElement('div', { key: event.id, className: 'game-audit-item' },
                                    React.createElement('div', { className: 'game-audit-item__row' },
                                        React.createElement('div', { className: 'game-audit-item__title' }, actionLabel),
                                        xpDelta !== null && React.createElement('div', { className: 'game-audit-item__delta' }, `+${xpDelta} XP`)
                                    ),
                                    React.createElement('div', { className: 'game-audit-item__meta' },
                                        React.createElement('span', { className: `game-audit-badge game-audit-badge--${event.actor_type || 'system'}` }, actorLabel),
                                        reasonLabel && React.createElement('span', { className: 'game-audit-meta' }, reasonLabel),
                                        levelChange && React.createElement('span', { className: 'game-audit-meta' }, levelChange),
                                        when && React.createElement('span', { className: 'game-audit-meta' }, when)
                                    )
                                );
                            })
                        )
                    )
                )
            ),

            storyAchievement && React.createElement('div', {
                className: 'achievement-story-modal',
                onClick: () => setStoryAchId(null)
            },
                React.createElement('div', {
                    className: `achievement-story-card ${storyUnlocked ? 'unlocked' : 'locked'} rarity-${storyAchievement.rarity}`,
                    onClick: (e) => e.stopPropagation()
                },
                    React.createElement('div', { className: 'achievement-story-close', onClick: () => setStoryAchId(null) }, '‚úï'),
                    React.createElement('div', { className: 'achievement-story-rarity' }, storyAchievement.rarity),
                    React.createElement('div', { className: 'achievement-story-icon' }, storyUnlocked ? storyAchievement.icon : 'üîí'),
                    React.createElement('div', { className: 'achievement-story-name' }, storyAchievement.name),
                    React.createElement('div', {
                        className: `achievement-story-label ${storyUnlocked ? 'unlocked' : 'locked'}`
                    }, storyUnlocked ? '–ò–Ω—Å–∞–π—Ç' : '–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å'),
                    React.createElement('div', {
                        className: 'achievement-story-text'
                    }, storyUnlocked ? (storyAchievement.story || storyAchievement.desc) : storyAchievement.desc),
                    React.createElement('div', { className: 'achievement-story-xp' }, `+${storyAchievement.xp} XP`),
                    React.createElement('button', {
                        className: 'achievement-story-btn',
                        onClick: () => setStoryAchId(null)
                    }, '–ü–æ–Ω—è—Ç–Ω–æ')
                )
            ),

            levelUpModal && React.createElement('div', {
                className: 'level-up-modal',
                onClick: () => setLevelUpModal(null)
            },
                React.createElement('div', { className: 'level-up-modal__backdrop' }),
                React.createElement('div', {
                    className: 'level-up-modal__card',
                    style: { '--level-color': levelUpModal.color },
                    onClick: (e) => e.stopPropagation()
                },
                    React.createElement('div', { className: 'level-up-modal__badge' }, levelUpModal.icon),
                    React.createElement('div', { className: 'level-up-modal__title' }, '–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!'),
                    React.createElement('div', { className: 'level-up-modal__level' }, `–£—Ä–æ–≤–µ–Ω—å ${levelUpModal.level}`),
                    React.createElement('div', { className: 'level-up-modal__subtitle' }, levelUpModal.title),
                    React.createElement('button', {
                        className: 'level-up-modal__btn',
                        onClick: () => setLevelUpModal(null)
                    }, '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å')
                )
            ),

            weeklyCeremony && React.createElement('div', {
                className: 'weekly-ceremony-modal',
                onClick: () => setWeeklyCeremony(null)
            },
                React.createElement('div', { className: 'weekly-ceremony-modal__backdrop' }),
                React.createElement('div', {
                    className: 'weekly-ceremony-modal__card',
                    onClick: (e) => e.stopPropagation()
                },
                    React.createElement('div', { className: 'weekly-ceremony-modal__icon' }, weeklyCeremony.icon || 'üèÜ'),
                    React.createElement('div', { className: 'weekly-ceremony-modal__title' }, '–ù–µ–¥–µ–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω!'),
                    React.createElement('div', { className: 'weekly-ceremony-modal__subtitle' }, weeklyCeremony.title),
                    React.createElement('div', { className: 'weekly-ceremony-modal__reward' }, `+${weeklyCeremony.reward} XP`),
                    React.createElement('button', {
                        className: 'weekly-ceremony-modal__btn',
                        onClick: () => setWeeklyCeremony(null)
                    }, '–û—Ç–ª–∏—á–Ω–æ!')
                )
            ),

            streakCelebration && React.createElement('div', {
                className: 'streak-milestone-toast'
            }, `üî• Streak ${streakCelebration} –¥–Ω–µ–π!`),

            // === Onboarding Fusion Ceremony ===
            fusionPhase && React.createElement('div', {
                className: 'onboarding-fusion',
                onClick: (e) => { if (fusionPhase === 'ready') handleFusionDismiss(); }
            },
                React.createElement('div', { className: 'onboarding-fusion__backdrop' }),
                React.createElement('div', {
                    className: 'onboarding-fusion__stage',
                    onClick: (e) => e.stopPropagation()
                },
                    // Title
                    React.createElement('div', {
                        className: 'onboarding-fusion__title'
                    }, '‚ú® –í—Å–µ –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!'),

                    // Ring with achievement icons
                    React.createElement('div', { className: 'onboarding-fusion__ring' },
                        // Achievement icons positioned in a circle
                        ONBOARDING_ICONS.map((icon, i) => {
                            const isMerging = fusionPhase === 'merge' || fusionPhase === 'medal' || fusionPhase === 'ready' || fusionPhase === 'fly';
                            return React.createElement('div', {
                                key: i,
                                className: 'onboarding-fusion__icon',
                                style: {
                                    left: isMerging ? 'calc(50% - 22px)' : `calc(${fusionIconPositions[i].left} - 22px)`,
                                    top: isMerging ? 'calc(50% - 22px)' : `calc(${fusionIconPositions[i].top} - 22px)`,
                                    opacity: isMerging ? 0 : 1,
                                    transform: isMerging ? 'scale(0)' : 'scale(1)',
                                    transition: isMerging ? `all 0.6s cubic-bezier(0.55, 0, 0.1, 1) ${i * 0.05}s` : 'none',
                                    animation: fusionPhase === 'gather' ? `fusionIconAppear 0.4s ease-out ${0.4 + i * 0.1}s forwards` : 'none'
                                }
                            }, icon);
                        }),

                        // Starburst rays
                        (fusionPhase === 'medal' || fusionPhase === 'ready') && React.createElement('div', {
                            className: 'onboarding-fusion__rays is-visible'
                        },
                            Array.from({ length: 12 }).map((_, i) =>
                                React.createElement('div', { key: i, className: 'onboarding-fusion__ray' })
                            )
                        ),

                        // Medal
                        React.createElement('div', {
                            ref: fusionMedalRef,
                            className: `onboarding-fusion__medal${(fusionPhase === 'medal' || fusionPhase === 'ready') ? ' is-visible' : ''}`,
                            style: fusionPhase === 'fly' ? {} : {}
                        }, 'üèÖ'),

                        // Confetti particles
                        (fusionPhase === 'medal' || fusionPhase === 'ready') && React.createElement('div', {
                            className: 'onboarding-fusion__confetti'
                        },
                            fusionConfetti.map((p, i) =>
                                React.createElement('div', {
                                    key: i,
                                    className: 'onboarding-fusion__confetti-piece is-active',
                                    style: {
                                        '--cx': p.cx,
                                        '--cy': p.cy,
                                        background: p.color,
                                        width: `${p.size}px`,
                                        height: `${p.size}px`,
                                        left: '50%',
                                        top: '50%',
                                        animationDelay: p.delay
                                    }
                                })
                            )
                        )
                    ),

                    // Subtitle
                    fusionPhase === 'ready' && React.createElement('div', {
                        className: 'onboarding-fusion__subtitle is-visible'
                    }, '–í—Å–µ –±–∞–∑–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ–±—Ä–∞–Ω—ã –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã'),

                    // XP total
                    fusionPhase === 'ready' && React.createElement('div', {
                        className: 'onboarding-fusion__xp is-visible'
                    }, `+${ONBOARDING_ACHIEVEMENTS.reduce((sum, id) => sum + (HEYS.game?.ACHIEVEMENTS?.[id]?.xp || 0), 0)} XP –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ`),

                    // Button
                    fusionPhase === 'ready' && React.createElement('button', {
                        className: 'onboarding-fusion__btn is-visible',
                        onClick: handleFusionDismiss
                    }, 'üèÖ –û—Ç–ª–∏—á–Ω–æ!')
                )
            )
        );
    }

    HEYS.GamificationBar = GamificationBar;
})();


/* ===== heys_app_gates_v1.js ===== */
// heys_app_gates_v1.js ‚Äî ErrorBoundary, DesktopGate, AppLoader, debug panel, badge API

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.Gates = HEYS.Gates || {};

    HEYS.Gates.initReactGates = function initReactGates(React) {
        if (!React) return;

        if (!HEYS.ErrorBoundary) {
            class ErrorBoundary extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = { hasError: false, error: null };
                }
                static getDerivedStateFromError(error) {
                    return { hasError: true, error };
                }
                componentDidCatch(error, info) {
                    console.error('[HEYS] ErrorBoundary caught:', error, info);
                }
                render() {
                    if (this.state.hasError) {
                        return React.createElement('div', {
                            className: 'error-boundary-fallback',
                            style: {
                                padding: '32px 24px',
                                textAlign: 'center',
                                background: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                                borderRadius: '16px',
                                margin: '16px',
                                border: '1px solid #fecaca'
                            }
                        },
                            React.createElement('div', { style: { fontSize: '48px', marginBottom: '16px' } }, 'üòî'),
                            React.createElement('h2', { style: { color: '#dc2626', marginBottom: '8px', fontSize: '18px' } }, '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫'),
                            React.createElement('p', { style: { color: '#7f1d1d', marginBottom: '16px', fontSize: '14px' } },
                                '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É'
                            ),
                            React.createElement('button', {
                                onClick: () => window.location.reload(),
                                style: {
                                    background: '#dc2626',
                                    color: '#fff',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    fontSize: '15px',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }
                            }, 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å')
                        );
                    }
                    return this.props.children;
                }
            }
            HEYS.ErrorBoundary = ErrorBoundary;
        }

        if (!HEYS.DesktopGateScreen) {
            function DesktopGateScreen({ onLogout }) {
                const currentUrl = window.location.origin;

                return React.createElement('div', {
                    className: 'desktop-gate',
                    style: {
                        minHeight: '100vh',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '40px 20px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: '#fff',
                        textAlign: 'center'
                    }
                },
                    // –ò–∫–æ–Ω–∫–∞
                    React.createElement('div', {
                        style: { fontSize: 80, marginBottom: 24 }
                    }, 'üì±'),

                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                    React.createElement('h1', {
                        style: {
                            fontSize: 28,
                            fontWeight: 700,
                            marginBottom: 12,
                            lineHeight: 1.3
                        }
                    }, '–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ'),

                    // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
                    React.createElement('p', {
                        style: {
                            fontSize: 16,
                            opacity: 0.9,
                            marginBottom: 32,
                            maxWidth: 320,
                            lineHeight: 1.5
                        }
                    }, 'HEYS –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.'),

                    // QR-–∫–æ–¥ (—á–µ—Ä–µ–∑ API)
                    React.createElement('div', {
                        style: {
                            background: 'var(--card, #fff)',
                            padding: 16,
                            borderRadius: 16,
                            marginBottom: 24,
                            boxShadow: '0 8px 32px rgba(0,0,0,0.2)'
                        }
                    },
                        React.createElement('img', {
                            src: `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(currentUrl)}`,
                            alt: 'QR Code',
                            style: { display: 'block', width: 180, height: 180 }
                        })
                    ),

                    // –°—Å—ã–ª–∫–∞
                    React.createElement('div', {
                        style: {
                            background: 'rgba(255,255,255,0.15)',
                            padding: '12px 20px',
                            borderRadius: 12,
                            fontSize: 14,
                            fontFamily: 'monospace',
                            marginBottom: 32,
                            wordBreak: 'break-all',
                            maxWidth: 320
                        }
                    }, currentUrl),

                    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è PWA
                    React.createElement('div', {
                        style: {
                            background: 'rgba(255,255,255,0.1)',
                            padding: '16px 20px',
                            borderRadius: 12,
                            maxWidth: 320,
                            marginBottom: 32
                        }
                    },
                        React.createElement('div', {
                            style: { fontWeight: 600, marginBottom: 8, fontSize: 15 }
                        }, 'üí° –°–æ–≤–µ—Ç'),
                        React.createElement('div', {
                            style: { fontSize: 14, opacity: 0.9, lineHeight: 1.5 }
                        }, '–î–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω"')
                    ),

                    // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
                    onLogout && React.createElement('button', {
                        onClick: onLogout,
                        style: {
                            background: 'rgba(255,255,255,0.2)',
                            border: '1px solid rgba(255,255,255,0.3)',
                            color: '#fff',
                            padding: '12px 24px',
                            borderRadius: 12,
                            fontSize: 15,
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                        }
                    }, '‚Üê –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞')
                );
            }
            HEYS.DesktopGateScreen = DesktopGateScreen;
        }

        if (!HEYS.AppLoader) {
            function AppLoader({ message = '–ó–∞–≥—Ä—É–∑–∫–∞...', subtitle = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É' }) {
                return React.createElement('div', { className: 'app-loader' },
                    // –õ–æ–≥–æ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    React.createElement('div', { className: 'app-loader-header' },
                        React.createElement('div', { className: 'app-loader-logo' }, 'ü•ó'),
                        React.createElement('div', { className: 'app-loader-title' }, message),
                        React.createElement('div', { className: 'app-loader-subtitle' }, subtitle)
                    ),
                    // –°–∫–µ–ª–µ—Ç–æ–Ω UI
                    React.createElement('div', { className: 'app-loader-skeleton' },
                        // Header skeleton
                        React.createElement('div', { className: 'skeleton-header' },
                            React.createElement('div', { className: 'skeleton-bar skeleton-bar-xp' }),
                            React.createElement('div', { className: 'skeleton-nav' },
                                React.createElement('div', { className: 'skeleton-circle' }),
                                React.createElement('div', { className: 'skeleton-rect skeleton-client' }),
                                React.createElement('div', { className: 'skeleton-circle' })
                            )
                        ),
                        // Content skeleton - sparkline
                        React.createElement('div', { className: 'skeleton-content' },
                            React.createElement('div', { className: 'skeleton-sparkline' },
                                // –ò–º–∏—Ç–∞—Ü–∏—è —Ç–æ—á–µ–∫ –≥—Ä–∞—Ñ–∏–∫–∞
                                ...Array.from({ length: 14 }, (_, i) =>
                                    React.createElement('div', {
                                        key: i,
                                        className: 'skeleton-dot',
                                        style: {
                                            height: `${20 + Math.random() * 60}%`,
                                            animationDelay: `${i * 0.05}s`
                                        }
                                    })
                                )
                            ),
                            // Cards skeleton
                            React.createElement('div', { className: 'skeleton-cards' },
                                React.createElement('div', { className: 'skeleton-card' }),
                                React.createElement('div', { className: 'skeleton-card' }),
                                React.createElement('div', { className: 'skeleton-card skeleton-card-wide' })
                            )
                        ),
                        // Bottom nav skeleton
                        React.createElement('div', { className: 'skeleton-tabs' },
                            ...Array.from({ length: 5 }, (_, i) =>
                                React.createElement('div', {
                                    key: i,
                                    className: `skeleton-tab ${i === 1 ? 'skeleton-tab-active' : ''}`
                                })
                            )
                        )
                    ),
                    // Spinner
                    React.createElement('div', { className: 'app-loader-spinner' })
                );
            }
            HEYS.AppLoader = AppLoader;
        }
    };

    // === Mobile Debug Panel ===
    // –¢—Ä–æ–π–Ω–æ–π —Ç–∞–ø –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–∫–∞–∂–µ—Ç –¥–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)
    function bootstrapGlobals() {
        HEYS.debugPanel = createDebugPanel();
        HEYS.badge = createBadgeApi();
    }
    bootstrapGlobals();

    function createDebugPanel() {
        return {
            _tapCount: 0,
            _tapTimer: null,
            _visible: false,
            _el: null,

            handleTap() {
                this._tapCount++;
                clearTimeout(this._tapTimer);

                if (this._tapCount >= 3) {
                    this._tapCount = 0;
                    this.toggle();
                } else {
                    this._tapTimer = setTimeout(() => { this._tapCount = 0; }, 500);
                }
            },

            toggle() {
                this._visible ? this.hide() : this.show();
            },

            show() {
                if (this._el) this.hide();

                const syncLog = HEYS?.cloud?.getSyncLog?.() || [];
                const pending = HEYS?.cloud?.getPendingCount?.() || 0;
                const status = HEYS?.cloud?.getStatus?.() || 'unknown';
                const cloudClientId = HEYS?.cloud?.getClientId?.() || '';

                // –ü–æ–ª—É—á–∞–µ–º clientId –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                const lsClientId = localStorage.getItem('heys_client_current') || '';
                const clientId = cloudClientId || lsClientId || 'none';

                // –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è ‚Äî –∏—â–µ–º —Å clientId prefix
                const today = new Date().toISOString().slice(0, 10);
                let dayData = null;
                let dayKey = '';

                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª—é—á–µ–π
                const possibleKeys = [
                    `heys_${clientId}_dayv2_${today}`,
                    `heys_dayv2_${today}`,
                ];

                // –¢–∞–∫–∂–µ –∏—â–µ–º –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É –≤ localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.includes(`dayv2_${today}`) && !k.includes('backup')) {
                        possibleKeys.unshift(k);
                        break;
                    }
                }

                for (const key of possibleKeys) {
                    try {
                        const raw = localStorage.getItem(key);
                        if (raw) {
                            dayData = JSON.parse(raw);
                            dayKey = key;
                            break;
                        }
                    } catch (e) { }
                }

                // –°—á–∏—Ç–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –≤ localStorage
                const allKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith('heys_')) allKeys.push(k);
                }

                const html = `
              <div id="heys-debug-panel" style="
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.95); color: #0f0; font-family: monospace;
                font-size: 11px; padding: 16px; overflow: auto; z-index: 99999;
              ">
                <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                  <b style="color:#fff;font-size:14px;">üîß HEYS Debug Panel <span style="color:#888;font-size:11px;">v${window.HEYS?.version || '?'}</span></b>
                  <button onclick="HEYS.debugPanel.hide()" style="background:#f00;color:#fff;border:none;padding:4px 12px;border-radius:4px;">‚úï Close</button>
                </div>
                
                <div style="background:#111;padding:8px;border-radius:4px;margin-bottom:8px;">
                  <b style="color:#0ff;">üì° Sync Status</b><br>
                  Status: <span style="color:${status === 'online' ? '#0f0' : '#f00'}">${status}</span><br>
                  Pending: ${pending}<br>
                  Cloud Client: ${cloudClientId ? cloudClientId.slice(0, 8) + '...' : '<span style="color:#f00">NOT SET</span>'}<br>
                  LS Client: ${lsClientId ? lsClientId.slice(0, 8) + '...' : '<span style="color:#f00">NOT SET</span>'}<br>
                  Total LS keys: ${allKeys.length}
                </div>
                
                <div style="background:#111;padding:8px;border-radius:4px;margin-bottom:8px;">
                  <b style="color:#0ff;">üìÖ Today (${today})</b><br>
                  Key: <span style="color:#888;font-size:9px;">${dayKey || 'NOT FOUND'}</span><br>
                  ${dayData ? `
                    Weight: ${dayData.weightMorning || '‚Äî'}<br>
                    Meals: ${dayData.meals?.length || 0}<br>
                    Steps: ${dayData.steps || 0}<br>
                    Water: ${dayData.waterMl || 0}ml<br>
                    Updated: ${dayData.updatedAt ? new Date(dayData.updatedAt).toLocaleTimeString() : '‚Äî'}
                  ` : '<span style="color:#f00">No data in localStorage!</span>'}
                </div>
                
                <div style="background:#111;padding:8px;border-radius:4px;margin-bottom:8px;">
                  <b style="color:#0ff;">üìú Sync Log (last 10)</b><br>
                  ${syncLog.slice(0, 10).map(e =>
                    `<div style="border-bottom:1px solid #333;padding:2px 0;">
                      ${e.time ? new Date(e.time).toLocaleTimeString() : '?'} | <b>${e.type}</b> | ${JSON.stringify(e.details || {}).slice(0, 50)}
                    </div>`
                ).join('') || '<span style="color:#888">Empty</span>'}
                </div>
                
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button onclick="HEYS.cloud?.forceSync?.();HEYS.debugPanel.refresh();" 
                    style="background:#00f;color:#fff;border:none;padding:8px 16px;border-radius:4px;">
                    üîÑ Force Sync
                  </button>
                  <button onclick="navigator.clipboard?.writeText(JSON.stringify(HEYS.cloud?.getSyncLog?.(),null,2));HEYS.Toast?.success('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!');" 
                    style="background:#555;color:#fff;border:none;padding:8px 16px;border-radius:4px;">
                    üìã Copy Log
                  </button>
                  <button onclick="HEYS.debugPanel.showDayData();" 
                    style="background:#555;color:#fff;border:none;padding:8px 16px;border-radius:4px;">
                    üìÖ Show Day JSON
                  </button>
                  <button onclick="HEYS.debugPanel.showAllKeys();" 
                    style="background:#555;color:#fff;border:none;padding:8px 16px;border-radius:4px;">
                    üóÇÔ∏è All LS Keys
                  </button>
                </div>
              </div>
            `;

                document.body.insertAdjacentHTML('beforeend', html);
                this._el = document.getElementById('heys-debug-panel');
                this._visible = true;
            },

            hide() {
                if (this._el) {
                    this._el.remove();
                    this._el = null;
                }
                this._visible = false;
            },

            refresh() {
                if (this._visible) {
                    this.hide();
                    setTimeout(() => this.show(), 100);
                }
            },

            showDayData() {
                const today = new Date().toISOString().slice(0, 10);
                // –ò—â–µ–º –¥–µ–Ω—å —Å –ª—é–±—ã–º clientId
                let dayData = null;
                let dayKey = '';
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.includes(`dayv2_${today}`) && !k.includes('backup')) {
                        dayKey = k;
                        try {
                            dayData = localStorage.getItem(k);
                        } catch (e) { }
                        break;
                    }
                }
                // Debug: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º JSON –≤ alert (–±–æ–ª—å—à–æ–π –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö)
                const msg = dayData ? `Key: ${dayKey}\n\n${JSON.stringify(JSON.parse(dayData), null, 2).slice(0, 1500)}` : `No day data found for ${today}`;
                console.log('[DEBUG] Day data:', msg);
                alert(msg);
            },

            showAllKeys() {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith('heys_')) {
                        const size = (localStorage.getItem(k) || '').length;
                        keys.push(`${k} (${size}b)`);
                    }
                }
                // Debug: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –≤ alert (–±–æ–ª—å—à–æ–π –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö)
                const msg = `HEYS keys (${keys.length}):\n\n${keys.slice(0, 30).join('\n')}${keys.length > 30 ? '\n...' : ''}`;
                console.log('[DEBUG] All keys:', keys);
                alert(msg);
            }
        };
    }

    // === Badge API Module ===
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç streak –Ω–∞ –∏–∫–æ–Ω–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Android Chrome PWA)
    function createBadgeApi() {
        return {
            update(count) {
                if (!('setAppBadge' in navigator)) return;

                try {
                    if (count > 0) {
                        navigator.setAppBadge(count);
                    } else {
                        navigator.clearAppBadge();
                    }
                } catch (e) {
                    // Silently fail ‚Äî badge –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω
                }
            },

            updateFromStreak() {
                const streak = HEYS?.Day?.getStreak?.() || 0;
                this.update(streak);
            },

            clear() {
                if ('clearAppBadge' in navigator) {
                    navigator.clearAppBadge().catch(() => { });
                }
            }
        };
    }
})();


/* ===== heys_app_shell_v1.js ===== */
// heys_app_shell_v1.js ‚Äî App header + navigation shell

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const React = window.React;
    if (!React) return;
    const U = HEYS.utils || {};

    const tryParseStoredValue = (raw, fallback) => {
        if (raw === null || raw === undefined) return fallback;
        if (typeof raw === 'string') {
            let str = raw;
            if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                try { str = HEYS.store.decompress(str); } catch (_) { }
            }
            try { return JSON.parse(str); } catch (_) { return str; }
        }
        return raw;
    };

    const readGlobalValue = (key, fallback) => {
        try {
            if (HEYS.store?.get) {
                const stored = HEYS.store.get(key, null);
                if (stored !== null && stored !== undefined) {
                    return tryParseStoredValue(stored, fallback);
                }
            }
            const raw = localStorage.getItem(key);
            if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
            if (U.lsGet) return U.lsGet(key, fallback);
            return fallback;
        } catch {
            return fallback;
        }
    };

    const writeGlobalValue = (key, value) => {
        try {
            if (HEYS.store?.set) {
                HEYS.store.set(key, value);
                return;
            }
            const serialized = typeof value === 'string' ? value : JSON.stringify(value);
            localStorage.setItem(key, serialized);
        } catch { }
    };

    const removeGlobalValue = (key) => {
        try {
            if (HEYS.store?.set) HEYS.store.set(key, null);
        } catch { }
        try { localStorage.removeItem(key); } catch { }
    };

    function AppHeader(props) {
        const {
            clientId,
            tab,
            selectedDate,
            setSelectedDate,
            todayISO,
            datePickerActiveDays,
            products,
            cachedProfile,
            currentClientName,
            getAvatarColor,
            getClientInitials,
            getClientStats,
            formatLastActive,
            clients,
            clientIdValue,
            setClientId,
            showClientDropdown,
            setShowClientDropdown,
            isRpcMode,
            cloudUser,
            handleSignOut,
            U,
            cloudStatus,
            syncProgress,
            pendingCount,
            retryCountdown,
            GamificationBar,
            setTab,
            setActiveTab,
        } = props;

        // üö® EWS Badge State (v1.0)
        const [ewsData, setEWSData] = React.useState(null);
        const clientDropdownAnchorRef = React.useRef(null);
        const [clientDropdownMaxHeight, setClientDropdownMaxHeight] = React.useState(320);
        // ‚òÅÔ∏è Cloud Sync Badge State (v2.0): auto-fade synced‚Üíidle, lastSyncedAt tracking
        const [displayStatus, setDisplayStatus] = React.useState(cloudStatus);
        const lastSyncedAtRef = React.useRef(null);
        const syncFadeTimerRef = React.useRef(null);

        React.useEffect(() => {
            if (!showClientDropdown) return;

            const updateClientDropdownHeight = () => {
                try {
                    const anchorRect = clientDropdownAnchorRef.current?.getBoundingClientRect?.();
                    const tabsRect = document.querySelector('.tabs')?.getBoundingClientRect?.();
                    const viewportHeight = window.visualViewport?.height || window.innerHeight || 800;

                    const dropdownTop = (anchorRect?.bottom || 120) + 8;
                    const tabsHeight = Math.max(56, Math.ceil(tabsRect?.height || 0));
                    const bottomGapAboveMenu = tabsHeight + 12;
                    const calculatedMaxHeight = Math.floor(viewportHeight - dropdownTop - bottomGapAboveMenu);
                    const clampedMaxHeight = Math.max(220, calculatedMaxHeight);

                    setClientDropdownMaxHeight(clampedMaxHeight);

                    console.info('[HEYS.header.clientDropdown] ‚úÖ Calculated dropdown max height:', {
                        viewportHeight,
                        dropdownTop,
                        tabsHeight,
                        bottomGapAboveMenu,
                        maxHeight: clampedMaxHeight,
                        scrollAreaMaxHeight: Math.max(120, clampedMaxHeight - 128),
                        clientsCount: Array.isArray(clients) ? clients.length : 0,
                    });
                } catch (err) {
                    console.warn('[HEYS.header.clientDropdown] ‚ö†Ô∏è Failed to calculate dropdown max height:', err?.message);
                    setClientDropdownMaxHeight(320);
                }
            };

            updateClientDropdownHeight();
            window.addEventListener('resize', updateClientDropdownHeight);
            window.visualViewport?.addEventListener?.('resize', updateClientDropdownHeight);

            return () => {
                window.removeEventListener('resize', updateClientDropdownHeight);
                window.visualViewport?.removeEventListener?.('resize', updateClientDropdownHeight);
            };
        }, [showClientDropdown, clients]);

        // Load EWS data on mount and when date changes
        React.useEffect(() => {
            console.info('ews / badge üîÑ useEffect triggered');

            let retryTimeoutId = null;
            let ewsLoaded = false; // PERF v7.2: prevent duplicate detect calls

            const loadEWSData = async (retryCount = 0) => {
                try {
                    // PERF v7.2: skip if already loaded (prevents event + timer double-fire)
                    if (ewsLoaded && retryCount > 0) return;

                    if (!HEYS?.InsightsPI?.earlyWarning?.detect) {
                        // PERF v7.1: Event listener 'heys-ews-ready' is the primary mechanism; polling is fallback
                        if (retryCount < 6) {
                            const delay = Math.min(1000 * Math.pow(2, retryCount), 8000);
                            // PERF v7.2: only log first and last retry to reduce noise
                            if (retryCount === 0 || retryCount === 5) {
                                console.info(`ews / badge ‚è≥ EWS module not ready, retry ${retryCount + 1}/6 (delay ${delay}ms)`);
                            }
                            retryTimeoutId = setTimeout(() => loadEWSData(retryCount + 1), delay);
                            return;
                        }
                        console.info('ews / badge ‚ÑπÔ∏è EWS polling exhausted ‚Äî event listener still active');
                        setEWSData(null);
                        return;
                    }

                    // PERF v7.2: cancel pending retries ‚Äî module is available
                    if (retryTimeoutId) {
                        clearTimeout(retryTimeoutId);
                        retryTimeoutId = null;
                    }
                    ewsLoaded = true;

                    console.info('ews / badge ‚úÖ EWS module detected');

                    // Load 7 days of data (ACUTE mode: current state alerts only)
                    const days = [];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const dateStr = formatLocalISO(d);
                        const U = HEYS.utils || {};
                        const dayData = U.lsGet ? U.lsGet(`heys_dayv2_${dateStr}`) : null;
                        if (dayData) days.push({ ...dayData, date: dateStr });
                    }

                    console.info('ews / badge üì¶ Days loaded:', days.length);

                    if (days.length < 3) {
                        console.info('ews / badge ‚è∏Ô∏è Insufficient data:', days.length, 'days (need 3+)');
                        setEWSData(null);
                        return;
                    }

                    const profile = cachedProfile || HEYS.store?.get?.('heys_profile') || null;
                    const pIndex = products || HEYS.products?.getAll?.() || [];

                    console.info('ews / badge üì§ calling detect:', {
                        mode: 'acute',
                        daysCount: days.length,
                        hasProfile: !!profile,
                        pIndexCount: pIndex?.length || 0,
                        checksExpected: 10
                    });

                    const result = await HEYS.InsightsPI.earlyWarning.detect(days, profile, pIndex, {
                        mode: 'acute',
                        includeDetails: true
                    });

                    if (result.available) {
                        setEWSData(result);
                        if (result.count > 0) {
                            console.info('ews / badge ‚úÖ Badge data loaded:', {
                                count: result.count,
                                high: result.highSeverityCount,
                                medium: result.count - result.highSeverityCount,
                                daysAnalyzed: days.length,
                                hasWarnings: Array.isArray(result.warnings) && result.warnings.length > 0,
                            });
                        } else {
                            console.info('ews / badge ‚úÖ All OK (no warnings):', {
                                daysAnalyzed: days.length,
                                status: 'healthy'
                            });
                        }
                    } else {
                        setEWSData(null);
                        console.info('ews / badge ‚ÑπÔ∏è EWS unavailable:', {
                            reason: result.reason || 'insufficient_data',
                            daysAnalyzed: days.length,
                        });
                    }
                } catch (err) {
                    console.warn('ews / badge ‚ö†Ô∏è Failed to load EWS data:', err.message);
                    setEWSData(null);
                }
            };

            // Listen for EWS module ready event (fired by pi_early_warning.js on load)
            const handleEWSReady = (event) => {
                console.info('ews / badge üì° heys-ews-ready event received:', event.detail);
                // PERF v7.2: cancel pending retries to prevent duplicate detect
                if (retryTimeoutId) {
                    clearTimeout(retryTimeoutId);
                    retryTimeoutId = null;
                }
                ewsLoaded = false; // allow fresh load from event
                loadEWSData(); // Immediately load data when module becomes available
            };
            window.addEventListener('heys-ews-ready', handleEWSReady);

            loadEWSData();

            // Reload on day-data-changed event
            const handleDayDataChanged = () => {
                ewsLoaded = false; // allow reload on data change
                loadEWSData();
            };
            window.addEventListener('day-data-changed', handleDayDataChanged);

            // Reload after sync complete
            const handleSyncComplete = () => {
                ewsLoaded = false; // allow reload after sync
                setTimeout(loadEWSData, 500); // Small delay to ensure data is written
            };
            window.addEventListener('heys-sync-complete', handleSyncComplete);

            // Reload every 5 minutes
            const interval = setInterval(() => {
                ewsLoaded = false;
                loadEWSData();
            }, 5 * 60 * 1000);

            return () => {
                if (retryTimeoutId) clearTimeout(retryTimeoutId);
                window.removeEventListener('heys-ews-ready', handleEWSReady);
                window.removeEventListener('day-data-changed', handleDayDataChanged);
                window.removeEventListener('heys-sync-complete', handleSyncComplete);
                clearInterval(interval);
            };
        }, [selectedDate, clientId]);

        // ‚òÅÔ∏è Auto-fade synced ‚Üí idle after 2s + track last sync time (v2.0)
        React.useEffect(() => {
            if (cloudStatus === 'synced') {
                lastSyncedAtRef.current = Date.now();
                setDisplayStatus('synced');
                clearTimeout(syncFadeTimerRef.current);
                syncFadeTimerRef.current = setTimeout(() => setDisplayStatus('idle'), 2000);
            } else {
                clearTimeout(syncFadeTimerRef.current);
                setDisplayStatus(cloudStatus);
            }
            return () => clearTimeout(syncFadeTimerRef.current);
        }, [cloudStatus]);

        const haptic = HEYS?.haptic || (() => { });
        const formatSyncAge = (ts) => {
            if (!ts) return '';
            const s = Math.floor((Date.now() - ts) / 1000);
            if (s < 10) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (s < 60) return `${s} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
            const m = Math.floor(s / 60);
            if (m < 60) return `${m} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            return `${Math.floor(m / 60)} —á –Ω–∞–∑–∞–¥`;
        };
        const handleSyncBadgeClick = () => {
            if (displayStatus === 'syncing' || displayStatus === 'offline') return;
            haptic('light');
            if (HEYS?.cloud?.syncClient && clientIdValue) {
                console.info('[HEYS.sync] üîÑ Manual force-sync triggered from badge');
                HEYS.cloud.syncClient(clientIdValue, { force: true });
            }
        };
        const pad2 = (n) => String(n).padStart(2, '0');
        const formatLocalISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        const shiftISO = (iso, delta) => {
            if (!iso) return null;
            const d = new Date(iso + 'T12:00:00');
            d.setDate(d.getDate() + delta);
            return formatLocalISO(d);
        };
        const getDefaultPrefetchDates = (nextDate) => {
            const dates = [nextDate, shiftISO(nextDate, -1), shiftISO(nextDate, 1)];
            return Array.from(new Set(dates.filter(Boolean)));
        };

        const selectDateWithPrefetch = (nextDate, options = {}) => {
            if (!nextDate) return;
            const prefetchDates = Array.isArray(options.prefetchDates) && options.prefetchDates.length
                ? options.prefetchDates
                : getDefaultPrefetchDates(nextDate);

            try {
                if (HEYS?.Day?.requestFlush) HEYS.Day.requestFlush({ force: true });
            } catch (e) { }

            const applyDate = () => {
                setSelectedDate(nextDate);
                haptic('light');
            };

            if (HEYS?.cloud?.fetchDays && prefetchDates.length > 0) {
                HEYS.cloud.fetchDays(prefetchDates)
                    .then(() => applyDate())
                    .catch(() => applyDate());
                return;
            }

            applyDate();
        };

        const clientListMaxHeight = Math.max(120, clientDropdownMaxHeight - 128);

        if (!clientId) return null;

        return React.createElement(
            'div',
            { className: 'hdr' },
            // === –í–ï–†–•–ù–Ø–Ø –õ–ò–ù–ò–Ø: Gamification Bar ===
            React.createElement(
                'div',
                { className: 'hdr-top hdr-gamification' },
                React.createElement(GamificationBar)
            ),
            // === –ù–ò–ñ–ù–Ø–Ø –õ–ò–ù–ò–Ø: –ö–ª–∏–µ–Ω—Ç + –î–µ–π—Å—Ç–≤–∏—è ===
            React.createElement(
                'div',
                { className: 'hdr-bottom' },
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ + DatePicker
                React.createElement(
                    'div',
                    { className: 'hdr-client', style: { position: 'relative', display: 'flex', alignItems: 'center', gap: '8px' }, ref: clientDropdownAnchorRef },
                    // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è dropdown
                    React.createElement(
                        'div',
                        {
                            className: 'hdr-client-clickable',
                            onClick: () => setShowClientDropdown(!showClientDropdown),
                            style: {
                                display: 'flex',
                                alignItems: 'center',
                                gap: 8,
                                cursor: 'pointer',
                                padding: '4px 8px 4px 4px',
                                borderRadius: 12,
                                transition: 'background 0.2s'
                            }
                        },
                        React.createElement(
                            'div',
                            {
                                className: 'hdr-client-avatar',
                                style: { background: getAvatarColor(currentClientName) }
                            },
                            getClientInitials(currentClientName)
                        ),
                        React.createElement(
                            'div',
                            { className: 'hdr-client-info' },
                            // –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–º–µ–Ω–∏: currentClientName
                            (() => {
                                const fullName = (currentClientName || '').trim();
                                const parts = fullName.split(' ').filter(Boolean);
                                return [
                                    React.createElement('span', { key: 'fn', className: 'hdr-client-firstname' }, parts[0] || ''),
                                    parts.length > 1 && React.createElement('span', { key: 'ln', className: 'hdr-client-lastname' }, parts.slice(1).join(' '))
                                ];
                            })()
                        ),
                        // –°—Ç—Ä–µ–ª–∫–∞ dropdown
                        React.createElement('span', {
                            style: {
                                fontSize: 10,
                                color: 'var(--muted)',
                                transition: 'transform 0.2s',
                                transform: showClientDropdown ? 'rotate(180deg)' : 'rotate(0)'
                            }
                        }, '‚ñº')
                    ),
                    // Dropdown —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
                    showClientDropdown && React.createElement(
                        'div',
                        {
                            className: 'client-dropdown',
                            style: {
                                position: 'absolute',
                                top: '100%',
                                left: 0,
                                marginTop: 8,
                                background: 'var(--card)',
                                borderRadius: 16,
                                boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
                                border: '1px solid var(--border)',
                                minWidth: 260,
                                maxHeight: clientDropdownMaxHeight,
                                overflow: 'hidden',
                                zIndex: 1000,
                                animation: 'fadeSlideIn 0.2s ease'
                            }
                        },
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º: –∫–ª–∏–µ–Ω—Ç (RPC) –∏–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä
                        isRpcMode
                            // === –ö–õ–ò–ï–ù–¢–°–ö–ò–ô –†–ï–ñ–ò–ú: —Ç–æ–ª—å–∫–æ –∏–º—è + –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ ===
                            ? [
                                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç"
                                React.createElement('div', {
                                    key: 'header',
                                    style: {
                                        padding: '16px 16px 12px',
                                        textAlign: 'center',
                                        borderBottom: '1px solid var(--border)'
                                    }
                                },
                                    React.createElement('div', {
                                        style: {
                                            width: 48,
                                            height: 48,
                                            borderRadius: '50%',
                                            background: getAvatarColor(currentClientName),
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: '#fff',
                                            fontWeight: 600,
                                            fontSize: 18,
                                            margin: '0 auto 8px'
                                        }
                                    }, getClientInitials(currentClientName)),
                                    React.createElement('div', {
                                        style: { fontSize: 16, fontWeight: 600, color: 'var(--text)' }
                                    }, currentClientName)
                                ),
                                // –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                                React.createElement('div', {
                                    key: 'settings',
                                    style: {
                                        padding: '12px 16px',
                                        textAlign: 'center',
                                        cursor: 'pointer',
                                        fontSize: 14,
                                        borderBottom: '1px solid var(--border)'
                                    },
                                    onClick: () => {
                                        setShowClientDropdown(false);
                                        if (setActiveTab) {
                                            setActiveTab('profile');
                                        }
                                    }
                                },
                                    React.createElement('span', {
                                        style: { color: 'var(--text)' }
                                    }, '‚öôÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
                                ),
                                // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
                                React.createElement('div', {
                                    key: 'logout',
                                    style: {
                                        padding: '12px 16px',
                                        textAlign: 'center',
                                        cursor: 'pointer',
                                        fontSize: 14
                                    },
                                    onClick: () => {
                                        setShowClientDropdown(false);
                                        handleSignOut();
                                    }
                                },
                                    React.createElement('span', {
                                        style: { color: '#ef4444' }
                                    }, 'üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞')
                                )
                            ]
                            // === –†–ï–ñ–ò–ú –ö–£–†–ê–¢–û–†–ê: –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
                            : [
                                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                                React.createElement('div', {
                                    key: 'header',
                                    style: {
                                        padding: '12px 16px 8px',
                                        fontSize: 12,
                                        color: 'var(--muted)',
                                        fontWeight: 600,
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px'
                                    }
                                }, `–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä (${clients.length})`),
                                // –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞)
                                React.createElement(
                                    'div',
                                    {
                                        key: 'client-list-scroll',
                                        className: 'client-dropdown-scroll-list',
                                        style: {
                                            maxHeight: clientListMaxHeight,
                                            overflowY: 'auto',
                                            overflowX: 'hidden',
                                            overscrollBehavior: 'contain'
                                        }
                                    },
                                    [...clients]
                                        .sort((a, b) => {
                                            const lastA = readGlobalValue('heys_last_client_id', '') === a.id ? 1 : 0;
                                            const lastB = readGlobalValue('heys_last_client_id', '') === b.id ? 1 : 0;
                                            if (lastA !== lastB) return lastB - lastA;
                                            // –ó–∞—Ç–µ–º –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (streak)
                                            const statsA = getClientStats(a.id);
                                            const statsB = getClientStats(b.id);
                                            return (statsB.streak || 0) - (statsA.streak || 0);
                                        })
                                        .map((c) =>
                                            React.createElement(
                                                'div',
                                                {
                                                    key: c.id,
                                                    className: 'client-dropdown-item' + (c.id === clientIdValue ? ' active' : ''),
                                                    style: {
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: 10,
                                                        padding: '10px 16px',
                                                        cursor: 'pointer',
                                                        transition: 'background 0.15s',
                                                        background: c.id === clientIdValue ? 'rgba(102, 126, 234, 0.1)' : 'transparent'
                                                    },
                                                    onClick: () => {
                                                        if (c.id !== clientIdValue) {
                                                            console.info(`[HEYS.store] üîÑ –í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞: ${c.name} (${c.id.slice(0, 8)}...)`);
                                                            // ‚úÖ FIX: –°—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º UI ‚Äî sync –≤ —Ñ–æ–Ω–µ
                                                            writeGlobalValue('heys_last_client_id', c.id);
                                                            setClientId(c.id);
                                                            window.dispatchEvent(new CustomEvent('heys:client-changed', { detail: { clientId: c.id } }));

                                                            if (HEYS.cloud && HEYS.cloud.switchClient) {
                                                                HEYS.cloud.switchClient(c.id).catch(err => {
                                                                    console.error('[HEYS.store] ‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:', err);
                                                                });
                                                            } else {
                                                                U.lsSet('heys_client_current', c.id);
                                                            }
                                                        }
                                                        setShowClientDropdown(false);
                                                    }
                                                },
                                                // –ú–∏–Ω–∏-–∞–≤–∞—Ç–∞—Ä
                                                React.createElement('div', {
                                                    style: {
                                                        width: 32,
                                                        height: 32,
                                                        borderRadius: '50%',
                                                        background: getAvatarColor(c.name),
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: '#fff',
                                                        fontWeight: 600,
                                                        fontSize: 12,
                                                        flexShrink: 0
                                                    }
                                                }, getClientInitials(c.name)),
                                                // –ò–º—è
                                                React.createElement('span', {
                                                    style: {
                                                        flex: 1,
                                                        fontWeight: c.id === clientIdValue ? 600 : 400,
                                                        color: c.id === clientIdValue ? '#4285f4' : 'var(--text)'
                                                    }
                                                }, c.name),
                                                // –ì–∞–ª–æ—á–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
                                                c.id === clientIdValue && React.createElement('span', {
                                                    style: { color: '#4285f4' }
                                                }, '‚úì')
                                            )
                                        )
                                ),
                                // –ù–∏–∂–Ω–∏–π –±–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (–≤–∏–∑—É–∞–ª—å–Ω–æ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π)
                                React.createElement(
                                    'div',
                                    {
                                        key: 'sticky-actions',
                                        className: 'client-dropdown-sticky-actions'
                                    },
                                    // –ö–Ω–æ–ø–∫–∞ "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã"
                                    React.createElement(
                                        'div',
                                        {
                                            key: 'all-clients',
                                            className: 'client-dropdown-sticky-btn client-dropdown-sticky-btn--all',
                                            style: {
                                                padding: '10px 16px 12px',
                                                textAlign: 'center',
                                                cursor: 'pointer',
                                                fontSize: 14
                                            },
                                            onClick: () => {
                                                if (window.HEYS) {
                                                    window.HEYS.currentClientId = null;
                                                    if (window.HEYS.store?.flushMemory) {
                                                        window.HEYS.store.flushMemory();
                                                    }
                                                }
                                                removeGlobalValue('heys_client_current');
                                                setClientId('');
                                                window.dispatchEvent(new CustomEvent('heys:client-changed', { detail: { clientId: null } }));
                                                setShowClientDropdown(false);
                                            }
                                        },
                                        'üë• –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã'
                                    ),
                                    // –ö–Ω–æ–ø–∫–∞ –í—ã—Ö–æ–¥ —Å email
                                    React.createElement(
                                        'div',
                                        {
                                            key: 'logout',
                                            className: 'client-dropdown-sticky-btn client-dropdown-sticky-btn--logout',
                                            style: {
                                                padding: '8px 16px 12px',
                                                textAlign: 'center',
                                                cursor: 'pointer',
                                                fontSize: 13
                                            },
                                            onClick: () => {
                                                setShowClientDropdown(false);
                                                handleSignOut();
                                            }
                                        },
                                        React.createElement('div', {
                                            className: 'client-dropdown-sticky-email',
                                            style: { fontSize: 11, marginBottom: 4 }
                                        }, cloudUser?.email || ''),
                                        React.createElement('span', {
                                            className: 'client-dropdown-sticky-logout-label'
                                        }, 'üö™ –í—ã–π—Ç–∏')
                                    )
                                )
                            ]
                    ),
                    // Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
                    showClientDropdown && React.createElement('div', {
                        style: {
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            zIndex: 999
                        },
                        onClick: () => setShowClientDropdown(false)
                    })
                ),
                // ‚òÅÔ∏è Cloud sync indicator (v2.0: forceSync on click, auto-fade, relative time tooltip)
                React.createElement('div', {
                    key: 'cloudsync',
                    className: 'cloud-sync-indicator ' + displayStatus + (displayStatus !== 'syncing' && displayStatus !== 'offline' ? ' cloud-sync-indicator--clickable' : ''),
                    title: (() => {
                        const routingMode = HEYS?.cloud?.getRoutingStatus?.()?.mode || 'unknown';
                        const modeLabel = routingMode === 'direct' ? 'üîó Direct' : routingMode === 'proxy' ? 'üîÄ Proxy' : '';
                        let baseTitle;
                        if (cloudStatus === 'syncing') {
                            baseTitle = syncProgress?.total > 1
                                ? `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... ${syncProgress.synced}/${syncProgress.total}`
                                : '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
                        } else if (cloudStatus === 'offline') {
                            baseTitle = pendingCount > 0
                                ? `–û—Ñ–ª–∞–π–Ω ‚Äî ${pendingCount} –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ–∂–∏–¥–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏`
                                : '–û—Ñ–ª–∞–π–Ω ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ';
                        } else if (cloudStatus === 'error') {
                            baseTitle = retryCountdown > 0
                                ? `–û—à–∏–±–∫–∞. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${retryCountdown}—Å ‚Äî –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞`
                                : '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞';
                        } else if (lastSyncedAtRef.current) {
                            const age = formatSyncAge(lastSyncedAtRef.current);
                            baseTitle = `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${age} ‚Äî –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏`;
                        } else {
                            baseTitle = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏';
                        }
                        return modeLabel ? `${baseTitle} (${modeLabel})` : baseTitle;
                    })(),
                    onClick: handleSyncBadgeClick,
                },
                    displayStatus === 'syncing' ? [
                        React.createElement('div', { key: 'spin', className: 'sync-spinner' }),
                        syncProgress?.total > 1 && React.createElement('span', { key: 'prog', className: 'sync-progress' }, `${syncProgress.synced}/${syncProgress.total}`)
                    ]
                        : displayStatus === 'synced'
                            ? React.createElement('span', { key: 'ok', className: 'cloud-icon synced' }, '‚úì')
                            : displayStatus === 'offline' ? [
                                React.createElement('svg', { key: 'ic', className: 'cloud-icon offline', viewBox: '0 0 24 24', width: 16, height: 16, fill: 'currentColor' },
                                    React.createElement('path', { d: 'M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z' }),
                                    React.createElement('line', { x1: '1', y1: '1', x2: '23', y2: '23', stroke: 'currentColor', strokeWidth: '2' })
                                ),
                                pendingCount > 0 && React.createElement('span', { key: 'pb', className: 'pending-badge' }, pendingCount)
                            ]
                                : displayStatus === 'error' ? [
                                    React.createElement('span', { key: 'warn', className: 'cloud-icon error' }, '‚ö†'),
                                    retryCountdown > 0 && React.createElement('span', { key: 'cd', className: 'retry-countdown' }, retryCountdown)
                                ]
                                    : React.createElement('svg', { key: 'cloud', className: 'cloud-icon idle', viewBox: '0 0 24 24', width: 16, height: 16, fill: 'currentColor' },
                                        React.createElement('path', { d: 'M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z' })
                                    )
                ),
                // üö® EWS Badge (v1.3 - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è)
                ewsData && React.createElement('div', {
                    className: 'ews-badge' + (
                        ewsData.count === 0 ? ' ews-badge--ok' :
                            ewsData.highSeverityCount > 0 ? ' ews-badge--high' : ' ews-badge--medium'
                    ),
                    title: (() => {
                        if (ewsData.count === 0) {
                            return '‚úÖ Early Warning System: –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –Ω–æ—Ä–º–µ';
                        }
                        const high = ewsData.highSeverityCount || 0;
                        const medium = ewsData.count - high;
                        const parts = [];
                        if (high > 0) parts.push(`${high} –∫—Ä–∏—Ç–∏—á.`);
                        if (medium > 0) parts.push(`${medium} –ø—Ä–µ–¥—É–ø—Ä.`);
                        return `‚ö†Ô∏è Early Warning System: ${parts.join(', ')}`;
                    })(),
                    onClick: () => {
                        haptic('medium');
                        if (ewsData.count === 0) {
                            console.info('ews / badge ‚úÖ Badge clicked (all ok) ‚Üí opening panel globally');
                        } else {
                            console.info('ews / badge üö® Badge clicked ‚Üí opening panel globally (acute mode)');
                        }
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ —Å warnings –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–∞–Ω–µ–ª–∏
                        window.dispatchEvent(new CustomEvent('heysShowEWSPanel', {
                            detail: {
                                warnings: ewsData.warnings || [],
                                mode: 'acute'
                            }
                        }));
                    }
                }, [
                    React.createElement('span', { className: 'ews-badge__icon' }, ewsData.count === 0 ? '‚úÖ' : '‚ö†Ô∏è'),
                    ewsData.count > 0 && React.createElement('span', { className: 'ews-badge__count' }, ewsData.count)
                ]),                    // –ö–Ω–æ–ø–∫–∏ "–í—á–µ—Ä–∞" + "–°–µ–≥–æ–¥–Ω—è" + DatePicker
                (tab === 'stats' || tab === 'diary' || tab === 'insights' || tab === 'month' || tab === 'widgets') && window.HEYS.DatePicker
                    ? React.createElement('div', { className: 'hdr-date-group' },
                        // –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤—á–µ—Ä–∞
                        React.createElement('button', {
                            className: 'yesterday-quick-btn' + (selectedDate === (() => {
                                const d = new Date();
                                if (d.getHours() < 3) d.setDate(d.getDate() - 1);
                                d.setDate(d.getDate() - 1);
                                // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–µ UTC!)
                                return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                            })() ? ' active' : ''),
                            onClick: () => {
                                const d = new Date();
                                if (d.getHours() < 3) d.setDate(d.getDate() - 1);
                                d.setDate(d.getDate() - 1);
                                // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–µ UTC!)
                                const nextDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                                selectDateWithPrefetch(nextDate, { reason: 'quick-yesterday' });
                            },
                            title: '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤—á–µ—Ä–∞'
                        }, (() => {
                            // –î–æ 3:00 ‚Äî –≤—á–µ—Ä–∞ = –ø–æ–∑–∞–≤—á–µ—Ä–∞ —Ä–µ–∞–ª—å–Ω–æ
                            const d = new Date();
                            if (d.getHours() < 3) d.setDate(d.getDate() - 1);
                            d.setDate(d.getDate() - 1);
                            return d.getDate();
                        })()),
                        // –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (—É—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ—á–Ω–æ–π –ø–æ—Ä–æ–≥)
                        React.createElement('button', {
                            className: 'today-quick-btn' + (selectedDate === todayISO() ? ' active' : ''),
                            onClick: () => selectDateWithPrefetch(todayISO(), { reason: 'quick-today' }),
                            title: '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'
                        }, (() => {
                            // –î–æ 3:00 ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—á–µ—Ä–∞—à–Ω–µ–µ —á–∏—Å–ª–æ
                            const d = new Date();
                            if (d.getHours() < 3) d.setDate(d.getDate() - 1);
                            return d.getDate();
                        })()),
                        // DatePicker
                        React.createElement(window.HEYS.DatePicker, {
                            valueISO: selectedDate,
                            onSelect: (nextDate) => selectDateWithPrefetch(nextDate, { reason: 'date-picker' }),
                            onRemove: () => {
                                selectDateWithPrefetch(todayISO(), { reason: 'date-picker-clear' });
                            },
                            activeDays: datePickerActiveDays,
                            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞
                            getActiveDaysForMonth: (year, month) => {
                                const getActiveDaysForMonthFn = window.HEYS.dayUtils && window.HEYS.dayUtils.getActiveDaysForMonth;
                                // Fallback chain –¥–ª—è products
                                const effectiveProducts = (products && products.length > 0) ? products
                                    : (window.HEYS.products?.getAll?.() || [])
                                        .length > 0 ? window.HEYS.products.getAll()
                                        : (U.lsGet?.('heys_products', []) || []);
                                // Fallback chain –¥–ª—è profile
                                const effectiveProfile = cachedProfile || (U && U.lsGet ? U.lsGet('heys_profile', {}) : {});
                                if (!getActiveDaysForMonthFn || !clientId || effectiveProducts.length === 0) {
                                    return new Map();
                                }
                                try {
                                    return getActiveDaysForMonthFn(year, month, effectiveProfile, effectiveProducts);
                                } catch (e) {
                                    return new Map();
                                }
                            }
                        }),
                    )
                    : null
            )
        );
    }

    function AppTabsNav(props) {
        const {
            tab,
            setTab,
            widgetsEditMode,
            defaultTab,
            setDefaultTab,
            clientId,
            selectedDate,
        } = props;

        const [settingsMenuOpen, setSettingsMenuOpen] = React.useState(false);

        React.useEffect(() => {
            if (settingsMenuOpen) setSettingsMenuOpen(false);
        }, [tab]);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CRS –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –±—ã–ª –≤—ã—á–∏—Å–ª–µ–Ω
        React.useEffect(() => {
            if (!window.HEYS?._lastCrs && window.HEYS?.CascadeCard?.computeCascadeState && clientId) {
                try {
                    const dateStr = selectedDate || window.HEYS.utils.getTodayStr();
                    const day = window.HEYS.utils.lsGet('heys_dayv2_' + dateStr, {});
                    const dayTot = window.HEYS.utils.lsGet('heys_dayTot_' + dateStr, {});
                    const prof = window.HEYS.utils.lsGet('heys_profile', {});
                    // v3.5.1: compute normAbs properly (same as buildNutritionState in day tab)
                    // heys_normAbs key is never written ‚Üí was always {}, causing normKcal fallback
                    // to 2000 and triggering false deficit_overshoot penalties for users eating
                    // within their real TDEE-based goal.
                    const normPerc = window.HEYS.utils.lsGet('heys_norms', {});
                    const optimumInfo = window.HEYS.dayUtils?.getOptimumForDay?.(day, prof) || {};
                    const normAbs = (window.HEYS.dayCalculations?.computeDailyNorms && optimumInfo.optimum)
                        ? window.HEYS.dayCalculations.computeDailyNorms(optimumInfo.optimum, normPerc)
                        : { kcal: 0, carbs: 0, simple: 0, complex: 0, prot: 0, fat: 0, bad: 0, good: 0, trans: 0, fiber: 0, gi: 0, harm: 0 };
                    console.info('[HEYS.AppTabsNav] ‚úÖ CRS init normAbs:', {
                        optimum: optimumInfo.optimum, normKcal: normAbs.kcal
                    });
                    const pIndex = window.HEYS.products?.getIndex ? window.HEYS.products.getIndex() : {};
                    window.HEYS.CascadeCard.computeCascadeState(day, dayTot, normAbs, prof, pIndex);
                } catch (e) {
                    console.warn('[HEYS.AppTabsNav] Failed to init CRS:', e);
                }
            }
        }, [clientId, selectedDate]);

        return React.createElement(
            'div',
            { className: 'tabs' + (widgetsEditMode ? ' tabs--edit-mode' : '') + (settingsMenuOpen ? ' tabs--settings-open' : '') },
            // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–≤–Ω—É—Ç—Ä–∏ tabs –¥–ª—è –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
            widgetsEditMode && React.createElement(
                'div',
                { className: 'default-tab-hint' },
                React.createElement('span', { className: 'default-tab-hint__icon' }, 'üè†'),
                React.createElement('span', { className: 'default-tab-hint__text' }, '–ù–∞–∂–º–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –µ—ë –¥–æ–º–∞—à–Ω–µ–π'),
            ),
            // –°–æ–≤–µ—Ç—ã ‚Äî –ø–µ—Ä–≤–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é
            React.createElement(
                'div',
                {
                    className: 'tab tab-advice' + (widgetsEditMode ? ' tab--disabled-home' : ''),
                    onClick: () => {
                        if (tab !== 'stats' && tab !== 'diary') {
                            setTab('stats');
                        }
                        window.dispatchEvent(new CustomEvent('heysShowAdvice'));
                    },
                },
                React.createElement('span', { className: 'tab-icon' }, 'üí°'),
                React.createElement('span', { className: 'tab-advice-badge', id: 'nav-advice-badge' }),
            ),
            // iOS Switch –≥—Ä—É–ø–ø–∞ –¥–ª—è stats/diary/widgets/insights/month ‚Äî –ü–û –¶–ï–ù–¢–†–£ + –ø–æ–¥–ø–∏—Å–∏
            React.createElement(
                'div',
                { className: 'tab-switch-wrapper tab-switch-wrapper--quint' },
                React.createElement(
                    'div',
                    { className: 'tab-switch-group tab-switch-group--quint' },
                    React.createElement(
                        'div',
                        {
                            className: 'tab tab-switch ' + (tab === 'stats' ? 'active' : '') + (widgetsEditMode && defaultTab === 'stats' ? ' default-tab-indicator' : '') + (widgetsEditMode ? ' tab--home-candidate' : ''),
                            id: 'tour-stats-tab',
                            onClick: () => {
                                if (widgetsEditMode) setDefaultTab('stats');
                                setTab('stats');
                            },
                        },
                        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–æ–º–∏–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤
                        widgetsEditMode && defaultTab === 'stats' && React.createElement('span', { className: 'default-home-badge', title: '–≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' }, 'üè†'),
                        React.createElement('span', { className: 'tab-icon' }, 'üìä'),
                        React.createElement('span', { className: 'tab-text' }, '–ò—Ç–æ–≥–∏'),
                    ),
                    React.createElement(
                        'div',
                        {
                            className: 'tab tab-switch ' + (tab === 'diary' ? 'active' : '') + (widgetsEditMode && defaultTab === 'diary' ? ' default-tab-indicator' : '') + (widgetsEditMode ? ' tab--home-candidate' : ''),
                            id: 'tour-diary-tab',
                            onClick: () => {
                                if (widgetsEditMode) setDefaultTab('diary');
                                setTab('diary');
                            },
                        },
                        widgetsEditMode && defaultTab === 'diary' && React.createElement('span', { className: 'default-home-badge', title: '–≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' }, 'üè†'),
                        React.createElement('span', { className: 'tab-icon' }, 'üç¥'),
                        React.createElement('span', { className: 'tab-text' }, '–ï–¥–∞'),
                    ),
                    React.createElement(
                        'div',
                        {
                            className: 'tab tab-switch ' + (tab === 'widgets' ? 'active' : '') + (widgetsEditMode && defaultTab === 'widgets' ? ' default-tab-indicator' : '') + (widgetsEditMode ? ' tab--home-candidate' : ''),
                            id: 'tour-widgets-tab',
                            onClick: () => {
                                if (widgetsEditMode) {
                                    setDefaultTab('widgets');
                                } else {
                                    window.HEYS?.debugPanel?.handleTap();
                                }
                                setTab('widgets');
                            },
                        },
                        widgetsEditMode && defaultTab === 'widgets' && React.createElement('span', { className: 'default-home-badge', title: '–≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' }, 'üè†'),
                        React.createElement('span', { className: 'tab-icon' }, 'üéõÔ∏è'),
                        React.createElement('span', { className: 'tab-text' }, '–í–∏–¥–∂–µ—Ç—ã'),
                    ),
                    React.createElement(
                        'div',
                        {
                            className: 'tab tab-switch ' + (tab === 'insights' ? 'active' : '') + (widgetsEditMode && defaultTab === 'insights' ? ' default-tab-indicator' : '') + (widgetsEditMode ? ' tab--home-candidate' : ''),
                            id: 'tour-insights-tab',
                            onClick: () => {
                                if (widgetsEditMode) setDefaultTab('insights');
                                setTab('insights');
                            },
                        },
                        widgetsEditMode && defaultTab === 'insights' && React.createElement('span', { className: 'default-home-badge', title: '–≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' }, 'üè†'),
                        React.createElement('span', { className: 'tab-icon' }, 'üîÆ'),
                        React.createElement('span', { className: 'tab-text' }, '–ò–Ω—Å–∞–π—Ç—ã'),
                    ),
                    React.createElement(
                        'div',
                        {
                            className: 'tab tab-switch ' + (tab === 'month' ? 'active' : '') + (widgetsEditMode && defaultTab === 'month' ? ' default-tab-indicator' : '') + (widgetsEditMode ? ' tab--home-candidate' : ''),
                            id: 'tour-month-tab',
                            onClick: () => {
                                if (widgetsEditMode) setDefaultTab('month');
                                setTab('month');
                            },
                        },
                        widgetsEditMode && defaultTab === 'month' && React.createElement('span', { className: 'default-home-badge', title: '–≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' }, 'üè†'),
                        React.createElement('span', { className: 'tab-icon' }, 'üìÖ'),
                        React.createElement('span', { className: 'tab-text' }, '–ú–µ—Å—è—Ü'),
                    ),
                ),
                // –ü–æ–¥–ø–∏—Å–∏ –ø–æ–¥ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º
                React.createElement(
                    'div',
                    { className: 'tab-switch-labels tab-switch-labels--quint' },
                    React.createElement('span', { className: 'tab-switch-label' + (tab === 'stats' ? ' active' : ''), onClick: () => setTab('stats') }, '–û—Ç—á—ë—Ç—ã'),
                    React.createElement('span', { className: 'tab-switch-label' + (tab === 'diary' ? ' active' : ''), onClick: () => setTab('diary') }, '–î–Ω–µ–≤–Ω–∏–∫'),
                    React.createElement('span', { className: 'tab-switch-label' + (tab === 'widgets' ? ' active' : ''), onClick: () => setTab('widgets') }, '–í–∏–¥–∂–µ—Ç—ã'),
                    React.createElement('span', { className: 'tab-switch-label' + (tab === 'insights' ? ' active' : ''), onClick: () => setTab('insights') }, '–ò–Ω—Å–∞–π—Ç—ã'),
                    React.createElement('span', { className: 'tab-switch-label' + (tab === 'month' ? ' active' : ''), onClick: () => setTab('month') }, '–ú–µ—Å—è—Ü'),
                ),
            ),
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–µ—Å—è –º–µ–Ω—é –≤–≤–µ—Ä—Ö
            React.createElement(
                'div',
                { className: 'tab-settings-wrap' },
                settingsMenuOpen && React.createElement('div', {
                    className: 'tab-settings-backdrop',
                    onClick: () => setSettingsMenuOpen(false)
                }),
                React.createElement(
                    'div',
                    {
                        className: 'tab ' + (tab === 'user' ? 'active' : '') + (widgetsEditMode ? ' tab--disabled-home' : ''),
                        onClick: () => {
                            if (widgetsEditMode) return;
                            setSettingsMenuOpen(!settingsMenuOpen);
                        },
                    },
                    React.createElement('span', { className: 'tab-icon' }, '‚öôÔ∏è'),
                    React.createElement('span', { className: 'tab-text' }, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'),
                ),
                settingsMenuOpen && React.createElement(
                    'div',
                    { className: 'tab-settings-menu' },
                    React.createElement(
                        'div',
                        {
                            className: 'tab-settings-item',
                            onClick: () => {
                                setSettingsMenuOpen(false);
                                setTab('user');
                            }
                        },
                        React.createElement('span', { className: 'tab-settings-icon' }, '‚öôÔ∏è'),
                        React.createElement('span', null, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏')
                    ),
                    React.createElement(
                        'div',
                        {
                            className: 'tab-settings-item',
                            onClick: () => {
                                setSettingsMenuOpen(false);
                                setTab('ration');
                            }
                        },
                        React.createElement('span', { className: 'tab-settings-icon' }, 'üì¶'),
                        React.createElement('span', null, '–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤')
                    )
                )
            ),
            // CRS Progress Bar (v3.1.0)
            window.HEYS?.CascadeCard?.CrsProgressBar && React.createElement(window.HEYS.CascadeCard.CrsProgressBar)
        );
    }

    function AppTabContent(props) {
        const {
            tab,
            slideDirection,
            edgeBounce,
            onTouchStart,
            onTouchEnd,
            syncVer,
            clientId,
            setTab,
            products,
            setProducts,
            selectedDate,
            setSelectedDate,
            DayTabWithCloudSync,
            RationTabWithCloudSync,
            UserTabWithCloudSync,
        } = props;

        const TAB_SKELETON_DELAY_MS = 240;
        const tabSkeletonSince = window.__heysTabSkeletonSince = window.__heysTabSkeletonSince || Object.create(null);
        const tabSkeletonState = window.__heysTabSkeletonState = window.__heysTabSkeletonState || Object.create(null);
        const renderTabFallback = (fallbackKey, fallbackNode) => {
            const now = Date.now();
            if (!tabSkeletonSince[fallbackKey]) {
                tabSkeletonSince[fallbackKey] = now;
            }
            const elapsedMs = now - tabSkeletonSince[fallbackKey];

            if (elapsedMs < TAB_SKELETON_DELAY_MS) {
                if (tabSkeletonState[fallbackKey] !== 'wait_delay') {
                    console.info('[HEYS.sceleton] ‚è±Ô∏è tab_wait_delay', {
                        key: fallbackKey,
                        elapsedMs,
                        delayMs: TAB_SKELETON_DELAY_MS,
                        tab,
                    });
                    tabSkeletonState[fallbackKey] = 'wait_delay';
                }
                return null;
            }

            if (tabSkeletonState[fallbackKey] !== 'show_skeleton') {
                console.info('[HEYS.sceleton] ü¶¥ tab_show_skeleton', {
                    key: fallbackKey,
                    elapsedMs,
                    delayMs: TAB_SKELETON_DELAY_MS,
                    tab,
                });
                tabSkeletonState[fallbackKey] = 'show_skeleton';
            }

            return fallbackNode;
        };

        return React.createElement(
            'div',
            {
                className: 'tab-content-swipeable' +
                    (slideDirection === 'out-left' ? ' slide-out-left' : '') +
                    (slideDirection === 'out-right' ? ' slide-out-right' : '') +
                    (slideDirection === 'in-left' ? ' slide-in-left' : '') +
                    (slideDirection === 'in-right' ? ' slide-in-right' : '') +
                    (edgeBounce === 'left' ? ' edge-bounce-left' : '') +
                    (edgeBounce === 'right' ? ' edge-bounce-right' : ''),
                onTouchStart: onTouchStart,
                onTouchEnd: onTouchEnd,
            },
            // Edge indicators
            edgeBounce && React.createElement('div', {
                className: 'edge-indicator ' + edgeBounce
            }),
            tab === 'ration'
                ? React.createElement(RationTabWithCloudSync, {
                    key: 'ration' + syncVer + '_' + String(clientId || ''),
                    products,
                    setProducts,
                    clientId,
                })
                : tab === 'insights'
                    ? (window.HEYS?.PredictiveInsights?.components?.InsightsTab
                        ? React.createElement(window.HEYS.PredictiveInsights.components.InsightsTab, {
                            key: 'insights' + syncVer + '_' + String(clientId || '') + '_' + selectedDate,
                            lsGet: window.HEYS?.utils?.lsGet,
                            profile: null,
                            pIndex: null,
                            optimum: null,
                            selectedDate: selectedDate,
                        })
                        : renderTabFallback('insights', React.createElement('div', { style: { padding: 16 } },
                            React.createElement('div', { className: 'skeleton-sparkline', style: { height: 160, marginBottom: 16 } }),
                            React.createElement('div', { className: 'skeleton-block', style: { height: 100 } })
                        )))
                    : tab === 'month'
                        ? (window.HEYS?.ReportsTab
                            ? React.createElement(window.HEYS.ReportsTab, {
                                key: 'month' + syncVer + '_' + String(clientId || '') + '_' + selectedDate,
                                selectedDate,
                                setSelectedDate,
                                clientId,
                            })
                            : renderTabFallback('month', React.createElement('div', { style: { padding: 16 } },
                                React.createElement('div', { className: 'skeleton-sparkline', style: { height: 160, marginBottom: 16 } }),
                                React.createElement('div', { className: 'skeleton-block', style: { height: 100 } })
                            )))
                        : (tab === 'stats' || tab === 'diary')
                            ? React.createElement(DayTabWithCloudSync, {
                                key: 'day' + syncVer + '_' + String(clientId || '') + '_' + selectedDate,
                                products,
                                clientId,
                                selectedDate,
                                setSelectedDate,
                                subTab: tab,
                            })
                            : tab === 'user'
                                ? React.createElement(UserTabWithCloudSync, {
                                    key: 'user' + syncVer + '_' + String(clientId || ''),
                                    clientId,
                                })
                                : tab === 'overview'
                                    ? (window.HEYS && window.HEYS.DataOverviewTab
                                        ? React.createElement(window.HEYS.DataOverviewTab, {
                                            key: 'overview' + syncVer + '_' + String(clientId || ''),
                                            clientId,
                                            setTab,
                                            setSelectedDate,
                                        })
                                        : renderTabFallback('overview', React.createElement('div', { style: { padding: 16 } },
                                            React.createElement('div', { className: 'skeleton-sparkline', style: { height: 80, marginBottom: 16 } }),
                                            React.createElement('div', { className: 'skeleton-block', style: { height: 100 } })
                                        )))
                                    : tab === 'widgets'
                                        ? (window.HEYS && window.HEYS.Widgets && window.HEYS.Widgets.WidgetsTab
                                            ? React.createElement(window.HEYS.Widgets.WidgetsTab, {
                                                key: 'widgets' + syncVer + '_' + String(clientId || '') + '_' + selectedDate,
                                                clientId,
                                                selectedDate,
                                                setTab,
                                                setSelectedDate,
                                            })
                                            : renderTabFallback('widgets', React.createElement('div', { style: { padding: 16 } },
                                                React.createElement('div', { className: 'skeleton-sparkline', style: { height: 80, marginBottom: 16 } }),
                                                React.createElement('div', { className: 'skeleton-block', style: { height: 100 } })
                                            )))
                                        : renderTabFallback('default_' + String(tab || 'unknown'), React.createElement('div', { style: { padding: 16 } },
                                            React.createElement('div', { className: 'skeleton-header', style: { width: 150, marginBottom: 16 } }),
                                            React.createElement('div', { className: 'skeleton-block', style: { height: 200 } })
                                        ))
        );
    }

    // Memoize sub-components before AppShell uses them
    const MemoAppHeader = React.memo(AppHeader);
    MemoAppHeader.displayName = 'AppHeader';

    const MemoAppTabsNav = React.memo(AppTabsNav);
    MemoAppTabsNav.displayName = 'AppTabsNav';

    const MemoAppTabContent = React.memo(AppTabContent);
    MemoAppTabContent.displayName = 'AppTabContent';

    function AppShell(props) {
        const { hideContent, clientId } = props;
        const shouldRenderContent = !!clientId;

        return React.createElement(
            'div',
            {
                className: 'wrap',
                style: hideContent ? { display: 'none' } : undefined
            },
            shouldRenderContent && React.createElement(MemoAppHeader, props),
            shouldRenderContent && React.createElement(MemoAppTabsNav, props),
            shouldRenderContent && React.createElement(MemoAppTabContent, props),
            shouldRenderContent && React.createElement(
                'div',
                { className: 'text-center text-[11px] text-slate-400 pb-6 pt-2' },
                '–í–µ—Ä—Å–∏—è ' + (HEYS.version || window.APP_VERSION || 'dev')
            )
        );
    }

    const MemoAppShell = React.memo(AppShell);
    MemoAppShell.displayName = 'AppShell';

    HEYS.AppShell = {
        AppShell: MemoAppShell,
        AppHeader: MemoAppHeader,
        AppTabsNav: MemoAppTabsNav,
        AppTabContent: MemoAppTabContent,
    };
})();


/* ===== heys_app_overlays_v1.js ===== */
// heys_app_overlays_v1.js ‚Äî Overlays and banners wrapper

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const React = window.React;
    if (!React) return;

    function AppOverlays(props) {
        const {
            gate,
            desktopGate,
            consentGate,
            isConsentBlocking,
            isMorningCheckinBlocking,
            showMorningCheckin,
            setShowMorningCheckin,
            showOfflineBanner,
            showOnlineBanner,
            offlineDuration,
            pendingCount,
            showPwaBanner,
            showIosPwaBanner,
            handlePwaInstall,
            dismissPwaBanner,
            dismissIosPwaBanner,
            showUpdateToast,
            handleUpdate,
            dismissUpdateToast,
            notification,
            dismissNotification,
            widgetsEditMode,
            tab,
            AppShell,
            appShellProps,
        } = props;

        return React.createElement(
            React.Fragment,
            null,
            gate,
            desktopGate,
            consentGate,
            // === MORNING CHECK-IN (–≤–µ—Å, —Å–æ–Ω, —à–∞–≥–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–ú–ï–°–¢–û –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–û –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏–π) ===
            !isConsentBlocking && isMorningCheckinBlocking && React.createElement(HEYS.MorningCheckin, {
                onComplete: () => {
                    setShowMorningCheckin(false);
                },
                onClose: () => {
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ—Å—Ç–∏–∫–æ–º ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    // –ü—Ä–∏ reload —á–µ–∫-–∏–Ω —Å–Ω–æ–≤–∞ –ø–æ—è–≤–∏—Ç—Å—è –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –≤–µ—Å
                    setShowMorningCheckin(false);
                }
            }),
            // === OFFLINE BANNER (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ—Ç–∏) ===
            !isConsentBlocking && !isMorningCheckinBlocking && showOfflineBanner && React.createElement(
                'div',
                { className: 'offline-banner offline-banner-enhanced' },
                React.createElement('span', { className: 'offline-banner-icon pulse' }, 'üì°'),
                React.createElement('div', { className: 'offline-banner-content' },
                    React.createElement('span', { className: 'offline-banner-text' },
                        '–ù–µ—Ç —Å–µ—Ç–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ'
                    ),
                    // üÜï –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ—Ñ–ª–∞–π–Ω –µ—Å–ª–∏ >10 —Å–µ–∫—É–Ω–¥
                    offlineDuration > 10 && React.createElement('span', { className: 'offline-banner-duration' },
                        `–û—Ñ–ª–∞–π–Ω ${offlineDuration < 60 ? `${offlineDuration} —Å–µ–∫` : `${Math.floor(offlineDuration / 60)} –º–∏–Ω`}`
                    )
                )
            ),
            // === ONLINE BANNER (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 2 —Å–µ–∫ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏) ===
            !isConsentBlocking && !isMorningCheckinBlocking && showOnlineBanner && React.createElement(
                'div',
                { className: 'online-banner' },
                React.createElement('span', { className: 'online-banner-icon' }, '‚úì'),
                React.createElement('span', { className: 'online-banner-text' },
                    pendingCount > 0 ? '–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...' : '–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'
                )
            ),
            // Toast —É–±—Ä–∞–Ω ‚Äî –æ—Ç–≤–ª–µ–∫–∞–µ—Ç
            // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî —Å–∫—Ä—ã—Ç –≤–æ –≤—Ä–µ–º—è Morning Check-in, Consent Screen –∏–ª–∏ –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è gate (login/client select)
            React.createElement(AppShell, appShellProps),
            // === PWA Install Banner for Android/Desktop (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ Morning Check-in) ===
            !isMorningCheckinBlocking && showPwaBanner && React.createElement(
                'div',
                { className: 'pwa-install-banner' },
                React.createElement('div', { className: 'pwa-banner-content' },
                    React.createElement('div', { className: 'pwa-banner-icon' }, 'üì±'),
                    React.createElement('div', { className: 'pwa-banner-text' },
                        React.createElement('div', { className: 'pwa-banner-title' }, '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å HEYS'),
                        React.createElement('div', { className: 'pwa-banner-desc' }, '–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞')
                    ),
                    React.createElement('div', { className: 'pwa-banner-actions' },
                        React.createElement('button', {
                            className: 'pwa-banner-install',
                            onClick: handlePwaInstall
                        }, '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'),
                        React.createElement('button', {
                            className: 'pwa-banner-dismiss',
                            onClick: dismissPwaBanner
                        }, '‚úï')
                    )
                )
            ),
            // === iOS Safari PWA Banner ===
            !isMorningCheckinBlocking && showIosPwaBanner && React.createElement(
                'div',
                { className: 'pwa-install-banner ios-pwa-banner' },
                React.createElement('div', { className: 'pwa-banner-content ios-banner-content' },
                    React.createElement('div', { className: 'pwa-banner-icon' }, 'üì≤'),
                    React.createElement('div', { className: 'pwa-banner-text' },
                        React.createElement('div', { className: 'pwa-banner-title' }, '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å HEYS'),
                        React.createElement('div', { className: 'ios-benefit-hint' },
                            '‚ú® –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø ‚Ä¢ –†–∞–±–æ—Ç–∞ offline'
                        ),
                        React.createElement('div', { className: 'ios-steps' },
                            React.createElement('div', { className: 'ios-step' },
                                React.createElement('span', { className: 'ios-step-num' }, '1'),
                                '–ù–∞–∂–º–∏—Ç–µ ',
                                React.createElement('span', { className: 'ios-share-icon' },
                                    React.createElement('svg', { width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                                        React.createElement('path', { d: 'M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8' }),
                                        React.createElement('polyline', { points: '16 6 12 2 8 6' }),
                                        React.createElement('line', { x1: 12, y1: 2, x2: 12, y2: 15 })
                                    )
                                ),
                                ' –≤–Ω–∏–∑—É'
                            ),
                            React.createElement('div', { className: 'ios-step' },
                                React.createElement('span', { className: 'ios-step-num' }, '2'),
                                '¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª'
                            )
                        )
                    ),
                    React.createElement('button', {
                        className: 'ios-got-it-btn',
                        onClick: dismissIosPwaBanner
                    }, '–ü–æ–Ω—è–ª')
                ),
                React.createElement('div', { className: 'ios-arrow-hint' },
                    React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'currentColor' },
                        React.createElement('path', { d: 'M12 16l-6-6h12l-6 6z' })
                    )
                )
            ),
            // === Update Toast (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ Morning Check-in) ===
            !isMorningCheckinBlocking && showUpdateToast && React.createElement(
                'div',
                { className: 'update-toast' },
                React.createElement('div', { className: 'update-toast-content' },
                    React.createElement('span', { className: 'update-toast-icon' }, 'üöÄ'),
                    React.createElement('span', { className: 'update-toast-text' }, '–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è!'),
                    React.createElement('button', {
                        className: 'update-toast-btn',
                        onClick: handleUpdate
                    }, '–û–±–Ω–æ–≤–∏—Ç—å'),
                    React.createElement('button', {
                        className: 'update-toast-dismiss',
                        onClick: dismissUpdateToast
                    }, '‚úï')
                )
            ),
            // === App Notification Toast ===
            !isMorningCheckinBlocking && notification && React.createElement(
                'div',
                { className: 'update-toast' },
                React.createElement('div', { className: 'update-toast-content' },
                    React.createElement('span', { className: 'update-toast-icon' }, notification.icon || (notification.type === 'success' ? '‚úÖ' : notification.type === 'error' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è')),
                    React.createElement('span', { className: 'update-toast-text' }, notification.message || ''),
                    React.createElement('button', {
                        className: 'update-toast-dismiss',
                        onClick: dismissNotification
                    }, '‚úï')
                )
            ),
            // === FAB —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –í–°–ï–• –≤–∫–ª–∞–¥–∫–∞—Ö –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ===
            widgetsEditMode && tab !== 'widgets' && React.createElement(
                'div',
                { className: 'widgets-fab-left widgets-fab-global' },
                React.createElement('button', {
                    className: 'widgets-edit-fab active',
                    onClick: () => {
                        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        if (window.HEYS?.Widgets?.toggleEditMode) {
                            window.HEYS.Widgets.toggleEditMode();
                        }
                    },
                    'aria-label': '–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±–æ—Ä –¥–æ–º–∞—à–Ω–µ–π –≤–∫–ª–∞–¥–∫–∏'
                }, '‚úì')
            ),
        );
    }

    const MemoAppOverlays = React.memo(AppOverlays);
    MemoAppOverlays.displayName = 'AppOverlays';

    HEYS.AppOverlays = {
        AppOverlays: MemoAppOverlays,
    };
})();


/* ===== heys_app_gate_flow_v1.js ===== */
// heys_app_gate_flow_v1.js ‚Äî Gate flow UI (login, client select, desktop/consents)

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const React = window.React;
    const ReactDOM = window.ReactDOM;
    if (!React) return;

    const U = HEYS.utils || {};

    const tryParseStoredValue = (raw, fallback) => {
        if (raw === null || raw === undefined) return fallback;
        if (typeof raw === 'string') {
            let str = raw;
            if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                try { str = HEYS.store.decompress(str); } catch (_) { }
            }
            try { return JSON.parse(str); } catch (_) { return str; }
        }
        return raw;
    };

    const readGlobalValue = (key, fallback) => {
        try {
            if (HEYS.store?.get) {
                const stored = HEYS.store.get(key, null);
                if (stored !== null && stored !== undefined) {
                    return tryParseStoredValue(stored, fallback);
                }
            }
            const raw = localStorage.getItem(key);
            if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
            if (U.lsGet) return U.lsGet(key, fallback);
            return fallback;
        } catch {
            return fallback;
        }
    };

    const writeGlobalValue = (key, value) => {
        try {
            if (HEYS.store?.set) {
                HEYS.store.set(key, value);
                return;
            }
            const serialized = typeof value === 'string' ? value : JSON.stringify(value);
            localStorage.setItem(key, serialized);
        } catch { }
    };

    const removeGlobalValue = (key) => {
        try {
            if (HEYS.store?.set) HEYS.store.set(key, null);
        } catch { }
        try { localStorage.removeItem(key); } catch { }
    };

    // üÜï –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    const getEffectiveSubscriptionStatus = (client) => {
        const statusRaw = client.subscription_status || 'none';
        const now = Date.now();
        const activeUntil = client.active_until ? new Date(client.active_until).getTime() : null;
        const trialEndsAt = client.trial_ends_at ? new Date(client.trial_ends_at).getTime() : null;
        const trialStartsAt = client.trial_started_at ? new Date(client.trial_started_at).getTime() : null;

        if (activeUntil && activeUntil > now) return 'active';
        if (trialStartsAt && trialStartsAt > now) return 'trial_pending';
        if (trialEndsAt && trialEndsAt > now) return 'trial';

        return statusRaw || 'none';
    };

    const getSubscriptionBadge = (client) => {
        const status = getEffectiveSubscriptionStatus(client);
        // active_until –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ trial_ends_at –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è end date
        const rawEndDate = client.active_until || client.trial_ends_at;
        const endDate = rawEndDate ? new Date(rawEndDate) : null;
        const now = new Date();
        const daysLeft = endDate ? Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)) : null;
        const debugSet = (HEYS._subBadgeDebug = HEYS._subBadgeDebug || new Set());
        const clientId = client && client.id ? String(client.id) : '';
        const clientShortId = clientId ? clientId.slice(0, 8) : 'unknown';
        const debugKey = `${clientShortId}:${status}:${endDate ? endDate.toISOString().slice(0, 10) : 'no_end'}`;

        if (!debugSet.has(debugKey)) {
            debugSet.add(debugKey);
            console.info('[HEYS.subs] ‚ÑπÔ∏è Badge reason', {
                clientId: clientShortId,
                status,
                hasEndDate: !!endDate,
                daysLeft
            });
        }

        if (!endDate || status === 'none') {
            return { emoji: '‚ö™', color: '#6b7280', bg: '#f3f4f6', text: '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏', urgent: false };
        }

        if (daysLeft !== null && daysLeft < 0) {
            return { emoji: 'üî¥', color: '#dc2626', bg: '#fee2e2', text: `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ ${Math.abs(daysLeft)} –¥–Ω.`, urgent: true };
        }

        if (daysLeft !== null && daysLeft <= 3) {
            return { emoji: 'üü°', color: '#d97706', bg: '#fef3c7', text: `–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${daysLeft} –¥–Ω.`, urgent: true };
        }

        if (daysLeft !== null && daysLeft <= 7) {
            return { emoji: 'üü°', color: '#ca8a04', bg: '#fef9c3', text: `–î–æ ${endDate.toLocaleDateString('ru-RU')}`, urgent: false };
        }

        if (status === 'trial') {
            return { emoji: '‚è≥', color: '#6366f1', bg: '#e0e7ff', text: `–¢—Ä–∏–∞–ª –¥–æ ${endDate.toLocaleDateString('ru-RU')}`, urgent: false };
        }

        if (status === 'trial_pending') {
            const startDate = client.trial_ends_at ? new Date(new Date(client.trial_ends_at).getTime() - 7 * 24 * 60 * 60 * 1000) : null;
            const startText = startDate ? startDate.toLocaleDateString('ru-RU') : '?';
            return { emoji: 'üïê', color: '#3b82f6', bg: '#dbeafe', text: `–û–∂–∏–¥–∞–µ—Ç —Å ${startText}`, urgent: false };
        }

        if (status === 'active') {
            return { emoji: 'üü¢', color: '#16a34a', bg: '#dcfce7', text: `–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${endDate.toLocaleDateString('ru-RU')}`, urgent: false };
        }

        if (status === 'read_only') {
            return { emoji: 'üîí', color: '#dc2626', bg: '#fee2e2', text: '–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω', urgent: true };
        }

        return { emoji: '‚ö™', color: '#6b7280', bg: '#f3f4f6', text: status, urgent: false };
    };

    // ‚öôÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ—Ä—Ç–∞–ª + enterprise UI)
    function ClientSubscriptionButton({ client, curatorId, onUpdate }) {
        const [open, setOpen] = React.useState(false);
        const [view, setView] = React.useState('main'); // main | trial | extend
        const [loading, setLoading] = React.useState(false);
        const [trialDate, setTrialDate] = React.useState(() => new Date().toISOString().split('T')[0]);
        const [months, setMonths] = React.useState(1);

        const status = getEffectiveSubscriptionStatus(client);
        const badge = getSubscriptionBadge(client);
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('ru-RU') : '‚Äî';
        const h = React.createElement;

        const closeModal = () => { setOpen(false); setView('main'); };

        // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª
        const handleActivateTrial = async () => {
            console.info('[HEYS.subs] üé´ –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–∏–∞–ª–∞', { clientId: client.id, clientName: client.name, trialDate });
            setLoading(true);
            try {
                const res = await HEYS.TrialQueue?.admin?.activateTrial?.(client.id, trialDate);
                if (res && res.success) {
                    const isToday = trialDate === new Date().toISOString().split('T')[0];
                    console.info('[HEYS.subs] ‚úÖ –¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ', { clientId: client.id, status: res.status, trialEndsAt: res.trial_ends_at });
                    HEYS.Toast?.success?.(isToday
                        ? '‚úÖ –¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! 7 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞.'
                        : `‚úÖ –¢—Ä–∏–∞–ª –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${trialDate}`
                    );
                    client.subscription_status = res.status || (isToday ? 'trial' : 'trial_pending');
                    client.trial_ends_at = res.trial_ends_at;
                    onUpdate?.();
                    closeModal();
                } else {
                    const errorMessage = res?.message || res?.error?.message || res?.error || '–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–∏–∞–ª–∞';
                    console.warn('[HEYS.subs] ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–∏–∞–ª–∞', { message: errorMessage, response: res });
                    HEYS.Toast?.error?.(errorMessage);
                }
            } catch (e) {
                console.error('[HEYS.sub] ‚ùå activateTrial error:', e);
                HEYS.Toast?.error?.('–û—à–∏–±–∫–∞: ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'));
            }
            setLoading(false);
        };

        // –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        const handleExtend = async () => {
            console.info('[HEYS.subs] ‚ûï –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏', { clientId: client.id, clientName: client.name, months });
            setLoading(true);
            try {
                const { data: res, error } = await HEYS.YandexAPI?.rpc?.('admin_extend_subscription', {
                    p_curator_id: curatorId,
                    p_client_id: client.id,
                    p_months: months
                }) || {};
                if (error) {
                    console.error('[HEYS.subs] ‚ùå RPC error –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏', { error: error.message, clientId: client.id });
                    HEYS.Toast?.error?.(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è');
                } else if (res && res.success) {
                    console.info('[HEYS.subs] ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', { clientId: client.id, newEndDate: res.new_end_date, newStatus: res.new_status });
                    HEYS.Toast?.success?.(`‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ –¥–æ ${formatDate(res.new_end_date)}`);
                    client.active_until = res.new_end_date;
                    client.subscription_status = res.new_status || 'active';
                    onUpdate?.();
                    closeModal();
                } else {
                    console.warn('[HEYS.subs] ‚ö†Ô∏è –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', { message: res?.message, clientId: client.id });
                    HEYS.Toast?.error?.(res?.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è');
                }
            } catch (e) {
                console.error('[HEYS.sub] ‚ùå extend error:', e);
                HEYS.Toast?.error?.('–û—à–∏–±–∫–∞: ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–ª–∏—Ç—å'));
            }
            setLoading(false);
        };

        // –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        const handleCancel = async () => {
            console.info('[HEYS.subs] üö´ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∫–∏', { clientId: client.id, clientName: client.name });
            if (!confirm(`–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è "${client.name}"?\n–°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–µ—Ç ¬´–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏¬ª.`)) {
                console.info('[HEYS.subs] ‚èπÔ∏è –°–±—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                return;
            }
            setLoading(true);
            try {
                const { data: res, error } = await HEYS.YandexAPI?.rpc?.('admin_cancel_subscription', {
                    p_curator_id: curatorId,
                    p_client_id: client.id
                }) || {};
                if (error) {
                    console.error('[HEYS.subs] ‚ùå RPC error –ø—Ä–∏ —Å–±—Ä–æ—Å–µ', { error: error.message, clientId: client.id });
                    HEYS.Toast?.error?.(error.message || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞');
                } else if (res && res.success) {
                    console.info('[HEYS.subs] ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', { clientId: client.id });
                    HEYS.Toast?.success?.('üö´ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
                    client.subscription_status = 'none';
                    client.active_until = null;
                    client.trial_ends_at = null;
                    onUpdate?.();
                    closeModal();
                } else {
                    console.warn('[HEYS.subs] ‚ö†Ô∏è –°–±—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è', { message: res?.message, clientId: client.id });
                    HEYS.Toast?.error?.(res?.message || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞');
                }
            } catch (e) {
                console.error('[HEYS.sub] ‚ùå cancel error:', e);
                HEYS.Toast?.error?.('–û—à–∏–±–∫–∞: ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å'));
            }
            setLoading(false);
        };

        const btnBase = {
            border: '1px solid var(--border, #e5e7eb)',
            borderRadius: 10,
            padding: '10px 14px',
            fontSize: 14,
            fontWeight: 600,
            cursor: 'pointer',
            width: '100%',
            textAlign: 'left',
            display: 'flex',
            alignItems: 'center',
            gap: 10,
            background: 'var(--card, #fff)'
        };

        const pill = (label, value) => h('div', {
            style: {
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                gap: 12,
                padding: '8px 10px',
                borderRadius: 10,
                background: 'var(--bg-secondary, #f9fafb)',
                border: '1px solid var(--border, #e5e7eb)'
            }
        },
            h('span', { style: { fontSize: 12, color: '#6b7280' } }, label),
            h('span', { style: { fontSize: 12, fontWeight: 600, color: 'var(--text, #111827)' } }, value)
        );

        const statCard = (label, value, tone) => h('div', {
            style: {
                padding: '10px 12px',
                borderRadius: 12,
                border: '1px solid var(--border, #e5e7eb)',
                background: tone?.bg || 'var(--card, #fff)'
            }
        },
            h('div', { style: { fontSize: 11, color: '#6b7280', marginBottom: 4 } }, label),
            h('div', { style: { fontSize: 13, fontWeight: 700, color: tone?.color || 'var(--text, #111827)' } }, value)
        );

        const trialView = () => h('div', { style: { display: 'grid', gap: 16 } },
            h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                h('div', { style: { width: 34, height: 34, borderRadius: 10, background: '#ecfdf5', display: 'flex', alignItems: 'center', justifyContent: 'center' } }, 'üé´'),
                h('div', null,
                    h('div', { style: { fontSize: 16, fontWeight: 700, color: 'var(--text, #111827)' } }, '–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–∏–∞–ª–∞'),
                    h('div', { style: { fontSize: 12, color: '#6b7280' } }, '–ù–∞–∑–Ω–∞—á—å—Ç–µ –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞')
                )
            ),
            h('div', null,
                h('label', { style: { display: 'block', fontSize: 12, color: '#6b7280', marginBottom: 6 } }, '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'),
                h('input', {
                    type: 'date', value: trialDate,
                    onChange: (e) => {
                        console.info('[HEYS.subs] üìÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã —Ç—Ä–∏–∞–ª–∞', { clientId: client.id, oldDate: trialDate, newDate: e.target.value });
                        setTrialDate(e.target.value);
                    },
                    min: new Date().toISOString().split('T')[0],
                    style: { width: '100%', padding: '10px 12px', borderRadius: 10, border: '1px solid #d1d5db', fontSize: 14, boxSizing: 'border-box' }
                })
            ),
            h('div', { style: { fontSize: 12, color: '#6b7280' } },
                trialDate === new Date().toISOString().split('T')[0]
                    ? '‚ö° –¢—Ä–∏–∞–ª –Ω–∞—á–Ω—ë—Ç—Å—è —Å—Ä–∞–∑—É (7 –¥–Ω–µ–π)'
                    : `üìÖ –¢—Ä–∏–∞–ª –Ω–∞—á–Ω—ë—Ç—Å—è ${trialDate}, –¥–æ—Å—Ç—É–ø –Ω–∞ 7 –¥–Ω–µ–π`
            ),
            h('div', { style: { display: 'flex', gap: 8 } },
                h('button', {
                    onClick: () => {
                        console.info('[HEYS.subs] ‚Üê –í–æ–∑–≤—Ä–∞—Ç –∏–∑ trial view');
                        setView('main');
                    },
                    style: { ...btnBase, justifyContent: 'center', background: 'var(--border, #eef2f7)' }
                }, '‚Üê –ù–∞–∑–∞–¥'),
                h('button', {
                    onClick: handleActivateTrial, disabled: loading,
                    style: { ...btnBase, justifyContent: 'center', background: loading ? '#9ca3af' : 'linear-gradient(135deg, #22c55e, #16a34a)', color: '#fff', border: 'none' }
                }, loading ? '‚è≥...' : '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å')
            )
        );

        const extendView = () => h('div', { style: { display: 'grid', gap: 16 } },
            h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                h('div', { style: { width: 34, height: 34, borderRadius: 10, background: '#eff6ff', display: 'flex', alignItems: 'center', justifyContent: 'center' } }, '‚ûï'),
                h('div', null,
                    h('div', { style: { fontSize: 16, fontWeight: 700, color: 'var(--text, #111827)' } }, '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏'),
                    h('div', { style: { fontSize: 12, color: '#6b7280' } }, '–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å')
                )
            ),
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 } },
                [1, 2, 3, 6].map(m => h('button', {
                    key: m,
                    onClick: () => {
                        console.info('[HEYS.subs] üìÜ –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è', { clientId: client.id, months: m });
                        setMonths(m);
                    },
                    style: {
                        padding: '10px 0', borderRadius: 10, fontSize: 13, fontWeight: 700, cursor: 'pointer',
                        border: months === m ? '2px solid #2563eb' : '2px solid #e5e7eb',
                        background: months === m ? '#eff6ff' : 'var(--card, #fff)',
                        color: months === m ? '#1d4ed8' : 'var(--text, #374151)'
                    }
                }, `${m} –º–µ—Å`))
            ),
            h('div', { style: { fontSize: 12, color: '#6b7280' } },
                `–ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞ ${months} –º–µ—Å. –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è`
            ),
            h('div', { style: { display: 'flex', gap: 8 } },
                h('button', {
                    onClick: () => {
                        console.info('[HEYS.subs] ‚Üê –í–æ–∑–≤—Ä–∞—Ç –∏–∑ extend view');
                        setView('main');
                    },
                    style: { ...btnBase, justifyContent: 'center', background: 'var(--border, #eef2f7)' }
                }, '‚Üê –ù–∞–∑–∞–¥'),
                h('button', {
                    onClick: handleExtend, disabled: loading,
                    style: { ...btnBase, justifyContent: 'center', background: loading ? '#9ca3af' : 'linear-gradient(135deg, #4285f4, #2563eb)', color: '#fff', border: 'none' }
                }, loading ? '‚è≥...' : `‚úÖ +${months} –º–µ—Å`)
            )
        );

        const mainView = () => h('div', { style: { display: 'grid', gap: 16 } },
            h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                h('div', { style: { width: 44, height: 44, borderRadius: 14, background: badge.bg, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, badge.emoji),
                h('div', null,
                    h('div', { style: { fontSize: 16, fontWeight: 700, color: 'var(--text, #111827)' } }, client.name),
                    h('div', { style: { fontSize: 12, color: badge.color, fontWeight: 700 } }, badge.text)
                )
            ),
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8 } },
                statCard('–°—Ç–∞—Ç—É—Å', status, { color: badge.color, bg: badge.bg }),
                statCard('–¢—Ä–∏–∞–ª –¥–æ', formatDate(client.trial_ends_at)),
                statCard('–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ', formatDate(client.active_until))
            ),
            h('div', { style: { display: 'grid', gap: 8 } },
                pill('ID –∫–ª–∏–µ–Ω—Ç–∞', (client.id || '').slice(0, 8) + '‚Ä¶'),
                pill('–¢–∞—Ä–∏—Ñ', status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : status === 'trial' ? '–¢—Ä–∏–∞–ª' : status === 'trial_pending' ? '–û–∂–∏–¥–∞–Ω–∏–µ' : status === 'read_only' ? '–û–≥—Ä–∞–Ω–∏—á–µ–Ω' : '–ù–µ—Ç')
            ),
            h('div', { style: { display: 'grid', gap: 8 } },
                (status === 'none' || status === 'read_only' || status === 'trial_pending') && h('button', {
                    onClick: () => {
                        console.info('[HEYS.subs] üé´ –û—Ç–∫—Ä—ã—Ç–∏–µ trial view', { clientId: client.id, status });
                        setTrialDate(new Date().toISOString().split('T')[0]);
                        setView('trial');
                    },
                    style: { ...btnBase, background: '#ecfdf5', color: '#059669', border: '1px solid #bbf7d0' }
                }, status === 'trial_pending' ? '‚ö° –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∏–∞–ª —Å–µ–π—á–∞—Å' : 'üé´ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª'),
                h('button', {
                    onClick: () => {
                        console.info('[HEYS.subs] ‚ûï –û—Ç–∫—Ä—ã—Ç–∏–µ extend view', { clientId: client.id, status });
                        setMonths(1);
                        setView('extend');
                    },
                    style: { ...btnBase, background: '#eff6ff', color: '#1d4ed8', border: '1px solid #bfdbfe' }
                }, '‚ûï –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'),
                status !== 'none' && h('button', {
                    onClick: handleCancel, disabled: loading,
                    style: { ...btnBase, background: '#fef2f2', color: '#dc2626', border: '1px solid #fecaca' }
                }, loading ? '‚è≥ –°–±—Ä–æ—Å...' : 'üö´ –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É')
            )
        );

        const modalContent = h('div', {
            style: {
                width: 480,
                maxWidth: '92vw',
                maxHeight: '86vh',
                background: 'var(--card, #fff)',
                borderRadius: 18,
                boxShadow: '0 30px 80px rgba(0,0,0,0.35)',
                border: '1px solid rgba(148,163,184,0.25)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
            }
        },
            h('div', {
                style: {
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '16px 18px',
                    background: 'linear-gradient(135deg, #0f172a, #1e293b)',
                    color: '#fff'
                }
            },
                h('div', { style: { fontSize: 13, fontWeight: 700, letterSpacing: 0.2 } }, '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π'),
                h('button', {
                    onClick: closeModal,
                    style: {
                        width: 28,
                        height: 28,
                        borderRadius: 8,
                        border: '1px solid rgba(255,255,255,0.3)',
                        background: 'rgba(255,255,255,0.08)',
                        color: '#fff',
                        cursor: 'pointer'
                    }
                }, '‚úï')
            ),
            h('div', {
                style: {
                    padding: 18,
                    overflow: 'auto',
                    background: 'var(--surface, #f8fafc)'
                }
            },
                view === 'main' ? mainView() : view === 'trial' ? trialView() : extendView()
            )
        );

        const modalOverlay = open && h('div', {
            style: {
                position: 'fixed',
                inset: 0,
                background: 'rgba(2,6,23,0.55)',
                backdropFilter: 'blur(6px)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000,
                padding: '24px'
            },
            onClick: (e) => { if (e.target === e.currentTarget) closeModal(); }
        }, modalContent);

        const portal = open && ReactDOM?.createPortal
            ? ReactDOM.createPortal(modalOverlay, document.body)
            : modalOverlay;

        return h(React.Fragment, null,
            h('button', {
                className: 'btn-icon',
                title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π',
                onClick: (e) => {
                    e.stopPropagation();
                    console.info('[HEYS.subs] ‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π', { clientId: client.id, clientName: client.name });
                    setOpen(true);
                    setView('main');
                },
                style: {
                    width: 32, height: 32, borderRadius: 8, border: 'none',
                    background: '#e0e7ff', cursor: 'pointer', fontSize: 14,
                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                }
            }, '‚öôÔ∏è'),
            portal
        );
    }

    // üÜï –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
    function CreateClientModal(props) {
        const {
            newName, setNewName,
            newPhone, setNewPhone,
            newPin, setNewPin,
            addClientToCloud
        } = props;
        const [open, setOpen] = React.useState(false);

        const closeModal = () => {
            setOpen(false);
            setNewName('');
            setNewPhone('');
            setNewPin('');
        };

        const handleCreate = () => {
            const canCreate = newName.trim() && newPhone.trim() && newPin.trim();
            if (!canCreate) return;
            addClientToCloud({ name: newName, phone: newPhone, pin: newPin }).then(() => {
                closeModal();
                HEYS.Toast?.success?.('‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');
            });
        };

        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
        const triggerBtn = React.createElement(
            'button',
            {
                onClick: () => setOpen(true),
                style: {
                    width: '100%',
                    padding: '16px',
                    borderRadius: 14,
                    background: '#eff6ff',
                    border: '1px dashed #60a5fa',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: 10,
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                },
                onMouseEnter: (e) => { e.currentTarget.style.background = '#dbeafe'; e.currentTarget.style.borderColor = '#3b82f6'; },
                onMouseLeave: (e) => { e.currentTarget.style.background = '#eff6ff'; e.currentTarget.style.borderColor = '#60a5fa'; }
            },
            React.createElement('span', { style: { fontSize: 20, lineHeight: 1 } }, '‚ûï'),
            React.createElement('span', { style: { fontSize: 15, fontWeight: 600, color: '#2563eb' } }, '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞')
        );

        const modalContent = React.createElement('div', {
            style: {
                width: 440,
                maxWidth: '92vw',
                background: '#fff',
                borderRadius: 20,
                boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden',
                animation: 'scaleIn 0.2s ease-out'
            },
            onClick: (e) => e.stopPropagation()
        },
            // Header
            React.createElement('div', {
                style: {
                    padding: '16px 20px',
                    background: 'linear-gradient(135deg, #0f172a, #334155)',
                    color: '#fff',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }
            },
                React.createElement('div', { style: { fontWeight: 700, fontSize: 16 } }, '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç'),
                React.createElement('button', {
                    onClick: closeModal,
                    style: { width: 30, height: 30, borderRadius: 8, background: 'rgba(255,255,255,0.1)', border: 'none', color: '#fff', fontSize: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }
                }, '‚úï')
            ),
            // Body
            React.createElement('div', { style: { padding: 20, display: 'grid', gap: 16 } },
                // Name
                React.createElement('div', null,
                    React.createElement('label', { style: { display: 'block', fontSize: 13, fontWeight: 600, color: '#374151', marginBottom: 6 } }, '–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞'),
                    React.createElement('input', {
                        placeholder: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
                        value: newName,
                        onChange: (e) => setNewName(e.target.value),
                        style: { width: '100%', padding: '12px', borderRadius: 10, border: '1px solid #d1d5db', fontSize: 15, outline: 'none' }
                    })
                ),
                // Phone
                React.createElement('div', null,
                    React.createElement('label', { style: { display: 'block', fontSize: 13, fontWeight: 600, color: '#374151', marginBottom: 6 } }, '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞'),
                    React.createElement('input', {
                        placeholder: '+7 (999) 000-00-00',
                        value: (() => {
                            const d = (newPhone || '').replace(/\D/g, '').slice(0, 11);
                            if (!d) return '';
                            let result = '+7';
                            const body = d.startsWith('7') ? d.slice(1) : d.startsWith('8') ? d.slice(1) : d;
                            if (body.length > 0) result += ' (' + body.slice(0, 3);
                            if (body.length >= 3) result += ') ';
                            if (body.length > 3) result += body.slice(3, 6);
                            if (body.length >= 6) result += '-';
                            if (body.length > 6) result += body.slice(6, 8);
                            if (body.length >= 8) result += '-';
                            if (body.length > 8) result += body.slice(8, 10);
                            return result;
                        })(),
                        onChange: (e) => setNewPhone((e.target.value || '').replace(/\D/g, '').slice(0, 11)),
                        style: { width: '100%', padding: '12px', borderRadius: 10, border: '1px solid #d1d5db', fontSize: 15, outline: 'none' }
                    })
                ),
                // PIN
                React.createElement('div', null,
                    React.createElement('label', { style: { display: 'block', fontSize: 13, fontWeight: 600, color: '#374151', marginBottom: 6 } }, 'PIN –∫–æ–¥ (4 —Ü–∏—Ñ—Ä—ã)'),
                    React.createElement('input', {
                        placeholder: '1234',
                        value: newPin,
                        maxLength: 4,
                        onChange: (e) => setNewPin(e.target.value),
                        onKeyDown: (e) => { if (e.key === 'Enter') handleCreate(); },
                        type: 'tel', /* numeric keyboard */
                        style: { width: '100%', padding: '12px', borderRadius: 10, border: '1px solid #d1d5db', fontSize: 15, outline: 'none', letterSpacing: 4, textAlign: 'center', fontWeight: 700 }
                    })
                ),
                // Info
                React.createElement('div', { style: { padding: '12px', background: '#f8fafc', borderRadius: 8, border: '1px solid #e2e8f0', fontSize: 13, color: '#64748b', lineHeight: 1.4 } },
                    'üîí –ö–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç –≤—Ö–æ–¥–∏—Ç—å –ø–æ —ç—Ç–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏ PIN-–∫–æ–¥—É. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.'
                ),
                // Button
                React.createElement('button', {
                    onClick: handleCreate,
                    disabled: !(newName.trim() && newPhone.trim() && newPin.trim().length >= 4),
                    style: {
                        marginTop: 8,
                        width: '100%',
                        padding: '14px',
                        borderRadius: 12,
                        background: (newName.trim() && newPhone.trim() && newPin.trim().length >= 4) ? 'linear-gradient(135deg, #2563eb, #1d4ed8)' : '#e2e8f0',
                        color: (newName.trim() && newPhone.trim() && newPin.trim().length >= 4) ? '#fff' : '#94a3b8',
                        border: 'none',
                        fontWeight: 700,
                        fontSize: 16,
                        cursor: (newName.trim() && newPhone.trim() && newPin.trim().length >= 4) ? 'pointer' : 'not-allowed',
                        boxShadow: (newName.trim() && newPhone.trim() && newPin.trim().length >= 4) ? '0 4px 6px -1px rgba(37,99,235,0.2)' : 'none'
                    }
                }, '–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞')
            )
        );

        const modalOverlay = open && ReactDOM.createPortal(
            React.createElement('div', {
                style: {
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    zIndex: 9999,
                    background: 'rgba(15, 23, 42, 0.65)',
                    backdropFilter: 'blur(4px)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    padding: 20
                },
                onClick: closeModal
            }, modalContent),
            document.body
        );

        return React.createElement(React.Fragment, null, triggerBtn, modalOverlay);
    }

    function buildGate(props) {
        const {
            clientId,
            isInitializing,
            cloudUser,
            clients,
            clientsSource,
            clientSearch,
            setClientSearch,
            setClientId,
            cloudSignIn,
            handleSignOut,
            U,
            getClientStats,
            formatLastActive,
            getAvatarColor,
            getClientInitials,
            renameClient,
            removeClient,
            addClientToCloud,
            newName,
            setNewName,
            newPhone,
            setNewPhone,
            newPin,
            setNewPin,
            curatorTab,
            setCuratorTab,
        } = props;

        const GATE_SKELETON_DELAY_MS = 280;
        const gateLoaderSinceKey = '__heysGateLoaderSince';

        const gate = !clientId
            ? (isInitializing
                ? (() => {
                    const now = Date.now();
                    if (!window[gateLoaderSinceKey]) {
                        window[gateLoaderSinceKey] = now;
                    }
                    const elapsedMs = now - window[gateLoaderSinceKey];

                    if (elapsedMs < GATE_SKELETON_DELAY_MS) {
                        if (window.__heysGateSkeletonState !== 'wait_delay') {
                            console.info('[HEYS.sceleton] ‚è±Ô∏è gate_wait_delay', {
                                elapsedMs,
                                delayMs: GATE_SKELETON_DELAY_MS,
                            });
                            window.__heysGateSkeletonState = 'wait_delay';
                        }
                        return null;
                    }

                    if (window.__heysGateSkeletonState !== 'show_loader') {
                        console.info('[HEYS.sceleton] ü¶¥ gate_show_loader', {
                            elapsedMs,
                            delayMs: GATE_SKELETON_DELAY_MS,
                        });
                        window.__heysGateSkeletonState = 'show_loader';
                    }

                    return React.createElement(HEYS.AppLoader, {
                        message: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                        subtitle: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É'
                    });
                })()
                : !cloudUser
                    ? React.createElement(
                        HEYS.LoginScreen,
                        {
                            initialMode: 'client',
                            onCuratorLogin: async ({ email, password }) => {
                                const res = await cloudSignIn(email, password, { rememberMe: true });
                                return res && res.error ? { error: res.error } : { ok: true };
                            },
                            onClientLogin: async ({ phone, pin }) => {
                                const auth = HEYS && HEYS.auth;
                                const fn = auth && auth.loginClient;
                                const res = fn ? await fn({ phone, pin }) : { ok: false, error: 'cloud_not_ready' };
                                if (res && res.ok && res.clientId) {
                                    try {
                                        if (HEYS.cloud && HEYS.cloud.switchClient) {
                                            await HEYS.cloud.switchClient(res.clientId);
                                        } else {
                                            U.lsSet('heys_client_current', res.clientId);
                                        }
                                        writeGlobalValue('heys_last_client_id', res.clientId);
                                        // üì± –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ü–≠–ü (SMS-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–≥–ª–∞—Å–∏–π)
                                        try {
                                            const phoneNorm = HEYS.auth?.normalizePhone?.(phone) || phone;
                                            writeGlobalValue('heys_client_phone', phoneNorm);
                                        } catch (_) { }
                                        setClientId(res.clientId);
                                    } catch (_) { }
                                }
                                return res;
                            },
                        }
                    )
                    : React.createElement(
                        'div',
                        {
                            className: 'modal-backdrop',
                            style: {
                                background: 'rgba(2,6,23,0.55)',
                                backdropFilter: 'blur(6px)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '10px' // minimal padding
                            }
                        },
                        React.createElement(
                            'div',
                            {
                                className: 'modal client-select-modal',
                                style: {
                                    width: 520,
                                    maxWidth: '96vw',
                                    height: '92vh', // Fixed high height to maximize space
                                    maxHeight: '1000px', // Reasonable cap on huge screens
                                    background: 'var(--card, #fff)',
                                    borderRadius: 18,
                                    boxShadow: '0 30px 80px rgba(0,0,0,0.35)',
                                    border: '1px solid rgba(148,163,184,0.25)',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    overflow: 'hidden'
                                }
                            },
                            React.createElement(
                                React.Fragment,
                                null,
                                // HEADER: –¢—ë–º–Ω—ã–π enterprise —Ö–µ–¥–µ—Ä —Å —Ç–∞–±–∞–º–∏
                                React.createElement(
                                    'div',
                                    {
                                        style: {
                                            background: 'linear-gradient(135deg, #0f172a, #1e293b)',
                                            color: '#fff',
                                            padding: '18px 20px 14px'
                                        }
                                    },
                                    // Title + status + logout
                                    React.createElement(
                                        'div',
                                        { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 } },
                                        React.createElement(
                                            'div',
                                            { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            React.createElement('div', { style: { fontSize: 24 } }, 'üë•'),
                                            React.createElement('div', null,
                                                React.createElement('div', { style: { fontSize: 16, fontWeight: 700, letterSpacing: 0.2 } }, '–ü–∞–Ω–µ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–∞'),
                                                React.createElement('div', { style: { fontSize: 11, color: 'rgba(255,255,255,0.7)', marginTop: 2 } },
                                                    clientsSource === 'loading' ? '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...'
                                                        : clientsSource === 'error' ? '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
                                                            : clientsSource === 'cache' ? `${clients.length} –∫–ª–∏–µ–Ω—Ç–æ–≤ (–∫—ç—à)`
                                                                : clients.length ? `${clients.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`
                                                                    : '–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤'
                                                )
                                            )
                                        ),
                                        React.createElement(
                                            'button',
                                            {
                                                onClick: () => {
                                                    console.info('[HEYS.gate] üö™ –í—ã—Ö–æ–¥ –∫—É—Ä–∞—Ç–æ—Ä–∞');
                                                    handleSignOut();
                                                },
                                                title: '–í—ã–π—Ç–∏',
                                                style: {
                                                    width: 32,
                                                    height: 32,
                                                    borderRadius: 8,
                                                    border: '1px solid rgba(255,255,255,0.25)',
                                                    background: 'rgba(255,255,255,0.08)',
                                                    color: '#fff',
                                                    cursor: 'pointer',
                                                    fontSize: 16,
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }
                                            },
                                            '‚Üê'
                                        )
                                    ),
                                    // Tabs –≤ —Ö–µ–¥–µ—Ä–µ
                                    React.createElement(
                                        'div',
                                        {
                                            style: {
                                                display: 'flex',
                                                gap: 6,
                                                background: 'rgba(0,0,0,0.25)',
                                                borderRadius: 10,
                                                padding: 4
                                            }
                                        },
                                        React.createElement(
                                            'button',
                                            {
                                                onClick: () => {
                                                    console.info('[HEYS.gate] üîò –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ç–∞–± –ö–ª–∏–µ–Ω—Ç—ã');
                                                    setCuratorTab('clients');
                                                },
                                                style: {
                                                    flex: 1,
                                                    padding: '8px 14px',
                                                    border: 'none',
                                                    borderRadius: 8,
                                                    fontSize: 13,
                                                    fontWeight: 600,
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s',
                                                    background: curatorTab === 'clients' ? 'rgba(255,255,255,0.95)' : 'transparent',
                                                    color: curatorTab === 'clients' ? '#0f172a' : 'rgba(255,255,255,0.8)'
                                                }
                                            },
                                            'üë• –ö–ª–∏–µ–Ω—Ç—ã'
                                        ),
                                        React.createElement(
                                            'button',
                                            {
                                                onClick: () => {
                                                    console.info('[HEYS.gate] üîò –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ç–∞–± –û—á–µ—Ä–µ–¥—å');
                                                    setCuratorTab('queue');
                                                },
                                                style: {
                                                    flex: 1,
                                                    padding: '8px 14px',
                                                    border: 'none',
                                                    borderRadius: 8,
                                                    fontSize: 13,
                                                    fontWeight: 600,
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s',
                                                    background: curatorTab === 'queue' ? 'rgba(255,255,255,0.95)' : 'transparent',
                                                    color: curatorTab === 'queue' ? '#0f172a' : 'rgba(255,255,255,0.8)'
                                                }
                                            },
                                            'üìã –û—á–µ—Ä–µ–¥—å'
                                        )
                                    ),
                                    // Warnings (cache/error) –≤ —Ö–µ–¥–µ—Ä–µ
                                    clientsSource === 'cache' && React.createElement(
                                        'div',
                                        {
                                            style: {
                                                fontSize: 11,
                                                color: '#fbbf24',
                                                marginTop: 10,
                                                padding: '6px 10px',
                                                background: 'rgba(251, 191, 36, 0.15)',
                                                borderRadius: 8,
                                                border: '1px solid rgba(251, 191, 36, 0.3)'
                                            }
                                        },
                                        '‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º...'
                                    ),
                                    clientsSource === 'error' && React.createElement(
                                        'div',
                                        {
                                            style: {
                                                fontSize: 11,
                                                color: '#f87171',
                                                marginTop: 10,
                                                padding: '6px 10px',
                                                background: 'rgba(239, 68, 68, 0.15)',
                                                borderRadius: 8,
                                                border: '1px solid rgba(239, 68, 68, 0.3)'
                                            }
                                        },
                                        '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤'
                                    )
                                ),
                                // CONTENT: –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å
                                React.createElement(
                                    'div',
                                    {
                                        style: {
                                            flex: 1,
                                            overflow: 'auto',
                                            background: 'var(--surface, #f8fafc)',
                                            padding: '18px 20px'
                                        }
                                    },
                                    // === TAB: CLIENTS ===
                                    curatorTab === 'clients' && React.createElement(React.Fragment, null,
                                        // –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ > 3)
                                        clients.length > 3 && React.createElement('div', {
                                            style: { position: 'relative', marginBottom: 16 }
                                        },
                                            React.createElement('span', {
                                                style: {
                                                    position: 'absolute',
                                                    left: 14,
                                                    top: '50%',
                                                    transform: 'translateY(-50%)',
                                                    fontSize: 16,
                                                    opacity: 0.5
                                                }
                                            }, 'üîç'),
                                            React.createElement('input', {
                                                type: 'text',
                                                placeholder: '–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞...',
                                                value: clientSearch || '',
                                                onChange: (e) => setClientSearch(e.target.value),
                                                style: {
                                                    width: '100%',
                                                    padding: '12px 12px 12px 42px',
                                                    borderRadius: 12,
                                                    border: '2px solid var(--border)',
                                                    fontSize: 15,
                                                    outline: 'none'
                                                }
                                            })
                                        ),
                                        // –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
                                        React.createElement(
                                            'div',
                                            {
                                                style: {
                                                    // maxHeight removed
                                                    minHeight: 100,
                                                    marginBottom: 16,
                                                    display: 'flex',
                                                    flexDirection: 'column',
                                                    gap: 8
                                                }
                                            },
                                            clients.length
                                                ? clients
                                                    .filter(c => !clientSearch || c.name.toLowerCase().includes(clientSearch.toLowerCase()))
                                                    .map((c, idx) => {
                                                        const stats = getClientStats(c.id);
                                                        const isLast = readGlobalValue('heys_last_client_id', '') === c.id;
                                                        const copyClientId = async (e) => {
                                                            if (e && e.stopPropagation) e.stopPropagation();
                                                            try {
                                                                if (navigator?.clipboard?.writeText) {
                                                                    await navigator.clipboard.writeText(c.id);
                                                                    HEYS.Toast?.success?.('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
                                                                    return;
                                                                }
                                                            } catch (err) {
                                                                HEYS.analytics?.trackError?.(err, { context: 'copy_client_id', clientId: c.id });
                                                            }

                                                            try {
                                                                const temp = document.createElement('textarea');
                                                                temp.value = c.id;
                                                                temp.setAttribute('readonly', '');
                                                                temp.style.position = 'absolute';
                                                                temp.style.left = '-9999px';
                                                                document.body.appendChild(temp);
                                                                temp.select();
                                                                document.execCommand('copy');
                                                                document.body.removeChild(temp);
                                                                HEYS.Toast?.success?.('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
                                                            } catch (err) {
                                                                HEYS.analytics?.trackError?.(err, { context: 'copy_client_id_fallback', clientId: c.id });
                                                                HEYS.Toast?.warning?.('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID') || alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID');
                                                            }
                                                        };
                                                        return React.createElement(
                                                            'div',
                                                            {
                                                                key: c.id,
                                                                className: 'client-card',
                                                                onMouseEnter: (e) => {
                                                                    if (!isLast) e.currentTarget.style.transform = 'translateY(-2px)';
                                                                    e.currentTarget.style.boxShadow = '0 10px 25px -10px rgba(0,0,0,0.2)';
                                                                },
                                                                onMouseLeave: (e) => {
                                                                    e.currentTarget.style.transform = 'translateY(0)';
                                                                    e.currentTarget.style.boxShadow = 'none';
                                                                },
                                                                style: {
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: 12,
                                                                    padding: '14px 16px',
                                                                    borderRadius: 14,
                                                                    background: '#fff',
                                                                    border: isLast ? '2px solid #4285f4' : '1px solid var(--border, #e5e7eb)',
                                                                    cursor: 'pointer',
                                                                    transition: 'all 0.2s',
                                                                    animation: `fadeSlideIn 0.3s ease ${idx * 0.05}s both`
                                                                },
                                                                onClick: () => {
                                                                    console.info('[HEYS.gate] üë§ –í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞', { clientId: c.id, clientName: c.name });

                                                                    // ‚úÖ FIX: –°—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ–º gate ‚Äî –Ω–µ –∂–¥—ë–º syncClient (10-15—Å–µ–∫)
                                                                    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–∫–∞–∂—É—Ç —Å–∫–µ–ª–µ—Ç–æ–Ω—ã, heysSyncCompleted –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç –ø–æ—Å–ª–µ sync
                                                                    writeGlobalValue('heys_last_client_id', c.id);
                                                                    setClientId(c.id);
                                                                    console.info('[HEYS.gate] ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω', { clientId: c.id });
                                                                    window.dispatchEvent(new CustomEvent('heys:client-changed', { detail: { clientId: c.id } }));

                                                                    // switchClient –≤ —Ñ–æ–Ω–µ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –¥–∏—Å–ø–∞—Ç—á–∏—Ç heysSyncCompleted
                                                                    if (HEYS.cloud && HEYS.cloud.switchClient) {
                                                                        HEYS.cloud.switchClient(c.id).catch(err => {
                                                                            console.error('[HEYS.gate] ‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:', err);
                                                                        });
                                                                    } else {
                                                                        U.lsSet('heys_client_current', c.id);
                                                                    }
                                                                }
                                                            },
                                                            // –ê–≤–∞—Ç–∞—Ä —Å —Ü–≤–µ—Ç–æ–º –ø–æ –±—É–∫–≤–µ
                                                            React.createElement(
                                                                'div',
                                                                {
                                                                    style: {
                                                                        width: 48,
                                                                        height: 48,
                                                                        borderRadius: '50%',
                                                                        background: getAvatarColor(c.name),
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        justifyContent: 'center',
                                                                        color: '#fff',
                                                                        fontWeight: 700,
                                                                        fontSize: 18,
                                                                        flexShrink: 0,
                                                                        boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                                                                    }
                                                                },
                                                                getClientInitials(c.name)
                                                            ),
                                                            // –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ (–ò–Ω—Ñ–æ + –ö–Ω–æ–ø–∫–∏)
                                                            React.createElement(
                                                                'div',
                                                                { style: { flex: 1, minWidth: 0, display: 'flex', flexDirection: 'column', gap: 6 } },

                                                                // 1. –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥: –ò–º—è + –¢–µ–ª–µ—Ñ–æ–Ω
                                                                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: 8 } },
                                                                    React.createElement('div', { style: { fontWeight: 700, fontSize: 16, color: 'var(--text)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, c.name),
                                                                    c.phone_normalized && React.createElement('div', { style: { fontSize: 13, color: 'var(--muted)', whiteSpace: 'nowrap', marginTop: 1, fontFamily: 'monospace' } }, c.phone_normalized)
                                                                ),

                                                                // 2. –°—Ä–µ–¥–Ω–∏–π —Ä—è–¥: –ë–µ–π–¥–∂ + –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                                                                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap', minHeight: 24 } },
                                                                    (() => {
                                                                        const badge = getSubscriptionBadge(c);
                                                                        return React.createElement('div', {
                                                                            style: {
                                                                                display: 'inline-flex', alignItems: 'center', gap: 4,
                                                                                padding: '4px 8px', borderRadius: 6,
                                                                                background: badge.bg, color: badge.color,
                                                                                fontSize: 12, fontWeight: 600,
                                                                                border: `1px solid ${badge.bg === '#fef2f2' ? '#fecaca' : badge.bg === '#eff6ff' ? '#bfdbfe' : '#bbf7d0'}`,
                                                                                animation: badge.urgent ? 'pulse 2s infinite' : 'none'
                                                                            }
                                                                        }, badge.emoji + ' ' + badge.text);
                                                                    })(),
                                                                    // Streak
                                                                    stats.streak > 0 && React.createElement('span', {
                                                                        style: { color: stats.streak >= 3 ? '#16a34a' : 'var(--muted)', fontSize: 12, fontWeight: 600, display: 'flex', alignItems: 'center', gap: 4 }
                                                                    }, 'üî• ' + stats.streak + ' –¥–Ω.'),
                                                                    // Last Active
                                                                    stats.lastActiveDate && React.createElement('span', { style: { fontSize: 12, color: 'var(--muted)' } },
                                                                        'üìÖ ' + formatLastActive(stats.lastActiveDate)
                                                                    ),
                                                                    // –ú–µ—Ç–∫–∞ "–ü–æ—Å–ª–µ–¥–Ω–∏–π"
                                                                    isLast && React.createElement('span', { style: { color: '#4285f4', fontWeight: 500, fontSize: 12 } }, '‚úì')
                                                                ),

                                                                // 3. –ù–∏–∂–Ω–∏–π —Ä—è–¥: –ö–Ω–æ–ø–∫–∏ (–≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –≤–ø—Ä–∞–≤–æ)
                                                                React.createElement(
                                                                    'div',
                                                                    {
                                                                        style: { display: 'flex', justifyContent: 'flex-end', gap: 6, marginTop: 4 },
                                                                        onClick: (e) => e.stopPropagation()
                                                                    },
                                                                    React.createElement('button', {
                                                                        className: 'btn-icon',
                                                                        title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID',
                                                                        onClick: (e) => {
                                                                            console.info('[HEYS.gate] üÜî –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ID', { clientId: c.id });
                                                                            copyClientId(e);
                                                                        },
                                                                        style: { width: 30, height: 30, borderRadius: 6, border: '1px solid var(--border)', background: '#fff', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }
                                                                    }, 'üÜî'),
                                                                    React.createElement('button', {
                                                                        className: 'btn-icon',
                                                                        title: '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å',
                                                                        onClick: () => {
                                                                            const nm = prompt('–ù–æ–≤–æ–µ –∏–º—è', c.name) || c.name;
                                                                            if (nm !== c.name) renameClient(c.id, nm);
                                                                        },
                                                                        style: { width: 30, height: 30, borderRadius: 6, border: '1px solid var(--border)', background: '#fff', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }
                                                                    }, '‚úèÔ∏è'),
                                                                    // Settings
                                                                    React.createElement(ClientSubscriptionButton, {
                                                                        client: c,
                                                                        curatorId: cloudUser?.id,
                                                                        onUpdate: () => window.dispatchEvent(new CustomEvent('heys:clients-updated'))
                                                                    }),
                                                                    React.createElement('button', {
                                                                        className: 'btn-icon',
                                                                        title: '–£–¥–∞–ª–∏—Ç—å',
                                                                        onClick: () => {
                                                                            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${c.name}"?`)) removeClient(c.id);
                                                                        },
                                                                        style: { width: 30, height: 30, borderRadius: 6, border: '1px solid #fca5a5', background: '#fef2f2', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }
                                                                    }, 'üóëÔ∏è')
                                                                )
                                                            )
                                                        );
                                                    })
                                                : React.createElement(
                                                    'div',
                                                    {
                                                        style: {
                                                            textAlign: 'center',
                                                            padding: '40px 20px',
                                                            color: 'var(--muted)'
                                                        }
                                                    },
                                                    React.createElement('div', { style: { fontSize: 48, marginBottom: 12 } }, 'üìã'),
                                                    React.createElement('div', { style: { fontSize: 15 } }, '–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤'),
                                                    React.createElement('div', { style: { fontSize: 13, marginTop: 4 } }, '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∏–∂–µ')
                                                ),
                                        ),
                                    ),

                                    // === TAB: QUEUE (–û—á–µ—Ä–µ–¥—å –Ω–∞ —Ç—Ä–∏–∞–ª) ===
                                    curatorTab === 'queue' && React.createElement(HEYS.TrialQueue.TrialQueueAdmin)
                                ),

                                // FOOTER: –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–ø—Ä–∏–±–∏—Ç–∞ –∫ –Ω–∏–∑—É)
                                curatorTab === 'clients' && React.createElement(
                                    'div',
                                    {
                                        style: {
                                            padding: '16px 20px',
                                            background: '#fff',
                                            borderTop: '1px solid var(--border, #e2e8f0)',
                                            flexShrink: 0
                                        }
                                    },
                                    React.createElement(CreateClientModal, props)
                                )
                            )
                        )
                    )
            )
            : null;

        if (!isInitializing && window[gateLoaderSinceKey]) {
            delete window[gateLoaderSinceKey];
            if (window.__heysGateSkeletonState !== 'ready') {
                console.info('[HEYS.sceleton] ‚úÖ gate_ready');
                window.__heysGateSkeletonState = 'ready';
            }
        }

        return gate;
    }

    function buildDesktopGate(props) {
        const {
            gate,
            isDesktop,
            isCurator,
            desktopAllowed,
            DesktopGateScreen,
            setClientId,
        } = props;

        return !gate && isDesktop && !isCurator && !desktopAllowed
            ? React.createElement(DesktopGateScreen, {
                onLogout: () => {
                    // –í—ã—Ö–æ–¥ –∏–∑ PIN auth
                    removeGlobalValue('heys_pin_auth_client');
                    window.HEYS?.cloud?._setPinAuthMode?.(false, null);
                    if (window.HEYS) {
                        window.HEYS.currentClientId = null;
                        if (window.HEYS.store?.flushMemory) {
                            window.HEYS.store.flushMemory();
                        }
                    }
                    setClientId(null);
                    window.location.reload();
                }
            })
            : null;
    }

    function buildConsentGate(props) {
        const {
            gate,
            desktopGate,
            cloudUser,
            clientId,
            needsConsent,
            checkingConsent,
            setNeedsConsent,
            setShowMorningCheckin,
        } = props;

        const clientPhone = typeof localStorage !== 'undefined' ? readGlobalValue('heys_client_phone', null) : null;

        return !gate && !desktopGate && !cloudUser && clientId && needsConsent && !checkingConsent && HEYS.Consents?.ConsentScreen
            ? React.createElement(HEYS.Consents.ConsentScreen, {
                clientId: clientId,
                phone: clientPhone,
                onComplete: () => {
                    console.log('[CONSENTS] ‚úÖ –°–æ–≥–ª–∞—Å–∏—è –ø—Ä–∏–Ω—è—Ç—ã');
                    setNeedsConsent(false);
                    // üîÑ v1.14c: –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è tryStartOnboardingTour
                    HEYS._consentsValid = true;
                    // üéì v1.10: –ü–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–æ–≥–ª–∞—Å–∏–π ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω—É–∂–Ω—ã–π —Ñ–ª–æ—É
                    setTimeout(() => {
                        const U = HEYS.utils || {};
                        const profile = U.lsGet ? U.lsGet('heys_profile', {}) : {};
                        const isProfileIncomplete = HEYS.ProfileSteps?.isProfileIncomplete?.(profile);
                        const hasMorningCheckin = typeof HEYS.MorningCheckin === 'function';

                        console.log('[CONSENTS] üéì –ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏–π:', {
                            isProfileIncomplete,
                            hasName: !!(profile.firstName || profile.name),
                            profileCompleted: profile.profileCompleted,
                            hasMorningCheckin
                        });

                        // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ–ø–æ–ª–Ω—ã–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        if (isProfileIncomplete) {
                            if (hasMorningCheckin) {
                                console.log('[CONSENTS] üìã –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
                                setShowMorningCheckin(true);
                            } else {
                                console.warn('[CONSENTS] ‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–ø–æ–ª–Ω—ã–π, –Ω–æ MorningCheckin –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                            }
                        } else {
                            // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º onboarding tour
                            console.log('[CONSENTS] üéì Triggering onboarding tour after consents');
                            window.HEYS?._tour?.tryStart?.();
                        }
                    }, 500);
                },
                onCancel: () => {
                    // –û—Ç–º–µ–Ω–∞ = –≤—ã—Ö–æ–¥ (–Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏–π)
                    console.log('[CONSENTS] ‚ùå –û—Ç–∫–∞–∑ –æ—Ç —Å–æ–≥–ª–∞—Å–∏–π ‚Äî –≤—ã—Ö–æ–¥');
                    removeGlobalValue('heys_pin_auth_client');
                    removeGlobalValue('heys_client_phone');
                    window.HEYS?.cloud?._setPinAuthMode?.(false, null);
                    setClientId(null);
                    window.location.reload();
                }
            })
            : null;
    }

    HEYS.AppGateFlow = {
        buildGate,
        buildDesktopGate,
        buildConsentGate,
    };
})();


/* ===== heys_app_backup_v1.js ===== */
// heys_app_backup_v1.js ‚Äî Backup helpers for App
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const CORE_BACKUP_KEYS = [
        'heys_products',
        'heys_profile',
        'heys_hr_zones',
        'heys_norms',
        'heys_dayv2_date',
        'heys_shared_products', // üÜï –ë—ç–∫–∞–ø –æ–±—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    ];

    const downloadBackupFile = (payload, activeClientId, timestamp) => {
        try {
            const blob = new Blob([JSON.stringify(payload, null, 2)], {
                type: 'application/json',
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const safeTs = (timestamp || '').replace(/[:]/g, '-');
            a.download = `heys-backup-${activeClientId || 'client'}-${safeTs || Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 0);
        } catch (error) {
            HEYS.analytics?.trackError?.(error, { context: 'downloadBackupFile' });
        }
    };

    const listDayKeysForClient = (clientId) => {
        if (!clientId) return [];
        const normalized = new Set();
        try {
            const heysPrefix = `heys_${clientId}_`;
            const legacyDayPrefix = `day_${clientId}_`;
            for (let i = 0; i < localStorage.length; i++) {
                const rawKey = localStorage.key(i);
                if (!rawKey) continue;
                if (rawKey.startsWith(`${heysPrefix}dayv2_`)) {
                    normalized.add('heys_' + rawKey.slice(heysPrefix.length));
                } else if (rawKey.startsWith(legacyDayPrefix)) {
                    normalized.add('day_' + rawKey.slice(legacyDayPrefix.length));
                }
            }
        } catch (error) {
            HEYS.analytics?.trackError?.(error, { context: 'listDayKeysForClient' });
        }
        return Array.from(normalized);
    };

    const formatBackupTime = (meta) => {
        if (!meta || !meta.timestamp) return '‚Äî';
        try {
            return new Date(meta.timestamp).toLocaleString('ru-RU', { hour12: false });
        } catch (error) {
            return meta.timestamp;
        }
    };

    const createBackupHelpers = ({
        U,
        clientId,
        setProducts,
        setSyncVer,
        setBackupMeta,
    }) => {
        const backupAllKeys = (options = {}) => {
            if (!clientId) {
                if (!options.silent) HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return { ok: false, reason: 'no-client' };
            }
            const timestamp = new Date().toISOString();
            const reason = options.reason || 'manual';
            const includeDays = options.includeDays !== false;
            const baseKeys = Array.isArray(options.keys) && options.keys.length
                ? options.keys
                : CORE_BACKUP_KEYS;
            const keysToProcess = new Set(baseKeys);
            if (includeDays) {
                listDayKeysForClient(clientId).forEach((key) => keysToProcess.add(key));
            }
            const shouldDownload = Boolean(options.triggerDownload);
            const filePayload = shouldDownload
                ? { version: 1, clientId, generatedAt: timestamp, reason, items: [] }
                : null;
            let processed = 0;
            keysToProcess.forEach((key) => {
                let data = null;
                try {
                    data = U && typeof U.lsGet === 'function' ? U.lsGet(key, null) : null;
                } catch (error) {
                    HEYS.analytics?.trackError?.(error, { context: 'backupAllKeys', key });
                    data = null;
                }
                if (data === null || data === undefined) return;
                if (key === 'heys_products' && Array.isArray(data) && data.length === 0) {
                    if (window.DEV) {
                        window.DEV.log(
                            '[BACKUP] SKIP heys_products_backup: source array is empty, keep previous snapshot',
                        );
                    }
                    return;
                }
                const snapshot = {
                    key,
                    clientId,
                    backupAt: timestamp,
                    reason,
                    data,
                    itemsCount: Array.isArray(data)
                        ? data.length
                        : data && typeof data === 'object'
                            ? Object.keys(data).length
                            : 1,
                };
                if (window.DEV && key === 'heys_products') {
                    window.DEV.log('[BACKUP] heys_products_backup items:', snapshot.itemsCount);
                }
                if (U && typeof U.lsSet === 'function') {
                    U.lsSet(`${key}_backup`, snapshot);
                } else {
                    try {
                        localStorage.setItem(`${key}_backup`, JSON.stringify(snapshot));
                    } catch (error) {
                        HEYS.analytics?.trackError?.(error, { context: 'backupAllKeys', key });
                    }
                    if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                        try {
                            window.HEYS.saveClientKey(`${key}_backup`, snapshot);
                        } catch (error) {
                            HEYS.analytics?.trackError?.(error, { context: 'backupAllKeys:saveClientKey', key });
                        }
                    }
                }
                if (filePayload) {
                    filePayload.items.push(snapshot);
                }
                processed++;
            });
            const meta = {
                timestamp,
                clientId,
                reason,
                processed,
                keys: Array.from(keysToProcess),
            };
            if (U && typeof U.lsSet === 'function') {
                U.lsSet('heys_backup_meta', meta);
            } else {
                try {
                    localStorage.setItem('heys_backup_meta', JSON.stringify(meta));
                } catch (error) { }
                if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                    try {
                        window.HEYS.saveClientKey('heys_backup_meta', meta);
                    } catch (error) {
                        HEYS.analytics?.trackError?.(error, { context: 'backupAllKeys:saveClientKey', key: 'heys_backup_meta' });
                    }
                }
            }
            setBackupMeta(meta);
            if (shouldDownload && filePayload && filePayload.items.length) {
                downloadBackupFile(filePayload, clientId, timestamp);
            }
            if (!options.silent) {
                (processed
                    ? HEYS.Toast?.success(`–ë—ç–∫–∞–ø –≥–æ—Ç–æ–≤: ${processed} —Ä–∞–∑–¥–µ–ª–æ–≤`)
                    : HEYS.Toast?.warning('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è')
                ) || alert(
                    processed
                        ? `–ë—ç–∫–∞–ø –≥–æ—Ç–æ–≤: ${processed} —Ä–∞–∑–¥–µ–ª–æ–≤`
                        : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è',
                );
            }
            if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackDataOperation('backup-save', processed);
            }
            return { ok: processed > 0, meta, processed };
        };

        const restoreFromBackup = (target = 'heys_products', options = {}) => {
            if (!clientId) {
                if (!options.silent) HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return { ok: false, reason: 'no-client' };
            }
            const keysList =
                target === 'all'
                    ? Array.from(
                        new Set([
                            ...CORE_BACKUP_KEYS,
                            ...(options.includeDays === false
                                ? []
                                : listDayKeysForClient(clientId)),
                        ]),
                    )
                    : Array.isArray(target)
                        ? target
                        : [target];
            let restored = 0;
            keysList.forEach((key) => {
                let snapshot = null;
                try {
                    snapshot = U && typeof U.lsGet === 'function' ? U.lsGet(`${key}_backup`, null) : null;
                } catch (error) {
                    HEYS.analytics?.trackError?.(error, { context: 'restoreFromBackup', key });
                    snapshot = null;
                }
                if (!snapshot || typeof snapshot !== 'object' || !('data' in snapshot)) {
                    return;
                }
                if (key === 'heys_products' && Array.isArray(snapshot.data) && snapshot.data.length === 0) {
                    if (window.DEV) {
                        window.DEV.log('[RESTORE] Empty heys_products_backup, treating as no backup');
                    }
                    return;
                }
                if (key === 'heys_products') {
                    setProducts(Array.isArray(snapshot.data) ? snapshot.data : []);
                } else if (U && typeof U.lsSet === 'function') {
                    U.lsSet(key, snapshot.data);
                } else {
                    try {
                        localStorage.setItem(key, JSON.stringify(snapshot.data));
                    } catch (error) { }
                    if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                        try {
                            window.HEYS.saveClientKey(key, snapshot.data);
                        } catch (error) {
                            HEYS.analytics?.trackError?.(error, { context: 'restoreFromBackup:saveClientKey', key });
                        }
                    }
                }
                restored++;
            });
            if (restored) {
                setSyncVer((v) => v + 1);
                if (window.HEYS && window.HEYS.analytics) {
                    window.HEYS.analytics.trackDataOperation('backup-restore', restored);
                }
            }
            if (!options.silent) {
                (restored
                    ? HEYS.Toast?.success(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤: ${restored}`)
                    : HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –±—ç–∫–∞–ø')
                ) || alert(
                    restored
                        ? `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤: ${restored}`
                        : '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –±—ç–∫–∞–ø',
                );
            }
            return { ok: restored > 0, restored };
        };

        const restoreFromBackupFile = async (options = {}) => {
            if (!clientId) {
                if (!options.silent) HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return { ok: false, reason: 'no-client' };
            }

            const openFile = HEYS.fileSystem?.openFile;
            if (typeof openFile !== 'function') {
                if (!options.silent) {
                    HEYS.Toast?.warning('–ò–º–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏') || alert('–ò–º–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏');
                }
                return { ok: false, reason: 'no-file-picker' };
            }

            const result = await openFile(['.json']);
            if (!result || !result.success || result.cancelled) {
                return { ok: false, reason: 'cancelled' };
            }

            const data = result.data;
            if (!data || typeof data !== 'object') {
                if (!options.silent) HEYS.Toast?.warning('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±—ç–∫–∞–ø–∞') || alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±—ç–∫–∞–ø–∞');
                return { ok: false, reason: 'invalid-format' };
            }

            const dates = Array.isArray(options.dates)
                ? options.dates
                : options.date
                    ? [options.date]
                    : null;
            const shouldOverwrite = options.overwrite !== false;
            const restoredDates = [];
            const skippedDates = [];

            const commitDay = (dateStr, dayData) => {
                if (!dateStr || !dayData) return;
                const key = dateStr.startsWith('heys_dayv2_')
                    ? dateStr
                    : `heys_dayv2_${dateStr}`;
                const existing = U && typeof U.lsGet === 'function' ? U.lsGet(key, null) : null;
                if (existing && !shouldOverwrite) {
                    skippedDates.push(dateStr);
                    return;
                }
                if (U && typeof U.lsSet === 'function') {
                    U.lsSet(key, dayData);
                } else {
                    try {
                        localStorage.setItem(key, JSON.stringify(dayData));
                    } catch (_) { }
                    if (window.HEYS && typeof window.HEYS.saveClientKey === 'function') {
                        try {
                            window.HEYS.saveClientKey(key, dayData);
                        } catch (_) { }
                    }
                }
                restoredDates.push(dateStr);
            };

            if (data.days && typeof data.days === 'object' && !Array.isArray(data.days)) {
                const available = Object.keys(data.days);
                const targetDates = dates || available;
                targetDates.forEach((dateStr) => {
                    const dayData = data.days[dateStr] || data.days[`heys_dayv2_${dateStr}`];
                    commitDay(dateStr, dayData);
                });
            } else if (Array.isArray(data.items)) {
                const dayItems = data.items.filter((item) => item && typeof item.key === 'string' && item.key.startsWith('heys_dayv2_'));
                const available = dayItems.map((item) => item.key.replace('heys_dayv2_', ''));
                const targetDates = dates || available;
                dayItems.forEach((item) => {
                    const dateStr = item.key.replace('heys_dayv2_', '');
                    if (targetDates && !targetDates.includes(dateStr)) return;
                    commitDay(dateStr, item.data);
                });
            } else {
                if (!options.silent) HEYS.Toast?.warning('–í –±—ç–∫–∞–ø–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π') || alert('–í –±—ç–∫–∞–ø–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π');
                return { ok: false, reason: 'no-days' };
            }

            if (options.restoreProducts && Array.isArray(data.products) && HEYS.products?.setAll) {
                const existing = HEYS.products.getAll?.() || [];
                const merged = Array.isArray(existing) ? [...existing] : [];
                let added = 0;
                data.products.forEach((product) => {
                    if (!product || !product.id) return;
                    if (merged.find((p) => p.id === product.id)) return;
                    merged.push(product);
                    added++;
                });
                if (added) {
                    HEYS.products.setAll(merged, { source: 'restore-backup-file' });
                }
            }

            if (restoredDates.length) {
                setSyncVer((v) => v + 1);
                if (options.sync !== false && HEYS.cloud?.syncClient) {
                    HEYS.cloud.syncClient(clientId).catch(() => { });
                }
            }

            if (!options.silent) {
                const msg = restoredDates.length
                    ? `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–Ω–∏: ${restoredDates.length}`
                    : '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è';
                (restoredDates.length ? HEYS.Toast?.success(msg) : HEYS.Toast?.warning(msg)) || alert(msg);
            }

            return {
                ok: restoredDates.length > 0,
                restored: restoredDates.length,
                restoredDates,
                skippedDates,
                filename: result.filename,
            };
        };

        return {
            CORE_BACKUP_KEYS,
            downloadBackupFile,
            listDayKeysForClient,
            backupAllKeys,
            restoreFromBackup,
            restoreFromBackupFile,
            formatBackupTime,
        };
    };

    HEYS.AppBackup = {
        CORE_BACKUP_KEYS,
        downloadBackupFile,
        listDayKeysForClient,
        createBackupHelpers,
        formatBackupTime,
    };
})();


/* ===== heys_app_shortcuts_v1.js ===== */
// heys_app_shortcuts_v1.js ‚Äî PWA deep-link/shortcut handling
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const openShareDB = () => new Promise((resolve, reject) => {
        const request = indexedDB.open('heys-share-db', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('shared-images')) {
                db.createObjectStore('shared-images', { keyPath: 'id' });
            }
        };
    });

    const getAllFromStore = (store) => new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
    });

    const handleShortcuts = ({ setTab, setNotification, skipTabSwitchRef }) => {
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');
        const tabParam = params.get('tab');
        const shareReceived = params.get('share-received');

        // –û—á–∏—â–∞–µ–º URL –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        const url = new URL(window.location.href);
        let needsUrlCleanup = false;

        if (action === 'add-meal') {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ clientId
            if (skipTabSwitchRef) skipTabSwitchRef.current = true;
            needsUrlCleanup = true;

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É stats (—Ç–∞–º DayTab)
            setTab('stats');

            // –ñ–¥—ë–º –ø–æ–∫–∞ DayTab —Å–º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∏ –≤—ã–∑—ã–≤–∞–µ–º addMeal
            const tryAddMeal = () => {
                if (window.HEYS?.Day?.addMeal) {
                    window.HEYS.Day.addMeal();
                    // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
                    if (navigator.vibrate) navigator.vibrate(15);
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => { if (skipTabSwitchRef) skipTabSwitchRef.current = false; }, 500);
                } else {
                    // –ü–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 100ms –µ—Å–ª–∏ DayTab –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤
                    setTimeout(tryAddMeal, 100);
                }
            };
            // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä
            setTimeout(tryAddMeal, 150);
        } else if (action === 'add-water') {
            // üÜï Shortcut –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–¥—ã
            if (skipTabSwitchRef) skipTabSwitchRef.current = true;
            needsUrlCleanup = true;
            setTab('stats');

            const tryAddWater = () => {
                if (window.HEYS?.Day?.addWater) {
                    window.HEYS.Day.addWater(250); // –î–æ–±–∞–≤–ª—è–µ–º 250–º–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (navigator.vibrate) navigator.vibrate(15);
                    setTimeout(() => { if (skipTabSwitchRef) skipTabSwitchRef.current = false; }, 500);
                } else {
                    setTimeout(tryAddWater, 100);
                }
            };
            setTimeout(tryAddWater, 150);
        } else if (shareReceived === 'true') {
            // üÜï Share Target API ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            needsUrlCleanup = true;

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º IndexedDB –∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–¥–µ–ª—ë–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const processSharedImages = async () => {
                try {
                    const db = await openShareDB();
                    const tx = db.transaction('shared-images', 'readonly');
                    const store = tx.objectStore('shared-images');
                    const images = await getAllFromStore(store);

                    if (images.length > 0) {
                        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
                        if (navigator.vibrate) navigator.vibrate([30, 50, 30]);

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                        if (typeof setNotification === 'function') {
                            setNotification({
                                message: `üì§ –ü–æ–ª—É—á–µ–Ω–æ ${images.length} —Ñ–æ—Ç–æ`,
                                type: 'success',
                                duration: 3000,
                            });
                        }

                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É –¥–Ω—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –µ–¥—ã
                        if (skipTabSwitchRef) skipTabSwitchRef.current = true;
                        setTab('stats');
                        setTimeout(() => {
                            if (skipTabSwitchRef) skipTabSwitchRef.current = false;
                            // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –µ–¥—ã —Å –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            if (window.HEYS?.Day?.addMeal) {
                                window.HEYS.Day.addMeal();
                            }
                        }, 500);

                        // –û—á–∏—â–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const clearTx = db.transaction('shared-images', 'readwrite');
                        const clearStore = clearTx.objectStore('shared-images');
                        for (const img of images) {
                            clearStore.delete(img.id);
                        }
                    }
                } catch (err) {
                    HEYS.analytics?.trackError?.(err, { context: 'share-target' });
                }
            };

            processSharedImages();
        } else if (tabParam) {
            // üÜï Shortcut –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫: ?tab=day, ?tab=stats –∏ —Ç.–¥.
            needsUrlCleanup = true;
            const validTabs = ['stats', 'ration', 'user', 'day'];
            const mappedTab = tabParam === 'day' ? 'stats' : tabParam;
            if (validTabs.includes(mappedTab)) {
                if (skipTabSwitchRef) skipTabSwitchRef.current = true;
                setTab(mappedTab);
                setTimeout(() => { if (skipTabSwitchRef) skipTabSwitchRef.current = false; }, 500);
            }
        }

        // –ß–∏—Å—Ç–∏–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if (needsUrlCleanup) {
            url.searchParams.delete('action');
            url.searchParams.delete('tab');
            url.searchParams.delete('share-received');
            window.history.replaceState({}, '', url.pathname + url.search);
        }

        return undefined;
    };

    HEYS.AppShortcuts = {
        handleShortcuts,
    };
})();


/* ===== heys_app_onboarding_v1.js ===== */
// heys_app_onboarding_v1.js ‚Äî Onboarding tour helpers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const trackOnboardingEvent = (event, data) => {
        if (HEYS.analytics?.trackEvent) {
            HEYS.analytics.trackEvent(event, data);
        }
    };

    const trackOnboardingError = (error, context) => {
        if (HEYS.analytics?.trackError) {
            HEYS.analytics.trackError(error, context);
        }
    };

    const tryParseStoredValue = (raw, fallback) => {
        if (raw === null || raw === undefined) return fallback;
        if (typeof raw === 'string') {
            let str = raw;
            if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                try { str = HEYS.store.decompress(str); } catch (_) { }
            }
            try { return JSON.parse(str); } catch (_) { return str; }
        }
        return raw;
    };

    const readStoredValue = (key, fallback = null) => {
        let value;
        if (HEYS.store?.get) {
            value = HEYS.store.get(key, null);
        } else if (HEYS.utils?.lsGet) {
            value = HEYS.utils.lsGet(key, fallback);
        } else {
            try {
                value = localStorage.getItem(key);
            } catch (e) {
                return fallback;
            }
        }

        if (value == null) return fallback;
        return tryParseStoredValue(value, fallback);
    };

    const getStoredFlag = (key, fallback = false) => {
        const scoped = readStoredValue(key, null);
        if (scoped === true || scoped === 'true') return true;
        if (scoped === false || scoped === 'false') return false;
        return fallback;
    };

    // üéì ONBOARDING TOUR ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞
    // –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–∑–≤–∞—Ç—å –∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –∏ –ø–æ—Å–ª–µ checkin-complete
    const tryStartOnboardingTour = () => {
        const hasSeenTour = getStoredFlag('heys_tour_completed', false);

        // üÜï v1.7: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const isClient = isClientAuthorized();

        // üÜï –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ —Å–µ–π—á–∞—Å MorningCheckin —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —à–∞–≥–∞–º–∏
        const profile = HEYS.store?.get?.('heys_profile', {}) || {};
        const profileIncomplete = HEYS.ProfileSteps?.isProfileIncomplete?.(profile);

        // üÜï v1.14: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–≥–ª–∞—Å–∏—è —É–∂–µ –ø—Ä–∏–Ω—è—Ç—ã (—Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ React –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        // HEYS._consentsChecked = –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, HEYS._consentsValid = —Å–æ–≥–ª–∞—Å–∏—è –ø—Ä–∏–Ω—è—Ç—ã
        const consentsNotReady = isClient && (!HEYS._consentsChecked || !HEYS._consentsValid);

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏: –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç, –µ—â–µ –Ω–µ –≤–∏–¥–µ–ª —Ç—É—Ä, –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω, —Å–æ–≥–ª–∞—Å–∏—è –ø—Ä–∏–Ω—è—Ç—ã
        if (isClient && !hasSeenTour && !profileIncomplete && !consentsNotReady && window.HEYS.OnboardingTour) {
            trackOnboardingEvent('onboarding_tour_triggered', {
                reason: 'eligible',
                consentsChecked: HEYS._consentsChecked,
                consentsValid: HEYS._consentsValid,
            });
            window.HEYS.OnboardingTour.start();
            return true;
        } else if (!isClient) {
            trackOnboardingEvent('onboarding_tour_skipped', { reason: 'not_client' });
        } else if (profileIncomplete) {
            trackOnboardingEvent('onboarding_tour_deferred', { reason: 'profile_incomplete' });
        } else if (consentsNotReady) {
            trackOnboardingEvent('onboarding_tour_deferred', {
                reason: 'consents_not_ready',
                consentsChecked: HEYS._consentsChecked,
                consentsValid: HEYS._consentsValid,
            });
        }
        return false;
    };

    // üéì v1.7: Tour ONLY for PIN-authenticated clients, NOT for curators
    // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–≤—ã–Ω–æ—Å–∏–º –≤ HEYS –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
    const isCuratorSession = () => {
        const isCuratorSessionFn = HEYS.auth?.isCuratorSession;
        if (typeof isCuratorSessionFn === 'function') return isCuratorSessionFn();
        const curatorSession = readStoredValue('heys_curator_session', null);
        const supabaseToken = readStoredValue('heys_supabase_auth_token', null);
        return !!(curatorSession || supabaseToken || HEYS.cloud?.getUser?.());
    };

    // üÜï v1.7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –ö–õ–ò–ï–ù–¢ (–Ω–µ –∫—É—Ä–∞—Ç–æ—Ä, –Ω–µ –≥–æ—Å—Ç—å)
    const isClientAuthorized = () => {
        // üîß v1.11: –ü—Ä–æ–≤–µ—Ä—è–µ–º –û–ë–ê –∫–ª—é—á–∞ ‚Äî heys_client_current –ò heys_pin_auth_client
        let clientId = null;

        // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º heys_pin_auth_client (–¥–ª—è PIN auth)
        const pinAuthClient = readStoredValue('heys_pin_auth_client', null);
        if (pinAuthClient && pinAuthClient.length > 10) {
            clientId = pinAuthClient;
            trackOnboardingEvent('onboarding_auth_pin_client', { clientId });
        }

        // 2. –ü–æ—Ç–æ–º heys_client_current (–¥–ª—è curator-managed clients)
        if (!clientId) {
            try {
                const raw = readStoredValue('heys_client_current', null);
                trackOnboardingEvent('onboarding_auth_client_current_raw', { raw });
                if (raw) clientId = raw;
                trackOnboardingEvent('onboarding_auth_client_current_parsed', { clientId });
            } catch (e) {
                // fallback ‚Äî –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –±–µ–∑ JSON
                clientId = readStoredValue('heys_client_current', null);
                trackOnboardingEvent('onboarding_auth_client_current_fallback', { clientId });
                trackOnboardingError(e, { scope: 'onboarding_auth_client_current_parse' });
            }
        }

        const isCurator = isCuratorSession();
        const result = clientId && clientId.length > 10 && !isCurator;
        trackOnboardingEvent('onboarding_auth_check', {
            clientId,
            length: clientId?.length,
            isCurator,
            result,
        });
        // clientId –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π (UUID)
        return result;
    };

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
    window.HEYS._tour = window.HEYS._tour || {};
    window.HEYS._tour.isCuratorSession = isCuratorSession;
    window.HEYS._tour.isClientAuthorized = isClientAuthorized;
    window.HEYS._tour.tryStart = tryStartOnboardingTour; // üÜï v1.9: —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–ø—É—Å–∫–∞ —á–µ–∫–∏–Ω–∞

    // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
    setTimeout(() => {
        if (!isCuratorSession()) tryStartOnboardingTour();
    }, 2000);

    // üÜï –°–ª—É—à–∞—Ç–µ–ª—å: –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è checkin (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏) ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ–∫–∞–∑–∞—Ç—å —Ç—É—Ä
    window.addEventListener('heys:checkin-complete', () => {
        if (isCuratorSession()) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤
        trackOnboardingEvent('onboarding_checkin_complete', {});
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã UI –æ–±–Ω–æ–≤–∏–ª—Å—è –ø–æ—Å–ª–µ checkin
        setTimeout(tryStartOnboardingTour, 500);
    }); // üÜï v1.9: —É–±—Ä–∞–ª–∏ once:true ‚Äî –º–æ–∂–µ–º —Å–ª—É—à–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ

    HEYS.AppOnboarding = {
        tryStartOnboardingTour,
        isCuratorSession,
        isClientAuthorized,
    };
})();


/* ===== heys_app_auth_init_v1.js ===== */
// heys_app_auth_init_v1.js ‚Äî App auth/session initialization
(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const DEV = window.DEV || {};
    const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };
    const devWarn = typeof DEV.warn === 'function' ? DEV.warn.bind(DEV) : function () { };
    const U = HEYS.utils || {};
    const trackError = (error, context) => {
        if (!HEYS?.analytics?.trackError) return;
        try {
            const err = error instanceof Error ? error : new Error(String(error || 'Auth init error'));
            HEYS.analytics.trackError(err, context);
        } catch (_) { }
    };

    const runAuthInit = ({
        U,
        cloud,
        setProducts,
        setClients,
        setClientsSource,
        setClientId,
        setSyncVer,
        setEmail,
        setCloudUser,
        setStatus,
        setIsInitializing,
    }) => {
        // üîß cloud reference for initialization
        const cloudRef = cloud || (window.HEYS && window.HEYS.cloud);

        const utils = U || { lsGet: () => null };

        const tryParseStoredValue = (raw, fallback) => {
            if (raw === null || raw === undefined) return fallback;
            if (typeof raw === 'string') {
                let str = raw;
                if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                    try { str = HEYS.store.decompress(str); } catch (_) { }
                }
                try { return JSON.parse(str); } catch (_) { return str; }
            }
            return raw;
        };

        const readStoredValue = (key, fallback) => {
            try {
                if (HEYS.store?.get) {
                    const stored = HEYS.store.get(key, null);
                    if (stored !== null && stored !== undefined) {
                        return tryParseStoredValue(stored, fallback);
                    }
                }
                if (utils.lsGet) {
                    const legacy = utils.lsGet(key, fallback);
                    if (legacy !== null && legacy !== undefined) return legacy;
                }
                const raw = localStorage.getItem(key);
                return tryParseStoredValue(raw, fallback);
            } catch {
                return fallback;
            }
        };

        const readGlobalValue = (key, fallback) => {
            try {
                if (HEYS.store?.get) {
                    const stored = HEYS.store.get(key, null);
                    if (stored !== null && stored !== undefined) {
                        return tryParseStoredValue(stored, fallback);
                    }
                }
                const raw = localStorage.getItem(key);
                if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
                if (utils.lsGet) return utils.lsGet(key, fallback);
                return fallback;
            } catch {
                return fallback;
            }
        };

        const removeGlobalValue = (key) => {
            try {
                if (HEYS.store?.set) HEYS.store.set(key, null);
            } catch (_) { }
            try { localStorage.removeItem(key); } catch (_) { }
        };

        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
        // opts.skipClientRestore: –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ heys_client_current
        // opts.skipPinAuthRestore: –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å PIN-auth –∫–ª–∏–µ–Ω—Ç–∞
        const initLocalData = (opts = {}) => {
            const skipClientRestore = opts.skipClientRestore === true;
            const skipPinAuthRestore = opts.skipPinAuthRestore === true;
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ localStorage
            const storedProducts = readStoredValue('heys_products', []);
            if (Array.isArray(storedProducts)) {
                setProducts(storedProducts);
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ localStorage (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö!)
            const storedClients = readStoredValue('heys_clients', []);
            if (Array.isArray(storedClients) && storedClients.length > 0) {
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                const realClients = storedClients.filter(c => !c.id?.startsWith('local-user'));
                if (realClients.length > 0) {
                    setClients(realClients);
                    setClientsSource('cache'); // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ –∏–∑ –∫—ç—à–∞
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
            const currentClient = readStoredValue('heys_client_current');
            const storedClientsArray = readStoredValue('heys_clients', []);

            // üîê PIN auth: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ heys_pin_auth_client (–∫–ª–∏–µ–Ω—Ç –≤–æ—à–µ–¥—à–∏–π –ø–æ PIN)
            const pinAuthClient = readGlobalValue('heys_pin_auth_client', null);

            if (!skipClientRestore && currentClient && storedClientsArray.some((c) => c.id === currentClient)) {
                // –ö—É—Ä–∞—Ç–æ—Ä –≤—ã–±—Ä–∞–ª –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
                setClientId(currentClient);
                window.HEYS = window.HEYS || {};
                window.HEYS.currentClientId = currentClient;
                console.warn('[AuthInit] restored curator currentClientId', currentClient?.slice(0, 8));
            } else if (!skipPinAuthRestore && pinAuthClient) {
                // üîê PIN auth: –∫–ª–∏–µ–Ω—Ç –≤–æ—à—ë–ª –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É+PIN ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ clientId
                setClientId(pinAuthClient);
                window.HEYS = window.HEYS || {};
                window.HEYS.currentClientId = pinAuthClient;
                console.warn('[AuthInit] restored PIN currentClientId', pinAuthClient?.slice(0, 8));

                // üõ†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è legacy –∫–ª—é—á–µ–π –±–µ–∑ clientId ‚Üí scoped (PIN flow)
                try {
                    const clientId = pinAuthClient;
                    const keysToMigrate = ['heys_profile', 'heys_products', 'heys_norms', 'heys_hr_zones', 'heys_game'];
                    keysToMigrate.forEach((baseKey) => {
                        const scopedKey = `heys_${clientId}_${baseKey.replace(/^heys_/, '')}`;
                        const hasScoped = !!localStorage.getItem(scopedKey);
                        if (hasScoped) return;
                        const rawLegacy = localStorage.getItem(baseKey);
                        if (!rawLegacy) return;
                        localStorage.setItem(scopedKey, rawLegacy);
                        if (window.HEYS?.store?.invalidate) {
                            window.HEYS.store.invalidate(baseKey);
                            window.HEYS.store.invalidate(scopedKey);
                        }
                        console.warn('[AuthInit] migrated legacy key to scoped', { baseKey, scopedKey });
                    });

                    // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –æ—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    const scopedProfileKey = `heys_${clientId}_profile`;
                    const rawProfile = localStorage.getItem(scopedProfileKey);
                    if (rawProfile) {
                        const prof = tryParseStoredValue(rawProfile, null);
                        if (prof?.profileCompleted || prof?.firstName || prof?.birthDate) {
                            localStorage.removeItem('heys_registration_in_progress');
                            console.warn('[AuthInit] registrationInProgress cleared (migrated profile)');
                        }
                    }
                } catch (_) { }
            }

            setSyncVer((v) => v + 1);
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏
        if (!navigator.onLine) {
            // –ù–µ—Ç —Å–µ—Ç–∏ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            initLocalData();
            setIsInitializing(false);
            setStatus('offline');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (!readStoredValue('heys_client_current')) {
                setTimeout(() => {
                    HEYS.Toast?.warning('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –Ω—É–∂–Ω–∞ —Å–µ—Ç—å.') || alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –Ω—É–∂–Ω–∞ —Å–µ—Ç—å.');
                }, 100);
            }
            return undefined;
        }

        // üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º expires_at ‚Äî –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –†–ï–ê–õ–¨–ù–û –∏—Å—Ç—ë–∫, –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
        // ‚úÖ FIX 2025-12-25: –ù–ï —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ –∏—Å—Ç—ë–∫!
        // ensureValidToken() –º–æ–∂–µ—Ç –ø—Ä–æ–¥–ª–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        const readStoredAuthUser = () => {
            try {
                const stored = readGlobalValue('heys_supabase_auth_token', null);
                if (!stored) return null;
                const parsed = typeof stored === 'string' ? JSON.parse(stored) : stored;

                // üö® –ü—Ä–æ–≤–µ—Ä—è–µ–º expires_at ‚Äî –Ω–æ –ù–ï —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ!
                const expiresAt = parsed?.expires_at;
                if (expiresAt) {
                    const now = Date.now();
                    const expiresAtMs = expiresAt * 1000;
                    // ‚úÖ FIX: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –†–ï–ê–õ–¨–ù–û –∏—Å—Ç—ë–∫ (–Ω–µ "—Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç")
                    // –†–∞–Ω—å—à–µ –∑–¥–µ—Å—å –±—ã–ª –±—É—Ñ–µ—Ä 5 –º–∏–Ω—É—Ç –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–ª –ª–æ–∂–Ω—ã–µ –ª–æ–≥–∞—É—Ç—ã
                    if (expiresAtMs < now) {
                        devLog('[AUTH] Token expired at', new Date(expiresAtMs).toISOString());
                        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –†–ï–ê–õ–¨–ù–û –∏—Å—Ç—ë–∫—à–∏–π Supabase —Ç–æ–∫–µ–Ω
                        removeGlobalValue('heys_supabase_auth_token');
                        // üîß v58 FIX: –ù–ï —É–¥–∞–ª—è–µ–º session_token –µ—Å–ª–∏ –µ—Å—Ç—å PIN auth —Å–µ—Å—Å–∏—è!
                        // session_token –Ω—É–∂–µ–Ω –¥–ª—è PIN auth –∫–ª–∏–µ–Ω—Ç–æ–≤ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Supabase)
                        // –£–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ PIN-—Å–µ—Å—Å–∏–∏ (–∫—É—Ä–∞—Ç–æ—Ä)
                        const hasPinAuth = readGlobalValue('heys_pin_auth_client', null);
                        if (!hasPinAuth) {
                            devLog('[AUTH] No PIN auth, clearing session_token');
                            removeGlobalValue('heys_session_token');
                        } else {
                            devLog('[AUTH] PIN auth present, keeping session_token');
                        }
                        return null;
                    }
                    // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç ‚Äî —ç—Ç–æ –û–ö, ensureValidToken() –æ–±–Ω–æ–≤–∏—Ç –µ–≥–æ
                    const minutesLeft = Math.round((expiresAtMs - now) / 60000);
                    devLog('[AUTH] Token valid, expires in', minutesLeft, 'min');
                }

                return parsed?.user || null;
            } catch (e) {
                return null;
            }
        };

        const storedUser = readStoredAuthUser();
        const savedEmail = storedUser?.email || readGlobalValue('heys_remember_email', null) || readGlobalValue('heys_saved_email', null);

        // üîê FIX v52: PIN auth –∏–º–µ–µ—Ç –ü–†–ò–û–†–ò–¢–ï–¢ –Ω–∞–¥ –∫—É—Ä–∞—Ç–æ—Ä–æ–º!
        // –ï—Å–ª–∏ –µ—Å—Ç—å PIN-—Å–µ—Å—Å–∏—è ‚Äî –ù–ï –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä–∞—Ç–æ—Ä–∞ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–µ—Ä–µ–Ω–¥–µ—Ä)
        const pinAuthClient = readGlobalValue('heys_pin_auth_client', null);
        const hasPinSession = !!pinAuthClient;

        if (storedUser && cloudRef && !hasPinSession) {
            // –ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞ (–∏ –Ω–µ—Ç PIN-—Å–µ—Å—Å–∏–∏) ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º.
            // –í–∞–∂–Ω–æ: —Å—Ç–∞–≤–∏–º cloudUser –î–û –ª—é–±—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π clientId, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è consent-flow –∫–∞–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
            if (savedEmail) setEmail(savedEmail);
            setCloudUser(storedUser);
            setStatus('online');

            // ‚úÖ FIX 2025-12-25: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ localStorage!
            // –†–∞–Ω–µ–µ skipClientRestore: true –º–µ—à–∞–ª–æ –∫—É—Ä–∞—Ç–æ—Ä—É –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Ä–µ—Ñ—Ä–µ—à–∞
            // –¢–µ–ø–µ—Ä—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º clientId, –Ω–æ –Ω–µ PIN auth (–∫—É—Ä–∞—Ç–æ—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PIN)
            initLocalData({ skipClientRestore: false, skipPinAuthRestore: true });

            // üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ YandexAPI –≤–º–µ—Å—Ç–æ Supabase
            HEYS.YandexAPI.getClients(storedUser.id)
                .then((clients) => {
                    if (!clients || clients.error) {
                        // –°–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥
                    }
                })
                .catch(() => {
                    // –°–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥
                })
                .finally(() => {
                    setIsInitializing(false);
                });
        } else if (hasPinSession && cloudRef) {
            // üîê PIN auth ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∫—É—Ä–∞—Ç–æ—Ä–æ–º (–∫–ª–∏–µ–Ω—Ç –≤–æ—à—ë–ª –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É+PIN)
            devLog('[App] üîê –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PIN-—Å–µ—Å—Å–∏–∏:', pinAuthClient.substring(0, 8) + '...');

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º RPC-—Ä–µ–∂–∏–º
            if (cloudRef.setPinAuthClient) {
                cloudRef.setPinAuthClient(pinAuthClient);
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            initLocalData();
            setStatus('online');

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
            // –°–æ–±—ã—Ç–∏–µ heysSyncCompleted –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –í–ù–£–¢–†–ò syncClientViaRPC –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            cloudRef.syncClient(pinAuthClient)
                .then(() => {
                    devLog('[App] ‚úÖ PIN-—Å–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                    // –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º heysSyncCompleted –∑–¥–µ—Å—å ‚Äî –æ–Ω–æ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ syncClient
                    // –ø–æ—Å–ª–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
                })
                .catch((err) => {
                    devWarn('[App] ‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è PIN-—Å–µ—Å—Å–∏–∏:', err);
                    trackError(err, { scope: 'AppAuthInit', action: 'restore_pin_session' });
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
                    removeGlobalValue('heys_pin_auth_client');
                    setClientId(null);
                })
                .finally(() => {
                    setIsInitializing(false);
                });
        } else {
            // –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
            initLocalData();
            setStatus('offline');
            setIsInitializing(false);
        }

        return undefined;
    };

    HEYS.AppAuthInit = {
        runAuthInit,
    };
})();


/* ===== heys_app_client_helpers_v1.js ===== */
// heys_app_client_helpers_v1.js ‚Äî Client UI helpers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const tryParseStoredValue = (raw, fallback) => {
        if (raw === null || raw === undefined) return fallback;
        if (typeof raw === 'string') {
            let str = raw;
            if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                try { str = HEYS.store.decompress(str); } catch (_) { }
            }
            try { return JSON.parse(str); } catch (_) { return str; }
        }
        return raw;
    };

    const readRawValue = (key, fallback) => {
        try {
            const raw = localStorage.getItem(key);
            if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
            return fallback;
        } catch {
            return fallback;
        }
    };

    // –¶–≤–µ—Ç–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã –ø–æ –ø–µ—Ä–≤–æ–π –±—É–∫–≤–µ –∏–º–µ–Ω–∏
    const AVATAR_COLORS = [
        'linear-gradient(135deg, #4285f4 0%, #2563eb 100%)', // –ê, –ö, –§ ‚Äî —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', // –ë, –õ, –• ‚Äî —Ä–æ–∑–æ–≤—ã–π
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', // –í, –ú, –¶ ‚Äî –≥–æ–ª—É–±–æ–π
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', // –ì, –ù, –ß ‚Äî –∑–µ–ª—ë–Ω—ã–π
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', // –î, –û, –® ‚Äî –æ—Ä–∞–Ω–∂–µ–≤—ã–π
        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', // –ï, –ü, –© ‚Äî –º—è—Ç–Ω—ã–π
        'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', // –ñ, –†, –´ ‚Äî –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π
        'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', // –ó, –°, –≠ ‚Äî –∫—Ä–µ–º–æ–≤—ã–π
        'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)', // –ò, –¢, –Æ ‚Äî —Å–≤–µ—Ç–ª–æ-—Å–∏–Ω–∏–π
        'linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)', // –ô, –£, –Ø ‚Äî –ª–∞–π–º–æ–≤—ã–π
    ];

    const getClientInitials = (name) => {
        if (!name) return '?';
        const parts = name.trim().split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[1][0]).toUpperCase();
        }
        return name.slice(0, 2).toUpperCase();
    };

    const getAvatarColor = (name) => {
        if (!name) return AVATAR_COLORS[0];
        const firstChar = name.trim()[0]?.toUpperCase() || '–ê';
        const code = firstChar.charCodeAt(0);
        let index = 0;
        if (code >= 1040 && code <= 1071) { // –†—É—Å—Å–∫–∏–π
            index = (code - 1040) % AVATAR_COLORS.length;
        } else if (code >= 65 && code <= 90) { // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
            index = (code - 65) % AVATAR_COLORS.length;
        } else {
            index = code % AVATAR_COLORS.length;
        }
        return AVATAR_COLORS[index];
    };

    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç, streak)
    const getClientStats = (cId) => {
        try {
            const today = new Date();
            let lastActiveDate = null;
            let streak = 0;

            for (let i = 0; i < 30; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const key = `heys_dayv2_${d.toISOString().slice(0, 10)}`;
                const scopedKey = `heys_${cId}_dayv2_${d.toISOString().slice(0, 10)}`;
                const legacyKey = `${cId}_${key}`;
                const data = readRawValue(scopedKey, null) ?? readRawValue(legacyKey, null);
                if (data) {
                    try {
                        const parsed = typeof data === 'string' ? JSON.parse(data) : data;
                        if (parsed && parsed.meals && parsed.meals.length > 0) {
                            if (!lastActiveDate) lastActiveDate = d;
                            if (i === streak) streak++;
                        } else if (streak > 0) break;
                    } catch (e) { }
                } else if (streak > 0) break;
            }

            return { lastActiveDate, streak };
        } catch (e) {
            return { lastActiveDate: null, streak: 0 };
        }
    };

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º "–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç"
    const formatLastActive = (date) => {
        if (!date) return '';
        const now = new Date();
        const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        if (diff === 0) return '–°–µ–≥–æ–¥–Ω—è';
        if (diff === 1) return '–í—á–µ—Ä–∞';
        if (diff < 7) return `${diff} –¥–Ω. –Ω–∞–∑–∞–¥`;
        return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
    };

    HEYS.AppClientHelpers = {
        AVATAR_COLORS,
        getClientInitials,
        getAvatarColor,
        getClientStats,
        formatLastActive,
    };
})();


/* ===== heys_app_desktop_gate_v1.js ===== */
// heys_app_desktop_gate_v1.js ‚Äî Desktop gate helpers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useDesktopGateState = ({ React }) => {
        const [isDesktop, setIsDesktop] = React.useState(() => window.innerWidth > 768);
        const [isCurator, setIsCurator] = React.useState(false);

        // –°–ª—É—à–∞–µ–º resize –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è isDesktop
        React.useEffect(() => {
            const handleResize = () => setIsDesktop(window.innerWidth > 768);
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, []);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É—Ä–∞—Ç–æ—Ä –ª–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ª–æ–≥–∏–∫–µ –≤ heys_core_v12.js)
        // ‚úÖ FIX v47: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ cloudUser (curator login —Å–æ–∑–¥–∞—ë—Ç user),
        // –∞ –Ω–µ _rpcOnlyMode (–∫–æ—Ç–æ—Ä—ã–π true –¥–ª—è –í–°–ï–• –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API)
        React.useEffect(() => {
            const checkCurator = () => {
                const isCuratorSession = window.HEYS?.auth?.isCuratorSession;
                if (typeof isCuratorSession === 'function') {
                    setIsCurator(isCuratorSession());
                    return;
                }
                const cloudUserLocal = window.HEYS?.cloud?.getUser?.();
                setIsCurator(cloudUserLocal != null);
            };
            checkCurator();
            const interval = setInterval(checkCurator, 1000);
            return () => clearInterval(interval);
        }, []);

        return { isDesktop, isCurator };
    };

    HEYS.AppDesktopGate = {
        useDesktopGateState,
    };
})();


/* ===== heys_app_morning_checkin_v1.js ===== */
// heys_app_morning_checkin_v1.js ‚Äî Morning check-in gate logic
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useMorningCheckinSync = ({ React, isInitializing, clientId }) => {
        const [showMorningCheckin, setShowMorningCheckin] = React.useState(false);

        // Ref –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ clientId (–∏–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–±–ª–µ–º—ã closure)
        const clientIdRef = React.useRef(clientId);
        React.useEffect(() => { clientIdRef.current = clientId; }, [clientId]);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏—è heysSyncCompleted (–∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)
        React.useEffect(() => {
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            const handleSyncCompleted = (e) => {
                const eventClientId = e?.detail?.clientId;

                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç clientId –≤ —Å–æ–±—ã—Ç–∏–∏
                if (!eventClientId) {
                    console.warn('[MorningCheckin] ‚ö†Ô∏è heysSyncCompleted –±–µ–∑ clientId ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                    return;
                }

                // üõ°Ô∏è FIX v1.9.4: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º Phase A (–Ω–µ–ø–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ 5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π).
                // –í —Ñ–∞–∑–µ A –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ localStorage ‚Äî
                // isProfileIncomplete –≤–µ—Ä–Ω—ë—Ç true –∏ –º–æ–¥–∞–ª–∫–∞ –º–µ–ª—å–∫–Ω—ë—Ç –Ω–∞ –¥–æ–ª—é —Å–µ–∫—É–Ω–¥—ã.
                // –ñ–¥—ë–º –ø–æ–ª–Ω–æ–≥–æ sync (–±–µ–∑ —Ñ–ª–∞–≥–∞ phaseA).
                if (e?.detail?.phaseA) {
                    console.info('[MorningCheckin] ‚ÑπÔ∏è Phase A sync ‚Äî –∂–¥—ë–º –ø–æ–ª–Ω–æ–≥–æ sync –¥–ª—è —á–µ–∫-–∏–Ω–∞');
                    return;
                }

                // –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã React state (setClientId) —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                // –∏ localStorage —Ç–æ—á–Ω–æ —Å–æ–¥–µ—Ä–∂–∞–ª –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                setTimeout(() => {
                    // üõ°Ô∏è FIX v1.9.3: clientIdRef –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º switchClient ‚Äî
                    // heysSyncCompleted —Å—Ç—Ä–µ–ª—è–µ—Ç –î–û —Ç–æ–≥–æ –∫–∞–∫ React state –æ–±–Ω–æ–≤–∏—Ç clientId.
                    // –ï—Å–ª–∏ ref –ø—É—Å—Ç–æ–π ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ–º eventClientId (–ø–µ—Ä–≤–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞).
                    // –ï—Å–ª–∏ ref –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Äî —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.
                    if (clientIdRef.current && clientIdRef.current !== eventClientId) {
                        console.warn('[MorningCheckin] ‚ö†Ô∏è clientIdRef.current !== eventClientId ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–¥—Ä—É–≥–æ–π –∫–ª–∏–µ–Ω—Ç)', {
                            ref: clientIdRef.current?.slice(0, 8),
                            event: eventClientId?.slice(0, 8),
                        });
                        return;
                    }
                    if (!clientIdRef.current) {
                        console.info('[MorningCheckin] ‚ÑπÔ∏è clientIdRef –ø—É—Å—Ç–æ–π (–ø–µ—Ä–≤—ã–π switchClient), –∏—Å–ø–æ–ª—å–∑—É–µ–º eventClientId:', eventClientId?.slice(0, 8));
                    }

                    // üîÑ –í–ê–ñ–ù–û: –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
                    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫-–∏–Ω –î–ê–ñ–ï –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!
                    const U = HEYS.utils || {};
                    const profile = U.lsGet ? U.lsGet('heys_profile', {}) : {};
                    const isProfileIncomplete = HEYS.ProfileSteps?.isProfileIncomplete?.(profile);

                    // üÜï v1.9.2 FIX: isInitializing=true —É –∫—É—Ä–∞—Ç–æ—Ä–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –æ–∂–∏–¥–∞–Ω–∏–µ getClients() ‚Äî
                    // —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ü–û–°–õ–ï heysSyncCompleted –∏ –ù–ï –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–∏–Ω.
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏: isInitializing –ò –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å,
                    // —É –∫–æ—Ç–æ—Ä–æ–≥–æ –¥–∞–Ω–Ω—ã–µ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã).
                    // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –ó–ê–ü–û–õ–ù–ï–ù ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–≤–Ω–æ –∞–∫—Ç–∏–≤–µ–Ω, isInitializing –∑–¥–µ—Å—å –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω.
                    if (isInitializing && isProfileIncomplete) {
                        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚Äî –∂–¥—ë–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
                        console.warn('[MorningCheckin] ‚ö†Ô∏è isInitializing=true & new user (no profile) ‚Äî –∂–¥—ë–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è');
                        return;
                    }
                    if (isInitializing && !isProfileIncomplete) {
                        // –£–∂–µ –∑–Ω–∞–∫–æ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî isInitializing = –ø—Ä–æ—Å—Ç–æ –æ–∂–∏–¥–∞–Ω–∏–µ getClients()
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —á–µ–∫–∏–Ω –∫–∞–∫ –æ–±—ã—á–Ω–æ
                        console.info('[MorningCheckin] ‚ÑπÔ∏è isInitializing=true –Ω–æ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º');
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ clientId –∏–∑ —Å–æ–±—ã—Ç–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –≤ localStorage
                    const lsClientId = HEYS.utils?.getCurrentClientId?.() || '';
                    if (eventClientId !== lsClientId) {
                        console.warn('[MorningCheckin] ‚ö†Ô∏è eventClientId !== lsClientId ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º', {
                            event: eventClientId?.slice(0, 8),
                            ls: lsClientId?.slice(0, 8),
                        });
                        return;
                    }

                    if (HEYS.shouldShowMorningCheckin) {
                        const shouldShow = HEYS.shouldShowMorningCheckin();
                        console.info('[MorningCheckin] üîç shouldShow —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', shouldShow, {
                            clientId: lsClientId?.slice(0, 8),
                            isInitializing,
                            suppressFlag: !!window.HEYS?.ui?.suppressMorningCheckin,
                        });

                        // üõë –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —Ñ–ª–∞–≥ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è (Onboarding Tour), –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫-–∏–Ω
                        if (window.HEYS?.ui?.suppressMorningCheckin) {
                            console.warn('[MorningCheckin] üõë suppressMorningCheckin=true ‚Äî –ø–æ–¥–∞–≤–ª—è–µ–º');
                            return;
                        }

                        // üîí –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ –∂–µ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–µ-—Ä–µ–Ω–¥–µ—Ä)
                        setShowMorningCheckin((prev) => (prev === shouldShow ? prev : shouldShow));
                    } else {
                        // PERF v7.1: module deferred after boot chain ‚Äî wait for ready event
                        console.info('[MorningCheckin] ‚ÑπÔ∏è shouldShowMorningCheckin deferred ‚Äî –æ–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–æ–¥—É–ª—è');
                        const onModuleReady = () => {
                            if (HEYS.shouldShowMorningCheckin) {
                                const shouldShow = HEYS.shouldShowMorningCheckin();
                                if (window.HEYS?.ui?.suppressMorningCheckin) return;
                                setShowMorningCheckin((prev) => (prev === shouldShow ? prev : shouldShow));
                            }
                        };
                        window.addEventListener('heys-morning-checkin-ready', onModuleReady, { once: true });
                    }
                }, 200);
            };

            window.addEventListener('heysSyncCompleted', handleSyncCompleted);
            return () => window.removeEventListener('heysSyncCompleted', handleSyncCompleted);
        }, [isInitializing]); // clientId —É–±—Ä–∞–Ω –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º ref

        return { showMorningCheckin, setShowMorningCheckin };
    };

    HEYS.AppMorningCheckin = {
        useMorningCheckinSync,
    };
})();


/* ===== heys_app_swipe_nav_v1.js ===== */
// heys_app_swipe_nav_v1.js ‚Äî Swipe navigation helpers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useSwipeNavigation = ({ React, tab, setTab }) => {
        // === SWIPE NAVIGATION ===
        // –°–≤–∞–π–ø —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É 4 –≤–∫–ª–∞–¥–∫–∞–º–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è (–ø–æ –∫—Ä—É–≥—É)
        // widgets –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ —Å–≤–∞–π–ø–∞ –∫–æ–≥–¥–∞ editMode –∞–∫—Ç–∏–≤–µ–Ω (drag & drop)
        const SWIPEABLE_TABS = ['widgets', 'stats', 'diary', 'insights', 'month'];
        const touchRef = React.useRef({ startX: 0, startY: 0, startTime: 0 });
        const MIN_SWIPE_DISTANCE = 60;
        const MAX_SWIPE_TIME = 500; // ms ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ —Å–≤–∞–π–ø–∞

        // Slide animation state
        const [slideDirection, setSlideDirection] = React.useState(null); // 'left' | 'right' | null
        const [edgeBounce, setEdgeBounce] = React.useState(null); // 'left' | 'right' | null

        const onTouchStart = React.useCallback((e) => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–∞–π–ø—ã –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö, –º–æ–¥–∞–ª–∫–∞—Ö, —Å–ª–∞–π–¥–µ—Ä–∞—Ö –∏ —Ç–æ—Å—Ç–∞—Ö
            const target = e.target;
            if (target.closest('input, textarea, select, button, .swipeable-container, table, .tab-switch-group, .advice-list-overlay, .macro-toast, .no-swipe-zone, [type="range"]')) {
                return;
            }
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å–≤–∞–π–ø–∞ –∏ drag & drop –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤
            if (window.HEYS?.Widgets?.state?.isEditMode?.() || target.closest('.widgets-grid--editing')) {
                return;
            }
            const touch = e.touches[0];
            touchRef.current = {
                startX: touch.clientX,
                startY: touch.clientY,
                startTime: Date.now()
            };
        }, []);

        const onTouchEnd = React.useCallback((e) => {
            if (!touchRef.current.startTime) return; // –ù–µ –±—ã–ª–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ touchStart

            const touch = e.changedTouches[0];
            const deltaX = touch.clientX - touchRef.current.startX;
            const deltaY = touch.clientY - touchRef.current.startY;
            const deltaTime = Date.now() - touchRef.current.startTime;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–≤–∞–π–ø–∞
            touchRef.current.startTime = 0;

            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏:
            // - —Å–≤–∞–π–ø —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π
            // - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –±–æ–ª—å—à–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ
            // - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ
            if (deltaTime > MAX_SWIPE_TIME) return;
            if (Math.abs(deltaY) > Math.abs(deltaX) * 0.7) return; // –ë–æ–ª–µ–µ –º—è–≥–∫–æ–µ —É—Å–ª–æ–≤–∏–µ
            if (Math.abs(deltaX) < MIN_SWIPE_DISTANCE) return;

            // –°–≤–∞–π–ø —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É 4 –≤–∫–ª–∞–¥–∫–∞–º–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è (–ø–æ –∫—Ä—É–≥—É)
            const currentIndex = SWIPEABLE_TABS.indexOf(tab);

            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –≤ —Å–≤–∞–π–ø–∞–±–µ–ª—å–Ω—ã—Ö ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (currentIndex === -1) return;

            if (deltaX < 0) {
                // –°–≤–∞–π–ø –≤–ª–µ–≤–æ ‚Üí —Å–ª–µ–¥—É—é—â–∞—è –≤–∫–ª–∞–¥–∫–∞ (–ø–æ –∫—Ä—É–≥—É)
                const nextIndex = (currentIndex + 1) % SWIPEABLE_TABS.length;
                const nextTab = SWIPEABLE_TABS[nextIndex];

                // –§–∞–∑–∞ 1: –≤—ã—Ö–æ–¥ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                setSlideDirection('out-left');
                if (navigator.vibrate) navigator.vibrate(10);
                setTimeout(() => {
                    // –§–∞–∑–∞ 2: —Å–º–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∏ + –≤—Ö–æ–¥ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                    setTab(nextTab);
                    setSlideDirection('in-left');
                    setTimeout(() => setSlideDirection(null), 220);
                }, 120);
            } else if (deltaX > 0) {
                // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ ‚Üí –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞ (–ø–æ –∫—Ä—É–≥—É)
                const prevIndex = (currentIndex - 1 + SWIPEABLE_TABS.length) % SWIPEABLE_TABS.length;
                const prevTab = SWIPEABLE_TABS[prevIndex];

                setSlideDirection('out-right');
                if (navigator.vibrate) navigator.vibrate(10);
                setTimeout(() => {
                    setTab(prevTab);
                    setSlideDirection('in-right');
                    setTimeout(() => setSlideDirection(null), 220);
                }, 120);
            }
        }, [tab, setTab]);

        return {
            slideDirection,
            edgeBounce,
            onTouchStart,
            onTouchEnd,
        };
    };

    HEYS.AppSwipeNav = {
        useSwipeNavigation,
    };
})();


/* ===== heys_app_runtime_effects_v1.js ===== */
// heys_app_runtime_effects_v1.js ‚Äî runtime UI effects
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useWidgetsEditMode = ({ React }) => {
        const [widgetsEditMode, setWidgetsEditMode] = React.useState(false);

        React.useEffect(() => {
            const handleEditEnter = () => setWidgetsEditMode(true);
            const handleEditExit = () => setWidgetsEditMode(false);

            const unsubEnter = window.HEYS?.Widgets?.on?.('editmode:enter', handleEditEnter);
            const unsubExit = window.HEYS?.Widgets?.on?.('editmode:exit', handleEditExit);

            setWidgetsEditMode(window.HEYS?.Widgets?.state?.isEditMode?.() || false);

            return () => {
                unsubEnter?.();
                unsubExit?.();
            };
        }, []);

        return { widgetsEditMode, setWidgetsEditMode };
    };

    const useConsentCheck = ({ React, clientId, cloudUser, setNeedsConsent, setCheckingConsent }) => {
        React.useEffect(() => {
            if (!clientId) {
                setNeedsConsent(false);
                setCheckingConsent(false);
                HEYS._consentsChecked = false;
                HEYS._consentsValid = false;
                return;
            }
            if (cloudUser) {
                setNeedsConsent(false);
                setCheckingConsent(false);
                HEYS._consentsChecked = true;
                HEYS._consentsValid = true;
                return;
            }
            if (HEYS.Consents?.api?.checkRequired) {
                setCheckingConsent(true);
                HEYS.Consents.api.checkRequired(clientId).then((result) => {
                    setNeedsConsent(!result.valid);
                    setCheckingConsent(false);
                    HEYS._consentsChecked = true;
                    HEYS._consentsValid = result.valid;
                    if (!result.valid) {
                        console.log('[CONSENTS] Client needs to accept consents:', result.missing);
                    } else {
                        console.log('[CONSENTS] ‚úÖ All consents are valid');
                    }
                }).catch((err) => {
                    console.error('[CONSENTS] Error checking consents:', err);
                    setCheckingConsent(false);
                    setNeedsConsent(false);
                    HEYS._consentsChecked = true;
                    HEYS._consentsValid = true;
                });
            }
        }, [clientId, cloudUser, setNeedsConsent, setCheckingConsent]);
    };

    const useBadgeSync = ({ React }) => {
        React.useEffect(() => {
            const initialUpdate = setTimeout(() => {
                window.HEYS?.badge?.updateFromStreak();
            }, 2000);

            const handleDataChange = () => {
                setTimeout(() => {
                    window.HEYS?.badge?.updateFromStreak();
                }, 500);
            };

            window.addEventListener('heysSyncCompleted', handleDataChange);
            window.addEventListener('heys:data-saved', handleDataChange);

            return () => {
                clearTimeout(initialUpdate);
                window.removeEventListener('heysSyncCompleted', handleDataChange);
                window.removeEventListener('heys:data-saved', handleDataChange);
            };
        }, []);
    };

    const useCalendarSync = ({ React, setCalendarVer }) => {
        const calendarDebounceRef = React.useRef(null);
        // üõ°Ô∏è v64 FIX: –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ calendarVer increment timestamp
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–π increment –æ—Ç –¥–≤—É—Ö heysSyncCompleted —Å–æ–±—ã—Ç–∏–π
        const lastIncrementRef = React.useRef(0);

        React.useEffect(() => {
            const handleCycleUpdate = (e) => {
                const source = e.detail?.source;
                const field = e.detail?.field;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–∏: cycleDay changes –ò–õ–ò cloud-sync/force-sync/merge
                const isCycleUpdate = field === 'cycleDay' || (source && source.startsWith('cycle'));
                const isSyncUpdate = source === 'cloud-sync' || source === 'force-sync' || source === 'merge';
                if (!isCycleUpdate && !isSyncUpdate) return;

                if (calendarDebounceRef.current) {
                    clearTimeout(calendarDebounceRef.current);
                }
                calendarDebounceRef.current = setTimeout(() => {
                    setCalendarVer((v) => v + 1);
                    calendarDebounceRef.current = null;
                }, isSyncUpdate ? 800 : 500); // Sync ‚Äî –¥–æ–ª—å—à–µ –∂–¥—ë–º (–º–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏–π –ø–æ–¥—Ä—è–¥)
            };

            // –¢–∞–∫–∂–µ —Å–ª—É—à–∞–µ–º heysSyncCompleted –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ sync
            const handleSyncComplete = (e) => {
                const now = Date.now();
                const sinceLastIncrement = now - lastIncrementRef.current;
                window.console.info('[HEYS.calendar] üîî heysSyncCompleted –ø–æ–ª—É—á–µ–Ω, clientId=', e?.detail?.clientId?.slice(0, 8), 'sinceLastIncrement=' + sinceLastIncrement + 'ms');

                // üõ°Ô∏è v64 FIX: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä—É—é—â–µ–µ—Å—è —Å–æ–±—ã—Ç–∏–µ (< 2 —Å–µ–∫ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ increment)
                // –î–≤–∞ sync path (syncClientViaRPC + bootstrapClientSync) –º–æ–≥—É—Ç –æ–±–∞ —Å—Ç—Ä–µ–ª—è—Ç—å heysSyncCompleted
                if (sinceLastIncrement < 2000) {
                    window.console.info('[HEYS.calendar] ‚è≠Ô∏è SKIP duplicate heysSyncCompleted (debounce=' + sinceLastIncrement + 'ms < 2000ms)');
                    return;
                }

                if (calendarDebounceRef.current) {
                    clearTimeout(calendarDebounceRef.current);
                }
                calendarDebounceRef.current = setTimeout(() => {
                    lastIncrementRef.current = Date.now();
                    setCalendarVer((v) => {
                        window.console.info('[HEYS.calendar] üìà calendarVer', v, '‚Üí', v + 1);
                        return v + 1;
                    });
                    calendarDebounceRef.current = null;
                }, 500); // üõ°Ô∏è v64: –£–≤–µ–ª–∏—á–µ–Ω —Å 300 –¥–æ 500ms –¥–ª—è –ª—É—á—à–µ–≥–æ debounce
            };

            window.addEventListener('heys:day-updated', handleCycleUpdate);
            window.addEventListener('heysSyncCompleted', handleSyncComplete);
            return () => {
                window.removeEventListener('heys:day-updated', handleCycleUpdate);
                window.removeEventListener('heysSyncCompleted', handleSyncComplete);
                if (calendarDebounceRef.current) {
                    clearTimeout(calendarDebounceRef.current);
                }
            };
        }, [setCalendarVer]);

        return { calendarDebounceRef };
    };

    HEYS.AppRuntimeEffects = {
        useWidgetsEditMode,
        useConsentCheck,
        useBadgeSync,
        useCalendarSync,
    };
})();


/* ===== heys_app_sync_effects_v1.js ===== */
// heys_app_sync_effects_v1.js ‚Äî client sync & persistence effects
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useSyncEffects = ({
        React,
        U,
        cloud,
        clientId,
        products,
        setProducts,
        setSyncVer,
        setBackupMeta,
    }) => {
        const clientSyncDoneRef = React.useRef(false);
        const initialSyncDoneRef = React.useRef(false);
        const saveTimerRef = React.useRef(null);

        React.useEffect(() => {
            if (products.length === 0) {
                try {
                    // üîÑ v4.8.8: FIX ‚Äî —á–∏—Ç–∞–µ–º –∏–∑ Store API –≤–º–µ—Å—Ç–æ utils.lsGet
                    // –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è products ‚Äî HEYS.products.getAll()
                    const stored = window.HEYS?.products?.getAll?.() || [];
                    if (Array.isArray(stored) && stored.length) setProducts(stored);
                } catch (e) { }
            }
        }, [products.length, setProducts]);

        React.useEffect(() => {
            if (clientId) {
                U.lsSet('heys_client_current', clientId);
                window.HEYS = window.HEYS || {};
                window.HEYS.currentClientId = clientId;
                window.dispatchEvent(new CustomEvent('heys:client-changed', { detail: { clientId } }));
                // üîá v4.7.1: –õ–æ–≥ –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç–∫–ª—é—á—ë–Ω

                if (cloud && typeof cloud.syncClient === 'function') {
                    const productsBeforeSync = products.length > 0 ? products : window.HEYS.utils.lsGet('heys_products', []);

                    cloud.syncClient(clientId)
                        .then(() => {
                            // üîÑ v4.8.8: FIX ‚Äî —á–∏—Ç–∞–µ–º –∏–∑ Store API, –Ω–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ localStorage
                            // Store.set –ø–∏—à–µ—Ç –≤ scoped –∫–ª—é—á, utils.lsGet —á–∏—Ç–∞–µ—Ç –∏–∑ –¥—Ä—É–≥–æ–≥–æ ‚Üí –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ: sync ‚Üí setAll ‚Üí Store.set ‚Üí products.getAll() (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
                            const loadedProducts = Array.isArray(window.HEYS?.products?.getAll?.())
                                ? window.HEYS.products.getAll()
                                : [];

                            // ü™¶ FIX v4.8.9: –ø—Ä–∏–º–µ–Ω—è–µ–º tombstone filter –ø–æ—Å–ª–µ cloud sync.
                            // –ë–µ–∑ —ç—Ç–æ–≥–æ mergeProductsData –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ deleted products (merge = union remote+local),
                            // –∏ setProducts —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ –≤ React state ‚Üí resurrection –ø—Ä–∏ page refresh.
                            const _tombstones = window.HEYS?.store?.get?.('heys_deleted_ids') || [];
                            const filteredProducts = (() => {
                                if (!Array.isArray(_tombstones) || _tombstones.length === 0) return loadedProducts;
                                const _deletedIds = new Set(_tombstones.map(t => t.id).filter(Boolean));
                                const _deletedNames = new Set(_tombstones.map(t => (t.name || '').trim().toLowerCase()).filter(Boolean));
                                const _result = loadedProducts.filter(p =>
                                    !_deletedIds.has(p.id) &&
                                    !_deletedNames.has((p.name || '').trim().toLowerCase())
                                );
                                if (_result.length < loadedProducts.length) {
                                    console.info(`[HEYS.sync] ü™¶ tombstone filter: —É–±—Ä–∞–Ω–æ ${loadedProducts.length - _result.length} resurrection product(s) –ø–æ—Å–ª–µ sync`);
                                }
                                return _result;
                            })();

                            // üîç v4.8.7: DEBUG ‚Äî —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∏–∑ Store –ø–æ—Å–ª–µ sync
                            const loadedIron = filteredProducts.filter(p => p?.iron && +p.iron > 0).length;
                            console.info(`[HEYS.sync] üîç After sync: loadedProducts.length=${loadedProducts.length} (${filteredProducts.length} after tombstone filter), withIron=${loadedIron}`);

                            if (filteredProducts.length === 0 && Array.isArray(productsBeforeSync) && productsBeforeSync.length > 0) {
                                // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
                                // üõ°Ô∏è v4.7.2: –ü–µ—Ä–µ–¥ fallback –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ productsBeforeSync –Ω–µ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–∏—Ö
                                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –∫–æ–≥–¥–∞ –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤–æ –≤—Ä–µ–º—è sync
                                const currentProducts = window.HEYS?.products?.getAll?.() || [];
                                const currentCount = currentProducts.length;
                                const fallbackCount = productsBeforeSync.length;

                                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –±–æ–ª—å—à–µ ‚Äî –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –Ω–∞ —Å—Ç–∞—Ä—ã–µ
                                if (currentCount > fallbackCount) {
                                    // üîá –ú–æ–ª—á–∏–º ‚Äî –∑–∞—â–∏—Ç–∞ –≤ setAll –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç
                                    return;
                                }

                                setProducts(prev => {
                                    if (Array.isArray(prev) && prev.length === productsBeforeSync.length) return prev;
                                    return productsBeforeSync;
                                });
                                if (window.HEYS?.products?.setAll) {
                                    window.HEYS.products.setAll(productsBeforeSync, {
                                        source: 'cloud-sync-fallback',
                                        skipNotify: true,
                                        skipCloud: true
                                    });
                                } else {
                                    window.HEYS.utils.lsSet('heys_products', productsBeforeSync);
                                }
                            } else {
                                // üîÑ v4.8.7: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –¥–ª–∏–Ω—ã
                                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏ (iron) –≤–º–µ—Å—Ç–æ –æ–±—â–µ–π –¥–ª–∏–Ω—ã
                                setProducts(prev => {
                                    const prevIron = Array.isArray(prev) ? prev.filter(p => p?.iron && +p.iron > 0).length : 0;
                                    const loadedIron = filteredProducts.filter(p => p?.iron && +p.iron > 0).length;

                                    // üîç v4.8.7: DEBUG ‚Äî –∫–∞–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å
                                    console.info(`[HEYS.sync] üîç setProducts callback: prev.length=${prev.length}, prevIron=${prevIron}, loadedIron=${loadedIron}`);

                                    // –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ ‚Äî –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
                                    // –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–∑–Ω–æ–µ ‚Äî –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º (42 Fe ‚Üí 290 Fe)
                                    if (Array.isArray(prev) && prev.length === filteredProducts.length && prevIron === loadedIron) {
                                        console.info(`[HEYS.sync] üö´ React state NOT updated (same quality)`);
                                        return prev;
                                    }

                                    console.info(`[HEYS.sync] üîÑ React state updated: ${prev.length}‚Üí${filteredProducts.length} products, ${prevIron}‚Üí${loadedIron} with iron`);
                                    return filteredProducts;
                                });
                            }
                            if (!clientSyncDoneRef.current) {
                                clientSyncDoneRef.current = true;
                                return;
                            }
                            setSyncVer((v) => v + 1);
                        })
                        .catch((err) => {
                            console.warn('[HEYS] Sync failed, using local cache:', err?.message || err);
                            if (Array.isArray(productsBeforeSync) && productsBeforeSync.length > 0) {
                                setProducts(prev => {
                                    if (Array.isArray(prev) && prev.length === productsBeforeSync.length) return prev;
                                    return productsBeforeSync;
                                });
                            }
                            if (!clientSyncDoneRef.current) {
                                clientSyncDoneRef.current = true;
                                return;
                            }
                            setSyncVer((v) => v + 1);
                        });
                } else {
                    if (!clientSyncDoneRef.current) {
                        clientSyncDoneRef.current = true;
                        return;
                    }
                    setSyncVer((v) => v + 1);
                }
            }
        }, [clientId]);

        React.useEffect(() => {
            if (!clientId) {
                setBackupMeta(null);
                return;
            }
            try {
                const meta = U && typeof U.lsGet === 'function' ? U.lsGet('heys_backup_meta', null) : null;
                setBackupMeta(meta || null);
            } catch (error) {
            }
        }, [clientId, setBackupMeta, U]);

        React.useEffect(() => {
            const markInitialSyncDone = () => {
                // üÜï PERF v9.2: React-—Å–ª—É—à–∞—Ç–µ–ª—å –ø–æ–π–º–∞–ª heysSyncCompleted
                window.__heysPerfMark && window.__heysPerfMark('markInitialSyncDone: React listener fired');
                if (window.HEYS) window.HEYS.syncCompletedAt = Date.now();
                setTimeout(() => {
                    initialSyncDoneRef.current = true;
                    if (window.HEYS) window.HEYS.initialSyncDone = true;
                }, 1000);
            };
            window.addEventListener('heysSyncCompleted', markInitialSyncDone);
            return () => {
                window.removeEventListener('heysSyncCompleted', markInitialSyncDone);
            };
        }, []);

        React.useEffect(() => {
            // v5.0.2: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚Äî heys_storage_supabase –¥–∏—Å–ø–∞—Ç—á–∏—Ç –æ–±–∞ —Å–æ–±—ã—Ç–∏—è
            // (heys:products-updated + heysProductsUpdated) –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
            // –ë–µ–∑ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ setSyncVer –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã ‚Üí 2 React-—Ä–µ–Ω–¥–µ—Ä–∞ –Ω–∞ –∫–∞–∂–¥—ã–π sync.
            let _lastProductsVerTs = 0;

            const handleProductsUpdate = (event) => {
                const detail = event?.detail || {};
                const incoming = detail.products;
                // üîÑ v4.8.8: –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî Store API
                const latest = Array.isArray(incoming)
                    ? incoming
                    : (window.HEYS?.products?.getAll?.() || []);

                // ü™¶ v4.8.10: Tombstone filter ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç resurrection —á–µ—Ä–µ–∑ event dispatch
                const _ts = window.HEYS?.store?.get?.('heys_deleted_ids') || [];
                let filtered = latest;
                if (Array.isArray(_ts) && _ts.length > 0) {
                    const _dIds = new Set(_ts.map(t => t.id).filter(Boolean));
                    const _dNames = new Set(_ts.map(t => (t.name || '').trim().toLowerCase()).filter(Boolean));
                    filtered = latest.filter(p =>
                        !_dIds.has(p.id) &&
                        !_dNames.has((p.name || '').trim().toLowerCase())
                    );
                }

                setProducts(filtered);
                if (!initialSyncDoneRef.current) {
                    return;
                }

                // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 300–º—Å
                const now = Date.now();
                if (now - _lastProductsVerTs < 300) return;
                _lastProductsVerTs = now;
                setSyncVer((v) => v + 1);
            };

            window.addEventListener('heys:products-updated', handleProductsUpdate);
            window.addEventListener('heysProductsUpdated', handleProductsUpdate);
            return () => {
                window.removeEventListener('heys:products-updated', handleProductsUpdate);
                window.removeEventListener('heysProductsUpdated', handleProductsUpdate);
            };
        }, [setProducts, setSyncVer]);

        React.useEffect(() => {
            const IGNORED_SOURCES = [
                'cloud', 'merge', 'step-modal', 'fetchDays',
                'deficit-step', 'household-step', 'training-step', 'steps-step',
                'measurements-step', 'cold-exposure-step',
                'cycle-auto', 'cycle-clear', 'cycle-save', 'cycle-step'
            ];

            const handleDayUpdate = (e) => {
                const source = e.detail?.source;
                const field = e.detail?.field;

                if (field === 'cycleDay') return;
                if (source && IGNORED_SOURCES.includes(source)) {
                    return;
                }
                if (!initialSyncDoneRef.current) {
                    return;
                }

                setSyncVer((v) => v + 1);
            };

            window.addEventListener('heys:day-updated', handleDayUpdate);
            return () => window.removeEventListener('heys:day-updated', handleDayUpdate);
        }, [setSyncVer]);

        React.useEffect(() => {
            if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
            // üöÄ PERF v2.5: Don't re-upload products that were just downloaded from cloud
            // After sync, React state updates ‚Üí this effect fires ‚Üí 405KB upload back to cloud
            // Grace period check: skip if sync completed within last 10 seconds
            const cloud = window.HEYS?.cloud;
            if (cloud?._syncCompletedAt && (Date.now() - cloud._syncCompletedAt) < 10000) {
                return;
            }
            saveTimerRef.current = setTimeout(() => {
                try {
                    window.HEYS.saveClientKey('heys_products', products);
                } catch (e) {
                    console.error('Error saving products:', e);
                }
            }, 300);
            return () => {
                if (saveTimerRef.current) {
                    clearTimeout(saveTimerRef.current);
                    saveTimerRef.current = null;
                }
            };
        }, [products]);
    };

    HEYS.AppSyncEffects = {
        useSyncEffects,
    };
})();


/* ===== heys_app_tab_state_v1.js ===== */
// heys_app_tab_state_v1.js ‚Äî tab state helpers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const DEV = window.DEV || {};
    const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

    const useTabState = ({ React }) => {
        const getDefaultTabFromProfile = () => {
            const U = window.HEYS?.utils;
            const profile = U?.lsGet?.('heys_profile', {}) || {};
            const validTabs = ['widgets', 'stats', 'diary', 'insights', 'month'];
            const savedTab = validTabs.includes(profile.defaultTab) ? profile.defaultTab : 'diary';
            return savedTab;
        };

        const [defaultTab, setDefaultTabState] = React.useState('diary');
        const [tab, setTab] = React.useState('diary');
        const [initialTabLoaded, setInitialTabLoaded] = React.useState(false);

        React.useEffect(() => {
            if (!window.HEYS) window.HEYS = {};
            if (!window.HEYS.ui) window.HEYS.ui = {};
            window.HEYS.ui.switchTab = (newTab) => {
                devLog(`[App] üîÑ Switching tab to: ${newTab}`);
                setTab(newTab);
            };
        }, [setTab]);

        React.useEffect(() => {
            if (initialTabLoaded) return;

            const tryLoadDefaultTab = () => {
                const U = window.HEYS?.utils;
                if (!U?.lsGet) return false;

                const savedTab = getDefaultTabFromProfile();
                devLog(`[App] üè† Loading default tab from profile: ${savedTab}`);
                setDefaultTabState(savedTab);
                setTab(savedTab);
                setInitialTabLoaded(true);
                return true;
            };

            if (tryLoadDefaultTab()) return;

            const handleReady = () => tryLoadDefaultTab();
            window.addEventListener('heysReady', handleReady);

            const interval = setInterval(() => {
                if (tryLoadDefaultTab()) clearInterval(interval);
            }, 100);

            const timeout = setTimeout(() => {
                clearInterval(interval);
                if (!initialTabLoaded) {
                    tryLoadDefaultTab();
                    setInitialTabLoaded(true);
                }
            }, 2000);

            return () => {
                window.removeEventListener('heysReady', handleReady);
                clearInterval(interval);
                clearTimeout(timeout);
            };
        }, [initialTabLoaded]);

        const setDefaultTab = React.useCallback((newDefaultTab) => {
            const validTabs = ['widgets', 'stats', 'diary', 'insights', 'month'];
            if (!validTabs.includes(newDefaultTab)) return;

            const U = window.HEYS?.utils;
            const profile = U?.lsGet?.('heys_profile', {}) || {};
            const updatedProfile = { ...profile, defaultTab: newDefaultTab };
            U?.lsSet?.('heys_profile', updatedProfile);
            setDefaultTabState(newDefaultTab);

            devLog(`[App] üè† Default tab changed to: ${newDefaultTab}`);
        }, []);

        React.useEffect(() => {
            window.HEYS = window.HEYS || {};
            window.HEYS.App = window.HEYS.App || {};
            window.HEYS.App.setTab = setTab;
            window.HEYS.App.getTab = () => tab;
            window.HEYS.App.getDefaultTab = () => defaultTab;
            window.HEYS.App.setDefaultTab = setDefaultTab;
            return () => {
                if (window.HEYS?.App) {
                    delete window.HEYS.App.setTab;
                    delete window.HEYS.App.getTab;
                    delete window.HEYS.App.getDefaultTab;
                    delete window.HEYS.App.setDefaultTab;
                }
            };
        }, [tab, setTab, defaultTab, setDefaultTab]);

        return {
            tab,
            setTab,
            defaultTab,
            setDefaultTab,
        };
    };

    HEYS.AppTabState = {
        useTabState,
    };
})();


/* ===== heys_app_client_management_v1.js ===== */
// heys_app_client_management_v1.js ‚Äî client list management
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useClientListSync = ({
        React,
        cloudUser,
        clientsSource,
        fetchClientsFromCloud,
        setClients,
        setClientId,
        clientId,
    }) => {
        React.useEffect(() => {
            if (cloudUser && cloudUser.id && (clientsSource === 'cache' || clientsSource === '')) {
                fetchClientsFromCloud(cloudUser.id).then((result) => {
                    if (result.data && result.data.length > 0) {
                        setClients(result.data);

                        const savedClientId = localStorage.getItem('heys_client_current');
                        if (savedClientId && result.data.some(c => c.id === savedClientId)) {
                            // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
                            setClientId(savedClientId);
                            window.HEYS = window.HEYS || {};
                            window.HEYS.currentClientId = savedClientId;
                        } else if (!clientId && result.data.length === 1) {
                            // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
                            setClientId(result.data[0].id);
                            window.HEYS = window.HEYS || {};
                            window.HEYS.currentClientId = result.data[0].id;
                        }
                    }
                }).catch((e) => {
                    console.error('[HEYS] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –æ–±–ª–∞–∫–∞:', e);
                });
            }
        }, [cloudUser, clientsSource, fetchClientsFromCloud, setClients, setClientId, clientId]);
    };

    const useClientsUpdatedListener = ({ React, setClients }) => {
        React.useEffect(() => {
            const handleClientsUpdated = (e) => {
                if (e.detail && e.detail.clients) {
                    setClients(e.detail.clients);
                }
            };
            window.addEventListener('heys:clients-updated', handleClientsUpdated);
            return () => window.removeEventListener('heys:clients-updated', handleClientsUpdated);
        }, [setClients]);
    };

    const createTestClients = async ({ cloudUser, fetchClientsFromCloud, setClients }) => {
        if (!cloudUser || !cloudUser.id) return;
        const userId = cloudUser.id;
        const testClients = [{ name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤' }, { name: '–ê–Ω–Ω–∞ –°–∏–¥–æ—Ä–æ–≤–∞' }];

        for (const testClient of testClients) {
            try {
                await HEYS.YandexAPI.createClient(testClient.name, userId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:', error);
            }
        }

        const result = await fetchClientsFromCloud(userId);
        setClients(result.data);
    };

    HEYS.AppClientManagement = {
        useClientListSync,
        useClientsUpdatedListener,
        createTestClients,
    };
})();


/* ===== heys_app_backup_actions_v1.js ===== */
// heys_app_backup_actions_v1.js ‚Äî backup action handlers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};

    const useBackupActions = ({
        React,
        clientId,
        backupBusy,
        setBackupBusy,
        backupAllKeys,
        restoreFromBackup,
    }) => {
        const handleManualBackup = React.useCallback(async () => {
            if (!clientId) {
                HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            if (backupBusy) return;
            setBackupBusy(true);
            try {
                await backupAllKeys({ reason: 'manual' });
            } finally {
                setBackupBusy(false);
            }
        }, [clientId, backupBusy, setBackupBusy, backupAllKeys]);

        const handleExportBackup = React.useCallback(async () => {
            if (!clientId) {
                HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            if (backupBusy) return;
            setBackupBusy(true);
            try {
                const result = await backupAllKeys({
                    reason: 'manual-export',
                    triggerDownload: true,
                    includeDays: true,
                    silent: true,
                });
                (result && result.processed
                    ? HEYS.Toast?.success(`–§–∞–π–ª –±—ç–∫–∞–ø–∞ —Å–∫–∞—á–∞–Ω (${result.processed} —Ä–∞–∑–¥–µ–ª–æ–≤)`)
                    : HEYS.Toast?.warning('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞')
                ) || alert(
                    result && result.processed
                        ? `–§–∞–π–ª –±—ç–∫–∞–ø–∞ —Å–∫–∞—á–∞–Ω (${result.processed} —Ä–∞–∑–¥–µ–ª–æ–≤)`
                        : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞',
                );
            } finally {
                setBackupBusy(false);
            }
        }, [clientId, backupBusy, setBackupBusy, backupAllKeys]);

        const handleRestoreProducts = React.useCallback(() => {
            if (!clientId) {
                HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞?')) return;
            const result = restoreFromBackup('heys_products', { silent: true });
            (result && result.ok
                ? HEYS.Toast?.success('–ü—Ä–æ–¥—É–∫—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.')
                : HEYS.Toast?.warning('–ù–µ –Ω–∞–π–¥–µ–Ω –±—ç–∫–∞–ø –ø—Ä–æ–¥—É–∫—Ç–æ–≤.')
            ) || alert(result && result.ok ? '–ü—Ä–æ–¥—É–∫—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.' : '–ù–µ –Ω–∞–π–¥–µ–Ω –±—ç–∫–∞–ø –ø—Ä–æ–¥—É–∫—Ç–æ–≤.');
        }, [clientId, restoreFromBackup]);

        const handleRestoreAll = React.useCallback(() => {
            if (!clientId) {
                HEYS.Toast?.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞?')) return;
            const result = restoreFromBackup('all', { silent: true });
            (result && result.ok
                ? HEYS.Toast?.success(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤: ${result.restored}`)
                : HEYS.Toast?.warning('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –±—ç–∫–∞–ø–æ–≤.')
            ) || alert(
                result && result.ok
                    ? `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤: ${result.restored}`
                    : '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –±—ç–∫–∞–ø–æ–≤.',
            );
        }, [clientId, restoreFromBackup]);

        return {
            handleManualBackup,
            handleExportBackup,
            handleRestoreProducts,
            handleRestoreAll,
        };
    };

    HEYS.AppBackupActions = {
        useBackupActions,
    };
})();


/* ===== heys_app_backup_export_v1.js ===== */
// heys_app_backup_export_v1.js ‚Äî export backup helper extracted from heys_app_v12.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppBackupExport = HEYS.AppBackupExport || {};

    HEYS.AppBackupExport.init = function () {
        // === –≠–∫—Å–ø–æ—Ä—Ç –±—ç–∫–∞–ø–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ JSON ===
        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ DayTab –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø"
        HEYS.exportFullBackup = async function () {
            let clientId = localStorage.getItem('heys_client_current');
            if (!clientId) {
                HEYS.Toast?.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞') || alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞');
                return { ok: false, error: 'no_client' };
            }

            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å (legacy bug)
            if (clientId.startsWith('"') && clientId.endsWith('"')) {
                clientId = clientId.slice(1, -1);
            }

            console.log('[BACKUP] Client ID:', clientId);

            // Debug: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏ localStorage –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const allKeys = Object.keys(localStorage);
            const clientKeys = allKeys.filter(k => k.includes(clientId) || k.includes('heys_'));
            console.log('[BACKUP] Found localStorage keys:', clientKeys);

            try {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
                const backup = {
                    exportedAt: new Date().toISOString(),
                    clientId: clientId,
                    appVersion: window.APP_VERSION || 'unknown',
                    products: [],
                    sharedProducts: [],
                    profile: null,
                    norms: null,
                    hrZones: null,
                    days: {},
                    water: null,
                    scheduledAdvices: null,
                };

                // –ü—Ä–æ–¥—É–∫—Ç—ã ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∏–∑ React state, –ø–æ—Ç–æ–º localStorage
                // React state –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ —Ç.–∫. localStorage –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥—ë–Ω
                if (HEYS.products && typeof HEYS.products.getAll === 'function') {
                    const stateProducts = HEYS.products.getAll();
                    if (Array.isArray(stateProducts) && stateProducts.length > 0) {
                        backup.products = stateProducts;
                        console.log('[BACKUP] Products from HEYS.products.getAll():', stateProducts.length);
                    }
                }

                // Fallback –Ω–∞ HEYS.store.get (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ)
                if (!backup.products || backup.products.length === 0) {
                    if (HEYS.store && typeof HEYS.store.get === 'function') {
                        backup.products = HEYS.store.get('heys_products', []);
                        console.log('[BACKUP] Products from HEYS.store.get:', backup.products.length);
                    }
                }

                // –ü—Ä–æ—Ñ–∏–ª—å ‚Äî —á–µ—Ä–µ–∑ HEYS.store.get (—É—á–∏—Ç—ã–≤–∞–µ—Ç memory cache –∏ scoped keys)
                if (HEYS.store && typeof HEYS.store.get === 'function') {
                    backup.profile = HEYS.store.get('heys_profile', null);
                    console.log('[BACKUP] Profile from HEYS.store.get:', backup.profile ? 'found' : 'NOT FOUND');
                }
                // Fallback –Ω–∞ –ø—Ä—è–º–æ–π localStorage
                if (!backup.profile) {
                    let profileKey = `heys_${clientId}_profile`;
                    let profileRaw = localStorage.getItem(profileKey);
                    if (!profileRaw) {
                        profileKey = 'heys_profile';
                        profileRaw = localStorage.getItem(profileKey);
                    }
                    console.log('[BACKUP] Profile key:', profileKey, '‚Üí', profileRaw ? 'found' : 'NOT FOUND');
                    if (profileRaw) {
                        try { backup.profile = JSON.parse(profileRaw); } catch (e) { }
                    }
                }

                // –ù–æ—Ä–º—ã ‚Äî —á–µ—Ä–µ–∑ HEYS.store.get
                if (HEYS.store && typeof HEYS.store.get === 'function') {
                    backup.norms = HEYS.store.get('heys_norms', null);
                    console.log('[BACKUP] Norms from HEYS.store.get:', backup.norms ? 'found' : 'NOT FOUND');
                }
                if (!backup.norms) {
                    let normsKey = `heys_${clientId}_norms`;
                    let normsRaw = localStorage.getItem(normsKey);
                    if (!normsRaw) {
                        normsKey = 'heys_norms';
                        normsRaw = localStorage.getItem(normsKey);
                    }
                    console.log('[BACKUP] Norms key:', normsKey, '‚Üí', normsRaw ? 'found' : 'NOT FOUND');
                    if (normsRaw) {
                        try { backup.norms = JSON.parse(normsRaw); } catch (e) { }
                    }
                }

                // –ü—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã ‚Äî —á–µ—Ä–µ–∑ HEYS.store.get
                if (HEYS.store && typeof HEYS.store.get === 'function') {
                    backup.hrZones = HEYS.store.get('heys_hr_zones', null);
                    console.log('[BACKUP] HR Zones from HEYS.store.get:', backup.hrZones ? 'found' : 'NOT FOUND');
                }
                if (!backup.hrZones) {
                    let hrKey = `heys_${clientId}_hr_zones`;
                    let hrRaw = localStorage.getItem(hrKey);
                    if (!hrRaw) {
                        hrKey = 'heys_hr_zones';
                        hrRaw = localStorage.getItem(hrKey);
                    }
                    console.log('[BACKUP] HR Zones key:', hrKey, '‚Üí', hrRaw ? 'found' : 'NOT FOUND');
                    if (hrRaw) {
                        try { backup.hrZones = JSON.parse(hrRaw); } catch (e) { }
                    }
                }

                // –í–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store.get –¥–ª—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏)
                if (HEYS.store && typeof HEYS.store.get === 'function') {
                    backup.water = HEYS.store.get('heys_water_history', null);
                    console.log('[BACKUP] Water from HEYS.store.get:', backup.water ? 'found' : 'NOT FOUND');
                }

                // –°–æ–≤–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store.get –¥–ª—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏)
                if (HEYS.store && typeof HEYS.store.get === 'function') {
                    backup.scheduledAdvices = HEYS.store.get('heys_scheduled_advices', []);
                }

                // Shared products ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (–∫—ç—à –∏–∑ PostgreSQL), –Ω–µ –≤ localStorage!
                backup.sharedProducts = HEYS.cloud?.getCachedSharedProducts?.() || [];
                console.log('[BACKUP] Shared products (from cache):', backup.sharedProducts?.length || 0);

                // Fallback: –µ—Å–ª–∏ –∫—ç—à –µ—â—ë –Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –∑–∞–±–∏—Ä–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ API
                if ((!backup.sharedProducts || backup.sharedProducts.length === 0) && HEYS.YandexAPI?.rest) {
                    HEYS.Toast?.info('–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã‚Ä¶');
                    try {
                        const { data, error } = await HEYS.YandexAPI.rest('shared_products');
                        if (error) {
                            console.log('[BACKUP] Shared products API error:', error);
                            HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π —ç–∫—Å–ø–æ—Ä—Ç –µ—â—ë —Ä–∞–∑.');
                        } else if (Array.isArray(data) && data.length > 0) {
                            backup.sharedProducts = data;
                            console.log('[BACKUP] Shared products (from API):', data.length);
                            HEYS.Toast?.success?.('–û–±—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º‚Ä¶');
                        } else {
                            HEYS.Toast?.warning('–û–±—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤—ã. –ü–æ–≤—Ç–æ—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.');
                        }
                    } catch (e) {
                        console.log('[BACKUP] Shared products API failed:', e?.message || e);
                        HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π —ç–∫—Å–ø–æ—Ä—Ç –µ—â—ë —Ä–∞–∑.');
                    }
                }

                // –î–Ω–∏ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π) - –∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store.get –¥–ª—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
                const today = new Date();
                console.log('[BACKUP] Starting days collection for 90 days from:', today.toISOString().slice(0, 10));
                console.log('[BACKUP] HEYS.store available:', !!HEYS.store, 'HEYS.store.get:', typeof HEYS.store?.get);
                console.log('[BACKUP] currentClientId:', HEYS.currentClientId);

                // Debug: –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –µ—Å—Ç—å –≤ localStorage —Å dayv2
                const dayv2Keys = Object.keys(localStorage).filter(k => k.includes('dayv2_'));
                console.log('[BACKUP] Found dayv2 keys in localStorage:', dayv2Keys.slice(0, 10));

                let daysFound = 0;
                let daysChecked = 0;
                for (let i = 0; i < 90; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().slice(0, 10);
                    daysChecked++;

                    if (HEYS.store && typeof HEYS.store.get === 'function') {
                        const dayData = HEYS.store.get('heys_dayv2_' + dateStr, null);
                        if (dayData) {
                            backup.days[dateStr] = dayData;
                            daysFound++;
                            if (daysFound <= 3) {
                                console.log(`[BACKUP] ‚úÖ Found day ${dateStr}:`, typeof dayData, dayData?.meals?.length || 0, 'meals');
                            }
                        }
                    }
                }
                console.log(`[BACKUP] Days scan complete: checked ${daysChecked}, found ${daysFound}`);

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const daysCount = Object.keys(backup.days).length;
                const productsCount = backup.products?.length || 0;

                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const fileName = `heys-backup-${clientId.slice(0, 8)}-${new Date().toISOString().slice(0, 10)}.json`;
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                const sharedCount = backup.sharedProducts?.length || 0;
                console.log(`[BACKUP] ‚úÖ Exported: ${productsCount} products, ${sharedCount} shared, ${daysCount} days`);
                return { ok: true, products: productsCount, sharedProducts: sharedCount, days: daysCount, fileName };
            } catch (err) {
                console.error('[BACKUP] Export failed:', err);
                HEYS.Toast?.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + err.message) || alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + err.message);
                return { ok: false, error: err.message };
            }
        };
    };

    HEYS.AppBackupExport.init();
})();


/* ===== heys_app_update_checks_v1.js ===== */
// heys_app_update_checks_v1.js ‚Äî update helpers extracted from heys_app_v12.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppUpdateChecks = HEYS.AppUpdateChecks || {};

    function getPwaHelpers() {
        const pwa = HEYS.PWA || {};
        return {
            showUpdateModal: pwa.showUpdateModal || window.showUpdateModal,
            updateModalStage: pwa.updateModalStage || window.updateModalStage,
            hideUpdateModal: pwa.hideUpdateModal || window.hideUpdateModal,
            checkServerVersion: pwa.checkServerVersion || window.checkServerVersion,
            isNewerVersion: pwa.isNewerVersion || null,
            version: pwa.version || HEYS.version || window.APP_VERSION || 'unknown',
        };
    }

    HEYS.AppUpdateChecks.init = function () {
        const helpers = getPwaHelpers();

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
        HEYS.checkForUpdates = () => {
            if (helpers.showUpdateModal) {
                helpers.showUpdateModal('checking');
            }
            setTimeout(async () => {
                if (!helpers.checkServerVersion) return;
                const hasUpdate = await helpers.checkServerVersion(false);
                if (!hasUpdate && helpers.updateModalStage && helpers.hideUpdateModal) {
                    helpers.updateModalStage('ready');
                    const title = document.getElementById('heys-update-title');
                    const subtitle = document.getElementById('heys-update-subtitle');
                    const icon = document.getElementById('heys-update-icon');
                    if (title) title.textContent = '–í—Å—ë –∞–∫—Ç—É–∞–ª—å–Ω–æ!';
                    if (subtitle) subtitle.textContent = '–£ –≤–∞—Å –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è';
                    if (icon) icon.textContent = '‚úÖ';
                    setTimeout(helpers.hideUpdateModal, 1500);
                }
            }, 800);
        };

        // –¢–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ (–±–µ–∑ UI) ‚Äî –¥–ª—è pull-to-refresh
        HEYS.checkVersionSilent = async () => {
            try {
                if (helpers.checkServerVersion) {
                    await helpers.checkServerVersion(true);
                }
            } catch (e) {
                // Silent fail
            }
        };

        // === –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–¥–ª—è pull-to-refresh) ===
        // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise<{ hasUpdate: boolean, version?: string }>
        HEYS.forceCheckAndUpdate = async function () {
            try {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞ (–±–µ–∑ UI)
                const cacheBust = Date.now();
                const response = await fetch(`/build-meta.json?_cb=${cacheBust}`, {
                    cache: 'no-store',
                    headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' },
                });

                if (!response.ok) {
                    console.log('[PWA Update] build-meta.json not available');
                    return { hasUpdate: false };
                }

                const data = await response.json();
                const isNewer = helpers.isNewerVersion;
                if (!isNewer) {
                    console.log('[PWA Update] isNewerVersion not available');
                    return { hasUpdate: false };
                }

                const currentVersion = helpers.version;

                // 2. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏
                if (!data.version || !isNewer(data.version, currentVersion)) {
                    console.log('[PWA Update] No update available | server:', data.version, '| local:', currentVersion);
                    return { hasUpdate: false };
                }

                console.log('[PWA Update] üÜï Update available!', currentVersion, '‚Üí', data.version);

                // ‚úÖ –ú–∞—Ä–∫–µ—Ä: –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è logout + —á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏
                try {
                    sessionStorage.setItem('heys_update_requires_logout', 'true');
                } catch (e) { }

                // 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫—ç—à–µ–π —á–µ—Ä–µ–∑ SW
                if (navigator.serviceWorker?.controller) {
                    console.log('[PWA Update] üóëÔ∏è Clearing all caches...');
                    navigator.serviceWorker.controller.postMessage('clearAllCaches');

                    // –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–µ–π (–º–∞–∫—Å 2 —Å–µ–∫)
                    await new Promise((resolve) => {
                        const timeout = setTimeout(resolve, 2000);
                        const handler = (event) => {
                            if (event.data?.type === 'CACHES_CLEARED') {
                                clearTimeout(timeout);
                                navigator.serviceWorker.removeEventListener('message', handler);
                                resolve();
                            }
                        };
                        navigator.serviceWorker.addEventListener('message', handler);
                    });

                    // 4. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º SW
                    console.log('[PWA Update] üîÑ Updating Service Worker...');
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.update();
                    }

                    // 5. skipWaiting –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ SW (—á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)
                    HEYS.PlatformAPIs?.triggerSkipWaiting?.({
                        fallbackMs: 5000,
                        showModal: false,
                        source: 'HEYS.forceCheckAndUpdate',
                    });
                } else {
                    // –ù–µ—Ç SW ‚Äî –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è reload
                    sessionStorage.setItem('heys_pending_update', 'true');
                    sessionStorage.setItem('heys_force_sync_after_update', 'true');
                }

                // ‚ö†Ô∏è VERSION_KEY —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ triggerSkipWaiting –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ reload
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é –∫–æ–≥–¥–∞ –≤–µ—Ä—Å–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è, –Ω–æ reload –Ω–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª

                return { hasUpdate: true, version: data.version };
            } catch (e) {
                console.warn('[PWA Update] Check failed:', e.message);
                return { hasUpdate: false, error: e.message };
            }
        };
    };

    HEYS.AppUpdateChecks.init();
})();


/* ===== heys_app_update_notifications_v1.js ===== */
// heys_app_update_notifications_v1.js ‚Äî update toast & notifications
(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    const U = HEYS.utils || {};

    const writeGlobalValue = (key, value) => {
        try {
            if (HEYS.store?.set) {
                HEYS.store.set(key, value);
                return;
            }
            if (U.lsSet) {
                U.lsSet(key, value);
                return;
            }
            const serialized = typeof value === 'string' ? value : JSON.stringify(value);
            localStorage.setItem(key, serialized);
        } catch { }
    };

    const useUpdateNotifications = ({ React }) => {
        const [showUpdateToast, setShowUpdateToast] = React.useState(false);
        const [notification, setNotification] = React.useState(null);

        React.useEffect(() => {
            if (!notification) return;
            const duration = Number(notification.duration) || 3000;
            const timer = setTimeout(() => setNotification(null), duration);
            return () => clearTimeout(timer);
        }, [notification]);

        React.useEffect(() => {
            window.HEYS = window.HEYS || {};
            window.HEYS.showUpdateToast = () => {
                setShowUpdateToast(true);
            };
            return () => {
                if (window.HEYS) delete window.HEYS.showUpdateToast;
            };
        }, []);

        const handleUpdate = React.useCallback(() => {
            HEYS.PlatformAPIs?.triggerSkipWaiting?.({
                fallbackMs: 5000,
                showModal: false,
                source: 'UpdateToast.handleUpdate'
            });
        }, []);

        const dismissUpdateToast = React.useCallback(() => {
            setShowUpdateToast(false);
            writeGlobalValue('heys_update_dismissed', Date.now().toString());
        }, []);

        return {
            showUpdateToast,
            notification,
            setNotification,
            handleUpdate,
            dismissUpdateToast,
        };
    };

    HEYS.AppUpdateNotifications = {
        useUpdateNotifications,
    };
})();


/* ===== heys_app_cloud_init_v1.js ===== */
// heys_app_cloud_init_v1.js ‚Äî cloud init helpers extracted from heys_app_v12.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppCloudInit = HEYS.AppCloudInit || {};

    HEYS.AppCloudInit.initCloud = function ({ fetcher } = {}) {
        if (!HEYS.cloud || typeof HEYS.cloud.init !== 'function') {
            return { initialized: false, reason: 'no-cloud' };
        }

        const doFetch = fetcher || fetch;

        // üî• Warm-up ping ‚Äî –ø—Ä–æ–≥—Ä–µ–≤–∞–µ–º Yandex Cloud Functions
        doFetch('https://api.heyslab.ru/health', { method: 'GET' }).catch(() => { });

        // üÜï v2025-12-22: –ù–∞ production –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û Yandex Cloud API
        // Supabase SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ cloud.signIn/signOut,
        // –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–∞—Ñ–∏–∫ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ HEYS.YandexAPI
        const supabaseUrl = 'https://api.heyslab.ru';

        HEYS.cloud.init({
            url: supabaseUrl,
            anonKey:
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcW9sY3ppcWN1cGxxZmdybXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTE1NDUsImV4cCI6MjA3MDgyNzU0NX0.Nzd8--PyGMJvIHqFoCQKNUOwpxnrAZuslQHtAjcE1Ds',
            // localhost fallback –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º Yandex API –≤–µ–∑–¥–µ
            localhostProxyUrl: undefined,
        });

        return { initialized: true, url: supabaseUrl };
    };
})();


/* ===== heys_app_client_state_manager_v1.js ===== */
// heys_app_client_state_manager_v1.js ‚Äî client state manager extracted from heys_app_v12.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppClientStateManager = HEYS.AppClientStateManager || {};

    HEYS.AppClientStateManager.useClientStateManager = function ({
        React,
        clientId,
        setTab,
        defaultTab,
        setProducts,
        setSyncVer,
    }) {
        const { useEffect, useRef } = React;
        const skipTabSwitchRef = useRef(false);

        // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥–æ–º–∞—à–Ω—é—é –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞
        // (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ PWA shortcut action)
        useEffect(() => {
            if (clientId && !skipTabSwitchRef.current) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –¥–æ–º–∞—à–Ω—é—é –≤–∫–ª–∞–¥–∫—É –≤–º–µ—Å—Ç–æ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–π 'stats'
                setTab(defaultTab);
            }
        }, [clientId, defaultTab, setTab]);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ products –ø—Ä–∏ —Å–º–µ–Ω–µ clientId (–±–µ–∑ bootstrap ‚Äî –µ–≥–æ –¥–µ–ª–∞—é—Ç wrapper'—ã)
        useEffect(() => {
            if (clientId) {
                const loadedProducts = Array.isArray(window.HEYS?.utils?.lsGet?.('heys_products', []))
                    ? window.HEYS.utils.lsGet('heys_products', [])
                    : [];
                setProducts(loadedProducts);
                setSyncVer((v) => v + 1);
            }
        }, [clientId, setProducts, setSyncVer]);

        return { skipTabSwitchRef };
    };
})();


/* ===== heys_app_date_state_v1.js ===== */
// heys_app_date_state_v1.js ‚Äî date selection + calendar active days state

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppDateState = HEYS.AppDateState || {};

    const getTodayISO = () => {
        const d = new Date();
        const hour = d.getHours();
        if (hour < 3) {
            d.setDate(d.getDate() - 1);
        }
        return d.getFullYear()
            + '-' + String(d.getMonth() + 1).padStart(2, '0')
            + '-' + String(d.getDate()).padStart(2, '0');
    };

    HEYS.AppDateState.useDateSelectionState = function ({ React }) {
        const { useState } = React;
        const [selectedDate, setSelectedDate] = useState(getTodayISO());
        return { todayISO: getTodayISO, selectedDate, setSelectedDate };
    };

    HEYS.AppDateState.useDatePickerActiveDays = function ({
        React,
        selectedDate,
        clientId,
        products,
        isInitializing,
        calendarVer,
        U,
    }) {
        const { useMemo } = React;
        return useMemo(() => {
            const readStoredValue = (key, fallback) => {
                try {
                    let value;
                    if (window.HEYS?.store?.get) {
                        value = window.HEYS.store.get(key, fallback);
                    } else if (U?.lsGet) {
                        value = U.lsGet(key, fallback);
                    } else {
                        value = localStorage.getItem(key);
                    }

                    if (value == null) return fallback;

                    if (typeof value === 'string') {
                        if (value.startsWith('¬§Z¬§') && window.HEYS?.store?.decompress) {
                            try {
                                value = window.HEYS.store.decompress(value.slice(3));
                            } catch (e) { }
                        }
                        try {
                            return JSON.parse(value);
                        } catch (e) {
                            return value;
                        }
                    }

                    return value;
                } catch (e) {
                    return fallback;
                }
            };

            // Fallback chain –¥–ª—è products: props ‚Üí HEYS.products.getAll() ‚Üí localStorage
            const effectiveProducts = (products && products.length > 0) ? products
                : (window.HEYS.products?.getAll?.() || [])
                    .length > 0 ? window.HEYS.products.getAll()
                    : (readStoredValue('heys_products', []) || []);

            // –ù–µ –≤—ã—á–∏—Å–ª—è–µ–º –ø–æ–∫–∞ –∏–¥—ë—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ –Ω–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤
            if (isInitializing || effectiveProducts.length === 0) {
                return new Map();
            }

            const getActiveDaysForMonth = window.HEYS.dayUtils && window.HEYS.dayUtils.getActiveDaysForMonth;
            if (!getActiveDaysForMonth || !clientId) {
                return new Map();
            }

            // –ü–æ–ª—É—á–∞–µ–º profile –∏–∑ localStorage
            const profile = readStoredValue('heys_profile', {});

            // –ü–∞—Ä—Å–∏–º selectedDate –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—è—Ü–∞
            const parts = selectedDate.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed

            try {
                // –ü–µ—Ä–µ–¥–∞—ë–º effectiveProducts (—Å fallback) –≤ —Ñ—É–Ω–∫—Ü–∏—é
                const result = getActiveDaysForMonth(year, month, profile, effectiveProducts);
                window.console.info('[HEYS.calendar] üóìÔ∏è useDatePickerActiveDays –ø–µ—Ä–µ—Å—á—ë—Ç: calendarVer=' + calendarVer + ' month=' + (month + 1) + ' activeDays=' + (result?.size || 0) + ' products=' + effectiveProducts.length);

                // üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å localStorage –Ω–∞–ø—Ä—è–º—É—é
                try {
                    const cid = clientId || window.HEYS?.currentClientId || '';
                    const cidShort = cid ? cid.slice(0, 8) : 'none';
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const missingDays = [];
                    let lsDayCount = 0;
                    let lsNullCount = 0;

                    for (let d = 1; d <= daysInMonth; d++) {
                        const dd = String(d).padStart(2, '0');
                        const mm = String(month + 1).padStart(2, '0');
                        const dateStr = year + '-' + mm + '-' + dd;
                        const lsKey = cid ? ('heys_' + cid + '_dayv2_' + dateStr) : ('heys_dayv2_' + dateStr);
                        const lsVal = localStorage.getItem(lsKey);

                        if (lsVal) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ "null"/"undefined" –∑–Ω–∞—á–µ–Ω–∏—è (–±–∞–≥ cloud sync)
                            if (lsVal === 'null' || lsVal === 'undefined') {
                                lsNullCount++;
                                if (!result.has(dateStr)) {
                                    missingDays.push(dateStr + '(null_value)');
                                }
                                continue;
                            }

                            lsDayCount++;
                            if (!result.has(dateStr)) {
                                // –î–µ–Ω—å –µ—Å—Ç—å –≤ localStorage –Ω–æ –ù–ï–¢ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ!
                                let reason = '?';
                                try {
                                    let valStr = lsVal;
                                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∂–∞—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                    if (valStr.startsWith('¬§Z¬§')) {
                                        const decomp = window.HEYS?.store?.decompress;
                                        if (decomp) {
                                            const parsed = decomp(valStr.slice(3));
                                            const mealsCount = (parsed?.meals || []).length;
                                            const itemsCount = (parsed?.meals || []).reduce((s, m) => s + ((m && m.items) || []).length, 0);
                                            reason = 'compressed meals=' + mealsCount + ' items=' + itemsCount;
                                        } else {
                                            reason = 'compressed_no_decompress';
                                        }
                                    } else {
                                        const parsed = JSON.parse(valStr);
                                        if (parsed == null) {
                                            reason = 'parsed_to_null';
                                        } else {
                                            const mealsCount = (parsed?.meals || []).length;
                                            const itemsCount = (parsed?.meals || []).reduce((s, m) => s + ((m && m.items) || []).length, 0);
                                            reason = 'meals=' + mealsCount + ' items=' + itemsCount;
                                        }
                                    }
                                } catch (pe) {
                                    reason = 'parse_error: ' + (pe.message || '').slice(0, 50);
                                }
                                missingDays.push(dateStr + '(' + reason + ')');
                            }
                        }
                    }

                    // –í—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É–µ–º localStorage count –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                    window.console.info('[HEYS.calendar] üìä localStorage dayv2: ' + lsDayCount + ' keys'
                        + (lsNullCount > 0 ? ', nulls=' + lsNullCount : '')
                        + ', activeDays=' + (result?.size || 0)
                        + ', calendarVer=' + calendarVer);

                    if (missingDays.length > 0) {
                        window.console.warn('[HEYS.calendar] ‚ö†Ô∏è –ü–†–û–ü–£–©–ï–ù–ù–´–ï –î–ù–ò: –í localStorage=' + lsDayCount
                            + ' –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ=' + result.size + ' –ø—Ä–æ–ø—É—â–µ–Ω–æ=' + missingDays.length
                            + ' productsCount=' + effectiveProducts.length
                            + ' clientId=' + cidShort
                            + '\n  ‚Üí ' + missingDays.join(', '));
                    }
                } catch (_diagErr) {
                    window.console.warn('[HEYS.calendar] diag error:', _diagErr?.message);
                }

                return result;
            } catch (e) {
                // –¢–∏—Ö–∏–π fallback ‚Äî activeDays –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã
                window.console.info('[HEYS.calendar] ‚ùå useDatePickerActiveDays –æ—à–∏–±–∫–∞:', e?.message);
                return new Map();
            }
        }, [selectedDate, clientId, products, isInitializing, calendarVer, U]);
    };
})();


/* ===== heys_app_derived_state_v1.js ===== */
// heys_app_derived_state_v1.js ‚Äî derived UI state helpers

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppDerivedState = HEYS.AppDerivedState || {};

    const readStoredValue = (key, fallback = null) => {
        let value;
        if (HEYS.store?.get) {
            value = HEYS.store.get(key, fallback);
        } else if (HEYS.utils?.lsGet) {
            value = HEYS.utils.lsGet(key, fallback);
        } else {
            try {
                value = localStorage.getItem(key);
            } catch (e) {
                return fallback;
            }
        }

        if (value == null) return fallback;

        if (typeof value === 'string') {
            if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                try {
                    value = HEYS.store.decompress(value.slice(3));
                } catch (e) { }
            }
            try {
                return JSON.parse(value);
            } catch (e) {
                return value;
            }
        }

        return value;
    };

    HEYS.AppDerivedState.useAppDerivedState = function ({
        React,
        pendingDetails,
        clients,
        clientId,
        needsConsent,
        checkingConsent,
        showMorningCheckin,
        U,
        cloud,
    }) {
        const { useMemo } = React;
        const [clientChangeTick, setClientChangeTick] = React.useState(0);

        React.useEffect(() => {
            const handleClientChange = () => setClientChangeTick((v) => v + 1);
            window.addEventListener('heys:client-changed', handleClientChange);
            return () => window.removeEventListener('heys:client-changed', handleClientChange);
        }, []);

        const pendingText = useMemo(() => {
            if (!pendingDetails) return '';
            const parts = [];
            if (pendingDetails.days > 0) parts.push(`${pendingDetails.days} –¥–Ω.`);
            if (pendingDetails.products > 0) parts.push(`${pendingDetails.products} –ø—Ä–æ–¥.`);
            if (pendingDetails.profile > 0) parts.push('–ø—Ä–æ—Ñ–∏–ª—å');
            if (pendingDetails.other > 0) parts.push(`${pendingDetails.other} –¥—Ä.`);
            return parts.length > 0 ? parts.join(', ') : '';
        }, [pendingDetails]);

        const cachedProfile = useMemo(() => {
            return readStoredValue('heys_profile', {});
        }, [U, clientId, clientChangeTick]);

        const isRpcMode = cloud?.isPinAuthClient?.() || false;

        const currentClientName = useMemo(() => {
            if (isRpcMode) {
                // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞: name (–æ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞) –∏ firstName+lastName (–æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
                const fullName = cachedProfile.name
                    || [cachedProfile.firstName, cachedProfile.lastName].filter(Boolean).join(' ');
                if (fullName) return fullName;

                // üí° –î–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –æ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞
                try {
                    const pendingName = readStoredValue('heys_pending_client_name', null);
                    if (pendingName) return pendingName;
                } catch (e) { }

                return '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å';
            }
            return Array.isArray(clients)
                ? (clients.find((c) => c.id === clientId)?.name || '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞')
                : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞';
        }, [isRpcMode, cachedProfile, clients, clientId, clientChangeTick]);

        // Morning Check-in –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –î–û –∑–∞–≥—Ä—É–∑–∫–∏)
        const isMorningCheckinBlocking = showMorningCheckin === true && window.HEYS?.MorningCheckin;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—ë (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –î–û morning checkin)
        const isConsentBlocking = needsConsent || checkingConsent;

        return {
            pendingText,
            cachedProfile,
            isRpcMode,
            currentClientName,
            isMorningCheckinBlocking,
            isConsentBlocking,
        };
    };
})();


/* ===== heys_app_shell_props_v1.js ===== */
// heys_app_shell_props_v1.js ‚Äî AppShell props builder

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppShellProps = HEYS.AppShellProps || {};

    HEYS.AppShellProps.buildAppShellProps = function ({
        isConsentBlocking,
        isMorningCheckinBlocking,
        clientId,
        tab,
        setTab,
        selectedDate,
        setSelectedDate,
        todayISO,
        datePickerActiveDays,
        products,
        setProducts,
        cachedProfile,
        currentClientName,
        getAvatarColor,
        getClientInitials,
        getClientStats,
        formatLastActive,
        clients,
        setClientId,
        showClientDropdown,
        setShowClientDropdown,
        isRpcMode,
        cloudUser,
        handleSignOut,
        U,
        cloudStatus,
        syncProgress,
        pendingCount,
        retryCountdown,
        GamificationBar,
        widgetsEditMode,
        defaultTab,
        setDefaultTab,
        slideDirection,
        edgeBounce,
        onTouchStart,
        onTouchEnd,
        syncVer,
        DayTabWithCloudSync,
        RationTabWithCloudSync,
        UserTabWithCloudSync,
    }) {
        return {
            hideContent: (isConsentBlocking || isMorningCheckinBlocking || !clientId),
            clientId,
            clientIdValue: clientId,
            tab,
            setTab,
            selectedDate,
            setSelectedDate,
            todayISO,
            datePickerActiveDays,
            products,
            setProducts,
            cachedProfile,
            currentClientName,
            getAvatarColor,
            getClientInitials,
            getClientStats,
            formatLastActive,
            clients,
            setClientId,
            showClientDropdown,
            setShowClientDropdown,
            isRpcMode,
            cloudUser,
            handleSignOut,
            U,
            cloudStatus,
            syncProgress,
            pendingCount,
            retryCountdown,
            GamificationBar,
            widgetsEditMode,
            defaultTab,
            setDefaultTab,
            slideDirection,
            edgeBounce,
            onTouchStart,
            onTouchEnd,
            syncVer,
            DayTabWithCloudSync,
            RationTabWithCloudSync,
            UserTabWithCloudSync,
        };
    };
})();


/* ===== heys_app_overlays_props_v1.js ===== */
// heys_app_overlays_props_v1.js ‚Äî AppOverlays props builder

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppOverlaysProps = HEYS.AppOverlaysProps || {};

    HEYS.AppOverlaysProps.buildOverlaysProps = function ({
        gate,
        desktopGate,
        consentGate,
        isConsentBlocking,
        isMorningCheckinBlocking,
        showMorningCheckin,
        setShowMorningCheckin,
        showOfflineBanner,
        showOnlineBanner,
        offlineDuration,
        pendingCount,
        showPwaBanner,
        showIosPwaBanner,
        handlePwaInstall,
        dismissPwaBanner,
        dismissIosPwaBanner,
        showUpdateToast,
        handleUpdate,
        dismissUpdateToast,
        notification,
        dismissNotification,
        widgetsEditMode,
        tab,
        AppShell,
        appShellProps,
    }) {
        return {
            gate,
            desktopGate,
            consentGate,
            isConsentBlocking,
            isMorningCheckinBlocking,
            showMorningCheckin,
            setShowMorningCheckin,
            showOfflineBanner,
            showOnlineBanner,
            offlineDuration,
            pendingCount,
            showPwaBanner,
            showIosPwaBanner,
            handlePwaInstall,
            dismissPwaBanner,
            dismissIosPwaBanner,
            showUpdateToast,
            handleUpdate,
            dismissUpdateToast,
            notification,
            dismissNotification,
            widgetsEditMode,
            tab,
            AppShell,
            appShellProps,
        };
    };
})();


/* ===== heys_app_gate_state_v1.js ===== */
// heys_app_gate_state_v1.js ‚Äî gate/desktop/consent state builder

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppGateState = HEYS.AppGateState || {};

    HEYS.AppGateState.useGateState = function ({
        React,
        AppGateFlow,
        AppDesktopGate,
        DesktopGateScreen,
        U,
        cloudUser,
        clientId,
        clients,
        clientsSource,
        clientSearch,
        setClientSearch,
        setClientId,
        cloudSignIn,
        handleSignOut,
        getClientStats,
        formatLastActive,
        getAvatarColor,
        getClientInitials,
        renameClient,
        removeClient,
        addClientToCloud,
        newName,
        setNewName,
        newPhone,
        setNewPhone,
        newPin,
        setNewPin,
        curatorTab,
        setCuratorTab,
        needsConsent,
        checkingConsent,
        setNeedsConsent,
        setShowMorningCheckin,
        isInitializing,
    }) {
        const gate = AppGateFlow.buildGate ? AppGateFlow.buildGate({
            clientId,
            isInitializing,
            cloudUser,
            clients,
            clientsSource,
            clientSearch,
            setClientSearch,
            setClientId,
            cloudSignIn,
            handleSignOut,
            U,
            getClientStats,
            formatLastActive,
            getAvatarColor,
            getClientInitials,
            renameClient,
            removeClient,
            addClientToCloud,
            newName,
            setNewName,
            newPhone,
            setNewPhone,
            newPin,
            setNewPin,
            curatorTab,
            setCuratorTab,
        }) : null;

        // üñ•Ô∏è Desktop Gate ‚Äî –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É—Ä–∞—Ç–æ—Ä –ª–∏ —ç—Ç–æ (–µ—Å—Ç—å user object –ø–æ—Å–ª–µ curator login)
        const desktopGateState = AppDesktopGate.useDesktopGateState
            ? AppDesktopGate.useDesktopGateState({ React })
            : { isDesktop: window.innerWidth > 768, isCurator: false };
        const { isDesktop, isCurator } = desktopGateState;

        // –ß–∏—Ç–∞–µ–º desktopAllowed –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        const profile = U?.lsGet ? U.lsGet('heys_profile', {}) : {};
        const desktopAllowed = profile?.desktopAllowed === true;

        // Desktop Gate: –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∏ –¥–µ—Å–∫—Ç–æ–ø –ù–ï —Ä–∞–∑—Ä–µ—à—ë–Ω
        const desktopGate = AppGateFlow.buildDesktopGate ? AppGateFlow.buildDesktopGate({
            gate,
            isDesktop,
            isCurator,
            desktopAllowed,
            DesktopGateScreen,
            setClientId,
        }) : null;

        // üìú Consent Gate: –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—É –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏—è
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞, –Ω–æ –î–û –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const consentGate = AppGateFlow.buildConsentGate ? AppGateFlow.buildConsentGate({
            gate,
            desktopGate,
            cloudUser,
            clientId,
            needsConsent,
            checkingConsent,
            setNeedsConsent,
            setShowMorningCheckin,
        }) : null;

        return {
            gate,
            desktopGate,
            consentGate,
            isDesktop,
            isCurator,
            desktopAllowed,
        };
    };
})();


/* ===== heys_app_global_bindings_v1.js ===== */
// heys_app_global_bindings_v1.js ‚Äî window bindings for saveClientKey + backupManager

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppGlobalBindings = HEYS.AppGlobalBindings || {};

    HEYS.AppGlobalBindings.useGlobalBindings = function ({
        React,
        cloud,
        clientId,
        backupAllKeys,
        restoreFromBackup,
        restoreFromBackupFile,
        backupMeta,
    }) {
        const { useEffect } = React;

        useEffect(() => {
            window.HEYS = window.HEYS || {};
            window.HEYS.saveClientKey = function (...args) {
                if (cloud && typeof cloud.saveClientKey === 'function') {
                    if (args.length === 3) {
                        // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: (clientId, key, value)
                        const [cid, k, v] = args;
                        cloud.saveClientKey(cid, k, v);
                    } else if (args.length === 2) {
                        // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: (key, value) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º clientId –∏–∑ –∑–∞–º—ã–∫–∞–Ω–∏—è
                        const [k, v] = args;
                        if (clientId) {
                            cloud.saveClientKey(clientId, k, v);
                        }
                    }
                }
            };
        }, [cloud, clientId]);

        useEffect(() => {
            window.HEYS = window.HEYS || {};
            window.HEYS.backupManager = window.HEYS.backupManager || {};
            window.HEYS.backupManager.backupAll = backupAllKeys;
            window.HEYS.backupManager.restore = restoreFromBackup;
            window.HEYS.backupManager.restoreFromFile = restoreFromBackupFile;
            window.HEYS.backupManager.getLastBackupMeta = () => backupMeta;
        }, [backupAllKeys, restoreFromBackup, restoreFromBackupFile, backupMeta]);
    };
})();


/* ===== heys_app_backup_state_v1.js ===== */
// heys_app_backup_state_v1.js ‚Äî backup helpers + actions state

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppBackupState = HEYS.AppBackupState || {};

    HEYS.AppBackupState.useBackupState = function ({
        React,
        AppBackup,
        AppBackupActions,
        U,
        clientId,
        setProducts,
        setSyncVer,
        setBackupMeta,
        backupBusy,
        setBackupBusy,
    }) {
        const { useMemo, useCallback } = React;

        const backupHelpers = useMemo(() => {
            if (!AppBackup?.createBackupHelpers) return null;
            return AppBackup.createBackupHelpers({
                U,
                clientId,
                setProducts,
                setSyncVer,
                setBackupMeta,
            });
        }, [AppBackup, U, clientId, setProducts, setSyncVer, setBackupMeta]);

        const backupAllKeys = backupHelpers?.backupAllKeys
            || ((options = {}) => ({ ok: false, reason: 'no-backup-helpers', options }));
        const restoreFromBackup = backupHelpers?.restoreFromBackup
            || ((target = 'heys_products', options = {}) => ({ ok: false, reason: 'no-backup-helpers', target, options }));
        const restoreFromBackupFile = backupHelpers?.restoreFromBackupFile
            || (async (options = {}) => ({ ok: false, reason: 'no-backup-helpers', options }));
        const formatBackupTime = backupHelpers?.formatBackupTime || (() => '‚Äî');

        const useBackupActions = AppBackupActions?.useBackupActions
            || (({ React: HookReact }) => ({
                handleManualBackup: HookReact.useCallback(() => { }, []),
                handleExportBackup: HookReact.useCallback(() => { }, []),
                handleRestoreProducts: HookReact.useCallback(() => { }, []),
                handleRestoreAll: HookReact.useCallback(() => { }, []),
            }));
        const backupActions = useBackupActions({
            React,
            clientId,
            backupBusy,
            setBackupBusy,
            backupAllKeys,
            restoreFromBackup,
        });

        return {
            backupAllKeys,
            restoreFromBackup,
            restoreFromBackupFile,
            formatBackupTime,
            backupActions,
        };
    };
})();


/* ===== heys_app_banner_state_v1.js ===== */
// heys_app_banner_state_v1.js ‚Äî PWA/Update banner state

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppBannerState = HEYS.AppBannerState || {};

    HEYS.AppBannerState.useBannerState = function ({
        React,
        usePwaPrompts,
        useCloudSyncStatus,
        useUpdateNotifications,
    }) {
        const pwa = usePwaPrompts ? usePwaPrompts() : {
            showPwaBanner: false,
            showIosPwaBanner: false,
            handlePwaInstall: () => { },
            dismissPwaBanner: () => { },
            dismissIosPwaBanner: () => { },
        };

        const cloudSync = useCloudSyncStatus ? useCloudSyncStatus() : {
            cloudStatus: 'offline',
            pendingCount: 0,
            pendingDetails: { days: 0, products: 0, profile: 0, other: 0 },
            showOfflineBanner: false,
            showOnlineBanner: false,
            syncProgress: null,
            retryCountdown: 0,
            handleRetrySync: () => { },
            offlineDuration: 0,
        };

        const updates = useUpdateNotifications ? useUpdateNotifications({ React }) : {
            showUpdateToast: false,
            notification: null,
            setNotification: () => { },
            handleUpdate: () => { },
            dismissUpdateToast: () => { },
        };

        return {
            ...pwa,
            ...cloudSync,
            ...updates,
        };
    };
})();


/* ===== heys_app_client_init_v1.js ===== */
// heys_app_client_init_v1.js ‚Äî auth init + client sync effects

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppClientInit = HEYS.AppClientInit || {};

    HEYS.AppClientInit.useClientInitState = function ({
        React,
        AppAuthInit,
        AppClientManagement,
        U,
        cloud,
        setProducts,
        setClients,
        setClientsSource,
        setClientId,
        setSyncVer,
        setEmail,
        setCloudUser,
        setStatus,
        setIsInitializing,
        cloudUser,
        clientsSource,
        fetchClientsFromCloud,
        clientId,
    }) {
        const { useEffect } = React;

        useEffect(() => {
            if (!AppAuthInit?.runAuthInit) return;
            return AppAuthInit.runAuthInit({
                U,
                cloud,
                setProducts,
                setClients,
                setClientsSource,
                setClientId,
                setSyncVer,
                setEmail,
                setCloudUser,
                setStatus,
                setIsInitializing,
            });
        }, [
            AppAuthInit,
            U,
            cloud,
            setProducts,
            setClients,
            setClientsSource,
            setClientId,
            setSyncVer,
            setEmail,
            setCloudUser,
            setStatus,
            setIsInitializing,
        ]);

        const useClientListSync = AppClientManagement?.useClientListSync
            || (({ React: HookReact }) => HookReact.useEffect(() => { }, []));
        useClientListSync({
            React,
            cloudUser,
            clientsSource,
            fetchClientsFromCloud,
            setClients,
            setClientId,
            clientId,
        });

        const useClientsUpdatedListener = AppClientManagement?.useClientsUpdatedListener
            || (({ React: HookReact }) => HookReact.useEffect(() => { }, []));
        useClientsUpdatedListener({ React, setClients });
    };
})();


/* ===== heys_app_twemoji_effect_v1.js ===== */
// heys_app_twemoji_effect_v1.js ‚Äî Twemoji reparse effect

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppTwemojiEffect = HEYS.AppTwemojiEffect || {};

    HEYS.AppTwemojiEffect.useTwemojiEffect = function ({ React, tab }) {
        const { useEffect } = React;
        useEffect(() => {
            const root = document.getElementById('root') || document.body;

            if (window.scheduleTwemojiParse) {
                // Debounced reparse for current viewport content
                window.scheduleTwemojiParse(root);
            } else if (window.applyTwemoji) {
                window.applyTwemoji(root);
            } else {
                console.warn('[App] ‚ö†Ô∏è applyTwemoji not available');
            }
        }, [tab]);
    };
})();


/* ===== heys_app_runtime_state_v1.js ===== */
// heys_app_runtime_state_v1.js ‚Äî runtime widgets/consent/swipe/badge/calendar state

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppRuntimeState = HEYS.AppRuntimeState || {};

    HEYS.AppRuntimeState.useRuntimeState = function ({
        React,
        AppRuntimeEffects,
        AppSwipeNav,
        tab,
        setTab,
        clientId,
        cloudUser,
        setNeedsConsent,
        setCheckingConsent,
        setCalendarVer,
    }) {
        const useWidgetsEditMode = AppRuntimeEffects?.useWidgetsEditMode
            || (({ React: HookReact }) => ({
                widgetsEditMode: HookReact.useState(false)[0],
                setWidgetsEditMode: () => { },
            }));
        const widgetsEditState = useWidgetsEditMode({ React });

        const useConsentCheck = AppRuntimeEffects?.useConsentCheck
            || (({ React: HookReact }) => HookReact.useEffect(() => { }, []));
        useConsentCheck({ React, clientId, cloudUser, setNeedsConsent, setCheckingConsent });

        const swipeState = AppSwipeNav?.useSwipeNavigation
            ? AppSwipeNav.useSwipeNavigation({ React, tab, setTab })
            : {
                slideDirection: null,
                edgeBounce: null,
                onTouchStart: () => { },
                onTouchEnd: () => { },
            };

        const useBadgeSync = AppRuntimeEffects?.useBadgeSync
            || (({ React: HookReact }) => HookReact.useEffect(() => { }, []));
        useBadgeSync({ React });

        const useCalendarSync = AppRuntimeEffects?.useCalendarSync
            || (({ React: HookReact }) => HookReact.useEffect(() => { }, []));
        useCalendarSync({ React, setCalendarVer });

        return {
            ...widgetsEditState,
            swipeState,
        };
    };
})();


/* ===== heys_app_core_state_v1.js ===== */
// heys_app_core_state_v1.js ‚Äî core client/cloud state

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppCoreState = HEYS.AppCoreState || {};

    HEYS.AppCoreState.useAppCoreState = function ({ React, AppHooks, cloud, U }) {
        const { useClientState, useCloudClients } = AppHooks || {};
        const [loginError, setLoginError] = React.useState('');

        const clientState = useClientState
            ? useClientState(cloud, U)
            : {
                status: 'offline', setStatus: () => { },
                syncVer: 0, setSyncVer: () => { },
                calendarVer: 0, setCalendarVer: () => { },
                clients: [], setClients: () => { },
                clientsSource: 'local', setClientsSource: () => { },
                clientId: null, setClientId: () => { },
                newName: '', setNewName: () => { },
                cloudUser: null, setCloudUser: () => { },
                isInitializing: false, setIsInitializing: () => { },
                products: [], setProducts: () => { },
                backupMeta: null, setBackupMeta: () => { },
                backupBusy: false, setBackupBusy: () => { },
                needsConsent: false, setNeedsConsent: () => { },
                checkingConsent: false, setCheckingConsent: () => { },
                curatorTab: 'clients', setCuratorTab: () => { },
            };

        const {
            clients,
            setClients,
            clientsSource,
            setClientsSource,
            clientId,
            setClientId,
            cloudUser,
            setCloudUser,
            setProducts,
            setStatus,
            setSyncVer,
        } = clientState;

        const cloudClients = useCloudClients
            ? useCloudClients(cloud, U, {
                clients,
                setClients,
                clientsSource,
                setClientsSource,
                clientId,
                setClientId,
                cloudUser,
                setCloudUser,
                setProducts,
                setStatus,
                setSyncVer,
                setLoginError,
            })
            : {
                ONE_CURATOR_MODE: false,
                fetchClientsFromCloud: async () => [],
                addClientToCloud: async () => ({}),
                renameClient: async () => ({}),
                removeClient: async () => ({}),
                cloudSignIn: async () => ({}),
                cloudSignOut: async () => ({}),
            };

        return {
            clientState,
            cloudClients,
            loginError,
            setLoginError,
        };
    };
})();


/* ===== heys_app_root_impl_v1.js ===== */
// heys_app_root_impl_v1.js ‚Äî App component implementation extracted from heys_app_root_component_v1.js

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppRootImpl = HEYS.AppRootImpl || {};

    // üÜï Heartbeat –¥–ª—è watchdog ‚Äî AppRootImpl –∑–∞–≥—Ä—É–∂–µ–Ω (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–ª—è dep check)
    if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();

    const getModule = HEYS._getModule || function (name, fallback) {
        return HEYS[name] || fallback || {};
    };

    HEYS.AppRootImpl.createApp = function createApp({ React }) {
        const AppGateFlow = getModule('AppGateFlow');
        const AppBackup = getModule('AppBackup');
        const AppShortcuts = getModule('AppShortcuts');
        const AppAuthInit = getModule('AppAuthInit');
        const AppClientHelpers = getModule('AppClientHelpers');
        const AppDesktopGate = getModule('AppDesktopGate');
        const AppMorningCheckin = getModule('AppMorningCheckin');
        const AppSwipeNav = getModule('AppSwipeNav');
        const AppRuntimeEffects = getModule('AppRuntimeEffects');
        const AppSyncEffects = getModule('AppSyncEffects');
        const AppTabState = getModule('AppTabState');
        const AppClientManagement = getModule('AppClientManagement');
        const AppBackupActions = getModule('AppBackupActions');
        const AppUpdateNotifications = getModule('AppUpdateNotifications');
        const AppUIState = getModule('AppUIState');
        const AppClientStateManager = getModule('AppClientStateManager');
        const AppDateState = getModule('AppDateState');
        const AppDerivedState = getModule('AppDerivedState');
        const AppShellProps = getModule('AppShellProps');
        const AppOverlaysProps = getModule('AppOverlaysProps');
        const AppGateState = getModule('AppGateState');
        const AppGlobalBindings = getModule('AppGlobalBindings');
        const AppBackupState = getModule('AppBackupState');
        const AppBannerState = getModule('AppBannerState');
        const AppClientInit = getModule('AppClientInit');
        const AppTwemojiEffect = getModule('AppTwemojiEffect');
        const AppRuntimeState = getModule('AppRuntimeState');
        const AppCoreState = getModule('AppCoreState');
        const DesktopGateScreen = HEYS.DesktopGateScreen;
        const GamificationBar = HEYS.GamificationBar;
        const AppShellModule = getModule('AppShell');
        const AppOverlaysModule = getModule('AppOverlays');
        const AppShell = AppShellModule && AppShellModule.AppShell;
        const AppOverlays = AppOverlaysModule && AppOverlaysModule.AppOverlays;
        const AppTabs = getModule('AppTabs');
        const {
            DayTabWithCloudSync,
            RationTabWithCloudSync,
            UserTabWithCloudSync,
            AnalyticsTab,
        } = AppTabs;

        const AppHooks = getModule('AppHooks');
        const {
            useThemePreference,
            usePwaPrompts,
            useWakeLock,
            useCloudSyncStatus,
            useClientState,
            useCloudClients,
        } = AppHooks;

        function App() {
            const getStableHook = (primaryHook, fallbackHook) => {
                const hookRef = React.useRef(primaryHook || fallbackHook);
                return hookRef.current;
            };

            const fallbackUseTabState = ({ React: HookReact }) => ({
                tab: HookReact.useState('diary')[0],
                setTab: () => { },
                defaultTab: 'diary',
                setDefaultTab: () => { },
            });
            const useTabState = getStableHook(AppTabState.useTabState, fallbackUseTabState);
            const tabState = useTabState({ React });
            const { tab, setTab, defaultTab, setDefaultTab } = tabState;

            const { theme, resolvedTheme, cycleTheme } = useThemePreference();
            React.useEffect(() => {
                HEYS.cycleTheme = cycleTheme;
            }, [cycleTheme]);

            const fallbackUseTwemojiEffect = ({ React: HookReact }) => HookReact.useEffect(() => { }, []);
            const useTwemojiEffect = getStableHook(AppTwemojiEffect.useTwemojiEffect, fallbackUseTwemojiEffect);
            useTwemojiEffect({ React, tab });

            const U = HEYS.utils || { lsGet: (k, d) => d, lsSet: () => { } };
            const cloud = HEYS.cloud || {};

            const readStoredValue = (key, fallback = null) => {
                let value;
                if (HEYS.store?.get) {
                    value = HEYS.store.get(key, fallback);
                } else if (HEYS.utils?.lsGet) {
                    value = HEYS.utils.lsGet(key, fallback);
                } else {
                    try {
                        value = localStorage.getItem(key);
                    } catch (e) {
                        return fallback;
                    }
                }

                if (value == null) return fallback;

                if (typeof value === 'string') {
                    if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
                        try {
                            value = HEYS.store.decompress(value.slice(3));
                        } catch (e) { }
                    }
                    try {
                        return JSON.parse(value);
                    } catch (e) {
                        return value;
                    }
                }

                return value;
            };

            const fallbackUseAppCoreState = ({ React: HookReact, AppHooks: HookAppHooks, cloud: hookCloud, U: hookU }) => {
                const { useClientState: hookUseClientState, useCloudClients: hookUseCloudClients } = HookAppHooks || {};
                const [loginError, setLoginError] = HookReact.useState('');
                const clientState = hookUseClientState ? hookUseClientState(hookCloud, hookU) : {
                    status: 'offline', setStatus: () => { },
                    syncVer: 0, setSyncVer: () => { },
                    calendarVer: 0, setCalendarVer: () => { },
                    clients: [], setClients: () => { },
                    clientsSource: 'local', setClientsSource: () => { },
                    clientId: null, setClientId: () => { },
                    newName: '', setNewName: () => { },
                    cloudUser: null, setCloudUser: () => { },
                    isInitializing: false, setIsInitializing: () => { },
                    products: [], setProducts: () => { },
                    backupMeta: null, setBackupMeta: () => { },
                    backupBusy: false, setBackupBusy: () => { },
                    needsConsent: false, setNeedsConsent: () => { },
                    checkingConsent: false, setCheckingConsent: () => { },
                    curatorTab: 'clients', setCuratorTab: () => { },
                };
                const {
                    clients,
                    setClients,
                    clientsSource,
                    setClientsSource,
                    clientId,
                    setClientId,
                    cloudUser,
                    setCloudUser,
                    setProducts,
                    setStatus,
                    setSyncVer,
                } = clientState;
                const cloudClients = hookUseCloudClients
                    ? hookUseCloudClients(hookCloud, hookU, {
                        clients,
                        setClients,
                        clientsSource,
                        setClientsSource,
                        clientId,
                        setClientId,
                        cloudUser,
                        setCloudUser,
                        setProducts,
                        setStatus,
                        setSyncVer,
                        setLoginError,
                    })
                    : {
                        ONE_CURATOR_MODE: false,
                        fetchClientsFromCloud: async () => [],
                        addClientToCloud: async () => ({}),
                        renameClient: async () => ({}),
                        removeClient: async () => ({}),
                        cloudSignIn: async () => ({}),
                        cloudSignOut: async () => ({}),
                    };
                return { clientState, cloudClients, loginError, setLoginError };
            };
            const useAppCoreState = getStableHook(AppCoreState.useAppCoreState, fallbackUseAppCoreState);
            const coreState = useAppCoreState({ React, AppHooks, cloud, U });
            const { clientState, cloudClients, loginError, setLoginError } = coreState;
            const {
                status, setStatus,
                syncVer, setSyncVer,
                calendarVer, setCalendarVer,
                clients, setClients,
                clientsSource, setClientsSource,
                clientId, setClientId,
                newName, setNewName,
                cloudUser, setCloudUser,
                isInitializing, setIsInitializing,
                products, setProducts,
                backupMeta, setBackupMeta,
                backupBusy, setBackupBusy,
                needsConsent, setNeedsConsent,
                checkingConsent, setCheckingConsent,
                curatorTab, setCuratorTab,
            } = clientState;
            const {
                ONE_CURATOR_MODE,
                fetchClientsFromCloud,
                addClientToCloud,
                renameClient,
                removeClient,
                cloudSignIn,
                cloudSignOut,
            } = cloudClients;

            const fallbackUseRuntimeState = ({ React: HookReact }) => ({
                widgetsEditMode: HookReact.useState(false)[0],
                setWidgetsEditMode: () => { },
                swipeState: {
                    slideDirection: null,
                    edgeBounce: null,
                    onTouchStart: () => { },
                    onTouchEnd: () => { },
                },
            });
            const useRuntimeState = getStableHook(AppRuntimeState.useRuntimeState, fallbackUseRuntimeState);
            const runtimeState = useRuntimeState({
                React,
                AppRuntimeEffects,
                AppSwipeNav,
                tab,
                setTab,
                clientId,
                cloudUser,
                setNeedsConsent,
                setCheckingConsent,
                setCalendarVer,
            });
            const { widgetsEditMode } = runtimeState;
            const { slideDirection, edgeBounce, onTouchStart, onTouchEnd } = runtimeState.swipeState;

            const fallbackUseDateSelectionState = ({ React: HookReact }) => {
                const todayISO = () => {
                    const d = new Date();
                    const hour = d.getHours();
                    if (hour < 3) {
                        d.setDate(d.getDate() - 1);
                    }
                    return d.getFullYear()
                        + '-' + String(d.getMonth() + 1).padStart(2, '0')
                        + '-' + String(d.getDate()).padStart(2, '0');
                };
                const [selectedDate, setSelectedDate] = HookReact.useState(todayISO());
                return { todayISO, selectedDate, setSelectedDate };
            };
            const useDateSelectionState = getStableHook(AppDateState.useDateSelectionState, fallbackUseDateSelectionState);
            const dateSelectionState = useDateSelectionState({ React });
            const { todayISO, selectedDate, setSelectedDate } = dateSelectionState;

            const fallbackUseUpdateNotifications = ({ React: HookReact }) => {
                const [showUpdateToast, setShowUpdateToast] = HookReact.useState(false);
                const [notification, setNotification] = HookReact.useState(null);
                HookReact.useEffect(() => { }, []);
                const handleUpdate = HookReact.useCallback(() => { }, []);
                const dismissUpdateToast = HookReact.useCallback(() => { }, []);
                return { showUpdateToast, notification, setNotification, handleUpdate, dismissUpdateToast };
            };
            const useUpdateNotifications = getStableHook(
                AppUpdateNotifications.useUpdateNotifications,
                fallbackUseUpdateNotifications,
            );

            const fallbackUseBannerState = ({ React: HookReact, usePwaPrompts: fallbackPwa, useCloudSyncStatus: fallbackCloud, useUpdateNotifications: fallbackUpdates }) => {
                const pwa = fallbackPwa ? fallbackPwa() : {
                    showPwaBanner: false,
                    showIosPwaBanner: false,
                    handlePwaInstall: () => { },
                    dismissPwaBanner: () => { },
                    dismissIosPwaBanner: () => { },
                };
                const cloudSync = fallbackCloud ? fallbackCloud() : {
                    cloudStatus: 'offline',
                    pendingCount: 0,
                    pendingDetails: { days: 0, products: 0, profile: 0, other: 0 },
                    showOfflineBanner: false,
                    showOnlineBanner: false,
                    syncProgress: null,
                    retryCountdown: 0,
                    handleRetrySync: () => { },
                    offlineDuration: 0,
                };
                const updates = fallbackUpdates ? fallbackUpdates({ React: HookReact }) : {
                    showUpdateToast: false,
                    notification: null,
                    setNotification: () => { },
                    handleUpdate: () => { },
                    dismissUpdateToast: () => { },
                };
                return { ...pwa, ...cloudSync, ...updates };
            };
            const useBannerState = getStableHook(AppBannerState.useBannerState, fallbackUseBannerState);
            const bannerState = useBannerState({
                React,
                usePwaPrompts,
                useCloudSyncStatus,
                useUpdateNotifications,
            });
            const {
                showPwaBanner,
                showIosPwaBanner,
                handlePwaInstall,
                dismissPwaBanner,
                dismissIosPwaBanner,
                cloudStatus,
                pendingCount,
                pendingDetails,
                showOfflineBanner,
                showOnlineBanner,
                syncProgress,
                retryCountdown,
                handleRetrySync,
                offlineDuration,
                showUpdateToast,
                notification,
                setNotification,
                handleUpdate,
                dismissUpdateToast,
            } = bannerState;

            const fallbackUseDatePickerActiveDays = ({ React: HookReact }) => HookReact.useMemo(() => new Map(), []);
            const useDatePickerActiveDays = getStableHook(AppDateState.useDatePickerActiveDays, fallbackUseDatePickerActiveDays);
            const datePickerActiveDays = useDatePickerActiveDays({
                React,
                selectedDate,
                clientId,
                products,
                isInitializing,
                calendarVer,
                U,
            });

            const fallbackUseBackupState = ({ React: HookReact }) => ({
                backupAllKeys: () => ({ ok: false, reason: 'no-backup-helpers' }),
                restoreFromBackup: () => ({ ok: false, reason: 'no-backup-helpers' }),
                formatBackupTime: () => '‚Äî',
                backupActions: {
                    handleManualBackup: () => { },
                    handleExportBackup: () => { },
                    handleRestoreProducts: () => { },
                    handleRestoreAll: () => { },
                },
            });
            const useBackupState = getStableHook(AppBackupState.useBackupState, fallbackUseBackupState);
            const backupState = useBackupState({
                React,
                AppBackup,
                AppBackupActions,
                U,
                clientId,
                setProducts,
                setSyncVer,
                setBackupMeta,
                backupBusy,
                setBackupBusy,
            });
            const {
                backupAllKeys,
                restoreFromBackup,
                restoreFromBackupFile,
                formatBackupTime,
                backupActions,
            } = backupState;

            const fallbackUseClientStateManager = ({ React: HookReact }) => ({
                skipTabSwitchRef: HookReact.useRef(false),
            });
            const useClientStateManager = getStableHook(
                AppClientStateManager.useClientStateManager,
                fallbackUseClientStateManager,
            );
            const { skipTabSwitchRef } = useClientStateManager({
                React,
                clientId,
                setTab,
                defaultTab,
                setProducts,
                setSyncVer,
            });

            const fallbackUseSyncEffects = ({ React: HookReact }) => HookReact.useEffect(() => { }, []);
            const useSyncEffects = getStableHook(AppSyncEffects.useSyncEffects, fallbackUseSyncEffects);
            useSyncEffects({
                React,
                U,
                cloud,
                clientId,
                products,
                setProducts,
                setSyncVer,
                setBackupMeta,
            });

            const fallbackUseGlobalBindings = ({ React: HookReact }) => HookReact.useEffect(() => { }, []);
            const useGlobalBindings = getStableHook(AppGlobalBindings.useGlobalBindings, fallbackUseGlobalBindings);
            useGlobalBindings({
                React,
                cloud,
                clientId,
                backupAllKeys,
                restoreFromBackup,
                restoreFromBackupFile,
                backupMeta,
            });

            const {
                handleManualBackup,
                handleExportBackup,
                handleRestoreProducts,
                handleRestoreAll,
            } = backupActions;

            const fallbackAppUIState = ({
                React: HookReact,
                setTab: fallbackSetTab,
                setNotification: fallbackSetNotification,
                skipTabSwitchRef: fallbackSkipRef,
            }) => {
                HookReact.useEffect(() => {
                    const shortcuts = HEYS?.AppShortcuts?.handleShortcuts;
                    if (!shortcuts) return;
                    return shortcuts({
                        setTab: fallbackSetTab,
                        setNotification: fallbackSetNotification,
                        skipTabSwitchRef: fallbackSkipRef,
                    });
                }, [fallbackSetTab, fallbackSetNotification, fallbackSkipRef]);
                return {
                    email: HookReact.useState('')[0],
                    setEmail: () => { },
                    pwd: HookReact.useState('')[0],
                    setPwd: () => { },
                    rememberMe: false,
                    setRememberMe: () => { },
                    handleSignIn: () => Promise.resolve(),
                    handleSignOut: () => { },
                    clientSearch: '',
                    setClientSearch: () => { },
                    showClientDropdown: false,
                    setShowClientDropdown: () => { },
                    newPhone: '',
                    setNewPhone: () => { },
                    newPin: '',
                    setNewPin: () => { },
                };
            };
            const useAppUIState = getStableHook(AppUIState.useAppUIState, fallbackAppUIState);
            const uiState = useAppUIState({
                React,
                cloudSignIn,
                cloudSignOut,
                setTab,
                setNotification,
                skipTabSwitchRef,
            });
            const {
                email,
                setEmail,
                pwd,
                setPwd,
                rememberMe,
                setRememberMe,
                handleSignIn,
                handleSignOut,
                clientSearch,
                setClientSearch,
                showClientDropdown,
                setShowClientDropdown,
                newPhone,
                setNewPhone,
                newPin,
                setNewPin,
            } = uiState;

            const fallbackUseMorningCheckinSync = ({ React: HookReact }) => {
                return { showMorningCheckin: false, setShowMorningCheckin: () => { } };
            };
            const useMorningCheckinSync = getStableHook(
                AppMorningCheckin.useMorningCheckinSync,
                fallbackUseMorningCheckinSync,
            );
            const morningCheckinState = useMorningCheckinSync({ React, isInitializing, clientId });
            const { showMorningCheckin, setShowMorningCheckin } = morningCheckinState;

            const getClientInitials = AppClientHelpers.getClientInitials || ((name) => {
                if (!name) return '?';
                const parts = name.trim().split(' ');
                if (parts.length >= 2) {
                    return (parts[0][0] + parts[1][0]).toUpperCase();
                }
                return name.slice(0, 2).toUpperCase();
            });

            const getAvatarColor = AppClientHelpers.getAvatarColor || ((name) => {
                if (!name) return 'linear-gradient(135deg, #4285f4 0%, #2563eb 100%)';
                return 'linear-gradient(135deg, #4285f4 0%, #2563eb 100%)';
            });

            const getClientStats = AppClientHelpers.getClientStats || (() => ({ lastActiveDate: null, streak: 0 }));
            const formatLastActive = AppClientHelpers.formatLastActive || (() => '');

            const fallbackUseGateState = ({ React: HookReact }) => ({
                gate: null,
                desktopGate: null,
                consentGate: null,
                isDesktop: window.innerWidth > 768,
                isCurator: false,
                desktopAllowed: false,
            });
            const useGateState = getStableHook(AppGateState.useGateState, fallbackUseGateState);
            const gateState = useGateState({
                React,
                AppGateFlow,
                AppDesktopGate,
                DesktopGateScreen,
                U,
                cloudUser,
                clientId,
                clients,
                clientsSource,
                clientSearch,
                setClientSearch,
                setClientId,
                cloudSignIn,
                handleSignOut,
                getClientStats,
                formatLastActive,
                getAvatarColor,
                getClientInitials,
                renameClient,
                removeClient,
                addClientToCloud,
                newName,
                setNewName,
                newPhone,
                setNewPhone,
                newPin,
                setNewPin,
                curatorTab,
                setCuratorTab,
                needsConsent,
                checkingConsent,
                setNeedsConsent,
                setShowMorningCheckin,
                isInitializing,
            });
            const { gate, desktopGate, consentGate } = gateState;

            const fallbackUseClientInitState = ({ React: HookReact }) => HookReact.useEffect(() => { }, []);
            const useClientInitState = getStableHook(AppClientInit.useClientInitState, fallbackUseClientInitState);
            useClientInitState({
                React,
                AppAuthInit,
                AppClientManagement,
                U,
                cloud,
                setProducts,
                setClients,
                setClientsSource,
                setClientId,
                setSyncVer,
                setEmail,
                setCloudUser,
                setStatus,
                setIsInitializing,
                cloudUser,
                clientsSource,
                fetchClientsFromCloud,
                clientId,
            });

            const createTestClients = AppClientManagement.createTestClients
                || (async () => { });

            const fallbackUseAppDerivedState = ({ React: HookReact, pendingDetails: fallbackPendingDetails, clients: fallbackClients, clientId: fallbackClientId, needsConsent: fallbackNeedsConsent, checkingConsent: fallbackCheckingConsent, showMorningCheckin: fallbackShowMorningCheckin, U: fallbackU, cloud: fallbackCloud }) => {
                const [clientChangeTick, setClientChangeTick] = HookReact.useState(0);
                HookReact.useEffect(() => {
                    const handleClientChange = () => setClientChangeTick((v) => v + 1);
                    window.addEventListener('heys:client-changed', handleClientChange);
                    return () => window.removeEventListener('heys:client-changed', handleClientChange);
                }, []);
                const pendingText = HookReact.useMemo(() => {
                    if (!fallbackPendingDetails) return '';
                    const parts = [];
                    if (fallbackPendingDetails.days > 0) parts.push(`${fallbackPendingDetails.days} –¥–Ω.`);
                    if (fallbackPendingDetails.products > 0) parts.push(`${fallbackPendingDetails.products} –ø—Ä–æ–¥.`);
                    if (fallbackPendingDetails.profile > 0) parts.push('–ø—Ä–æ—Ñ–∏–ª—å');
                    if (fallbackPendingDetails.other > 0) parts.push(`${fallbackPendingDetails.other} –¥—Ä.`);
                    return parts.length > 0 ? parts.join(', ') : '';
                }, [fallbackPendingDetails]);

                const cachedProfile = HookReact.useMemo(() => {
                    return readStoredValue('heys_profile', {});
                }, [fallbackU, fallbackClientId, clientChangeTick]);

                const isRpcMode = fallbackCloud?.isPinAuthClient?.() || false;
                const currentClientName = HookReact.useMemo(() => {
                    if (isRpcMode) {
                        const fullName = cachedProfile.name
                            || [cachedProfile.firstName, cachedProfile.lastName].filter(Boolean).join(' ');
                        if (fullName) return fullName;
                        try {
                            const pendingName = readStoredValue('heys_pending_client_name', null);
                            if (pendingName) return pendingName;
                        } catch (e) { }
                        return '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å';
                    }
                    return Array.isArray(fallbackClients)
                        ? (fallbackClients.find((c) => c.id === fallbackClientId)?.name || '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞')
                        : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞';
                }, [isRpcMode, cachedProfile, fallbackClients, fallbackClientId, clientChangeTick]);

                const isMorningCheckinBlocking = fallbackShowMorningCheckin === true && HEYS?.MorningCheckin;
                const isConsentBlocking = fallbackNeedsConsent || fallbackCheckingConsent;

                return {
                    pendingText,
                    cachedProfile,
                    isRpcMode,
                    currentClientName,
                    isMorningCheckinBlocking,
                    isConsentBlocking,
                };
            };
            const useAppDerivedState = getStableHook(AppDerivedState.useAppDerivedState, fallbackUseAppDerivedState);
            const derivedState = useAppDerivedState({
                React,
                pendingDetails,
                clients,
                clientId,
                needsConsent,
                checkingConsent,
                showMorningCheckin,
                U,
                cloud,
            });
            const {
                pendingText,
                cachedProfile,
                isRpcMode,
                currentClientName,
                isMorningCheckinBlocking,
                isConsentBlocking,
            } = derivedState;
            const getPendingText = () => pendingText;

            const buildAppShellProps = AppShellProps.buildAppShellProps
                || ((params) => ({
                    hideContent: (params.isConsentBlocking || params.isMorningCheckinBlocking || !params.clientId),
                    clientId: params.clientId,
                    clientIdValue: params.clientId,
                    tab: params.tab,
                    setTab: params.setTab,
                    selectedDate: params.selectedDate,
                    setSelectedDate: params.setSelectedDate,
                    todayISO: params.todayISO,
                    datePickerActiveDays: params.datePickerActiveDays,
                    products: params.products,
                    setProducts: params.setProducts,
                    cachedProfile: params.cachedProfile,
                    currentClientName: params.currentClientName,
                    getAvatarColor: params.getAvatarColor,
                    getClientInitials: params.getClientInitials,
                    getClientStats: params.getClientStats,
                    formatLastActive: params.formatLastActive,
                    clients: params.clients,
                    setClientId: params.setClientId,
                    showClientDropdown: params.showClientDropdown,
                    setShowClientDropdown: params.setShowClientDropdown,
                    isRpcMode: params.isRpcMode,
                    cloudUser: params.cloudUser,
                    handleSignOut: params.handleSignOut,
                    U: params.U,
                    cloudStatus: params.cloudStatus,
                    syncProgress: params.syncProgress,
                    pendingCount: params.pendingCount,
                    retryCountdown: params.retryCountdown,
                    GamificationBar: params.GamificationBar,
                    widgetsEditMode: params.widgetsEditMode,
                    defaultTab: params.defaultTab,
                    setDefaultTab: params.setDefaultTab,
                    slideDirection: params.slideDirection,
                    edgeBounce: params.edgeBounce,
                    onTouchStart: params.onTouchStart,
                    onTouchEnd: params.onTouchEnd,
                    syncVer: params.syncVer,
                    DayTabWithCloudSync: params.DayTabWithCloudSync,
                    RationTabWithCloudSync: params.RationTabWithCloudSync,
                    UserTabWithCloudSync: params.UserTabWithCloudSync,
                }));
            // useMemo prevents AppShell (React.memo) from re-rendering when unrelated state changes
            const appShellProps = React.useMemo(() => buildAppShellProps({
                isConsentBlocking,
                isMorningCheckinBlocking,
                clientId,
                tab,
                setTab,
                selectedDate,
                setSelectedDate,
                todayISO,
                datePickerActiveDays,
                products,
                setProducts,
                cachedProfile,
                currentClientName,
                getAvatarColor,
                getClientInitials,
                getClientStats,
                formatLastActive,
                clients,
                setClientId,
                showClientDropdown,
                setShowClientDropdown,
                isRpcMode,
                cloudUser,
                handleSignOut,
                U,
                cloudStatus,
                syncProgress,
                pendingCount,
                retryCountdown,
                GamificationBar,
                widgetsEditMode,
                defaultTab,
                setDefaultTab,
                slideDirection,
                edgeBounce,
                onTouchStart,
                onTouchEnd,
                syncVer,
                DayTabWithCloudSync,
                RationTabWithCloudSync,
                UserTabWithCloudSync,
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }), [isConsentBlocking, isMorningCheckinBlocking, clientId, tab,
                selectedDate, datePickerActiveDays, products, cachedProfile,
                currentClientName, clients, showClientDropdown, isRpcMode,
                cloudUser, cloudStatus, syncProgress, pendingCount, retryCountdown,
                widgetsEditMode, defaultTab, slideDirection, edgeBounce, syncVer]);

            const buildOverlaysProps = AppOverlaysProps.buildOverlaysProps
                || ((params) => ({
                    gate: params.gate,
                    desktopGate: params.desktopGate,
                    consentGate: params.consentGate,
                    isConsentBlocking: params.isConsentBlocking,
                    isMorningCheckinBlocking: params.isMorningCheckinBlocking,
                    showMorningCheckin: params.showMorningCheckin,
                    setShowMorningCheckin: params.setShowMorningCheckin,
                    showOfflineBanner: params.showOfflineBanner,
                    showOnlineBanner: params.showOnlineBanner,
                    offlineDuration: params.offlineDuration,
                    pendingCount: params.pendingCount,
                    showPwaBanner: params.showPwaBanner,
                    showIosPwaBanner: params.showIosPwaBanner,
                    handlePwaInstall: params.handlePwaInstall,
                    dismissPwaBanner: params.dismissPwaBanner,
                    dismissIosPwaBanner: params.dismissIosPwaBanner,
                    showUpdateToast: params.showUpdateToast,
                    handleUpdate: params.handleUpdate,
                    dismissUpdateToast: params.dismissUpdateToast,
                    notification: params.notification,
                    dismissNotification: params.dismissNotification,
                    widgetsEditMode: params.widgetsEditMode,
                    tab: params.tab,
                    AppShell: params.AppShell,
                    appShellProps: params.appShellProps,
                }));
            // useMemo prevents AppOverlays (React.memo) from re-rendering when unrelated state changes
            const overlaysProps = React.useMemo(() => buildOverlaysProps({
                gate,
                desktopGate,
                consentGate,
                isConsentBlocking,
                isMorningCheckinBlocking,
                showMorningCheckin,
                setShowMorningCheckin,
                showOfflineBanner,
                showOnlineBanner,
                offlineDuration,
                pendingCount,
                showPwaBanner,
                showIosPwaBanner,
                handlePwaInstall,
                dismissPwaBanner,
                dismissIosPwaBanner,
                showUpdateToast,
                handleUpdate,
                dismissUpdateToast,
                notification,
                dismissNotification: () => setNotification(null),
                widgetsEditMode,
                tab,
                AppShell,
                appShellProps,
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }), [isConsentBlocking, isMorningCheckinBlocking, showMorningCheckin,
                showOfflineBanner, showOnlineBanner, offlineDuration, pendingCount,
                showPwaBanner, showIosPwaBanner, showUpdateToast, notification,
                widgetsEditMode, tab, appShellProps]);
            return React.createElement(AppOverlays, overlaysProps);
        }

        return App;
    };
})();


/* ===== heys_app_root_component_v1.js ===== */
// heys_app_root_component_v1.js ‚Äî App component proxy (delegates to AppRootImpl)

(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.AppRootComponent = HEYS.AppRootComponent || {};

    // üÜï Heartbeat –¥–ª—è watchdog ‚Äî AppRootComponent –∑–∞–≥—Ä—É–∂–µ–Ω
    if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();

    // üÜï Recovery UI –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
    function RecoveryScreen({ React, moduleName }) {
        const [clearing, setClearing] = React.useState(false);

        const handleReload = () => {
            window.location.reload();
        };

        const handleClearCache = async () => {
            setClearing(true);
            try {
                // –£–≤–µ–¥–æ–º–ª—è–µ–º SW –æ boot failure
                if (navigator.serviceWorker?.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'BOOT_FAILURE' });
                }

                // –û—á–∏—â–∞–µ–º –∫—ç—à–∏ –Ω–∞–ø—Ä—è–º—É—é
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }

                // Unregister SW
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                }

                // –û—á–∏—â–∞–µ–º sessionStorage
                sessionStorage.clear();

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                window.location.reload();
            } catch (e) {
                console.error('[Recovery] Error:', e);
                window.location.reload();
            }
        };

        return React.createElement('div', {
            style: {
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '100vh',
                padding: '20px',
                fontFamily: 'system-ui, sans-serif',
                background: 'var(--bg-secondary, #f3f4f6)',
                textAlign: 'center'
            }
        }, [
            React.createElement('div', {
                key: 'card',
                style: {
                    background: 'var(--card, white)',
                    borderRadius: '16px',
                    padding: '32px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    maxWidth: '400px',
                    width: '100%'
                }
            }, [
                React.createElement('div', { key: 'icon', style: { fontSize: '48px', marginBottom: '16px' } }, '‚ö†Ô∏è'),
                React.createElement('h2', {
                    key: 'title',
                    style: { margin: '0 0 8px', fontSize: '20px', fontWeight: '600' }
                }, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'),
                React.createElement('p', {
                    key: 'desc',
                    style: { margin: '0 0 24px', color: '#6b7280', fontSize: '14px' }
                }, moduleName
                    ? `–ú–æ–¥—É–ª—å "${moduleName}" –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`
                    : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'
                ),
                React.createElement('div', {
                    key: 'buttons',
                    style: { display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }
                }, [
                    React.createElement('button', {
                        key: 'reload',
                        onClick: handleReload,
                        style: {
                            padding: '12px 24px',
                            borderRadius: '8px',
                            border: 'none',
                            background: '#10b981',
                            color: 'white',
                            fontWeight: '500',
                            cursor: 'pointer',
                            fontSize: '14px'
                        }
                    }, 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å'),
                    React.createElement('button', {
                        key: 'clear',
                        onClick: handleClearCache,
                        disabled: clearing,
                        style: {
                            padding: '12px 24px',
                            borderRadius: '8px',
                            border: '1px solid #d1d5db',
                            background: 'var(--card, white)',
                            color: 'var(--text, #374151)',
                            fontWeight: '500',
                            cursor: clearing ? 'wait' : 'pointer',
                            fontSize: '14px',
                            opacity: clearing ? 0.6 : 1
                        }
                    }, clearing ? '‚è≥ –û—á–∏—Å—Ç–∫–∞...' : 'üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à')
                ])
            ])
        ]);
    }

    HEYS.AppRootComponent.createApp = function createApp({ React }) {
        const AppRootImpl = HEYS.AppRootImpl;
        if (!AppRootImpl || typeof AppRootImpl.createApp !== 'function') {
            // üÜï –£–≤–µ–¥–æ–º–ª—è–µ–º SW –æ boot failure
            if (navigator.serviceWorker?.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'BOOT_FAILURE' });
            }
            window.__heysLog && window.__heysLog('[CRITICAL] AppRootImpl missing!');

            return function MissingAppRootImpl() {
                return React.createElement(RecoveryScreen, { React, moduleName: 'AppRootImpl' });
            };
        }
        return AppRootImpl.createApp({ React });
    };

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    HEYS.AppRootComponent.RecoveryScreen = RecoveryScreen;
})();

