
/* ===== heys_modal_manager_v1.js ===== */
window.__heysPerfMark && window.__heysPerfMark('postboot-3-ui: execute start');
// heys_modal_manager_v1.js ‚Äî –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –º–æ–¥–∞–ª–∫–∞–º–∏
// –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
// 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–æ–≤–æ–π
// 2. –ï–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª–æ–∫
// 3. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // === –†–µ–µ—Å—Ç—Ä –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª–æ–∫ ===
  const openModals = new Set();
  const modalClosers = new Map(); // modalId => closeFunction
  const MODAL_SYNC_BLOCK_MS = 10 * 60 * 1000;
  const syncState = {
    token: null,
    dayBlockUntil: 0,
    transitioning: false
  };

  // === API ===
  const ModalManager = {
    /**
     * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –º–æ–¥–∞–ª–∫—É
     * @param {string} modalId - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –º–æ–¥–∞–ª–∫–∏
     * @param {Function} closeFunction - —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
     * @returns {Function} cleanup —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
     */
    register(modalId, closeFunction) {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –º–æ–¥–∞–ª–∫–∏
      syncState.transitioning = true;
      this.closeAll(modalId);

      // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é
      if (openModals.size === 0) {
        this._pauseSyncForModal();
      }
      openModals.add(modalId);
      modalClosers.set(modalId, closeFunction);
      syncState.transitioning = false;

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º cleanup —Ñ—É–Ω–∫—Ü–∏—é
      return () => {
        this._unregister(modalId);
        if (!syncState.transitioning) {
          this._resumeSyncIfNeeded();
        }
      };
    },

    /**
     * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –º–æ–¥–∞–ª–∫–∏ –∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π
     * @param {string} exceptModalId - ID –º–æ–¥–∞–ª–∫–∏ –∫–æ—Ç–æ—Ä—É—é –ù–ï –∑–∞–∫—Ä—ã–≤–∞—Ç—å
     */
    closeAll(exceptModalId = null) {
      const idsToClose = [];
      for (const modalId of modalClosers.keys()) {
        if (modalId !== exceptModalId) idsToClose.push(modalId);
      }

      idsToClose.forEach((modalId) => {
        const closer = modalClosers.get(modalId);
        if (!closer) return;
        try {
          closer();
        } catch (e) {
          console.warn(`[ModalManager] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ ${modalId}:`, e);
        }
        this._unregister(modalId);
      });

      if (!syncState.transitioning) {
        this._resumeSyncIfNeeded();
      }
    },

    /**
     * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–æ–¥–∞–ª–∫—É
     * @param {string} modalId - ID –º–æ–¥–∞–ª–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
     */
    close(modalId) {
      const closer = modalClosers.get(modalId);
      if (closer) {
        try {
          closer();
        } catch (e) {
          console.warn(`[ModalManager] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ ${modalId}:`, e);
        }
      }
      this._unregister(modalId);
      this._resumeSyncIfNeeded();
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –º–æ–¥–∞–ª–∫–∞
     * @param {string} modalId - ID –º–æ–¥–∞–ª–∫–∏
     * @returns {boolean}
     */
    isOpen(modalId) {
      return openModals.has(modalId);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª–æ–∫
     * @returns {Array<string>}
     */
    getOpenModals() {
      return Array.from(openModals);
    },

    /**
     * –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª–æ–∫
     * @returns {number}
     */
    getOpenCount() {
      return openModals.size;
    },

    _unregister(modalId) {
      openModals.delete(modalId);
      modalClosers.delete(modalId);
    },

    _pauseSyncForModal() {
      if (syncState.token) return;

      if (HEYS.Day?.setBlockCloudUpdates) {
        syncState.dayBlockUntil = Date.now() + MODAL_SYNC_BLOCK_MS;
        HEYS.Day.setBlockCloudUpdates(syncState.dayBlockUntil);
      }

      syncState.token = HEYS.cloud?.pauseSync?.(MODAL_SYNC_BLOCK_MS, 'modal') || null;
    },

    _resumeSyncIfNeeded() {
      if (openModals.size > 0) return;

      if (HEYS.cloud?.resumeSync && syncState.token) {
        HEYS.cloud.resumeSync(syncState.token);
      }
      syncState.token = null;

      if (HEYS.Day?.getBlockUntil && HEYS.Day?.setBlockCloudUpdates && syncState.dayBlockUntil) {
        const currentBlock = HEYS.Day.getBlockUntil() || 0;
        if (currentBlock >= syncState.dayBlockUntil - 50) {
          HEYS.Day.setBlockCloudUpdates(Date.now());
        }
      }
      syncState.dayBlockUntil = 0;
    }
  };

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.ModalManager = ModalManager;

  // Debug helper
  if (typeof window !== 'undefined') {
    window.debugModals = () => {
      console.table({
        '–û—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª–æ–∫': openModals.size,
        '–°–ø–∏—Å–æ–∫': Array.from(openModals).join(', ') || '–Ω–µ—Ç'
      });
    };
  }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_step_modal_v1.js ===== */
// heys_step_modal_v1.js ‚Äî –ú–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–¥–∞–ª–æ–∫ —Å —à–∞–≥–∞–º–∏
// –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —à–∞–≥–∏: –≤–µ—Å, —Å–æ–Ω, —à–∞–≥–∏, –≤–æ–¥–∞ –∏ –¥—Ä.
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const { useState, useMemo, useEffect, useCallback, useRef, useContext, createContext } = React;

  // === –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ ===
  const StepModalContext = createContext({});

  // === –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ steps/meal_step) ===

  // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è localStorage —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π clientId namespace
  const U = () => HEYS.utils || {};

  function lsGet(key, def) {
    const utils = U();
    if (utils.lsGet) return utils.lsGet(key, def);
    try {
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : def;
    } catch { return def; }
  }

  function lsSet(key, val) {
    const utils = U();
    if (utils.lsSet) {
      utils.lsSet(key, val);
    } else {
      localStorage.setItem(key, JSON.stringify(val));
    }
  }

  function getTodayKey() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º ¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é¬ª –¥–∞—Ç—É (–¥–æ 03:00 —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–µ–Ω—å –µ—â—ë –ø—Ä–µ–¥—ã–¥—É—â–∏–π)
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: dayUtils.todayISO ‚Üí models.todayISO ‚Üí fallback –Ω–∞ ISO –±–µ–∑ —Å–º–µ—â–µ–Ω–∏—è
    const dayUtils = HEYS.dayUtils || {};
    if (typeof dayUtils.todayISO === 'function') return dayUtils.todayISO();
    if (HEYS.models && typeof HEYS.models.todayISO === 'function') return HEYS.models.todayISO();
    return new Date().toISOString().slice(0, 10);
  }

  function getCurrentHour() {
    return new Date().getHours();
  }

  function getTimeBasedGreeting() {
    const hour = getCurrentHour();
    if (hour >= 5 && hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ‚òÄÔ∏è';
    if (hour >= 12 && hour < 17) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å! üå§Ô∏è';
    if (hour >= 17 && hour < 22) return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä! üåô';
    return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏! üåå';
  }

  function getDailyTip() {
    const tips = [
      'üí° –í–∑–≤–µ—à–∏–≤–∞–π—Ç–µ—Å—å –≤ –æ–¥–Ω–æ –≤—Ä–µ–º—è –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏',
      'üåä –°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã —É—Ç—Ä–æ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
      'üç≥ –ë–µ–ª–æ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫ = –º–µ–Ω—å—à–µ –≥–æ–ª–æ–¥–∞ –¥–Ω—ë–º',
      'üö∂ 10 –º–∏–Ω—É—Ç –ø—Ä–æ–≥—É–ª–∫–∏ –ø–æ—Å–ª–µ –µ–¥—ã –ø–æ–º–æ–≥–∞—é—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—é',
      'üò¥ –°–æ–Ω 7-8 —á–∞—Å–æ–≤ = –º–µ–Ω—å—à–µ —Ç—è–≥–∏ –∫ —Å–ª–∞–¥–∫–æ–º—É',
      'ü•ó –û–≤–æ—â–∏ –≤ –∫–∞–∂–¥—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ',
      '‚è∞ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é',
      'üí™ –ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å!',
      'üéØ –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º',
      '‚ú® –í—ã —É–∂–µ –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –∑–¥–æ—Ä–æ–≤—å–µ–º!'
    ];
    const dayOfWeek = new Date().getDay();
    return tips[dayOfWeek % tips.length];
  }

  function getCurrentStreak() {
    try {
      const utils = HEYS.utils || {};
      if (typeof utils.safeGetStreak === 'function') {
        return utils.safeGetStreak();
      }
      const U = HEYS.utils || {};
      let streak = 0;
      const today = new Date();
      for (let i = 1; i <= 30; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0, 10);
        const dayData = U.lsGet ? U.lsGet(`heys_dayv2_${key}`, {}) : {};
        if (dayData.meals && dayData.meals.length > 0) {
          streak++;
        } else {
          break;
        }
      }
      return streak;
    } catch (e) {
      return 0;
    }
  }

  // === AutoFitText ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ ===
  function AutoFitText({ text, className, minFontSize = 10, maxFontSize = 16, style = {} }) {
    const containerRef = useRef(null);
    const textRef = useRef(null);
    const [fontSize, setFontSize] = useState(maxFontSize);

    useEffect(() => {
      const container = containerRef.current;
      const textEl = textRef.current;
      if (!container || !textEl) return;

      // –ù–∞—á–∏–Ω–∞–µ–º —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
      let currentSize = maxFontSize;
      textEl.style.fontSize = `${currentSize}px`;

      // –£–º–µ–Ω—å—à–∞–µ–º –ø–æ–∫–∞ —Ç–µ–∫—Å—Ç –Ω–µ –≤–ª–µ–∑–µ—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      const containerWidth = container.offsetWidth;
      while (textEl.offsetWidth > containerWidth && currentSize > minFontSize) {
        currentSize -= 0.5;
        textEl.style.fontSize = `${currentSize}px`;
      }

      setFontSize(currentSize);
    }, [text, maxFontSize, minFontSize]);

    return React.createElement('div', {
      ref: containerRef,
      className: className + '-container',
      style: {
        width: '100%',
        overflow: 'hidden',
        display: 'flex',
        justifyContent: 'center'
      }
    },
      React.createElement('span', {
        ref: textRef,
        className,
        style: {
          ...style,
          fontSize: `${fontSize}px`,
          whiteSpace: 'nowrap'
        }
      }, text)
    );
  }

  // === WheelPicker (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π) ===
  function WheelPicker({ values, value, onChange, label, suffix = '', currentSuffix = null, formatValue = null, wrap = true, height = null, compact = false }) {
    const containerRef = useRef(null);
    const currentIndex = values.indexOf(value);
    const len = values.length;
    // currentSuffix ‚Äî –µ–¥–∏–Ω–∏—Ü—ã –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–∫–≥, —á), suffix ‚Äî –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
    const displaySuffix = currentSuffix !== null ? currentSuffix : suffix;
    // formatValue ‚Äî —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ –Ω—É–ª—è)
    const fmt = formatValue || ((v) => v);

    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º (3 –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ 5)
    const showFar = !compact && !height;

    // –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
    const wrapIndex = (i) => ((i % len) + len) % len;

    // Wheel scroll event (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ)
    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º preventDefault ‚Äî React –∏—Å–ø–æ–ª—å–∑—É–µ—Ç passive listeners
    const handleWheel = useCallback((e) => {
      const direction = e.deltaY > 0 ? 1 : -1;
      let newIndex;
      if (wrap) {
        newIndex = wrapIndex(currentIndex + direction);
      } else {
        newIndex = Math.max(0, Math.min(len - 1, currentIndex + direction));
      }
      if (newIndex !== currentIndex) {
        onChange(values[newIndex]);
      }
    }, [values, currentIndex, onChange, wrap, len]);

    // Touch drag
    const touchState = useRef({ active: false, startY: 0, startIndex: 0 });

    const handleTouchStart = useCallback((e) => {
      touchState.current = {
        active: true,
        startY: e.touches[0].clientY,
        startIndex: currentIndex
      };
    }, [currentIndex]);

    const handleTouchMove = useCallback((e) => {
      if (!touchState.current.active) return;
      // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º preventDefault - —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É passive listener
      const deltaY = touchState.current.startY - e.touches[0].clientY;
      const steps = Math.round(deltaY / 30);
      let newIndex;
      if (wrap) {
        newIndex = wrapIndex(touchState.current.startIndex + steps);
      } else {
        newIndex = Math.max(0, Math.min(len - 1, touchState.current.startIndex + steps));
      }
      if (newIndex !== currentIndex) {
        onChange(values[newIndex]);
      }
    }, [values, currentIndex, onChange, wrap, len]);

    const handleTouchEnd = useCallback(() => {
      touchState.current.active = false;
    }, []);

    // Click –Ω–∞ —Å–æ—Å–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (—Å —Ü–∏–∫–ª–æ–º)
    const handleClickPrev = useCallback(() => {
      const newIndex = wrap ? wrapIndex(currentIndex - 1) : Math.max(0, currentIndex - 1);
      if (newIndex !== currentIndex) onChange(values[newIndex]);
    }, [values, currentIndex, onChange, wrap]);

    const handleClickNext = useCallback(() => {
      const newIndex = wrap ? wrapIndex(currentIndex + 1) : Math.min(len - 1, currentIndex + 1);
      if (newIndex !== currentIndex) onChange(values[newIndex]);
    }, [values, currentIndex, onChange, wrap, len]);

    const handleClickPrev2 = useCallback(() => {
      const newIndex = wrap ? wrapIndex(currentIndex - 2) : Math.max(0, currentIndex - 2);
      if (newIndex !== currentIndex) onChange(values[newIndex]);
    }, [values, currentIndex, onChange, wrap]);

    const handleClickNext2 = useCallback(() => {
      const newIndex = wrap ? wrapIndex(currentIndex + 2) : Math.min(len - 1, currentIndex + 2);
      if (newIndex !== currentIndex) onChange(values[newIndex]);
    }, [values, currentIndex, onChange, wrap, len]);

    // –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å —Ü–∏–∫–ª–æ–º)
    const prev2Index = wrap ? wrapIndex(currentIndex - 2) : Math.max(0, currentIndex - 2);
    const prevIndex = wrap ? wrapIndex(currentIndex - 1) : Math.max(0, currentIndex - 1);
    const nextIndex = wrap ? wrapIndex(currentIndex + 1) : Math.min(len - 1, currentIndex + 1);
    const next2Index = wrap ? wrapIndex(currentIndex + 2) : Math.min(len - 1, currentIndex + 2);

    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Å–æ—Å–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –Ω–µ-—Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Å–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∞—è)
    const showPrev2 = (wrap || currentIndex > 1) && showFar;
    const showPrev = wrap || currentIndex > 0;
    const showNext = wrap || currentIndex < len - 1;
    const showNext2 = (wrap || currentIndex < len - 2) && showFar;

    // –°—Ç–∏–ª—å –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    const containerStyle = height ? { height: `${height}px` } : {};
    const compactClass = (compact || height) ? 'mc-wheel-picker--compact' : '';

    return React.createElement('div', {
      className: `mc-wheel-picker ${compactClass}`.trim(),
      ref: containerRef,
      style: containerStyle,
      onTouchStart: handleTouchStart,
      onTouchMove: handleTouchMove,
      onTouchEnd: handleTouchEnd,
      onWheel: handleWheel
    },
      React.createElement('div', { className: 'mc-wheel-label' }, label),
      React.createElement('div', { className: 'mc-wheel-values' },
        // Far prev (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ compact)
        showFar && React.createElement('div', {
          className: 'mc-wheel-value mc-wheel-value--far',
          onClick: handleClickPrev2
        }, showPrev2 ? fmt(values[prev2Index]) + suffix : ''),
        // Prev
        React.createElement('div', {
          className: 'mc-wheel-value mc-wheel-value--prev',
          onClick: handleClickPrev
        }, showPrev ? fmt(values[prevIndex]) + suffix : ''),
        // Current
        React.createElement('div', { className: 'mc-wheel-value mc-wheel-value--current' },
          fmt(value),
          displaySuffix && React.createElement('span', { className: 'mc-wheel-suffix' }, displaySuffix)
        ),
        // Next
        React.createElement('div', {
          className: 'mc-wheel-value mc-wheel-value--next',
          onClick: handleClickNext
        }, showNext ? fmt(values[nextIndex]) + suffix : ''),
        // Far next (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ compact)
        showFar && React.createElement('div', {
          className: 'mc-wheel-value mc-wheel-value--far',
          onClick: handleClickNext2
        }, showNext2 ? fmt(values[next2Index]) + suffix : '')
      )
    );
  }

  // === TimePicker ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ ===
  /**
   * –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∏–∫–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã:–º–∏–Ω—É—Ç—ã)
   * @param {Object} props
   * @param {number} props.hours - –ó–Ω–∞—á–µ–Ω–∏–µ —á–∞—Å–æ–≤ (0-23)
   * @param {number} props.minutes - –ó–Ω–∞—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç (0-55, —à–∞–≥ 5)
   * @param {function} props.onHoursChange - Callback –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–∞—Å–æ–≤
   * @param {function} props.onMinutesChange - Callback –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∏–Ω—É—Ç
   * @param {string} [props.hoursLabel='–ß–ê–°–´'] - –ü–æ–¥–ø–∏—Å—å –Ω–∞–¥ —á–∞—Å–∞–º–∏
   * @param {string} [props.minutesLabel='–ú–ò–ù–£–¢–´'] - –ü–æ–¥–ø–∏—Å—å –Ω–∞–¥ –º–∏–Ω—É—Ç–∞–º–∏
   * @param {boolean} [props.wrap=true] - –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
   * @param {boolean} [props.compact=false] - –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º (3 –∑–Ω–∞—á–µ–Ω–∏—è)
   * @param {string} [props.className=''] - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
   * @param {number[]} [props.hoursValues] - –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Å—Å–∏–≤ —á–∞—Å–æ–≤
   * @param {number[]} [props.minutesValues] - –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Å—Å–∏–≤ –º–∏–Ω—É—Ç
   * @param {string} [props.display] - –§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–≤–µ—Ä—Ö—É ('HH:MM' –∏–ª–∏ null)
   */
  const DEFAULT_HOURS = Array.from({ length: 24 }, (_, i) => i);
  const DEFAULT_MINUTES = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
  const pad2 = (v) => String(v).padStart(2, '0');

  function TimePicker({
    hours,
    minutes,
    onHoursChange,
    onMinutesChange,
    onTimeChange, // üÜï –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll: (newHours, newMinutes) => void
    hoursLabel = '–ß–ê–°–´',
    minutesLabel = '–ú–ò–ù–£–¢–´',
    wrap = true,
    compact = false,
    className = '',
    hoursValues = DEFAULT_HOURS,
    minutesValues = DEFAULT_MINUTES,
    display = 'HH:MM',
    linkedScroll = true, // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–∏–Ω—É—Ç —á–µ—Ä–µ–∑ –≥—Ä–∞–Ω–∏—Ü—É –º–µ–Ω—è—Ç—å —á–∞—Å
    haptic = true // –í–∫–ª—é—á–∏—Ç—å haptic feedback
  }) {
    // Haptic feedback helper
    const triggerHaptic = React.useCallback((intensity = 5) => {
      if (!haptic) return;
      if (navigator.vibrate) navigator.vibrate(intensity);
    }, [haptic]);

    // Ref –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –º–∏–Ω—É—Ç ‚Äî –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ!
    // –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ handleMinutesChange –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    const prevMinutesRef = useRef(minutes);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∞—Å–æ–≤ —Å haptic
    const handleHoursChange = React.useCallback((newHours) => {
      triggerHaptic(5);
      onHoursChange(newHours);
    }, [onHoursChange, triggerHaptic]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∏–Ω—É—Ç —Å —É—á—ë—Ç–æ–º overflow –Ω–∞ —á–∞—Å
    const handleMinutesChange = React.useCallback((newMinutes) => {
      const prevMin = prevMinutesRef.current;

      // –ï—Å–ª–∏ linkedScroll –≤–∫–ª—é—á—ë–Ω –∏ wrap=true ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –≥—Ä–∞–Ω–∏—Ü—É
      if (linkedScroll && wrap) {
        const maxMinute = minutesValues[minutesValues.length - 1]; // 55
        const minMinute = minutesValues[0]; // 0

        // 55 ‚Üí 0: –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–ø–µ—Ä—ë–¥ —á–µ—Ä–µ–∑ –≥—Ä–∞–Ω–∏—Ü—É ‚Üí —á–∞—Å +1
        if (prevMin === maxMinute && newMinutes === minMinute) {
          const currentHourIndex = hoursValues.indexOf(hours);
          const newHourIndex = (currentHourIndex + 1) % hoursValues.length;
          const newHour = hoursValues[newHourIndex];

          // –û–±–Ω–æ–≤–ª—è–µ–º ref –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º callback
          prevMinutesRef.current = newMinutes;
          triggerHaptic(10); // –£—Å–∏–ª–µ–Ω–Ω—ã–π haptic –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —á–∞—Å–∞

          // –ï—Å–ª–∏ –µ—Å—Ç—å onTimeChange ‚Äî –≤—ã–∑—ã–≤–∞–µ–º –µ–≥–æ (–æ–¥–∏–Ω –≤—ã–∑–æ–≤ = –Ω–µ—Ç batching –ø—Ä–æ–±–ª–µ–º—ã)
          if (onTimeChange) {
            onTimeChange(newHour, newMinutes);
            return;
          }
          // Fallback: —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ callbacks
          onHoursChange(newHour);
          onMinutesChange(newMinutes);
          return;
        }
        // 0 ‚Üí 55: –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞–∑–∞–¥ —á–µ—Ä–µ–∑ –≥—Ä–∞–Ω–∏—Ü—É ‚Üí —á–∞—Å -1
        else if (prevMin === minMinute && newMinutes === maxMinute) {
          const currentHourIndex = hoursValues.indexOf(hours);
          const newHourIndex = (currentHourIndex - 1 + hoursValues.length) % hoursValues.length;
          const newHour = hoursValues[newHourIndex];

          // –û–±–Ω–æ–≤–ª—è–µ–º ref –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º callback
          prevMinutesRef.current = newMinutes;
          triggerHaptic(10); // –£—Å–∏–ª–µ–Ω–Ω—ã–π haptic –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —á–∞—Å–∞

          // –ï—Å–ª–∏ –µ—Å—Ç—å onTimeChange ‚Äî –≤—ã–∑—ã–≤–∞–µ–º –µ–≥–æ (–æ–¥–∏–Ω –≤—ã–∑–æ–≤ = –Ω–µ—Ç batching –ø—Ä–æ–±–ª–µ–º—ã)
          if (onTimeChange) {
            onTimeChange(newHour, newMinutes);
            return;
          }
          // Fallback: —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ callbacks
          onHoursChange(newHour);
          onMinutesChange(newMinutes);
          return;
        }
      }

      // –û–±—ã—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∏–Ω—É—Ç (–±–µ–∑ overflow)
      prevMinutesRef.current = newMinutes;
      triggerHaptic(5);
      onMinutesChange(newMinutes);
    }, [onMinutesChange, onHoursChange, onTimeChange, hoursValues, minutesValues, linkedScroll, wrap, hours, triggerHaptic]);

    return React.createElement('div', { className: `mc-time-picker ${className}`.trim() },
      // –î–∏—Å–ø–ª–µ–π –≤—Ä–µ–º–µ–Ω–∏ —Å–≤–µ—Ä—Ö—É
      display && React.createElement('div', { className: 'mc-time-display' },
        React.createElement('span', { className: 'mc-time-display-value' },
          `${pad2(hours)}:${pad2(minutes)}`
        )
      ),
      // –ü–æ–¥–ø–∏—Å–∏ (—Å–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ)
      (hoursLabel || minutesLabel) && React.createElement('div', { className: 'mc-time-labels' },
        React.createElement('span', { className: 'mc-time-label' }, hoursLabel),
        React.createElement('span', { className: 'mc-time-label' }, minutesLabel)
      ),
      // –ü–∏–∫–µ—Ä—ã
      React.createElement('div', { className: 'mc-time-pickers' },
        React.createElement(WheelPicker, {
          values: hoursValues,
          value: hours,
          onChange: handleHoursChange, // –° haptic
          label: '',
          formatValue: pad2,
          wrap,
          compact
        }),
        React.createElement('span', { className: 'mc-time-sep' }, ':'),
        React.createElement(WheelPicker, {
          values: minutesValues,
          value: minutes,
          onChange: handleMinutesChange, // –° haptic + linkedScroll
          label: '',
          formatValue: pad2,
          wrap,
          compact
        })
      )
    );
  }

  // === –†–µ–µ—Å—Ç—Ä —à–∞–≥–æ–≤ ===
  const StepRegistry = {};;

  /**
   * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —à–∞–≥–∞
   * @param {string} id - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
   * @param {Object} config - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —à–∞–≥–∞
   */
  function registerStep(id, config) {
    StepRegistry[id] = {
      id,
      title: config.title || id,
      hint: config.hint || '',
      icon: config.icon || 'üìã',
      component: config.component,
      shouldShow: config.shouldShow || null,
      getInitialData: config.getInitialData || (() => ({})),
      validate: config.validate || (() => true),
      save: config.save || (() => { }),
      canSkip: config.canSkip || false,
      nextLabel: config.nextLabel || null,  // –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–î–∞–ª–µ–µ"/"–ì–æ—Ç–æ–≤–æ"
      hideHeaderNext: config.hideHeaderNext || false,  // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –≤ —Ö–µ–¥–µ—Ä–µ
    };
  }

  // === StepModal ‚Äî –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ===
  function StepModal({
    steps = [],
    onComplete,
    onClose,
    initialStep = 0,
    showProgress = true,
    showStreak = true,
    showGreeting = true,
    showTip = true,
    title = null,
    allowSwipe = true,
    allowSkip = false,
    context = {}, // –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è getInitialData (–Ω–∞–ø—Ä–∏–º–µ—Ä, dateKey)
    hidePrimaryOnFirst = false,
    finishLabel = '–ì–æ—Ç–æ–≤–æ' // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–ì–æ—Ç–æ–≤–æ")
  }) {
    const [currentStepIndex, setCurrentStepIndex] = useState(initialStep);
    const [animating, setAnimating] = useState(false);
    const [slideDirection, setSlideDirection] = useState(null);
    const [stepData, setStepData] = useState({});
    const [validationError, setValidationError] = useState(false);
    const [validationMessage, setValidationMessage] = useState(null);
    const [slideInDirection, setSlideInDirection] = useState(null); // –î–ª—è shake-–∞–Ω–∏–º–∞—Ü–∏–∏
    const containerRef = useRef(null);
    const touchStartX = useRef(0);
    const touchStartY = useRef(0);

    const contextKey = useMemo(() => JSON.stringify(context), [context]);

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —à–∞–≥–æ–≤
    const stepConfigs = useMemo(() => {
      return steps.map(stepId => {
        if (typeof stepId === 'string') {
          return StepRegistry[stepId];
        }
        // Inline step config
        return stepId;
      }).filter(Boolean);
    }, [steps]);

    const visibleStepConfigs = useMemo(() => {
      return stepConfigs.filter(config => {
        if (!config) return false;
        if (typeof config.shouldShow !== 'function') return true;
        try {
          return config.shouldShow(context);
        } catch (e) {
          console.warn('[StepModal] shouldShow error:', config.id, e);
          return true;
        }
      });
    }, [stepConfigs, contextKey]);

    const totalSteps = visibleStepConfigs.length;
    const currentConfig = visibleStepConfigs[currentStepIndex];

    // –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const greeting = useMemo(() => getTimeBasedGreeting(), []);
    const dailyTip = useMemo(() => getDailyTip(), []);
    const currentStreak = useMemo(() => getCurrentStreak(), []);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤ (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ context)
    const lastContextKeyRef = useRef(null);

    useEffect(() => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ context –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
      if (lastContextKeyRef.current === contextKey) return;
      lastContextKeyRef.current = contextKey;

      const initialData = {};
      visibleStepConfigs.forEach(config => {
        if (config.getInitialData) {
          // –ü–µ—Ä–µ–¥–∞—ë–º context –∏ —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö —à–∞–≥–æ–≤
          initialData[config.id] = config.getInitialData(context, initialData);
        }
      });
      setStepData(initialData);
    }, [contextKey, visibleStepConfigs]);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–∞
    const updateStepData = useCallback((stepId, data) => {
      setStepData(prev => ({
        ...prev,
        [stepId]: data // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —à–∞–≥–∞ (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç)
      }));
    }, []);

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    const goToStep = useCallback((newIndex, direction) => {
      if (animating || newIndex < 0 || newIndex >= totalSteps) return;

      setSlideDirection(direction);
      setAnimating(true);

      setTimeout(() => {
        setCurrentStepIndex(newIndex);
        setSlideDirection(null);
        // –ó–∞–ø—É—Å–∫–∞–µ–º slide-in –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —à–∞–≥–∞
        setSlideInDirection(direction === 'left' ? 'from-right' : 'from-left');
        setAnimating(false);
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º slide-in –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => setSlideInDirection(null), 250);
      }, 200);
    }, [animating, totalSteps]);

    const handleNext = useCallback(() => {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
      if (currentConfig.validate && !currentConfig.validate(stepData[currentConfig.id], stepData)) {
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        const errorMsg = currentConfig.getValidationMessage
          ? currentConfig.getValidationMessage(stepData[currentConfig.id], stepData)
          : null;
        setValidationMessage(errorMsg);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º shake-–∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
        setValidationError(true);
        // Haptic feedback –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        setTimeout(() => {
          setValidationError(false);
          setValidationMessage(null);
        }, 2500);
        return;
      }

      if (currentStepIndex < totalSteps - 1) {
        goToStep(currentStepIndex + 1, 'left');
      } else {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        visibleStepConfigs.forEach(config => {
          if (config.save) {
            // –ü–µ—Ä–µ–¥–∞—ë–º: –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞, context, –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —à–∞–≥–æ–≤
            config.save(stepData[config.id], context, stepData);
          }
        });

        // XP –∑–∞ —á–µ–∫-–∏–Ω
        if (HEYS.gamification) {
          try {
            visibleStepConfigs.forEach(config => {
              if (config.xpAction) {
                HEYS.gamification.addXP(config.xpAction);
              }
            });
          } catch (e) {
            console.warn('Gamification XP error:', e);
          }
        }

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ù–ï MealStep ‚Äî –æ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∞–º)
        // MealStep —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–Ω—è —á–µ—Ä–µ–∑ onComplete
        if (!visibleStepConfigs.some(c => c.id === 'mealName' || c.id === 'mealTime')) {
          window.dispatchEvent(new CustomEvent('heys:day-updated', {
            detail: { date: getTodayKey(), source: 'step-modal' }
          }));
        }

        onComplete && onComplete(stepData);
      }
    }, [currentStepIndex, totalSteps, currentConfig, stepData, visibleStepConfigs, goToStep, onComplete]);

    const handlePrev = useCallback(() => {
      if (currentStepIndex > 0) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ —à–∞–≥–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥
        let prevIndex = currentStepIndex - 1;
        while (prevIndex > 0 && visibleStepConfigs[prevIndex]?.hidden) {
          prevIndex--;
        }
        goToStep(prevIndex, 'right');
      }
    }, [currentStepIndex, goToStep, visibleStepConfigs]);

    // Swipe handlers ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º allowSwipe –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ —à–∞–≥–∞
    const stepAllowSwipe = currentConfig?.allowSwipe !== false && allowSwipe;

    const handleTouchStart = useCallback((e) => {
      if (!stepAllowSwipe) return;

      // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º touch –Ω–∞ —Å–ª–∞–π–¥–µ—Ä–∞—Ö ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç –∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
      const isRangeInput = e.target.tagName === 'INPUT' && e.target.type === 'range';
      const hasRangeParent = e.target.closest && e.target.closest('input[type="range"]');
      const isOnSlider = e.target.closest && e.target.closest('.mc-quality-slider, .mood-rating-card input[type="range"]');

      if (isRangeInput || hasRangeParent || isOnSlider) {
        return;
      }

      touchStartX.current = e.touches[0].clientX;
      touchStartY.current = e.touches[0].clientY;
    }, [stepAllowSwipe, currentConfig]);

    // –ë–ª–æ–∫–∏—Ä—É–µ–º scroll –Ω–∞ backdrop, —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ scrollable –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º useEffect –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å { passive: false }, –∏–Ω–∞—á–µ preventDefault() –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    useEffect(() => {
      const container = containerRef.current;
      if (!container) return;

      const handleTouchMove = (e) => {
        // –†–∞–∑—Ä–µ—à–∞–µ–º touch –Ω–∞ range inputs (—Å–ª–∞–π–¥–µ—Ä–∞—Ö) ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        const isRangeInput = e.target.tagName === 'INPUT' && e.target.type === 'range';
        const hasRangeClass = e.target.classList && e.target.classList.contains('mc-quality-slider');
        const closestRange = e.target.closest ? e.target.closest('input[type="range"]') : null;
        const closestSliderClass = e.target.closest ? e.target.closest('.mc-quality-slider') : null;
        const closestMoodCard = e.target.closest ? e.target.closest('.mood-rating-card') : null;

        // –†–∞–∑—Ä–µ—à–∞–µ–º touch –Ω–∞ wheel picker (–¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏)
        const closestWheelPicker = e.target.closest ? e.target.closest('.mc-wheel-picker') : null;

        // –ï—Å–ª–∏ —ç—Ç–æ —Å–ª–∞–π–¥–µ—Ä –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ mood-rating-card –∏–ª–∏ wheel-picker ‚Äî –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º
        if (isRangeInput || hasRangeClass || closestRange || closestSliderClass || closestMoodCard || closestWheelPicker) {
          return;
        }

        // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π scrollable —ç–ª–µ–º–µ–Ω—Ç
        let target = e.target;
        while (target && target !== container) {
          const style = window.getComputedStyle(target);
          const overflowY = style.overflowY;
          const isScrollable = overflowY === 'auto' || overflowY === 'scroll';

          if (isScrollable && target.scrollHeight > target.clientHeight) {
            // –≠—Ç–æ scrollable –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º scroll
            return;
          }
          target = target.parentElement;
        }

        // –ù–µ –≤–Ω—É—Ç—Ä–∏ scrollable ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º scroll –Ω–∞ backdrop
        console.log('[TouchMove NATIVE] BLOCKED ‚Äî –≤—ã–∑—ã–≤–∞–µ–º preventDefault');
        e.preventDefault();
      };

      container.addEventListener('touchmove', handleTouchMove, { passive: false });
      return () => container.removeEventListener('touchmove', handleTouchMove);
    }, []);

    const handleTouchEnd = useCallback((e) => {
      if (!stepAllowSwipe) return;

      // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–≤–∞–π–ø –Ω–∞ —Å–ª–∞–π–¥–µ—Ä–∞—Ö ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç –∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
      const isRangeInput = e.target.tagName === 'INPUT' && e.target.type === 'range';
      const isOnSlider = e.target.closest && e.target.closest('.mc-quality-slider, .mood-rating-card input[type="range"]');
      if (isRangeInput || isOnSlider) {
        return;
      }

      const deltaX = e.changedTouches[0].clientX - touchStartX.current;
      const deltaY = e.changedTouches[0].clientY - touchStartY.current;

      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
        if (deltaX < 0 && currentStepIndex < totalSteps - 1) {
          goToStep(currentStepIndex + 1, 'left');
        } else if (deltaX > 0 && currentStepIndex > 0) {
          goToStep(currentStepIndex - 1, 'right');
        }
      }
    }, [stepAllowSwipe, currentStepIndex, totalSteps, goToStep, currentConfig]);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ
    const handleClose = useCallback(() => {
      onClose && onClose();
    }, [onClose]);

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–≥–æ–≤
    const contextValue = useMemo(() => ({
      stepData,
      updateStepData,
      currentStepIndex,
      totalSteps,
      goToStep
    }), [stepData, updateStepData, currentStepIndex, totalSteps, goToStep]);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ backdrop (–≤–Ω–µ –º–æ–¥–∞–ª–∫–∏)
    const handleBackdropClick = useCallback((e) => {
      if (e.target.classList.contains('mc-backdrop') && onClose) {
        onClose();
      }
    }, [onClose]);

    if (!currentConfig) {
      return null;
    }

    const slideClass = slideDirection === 'left' ? 'mc-slide-left' :
      slideDirection === 'right' ? 'mc-slide-right' :
        slideInDirection === 'from-right' ? 'mc-slide-in-right' :
          slideInDirection === 'from-left' ? 'mc-slide-in-left' : '';

    const StepComponent = currentConfig.component;

    const headerRightContent = typeof context.headerRight === 'function'
      ? context.headerRight({
        stepData,
        currentConfig,
        currentStepIndex,
        totalSteps,
        context,
        goToStep // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —à–∞–≥–∏
      })
      : context.headerRight;

    return React.createElement(StepModalContext.Provider, { value: contextValue },
      React.createElement('div', {
        className: 'mc-backdrop',
        ref: containerRef,
        onClick: handleBackdropClick,
        onTouchStart: handleTouchStart,
        onTouchEnd: handleTouchEnd
      },
        React.createElement('div', { className: 'mc-modal' },
          // Header ‚Äî iOS-style —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞
          React.createElement('div', { className: 'mc-header mc-header--nav' },
            // –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ù–∞–∑–∞–¥ –∏–ª–∏ –ó–∞–∫—Ä—ã—Ç—å
            React.createElement('div', { className: 'mc-header-left' },
              currentStepIndex > 0
                ? React.createElement('button', {
                  className: 'mc-header-btn mc-header-btn--back',
                  onClick: handlePrev
                }, '‚Üê –ù–∞–∑–∞–¥')
                : onClose && React.createElement('button', {
                  className: 'mc-header-btn mc-header-btn--close',
                  onClick: handleClose,
                  'aria-label': '–ó–∞–∫—Ä—ã—Ç—å'
                }, '√ó')
            ),

            // –¶–µ–Ω—Ç—Ä: Title –∏–ª–∏ —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
            React.createElement('div', { className: 'mc-header-center' },
              context.headerExtra
                ? context.headerExtra
                : (currentConfig.title || currentConfig.hint) && React.createElement('div', { className: 'mc-header-titles' },
                  currentConfig.title && React.createElement(AutoFitText, {
                    className: 'mc-header-title',
                    text: `${currentConfig.icon || ''} ${currentConfig.title}`.trim(),
                    maxFontSize: 16,
                    minFontSize: 11
                  }),
                  currentConfig.hint && React.createElement(AutoFitText, {
                    className: 'mc-header-hint',
                    text: currentConfig.hint,
                    maxFontSize: 12,
                    minFontSize: 9
                  })
                )
            ),

            // –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: headerRight –ò–õ–ò –∫–Ω–æ–ø–∫–∞ –ì–æ—Ç–æ–≤–æ/–î–∞–ª–µ–µ
            // headerRight ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å–ø—Ä–∞–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
            // finishLabel ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —à–∞–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–î–æ–±–∞–≤–∏—Ç—å")
            // currentConfig.nextLabel ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–∞–≥–∞
            React.createElement('div', { className: 'mc-header-right' },
              headerRightContent
                ? React.createElement('span', { className: 'mc-header-right-text' }, headerRightContent)
                : (!(hidePrimaryOnFirst && currentStepIndex === 0) && !currentConfig.hideHeaderNext && React.createElement('button', {
                  className: 'mc-header-btn mc-header-btn--primary',
                  onClick: handleNext
                }, currentStepIndex === totalSteps - 1
                  ? (currentConfig.nextLabel || finishLabel)
                  : (currentConfig.nextLabel || '–î–∞–ª–µ–µ')))
            )
          ),

          // Progress dots (–∫—Ä—É–∂–æ—á–∫–∏) ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
          // –°–∫—Ä—ã—Ç—ã–µ —à–∞–≥–∏ (hidden: true) –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ progress
          showProgress && totalSteps > 1 && React.createElement('div', { className: 'mc-progress-dots' },
            visibleStepConfigs.map((config, i) =>
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ —à–∞–≥–∏
              config.hidden ? null : React.createElement('button', {
                key: i,
                className: 'mc-progress-dot' + (i === currentStepIndex ? ' active' : '') + (i < currentStepIndex ? ' completed' : ''),
                onClick: () => {
                  if (i !== currentStepIndex) {
                    goToStep(i, i > currentStepIndex ? 'left' : 'right');
                  }
                },
                'aria-label': `–®–∞–≥ ${i + 1}`
              })
            )
          ),

          // Step content
          React.createElement('div', {
            className: `mc-step-content ${slideClass}${validationError ? ' mc-validation-error' : ''}`
          },
            StepComponent && React.createElement(StepComponent, {
              data: stepData[currentConfig.id] || {},
              onChange: (data) => updateStepData(currentConfig.id, data),
              stepData: stepData,
              context: { ...context, onNext: handleNext, onClose: handleClose }  // –ü–µ—Ä–µ–¥–∞—ë–º onNext –∏ onClose –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            })
          ),

          // Validation message
          validationMessage && React.createElement('div', { className: 'mc-validation-message' },
            React.createElement('span', { className: 'mc-validation-icon' }, '‚ö†Ô∏è'),
            React.createElement('span', null, validationMessage)
          ),

          // Skip button (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à—ë–Ω –ø—Ä–æ–ø—É—Å–∫) ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–Ω–∏–∑—É
          allowSkip && currentStepIndex < totalSteps - 1 && React.createElement('div', { className: 'mc-buttons mc-buttons--skip-only' },
            React.createElement('button', {
              className: 'mc-btn mc-btn--ghost',
              onClick: () => goToStep(currentStepIndex + 1, 'left')
            }, '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å')
          ),

          // Daily tip
          showTip && React.createElement('div', { className: 'mc-tip' }, dailyTip)
        )
      )
    );
  }

  // === API –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ ===
  let modalRoot = null;
  let modalRootInstance = null; // React 18 createRoot instance
  let currentModalElement = null;
  let savedScrollY = 0; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
  let modalCleanup = null; // Cleanup —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è ModalManager

  function showStepModal(options) {
    // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –Ω–µ—Ç
    if (!modalRoot) {
      modalRoot = document.createElement('div');
      modalRoot.id = 'heys-step-modal-root';
      document.body.appendChild(modalRoot);
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ ModalManager
    if (HEYS.ModalManager) {
      modalCleanup = HEYS.ModalManager.register('step-modal', () => {
        hideStepModal({ skipManagerNotify: true });
      });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
    savedScrollY = window.scrollY;

    // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ (–±–µ–∑ position:fixed —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª —Ñ–æ–Ω)
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    const handleComplete = (data) => {
      // –î–ª—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –¥–Ω–µ–≤–Ω–∏–∫—É
      hideStepModal({ scrollToDiary: options.scrollToDiary !== false });
      options.onComplete && options.onComplete(data);
    };

    const handleClose = () => {
      // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∂–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –¥–Ω–µ–≤–Ω–∏–∫—É
      hideStepModal({ scrollToDiary: options.scrollToDiary !== false });
      options.onClose && options.onClose();
    };

    currentModalElement = React.createElement(StepModal, {
      ...options,
      onComplete: handleComplete,
      onClose: handleClose
    });

    // React 18: createRoot API
    if (!modalRootInstance) {
      modalRootInstance = ReactDOM.createRoot(modalRoot);
    }
    modalRootInstance.render(currentModalElement);
  }

  function hideStepModal(options = {}) {
    // üîì –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';

    // –î–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–∑ ModalManager (–µ—Å–ª–∏ –Ω–µ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
    if (modalCleanup && !options.skipManagerNotify) {
      modalCleanup();
      modalCleanup = null;
    }

    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ scrollToDiary ‚Äî –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∑–∞–≥–æ–ª–æ–≤–∫—É –¥–Ω–µ–≤–Ω–∏–∫–∞
    if (options.scrollToDiary) {
      requestAnimationFrame(() => {
        const heading = document.getElementById('diary-heading');
        if (heading) {
          heading.scrollIntoView({ behavior: 'auto', block: 'start' });
        }
      });
    }
    // –ò–Ω–∞—á–µ —Å–∫—Ä–æ–ª–ª –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ (–Ω–µ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å, —Ç.–∫. –º—ã –Ω–µ –º–µ–Ω—è–ª–∏ position)

    // React 18: unmount —á–µ—Ä–µ–∑ root instance
    if (modalRootInstance) {
      modalRootInstance.unmount();
      modalRootInstance = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–∫–∞–∑–∞
    }
    // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑ DOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è createRoot
    if (modalRoot && modalRoot.parentNode) {
      modalRoot.parentNode.removeChild(modalRoot);
      modalRoot = null;
    }
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.StepModal = {
    show: showStepModal,
    hide: hideStepModal,
    Component: StepModal,
    registerStep,
    registry: StepRegistry,
    WheelPicker,
    TimePicker,
    pad2,
    Context: StepModalContext,
    utils: {
      lsGet,
      lsSet,
      getTodayKey,
      getCurrentHour,
      getTimeBasedGreeting,
      getDailyTip,
      getCurrentStreak
    }
  };

  // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ —á—Ç–æ StepModal –≥–æ—Ç–æ–≤ (–≤ —Ç.—á. —Ç–µ —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å —Ä–∞–Ω—å—à–µ)
  try {
    document.dispatchEvent(new CustomEvent('heys-stepmodal-ready'));
    console.info('[HEYS.StepModal] ‚úÖ heys-stepmodal-ready dispatched');
  } catch (_) { }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_steps_v1.js ===== */
// heys_steps_v1.js ‚Äî –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —à–∞–≥–æ–≤ –¥–ª—è StepModal
// WeightStep, SleepTimeStep, SleepQualityStep, StepsGoalStep
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const { useState, useMemo, useCallback, useEffect, useRef } = React;

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ StepModal
  if (!HEYS.StepModal) {
    console.error('heys_steps_v1.js: HEYS.StepModal not found. Load heys_step_modal_v1.js first.');
    return;
  }

  const { WheelPicker, registerStep, utils } = HEYS.StepModal;
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –∏–∑ StepModal
  const { lsGet: baseLsGet, lsSet: baseLsSet, getTodayKey } = utils;

  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const lsGet = (key, def) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, def);
        }
      }
      if (baseLsGet) return baseLsGet(key, def);
      const raw = localStorage.getItem(key);
      if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, def);
      return def;
    } catch {
      return def;
    }
  };

  const lsSet = (key, value) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(key, value);
        return;
      }
      if (baseLsSet) {
        baseLsSet(key, value);
        return;
      }
      localStorage.setItem(key, JSON.stringify(value));
    } catch { }
  };

  function resolveDateKey(rawDateKey) {
    const isIsoDate = (value) => typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value);

    if (isIsoDate(rawDateKey)) return rawDateKey;

    if (rawDateKey instanceof Date && !Number.isNaN(rawDateKey.getTime())) {
      return rawDateKey.toISOString().slice(0, 10);
    }

    if (typeof rawDateKey === 'number') {
      const d = new Date(rawDateKey);
      if (!Number.isNaN(d.getTime())) return d.toISOString().slice(0, 10);
    }

    if (rawDateKey && typeof rawDateKey === 'object') {
      if (isIsoDate(rawDateKey.dateKey)) return rawDateKey.dateKey;
      if (isIsoDate(rawDateKey.date)) return rawDateKey.date;
      if (rawDateKey.value instanceof Date && !Number.isNaN(rawDateKey.value.getTime())) {
        return rawDateKey.value.toISOString().slice(0, 10);
      }
    }

    const today = getTodayKey?.();
    if (isIsoDate(today)) return today;
    return new Date().toISOString().slice(0, 10);
  }

  // ============================================================
  // WEIGHT STEP
  // ============================================================

  function getLastKnownWeight() {
    const profile = lsGet('heys_profile', { weight: 70 });
    const today = new Date();

    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –≤–µ—Å (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏)
    const todayKey = today.toISOString().slice(0, 10);
    const todayData = lsGet(`heys_dayv2_${todayKey}`, {}) || {};
    if (todayData.weightMorning) {
      return { weight: todayData.weightMorning, daysAgo: 0, date: todayKey };
    }

    // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç ‚Äî –∏—â–µ–º –≤ –ø—Ä–æ—à–ª—ã—Ö –¥–Ω—è—Ö (–¥–ª—è —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞)
    for (let i = 1; i <= 60; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
      if (dayData.weightMorning) {
        return { weight: dayData.weightMorning, daysAgo: i, date: key };
      }
    }
    if (profile.weight) {
      return { weight: profile.weight, daysAgo: null, date: null };
    }
    return { weight: 70, daysAgo: null, date: null };
  }

  function getYesterdayWeight() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const key = yesterday.toISOString().slice(0, 10);
    const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
    return dayData.weightMorning || null;
  }

  function getWeightForecast() {
    const weights = [];
    const today = new Date();
    for (let i = 1; i <= 14; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
      if (dayData.weightMorning) {
        weights.push({ day: -i, weight: dayData.weightMorning });
      }
    }
    if (weights.length < 3) return null;
    const n = weights.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    for (const p of weights) {
      sumX += p.day;
      sumY += p.weight;
      sumXY += p.day * p.weight;
      sumXX += p.day * p.day;
    }
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    const forecastWeight = intercept + slope * 14;
    const weeklyChange = slope * 7;
    return {
      weight: Math.round(forecastWeight * 10) / 10,
      weeklyChange: Math.round(weeklyChange * 100) / 100,
      confidence: weights.length >= 7 ? 'high' : 'low'
    };
  }

  function WeightStepComponent({ data, onChange }) {
    const lastWeight = useMemo(() => getLastKnownWeight(), []);
    const yesterdayWeight = useMemo(() => getYesterdayWeight(), []);
    const weightForecast = useMemo(() => getWeightForecast(), []);

    const weightKg = data.weightKg ?? Math.floor(lastWeight.weight);
    const weightG = data.weightG ?? Math.round((lastWeight.weight % 1) * 10);
    const currentWeight = weightKg + weightG / 10;
    const weightDelta = yesterdayWeight ? currentWeight - yesterdayWeight : null;

    const kgValues = useMemo(() => Array.from({ length: 101 }, (_, i) => 40 + i), []);
    const gValues = useMemo(() => Array.from({ length: 10 }, (_, i) => i), []);

    const prevWeightGRef = useRef(weightG);

    useEffect(() => {
      prevWeightGRef.current = weightG;
    }, [weightG]);

    const setWeightKg = (v) => onChange({ ...data, weightKg: v, weightG: data.weightG ?? weightG });
    const setWeightG = (v) => {
      const prevG = prevWeightGRef.current;
      const currentKg = data.weightKg ?? weightKg;
      let nextKg = currentKg;

      if (prevG === 9 && v === 0) {
        const currentIndex = kgValues.indexOf(currentKg);
        const nextIndex = currentIndex >= 0
          ? (currentIndex + 1) % kgValues.length
          : 0;
        nextKg = kgValues[nextIndex];
      } else if (prevG === 0 && v === 9) {
        const currentIndex = kgValues.indexOf(currentKg);
        const nextIndex = currentIndex >= 0
          ? (currentIndex - 1 + kgValues.length) % kgValues.length
          : kgValues.length - 1;
        nextKg = kgValues[nextIndex];
      }

      prevWeightGRef.current = v;
      onChange({ ...data, weightKg: nextKg, weightG: v });
    };

    return React.createElement('div', { className: 'mc-weight-step' },
      React.createElement('div', { className: 'mc-weight-display' },
        React.createElement('span', { className: 'mc-weight-value' }, currentWeight.toFixed(1)),
        React.createElement('span', { className: 'mc-weight-unit' }, ' –∫–≥'),
        weightDelta !== null && React.createElement('div', {
          className: `mc-weight-delta ${weightDelta > 0 ? 'mc-delta-up' : weightDelta < 0 ? 'mc-delta-down' : 'mc-delta-same'}`
        },
          weightDelta > 0 ? `+${weightDelta.toFixed(1)}` : weightDelta.toFixed(1),
          ' –∫–≥ –∑–∞ –≤—á–µ—Ä–∞'
        )
      ),
      React.createElement('div', { className: 'mc-weight-pickers' },
        React.createElement(WheelPicker, {
          values: kgValues,
          value: weightKg,
          onChange: setWeightKg,
          label: '–∫–≥'
        }),
        React.createElement('span', { className: 'mc-weight-dot' }, '.'),
        React.createElement(WheelPicker, {
          values: gValues,
          value: weightG,
          onChange: setWeightG,
          label: '–≥'
        })
      ),
      weightForecast && React.createElement('div', { className: 'mc-weight-forecast' },
        React.createElement('span', { className: 'mc-forecast-icon' }, 'üìà'),
        React.createElement('span', { className: 'mc-forecast-text' },
          `–ü—Ä–æ–≥–Ω–æ–∑ —á–µ—Ä–µ–∑ 2 –Ω–µ–¥: ${weightForecast.weight} –∫–≥`,
          weightForecast.weeklyChange !== 0 && ` (${weightForecast.weeklyChange > 0 ? '+' : ''}${weightForecast.weeklyChange} –∫–≥/–Ω–µ–¥)`
        )
      )
    );
  }

  registerStep('weight', {
    title: '–í–µ—Å',
    hint: '–í–∑–≤–µ—Å—å—Ç–µ—Å—å –Ω–∞—Ç–æ—â–∞–∫',
    icon: '‚öñÔ∏è',
    component: WeightStepComponent,
    getInitialData: (context) => {
      // –ï—Å–ª–∏ –µ—Å—Ç—å dateKey –≤ context ‚Äî –±–µ—Ä—ë–º –≤–µ—Å –∏–∑ —Ç–æ–≥–æ –¥–Ω—è (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
      if (context && context.dateKey) {
        const dayData = lsGet(`heys_dayv2_${context.dateKey}`, {}) || {};
        if (dayData.weightMorning) {
          return {
            weightKg: Math.floor(dayData.weightMorning),
            weightG: Math.round((dayData.weightMorning % 1) * 10)
          };
        }
      }
      // –ò–Ω–∞—á–µ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ—Å
      const last = getLastKnownWeight();
      return {
        weightKg: Math.floor(last.weight),
        weightG: Math.round((last.weight % 1) * 10)
      };
    },
    save: (data, context) => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º dateKey –∏–∑ context, –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –∫–∞–∫ fallback
      const dateKey = (context && context.dateKey) || getTodayKey();
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      const weight = (data.weightKg || 70) + (data.weightG || 0) / 10;
      dayData.date = dateKey;
      dayData.weightMorning = weight;
      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, dayData);

      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–µ—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ TDEE, BMR –∏ —Ç.–¥.)
      const profile = lsGet('heys_profile', {});
      if (profile.weight !== weight) {
        profile.weight = weight;
        lsSet('heys_profile', profile);
        console.log('[WeightStep] Profile weight updated:', weight, 'kg');

        // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –ø—Ä–æ—Ñ–∏–ª—è
        if (typeof window !== 'undefined') {
          window.dispatchEvent(new CustomEvent('heys:profile-updated', {
            detail: { profile, source: 'weight-step' }
          }));
        }
      }

      // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –¥–Ω—è
      if (typeof window !== 'undefined') {
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { date: dateKey, field: 'weightMorning', value: weight, forceReload: true }
        }));
      }
    },
    xpAction: 'weight_logged'
  });

  // ============================================================
  // SLEEP TIME STEP
  // ============================================================

  function getLastSleepData() {
    const today = new Date();
    for (let i = 1; i <= 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
      if (dayData.sleepStart && dayData.sleepEnd) {
        return {
          sleepStart: dayData.sleepStart,
          sleepEnd: dayData.sleepEnd,
          sleepQuality: dayData.sleepQuality || 7
        };
      }
    }
    return { sleepStart: '23:00', sleepEnd: '07:00', sleepQuality: 7 };
  }

  function calcSleepHours(startH, startM, endH, endM) {
    let startMins = startH * 60 + startM;
    let endMins = endH * 60 + endM;
    if (endMins <= startMins) {
      endMins += 24 * 60;
    }
    return (endMins - startMins) / 60;
  }

  function SleepTimeStepComponent({ data, onChange }) {
    const lastSleep = useMemo(() => getLastSleepData(), []);

    const sleepStartH = data.sleepStartH ?? parseInt(lastSleep.sleepStart.split(':')[0], 10);
    const sleepStartM = data.sleepStartM ?? parseInt(lastSleep.sleepStart.split(':')[1], 10);
    const sleepEndH = data.sleepEndH ?? parseInt(lastSleep.sleepEnd.split(':')[0], 10);
    const sleepEndM = data.sleepEndM ?? parseInt(lastSleep.sleepEnd.split(':')[1], 10);

    const sleepHours = calcSleepHours(sleepStartH, sleepStartM, sleepEndH, sleepEndM);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π TimePicker –∏–∑ StepModal
    const TimePicker = HEYS.StepModal.TimePicker;

    // Helper –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    const pad2 = (n) => String(n).padStart(2, '0');

    // –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –¥–ª—è onComplete
    const updateData = (newData) => {
      const startH = newData.sleepStartH ?? sleepStartH;
      const startM = newData.sleepStartM ?? sleepStartM;
      const endH = newData.sleepEndH ?? sleepEndH;
      const endM = newData.sleepEndM ?? sleepEndM;

      onChange({
        ...newData,
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –¥–ª—è onComplete callback
        sleepStart: `${pad2(startH)}:${pad2(startM)}`,
        sleepEnd: `${pad2(endH)}:${pad2(endM)}`,
        sleepHours: Math.round(calcSleepHours(startH, startM, endH, endM) * 10) / 10
      });
    };

    // Callbacks –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞—Å—ã–ø–∞–Ω–∏—è
    const setSleepStartH = (h) => {
      updateData({
        ...data,
        sleepStartH: h,
        sleepStartM: data.sleepStartM ?? sleepStartM,
        sleepEndH: data.sleepEndH ?? sleepEndH,
        sleepEndM: data.sleepEndM ?? sleepEndM
      });
    };

    const setSleepStartM = (m) => {
      updateData({
        ...data,
        sleepStartH: data.sleepStartH ?? sleepStartH,
        sleepStartM: m,
        sleepEndH: data.sleepEndH ?? sleepEndH,
        sleepEndM: data.sleepEndM ?? sleepEndM
      });
    };

    // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll ‚Äî –∑–∞—Å—ã–ø–∞–Ω–∏–µ
    const setSleepStartTime = (h, m) => {
      updateData({
        ...data,
        sleepStartH: h,
        sleepStartM: m,
        sleepEndH: data.sleepEndH ?? sleepEndH,
        sleepEndM: data.sleepEndM ?? sleepEndM
      });
    };

    // Callbacks –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è
    const setSleepEndH = (h) => {
      updateData({
        ...data,
        sleepStartH: data.sleepStartH ?? sleepStartH,
        sleepStartM: data.sleepStartM ?? sleepStartM,
        sleepEndH: h,
        sleepEndM: data.sleepEndM ?? sleepEndM
      });
    };

    const setSleepEndM = (m) => {
      updateData({
        ...data,
        sleepStartH: data.sleepStartH ?? sleepStartH,
        sleepStartM: data.sleepStartM ?? sleepStartM,
        sleepEndH: data.sleepEndH ?? sleepEndH,
        sleepEndM: m
      });
    };

    // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll ‚Äî –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ
    const setSleepEndTime = (h, m) => {
      updateData({
        ...data,
        sleepStartH: data.sleepStartH ?? sleepStartH,
        sleepStartM: data.sleepStartM ?? sleepStartM,
        sleepEndH: h,
        sleepEndM: m
      });
    };

    return React.createElement('div', { className: 'mc-sleep-step' },
      React.createElement('div', { className: 'mc-sleep-display' },
        React.createElement('span', { className: 'mc-sleep-value' }, sleepHours.toFixed(1)),
        React.createElement('span', { className: 'mc-sleep-unit' }, ' —á —Å–Ω–∞')
      ),
      React.createElement('div', { className: 'mc-sleep-times' },
        React.createElement('div', { className: 'mc-sleep-block' },
          React.createElement('div', { className: 'mc-sleep-label' }, 'üåô –õ—ë–≥'),
          React.createElement(TimePicker, {
            hours: sleepStartH,
            minutes: sleepStartM,
            onHoursChange: setSleepStartH,
            onMinutesChange: setSleepStartM,
            onTimeChange: setSleepStartTime,
            hoursLabel: '',
            minutesLabel: '',
            display: null,
            linkedScroll: true,
            className: 'mc-time-pickers'
          })
        ),
        React.createElement('div', { className: 'mc-sleep-block' },
          React.createElement('div', { className: 'mc-sleep-label' }, '‚òÄÔ∏è –í—Å—Ç–∞–ª'),
          React.createElement(TimePicker, {
            hours: sleepEndH,
            minutes: sleepEndM,
            onHoursChange: setSleepEndH,
            onMinutesChange: setSleepEndM,
            onTimeChange: setSleepEndTime,
            hoursLabel: '',
            minutesLabel: '',
            display: null,
            linkedScroll: true,
            className: 'mc-time-pickers'
          })
        )
      )
    );
  }

  registerStep('sleepTime', {
    title: '–°–æ–Ω',
    hint: '–í–æ —Å–∫–æ–ª—å–∫–æ –ª–µ–≥–ª–∏ –∏ –≤—Å—Ç–∞–ª–∏',
    icon: 'üõèÔ∏è',
    component: SleepTimeStepComponent,
    getInitialData: (context) => {
      const dateKey = resolveDateKey(context?.dateKey);
      // –ï—Å–ª–∏ –µ—Å—Ç—å dateKey –≤ context ‚Äî –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–æ–≥–æ –¥–Ω—è
      if (dateKey) {
        const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
        if (dayData.sleepStart && dayData.sleepEnd) {
          const sleepStartH = parseInt(dayData.sleepStart.split(':')[0], 10);
          const sleepStartM = parseInt(dayData.sleepStart.split(':')[1], 10);
          const sleepEndH = parseInt(dayData.sleepEnd.split(':')[0], 10);
          const sleepEndM = parseInt(dayData.sleepEnd.split(':')[1], 10);
          return {
            sleepStartH,
            sleepStartM,
            sleepEndH,
            sleepEndM,
            sleepStart: dayData.sleepStart,
            sleepEnd: dayData.sleepEnd,
            sleepHours: dayData.sleepHours || Math.round(calcSleepHours(sleepStartH, sleepStartM, sleepEndH, sleepEndM) * 10) / 10
          };
        }
      }
      // –ò–Ω–∞—á–µ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –æ —Å–Ω–µ
      const last = getLastSleepData();
      const sleepStartH = parseInt(last.sleepStart.split(':')[0], 10);
      const sleepStartM = parseInt(last.sleepStart.split(':')[1], 10);
      const sleepEndH = parseInt(last.sleepEnd.split(':')[0], 10);
      const sleepEndM = parseInt(last.sleepEnd.split(':')[1], 10);
      return {
        sleepStartH,
        sleepStartM,
        sleepEndH,
        sleepEndM,
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –¥–ª—è onComplete
        sleepStart: last.sleepStart,
        sleepEnd: last.sleepEnd,
        sleepHours: Math.round(calcSleepHours(sleepStartH, sleepStartM, sleepEndH, sleepEndM) * 10) / 10
      };
    },
    save: (data, context) => {
      const dateKey = resolveDateKey(context?.dateKey);
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      const sleepStart = `${String(data.sleepStartH).padStart(2, '0')}:${String(data.sleepStartM).padStart(2, '0')}`;
      const sleepEnd = `${String(data.sleepEndH).padStart(2, '0')}:${String(data.sleepEndM).padStart(2, '0')}`;
      const sleepHours = calcSleepHours(data.sleepStartH, data.sleepStartM, data.sleepEndH, data.sleepEndM);

      dayData.date = dateKey;
      dayData.sleepStart = sleepStart;
      dayData.sleepEnd = sleepEnd;
      dayData.sleepHours = Math.round(sleepHours * 10) / 10;
      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, dayData);
      console.info('[HEYS.sleepTime] ‚úÖ Saved:', { dateKey, sleepStart, sleepEnd, sleepHours: dayData.sleepHours });
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'sleep', source: 'sleep-step', forceReload: true }
      }));
    },
    xpAction: 'sleep_logged'
  });

  // ============================================================
  // SLEEP QUALITY STEP
  // ============================================================

  const SLEEP_QUALITY_EMOJI = ['üò¥', 'üòü', 'üòï', 'üòê', 'üôÇ', 'üòä', 'üòÉ', 'üåü', '‚ú®', 'üåà'];
  const SLEEP_QUALITY_LABELS = [
    '–£–∂–∞—Å–Ω–æ', '–ü–ª–æ—Ö–æ', '–¢–∞–∫ —Å–µ–±–µ', '–ù–æ—Ä–º', '–ù–µ–ø–ª–æ—Ö–æ',
    '–•–æ—Ä–æ—à–æ', '–û—Ç–ª–∏—á–Ω–æ', '–°—É–ø–µ—Ä', '–ò–¥–µ–∞–ª—å–Ω–æ', '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ'
  ];

  const SLEEP_ADVICE = {
    bad: [
      { icon: 'üìµ', text: '–ü–æ–ø—Ä–æ–±—É–π –±–µ–∑ —ç–∫—Ä–∞–Ω–æ–≤ –∑–∞ —á–∞—Å –¥–æ —Å–Ω–∞' },
      { icon: 'üå°Ô∏è', text: '–ü—Ä–æ—Ö–ª–∞–¥–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ (18-20¬∞C) —É–ª—É—á—à–∞–µ—Ç —Å–æ–Ω' },
      { icon: 'üßò', text: '–õ—ë–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º —Å–Ω–∏–º–∞–µ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ' },
      { icon: '‚òï', text: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ—Ñ–µ ‚Äî –¥–æ 14:00' },
      { icon: 'üö∂', text: '–ü—Ä–æ–≥—É–ª–∫–∞ –≤–µ—á–µ—Ä–æ–º –ø–æ–º–æ–∂–µ—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è' }
    ],
    medium: [
      { icon: '‚è∞', text: '–ü–æ–ø—Ä–æ–±—É–π –ª–æ–∂–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ –≤—Ä–µ–º—è' },
      { icon: 'üåô', text: '–ó–∞—Ç–µ–º–Ω–∏ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ —Å–Ω–∞' },
      { icon: 'üìñ', text: '–ö–Ω–∏–≥–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –ª—É—á—à–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞' },
      { icon: 'üí®', text: '–ü—Ä–æ–≤–µ—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—É –ø–µ—Ä–µ–¥ —Å–Ω–æ–º' }
    ],
    good: [
      { icon: '‚ú®', text: '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∂–∏–º! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ' },
      { icon: 'üí™', text: '–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω = –±–æ–ª—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏ –¥–Ω—ë–º' },
      { icon: 'üß†', text: '–•–æ—Ä–æ—à–∏–π —Å–æ–Ω —É–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é' }
    ],
    excellent: [
      { icon: 'üåü', text: '–ò–¥–µ–∞–ª—å–Ω–æ! –¢—ã –º–∞—Å—Ç–µ—Ä —Å–Ω–∞!' },
      { icon: 'üèÜ', text: '–¢–≤–æ–π —Å–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ ‚Äî –≤ —Ä–µ–∂–∏–º–µ' },
      { icon: 'üöÄ', text: '–° —Ç–∞–∫–∏–º —Å–Ω–æ–º –≥–æ—Ä—ã —Å–≤–µ—Ä–Ω—ë—à—å!' }
    ]
  };

  function getSleepAdvice(quality) {
    if (quality <= 3) return SLEEP_ADVICE.bad;
    if (quality <= 6) return SLEEP_ADVICE.medium;
    if (quality <= 8) return SLEEP_ADVICE.good;
    return SLEEP_ADVICE.excellent;
  }

  function getSleepAdviceColor(quality) {
    if (quality <= 3) return { bg: '#fef2f2', border: '#fecaca', text: '#991b1b' };
    if (quality <= 6) return { bg: '#fefce8', border: '#fef08a', text: '#854d0e' };
    if (quality <= 8) return { bg: '#f0fdf4', border: '#bbf7d0', text: '#166534' };
    return { bg: '#ecfdf5', border: '#6ee7b7', text: '#047857' };
  }

  function getQualityColor(quality) {
    if (quality <= 3) {
      const t = (quality - 1) / 2;
      return `hsl(${Math.round(t * 30)}, 80%, 50%)`;
    } else if (quality <= 6) {
      const t = (quality - 3) / 3;
      return `hsl(${Math.round(30 + t * 40)}, 80%, 50%)`;
    } else {
      const t = (quality - 6) / 4;
      return `hsl(${Math.round(70 + t * 90)}, 70%, 45%)`;
    }
  }

  function SleepQualityStepComponent({ data, onChange }) {
    const lastSleep = useMemo(() => getLastSleepData(), []);
    const sleepQuality = data.sleepQuality ?? lastSleep.sleepQuality ?? 7;
    const sleepNote = data.sleepNote ?? '';

    const qualityColor = getQualityColor(sleepQuality);
    const adviceList = getSleepAdvice(sleepQuality);
    const adviceColors = getSleepAdviceColor(sleepQuality);
    const adviceIndex = (sleepQuality * 7) % adviceList.length;
    const currentAdvice = adviceList[adviceIndex];

    const commentQuestion = sleepQuality <= 4
      ? 'üòî –ß—Ç–æ –ø–æ–º–µ—à–∞–ª–æ –≤—ã—Å–ø–∞—Ç—å—Å—è?'
      : sleepQuality >= 8
        ? '‚ú® –ß—Ç–æ –ø–æ–º–æ–≥–ª–æ —Ö–æ—Ä–æ—à–æ –≤—ã—Å–ø–∞—Ç—å—Å—è?'
        : 'üí≠ –ó–∞–º–µ—Ç–∫–∞ –æ —Å–Ω–µ';
    const commentPlaceholder = sleepQuality <= 4
      ? '–®—É–º, —Å—Ç—Ä–µ—Å—Å, –ø–æ–∑–¥–Ω–æ –ª—ë–≥...'
      : sleepQuality >= 8
        ? '–†–µ–∂–∏–º, —Ç–∏—à–∏–Ω–∞, –ø—Ä–æ—Ö–ª–∞–¥–∞...'
        : '–õ—é–±—ã–µ –∑–∞–º–µ—Ç–∫–∏...';

    return React.createElement('div', {
      className: 'mc-quality-step',
      style: { '--quality-color': qualityColor }
    },
      React.createElement('div', { className: 'mc-quality-display' },
        React.createElement('span', {
          className: 'mc-quality-emoji',
          style: { filter: `drop-shadow(0 0 8px ${qualityColor})` }
        }, SLEEP_QUALITY_EMOJI[sleepQuality - 1]),
        React.createElement('span', { className: 'mc-quality-label' }, SLEEP_QUALITY_LABELS[sleepQuality - 1])
      ),
      React.createElement('input', {
        type: 'range',
        className: 'mc-quality-slider',
        min: 1,
        max: 10,
        value: sleepQuality,
        onChange: (e) => onChange({ ...data, sleepQuality: Number(e.target.value) }),
        style: {
          background: `linear-gradient(to right, ${qualityColor} ${(sleepQuality - 1) * 11.1}%, #e5e7eb ${(sleepQuality - 1) * 11.1}%)`
        }
      }),
      React.createElement('div', { className: 'mc-quality-buttons' },
        [1, 4, 7, 10].map(q =>
          React.createElement('button', {
            key: q,
            className: `mc-quality-btn ${sleepQuality === q ? 'mc-quality-btn--active' : ''}`,
            onClick: () => onChange({ ...data, sleepQuality: q }),
            style: sleepQuality === q ? { backgroundColor: qualityColor, borderColor: qualityColor } : {}
          }, SLEEP_QUALITY_EMOJI[q - 1])
        )
      ),
      React.createElement('div', {
        className: 'mc-sleep-advice',
        style: {
          backgroundColor: adviceColors.bg,
          borderColor: adviceColors.border
        }
      },
        React.createElement('span', { className: 'mc-sleep-advice-icon' }, currentAdvice.icon),
        React.createElement('span', {
          className: 'mc-sleep-advice-text',
          style: { color: adviceColors.text }
        }, currentAdvice.text)
      ),
      React.createElement('div', {
        className: 'mc-sleep-comment',
        style: { borderColor: adviceColors.border }
      },
        React.createElement('label', {
          className: 'mc-sleep-comment-label',
          style: { color: adviceColors.text }
        }, commentQuestion),
        React.createElement('input', {
          type: 'text',
          className: 'mc-sleep-comment-input',
          placeholder: commentPlaceholder,
          value: sleepNote,
          onChange: (e) => onChange({ ...data, sleepNote: e.target.value })
        })
      )
    );
  }

  registerStep('sleepQuality', {
    title: '–ö–∞–∫ –≤—ã—Å–ø–∞–ª–∏—Å—å?',
    hint: '',
    icon: '‚ú®',
    component: SleepQualityStepComponent,
    getInitialData: (context) => {
      const dateKey = resolveDateKey(context?.dateKey);
      // –ï—Å–ª–∏ –µ—Å—Ç—å dateKey –≤ context ‚Äî –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–æ–≥–æ –¥–Ω—è
      if (dateKey) {
        const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
        if (dayData.sleepQuality !== undefined) {
          return {
            sleepQuality: dayData.sleepQuality,
            sleepNote: ''  // –ù–µ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–º–µ—Ç–∫—É ‚Äî –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤–∞—è
          };
        }
      }
      // –ò–Ω–∞—á–µ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
      const last = getLastSleepData();
      return {
        sleepQuality: last.sleepQuality || 7,
        sleepNote: ''
      };
    },
    save: (data, context, allStepData) => {
      const dateKey = resolveDateKey(context?.dateKey);
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      dayData.sleepQuality = data.sleepQuality;

      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞ –∏–∑ sleepTime-—à–∞–≥–∞
      // (HEYS.store –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –±–µ–∑ sleepStart)
      if (allStepData?.sleepTime) {
        const st = allStepData.sleepTime;
        if (st.sleepStart) dayData.sleepStart = st.sleepStart;
        if (st.sleepEnd) dayData.sleepEnd = st.sleepEnd;
        if (st.sleepHours !== undefined) dayData.sleepHours = st.sleepHours;
      }

      if (data.sleepNote && data.sleepNote.trim()) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        const noteWithTime = `[${timeStr}] ${data.sleepNote.trim()}`;
        dayData.sleepNote = dayData.sleepNote
          ? dayData.sleepNote + '\n' + noteWithTime
          : noteWithTime;
      }

      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, dayData);
      console.info('[HEYS.sleepQuality] ‚úÖ Saved:', { dateKey, sleepQuality: dayData.sleepQuality, sleepStart: dayData.sleepStart, sleepEnd: dayData.sleepEnd });
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'sleep', source: 'sleep-quality-step', forceReload: true }
      }));
    }
  });

  // ============================================================
  // STEPS GOAL STEP
  // ============================================================

  function getWeeklyStepsStats(weight = 70) {
    const today = new Date();
    const stepsData = [];
    for (let i = 1; i <= 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
      if (dayData.steps && dayData.steps > 0) {
        stepsData.push(dayData.steps);
      }
    }
    if (stepsData.length === 0) {
      return { avg: 0, daysWithData: 0, recommended: 7000, minHealthy: 7000 };
    }
    const avg = Math.round(stepsData.reduce((a, b) => a + b, 0) / stepsData.length);
    const minHealthy = 7000;
    const rawRecommended = Math.round(avg * 1.2 / 100) * 100;
    const recommended = Math.max(rawRecommended, minHealthy);
    return { avg, daysWithData: stepsData.length, recommended, minHealthy };
  }

  function StepsGoalStepComponent({ data, onChange, stepData }) {
    const profile = useMemo(() => lsGet('heys_profile', {}), []);
    const weight = stepData?.weight?.weightKg ? (stepData.weight.weightKg + (stepData.weight.weightG || 0) / 10) : profile.weight || 70;
    const stepsStats = useMemo(() => getWeeklyStepsStats(weight), [weight]);

    const defaultStepsGoal = useMemo(() => {
      if (stepsStats.daysWithData >= 3) {
        return stepsStats.recommended;
      }
      return profile.stepsGoal || 10000;
    }, [stepsStats, profile.stepsGoal]);

    const stepsGoal = data.stepsGoal ?? defaultStepsGoal;
    const hasStepsHistory = stepsStats.daysWithData >= 3;

    // –†–∞—Å—á—ë—Ç –±–æ–Ω—É—Å–∞ –∫–∫–∞–ª
    const isFemale = profile.gender === '–ñ–µ–Ω—Å–∫–∏–π';
    const coef = isFemale ? 0.5 : 0.57;
    const bonusSteps = stepsGoal - stepsStats.avg;
    const bonusKm = bonusSteps * 0.7 / 1000;
    const bonusKcal = Math.round(coef * weight * bonusKm);

    const sliderMin = 3000;
    const sliderMax = 20000;
    const sliderPercent = Math.min(100, Math.max(0, ((stepsGoal - sliderMin) / (sliderMax - sliderMin)) * 100));
    const sliderColor = stepsGoal < 7000 ? '#eab308' : stepsGoal >= 10000 ? '#22c55e' : '#3b82f6';

    const stepsValues = useMemo(() => [5000, 6000, 7000, 8000, 9000, 10000, 12000, 15000], []);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–Ω—è –ø–æ —Ü–µ–ª–∏
    const getDayTypeLabel = () => {
      if (stepsGoal <= 5000) return { emoji: 'üõãÔ∏è', label: '–ú–∞–ª–æ–ø–æ–¥–≤–∏–∂–Ω—ã–π –¥–µ–Ω—å', desc: '–æ—Ñ–∏—Å, –¥–æ–º, –æ—Ç–¥—ã—Ö' };
      if (stepsGoal <= 7000) return { emoji: 'üíº', label: '–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å', desc: '—Ä–∞–±–æ—Ç–∞, –¥–µ–ª–∞ –ø–æ –¥–æ–º—É' };
      if (stepsGoal <= 10000) return { emoji: 'üö∂', label: '–ê–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å', desc: '–ø—Ä–æ–≥—É–ª–∫–∏, –≤—Å—Ç—Ä–µ—á–∏' };
      if (stepsGoal <= 15000) return { emoji: 'üèÉ', label: '–û—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å', desc: '–º–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π' };
      return { emoji: 'üèîÔ∏è', label: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', desc: '–ø–æ—Ö–æ–¥, —ç–∫—Å–∫—É—Ä—Å–∏—è' };
    };
    const dayType = getDayTypeLabel();

    return React.createElement('div', { className: 'mc-steps-step' },
      // –ü–æ—è—Å–Ω–µ–Ω–∏–µ –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ —Ü–µ–ª—å
      React.createElement('div', { className: 'mc-steps-purpose' },
        React.createElement('div', { className: 'mc-steps-purpose-main' },
          'üéØ –ö–∞–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∂–¥—ë—Ç —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è?'
        ),
        React.createElement('div', { className: 'mc-steps-purpose-sub' },
          '–ö—É—Ä–∞—Ç–æ—Ä —É–≤–∏–¥–∏—Ç —Ç–≤–æ–π –ø–ª–∞–Ω –∏ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é'
        )
      ),
      React.createElement('div', { className: 'mc-steps-display' },
        React.createElement('span', { className: 'mc-steps-value' }, stepsGoal.toLocaleString()),
        React.createElement('span', { className: 'mc-steps-unit' }, ' —à–∞–≥–æ–≤')
      ),
      React.createElement('div', { className: 'mc-steps-slider-container' },
        React.createElement('input', {
          type: 'range',
          className: 'mc-steps-slider',
          min: sliderMin,
          max: sliderMax,
          step: 500,
          value: stepsGoal,
          onChange: (e) => onChange({ ...data, stepsGoal: Number(e.target.value) }),
          style: {
            background: `linear-gradient(to right, ${sliderColor} ${sliderPercent}%, #e5e7eb ${sliderPercent}%)`
          }
        }),
        React.createElement('div', { className: 'mc-steps-slider-labels' },
          React.createElement('span', null, '3–∫'),
          React.createElement('span', { className: 'mc-steps-slider-label-health' }, '7–∫ ‚ù§Ô∏è'),
          React.createElement('span', null, '10–∫'),
          React.createElement('span', null, '15–∫'),
          React.createElement('span', null, '20–∫')
        )
      ),
      hasStepsHistory && React.createElement('div', { className: 'mc-steps-stats' },
        React.createElement('div', { className: 'mc-steps-avg' },
          React.createElement('span', { className: 'mc-steps-avg-label' }, 'üìä –°—Ä–µ–¥–Ω–µ–µ –∑–∞ –Ω–µ–¥–µ–ª—é: '),
          React.createElement('span', { className: 'mc-steps-avg-value' }, stepsStats.avg.toLocaleString())
        ),
        stepsGoal > stepsStats.avg && bonusKcal > 0 && React.createElement('div', { className: 'mc-steps-bonus' },
          React.createElement('span', { className: 'mc-steps-bonus-icon' }, 'üî•'),
          React.createElement('span', { className: 'mc-steps-bonus-text' },
            `+${(stepsGoal - stepsStats.avg).toLocaleString()} —à–∞–≥–æ–≤ = +${bonusKcal} –∫–∫–∞–ª`
          )
        )
      ),
      // –¢–∏–ø –¥–Ω—è ‚Äî —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ü–µ–ª—å
      React.createElement('div', { className: 'mc-steps-day-type' },
        React.createElement('span', { className: 'mc-steps-day-type-emoji' }, dayType.emoji),
        React.createElement('div', { className: 'mc-steps-day-type-info' },
          React.createElement('span', { className: 'mc-steps-day-type-label' }, dayType.label),
          React.createElement('span', { className: 'mc-steps-day-type-desc' }, dayType.desc)
        )
      ),
      React.createElement('div', { className: 'mc-steps-recommendation' },
        stepsGoal < 7000
          ? '‚ù§Ô∏è –ú–∏–Ω–∏–º—É–º 7000 —à–∞–≥–æ–≤ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–¥—Ü–∞ –∏ —Å–æ—Å—É–¥–æ–≤'
          : hasStepsHistory && stepsGoal === stepsStats.recommended
            ? '‚ú® –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º: –≤–∞—à–µ —Å—Ä–µ–¥–Ω–µ–µ +20%'
            : stepsGoal >= 10000
              ? 'üèÜ –û—Ç–ª–∏—á–Ω–∞—è —Ü–µ–ª—å! 10–ö+ —à–∞–≥–æ–≤ ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏'
              : 'üëç –•–æ—Ä–æ—à–∞—è —Ü–µ–ª—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è'
      ),
      React.createElement('div', { className: 'mc-steps-grid' },
        stepsValues.map(v =>
          React.createElement('button', {
            key: v,
            className: `mc-steps-btn ${stepsGoal === v ? 'mc-steps-btn--active' : ''} ${v === stepsStats.recommended && hasStepsHistory ? 'mc-steps-btn--recommended' : ''}`,
            onClick: () => onChange({ ...data, stepsGoal: v })
          }, v >= 10000 ? `${v / 1000}–∫` : v.toLocaleString())
        )
      ),
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤–Ω–∏–∑—É
      React.createElement('div', { className: 'mc-steps-footer-hint' },
        'üò¥ –°–æ–Ω 7-8 —á–∞—Å–æ–≤ = –º–µ–Ω—å—à–µ —Ç—è–≥–∏ –∫ —Å–ª–∞–¥–∫–æ–º—É'
      )
    );
  }

  registerStep('stepsGoal', {
    title: '–®–∞–≥–∏',
    hint: '–ö–∞–∫–æ–π –¥–µ–Ω—å —Ç–µ–±—è –∂–¥—ë—Ç?',
    icon: 'üëü',
    component: StepsGoalStepComponent,
    getInitialData: () => {
      const profile = lsGet('heys_profile', {});
      const stats = getWeeklyStepsStats(profile.weight || 70);
      return {
        stepsGoal: stats.daysWithData >= 3 ? stats.recommended : (profile.stepsGoal || 10000)
      };
    },
    save: (data) => {
      const profile = lsGet('heys_profile', {});
      profile.stepsGoal = data.stepsGoal;
      lsSet('heys_profile', profile);
      // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
      window.dispatchEvent(new CustomEvent('heys:profile-updated', {
        detail: { stepsGoal: data.stepsGoal }
      }));
    }
  });

  // =============================================
  // –®–ê–ì 5: –î–ï–§–ò–¶–ò–¢ –ö–ê–õ–û–†–ò–ô
  // =============================================

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏–∑ –¥–Ω—è –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è
   */
  function getCurrentDeficit(dateKey) {
    const day = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
    if (day.deficitPct !== undefined && day.deficitPct !== null && day.deficitPct !== '') {
      return day.deficitPct;
    }
    const profile = lsGet('heys_profile', {});
    return profile.deficitPctTarget ?? 15;
  }

  /**
   * DeficitStep ‚Äî –®–∞–≥ –≤—ã–±–æ—Ä–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∫–∞–ª–æ—Ä–∏–π
   * –î–∏–∞–ø–∞–∑–æ–Ω: -20% (–¥–µ—Ñ–∏—Ü–∏—Ç/–ø–æ—Ö—É–¥–µ–Ω–∏–µ) –¥–æ +20% (–ø—Ä–æ—Ñ–∏—Ü–∏—Ç/–Ω–∞–±–æ—Ä)
   */
  function DeficitStepComponent({ data, onChange }) {
    const { useMemo, useCallback } = React;

    const deficit = data.deficit ?? 0;

    // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ–ª–µ—Å–∞: –æ—Ç -20 –¥–æ +20
    const deficitValues = useMemo(() => Array.from({ length: 41 }, (_, i) => i - 20), []);

    // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
    const getDeficitInfo = useCallback((val) => {
      if (val < -10) return { color: '#ef4444', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç', emoji: 'üî•üî•' };
      if (val < 0) return { color: '#f97316', label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç', emoji: 'üî•' };
      if (val === 0) return { color: '#22c55e', label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞', emoji: '‚öñÔ∏è' };
      if (val <= 10) return { color: '#3b82f6', label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ü–∏—Ç', emoji: 'üí™' };
      return { color: '#3b82f6', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™üí™' };
    }, []);

    const info = getDeficitInfo(deficit);

    const setDeficit = (v) => {
      onChange({ ...data, deficit: v });
      if (navigator.vibrate) navigator.vibrate(5);
    };

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–ª–µ—Å–µ
    const formatValue = (v) => (v > 0 ? '+' : '') + v + '%';

    // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã
    const presets = [
      { value: -15, label: '-15%', emoji: 'üî•' },
      { value: -10, label: '-10%', emoji: 'üéØ' },
      { value: 0, label: '0%', emoji: '‚öñÔ∏è' },
      { value: 10, label: '+10%', emoji: 'üí™' },
    ];

    return React.createElement('div', { className: 'step-deficit' },
      // –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Å–ø–ª–µ–π
      React.createElement('div', { className: 'deficit-display' },
        React.createElement('div', { className: 'deficit-value', style: { color: info.color } },
          (deficit > 0 ? '+' : '') + deficit + '%'
        ),
        React.createElement('div', { className: 'deficit-label' },
          info.emoji + ' ' + info.label
        )
      ),

      // WheelPicker –≤–º–µ—Å—Ç–æ —Å–ª–∞–π–¥–µ—Ä–∞
      React.createElement('div', { className: 'deficit-wheel-container' },
        React.createElement(WheelPicker, {
          values: deficitValues,
          value: deficit,
          onChange: setDeficit,
          label: '%',
          formatValue: formatValue
        })
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞
      React.createElement('div', { className: 'deficit-hint' },
        '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –¥–µ—Ñ–∏—Ü–∏—Ç (–ø–æ—Ö—É–¥–µ–Ω–∏–µ)',
        React.createElement('br'),
        '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø—Ä–æ—Ñ–∏—Ü–∏—Ç (–Ω–∞–±–æ—Ä)'
      ),

      // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã
      React.createElement('div', { className: 'deficit-presets' },
        presets.map(p =>
          React.createElement('button', {
            key: p.value,
            className: 'deficit-preset' + (deficit === p.value ? ' active' : ''),
            onClick: () => {
              onChange({ ...data, deficit: p.value });
              if (navigator.vibrate) navigator.vibrate(15);
            },
            style: deficit === p.value ? {
              backgroundColor: info.color,
              borderColor: info.color
            } : {}
          }, p.emoji + ' ' + p.label)
        )
      )
    );
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–∞
  registerStep('deficit', {
    title: '–î–µ—Ñ–∏—Ü–∏—Ç',
    hint: '–¶–µ–ª—å –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏',
    icon: 'üìä',
    component: DeficitStepComponent,
    getInitialData: (ctx) => {
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      return { deficit: getCurrentDeficit(dateKey), dateKey };
    },
    save: (data) => {
      const dateKey = data.dateKey || new Date().toISOString().slice(0, 10);
      const day = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey }) || { date: dateKey };
      day.deficitPct = data.deficit;
      day.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, day);

      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–Ω—è
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'deficitPct', value: data.deficit, source: 'deficit-step', forceReload: true }
      }));
    }
  });

  // =============================================
  // –®–ê–ì 6: –ë–´–¢–û–í–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨ (Household)
  // =============================================

  /**
   * –ü—Ä–∏–º–µ—Ä—ã –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å MET –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏
   * (–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –Ω–æ–≥–∞—Ö –ë–ï–ó –¥–≤–∏–∂–µ–Ω–∏—è ‚Äî —à–∞–≥–∏ —Å—á–∏—Ç–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ –±—Ä–∞—Å–ª–µ—Ç–æ–º)
   */
  const HOUSEHOLD_EXAMPLES = [
    { icon: 'üßπ', name: '–£–±–æ—Ä–∫–∞', met: 3.0, minutes: 30 },
    { icon: 'üë∂', name: '–ò–≥—Ä—ã —Å –¥–µ—Ç—å–º–∏', met: 3.5, minutes: 40 },
    { icon: 'üè¢', name: '–†–∞–±–æ—Ç–∞ —Å—Ç–æ—è', met: 2.0, minutes: 25 },
    { icon: 'üç≥', name: '–ì–æ—Ç–æ–≤–∫–∞', met: 2.5, minutes: 30 },
    { icon: 'üîß', name: '–î–æ–º. –¥–µ–ª–∞', met: 3.5, minutes: 35 }
  ];

  /**
   * –ü—Ä–µ—Å–µ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   */
  const HOUSEHOLD_PRESETS = [
    { label: '15 –º–∏–Ω', value: 15, icon: '‚ö°' },
    { label: '30 –º–∏–Ω', value: 30, icon: 'üö∂' },
    { label: '1 —á–∞—Å', value: 60, icon: 'üèÉ' },
    { label: '2 —á–∞—Å–∞', value: 120, icon: 'üí™' }
  ];

  // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ N –¥–Ω–µ–π (–º–∏–Ω—É—Ç—ã)
  function getHouseholdHistory(days = 7) {
    const result = [];
    const today = new Date();
    for (let i = 0; i < days; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
      const min = Number(dayData.householdMin) || 0;
      result.push({ date: key, minutes: min });
    }
    return result;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∫–∞–ª –æ—Ç –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   */
  function calcHouseholdKcal(minutes, weight = 70) {
    // –°—Ä–µ–¥–Ω–∏–π MET –¥–ª—è –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ~2.5
    // –§–æ—Ä–º—É–ª–∞: –∫–∫–∞–ª = MET * –≤–µ—Å(–∫–≥) * –≤—Ä–µ–º—è(—á)
    const met = 2.5;
    return Math.round(met * weight * (minutes / 60));
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
   */
  function getWeeklyHouseholdStats() {
    const history = getHouseholdHistory(7);
    const nonZero = history.filter(h => h.minutes > 0).map(h => h.minutes);
    if (nonZero.length === 0) return { avg: 0, daysWithData: 0, trend: 'none', history };
    const avg = Math.round(nonZero.reduce((a, b) => a + b, 0) / nonZero.length);
    const trend = nonZero.length >= 3 ? (nonZero[0] > nonZero[2] ? 'up' : nonZero[0] < nonZero[2] ? 'down' : 'stable') : 'none';
    return { avg, daysWithData: nonZero.length, trend, history };
  }

  // –ú–µ—Å—è—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ streak –ø–æ–¥—Ä—è–¥ (–¥–Ω–∏ >=30 –º–∏–Ω)
  function getHouseholdMonthlyStats() {
    const history30 = getHouseholdHistory(30);
    const total30 = history30.reduce((a, b) => a + b.minutes, 0);
    let streak = 0;
    for (let i = 0; i < history30.length; i++) {
      if (history30[i].minutes >= 30) streak += 1; else break;
    }
    return { total30, streak, history30 };
  }

  /**
   * HouseholdStep ‚Äî –®–∞–≥ 1: –ú–∏–Ω—É—Ç—ã + –≤—Ä–µ–º—è (–≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö)
   */
  function HouseholdMinutesComponent({ data, onChange, context }) {
    const { useCallback, useMemo } = React;

    const dateKey = context?.dateKey || new Date().toISOString().slice(0, 10);
    const minutes = data.minutes ?? 0;
    const householdTime = data.householdTime ?? '';

    // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫–∞–ª–æ—Ä–∏–π
    const profile = useMemo(() => lsGet('heys_profile', {}), []);
    const weight = profile.weight || 70;
    const kcalBurned = calcHouseholdKcal(minutes, weight);

    // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∏–Ω—É—Ç
    const getColor = useCallback((min) => {
      if (min === 0) return '#94a3b8';
      if (min < 30) return '#eab308';
      if (min < 60) return '#22c55e';
      return '#10b981';
    }, []);

    const color = getColor(minutes);

    // Slider
    const sliderMin = 0;
    const sliderMax = 180;
    const sliderPercent = Math.min(100, (minutes / sliderMax) * 100);

    // Haptic
    const triggerHaptic = (intensity = 10) => {
      if (navigator.vibrate) navigator.vibrate(intensity);
    };

    // Quick preset buttons
    const handlePreset = (value) => {
      triggerHaptic(15);
      onChange({ ...data, minutes: value });
    };

    // –°—Ç–∞—Ç—É—Å —Ç–µ–∫—Å—Ç
    const getStatusText = (min) => {
      if (min === 0) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
      if (min < 30) return '–ù–µ–±–æ–ª—å—à–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
      if (min < 60) return '–•–æ—Ä–æ—à–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
      if (min < 120) return '–û—Ç–ª–∏—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!';
      return '–°—É–ø–µ—Ä –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å! üî•';
    };

    // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –¥–ª—è TimePicker (—á–∏—Å–ª–∞)
    const [currentHour, currentMinute] = useMemo(() => {
      if (householdTime) {
        const [h, m] = householdTime.split(':').map(Number);
        return [h || 0, Math.floor((m || 0) / 5) * 5];
      }

      const now = new Date();
      const roundedMinutes = Math.floor(now.getMinutes() / 5) * 5;
      return [now.getHours(), roundedMinutes];
    }, [householdTime]);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π TimePicker –∏–∑ StepModal
    const TimePicker = HEYS.StepModal.TimePicker;
    const pad2 = HEYS.StepModal.pad2;

    // Haptic —É–∂–µ –≤ TimePicker
    const setHour = (h) => {
      const newTime = `${pad2(h)}:${pad2(currentMinute)}`;
      onChange({ ...data, householdTime: newTime });
    };

    const setMinute = (m) => {
      const newTime = `${pad2(currentHour)}:${pad2(m)}`;
      onChange({ ...data, householdTime: newTime });
    };

    // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll
    const setTime = (h, m) => {
      const newTime = `${pad2(h)}:${pad2(m)}`;
      onChange({ ...data, householdTime: newTime });
    };

    return React.createElement('div', { className: 'step-household step-household-minutes' },
      // –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Å–ø–ª–µ–π
      React.createElement('div', { className: 'household-display' },
        React.createElement('div', { className: 'household-value', style: { color } },
          minutes,
          React.createElement('span', { className: 'household-unit' }, ' –º–∏–Ω')
        ),
        React.createElement('div', { className: 'household-kcal' },
          kcalBurned > 0 && React.createElement('span', null, 'üî• ~' + kcalBurned + ' –∫–∫–∞–ª')
        ),
        React.createElement('div', { className: 'household-status' }, getStatusText(minutes))
      ),

      // –°–ª–∞–π–¥–µ—Ä
      React.createElement('div', { className: 'household-slider-container' },
        React.createElement('input', {
          type: 'range',
          className: 'household-slider',
          min: sliderMin,
          max: sliderMax,
          step: 5,
          value: minutes,
          onChange: (e) => {
            triggerHaptic(5);
            onChange({ ...data, minutes: Number(e.target.value) });
          },
          style: {
            background: `linear-gradient(to right, ${color} ${sliderPercent}%, #e5e7eb ${sliderPercent}%)`
          }
        }),
        React.createElement('div', { className: 'household-slider-labels' },
          React.createElement('span', null, '0'),
          React.createElement('span', null, '30'),
          React.createElement('span', null, '1—á'),
          React.createElement('span', null, '1.5—á'),
          React.createElement('span', null, '2—á'),
          React.createElement('span', null, '2.5—á'),
          React.createElement('span', null, '3—á')
        )
      ),

      // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã
      React.createElement('div', { className: 'household-presets' },
        HOUSEHOLD_PRESETS.map(p =>
          React.createElement('button', {
            key: p.value,
            type: 'button',
            className: 'household-preset' + (minutes === p.value ? ' active' : ''),
            onClick: () => handlePreset(p.value),
            style: minutes === p.value ? {
              backgroundColor: color,
              borderColor: color,
              color: '#fff'
            } : {}
          }, p.icon + ' ' + p.label)
        )
      ),

      // –°–µ–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è)
      React.createElement('div', { className: 'household-time-section' },
        React.createElement('div', { className: 'household-time-header' },
          React.createElement('span', { className: 'household-time-label' }, '‚è∞ –ö–æ–≥–¥–∞ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'),
          householdTime && React.createElement('span', { className: 'household-time-value-small' }, householdTime)
        ),
        React.createElement(TimePicker, {
          hours: currentHour,
          minutes: currentMinute,
          onHoursChange: setHour,
          onMinutesChange: setMinute,
          onTimeChange: setTime,
          hoursLabel: '',
          minutesLabel: '',
          display: null,
          linkedScroll: true,
          className: 'household-time-pickers compact'
        }),
        householdTime && React.createElement('button', {
          type: 'button',
          className: 'household-time-clear',
          onClick: () => {
            triggerHaptic(5);
            onChange({ ...data, householdTime: '' });
          }
        }, '‚úï –°–±—Ä–æ—Å–∏—Ç—å')
      )
    );
  }

  /**
   * HouseholdStatsStep ‚Äî –®–∞–≥ 2: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ + –≥—Ä–∞—Ñ–∏–∫ + –±–µ–π–¥–∂–∏ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å)
   * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ —á–µ—Ä–µ–∑ stepData.household_minutes
   */
  function HouseholdStatsComponent({ data, onChange, context, stepData }) {
    const { useMemo } = React;

    // –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ (household_minutes) ‚Äî –æ–Ω–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ
    const minutesData = stepData?.household_minutes || data || {};
    const minutes = minutesData.minutes ?? 0;
    const householdTime = minutesData.householdTime ?? '';
    const todayKey = new Date().toISOString().slice(0, 10);

    // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫–∞–ª–æ—Ä–∏–π
    const profile = useMemo(() => lsGet('heys_profile', {}), []);
    const weight = profile.weight || 70;
    const kcalBurned = calcHouseholdKcal(minutes, weight);

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é –∏ –º–µ—Å—è—Ü
    const weeklyStats = useMemo(() => getWeeklyHouseholdStats(), []);
    const monthlyStats = useMemo(() => getHouseholdMonthlyStats(), []);
    const history7 = weeklyStats.history || getHouseholdHistory(7);

    // –î–ª—è —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞
    const targetMin = 30;
    const maxSpark = Math.max(...history7.map(h => h.minutes), 90);
    const sparkBars = history7.slice().reverse();

    // –ë—ç–π–¥–∂–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    const showStreakBadge = monthlyStats.streak >= 3;
    const showMonthlyBadge = monthlyStats.total30 >= 500;

    // –¶–≤–µ—Ç
    const getColor = (min) => {
      if (min === 0) return '#94a3b8';
      if (min < 30) return '#eab308';
      if (min < 60) return '#22c55e';
      return '#10b981';
    };
    const color = getColor(minutes);

    return React.createElement('div', { className: 'step-household step-household-stats' },
      // –°–≤–æ–¥–∫–∞: —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ
      React.createElement('div', { className: 'household-summary' },
        React.createElement('div', { className: 'household-summary-main' },
          React.createElement('span', { className: 'household-summary-value', style: { color } }, minutes + ' –º–∏–Ω'),
          householdTime && React.createElement('span', { className: 'household-summary-time' }, ' –≤ ' + householdTime),
          kcalBurned > 0 && React.createElement('span', { className: 'household-summary-kcal' }, ' ‚Ä¢ üî• ' + kcalBurned + ' –∫–∫–∞–ª')
        )
      ),

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
      weeklyStats.daysWithData > 0 && React.createElement('div', { className: 'household-weekly-stats' },
        React.createElement('span', { className: 'household-stats-icon' }, 'üìä'),
        React.createElement('span', { className: 'household-stats-text' },
          '–í —Å—Ä–µ–¥–Ω–µ–º –∑–∞ –Ω–µ–¥–µ–ª—é: ' + weeklyStats.avg + ' –º–∏–Ω',
          weeklyStats.trend === 'up' && ' ‚Üë',
          weeklyStats.trend === 'down' && ' ‚Üì'
        )
      ),

      // –°–ø–∞—Ä–∫–ª–∞–π–Ω 7 –¥–Ω–µ–π
      React.createElement('div', { className: 'household-spark' },
        React.createElement('div', { className: 'household-spark-values' },
          sparkBars.map((h) => {
            const isToday = h.date === todayKey;
            return React.createElement('span', { key: h.date, className: isToday ? 'today' : '' },
              h.minutes > 0 ? `${h.minutes}` : '‚Äî'
            );
          })
        ),
        React.createElement('div', { className: 'household-spark-bars' },
          sparkBars.map((h) => {
            const isToday = h.date === todayKey;
            return React.createElement('div', {
              key: h.date,
              className: 'household-spark-bar' + (isToday ? ' today' : ''),
              title: `${h.date}: ${h.minutes} –º–∏–Ω`,
              style: { height: `${Math.max(10, (h.minutes / maxSpark) * 100)}%`, background: h.minutes >= targetMin ? '#10b981' : '#e5e7eb' }
            });
          })
        ),
        React.createElement('div', { className: 'household-spark-labels' },
          sparkBars.map((h) => {
            const isToday = h.date === todayKey;
            return React.createElement('span', { key: h.date, className: isToday ? 'today' : '' }, h.date.slice(8));
          })
        )
      ),

      // –ë—ç–π–¥–∂–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
      (showStreakBadge || showMonthlyBadge) && React.createElement('div', { className: 'household-badges' },
        showStreakBadge && React.createElement('span', { className: 'household-badge success' }, 'üèÖ ' + monthlyStats.streak + ' –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚â•30 –º–∏–Ω'),
        showMonthlyBadge && React.createElement('span', { className: 'household-badge info' }, 'üìÜ ' + monthlyStats.total30 + ' –º–∏–Ω –∑–∞ –º–µ—Å—è—Ü')
      ),

      // –ü—Ä–∏–º–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
      React.createElement('div', { className: 'household-examples' },
        React.createElement('div', { className: 'household-examples-title' }, 'üí° –ü—Ä–∏–º–µ—Ä—ã –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:'),
        React.createElement('div', { className: 'household-examples-grid' },
          HOUSEHOLD_EXAMPLES.slice(0, 6).map((ex, i) =>
            React.createElement('span', {
              key: i,
              className: 'household-example readonly',
              title: `MET: ${ex.met}`
            }, ex.icon + ' ' + ex.name)
          )
        )
      )
    );
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ 1: –ú–∏–Ω—É—Ç—ã –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  registerStep('household_minutes', {
    title: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
    hint: '–°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç?',
    icon: 'üè†',
    component: HouseholdMinutesComponent,
    getInitialData: (ctx) => {
      console.log('[Household getInitialData] ctx:', ctx);
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const editIndex = ctx?.editIndex ?? null;
      console.log('[Household getInitialData] dateKey:', dateKey, 'editIndex:', editIndex);
      const day = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      console.log('[Household getInitialData] day:', day);
      console.log('[Household getInitialData] day.householdActivities:', day.householdActivities);
      console.log('[Household getInitialData] day.householdMin:', day.householdMin);
      const weekly = getWeeklyHouseholdStats();

      // Backward compatible: householdActivities –º–∞—Å—Å–∏–≤ –∏–ª–∏ legacy householdMin
      const activities = day.householdActivities ||
        (day.householdMin > 0 ? [{ minutes: day.householdMin, time: day.householdTime || '' }] : []);
      console.log('[Household getInitialData] activities:', activities);

      // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é ‚Äî –±–µ—Ä—ë–º –µ—ë –¥–∞–Ω–Ω—ã–µ
      if (editIndex !== null && editIndex >= 0 && activities[editIndex]) {
        const activity = activities[editIndex];
        console.log('[Household getInitialData] EDIT MODE - activity:', activity);
        return {
          minutes: activity.minutes || 0,
          householdTime: activity.time || '',
          dateKey,
          editIndex
        };
      }

      console.log('[Household getInitialData] ADD MODE - using defaults');
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      return { minutes: weekly.avg || 30, householdTime: '', dateKey, editIndex: null };
    },
    save: (data) => {
      console.log('[Household save] data:', data);
      const dateKey = data.dateKey || new Date().toISOString().slice(0, 10);
      const editIndex = data.editIndex;
      console.log('[Household save] editIndex:', editIndex, 'typeof:', typeof editIndex);
      const day = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey }) || { date: dateKey };
      console.log('[Household save] day.householdActivities:', day.householdActivities);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if (!day.householdActivities) {
        // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (day.householdMin > 0) {
          day.householdActivities = [{ minutes: day.householdMin, time: day.householdTime || '' }];
        } else {
          day.householdActivities = [];
        }
      }

      const newActivity = { minutes: data.minutes, time: data.householdTime || '' };

      if (typeof editIndex === 'number' && editIndex >= 0 && editIndex < day.householdActivities.length) {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
        day.householdActivities[editIndex] = newActivity;
      } else {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π
        day.householdActivities.push(newActivity);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º legacy –ø–æ–ª—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      day.householdMin = day.householdActivities.reduce((sum, h) => sum + (+h.minutes || 0), 0);
      day.householdTime = day.householdActivities[0]?.time || '';
      day.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, day);

      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–Ω—è
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: {
          date: dateKey,
          field: 'householdActivities',
          value: day.householdActivities,
          householdMin: day.householdMin,
          householdTime: day.householdTime,
          source: 'household-step',
          forceReload: true
        }
      }));

      if (typeof window !== 'undefined' && data.minutes > 0) {
        window.dispatchEvent(new CustomEvent('heysHouseholdActivityAdded', {
          detail: { minutes: data.minutes, date: dateKey }
        }));
      }
    },
    xpAction: 'household_logged'
  });

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ 2: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (read-only)
  registerStep('household_stats', {
    title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    hint: '–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å',
    icon: 'üìä',
    component: HouseholdStatsComponent,
    canSkip: true,
    skipLabel: '–ì–æ—Ç–æ–≤–æ',
    getInitialData: (ctx, prevData) => {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ (household_minutes)
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const day = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ > –¥–∞–Ω–Ω—ã–µ –∏–∑ storage
      const minutes = prevData?.minutes ?? day.householdMin ?? 0;
      const householdTime = prevData?.householdTime ?? day.householdTime ?? '';
      return { minutes, householdTime, dateKey };
    }
    // –ù–ï–¢ save ‚Äî —ç—Ç–æ read-only —à–∞–≥ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  });

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —à–∞–≥–∞ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  registerStep('household', {
    title: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
    hint: '–í—Ä–µ–º—è –Ω–∞ –Ω–æ–≥–∞—Ö –ø–æ–º–∏–º–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
    icon: 'üè†',
    component: HouseholdMinutesComponent,  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∏–Ω—É—Ç—ã –≤ —Å—Ç–∞—Ä–æ–º —Ä–µ–∂–∏–º–µ
    getInitialData: (ctx) => {
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const day = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      const weekly = getWeeklyHouseholdStats();
      const minutes = day.householdMin || weekly.avg || 0;
      const householdTime = day.householdTime || '';
      return { minutes, householdTime, dateKey };
    },
    save: (data) => {
      const dateKey = data.dateKey || new Date().toISOString().slice(0, 10);
      const day = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey }) || { date: dateKey };
      day.householdMin = data.minutes;
      day.householdTime = data.householdTime || '';
      day.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, day);

      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–Ω—è
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'householdMin', value: data.minutes, householdTime: data.householdTime, source: 'household-step' }
      }));

      if (typeof window !== 'undefined' && data.minutes > 0) {
        window.dispatchEvent(new CustomEvent('heysHouseholdActivityAdded', {
          detail: { minutes: data.minutes, date: dateKey }
        }));
      }
    },
    xpAction: 'household_logged'
  });

  // ============================================================
  // CYCLE STEP ‚Äî –û—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥ (–º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª)
  // ============================================================

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —à–∞–≥ cycle?
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏:
   * 1. –í –ø—Ä–æ—Ñ–∏–ª–µ cycleTrackingEnabled = true
   */
  function shouldShowCycleStep() {
    try {
      const profile = lsGet('heys_profile', {});
      return profile.cycleTrackingEnabled === true;
    } catch {
      return false;
    }
  }

  /**
   * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —à–∞–≥–∞ "–û—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥" (v2 ‚Äî —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º)
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ stepData –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è)
   */
  function CycleStepComponent({ data, onChange, stepData, context }) {
    const { useState, useCallback, useEffect } = React;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª: –∏–∑ stepData (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) –∏–ª–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    const genderFromSteps = stepData?.['profile-personal']?.gender;
    const profile = lsGet('heys_profile', {});
    const gender = genderFromSteps || profile.gender;
    const isFemale = gender === '–ñ–µ–Ω—Å–∫–∏–π';

    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º cycleTrackingEnabled –∏–∑ —à–∞–≥–æ–≤ –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è
    const trackingFromSteps = stepData?.['profile-personal']?.cycleTrackingEnabled;
    const cycleTrackingEnabled = trackingFromSteps !== undefined ? trackingFromSteps : profile.cycleTrackingEnabled;

    // –ï—Å–ª–∏ –Ω–µ –∂–µ–Ω—â–∏–Ω–∞ –∏–ª–∏ —Ç—Ä–µ–∫–∏–Ω–≥ –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥
    const shouldSkip = !isFemale || cycleTrackingEnabled === false;

    // cycleDay: null = –Ω–µ—Ç –ø–µ—Ä–∏–æ–¥–∞, 1-7 = –¥–µ–Ω—å –ø–µ—Ä–∏–æ–¥–∞
    const [cycleDay, setCycleDay] = useState(data?.cycleDay || null);
    const [isEnabled, setIsEnabled] = useState(cycleDay !== null);
    const [showDayPicker, setShowDayPicker] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    const dateKey = data?._dateKey || new Date().toISOString().slice(0, 10);

    // –ê–≤—Ç–æ–ø—Ä–æ–ø—É—Å–∫ –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç —à–∞–≥
    useEffect(() => {
      if (shouldSkip && context?.onNext) {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º–∏–≥–∞–Ω–∏—è
        const timer = setTimeout(() => {
          onChange({ cycleDay: null, _skipped: true });
          context.onNext();
        }, 50);
        return () => clearTimeout(timer);
      }
    }, [shouldSkip, context, onChange]);

    // –ï—Å–ª–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    if (shouldSkip) {
      return React.createElement('div', { className: 'mc-cycle-step mc-cycle-skip' },
        React.createElement('div', { className: 'mc-cycle-header' },
          React.createElement('span', { className: 'mc-cycle-icon' }, 'üå∏'),
          React.createElement('span', { className: 'mc-cycle-title' }, '–ü—Ä–æ–ø—É—Å–∫–∞–µ–º...')
        )
      );
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ toggle "–î–∞/–ù–µ—Ç"
    const handleToggle = useCallback(() => {
      const newEnabled = !isEnabled;
      setIsEnabled(newEnabled);
      if (newEnabled) {
        // –í–∫–ª—é—á–∞–µ–º ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–Ω—è
        setShowDayPicker(true);
      } else {
        // –í—ã–∫–ª—é—á–∞–µ–º ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–Ω–∏
        setCycleDay(null);
        onChange({ cycleDay: null });
        setShowDayPicker(false);

        // –û—á–∏—â–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–Ω–∏
        if (HEYS.Cycle?.clearCycleDays) {
          HEYS.Cycle.clearCycleDays(dateKey, lsGet, lsSet);
        }
      }
    }, [isEnabled, onChange, dateKey]);

    // –í—ã–±–æ—Ä –¥–Ω—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –≤—Å–µ—Ö 7 –¥–Ω–µ–π
    const selectDay = useCallback((day) => {
      setCycleDay(day);
      onChange({ cycleDay: day });
      setShowDayPicker(false);

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ 7 –¥–Ω–µ–π
      if (HEYS.Cycle?.setCycleDaysAuto) {
        const result = HEYS.Cycle.setCycleDaysAuto(dateKey, day, lsGet, lsSet);
        console.log('[Cycle Step] Auto-filled', result.updated, 'days');
      }
    }, [onChange, dateKey]);

    // –ë—ã—Å—Ç—Ä—ã–µ –æ–ø—Ü–∏–∏
    const quickOptions = [
      { day: 1, label: '–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å', hint: '–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è' },
      { day: 2, label: '–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å', hint: '' },
      { day: 3, label: '–¢—Ä–µ—Ç–∏–π –¥–µ–Ω—å', hint: '' },
      { day: 4, label: '–°–µ—Ä–µ–¥–∏–Ω–∞', hint: '4-5 –¥–µ–Ω—å' },
      { day: 6, label: '–ü–æ—á—Ç–∏ –∫–æ–Ω–µ—Ü', hint: '6-7 –¥–µ–Ω—å' }
    ];

    return React.createElement('div', { className: 'mc-cycle-step' },
      // –í–æ–ø—Ä–æ—Å ‚Äî —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –æ —á—ë–º —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
      React.createElement('div', { className: 'mc-cycle-question' },
        '–°–µ–≥–æ–¥–Ω—è –æ—Å–æ–±—ã–µ –¥–Ω–∏?'
      ),

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å toggle
      React.createElement('div', { className: 'mc-cycle-header' },
        React.createElement('div', { className: 'mc-cycle-header-left' },
          React.createElement('span', { className: 'mc-cycle-icon' }, 'üå∏'),
          React.createElement('span', { className: 'mc-cycle-title' }, '–û—Å–æ–±—ã–µ –¥–Ω–∏')
        ),
        // Toggle –∫–Ω–æ–ø–∫–∞
        React.createElement('button', {
          type: 'button',
          className: 'mc-cycle-toggle ' + (isEnabled ? 'active' : ''),
          onClick: handleToggle,
          'aria-pressed': isEnabled
        }, isEnabled ? '–î–∞' : '–ù–µ—Ç')
      ),

      // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –∏ –µ—Å—Ç—å –¥–µ–Ω—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      isEnabled && cycleDay && !showDayPicker && React.createElement('div', { className: 'mc-cycle-status' },
        React.createElement('div', { className: 'mc-cycle-status-main' },
          React.createElement('span', { className: 'mc-cycle-status-day' }, '–î–µ–Ω—å ' + cycleDay),
          React.createElement('span', { className: 'mc-cycle-status-info' },
            cycleDay <= 3 ? '–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞' :
              cycleDay <= 5 ? '–°–µ—Ä–µ–¥–∏–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞' :
                '–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞'
          )
        ),
        React.createElement('button', {
          type: 'button',
          className: 'mc-cycle-change-btn',
          onClick: () => setShowDayPicker(true)
        }, '–ò–∑–º–µ–Ω–∏—Ç—å')
      ),

      // –í—ã–ø–∞–¥–∞—à–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–Ω—è
      isEnabled && showDayPicker && React.createElement('div', { className: 'mc-cycle-picker' },
        React.createElement('div', { className: 'mc-cycle-picker-title' },
          '–ö–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å?'
        ),

        // –ë—ã—Å—Ç—Ä—ã–µ –æ–ø—Ü–∏–∏
        React.createElement('div', { className: 'mc-cycle-options' },
          quickOptions.map(opt =>
            React.createElement('button', {
              key: opt.day,
              type: 'button',
              className: 'mc-cycle-option ' + (cycleDay === opt.day ? 'active' : ''),
              onClick: () => selectDay(opt.day)
            },
              React.createElement('span', { className: 'mc-cycle-option-day' }, opt.day),
              React.createElement('span', { className: 'mc-cycle-option-label' }, opt.label),
              opt.hint && React.createElement('span', { className: 'mc-cycle-option-hint' }, opt.hint)
            )
          )
        ),

        // –¢–æ—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–Ω—è (1-7)
        React.createElement('div', { className: 'mc-cycle-exact' },
          React.createElement('span', { className: 'mc-cycle-exact-label' }, '–¢–æ—á–Ω—ã–π –¥–µ–Ω—å:'),
          React.createElement('div', { className: 'mc-cycle-exact-days' },
            [1, 2, 3, 4, 5, 6, 7].map(d =>
              React.createElement('button', {
                key: d,
                type: 'button',
                className: 'mc-cycle-exact-btn ' + (cycleDay === d ? 'active' : ''),
                onClick: () => selectDay(d)
              }, d)
            )
          )
        ),

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ–± –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏
        React.createElement('div', { className: 'mc-cycle-auto-hint' },
          React.createElement('span', { className: 'mc-cycle-hint-icon' }, '‚ú®'),
          React.createElement('span', { className: 'mc-cycle-hint-text' },
            '–î–Ω–∏ 1-7 –ø—Ä–æ—Å—Ç–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
          )
        )
      ),

      // –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞
      !isEnabled && React.createElement('div', { className: 'mc-cycle-disabled-hint' },
        '–û—Ç–º–µ—á–∞–π—Ç–µ –¥–ª—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π'
      )
    );
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ –æ—Å–æ–±–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
  registerStep('cycle', {
    title: '–û—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥',
    hint: '–ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–æ—Ä–º',
    icon: 'üå∏',
    component: CycleStepComponent,
    canSkip: true,
    // shouldShow ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á—ë–Ω –ª–∏ tracking –≤ –ø—Ä–æ—Ñ–∏–ª–µ
    shouldShow: shouldShowCycleStep,
    getInitialData: (ctx) => {
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const day = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      return {
        cycleDay: day.cycleDay || null,
        _dateKey: dateKey
      };
    },
    save: (data) => {
      const dateKey = data._dateKey || new Date().toISOString().slice(0, 10);
      const cycleDay = data.cycleDay;

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ 7 –¥–Ω–µ–π
      if (cycleDay != null && cycleDay >= 1 && cycleDay <= 7) {
        // setCycleDaysAuto –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç –¥–Ω–∏ 1-7 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if (HEYS.Cycle && HEYS.Cycle.setCycleDaysAuto) {
          HEYS.Cycle.setCycleDaysAuto(dateKey, cycleDay, lsGet, lsSet);
        } else {
          // Fallback: –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–¥–∏–Ω –¥–µ–Ω—å
          const day = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey }) || { date: dateKey };
          day.cycleDay = cycleDay;
          day.updatedAt = Date.now();
          lsSet(`heys_dayv2_${dateKey}`, day);
        }
      } else if (cycleDay === null) {
        // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–Ω–∏ —Ü–∏–∫–ª–∞
        if (HEYS.Cycle && HEYS.Cycle.clearCycleDays) {
          HEYS.Cycle.clearCycleDays(dateKey, lsGet, lsSet);
        } else {
          // Fallback: –æ—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
          const day = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey }) || { date: dateKey };
          day.cycleDay = null;
          day.updatedAt = Date.now();
          lsSet(`heys_dayv2_${dateKey}`, day);
        }
      }

      // –¢—Ä–∏–≥–≥–µ—Ä –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      window.dispatchEvent(new CustomEvent('heys:data-saved', {
        detail: { key: `day:${dateKey}`, type: 'cycle' }
      }));

      // –£–≤–µ–¥–æ–º–ª—è–µ–º DayTab –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: {
          date: dateKey,
          field: 'cycleDay',
          value: data.cycleDay,
          source: 'cycle-step',
          updatedAt: Date.now()
        }
      }));
    },
    xpAction: 'cycle_logged'
  });

  // ============================================================
  // MEASUREMENTS STEP ‚Äî –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞ (–æ–±—Ö–≤–∞—Ç—ã: —Ç–∞–ª–∏—è, –±—ë–¥—Ä–∞, –±–µ–¥—Ä–æ, –±–∏—Ü–µ–ø—Å)
  // ============================================================

  const MEASUREMENT_FIELDS = [
    { key: 'waist', label: '–û–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏', icon: 'üìè', hint: '–ù–∞ —É—Ä–æ–≤–Ω–µ –ø—É–ø–∫–∞', min: 40, max: 150, hasSide: false },
    { key: 'hips', label: '–û–±—Ö–≤–∞—Ç –±—ë–¥–µ—Ä', icon: 'üçë', hint: '–ü–æ —è–≥–æ–¥–∏—Ü–∞–º', min: 60, max: 150, hasSide: false },
    { key: 'thigh', label: '–û–±—Ö–≤–∞—Ç –±–µ–¥—Ä–∞', icon: 'ü¶µ', hint: '–û–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞', min: 30, max: 100, hasSide: true },
    { key: 'biceps', label: '–û–±—Ö–≤–∞—Ç –±–∏—Ü–µ–ø—Å–∞', icon: 'üí™', hint: '–í –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–∏', min: 20, max: 60, hasSide: true }
  ];

  // –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–ª–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è) ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä
  const MEASUREMENT_SIDE_KEY = 'heys_measurement_side';
  function getMeasurementSide() {
    try { return lsGet(MEASUREMENT_SIDE_KEY, 'right'); } catch { return 'right'; }
  }
  function setMeasurementSide(side) {
    try { lsSet(MEASUREMENT_SIDE_KEY, side); } catch { }
  }

  /**
   * –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–º–µ—Ä–æ–≤ –∑–∞ 60 –¥–Ω–µ–π
   */
  function getLastMeasurements() {
    const today = new Date();
    for (let i = 0; i <= 60; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, null);
      if (!dayData || typeof dayData !== 'object') continue;
      const m = dayData.measurements;
      if (m && m.measuredAt && (m.waist || m.hips || m.thigh || m.biceps)) {
        return {
          ...m,
          daysAgo: i,
          foundDate: key
        };
      }
    }
    return {
      waist: null,
      hips: null,
      thigh: null,
      biceps: null,
      measuredAt: null,
      daysAgo: null,
      foundDate: null
    };
  }

  function getLastMeasurementByField(field) {
    const today = new Date();
    for (let i = 0; i <= 90; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};
      const m = dayData.measurements;
      if (m && m.measuredAt && m[field]) {
        return { value: m[field], date: key, daysAgo: i };
      }
    }
    return { value: null, date: null, daysAgo: null };
  }

  function getMeasurementsHistory(days = 30) {
    const today = new Date();
    const list = [];
    for (let i = 0; i < days; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${key}`, null);
      // –ó–∞—â–∏—Ç–∞ –æ—Ç null/undefined
      if (!dayData || typeof dayData !== 'object') continue;
      const m = dayData.measurements;
      if (m && m.measuredAt) {
        list.push({ date: key, ...m });
      }
    }
    return list;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —à–∞–≥ –∑–∞–º–µ—Ä–æ–≤ (–ø—Ä–æ—à–ª–æ ‚â•7 –¥–Ω–µ–π)
   */
  function shouldShowMeasurements() {
    const last = getLastMeasurements();
    if (!last.measuredAt) return true; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª—ã–π –∑–∞–º–µ—Ä –±—ã–ª –Ω–µ–ø–æ–ª–Ω—ã–º ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    if (last.waist && (!last.hips || !last.thigh || !last.biceps)) return true;

    const lastDate = new Date(last.measuredAt);
    const today = new Date();
    const diffMs = today - lastDate;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    return diffDays >= 7;
  }

  function MeasurementsStepComponent({ data, onChange }) {
    const lastMeasurements = useMemo(() => getLastMeasurements(), []);

    // –°—Ç–æ—Ä–æ–Ω–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ª–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è)
    const [side, setSideState] = useState(() => getMeasurementSide());
    const setSide = (newSide) => {
      setSideState(newSide);
      setMeasurementSide(newSide);
    };

    // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π state –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑ data
    const [inputValues, setInputValues] = useState(() => {
      const init = {};
      MEASUREMENT_FIELDS.forEach(f => {
        if (data[f.key] !== null && data[f.key] !== undefined) {
          init[f.key] = String(data[f.key]);
        }
      });
      return init;
    });

    const lastByField = useMemo(() => {
      const res = {};
      MEASUREMENT_FIELDS.forEach((f) => {
        res[f.key] = getLastMeasurementByField(f.key);
      });
      return res;
    }, []);

    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ: –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ state
    const getInputValue = (key) => {
      return inputValues[key] ?? '';
    };

    const handleInputChange = (key, textValue) => {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å (–¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
      setInputValues(prev => ({ ...prev, [key]: textValue }));

      // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      const cleaned = textValue.replace(',', '.');
      if (cleaned === '' || cleaned === '.') {
        onChange({ ...data, [key]: null });
      } else {
        const num = parseFloat(cleaned);
        if (!isNaN(num)) {
          onChange({ ...data, [key]: num });
        }
      }
    };

    const handleFocus = (key, e) => {
      // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –≤—ã–¥–µ–ª—è–µ–º –≤—Å—ë
      e.target.select();
    };

    const lastMeasuredInfo = lastMeasurements.measuredAt
      ? `–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä: ${lastMeasurements.daysAgo === 0 ? '—Å–µ–≥–æ–¥–Ω—è' : lastMeasurements.daysAgo === 1 ? '–≤—á–µ—Ä–∞' : lastMeasurements.daysAgo + ' –¥–Ω. –Ω–∞–∑–∞–¥'}`
      : '–ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä';

    return React.createElement('div', { className: 'mc-measurements-step' },
      React.createElement('div', { className: 'mc-measurements-info' },
        React.createElement('span', { className: 'mc-measurements-info-icon' }, 'üìÖ'),
        React.createElement('span', { className: 'mc-measurements-info-text' }, lastMeasuredInfo)
      ),

      React.createElement('div', { className: 'mc-measurements-fields' },
        MEASUREMENT_FIELDS.map(field => {
          const numValue = data[field.key];
          const last = lastByField[field.key];
          const placeholder = last.value ? String(last.value) : '‚Äî';
          const delta = last.value && numValue ? numValue - last.value : null;
          const deltaPct = (last.value && numValue) ? (numValue - last.value) / last.value : null;
          const showWarning = deltaPct !== null && Math.abs(deltaPct) > 0.15;
          const progressLabel = last.value && numValue ? `${delta > 0 ? '+' : ''}${(Math.round(delta * 10) / 10)} —Å–º` : null;

          return React.createElement('div', {
            key: field.key,
            className: 'mc-measurement-field'
          },
            React.createElement('div', { className: 'mc-measurement-header' },
              React.createElement('span', { className: 'mc-measurement-icon' }, field.icon),
              React.createElement('span', { className: 'mc-measurement-label' }, field.label),
              last.value && React.createElement('span', { className: 'mc-measurement-prev' }, `–±—ã–ª–æ: ${last.value}`)
            ),
            React.createElement('div', { className: 'mc-measurement-input-row' },
              React.createElement('input', {
                type: 'text',
                inputMode: 'decimal',
                pattern: '[0-9]*\\.?[0-9]*',
                className: 'mc-measurement-input',
                value: getInputValue(field.key),
                placeholder,
                onFocus: (e) => handleFocus(field.key, e),
                onChange: (e) => handleInputChange(field.key, e.target.value)
              }),
              React.createElement('span', { className: 'mc-measurement-unit' }, '—Å–º'),
              progressLabel && React.createElement('span', {
                className: 'mc-measurement-delta' + (delta > 0 ? ' up' : delta < 0 ? ' down' : '')
              }, progressLabel)
            ),
            !last.value && React.createElement('div', { className: 'mc-measurement-no-data' }, '–ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä'),
            showWarning && React.createElement('div', { className: 'mc-measurement-warning', role: 'alert' }, '‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–æ–¥'),
            // –•–∏–Ω—Ç + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–æ—Ä–æ–Ω—ã –¥–ª—è –±–µ–¥—Ä–∞/–±–∏—Ü–µ–ø—Å–∞
            React.createElement('div', { className: 'mc-measurement-hint' },
              field.hasSide
                ? `${field.hint} (${side === 'left' ? '–ª–µ–≤–∞—è' : '–ø—Ä–∞–≤–∞—è'})`
                : field.hint
            )
          );
        })
      ),

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç–æ—Ä–æ–Ω—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—è —Å hasSide)
      MEASUREMENT_FIELDS.some(f => f.hasSide) && React.createElement('div', { className: 'mc-measurements-side-toggle' },
        React.createElement('span', { className: 'mc-measurements-side-label' }, '–°—Ç–æ—Ä–æ–Ω–∞ –∑–∞–º–µ—Ä–∞:'),
        React.createElement('div', { className: 'mc-measurements-side-buttons' },
          React.createElement('button', {
            type: 'button',
            className: 'mc-measurements-side-btn' + (side === 'left' ? ' active' : ''),
            onClick: () => setSide('left')
          }, '‚Üê –õ–µ–≤–∞—è'),
          React.createElement('button', {
            type: 'button',
            className: 'mc-measurements-side-btn' + (side === 'right' ? ' active' : ''),
            onClick: () => setSide('right')
          }, '–ü—Ä–∞–≤–∞—è ‚Üí')
        )
      ),

      React.createElement('div', { className: 'mc-measurements-tip' },
        React.createElement('span', { className: 'mc-measurements-tip-icon' }, 'üí°'),
        React.createElement('span', { className: 'mc-measurements-tip-text' },
          '–ú–µ—Ä—å—Ç–µ —É—Ç—Ä–æ–º, –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞, –±–µ–∑ –æ–¥–µ–∂–¥—ã'
        )
      )
    );
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ –∑–∞–º–µ—Ä–æ–≤
  registerStep('measurements', {
    title: '–ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞',
    hint: '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å',
    icon: 'üìè',
    component: MeasurementsStepComponent,
    canSkip: true,  // –ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    getInitialData: (context = {}) => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –∏–∑ context –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è
      const dateKey = context.dateKey || getTodayKey();

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º lsGet ‚Äî –æ–Ω:
      // 1. –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ scoped-–∫–ª—é—á–∞–º–∏ (clientId)
      // 2. –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ (¬§Z¬§ prefix)
      // 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –æ–±–ª–∞–∫–æ–º —á–µ—Ä–µ–∑ HEYS.store
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {});

      const m = dayData?.measurements || {};
      return {
        waist: m.waist ?? null,
        hips: m.hips ?? null,
        thigh: m.thigh ?? null,
        biceps: m.biceps ?? null,
        _dateKey: dateKey // –ü–µ—Ä–µ–¥–∞—ë–º –¥–∞—Ç—É –¥–ª—è save
      };
    },
    save: (data) => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –∏–∑ data._dateKey (–ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∏–∑ getInitialData) –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è
      const dateKey = data._dateKey || getTodayKey();
      const dayData = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey });
      const hasData = ['waist', 'hips', 'thigh', 'biceps'].some(k => data[k] !== null && data[k] !== undefined && !Number.isNaN(data[k]));

      if (hasData) {
        const newUpdatedAt = Date.now();
        dayData.measurements = {
          waist: data.waist ?? null,
          hips: data.hips ?? null,
          thigh: data.thigh ?? null,
          biceps: data.biceps ?? null,
          measuredAt: dateKey
        };
        dayData.updatedAt = newUpdatedAt;
        lsSet(`heys_dayv2_${dateKey}`, dayData);

        // –¢—Ä–∏–≥–≥–µ—Ä –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        window.dispatchEvent(new CustomEvent('heys:data-saved', {
          detail: { key: `day:${dateKey}`, type: 'measurements' }
        }));

        // –£–≤–µ–¥–æ–º–ª—è–µ–º DayTab –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (—Å forceReload)
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: {
            date: dateKey,
            field: 'measurements',
            value: dayData.measurements,
            source: 'measurements-step',
            updatedAt: newUpdatedAt,
            forceReload: true
          }
        }));
      }
    },
    xpAction: 'measurements_logged'
  });

  // ============================================================
  // COLD EXPOSURE STEP ‚Äî üßä –•–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ
  // v3.2.1: –£–ª—É—á—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ ~5-12%
  // v3.3.0: –î–æ–±–∞–≤–ª–µ–Ω—ã 3 —Å–ª–∞–π–¥–µ—Ä–∞ –æ—Ü–µ–Ω–æ–∫ (mood, wellbeing, stress)
  // ============================================================

  const COLD_TYPES = [
    { id: 'none', icon: 'üöø', label: '–ù–µ—Ç', desc: '–û–±—ã—á–Ω—ã–π –¥—É—à' },
    { id: 'coldShower', icon: 'üßä', label: '–•–æ–ª–æ–¥–Ω—ã–π –¥—É—à', desc: '2-3 –º–∏–Ω, -5% –≤–æ–ª–Ω–∞' },
    { id: 'coldBath', icon: 'üõÅ', label: '–•–æ–ª–æ–¥–Ω–∞—è –≤–∞–Ω–Ω–∞', desc: '10+ –º–∏–Ω, -10% –≤–æ–ª–Ω–∞' },
    { id: 'coldSwim', icon: 'üèä', label: '–ú–æ—Ä–∂–µ–≤–∞–Ω–∏–µ', desc: '5+ –º–∏–Ω, -12% –≤–æ–ª–Ω–∞' }
  ];

  // Emoji –¥–ª—è –æ—Ü–µ–Ω–æ–∫ —Ö–æ–ª–æ–¥–∞
  const COLD_MOOD_EMOJI = ['üò¢', 'üò¢', 'üòï', 'üòï', 'üòê', 'üòê', 'üôÇ', 'üôÇ', 'üòä', 'üòä', 'üòÑ'];
  const COLD_WELLBEING_EMOJI = ['ü•∂', 'ü•∂', 'üòì', 'üòì', 'üòê', 'üòê', 'üôÇ', 'üôÇ', 'üí™', 'üí™', 'üî•'];
  const COLD_STRESS_EMOJI = ['üòå', 'üòå', 'üôÇ', 'üôÇ', 'üòê', 'üòê', 'üòü', 'üòü', 'üò∞', 'üò∞', 'üò±'];

  // –ü—Ä–µ—Å–µ—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
  const COLD_PRESETS_POSITIVE = [
    { emoji: 'üëé', value: 2, label: '–ü–ª–æ—Ö–æ' },
    { emoji: 'üëå', value: 5, label: '–ù–æ—Ä–º' },
    { emoji: 'üëç', value: 8, label: '–•–æ—Ä–æ—à–æ' }
  ];
  const COLD_PRESETS_NEGATIVE = [
    { emoji: 'üòå', value: 2, label: '–°–ø–æ–∫–æ–µ–Ω' },
    { emoji: 'üòê', value: 5, label: '–°—Ä–µ–¥–Ω–µ' },
    { emoji: 'üò∞', value: 8, label: '–°—Ç—Ä–µ—Å—Å' }
  ];

  // –¶–≤–µ—Ç–∞ –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —à–∫–∞–ª
  const getColdPositiveColor = (v) => {
    if (v <= 3) return '#ef4444';
    if (v <= 5) return '#3b82f6';
    if (v <= 7) return '#22c55e';
    return '#10b981';
  };

  // –¶–≤–µ—Ç–∞ –¥–ª—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —à–∫–∞–ª (stress)
  const getColdNegativeColor = (v) => {
    if (v <= 3) return '#10b981';
    if (v <= 5) return '#3b82f6';
    if (v <= 7) return '#eab308';
    return '#ef4444';
  };

  // –¢–µ–∫—Å—Ç –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π
  const getColdMoodText = (v) => v <= 2 ? '–ü–ª–æ—Ö–æ' : v <= 4 ? '–¢–∞–∫ —Å–µ–±–µ' : v <= 6 ? '–ù–æ—Ä–º' : v <= 8 ? '–•–æ—Ä–æ—à–æ' : '–û—Ç–ª–∏—á–Ω–æ';
  const getColdWellbeingText = (v) => v <= 2 ? '–ó–∞–º—ë—Ä–∑' : v <= 4 ? '–•–æ–ª–æ–¥–Ω–æ' : v <= 6 ? '–¢–µ—Ä–ø–∏–º–æ' : v <= 8 ? '–ë–æ–¥—Ä–∏—Ç' : '–û–≥–æ–Ω—å!';
  const getColdStressText = (v) => v <= 2 ? '–°–ø–æ–∫–æ–µ–Ω' : v <= 4 ? '–ù–µ–º–Ω–æ–≥–æ' : v <= 6 ? '–°—Ä–µ–¥–Ω–µ' : v <= 8 ? '–ú–Ω–æ–≥–æ' : '–û—á–µ–Ω—å';

  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ª–∞–π–¥–µ—Ä–∞ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —Ö–æ–ª–æ–¥–∞
  function ColdRatingSlider({ field, value, emoji, title, presets, getColor, getText, isNegative, onChange }) {
    const color = getColor(value);
    return React.createElement('div', {
      className: 'cold-rating-card',
      style: {
        padding: '12px',
        borderRadius: '10px',
        background: isNegative
          ? (value <= 3 ? 'rgba(16, 185, 129, 0.08)' : value >= 7 ? 'rgba(239, 68, 68, 0.08)' : 'rgba(59, 130, 246, 0.06)')
          : (value <= 3 ? 'rgba(239, 68, 68, 0.08)' : value >= 7 ? 'rgba(16, 185, 129, 0.08)' : 'rgba(59, 130, 246, 0.06)'),
        marginBottom: '8px'
      }
    },
      React.createElement('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          marginBottom: '8px'
        }
      },
        // Emoji + –∑–∞–≥–æ–ª–æ–≤–æ–∫
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
          React.createElement('span', { style: { fontSize: '20px' } }, emoji),
          React.createElement('span', { style: { fontWeight: '600', fontSize: '13px' } }, title)
        ),
        // –ó–Ω–∞—á–µ–Ω–∏–µ + —Ç–µ–∫—Å—Ç
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } },
          React.createElement('span', {
            style: {
              fontWeight: '700',
              fontSize: '16px',
              color: color
            }
          }, value),
          React.createElement('span', {
            style: { fontSize: '12px', color: '#64748b' }
          }, getText(value))
        )
      ),
      // –ü—Ä–µ—Å–µ—Ç—ã
      React.createElement('div', {
        style: {
          display: 'flex',
          gap: '6px',
          marginBottom: '8px'
        }
      },
        presets.map(p => React.createElement('button', {
          key: p.value,
          onClick: () => onChange(p.value),
          style: {
            flex: 1,
            padding: '6px',
            borderRadius: '6px',
            border: value === p.value ? `2px solid ${color}` : '1px solid #e2e8f0',
            background: value === p.value ? `${color}15` : '#fff',
            cursor: 'pointer',
            fontSize: '14px',
            transition: 'all 0.15s'
          }
        }, p.emoji))
      ),
      // –°–ª–∞–π–¥–µ—Ä
      React.createElement('input', {
        type: 'range',
        min: 1,
        max: 10,
        value: value,
        onChange: (e) => onChange(Number(e.target.value)),
        style: {
          width: '100%',
          height: '6px',
          borderRadius: '3px',
          appearance: 'none',
          background: `linear-gradient(to right, ${color} ${(value - 1) * 11.1}%, #e5e7eb ${(value - 1) * 11.1}%)`,
          cursor: 'pointer'
        }
      })
    );
  }

  function ColdExposureStepComponent({ data, onChange }) {
    const selectedType = data.coldType || 'none';
    const time = data.coldTime || new Date().toTimeString().slice(0, 5);

    return React.createElement('div', { className: 'mc-cold-step' },
      // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
      React.createElement('div', {
        style: {
          display: 'grid',
          gridTemplateColumns: 'repeat(2, 1fr)',
          gap: '12px',
          marginBottom: '16px'
        }
      },
        COLD_TYPES.map(t => React.createElement('button', {
          key: t.id,
          onClick: () => onChange({ ...data, coldType: t.id, coldTime: t.id !== 'none' ? time : null }),
          style: {
            padding: '12px',
            borderRadius: '12px',
            border: selectedType === t.id ? '2px solid #3b82f6' : '2px solid #e2e8f0',
            background: selectedType === t.id ? 'rgba(59, 130, 246, 0.1)' : '#fff',
            cursor: 'pointer',
            textAlign: 'left',
            transition: 'all 0.2s'
          }
        },
          React.createElement('div', { style: { fontSize: '24px', marginBottom: '4px' } }, t.icon),
          React.createElement('div', { style: { fontWeight: '600', fontSize: '13px' } }, t.label),
          React.createElement('div', { style: { fontSize: '11px', color: '#64748b' } }, t.desc)
        ))
      ),
      // –í—Ä–µ–º—è (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —á—Ç–æ-—Ç–æ –∫—Ä–æ–º–µ "–Ω–µ—Ç")
      selectedType !== 'none' && React.createElement('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '12px',
          padding: '12px',
          background: 'rgba(59, 130, 246, 0.05)',
          borderRadius: '8px',
          marginBottom: '16px'
        }
      },
        React.createElement('span', { style: { fontSize: '14px', color: '#64748b' } }, '‚è∞ –í—Ä–µ–º—è:'),
        React.createElement('input', {
          type: 'time',
          value: time,
          onChange: (e) => onChange({ ...data, coldTime: e.target.value }),
          style: {
            padding: '8px 12px',
            borderRadius: '8px',
            border: '1px solid #e2e8f0',
            fontSize: '16px',
            fontWeight: '600'
          }
        })
      ),
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø–æ–ª—å–∑–µ
      selectedType !== 'none' && React.createElement('div', {
        style: {
          padding: '10px',
          background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.15))',
          borderRadius: '8px',
          fontSize: '12px',
          color: '#3b82f6'
        }
      },
        'üí° –•–æ–ª–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –±—É—Ä—ã–π –∂–∏—Ä –∏ —É–ª—É—á—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É –Ω–∞ 4-5 —á–∞—Å–æ–≤'
      )
    );
  }

  registerStep('cold_exposure', {
    title: '–•–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ',
    hint: '–ë—ã–ª –ª–∏ —Ö–æ–ª–æ–¥–Ω—ã–π –¥—É—à?',
    icon: 'üßä',
    canSkip: true,
    component: ColdExposureStepComponent,
    getInitialData: () => {
      const dateKey = getTodayKey();
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
      const cold = dayData.coldExposure ?? {};  // null-safe: ?? –≤–º–µ—Å—Ç–æ ||
      return {
        coldType: cold.type || 'none',
        coldTime: cold.time || new Date().toTimeString().slice(0, 5),
        _dateKey: dateKey
      };
    },
    save: (data) => {
      const dateKey = data._dateKey || getTodayKey();
      const dayData = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey });

      if (data.coldType && data.coldType !== 'none') {
        dayData.coldExposure = {
          type: data.coldType,
          time: data.coldTime
        };
      } else {
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–Ω–µ—Ç" ‚Äî —É–¥–∞–ª—è–µ–º —Ö–æ–ª–æ–¥
        if (dayData.coldExposure) {
          delete dayData.coldExposure;
        }
      }

      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, dayData);

      window.dispatchEvent(new CustomEvent('heys:data-saved', {
        detail: { key: `day:${dateKey}`, type: 'coldExposure' }
      }));
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'coldExposure', source: 'cold-exposure-step' }
      }));
    },
    xpAction: 'cold_exposure_logged'
  });

  // ============================================================
  // MORNING MOOD STEP ‚Äî üìä –£—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)
  // –î–µ—Ñ–æ–ª—Ç = —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –≤—á–µ—Ä–∞
  // WOW-—ç—Ñ—Ñ–µ–∫—Ç—ã: staggered animation, –ø—Ä–µ—Å–µ—Ç—ã, pulse, –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã
  // ============================================================

  // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è –æ—Ü–µ–Ω–æ–∫ (–∫–∞–∫ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ)
  function getMoodEmoji(v) {
    if (v <= 2) return 'üò´';
    if (v <= 4) return 'üòï';
    if (v <= 6) return 'üòê';
    if (v <= 8) return 'üòä';
    return 'ü§©';
  }

  function getStressEmoji(v) {
    if (v <= 2) return 'üòå';
    if (v <= 4) return 'üôÇ';
    if (v <= 6) return 'üòê';
    if (v <= 8) return 'üòü';
    return 'üò∞';
  }

  function getWellbeingEmoji(v) {
    if (v <= 2) return 'ü§í';
    if (v <= 4) return 'üòì';
    if (v <= 6) return 'üòê';
    if (v <= 8) return 'üí™';
    return 'üèÜ';
  }

  function getMoodColor(v) {
    if (v <= 2) return '#ef4444';
    if (v <= 4) return '#f97316';
    if (v <= 6) return '#eab308';
    if (v <= 8) return '#22c55e';
    return '#10b981';
  }

  function getStressColor(v) {
    if (v <= 2) return '#10b981';
    if (v <= 4) return '#22c55e';
    if (v <= 6) return '#eab308';
    if (v <= 8) return '#f97316';
    return '#ef4444';
  }

  // Haptic feedback
  const hapticLight = () => {
    try { navigator.vibrate?.(5); } catch { }
  };

  // –ü—Ä–µ—Å–µ—Ç—ã –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ (5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
  const MOOD_PRESETS = [
    { value: 2, emoji: 'üò´' },
    { value: 4, emoji: 'üòû' },
    { value: 6, emoji: 'üòê' },
    { value: 8, emoji: 'üòä' },
    { value: 10, emoji: 'üî•' }
  ];

  const STRESS_PRESETS = [
    { value: 2, emoji: 'üòå' },
    { value: 4, emoji: 'üôÇ' },
    { value: 6, emoji: 'üòê' },
    { value: 8, emoji: 'üòü' },
    { value: 10, emoji: 'üò∞' }
  ];

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ –≤—á–µ—Ä–∞
  function getYesterdayMoodAvg() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const key = yesterday.toISOString().slice(0, 10);
    // üîß FIX: –î–æ–±–∞–≤–ª—è–µ–º || {} –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ lsGet –≤–µ—Ä–Ω—ë—Ç null
    const dayData = lsGet(`heys_dayv2_${key}`, {}) || {};

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å (–∏–∑ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ + —É—Ç—Ä–µ–Ω–Ω–µ–µ)
    const moodValues = [];
    const wellbeingValues = [];
    const stressValues = [];

    // –£—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    if (dayData.moodMorning) moodValues.push(dayData.moodMorning);
    if (dayData.wellbeingMorning) wellbeingValues.push(dayData.wellbeingMorning);
    if (dayData.stressMorning) stressValues.push(dayData.stressMorning);

    // –ò–∑ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
    if (dayData.meals && dayData.meals.length > 0) {
      dayData.meals.forEach(meal => {
        if (meal.mood) moodValues.push(meal.mood);
        if (meal.wellbeing) wellbeingValues.push(meal.wellbeing);
        if (meal.stress) stressValues.push(meal.stress);
      });
    }

    const avg = arr => arr.length > 0 ? Math.round(arr.reduce((a, b) => a + b, 0) / arr.length) : 5;

    return {
      mood: avg(moodValues),
      wellbeing: avg(wellbeingValues),
      stress: avg(stressValues)
    };
  }

  // CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
  if (typeof document !== 'undefined' && !document.getElementById('morning-mood-styles')) {
    const style = document.createElement('style');
    style.id = 'morning-mood-styles';
    style.textContent = `
      @keyframes moodPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
      }
      @keyframes emojiPop {
        0% { transform: scale(0.9); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
      }
      .mood-value-pulse {
        animation: moodPulse 0.25s ease-out;
      }
      .mood-emoji-pop {
        animation: emojiPop 0.2s ease-out;
      }
      .mood-preset-btn {
        transition: background 0.1s, border-color 0.1s;
      }
      .mood-preset-btn:active {
        transform: scale(0.95);
      }
    `;
    document.head.appendChild(style);
  }

  function MorningMoodStepComponent({ data, onChange }) {
    const mood = data.mood ?? 5;
    const wellbeing = data.wellbeing ?? 5;
    const stress = data.stress ?? 5;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ pulse
    const [pulsingField, setPulsingField] = useState(null);
    const [poppingEmoji, setPoppingEmoji] = useState(null);

    const updateField = (field, value) => {
      hapticLight();
      onChange({ ...data, [field]: value });

      // –ó–∞–ø—É—Å–∫–∞–µ–º pulse-–∞–Ω–∏–º–∞—Ü–∏—é
      setPulsingField(field);
      setPoppingEmoji(field);
      setTimeout(() => setPulsingField(null), 300);
      setTimeout(() => setPoppingEmoji(null), 250);
    };

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–¥–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏ –∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
    const RatingCard = ({ field, value, emoji, emojiFn, title, color, colorFn, presets, isNegative, index }) => {
      return React.createElement('div', {
        className: 'mood-rating-card',
        style: {
          padding: '10px 12px',
          borderRadius: '12px',
          background: 'var(--card, #fff)',
          boxShadow: '0 1px 4px rgba(0,0,0,0.08)',
          border: '1px solid #e2e8f0'
        }
      },
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —ç–º–æ–¥–∑–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º
        React.createElement('div', {
          style: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            marginBottom: '6px'
          }
        },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
            React.createElement('span', {
              className: poppingEmoji === field ? 'mood-emoji-pop' : '',
              style: { fontSize: '22px', transition: 'all 0.2s' }
            }, emojiFn(value)),
            React.createElement('span', { style: { fontWeight: '600', fontSize: '14px', color: 'var(--text, #1e293b)' } }, title)
          ),
          React.createElement('span', {
            className: pulsingField === field ? 'mood-value-pulse' : '',
            style: {
              fontWeight: '700',
              fontSize: '18px',
              color: colorFn(value),
              minWidth: '45px',
              textAlign: 'right'
            }
          }, value + '/10')
        ),

        // –ü—Ä–µ—Å–µ—Ç—ã –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ (5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
        React.createElement('div', {
          style: {
            display: 'flex',
            gap: '4px',
            marginBottom: '6px'
          }
        },
          presets.map(p => {
            const isSelected = value === p.value;
            const btnColor = colorFn(p.value);
            return React.createElement('button', {
              key: p.value,
              className: 'mood-preset-btn',
              onClick: () => updateField(field, p.value),
              style: {
                flex: 1,
                padding: '6px 2px',
                borderRadius: '8px',
                border: isSelected ? `2px solid ${btnColor}` : '1px solid #e5e7eb',
                background: isSelected ? `${btnColor}20` : '#fff',
                cursor: 'pointer',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                minHeight: '36px'
              }
            },
              React.createElement('span', { style: { fontSize: '20px' } }, p.emoji)
            );
          })
        ),

        // –°–ª–∞–π–¥–µ—Ä ‚Äî –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ tap
        React.createElement('input', {
          type: 'range',
          className: 'mc-quality-slider',
          min: 1,
          max: 10,
          value: value,
          onChange: e => {
            updateField(field, Number(e.target.value));
          },
          style: {
            background: isNegative
              ? `linear-gradient(to right, #10b981 0%, #22c55e 30%, #eab308 50%, #f97316 70%, #ef4444 100%)`
              : `linear-gradient(to right, #ef4444 0%, #f97316 30%, #eab308 50%, #22c55e 70%, #10b981 100%)`
          }
        })
      );
    };

    return React.createElement('div', {
      className: 'ts-step morning-mood-step',
      style: { opacity: 1 }
    },

      // === –ó–∞–≥–æ–ª–æ–≤–æ–∫ ===
      React.createElement('div', {
        style: {
          textAlign: 'center',
          marginBottom: '12px',
          padding: '10px',
          background: 'linear-gradient(135deg, #f59e0b, #ea580c)',
          borderRadius: '12px'
        }
      },
        React.createElement('div', { style: { fontSize: '26px', marginBottom: '2px' } }, 'üåÖ'),
        React.createElement('div', { style: { fontWeight: '700', fontSize: '15px', color: '#fff', textShadow: '0 1px 2px rgba(0,0,0,0.2)' } },
          '–ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?'
        )
      ),

      // === –û—Ü–µ–Ω–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π ===
      React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },

        // –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        React.createElement(RatingCard, {
          field: 'mood',
          value: mood,
          emojiFn: getMoodEmoji,
          title: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
          colorFn: getMoodColor,
          presets: MOOD_PRESETS,
          isNegative: false,
          index: 0
        }),

        // –ë–æ–¥—Ä–æ—Å—Ç—å
        React.createElement(RatingCard, {
          field: 'wellbeing',
          value: wellbeing,
          emojiFn: getWellbeingEmoji,
          title: '–ë–æ–¥—Ä–æ—Å—Ç—å',
          colorFn: getMoodColor,
          presets: MOOD_PRESETS,
          isNegative: false,
          index: 1
        }),

        // –°—Ç—Ä–µ—Å—Å
        React.createElement(RatingCard, {
          field: 'stress',
          value: stress,
          emojiFn: getStressEmoji,
          title: '–°—Ç—Ä–µ—Å—Å',
          colorFn: getStressColor,
          presets: STRESS_PRESETS,
          isNegative: true,
          index: 2
        })
      ),

      // === –ü–æ–¥—Å–∫–∞–∑–∫–∞ ===
      React.createElement('div', {
        style: {
          marginTop: '16px',
          padding: '10px 14px',
          background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.06), rgba(147, 197, 253, 0.08))',
          borderRadius: '10px',
          fontSize: '12px',
          color: '#64748b',
          textAlign: 'center'
        }
      }, 'üí° –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–æ–≥—É—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ –µ–¥—ã –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ')
    );
  }

  registerStep('morning_mood', {
    title: '–£—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
    hint: '–ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?',
    icon: 'üòä',
    canSkip: false, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥!
    component: MorningMoodStepComponent,
    getInitialData: () => {
      const dateKey = getTodayKey();
      // üîß FIX: –î–æ–±–∞–≤–ª—è–µ–º || {} –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ lsGet –≤–µ—Ä–Ω—ë—Ç null (–Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç)
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};

      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –±–µ—Ä—ë–º –∏—Ö
      if (dayData.moodMorning !== undefined) {
        return {
          mood: dayData.moodMorning,
          wellbeing: dayData.wellbeingMorning ?? 5,
          stress: dayData.stressMorning ?? 5,
          _dateKey: dateKey
        };
      }

      // –ò–Ω–∞—á–µ –±–µ—Ä—ë–º —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –≤—á–µ—Ä–∞
      const yesterdayAvg = getYesterdayMoodAvg();
      return {
        mood: yesterdayAvg.mood,
        wellbeing: yesterdayAvg.wellbeing,
        stress: yesterdayAvg.stress,
        _dateKey: dateKey
      };
    },
    save: (data) => {
      const dateKey = data._dateKey || getTodayKey();
      const dayData = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey });

      dayData.moodMorning = data.mood ?? 5;
      dayData.wellbeingMorning = data.wellbeing ?? 5;
      dayData.stressMorning = data.stress ?? 5;

      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, dayData);

      window.dispatchEvent(new CustomEvent('heys:data-saved', {
        detail: { key: `day:${dateKey}`, type: 'morningMood' }
      }));
      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'morningMood', source: 'morning-mood-step', forceReload: true }
      }));
    },
    xpAction: 'morning_mood_logged'
  });

  // ============================================================
  // MORNING ROUTINE STEP ‚Äî –ó–∞–≤–µ—Ä—à–∞—é—â–∏–π –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —à–∞–≥
  // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é
  // ============================================================

  function MorningRoutineStepComponent({ data, onChange, context }) {
    const [checkedItems, setCheckedItems] = useState(data.checkedItems || []);
    const [showConfetti, setShowConfetti] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º —É—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
    const dateKey = getTodayKey();
    // üîß FIX: –î–æ–±–∞–≤–ª—è–µ–º || {} –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ lsGet –≤–µ—Ä–Ω—ë—Ç null
    const dayData = lsGet(`heys_dayv2_${dateKey}`, {}) || {};
    const morningMood = dayData.moodMorning ?? 5;
    const morningWellbeing = dayData.wellbeingMorning ?? 5;
    const morningStress = dayData.stressMorning ?? 5;

    // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    const getPersonalizedGreeting = () => {
      const avgMood = (morningMood + morningWellbeing + (10 - morningStress)) / 3;
      const hour = new Date().getHours();
      const timeOfDay = hour < 12 ? '—É—Ç—Ä–æ' : hour < 17 ? '–¥–µ–Ω—å' : '–≤–µ—á–µ—Ä';

      if (avgMood >= 7) {
        const phrases = [
          { emoji: 'üöÄ', text: '–û—Ç–ª–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç!' },
          { emoji: 'üî•', text: '–¢—ã –≤ –æ–≥–Ω–µ!' },
          { emoji: '‚ö°', text: '–ó–∞—Ä—è–∂–µ–Ω –Ω–∞ 100%!' },
          { emoji: 'üåü', text: `–°–∏—è—é—â–µ–µ ${timeOfDay}!` },
          { emoji: 'üí´', text: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ!' }
        ];
        return phrases[Math.floor(Math.random() * phrases.length)];
      } else if (avgMood >= 5) {
        const phrases = [
          { emoji: '‚òÄÔ∏è', text: `–•–æ—Ä–æ—à–µ–µ ${timeOfDay}!` },
          { emoji: '‚ú®', text: '–í—Å—ë –±—É–¥–µ—Ç —Å—É–ø–µ—Ä!' },
          { emoji: 'üí™', text: '–î–µ–Ω—å –±—É–¥–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º!' },
          { emoji: 'üéØ', text: '–í–ø–µ—Ä—ë–¥ –∫ —Ü–µ–ª—è–º!' }
        ];
        return phrases[Math.floor(Math.random() * phrases.length)];
      } else {
        const phrases = [
          { emoji: 'üí™', text: '–î–µ—Ä–∂–∏—Å—å! –î–µ–Ω—å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ª—É—á—à–µ' },
          { emoji: 'üåà', text: '–ü–æ—Å–ª–µ —Ç—É—á–∏ –≤—Å–µ–≥–¥–∞ —Å–æ–ª–Ω—Ü–µ!' },
          { emoji: '‚òï', text: '–ù–∞—á–Ω–∏ —Å —á–∞—à–∫–∏ —á–µ–≥–æ-—Ç–æ —Ç—ë–ø–ª–æ–≥–æ' },
          { emoji: 'ü§ó', text: '–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!' },
          { emoji: 'üå±', text: '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤—ã–π —à–∞–Ω—Å' }
        ];
        return phrases[Math.floor(Math.random() * phrases.length)];
      }
    };

    const personalGreeting = useMemo(getPersonalizedGreeting, [morningMood, morningWellbeing, morningStress]);

    // –†–∞–Ω–¥–æ–º–Ω—ã–µ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)
    const getButtonPhrase = () => {
      const avgMood = (morningMood + morningWellbeing + (10 - morningStress)) / 3;
      if (avgMood >= 7) {
        const phrases = ['üöÄ –í–ü–ï–†–Å–î!', 'üî• –ü–û–ï–•–ê–õ–ò!', '‚ö° –ù–ê–ß–ò–ù–ê–ï–ú!', 'üí™ –°–¢–ê–†–¢–£–ï–ú!'];
        return phrases[Math.floor(Math.random() * phrases.length)];
      } else if (avgMood >= 5) {
        const phrases = ['‚òÄÔ∏è –ù–ê–ß–ê–¢–¨ –î–ï–ù–¨!', '‚ú® –û–¢–õ–ò–ß–ù–û–ì–û –î–ù–Ø!', 'üéØ –í–ü–ï–†–Å–î –ö –¶–ï–õ–ò!'];
        return phrases[Math.floor(Math.random() * phrases.length)];
      } else {
        const phrases = ['üí™ –°–ü–†–ê–í–ò–ú–°–Ø!', 'üåà –í–ü–ï–†–Å–î!', '‚òï –ù–ê–ß–ù–Å–ú –ü–û–¢–ò–•–û–ù–¨–ö–£'];
        return phrases[Math.floor(Math.random() * phrases.length)];
      }
    };

    const randomPhrase = useMemo(getButtonPhrase, [morningMood, morningWellbeing, morningStress]);

    const routineItems = [
      {
        id: 'water',
        emoji: 'üíß',
        title: '–í—ã–ø–µ–π —Ç—ë–ø–ª–æ–π –≤–æ–¥—ã',
        desc: '–°—Ç–∞–∫–∞–Ω —Ç—ë–ø–ª–æ–π –≤–æ–¥—ã –Ω–∞—Ç–æ—â–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
        color: '#3b82f6'
      },
      {
        id: 'tracker',
        emoji: '‚åö',
        title: '–ù–∞–¥–µ–Ω—å —Ç—Ä–µ–∫–µ—Ä',
        desc: '–ß–∞—Å—ã –∏–ª–∏ –±—Ä–∞—Å–ª–µ—Ç ‚Äî —Å–ª–µ–¥–∏ –∑–∞ —à–∞–≥–∞–º–∏ –∏ –ø—É–ª—å—Å–æ–º',
        color: '#3b82f6'
      },
      {
        id: 'shower',
        emoji: 'üöø',
        title: '–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π –¥—É—à',
        desc: '–ë–æ–¥—Ä–∏—Ç –∏ —É–∫—Ä–µ–ø–ª—è–µ—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç',
        color: '#06b6d4'
      }
    ];

    const toggleItem = (id) => {
      setCheckedItems(prev => {
        const newItems = prev.includes(id)
          ? prev.filter(i => i !== id)
          : [...prev, id];
        onChange({ ...data, checkedItems: newItems });

        // –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö 3
        if (newItems.length === 3 && !showConfetti) {
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 2000);
        }

        return newItems;
      });
    };

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–≤—ã–∑—ã–≤–∞–µ—Ç onNext –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
    const handleFinish = () => {
      if (context && context.onNext) {
        context.onNext();
      }
    };

    const allChecked = checkedItems.length === 3;

    return React.createElement('div', {
      style: {
        display: 'flex',
        flexDirection: 'column',
        gap: '16px',
        padding: '8px 0'
      }
    },
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
      React.createElement('div', {
        style: {
          textAlign: 'center',
          marginBottom: '8px'
        }
      },
        React.createElement('div', {
          style: {
            fontSize: '48px',
            marginBottom: '8px',
            animation: 'bounce 1s ease infinite'
          }
        }, personalGreeting.emoji),
        React.createElement('div', {
          style: {
            fontSize: '20px',
            fontWeight: '700',
            color: 'var(--text, #1e293b)',
            marginBottom: '4px'
          }
        }, personalGreeting.text),
        React.createElement('div', {
          style: {
            fontSize: '14px',
            color: '#64748b'
          }
        }, '3 —à–∞–≥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä—É—Ç–∏–Ω—ã:')
      ),

      // üÜï NDTE Insight ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –≤—á–µ—Ä–∞ –±—ã–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
      (() => {
        const todayKey = getTodayKey();
        const prevTrainings = HEYS.InsulinWave && HEYS.InsulinWave.getPreviousDayTrainings
          ? HEYS.InsulinWave.getPreviousDayTrainings(todayKey, lsGet)
          : null;

        if (!prevTrainings || prevTrainings.totalKcal < 200) return null;

        const prof = lsGet('heys_profile', { weight: 70, height: 170 });
        const bmi = HEYS.InsulinWave.calculateBMI(prof.weight, prof.height);
        const ndteData = HEYS.InsulinWave.calculateNDTE({
          trainingKcal: prevTrainings.totalKcal,
          hoursSince: prevTrainings.hoursSince,
          bmi: bmi,
          trainingType: prevTrainings.dominantType,
          trainingsCount: prevTrainings.trainings.length
        });

        if (!ndteData.active) return null;

        const boostPct = Math.round(ndteData.tdeeBoost * 100);
        const wavePct = Math.round(ndteData.waveReduction * 100);

        return React.createElement('div', {
          style: {
            background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            borderRadius: '16px',
            padding: '16px',
            marginBottom: '16px',
            color: '#fff',
            boxShadow: '0 4px 14px rgba(16, 185, 129, 0.3)'
          }
        },
          // Header with animated icon
          React.createElement('div', {
            style: {
              display: 'flex',
              alignItems: 'center',
              gap: '10px',
              marginBottom: '10px'
            }
          },
            React.createElement('span', {
              style: {
                fontSize: '24px',
                animation: 'ndteFireFlicker 1.5s ease-in-out infinite'
              }
            }, 'üî•'),
            React.createElement('span', {
              style: {
                fontSize: '16px',
                fontWeight: '700'
              }
            }, '–≠—Ñ—Ñ–µ–∫—Ç –≤—á–µ—Ä–∞—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!')
          ),
          // Stats row
          React.createElement('div', {
            style: {
              display: 'flex',
              gap: '20px',
              fontSize: '13px',
              opacity: '0.95'
            }
          },
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: '600', fontSize: '18px' } }, `+${boostPct}%`),
              React.createElement('div', { style: { opacity: '0.8', fontSize: '11px' } }, '–∫ –º–µ—Ç–∞–±–æ–ª–∏–∑–º—É')
            ),
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: '600', fontSize: '18px' } }, `-${wavePct}%`),
              React.createElement('div', { style: { opacity: '0.8', fontSize: '11px' } }, '–∫ –∏–Ω—Å. –≤–æ–ª–Ω–µ')
            ),
            React.createElement('div', null,
              React.createElement('div', { style: { fontWeight: '600', fontSize: '18px' } }, `${prevTrainings.totalKcal}`),
              React.createElement('div', { style: { opacity: '0.8', fontSize: '11px' } }, '–∫–∫–∞–ª –≤—á–µ—Ä–∞')
            )
          ),
          // Motivation text
          React.createElement('div', {
            style: {
              marginTop: '10px',
              fontSize: '12px',
              opacity: '0.85',
              fontStyle: 'italic'
            }
          }, ndteData.tdeeBoost >= 0.07
            ? 'üí™ –û—Ç–ª–∏—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞! –¢–≤–æ–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ–ª–Ω—É—é –º–æ—â–Ω–æ—Å—Ç—å.'
            : '‚ö° –•–æ—Ä–æ—à–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å! –ú–µ—Ç–∞–±–æ–ª–∏–∑–º —Å–ª–µ–≥–∫–∞ —É—Å–∫–æ—Ä–µ–Ω.'
          )
        );
      })(),

      // –°–ø–∏—Å–æ–∫ —Ä—É—Ç–∏–Ω
      React.createElement('div', {
        style: {
          display: 'flex',
          flexDirection: 'column',
          gap: '12px'
        }
      },
        routineItems.map((item, index) =>
          React.createElement('div', {
            key: item.id,
            onClick: () => toggleItem(item.id),
            style: {
              display: 'flex',
              alignItems: 'center',
              gap: '14px',
              padding: '14px 16px',
              background: checkedItems.includes(item.id)
                ? `linear-gradient(135deg, ${item.color}15, ${item.color}08)`
                : '#f8fafc',
              borderRadius: '14px',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: checkedItems.includes(item.id)
                ? `2px solid ${item.color}40`
                : '2px solid transparent',
              transform: checkedItems.includes(item.id) ? 'scale(1.02)' : 'scale(1)'
            }
          },
            // –ù–æ–º–µ—Ä / –≥–∞–ª–æ—á–∫–∞
            React.createElement('div', {
              style: {
                width: '36px',
                height: '36px',
                borderRadius: '50%',
                background: checkedItems.includes(item.id)
                  ? `linear-gradient(135deg, ${item.color}, ${item.color}cc)`
                  : '#e2e8f0',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: checkedItems.includes(item.id) ? '18px' : '14px',
                fontWeight: '700',
                color: checkedItems.includes(item.id) ? '#fff' : '#64748b',
                transition: 'all 0.2s ease',
                flexShrink: 0
              }
            }, checkedItems.includes(item.id) ? '‚úì' : (index + 1)),

            // –≠–º–æ–¥–∑–∏
            React.createElement('div', {
              style: {
                fontSize: '28px',
                flexShrink: 0
              }
            }, item.emoji),

            // –¢–µ–∫—Å—Ç
            React.createElement('div', {
              style: {
                flex: 1,
                minWidth: 0
              }
            },
              React.createElement('div', {
                style: {
                  fontSize: '15px',
                  fontWeight: '600',
                  color: 'var(--text, #1e293b)',
                  marginBottom: '2px'
                }
              }, item.title),
              React.createElement('div', {
                style: {
                  fontSize: '12px',
                  color: '#64748b',
                  lineHeight: '1.3'
                }
              }, item.desc)
            )
          )
        )
      ),

      // –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞-–ø–ª–∞—à–∫–∞ –≤–Ω–∏–∑—É (–≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤ —Ö–µ–¥–µ—Ä–µ)
      React.createElement('button', {
        onClick: handleFinish,
        style: {
          width: '100%',
          textAlign: 'center',
          padding: '18px 24px',
          background: allChecked
            ? 'linear-gradient(135deg, #fef3c7, #fde68a)'
            : 'linear-gradient(135deg, #10b981, #059669)',
          borderRadius: '16px',
          marginTop: '16px',
          border: 'none',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          transform: 'scale(1)',
          boxShadow: allChecked
            ? '0 4px 14px rgba(251, 191, 36, 0.4)'
            : '0 4px 14px rgba(16, 185, 129, 0.4)'
        },
        onMouseDown: (e) => e.currentTarget.style.transform = 'scale(0.98)',
        onMouseUp: (e) => e.currentTarget.style.transform = 'scale(1)',
        onMouseLeave: (e) => e.currentTarget.style.transform = 'scale(1)'
      },
        allChecked && React.createElement('div', {
          style: { fontSize: '28px', marginBottom: '6px' }
        }, 'üèÜ'),
        React.createElement('div', {
          style: {
            fontSize: allChecked ? '14px' : '13px',
            fontWeight: '600',
            color: allChecked ? '#92400e' : '#fff',
            marginBottom: allChecked ? '8px' : '0'
          }
        }, allChecked ? '–¢—ã —É–∂–µ –Ω–∞ –ø—É—Ç–∏ –∫ —É—Å–ø–µ—Ö—É!' : '–ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å'),
        React.createElement('div', {
          style: {
            fontSize: '18px',
            fontWeight: '800',
            color: allChecked ? '#b45309' : '#fff',
            letterSpacing: '0.5px'
          }
        }, randomPhrase)
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –µ—Å–ª–∏ –Ω–µ –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω—ã
      !allChecked && React.createElement('div', {
        style: {
          textAlign: 'center',
          fontSize: '12px',
          color: '#94a3b8',
          marginTop: '8px'
        }
      }, '‚Üë –û—Ç–º–µ—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π'),

      // CSS –∞–Ω–∏–º–∞—Ü–∏—è
      React.createElement('style', null, `
        @keyframes bounce {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-8px); }
        }
      `)
    );
  }

  // ============================================================
  // SUPPLEMENTS STEP ‚Äî üíä –í–∏—Ç–∞–º–∏–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
  // –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–∏–¥–Ω—ã –¥–ª—è discovery, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ‚Äî —Å –æ—Ä–∞–Ω–∂–µ–≤–æ–π —Ä–∞–º–∫–æ–π
  // ============================================================

  function SupplementsStepComponent({ data, onChange }) {
    const Supps = HEYS.Supplements;
    if (!Supps) {
      return React.createElement('div', {
        style: { padding: '20px', textAlign: 'center', color: '#64748b' }
      }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Ç–∞–º–∏–Ω–æ–≤...');
    }

    const byCategory = useMemo(() => Supps.getByCategory(), []);
    const selected = data.selected || [];

    const toggle = (id) => {
      const newSelected = selected.includes(id)
        ? selected.filter(s => s !== id)
        : [...selected, id];
      onChange({ ...data, selected: newSelected });
    };

    return React.createElement('div', {
      className: 'mc-supplements-step',
      style: {
        display: 'flex',
        flexDirection: 'column',
        maxHeight: '60vh'
      }
    },
      // –°–∫—Ä–æ–ª–ª—è—â–∏–π—Å—è —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      React.createElement('div', {
        style: {
          flex: 1,
          overflowY: 'auto',
          paddingRight: '4px'
        }
      },
        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        Object.entries(byCategory).map(([catId, supps]) => {
          const cat = Supps.CATEGORIES[catId];
          return React.createElement('div', {
            key: catId,
            style: { marginBottom: '16px' }
          },
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            React.createElement('div', {
              style: {
                fontSize: '13px',
                fontWeight: '600',
                color: '#64748b',
                marginBottom: '8px',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
              }
            },
              React.createElement('span', null, cat.icon),
              React.createElement('span', null, cat.name)
            ),
            // –ß–∏–ø—ã –≤–∏—Ç–∞–º–∏–Ω–æ–≤
            React.createElement('div', {
              style: {
                display: 'flex',
                flexWrap: 'wrap',
                gap: '8px'
              }
            },
              supps.map(supp => {
                const isSelected = selected.includes(supp.id);
                return React.createElement('button', {
                  key: supp.id,
                  onClick: () => toggle(supp.id),
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                    padding: '8px 12px',
                    borderRadius: '20px',
                    border: isSelected ? '2px solid #f97316' : '2px solid #e2e8f0',
                    background: isSelected ? 'rgba(249, 115, 22, 0.1)' : '#fff',
                    cursor: 'pointer',
                    fontSize: '13px',
                    fontWeight: isSelected ? '600' : '500',
                    color: isSelected ? '#ea580c' : '#374151',
                    transition: 'all 0.2s'
                  }
                },
                  React.createElement('span', null, supp.icon),
                  React.createElement('span', null, supp.name)
                );
              })
            )
          );
        })
      ),
      // –°—á—ë—Ç—á–∏–∫ –≤–Ω–∏–∑—É ‚Äî –í–ù–ï —Å–∫—Ä–æ–ª–ª–∞!
      React.createElement('div', {
        style: {
          marginTop: '12px',
          padding: '12px',
          background: selected.length > 0 ? '#fff7ed' : '#f8fafc',
          borderRadius: '12px',
          textAlign: 'center',
          fontSize: '14px',
          fontWeight: '600',
          color: selected.length > 0 ? '#ea580c' : '#64748b',
          flexShrink: 0
        }
      },
        selected.length > 0
          ? `üíä –í—ã–±—Ä–∞–Ω–æ: ${selected.length}`
          : 'üíä –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏—Ç–∞–º–∏–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è'
      )
    );
  }

  registerStep('supplements', {
    title: '–í–∏—Ç–∞–º–∏–Ω—ã',
    hint: '–ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø—Ä–∏–Ω—è—Ç—å?',
    icon: 'üíä',
    canSkip: true,
    component: SupplementsStepComponent,
    getInitialData: () => {
      // –ë–µ—Ä—ë–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–∑–∞–ø–æ–º–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —Å –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è)
      const planned = HEYS.Supplements?.getPlanned() || [];
      return { selected: planned };
    },
    save: (data, context) => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º dateKey –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—à–ª—ã—Ö –¥–Ω–µ–π) –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è
      const dateKey = context?.dateKey || getTodayKey();

      console.log('[Supplements SAVE] üîµ START | dateKey:', dateKey, '| selected:', data.selected, '| context:', context);

      // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª—å (–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è)
      if (HEYS.Supplements && HEYS.Supplements.savePlanned) {
        HEYS.Supplements.savePlanned(data.selected);
        console.log('[Supplements SAVE] ‚úÖ Saved to profile');
      }

      // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –¥–µ–Ω—å –∫–∞–∫ planned
      const dayData = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey });
      const oldPlanned = dayData.supplementsPlanned;
      dayData.supplementsPlanned = data.selected;
      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, dayData);
      console.log('[Supplements SAVE] ‚úÖ Saved to day | old:', oldPlanned, '| new:', data.selected, '| updatedAt:', dayData.updatedAt);

      // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –¥–Ω—è (—Å forceReload!)
      if (typeof window !== 'undefined') {
        console.log('[Supplements SAVE] üì§ Dispatching heys:day-updated with forceReload:true');
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { date: dateKey, field: 'supplementsPlanned', forceReload: true }
        }));
      }
    },
    xpAction: 'supplements_planned'
  });

  registerStep('morningRoutine', {
    title: '–£—Ç—Ä–µ–Ω–Ω—è—è —Ä—É—Ç–∏–Ω–∞',
    hint: '–ù–∞—á–Ω–∏ –¥–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ!',
    icon: 'üåü',
    canSkip: true,
    hideHeaderNext: true,  // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ö–µ–¥–µ—Ä–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞—à–∫—É –≤–Ω–∏–∑—É
    component: MorningRoutineStepComponent,
    getInitialData: () => ({
      checkedItems: []
    }),
    save: (data) => {
      // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ—Ç–∏–ª
      // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      if (data.checkedItems && data.checkedItems.length > 0) {
        console.log('[MorningRoutine] Completed items:', data.checkedItems);
      }
    },
    xpAction: 'morning_routine_completed'
  });

  // =============================================

  // === –≠–∫—Å–ø–æ—Ä—Ç —à–∞–≥–æ–≤ ===
  HEYS.Steps = {
    Weight: WeightStepComponent,
    SleepTime: SleepTimeStepComponent,
    SleepQuality: SleepQualityStepComponent,
    StepsGoal: StepsGoalStepComponent,
    Deficit: DeficitStepComponent,
    HouseholdMinutes: HouseholdMinutesComponent,
    HouseholdStats: HouseholdStatsComponent,
    Cycle: CycleStepComponent,
    Measurements: MeasurementsStepComponent,
    ColdExposure: ColdExposureStepComponent,
    Supplements: SupplementsStepComponent,  // üíä –í–∏—Ç–∞–º–∏–Ω—ã
    MorningRoutine: MorningRoutineStepComponent,  // üåü –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ñ–∏–Ω–∞–ª
    getLastMeasurementByField,
    getMeasurementsHistory,
    // –£—Ç–∏–ª–∏—Ç—ã
    getLastKnownWeight,
    getYesterdayWeight,
    getWeightForecast,
    getLastSleepData,
    getWeeklyStepsStats,
    calcSleepHours,
    getCurrentDeficit,
    calcHouseholdKcal,
    getWeeklyHouseholdStats,
    getLastMeasurements,
    shouldShowMeasurements,
    shouldShowCycleStep
  };

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_add_product_step_v1.js ===== */
// heys_add_product_step_v1.js ‚Äî –®–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ —á–µ—Ä–µ–∑ StepModal
// –î–≤—É—Ö—à–∞–≥–æ–≤—ã–π flow: –ø–æ–∏—Å–∫ ‚Üí –≥—Ä–∞–º–º—ã/–ø–æ—Ä—Ü–∏–∏
if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const { useState, useMemo, useCallback, useEffect, useRef, useContext } = React;

  // === –ì–õ–û–ë–ê–õ–¨–ù–´–ô –°–ß–Å–¢–ß–ò–ö –í–ï–†–°–ò–ò –ü–†–û–î–£–ö–¢–û–í ===
  // –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è
  let globalProductsVersion = 0;

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ StepModal
  if (!HEYS.StepModal) {
    console.warn('[HEYS] AddProductStep: StepModal not loaded yet');
  }

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const U = () => HEYS.utils || {};
  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const readStoredValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      const raw = localStorage.getItem(key);
      if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
      return fallback;
    } catch {
      return fallback;
    }
  };

  const readGlobalValue = (key, fallback) => {
    try {
      if (HEYS.store?.get && /^heys_(clients|client_current)$/i.test(key)) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      const raw = localStorage.getItem(key);
      if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
      return fallback;
    } catch {
      return fallback;
    }
  };

  const writeRawValue = (key, value) => {
    try {
      const serialized = typeof value === 'string' ? value : JSON.stringify(value);
      localStorage.setItem(key, serialized);
    } catch { }
  };

  const lsGet = (key, def) => {
    const utils = U();
    if (HEYS.store?.get) return HEYS.store.get(key, def);
    if (utils.lsGet) return utils.lsGet(key, def);
    return readStoredValue(key, def);
  };

  // Haptic feedback
  const haptic = (style = 'light') => {
    if (navigator.vibrate) {
      navigator.vibrate(style === 'light' ? 10 : style === 'medium' ? 20 : 30);
    }
  };

  const useEscapeToClose = (closeFn, enabled = true) => {
    useEffect(() => {
      if (!enabled) return;

      const handleKeyDown = (event) => {
        if (event.key !== 'Escape') return;
        event.preventDefault();
        closeFn?.();
        HEYS.StepModal?.hide?.();
      };

      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }, [closeFn, enabled]);
  };

  const getAutoPortions = (productName) => {
    if (!productName) return [];
    return HEYS.models?.getAutoPortions?.(productName) || [];
  };

  const normalizePortions = (list) => {
    if (!Array.isArray(list)) {
      console.warn('[HEYS.portions] ‚ö†Ô∏è normalizePortions: –Ω–µ –º–∞—Å—Å–∏–≤', { input: list });
      return [];
    }
    const result = list
      .map((p) => ({
        name: String(p?.name || '').trim(),
        grams: Number(p?.grams || 0)
      }))
      .filter((p) => p.name && p.grams > 0);
    console.info('[HEYS.portions] üîÑ normalizePortions', {
      inputCount: list.length,
      outputCount: result.length,
      input: list.map(p => ({ name: p?.name, grams: p?.grams })),
      output: result
    });
    return result;
  };

  const saveProductPortions = (product, portions) => {
    console.info('[HEYS.portions] üì• saveProductPortions –í–´–ó–í–ê–ù', {
      productId: product?.id ?? product?.product_id ?? product?.name,
      productName: product?.name,
      portionsInput: portions,
      isShared: isSharedProduct(product),
      shared_origin_id: product?.shared_origin_id
    });
    if (!product || !Array.isArray(portions)) {
      console.warn('[HEYS.portions] ‚ö†Ô∏è saveProductPortions: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã', { product: !!product, portions });
      return;
    }
    const U = HEYS.utils || {};
    const products = HEYS.products?.getAll?.() || U.lsGet?.('heys_products', []) || [];
    const pid = String(product.id ?? product.product_id ?? product.name);
    const idx = products.findIndex((p) => String(p.id ?? p.product_id ?? p.name) === pid);

    if (idx === -1) {
      console.warn('[HEYS.portions] ‚ö†Ô∏è –ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, —Å–æ—Ö—Ä–∞–Ω—è—é —á–µ—Ä–µ–∑ upsert', {
        productId: pid
      });
      upsertLocalProduct({ ...product, portions }, false);
      return;
    }

    const updated = {
      ...products[idx],
      portions
    };

    const nextProducts = [...products];
    nextProducts[idx] = updated;

    if (HEYS.products?.setAll) {
      HEYS.products.setAll(nextProducts);
    } else if (HEYS.store?.set) {
      HEYS.store.set('heys_products', nextProducts);
    } else if (U.lsSet) {
      U.lsSet('heys_products', nextProducts);
    }

    console.info('[HEYS.portions] üì£ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ heys:local-product-updated', {
      productId: updated.id,
      productName: updated.name,
      portionsCount: portions.length,
      shared_origin_id: updated.shared_origin_id
    });
    window.dispatchEvent(new CustomEvent('heys:local-product-updated', {
      detail: {
        productId: updated.id ?? updated.product_id ?? updated.name,
        product: updated,
        portions,
        sharedId: updated.shared_origin_id
      }
    }));

    console.info('[HEYS.portions] üì£ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ heys:product-portions-updated', {
      productId: updated.id ?? updated.product_id ?? updated.name,
      productName: updated.name,
      portionsCount: portions.length
    });
    notifyPortionsUpdated(updated, portions);
  };

  const upsertLocalProduct = (product, isUserEdit = true) => {
    if (!product) return;
    const U = HEYS.utils || {};
    const products = HEYS.products?.getAll?.() || U.lsGet?.('heys_products', []) || [];
    const pid = String(product.id ?? product.product_id ?? product.name);
    const idx = products.findIndex((p) => String(p.id ?? p.product_id ?? p.name) === pid);

    let nextProducts = [...products];

    if (idx === -1) {
      nextProducts.push({
        ...product,
        // üÜï v4.8.6: Ensure new products have individual createdAt for sort order
        createdAt: product.createdAt || product.created_at || Date.now(),
        user_modified: isUserEdit ? true : product.user_modified
      });
    } else {
      const existing = products[idx];
      const shouldMarkModified = isUserEdit && hasNutrientChanges(existing, product);
      nextProducts[idx] = {
        ...existing,
        ...product,
        user_modified: existing.user_modified === true || shouldMarkModified
      };
    }

    if (HEYS.products?.setAll) {
      HEYS.products.setAll(nextProducts);
    } else if (HEYS.store?.set) {
      HEYS.store.set('heys_products', nextProducts);
    } else if (U.lsSet) {
      U.lsSet('heys_products', nextProducts);
    }

    if (idx !== -1) {
      cascadeMealItemsOnProductUpdate(products[idx], nextProducts[idx]);
    }
  };

  const hasCuratorJwt = () => {
    try {
      return !!readGlobalValue('heys_curator_session', null);
    } catch (_) {
      return false;
    }
  };

  const isCuratorUser = () => {
    const isCuratorSession = HEYS.auth?.isCuratorSession;
    if (typeof isCuratorSession === 'function') return isCuratorSession();
    return !!HEYS.cloud?.getUser?.() || hasCuratorJwt();
  };

  const isSharedProduct = (product) => {
    if (!product) return false;
    return !!(product._fromShared || product._source === 'shared' || product.is_shared);
  };

  const isUuidLike = (value) => {
    if (value == null) return false;
    const str = String(value).trim();
    return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(str);
  };

  const resolveSharedProductId = (product) => {
    if (!product) return null;
    if (product.shared_origin_id != null) return product.shared_origin_id;
    if (product.sharedId != null) return product.sharedId;
    if (product._sharedId != null) return product._sharedId;
    if (isSharedProduct(product)) {
      const sharedId = product.id ?? product.product_id ?? null;
      return isUuidLike(sharedId) ? sharedId : null;
    }
    return null;
  };

  const canEditProduct = (product) => {
    if (!product) return false;
    if (!isSharedProduct(product)) return true;
    return isCuratorUser() || !!product.is_mine;
  };

  const notifyPortionsUpdated = (product, portions) => {
    if (!product) return;
    window.dispatchEvent(new CustomEvent('heys:product-portions-updated', {
      detail: {
        productId: product.id ?? product.product_id ?? product.name,
        product,
        portions: Array.isArray(portions) ? portions : []
      }
    }));
  };

  const notifySharedProductUpdated = (sharedId, portions, product = null) => {
    if (sharedId == null) return;
    const eventProduct = product ? { ...product, id: sharedId } : { id: sharedId, portions };
    window.dispatchEvent(new CustomEvent('heys:shared-product-updated', {
      detail: {
        productId: sharedId,
        product: eventProduct,
        portions: Array.isArray(portions) ? portions : []
      }
    }));
  };

  const updateSharedProductsCache = (sharedId, portions, product = null) => {
    if (sharedId == null) return;

    // 1. –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)
    if (HEYS.cloud?.updateCachedSharedProduct) {
      const updates = {
        ...(product || {}),
        portions: Array.isArray(portions) ? portions : undefined
      };
      HEYS.cloud.updateCachedSharedProduct(sharedId, updates);
    } else {
      // Fallback: –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é
      const cache = HEYS.cloud?.getCachedSharedProducts?.();
      if (!Array.isArray(cache) || cache.length === 0) return;
      const idx = cache.findIndex((p) => String(p?.id) === String(sharedId));
      if (idx === -1) return;
      const merged = {
        ...cache[idx],
        ...(product || {}),
        id: sharedId,
        portions: Array.isArray(portions) ? portions : cache[idx]?.portions
      };
      cache[idx] = merged;
    }

    // üîß FIX: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º heys_products (–ª–∏—á–Ω–∞—è –±–∞–∑–∞)
    // –ü—Ä–æ–¥—É–∫—Ç –º–æ–≥ –±—ã—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω —Ç—É–¥–∞ —Ä–∞–Ω–µ–µ —á–µ—Ä–µ–∑ addFromShared
    try {
      const U = HEYS.utils || {};
      let localProducts = [];
      if (HEYS.products?.getAll) localProducts = HEYS.products.getAll() || [];
      if (localProducts.length === 0 && HEYS.store?.get) {
        localProducts = HEYS.store.get('heys_products', []) || [];
      }
      if (localProducts.length === 0 && U.lsGet) {
        localProducts = U.lsGet('heys_products', []) || [];
      }
      if (localProducts.length === 0) {
        const rawProducts = readStoredValue('heys_products', []) || [];
        if (Array.isArray(rawProducts)) localProducts = rawProducts;
      }
      if (!Array.isArray(localProducts) || localProducts.length === 0) return;

      const normalizeName = HEYS.models?.normalizeProductName
        || ((name) => String(name || '').trim().toLowerCase().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));

      const sharedName = product?.name
        || (HEYS.cloud?.getCachedSharedProducts?.() || []).find(p => String(p?.id) === String(sharedId))?.name
        || null;

      const getSharedOriginId = (p) => p?.shared_origin_id ?? p?.sharedOriginId ?? p?.shared_id ?? p?.sharedId ?? null;

      const localIndices = localProducts
        .map((p, idx) => ({ idx, p }))
        .filter(({ p }) => String(getSharedOriginId(p)) === String(sharedId) || String(p?.id) === String(sharedId))
        .map((item) => item.idx);

      if (localIndices.length === 0 && sharedName) {
        const targetName = normalizeName(sharedName);
        localProducts.forEach((p, idx) => {
          if (normalizeName(p?.name) === targetName) {
            localIndices.push(idx);
          }
        });
      }

      if (localIndices.length > 0) {
        let updatedProducts = [...localProducts];
        const incomingPortions = Array.isArray(portions) ? portions : [];
        const hasIncomingPortions = incomingPortions.length > 0;

        localIndices.forEach((idx) => {
          const localProduct = updatedProducts[idx];
          const finalPortions = hasIncomingPortions ? incomingPortions : (localProduct?.portions || []);

          const updatedProduct = {
            ...localProduct,
            ...product,
            portions: finalPortions,
            id: localProduct?.id
          };

          if (!getSharedOriginId(localProduct)) {
            updatedProduct.shared_origin_id = sharedId;
          }

          updatedProducts[idx] = updatedProduct;

          window.dispatchEvent(new CustomEvent('heys:local-product-updated', {
            detail: {
              productId: localProduct?.id,
              sharedId: sharedId,
              product: updatedProduct,
              portions: finalPortions
            }
          }));
          window.dispatchEvent(new CustomEvent('heys:product-portions-updated', {
            detail: {
              productId: localProduct?.id,
              product: updatedProduct,
              portions: finalPortions
            }
          }));
        });

        if (HEYS.products?.setAll) {
          HEYS.products.setAll(updatedProducts, { source: 'portions-sync-shared' });
        } else if (HEYS.store?.set) {
          HEYS.store.set('heys_products', updatedProducts);
        } else if (U.lsSet) {
          U.lsSet('heys_products', updatedProducts);
        } else {
          writeRawValue('heys_products', updatedProducts);
        }
      } else {
        console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', { sharedId, sharedName });
      }
    } catch (e) {
      console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π', e?.message || e);
    }
  };

  // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ü–∏–π —á–µ—Ä–µ–∑ RPC (direct UPDATE, –Ω–µ INSERT ON CONFLICT)
  // –ü—Ä–∏—á–∏–Ω–∞: REST upsert —Å partial data fails NOT NULL constraint –Ω–∞ name/fingerprint
  const updateSharedProductPortions = async (productId, portions, product = null) => {
    // üîß –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (curator_id –∏–∑ cloud.getUser())
    // –ü–†–ò–û–†–ò–¢–ï–¢: curator mode –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∫—É—Ä–∞—Ç–æ—Ä
    const curatorUser = (typeof HEYS !== 'undefined' && HEYS.cloud?.getUser?.());
    const curatorId = curatorUser?.id;
    const isCurator = curatorUser?.role === 'curator';

    // üîß –ü–æ–ª—É—á–∞–µ–º session token –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (PIN auth)
    const sessionToken = (typeof HEYS !== 'undefined' && HEYS.Auth?.getSessionToken?.())
      || localStorage.getItem('heys_session_token');

    // –ö—É—Ä–∞—Ç–æ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç curator —Ñ—É–Ω–∫—Ü–∏—é, –∫–ª–∏–µ–Ω—Ç—ã - session —Ñ—É–Ω–∫—Ü–∏—é
    const isCuratorMode = isCurator && !!curatorId;

    if (!HEYS?.YandexAPI?.rpc) {
      HEYS.Toast?.warning('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è') || alert('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      console.warn('[HEYS.portions] ‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ü–∏–π', {
        productId,
        portionsCount: Array.isArray(portions) ? portions.length : 0
      });
      return { ok: false };
    }

    if (!sessionToken && !curatorId) {
      HEYS.Toast?.warning('–°–µ—Å—Å–∏—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞') || alert('–°–µ—Å—Å–∏—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞');
      console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ü–∏–π', { productId });
      return { ok: false };
    }

    const resolvedSharedId = resolveSharedProductId(product) ?? productId;
    if (!isUuidLike(resolvedSharedId)) {
      console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π shared UUID –¥–ª—è RPC –ø–æ—Ä—Ü–∏–π', {
        productId,
        resolvedSharedId
      });
      return { ok: false };
    }

    try {
      // –í—ã–±–∏—Ä–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const rpcFn = isCuratorMode ? 'update_shared_product_portions_by_curator' : 'update_shared_product_portions';
      const rpcParams = isCuratorMode
        ? {
          p_curator_id: curatorId,
          p_product_id: resolvedSharedId,
          p_portions: Array.isArray(portions) ? portions : []
        }
        : {
          p_session_token: sessionToken,
          p_product_id: resolvedSharedId,
          p_portions: Array.isArray(portions) ? portions : []
        };

      console.info(`[HEYS.portions] üì§ RPC ${rpcFn}`, {
        productId: resolvedSharedId,
        portionsCount: Array.isArray(portions) ? portions.length : 0,
        portionsData: portions,
        isCuratorMode,
        curatorId: isCuratorMode ? curatorId : undefined
      });

      const { data: rawData, error } = await HEYS.YandexAPI.rpc(rpcFn, rpcParams);

      if (error) {
        const errorMsg = error?.message || error;
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + errorMsg) || alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + errorMsg);
        console.error('[HEYS.portions] ‚ùå RPC –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ü–∏–π', {
          productId,
          error
        });
        return { ok: false };
      }

      // üîß RPC –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { "[function_name]": { success: true/false, ... } }
      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ nested —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      const data = rawData?.[rpcFn] || rawData;

      console.info('[HEYS.portions] üì• RPC response parsed', {
        rawDataKeys: rawData ? Object.keys(rawData) : [],
        success: data?.success,
        hasError: !!data?.error
      });

      if (data?.success === false) {
        const errorMsg = data?.message || data?.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
        HEYS.Toast?.error(errorMsg) || alert(errorMsg);
        console.error('[HEYS.portions] ‚ùå RPC –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É', {
          productId,
          data
        });
        return { ok: false };
      }

      HEYS.Toast?.success('–ü–æ—Ä—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã') || alert('–ü–æ—Ä—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      console.info('[HEYS.portions] ‚úÖ –ü–æ—Ä—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ RPC', {
        productId: resolvedSharedId,
        portionsCount: Array.isArray(portions) ? portions.length : 0,
        portionsData: portions,
        serverResponse: data,
        isCuratorMode
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
      updateSharedProductsCache(resolvedSharedId, portions, product);
      notifySharedProductUpdated(resolvedSharedId, portions, product);
      return { ok: true };
    } catch (e) {
      const msg = e?.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
      HEYS.Toast?.error(msg) || alert(msg);
      console.error('[HEYS.portions] ‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Ä—Ü–∏–π', {
        productId,
        error: e?.message || e
      });
      return { ok: false };
    }
  };

  const toNum = (value, fallback = 0) => {
    if (value == null || value === '') return fallback;
    const normalized = String(value).trim().replace(',', '.');
    const n = Number(normalized);
    return Number.isFinite(n) ? n : fallback;
  };

  const toInt = (value, fallback = null) => {
    if (value == null || value === '') return fallback;
    const n = Number(String(value).trim().replace(',', '.'));
    if (!Number.isFinite(n)) return fallback;
    return Math.round(n);
  };

  const normalizeAdditives = (value) => {
    if (!value) return null;
    if (Array.isArray(value)) return value.length ? value : null;
    return String(value)
      .split(/[\n,;]+/)
      .map((item) => item.trim())
      .filter(Boolean);
  };

  const normalizeName = (name) => {
    if (HEYS.models?.normalizeProductName) return HEYS.models.normalizeProductName(name);
    return String(name || '')
      .trim()
      .toLowerCase()
      .replace(/\s+/g, ' ')
      .replace(/—ë/g, '–µ');
  };

  const notifyProductUpdated = (product) => {
    if (!product) return;
    window.dispatchEvent(new CustomEvent('heys:product-updated', {
      detail: {
        productId: product.id ?? product.product_id ?? product.name,
        product
      }
    }));
  };

  // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (–¥–ª—è user_modified —Ñ–ª–∞–≥–∞ + cascade update)
  const hasNutrientChanges = (oldProduct, newProduct) => {
    const nutrientKeys = [
      'simple100', 'complex100', 'protein100',
      'badFat100', 'goodFat100', 'trans100',
      'fiber100', 'gi', 'harm',
      // üÜï v5.0 Enrichment support: –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –¥–ª—è cascade update
      'iron', 'magnesium', 'zinc', 'selenium', 'calcium', 'phosphorus', 'potassium', 'iodine',
      'vitamin_a', 'vitamin_b1', 'vitamin_b2', 'vitamin_b3', 'vitamin_b6', 'vitamin_b9', 'vitamin_b12',
      'vitamin_c', 'vitamin_d', 'vitamin_e', 'vitamin_k',
      'omega3_100', 'omega6_100', 'cholesterol',
      'is_fermented', 'is_raw', 'is_organic', 'is_whole_grain', 'nova_group'
    ];
    return nutrientKeys.some(key => {
      const oldVal = oldProduct?.[key];
      const newVal = newProduct?.[key];
      // –°—á–∏—Ç–∞–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–º –µ—Å–ª–∏ –æ–±–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è
      if (oldVal == null && newVal == null) return false;
      return oldVal !== newVal;
    });
  };

  const saveLocalProduct = (product, isUserEdit = true) => {
    if (!product) return;
    const U = HEYS.utils || {};
    const products = HEYS.products?.getAll?.() || U.lsGet?.('heys_products', []) || [];
    const pid = String(product.id ?? product.product_id ?? product.name);
    const idx = products.findIndex((p) => String(p.id ?? p.product_id ?? p.name) === pid);
    if (idx === -1) return;

    const existing = products[idx];
    const nextProducts = [...products];

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º user_modified: true –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã
    const shouldMarkModified = isUserEdit && hasNutrientChanges(existing, product);
    nextProducts[idx] = {
      ...existing,
      ...product,
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º user_modified –µ—Å–ª–∏ —É–∂–µ –±—ã–ª true, –∏–ª–∏ —Å—Ç–∞–≤–∏–º –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∏–∑–º–µ–Ω–∏–ª–∏
      user_modified: existing.user_modified === true || shouldMarkModified
    };

    if (HEYS.products?.setAll) {
      HEYS.products.setAll(nextProducts);
    } else if (HEYS.store?.set) {
      HEYS.store.set('heys_products', nextProducts);
    } else if (U.lsSet) {
      U.lsSet('heys_products', nextProducts);
    }

    // v4.8.0: Cascade update to MealItems in all days
    cascadeMealItemsOnProductUpdate(existing, nextProducts[idx]);
  };

  /**
   * v4.8.0: Cascade MealItem updates when product is renamed/edited
   * Updates item.name and inline nutrients in all days where product_id matches
   * @param {Object} oldProduct - Product before update (for comparison)
   * @param {Object} newProduct - Product after update
   */
  const cascadeMealItemsOnProductUpdate = (oldProduct, newProduct) => {
    if (!oldProduct || !newProduct) return;
    const pid = String(newProduct.id ?? newProduct.product_id ?? '');
    if (!pid) return;

    // Check if name changed (main reason for cascade)
    const nameChanged = oldProduct.name !== newProduct.name;
    const nutrientsChanged = hasNutrientChanges(oldProduct, newProduct);
    if (!nameChanged && !nutrientsChanged) return;

    const U = HEYS.utils || {};
    // Find all day keys (with or without clientId prefix)
    const dayKeys = Object.keys(localStorage).filter(k => k.includes('_dayv2_'));
    let updatedDays = 0;
    let updatedItems = 0;

    for (const key of dayKeys) {
      try {
        const day = readStoredValue(key, null);
        if (!day || !day.meals) continue;

        let dayChanged = false;

        for (const meal of day.meals) {
          if (!meal.items) continue;
          for (const item of meal.items) {
            // Match by product_id (primary key for cascade)
            const itemPid = String(item.product_id ?? item.productId ?? '');
            if (itemPid === pid) {
              // Update name if changed
              if (nameChanged) {
                item.name = newProduct.name;
              }
              // Update inline nutrients if changed
              if (nutrientsChanged) {
                // Macronutrients
                item.kcal100 = newProduct.kcal100;
                item.protein100 = newProduct.protein100;
                item.fat100 = newProduct.fat100;
                item.simple100 = newProduct.simple100;
                item.complex100 = newProduct.complex100;
                item.badFat100 = newProduct.badFat100;
                item.goodFat100 = newProduct.goodFat100;
                item.trans100 = newProduct.trans100;
                item.fiber100 = newProduct.fiber100;
                item.gi = newProduct.gi ?? newProduct.gi100;
                item.harm = HEYS.models?.normalizeHarm?.(newProduct) ?? newProduct.harm;

                // üÜï v5.0 Enrichment: Micronutrients (cascade update)
                if (newProduct.iron != null) item.iron = newProduct.iron;
                if (newProduct.magnesium != null) item.magnesium = newProduct.magnesium;
                if (newProduct.zinc != null) item.zinc = newProduct.zinc;
                if (newProduct.selenium != null) item.selenium = newProduct.selenium;
                if (newProduct.calcium != null) item.calcium = newProduct.calcium;
                if (newProduct.phosphorus != null) item.phosphorus = newProduct.phosphorus;
                if (newProduct.potassium != null) item.potassium = newProduct.potassium;
                if (newProduct.iodine != null) item.iodine = newProduct.iodine;

                if (newProduct.vitamin_a != null) item.vitamin_a = newProduct.vitamin_a;
                if (newProduct.vitamin_b1 != null) item.vitamin_b1 = newProduct.vitamin_b1;
                if (newProduct.vitamin_b2 != null) item.vitamin_b2 = newProduct.vitamin_b2;
                if (newProduct.vitamin_b3 != null) item.vitamin_b3 = newProduct.vitamin_b3;
                if (newProduct.vitamin_b6 != null) item.vitamin_b6 = newProduct.vitamin_b6;
                if (newProduct.vitamin_b9 != null) item.vitamin_b9 = newProduct.vitamin_b9;
                if (newProduct.vitamin_b12 != null) item.vitamin_b12 = newProduct.vitamin_b12;
                if (newProduct.vitamin_c != null) item.vitamin_c = newProduct.vitamin_c;
                if (newProduct.vitamin_d != null) item.vitamin_d = newProduct.vitamin_d;
                if (newProduct.vitamin_e != null) item.vitamin_e = newProduct.vitamin_e;
                if (newProduct.vitamin_k != null) item.vitamin_k = newProduct.vitamin_k;

                if (newProduct.omega3_100 != null) item.omega3_100 = newProduct.omega3_100;
                if (newProduct.omega6_100 != null) item.omega6_100 = newProduct.omega6_100;
                if (newProduct.cholesterol != null) item.cholesterol = newProduct.cholesterol;

                if (newProduct.is_fermented != null) item.is_fermented = newProduct.is_fermented;
                if (newProduct.is_raw != null) item.is_raw = newProduct.is_raw;
                if (newProduct.is_organic != null) item.is_organic = newProduct.is_organic;
                if (newProduct.is_whole_grain != null) item.is_whole_grain = newProduct.is_whole_grain;
                if (newProduct.nova_group != null) item.nova_group = newProduct.nova_group;
              }
              dayChanged = true;
              updatedItems++;
            }
          }
        }

        if (dayChanged) {
          day.updatedAt = Date.now();
          writeRawValue(key, day);
          updatedDays++;
        }
      } catch (e) {
        console.warn('[HEYS] cascadeMealItems error for key:', key, e);
      }
    }

    if (updatedDays > 0) {
      console.log(`[HEYS] Cascade update: ${updatedItems} items in ${updatedDays} days`);
      // Clear caches to reflect changes
      HEYS.models?.clearMealTotalsCache?.();
      window.dispatchEvent(new CustomEvent('heys:mealitems-cascaded', {
        detail: { productId: pid, updatedDays, updatedItems }
      }));
    }
  };

  /**
   * üÜï v5.0: Batch cascade update ‚Äî efficiently updates MealItems for multiple products
   * Called automatically when products sync from cloud (heysProductsUpdated event)
   * @param {Array<Object>} products - Products to potentially update (only those with nutrient changes will cascade)
   */
  const cascadeBatchProductUpdates = (products, previousProducts = null) => {
    if (!Array.isArray(products) || products.length === 0) return;

    const prevArr = Array.isArray(previousProducts) ? previousProducts : null;

    // Build map: product_id ‚Üí oldProduct for O(1) lookup
    const prevById = new Map();
    if (prevArr) {
      for (const p of prevArr) {
        const pid = String(p?.id ?? p?.product_id ?? '');
        if (pid) prevById.set(pid, p);
      }
    }

    // Build map: product_id ‚Üí { old, new } for products with changes
    const changesMap = new Map();

    for (const newProduct of products) {
      const pid = String(newProduct?.id ?? newProduct?.product_id ?? '');
      if (!pid) continue;

      const oldProduct = prevById.get(pid);
      if (!oldProduct) continue; // Skip new products (no history to update)

      const nameChanged = oldProduct.name !== newProduct.name;
      const nutrientsChanged = hasNutrientChanges(oldProduct, newProduct);

      if (nameChanged || nutrientsChanged) {
        changesMap.set(pid, { old: oldProduct, new: newProduct, nameChanged, nutrientsChanged });
      }
    }

    if (changesMap.size === 0) {
      console.log('[HEYS.sync] ‚úÖ No nutrient changes detected in batch update');
      return;
    }

    console.log(`[HEYS.sync] üîÑ Cascade batch update: ${changesMap.size} products changed`);

    // Single pass through all days ‚Äî efficient!
    const dayKeys = Object.keys(localStorage).filter(k => k.includes('_dayv2_'));
    let updatedDays = 0;
    let updatedItems = 0;

    for (const key of dayKeys) {
      try {
        const day = readStoredValue(key, null);
        if (!day || !day.meals) continue;

        let dayChanged = false;

        for (const meal of day.meals) {
          if (!meal.items) continue;
          for (const item of meal.items) {
            const itemPid = String(item.product_id ?? item.productId ?? '');
            const change = changesMap.get(itemPid);

            if (change) {
              const { new: newProduct, nameChanged, nutrientsChanged } = change;

              if (nameChanged) {
                item.name = newProduct.name;
              }

              if (nutrientsChanged) {
                // Macronutrients
                item.kcal100 = newProduct.kcal100;
                item.protein100 = newProduct.protein100;
                item.fat100 = newProduct.fat100;
                item.simple100 = newProduct.simple100;
                item.complex100 = newProduct.complex100;
                item.badFat100 = newProduct.badFat100;
                item.goodFat100 = newProduct.goodFat100;
                item.trans100 = newProduct.trans100;
                item.fiber100 = newProduct.fiber100;
                item.gi = newProduct.gi ?? newProduct.gi100;
                item.harm = HEYS.models?.normalizeHarm?.(newProduct) ?? newProduct.harm;

                // üÜï v5.0 Enrichment: Micronutrients (batch cascade)
                if (newProduct.iron != null) item.iron = newProduct.iron;
                if (newProduct.magnesium != null) item.magnesium = newProduct.magnesium;
                if (newProduct.zinc != null) item.zinc = newProduct.zinc;
                if (newProduct.selenium != null) item.selenium = newProduct.selenium;
                if (newProduct.calcium != null) item.calcium = newProduct.calcium;
                if (newProduct.phosphorus != null) item.phosphorus = newProduct.phosphorus;
                if (newProduct.potassium != null) item.potassium = newProduct.potassium;
                if (newProduct.iodine != null) item.iodine = newProduct.iodine;

                if (newProduct.vitamin_a != null) item.vitamin_a = newProduct.vitamin_a;
                if (newProduct.vitamin_b1 != null) item.vitamin_b1 = newProduct.vitamin_b1;
                if (newProduct.vitamin_b2 != null) item.vitamin_b2 = newProduct.vitamin_b2;
                if (newProduct.vitamin_b3 != null) item.vitamin_b3 = newProduct.vitamin_b3;
                if (newProduct.vitamin_b6 != null) item.vitamin_b6 = newProduct.vitamin_b6;
                if (newProduct.vitamin_b9 != null) item.vitamin_b9 = newProduct.vitamin_b9;
                if (newProduct.vitamin_b12 != null) item.vitamin_b12 = newProduct.vitamin_b12;
                if (newProduct.vitamin_c != null) item.vitamin_c = newProduct.vitamin_c;
                if (newProduct.vitamin_d != null) item.vitamin_d = newProduct.vitamin_d;
                if (newProduct.vitamin_e != null) item.vitamin_e = newProduct.vitamin_e;
                if (newProduct.vitamin_k != null) item.vitamin_k = newProduct.vitamin_k;

                if (newProduct.omega3_100 != null) item.omega3_100 = newProduct.omega3_100;
                if (newProduct.omega6_100 != null) item.omega6_100 = newProduct.omega6_100;
                if (newProduct.cholesterol != null) item.cholesterol = newProduct.cholesterol;

                if (newProduct.is_fermented != null) item.is_fermented = newProduct.is_fermented;
                if (newProduct.is_raw != null) item.is_raw = newProduct.is_raw;
                if (newProduct.is_organic != null) item.is_organic = newProduct.is_organic;
                if (newProduct.is_whole_grain != null) item.is_whole_grain = newProduct.is_whole_grain;
                if (newProduct.nova_group != null) item.nova_group = newProduct.nova_group;
              }

              dayChanged = true;
              updatedItems++;
            }
          }
        }

        if (dayChanged) {
          day.updatedAt = Date.now();
          writeRawValue(key, day);
          updatedDays++;
        }
      } catch (e) {
        console.warn('[HEYS] Batch cascade error for key:', key, e);
      }
    }

    if (updatedDays > 0) {
      console.info(`[HEYS.sync] ‚úÖ Batch cascade complete: ${updatedItems} items in ${updatedDays} days`);
      // Clear caches to reflect changes
      HEYS.models?.clearMealTotalsCache?.();

      // v5.0.2: –î–∏—Å–ø–∞—Ç—á–∏–º heys:day-updated –¥–ª—è –°–ï–ì–û–î–ù–Ø, —á—Ç–æ–±—ã React state
      // –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ kcal100/protein100 –≤ items (—Ä–∞–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å).
      // –ó–∞–¥–µ—Ä–∂–∫–∞ 80–º—Å: –¥–∞—ë–º clearMealTotalsCache –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∏ –∏–∑–±–µ–≥–∞–µ–º race —Å —Ç–µ–∫—É—â–∏–º —Ä–µ–Ω–¥–µ—Ä–æ–º.
      const _cascadeTodayDate =
        (HEYS.models?.todayISO?.()) ||
        new Date().toISOString().slice(0, 10);
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { source: 'cascade-batch', date: _cascadeTodayDate }
        }));
        console.info('[HEYS.sync] üìÖ Dispatched heys:day-updated for today after cascade batch:', _cascadeTodayDate);
      }, 80);

      window.dispatchEvent(new CustomEvent('heys:mealitems-cascaded', {
        detail: { batchSize: changesMap.size, updatedDays, updatedItems }
      }));
    } else {
      console.log('[HEYS.sync] ‚ÑπÔ∏è No historical items affected by batch update');
    }
  };

  /**
   * üÜï v5.0: Auto-cascade listener for cloud sync
   * Automatically updates historical MealItems when products sync from shared_products
   */
  if (typeof window !== 'undefined') {
    // Guard against duplicate listeners if this module is evaluated multiple times
    if (!window.__heysProductsCascadeListenerV1) {
      window.__heysProductsCascadeListenerV1 = true;
      window.addEventListener('heysProductsUpdated', (event) => {
        if (event?.detail?.source === 'cloud-sync' && Array.isArray(event.detail.products)) {
          console.log('[HEYS.sync] üîÑ Products synced from cloud, triggering cascade update...');
          cascadeBatchProductUpdates(event.detail.products, event?.detail?.previousProducts);
        }
      });
    }
  }

  const updateSharedProduct = async (product, sharedIdOverride = null) => {
    const targetId = sharedIdOverride ?? product?.id ?? null;
    if (!product || !targetId) return { ok: false };
    if (!HEYS?.YandexAPI?.rest) {
      HEYS.Toast?.warning('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è') || alert('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      return { ok: false };
    }

    let fingerprint = product?.fingerprint || null;
    if (!fingerprint && HEYS.models?.computeProductFingerprint) {
      try {
        fingerprint = await HEYS.models.computeProductFingerprint(product);
      } catch (e) {
        console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å fingerprint', e?.message || e);
      }
    }

    if (!fingerprint) {
      console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ—Ç fingerprint –¥–ª—è shared update', {
        productId: targetId,
        name: product?.name || null
      });
      return { ok: false };
    }

    const payload = {
      id: targetId,
      name: product.name || null,
      name_norm: normalizeName(product.name),
      fingerprint: fingerprint,
      simple100: toNum(product.simple100, 0),
      complex100: toNum(product.complex100, 0),
      protein100: toNum(product.protein100, 0),
      badfat100: toNum(product.badFat100 ?? product.badfat100, 0),
      goodfat100: toNum(product.goodFat100 ?? product.goodfat100, 0),
      trans100: toNum(product.trans100, 0),
      fiber100: toNum(product.fiber100, 0),
      gi: toNum(product.gi, null),
      harm: toNum(HEYS.models?.normalizeHarm?.(product) ?? product.harm, null),
      category: product.category || null,
      portions: Array.isArray(product.portions) ? product.portions : null,
      description: product.description || null,
      sodium100: toNum(product.sodium100, null),
      omega3_100: toNum(product.omega3_100, null),
      omega6_100: toNum(product.omega6_100, null),
      nova_group: toInt(product.nova_group ?? product.novaGroup, null),
      additives: normalizeAdditives(product.additives),
      nutrient_density: toNum(product.nutrient_density ?? product.nutrientDensity, null),
      is_organic: product.is_organic ?? false,
      is_whole_grain: product.is_whole_grain ?? false,
      is_fermented: product.is_fermented ?? false,
      is_raw: product.is_raw ?? false,
      vitamin_a: toNum(product.vitamin_a, null),
      vitamin_c: toNum(product.vitamin_c, null),
      vitamin_d: toNum(product.vitamin_d, null),
      vitamin_e: toNum(product.vitamin_e, null),
      vitamin_k: toNum(product.vitamin_k, null),
      vitamin_b1: toNum(product.vitamin_b1, null),
      vitamin_b2: toNum(product.vitamin_b2, null),
      vitamin_b3: toNum(product.vitamin_b3, null),
      vitamin_b6: toNum(product.vitamin_b6, null),
      vitamin_b9: toNum(product.vitamin_b9, null),
      vitamin_b12: toNum(product.vitamin_b12, null),
      calcium: toNum(product.calcium, null),
      iron: toNum(product.iron, null),
      magnesium: toNum(product.magnesium, null),
      phosphorus: toNum(product.phosphorus, null),
      potassium: toNum(product.potassium, null),
      zinc: toNum(product.zinc, null),
      selenium: toNum(product.selenium, null),
      iodine: toNum(product.iodine, null)
    };

    const minimalPayload = {
      id: targetId,
      name: product.name || null,
      name_norm: normalizeName(product.name),
      fingerprint: fingerprint,
      simple100: toNum(product.simple100, 0),
      complex100: toNum(product.complex100, 0),
      protein100: toNum(product.protein100, 0),
      badfat100: toNum(product.badFat100 ?? product.badfat100, 0),
      goodfat100: toNum(product.goodFat100 ?? product.goodfat100, 0),
      trans100: toNum(product.trans100, 0),
      fiber100: toNum(product.fiber100, 0),
      gi: toNum(product.gi, null),
      harm: toNum(HEYS.models?.normalizeHarm?.(product) ?? product.harm, null),
      category: product.category || null,
      portions: Array.isArray(product.portions) ? product.portions : null,
      description: product.description || null
    };

    try {
      const primary = await HEYS.YandexAPI.rest('shared_products', {
        method: 'POST',
        data: payload,
        upsert: true,
        onConflict: 'id',
        select: 'id,name'
      });

      if (primary?.error?.code === 500) {
        console.warn('[HEYS.portions] ‚ö†Ô∏è Full payload failed, retry minimal payload', {
          productId: targetId
        });
        const fallback = await HEYS.YandexAPI.rest('shared_products', {
          method: 'POST',
          data: minimalPayload,
          upsert: true,
          onConflict: 'id',
          select: 'id,name'
        });
        if (fallback.error) {
          HEYS.Toast?.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + fallback.error) || alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + fallback.error);
          return { ok: false };
        }
        HEYS.Toast?.success('–ü—Ä–æ–¥—É–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω') || alert('–ü—Ä–æ–¥—É–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
        return { ok: true, fallback: true };
      }

      if (primary.error) {
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + primary.error) || alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + primary.error);
        return { ok: false };
      }

      HEYS.Toast?.success('–ü—Ä–æ–¥—É–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω') || alert('–ü—Ä–æ–¥—É–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
      return { ok: true };
    } catch (e) {
      const msg = e?.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
      HEYS.Toast?.error(msg) || alert(msg);
      return { ok: false };
    }
  };

  const openProductPortionsEditor = (product) => {
    console.log('[openProductPortionsEditor] called with product:', product);
    if (!product) {
      console.log('[openProductPortionsEditor] no product, returning');
      return;
    }
    if (!HEYS?.StepModal || !HEYS?.AddProductStep?.PortionsStep) {
      console.log('[openProductPortionsEditor] StepModal or PortionsStep missing');
      HEYS.Toast?.warning('–ú–æ–¥–∞–ª–∫–∞ –ø–æ—Ä—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') || alert('–ú–æ–¥–∞–ª–∫–∞ –ø–æ—Ä—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      return;
    }

    if (!canEditProduct(product)) {
      console.log('[openProductPortionsEditor] canEditProduct returned false');
      HEYS.Toast?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é') || alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
      return;
    }

    console.log('[openProductPortionsEditor] calling HEYS.StepModal.show');
    HEYS.StepModal.show({
      steps: [
        {
          id: 'portions',
          title: '–ü–æ—Ä—Ü–∏–∏',
          hint: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä—Ü–∏–∏',
          icon: 'ü•£',
          component: HEYS.AddProductStep.PortionsStep,
          validate: () => true,
          hideHeaderNext: true,
          getInitialData: () => ({
            selectedProduct: product,
            portions: product.portions || []
          })
        }
      ],
      context: {
        isEditMode: true,
        editProduct: product,
        onFinish: async ({ portions }) => {
          console.info('[HEYS.portions] üèÅ onFinish shared/personal edit', {
            productId: product?.id,
            productName: product?.name,
            receivedPortions: portions,
            shared_origin_id: product?.shared_origin_id
          });
          const normalized = normalizePortions(portions || []);
          const updatedProduct = {
            ...product,
            ...(normalized.length > 0 ? { portions: normalized } : {})
          };

          const sharedId = resolveSharedProductId(product);
          if (isCuratorUser() && sharedId) {
            const result = await updateSharedProductPortions(sharedId, normalized, updatedProduct);
            if (result.ok) {
              upsertLocalProduct(updatedProduct, false);
              notifyPortionsUpdated(updatedProduct, normalized);
            }
            return;
          }

          if (isSharedProduct(product)) {
            if (isCuratorUser()) {
              const resolvedSharedId = resolveSharedProductId(product);
              if (!resolvedSharedId) {
                console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å shared UUID –¥–ª—è –ø–æ—Ä—Ü–∏–π', {
                  productId: product?.id,
                  productName: product?.name,
                  shared_origin_id: product?.shared_origin_id
                });
                return;
              }
              const result = await updateSharedProductPortions(resolvedSharedId, normalized, updatedProduct);
              if (result.ok) {
                upsertLocalProduct(updatedProduct, false);
                notifyPortionsUpdated(updatedProduct, normalized);
              }
              return;
            }

            upsertLocalProduct(updatedProduct, true);
            notifyPortionsUpdated(updatedProduct, normalized);
            return;
          }

          saveProductPortions(updatedProduct, normalized);
          notifyPortionsUpdated(updatedProduct, normalized);
        }
      },
      showGreeting: false,
      showStreak: false,
      showTip: false,
      showProgress: false,
      allowSwipe: false,
      hidePrimaryOnFirst: true,
      title: ''
    });
  };

  // === –£–º–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: —á–∞—Å—Ç–æ—Ç–∞ + —Å–≤–µ–∂–µ—Å—Ç—å ===
  function computeSmartProducts(products, dateKey, options = {}) {
    if (!products || !products.length) return [];

    const usageStats = options.usageStats instanceof Map
      ? options.usageStats
      : new Map(Array.isArray(options.usageStats) ? options.usageStats : []);
    const lastUsedDay = new Map(); // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (daysAgo)
    const today = new Date(dateKey || new Date().toISOString().slice(0, 10));
    const now = Date.now();
    const daysWindow = Math.max(1, Math.min(60, Number(options.daysWindow) || 21));
    const favoritesSet = options.favorites instanceof Set
      ? options.favorites
      : new Set(Array.isArray(options.favorites) ? options.favorites : []);
    const hiddenSet = options.hidden instanceof Set
      ? options.hidden
      : new Set(Array.isArray(options.hidden) ? options.hidden : []);

    // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫–æ—Ä: —á–∞—Å—Ç–æ—Ç–∞ √ó —Å–≤–µ–∂–µ—Å—Ç—å
    // –°–≤–µ–∂–µ—Å—Ç—å: 1.0 –¥–ª—è —Å–µ–≥–æ–¥–Ω—è, —É–±—ã–≤–∞–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ
    // –§–æ—Ä–º—É–ª–∞: score = frequency * recencyWeight
    // recencyWeight = 1 / (1 + daysAgo * 0.15)
    const resolveUsageStats = (pid, name) => {
      const rawName = String(name || '').trim();
      const normName = normalizeName(rawName);
      const searchNorm = HEYS?.SmartSearchWithTypos?.utils?.normalizeText
        ? HEYS.SmartSearchWithTypos.utils.normalizeText(rawName)
        : normName;

      const candidates = [];
      if (pid && usageStats.has(pid)) candidates.push(usageStats.get(pid));
      if (normName && usageStats.has(normName)) candidates.push(usageStats.get(normName));
      if (searchNorm && usageStats.has(searchNorm)) candidates.push(usageStats.get(searchNorm));
      if (rawName && usageStats.has(rawName)) candidates.push(usageStats.get(rawName));

      const target = searchNorm || normName || rawName;
      if (target) {
        usageStats.forEach((stats, key) => {
          const k = String(key || '').trim();
          if (!k || k.length < 3) return;
          if (!target.includes(k) && !k.includes(target)) return;
          candidates.push(stats);
        });
      }

      if (!candidates.length) return null;

      return candidates.reduce((best, curr) => {
        if (!best) return curr;
        const bc = Number(best.count) || 0;
        const cc = Number(curr.count) || 0;
        if (cc !== bc) return cc > bc ? curr : best;
        const bl = Number(best.lastUsed) || 0;
        const cl = Number(curr.lastUsed) || 0;
        return cl > bl ? curr : best;
      }, null);
    };

    const getFreq = (pid, name) => {
      const stats = resolveUsageStats(pid, name);
      if (!stats || !stats.lastUsed) return 0;
      const daysAgo = Math.floor((now - stats.lastUsed) / (1000 * 60 * 60 * 24));
      if (daysAgo > daysWindow) return 0;
      lastUsedDay.set(pid, daysAgo);
      return Number(stats.count) || 0;
    };

    const getScore = (pid, name) => {
      const freq = getFreq(pid, name);
      if (freq === 0) return 0;
      const daysAgo = lastUsedDay.get(pid) ?? daysWindow;
      const recencyWeight = 1 / (1 + daysAgo * 0.15);
      return freq * recencyWeight;
    };

    const getGroupRank = (pid, name) => {
      const freq = getFreq(pid, name);
      const isFav = favoritesSet.has(pid);
      if (isFav && freq > 0) return 0; // –∏–∑–±—Ä–∞–Ω–Ω—ã–µ + —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ
      if (freq > 0) return 1; // —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ
      if (isFav) return 2; // –∏–∑–±—Ä–∞–Ω–Ω—ã–µ, –Ω–æ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      // v2.8.3: –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ù–ò–ñ–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö
      return 3;
    };

    // –ù–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ/–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ (48—á) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö—É –¥–∞–∂–µ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏
    const recentWindowMs = 48 * 60 * 60 * 1000;
    const isRecentlyTouched = (p) => {
      const ts = Number(p.updatedAt || p.createdAt || 0);
      return ts > 0 && (now - ts) < recentWindowMs;
    };

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–∫–æ—Ä—É
    // v2.8.3: –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –í–°–ï–ì–î–ê –≤—ã—à–µ –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö
    const sorted = [...products]
      .filter(p => {
        const pid = String(p.id || p.product_id || p.name || '');
        if (!pid) return false;
        if (hiddenSet.has(pid)) return false; // –°–∫—Ä—ã—Ç—ã–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        const freq = getFreq(pid, p.name);
        const isFav = favoritesSet.has(pid);
        return isFav || freq > 0 || isRecentlyTouched(p); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ, –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∏–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
      })
      .sort((a, b) => {
        const aId = String(a.id || a.product_id || a.name || '');
        const bId = String(b.id || b.product_id || b.name || '');

        // v2.8.3: –≥—Ä—É–ø–ø—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ‚Äî
        // 0: –∏–∑–±—Ä–∞–Ω–Ω—ã–µ + —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ
        // 1: —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ
        // 2: –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        // 3: –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ (48—á) –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        // 4: –æ—Å—Ç–∞–ª—å–Ω—ã–µ (–Ω–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ —Ñ–∏–ª—å—Ç—Ä)
        const aGroup = getGroupRank(aId, a.name);
        const bGroup = getGroupRank(bId, b.name);
        if (aGroup !== bGroup) return aGroup - bGroup;

        // –°—Ä–µ–¥–∏ –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö (–≥—Ä—É–ø–ø–∞ 3) ‚Äî —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ —Å–Ω–∞—á–∞–ª–∞
        if (aGroup === 3) {
          const aTs = Number(a.updatedAt || a.createdAt || 0);
          const bTs = Number(b.updatedAt || b.createdAt || 0);
          if (aTs !== bTs) return bTs - aTs;
        }

        const aScore = getScore(aId, a.name);
        const bScore = getScore(bId, b.name);
        if (aGroup <= 1 && aScore !== bScore) return bScore - aScore;

        if (aGroup <= 1) {
          const aLast = lastUsedDay.get(aId) ?? 999;
          const bLast = lastUsedDay.get(bId) ?? 999;
          if (aLast !== bLast) return aLast - bLast;
        }

        return String(a.name || '').localeCompare(String(b.name || ''), 'ru');
      });

    return sorted.slice(0, 20);
  }

  // === –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ ===
  const CATEGORIES = [
    { id: 'all', name: '–í—Å–µ', icon: 'üìã' },
    { id: 'dairy', name: '–ú–æ–ª–æ—á–Ω—ã–µ', icon: 'ü•õ', match: ['–º–æ–ª–æ—á', '—Å—ã—Ä', '—Ç–≤–æ—Ä–æ–≥', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '–º–æ–ª–æ–∫–æ'] },
    { id: 'meat', name: '–ú—è—Å–æ', icon: 'üçñ', match: ['–º—è—Å', '–∫—É—Ä–∏–Ω', '–≥–æ–≤—è', '—Å–≤–∏–Ω', '–∏–Ω–¥–µ–π–∫', '–ø—Ç–∏—Ü'] },
    { id: 'fish', name: '–†—ã–±–∞', icon: 'üêü', match: ['—Ä—ã–±', '–º–æ—Ä–µ–ø—Ä', '–ª–æ—Å–æ—Å—å', '—Ç—É–Ω–µ—Ü', '–∫—Ä–µ–≤–µ—Ç–∫'] },
    { id: 'veggies', name: '–û–≤–æ—â–∏', icon: 'ü•¨', match: ['–æ–≤–æ—â', '—Å–∞–ª–∞—Ç', '–æ–≥—É—Ä–µ—Ü', '–ø–æ–º–∏–¥–æ—Ä', '–∫–∞–ø—É—Å—Ç', '–º–æ—Ä–∫–æ–≤'] },
    { id: 'fruits', name: '–§—Ä—É–∫—Ç—ã', icon: 'üçé', match: ['—Ñ—Ä—É–∫—Ç', '—è–≥–æ–¥', '—è–±–ª–æ–∫', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å'] },
    { id: 'grains', name: '–ö—Ä—É–ø—ã', icon: 'üåæ', match: ['–∫—Ä—É–ø', '–∫–∞—à', '—Ä–∏—Å', '–≥—Ä–µ—á–∫', '–æ–≤—Å—è', '—Ö–ª–µ–±', '–º–∞–∫–∞—Ä'] },
    { id: 'sweets', name: '–°–ª–∞–¥–∫–æ–µ', icon: 'üç¨', match: ['—Å–ª–∞–¥–∫', '–∫–æ–Ω—Ñ–µ—Ç', '—à–æ–∫–æ–ª', '—Ç–æ—Ä—Ç', '–ø–µ—á–µ–Ω—å', '–¥–µ—Å–µ—Ä—Ç'] }
  ];

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
  function matchCategory(product, categoryId) {
    if (categoryId === 'all') return true;
    const cat = CATEGORIES.find(c => c.id === categoryId);
    if (!cat || !cat.match) return true;
    const name = (product.name || '').toLowerCase();
    const pCat = (product.category || '').toLowerCase();
    return cat.match.some(m => name.includes(m) || pCat.includes(m));
  }

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ (–®–∞–≥ 1) ===
  function ProductSearchStep({ data, onChange, context }) {
    const [searchInput, setSearchInput] = useState(data?.searchQuery || '');
    const [search, setSearch] = useState(data?.searchQuery || '');
    const [selectedCategory, setSelectedCategory] = useState('all');

    // v25.8.6.7: Sync searchQuery from StepModal's getInitialData
    // useState initializer runs only once at mount, but stepData is set via useEffect
    // (after first render), so data?.searchQuery may be empty on mount.
    // This effect picks up the initial search query once StepModal provides it.
    const initialSearchAppliedRef = useRef(false);
    useEffect(() => {
      if (!initialSearchAppliedRef.current && data?.searchQuery && !searchInput) {
        setSearchInput(data.searchQuery);
        setSearch(data.searchQuery);
        initialSearchAppliedRef.current = true;
        console.info('[HEYS.addProduct] üîç Pre-filled search from initialSearch:', data.searchQuery);
      }
    }, [data?.searchQuery]);
    const [favorites, setFavorites] = useState(() =>
      HEYS.store?.getFavorites?.() || new Set()
    );
    const [hiddenProducts, setHiddenProducts] = useState(() =>
      HEYS.store?.getHiddenProducts?.() || new Set()
    );
    const [selectedPhoto, setSelectedPhoto] = useState(null);
    const [photoPreview, setPhotoPreview] = useState(null);
    const [showPhotoConfirm, setShowPhotoConfirm] = useState(false); // –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const [pendingPhotoData, setPendingPhotoData] = useState(null);  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const inputRef = useRef(null);
    const fileInputRef = useRef(null);

    // –î–æ—Å—Ç—É–ø –∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ StepModal
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { goToStep, closeModal } = stepContext;

    const { dateKey = '', day: contextDay } = context || {};
    const usageWindowDays = 21;

    // üîß FIX: –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏—ë–º–∞
    // –ø—Ä–æ–¥—É–∫—Ç—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞, –Ω–æ –ø–æ—Å–ª–µ heysSyncCompleted –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è
    const [productsVersion, setProductsVersion] = useState(globalProductsVersion);
    const [usageStatsVersion, setUsageStatsVersion] = useState(0);

    // üîí Ref –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ sync (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ)
    const initialSyncDoneRef = useRef(false);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (heysSyncCompleted –∏–ª–∏ watch)
    useEffect(() => {
      const clearSearchCache = () => {
        try {
          HEYS?.SmartSearchWithTypos?.clearCache?.();
        } catch (e) {
          // no-op
        }
      };

      const refreshUsageFromHistory = () => {
        try {
          if (HEYS?.SmartSearchWithTypos?.syncUsageStatsFromDays) {
            HEYS.SmartSearchWithTypos.syncUsageStatsFromDays({
              daysWindow: usageWindowDays,
              dateKey: dateKey || new Date().toISOString().slice(0, 10),
              lsGet: HEYS.store?.get
            });
            setUsageStatsVersion(v => v + 1);
          }
        } catch (e) {
          // no-op
        }
      };

      const handleSyncComplete = (e) => {
        // üîí –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π heysSyncCompleted ‚Äî products —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (e?.type === 'heysSyncCompleted') {
          if (!initialSyncDoneRef.current) {
            initialSyncDoneRef.current = true;
            refreshUsageFromHistory();
            return;
          }
        }
        // console.log('[AddProductStep] üîÑ heysSyncCompleted ‚Üí refreshing products');
        setProductsVersion(v => v + 1);
        clearSearchCache();
        refreshUsageFromHistory();
      };

      // üÜï FIX v2: —Å–ª—É—à–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ listeners —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è 1 —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è
      // –∏ dispatch'–∞—Ç heys:products-version-changed –¥–ª—è React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      const handleVersionChanged = (e) => {
        console.log('[AddProductStep] üîÑ handleVersionChanged fired', {
          event: e?.type,
          detail: e?.detail,
          prevVersion: productsVersion
        });
        setProductsVersion(v => {
          const next = v + 1;
          console.log('[AddProductStep] ‚úÖ productsVersion updating', { prev: v, next });
          return next;
        });
        clearSearchCache();
      };

      window.addEventListener('heysSyncCompleted', handleSyncComplete);
      window.addEventListener('heys:products-version-changed', handleVersionChanged);

      // –¢–∞–∫–∂–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è —á–µ—Ä–µ–∑ HEYS.products.watch –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
      let unwatchProducts = () => { };
      if (HEYS.products?.watch) {
        unwatchProducts = HEYS.products.watch(() => {
          // console.log('[AddProductStep] üîÑ products.watch ‚Üí refreshing products');
          setProductsVersion(v => v + 1);
          clearSearchCache();
        });
      }

      return () => {
        window.removeEventListener('heysSyncCompleted', handleSyncComplete);
        window.removeEventListener('heys:products-version-changed', handleVersionChanged);
        unwatchProducts();
      };
    }, [dateKey, usageWindowDays]);

    // –í—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ)
    // productsVersion –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    const latestProducts = useMemo(() => {
      console.log('[AddProductStep] üîÑ latestProducts useMemo START', { productsVersion });
      const base = Array.isArray(context?.products) ? context.products : [];

      // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ HEYS.products.getAll()
      let storeProducts = [];
      if (HEYS.products?.getAll) {
        storeProducts = HEYS.products.getAll() || [];
      }

      // Fallback: –Ω–∞–ø—Ä—è–º—É—é –∏–∑ HEYS.store
      if (storeProducts.length === 0 && HEYS.store?.get) {
        storeProducts = HEYS.store.get('heys_products', []) || [];
      }

      // Fallback: –∏–∑ localStorage —á–µ—Ä–µ–∑ U()
      if (storeProducts.length === 0) {
        const utils = U();
        if (utils.lsGet) {
          storeProducts = utils.lsGet('heys_products', []) || [];
        }
      }

      // Fallback: –Ω–∞–ø—Ä—è–º—É—é –∏–∑ localStorage
      if (storeProducts.length === 0) {
        const rawProducts = readStoredValue('heys_products', null);
        if (Array.isArray(rawProducts)) storeProducts = rawProducts;
      }

      storeProducts = Array.isArray(storeProducts) ? storeProducts : [];
      // –ï—Å–ª–∏ store –¥–ª–∏–Ω–Ω–µ–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –æ—Å–Ω–æ–≤—É
      const primary = storeProducts.length >= base.length ? storeProducts : base;
      const secondary = primary === storeProducts ? base : storeProducts;
      // –û–±—ä–µ–¥–∏–Ω—è–µ–º, —É–±–∏—Ä–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ id/name
      const seen = new Set();
      const merged = [];
      const pushUnique = (p) => {
        if (!p) return;
        const pid = String(p.id ?? p.product_id ?? p.name);
        if (seen.has(pid)) return;
        seen.add(pid);
        merged.push(p);
      };
      primary.forEach(pushUnique);
      secondary.forEach(pushUnique);

      console.log('[AddProductStep] ‚úÖ latestProducts useMemo DONE', {
        count: merged.length,
        sampleIds: merged.slice(0, 3).map(p => p.id),
        productsVersion
      });
      return merged;
    }, [context, productsVersion]);

    // üåê –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫)
    const [sharedResults, setSharedResults] = useState([]);
    const [sharedLoading, setSharedLoading] = useState(false);

    useEffect(() => {
      const handleSharedUpdated = (event) => {
        const detail = event?.detail || {};
        const updatedId = detail.productId ?? detail.product?.id;
        if (updatedId == null) return;
        setSharedResults((prev) => {
          if (!Array.isArray(prev) || prev.length === 0) return prev;
          let changed = false;
          const next = prev.map((p) => {
            if (String(p?.id) !== String(updatedId)) return p;
            changed = true;
            return {
              ...p,
              ...(detail.product || {}),
              id: p.id,
              portions: Array.isArray(detail.portions) ? detail.portions : (detail.product?.portions || p.portions)
            };
          });
          return changed ? next : prev;
        });
      };

      window.addEventListener('heys:shared-product-updated', handleSharedUpdated);
      return () => window.removeEventListener('heys:shared-product-updated', handleSharedUpdated);
    }, []);

    useEscapeToClose(closeModal, true);

    // Debug: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ products –ø—Ä–∏—à–ª–∏
    // useEffect(() => {
    //   console.log('[AddProductStep] products count:', latestProducts?.length);
    // }, [latestProducts]);

    // –§–æ–∫—É—Å –Ω–∞ input –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    useEffect(() => {
      setTimeout(() => inputRef.current?.focus(), 100);
    }, []);

    useEffect(() => {
      try {
        if (HEYS?.SmartSearchWithTypos?.syncUsageStatsFromDays) {
          HEYS.SmartSearchWithTypos.syncUsageStatsFromDays({
            daysWindow: usageWindowDays,
            dateKey: dateKey || new Date().toISOString().slice(0, 10),
            lsGet: HEYS.store?.get
          });
          setUsageStatsVersion(v => v + 1);
        }
      } catch (e) {
        console.error('[HEYS.search] syncUsageStatsFromDays error:', e);
      }
    }, [dateKey, usageWindowDays]);

    // Debounce –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    useEffect(() => {
      const timer = setTimeout(() => {
        setSearch(searchInput);
      }, 200);

      return () => clearTimeout(timer);
    }, [searchInput]);

    // üåê –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –æ–±—â–µ–π –±–∞–∑–µ (debounced)
    useEffect(() => {
      const trimmed = search.trim();
      if (trimmed.length < 2) {
        setSharedResults([]);
        return;
      }

      const timeoutId = setTimeout(async () => {
        setSharedLoading(true);
        console.log('[SharedSearch] Searching for:', trimmed);
        try {
          const result = await HEYS?.cloud?.searchSharedProducts?.(trimmed, { limit: 30 });
          console.log('[SharedSearch] Result:', result?.data?.length, 'products');
          if (result?.data) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å UI
            const normalized = result.data.map(p => {
              // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π (snake_case ‚Üí camelCase fallback)
              const protein100 = Number(p.protein100 ?? 0) || 0;
              const simple100 = Number(p.simple100 ?? 0) || 0;
              const complex100 = Number(p.complex100 ?? 0) || 0;
              const badFat100 = Number(p.badfat100 ?? p.badFat100 ?? 0) || 0;
              const goodFat100 = Number(p.goodfat100 ?? p.goodFat100 ?? 0) || 0;
              const trans100 = Number(p.trans100 ?? 0) || 0;

              // kcal100 ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ (–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ shared_products)
              // TEF-aware formula: protein*3 + carbs*4 + fat*9 (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å heys_core_v12.js:computeDerived)
              const carbs100 = simple100 + complex100;
              const fat100 = badFat100 + goodFat100 + trans100;
              const kcal100 = Math.round(protein100 * 3 + carbs100 * 4 + fat100 * 9);

              return {
                ...p,
                protein100,
                simple100,
                complex100,
                badFat100,
                goodFat100,
                trans100,
                fiber100: Number(p.fiber100 ?? 0) || 0,
                gi: Number(p.gi ?? 0) || 0,
                harm: (HEYS.models?.normalizeHarm?.(p) ?? Number(p.harm ?? p.harmScore ?? p.harmscore ?? 0)) || 0,  // Canonical harm field
                // –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                kcal100,
                carbs100,
                fat100,
                // –§–ª–∞–≥ —á—Ç–æ —ç—Ç–æ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã
                _fromShared: true
              };
            });
            console.log('[SharedSearch] Normalized first:', normalized[0]?.name, 'kcal100:', normalized[0]?.kcal100);
            setSharedResults(normalized);
          }
        } catch (err) {
          console.error('[AddProductStep] Shared search error:', err);
        } finally {
          setSharedLoading(false);
        }
      }, 300);

      return () => clearTimeout(timeoutId);
    }, [search]);

    // –£–º–Ω—ã–π —Å–ø–∏—Å–æ–∫: —á–∞—Å—Ç–æ—Ç–∞ + —Å–≤–µ–∂–µ—Å—Ç—å (–æ–±—ä–µ–¥–∏–Ω—è–µ—Ç "—á–∞—Å—Ç–æ" –∏ "–ø–æ—Å–ª–µ–¥–Ω–∏–µ")
    const usageStats = useMemo(() =>
      HEYS?.SmartSearchWithTypos?.getUsageStats?.() || new Map(),
      [productsVersion, usageStatsVersion]
    );

    const sessionUsageStats = useMemo(() => {
      const map = new Map();
      const dayData = contextDay || null;
      const meals = dayData?.meals || [];
      if (!Array.isArray(meals) || meals.length === 0) return map;

      const dateStr = dayData?.date || dateKey || new Date().toISOString().slice(0, 10);
      const dayTs = Date.parse(dateStr + 'T12:00:00') || Date.now();

      const bump = (key) => {
        if (!key) return;
        const curr = map.get(key);
        if (curr) {
          curr.count += 1;
          curr.lastUsed = Math.max(curr.lastUsed || 0, dayTs);
        } else {
          map.set(key, { count: 1, lastUsed: dayTs });
        }
      };

      meals.forEach((meal) => {
        (meal?.items || []).forEach((item) => {
          const pid = String(item?.product_id ?? item?.productId ?? '').trim();
          const name = String(item?.name || '').trim();
          if (pid) bump(pid);
          if (name) {
            bump(normalizeName(name));
            bump(name);
          }
        });
      });

      return map;
    }, [contextDay, dateKey]);

    const effectiveUsageStats = useMemo(() => {
      const base = usageStats instanceof Map ? usageStats : new Map();
      const session = sessionUsageStats instanceof Map ? sessionUsageStats : new Map();
      if (base.size === 0 && session.size === 0) return base;

      const merged = new Map(base);
      if (session.size === 0) return merged;

      const dateStr = dateKey || new Date().toISOString().slice(0, 10);
      const dayStart = Date.parse(dateStr + 'T00:00:00') || 0;

      session.forEach((s, key) => {
        if (!key) return;
        const curr = merged.get(key);
        if (!curr) {
          merged.set(key, { ...s });
          return;
        }
        const currLast = Number(curr.lastUsed || 0) || 0;
        const sessLast = Number(s.lastUsed || 0) || 0;
        const currHasToday = currLast >= dayStart;
        if (!currHasToday) {
          merged.set(key, {
            count: (Number(curr.count) || 0) + (Number(s.count) || 0),
            lastUsed: Math.max(currLast, sessLast)
          });
        }
      });

      return merged;
    }, [usageStats, sessionUsageStats, dateKey]);

    useEffect(() => {
      try {
        HEYS._usageStatsDebug = {
          ...(HEYS._usageStatsDebug || {}),
          modal: {
            size: effectiveUsageStats.size,
            source: usageStats.size > 0 ? 'stored' : (sessionUsageStats.size > 0 ? 'session' : 'empty'),
            products: latestProducts.length,
            dateKey: dateKey || new Date().toISOString().slice(0, 10)
          }
        };
      } catch (e) { }

      if (HEYS?.DEBUG_MODE) {
        const payload = HEYS._usageStatsDebug?.modal || {
          size: effectiveUsageStats.size,
          source: usageStats.size > 0 ? 'stored' : (sessionUsageStats.size > 0 ? 'session' : 'empty'),
          products: latestProducts.length,
          dateKey: dateKey || new Date().toISOString().slice(0, 10)
        };
        console.log('üîé [UsageStats] snapshot', payload);
        if (window.DEV?.log) {
          window.DEV.log('üîé [UsageStats] snapshot', payload);
        }
      }
    }, [effectiveUsageStats, usageStats.size, sessionUsageStats.size, latestProducts.length, dateKey]);

    const getUsageCount = useCallback((productId, productName) => {
      if (!productId && !productName) return 0;

      const nameRaw = String(productName || '').trim();
      const nameNorm = normalizeName(nameRaw);
      const nameSearchNorm = HEYS?.SmartSearchWithTypos?.utils?.normalizeText
        ? HEYS.SmartSearchWithTypos.utils.normalizeText(nameRaw)
        : nameNorm;

      const directStats = effectiveUsageStats.get(productId)
        || effectiveUsageStats.get(nameNorm)
        || effectiveUsageStats.get(nameSearchNorm)
        || effectiveUsageStats.get(nameRaw);

      const resolveCount = (stats) => {
        if (!stats || !stats.lastUsed) return 0;
        const daysAgo = Math.floor((Date.now() - stats.lastUsed) / (1000 * 60 * 60 * 24));
        if (daysAgo > usageWindowDays) return 0;
        return Number(stats.count) || 0;
      };

      const directCount = resolveCount(directStats);

      // Fallback: –º—è–≥–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–∞–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–æ–¥—Å—Ç—Ä–æ–∫–∞)
      let best = directCount;
      const target = nameSearchNorm || nameNorm || nameRaw;
      if (!target || !effectiveUsageStats || effectiveUsageStats.size === 0) return 0;

      effectiveUsageStats.forEach((stats, key) => {
        if (best >= 9999) return;
        const k = String(key || '').trim();
        if (!k || k.length < 3) return;
        if (!target.includes(k) && !k.includes(target)) return;
        const c = resolveCount(stats);
        if (c > best) best = c;
      });

      return best;
    }, [effectiveUsageStats, usageWindowDays]);

    const smartProducts = useMemo(() =>
      computeSmartProducts(latestProducts, dateKey, {
        favorites,
        hidden: hiddenProducts,
        daysWindow: usageWindowDays,
        usageStats: effectiveUsageStats
      }),
      [latestProducts, dateKey, favorites, hiddenProducts, effectiveUsageStats, usageWindowDays]
    );

    // –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º normalizeText –∏–∑ SmartSearch (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
    const normalizeSearch = HEYS?.SmartSearchWithTypos?.utils?.normalizeText
      || ((text) => String(text || '').toLowerCase().replace(/—ë/g, '–µ'));
    const lc = normalizeSearch(search.trim());
    const searchResults = useMemo(() => {
      let results = [];

      if (lc) {
        // –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if (HEYS.SmartSearchWithTypos) {
          try {
            const result = HEYS.SmartSearchWithTypos.search(lc, latestProducts, {
              enablePhonetic: true,
              enableSynonyms: true,
              enableTranslit: true, // üÜï —Ä–∞—Ñ–∞ ‚Üí rafa ‚Üí Raffaello
              maxSuggestions: 30,
              usageStats: effectiveUsageStats,   // üÜï v2.8.2: –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π boost –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
              usageWindowDays: usageWindowDays,  // üÜï v2.8.2: –æ–∫–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
              favorites: favorites               // üÜï v2.8.2: boost –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –≤ —Ç–æ–ø
            });
            if (result?.results?.length) results = result.results;
          } catch (e) {
            console.warn('[AddProductStep] Smart search error:', e);
          }
        }

        // Fallback —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π —ë‚Üí–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ SmartSearch –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
        if (!results.length) {
          results = latestProducts.filter(p =>
            normalizeSearch(p.name).includes(lc)
          );

          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¢–û–õ–¨–ö–û –¥–ª—è fallback ‚Äî SmartSearch —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ relevance!
          results.sort((a, b) => {
            const aName = normalizeSearch(a.name);
            const bName = normalizeSearch(b.name);
            const aStartsWith = aName.startsWith(lc) ? 0 : 1;
            const bStartsWith = bName.startsWith(lc) ? 0 : 1;
            if (aStartsWith !== bStartsWith) return aStartsWith - bStartsWith;
            // –ó–∞—Ç–µ–º –ø–æ —Ç–æ—á–Ω–æ–º—É –≤—Ö–æ–∂–¥–µ–Ω–∏—é —Å–ª–æ–≤–∞
            const aExact = aName.split(/\s+/).some(w => w === lc) ? 0 : 1;
            const bExact = bName.split(/\s+/).some(w => w === lc) ? 0 : 1;
            if (aExact !== bExact) return aExact - bExact;
            // –ó–∞—Ç–µ–º –ø–æ –¥–ª–∏–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∫–æ—Ä–æ—Ç–∫–∏–µ = —Ç–æ—á–Ω–µ–µ)
            return aName.length - bName.length;
          });
        }
      }

      // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      if (selectedCategory !== 'all') {
        results = results.filter(p => matchCategory(p, selectedCategory));
      }

      return results.slice(0, 20);
    }, [lc, latestProducts, selectedCategory, effectiveUsageStats, usageWindowDays, favorites]);

    // üåê –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: –ª–∏—á–Ω—ã–µ + –æ–±—â–∞—è –±–∞–∑–∞ (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
    const combinedResults = useMemo(() => {
      if (!lc) return [];

      // –§–∏–ª—å—Ç—Ä—É–µ–º shared —Ç–æ–∂–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∏–Ω–∞—á–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∂–µ—Ç—Å—è ¬´—Å–ª–æ–º–∞–Ω–Ω—ã–π¬ª)
      const sharedFiltered = selectedCategory !== 'all'
        ? sharedResults.filter(p => matchCategory(p, selectedCategory))
        : sharedResults;

      // –°–æ–±–∏—Ä–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ—Ä –ø–æ ¬´—Ä–µ–∞–ª—å–Ω–æ–º—É¬ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é,
      // —á—Ç–æ–±—ã —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ/–∫–æ—Å–≤–µ–Ω–Ω—ã–µ –ª–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ —É—Ç–∞–ø—Ç—ã–≤–∞–ª–∏ —Ç–æ—á–Ω—ã–µ shared-–º–∞—Ç—á–∏.
      const candidates = [];

      // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ—á–µ—Ç–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (Jaro-Winkler like –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Ç—Ä–æ–∫)
      const isFuzzyMatch = (word, query) => {
        if (!word || !query) return false;
        if (word.includes(query)) return true;

        // –î–æ–ø—É—Å–∫–∞–µ–º 1 –æ—à–∏–±–∫—É/–æ–ø–µ—á–∞—Ç–∫—É –¥–ª—è —Å–ª–æ–≤ –¥–ª–∏–Ω–Ω–µ–µ 4 –±—É–∫–≤
        if (query.length > 3 && Math.abs(word.length - query.length) <= 2) {
          let errors = 0;
          let i = 0, j = 0;
          while (i < word.length && j < query.length) {
            if (word[i] !== query[j]) {
              errors++;
              if (errors > 1) return false;
              // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–∏–º–≤–æ–ª –≤ –æ–¥–Ω–æ–º –∏–∑ —Å–ª–æ–≤ (–≤—Å—Ç–∞–≤–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ)
              if (word.length > query.length) i++;
              else if (query.length > word.length) j++;
              else { i++; j++; } // –ó–∞–º–µ–Ω–∞
            } else {
              i++; j++;
            }
          }
          return true;
        }
        return false;
      };

      const pushCandidate = (p, source) => {
        if (!p) return;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ—Ç—É (–∑–∞—â–∏—Ç–∞ –æ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏)
        let nameNorm = normalizeSearch(p.name || '');
        if (!nameNorm && p.name) nameNorm = p.name.toLowerCase().trim();

        if (!nameNorm) return;

        const baseRel = Number.isFinite(p.relevance) ? p.relevance : 0;
        const hasSubstring = nameNorm.includes(lc);
        const startsWith = nameNorm.startsWith(lc);

        // –†–∞–∑–±–∏–≤–∞–µ–º –∏–º—è –Ω–∞ —Å–ª–æ–≤–∞ –¥–ª—è –±–æ–ª–µ–µ —É–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        const nameWords = nameNorm.split(/[\s,().]+/); // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –ø—Ä–æ–±–µ–ª, –∑–∞–ø—è—Ç–∞—è, —Å–∫–æ–±–∫–∏, —Ç–æ—á–∫–∞
        const exactWord = nameWords.some(w => w === lc);
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º fuzzy —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞
        const fuzzyMatch = nameWords.some(w => isFuzzyMatch(w, lc));
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Å–ª–æ–≤–∞ (3+ –±—É–∫–≤—ã) ‚Äî —Å–ø–∞—Å–∞–µ—Ç "—Å–∞–≤–∞—è" -> "—Å–∞–≤–æ—è—Ä–¥–∏" (—Å–æ–≤–ø–∞–¥–∞–µ—Ç "—Å–∞–≤")
        const prefix3Match = lc.length >= 3 && nameWords.some(w => w.startsWith(lc.slice(0, 3)));
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –ª—é–±–æ–≥–æ —Å–ª–æ–≤–∞ (–¥–ª—è "ad" ‚Üí "Admin" –∏ —Ç.–ø.)
        const wordStartsWith = nameWords.some(w => w.startsWith(lc));

        // –ë–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä: –∏—Å–ø–æ–ª—å–∑—É–µ–º relevance –µ—Å–ª–∏ –µ—Å—Ç—å + –ø–æ–ø—Ä–∞–≤–∫–∏
        let score = baseRel;

        if (hasSubstring) score += 40;
        else if (fuzzyMatch) score += 30; // –ü–æ—á—Ç–∏ –∫–∞–∫ —Ç–æ—á–Ω–æ–µ, –µ—Å–ª–∏ –ø–æ—Ö–æ–∂–µ
        else if (prefix3Match) score += 20; // –ù–∞—á–∞–ª–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —ç—Ç–æ —É–∂–µ –Ω–µ–ø–ª–æ—Ö–æ

        // üîß startsWith (–∏–º—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∑–∞–ø—Ä–æ—Å–∞) ‚Äî —Å–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª, –ø–µ—Ä–µ–±–∏–≤–∞–µ—Ç relevance
        if (startsWith) score += 70;
        else if (wordStartsWith) score += 20; // —Å–ª–æ–≤–æ –≤ –∏–º–µ–Ω–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∑–∞–ø—Ä–æ—Å–∞
        if (exactWord) score += 10;

        // üÜï –ë—É—Å—Ç –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö/–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö (48—á) ‚Äî –ø–æ–¥–Ω–∏–º–∞–µ–º –≤–≤–µ—Ä—Ö –≤ –ø–æ–∏—Å–∫–µ
        const recentTs = Number(p.updatedAt || p.createdAt || 0);
        const recentWindowMs = 48 * 60 * 60 * 1000;
        if (recentTs > 0 && (Date.now() - recentTs) < recentWindowMs) score += 25;

        // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –ø–æ–¥—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, fuzzy –∏ –¥–∞–∂–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ ‚Äî —Å–∏–ª—å–Ω–æ —à—Ç—Ä–∞—Ñ—É–µ–º
        if (!hasSubstring && !fuzzyMatch && !prefix3Match) score -= 35;

        // –õ—ë–≥–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ª–∏—á–Ω—ã–º (–ø—Ä–∏ –ø—Ä–æ—á–∏—Ö —Ä–∞–≤–Ω—ã—Ö)
        if (source === 'personal') score += 3;
        // Shared —Ç–æ–∂–µ –≤–∞–∂–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∏ —Ö–æ—Ä–æ—à–æ —Å–æ–≤–ø–∞–¥–∞—é—Ç
        if (source === 'shared') score += 1;

        candidates.push({ ...p, _source: source, _score: score, _nameNorm: nameNorm });
      };

      searchResults.forEach(p => pushCandidate(p, 'personal'));
      sharedFiltered.forEach(p => pushCandidate(p, 'shared'));

      // –î–µ–¥—É–ø –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –ª—É—á—à–∏–π —Å–∫–æ—Ä
      // üîß FIX: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞–º —Å –ø–æ—Ä—Ü–∏—è–º–∏ (–ª–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
      const bestByName = new Map();
      candidates.forEach(p => {
        const key = p._nameNorm;
        const prev = bestByName.get(key);
        if (!prev) {
          bestByName.set(key, p);
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ä—Ü–∏–π
        const prevHasPortions = Array.isArray(prev.portions) && prev.portions.length > 0;
        const currHasPortions = Array.isArray(p.portions) && p.portions.length > 0;

        // –ï—Å–ª–∏ —É —Ç–µ–∫—É—â–µ–≥–æ –µ—Å—Ç—å –ø–æ—Ä—Ü–∏–∏, –∞ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –Ω–µ—Ç ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π
        if (currHasPortions && !prevHasPortions) {
          bestByName.set(key, p);
          return;
        }

        // –ï—Å–ª–∏ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –µ—Å—Ç—å –ø–æ—Ä—Ü–∏–∏, –∞ —É —Ç–µ–∫—É—â–µ–≥–æ –Ω–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π
        if (prevHasPortions && !currHasPortions) {
          return;
        }

        // –ò–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ score (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        if ((p._score ?? 0) > (prev._score ?? 0)) {
          bestByName.set(key, p);
        }
      });

      const combined = Array.from(bestByName.values());

      combined.sort((a, b) => {
        const sa = a._score ?? 0;
        const sb = b._score ?? 0;
        if (sa !== sb) return sb - sa;
        // tie-break: personal –≤—ã—à–µ shared
        if (a._source !== b._source) return a._source === 'personal' ? -1 : 1;
        // –∑–∞—Ç–µ–º –∫–æ—Ä–æ—á–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã—à–µ
        return String(a.name || '').length - String(b.name || '').length;
      });

      return combined.slice(0, 25);
    }, [searchResults, sharedResults, lc, normalizeSearch, selectedCategory]);

    // "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
    const didYouMean = useMemo(() => {
      if (!lc || combinedResults.length > 0) return [];

      if (HEYS?.SmartSearchWithTypos?.getDidYouMean) {
        return HEYS.SmartSearchWithTypos.getDidYouMean(lc, latestProducts, 3);
      }
      return [];
    }, [lc, combinedResults.length, latestProducts]);

    // Toggle –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const toggleFavorite = useCallback((e, productId) => {
      e.stopPropagation();
      if (HEYS.store?.toggleFavorite) {
        HEYS.store.toggleFavorite(productId);
        setFavorites(HEYS.store.getFavorites());
      }
    }, []);

    const toggleHidden = useCallback((e, productId, productName, isHiddenNow) => {
      e.stopPropagation();

      const name = productName || '–ø—Ä–æ–¥—É–∫—Ç';
      if (!isHiddenNow) {
        const confirmed = confirm(`–£–±—Ä–∞—Ç—å "${name}" –∏–∑ –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤?\n\n–û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞. –í–µ—Ä–Ω—É—Ç—å –º–æ–∂–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ ‚Üí –°–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.`);
        if (!confirmed) return;
      }

      if (HEYS.store?.toggleHiddenProduct) {
        HEYS.store.toggleHiddenProduct(productId);
        setHiddenProducts(HEYS.store.getHiddenProducts());
        setFavorites(HEYS.store.getFavorites());
      }
    }, []);

    // –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞ ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ –≥—Ä–∞–º–º–æ–≤
    const selectProduct = useCallback((product) => {
      haptic('light');

      try {
        if (HEYS.store?.getHiddenProducts) {
          setHiddenProducts(HEYS.store.getHiddenProducts());
        }
      } catch (e) {
        // no-op
      }

      // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞–º–º—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
      const productId = product.id ?? product.product_id ?? product.name;
      const lastGrams = lsGet(`heys_last_grams_${productId}`, null);
      // v25.3: Use ML grams only from _mlGrams (set once by recommendation), not stale data.grams
      const mlGrams = data._mlGrams || null;
      const defaultGrams = mlGrams || lastGrams || 100;

      // üîç DEBUG: –ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
      const hasNutrients = !!(product.kcal100 || product.protein100 || product.carbs100);
      // console.log('[ProductSearchStep] selectProduct:', product.name, 'grams:', defaultGrams, {...});
      if (!hasNutrients) {
        console.error('üö® [ProductSearchStep] CRITICAL: Product has NO nutrients!', product);
      }

      onChange({
        ...data,
        selectedProduct: product,
        grams: defaultGrams,
        _mlGrams: null, // v25.3: clear ML grams after first use
        lastGrams: lastGrams
      });
      // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ –≥—Ä–∞–º–º–æ–≤ (index 4: search ‚Üí grams)
      // –®–∞–≥–∏ create/portions/harm ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–û–í–´–• –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      // –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è state
      if (goToStep) {
        setTimeout(() => goToStep(4, 'left'), 150);
      }
    }, [data, onChange, goToStep]);

    // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç" ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤–Ω–µ—à–Ω–µ–π —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
    const handleNewProduct = useCallback(() => {
      haptic('medium');
      onChange({ ...data, searchQuery: search });
      // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —à–∞–≥ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–µ–≥–æ
      if (goToStep) {
        setTimeout(() => goToStep(1, 'left'), 10);
        return;
      }
      // –ò–Ω–∞—á–µ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω onNewProduct –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî –≤—ã–∑–≤–∞—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
      if (context?.onNewProduct) {
        context.onNewProduct();
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π StepModal, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
        if (goToStep) {
          // StepModal –Ω–µ –¥–∞—ë—Ç —è–≤–Ω–æ–≥–æ close –∑–¥–µ—Å—å ‚Äî –∑–∞–∫—Ä–æ–µ–º —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª
          HEYS.StepModal?.close?.();
        }
      }
    }, [context, goToStep, search, data, onChange]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
    const handlePhotoSelect = useCallback((e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      haptic('medium');
      setSelectedPhoto(file);
      // console.log('[AddProductStep] Photo selected:', file.name, file.size, 'bytes');

      // –°–∂–∏–º–∞–µ–º —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (localStorage –ª–∏–º–∏—Ç ~5–ú–ë)
      const MAX_SIZE = 800; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ –±–æ–ª—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
      const QUALITY = 0.7;  // –ö–∞—á–µ—Å—Ç–≤–æ JPEG

      const img = new Image();
      img.onload = () => {
        // –†–∞—Å—á—ë—Ç –Ω–æ–≤—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
        let { width, height } = img;
        if (width > MAX_SIZE || height > MAX_SIZE) {
          if (width > height) {
            height = Math.round(height * MAX_SIZE / width);
            width = MAX_SIZE;
          } else {
            width = Math.round(width * MAX_SIZE / height);
            height = MAX_SIZE;
          }
        }

        // Canvas –¥–ª—è —Å–∂–∞—Ç–∏—è
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JPEG (–º–µ–Ω—å—à–µ —Ä–∞–∑–º–µ—Ä —á–µ–º PNG)
        const compressedData = canvas.toDataURL('image/jpeg', QUALITY);
        // console.log('[AddProductStep] Photo compressed:', ...);

        setPhotoPreview(compressedData);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        setPendingPhotoData({
          compressedData,
          filename: file.name,
          originalSize: file.size
        });
        setShowPhotoConfirm(true);
      };

      img.onerror = () => {
        console.error('[AddProductStep] Failed to load image');
      };

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
      const reader = new FileReader();
      reader.onload = (event) => {
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ –∂–µ —Ñ–æ—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ
      e.target.value = '';
    }, []);

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ
    const confirmPhoto = useCallback(() => {
      if (!pendingPhotoData || !context?.onAddPhoto) {
        console.warn('[AddProductStep] Cannot confirm photo - missing data or callback');
        setShowPhotoConfirm(false);
        return;
      }

      haptic('success');
      context.onAddPhoto({
        mealIndex: context.mealIndex,
        photo: pendingPhotoData.compressedData,
        filename: pendingPhotoData.filename,
        timestamp: Date.now()
      });
      // console.log('[AddProductStep] Photo confirmed and added to meal:', context.mealIndex);

      setShowPhotoConfirm(false);
      setPendingPhotoData(null);
    }, [pendingPhotoData, context]);

    // –û—Ç–º–µ–Ω–∞ —Ñ–æ—Ç–æ
    const cancelPhoto = useCallback(() => {
      haptic('light');
      setShowPhotoConfirm(false);
      setPendingPhotoData(null);
      setPhotoPreview(null);
      // console.log('[AddProductStep] Photo cancelled');
    }, []);

    // –û—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —Ñ–æ—Ç–æ
    const handlePhotoClick = useCallback(() => {
      haptic('medium');
      fileInputRef.current?.click();
    }, []);

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –±–∞–∑—ã
    const handleDeleteProduct = useCallback((e, product) => {
      e.stopPropagation();

      const name = product.name || '–ø—Ä–æ–¥—É–∫—Ç';
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}" –∏–∑ –±–∞–∑—ã?`)) return;

      haptic('medium');

      const U = HEYS.utils || {};
      const allProducts = HEYS.products?.getAll?.() || U.lsGet?.('heys_products', []) || [];
      const pid = String(product.id ?? product.product_id ?? product.name);
      const fingerprint = product.fingerprint || null;

      // üÜï v4.8.0: –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç —á—Ç–æ–±—ã autoRecover –∏ cloud sync –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏
      if (HEYS.deletedProducts?.add) {
        HEYS.deletedProducts.add(name, pid, fingerprint);
      }

      // –§–∏–ª—å—Ç—Ä—É–µ–º ‚Äî —É–±–∏—Ä–∞–µ–º —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç
      const filtered = allProducts.filter(p => {
        const id = String(p.id ?? p.product_id ?? p.name);
        return id !== pid;
      });

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ HEYS.products –∏–ª–∏ HEYS.store.set (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º)
      if (HEYS.products?.setAll) {
        HEYS.products.setAll(filtered);
      } else if (HEYS.store?.set) {
        HEYS.store.set('heys_products', filtered);
      } else if (U.lsSet) {
        U.lsSet('heys_products', filtered);
        console.warn('[AddProductStep] ‚ö†Ô∏è –ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª—ë–Ω —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ—Ç HEYS.store)');
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º context.products
      if (context?.onProductCreated) {
        // –ö–æ—Å—Ç—ã–ª—å: —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      }

      // console.log('[AddProductStep] –ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª—ë–Ω:', name);

      // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
      setSearch(s => s + ' ');
      setTimeout(() => setSearch(s => s.trim()), 10);
    }, [context]);

    // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    const renderProductCard = (product, showFavorite = true, showHide = true, showUsageCount = false) => {
      const pid = String(product.id ?? product.product_id ?? product.name);
      const isFav = favorites.has(pid);
      const isHidden = hiddenProducts.has(pid);
      const usageCount = showUsageCount ? getUsageCount(pid, product.name) : 0;
      const kcal = Math.round(product.kcal100 || 0);
      const prot = Math.round(product.protein100 || 0);
      const carbs = Math.round((product.simple100 || 0) + (product.complex100 || 0));
      const fat = Math.round((product.badFat100 || 0) + (product.goodFat100 || 0) + (product.trans100 || 0));
      const harmVal = product.harm ?? product.harmScore ?? product.harm100;
      const harmBg = getHarmBg(harmVal);

      // –§–ª–∞–≥: –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (–Ω–µ –∏–∑ –ª–∏—á–Ω–æ–π)
      const isFromShared = product._source === 'shared' || product._fromShared;

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
      const highlightedName = lc && HEYS?.SmartSearchWithTypos?.renderHighlightedText
        ? HEYS.SmartSearchWithTypos.renderHighlightedText(product.name, search, React)
        : product.name;

      return React.createElement('div', {
        key: pid,
        className: 'aps-product-card',
        style: harmBg ? { background: harmBg } : undefined,
        onClick: () => selectProduct(product)
      },
        // –ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        product.category && React.createElement('span', {
          className: 'aps-product-icon'
        }, getCategoryIcon(product.category)),

        // –ò–Ω—Ñ–æ
        React.createElement('div', { className: 'aps-product-info' },
          React.createElement('div', { className: 'aps-product-name' },
            highlightedName,
            // üåê –ë–µ–π–¥–∂ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã
            isFromShared && React.createElement('span', {
              className: 'aps-shared-badge'
            }, 'üåê')
          ),
          React.createElement('div', { className: 'aps-product-meta' },
            React.createElement('span', { className: 'aps-meta-kcal' }, kcal + ' –∫–∫–∞–ª'),
            React.createElement('span', { className: 'aps-meta-sep' }, '¬∑'),
            React.createElement('span', { className: 'aps-meta-macros' },
              '–ë ' + prot + ' | –ñ ' + fat + ' | –£ ' + carbs
            ),
            showUsageCount && React.createElement(React.Fragment, null,
              React.createElement('span', { className: 'aps-meta-sep' }, '¬∑'),
              React.createElement('span', { className: 'aps-product-usage' }, `–ò—Å–ø.: ${usageCount}√ó`)
            )
          )
        ),

        React.createElement('div', { className: 'aps-product-actions' },
          showHide && !isFromShared && React.createElement('button', {
            className: 'aps-hide-btn' + (isHidden ? ' aps-hide-btn--active' : ''),
            onClick: (e) => toggleHidden(e, pid, product.name, isHidden),
            title: isHidden ? '–í–µ—Ä–Ω—É—Ç—å –≤ —Å–ø–∏—Å–æ–∫' : '–°–∫—Ä—ã—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞'
          }, '‚úï'),
          // –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö
          showFavorite && !isFromShared && React.createElement('button', {
            className: 'aps-fav-btn' + (isFav ? ' active' : ''),
            onClick: (e) => toggleFavorite(e, pid)
          }, isFav ? '‚òÖ' : '‚òÜ')
        )
      );
    };

    // –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —É–º–Ω—ã–π —Å–ø–∏—Å–æ–∫
    const showSearch = lc.length > 0;

    // –°—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–∏—ë–º–µ
    const currentPhotoCount = context?.mealPhotos?.length || 0;
    const photoLimit = 10;
    const canAddPhoto = currentPhotoCount < photoLimit;

    return React.createElement('div', { className: 'aps-search-step' },
      // –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ñ–æ—Ç–æ
      showPhotoConfirm && pendingPhotoData && React.createElement('div', {
        className: 'photo-confirm-overlay',
        onClick: cancelPhoto
      },
        React.createElement('div', {
          className: 'photo-confirm-modal',
          onClick: e => e.stopPropagation()
        },
          React.createElement('div', { className: 'photo-confirm-header' }, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?'),
          React.createElement('div', { className: 'photo-confirm-preview' },
            React.createElement('img', {
              src: pendingPhotoData.compressedData,
              alt: '–ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ'
            })
          ),
          React.createElement('div', { className: 'photo-confirm-info' },
            Math.round(pendingPhotoData.compressedData.length / 1024) + ' –ö–ë'
          ),
          React.createElement('div', { className: 'photo-confirm-buttons' },
            React.createElement('button', {
              className: 'photo-confirm-btn cancel',
              onClick: cancelPhoto
            }, '–û—Ç–º–µ–Ω–∞'),
            React.createElement('button', {
              className: 'photo-confirm-btn confirm',
              onClick: confirmPhoto
            }, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å')
          )
        )
      ),

      // –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
      React.createElement('input', {
        ref: fileInputRef,
        type: 'file',
        accept: 'image/*',
        capture: 'environment', // –ö–∞–º–µ—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        style: { display: 'none' },
        onChange: handlePhotoSelect
      }),

      // === –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∞–ø–∫–∞: –∫–Ω–æ–ø–∫–∏ + –ø–æ–∏—Å–∫ + –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ===
      React.createElement('div', { className: 'aps-fixed-header' },
        // –†—è–¥ –∫–Ω–æ–ø–æ–∫: –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ + –ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç
        React.createElement('div', { className: 'aps-action-buttons' },
          // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ" —Å —Å—á—ë—Ç—á–∏–∫–æ–º
          React.createElement('button', {
            className: 'aps-new-product-btn aps-photo-btn' + (!canAddPhoto ? ' disabled' : ''),
            onClick: canAddPhoto ? handlePhotoClick : null,
            disabled: !canAddPhoto,
            title: !canAddPhoto ? `–õ–∏–º–∏—Ç ${photoLimit} —Ñ–æ—Ç–æ` : '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ'
          },
            React.createElement('span', { className: 'aps-new-icon' }, 'üì∑'),
            React.createElement('span', null,
              currentPhotoCount > 0
                ? `–§–æ—Ç–æ ${currentPhotoCount}/${photoLimit}`
                : '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ'
            )
          ),
          // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç"
          React.createElement('button', {
            className: 'aps-new-product-btn',
            onClick: handleNewProduct
          },
            React.createElement('span', { className: 'aps-new-icon' }, '+'),
            React.createElement('span', null, '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç')
          )
        ),

        // –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞
        React.createElement('div', { className: 'aps-search-container' },
          React.createElement('span', { className: 'aps-search-icon' }, 'üîç'),
          React.createElement('input', {
            ref: inputRef,
            type: 'text',
            className: 'aps-search-input',
            placeholder: '–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞...',
            value: searchInput,
            onChange: (e) => setSearchInput(e.target.value),
            autoComplete: 'off',
            autoCorrect: 'off',
            spellCheck: false
          }),
          search && React.createElement('button', {
            className: 'aps-search-clear',
            onClick: () => {
              setSearchInput('');
              setSearch('');
            }
          }, '√ó')
        )
      ),

      // === –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ===
      React.createElement('div', { className: 'aps-products-scroll' },
        // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        showSearch && React.createElement('div', { className: 'aps-section' },
          React.createElement('div', { className: 'aps-section-title' },
            combinedResults.length > 0
              ? `–ù–∞–π–¥–µ–Ω–æ: ${combinedResults.length}${sharedLoading ? ' ‚è≥' : ''}`
              : (sharedLoading ? '‚è≥ –ü–æ–∏—Å–∫...' : '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ')
          ),
          combinedResults?.length > 0 && React.createElement('div', { className: 'aps-products-list' },
            combinedResults.map(p => renderProductCard(p, true, false, true))
          ),
          // –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏"
          combinedResults.length === 0 && !sharedLoading && React.createElement('div', { className: 'aps-empty' },
            React.createElement('span', null, 'üòï'),

            // "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
            didYouMean.length > 0 && React.createElement('div', {
              className: 'aps-did-you-mean',
              style: {
                marginTop: '12px',
                padding: '12px',
                backgroundColor: 'rgba(255, 213, 0, 0.1)',
                borderRadius: '8px',
                textAlign: 'left'
              }
            },
              React.createElement('div', {
                style: {
                  fontSize: '13px',
                  color: 'var(--text-secondary)',
                  marginBottom: '8px'
                }
              }, 'üí° –í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏:'),
              React.createElement('div', {
                style: {
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: '8px'
                }
              },
                didYouMean.map((item, i) =>
                  React.createElement('button', {
                    key: i,
                    onClick: () => {
                      setSearchInput(item.text);
                      setSearch(item.text);
                    },
                    style: {
                      padding: '6px 12px',
                      border: '1px solid var(--border-color)',
                      borderRadius: '16px',
                      backgroundColor: 'var(--bg-card)',
                      cursor: 'pointer',
                      fontSize: '14px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px'
                    }
                  },
                    React.createElement('span', null, item.text),
                    item.label && React.createElement('span', {
                      style: {
                        fontSize: '10px',
                        color: 'var(--text-tertiary)',
                        marginLeft: '4px'
                      }
                    }, item.label)
                  )
                )
              )
            ),

            !didYouMean.length && React.createElement('span', null, '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å'),

            React.createElement('button', {
              className: 'aps-add-new-btn',
              onClick: handleNewProduct,
              style: { marginTop: didYouMean.length > 0 ? '12px' : '8px' }
            }, '+ –î–æ–±–∞–≤–∏—Ç—å "' + search + '"')
          )
        ),

        // –£–º–Ω—ã–π —Å–ø–∏—Å–æ–∫: —á–∞—Å—Ç–æ + –Ω–µ–¥–∞–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ (–æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π)
        !showSearch && smartProducts?.length > 0 && React.createElement('div', { className: 'aps-section' },
          React.createElement('div', { className: 'aps-section-title' }, '‚ö° –í–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã'),
          React.createElement('div', { className: 'aps-products-list' },
            smartProducts.map(p => renderProductCard(p, true, true, true))
          )
        )
      )
    );
  }

  const CREATE_PRODUCT_AI_PROMPT_FALLBACK = `–°–¥–µ–ª–∞–π –æ–¥–Ω—É —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ö–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ" (–∫–∞–∂–¥–æ–µ –ø–æ–ª–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏). –ù–∏–∫–∞–∫–æ–≥–æ JSON/–∫–æ–¥–∞. –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 100–≥.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
–ù–∞–∑–≤–∞–Ω–∏–µ: X
–ö–∫–∞–ª: X
–£–≥–ª–µ–≤–æ–¥—ã: X
–ü—Ä–æ—Å—Ç—ã–µ: X
–°–ª–æ–∂–Ω—ã–µ: X
–ë–µ–ª–æ–∫: X
–ñ–∏—Ä—ã: X
–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: X
–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: X
–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: X
–ö–ª–µ—Ç—á–∞—Ç–∫–∞: X
–ì–ò: X
–í—Ä–µ–¥: X

–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (–µ—Å–ª–∏ –∑–Ω–∞–µ—à—å ‚Äî –¥–æ–±–∞–≤—å):
–ù–∞—Ç—Ä–∏–π: X
–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: X
–û–º–µ–≥–∞-3: X
–û–º–µ–≥–∞-6: X
NOVA: 1-4
–î–æ–±–∞–≤–∫–∏: E621, E330 (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî "–Ω–µ—Ç")
–ù—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: X
–û—Ä–≥–∞–Ω–∏–∫: 0/1
–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π: 0/1
–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 0/1
–°—ã—Ä–æ–π: 0/1
–í–∏—Ç–∞–º–∏–Ω A: X
–í–∏—Ç–∞–º–∏–Ω C: X
–í–∏—Ç–∞–º–∏–Ω D: X
–í–∏—Ç–∞–º–∏–Ω E: X
–í–∏—Ç–∞–º–∏–Ω K: X
–í–∏—Ç–∞–º–∏–Ω B1: X
–í–∏—Ç–∞–º–∏–Ω B2: X
–í–∏—Ç–∞–º–∏–Ω B3: X
–í–∏—Ç–∞–º–∏–Ω B6: X
–í–∏—Ç–∞–º–∏–Ω B9: X
–í–∏—Ç–∞–º–∏–Ω B12: X
–ö–∞–ª—å—Ü–∏–π: X
–ñ–µ–ª–µ–∑–æ: X
–ú–∞–≥–Ω–∏–π: X
–§–æ—Å—Ñ–æ—Ä: X
–ö–∞–ª–∏–π: X
–¶–∏–Ω–∫: X
–°–µ–ª–µ–Ω: X
–ô–æ–¥: X`;

  const CREATE_PRODUCT_AI_EXAMPLE = `–ù–∞–∑–≤–∞–Ω–∏–µ: –ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π —Å–≤–µ–∂–∏–π
–ö–∫–∞–ª: 31
–£–≥–ª–µ–≤–æ–¥—ã: 6
–ü—Ä–æ—Å—Ç—ã–µ: 4
–°–ª–æ–∂–Ω—ã–µ: 2
–ë–µ–ª–æ–∫: 1
–ñ–∏—Ä—ã: 0.3
–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: 0.1
–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: 0.2
–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: 0
–ö–ª–µ—Ç—á–∞—Ç–∫–∞: 2.1
–ì–ò: 15
–í—Ä–µ–¥: 0
–ù–∞—Ç—Ä–∏–π: 2
–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 0
–û–º–µ–≥–∞-3: 0
–û–º–µ–≥–∞-6: 0
NOVA: 1
–î–æ–±–∞–≤–∫–∏: –Ω–µ—Ç
–û—Ä–≥–∞–Ω–∏–∫: 0
–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π: 0
–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 0
–°—ã—Ä–æ–π: 1
–í–∏—Ç–∞–º–∏–Ω A: 17.4
–í–∏—Ç–∞–º–∏–Ω C: 141.1
–í–∏—Ç–∞–º–∏–Ω D: 0
–í–∏—Ç–∞–º–∏–Ω E: 10.5
–í–∏—Ç–∞–º–∏–Ω K: 4.1
–í–∏—Ç–∞–º–∏–Ω B1: 4.5
–í–∏—Ç–∞–º–∏–Ω B2: 6.5
–í–∏—Ç–∞–º–∏–Ω B3: 6.1
–í–∏—Ç–∞–º–∏–Ω B6: 17.1
–í–∏—Ç–∞–º–∏–Ω B9: 11.5
–í–∏—Ç–∞–º–∏–Ω B12: 0
–ö–∞–ª—å—Ü–∏–π: 0.7
–ñ–µ–ª–µ–∑–æ: 2.4
–ú–∞–≥–Ω–∏–π: 3
–§–æ—Å—Ñ–æ—Ä: 3.7
–ö–∞–ª–∏–π: 6
–¶–∏–Ω–∫: 2.3
–°–µ–ª–µ–Ω: 0.2
–ô–æ–¥: 0`;

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (–®–∞–≥ create) ===
  function CreateProductStep({ data, onChange, context, stepData }) {
    // –ë–µ—Ä—ë–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
    const searchQuery = stepData?.search?.searchQuery || '';
    const [pasteText, setPasteText] = useState('');
    const [error, setError] = useState('');
    const [parsedPreview, setParsedPreview] = useState(null);
    const textareaRef = useRef(null);

    // üåê –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –æ–±—â—É—é –±–∞–∑—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ)
    const [publishToShared, setPublishToShared] = useState(true);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫—É—Ä–∞—Ç–æ—Ä –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ PIN)
    const isCurator = isCuratorUser();

    // –î–æ—Å—Ç—É–ø –∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ StepModal
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { goToStep, closeModal, updateStepData } = stepContext;

    useEscapeToClose(closeModal, true);

    // –§–æ–∫—É—Å –Ω–∞ textarea –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    useEffect(() => {
      setTimeout(() => textareaRef.current?.focus(), 100);
    }, []);

    const draftKey = 'heys_product_draft';

    useEffect(() => {
      const utils = U();
      const draft = HEYS.store?.get?.(draftKey, null) ?? utils.lsGet?.(draftKey, null);
      if (!draft || pasteText) return;
      if (draft.pasteText != null) setPasteText(draft.pasteText);
      if (typeof draft.publishToShared === 'boolean') setPublishToShared(draft.publishToShared);
    }, []);

    useEffect(() => {
      const utils = U();
      const timer = setTimeout(() => {
        const payload = {
          pasteText,
          publishToShared
        };
        if (HEYS.store?.set) {
          HEYS.store.set(draftKey, payload);
          return;
        }
        if (utils.lsSet) {
          utils.lsSet(draftKey, payload);
        }
      }, 500);

      return () => clearTimeout(timer);
    }, [pasteText, publishToShared]);

    const MISSING_FIELD_LABELS = {
      kcal100: '–ö–∫–∞–ª',
      carbs100: '–£–≥–ª–µ–≤–æ–¥—ã',
      simple100: '–ü—Ä–æ—Å—Ç—ã–µ',
      complex100: '–°–ª–æ–∂–Ω—ã–µ',
      protein100: '–ë–µ–ª–æ–∫',
      fat100: '–ñ–∏—Ä—ã',
      badFat100: '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã',
      goodFat100: '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã',
      trans100: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã',
      fiber100: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞',
      gi: '–ì–ò',
      harm: '–í—Ä–µ–¥'
    };

    const countExtendedFields = useCallback((product) => {
      if (!product) return 0;
      const fields = [
        'sodium100', 'omega3_100', 'omega6_100', 'nova_group', 'additives', 'nutrient_density',
        'is_organic', 'is_whole_grain', 'is_fermented', 'is_raw',
        'vitamin_a', 'vitamin_c', 'vitamin_d', 'vitamin_e', 'vitamin_k',
        'vitamin_b1', 'vitamin_b2', 'vitamin_b3', 'vitamin_b6', 'vitamin_b9', 'vitamin_b12',
        'calcium', 'iron', 'magnesium', 'phosphorus', 'potassium', 'zinc', 'selenium', 'iodine'
      ];

      return fields.reduce((count, field) => {
        const value = product[field];
        if (Array.isArray(value)) return value.length > 0 ? count + 1 : count;
        if (typeof value === 'boolean') return count + 1;
        return value != null ? count + 1 : count;
      }, 0);
    }, []);

    const formatMissingFields = useCallback((fields) => {
      return fields
        .map((field) => MISSING_FIELD_LABELS[field] || field)
        .join(', ');
    }, []);

    const PREVIEW_FIELDS = useMemo(() => ([
      { key: 'kcal100', label: '–ö–∫–∞–ª (100–≥)', unit: '–∫–∫–∞–ª' },
      { key: 'carbs100', label: '–£–≥–ª–µ–≤–æ–¥—ã (100–≥)', unit: '–≥' },
      { key: 'simple100', label: '–ü—Ä–æ—Å—Ç—ã–µ (100–≥)', unit: '–≥' },
      { key: 'complex100', label: '–°–ª–æ–∂–Ω—ã–µ (100–≥)', unit: '–≥' },
      { key: 'protein100', label: '–ë–µ–ª–æ–∫ (100–≥)', unit: '–≥' },
      { key: 'fat100', label: '–ñ–∏—Ä—ã (100–≥)', unit: '–≥' },
      { key: 'badFat100', label: '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (100–≥)', unit: '–≥' },
      { key: 'goodFat100', label: '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (100–≥)', unit: '–≥' },
      { key: 'trans100', label: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã (100–≥)', unit: '–≥' },
      { key: 'fiber100', label: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (100–≥)', unit: '–≥' },
      { key: 'gi', label: '–ì–ò' },
      { key: 'harm', label: '–í—Ä–µ–¥' },
      { key: 'sodium100', label: '–ù–∞—Ç—Ä–∏–π (100–≥)', unit: '–º–≥' },
      { key: 'cholesterol', label: '–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω (100–≥)', unit: '–º–≥' },
      { key: 'omega3_100', label: '–û–º–µ–≥–∞-3 (100–≥)', unit: '–≥' },
      { key: 'omega6_100', label: '–û–º–µ–≥–∞-6 (100–≥)', unit: '–≥' },
      { key: 'nova_group', label: 'NOVA –≥—Ä—É–ø–ø–∞' },
      { key: 'additives', label: '–î–æ–±–∞–≤–∫–∏' },
      { key: 'nutrient_density', label: '–ù—É—Ç—Ä. –ø–ª–æ—Ç–Ω–æ—Å—Ç—å', unit: '%' },
      { key: 'is_organic', label: '–û—Ä–≥–∞–Ω–∏–∫', type: 'bool' },
      { key: 'is_whole_grain', label: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω.', type: 'bool' },
      { key: 'is_fermented', label: '–§–µ—Ä–º–µ–Ω—Ç–∏—Ä.', type: 'bool' },
      { key: 'is_raw', label: '–°—ã—Ä–æ–π', type: 'bool' },
      { key: 'vitamin_a', label: '–í–∏—Ç–∞–º–∏–Ω A', unit: '%' },
      { key: 'vitamin_c', label: '–í–∏—Ç–∞–º–∏–Ω C', unit: '%' },
      { key: 'vitamin_d', label: '–í–∏—Ç–∞–º–∏–Ω D', unit: '%' },
      { key: 'vitamin_e', label: '–í–∏—Ç–∞–º–∏–Ω E', unit: '%' },
      { key: 'vitamin_k', label: '–í–∏—Ç–∞–º–∏–Ω K', unit: '%' },
      { key: 'vitamin_b1', label: '–í–∏—Ç–∞–º–∏–Ω B1', unit: '%' },
      { key: 'vitamin_b2', label: '–í–∏—Ç–∞–º–∏–Ω B2', unit: '%' },
      { key: 'vitamin_b3', label: '–í–∏—Ç–∞–º–∏–Ω B3', unit: '%' },
      { key: 'vitamin_b6', label: '–í–∏—Ç–∞–º–∏–Ω B6', unit: '%' },
      { key: 'vitamin_b9', label: '–í–∏—Ç–∞–º–∏–Ω B9', unit: '%' },
      { key: 'vitamin_b12', label: '–í–∏—Ç–∞–º–∏–Ω B12', unit: '%' },
      { key: 'calcium', label: '–ö–∞–ª—å—Ü–∏–π', unit: '%' },
      { key: 'iron', label: '–ñ–µ–ª–µ–∑–æ', unit: '%' },
      { key: 'magnesium', label: '–ú–∞–≥–Ω–∏–π', unit: '%' },
      { key: 'phosphorus', label: '–§–æ—Å—Ñ–æ—Ä', unit: '%' },
      { key: 'potassium', label: '–ö–∞–ª–∏–π', unit: '%' },
      { key: 'zinc', label: '–¶–∏–Ω–∫', unit: '%' },
      { key: 'selenium', label: '–°–µ–ª–µ–Ω', unit: '%' },
      { key: 'iodine', label: '–ô–æ–¥', unit: '%' }
    ]), []);

    const formatPreviewValue = useCallback((product, field) => {
      if (!product) return '‚Äî';
      const value = product[field.key];
      if (field.type === 'bool') {
        if (value === true) return '–¥–∞';
        if (value === false) return '–Ω–µ—Ç';
        return '‚Äî';
      }
      if (Array.isArray(value)) {
        return value.length ? value.join(', ') : '‚Äî';
      }
      if (value === null || value === undefined || value === '') return '‚Äî';
      const suffix = field.unit ? ` ${field.unit}` : '';
      return `${value}${suffix}`;
    }, []);

    // –ü–∞—Ä—Å–∏–Ω–≥ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ –∏–∑ heys_core_v12.js)
    const parseProductLine = useCallback((text) => {
      if (!text || !text.trim()) return null;

      // –†–µ–≥—É–ª—è—Ä–∫–∏ –∏–∑ heys_core_v12.js
      const INVIS = /[\u00A0\u1680\u180E\u2000-\u200A\u200B-\u200F\u202F\u205F\u3000\uFEFF]/g;
      const NUM_RE = /[-+]?\d+(?:[\.,]\d+)?/g;

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏
      let clean = text.replace(INVIS, ' ');
      clean = clean.replace(/\u060C/g, ',').replace(/\u066B/g, ',').replace(/\u066C/g, ',').replace(/\u201A/g, ',');
      clean = clean.replace(/\u00B7/g, '.').replace(/[‚Äì‚Äî‚àí]/g, '-').replace(/%/g, '');
      clean = clean.replace(/\t+/g, ' ').replace(/\s+/g, ' ').trim();

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–∞
      const tokens = clean.match(NUM_RE) || [];
      if (!tokens.length) return null;

      // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 —á–∏—Å–µ–ª
      let last = tokens.slice(-12);
      if (last.length < 12) {
        last = Array(12 - last.length).fill('0').concat(last);
      }

      // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–≤–æ–≥–æ —á–∏—Å–ª–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
      const toNum = (x) => {
        if (x === undefined || x === null) return 0;
        const s = String(x).trim().replace(',', '.');
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      };

      // –ü–æ–∏—Å–∫ –ø–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
      let start = 0;
      let firstPos = clean.length;
      for (const tok of last) {
        const idx = clean.indexOf(tok, start);
        if (idx !== -1 && idx < firstPos) {
          firstPos = idx;
          break;
        }
        if (idx !== -1) start = idx + tok.length;
      }

      const name = clean.slice(0, firstPos).trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const nums = last.map(toNum);

      // –ü–æ—Ä—è–¥–æ–∫: kcal, carbs (total), simple, complex, protein, fat (total), bad, good, trans, fiber, gi, harm
      const [kcal, carbs, simple, complex, protein, fat, bad, good, trans, fiber, gi, harm] = nums;

      // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç totals –∏–∑ 12 –ø–æ–ª–µ–π)
      const derivedCarbs = (Number.isFinite(carbs) && carbs > 0) ? carbs : (simple + complex);
      const derivedFat = (Number.isFinite(fat) && fat > 0) ? fat : (bad + good + trans);
      // TEF-aware formula: protein 3 kcal/g (25% TEF), carbs 4 kcal/g, fat 9 kcal/g (Atwater)
      const kcal100 = 3 * protein + 4 * derivedCarbs + 9 * derivedFat;

      return {
        id: Math.random().toString(36).slice(2, 10),
        name,
        simple100: simple,
        complex100: complex,
        protein100: protein,
        badFat100: bad,
        goodFat100: good,
        trans100: trans,
        fiber100: fiber,
        gi: gi,
        harm: harm,  // Canonical harm field
        carbs100: Math.round(derivedCarbs * 10) / 10,
        fat100: Math.round(derivedFat * 10) / 10,
        kcal100: Math.round(kcal100 * 10) / 10,
        createdAt: Date.now()
      };
    }, []);

    // Ref –¥–ª—è onChange —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –ª–∏—à–Ω–∏–µ —Ä–µ—Ä–µ–Ω–¥–µ—Ä—ã
    const onChangeRef = useRef(onChange);
    onChangeRef.current = onChange;

    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ fingerprint –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
    const ensureProductFingerprint = useCallback(async (product) => {
      if (!product || product.fingerprint) return product;
      if (!HEYS.models?.computeProductFingerprint) return product;
      try {
        const fingerprint = await HEYS.models.computeProductFingerprint(product);
        if (!fingerprint) return product;
        return { ...product, fingerprint };
      } catch {
        return product;
      }
    }, []);

    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ ‚Äî –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å (—Å debounce)
    useEffect(() => {
      if (!pasteText.trim()) {
        setParsedPreview(null);
        setError('');
        return;
      }

      // Debounce –ø–∞—Ä—Å–∏–Ω–≥–∞ —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –≤–≤–æ–¥–µ
      const timer = setTimeout(() => {
        const looksLikeAi = /[:=]/.test(pasteText) && /[–∞-—èa-z]/i.test(pasteText);
        const aiParsed = HEYS.models?.parseAIProductString
          ? HEYS.models.parseAIProductString(pasteText, { defaultName: searchQuery || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' })
          : null;

        if (looksLikeAi && aiParsed?.product) {
          if (aiParsed.missingFields?.length) {
            setParsedPreview(null);
            setError('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–ª–µ–π: ' + formatMissingFields(aiParsed.missingFields));
            return;
          }
          setParsedPreview(aiParsed.product);
          setError('');
          onChangeRef.current?.(prev => ({ ...prev, newProduct: aiParsed.product }));
          return;
        }

        const parsed = parseProductLine(pasteText);
        if (parsed) {
          setParsedPreview(parsed);
          setError('');
          onChangeRef.current?.(prev => ({ ...prev, newProduct: parsed }));
        } else if (looksLikeAi) {
          setParsedPreview(null);
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å AI-—Å—Ç—Ä–æ–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å –∫–ª—é—á–∞–º–∏.');
        } else {
          setParsedPreview(null);
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –§–æ—Ä–º–∞—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ + 12 —á–∏—Å–µ–ª.');
        }
      }, 150);

      return () => clearTimeout(timer);
    }, [pasteText, parseProductLine, searchQuery, formatMissingFields]);

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —à–∞–≥ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ (–ë–ï–ó –°–û–•–†–ê–ù–ï–ù–ò–Ø –í –ë–ê–ó–£!)
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –≤ HarmSelectStep
    const handleCreate = useCallback(async () => {
      if (!parsedPreview) return;

      haptic('medium');

      const preparedProduct = await ensureProductFingerprint(parsedPreview);
      if (preparedProduct?.fingerprint && preparedProduct !== parsedPreview) {
        setParsedPreview(preparedProduct);
      }

      console.log('[CreateProductStep] üìù –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ø—Ä–æ–¥—É–∫—Ç:', preparedProduct?.name || parsedPreview.name);
      console.log('[CreateProductStep] ‚è≠Ô∏è –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ –ø–æ—Ä—Ü–∏–π (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ—Å–ª–µ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏)');

      // 1. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ (–ë–ï–ó —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É!)
      onChange({
        ...data,
        newProduct: preparedProduct,
        selectedProduct: preparedProduct,
        grams: 100
      });

      // 4. –¢–ê–ö–ñ–ï –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —à–∞–≥–∞ harm –∏ grams (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É –≤–∏–¥–µ–ª–∏ –ø—Ä–æ–¥—É–∫—Ç)
      if (updateStepData) {
        updateStepData('harm', {
          product: preparedProduct
        });
        updateStepData('grams', {
          selectedProduct: preparedProduct,
          grams: 100
        });
      }

      // 5. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ –ø–æ—Ä—Ü–∏–π (index 2) –ø–µ—Ä–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏
      // –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è state
      if (goToStep) {
        setTimeout(() => goToStep(2, 'left'), 150);
      }
    }, [parsedPreview, data, onChange, context, goToStep, updateStepData, publishToShared, isCurator, ensureProductFingerprint]);

    // –ê–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ fingerprint –¥–ª—è –ø—Ä–µ–≤—å—é (–ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞)
    useEffect(() => {
      let active = true;
      if (!parsedPreview || parsedPreview.fingerprint) return undefined;

      (async () => {
        const updated = await ensureProductFingerprint(parsedPreview);
        if (!active || !updated?.fingerprint || updated.fingerprint === parsedPreview.fingerprint) return;
        setParsedPreview(updated);
        onChangeRef.current?.((prev) => ({ ...prev, newProduct: updated }));
      })();

      return () => {
        active = false;
      };
    }, [parsedPreview, ensureProductFingerprint]);

    const aiPromptText = useMemo(() => {
      const name = searchQuery || '–ù–∞–∑–≤–∞–Ω–∏–µ';
      if (HEYS.models?.generateAIProductStringPrompt) {
        return HEYS.models.generateAIProductStringPrompt(name);
      }
      return CREATE_PRODUCT_AI_PROMPT_FALLBACK.replace('–ù–∞–∑–≤–∞–Ω–∏–µ: X', `–ù–∞–∑–≤–∞–Ω–∏–µ: ${name}`);
    }, [searchQuery]);

    const handleCopyPrompt = useCallback(async () => {
      haptic('light');
      const text = aiPromptText;
      try {
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          HEYS.Toast?.success?.('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
          return;
        }
      } catch (e) {
        // fallback below
      }

      try {
        const temp = document.createElement('textarea');
        temp.value = text;
        temp.setAttribute('readonly', '');
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        HEYS.Toast?.success?.('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
      } catch (e) {
        HEYS.Toast?.warning?.('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç');
      }
    }, [aiPromptText]);

    return React.createElement('div', { className: 'aps-create-step' },
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('div', { className: 'aps-create-header' },
        React.createElement('span', { className: 'aps-create-icon' }, '‚ûï'),
        React.createElement('span', { className: 'aps-create-title' }, '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç')
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø–æ–∏—Å–∫–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
      searchQuery && React.createElement('div', { className: 'aps-create-search-hint' },
        'üîç –í—ã –∏—Å–∫–∞–ª–∏: ',
        React.createElement('strong', null, searchQuery)
      ),

      // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
      React.createElement('div', { className: 'aps-create-hint' },
        '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ (12 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ):',
        React.createElement('br'),
        React.createElement('span', { className: 'aps-create-format' },
          '–ù–∞–∑–≤–∞–Ω–∏–µ: ‚Ä¶\n–ö–∫–∞–ª: ‚Ä¶\n–£–≥–ª–µ–≤–æ–¥—ã: ‚Ä¶\n–ü—Ä–æ—Å—Ç—ã–µ: ‚Ä¶\n–°–ª–æ–∂–Ω—ã–µ: ‚Ä¶\n–ë–µ–ª–æ–∫: ‚Ä¶\n–ñ–∏—Ä—ã: ‚Ä¶\n–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: ‚Ä¶\n–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: ‚Ä¶\n–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: ‚Ä¶\n–ö–ª–µ—Ç—á–∞—Ç–∫–∞: ‚Ä¶\n–ì–ò: ‚Ä¶\n–í—Ä–µ–¥: ‚Ä¶\n+ –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω, –≤–∏—Ç–∞–º–∏–Ω—ã, –º–∏–Ω–µ—Ä–∞–ª—ã (–æ–ø—Ü)'
        )
      ),

      React.createElement('div', { className: 'aps-create-prompt-actions' },
        React.createElement('button', {
          type: 'button',
          className: 'aps-create-prompt-btn',
          onClick: handleCopyPrompt
        }, 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò'),
        React.createElement('span', { className: 'aps-create-prompt-note' }, '–ü–æ–¥ —Ñ–æ—Ä–º–∞—Ç –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã')
      ),

      // Textarea –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
      React.createElement('textarea', {
        ref: textareaRef,
        className: 'aps-create-textarea',
        placeholder: searchQuery
          ? `–ù–∞–∑–≤–∞–Ω–∏–µ: ${searchQuery}\n–ö–∫–∞–ª: 120\n–£–≥–ª–µ–≤–æ–¥—ã: 22\n–ü—Ä–æ—Å—Ç—ã–µ: 2\n–°–ª–æ–∂–Ω—ã–µ: 20\n–ë–µ–ª–æ–∫: 4\n–ñ–∏—Ä—ã: 2\n–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: 0.5\n–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: 1.5\n–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: 0\n–ö–ª–µ—Ç—á–∞—Ç–∫–∞: 3\n–ì–ò: 40\n–í—Ä–µ–¥: 0\n–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 0`
          : '–ù–∞–∑–≤–∞–Ω–∏–µ: –û–≤—Å—è–Ω–∫–∞ –Ω–∞ –≤–æ–¥–µ\n–ö–∫–∞–ª: 120\n–£–≥–ª–µ–≤–æ–¥—ã: 22\n–ü—Ä–æ—Å—Ç—ã–µ: 2\n–°–ª–æ–∂–Ω—ã–µ: 20\n–ë–µ–ª–æ–∫: 4\n–ñ–∏—Ä—ã: 2\n–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: 0.5\n–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: 1.5\n–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: 0\n–ö–ª–µ—Ç—á–∞—Ç–∫–∞: 3\n–ì–ò: 40\n–í—Ä–µ–¥: 0\n–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: 0',
        value: pasteText,
        onChange: (e) => setPasteText(e.target.value),
        rows: 8
      }),

      React.createElement('div', { className: 'aps-create-example-actions' },
        React.createElement('button', {
          type: 'button',
          className: 'aps-create-example-btn',
          onClick: () => setPasteText(CREATE_PRODUCT_AI_EXAMPLE)
        }, 'üß™ –í—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä'),
        React.createElement('span', { className: 'aps-create-example-note' }, '–§–æ—Ä–º–∞—Ç –¥–ª—è –ø–æ–ª—è –≤—Å—Ç–∞–≤–∫–∏')
      ),

      // –û—à–∏–±–∫–∞
      error && React.createElement('div', { className: 'aps-create-error' }, '‚ö†Ô∏è ' + error),

      // –ü—Ä–µ–≤—å—é —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
      parsedPreview && React.createElement('div', { className: 'aps-create-preview' },
        React.createElement('div', { className: 'aps-preview-title' }, '‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:'),
        React.createElement('div', { className: 'aps-preview-name' }, parsedPreview.name),
        // –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã
        React.createElement('div', { className: 'aps-preview-macros' },
          React.createElement('span', { className: 'aps-preview-kcal' }, parsedPreview.kcal100 + ' –∫–∫–∞–ª'),
          React.createElement('span', null, '–ë ' + parsedPreview.protein100 + '–≥'),
          React.createElement('span', null, '–ñ ' + parsedPreview.fat100 + '–≥'),
          React.createElement('span', null, '–£ ' + parsedPreview.carbs100 + '–≥')
        ),
        // –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        React.createElement('div', { className: 'aps-preview-details' },
          PREVIEW_FIELDS.map((field) => React.createElement('div', { className: 'aps-preview-row', key: field.key },
            React.createElement('span', { className: 'aps-preview-label' }, field.label),
            React.createElement('span', { className: 'aps-preview-value' }, formatPreviewValue(parsedPreview, field))
          ))
        )
      ),

      // üåê Checkbox: –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±—â—É—é –±–∞–∑—É
      parsedPreview && React.createElement('label', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          padding: '10px 12px',
          marginTop: '8px',
          background: 'var(--bg-secondary, #f3f4f6)',
          borderRadius: '8px',
          cursor: 'pointer',
          fontSize: '14px'
        }
      },
        React.createElement('input', {
          type: 'checkbox',
          checked: publishToShared,
          onChange: (e) => setPublishToShared(e.target.checked),
          style: { width: '18px', height: '18px', accentColor: '#22c55e' }
        }),
        React.createElement('span', null, 'üåê –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±—â—É—é –±–∞–∑—É'),
        React.createElement('span', {
          style: { fontSize: '11px', color: 'var(--text-muted, #6b7280)', marginLeft: 'auto' }
        }, isCurator ? '—Å—Ä–∞–∑—É –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º' : '–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é')
      ),

      // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å
      React.createElement('button', {
        className: 'aps-create-btn' + (parsedPreview ? ' active' : ''),
        onClick: handleCreate,
        disabled: !parsedPreview
      },
        parsedPreview
          ? '‚úì –î–æ–±–∞–≤–∏—Ç—å ¬´' + parsedPreview.name.slice(0, 20) + (parsedPreview.name.length > 20 ? '...' : '') + '¬ª'
          : '–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞'
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ —Ñ–æ—Ä–º–∞—Ç
      React.createElement('div', { className: 'aps-create-tip' },
        'üí° –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Google Sheets –∏–ª–∏ Excel. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∑–∞–ø—è—Ç—ã–µ –∏ —Ç–æ—á–∫–∏.'
      )
    );
  }

  // === –®–∞–≥ 1: –†–µ–¥–∞–∫—Ç–æ—Ä –±–∞–∑–æ–≤—ã—Ö –ø–æ–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞ ===
  function ProductEditBasicStep({ data, onChange, context, stepData }) {
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { goToStep, updateStepData, closeModal } = stepContext;

    useEscapeToClose(closeModal, true);

    const sourceProduct = context?.editProduct
      || stepData?.edit_extra?.product
      || stepData?.edit_basic?.product
      || stepData?.portions?.product
      || data?.product;

    const initialForm = useMemo(() => {
      const p = sourceProduct || {};
      const simple = toNum(p.simple100, 0);
      const complex = toNum(p.complex100, 0);
      const bad = toNum(p.badFat100 ?? p.badfat100, 0);
      const good = toNum(p.goodFat100 ?? p.goodfat100, 0);
      const trans = toNum(p.trans100, 0);
      const carbs = toNum(p.carbs100 ?? (simple + complex), 0);
      const fat = toNum(p.fat100 ?? (bad + good + trans), 0);
      const protein = toNum(p.protein100, 0);
      const kcal = toNum(p.kcal100 ?? (protein * 3 + carbs * 4 + fat * 9), 0); // NET Atwater
      const harmVal = HEYS.models?.normalizeHarm?.(p) ?? toNum(p.harm, 0);

      return {
        name: p.name || '',
        kcal100: kcal ? String(kcal) : '',
        carbs100: carbs ? String(carbs) : '',
        simple100: simple ? String(simple) : '',
        complex100: complex ? String(complex) : '',
        protein100: protein ? String(protein) : '',
        fat100: fat ? String(fat) : '',
        badFat100: bad ? String(bad) : '',
        goodFat100: good ? String(good) : '',
        trans100: trans ? String(trans) : '',
        fiber100: p.fiber100 ? String(p.fiber100) : '',
        gi: p.gi != null ? String(p.gi) : '',
        harm: harmVal != null ? String(harmVal) : ''
      };
    }, [sourceProduct]);

    const [form, setForm] = useState(initialForm);

    useEffect(() => {
      setForm(initialForm);
    }, [initialForm]);

    const updateField = useCallback((key, value) => {
      setForm((prev) => ({
        ...prev,
        [key]: value
      }));
    }, []);

    const isInvalidNumber = useCallback((value) => {
      if (value == null || value === '') return false;
      const n = Number(String(value).trim().replace(',', '.'));
      return !Number.isFinite(n) || n < 0;
    }, []);

    const computed = useMemo(() => {
      const simple = toNum(form.simple100, 0);
      const complex = toNum(form.complex100, 0);
      const protein = toNum(form.protein100, 0);
      const bad = toNum(form.badFat100, 0);
      const good = toNum(form.goodFat100, 0);
      const trans = toNum(form.trans100, 0);
      const partsCarbs = simple + complex;
      const partsFat = bad + good + trans;
      const carbsTotalInput = toNum(form.carbs100, 0);
      const fatTotalInput = toNum(form.fat100, 0);
      const carbsTotal = carbsTotalInput || partsCarbs;
      const fatTotal = fatTotalInput || partsFat;
      const kcalCalc = Math.round((protein * 3 + carbsTotal * 4 + fatTotal * 9) * 10) / 10; // NET Atwater
      const kcalInput = toNum(form.kcal100, 0);

      const carbsDiff = carbsTotalInput > 0 ? Math.abs(carbsTotalInput - partsCarbs) : 0;
      const fatDiff = fatTotalInput > 0 ? Math.abs(fatTotalInput - partsFat) : 0;
      const kcalDiff = kcalInput > 0 ? Math.abs(kcalInput - kcalCalc) : 0;

      return {
        carbsTotal: Math.round(carbsTotal * 10) / 10,
        fatTotal: Math.round(fatTotal * 10) / 10,
        kcalCalc,
        partsCarbs: Math.round(partsCarbs * 10) / 10,
        partsFat: Math.round(partsFat * 10) / 10,
        carbsDiff,
        fatDiff,
        kcalDiff,
        hasCarbsConflict: carbsDiff > 0.5,
        hasFatConflict: fatDiff > 0.5,
        hasKcalConflict: kcalDiff > 20
      };
    }, [form]);

    const buildUpdatedProduct = useCallback(() => {
      const base = sourceProduct || {};
      const name = String(form.name || base.name || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const simple100 = toNum(form.simple100, 0);
      const complex100 = toNum(form.complex100, 0);
      const protein100 = toNum(form.protein100, 0);
      const badFat100 = toNum(form.badFat100, 0);
      const goodFat100 = toNum(form.goodFat100, 0);
      const trans100 = toNum(form.trans100, 0);
      const fiber100 = toNum(form.fiber100, 0);
      const gi = toNum(form.gi, null);
      const harmInput = form.harm === '' ? null : toNum(form.harm, null);

      const carbsTotal = toNum(form.carbs100, 0);
      const fatTotal = toNum(form.fat100, 0);

      let finalSimple = simple100;
      let finalComplex = complex100;
      if (carbsTotal > 0) {
        if (!finalSimple && !finalComplex) {
          finalSimple = 0;
          finalComplex = carbsTotal;
        } else if (!finalComplex && finalSimple && carbsTotal > finalSimple) {
          finalComplex = Math.max(0, carbsTotal - finalSimple);
        }
      }

      let finalBad = badFat100;
      let finalGood = goodFat100;
      let finalTrans = trans100;
      if (fatTotal > 0) {
        const partsSum = finalBad + finalGood + finalTrans;
        if (!partsSum) {
          finalBad = fatTotal;
          finalGood = 0;
          finalTrans = 0;
        }
      }

      const carbs100 = Math.round((finalSimple + finalComplex) * 10) / 10;
      const fat100 = Math.round((finalBad + finalGood + finalTrans) * 10) / 10;
      // TEF-aware formula: protein*3 + carbs*4 + fat*9 (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å heys_core_v12.js:computeDerived)
      const kcalFromMacros = Math.round((protein100 * 3 + carbs100 * 4 + fat100 * 9) * 10) / 10;
      const kcal100 = form.kcal100 === '' ? kcalFromMacros : toNum(form.kcal100, kcalFromMacros);

      const harm = harmInput != null
        ? harmInput
        : (HEYS.models?.normalizeHarm?.(base) ?? base.harm ?? null);

      return {
        ...base,
        name,
        simple100: finalSimple,
        complex100: finalComplex,
        protein100,
        badFat100: finalBad,
        goodFat100: finalGood,
        trans100: finalTrans,
        fiber100,
        gi,
        harm,
        carbs100,
        fat100,
        kcal100
      };
    }, [form, sourceProduct]);

    const handleNext = useCallback(() => {
      if (!sourceProduct) return;
      haptic('light');
      const updatedProduct = buildUpdatedProduct();
      onChange({ ...data, product: updatedProduct });

      if (updateStepData) {
        updateStepData('edit_basic', { product: updatedProduct });
        updateStepData('edit_extra', { product: updatedProduct });
        updateStepData('portions', { product: updatedProduct });
      }

      setTimeout(() => goToStep?.(1, 'left'), 120);
    }, [sourceProduct, buildUpdatedProduct, onChange, data, updateStepData, goToStep]);

    if (!sourceProduct) {
      return React.createElement('div', { className: 'pe-empty' }, '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    }

    return React.createElement('div', { className: 'pe-step' },
      React.createElement('div', { className: 'pe-step-header' },
        React.createElement('span', { className: 'pe-step-icon' }, '‚úèÔ∏è'),
        React.createElement('span', { className: 'pe-step-title' }, '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ 12 –æ—Å–Ω–æ–≤–Ω—ã—Ö')
      ),

      React.createElement('div', { className: 'pe-field' },
        React.createElement('label', { className: 'pe-label' }, '–ù–∞–∑–≤–∞–Ω–∏–µ'),
        React.createElement('input', {
          className: 'pe-input',
          type: 'text',
          value: form.name,
          onChange: (e) => updateField('name', e.target.value),
          placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞'
        })
      ),

      React.createElement('div', { className: 'pe-grid' },
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ö–∫–∞–ª (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.kcal100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.kcal100,
            onChange: (e) => updateField('kcal100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–£–≥–ª–µ–≤–æ–¥—ã (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.carbs100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.carbs100,
            onChange: (e) => updateField('carbs100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ü—Ä–æ—Å—Ç—ã–µ (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.simple100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.simple100,
            onChange: (e) => updateField('simple100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–°–ª–æ–∂–Ω—ã–µ (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.complex100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.complex100,
            onChange: (e) => updateField('complex100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ë–µ–ª–æ–∫ (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.protein100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.protein100,
            onChange: (e) => updateField('protein100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ñ–∏—Ä—ã (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.fat100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.fat100,
            onChange: (e) => updateField('fat100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.badFat100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.badFat100,
            onChange: (e) => updateField('badFat100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.goodFat100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.goodFat100,
            onChange: (e) => updateField('goodFat100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.trans100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.trans100,
            onChange: (e) => updateField('trans100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (100–≥)'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.fiber100) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.fiber100,
            onChange: (e) => updateField('fiber100', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–ì–ò'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.gi) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.gi,
            onChange: (e) => updateField('gi', e.target.value),
            placeholder: '0'
          })
        ),
        React.createElement('div', { className: 'pe-field' },
          React.createElement('label', { className: 'pe-label' }, '–í—Ä–µ–¥'),
          React.createElement('input', {
            className: 'pe-input' + (isInvalidNumber(form.harm) ? ' pe-input--error' : ''),
            type: 'text',
            inputMode: 'numeric',
            value: form.harm,
            onChange: (e) => updateField('harm', e.target.value),
            placeholder: '0'
          })
        )
      ),

      React.createElement('div', { className: 'pe-preview' },
        React.createElement('span', { className: 'pe-preview-label' }, '–ê–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç:'),
        React.createElement('span', { className: 'pe-preview-value' },
          `–£ ${computed.carbsTotal} ¬∑ –ñ ${computed.fatTotal} ¬∑ ${computed.kcalCalc} –∫–∫–∞–ª`
        )
      ),

      (computed.hasCarbsConflict || computed.hasFatConflict || computed.hasKcalConflict) && React.createElement('div', {
        className: 'pe-warning'
      },
        React.createElement('div', { className: 'pe-warning__title' }, '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è'),
        computed.hasCarbsConflict && React.createElement('div', { className: 'pe-warning__text' },
          `–£–≥–ª–µ–≤–æ–¥—ã: –≤—Å–µ–≥–æ ${form.carbs100 || computed.carbsTotal} ‚â† –ø—Ä–æ—Å—Ç—ã–µ+—Å–ª–æ–∂–Ω—ã–µ ${computed.partsCarbs}`
        ),
        computed.hasFatConflict && React.createElement('div', { className: 'pe-warning__text' },
          `–ñ–∏—Ä—ã: –≤—Å–µ–≥–æ ${form.fat100 || computed.fatTotal} ‚â† –≤—Ä–µ–¥–Ω—ã–µ+–ø–æ–ª–µ–∑–Ω—ã–µ+—Ç—Ä–∞–Ω—Å ${computed.partsFat}`
        ),
        computed.hasKcalConflict && React.createElement('div', { className: 'pe-warning__text' },
          `–ö–∫–∞–ª: –≤–≤–µ–¥–µ–Ω–æ ${form.kcal100 || computed.kcalCalc} ‚â† —Ä–∞—Å—á—ë—Ç ${computed.kcalCalc}`
        )
      ),

      React.createElement('button', {
        className: 'pe-next-btn',
        onClick: handleNext
      }, '–î–∞–ª–µ–µ')
    );
  }

  // === –®–∞–≥ 2: –†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π ===
  function ProductEditExtraStep({ data, onChange, context, stepData }) {
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { goToStep, updateStepData, closeModal } = stepContext;

    useEscapeToClose(closeModal, true);

    const sourceProduct = stepData?.edit_basic?.product
      || context?.editProduct
      || stepData?.edit_extra?.product
      || stepData?.portions?.product
      || data?.product;

    const initialForm = useMemo(() => {
      const p = sourceProduct || {};
      return {
        category: p.category || '',
        description: p.description || '',
        sodium100: p.sodium100 != null ? String(p.sodium100) : '',
        omega3_100: p.omega3_100 != null ? String(p.omega3_100) : '',
        omega6_100: p.omega6_100 != null ? String(p.omega6_100) : '',
        nova_group: p.nova_group ?? p.novaGroup ?? '',
        nutrient_density: p.nutrient_density ?? p.nutrientDensity ?? '',
        additives: Array.isArray(p.additives) ? p.additives.join(', ') : (p.additives || ''),
        is_organic: !!p.is_organic,
        is_whole_grain: !!p.is_whole_grain,
        is_fermented: !!p.is_fermented,
        is_raw: !!p.is_raw,
        vitamin_a: p.vitamin_a != null ? String(p.vitamin_a) : '',
        vitamin_c: p.vitamin_c != null ? String(p.vitamin_c) : '',
        vitamin_d: p.vitamin_d != null ? String(p.vitamin_d) : '',
        vitamin_e: p.vitamin_e != null ? String(p.vitamin_e) : '',
        vitamin_k: p.vitamin_k != null ? String(p.vitamin_k) : '',
        vitamin_b1: p.vitamin_b1 != null ? String(p.vitamin_b1) : '',
        vitamin_b2: p.vitamin_b2 != null ? String(p.vitamin_b2) : '',
        vitamin_b3: p.vitamin_b3 != null ? String(p.vitamin_b3) : '',
        vitamin_b6: p.vitamin_b6 != null ? String(p.vitamin_b6) : '',
        vitamin_b9: p.vitamin_b9 != null ? String(p.vitamin_b9) : '',
        vitamin_b12: p.vitamin_b12 != null ? String(p.vitamin_b12) : '',
        calcium: p.calcium != null ? String(p.calcium) : '',
        iron: p.iron != null ? String(p.iron) : '',
        magnesium: p.magnesium != null ? String(p.magnesium) : '',
        phosphorus: p.phosphorus != null ? String(p.phosphorus) : '',
        potassium: p.potassium != null ? String(p.potassium) : '',
        zinc: p.zinc != null ? String(p.zinc) : '',
        selenium: p.selenium != null ? String(p.selenium) : '',
        iodine: p.iodine != null ? String(p.iodine) : ''
      };
    }, [sourceProduct]);

    const [form, setForm] = useState(initialForm);

    useEffect(() => {
      setForm(initialForm);
    }, [initialForm]);

    const updateField = useCallback((key, value) => {
      setForm((prev) => ({
        ...prev,
        [key]: value
      }));
    }, []);

    const isInvalidNumber = useCallback((value) => {
      if (value == null || value === '') return false;
      const n = Number(String(value).trim().replace(',', '.'));
      return !Number.isFinite(n) || n < 0;
    }, []);

    const buildUpdatedProduct = useCallback(() => {
      const base = sourceProduct || {};
      return {
        ...base,
        category: String(form.category || '').trim() || base.category || '',
        description: String(form.description || '').trim() || base.description || '',
        sodium100: form.sodium100 === '' ? null : toNum(form.sodium100, null),
        omega3_100: form.omega3_100 === '' ? null : toNum(form.omega3_100, null),
        omega6_100: form.omega6_100 === '' ? null : toNum(form.omega6_100, null),
        nova_group: form.nova_group === '' ? null : toInt(form.nova_group, null),
        additives: normalizeAdditives(form.additives),
        nutrient_density: form.nutrient_density === '' ? null : toNum(form.nutrient_density, null),
        is_organic: !!form.is_organic,
        is_whole_grain: !!form.is_whole_grain,
        is_fermented: !!form.is_fermented,
        is_raw: !!form.is_raw,
        vitamin_a: form.vitamin_a === '' ? null : toNum(form.vitamin_a, null),
        vitamin_c: form.vitamin_c === '' ? null : toNum(form.vitamin_c, null),
        vitamin_d: form.vitamin_d === '' ? null : toNum(form.vitamin_d, null),
        vitamin_e: form.vitamin_e === '' ? null : toNum(form.vitamin_e, null),
        vitamin_k: form.vitamin_k === '' ? null : toNum(form.vitamin_k, null),
        vitamin_b1: form.vitamin_b1 === '' ? null : toNum(form.vitamin_b1, null),
        vitamin_b2: form.vitamin_b2 === '' ? null : toNum(form.vitamin_b2, null),
        vitamin_b3: form.vitamin_b3 === '' ? null : toNum(form.vitamin_b3, null),
        vitamin_b6: form.vitamin_b6 === '' ? null : toNum(form.vitamin_b6, null),
        vitamin_b9: form.vitamin_b9 === '' ? null : toNum(form.vitamin_b9, null),
        vitamin_b12: form.vitamin_b12 === '' ? null : toNum(form.vitamin_b12, null),
        calcium: form.calcium === '' ? null : toNum(form.calcium, null),
        iron: form.iron === '' ? null : toNum(form.iron, null),
        magnesium: form.magnesium === '' ? null : toNum(form.magnesium, null),
        phosphorus: form.phosphorus === '' ? null : toNum(form.phosphorus, null),
        potassium: form.potassium === '' ? null : toNum(form.potassium, null),
        zinc: form.zinc === '' ? null : toNum(form.zinc, null),
        selenium: form.selenium === '' ? null : toNum(form.selenium, null),
        iodine: form.iodine === '' ? null : toNum(form.iodine, null)
      };
    }, [form, sourceProduct]);

    const handleNext = useCallback(() => {
      if (!sourceProduct) return;
      haptic('light');
      const updatedProduct = buildUpdatedProduct();
      onChange({ ...data, product: updatedProduct });

      if (updateStepData) {
        updateStepData('edit_extra', { product: updatedProduct });
        updateStepData('portions', { product: updatedProduct });
      }

      setTimeout(() => goToStep?.(2, 'left'), 120);
    }, [sourceProduct, buildUpdatedProduct, onChange, data, updateStepData, goToStep]);

    if (!sourceProduct) {
      return React.createElement('div', { className: 'pe-empty' }, '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    }

    return React.createElement('div', { className: 'pe-step' },
      React.createElement('div', { className: 'pe-step-header' },
        React.createElement('span', { className: 'pe-step-icon' }, 'üß¨'),
        React.createElement('span', { className: 'pe-step-title' }, '–î–æ–ø. –¥–∞–Ω–Ω—ã–µ')
      ),

      React.createElement('div', { className: 'pe-section' },
        React.createElement('div', { className: 'pe-grid' },
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'),
            React.createElement('input', {
              className: 'pe-input',
              type: 'text',
              list: 'pe-category-list',
              value: form.category,
              onChange: (e) => updateField('category', e.target.value),
              placeholder: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'
            }),
            React.createElement('datalist', { id: 'pe-category-list' },
              CATEGORIES.filter(c => c.id !== 'all').map((c) =>
                React.createElement('option', { key: c.id, value: c.name })
              )
            )
          ),
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, '–û–ø–∏—Å–∞–Ω–∏–µ'),
            React.createElement('input', {
              className: 'pe-input',
              value: form.description,
              onChange: (e) => updateField('description', e.target.value),
              placeholder: '–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ'
            })
          )
        )
      ),

      React.createElement('div', { className: 'pe-section' },
        React.createElement('div', { className: 'pe-section-title' }, '–ö–∞—á–µ—Å—Ç–≤–æ'),
        React.createElement('div', { className: 'pe-grid' },
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, '–ù–∞—Ç—Ä–∏–π, –º–≥'),
            React.createElement('input', {
              className: 'pe-input' + (isInvalidNumber(form.sodium100) ? ' pe-input--error' : ''),
              type: 'text',
              inputMode: 'numeric',
              value: form.sodium100,
              onChange: (e) => updateField('sodium100', e.target.value)
            })
          ),
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, 'NOVA'),
            React.createElement('div', { className: 'pe-segment' },
              [1, 2, 3, 4].map((val) =>
                React.createElement('button', {
                  key: val,
                  className: 'pe-segment-btn' + (String(form.nova_group) === String(val) ? ' active' : ''),
                  type: 'button',
                  onClick: () => updateField('nova_group', String(val))
                }, String(val))
              )
            )
          ),
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –Ω—É—Ç—Ä.'),
            React.createElement('input', {
              className: 'pe-input' + (isInvalidNumber(form.nutrient_density) ? ' pe-input--error' : ''),
              type: 'text',
              inputMode: 'numeric',
              value: form.nutrient_density,
              onChange: (e) => updateField('nutrient_density', e.target.value)
            })
          )
        )
      ),

      React.createElement('div', { className: 'pe-section' },
        React.createElement('div', { className: 'pe-section-title' }, '–û–º–µ–≥–∞ –∏ –¥–æ–±–∞–≤–∫–∏'),
        React.createElement('div', { className: 'pe-grid' },
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, 'Œ©-3, –≥'),
            React.createElement('input', {
              className: 'pe-input' + (isInvalidNumber(form.omega3_100) ? ' pe-input--error' : ''),
              type: 'text',
              inputMode: 'numeric',
              value: form.omega3_100,
              onChange: (e) => updateField('omega3_100', e.target.value)
            })
          ),
          React.createElement('div', { className: 'pe-field' },
            React.createElement('label', { className: 'pe-label' }, 'Œ©-6, –≥'),
            React.createElement('input', {
              className: 'pe-input' + (isInvalidNumber(form.omega6_100) ? ' pe-input--error' : ''),
              type: 'text',
              inputMode: 'numeric',
              value: form.omega6_100,
              onChange: (e) => updateField('omega6_100', e.target.value)
            })
          ),
          React.createElement('div', { className: 'pe-field', style: { gridColumn: '1 / -1' } },
            React.createElement('label', { className: 'pe-label' }, 'E-–¥–æ–±–∞–≤–∫–∏'),
            React.createElement('input', {
              className: 'pe-input',
              type: 'text',
              value: form.additives,
              onChange: (e) => updateField('additives', e.target.value),
              placeholder: 'E330, E621'
            })
          )
        )
      ),

      React.createElement('div', { className: 'pe-section' },
        React.createElement('div', { className: 'pe-section-title' }, '–§–ª–∞–≥–∏'),
        React.createElement('div', { className: 'pe-toggles pe-toggles--4col' },
          React.createElement('label', { className: 'pe-toggle' },
            React.createElement('input', {
              type: 'checkbox',
              checked: form.is_organic,
              onChange: (e) => updateField('is_organic', e.target.checked)
            }),
            React.createElement('span', null, 'üåø')
          ),
          React.createElement('label', { className: 'pe-toggle' },
            React.createElement('input', {
              type: 'checkbox',
              checked: form.is_whole_grain,
              onChange: (e) => updateField('is_whole_grain', e.target.checked)
            }),
            React.createElement('span', null, 'üåæ')
          ),
          React.createElement('label', { className: 'pe-toggle' },
            React.createElement('input', {
              type: 'checkbox',
              checked: form.is_fermented,
              onChange: (e) => updateField('is_fermented', e.target.checked)
            }),
            React.createElement('span', null, 'üß¨')
          ),
          React.createElement('label', { className: 'pe-toggle' },
            React.createElement('input', {
              type: 'checkbox',
              checked: form.is_raw,
              onChange: (e) => updateField('is_raw', e.target.checked)
            }),
            React.createElement('span', null, 'ü•¨')
          )
        ),
        React.createElement('div', { className: 'pe-toggles-legend' },
          'üåø –û—Ä–≥–∞–Ω–∏–∫ ¬∑ üåæ –¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω. ¬∑ üß¨ –§–µ—Ä–º–µ–Ω—Ç–∏—Ä. ¬∑ ü•¨ –°—ã—Ä–æ–π'
        )
      ),

      React.createElement('div', { className: 'pe-section' },
        React.createElement('div', { className: 'pe-section-title' }, '–í–∏—Ç–∞–º–∏–Ω—ã (%)'),
        React.createElement('div', { className: 'pe-grid pe-grid--vitamins' },
          [
            { key: 'vitamin_a', label: 'A' },
            { key: 'vitamin_c', label: 'C' },
            { key: 'vitamin_d', label: 'D' },
            { key: 'vitamin_e', label: 'E' },
            { key: 'vitamin_k', label: 'K' },
            { key: 'vitamin_b1', label: 'B1' },
            { key: 'vitamin_b2', label: 'B2' },
            { key: 'vitamin_b3', label: 'B3' },
            { key: 'vitamin_b6', label: 'B6' },
            { key: 'vitamin_b9', label: 'B9' },
            { key: 'vitamin_b12', label: 'B12' }
          ].map((item) =>
            React.createElement('div', { className: 'pe-field pe-field--inline', key: item.key },
              React.createElement('label', { className: 'pe-label' }, item.label),
              React.createElement('input', {
                className: 'pe-input' + (isInvalidNumber(form[item.key]) ? ' pe-input--error' : ''),
                type: 'text',
                inputMode: 'numeric',
                placeholder: '%',
                value: form[item.key],
                onChange: (e) => updateField(item.key, e.target.value)
              })
            )
          )
        )
      ),

      React.createElement('div', { className: 'pe-section' },
        React.createElement('div', { className: 'pe-section-title' }, '–ú–∏–Ω–µ—Ä–∞–ª—ã (%)'),
        React.createElement('div', { className: 'pe-grid pe-grid--minerals' },
          [
            { key: 'calcium', label: 'Ca' },
            { key: 'iron', label: 'Fe' },
            { key: 'magnesium', label: 'Mg' },
            { key: 'phosphorus', label: 'P' },
            { key: 'potassium', label: 'K' },
            { key: 'zinc', label: 'Zn' },
            { key: 'selenium', label: 'Se' },
            { key: 'iodine', label: 'I' }
          ].map((item) =>
            React.createElement('div', { className: 'pe-field pe-field--inline', key: item.key },
              React.createElement('label', { className: 'pe-label' }, item.label),
              React.createElement('input', {
                className: 'pe-input' + (isInvalidNumber(form[item.key]) ? ' pe-input--error' : ''),
                type: 'text',
                inputMode: 'numeric',
                placeholder: '%',
                value: form[item.key],
                onChange: (e) => updateField(item.key, e.target.value)
              })
            )
          )
        )
      ),

      React.createElement('button', {
        className: 'pe-next-btn',
        onClick: handleNext
      }, '–î–∞–ª–µ–µ –∫ –ø–æ—Ä—Ü–∏—è–º')
    );
  }

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ü–∏–π (–®–∞–≥ portions) ===
  function PortionsStep({ data, onChange, context, stepData }) {
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { goToStep, updateStepData, closeModal } = stepContext;

    useEscapeToClose(closeModal, true);

    // –ò—â–µ–º –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    const product = context?.editProduct
      || stepData?.grams?.selectedProduct  // –ü—Ä–æ–¥—É–∫—Ç —Å —à–∞–≥–∞ –≥—Ä–∞–º–º–æ–≤
      || stepData?.search?.selectedProduct // –ü—Ä–æ–¥—É–∫—Ç —Å —à–∞–≥–∞ –ø–æ–∏—Å–∫–∞
      || stepData?.create?.newProduct
      || stepData?.create?.selectedProduct
      || stepData?.portions?.product
      || data?.selectedProduct;

    const autoPortions = useMemo(() => getAutoPortions(product?.name), [product?.name]);

    const toEditablePortions = useCallback((list) => {
      const base = Array.isArray(list) ? list : [];
      return base.map((p) => ({
        name: String(p?.name || ''),
        grams: p?.grams ?? ''
      }));
    }, []);

    const [portions, setPortions] = useState(() => {
      if (product?.portions?.length) return toEditablePortions(product.portions);
      if (autoPortions?.length) return toEditablePortions(autoPortions);
      return [];
    });
    const [error, setError] = useState('');

    useEffect(() => {
      if (!product) return;
      if (portions.length > 0) return;

      if (product?.portions?.length) {
        setPortions(toEditablePortions(product.portions));
        return;
      }

      if (autoPortions?.length) {
        setPortions(toEditablePortions(autoPortions));
      }
    }, [product, autoPortions, portions.length, toEditablePortions]);

    const handleAddPortion = useCallback(() => {
      haptic('light');
      setPortions((prev) => {
        const next = [...prev, { name: '', grams: '' }];
        console.info('[HEYS.portions] ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—Ü–∏—é', {
          productId: product?.id ?? product?.product_id ?? null,
          prevCount: prev.length,
          nextCount: next.length
        });
        return next;
      });
    }, []);

    const handleRemovePortion = useCallback((index) => {
      haptic('light');
      console.info('[HEYS.portions] ‚ûñ –£–¥–∞–ª–∏—Ç—å –ø–æ—Ä—Ü–∏—é', {
        productId: product?.id ?? product?.product_id ?? null,
        index
      });
      setPortions((prev) => prev.filter((_, i) => i !== index));
    }, []);

    const handleUpdatePortion = useCallback((index, field, value) => {
      console.info('[HEYS.portions] ‚úèÔ∏è handleUpdatePortion', { index, field, value });
      setPortions((prev) => {
        const next = prev.map((p, i) => {
          if (i !== index) return p;
          return {
            ...p,
            [field]: value
          };
        });
        console.info('[HEYS.portions] ‚úèÔ∏è portions state updated', { prev, next });
        return next;
      });
    }, []);

    const handleApplyAuto = useCallback(() => {
      if (!autoPortions?.length) return;
      haptic('light');
      setPortions(toEditablePortions(autoPortions));
    }, [autoPortions, toEditablePortions]);

    const handleContinue = useCallback(() => {
      console.info('[HEYS.portions] üîµ handleContinue START', {
        productId: product?.id ?? product?.product_id ?? null,
        productName: product?.name,
        productPortions: product?.portions,
        statePortions: portions,
        isEditMode: !!context?.isEditMode
      });
      if (!product) {
        console.warn('[HEYS.portions] ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—Ü–∏–π');
        return;
      }

      const normalized = normalizePortions(portions);
      if (portions.length > 0 && normalized.length === 0) {
        setError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≥—Ä–∞–º–º—ã –ø–æ—Ä—Ü–∏–∏');
        console.warn('[HEYS.portions] ‚ö†Ô∏è –ü–æ—Ä—Ü–∏–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã', {
          productId: product?.id ?? product?.product_id ?? null,
          rawCount: portions.length
        });
        return;
      }

      setError('');

      console.info('[HEYS.portions] üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ü–∏–π', {
        productId: product?.id ?? product?.product_id ?? null,
        productName: product?.name,
        rawPortions: portions,
        normalizedPortions: normalized,
        normalizedCount: normalized.length,
        isEditMode: !!context?.isEditMode,
        isShared: isSharedProduct(product),
        isCurator: isCuratorUser()
      });

      const updatedProduct = {
        ...product,
        ...(normalized.length > 0 ? { portions: normalized } : {})
      };

      onChange({
        ...data,
        portions: normalized,
        selectedProduct: updatedProduct
      });

      if (updateStepData) {
        updateStepData('portions', {
          product: updatedProduct,
          portions: normalized
        });
        updateStepData('create', {
          ...stepData?.create,
          newProduct: updatedProduct,
          selectedProduct: updatedProduct
        });
        updateStepData('harm', {
          product: updatedProduct
        });
        updateStepData('grams', {
          selectedProduct: updatedProduct,
          grams: stepData?.create?.grams || 100
        });
      }

      if (context?.isEditMode && normalized.length > 0) {
        saveProductPortions(updatedProduct, normalized);
      }

      if (context?.onFinish) {
        console.info('[HEYS.portions] ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —à–∞–≥–∞ –ø–æ—Ä—Ü–∏–π', {
          productId: product?.id ?? product?.product_id ?? null,
          normalizedCount: normalized.length
        });
        context.onFinish({ product: updatedProduct, portions: normalized });
        if (HEYS.StepModal?.hide) {
          HEYS.StepModal.hide();
        }
        return;
      }

      const nextIndex = context?.isEditMode ? 1 : 3;
      setTimeout(() => goToStep?.(nextIndex, 'left'), 150);
    }, [product, portions, onChange, data, updateStepData, stepData, context?.isEditMode, context?.onFinish, goToStep]);

    const handleSkip = useCallback(() => {
      if (!product) return;
      haptic('light');

      if (updateStepData) {
        updateStepData('portions', {
          product,
          portions: []
        });
        updateStepData('harm', {
          product
        });
      }

      if (context?.onFinish) {
        context.onFinish({ product, portions: [] });
        if (HEYS.StepModal?.hide) {
          HEYS.StepModal.hide();
        }
        return;
      }

      const nextIndex = context?.isEditMode ? 1 : 3;
      setTimeout(() => goToStep?.(nextIndex, 'left'), 150);
    }, [product, updateStepData, context?.isEditMode, context?.onFinish, goToStep]);

    if (!product) {
      return React.createElement('div', { className: 'aps-no-product' },
        '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç'
      );
    }

    return React.createElement('div', { className: 'aps-portions-step' },
      React.createElement('div', { className: 'aps-portions-header' },
        React.createElement('span', { className: 'aps-portions-icon' }, 'ü•£'),
        React.createElement('span', { className: 'aps-portions-title' }, '–ü–æ—Ä—Ü–∏–∏')
      ),

      React.createElement('div', { className: 'aps-portions-subtitle' },
        '–£–¥–æ–±–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏ –¥–ª—è ¬´' + product.name + '¬ª'
      ),

      autoPortions?.length > 0 && React.createElement('div', { className: 'aps-portions-suggest' },
        React.createElement('div', { className: 'aps-portions-suggest-title' }, '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ'),
        React.createElement('div', { className: 'aps-portions-suggest-list' },
          autoPortions.map((p, i) =>
            React.createElement('div', { key: i, className: 'aps-portions-suggest-chip' },
              p.name + (String(p.name).includes('–≥') ? '' : ` (${p.grams}–≥)`)
            )
          )
        ),
        React.createElement('button', {
          className: 'aps-portions-apply-btn',
          onClick: handleApplyAuto
        }, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω')
      ),

      React.createElement('div', { className: 'aps-portions-editor' },
        portions.length === 0 && React.createElement('div', { className: 'aps-portions-empty' },
          '–ù–µ—Ç –ø–æ—Ä—Ü–∏–π ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ'
        ),
        portions.map((p, i) =>
          React.createElement('div', { key: i, className: 'aps-portions-row' },
            React.createElement('input', {
              className: 'aps-portions-input aps-portions-input--name',
              placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä: 1 —è–±–ª–æ–∫–æ',
              value: p.name,
              onChange: (e) => handleUpdatePortion(i, 'name', e.target.value)
            }),
            React.createElement('div', { className: 'aps-portions-grams' },
              React.createElement('input', {
                className: 'aps-portions-input aps-portions-input--grams',
                type: 'number',
                inputMode: 'numeric',
                placeholder: '–≥',
                value: p.grams,
                onChange: (e) => handleUpdatePortion(i, 'grams', e.target.value)
              }),
              React.createElement('span', { className: 'aps-portions-grams-unit' }, '–≥')
            ),
            React.createElement('button', {
              className: 'aps-portions-remove-btn',
              onClick: () => handleRemovePortion(i)
            }, '√ó')
          )
        )
      ),

      React.createElement('button', {
        className: 'aps-portions-add-btn',
        onClick: handleAddPortion
      }, '+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—Ü–∏—é'),

      error && React.createElement('div', { className: 'aps-portions-error' }, '‚ö†Ô∏è ' + error),

      React.createElement('div', { className: 'aps-portions-actions' },
        React.createElement('button', {
          className: 'aps-portions-skip-btn',
          onClick: handleSkip
        }, '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'),
        React.createElement('button', {
          className: 'aps-portions-next-btn',
          onClick: handleContinue
        }, context?.isProductEditor ? '–ì–æ—Ç–æ–≤–æ' : (context?.isEditMode ? '–î–∞–ª–µ–µ' : '–î–∞–ª–µ–µ –∫ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏'))
      )
    );
  }

  // –§–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏: 0=–∑–µ–ª—ë–Ω—ã–π(–ø–æ–ª–µ–∑–Ω—ã–π), 5=–≥–æ–ª—É–±–æ–π(—Å—Ä–µ–¥–Ω–∏–π), 10=–∫—Ä–∞—Å–Ω—ã–π(–≤—Ä–µ–¥–Ω—ã–π)
  function getHarmBg(h) {
    if (h == null) return null;
    // h: 0=–ø–æ–ª–µ–∑–Ω—ã–π, 5=—Å—Ä–µ–¥–Ω–∏–π, 10=–≤—Ä–µ–¥–Ω—ã–π
    // –°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ –¥–ª—è —Ö–æ—Ä–æ—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
    if (h <= 1) return '#d1fae5';  // 0-1: —Å–≤–µ—Ç–ª–æ-–º—è—Ç–Ω—ã–π ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π (emerald-100)
    if (h <= 2) return '#d1fae5';  // 2: —Å–≤–µ—Ç–ª–æ-–º—è—Ç–Ω—ã–π
    if (h <= 3) return '#ecfdf5';  // 3: –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –º—è—Ç–Ω—ã–π (emerald-50)
    if (h <= 4) return '#f0fdf4';  // 4: –ø–æ—á—Ç–∏ –±–µ–ª—ã–π —Å –∑–µ–ª–µ–Ω—Ü–æ–π (green-50)
    if (h <= 5) return '#e0f2fe';  // 5: —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π ‚Äî —Å—Ä–µ–¥–Ω–∏–π
    if (h <= 6) return '#f0f9ff';  // 6: –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –≥–æ–ª—É–±–æ–π
    if (h <= 7) return '#fef2f2';  // 7: –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π (red-50)
    if (h <= 8) return '#fee2e2';  // 8: —Å–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π (red-100)
    if (h <= 9) return '#fecaca';  // 9: —Ä–æ–∑–æ–≤—ã–π (red-200)
    return '#fca5a5';              // 10: –∫—Ä–∞—Å–Ω–æ–≤–∞—Ç—ã–π (red-300) ‚Äî –≤—Ä–µ–¥–Ω—ã–π
  }

  // –ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–æ–ø–∏—è –∏–∑ heys_day_v12.js)
  function getCategoryIcon(cat) {
    if (!cat) return 'üçΩÔ∏è';
    const c = cat.toLowerCase();
    if (c.includes('–º–æ–ª–æ—á') || c.includes('—Å—ã—Ä') || c.includes('—Ç–≤–æ—Ä–æ–≥')) return 'ü•õ';
    if (c.includes('–º—è—Å') || c.includes('–ø—Ç–∏—Ü') || c.includes('–∫—É—Ä–∏–Ω') || c.includes('–≥–æ–≤—è') || c.includes('—Å–≤–∏–Ω')) return 'üçñ';
    if (c.includes('—Ä—ã–±') || c.includes('–º–æ—Ä–µ–ø—Ä')) return 'üêü';
    if (c.includes('–æ–≤–æ—â') || c.includes('—Å–∞–ª–∞—Ç') || c.includes('–∑–µ–ª–µ–Ω')) return 'ü•¨';
    if (c.includes('—Ñ—Ä—É–∫—Ç') || c.includes('—è–≥–æ–¥')) return 'üçé';
    if (c.includes('–∫—Ä—É–ø') || c.includes('–∫–∞—à') || c.includes('–∑–ª–∞–∫') || c.includes('—Ö–ª–µ–±') || c.includes('–≤—ã–ø–µ—á')) return 'üåæ';
    if (c.includes('—è–π—Ü')) return 'ü•ö';
    if (c.includes('–æ—Ä–µ—Ö') || c.includes('—Å–µ–º–µ—á')) return 'ü•ú';
    if (c.includes('–º–∞—Å–ª')) return 'ü´í';
    if (c.includes('–Ω–∞–ø–∏—Ç') || c.includes('—Å–æ–∫') || c.includes('–∫–æ—Ñ–µ') || c.includes('—á–∞–π')) return 'ü•§';
    if (c.includes('—Å–ª–∞–¥–∫') || c.includes('–¥–µ—Å–µ—Ä—Ç') || c.includes('–∫–æ–Ω—Ñ–µ—Ç') || c.includes('—à–æ–∫–æ–ª')) return 'üç¨';
    if (c.includes('—Å–æ—É—Å') || c.includes('—Å–ø–µ—Ü–∏') || c.includes('–ø—Ä–∏–ø—Ä–∞')) return 'üßÇ';
    return 'üçΩÔ∏è';
  }

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ Harm Score (–®–∞–≥ harm) ‚Äî –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π UI ===
  function HarmSelectStep({ data, onChange, context, stepData }) {
    const e = React.createElement;

    // –ü—Ä–æ–¥—É–∫—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ create
    const product = stepData?.create?.newProduct
      || stepData?.portions?.product
      || stepData?.harm?.product
      || data?.newProduct
      || data?.product
      || data?.selectedProduct;

    // –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–æ–π harm
    const calculatedBreakdown = useMemo(() => {
      if (!product) return null;
      if (HEYS.Harm?.getHarmBreakdown) {
        return HEYS.Harm.getHarmBreakdown(product);
      }
      return null;
    }, [product]);

    const calculatedHarm = calculatedBreakdown?.score ?? null;

    // –í–≤–µ–¥—ë–Ω–Ω—ã–π –≤—Ä—É—á–Ω—É—é harm (–∏–∑ paste-–¥–∞–Ω–Ω—ã—Ö)
    const manualHarmRef = useRef(null);
    if (manualHarmRef.current == null) {
      manualHarmRef.current = HEYS.models?.normalizeHarm?.(product)
        ?? Number(product?.harm ?? product?.harmScore ?? product?.harmscore ?? product?.harm100 ?? NaN);
    }
    const manualHarm = manualHarmRef.current;
    const hasManualHarm = Number.isFinite(manualHarm);

    // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π harm
    const [selectedHarm, setSelectedHarm] = useState(() => {
      const safeManual = Number.isFinite(manualHarm) ? manualHarm : null;
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–æ–π
      return calculatedHarm ?? safeManual ?? 5;
    });

    // –†–µ–∂–∏–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤–≤–æ–¥–∞
    const [showCustom, setShowCustom] = useState(false);

    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ breakdown
    const [showBreakdown, setShowBreakdown] = useState(true);

    // WheelPicker –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    const WheelPicker = HEYS.StepModal?.WheelPicker;

    // –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±–æ—Ä–∞
    const selectedCategory = useMemo(() => {
      return HEYS.Harm?.getHarmCategory?.(selectedHarm) || { name: '‚Äî', color: '#6b7280', emoji: '‚ùì' };
    }, [selectedHarm]);

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { goToStep, updateStepData } = stepContext;

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
    useEffect(() => {
      if (product && selectedHarm != null) {
        const updatedProduct = {
          ...product,
          harm: selectedHarm,
          harmManual: Number.isFinite(manualHarm) ? manualHarm : product?.harmManual
        };
        onChange({ ...data, selectedHarm, product: updatedProduct });

        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤ create stepData
        if (updateStepData && stepData?.create) {
          updateStepData('create', {
            ...stepData.create,
            newProduct: updatedProduct
          });
        }
      }
    }, [selectedHarm]);

    // –í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç, –°–û–•–†–ê–ù–ò–¢–¨ –ü–†–û–î–£–ö–¢ –∏ –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ
    const selectAndContinue = useCallback((harm) => {
      haptic('light');
      setSelectedHarm(harm);

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º harm
      const updatedProduct = product ? {
        ...product,
        harm,
        harmManual: Number.isFinite(manualHarm) ? manualHarm : product?.harmManual
      } : null;

      if (updatedProduct && updateStepData) {
        updateStepData('create', {
          ...stepData?.create,
          newProduct: updatedProduct,
          selectedProduct: updatedProduct
        });
        updateStepData('grams', {
          selectedProduct: updatedProduct,
          grams: stepData?.create?.grams || 100
        });
      }

      // üîê –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–ê –í –ë–ê–ó–£ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ CreateProductStep)
      if (updatedProduct) {
        const U = HEYS.utils || {};
        const products = HEYS.products?.getAll?.() || U.lsGet?.('heys_products', []) || [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
        const normName = (updatedProduct.name || '').trim().toLowerCase();
        const existingPersonal = products.find(p =>
          (p.name || '').trim().toLowerCase() === normName
        );

        if (!existingPersonal) {
          // üÜï v4.8.0: –£–¥–∞–ª—è–µ–º –∏–∑ –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç–∞ –µ—Å–ª–∏ –±—ã–ª —Ç–∞–º
          if (HEYS.deletedProducts?.remove) {
            HEYS.deletedProducts.remove(updatedProduct.name, updatedProduct.id);
          }

          const newProducts = [...products, updatedProduct];
          if (HEYS.products?.setAll) {
            HEYS.products.setAll(newProducts);
            console.log('[HarmSelectStep] ‚úÖ –°–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±–∞–∑—É —Å harm:', harm, updatedProduct.name);
          } else if (HEYS.store?.set) {
            HEYS.store.set('heys_products', newProducts);
            console.log('[HarmSelectStep] ‚úÖ –°–æ—Ö—Ä–∞–Ω—ë–Ω —á–µ—Ä–µ–∑ store —Å harm:', harm);
          }
        } else {
          console.log('[HarmSelectStep] ‚ö†Ô∏è –ü—Ä–æ–¥—É–∫—Ç —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ:', existingPersonal.name);
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ID
          updatedProduct.id = existingPersonal.id;
          // üÜï –û–±–Ω–æ–≤–ª—è–µ–º updatedAt —á—Ç–æ–±—ã –ø—Ä–æ–¥—É–∫—Ç –ø–æ–¥–Ω—è–ª—Å—è –≤–≤–µ—Ä—Ö –≤ —Å–ø–∏—Å–∫–µ
          const touchedExisting = { ...existingPersonal, updatedAt: Date.now() };
          const touchedProducts = products.map(p => p.id === existingPersonal.id ? touchedExisting : p);
          if (HEYS.products?.setAll) {
            HEYS.products.setAll(touchedProducts);
            console.info('[HarmSelectStep] üîÑ –û–±–Ω–æ–≤–ª—ë–Ω updatedAt —É –ø—Ä–æ–¥—É–∫—Ç–∞:', existingPersonal.name);
          }
        }

        // üîÑ Orphan recovery
        if (HEYS.orphanProducts?.recalculate) {
          HEYS.orphanProducts.recalculate();
        }
        if (HEYS.orphanProducts?.remove && updatedProduct.name) {
          HEYS.orphanProducts.remove(updatedProduct.name);
        }

        // üåê –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ shared (async, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥)
        const publishToShared = stepData?.create?.publishToShared ?? true;
        const isCurator = isCuratorUser();

        if (publishToShared && HEYS.cloud) {
          (async () => {
            try {
              if (HEYS.models?.computeProductFingerprint) {
                const fingerprint = await HEYS.models.computeProductFingerprint(updatedProduct);
                const existing = await HEYS.cloud.searchSharedProducts?.('', { fingerprint, limit: 1 });
                if (existing?.data?.length > 0) {
                  console.log('[HarmSelectStep] üîÑ –ü—Ä–æ–¥—É–∫—Ç —É–∂–µ –≤ shared:', existing.data[0].name);
                  return;
                }
              }

              if (isCurator && HEYS.cloud.publishToShared) {
                const result = await HEYS.cloud.publishToShared(updatedProduct);
                console.log('[HarmSelectStep] ‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ shared:', result);
              } else if (HEYS.cloud.createPendingProduct) {
                const clientId = readGlobalValue('heys_client_current', null);
                if (clientId) {
                  await HEYS.cloud.createPendingProduct(clientId, updatedProduct);
                }
              }
            } catch (err) {
              console.error('[HarmSelectStep] ‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', err);
            }
          })();
        }
      }

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ –≥—Ä–∞–º–º–æ–≤
      setTimeout(() => goToStep?.(4, 'left'), 150);
    }, [product, stepData, updateStepData, goToStep, manualHarm]);

    // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è WheelPicker: 0, 0.5, 1, ... 10
    const wheelValues = useMemo(() => Array.from({ length: 21 }, (_, i) => i * 0.5), []);

    if (!product) {
      return e('div', { className: 'flex items-center justify-center h-40 text-gray-400' },
        '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç'
      );
    }

    return e('div', { className: 'harm-select-step' },
      // –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
      e('div', { className: 'text-center mb-4' },
        e('span', { className: 'text-lg font-medium text-gray-900' }, product.name)
      ),

      // –î–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: Manual vs Calculated
      e('div', { className: 'flex gap-3 mb-4' },
        // –ö–∞—Ä—Ç–æ—á–∫–∞: –í–≤–µ–¥—ë–Ω–Ω–æ–µ –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)
        hasManualHarm && e('button', {
          className: `harm-card ${selectedHarm === manualHarm ? 'selected' : ''}`,
          onClick: () => selectAndContinue(manualHarm),
          style: {
            flex: 1,
            background: selectedHarm === manualHarm ? (HEYS.Harm?.getHarmColor?.(manualHarm) || '#6b7280') + '15' : '#f9fafb',
            border: selectedHarm === manualHarm ? `2px solid ${HEYS.Harm?.getHarmColor?.(manualHarm) || '#6b7280'}` : '2px solid transparent',
            borderRadius: '16px',
            padding: '16px 12px',
            cursor: 'pointer',
            textAlign: 'center',
            transition: 'all 0.2s'
          }
        },
          e('div', { className: 'text-xs text-gray-500 mb-1' }, '‚úèÔ∏è AI'),
          e('div', {
            className: 'text-4xl font-bold mb-1',
            style: { color: HEYS.Harm?.getHarmColor?.(manualHarm) || '#6b7280' }
          }, manualHarm.toFixed(1)),
          e('div', {
            className: 'text-xs font-medium',
            style: { color: HEYS.Harm?.getHarmColor?.(manualHarm) || '#6b7280' }
          }, HEYS.Harm?.getHarmCategory?.(manualHarm)?.emoji || '')
        ),

        // –ö–∞—Ä—Ç–æ—á–∫–∞: –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å–∏—Å—Ç–µ–º–æ–π
        calculatedHarm != null && e('button', {
          className: `harm-card ${selectedHarm === calculatedHarm ? 'selected' : ''}`,
          onClick: () => selectAndContinue(calculatedHarm),
          style: {
            flex: 1,
            background: selectedHarm === calculatedHarm ? (calculatedBreakdown?.category?.color || '#6b7280') + '15' : '#f9fafb',
            border: selectedHarm === calculatedHarm ? `2px solid ${calculatedBreakdown?.category?.color || '#6b7280'}` : '2px solid transparent',
            borderRadius: '16px',
            padding: '16px 12px',
            cursor: 'pointer',
            textAlign: 'center',
            transition: 'all 0.2s'
          }
        },
          e('div', { className: 'text-xs text-gray-500 mb-1' }, 'üß™ –†–∞—Å—á—ë—Ç'),
          e('div', {
            className: 'text-4xl font-bold mb-1',
            style: { color: calculatedBreakdown?.category?.color || '#6b7280' }
          }, calculatedHarm.toFixed(1)),
          e('div', {
            className: 'text-xs font-medium',
            style: { color: calculatedBreakdown?.category?.color || '#6b7280' }
          }, calculatedBreakdown?.category?.emoji || '')
        )
      ),

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è)
      hasManualHarm && calculatedHarm != null && Math.abs(manualHarm - calculatedHarm) >= 0.5 && e('div', {
        className: 'text-center text-xs py-2 px-3 rounded-lg mb-3',
        style: {
          background: Math.abs(manualHarm - calculatedHarm) >= 2 ? '#fef3c7' : '#f3f4f6',
          color: Math.abs(manualHarm - calculatedHarm) >= 2 ? '#92400e' : '#6b7280'
        }
      },
        Math.abs(manualHarm - calculatedHarm) >= 2
          ? `‚ö†Ô∏è –†–∞–∑–Ω–∏—Ü–∞ ${Math.abs(manualHarm - calculatedHarm).toFixed(1)} ‚Äî AI –∏ —Ä–∞—Å—á—ë—Ç —Å–∏–ª—å–Ω–æ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è`
          : `Œî ${Math.abs(manualHarm - calculatedHarm).toFixed(1)} –º–µ–∂–¥—É AI –∏ —Ä–∞—Å—á—ë—Ç–æ–º`
      ),

      // –ö–Ω–æ–ø–∫–∞ "–°–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ"
      e('button', {
        className: 'w-full py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors',
        onClick: () => { setShowCustom(!showCustom); haptic('light'); }
      }, showCustom ? '‚ñº –°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä' : '‚öôÔ∏è –£–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ'),

      // WheelPicker –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
      showCustom && WheelPicker && e('div', { className: 'mt-3 mb-4' },
        e('div', { className: 'flex items-center justify-center gap-4' },
          e('div', { className: 'w-32' },
            e(WheelPicker, {
              values: wheelValues,
              value: selectedHarm,
              onChange: (v) => setSelectedHarm(v),
              height: 140,
              compact: true
            })
          ),
          e('div', { className: 'text-center' },
            e('div', {
              className: 'text-3xl font-bold',
              style: { color: selectedCategory.color }
            }, selectedHarm.toFixed(1)),
            e('div', {
              className: 'text-sm',
              style: { color: selectedCategory.color }
            }, selectedCategory.name)
          )
        ),
        e('button', {
          className: 'w-full mt-3 py-3 rounded-xl font-medium text-white',
          style: { background: selectedCategory.color },
          onClick: () => selectAndContinue(selectedHarm)
        }, '‚úì –í—ã–±—Ä–∞—Ç—å ' + selectedHarm.toFixed(1))
      ),

      // –ö–Ω–æ–ø–∫–∞ "–ö–∞–∫ –ø–æ—Å—á–∏—Ç–∞–Ω–æ?" ‚Äî —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç breakdown
      calculatedBreakdown && e('button', {
        className: 'w-full py-2 mt-2 text-xs text-gray-500 hover:text-gray-700 transition-colors',
        onClick: () => { setShowBreakdown(!showBreakdown); haptic('light'); }
      }, showBreakdown ? '‚ñ≤ –°–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É' : '‚ùì –ö–∞–∫ –ø–æ—Å—á–∏—Ç–∞–Ω–æ?'),

      // Breakdown —Ä–∞—Å—á—ë—Ç–∞
      showBreakdown && calculatedBreakdown && e('div', {
        className: 'mt-3 p-3 bg-gray-50 rounded-xl text-xs space-y-2'
      },
        // –§–æ—Ä–º—É–ª–∞
        e('div', { className: 'text-center text-gray-600 mb-2 font-mono' },
          calculatedBreakdown.formula
        ),
        // –í–µ—Ä—Å–∏—è —Ñ–æ—Ä–º—É–ª—ã
        e('div', { className: 'text-center text-[10px] text-gray-400' },
          `–§–æ—Ä–º—É–ª–∞ v${calculatedBreakdown.version || '3.0'}`
        ),

        // –®—Ç—Ä–∞—Ñ—ã
        calculatedBreakdown.penalties.length > 0 && e('div', null,
          e('div', { className: 'text-red-600 font-medium mb-1' }, 'üî¥ –®—Ç—Ä–∞—Ñ—ã:'),
          calculatedBreakdown.penalties.map((p, i) =>
            e('div', { key: i, className: 'flex justify-between text-gray-600 pl-4' },
              e('span', null, `${p.icon} ${p.label}`),
              e('span', { className: 'text-red-500' }, `+${p.contribution.toFixed(2)}`)
            )
          )
        ),

        // –ë–æ–Ω—É—Å—ã
        calculatedBreakdown.bonuses.length > 0 && e('div', { className: 'mt-2' },
          e('div', { className: 'text-green-600 font-medium mb-1' }, 'üü¢ –ë–æ–Ω—É—Å—ã:'),
          calculatedBreakdown.bonuses.map((b, i) =>
            e('div', { key: i, className: 'flex justify-between text-gray-600 pl-4' },
              e('span', null, `${b.icon} ${b.label}`),
              e('span', { className: 'text-green-500' }, `‚àí${b.contribution.toFixed(2)}`)
            )
          )
        ),

        // NOVA info
        e('div', { className: 'mt-2 text-gray-500 text-center' },
          `NOVA ${calculatedBreakdown.novaGroup}: ${calculatedBreakdown.novaGroup === 4 ? '–£–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π' :
            calculatedBreakdown.novaGroup === 3 ? '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π' :
              calculatedBreakdown.novaGroup === 2 ? '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç' : '–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π'
          }`
        )
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞
      e('div', { className: 'text-center text-xs text-gray-400 mt-4' },
        '0 = —Å—É–ø–µ—Ä–ø–æ–ª–µ–∑–Ω—ã–π ‚Ä¢ 10 = —Å—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–π'
      )
    );
  }

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –≥—Ä–∞–º–º–æ–≤ (–®–∞–≥ 2) ===
  function GramsStep({ data, onChange, context, stepData }) {
    const stepContext = useContext(HEYS.StepModal?.Context || React.createContext({}));
    const { closeModal, goToStep, updateStepData } = stepContext;

    useEscapeToClose(closeModal, true);
    // –ü—Ä–æ–¥—É–∫—Ç –±–µ—Ä—ë–º: 1) –∏–∑ context (–¥–ª—è edit mode), 2) –∏–∑ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö, 3) –∏–∑ create (newProduct –∏–ª–∏ selectedProduct), 4) –∏–∑ search
    // –í–ê–ñ–ù–û: stepData?.create –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç.–∫. –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ data.selectedProduct –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
    const product = context?.editProduct
      || data.selectedProduct
      || stepData?.create?.newProduct
      || stepData?.create?.selectedProduct
      || stepData?.search?.selectedProduct;
    const lastGrams = stepData?.search?.lastGrams || stepData?.create?.lastGrams; // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ
    const grams = data.grams || context?.editGrams || stepData?.create?.grams || stepData?.search?.grams || 100;

    // –†–µ–∂–∏–º –≤–≤–æ–¥–∞: grams –∏–ª–∏ kcal
    const [inputMode, setInputMode] = useState('grams');
    const [kcalInput, setKcalInput] = useState('');
    const gramsInputRef = useRef(null);

    const [favorites, setFavorites] = useState(() =>
      HEYS.store?.getFavorites?.() || new Set()
    );

    const productId = useMemo(() => {
      if (!product) return '';
      return String(product.id ?? product.product_id ?? product.name ?? '');
    }, [product]);

    useEffect(() => {
      if (HEYS.store?.getFavorites) {
        setFavorites(HEYS.store.getFavorites());
      }
    }, [productId]);

    const isFavorite = productId ? favorites.has(productId) : false;
    const isShared = isSharedProduct(product);

    const toggleFavorite = useCallback((e) => {
      e.stopPropagation();
      if (!productId || !HEYS.store?.toggleFavorite) return;
      HEYS.store.toggleFavorite(productId);
      if (HEYS.store?.getFavorites) {
        setFavorites(HEYS.store.getFavorites());
      }
    }, [productId]);

    // –í–ê–ñ–ù–û: –ó–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ —Å fallback –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–æ–≥–¥–∞ product –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    const toNum = (v) => {
      if (v == null || v === '') return 0;
      if (typeof v === 'number') return Number.isFinite(v) ? v : 0;
      const n = Number(String(v).replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    };
    const kcal100 = toNum(product?.kcal100);
    const protein100 = toNum(product?.protein100);
    const carbs100 = toNum(product?.simple100) + toNum(product?.complex100);
    const fat100 = toNum(product?.badFat100) + toNum(product?.goodFat100) + toNum(product?.trans100);
    const derivedKcal100 = kcal100 > 0
      ? kcal100
      : Math.round((3 * protein100 + 4 * carbs100 + 9 * fat100) * 10) / 10;

    // –†–∞—Å—á—ë—Ç –Ω–∞ —Ç–µ–∫—É—â—É—é –ø–æ—Ä—Ü–∏—é (safe with fallbacks)
    const currentKcal = Math.round(derivedKcal100 * grams / 100);
    const currentProt = Math.round(protein100 * grams / 100);
    const currentCarbs = Math.round(carbs100 * grams / 100);
    const currentFat = Math.round(fat100 * grams / 100);

    // === –í–°–ï –•–£–ö–ò –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –î–û –õ–Æ–ë–û–ì–û RETURN ===

    // –ê–≤—Ç–æ-–ø–æ—Ä—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
    const defaultPortions = useMemo(() => {
      if (!product) return [{ name: '100–≥', grams: 100 }];
      if (product.portions && product.portions.length) {
        return product.portions;
      }
      // –ê–≤—Ç–æ-–ø–æ—Ä—Ü–∏–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ø–µ—Ä–µ–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É, –Ω–µ –æ–±—ä–µ–∫—Ç!)
      return HEYS.models?.getAutoPortions?.(product.name) || [
        { name: '50–≥', grams: 50 },
        { name: '100–≥', grams: 100 },
        { name: '150–≥', grams: 150 },
        { name: '200–≥', grams: 200 }
      ];
    }, [product]);

    const [localPortions, setLocalPortions] = useState(defaultPortions);

    useEffect(() => {
      setLocalPortions(defaultPortions);
    }, [defaultPortions]);

    useEffect(() => {
      const handleProductUpdated = (event) => {
        const detail = event?.detail || {};
        const updatedProduct = detail.product;
        const updatedId = String(detail.productId ?? updatedProduct?.id ?? updatedProduct?.product_id ?? updatedProduct?.name);
        const updatedSharedId = String(detail.sharedId ?? updatedProduct?.shared_origin_id ?? updatedProduct?.sharedId ?? updatedProduct?._sharedId ?? '');

        const currentId = String(product?.id ?? product?.product_id ?? product?.name);
        const currentSharedId = String(resolveSharedProductId(product) ?? '');

        const isDirectMatch = !!updatedId && updatedId === currentId;
        const isSharedMatch = !!updatedSharedId && !!currentSharedId && updatedSharedId === currentSharedId;
        if (!isDirectMatch && !isSharedMatch) return;

        console.info('[HEYS.portions] üîÑ GramsStep update', {
          event: event?.type,
          match: isSharedMatch ? 'shared' : 'direct',
          updatedId,
          updatedSharedId: updatedSharedId || null,
          currentId,
          currentSharedId: currentSharedId || null
        });

        const nextPortions = Array.isArray(detail.portions)
          ? detail.portions
          : (updatedProduct?.portions || []);

        setLocalPortions(nextPortions);
        if (updatedProduct) {
          const mergedProduct = {
            ...product,
            ...updatedProduct,
            portions: nextPortions
          };

          if (isSharedMatch) {
            mergedProduct.shared_origin_id = resolveSharedProductId(product) || updatedProduct?.shared_origin_id || updatedProduct?.sharedId || mergedProduct.shared_origin_id;
            if (product?.id != null) {
              mergedProduct.id = product.id;
            }
          }

          onChange({ ...data, selectedProduct: mergedProduct });
        }
      };

      window.addEventListener('heys:product-portions-updated', handleProductUpdated);
      window.addEventListener('heys:product-updated', handleProductUpdated);
      return () => {
        window.removeEventListener('heys:product-portions-updated', handleProductUpdated);
        window.removeEventListener('heys:product-updated', handleProductUpdated);
      };
    }, [product, data, onChange]);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞–º–º–æ–≤
    const setGrams = useCallback((newGrams) => {
      const val = Math.max(1, Math.min(2000, Number(newGrams) || 100));
      // Debug: log only if value doesn't change as expected
      if (data?.grams && data.grams !== val && Math.abs(data.grams - val) > 1) {
        console.warn('[GramsStep] ‚ö†Ô∏è Unexpected grams change:', { from: data.grams, to: val, input: newGrams });
      }
      onChange({ ...data, grams: val });
    }, [data, onChange]);

    // –†–∞—Å—á—ë—Ç –≥—Ä–∞–º–º–æ–≤ –∏–∑ –∫–∫–∞–ª
    const setKcalAndCalcGrams = useCallback((kcalStr) => {
      setKcalInput(kcalStr);
      const kcal = Number(kcalStr) || 0;
      if (kcal > 0 && kcal100 > 0) {
        const calcGrams = Math.round(kcal / kcal100 * 100);
        const val = Math.max(1, Math.min(2000, calcGrams));
        onChange({ ...data, grams: val });
      }
    }, [data, onChange, kcal100]);

    const handleSubmit = useCallback(() => {
      if (!product || grams <= 0) {
        console.warn('[HEYS.addProduct] ‚ö†Ô∏è GramsStep submit blocked', {
          hasProduct: !!product,
          grams,
          mealIndex: context?.mealIndex ?? null,
          productName: product?.name || null
        });
        return;
      }
      console.info('[HEYS.addProduct] üü¢ GramsStep submit', {
        grams,
        mealIndex: context?.mealIndex ?? null,
        productId: product?.id ?? product?.product_id ?? null,
        productName: product?.name || null
      });
      // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –≤—ã–∑—ã–≤–∞–µ–º onSave
      if (context?.isEditMode && context?.onSave) {
        context.onSave({
          mealIndex: context.mealIndex,
          itemId: context.itemId,
          grams
        });
      }
      // –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ‚Äî –≤—ã–∑—ã–≤–∞–µ–º onAdd
      else if (context?.onAdd) {
        if (grams !== data?.grams && data?.grams && data.grams !== 100) {
          console.warn('[GramsStep] ‚ö†Ô∏è grams mismatch on submit:', { final: grams, dataGrams: data.grams });
        }
        const hasNutrients = !!(product?.kcal100 || product?.protein100 || product?.carbs100);
        if (!hasNutrients) {
          console.error('üö® [GramsStep] CRITICAL: Sending product with NO nutrients!', {
            product,
            stepData,
            contextEditProduct: context?.editProduct,
            dataSelectedProduct: data?.selectedProduct
          });
        }

        const productForSubmit = (!product?.kcal100 && derivedKcal100 > 0)
          ? { ...product, kcal100: derivedKcal100 }
          : product;

        console.info('[HEYS.addProduct] ‚ûï GramsStep onAdd', {
          grams,
          mealIndex: context?.mealIndex ?? null,
          productId: productForSubmit?.id ?? productForSubmit?.product_id ?? null,
          productName: productForSubmit?.name || null
        });
        context.onAdd({
          product: productForSubmit,
          grams,
          mealIndex: context.mealIndex
        });

        window.dispatchEvent(new CustomEvent('heysProductAdded', {
          detail: { product: productForSubmit, grams }
        }));
      }

      if (HEYS.StepModal?.hide) {
        if (!context?.multiProductMode) {
          HEYS.StepModal.hide({ scrollToDiary: true });
          return;
        }

        const continueAdding = () => {
          updateStepData?.('search', {
            ...stepData?.search,
            selectedProduct: null,
            grams,
            lastGrams: grams
          });
          updateStepData?.('grams', {
            ...stepData?.grams,
            selectedProduct: null,
            grams
          });
          setTimeout(() => {
            goToStep?.(0, 'right');
          }, 0);
        };

        const finishMeal = () => {
          HEYS.StepModal.hide({ scrollToDiary: true });
        };

        // üÜï –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π summary-—Ö–µ–ª–ø–µ—Ä –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        const summaryShow = HEYS.dayAddProductSummary?.show;
        if (typeof summaryShow === 'function') {
          let addMoreChosen = false;
          const dayUtils = HEYS.dayUtils || {};
          const getProductFromItem = dayUtils.getProductFromItem || (() => null);
          const per100 = dayUtils.per100 || (() => ({
            kcal100: 0, carbs100: 0, prot100: 0, fat100: 0,
            simple100: 0, complex100: 0, bad100: 0, good100: 0,
            trans100: 0, fiber100: 0
          }));
          const scale = dayUtils.scale || ((v, g) => Math.round(((+v || 0) * (+g || 0) / 100) * 10) / 10);
          const currentDay = HEYS.Day?.getDay?.() || context?.day || {};
          const pIndex = dayUtils.buildProductIndex?.() || HEYS.products?.buildIndex?.() || {};

          Promise.resolve(summaryShow({
            day: currentDay,
            mealIndex: context?.mealIndex ?? 0,
            pIndex,
            getProductFromItem,
            per100,
            scale,
            onAddMore: () => {
              addMoreChosen = true;
              continueAdding();
            }
          })).then(() => {
            if (!addMoreChosen) finishMeal();
          });
          return;
        }

        // Fallback: —Å—Ç–∞—Ä—ã–π ConfirmModal
        if (HEYS.ConfirmModal?.show) {
          const mealName = (context?.day?.meals?.[context?.mealIndex]?.name || '–ø—Ä–∏—ë–º').toLowerCase();
          Promise.resolve(HEYS.ConfirmModal.show({
            icon: 'üçΩÔ∏è',
            title: `–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –≤ ${mealName}?`,
            text: '–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏—ë–º.',
            confirmText: '–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë',
            cancelText: '–ó–∞–≤–µ—Ä—à–∏—Ç—å',
            confirmStyle: 'success',
            cancelStyle: 'primary',
            confirmVariant: 'fill',
            cancelVariant: 'fill'
          })).then((result) => {
            if (result) continueAdding();
            else finishMeal();
          });
        } else {
          continueAdding();
        }
      }
    }, [product, grams, context, data, stepData]);

    // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∫–∫–∞–ª –∑–∞ –¥–µ–Ω—å
    const { dateKey, mealIndex } = context || {};
    const dayTotalKcal = useMemo(() => {
      const dayData = lsGet(`heys_dayv2_${dateKey}`, {});
      let total = 0;
      (dayData.meals || []).forEach(m => {
        (m.items || []).forEach(it => {
          const g = it.grams || 100;
          const pid = it.product_id || it.name;
          const prod = (context?.products || []).find(p => (p.id || p.name) === pid);
          if (prod) total += (prod.kcal100 || 0) * g / 100;
        });
      });
      return Math.round(total);
    }, [dateKey, context?.products]);

    // –ù–æ—Ä–º–∞ –∫–∫–∞–ª –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    const dailyGoal = useMemo(() => {
      const profile = lsGet('heys_profile', {});
      return profile.optimum || profile.tdee || 1800;
    }, []);

    // === –¢–ï–ü–ï–†–¨ –ú–û–ñ–ù–û –î–ï–õ–ê–¢–¨ EARLY RETURN ===
    if (!product) {
      return React.createElement('div', { className: 'aps-no-product' },
        '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç'
      );
    }

    // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Ä—Ü–∏–π
    const quickPortions = [50, 100, 150, 200, 300];

    // –§–æ–Ω —Ö–µ–¥–µ—Ä–∞ –ø–æ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏
    const harmVal = product.harm ?? product.harmScore ?? product.harm100;
    const harmBg = getHarmBg(harmVal);

    return React.createElement('div', { className: 'aps-grams-step' },
      // –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
      React.createElement('div', {
        className: 'aps-product-header',
        style: harmBg ? { background: harmBg, borderColor: harmBg } : undefined
      },
        React.createElement('div', { className: 'aps-product-header__main' },
          product.category && React.createElement('span', { className: 'aps-product-icon-lg' },
            getCategoryIcon(product.category)
          ),
          React.createElement('div', { className: 'aps-product-title' }, product.name)
        ),
        !isShared && React.createElement('button', {
          className: 'aps-fav-btn aps-product-header__fav' + (isFavorite ? ' active' : ''),
          onClick: toggleFavorite,
          title: isFavorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'
        }, isFavorite ? '‚òÖ' : '‚òÜ')
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥—Ä–∞–º–º—ã
      lastGrams && React.createElement('div', { className: 'aps-last-grams-hint' },
        React.createElement('span', null, '–í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑: '),
        React.createElement('button', {
          className: 'aps-last-grams-btn',
          onClick: () => setGrams(lastGrams)
        }, lastGrams + '–≥')
      ),

      // === HERO: –ë–æ–ª—å—à–æ–π input (–≥—Ä–∞–º–º—ã –∏–ª–∏ –∫–∫–∞–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞) ===
      React.createElement('div', { className: 'aps-grams-hero' },
        React.createElement('button', {
          className: 'aps-grams-hero-btn',
          onClick: () => inputMode === 'grams'
            ? setGrams(grams - 10)
            : setKcalAndCalcGrams(Math.max(10, (Number(kcalInput) || 0) - 10))
        }, '‚àí'),
        React.createElement('div', { className: 'aps-grams-hero-field' },
          React.createElement('input', {
            ref: gramsInputRef,
            type: 'number',
            className: 'aps-grams-hero-input',
            value: inputMode === 'grams' ? grams : kcalInput,
            onChange: (e) => inputMode === 'grams'
              ? setGrams(e.target.value)
              : setKcalAndCalcGrams(e.target.value),
            onKeyDown: (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                handleSubmit();
              }
            },
            onFocus: (e) => e.target.select(),
            onClick: (e) => e.target.select(),
            inputMode: 'numeric',
            min: 1,
            max: inputMode === 'grams' ? 2000 : 5000
          })
        ),
        React.createElement('button', {
          className: 'aps-grams-hero-btn',
          onClick: () => inputMode === 'grams'
            ? setGrams(grams + 10)
            : setKcalAndCalcGrams((Number(kcalInput) || 0) + 10)
        }, '+')
      ),

      // –ü–æ–¥–ø–∏—Å—å –ø–æ–¥ –∏–Ω–ø—É—Ç–æ–º (–≥—Ä–∞–º–º / –∫–∫–∞–ª)
      React.createElement('div', { className: 'aps-grams-hero-label' },
        inputMode === 'grams' ? '–≥—Ä–∞–º–º' : '–∫–∫–∞–ª'
      ),

      // –í—Ç–æ—Ä–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∫–∞–ª–æ—Ä–∏–∏ –∏–ª–∏ –≥—Ä–∞–º–º—ã)
      React.createElement('div', { className: 'aps-kcal-secondary' },
        React.createElement('span', { className: 'aps-kcal-secondary-value' },
          inputMode === 'grams' ? (currentKcal + ' –∫–∫–∞–ª') : ('= ' + grams + '–≥')
        )
      ),

      // –ë–ñ–£
      React.createElement('div', { className: 'aps-macros' },
        React.createElement('div', { className: 'aps-macro' },
          React.createElement('span', { className: 'aps-macro-label' }, '–ë'),
          React.createElement('span', { className: 'aps-macro-value' }, currentProt + '–≥')
        ),
        React.createElement('div', { className: 'aps-macro' },
          React.createElement('span', { className: 'aps-macro-label' }, '–ñ'),
          React.createElement('span', { className: 'aps-macro-value' }, currentFat + '–≥')
        ),
        React.createElement('div', { className: 'aps-macro' },
          React.createElement('span', { className: 'aps-macro-label' }, '–£'),
          React.createElement('span', { className: 'aps-macro-value' }, currentCarbs + '–≥')
        )
      ),

      // === –ë–û–õ–¨–®–ê–Ø –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–ò–¢–¨/–ò–ó–ú–ï–ù–ò–¢–¨ ===
      React.createElement('button', {
        className: 'aps-add-hero-btn',
        onClick: handleSubmit,
        style: {
          display: 'block',
          width: '100%',
          padding: '16px',
          marginTop: '16px',
          marginBottom: '16px',
          fontSize: '18px',
          fontWeight: '600',
          color: '#fff',
          background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
          border: 'none',
          borderRadius: '12px',
          boxShadow: '0 4px 14px rgba(34, 197, 94, 0.4)',
          cursor: 'pointer'
        }
      }, context?.isEditMode ? '‚úì –ò–∑–º–µ–Ω–∏—Ç—å' : '‚úì –î–æ–±–∞–≤–∏—Ç—å'),

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞: –≥—Ä–∞–º–º—ã / –∫–∫–∞–ª
      React.createElement('div', { className: 'aps-input-mode-toggle' },
        React.createElement('button', {
          className: 'aps-mode-btn' + (inputMode === 'grams' ? ' active' : ''),
          onClick: () => setInputMode('grams')
        }, '‚öñÔ∏è –ì—Ä–∞–º–º—ã'),
        React.createElement('button', {
          className: 'aps-mode-btn' + (inputMode === 'kcal' ? ' active' : ''),
          onClick: () => setInputMode('kcal')
        }, 'üî• –ö–∫–∞–ª')
      ),

      // –°–ª–∞–π–¥–µ—Ä (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –≥—Ä–∞–º–º–æ–≤)
      inputMode === 'grams' && React.createElement('input', {
        type: 'range',
        className: 'aps-grams-slider',
        min: 10,
        max: 500,
        step: 5,
        value: Math.min(500, grams),
        onChange: (e) => setGrams(Number(e.target.value)),
        onTouchStart: (e) => e.stopPropagation(),
        onTouchEnd: (e) => e.stopPropagation(),
        onTouchMove: (e) => e.stopPropagation()
      }),

      // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
      React.createElement('div', { className: 'aps-quick-grams' },
        quickPortions.map(g =>
          React.createElement('button', {
            key: g,
            className: 'aps-quick-btn' + (grams === g ? ' active' : ''),
            onClick: () => setGrams(g)
          }, g + '–≥')
        )
      ),

      // –ü–æ—Ä—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
      localPortions?.length > 0 && React.createElement('div', { className: 'aps-portions' },
        React.createElement('div', { className: 'aps-portions-title' }, '–ü–æ—Ä—Ü–∏–∏:'),
        React.createElement('div', { className: 'aps-portions-list' },
          localPortions.map((p, i) =>
            React.createElement('button', {
              key: i,
              className: 'aps-portion-btn' + (grams === p.grams ? ' active' : ''),
              onClick: () => setGrams(p.grams)
            }, p.name + (p.name.includes('–≥') ? '' : ` (${p.grams}–≥)`))
          )
        )
      ),

      // –ò—Ç–æ–≥ –¥–Ω—è: +–∫–∫–∞–ª ‚Üí –≤—Å–µ–≥–æ/–Ω–æ—Ä–º–∞ (%)
      React.createElement('div', { className: 'aps-day-total' },
        React.createElement('span', { className: 'aps-day-plus' }, '+' + currentKcal + ' –∫–∫–∞–ª'),
        React.createElement('span', { className: 'aps-day-arrow' }, ' ‚Üí '),
        React.createElement('span', { className: 'aps-day-sum' },
          (dayTotalKcal + currentKcal) + '/' + dailyGoal
        ),
        React.createElement('span', { className: 'aps-day-pct' },
          ' (' + Math.round((dayTotalKcal + currentKcal) / dailyGoal * 100) + '%)'
        )
      )
    );
  }

  // === –ü–æ–ª–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞ (3 —à–∞–≥–∞) ===
  function showEditProductModal(productOrOptions = {}, maybeOptions = {}) {
    let product = productOrOptions;
    let options = maybeOptions;

    if (productOrOptions && typeof productOrOptions === 'object' && productOrOptions.product) {
      options = productOrOptions;
      product = productOrOptions.product;
    }

    const { initialStep = 0, onSave, onClose } = options || {};

    if (!product) {
      HEYS.Toast?.warning('–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω') || alert('–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    if (!HEYS.StepModal?.show) {
      HEYS.Toast?.warning('–ú–æ–¥–∞–ª–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') || alert('–ú–æ–¥–∞–ª–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      return;
    }

    if (!canEditProduct(product)) {
      HEYS.Toast?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é') || alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
      return;
    }

    HEYS.StepModal.show({
      steps: [
        {
          id: 'edit_basic',
          title: '–û—Å–Ω–æ–≤–Ω—ã–µ',
          hint: '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ 12 –ø–æ–ª–µ–π',
          icon: '‚úèÔ∏è',
          component: ProductEditBasicStep,
          validate: () => true,
          hideHeaderNext: true,
          getInitialData: () => ({ product })
        },
        {
          id: 'edit_extra',
          title: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ',
          hint: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è',
          icon: 'üß¨',
          component: ProductEditExtraStep,
          validate: () => true,
          hideHeaderNext: true
        },
        {
          id: 'portions',
          title: '–ü–æ—Ä—Ü–∏–∏',
          hint: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä—Ü–∏–∏',
          icon: 'ü•£',
          component: PortionsStep,
          validate: () => true,
          hideHeaderNext: true
        }
      ],
      context: {
        isEditMode: true,
        isProductEditor: true,
        editProduct: product,
        onFinish: async ({ product: updatedProduct, portions }) => {
          const finalProduct = {
            ...product,
            ...(updatedProduct || {})
          };

          if (Array.isArray(portions)) {
            finalProduct.portions = portions;
          }

          // v4.8.0: Track if name changed for UX feedback
          const nameChanged = product.name !== finalProduct.name;
          const portionsChanged =
            JSON.stringify(normalizePortions(product.portions || [])) !==
            JSON.stringify(normalizePortions(finalProduct.portions || []));
          const otherChanged =
            nameChanged ||
            hasNutrientChanges(product, finalProduct) ||
            (product.category || '') !== (finalProduct.category || '') ||
            (product.description || '') !== (finalProduct.description || '');

          const sharedId = resolveSharedProductId(finalProduct);

          if (isCuratorUser() && sharedId && portionsChanged && !otherChanged) {
            const result = await updateSharedProductPortions(sharedId, finalProduct.portions || [], finalProduct);
            if (result.ok) {
              upsertLocalProduct(finalProduct, false);
              notifyProductUpdated(finalProduct);
              if (nameChanged) {
                HEYS.Toast?.info?.('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –ø—Ä–∏—ë–º–∞—Ö') ||
                  console.log('[HEYS] Product renamed, cascaded to meals');
              }
            }
            onSave?.(finalProduct);
            return;
          }

          if (isSharedProduct(product)) {
            if (isCuratorUser()) {
              const result = await updateSharedProduct(finalProduct);
              if (result.ok) {
                upsertLocalProduct(finalProduct, false);
                notifyProductUpdated(finalProduct);
                // v4.8.0: Show cascade notification for shared products
                if (nameChanged) {
                  HEYS.Toast?.info?.('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –ø—Ä–∏—ë–º–∞—Ö') ||
                    console.log('[HEYS] Product renamed, cascaded to meals');
                }
              }
            } else {
              upsertLocalProduct(finalProduct, true);
              notifyProductUpdated(finalProduct);
              if (nameChanged) {
                HEYS.Toast?.info?.('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –ø—Ä–∏—ë–º–∞—Ö') ||
                  console.log('[HEYS] Product renamed, cascaded to meals');
              }
            }
          } else {
            saveLocalProduct(finalProduct);
            notifyProductUpdated(finalProduct);
            // v4.8.0: Show cascade notification for local products
            if (nameChanged) {
              HEYS.Toast?.info?.('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –ø—Ä–∏—ë–º–∞—Ö') ||
                console.log('[HEYS] Product renamed, cascaded to meals');
            }
          }

          onSave?.(finalProduct);
        }
      },
      initialStep,
      showGreeting: false,
      showStreak: false,
      showTip: false,
      showProgress: true,
      allowSwipe: false,
      hidePrimaryOnFirst: true,
      finishLabel: '–ì–æ—Ç–æ–≤–æ',
      title: '',
      onClose
    });
  }

  // === –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ ===
  function showAddProductModal(options = {}) {
    const {
      mealIndex = 0,
      products: providedProducts,
      day,
      dateKey = new Date().toISOString().slice(0, 10),
      multiProductMode = false,
      initialSearch = '', // üÜï –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ (MealRec UX fix)
      initialGrams = 100, // üÜï v24: Smart Grams Pre-fill (R6, Sprint 1)
      onAdd,
      onAddPhoto, // Callback –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –∫ –ø—Ä–∏—ë–º—É
      onNewProduct,
      onClose
    } = options;

    // –í—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (providedProducts –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º)
    const U = HEYS.utils || {};

    // –ë–µ—Ä—ë–º –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–µ–ø—É—Å—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å fallback chain
    const fromHeysProducts = HEYS.products?.getAll?.() || [];
    const fromStore = HEYS.store?.get?.('heys_products', []) || [];
    const fromLsGet = U.lsGet?.('heys_products', []) || [];

    let products = [];
    if (fromHeysProducts.length > 0) {
      products = fromHeysProducts;
    } else if (fromStore.length > 0) {
      products = fromStore;
    } else if (fromLsGet.length > 0) {
      products = fromLsGet;
    }

    console.info('[HEYS.addProduct] üì¶ Open modal', {
      mealIndex,
      dateKey,
      productsCount: products.length,
      hasProvidedProducts: Array.isArray(providedProducts) && providedProducts.length > 0,
      // üÜï v24: Sprint 1 verification ‚Äî show initialGrams from MealRec
      initialSearch: initialSearch || '(none)',
      initialGrams: initialGrams,
      usingMLGrams: initialGrams !== 100
    });

    const handleModalClose = () => {
      onClose?.();
    };

    // Mutable ref –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
    let currentProducts = [...products];

    if (!HEYS.StepModal) {
      console.error('[AddProductStep] StepModal not loaded');
      return;
    }

    HEYS.StepModal.show({
      steps: [
        {
          id: 'search',
          title: '',
          hint: '',
          icon: '',
          component: ProductSearchStep,
          getInitialData: () => ({
            selectedProduct: null,
            grams: initialGrams,
            _mlGrams: initialGrams !== 100 ? initialGrams : null, // v25.3: separate ML grams flag
            searchQuery: initialSearch
          }),
          validate: (data) => !!data?.selectedProduct
        },
        {
          id: 'create',
          title: '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç',
          hint: '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É —Å –º–∞–∫—Ä–æ—Å–∞–º–∏',
          icon: '‚ûï',
          component: CreateProductStep,
          validate: () => true,
          hidden: true, // –°–∫—Ä—ã—Ç—ã–π —à–∞–≥ ‚Äî –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ progress dots
          hideHeaderNext: true // –°–∫—Ä—ã–≤–∞–µ–º "–î–∞–ª–µ–µ" ‚Äî –µ—Å—Ç—å —Å–≤–æ—è –∫–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å"
        },
        {
          id: 'portions',
          title: '–ü–æ—Ä—Ü–∏–∏',
          hint: '–î–æ–±–∞–≤—å—Ç–µ —É–¥–æ–±–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏',
          icon: 'ü•£',
          component: PortionsStep,
          validate: () => true,
          hidden: true,
          hideHeaderNext: true
        },
        {
          id: 'harm',
          title: '–í—Ä–µ–¥–Ω–æ—Å—Ç—å',
          hint: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ',
          icon: 'üß™',
          component: HarmSelectStep,
          validate: () => true,
          hidden: true, // –°–∫—Ä—ã—Ç—ã–π —à–∞–≥ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
          hideHeaderNext: true // –ï—Å—Ç—å —Å–≤–æ—è –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞
        },
        {
          id: 'grams',
          title: '',
          hint: '',
          icon: '‚öñÔ∏è',
          component: GramsStep,
          validate: (data, stepData) => (data?.grams || stepData?.search?.grams || 0) > 0,
          hideHeaderNext: true // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ö–µ–¥–µ—Ä–µ ‚Äî –µ—Å—Ç—å –±–æ–ª—å—à–∞—è –∑–µ–ª—ë–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É
        }
      ],
      context: {
        products: currentProducts,
        day,
        dateKey,
        mealIndex,
        multiProductMode,
        onNewProduct,
        onAdd, // –ü–µ—Ä–µ–¥–∞—ë–º callback –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–∏—ë–º –ø–∏—â–∏
        onAddPhoto, // Callback –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –∫ –ø—Ä–∏—ë–º—É
        headerRight: ({ stepData, currentConfig, goToStep }) => {
          const countLabel = `üóÉÔ∏è ${currentProducts.length}`;
          if (currentConfig?.id !== 'grams') return countLabel;

          const product = stepData?.grams?.selectedProduct
            || stepData?.create?.newProduct
            || stepData?.create?.selectedProduct
            || stepData?.search?.selectedProduct;

          const canEdit = canEditProduct(product);

          return React.createElement('div', { className: 'mc-header-right-group' },
            React.createElement('span', { className: 'mc-header-right-count' }, countLabel),
            canEdit && React.createElement('button', {
              className: 'mc-header-right-btn',
              onClick: (e) => {
                e.stopPropagation();
                if (HEYS.StepModal?.hide) {
                  HEYS.StepModal.hide({ scrollToDiary: false });
                }
                setTimeout(() => {
                  showEditProductModal(product);
                }, 80);
              },
              title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç'
            }, '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å')
          );
        }, // –°—á—ë—Ç—á–∏–∫ + –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ä—Ü–∏–π
        // Callback –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ 2 —à–∞–≥–∞—Ö, –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        onProductCreated: (product) => {
          currentProducts = [...currentProducts, product];
        }
      },
      showGreeting: false,
      showStreak: false,
      showTip: false,
      showProgress: true,
      allowSwipe: false,
      hidePrimaryOnFirst: true,
      finishLabel: '–î–æ–±–∞–≤–∏—Ç—å', // –ö–Ω–æ–ø–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ
      title: '', // –£–±—Ä–∞–ª–∏ ‚Äî –∏ —Ç–∞–∫ –æ—á–µ–≤–∏–¥–Ω–æ
      onComplete: (stepData) => {
        // console.log('[AddProductStep] onComplete stepData:', stepData);

        // –î–∞–Ω–Ω—ã–µ —à–∞–≥–æ–≤
        const searchData = stepData.search || {};
        const gramsData = stepData.grams || {};
        const createData = stepData.create || {};

        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ø—Ä–æ–¥—É–∫—Ç –∏–∑ grams (–ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥), –∑–∞—Ç–µ–º create (–Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç), –∑–∞—Ç–µ–º search
        // –í–ê–ñ–ù–û: create –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ search, —Ç.–∫. –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ 
        // stepData.grams –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –∏–∑-–∑–∞ React batching
        // newProduct ‚Äî —ç—Ç–æ –ø–æ–ª–µ –∫–æ—Ç–æ—Ä–æ–µ –≤—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
        const selectedProduct = gramsData.selectedProduct
          || createData.newProduct
          || createData.selectedProduct
          || searchData.selectedProduct;
        const grams = gramsData.grams || createData.grams || searchData.grams || 100;

        // console.log('[AddProductStep] selectedProduct:', selectedProduct?.name, 'grams:', grams);

        if (selectedProduct && grams) {
          console.info('[HEYS.addProduct] ‚úÖ onComplete -> onAdd', {
            mealIndex,
            grams,
            productId: selectedProduct.id ?? selectedProduct.product_id ?? null,
            productName: selectedProduct.name || null,
            source: selectedProduct._source || (selectedProduct._fromShared ? 'shared' : 'personal')
          });
          onAdd?.({
            product: selectedProduct,
            grams: grams,
            mealIndex
          });

          // üîî Dispatch event –¥–ª—è advice module
          window.dispatchEvent(new CustomEvent('heysProductAdded', {
            detail: { product: selectedProduct, grams }
          }));
        } else {
          console.warn('[HEYS.addProduct] ‚ö†Ô∏è onComplete skipped (missing product or grams)', {
            mealIndex,
            grams,
            hasSelectedProduct: !!selectedProduct,
            selectedProductName: selectedProduct?.name || null
          });
        }
      },
      onClose: handleModalClose
    });
  }

  // === –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä–∞–º–º–æ–≤ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞) ===
  function showEditGramsModal(options = {}) {
    const {
      product,
      currentGrams = 100,
      mealIndex = 0,
      itemId,
      dateKey = new Date().toISOString().slice(0, 10),
      onSave,
      onClose
    } = options;

    if (!product) {
      console.error('[EditGramsModal] No product provided');
      return;
    }

    if (!HEYS.StepModal) {
      console.error('[EditGramsModal] StepModal not loaded');
      return;
    }

    HEYS.StepModal.show({
      steps: [
        {
          id: 'grams',
          title: product?.name || '–ì—Ä–∞–º–º—ã',
          hint: '',
          icon: '‚öñÔ∏è',
          component: GramsStep,
          validate: (data) => (data?.grams || 0) > 0,
          hideHeaderNext: true, // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ö–µ–¥–µ—Ä–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª—å—à—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É
          getInitialData: (ctx) => ({
            grams: ctx?.editGrams || currentGrams || 100,
            selectedProduct: ctx?.editProduct || product
          })
        }
      ],
      context: {
        products: [],
        dateKey,
        mealIndex,
        itemId,
        isEditMode: true,
        editProduct: product,   // –ü—Ä–æ–¥—É–∫—Ç —á–µ—Ä–µ–∑ context ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω —Å—Ä–∞–∑—É
        editGrams: currentGrams, // –ì—Ä–∞–º–º—ã —á–µ—Ä–µ–∑ context
        onSave  // Callback –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ–ª—å—à–æ–π –∫–Ω–æ–ø–∫–æ–π
      },
      showGreeting: false,
      showStreak: false,
      showTip: false,
      showProgress: false,
      allowSwipe: false,
      finishLabel: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
      title: '',
      onComplete: (stepData) => {
        const gramsData = stepData.grams || {};
        const grams = gramsData.grams || currentGrams;

        if (grams > 0) {
          onSave?.({
            mealIndex,
            itemId,
            grams
          });
        }
      },
      onClose
    });
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.AddProductStep = {
    show: showAddProductModal,
    showEditGrams: showEditGramsModal,
    showEditProduct: showEditProductModal,
    ProductSearchStep,
    GramsStep,
    PortionsStep,
    CreateProductStep,
    ProductEditBasicStep,
    ProductEditExtraStep,
    HarmSelectStep,
    getCategoryIcon,
    computeSmartProducts,
    updateSharedProduct,
    updateSharedProductPortions
  };

  // === –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ú–ï–•–ê–ù–ò–ó–ú –°–û–ë–´–¢–ò–ô –ü–†–û–î–£–ö–¢–û–í ===
  // –°–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è ‚Äî –ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  // –†–µ—à–µ–Ω–∏–µ –¥–ª—è EDIT flow (showEditProductModal), –≥–¥–µ ProductSearchStep –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

  function initializeGlobalProductListeners() {
    const handleGlobalProductUpdate = (e) => {
      console.log('[AddProductStep GLOBAL] üîÑ Product event received', {
        event: e?.type,
        detail: e?.detail,
        currentVersion: globalProductsVersion,
        timestamp: new Date().toISOString()
      });

      globalProductsVersion++;

      console.log('[AddProductStep GLOBAL] ‚úÖ Version incremented', {
        newVersion: globalProductsVersion
      });

      // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      window.dispatchEvent(new CustomEvent('heys:products-version-changed', {
        detail: {
          version: globalProductsVersion,
          sourceEvent: e?.type
        }
      }));

      console.log('[AddProductStep GLOBAL] üì¢ Dispatched version-changed event', {
        version: globalProductsVersion
      });
    };

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è)
    window.addEventListener('heys:local-product-updated', handleGlobalProductUpdate);
    window.addEventListener('heys:product-portions-updated', handleGlobalProductUpdate);
    window.addEventListener('heys:product-updated', handleGlobalProductUpdate);

    console.log('[AddProductStep GLOBAL] ‚úÖ Global product listeners initialized', {
      initialVersion: globalProductsVersion
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è
  initializeGlobalProductListeners();

  console.log('[HEYS] AddProductStep v1 loaded with global listeners');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_confirm_modal_v1.js ===== */
// heys_confirm_modal_v1.js ‚Äî –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
// –ï–¥–∏–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö confirm-–¥–∏–∞–ª–æ–≥–æ–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const ReactDOM = global.ReactDOM;

  if (!React || !ReactDOM) {
    console.error('[ConfirmModal] React/ReactDOM not found');
    return;
  }

  // === –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏ ===
  let currentModal = null;
  let setModalState = null;
  let modalRoot = null;
  let modalRootInstance = null; // React 18 createRoot instance
  let modalCleanup = null; // Cleanup —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è ModalManager

  // === –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===
  const DEFAULTS = {
    icon: '‚ùì',
    title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
    text: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
    confirmText: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
    cancelText: '–û—Ç–º–µ–Ω–∞',
    confirmStyle: 'danger', // 'danger' | 'primary' | 'success'
    cancelStyle: 'neutral', // 'neutral' | 'danger' | 'primary' | 'success'
    confirmVariant: 'text', // 'text' | 'fill'
    cancelVariant: 'text', // 'text' | 'fill'
    onConfirm: () => { },
    onCancel: () => { }
  };

  // === –°—Ç–∏–ª–∏ –¥–ª—è confirmStyle ===
  const CONFIRM_STYLES = {
    neutral: {
      color: '#6b7280',
      activeBackground: '#f3f4f6',
      darkColor: '#9ca3af',
      darkActiveBackground: 'rgba(148, 163, 184, 0.2)'
    },
    danger: {
      color: '#ef4444',
      activeBackground: '#fef2f2',
      darkColor: '#f87171',
      darkActiveBackground: 'rgba(239, 68, 68, 0.2)'
    },
    primary: {
      color: '#3b82f6',
      activeBackground: '#eff6ff',
      darkColor: '#60a5fa',
      darkActiveBackground: 'rgba(59, 130, 246, 0.2)'
    },
    success: {
      color: '#22c55e',
      activeBackground: '#f0fdf4',
      darkColor: '#4ade80',
      darkActiveBackground: 'rgba(34, 197, 94, 0.2)'
    }
  };

  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ ===
  function ConfirmModalComponent() {
    const [modal, setModal] = React.useState(null);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º setter –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    React.useEffect(() => {
      setModalState = setModal;
      return () => { setModalState = null; };
    }, []);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    React.useEffect(() => {
      if (!modal) return;

      const handleKeyDown = (e) => {
        if (e.key === 'Escape') {
          handleCancel();
        } else if (e.key === 'Enter') {
          handleConfirm();
        }
      };

      document.addEventListener('keydown', handleKeyDown);
      return () => document.removeEventListener('keydown', handleKeyDown);
    }, [modal]);

    const handleConfirm = React.useCallback(() => {
      if (!modal) return;

      // Haptic feedback
      if (HEYS.dayUtils?.haptic) {
        HEYS.dayUtils.haptic('medium');
      }

      modal.onConfirm?.();
      setModal(null);
    }, [modal]);

    const handleCancel = React.useCallback(() => {
      if (!modal) return;
      modal.onCancel?.();
      setModal(null);
    }, [modal]);

    const handleBackdropClick = React.useCallback((e) => {
      if (e.target === e.currentTarget) {
        handleCancel();
      }
    }, [handleCancel]);

    if (!modal) return null;

    const confirmStyle = CONFIRM_STYLES[modal.confirmStyle] || CONFIRM_STYLES.danger;
    const cancelStyle = CONFIRM_STYLES[modal.cancelStyle] || CONFIRM_STYLES.neutral;
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const confirmVariant = modal.confirmVariant || 'text';
    const cancelVariant = modal.cancelVariant || 'text';

    return React.createElement('div', {
      className: 'confirm-modal-backdrop',
      onClick: handleBackdropClick
    },
      React.createElement('div', {
        className: 'confirm-modal',
        onClick: e => e.stopPropagation()
      },
        // –ò–∫–æ–Ω–∫–∞
        React.createElement('div', { className: 'confirm-modal-icon' }, modal.icon),

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        React.createElement('div', { className: 'confirm-modal-title' }, modal.title),

        // –¢–µ–∫—Å—Ç
        modal.text && React.createElement('div', { className: 'confirm-modal-text' }, modal.text),

        // –ö–Ω–æ–ø–∫–∏
        React.createElement('div', { className: 'confirm-modal-buttons' },
          React.createElement('button', {
            className: 'confirm-modal-btn cancel'
              + (modal.cancelStyle ? ` confirm-modal-btn--${modal.cancelStyle}` : '')
              + (cancelVariant === 'fill' ? ' confirm-modal-btn--fill' : ''),
            style: cancelVariant === 'fill'
              ? { fontWeight: 600 }
              : {
                color: isDark ? cancelStyle.darkColor : cancelStyle.color,
                fontWeight: 600
              },
            onClick: handleCancel
          }, modal.cancelText),
          modal.confirmText && React.createElement('button', {
            className: 'confirm-modal-btn confirm'
              + (modal.confirmStyle ? ` confirm-modal-btn--${modal.confirmStyle}` : '')
              + (confirmVariant === 'fill' ? ' confirm-modal-btn--fill' : ''),
            style: confirmVariant === 'fill'
              ? { fontWeight: 600 }
              : {
                color: isDark ? confirmStyle.darkColor : confirmStyle.color,
                fontWeight: 600
              },
            onClick: handleConfirm
          }, modal.confirmText)
        )
      )
    );
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è root —ç–ª–µ–º–µ–Ω—Ç–∞ ===
  function ensureRoot() {
    if (modalRoot) return modalRoot;

    modalRoot = document.getElementById('confirm-modal-root');
    if (!modalRoot) {
      modalRoot = document.createElement('div');
      modalRoot.id = 'confirm-modal-root';
      document.body.appendChild(modalRoot);
    }

    // React 18: createRoot API
    if (!modalRootInstance) {
      modalRootInstance = ReactDOM.createRoot(modalRoot);
    }
    modalRootInstance.render(
      React.createElement(ConfirmModalComponent)
    );

    return modalRoot;
  }

  // === –ü—É–±–ª–∏—á–Ω–æ–µ API ===

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   * @param {Object} options - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–∞–ª–∫–∏
   * @param {string} options.icon - –≠–º–æ–¥–∑–∏ –∏–∫–æ–Ω–∫–∞ (–Ω–∞–ø—Ä. 'üóëÔ∏è')
   * @param {string} options.title - –ó–∞–≥–æ–ª–æ–≤–æ–∫
   * @param {string} options.text - –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @param {string} options.confirmText - –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   * @param {string} options.cancelText - –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
  * @param {string} options.confirmStyle - –°—Ç–∏–ª—å: 'danger' | 'primary' | 'success'
  * @param {string} options.cancelStyle - –°—Ç–∏–ª—å: 'neutral' | 'danger' | 'primary' | 'success'
  * @param {string} options.confirmVariant - –í–∞—Ä–∏–∞–Ω—Ç: 'text' | 'fill'
  * @param {string} options.cancelVariant - –í–∞—Ä–∏–∞–Ω—Ç: 'text' | 'fill'
   * @param {Function} options.onConfirm - Callback –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
   * @param {Function} options.onCancel - Callback –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
   * @returns {Promise<boolean>} - true –µ—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, false –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ
   */
  function show(options = {}) {
    ensureRoot();

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ ModalManager
    if (HEYS.ModalManager) {
      modalCleanup = HEYS.ModalManager.register('confirm-modal', () => {
        hide(true); // skipManagerNotify = true
      });
    }

    return new Promise((resolve) => {
      const modal = {
        ...DEFAULTS,
        ...options,
        onConfirm: () => {
          options.onConfirm?.();
          resolve(true);
        },
        onCancel: () => {
          options.onCancel?.();
          resolve(false);
        }
      };

      if (setModalState) {
        setModalState(modal);
      }
    });
  }

  /**
   * –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
   */
  function hide(skipManagerNotify = false) {
    // –î–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–∑ ModalManager (–µ—Å–ª–∏ –Ω–µ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
    if (modalCleanup && !skipManagerNotify) {
      modalCleanup();
      modalCleanup = null;
    }

    if (setModalState) {
      setModalState(null);
    }
  }

  // === –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–µ—Å–µ—Ç—ã ===

  /**
   * –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
   */
  function confirmDelete(options = {}) {
    return show({
      icon: 'üóëÔ∏è',
      title: options.title || '–£–¥–∞–ª–∏—Ç—å?',
      text: options.text || '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
      confirmText: '–£–¥–∞–ª–∏—Ç—å',
      cancelText: '–û—Ç–º–µ–Ω–∞',
      confirmStyle: 'danger',
      ...options
    });
  }

  /**
   * –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ)
   */
  function confirmAction(options = {}) {
    return show({
      icon: '‚ùì',
      title: options.title || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
      confirmText: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
      cancelText: '–û—Ç–º–µ–Ω–∞',
      confirmStyle: 'primary',
      ...options
    });
  }

  /**
   * –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   */
  function confirmSave(options = {}) {
    return show({
      icon: 'üíæ',
      title: options.title || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?',
      confirmText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
      cancelText: '–û—Ç–º–µ–Ω–∞',
      confirmStyle: 'success',
      ...options
    });
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.ConfirmModal = {
    show,
    hide,
    close: hide,  // –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ day/_meals.js)
    confirmDelete,
    confirmAction,
    confirmSave,
    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
    Component: ConfirmModalComponent
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureRoot);
  } else {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã React —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
    setTimeout(ensureRoot, 0);
  }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_predictive_insights_v1.js ===== */
// heys_predictive_insights_v1.js ‚Äî Predictive Insights Module v4.0.0
// –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 7-30 –¥–Ω–µ–π, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏, –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –ø—Ä–æ–≥–Ω–æ–∑—ã
// v2.2.0: What-If Simulator ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä –µ–¥—ã
// v2.2.1: Refactored - constants extracted to insights/pi_constants.js
// v3.0.0: Major refactoring - extracted Layer B modules (stats, science, patterns, advanced, analytics_api)
if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();
//         Main file reduced from 10,206 to 3,557 lines (-65%)
// v3.1.0: Final refactoring (Phases 10-12) - extracted calculations, removed UI duplicates
//         Main file reduced to 1,005 lines (-90% from original, pure orchestration)
// v4.0.0: Insights Deep Analytics ‚Äî 6 new patterns (sleep quality, wellbeing, hydration, body composition,
//         cycle impact, weekend effect), EMA smoothing, TEF-adjusted protein=3kcal/g, scientific thresholds,
//         25 patterns total (was 19)
//         Total 11 Layer B modules created
// –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: HEYS.InsulinWave, HEYS.Cycle, HEYS.ratioZones, HEYS.models, U.lsGet
//              HEYS.InsightsPI.* (pi_constants, pi_math, pi_stats, pi_science_info, pi_patterns, 
//                                 pi_advanced, pi_analytics_api, pi_calculations, pi_ui_*)
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const U = HEYS.utils || {};

  // === –ö–û–ù–°–¢–ê–ù–¢–´ (–∏–∑ pi_constants.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const piConst = HEYS.InsightsPI?.constants || window.piConst || {};

  // === –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò (–∏–∑ pi_stats.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const piStats = HEYS.InsightsPI?.stats || window.piStats || {};

  // === –ù–ê–£–ß–ù–ê–Ø –ë–î (–∏–∑ pi_science_info.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const SCIENCE_INFO = piConst.SCIENCE_INFO || HEYS.InsightsPI?.science || window.piScience || {};

  // === –ê–ù–ê–õ–ò–ó –ü–ê–¢–¢–ï–†–ù–û–í (–∏–∑ pi_patterns.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const piPatterns = HEYS.InsightsPI?.patterns || window.piPatterns || {};

  // === –ü–†–û–î–í–ò–ù–£–¢–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê (–∏–∑ pi_advanced.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const piAdvanced = HEYS.InsightsPI?.advanced || window.piAdvanced || {};

  // === –ê–ù–ê–õ–ò–¢–ò–ö–ê API (–∏–∑ pi_analytics_api.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const piAnalyticsAPI = HEYS.InsightsPI?.analyticsAPI || window.piAnalyticsAPI || {};

  // === –í–´–ß–ò–°–õ–ò–¢–ï–õ–¨–ù–´–ï –£–¢–ò–õ–ò–¢–´ (–∏–∑ pi_calculations.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–æ–≤, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const piCalculations = HEYS.InsightsPI?.calculations || window.piCalculations || {};

  // === UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ (–∏–∑ pi_ui_*.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, fallback –µ—Å–ª–∏ –º–æ–¥—É–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
  const piUIRings = HEYS.InsightsPI?.uiRings || window.piUIRings || {};
  const piUICards = HEYS.InsightsPI?.uiCards || window.piUICards || {};
  const piUIWhatIf = HEYS.InsightsPI?.uiWhatIf || window.piUIWhatIf || {};
  const piUIDashboard = HEYS.InsightsPI?.uiDashboard || window.piUIDashboard || {};

  // === LAZY GETTER –¥–ª—è InfoButton —Å –ø–æ–ª–Ω–æ–π fallback —Ü–µ–ø–æ—á–∫–æ–π (fix load order) ===
  function getInfoButton() {
    return HEYS.InsightsPI?.uiDashboard?.InfoButton ||
      HEYS.PredictiveInsights?.components?.InfoButton ||
      HEYS.day?.InfoButton ||
      HEYS.InfoButton ||
      window.InfoButton ||
      function FallbackInfoButton() { return null; };
  }

  const CONFIG = piConst.CONFIG || {
    DEFAULT_DAYS: 60,
    MIN_DAYS_FOR_INSIGHTS: 3,
    MIN_DAYS_FOR_FULL_ANALYSIS: 7,
    MIN_CORRELATION_DISPLAY: 0.35,
    CACHE_TTL_MS: 5 * 60 * 1000,
    VERSION: '4.1.0'
  };

  // === –°–ò–°–¢–ï–ú–ê –ü–†–ò–û–†–ò–¢–ï–¢–û–í –ò –ö–†–ò–¢–ï–†–ò–ï–í ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ pi_constants.js

  const PRIORITY_LEVELS = piConst.PRIORITY_LEVELS || {
    CRITICAL: { level: 1, name: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', emoji: 'üî¥', color: '#ef4444', description: '–¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.' },
    HIGH: { level: 2, name: '–í—ã—Å–æ–∫–∏–π', emoji: 'üü†', color: '#f97316', description: '–í–∞–∂–Ω–æ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π.' },
    MEDIUM: { level: 3, name: '–°—Ä–µ–¥–Ω–∏–π', emoji: 'üü°', color: '#eab308', description: '–ü–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.' },
    LOW: { level: 4, name: '–ù–∏–∑–∫–∏–π', emoji: 'üü¢', color: '#22c55e', description: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.' },
    INFO: { level: 5, name: '–°–ø—Ä–∞–≤–æ—á–Ω—ã–π', emoji: 'üîµ', color: '#3b82f6', description: '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.' }
  };

  const CATEGORIES = piConst.CATEGORIES || {
    METABOLISM: { id: 'metabolism', name: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', emoji: 'üî•', color: '#f97316', description: '–ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é' },
    NUTRITION: { id: 'nutrition', name: '–ü–∏—Ç–∞–Ω–∏–µ', emoji: 'üçΩÔ∏è', color: '#22c55e', description: '–ö–∞—á–µ—Å—Ç–≤–æ –∏ —Å–æ—Å—Ç–∞–≤ –ø–∏—Ç–∞–Ω–∏—è' },
    TIMING: { id: 'timing', name: '–¢–∞–π–º–∏–Ω–≥', emoji: '‚è∞', color: '#8b5cf6', description: '–ö–æ–≥–¥–∞ –µ—Å—Ç—å –∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å' },
    RECOVERY: { id: 'recovery', name: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', emoji: 'üò¥', color: '#6366f1', description: '–°–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –æ—Ç–¥—ã—Ö' },
    RISK: { id: 'risk', name: '–†–∏—Å–∫–∏', emoji: '‚ö†Ô∏è', color: '#ef4444', description: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º' },
    PREDICTION: { id: 'prediction', name: '–ü—Ä–æ–≥–Ω–æ–∑—ã', emoji: 'üîÆ', color: '#a855f7', description: '–ß—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ' },
    PATTERNS: { id: 'patterns', name: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', emoji: 'üß¨', color: '#ec4899', description: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏' },
    COMPOSITE: { id: 'composite', name: '–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ', emoji: 'üìä', color: '#14b8a6', description: '–°–≤–æ–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏' },
    STATISTICS: { id: 'statistics', name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', emoji: 'üìà', color: '#64748b', description: '–ù–∞—É—á–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã' }
  };

  // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è actionability (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ pi_constants.js)
  const ACTIONABILITY = piConst.ACTIONABILITY || {
    IMMEDIATE: { level: 1, name: '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ', emoji: '‚ö°', description: '–ú–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å' },
    TODAY: { level: 2, name: '–°–µ–≥–æ–¥–Ω—è', emoji: 'üìÖ', description: '–í–ª–∏—è–µ—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è' },
    WEEKLY: { level: 3, name: '–ù–µ–¥–µ–ª—è', emoji: 'üìÜ', description: '–¢—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π' },
    LONG_TERM: { level: 4, name: '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ', emoji: 'üéØ', description: '–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' },
    INFORMATIONAL: { level: 5, name: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ', emoji: '‚ÑπÔ∏è', description: '–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è' }
  };

  // === API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ ===

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ –º–µ—Ç—Ä–∏–∫–∏
   * @param {string} key - –∫–ª—é—á –∏–∑ SCIENCE_INFO
   * @returns {Object} { priority, category, actionability, impactScore, whyImportant, ... }
   */
  function getMetricPriority(key) {
    const info = SCIENCE_INFO[key];
    if (!info) return null;

    const priorityLevel = PRIORITY_LEVELS[info.priority] || PRIORITY_LEVELS.INFO;
    const category = CATEGORIES[info.category] || CATEGORIES.STATISTICS;
    const actionability = ACTIONABILITY[info.actionability] || ACTIONABILITY.INFORMATIONAL;

    return {
      key,
      name: info.name,
      priority: info.priority || 'INFO',
      priorityLevel: priorityLevel.level,
      priorityName: priorityLevel.name,
      priorityEmoji: priorityLevel.emoji,
      priorityColor: priorityLevel.color,
      category: info.category || 'STATISTICS',
      categoryName: category.name,
      categoryEmoji: category.emoji,
      categoryColor: category.color,
      actionability: info.actionability || 'INFORMATIONAL',
      actionabilityLevel: actionability.level,
      actionabilityName: actionability.name,
      actionabilityEmoji: actionability.emoji,
      impactScore: info.impactScore || 0,
      whyImportant: info.whyImportant || '',
      source: info.source,
      pmid: info.pmid
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –∏ impact score
   * @returns {Array} –º–∞—Å—Å–∏–≤ –º–µ—Ç—Ä–∏–∫ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   */
  function getAllMetricsByPriority() {
    const metrics = [];
    for (const key of Object.keys(SCIENCE_INFO)) {
      const priority = getMetricPriority(key);
      if (priority) metrics.push(priority);
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ priorityLevel (1=CRITICAL —Å–Ω–∞—á–∞–ª–∞), –∑–∞—Ç–µ–º –ø–æ impactScore (–≤—ã—à–µ = –≤–∞–∂–Ω–µ–µ)
    return metrics.sort((a, b) => {
      if (a.priorityLevel !== b.priorityLevel) {
        return a.priorityLevel - b.priorityLevel;
      }
      return b.impactScore - a.impactScore;
    });
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * @param {string} category - –∫–ª—é—á –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (METABOLISM, NUTRITION, etc)
   * @returns {Array} –º–∞—Å—Å–∏–≤ –º–µ—Ç—Ä–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   */
  function getMetricsByCategory(category) {
    return getAllMetricsByPriority().filter(m => m.category === category);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ actionability
   * @param {string} actionability - IMMEDIATE, TODAY, WEEKLY, etc
   * @returns {Array} –º–∞—Å—Å–∏–≤ –º–µ—Ç—Ä–∏–∫
   */
  function getMetricsByActionability(actionability) {
    return getAllMetricsByPriority().filter(m => m.actionability === actionability);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ CRITICAL –∏ HIGH priority –º–µ—Ç—Ä–∏–∫–∏
   * @returns {Array} –º–∞—Å—Å–∏–≤ –≤–∞–∂–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
   */
  function getCriticalMetrics() {
    return getAllMetricsByPriority().filter(m =>
      m.priority === 'CRITICAL' || m.priority === 'HIGH'
    );
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
   * @returns {Object} { total, byPriority, byCategory, byActionability }
   */
  function getPriorityStats() {
    const all = getAllMetricsByPriority();

    const byPriority = {};
    const byCategory = {};
    const byActionability = {};

    for (const m of all) {
      byPriority[m.priority] = (byPriority[m.priority] || 0) + 1;
      byCategory[m.category] = (byCategory[m.category] || 0) + 1;
      byActionability[m.actionability] = (byActionability[m.actionability] || 0) + 1;
    }

    return {
      total: all.length,
      avgImpactScore: all.length > 0
        ? Math.round(all.reduce((s, m) => s + m.impactScore, 0) / all.length * 100) / 100
        : 0,
      byPriority,
      byCategory,
      byActionability
    };
  }

  // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–ö–¶–ò–ô UI (–∏–∑ pi_constants.js) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const SECTIONS_CONFIG = piConst.SECTIONS_CONFIG || (() => {
    // Fallback —Å–µ–∫—Ü–∏–∏ –µ—Å–ª–∏ pi_constants.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    console.warn('[PI] pi_constants.js not loaded, using fallback SECTIONS_CONFIG');
    return {
      STATUS_SCORE: { id: 'status_score', component: 'StatusScoreCard', priority: 'CRITICAL', order: 1, alwaysShow: true, title: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å', icon: 'üéØ' },
      CRASH_RISK: { id: 'crash_risk', component: 'MetabolicQuickStatus', priority: 'CRITICAL', order: 2, alwaysShow: true, title: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞', icon: '‚ö†Ô∏è' },
      PRIORITY_ACTIONS: { id: 'priority_actions', component: 'PriorityActions', priority: 'CRITICAL', order: 3, alwaysShow: true, title: '–î–µ–π—Å—Ç–≤–∏—è —Å–µ–π—á–∞—Å', icon: '‚ö°' },
      PREDICTIVE_DASHBOARD: { id: 'predictive_dashboard', component: 'PredictiveDashboard', priority: 'HIGH', order: 10, title: '–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è', icon: 'üîÆ' },
      ADVANCED_ANALYTICS: { id: 'advanced_analytics', component: 'AdvancedAnalyticsCard', priority: 'HIGH', order: 11, title: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞', icon: 'üìä' },
      METABOLISM: { id: 'metabolism', component: 'MetabolismSection', priority: 'HIGH', order: 12, title: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', icon: 'üî•' },
      MEAL_TIMING: { id: 'meal_timing', component: 'MealTimingCard', priority: 'HIGH', order: 13, title: '–¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤', icon: '‚è∞' },
      WHAT_IF: { id: 'what_if', component: 'WhatIfSection', priority: 'MEDIUM', order: 20, title: '–ß—Ç–æ –µ—Å–ª–∏...', icon: 'üéØ' },
      PATTERNS: { id: 'patterns', component: 'PatternsList', priority: 'MEDIUM', order: 21, title: '–ü–∞—Ç—Ç–µ—Ä–Ω—ã', icon: 'üîç' },
      WEIGHT_PREDICTION: { id: 'weight_prediction', component: 'WeightPrediction', priority: 'MEDIUM', order: 22, title: '–ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞', icon: '‚öñÔ∏è' },
      WEEKLY_WRAP: { id: 'weekly_wrap', component: 'WeeklyWrap', priority: 'LOW', order: 30, title: '–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏', icon: 'üìã' },
      DATA_COMPLETENESS: { id: 'data_completeness', component: 'DataCompletenessCard', priority: 'LOW', order: 31, title: '–ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', icon: 'üìä' }
    };
  })();

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ü–∏–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ pi_constants –µ—Å–ª–∏ –µ—Å—Ç—å)
   */
  const getSortedSections = piConst.getSortedSections || function (filterPriority = null) {
    let sections = Object.values(SECTIONS_CONFIG);
    if (filterPriority) sections = sections.filter(s => s.priority === filterPriority);
    return sections.sort((a, b) => a.order - b.order);
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–µ–∫—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ pi_constants –µ—Å–ª–∏ –µ—Å—Ç—å)
   */
  const getSectionPriority = piConst.getSectionPriority || function (sectionId) {
    const section = Object.values(SECTIONS_CONFIG).find(s => s.id === sectionId);
    if (!section) return null;
    const priorityLevel = PRIORITY_LEVELS[section.priority];
    return {
      ...section,
      priorityLevel: priorityLevel?.level || 5,
      priorityEmoji: priorityLevel?.emoji || 'üîµ',
      priorityColor: priorityLevel?.color || '#3b82f6',
      priorityName: priorityLevel?.name || '–°–ø—Ä–∞–≤–æ—á–Ω—ã–π'
    };
  }

  const PATTERNS = {
    // –ï–¥–∞ + –≤–æ–ª–Ω—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    MEAL_TIMING: 'meal_timing',
    WAVE_OVERLAP: 'wave_overlap',
    LATE_EATING: 'late_eating',
    MEAL_QUALITY_TREND: 'meal_quality',

    // –°–æ–Ω + –≤–µ—Å
    SLEEP_WEIGHT: 'sleep_weight',
    SLEEP_HUNGER: 'sleep_hunger',

    // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    TRAINING_KCAL: 'training_kcal',
    STEPS_WEIGHT: 'steps_weight',

    // –ú–∞–∫—Ä–æ—Å—ã
    PROTEIN_SATIETY: 'protein_satiety',
    FIBER_REGULARITY: 'fiber_regularity',

    // –≠–º–æ—Ü–∏–∏
    STRESS_EATING: 'stress_eating',
    MOOD_FOOD: 'mood_food',

    // NEW v2.0
    CIRCADIAN: 'circadian',
    NUTRIENT_TIMING: 'nutrient_timing',
    INSULIN_SENSITIVITY: 'insulin_sensitivity',
    GUT_HEALTH: 'gut_health'
  };

  // === –ö–≠–® ===
  let _cache = {
    data: null,
    timestamp: 0,
    clientId: null,
    daysBack: null
  };

  // === –£–¢–ò–õ–ò–¢–´ ===

  // –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ pi_stats.js
  const average = piStats.average || function (arr) {
    if (!arr || arr.length === 0) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  };

  const stdDev = piStats.stdDev || function (arr) {
    if (!arr || arr.length < 2) return 0;
    const avg = average(arr);
    const squareDiffs = arr.map(v => Math.pow(v - avg, 2));
    return Math.sqrt(average(squareDiffs));
  };

  const pearsonCorrelation = piStats.pearsonCorrelation || function (x, y) {
    if (x.length !== y.length || x.length < 3) return 0;
    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
    const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);
    const sumY2 = y.reduce((acc, yi) => acc + yi * yi, 0);
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    if (denominator === 0) return 0;
    return numerator / denominator;
  };

  const calculateTrend = piStats.calculateTrend || function (values) {
    if (values.length < 2) return 0;
    const n = values.length;
    const x = values.map((_, i) => i);
    const y = values;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
    const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    return isNaN(slope) ? 0 : slope;
  };

  const calculateLinearRegression = piStats.calculateLinearRegression || function (points) {
    if (points.length < 2) return 0;
    const n = points.length;
    const sumX = points.reduce((a, p) => a + p.x, 0);
    const sumY = points.reduce((a, p) => a + p.y, 0);
    const sumXY = points.reduce((a, p) => a + p.x * p.y, 0);
    const sumX2 = points.reduce((a, p) => a + p.x * p.x, 0);
    const denominator = (n * sumX2 - sumX * sumX);
    if (denominator === 0) return 0;
    const slope = (n * sumXY - sumX * sumY) / denominator;
    return isNaN(slope) ? 0 : slope;
  };

  // === –í–´–ß–ò–°–õ–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ pi_calculations.js) ===
  const calculateItemKcal = piCalculations.calculateItemKcal || function (item, pIndex) {
    if (!item || !item.grams) return 0;
    const prod = pIndex?.byId?.get?.(String(item.product_id || item.productId || item.id)?.toLowerCase());
    if (!prod) return 0;
    const p = prod.protein100 || 0;
    const c = (prod.simple100 || 0) + (prod.complex100 || 0);
    const f = (prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0);
    return (p * 4 + c * 4 + f * 9) * item.grams / 100;
  };

  const calculateDayKcal = piCalculations.calculateDayKcal || function (day, pIndex) {
    let total = 0;
    if (!day.meals) return 0;
    for (const meal of day.meals) {
      if (!meal.items) continue;
      for (const item of meal.items) {
        total += calculateItemKcal(item, pIndex);
      }
    }
    return total;
  };

  const calculateBMR = piCalculations.calculateBMR || function (profile) {
    if (HEYS.TDEE?.calcBMR) return HEYS.TDEE.calcBMR(profile);
    const weight = profile?.weight || 70;
    const height = profile?.height || 170;
    const age = profile?.age || 30;
    const isMale = profile?.gender !== '–ñ–µ–Ω—Å–∫–∏–π';
    return isMale ? (10 * weight + 6.25 * height - 5 * age + 5) : (10 * weight + 6.25 * height - 5 * age - 161);
  };

  const getDaysData = piCalculations.getDaysData || function (daysBack, lsGet) {
    const days = [];
    const today = new Date();
    for (let i = 0; i < daysBack; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const dayData = lsGet(`heys_dayv2_${dateStr}`, null);
      if (dayData && Object.keys(dayData).length > 0) {
        days.push({ date: dateStr, daysAgo: i, ...dayData });
      }
    }
    return days;
  };

  // === UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ - Fallback references (–¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ pi_ui_*.js –º–æ–¥—É–ª–∏) ===
  // Ring Components
  const HealthRing = piUIRings.HealthRing || function () { return h('div', {}, 'HealthRing not loaded'); };
  const TotalHealthRing = piUIRings.TotalHealthRing || function () { return h('div', {}, 'TotalHealthRing not loaded'); };
  const StatusProgressRing = piUIRings.StatusProgressRing || function () { return h('div', {}, 'StatusProgressRing not loaded'); };
  const MiniRiskMeter = piUIRings.MiniRiskMeter || function () { return h('div', {}, 'MiniRiskMeter not loaded'); };
  const MetabolicStateRing = piUIRings.MetabolicStateRing || function () { return h('div', {}, 'MetabolicStateRing not loaded'); };

  // Card Components
  const CollapsibleSection = piUICards.CollapsibleSection || function () { return h('div', {}, 'CollapsibleSection not loaded'); };
  const AdvancedAnalyticsCard = piUICards.AdvancedAnalyticsCard || function () { return h('div', {}, 'AdvancedAnalyticsCard not loaded'); };
  const MetabolismCard = piUICards.MetabolismCard || function () { return h('div', {}, 'MetabolismCard not loaded'); };
  const MetabolismSection = piUICards.MetabolismSection || function () { return h('div', {}, 'MetabolismSection not loaded'); };
  const PatternCard = piUICards.PatternCard || function () { return h('div', {}, 'PatternCard not loaded'); };
  const PatternsList = piUICards.PatternsList || function () { return h('div', {}, 'PatternsList not loaded'); };
  const WeeklyWrap = piUICards.WeeklyWrap || function () { return h('div', {}, 'WeeklyWrap not loaded'); };
  const EmptyState = piUICards.EmptyState || function () { return h('div', {}, 'EmptyState not loaded'); };
  const InsightsCard = piUICards.InsightsCard || function () { return h('div', {}, 'InsightsCard not loaded'); };
  const InfoButton = piUICards.InfoButton || function () { return h('button', {}, '‚ÑπÔ∏è'); };
  const MetricWithInfo = piUICards.MetricWithInfo || function () { return h('div', {}, 'Metric'); };
  const MetabolicStatusCard = piUICards.MetabolicStatusCard || function () { return h('div', {}, 'Status'); };
  const ReasonCard = piUICards.ReasonCard || function () { return h('div', {}, 'Reason'); };
  const ActionCard = piUICards.ActionCard || function () { return h('div', {}, 'Action'); };

  // What-If Components
  const WhatIfSimulator = piUIWhatIf.WhatIfSimulator || function () { return h('div', {}, 'WhatIfSimulator not loaded'); };
  const WhatIfCard = piUIWhatIf.WhatIfCard || function () { return h('div', {}, 'WhatIfCard not loaded'); };
  const ScenarioCard = piUIWhatIf.ScenarioCard || function () { return h('div', {}, 'ScenarioCard not loaded'); };
  const WhatIfSection = piUIWhatIf.WhatIfSection || function () { return h('div', {}, 'WhatIfSection not loaded'); };

  // Dashboard Components
  const WeightPrediction = piUIDashboard.WeightPrediction || function () { return h('div', {}, 'WeightPrediction not loaded'); };
  const PriorityFilterBar = piUIDashboard.PriorityFilterBar || function () { return h('div', {}, 'PriorityFilterBar not loaded'); };
  const PillarBreakdownBars = piUIDashboard.PillarBreakdownBars || function () { return h('div', {}, 'PillarBreakdownBars not loaded'); };
  const DualRiskPanel = piUIDashboard.DualRiskPanel || function () { return h('div', {}, 'DualRiskPanel not loaded'); };
  const RiskPanel = piUIDashboard.RiskPanel || function () { return h('div', {}, 'RiskPanel not loaded'); };
  const RiskMeter = piUIDashboard.RiskMeter || function () { return h('div', {}, 'RiskMeter not loaded'); };
  const ForecastPanel = piUIDashboard.ForecastPanel || function () { return h('div', {}, 'ForecastPanel not loaded'); };
  const FeedbackPrompt = piUIDashboard.FeedbackPrompt || function () { return h('div', {}, 'FeedbackPrompt not loaded'); };
  const AccuracyBadge = piUIDashboard.AccuracyBadge || function () { return h('span', {}, 'Accuracy'); };
  const PredictiveDashboardLegacy = piUIDashboard.PredictiveDashboardLegacy || function () { return h('div', {}, 'Dashboard not loaded'); };
  const DataCompletenessCard = piUIDashboard.DataCompletenessCard || function () { return h('div', {}, 'DataCompletenessCard not loaded'); };
  const MealTimingCard = piUIDashboard.MealTimingCard || function () { return h('div', {}, 'MealTimingCard not loaded'); };

  // === –ê–ù–ê–õ–ò–ó –ü–ê–¢–¢–ï–†–ù–û–í ===
  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ pi_patterns.js
  const analyzeMealTiming = piPatterns.analyzeMealTiming || function () { return { pattern: 'meal_timing', available: false }; };
  const analyzeWaveOverlap = piPatterns.analyzeWaveOverlap || function () { return { pattern: 'wave_overlap', available: false }; };
  const analyzeLateEating = piPatterns.analyzeLateEating || function () { return { pattern: 'late_eating', available: false }; };
  const analyzeMealQualityTrend = piPatterns.analyzeMealQualityTrend || function () { return { pattern: 'meal_quality', available: false }; };
  const analyzeSleepWeight = piPatterns.analyzeSleepWeight || function () { return { pattern: 'sleep_weight', available: false }; };
  const analyzeSleepHunger = piPatterns.analyzeSleepHunger || function () { return { pattern: 'sleep_hunger', available: false }; };
  const analyzeTrainingKcal = piPatterns.analyzeTrainingKcal || function () { return { pattern: 'training_kcal', available: false }; };
  const analyzeStepsWeight = piPatterns.analyzeStepsWeight || function () { return { pattern: 'steps_weight', available: false }; };
  const analyzeProteinSatiety = piPatterns.analyzeProteinSatiety || function () { return { pattern: 'protein_satiety', available: false }; };
  const analyzeFiberRegularity = piPatterns.analyzeFiberRegularity || function () { return { pattern: 'fiber_regularity', available: false }; };
  const analyzeNutritionQuality = piPatterns.analyzeNutritionQuality || function () { return { pattern: 'nutrition_quality', available: false }; };
  const analyzeStressEating = piPatterns.analyzeStressEating || function () { return { pattern: 'stress_eating', available: false }; };
  const analyzeMoodFood = piPatterns.analyzeMoodFood || function () { return { pattern: 'mood_food', available: false }; };
  const analyzeMoodTrajectory = piPatterns.analyzeMoodTrajectory || function () { return { pattern: 'mood_trajectory', available: false }; };
  const analyzeCircadianTiming = piPatterns.analyzeCircadianTiming || function () { return { pattern: 'circadian', available: false }; };
  const analyzeNutrientTiming = piPatterns.analyzeNutrientTiming || function () { return { pattern: 'nutrient_timing', available: false }; };
  const analyzeInsulinSensitivity = piPatterns.analyzeInsulinSensitivity || function () { return { pattern: 'insulin_sensitivity', available: false }; };
  const analyzeGutHealth = piPatterns.analyzeGutHealth || function () { return { pattern: 'gut_health', available: false }; };
  const analyzeNEATTrend = piPatterns.analyzeNEATTrend || function () { return { pattern: 'neat_activity', available: false }; };

  // NEW v4.0 (B1-B6)
  const analyzeSleepQuality = piPatterns.analyzeSleepQuality || function () { return { pattern: 'sleep_quality', available: false }; };
  const analyzeWellbeing = piPatterns.analyzeWellbeing || function () { return { pattern: 'wellbeing_correlation', available: false }; };
  const analyzeHydration = piPatterns.analyzeHydration || function () { return { pattern: 'hydration', available: false }; };
  const analyzeBodyComposition = piPatterns.analyzeBodyComposition || function () { return { pattern: 'body_composition', available: false }; };
  const analyzeCyclePatterns = piPatterns.analyzeCyclePatterns || function () { return { pattern: 'cycle_impact', available: false }; };
  const analyzeWeekendEffect = piPatterns.analyzeWeekendEffect || function () { return { pattern: 'weekend_effect', available: false }; };

  // NEW v5.0 (C7-C12)
  const analyzeNOVAQuality = piPatterns.analyzeNOVAQuality || function () { return { pattern: 'nova_quality', available: false }; };
  const analyzeTrainingRecovery = piPatterns.analyzeTrainingRecovery || function () { return { pattern: 'training_recovery', available: false }; };
  const analyzeHypertrophy = piPatterns.analyzeHypertrophy || function () { return { pattern: 'hypertrophy', available: false }; };
  const analyzeMicronutrients = piPatterns.analyzeMicronutrients || function () { return { pattern: 'micronutrient_radar', available: false }; };
  const analyzeHeartHealth = piPatterns.analyzeHeartHealth || function () { return { pattern: 'heart_health', available: false }; };
  const analyzeOmegaBalance = piPatterns.analyzeOmegaBalance || function () { return { pattern: 'omega_balancer', available: false }; };

  // NEW v6.0 (C13-C22)
  const analyzeVitaminDefense = piPatterns.analyzeVitaminDefense || function () { return { pattern: 'vitamin_defense', available: false }; };
  const analyzeBComplexAnemia = piPatterns.analyzeBComplexAnemia || function () { return { pattern: 'b_complex_anemia', available: false }; };
  const analyzeGlycemicLoad = piPatterns.analyzeGlycemicLoad || function () { return { pattern: 'glycemic_load', available: false }; };
  const analyzeProteinDistribution = piPatterns.analyzeProteinDistribution || function () { return { pattern: 'protein_distribution', available: false }; };
  const analyzeAntioxidantDefense = piPatterns.analyzeAntioxidantDefense || function () { return { pattern: 'antioxidant_defense', available: false }; };
  const analyzeAddedSugarDependency = piPatterns.analyzeAddedSugarDependency || function () { return { pattern: 'added_sugar_dependency', available: false }; };
  const analyzeBoneHealth = piPatterns.analyzeBoneHealth || function () { return { pattern: 'bone_health', available: false }; };
  const analyzeTrainingTypeMatch = piPatterns.analyzeTrainingTypeMatch || function () { return { pattern: 'training_type_match', available: false }; };
  const analyzeElectrolyteHomeostasis = piPatterns.analyzeElectrolyteHomeostasis || function () { return { pattern: 'electrolyte_homeostasis', available: false }; };
  const analyzeNutrientDensity = piPatterns.analyzeNutrientDensity || function () { return { pattern: 'nutrient_density', available: false }; };

  // === –ü–†–û–î–í–ò–ù–£–¢–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê ===
  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ pi_advanced.js
  const calculateHealthScore = piAdvanced.calculateHealthScore || function (patterns, profile) {
    return { total: 0, categories: {}, available: false };
  };

  const generateWhatIfScenarios = piAdvanced.generateWhatIfScenarios || function (patterns, healthScore, days, profile) {
    return [];
  };

  const predictWeight = piAdvanced.predictWeight || function (days, profile) {
    return { available: false };
  };

  const generateWeeklyWrap = piAdvanced.generateWeeklyWrap || function (days, patterns, healthScore, weightPrediction, profile) {
    return null;
  };

  // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ê–ù–ê–õ–ò–ó–ê ===

  /**
   * –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
   * @param {Object} options - –æ–ø—Ü–∏–∏
   * @param {number} options.daysBack - —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 14)
   * @param {Function} options.lsGet - —Ñ—É–Ω–∫—Ü–∏—è U.lsGet
   * @param {Object} options.profile - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {Object} options.pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @param {number} options.optimum - —Ü–µ–ª–µ–≤–æ–π –∫–∞–ª–æ—Ä–∞–∂
   * @returns {Object} —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
   */
  function analyze(options = {}) {
    const {
      daysBack = CONFIG.DEFAULT_DAYS,
      lsGet = U.lsGet || ((k, d) => {
        try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
      }),
      profile = lsGet('heys_profile', {}),
      optimum = 2000
    } = options;

    // –ü–æ–ª—É—á–∞–µ–º pIndex: –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ —Å—Ç—Ä–æ–∏–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    let pIndex = options.pIndex || null;
    if (!pIndex || !pIndex.byId) {
      const products = HEYS.products?.getAll?.() || [];
      const buildIndex = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
      if (buildIndex && products.length > 0) {
        pIndex = buildIndex(products);
      } else if (products.length > 0) {
        const byId = new Map();
        const byName = new Map();
        for (const p of products) {
          if (p.id) byId.set(String(p.id).toLowerCase(), p);
          if (p.name) byName.set(p.name.toLowerCase(), p);
        }
        pIndex = { byId, byName };
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const clientId = lsGet('heys_client_current', 'default');
    const now = Date.now();

    if (_cache.data &&
      _cache.clientId === clientId &&
      _cache.daysBack === daysBack &&
      (now - _cache.timestamp) < CONFIG.CACHE_TTL_MS) {
      return _cache.data;
    }

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const days = getDaysData(daysBack, lsGet);

    if (days.length < CONFIG.MIN_DAYS_FOR_INSIGHTS) {
      return {
        available: false,
        daysAnalyzed: days.length,
        daysWithData: days.length,
        confidence: Math.round((days.length / CONFIG.MIN_DAYS_FOR_INSIGHTS) * 50),
        minDaysRequired: CONFIG.MIN_DAYS_FOR_INSIGHTS,
        message: `–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${CONFIG.MIN_DAYS_FOR_INSIGHTS} –¥–Ω—è –¥–∞–Ω–Ω—ã—Ö. –°–µ–π—á–∞—Å: ${days.length}`,
        patterns: [],
        healthScore: { total: 0, categories: {} },
        whatIf: [],
        weightPrediction: { available: false },
        weeklyWrap: null
      };
    }

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã ‚Äî v2.0: –¥–æ–±–∞–≤–ª–µ–Ω—ã pIndex –∏ –Ω–æ–≤—ã–µ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã
    const patterns = [
      // === –¢–∞–π–º–∏–Ω–≥ –∏ –≤–æ–ª–Ω—ã ===
      analyzeMealTiming(days, profile, pIndex),
      analyzeWaveOverlap(days, profile),
      analyzeLateEating(days, profile, pIndex),

      // === –ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è ===
      analyzeMealQualityTrend(days, pIndex, optimum),
      analyzeNutritionQuality(days, pIndex),
      analyzeProteinSatiety(days, profile, pIndex),     // v2.0: –¥–æ–±–∞–≤–ª–µ–Ω pIndex
      analyzeFiberRegularity(days, pIndex),              // v2.0: –¥–æ–±–∞–≤–ª–µ–Ω pIndex
      analyzeMoodFood(days, pIndex, optimum),
      analyzeMoodTrajectory(days, pIndex),

      // === –°–æ–Ω –∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ ===
      analyzeSleepWeight(days),
      analyzeSleepHunger(days, profile, pIndex),         // v2.0: –¥–æ–±–∞–≤–ª–µ–Ω pIndex

      // === –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ===
      analyzeTrainingKcal(days, pIndex),                 // v2.0: –¥–æ–±–∞–≤–ª–µ–Ω pIndex
      analyzeStepsWeight(days),
      analyzeNEATTrend(days),

      // === –°—Ç—Ä–µ—Å—Å ===
      analyzeStressEating(days, pIndex),                 // v2.0: –¥–æ–±–∞–≤–ª–µ–Ω pIndex

      // === –ù–∞—É—á–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã (v2.1) ===
      analyzeCircadianTiming(days, pIndex, profile),     // –¶–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã
      analyzeNutrientTiming(days, pIndex, profile),      // –¢–∞–π–º–∏–Ω–≥ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
      analyzeInsulinSensitivity(days, pIndex, profile),  // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É
      analyzeGutHealth(days, pIndex),                    // –ó–¥–æ—Ä–æ–≤—å–µ –ñ–ö–¢

      // === NEW v4.0 (B1-B6) ===
      analyzeSleepQuality(days, pIndex),                 // B1: –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ ‚Üí –º–µ—Ç—Ä–∏–∫–∏ —Å–ª–µ–¥. –¥–Ω—è
      analyzeWellbeing(days, pIndex),                    // B2: —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ ‚Üî –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏
      analyzeHydration(days),                            // B3: –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è (30ml/–∫–≥)
      analyzeBodyComposition(days, profile),             // B4: WHR —Ç—Ä–µ–Ω–¥
      analyzeCyclePatterns(days, pIndex, profile),       // B5: —Ü–∏–∫–ª (—Ñ–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è/–ª—é—Ç–µ–∏–Ω–æ–≤–∞—è)
      analyzeWeekendEffect(days, pIndex),                // B6: –≤—ã—Ö–æ–¥–Ω—ã–µ vs –±—É–¥–Ω–∏

      // === NEW v5.0 (C7-C12) ===
      analyzeNOVAQuality(days, pIndex),                  // C10: NOVA Quality Score (—É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞)
      analyzeTrainingRecovery(days),                     // C11: –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ + –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
      analyzeHypertrophy(days, profile),                 // C12: –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è + –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ–ª–∞
      analyzeMicronutrients(days, pIndex, profile),      // C7: –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã (–∂–µ–ª–µ–∑–æ, –º–∞–≥–Ω–∏–π, —Ü–∏–Ω–∫, –∫–∞–ª—å—Ü–∏–π)
      analyzeHeartHealth(days, pIndex),                  // C9: Na/K ratio + —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω
      analyzeOmegaBalance(days, pIndex),                 // C8: –æ–º–µ–≥–∞-6:3 –±–∞–ª–∞–Ω—Å + –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

      // === NEW v6.0 (C13-C22) ===
      analyzeVitaminDefense(days, profile),     // C13: Vitamin Defense Radar (11 vitamins)
      analyzeBComplexAnemia(days, profile),      // C22: B-Complex Energy & Anemia Risk
      analyzeGlycemicLoad(days, pIndex),         // C14: Glycemic Load Optimizer
      analyzeProteinDistribution(days, profile, pIndex), // C15: Protein Distribution
      analyzeAntioxidantDefense(days, pIndex), // C16: Antioxidant Defense Score
      analyzeAddedSugarDependency(days, pIndex), // C18: Added Sugar & Dependency
      analyzeBoneHealth(days, profile, pIndex), // C17: Bone Health Index
      analyzeTrainingTypeMatch(days, profile, pIndex), // C19: Training-Type Nutrition Match
      analyzeElectrolyteHomeostasis(days, pIndex), // C20: Electrolyte Homeostasis
      analyzeNutrientDensity(days, pIndex) // C21: Nutrient Density
    ]
      .flat() // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤—ã (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
      .filter(p => p != null)
      .reduce((acc, p) => {
        // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ pattern ID
        if (!acc.some(existing => existing.pattern === p.pattern)) {
          acc.push(p);
        } else {
          console.warn(`[HEYS.insights] ‚ö†Ô∏è Duplicate pattern detected and skipped: ${p.pattern}`);
        }
        return acc;
      }, [])
      .map(p => {
        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ available=false, –Ω–æ reason –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–ª–∏ –¥–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
        if (!p.available && !p.reason) {
          const msg = (p.message || p.insight || '').toLowerCase();
          if (msg.includes('–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö') || msg.includes('–º–∞–ª–æ –¥–Ω–µ–π')) {
            p.reason = 'insufficient_data';
          } else if (msg.includes('–Ω–µ—Ç –ø—Ä–∏—ë–º') || msg.includes('–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—ë–º')) {
            p.reason = 'no_meals';
          } else if (msg.includes('–Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤')) {
            p.reason = 'no_training';
          } else if (msg.includes('–Ω–µ—Ç —Å–Ω–∞') || msg.includes('–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–Ω–µ')) {
            p.reason = 'no_sleep';
          } else {
            p.reason = 'insufficient_data'; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π reason
          }
        }
        return p;
      });

    console.info(`[HEYS.insights] üìä v6.0 | daysBack=${daysBack}, days=${days.length}, patterns=${patterns.length}/41 possible (v6.0: +C13+C22+C14+C15+C16+C18+C17+C19+C20+C21)`,
      patterns.map(p => `${p.pattern || 'unknown_pattern'}:${p.score ?? 'n/a'}`));

    // Detailed unavailable patterns logging
    const unavailable = patterns.filter(p => !p.available);
    if (unavailable.length > 0) {
      console.group(`[HEYS.insights] ‚è∏Ô∏è –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (${unavailable.length}/${patterns.length})`);
      unavailable.forEach(p => {
        console.log(
          `‚îú‚îÄ ${p.pattern}:`,
          `reason="${p.reason || 'none'}"`,
          p.message ? `msg="${p.message}"` : ''
        );
      });
      console.groupEnd();
    }

    // Category distribution log
    const catCounts = patterns.reduce((acc, p) => {
      const meta = HEYS.InsightsPI?.patternDebugger?.PATTERN_METADATA?.[p.pattern];
      const cat = meta?.category || 'unknown';
      acc[cat] = (acc[cat] || 0) + 1;
      return acc;
    }, {});
    console.info(`[HEYS.insights] üìÇ Category counts:`, catCounts);

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º Health Score
    const healthScore = calculateHealthScore(patterns, profile);

    console.info(`[HEYS.insights] üéØ healthScore=${healthScore.total}, categories=`, healthScore.categories);

    // What-If Scenarios
    const whatIfScenarios = generateWhatIfScenarios(patterns, healthScore, days, profile);

    // Weight Prediction
    const weightPrediction = predictWeight(days, profile);

    // Weekly Wrap - —Å–∏–≥–Ω–∞—Ç—É—Ä–∞: (days, patterns, healthScore, weightPrediction)
    const weeklyWrap = generateWeeklyWrap(days, patterns, healthScore, weightPrediction, profile);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    const result = {
      available: true,
      daysAnalyzed: daysBack,
      daysWithData: days.length,
      confidence: Math.round(Math.min(100, (days.length / CONFIG.MIN_DAYS_FOR_FULL_ANALYSIS) * 100)),
      patterns,
      healthScore,
      whatIf: whatIfScenarios,
      weightPrediction,
      weeklyWrap,
      generatedAt: now
    };

    _cache = {
      data: result,
      clientId,
      daysBack,
      timestamp: now
    };

    return result;
  }

  // === HealthRingsGrid Component ===
  function HealthRingsGrid({ healthScore, compact, onCategoryClick, lsGet }) {
    if (!healthScore || !healthScore.breakdown) return null;

    // üÜï v3.22.0: –í—ã—á–∏—Å–ª—è–µ–º emotionalRisk –¥–ª—è Recovery overlay
    const emotionalRiskData = useMemo(() => {
      const U = window.HEYS?.utils;
      const getter = lsGet || U?.lsGet || ((k, d) => {
        try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
      });
      const profile = getter('heys_profile', {});
      const todayDate = new Date().toISOString().split('T')[0];
      const day = getter(`heys_dayv2_${todayDate}`, {});

      const stressAvg = day.stressAvg || 0;
      const factors = [];
      let bingeRisk = 0;

      if (stressAvg >= 6) { factors.push('–°—Ç—Ä–µ—Å—Å'); bingeRisk += 35; }
      else if (stressAvg >= 4) { factors.push('–°—Ç—Ä–µ—Å—Å'); bingeRisk += 15; }

      const hour = new Date().getHours();
      if (hour >= 20) bingeRisk += 20;

      const sleepDeficit = (profile.sleepHours || 8) - (day.sleepHours || 0);
      if (sleepDeficit > 2) { factors.push('–ù–µ–¥–æ—Å—ã–ø'); bingeRisk += 15; }

      return {
        hasRisk: bingeRisk >= 30,
        bingeRisk: Math.min(90, bingeRisk),
        factors,
        level: bingeRisk >= 60 ? 'high' : bingeRisk >= 40 ? 'medium' : 'low'
      };
    }, [lsGet]);

    const categories = [
      { key: 'nutrition', label: '–ü–∏—Ç–∞–Ω–∏–µ', color: '#22c55e', infoKey: 'CATEGORY_NUTRITION' },
      { key: 'timing', label: '–¢–∞–π–º–∏–Ω–≥', color: '#3b82f6', infoKey: 'CATEGORY_TIMING' },
      { key: 'activity', label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', color: '#f59e0b', infoKey: 'CATEGORY_ACTIVITY' },
      { key: 'recovery', label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', color: '#8b5cf6', infoKey: 'CATEGORY_RECOVERY' },
      { key: 'metabolism', label: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', color: '#f43f5e', infoKey: 'CATEGORY_METABOLISM' }
    ];

    // Compact mode: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
    if (compact) {
      return h('div', { className: 'insights-rings-compact' },
        categories.map(cat => {
          const score = healthScore.breakdown[cat.key]?.score || 0;
          const radius = 15;
          const circumference = 2 * Math.PI * radius;
          const offset = circumference - (score / 100) * circumference;

          // üÜï emotionalRisk overlay –¥–ª—è Recovery
          const hasEmotionalWarning = cat.key === 'recovery' && emotionalRiskData.hasRisk;

          // üé® –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è "—Å–≤–µ—Ç–æ—Ñ–æ—Ä" (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω)
          const getScoreColor = (s) => {
            if (s >= 80) return 'excellent'; // –ó–µ–ª–µ–Ω—ã–π
            if (s >= 60) return 'good';      // –ñ–µ–ª—Ç—ã–π
            if (s >= 40) return 'fair';      // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            return 'poor';                   // –ö—Ä–∞—Å–Ω—ã–π
          };

          return h('div', {
            key: cat.key,
            className: 'insights-ring-mini-wrapper'
          },
            // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–µ—Ä—Ö—É (–±–µ–∑ info-–∫–Ω–æ–ø–∫–∏)
            h('div', { className: 'insights-ring-mini-header' },
              h('span', { className: 'insights-ring-mini-header__name' }, cat.label)
            ),
            // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–ª—å—Ü–æ–º + —Ü–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
            h('div', {
              className: `insights-ring-mini insights-ring-mini--${cat.key} insights-ring-mini--${getScoreColor(score)} ${hasEmotionalWarning ? 'insights-ring-mini--warning' : ''}`,
              onClick: () => onCategoryClick && onCategoryClick(cat.key)
            },
              // Mini ring (36x36)
              h('div', { className: 'insights-ring-mini__ring' },
                h('svg', { width: 36, height: 36, viewBox: '0 0 36 36' },
                  h('circle', {
                    cx: 18, cy: 18, r: radius,
                    fill: 'none',
                    stroke: 'rgba(0,0,0,0.06)',
                    strokeWidth: 3
                  }),
                  h('circle', {
                    cx: 18, cy: 18, r: radius,
                    fill: 'none',
                    stroke: hasEmotionalWarning ? '#f87171' : cat.color,
                    strokeWidth: 3,
                    strokeLinecap: 'round',
                    strokeDasharray: circumference,
                    strokeDashoffset: offset,
                    style: { transition: 'stroke-dashoffset 0.8s ease' }
                  })
                ),
                h('span', { className: 'insights-ring-mini__value' }, Math.round(score)),
                hasEmotionalWarning && h('span', {
                  className: 'insights-ring-mini__badge',
                  title: `–≠–º–æ—Ü. —Ä–∏—Å–∫: ${emotionalRiskData.bingeRisk}%\n${emotionalRiskData.factors.join(', ')}`
                }, 'üß†')
              ),
              // Status (–∫–æ—Ä–æ—Ç–∫–∏–π —ç–º–æ–¥–∑–∏)
              h('div', { className: 'insights-ring-mini__status' },
                hasEmotionalWarning
                  ? '‚ö†Ô∏è'
                  : score >= 80 ? '‚úÖ' : score >= 60 ? 'üëç' : score >= 40 ? '‚ûñ' : '‚ö°'
              )
            ),
            // Info-–∫–Ω–æ–ø–∫–∞ —Å–Ω–∏–∑—É (–ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π)
            h('div', { className: 'insights-ring-mini-footer' },
              h(getInfoButton(), { infoKey: cat.infoKey, size: 'small' })
            )
          );
        })
      );
    }

    // Full mode: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–ª—å—Ü–∞
    return h('div', { className: 'insights-rings' },
      categories.map(cat =>
        h(HealthRing, {
          key: cat.key,
          score: healthScore.breakdown[cat.key]?.score,
          category: cat.key,
          label: cat.label,
          color: cat.key === 'recovery' && emotionalRiskData.hasRisk ? '#f87171' : cat.color,
          onClick: onCategoryClick,
          infoKey: cat.infoKey,
          debugData: healthScore.breakdown[cat.key],
          emotionalWarning: cat.key === 'recovery' ? emotionalRiskData : null
        })
      )
    );
  }

  // ============================================================
  // üß™ WHAT-IF SIMULATOR v1.0.0
  // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä: "–ß—Ç–æ –µ—Å–ª–∏ —è —Å—ä–µ–º X?"
  // ============================================================

  /**
   * Preset-–ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
   * –†–µ–∞–ª—å–Ω—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∏–∑ –±–∞–∑—ã –∏–ª–∏ —Ç–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   */
  const WHATIF_PRESETS = [
    // –ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–≤—ã—Å–æ–∫–∏–π GI, –∫–æ—Ä–æ—Ç–∫–∞—è —Å—ã—Ç–æ—Å—Ç—å)
    { id: 'pizza', name: '–ü–∏—Ü—Ü–∞', emoji: 'üçï', kcal: 400, prot: 15, carbs: 45, fat: 18, gi: 65, category: 'fast' },
    { id: 'chocolate', name: '–®–æ–∫–æ–ª–∞–¥', emoji: 'üç´', kcal: 250, prot: 3, carbs: 28, fat: 14, gi: 70, category: 'fast' },
    { id: 'cookie', name: '–ü–µ—á–µ–Ω—å–µ', emoji: 'üç™', kcal: 200, prot: 2, carbs: 30, fat: 8, gi: 75, category: 'fast' },
    { id: 'icecream', name: '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ', emoji: 'üç®', kcal: 250, prot: 3, carbs: 30, fat: 12, gi: 62, category: 'fast' },
    { id: 'soda', name: '–ì–∞–∑–∏—Ä–æ–≤–∫–∞ 330–º–ª', emoji: 'ü•§', kcal: 140, prot: 0, carbs: 35, fat: 0, gi: 90, category: 'fast' },

    // –ó–¥–æ—Ä–æ–≤—ã–µ –æ–ø—Ü–∏–∏ (–Ω–∏–∑–∫–∏–π GI, –≤—ã—Å–æ–∫–∏–π –±–µ–ª–æ–∫/–∫–ª–µ—Ç—á–∞—Ç–∫–∞)
    { id: 'salad', name: '–°–∞–ª–∞—Ç', emoji: 'ü•ó', kcal: 200, prot: 5, carbs: 15, fat: 12, gi: 25, fiber: 5, category: 'healthy' },
    { id: 'chicken', name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', emoji: 'üçó', kcal: 250, prot: 35, carbs: 0, fat: 10, gi: 0, category: 'healthy' },
    { id: 'eggs', name: '–Ø–π—Ü–∞ (2 —à—Ç)', emoji: 'ü•ö', kcal: 180, prot: 14, carbs: 1, fat: 12, gi: 0, category: 'healthy' },
    { id: 'cottage', name: '–¢–≤–æ—Ä–æ–≥', emoji: 'üßÄ', kcal: 180, prot: 25, carbs: 5, fat: 5, gi: 30, category: 'healthy' },
    { id: 'nuts', name: '–û—Ä–µ—Ö–∏ 50–≥', emoji: 'ü•ú', kcal: 300, prot: 10, carbs: 10, fat: 28, gi: 15, fiber: 4, category: 'healthy' },

    // –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –ø—Ä–∏—ë–º—ã
    { id: 'breakfast', name: '–û–≤—Å—è–Ω–∫–∞ + –±–∞–Ω–∞–Ω', emoji: 'ü•£', kcal: 350, prot: 10, carbs: 55, fat: 8, gi: 55, fiber: 6, category: 'meal' },
    { id: 'lunch', name: '–†–∏—Å + –∫—É—Ä–∏—Ü–∞ + —Å–∞–ª–∞—Ç', emoji: 'üç±', kcal: 500, prot: 35, carbs: 50, fat: 15, gi: 50, fiber: 5, category: 'meal' },
    { id: 'dinner', name: '–†—ã–±–∞ + –æ–≤–æ—â–∏', emoji: 'üêü', kcal: 400, prot: 30, carbs: 20, fat: 18, gi: 35, fiber: 8, category: 'meal' }
  ];

  /**
   * –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ preset-–æ–≤
   */
  const WHATIF_CATEGORIES = {
    fast: { name: '–ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã', emoji: '‚ö°', color: '#ef4444' },
    healthy: { name: '–ü–æ–ª–µ–∑–Ω—ã–µ –æ–ø—Ü–∏–∏', emoji: 'üíö', color: '#22c55e' },
    meal: { name: '–ü–æ–ª–Ω—ã–µ –ø—Ä–∏—ë–º—ã', emoji: 'üçΩÔ∏è', color: '#3b82f6' }
  };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç –µ–¥—ã (—Å–∏–º—É–ª—è—Ü–∏—è)
   * @param {Object} food - –ø—Ä–æ–¥—É–∫—Ç { kcal, prot, carbs, fat, gi, fiber }
   * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç { currentWave, currentRisk, dayTot, optimum, profile, trainings }
   * @returns {Object} —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–º—É–ª—è—Ü–∏–∏
   */
  function simulateFood(food, context) {
    const { currentWave, currentRisk, dayTot, optimum, profile, trainings } = context;

    // 1. –†–∞—Å—á—ë—Ç –Ω–æ–≤–æ–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
    const gl = ((food.gi || 50) * (food.carbs || 0)) / 100;
    const baseWaveHours = profile?.insulinWaveHours || 3;

    // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤–æ–ª–Ω—ã (–∏–∑ InsulinWave module)
    let waveMultiplier = 1.0;

    // GI –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    if (food.gi >= 70) waveMultiplier *= 1.2;
    else if (food.gi >= 55) waveMultiplier *= 1.1;
    else if (food.gi <= 35) waveMultiplier *= 0.85;

    // GL –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–ø–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è)
    const glMult = 0.15 + (Math.min(gl, 40) / 40) ** 0.6 * 1.15;
    waveMultiplier *= Math.min(1.3, Math.max(0.2, glMult));

    // –ë–µ–ª–æ–∫ —É–¥–ª–∏–Ω—è–µ—Ç (–∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
    if (food.prot >= 30) waveMultiplier *= 1.10;
    else if (food.prot >= 20) waveMultiplier *= 1.05;

    // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç
    if (food.fiber >= 8) waveMultiplier *= 0.85;
    else if (food.fiber >= 5) waveMultiplier *= 0.92;

    // –ñ–∏—Ä—ã —É–¥–ª–∏–Ω—è—é—Ç
    if (food.fat >= 20) waveMultiplier *= 1.10;
    else if (food.fat >= 10) waveMultiplier *= 1.05;

    // Activity Context (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞)
    let activityBonus = 0;
    if (trainings && trainings.length > 0) {
      const nowMin = new Date().getHours() * 60 + new Date().getMinutes();
      for (const t of trainings) {
        const tMin = parseInt((t.time || '').split(':')[0]) * 60 + parseInt((t.time || '').split(':')[1] || 0);
        const gap = Math.abs(nowMin - tMin);
        if (gap <= 120) {
          activityBonus = -0.25; // POST-workout
          break;
        }
      }
    }
    waveMultiplier *= (1 + activityBonus);

    const newWaveMinutes = Math.round(baseWaveHours * 60 * waveMultiplier);
    const newWaveEndTime = new Date(Date.now() + newWaveMinutes * 60 * 1000);
    const newWaveEndStr = newWaveEndTime.toTimeString().slice(0, 5);

    // 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–µ–π –≤–æ–ª–Ω–æ–π
    let waveImpact = 'neutral';
    let waveCompare = null;

    if (currentWave && currentWave.status !== 'lipolysis') {
      // –°–µ–π—á–∞—Å –≤–æ–ª–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–¥—ã –ø—Ä–æ–¥–ª–∏—Ç –µ—ë
      waveImpact = 'extends';
      waveCompare = {
        before: currentWave.remaining || 0,
        after: newWaveMinutes,
        diff: newWaveMinutes - (currentWave.remaining || 0)
      };
    } else if (currentWave && currentWave.status === 'lipolysis') {
      // –°–µ–π—á–∞—Å –ª–∏–ø–æ–ª–∏–∑ ‚Äî –µ–¥–∞ –ø—Ä–µ—Ä–≤—ë—Ç –µ–≥–æ
      waveImpact = 'interrupts';
      waveCompare = {
        lipolysisLost: currentWave.lipolysisMinutes || 0,
        newWaveMinutes
      };
    }

    // 3. –†–∞—Å—á—ë—Ç –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞
    const newDayKcal = (dayTot?.kcal || 0) + food.kcal;
    const newRatio = optimum ? newDayKcal / optimum : 1;

    let riskDelta = 0;
    let riskReason = null;

    // –†–∏—Å–∫ —Ä–∞—Å—Ç—ë—Ç –µ—Å–ª–∏:
    if (food.gi >= 70) {
      riskDelta += 8; // –í—ã—Å–æ–∫–∏–π GI ‚Üí –±—ã—Å—Ç—Ä—ã–π –≥–æ–ª–æ–¥ –ø–æ–∑–∂–µ
      riskReason = '–í—ã—Å–æ–∫–∏–π –ì–ò ‚Üí –±—ã—Å—Ç—Ä—ã–π –≥–æ–ª–æ–¥ —á–µ—Ä–µ–∑ 2-3—á';
    }
    if (newRatio > 1.1 && newRatio < 1.3) {
      riskDelta += 5; // –õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä ‚Üí –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å
    } else if (newRatio >= 1.3) {
      riskDelta += 15; // –°–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä ‚Üí —Å—Ç—Ä–µ—Å—Å –∏ "–¥–∞ –≥–æ—Ä–∏ –æ–Ω–æ –≤—Å—ë"
      riskReason = '–°–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π ‚Üí –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ä—ã–≤';
    }

    // –†–∏—Å–∫ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –µ—Å–ª–∏:
    if (food.prot >= 25 && food.gi <= 40) {
      riskDelta -= 10; // –ë–µ–ª–æ–∫ + –Ω–∏–∑–∫–∏–π GI = –¥–æ–ª–≥–∞—è —Å—ã—Ç–æ—Å—Ç—å
      riskReason = '–ú–Ω–æ–≥–æ –±–µ–ª–∫–∞ + –Ω–∏–∑–∫–∏–π –ì–ò ‚Üí –¥–æ–ª–≥–∞—è —Å—ã—Ç–æ—Å—Ç—å';
    }
    if (food.fiber >= 5) {
      riskDelta -= 5; // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ = —Å—ã—Ç–æ—Å—Ç—å
    }

    const newRisk = Math.min(100, Math.max(0, (currentRisk || 0) + riskDelta));

    // 4. –°–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–º—É–ª—è—Ü–∏–∏
    const advice = [];

    // –°–æ–≤–µ—Ç –ø—Ä–æ —Ç–∞–π–º–∏–Ω–≥
    if (currentWave && currentWave.status !== 'lipolysis' && currentWave.remaining >= 60) {
      advice.push({
        type: 'timing',
        icon: '‚è≥',
        text: `–ü–æ–¥–æ–∂–¥–∏ ${Math.round(currentWave.remaining / 60 * 10) / 10}—á –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–π –≤–æ–ª–Ω—ã`,
        priority: 1
      });
    }

    // –°–æ–≤–µ—Ç –ø—Ä–æ –∑–∞–º–µ–Ω—É
    if (food.gi >= 65 && food.category === 'fast') {
      const healthyAlt = WHATIF_PRESETS.find(p => p.category === 'healthy' && Math.abs(p.kcal - food.kcal) < 100);
      if (healthyAlt) {
        advice.push({
          type: 'alternative',
          icon: 'üí°',
          text: `–ó–∞–º–µ–Ω–∏ –Ω–∞ ${healthyAlt.emoji} ${healthyAlt.name} ‚Äî –≤–æ–ª–Ω–∞ –Ω–∞ ${Math.round((waveMultiplier - 0.85) / waveMultiplier * 100)}% –∫–æ—Ä–æ—á–µ`,
          priority: 2,
          altPreset: healthyAlt
        });
      }
    }

    // –°–æ–≤–µ—Ç –ø—Ä–æ –±–µ–ª–æ–∫
    if (food.prot < 15 && food.kcal >= 300) {
      advice.push({
        type: 'add_protein',
        icon: 'ü•ö',
        text: '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫ ‚Äî –¥–æ–ª—å—à–µ —Å—ã—Ç–æ—Å—Ç—å',
        priority: 3
      });
    }

    // –°–æ–≤–µ—Ç –ø—Ä–æ –∫–∞–ª–æ—Ä–∏–∏
    if (newRatio >= 1.3) {
      advice.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        text: '–ü–µ—Ä–µ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π! –†–∞—Å—Å–º–æ—Ç—Ä–∏ –º–µ–Ω—å—à—É—é –ø–æ—Ä—Ü–∏—é',
        priority: 0
      });
    } else if (newRatio >= 0.9 && newRatio <= 1.1) {
      advice.push({
        type: 'success',
        icon: '‚úÖ',
        text: '–ö–∞–ª–æ—Ä–∏–∏ –±—É–¥—É—Ç –≤ –Ω–æ—Ä–º–µ',
        priority: 4
      });
    }

    // 5. –°–∞—Ç–∏–∞—Ü–∏—è (–Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–æ–ª–≥–æ –±—É–¥–µ—Ç —Å—ã—Ç–æ)
    let satietyHours = 2; // –±–∞–∑–æ–≤–∞—è
    satietyHours += food.prot * 0.03; // +0.03—á –Ω–∞ –≥—Ä–∞–º–º –±–µ–ª–∫–∞
    satietyHours += (food.fiber || 0) * 0.05; // +0.05—á –Ω–∞ –≥—Ä–∞–º–º –∫–ª–µ—Ç—á–∞—Ç–∫–∏
    satietyHours -= (food.gi - 50) * 0.01; // -0.01—á –∑–∞ –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç GI –≤—ã—à–µ 50
    satietyHours = Math.max(1, Math.min(6, satietyHours));

    return {
      food,
      wave: {
        minutes: newWaveMinutes,
        hours: Math.round(newWaveMinutes / 60 * 10) / 10,
        endTime: newWaveEndStr,
        impact: waveImpact,
        compare: waveCompare,
        multiplier: waveMultiplier,
        gl
      },
      risk: {
        before: currentRisk || 0,
        after: newRisk,
        delta: riskDelta,
        reason: riskReason
      },
      calories: {
        add: food.kcal,
        newTotal: newDayKcal,
        ratio: Math.round(newRatio * 100),
        optimum
      },
      satiety: {
        hours: Math.round(satietyHours * 10) / 10,
        desc: satietyHours >= 4 ? '–î–æ–ª–≥–∞—è —Å—ã—Ç–æ—Å—Ç—å' : satietyHours >= 2.5 ? '–°—Ä–µ–¥–Ω—è—è —Å—ã—Ç–æ—Å—Ç—å' : '–ë—ã—Å—Ç—Ä–æ –∑–∞—Ö–æ—á–µ—Ç—Å—è –µ—Å—Ç—å'
      },
      advice: advice.sort((a, b) => a.priority - b.priority),
      verdict: newRatio <= 1.1 && riskDelta <= 0 ? 'good' : newRatio <= 1.2 && riskDelta <= 10 ? 'neutral' : 'bad'
    };
  }

  // === DEBUG HELPERS ===

  window.debugWeeklyWrap = () => {
    if (!HEYS.PredictiveInsights?.analyze) {
      console.error('‚ùå HEYS.PredictiveInsights.analyze not loaded');
      return null;
    }

    const lsGet = U.lsGet || ((k, d) => {
      try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; }
    });
    const analysis = HEYS.PredictiveInsights.analyze({ daysBack: 60, lsGet });
    return analysis?.weeklyWrap || null;
  };

  window.debugABTest = () => {
    if (!HEYS.Metabolic?.getABStats) {
      console.error('‚ùå HEYS.Metabolic.getABStats not loaded');
      return null;
    }

    const stats = HEYS.Metabolic.getABStats();
    const variant = HEYS.Metabolic.getABVariant();
    const weights = HEYS.Metabolic.getABWeights();

    console.group('üìä A/B Test Results');
    // console.log('üéØ Current Variant:', variant.id, '-', variant.name);
    // console.log('‚öñÔ∏è Weights:', weights);
    // console.log('üìà Stats:', stats);

    if (Object.keys(stats.variantStats).length > 0) {
      console.table(stats.variantStats);
      // console.log('üèÜ Best Variant (by F1):', stats.bestVariant);
    } else {
      // console.log('‚è≥ Not enough data yet');
    }
    console.groupEnd();

    return { variant, weights, stats };
  };

  // === EXPORT HEYS.PredictiveInsights ===
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ –º–æ–¥—É–ª–µ–π InsightsPI.* –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–µ—Ç—Ç–µ—Ä—ã –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ (UI –º–æ–¥—É–ª–∏ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –∏–∑-–∑–∞ React CDN)

  HEYS.PredictiveInsights = HEYS.PredictiveInsights || {};

  // === –≠–∫—Å–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π ===
  // analyze() ‚Äî –≥–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  HEYS.PredictiveInsights.analyze = analyze;

  // clearCache() ‚Äî –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∞–Ω–∞–ª–∏–∑–∞
  HEYS.PredictiveInsights.clearCache = function () {
    _cache = {};
    // console.log('[PI] Cache cleared');
  };

  // getDaysData() ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π
  HEYS.PredictiveInsights.getDaysData = getDaysData;

  // –ü–∞—Ç—Ç–µ—Ä–Ω-–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã (–¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ HEYS.InsightsPI.patterns –µ—Å–ª–∏ –µ—Å—Ç—å)
  HEYS.PredictiveInsights.analyzeMealTiming = analyzeMealTiming;
  HEYS.PredictiveInsights.analyzeWaveOverlap = analyzeWaveOverlap;
  HEYS.PredictiveInsights.analyzeLateEating = analyzeLateEating;
  HEYS.PredictiveInsights.analyzeMealQualityTrend = analyzeMealQualityTrend;
  HEYS.PredictiveInsights.analyzeSleepWeight = analyzeSleepWeight;
  HEYS.PredictiveInsights.analyzeSleepHunger = analyzeSleepHunger;
  HEYS.PredictiveInsights.analyzeTrainingKcal = analyzeTrainingKcal;
  HEYS.PredictiveInsights.analyzeStepsWeight = analyzeStepsWeight;
  HEYS.PredictiveInsights.analyzeProteinSatiety = analyzeProteinSatiety;
  HEYS.PredictiveInsights.analyzeFiberRegularity = analyzeFiberRegularity;
  HEYS.PredictiveInsights.analyzeStressEating = analyzeStressEating;
  HEYS.PredictiveInsights.analyzeMoodFood = analyzeMoodFood;
  HEYS.PredictiveInsights.analyzeCircadianTiming = analyzeCircadianTiming;
  HEYS.PredictiveInsights.analyzeNutrientTiming = analyzeNutrientTiming;
  HEYS.PredictiveInsights.analyzeInsulinSensitivity = analyzeInsulinSensitivity;
  HEYS.PredictiveInsights.analyzeGutHealth = analyzeGutHealth;

  // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  HEYS.PredictiveInsights.calculateHealthScore = calculateHealthScore;
  HEYS.PredictiveInsights.generateWhatIfScenarios = generateWhatIfScenarios;
  HEYS.PredictiveInsights.predictWeight = predictWeight;
  HEYS.PredictiveInsights.generateWeeklyWrap = generateWeeklyWrap;

  // –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã
  HEYS.PredictiveInsights.pearsonCorrelation = pearsonCorrelation;
  HEYS.PredictiveInsights.calculateTrend = calculateTrend;
  HEYS.PredictiveInsights.average = average;
  HEYS.PredictiveInsights.stdDev = stdDev;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  HEYS.PredictiveInsights.VERSION = CONFIG.VERSION;
  HEYS.PredictiveInsights.CONFIG = CONFIG;
  HEYS.PredictiveInsights.PATTERNS = PATTERNS;
  HEYS.PredictiveInsights.PRIORITY_LEVELS = PRIORITY_LEVELS;
  HEYS.PredictiveInsights.CATEGORIES = CATEGORIES;
  HEYS.PredictiveInsights.ACTIONABILITY = ACTIONABILITY;
  HEYS.PredictiveInsights.SCIENCE_INFO = SCIENCE_INFO;

  // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è SCIENCE_INFO
  HEYS.PredictiveInsights.getMetricPriority = getMetricPriority;
  HEYS.PredictiveInsights.getAllMetricsByPriority = getAllMetricsByPriority;
  HEYS.PredictiveInsights.getMetricsByCategory = getMetricsByCategory;
  HEYS.PredictiveInsights.getMetricsByActionability = getMetricsByActionability;
  HEYS.PredictiveInsights.getCriticalMetrics = getCriticalMetrics;
  HEYS.PredictiveInsights.getPriorityStats = getPriorityStats;

  // What-If —Ñ—É–Ω–∫—Ü–∏–∏
  HEYS.PredictiveInsights.simulateFood = simulateFood;
  HEYS.PredictiveInsights.WHATIF_PRESETS = WHATIF_PRESETS;
  HEYS.PredictiveInsights.WHATIF_CATEGORIES = WHATIF_CATEGORIES;

  // Analytics API —Ñ—É–Ω–∫—Ü–∏–∏ (–∏–∑ pi_analytics_api.js) - –ª–µ–Ω–∏–≤—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã –¥–ª—è load order
  const analyticsApiFunctions = [
    'calculateConfidenceScore', 'analyzeMetabolism', 'calculateCorrelationMatrix',
    'detectMetabolicPatterns', 'calculatePredictiveRisk', 'forecastEnergy',
    'calculateBayesianConfidence', 'calculateTimeLaggedCorrelations',
    'calculateGlycemicVariability', 'calculateAllostaticLoad',
    'detectEarlyWarningSignals', 'calculate2ProcessModel', 'analyticsAPI'
  ];

  analyticsApiFunctions.forEach(fnName => {
    Object.defineProperty(HEYS.PredictiveInsights, fnName, {
      get: function () {
        return HEYS.InsightsPI?.analyticsAPI?.[fnName] ||
          HEYS.InsightsPI?.[fnName] ||
          (typeof window !== 'undefined' && window[fnName]);
      },
      configurable: true,
      enumerable: true
    });
  });

  // console.log('[PI] ‚úÖ HEYS.PredictiveInsights functions exported (analyze, patterns, advanced, stats, analyticsAPI)');

  // –õ–µ–Ω–∏–≤—ã–π –≥–µ—Ç—Ç–µ—Ä –¥–ª—è components - —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ UI –º–æ–¥—É–ª–∏ –≤ –º–æ–º–µ–Ω—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è
  Object.defineProperty(HEYS.PredictiveInsights, 'components', {
    get: function () {
      const uiDashboard = HEYS.InsightsPI?.uiDashboard || {};
      const uiCards = HEYS.InsightsPI?.uiCards || {};
      const uiRings = HEYS.InsightsPI?.uiRings || {};
      const uiWhatIf = HEYS.InsightsPI?.uiWhatIf || {};

      return {
        // Dashboard components (from pi_ui_dashboard.js)
        ...uiDashboard,
        // Cards components (from pi_ui_cards.js)  
        ...uiCards,
        // Rings components (from pi_ui_rings.js)
        ...uiRings,
        // What-If components (from pi_ui_whatif.js)
        ...uiWhatIf,
        // Direct exports for legacy compatibility
        InsightsTab: uiDashboard?.InsightsTab,
        PredictiveDashboard: uiDashboard?.PredictiveDashboard,
        WeeklyWrap: uiCards?.WeeklyWrap || uiDashboard?.WeeklyWrap,
        WeeklyWrapCard: uiCards?.WeeklyWrapCard || uiDashboard?.WeeklyWrapCard,
        simulateFood,
        WHATIF_PRESETS,
        WHATIF_CATEGORIES
      };
    },
    configurable: true,
    enumerable: true
  });

  // console.log('[PI] ‚úÖ HEYS.PredictiveInsights.components getter configured (lazy loading)');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_phenotype_v1.js ===== */
// heys_phenotype_v1.js ‚Äî –ú–æ–¥—É–ª—å –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Ñ–µ–Ω–æ—Ç–∏–ø–∞
// v1.1.0 ‚Äî –û—Ç–¥–µ–ª—å–Ω–∞—è expandable –∫–∞—Ä—Ç–æ—á–∫–∞ —Å radar chart
(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  const { createElement: h, useState, useMemo, useEffect } = React;
  
  // InfoButton –∏–∑ PredictiveInsights (lazy reference)
  const getInfoButton = () => HEYS.PredictiveInsights?.InfoButton || null;
  
  // === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–µ–Ω–æ—Ç–∏–ø–æ–≤ ===
  const PHENOTYPE_CONFIG = {
    sprinter: { 
      emoji: 'üèÉ', 
      color: '#ef4444', 
      gradient: 'linear-gradient(135deg, #ef4444 0%, #f97316 100%)',
      label: '–°–ø—Ä–∏–Ω—Ç–µ—Ä', 
      shortDesc: '–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
      desc: '–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º, –≤—ã—Å–æ–∫–∏–µ –ø–∏–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –≤–æ–ª–Ω—ã. –¢–µ–±–µ –Ω—É–∂–Ω—ã —á–∞—Å—Ç—ã–µ –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏.' 
    },
    marathoner: { 
      emoji: 'üèÉ‚Äç‚ôÇÔ∏è', 
      color: '#3b82f6', 
      gradient: 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)',
      label: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü', 
      shortDesc: '–°—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è',
      desc: '–°—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, –¥–ª–∏–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã, –æ—Ç–ª–∏—á–Ω–∞—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å. –ú–æ–∂–µ—à—å –µ—Å—Ç—å —Ä–µ–∂–µ, –Ω–æ –ø–ª–æ—Ç–Ω–µ–µ.' 
    },
    powerlifter: { 
      emoji: 'üèãÔ∏è', 
      color: '#8b5cf6', 
      gradient: 'linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)',
      label: '–°–∏–ª–æ–≤–∏–∫', 
      shortDesc: '–ú–æ—â–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
      desc: '–í—ã—Å–æ–∫–∞—è –º—ã—à–µ—á–Ω–∞—è –º–∞—Å—Å–∞, –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–æ–∫. –í–∞–∂–µ–Ω –±–µ–ª–æ–∫ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.' 
    },
    balanced: { 
      emoji: '‚öñÔ∏è', 
      color: '#22c55e', 
      gradient: 'linear-gradient(135deg, #22c55e 0%, #10b981 100%)',
      label: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', 
      shortDesc: '–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å',
      desc: '–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –±–µ–∑ —è—Ä–∫–∏—Ö –ø–µ—Ä–µ–∫–æ—Å–æ–≤. –ü–æ–¥—Ö–æ–¥–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è.' 
    },
    nightowl: { 
      emoji: 'ü¶â', 
      color: '#6366f1', 
      gradient: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
      label: '–°–æ–≤–∞', 
      shortDesc: '–í–µ—á–µ—Ä–Ω–∏–π –ø–∏–∫',
      desc: '–ü–æ–∑–¥–Ω–∏–π —Ö—Ä–æ–Ω–æ—Ç–∏–ø, –≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–µ—á–µ—Ä–æ–º. –ú–æ–∂–Ω–æ —Å–º–µ—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—ë–º—ã –±–ª–∏–∂–µ –∫ –≤–µ—á–µ—Ä—É.' 
    },
    earlybird: { 
      emoji: 'üê¶', 
      color: '#f59e0b', 
      gradient: 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)',
      label: '–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫', 
      shortDesc: '–£—Ç—Ä–µ–Ω–Ω–∏–π –ø–∏–∫',
      desc: '–†–∞–Ω–Ω–∏–π —Ö—Ä–æ–Ω–æ—Ç–∏–ø, –ø–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ —É—Ç—Ä–æ–º. –í–∞–∂–µ–Ω –ø–ª–æ—Ç–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫.' 
    }
  };

  // === Tier –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—É—Ä–æ–≤–Ω–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏) ===
  const TIER_CONFIG = {
    basic: { label: '–ë–∞–∑–æ–≤—ã–π', color: '#94a3b8', days: 0, icon: 'üå±' },
    developing: { label: '–†–∞–∑–≤–∏–≤–∞—é—â–∏–π—Å—è', color: '#f59e0b', days: 7, icon: 'üåø' },
    confident: { label: '–£–≤–µ—Ä–µ–Ω–Ω—ã–π', color: '#22c55e', days: 14, icon: 'üå≥' },
    expert: { label: '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π', color: '#8b5cf6', days: 30, icon: '‚≠ê' }
  };

  // === TRAITS –¥–ª—è Radar Chart ===
  const TRAITS = [
    { key: 'stability', label: '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', icon: 'üìä', color: '#22c55e', desc: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–æ–≤–Ω–æ –¥–µ—Ä–∂–∏—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è' },
    { key: 'recovery', label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', icon: 'üîÑ', color: '#3b82f6', desc: '–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å—Å—è –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–æ–∫' },
    { key: 'insulinSensitivity', label: '–ò–Ω—Å—É–ª–∏–Ω', icon: 'üíâ', color: '#f59e0b', desc: '–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º –∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –ø–∏–∫–∏' },
    { key: 'consistency', label: '–ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ', icon: 'üìà', color: '#ec4899', desc: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ —Å–ª–µ–¥—É–µ—à—å —Ä–µ–∂–∏–º—É' },
    { key: 'chronotype', label: '–•—Ä–æ–Ω–æ—Ç–∏–ø', icon: 'üïê', color: '#8b5cf6', desc: '–í—Ä–µ–º—è –ø–∏–∫–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä)' }
  ];

  /**
   * MiniRadar ‚Äî –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π radar chart –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
   */
  function MiniRadar({ data, color = '#8b5cf6', size = 80 }) {
    const center = size / 2;
    const radius = size / 2 - 8;
    const angleStep = (2 * Math.PI) / TRAITS.length;
    
    const points = TRAITS.map((trait, i) => {
      const value = (data[trait.key] || 50) / 100;
      const angle = -Math.PI / 2 + i * angleStep;
      return {
        x: center + Math.cos(angle) * radius * value,
        y: center + Math.sin(angle) * radius * value
      };
    });
    
    const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');
    
    return h('svg', { 
      viewBox: `0 0 ${size} ${size}`, 
      className: 'mini-radar',
      style: { width: size, height: size }
    },
      // Background circle
      h('circle', {
        cx: center, cy: center, r: radius,
        fill: 'none', stroke: '#e2e8f0', strokeWidth: 1
      }),
      // Data polygon
      h('polygon', {
        points: polygonPoints,
        fill: color,
        fillOpacity: 0.25,
        stroke: color,
        strokeWidth: 2
      }),
      // Points
      points.map((p, i) =>
        h('circle', {
          key: i, cx: p.x, cy: p.y, r: 2.5,
          fill: color
        })
      )
    );
  }

  /**
   * FullRadar ‚Äî –ü–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã–π radar chart –¥–ª—è expand-—Å–µ–∫—Ü–∏–∏
   */
  function FullRadar({ data, color = '#8b5cf6' }) {
    const size = 240;
    const center = size / 2;
    const radius = size / 2 - 40;
    const angleStep = (2 * Math.PI) / TRAITS.length;
    
    const points = TRAITS.map((trait, i) => {
      const value = (data[trait.key] || 50) / 100;
      const angle = -Math.PI / 2 + i * angleStep;
      return {
        x: center + Math.cos(angle) * radius * value,
        y: center + Math.sin(angle) * radius * value,
        value: data[trait.key] || 50,
        labelX: center + Math.cos(angle) * (radius + 28),
        labelY: center + Math.sin(angle) * (radius + 28),
        color: trait.color,
        label: trait.label
      };
    });
    
    const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');
    const gradientId = 'fullRadarGrad_' + Math.random().toString(36).substr(2, 9);
    
    return h('div', { className: 'full-radar' },
      h('svg', { viewBox: `0 0 ${size} ${size}`, className: 'full-radar__svg' },
        // Gradient
        h('defs', null,
          h('linearGradient', { id: gradientId, x1: '0%', y1: '0%', x2: '100%', y2: '100%' },
            h('stop', { offset: '0%', stopColor: '#8b5cf6', stopOpacity: '0.4' }),
            h('stop', { offset: '50%', stopColor: '#3b82f6', stopOpacity: '0.3' }),
            h('stop', { offset: '100%', stopColor: '#22c55e', stopOpacity: '0.4' })
          )
        ),
        
        // Background circles
        [0.25, 0.5, 0.75, 1].map((scale, idx) =>
          h('circle', {
            key: scale, cx: center, cy: center, r: radius * scale,
            fill: 'none',
            stroke: `rgba(139, 92, 246, ${0.15 + idx * 0.05})`,
            strokeWidth: idx === 3 ? 2 : 1,
            strokeDasharray: idx < 3 ? '4,4' : 'none'
          })
        ),
        
        // Axes
        TRAITS.map((_, i) => {
          const angle = -Math.PI / 2 + i * angleStep;
          return h('line', {
            key: i,
            x1: center, y1: center,
            x2: center + Math.cos(angle) * radius,
            y2: center + Math.sin(angle) * radius,
            stroke: 'rgba(139, 92, 246, 0.2)',
            strokeWidth: 1
          });
        }),
        
        // Data polygon
        h('polygon', {
          points: polygonPoints,
          fill: `url(#${gradientId})`,
          stroke: '#8b5cf6',
          strokeWidth: 2.5,
          strokeLinejoin: 'round'
        }),
        
        // Data points
        points.map((p, i) =>
          h('g', { key: i },
            h('circle', { cx: p.x, cy: p.y, r: 6, fill: p.color, fillOpacity: 0.2 }),
            h('circle', { cx: p.x, cy: p.y, r: 4, fill: p.color, stroke: '#fff', strokeWidth: 1.5 })
          )
        ),
        
        // Labels
        points.map((p, i) =>
          h('text', {
            key: i, x: p.labelX, y: p.labelY,
            textAnchor: 'middle', dominantBaseline: 'middle',
            fontSize: 10, fontWeight: 600, fill: '#64748b'
          }, `${p.label}`)
        )
      ),
      
      // Legend
      h('div', { className: 'full-radar__legend' },
        TRAITS.map((trait, i) =>
          h('div', { key: i, className: 'full-radar__legend-item' },
            h('span', { 
              className: 'full-radar__legend-dot',
              style: { background: trait.color }
            }),
            h('span', { className: 'full-radar__legend-label' }, trait.label),
            h('span', { className: 'full-radar__legend-value' }, 
              `${data[trait.key] || 50}%`
            )
          )
        )
      )
    );
  }

  /**
   * usePhenotype ‚Äî Hook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–µ–Ω–æ—Ç–∏–ø–∞
   * –ú–∞–ø–ø–∏—Ç API HEYS.Metabolic.identifyPhenotype –Ω–∞ UI —Ñ–æ—Ä–º–∞—Ç
   */
  function usePhenotype(profile) {
    return useMemo(() => {
      if (!HEYS.Metabolic?.identifyPhenotype) {
        return { available: false, daysRequired: 7, daysAvailable: 0 };
      }
      
      try {
        const history = HEYS.Metabolic.getDaysHistory ? HEYS.Metabolic.getDaysHistory(90) : [];
        const result = HEYS.Metabolic.identifyPhenotype(
          history,
          profile || window.HEYS?.utils?.lsGet?.('heys_profile', {})
        );
        
        if (!result || !result.available) {
          return result;
        }
        
        // –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–∞ —Ñ–µ–Ω–æ—Ç–∏–ø–∞ (API ‚Üí UI)
        const phenotypeMap = {
          'balanced': 'balanced',
          'carb_preferring': 'sprinter',    // –£–≥–ª–µ–≤–æ–¥–Ω—ã–π ‚Üí –°–ø—Ä–∏–Ω—Ç–µ—Ä
          'fat_preferring': 'marathoner',   // –ñ–∏—Ä–æ–≤–æ–π ‚Üí –ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü  
          'protein_efficient': 'powerlifter' // –ë–µ–ª–∫–æ–≤—ã–π ‚Üí –°–∏–ª–æ–≤–∏–∫
        };
        
        // –ú–∞–ø–ø–∏–Ω–≥ tier (API ‚Üí UI)
        const tierMap = {
          'basic': 'basic',
          'standard': 'developing',
          'advanced': 'confident'
        };
        
        return {
          ...result,
          // –ú–∞–ø–ø–∏–Ω–≥ type –¥–ª—è UI –∫–æ–Ω—Ñ–∏–≥–∞
          type: phenotypeMap[result.phenotype] || 'balanced',
          // –ú–∞–ø–ø–∏–Ω–≥ tier –¥–ª—è UI –∫–æ–Ω—Ñ–∏–≥–∞
          tier: tierMap[result.tier] || 'basic',
          // –ú–∞–ø–ø–∏–Ω–≥ radarData ‚Üí traits –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          traits: result.radarData || {
            stability: 50,
            recovery: 50,
            insulinSensitivity: 50,
            consistency: 50,
            chronotype: 50
          },
          // Confidence –∫–∞–∫ —á–∏—Å–ª–æ (0-100)
          confidence: Math.round((result.confidence || 0.5) * 100),
          // Strengths/weaknesses
          strengths: result.strengths || [],
          weaknesses: result.weaknesses || [],
          // Recommendations
          recommendations: result.recommendations || [],
          // Thresholds
          thresholds: result.personalThresholds || null,
          // Next tier info
          nextTier: result.nextTier ? {
            tier: tierMap[result.nextTier.name] || result.nextTier.name,
            daysNeeded: result.nextTier.daysNeeded,
            unlocks: result.nextTier.unlocks
          } : null
        };
      } catch (e) {
        console.error('[Phenotype] Error:', e);
        return { available: false, daysRequired: 7, daysAvailable: 0 };
      }
    }, [profile]);
  }

  /**
   * PhenotypeExpandableCard ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è expandable –∫–∞—Ä—Ç–æ—á–∫–∞ —Ñ–µ–Ω–æ—Ç–∏–ø–∞
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –º–∏–Ω–∏-—Ä–∞–¥–∞—Ä–æ–º, –ø–æ –∫–ª–∏–∫—É —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –¥–µ—Ç–∞–ª—è–º–∏
   */
  function PhenotypeExpandableCard({ profile }) {
    const [expanded, setExpanded] = useState(false);
    const phenotype = usePhenotype(profile);
    
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º empty state
    if (!phenotype || !phenotype.available) {
      const progress = Math.round(((phenotype?.daysAvailable || 0) / (phenotype?.daysRequired || 7)) * 100);
      
      return h('div', { className: 'phenotype-expandable-card phenotype-expandable-card--empty' },
        h('div', { className: 'phenotype-expandable-card__header' },
          h('div', { className: 'phenotype-expandable-card__icon' }, 'üß¨'),
          h('div', { className: 'phenotype-expandable-card__title-block' },
            h('div', { className: 'phenotype-expandable-card__title' }, '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø'),
            h('div', { className: 'phenotype-expandable-card__subtitle' }, 
              `–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è... ${phenotype?.daysAvailable || 0}/${phenotype?.daysRequired || 7} –¥–Ω–µ–π`
            )
          ),
          h('div', { className: 'phenotype-expandable-card__progress-mini' },
            h('div', { 
              className: 'phenotype-expandable-card__progress-fill',
              style: { width: `${progress}%` }
            })
          )
        )
      );
    }
    
    const config = PHENOTYPE_CONFIG[phenotype.type] || PHENOTYPE_CONFIG.balanced;
    const tier = TIER_CONFIG[phenotype.tier] || TIER_CONFIG.basic;
    const confidence = phenotype.confidence || 50;
    
    return h('div', { 
      className: `phenotype-expandable-card ${expanded ? 'phenotype-expandable-card--expanded' : ''}`,
      style: { '--phenotype-color': config.color }
    },
      // Header (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–π)
      h('div', { 
        className: 'phenotype-expandable-card__header',
        onClick: () => setExpanded(!expanded)
      },
        // Left: Emoji + Type + InfoButton
        h('div', { className: 'phenotype-expandable-card__left' },
          h('div', { 
            className: 'phenotype-expandable-card__emoji',
            style: { background: config.gradient }
          }, config.emoji),
          h('div', { className: 'phenotype-expandable-card__title-block' },
            h('div', { className: 'phenotype-expandable-card__title-row' },
              h('span', null, config.label),
              // InfoButton —Ä—è–¥–æ–º —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
              getInfoButton() && h(getInfoButton(), { infoKey: 'PHENOTYPE', size: 'small' })
            ),
            h('div', { className: 'phenotype-expandable-card__subtitle' }, config.shortDesc)
          )
        ),
        
        // Center: Mini radar
        h('div', { className: 'phenotype-expandable-card__center' },
          h(MiniRadar, { data: phenotype.traits || {}, color: config.color, size: 56 })
        ),
        
        // Right: Tier + Arrow
        h('div', { className: 'phenotype-expandable-card__right' },
          h('div', { 
            className: 'phenotype-expandable-card__tier',
            style: { background: tier.color }
          }, tier.icon),
          h('div', { 
            className: `phenotype-expandable-card__arrow ${expanded ? 'phenotype-expandable-card__arrow--up' : ''}`
          }, expanded ? '‚ñ≤' : '‚ñº')
        )
      ),
      
      // Expand content
      expanded && h('div', { className: 'phenotype-expandable-card__content' },
        // Description
        h('div', { className: 'phenotype-expandable-card__desc' }, config.desc),
        
        // Confidence bar
        h('div', { className: 'phenotype-expandable-card__confidence' },
          h('div', { className: 'phenotype-expandable-card__confidence-row' },
            h('span', null, `${tier.icon} ${tier.label}`),
            h('span', null, `${confidence}% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å`)
          ),
          h('div', { className: 'phenotype-expandable-card__confidence-bar' },
            h('div', { 
              className: 'phenotype-expandable-card__confidence-fill',
              style: { width: `${confidence}%`, background: config.gradient }
            })
          )
        ),
        
        // Full Radar —Å InfoButton
        h('div', { className: 'phenotype-expandable-card__radar' },
          h('div', { className: 'phenotype-expandable-card__section-header' },
            h('span', null, 'üìä –ü—Ä–æ—Ñ–∏–ª—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞'),
            getInfoButton() && h(getInfoButton(), { infoKey: 'PHENOTYPE_TRAITS', size: 'small' })
          ),
          h(FullRadar, { data: phenotype.traits || {}, color: config.color })
        ),
        
        // Thresholds —Å InfoButton
        phenotype.thresholds && h('div', { className: 'phenotype-expandable-card__thresholds' },
          h('div', { className: 'phenotype-expandable-card__section-header' },
            h('span', null, 'üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏'),
            getInfoButton() && h(getInfoButton(), { infoKey: 'PHENOTYPE_THRESHOLDS', size: 'small' })
          ),
          h('div', { className: 'phenotype-expandable-card__threshold-grid' },
            phenotype.thresholds.optimalKcalRange && h('div', { className: 'phenotype-expandable-card__threshold' },
              h('span', { className: 'phenotype-expandable-card__threshold-icon' }, 'üî•'),
              h('span', { className: 'phenotype-expandable-card__threshold-value' }, 
                `${phenotype.thresholds.optimalKcalRange[0]}‚Äì${phenotype.thresholds.optimalKcalRange[1]} –∫–∫–∞–ª`
              )
            ),
            phenotype.thresholds.waveHours && h('div', { className: 'phenotype-expandable-card__threshold' },
              h('span', { className: 'phenotype-expandable-card__threshold-icon' }, 'üåä'),
              h('span', { className: 'phenotype-expandable-card__threshold-value' }, `${phenotype.thresholds.waveHours}—á –≤–æ–ª–Ω–∞`)
            ),
            phenotype.thresholds.mealGap && h('div', { className: 'phenotype-expandable-card__threshold' },
              h('span', { className: 'phenotype-expandable-card__threshold-icon' }, '‚è∞'),
              h('span', { className: 'phenotype-expandable-card__threshold-value' }, `${phenotype.thresholds.mealGap}—á –ø–µ—Ä–µ—Ä—ã–≤`)
            )
          )
        ),
        
        // Strengths & Weaknesses
        (phenotype.strengths?.length > 0 || phenotype.weaknesses?.length > 0) && 
          h('div', { className: 'phenotype-expandable-card__lists' },
            phenotype.strengths?.length > 0 && h('div', { className: 'phenotype-expandable-card__list' },
              h('div', { className: 'phenotype-expandable-card__list-title' }, 'üí™ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã'),
              phenotype.strengths.slice(0, 3).map((s, i) =>
                h('div', { key: i, className: 'phenotype-expandable-card__list-item phenotype-expandable-card__list-item--good' }, 
                  h('span', null, '‚úì'),
                  typeof s === 'string' ? s : s.text || ''
                )
              )
            ),
            phenotype.weaknesses?.length > 0 && h('div', { className: 'phenotype-expandable-card__list' },
              h('div', { className: 'phenotype-expandable-card__list-title' }, '‚ö†Ô∏è –ó–æ–Ω—ã —Ä–æ—Å—Ç–∞'),
              phenotype.weaknesses.slice(0, 3).map((w, i) =>
                h('div', { key: i, className: 'phenotype-expandable-card__list-item phenotype-expandable-card__list-item--warn' }, 
                  h('span', null, '‚Ä¢'),
                  typeof w === 'string' ? w : w.text || ''
                )
              )
            )
          ),
        
        // Recommendations
        phenotype.recommendations?.length > 0 && h('div', { className: 'phenotype-expandable-card__recommendations' },
          h('div', { className: 'phenotype-expandable-card__section-title' }, 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'),
          phenotype.recommendations.slice(0, 3).map((rec, i) =>
            h('div', { key: i, className: 'phenotype-expandable-card__rec' },
              h('span', { className: 'phenotype-expandable-card__rec-num' }, i + 1),
              h('span', null, typeof rec === 'string' ? rec : rec.text || '')
            )
          )
        ),
        
        // Next tier
        phenotype.nextTier && phenotype.nextTier.daysNeeded > 0 && h('div', { className: 'phenotype-expandable-card__next-tier' },
          h('span', { className: 'phenotype-expandable-card__next-tier-text' },
            `üîì –ß–µ—Ä–µ–∑ ${phenotype.nextTier.daysNeeded} –¥–Ω–µ–π ‚Äî ${TIER_CONFIG[phenotype.nextTier.tier]?.label || '–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å'}`
          )
        )
      )
    );
  }

  // === Legacy exports –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ===
  // (–°—Ç–∞—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
  function PhenotypeWidget({ profile }) {
    return h(PhenotypeExpandableCard, { profile });
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.Phenotype = {
    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    PhenotypeExpandableCard,
    
    // Legacy (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    PhenotypeWidget,
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
    MiniRadar,
    FullRadar,
    usePhenotype,
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    CONFIG: PHENOTYPE_CONFIG,
    TIERS: TIER_CONFIG,
    TRAITS,
    
    // –í–µ—Ä—Å–∏—è
    VERSION: '1.1.0'
  };
  
  // Verbose init log removed
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_metabolic_intelligence_v1.js ===== */
// heys_metabolic_intelligence_v1.js ‚Äî Metabolic Intelligence Module v1.0.1
// META-–≤–µ—Ä—Å–∏—è: –ø–æ–ª–Ω–∞—è –Ω–∞—É—á–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è
// –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: HEYS.InsulinWave, HEYS.PredictiveInsights, HEYS.ratioZones, U.lsGet/lsSet
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // === HELPER: localStorage —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π clientId namespace ===
  // –í–ê–ñ–ù–û: –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Å clientId prefix: heys_${clientId}_dayv2_2025-12-15
  function getScopedLsGet() {
    // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º HEYS.utils.lsGet –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò, —Ç.–∫. –º–æ–¥—É–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ core
    const dynamicLsGet = HEYS.utils?.lsGet;
    if (dynamicLsGet) return dynamicLsGet;

    // Fallback —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π clientId
    return function (key, defaultVal) {
      try {
        // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ HEYS.store.get –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç clientId
        if (window.HEYS?.store?.get) {
          return window.HEYS.store.get(key, defaultVal);
        }
        // Fallback: –ø—Ä–æ–±—É–µ–º —Å clientId prefix –¥–ª—è client-specific –∫–ª—é—á–µ–π
        const clientId = localStorage.getItem('heys_client_current');
        const isClientKey = key.includes('dayv2_') || key === 'heys_profile' ||
          key === 'heys_products' || key === 'heys_norms';
        if (clientId && isClientKey) {
          const scopedKey = `heys_${clientId}_${key.replace('heys_', '')}`;
          const val = localStorage.getItem(scopedKey);
          if (val) return JSON.parse(val);
        }
        // Last resort: –±–µ–∑ prefix
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : defaultVal;
      } catch (e) {
        return defaultVal;
      }
    };
  }

  // === –ö–û–ù–°–¢–ê–ù–¢–´ ===
  const CONFIG = {
    VERSION: '1.1.0', // v1.1.0 ‚Äî Progressive phenotype disclosure
    CACHE_TTL_MS: 2 * 60 * 1000, // 2 –º–∏–Ω—É—Ç—ã
    MAX_HISTORY_DAYS: 90,
    // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è —Ñ–µ–Ω–æ—Ç–∏–ø–∞
    PHENOTYPE_TIERS: {
      BASIC: 7,        // –ë–∞–∑–æ–≤—ã–π —Ñ–µ–Ω–æ—Ç–∏–ø (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ)
      STANDARD: 14,    // + –ü–æ—Ä–æ–≥–∏ + –°–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
      ADVANCED: 30     // + –ü–æ–ª–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    },
    MIN_DATA_FOR_PHENOTYPE: 7, // –ú–∏–Ω–∏–º—É–º –¥–ª—è –ø–æ–∫–∞–∑–∞ (–±—ã–ª–æ 30)
    FEATURE_FLAG_KEY: 'heys_feature_metabolic_intelligence',
    SMOOTHING_ALPHA: 0.3, // EMA —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
    MAX_SCORE_CHANGE_PER_UPDATE: 15, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ score –∑–∞ —Ä–∞–∑

    // –ü–æ—Ä–æ–≥–∏ —Ä–∏—Å–∫–∞ (—Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º)
    RISK_THRESHOLDS: {
      low: { enter: 30, exit: 25 },
      medium: { enter: 60, exit: 55 },
      high: { enter: 85, exit: 80 }
    },

    // üÜï A/B Testing Config
    AB_TESTING: {
      enabled: true,
      variants: {
        // –í–∞—Ä–∏–∞–Ω—Ç A: —Ç–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ (default)
        A: {
          id: 'A',
          name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞',
          weights: {
            currentRisk: 0.6,
            sleepDebt: 25,
            weekend: 20,
            chronicDeficit: 30,
            historical: 15
          }
        },
        // –í–∞—Ä–∏–∞–Ω—Ç B: —É—Å–∏–ª–µ–Ω–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Å–Ω–µ
        B: {
          id: 'B',
          name: 'Sleep-focused',
          weights: {
            currentRisk: 0.5,
            sleepDebt: 35,
            weekend: 15,
            chronicDeficit: 25,
            historical: 15
          }
        },
        // –í–∞—Ä–∏–∞–Ω—Ç C: —É—Å–∏–ª–µ–Ω–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ
        C: {
          id: 'C',
          name: 'Deficit-focused',
          weights: {
            currentRisk: 0.55,
            sleepDebt: 20,
            weekend: 20,
            chronicDeficit: 40,
            historical: 10
          }
        }
      },
      storageKey: 'heys_ab_variant',
      resultsKey: 'heys_ab_results'
    }
  };

  // === –ù–ê–£–ß–ù–´–ï –ë–ê–ó–û–í–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø ===
  const BASELINE = {
    // –ë–∞–∑–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã (—á–∞—Å—ã)
    WAVE_DURATION: 3,

    // –ü–æ—Ä–æ–≥–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏
    PROTEIN_MIN_G_PER_KG: 0.8,
    FIBER_MIN_G_PER_1000_KCAL: 14,
    SLEEP_OPTIMAL_HOURS: 8,
    WATER_MIN_ML_PER_KG: 30,
    STEPS_MIN: 8000,

    // –§–∞–∑—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ (—á–∞—Å—ã –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞)
    PHASES: {
      ANABOLIC: { from: 0, to: 3, label: '–ê–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è', emoji: 'üìà' },
      TRANSITIONAL: { from: 3, to: 5, label: '–ü–µ—Ä–µ—Ö–æ–¥–Ω–∞—è', emoji: '‚öñÔ∏è' },
      CATABOLIC: { from: 5, to: 24, label: '–ö–∞—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è', emoji: 'üî•' }
    }
  };

  // –ö—ç—à –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
  let _cache = {
    status: null,
    timestamp: 0,
    clientId: null,
    smoothedScore: null,
    lastRiskLevel: 'low'
  };

  // === PHASE 0: DATA INVENTORY ===

  /**
   * –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π
   * @param {string} dateStr - –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
   * @returns {Object} –æ–±—ä–µ–∫—Ç —Å —Ñ–ª–∞–≥–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
   */
  function inventoryData(dateStr) {
    const lsGet = getScopedLsGet();

    const day = lsGet(`heys_dayv2_${dateStr}`, {});
    const profile = lsGet('heys_profile', {});
    console.info('[HEYS.Metabolic] üîç inventoryData("' + dateStr + '") day keys:', Object.keys(day || {}), 'meals:', day?.meals?.length || 0);

    return {
      // –î–µ–Ω—å
      hasMeals: Boolean(day.meals && day.meals.length > 0),
      hasSleep: Boolean(day.sleepHours || (day.sleepStart && day.sleepEnd)),
      hasWeight: Boolean(day.weightMorning),
      hasWater: Boolean(day.waterMl),
      hasSteps: Boolean(day.steps),
      hasTrainings: Boolean(day.trainings && day.trainings.length > 0),
      hasStress: Boolean(day.stressAvg || (day.meals && day.meals.some(m => m.stress))),
      hasMood: Boolean(day.moodAvg || (day.meals && day.meals.some(m => m.mood))),

      // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
      hasDeficitPct: Boolean(typeof day.deficitPct === 'number'),
      hasCaloricDebt: Boolean(typeof day.caloricDebt === 'number'),
      hasRefeedDay: Boolean(day.isRefeedDay),

      // –ü—Ä–æ—Ñ–∏–ª—å
      hasProfile: Boolean(profile && profile.weight),
      hasGoal: Boolean(profile && profile.goal),

      // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
      date: dateStr,
      completeness: 0 // –ë—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –Ω–∏–∂–µ
    };
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö (0-100%)
   */
  function calculateDataCompleteness(inventory) {
    const weights = {
      hasMeals: 30,
      hasSleep: 15,
      hasWeight: 10,
      hasWater: 5,
      hasSteps: 10,
      hasTrainings: 5,
      hasStress: 5,
      hasMood: 5,
      hasProfile: 15
    };

    let score = 0;
    let maxScore = 0;

    for (const [key, weight] of Object.entries(weights)) {
      maxScore += weight;
      if (inventory[key]) score += weight;
    }

    return Math.round((score / maxScore) * 100);
  }

  // === PHASE 0: PLAN ADHERENCE ===

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å adherence –∫ –ø–ª–∞–Ω—É (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã –ø–æ –∫–∞–ª–æ—Ä–∏—è–º –∏ –º–∞–∫—Ä–æ—Å–∞–º)
   * @returns {Object} { score, reasons[], details }
   */
  function calculatePlanAdherence(dateStr, pIndex, profile) {
    const lsGet = getScopedLsGet();

    const day = lsGet(`heys_dayv2_${dateStr}`, {});
    const optimum = profile?.optimum || 2000;

    // –ü–æ–ª—É—á–∞–µ–º dayTot –∏ normAbs
    const dayTot = calculateDayTotals(day, pIndex);
    const normAbs = calculateNormAbs(profile, optimum);

    const reasons = [];
    let totalScore = 100;

    // 1. –ö–∞–ª–æ—Ä–∏–∏ (–≤–µ—Å: 30%)
    const ratio = dayTot.kcal / optimum;
    const ratioZone = HEYS.ratioZones?.getZone?.(ratio) || {};

    // Refeed Day ‚Äî –Ω–µ —à—Ç—Ä–∞—Ñ—É–µ–º
    if (day.isRefeedDay && ratio >= 0.9 && ratio <= 1.3) {
      reasons.push({
        id: 'refeed_day',
        pillar: 'nutrition',
        impact: 0,
        label: 'Refeed Day',
        short: '–û—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä',
        details: `Refeed day ‚Äî –∫–∞–ª–æ—Ä–∏–∏ –≤ –Ω–æ—Ä–º–µ —Ä–µ—Ñ–∏–¥–∞ (${Math.round(ratio * 100)}% –æ—Ç –æ–±—ã—á–Ω–æ–π –Ω–æ—Ä–º—ã)`,
        scientificBasis: '–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ—Ñ–∏–¥ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ'
      });
    } else {
      const caloriesPenalty = ratio < 0.75 ? 30 : ratio > 1.3 ? 25 : ratio < 0.85 ? 15 : ratio > 1.15 ? 15 : 0;
      if (caloriesPenalty > 0) {
        totalScore -= caloriesPenalty;
        reasons.push({
          id: 'calories_off',
          pillar: 'nutrition',
          impact: caloriesPenalty,
          label: ratio < 1 ? '–ù–µ–¥–æ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π' : '–ü–µ—Ä–µ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π',
          short: `${Math.round(ratio * 100)}% –æ—Ç –Ω–æ—Ä–º—ã`,
          details: `–°—ä–µ–¥–µ–Ω–æ ${Math.round(dayTot.kcal)} –∏–∑ ${optimum} –∫–∫–∞–ª`,
          scientificBasis: ratio < 0.75
            ? '–ì–ª—É–±–æ–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º (Rosenbaum & Leibel, 2010)'
            : '–ë–æ–ª—å—à–æ–π –ø—Ä–æ—Ñ–∏—Ü–∏—Ç –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É'
        });
      }
    }

    // 2. –ë–µ–ª–æ–∫ (–≤–µ—Å: 25%)
    const proteinMinG = (profile?.weight || 70) * BASELINE.PROTEIN_MIN_G_PER_KG;
    if (dayTot.prot < proteinMinG) {
      const proteinPenalty = dayTot.prot < proteinMinG * 0.5 ? 25 : 15;
      totalScore -= proteinPenalty;
      reasons.push({
        id: 'protein_low',
        pillar: 'nutrition',
        impact: proteinPenalty,
        label: '–ú–∞–ª–æ –±–µ–ª–∫–∞',
        short: `${Math.round(dayTot.prot)}–≥ –∏–∑ ${Math.round(proteinMinG)}–≥`,
        details: `–ë–µ–ª–æ–∫: ${Math.round(dayTot.prot)}–≥, –Ω–æ—Ä–º–∞: ‚â•${Math.round(proteinMinG)}–≥`,
        scientificBasis: '–ë–µ–ª–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—ã—à–µ—á–Ω—É—é –º–∞—Å—Å—É –∏ –Ω–∞—Å—ã—â–µ–Ω–∏–µ (Westerterp-Plantenga, 2008)'
      });
    }

    // 3. –ö–ª–µ—Ç—á–∞—Ç–∫–∞ (–≤–µ—Å: 15%)
    const fiberMinG = (dayTot.kcal / 1000) * BASELINE.FIBER_MIN_G_PER_1000_KCAL;
    if (dayTot.fiber < fiberMinG) {
      const fiberPenalty = 10;
      totalScore -= fiberPenalty;
      reasons.push({
        id: 'fiber_low',
        pillar: 'nutrition',
        impact: fiberPenalty,
        label: '–ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏',
        short: `${Math.round(dayTot.fiber)}–≥ –∏–∑ ${Math.round(fiberMinG)}–≥`,
        details: `–ö–ª–µ—Ç—á–∞—Ç–∫–∞: ${Math.round(dayTot.fiber)}–≥, –Ω–æ—Ä–º–∞: ‚â•${Math.round(fiberMinG)}–≥`,
        scientificBasis: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ —É–ª—É—á—à–∞–µ—Ç –Ω–∞—Å—ã—â–µ–Ω–∏–µ –∏ –∑–¥–æ—Ä–æ–≤—å–µ –ñ–ö–¢ (Makki et al., 2018)'
      });
    }

    // 4. –°–æ–Ω (–≤–µ—Å: 15%)
    const sleepHours = day.sleepHours || 0;
    const sleepNorm = profile?.sleepHours || BASELINE.SLEEP_OPTIMAL_HOURS;
    if (sleepHours < sleepNorm - 1) {
      const sleepPenalty = sleepHours < sleepNorm - 2 ? 20 : 10;
      totalScore -= sleepPenalty;
      reasons.push({
        id: 'sleep_debt',
        pillar: 'recovery',
        impact: sleepPenalty,
        label: '–ù–µ–¥–æ—Å—ã–ø',
        short: `${sleepHours}—á –∏–∑ ${sleepNorm}—á`,
        details: `–°–ø–∞–ª ${sleepHours}—á, –Ω–æ—Ä–º–∞: ${sleepNorm}—á`,
        scientificBasis: '–ù–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –≥—Ä–µ–ª–∏–Ω (–≥–æ–ª–æ–¥) –Ω–∞ 15-28% (Spiegel et al., 2004)'
      });
    }

    // 5. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–≤–µ—Å: 15%)
    if (day.steps < BASELINE.STEPS_MIN && (!day.trainings || day.trainings.length === 0)) {
      const activityPenalty = 10;
      totalScore -= activityPenalty;
      reasons.push({
        id: 'low_activity',
        pillar: 'activity',
        impact: activityPenalty,
        label: '–ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        short: `${day.steps || 0} —à–∞–≥–æ–≤`,
        details: `–®–∞–≥–∏: ${day.steps || 0}, –Ω–æ—Ä–º–∞: ‚â•${BASELINE.STEPS_MIN}`,
        scientificBasis: '–ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏ –∏ NEAT (Levine, 2004)'
      });
    }

    return {
      score: Math.max(0, Math.min(100, totalScore)),
      reasons,
      details: {
        calories: { actual: dayTot.kcal, target: optimum, ratio },
        protein: { actual: dayTot.prot, target: proteinMinG },
        fiber: { actual: dayTot.fiber, target: fiberMinG },
        sleep: { actual: sleepHours, target: sleepNorm }
      }
    };
  }

  // === PHASE 0: CRASH RISK ===

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ (0-100)
   * –§–∞–∫—Ç–æ—Ä—ã: –Ω–µ–¥–æ—Å—ã–ø, —Å—Ç—Ä–µ—Å—Å, –¥–µ—Ñ–∏—Ü–∏—Ç >3 –¥–Ω–µ–π, —Ç—Ä–∏–≥–≥–µ—Ä—ã
   */
  function calculateCrashRisk(dateStr, profile, history) {
    const lsGet = getScopedLsGet();

    const day = lsGet(`heys_dayv2_${dateStr}`, {});
    let riskScore = 0;
    const factors = [];

    // 1. –ù–µ–¥–æ—Å—ã–ø (+20-40)
    const sleepHours = day.sleepHours || 0;
    const sleepNorm = profile?.sleepHours || 8;
    const sleepDebt = sleepNorm - sleepHours;
    if (sleepDebt >= 3) {
      riskScore += 40;
      factors.push({
        id: 'sleep_debt_high',
        label: '–°–∏–ª—å–Ω—ã–π –Ω–µ–¥–æ—Å—ã–ø',
        impact: 40,
        details: `–ù–µ–¥–æ—Å—ã–ø ${sleepDebt}—á ‚Äî –ø–æ–≤—ã—à–µ–Ω —Ä–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è`
      });
    } else if (sleepDebt >= 2) {
      riskScore += 25;
      factors.push({
        id: 'sleep_debt_moderate',
        label: '–ù–µ–¥–æ—Å—ã–ø',
        impact: 25,
        details: `–ù–µ–¥–æ—Å—ã–ø ${sleepDebt}—á`
      });
    } else if (sleepDebt >= 1) {
      riskScore += 15;
      factors.push({
        id: 'sleep_debt_mild',
        label: '–õ—ë–≥–∫–∏–π –Ω–µ–¥–æ—Å—ã–ø',
        impact: 15,
        details: `–ù–µ–¥–æ—Å—ã–ø ${sleepDebt}—á`
      });
    }

    // 2. –°—Ç—Ä–µ—Å—Å (+15-30)
    const stress = day.stressAvg || 0;
    if (stress >= 7) {
      riskScore += 30;
      factors.push({
        id: 'stress_high',
        label: '–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å',
        impact: 30,
        details: `–°—Ç—Ä–µ—Å—Å ${stress}/10 ‚Äî —Ä–∏—Å–∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è`
      });
    } else if (stress >= 5) {
      riskScore += 15;
      factors.push({
        id: 'stress_moderate',
        label: '–°—Ä–µ–¥–Ω–∏–π —Å—Ç—Ä–µ—Å—Å',
        impact: 15,
        details: `–°—Ç—Ä–µ—Å—Å ${stress}/10`
      });
    }

    // 3. –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç (+20-35)
    const consecutiveDeficitDays = countConsecutiveDeficitDays(history);
    if (consecutiveDeficitDays >= 5) {
      riskScore += 35;
      factors.push({
        id: 'chronic_deficit',
        label: '–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç',
        impact: 35,
        details: `${consecutiveDeficitDays} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ ‚Äî –≤—ã—Å–æ–∫ —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞`
      });
    } else if (consecutiveDeficitDays >= 3) {
      riskScore += 20;
      factors.push({
        id: 'moderate_deficit',
        label: '–î–ª–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç',
        impact: 20,
        details: `${consecutiveDeficitDays} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ`
      });
    }

    // 4. –°–æ—Ü-—Ç—Ä–∏–≥–≥–µ—Ä—ã (+10-20)
    const dayOfWeek = new Date(dateStr).getDay();
    const isFridayOrWeekend = dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0;
    if (isFridayOrWeekend) {
      riskScore += 15;
      factors.push({
        id: 'weekend_trigger',
        label: '–í—ã—Ö–æ–¥–Ω—ã–µ',
        impact: 15,
        details: '–í—ã—Ö–æ–¥–Ω—ã–µ ‚Äî –ø–æ–≤—ã—à–µ–Ω —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞'
      });
    }

    // === –ü–û–ó–ò–¢–ò–í–ù–´–ï –§–ê–ö–¢–û–†–´ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Ö–æ—Ä–æ—à–æ) ===
    const positiveFactors = [];

    // –•–æ—Ä–æ—à–∏–π —Å–æ–Ω (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ >= –Ω–æ—Ä–º–∞)
    if (sleepHours > 0 && sleepHours >= sleepNorm) {
      positiveFactors.push({
        id: 'good_sleep',
        label: '–í—ã—Å–ø–∞–ª—Å—è',
        impact: -10,
        positive: true,
        details: `–°–æ–Ω ${sleepHours}—á ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –±–∞–∑–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è`
      });
    }

    // –ù–∏–∑–∫–∏–π —Å—Ç—Ä–µ—Å—Å (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω 1-3, –∏–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω = –Ω–µ—Ç —Å—Ç—Ä–µ—Å—Å–∞)
    if (stress <= 3) {
      positiveFactors.push({
        id: 'low_stress',
        label: stress > 0 ? '–ù–∏–∑–∫–∏–π —Å—Ç—Ä–µ—Å—Å' : '–ù–µ—Ç —Å—Ç—Ä–µ—Å—Å–∞',
        impact: -10,
        positive: true,
        details: stress > 0
          ? `–°—Ç—Ä–µ—Å—Å ${stress}/10 ‚Äî —Ö–æ—Ä–æ—à–∏–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω`
          : '–°—Ç—Ä–µ—Å—Å –Ω–µ –æ—Ç–º–µ—á–µ–Ω ‚Äî —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫!'
      });
    }

    // –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ (–Ω–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞)
    if (consecutiveDeficitDays === 0) {
      positiveFactors.push({
        id: 'stable_eating',
        label: '–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ',
        impact: -15,
        positive: true,
        details: '–ù–µ—Ç —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–µ—Å—Å–∞'
      });
    }

    // –ë—É–¥–Ω–∏–π –¥–µ–Ω—å (–º–µ–Ω—å—à–µ —Å–æ—Ü-—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤)
    if (!isFridayOrWeekend) {
      positiveFactors.push({
        id: 'weekday',
        label: '–ë—É–¥–Ω–∏–π –¥–µ–Ω—å',
        impact: -5,
        positive: true,
        details: '–ë—É–¥–Ω–∏–µ –¥–Ω–∏ ‚Äî –º–µ–Ω—å—à–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤'
      });
    }

    return {
      risk: Math.min(100, riskScore),
      factors,
      positiveFactors,
      level: riskScore < 30 ? 'low' : riskScore < 60 ? 'medium' : 'high'
    };
  }

  /**
   * –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ
   */
  function countConsecutiveDeficitDays(history) {
    if (!history || history.length === 0) return 0;

    let count = 0;
    for (const day of history) {
      if (day.ratio && day.ratio < 0.85) {
        count++;
      } else {
        break;
      }
    }
    return count;
  }

  // === PHASE 0: METABOLIC PHASE ===

  /**
   * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫—É—é —Ñ–∞–∑—É
   * @returns {Object} { phase, hoursInPhase, nextPhase, timeToLipolysis }
   */
  function calculateMetabolicPhase(dateStr) {
    const lsGet = getScopedLsGet();

    const day = lsGet(`heys_dayv2_${dateStr}`, {});
    const profile = lsGet('heys_profile', {});

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.InsulinWave.calculate() –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
    if (HEYS.InsulinWave && HEYS.InsulinWave.calculate && day.meals && day.meals.length > 0) {
      try {
        // üîß Fix: buildIndex —á–µ—Ä–µ–∑ dayUtils (HEYS.products.buildIndex –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
        const prods = HEYS.products?.getAll?.() || lsGet('heys_products', []);
        const pIndex = buildIdx ? buildIdx(prods) : { byId: new Map() };
        const getProductFromItem = (item, idx) => {
          if (!item) return null;
          // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ product_id
          if (item.product_id && idx?.byId?.get) {
            return idx.byId.get(item.product_id) || idx.byId.get(String(item.product_id));
          }
          // Fallback: –¥–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ item (—à—Ç–∞–º–ø)
          return item;
        };

        // üîß Fix: –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –¥–∞—Ç–∞ (–Ω–µ —Å–µ–≥–æ–¥–Ω—è), –ø–µ—Ä–µ–¥–∞—ë–º –∫–æ–Ω–µ—Ü —Ç–æ–≥–æ –¥–Ω—è –∫–∞–∫ "now"
        const today = HEYS.dayUtils?.todayISO?.() || new Date().toISOString().split('T')[0];
        const isFallback = dateStr !== today;
        let effectiveNow;
        if (isFallback) {
          // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º 23:59 —Ç–æ–≥–æ –¥–Ω—è (–∫–æ–Ω–µ—Ü –¥–Ω—è)
          effectiveNow = new Date(dateStr + 'T23:59:00');
        } else {
          effectiveNow = new Date();
        }

        const waveData = HEYS.InsulinWave.calculate({
          meals: day.meals,
          pIndex,
          getProductFromItem,
          baseWaveHours: profile.insulinWaveHours || 3,
          trainings: day.trainings || [],
          dayData: {
            ...day,
            profile,
            date: dateStr,
            lsGet
          },
          now: effectiveNow
        });

        if (waveData && waveData.status === 'lipolysis') {
          return {
            phase: 'catabolic',
            label: BASELINE.PHASES.CATABOLIC.label,
            emoji: BASELINE.PHASES.CATABOLIC.emoji,
            hoursInPhase: (waveData.lipolysisMinutes || 0) / 60,
            nextPhase: null,
            timeToLipolysis: 0,
            isLipolysis: true,
            details: '–õ–∏–ø–æ–ª–∏–∑ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ'
          };
        } else if (waveData) {
          const hoursRemaining = (waveData.remaining || 0) / 60;
          const phase = hoursRemaining > 2 ? 'anabolic' : 'transitional';

          return {
            phase,
            label: BASELINE.PHASES[phase.toUpperCase()].label,
            emoji: BASELINE.PHASES[phase.toUpperCase()].emoji,
            hoursInPhase: ((waveData.duration || 180) - (waveData.remaining || 0)) / 60,
            nextPhase: phase === 'anabolic' ? 'transitional' : 'catabolic',
            timeToLipolysis: Math.max(0, hoursRemaining),
            isLipolysis: false,
            details: `–î–æ –ª–∏–ø–æ–ª–∏–∑–∞: ${Math.round(waveData.remaining || 0)} –º–∏–Ω`
          };
        }
      } catch (e) {
        HEYS.analytics?.trackError?.('metabolic_phase_calculation_error', e);
      }
    }

    // Fallback: –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
    const lastMeal = getLastMealTime(day);
    if (!lastMeal) {
      return {
        phase: 'unknown',
        label: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
        emoji: '‚ùì',
        hoursInPhase: 0,
        nextPhase: null,
        timeToLipolysis: null,
        isLipolysis: false,
        details: '–ù–µ—Ç –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏'
      };
    }

    const now = new Date();
    const lastMealTime = new Date(lastMeal);
    const hoursSinceLastMeal = (now - lastMealTime) / (1000 * 60 * 60);

    let phase, nextPhase;
    if (hoursSinceLastMeal < 3) {
      phase = 'anabolic';
      nextPhase = 'transitional';
    } else if (hoursSinceLastMeal < 5) {
      phase = 'transitional';
      nextPhase = 'catabolic';
    } else {
      phase = 'catabolic';
      nextPhase = null;
    }

    const timeToLipolysis = Math.max(0, 5 - hoursSinceLastMeal);

    return {
      phase,
      label: BASELINE.PHASES[phase.toUpperCase()].label,
      emoji: BASELINE.PHASES[phase.toUpperCase()].emoji,
      hoursInPhase: hoursSinceLastMeal,
      nextPhase,
      timeToLipolysis,
      isLipolysis: hoursSinceLastMeal >= 5,
      details: hoursSinceLastMeal >= 5
        ? '–õ–∏–ø–æ–ª–∏–∑ –∞–∫—Ç–∏–≤–µ–Ω'
        : `–î–æ –ª–∏–ø–æ–ª–∏–∑–∞: ${Math.round(timeToLipolysis * 60)} –º–∏–Ω`
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
   */
  function getLastMealTime(day) {
    if (!day.meals || day.meals.length === 0) return null;

    const sortedMeals = [...day.meals]
      .filter(m => m.time)
      .sort((a, b) => b.time.localeCompare(a.time));

    if (sortedMeals.length === 0) return null;

    const dateStr = day.date || new Date().toISOString().split('T')[0];
    return new Date(`${dateStr}T${sortedMeals[0].time}:00`);
  }

  // === PHASE 0: SMOOTHING & HYSTERESIS ===

  /**
   * –°–≥–ª–∞–¥–∏—Ç—å score —Å –ø–æ–º–æ—â—å—é EMA
   */
  function smoothScore(newScore, prevScore) {
    if (prevScore === null) return newScore;

    const alpha = CONFIG.SMOOTHING_ALPHA;
    let smoothed = alpha * newScore + (1 - alpha) * prevScore;

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max –∏–∑–º–µ–Ω–µ–Ω–∏—è
    const maxChange = CONFIG.MAX_SCORE_CHANGE_PER_UPDATE;
    const diff = smoothed - prevScore;
    if (Math.abs(diff) > maxChange) {
      smoothed = prevScore + Math.sign(diff) * maxChange;
    }

    return Math.round(smoothed);
  }

  /**
   * –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –∫ —É—Ä–æ–≤–Ω—é —Ä–∏—Å–∫–∞
   */
  function applyRiskHysteresis(riskScore, prevLevel) {
    const thresholds = CONFIG.RISK_THRESHOLDS;

    // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π
    if (!prevLevel) {
      if (riskScore < thresholds.low.enter) return 'low';
      if (riskScore < thresholds.medium.enter) return 'medium';
      return 'high';
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å
    switch (prevLevel) {
      case 'low':
        return riskScore >= thresholds.low.enter ? 'medium' : 'low';
      case 'medium':
        if (riskScore < thresholds.low.exit) return 'low';
        if (riskScore >= thresholds.medium.enter) return 'high';
        return 'medium';
      case 'high':
        return riskScore < thresholds.medium.exit ? 'medium' : 'high';
      default:
        return 'low';
    }
  }

  // === UTILITIES ===

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å dayTot –∏–∑ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
   */
  function calculateDayTotals(day, pIndex) {
    const totals = {
      kcal: 0,
      prot: 0,
      carbs: 0,
      fat: 0,
      fiber: 0
    };

    if (!day.meals || !pIndex) return totals;

    for (const meal of day.meals) {
      if (!meal.items) continue;

      for (const item of meal.items) {
        const prod = pIndex?.byId?.get?.(String(item.product_id || item.id)?.toLowerCase());
        if (!prod || !item.grams) continue;

        const g = item.grams / 100;
        totals.prot += (prod.protein100 || 0) * g;
        totals.carbs += ((prod.simple100 || 0) + (prod.complex100 || 0)) * g;
        totals.fat += ((prod.badFat100 || 0) + (prod.goodFat100 || 0) + (prod.trans100 || 0)) * g;
        totals.fiber += (prod.fiber100 || 0) * g;
      }
    }

    totals.kcal = totals.prot * 3 + totals.carbs * 4 + totals.fat * 9; // NET Atwater

    return totals;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å normAbs (–∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –Ω–æ—Ä–º—ã –≤ –≥—Ä–∞–º–º–∞—Ö)
   */
  function calculateNormAbs(profile, optimum) {
    const protPct = profile?.protPct || 0.25;
    const carbsPct = profile?.carbsPct || 0.45;
    const fatPct = profile?.fatPct || 0.30;

    return {
      prot: (optimum * protPct) / 4,
      carbs: (optimum * carbsPct) / 4,
      fat: (optimum * fatPct) / 9
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–Ω–µ–π —Å –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –º–∞–∫—Ä–æ-–ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
   */
  function getDaysHistory(daysBack) {
    const lsGet = getScopedLsGet();

    const days = [];
    const today = new Date();
    // üîß Fix: buildIndex —á–µ—Ä–µ–∑ dayUtils
    const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
    const prods = HEYS.products?.getAll?.() || lsGet('heys_products', []);
    const pIndex = buildIdx ? buildIdx(prods) : { byId: new Map() };

    for (let i = 0; i < daysBack; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const day = lsGet(`heys_dayv2_${dateStr}`, null);

      // –î–µ–Ω—å —Å—á–∏—Ç–∞–µ—Ç—Å—è "—Å –¥–∞–Ω–Ω—ã–º–∏" –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
      const hasMeals = day?.meals?.some?.(m => m?.items?.length > 0);

      if (day && hasMeals) {
        // –í—ã—á–∏—Å–ª—è–µ–º dayTot –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –º–∞–∫—Ä–æ—Å–æ–≤
        const dayTot = calculateDayTotals(day, pIndex);
        const totalKcal = dayTot.kcal || 0;

        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –º–∞–∫—Ä–æ—Å–æ–≤ –æ—Ç –∫–∞–ª–æ—Ä–∏–π (–∫–∞–∫ –≤ –Ω–æ—Ä–º–∞—Ö)
        // –ë–µ–ª–æ–∫ 4 –∫–∫–∞–ª/–≥, —É–≥–ª–µ–≤–æ–¥—ã 4 –∫–∫–∞–ª/–≥, –∂–∏—Ä—ã 9 –∫–∫–∞–ª/–≥
        const enrichedDay = {
          ...day,
          dateStr,
          daysAgo: i,
          dayTot, // –î–æ–±–∞–≤–ª—è–µ–º dayTot –¥–ª—è –ø—Ä–æ—á–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
          // –ü—Ä–æ—Ü–µ–Ω—Ç—ã –º–∞–∫—Ä–æ—Å–æ–≤ (–¥–æ–ª—è –∫–∞–ª–æ—Ä–∏–π –æ—Ç –¥–∞–Ω–Ω–æ–≥–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞)
          carbsPct: totalKcal > 0 ? (dayTot.carbs * 4) / totalKcal : 0,
          protPct: totalKcal > 0 ? (dayTot.prot * 3) / totalKcal : 0,
          fatPct: totalKcal > 0 ? (dayTot.fat * 9) / totalKcal : 0
        };

        days.push(enrichedDay);
      }
    }

    return days;
  }

  // === MAIN API: getStatus() ===

  /**
   * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è
   * @param {Object} options - { dateStr, pIndex, profile, forceRefresh }
   * @returns {Object} –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
   */
  function getStatus(options = {}) {
    console.info('[HEYS.Metabolic] üîç getStatus() called with options:', JSON.stringify(Object.keys(options)));
    const lsGet = getScopedLsGet();

    // üîß Fix: buildIndex fallback ‚Äî HEYS.products.buildIndex –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
    console.info('[HEYS.Metabolic] üîç buildIdx available:', !!buildIdx, 'dayUtils:', !!HEYS.dayUtils?.buildProductIndex, 'models:', !!HEYS.models?.buildProductIndex);
    const products = HEYS.products?.getAll?.() || lsGet('heys_products', []);
    console.info('[HEYS.Metabolic] üîç products count:', Array.isArray(products) ? products.length : 'not-array');
    const defaultPIndex = buildIdx
      ? buildIdx(products)
      : null;
    console.info('[HEYS.Metabolic] üîç defaultPIndex:', defaultPIndex ? `{byId:${defaultPIndex.byId?.size},byName:${defaultPIndex.byName?.size}}` : 'null');

    const {
      dateStr = new Date().toISOString().split('T')[0],
      pIndex = defaultPIndex,
      profile = lsGet('heys_profile', {}),
      forceRefresh = false
    } = options;

    // Kill-switch check
    const featureEnabled = lsGet(CONFIG.FEATURE_FLAG_KEY, 1) === 1;
    if (!featureEnabled) {
      return {
        available: false,
        reason: 'feature_disabled',
        message: 'Metabolic Intelligence –æ—Ç–∫–ª—é—á—ë–Ω'
      };
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ ‚Äî üîß Fix: –≤–∫–ª—é—á–∞–µ–º dateStr –≤ –∫–ª—é—á –∫—ç—à–∞
    const clientId = lsGet('heys_client_current', 'default');
    const now = Date.now();

    if (!forceRefresh &&
      _cache.status &&
      _cache.clientId === clientId &&
      _cache.dateStr === dateStr &&
      (now - _cache.timestamp) < CONFIG.CACHE_TTL_MS) {
      return _cache.status;
    }

    // –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    let inventory = inventoryData(dateStr);
    inventory.completeness = calculateDataCompleteness(inventory);
    console.info('[HEYS.Metabolic] üîç inventory for', dateStr, ':', JSON.stringify({
      hasMeals: inventory.hasMeals,
      hasSleep: inventory.hasSleep,
      hasWeight: inventory.hasWeight,
      completeness: inventory.completeness,
      meals: inventory.meals
    }));

    // üîß Fix: –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî fallback –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Å –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ 14 –¥–Ω–µ–π)
    let effectiveDateStr = dateStr;
    const today = HEYS.dayUtils?.todayISO?.() || new Date().toISOString().split('T')[0];
    console.info('[HEYS.Metabolic] üîç today:', today, 'dateStr:', dateStr);

    if (!inventory.hasMeals) {
      // üîß Fix: fallback –µ—Å–ª–∏ –Ω–µ—Ç –ü–†–ò–Å–ú–û–í –ü–ò–©–ò (meals) ‚Äî –∫–ª—é—á–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
      if (dateStr === today) {
        console.info('[HEYS.Metabolic] üîç No meals for today, searching fallback...');
        for (let i = 1; i <= 14; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const fallbackDate = d.toISOString().split('T')[0];
          const fallbackInv = inventoryData(fallbackDate);
          if (fallbackInv.hasMeals) {
            // üîß –ò—â–µ–º –∏–º–µ–Ω–Ω–æ –¥–µ–Ω—å —Å meals ‚Äî –∫–ª—é—á –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π —Ñ–∞–∑—ã –∏ score
            console.info('[HEYS.Metabolic] ‚úÖ Fallback found:', fallbackDate, JSON.stringify({
              hasMeals: fallbackInv.hasMeals,
              hasSleep: fallbackInv.hasSleep,
              hasWeight: fallbackInv.hasWeight
            }));
            effectiveDateStr = fallbackDate;
            inventory = fallbackInv;
            inventory.completeness = calculateDataCompleteness(inventory);
            inventory.isFallbackDate = true;
            inventory.originalDate = dateStr;
            break;
          }
        }
        if (effectiveDateStr === dateStr) {
          console.warn('[HEYS.Metabolic] ‚ö†Ô∏è No fallback data found in 14 days!');
        }
      }
    }

    // Confidence —É—Ä–æ–≤–µ–Ω—å
    const confidence = inventory.completeness >= 80 ? 'high'
      : inventory.completeness >= 50 ? 'medium'
        : 'low';

    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ ‚Äî –ø–æ—Å–ª–µ fallback
    if (!inventory.hasMeals && !inventory.hasSleep && !inventory.hasWeight) {
      // üîß Fix: –ù–ï –∫—ç—à–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      console.warn('[HEYS.Metabolic] ‚ö†Ô∏è insufficient_data AFTER fallback, returning available:false');
      return {
        available: false,
        reason: 'insufficient_data',
        message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞',
        inventory,
        confidence: 'low'
      };
    }

    // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏
    const history = getDaysHistory(30);

    // === –†–∞—Å—á—ë—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º effectiveDateStr ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å fallback –¥–∞—Ç–∞) ===

    // 1. Plan Adherence
    const adherence = calculatePlanAdherence(effectiveDateStr, pIndex, profile);

    // 2. Crash Risk
    const crash = calculateCrashRisk(effectiveDateStr, profile, history);

    // 3. Metabolic Phase
    const metabolicPhase = calculateMetabolicPhase(effectiveDateStr);

    // 4. –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ score
    const rawScore = adherence.score;
    const smoothedScore = smoothScore(rawScore, _cache.smoothedScore);
    _cache.smoothedScore = smoothedScore;

    // 5. Risk Level —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º
    const riskLevel = applyRiskHysteresis(crash.risk, _cache.lastRiskLevel);
    _cache.lastRiskLevel = riskLevel;

    // 6. Next Steps (–ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
    const nextSteps = generateNextSteps(adherence, crash, metabolicPhase, inventory);

    // –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    const result = {
      available: true,
      version: CONFIG.VERSION,
      generatedAt: new Date().toISOString(),

      // –ì–ª–∞–≤–Ω—ã–π score (0-100)
      score: smoothedScore,
      rawScore,

      // –ü—Ä–∏—á–∏–Ω—ã —Å–Ω–∏–∂–µ–Ω–∏—è score
      reasons: adherence.reasons,

      // –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
      nextSteps,

      // –†–∏—Å–∫ —Å—Ä—ã–≤–∞
      risk: crash.risk,
      riskLevel,
      riskFactors: crash.factors,

      // –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è —Ñ–∞–∑–∞
      metabolicPhase,

      // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
      confidence,

      // üîß Fallback –¥–∞—Ç–∞ (–µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø—É—Å—Ç–æ–π)
      effectiveDate: effectiveDateStr,
      isFallbackDate: effectiveDateStr !== dateStr,

      // Debug –∏–Ω—Ñ–æ
      debug: {
        inventory,
        adherenceDetails: adherence.details,
        crashRiskFactors: crash.factors,
        smoothedScore,
        rawScore,
        riskLevel,
        prevRiskLevel: _cache.lastRiskLevel,
        requestedDate: dateStr,
        effectiveDate: effectiveDateStr
      }
    };

    // –ö—ç—à–∏—Ä—É–µ–º ‚Äî üîß Fix: dateStr –≤–∫–ª—é—á—ë–Ω –≤ –∫–ª—é—á –∫—ç—à–∞
    _cache = {
      status: result,
      timestamp: now,
      clientId,
      dateStr,
      smoothedScore,
      lastRiskLevel: riskLevel
    };

    // Analytics
    if (HEYS.analytics?.trackEvent) {
      HEYS.analytics.trackEvent('metabolic_status_calculated', {
        score: smoothedScore,
        riskLevel,
        confidence,
        hasData: inventory.completeness
      });
    }

    return result;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤
   */
  function generateNextSteps(adherence, crash, metabolicPhase, inventory) {
    const steps = [];

    // –¢–æ–ø-3 –ø—Ä–∏—á–∏–Ω—ã –ø–æ impact
    const topReasons = [...adherence.reasons]
      .sort((a, b) => (b.impact || 0) - (a.impact || 0))
      .slice(0, 3);

    for (const reason of topReasons) {
      if (reason.id === 'protein_low') {
        steps.push({
          id: 'add_protein',
          label: '–î–æ–±–∞–≤—å –±–µ–ª–∫–∞',
          etaMin: 10,
          expectedEffect: '+10-15 –∫ —Å—Ç–∞—Ç—É—Å—É',
          why: '–ë–µ–ª–æ–∫ –ø–æ–≤—ã—à–∞–µ—Ç –Ω–∞—Å—ã—â–µ–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—ã—à—Ü—ã',
          priority: 1
        });
      } else if (reason.id === 'fiber_low') {
        steps.push({
          id: 'add_fiber',
          label: '–ë–æ–ª—å—à–µ –æ–≤–æ—â–µ–π',
          etaMin: 5,
          expectedEffect: '+5-10 –∫ —Å—Ç–∞—Ç—É—Å—É',
          why: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ —É–ª—É—á—à–∞–µ—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ',
          priority: 2
        });
      } else if (reason.id === 'sleep_debt') {
        steps.push({
          id: 'improve_sleep',
          label: '–í—ã—Å—ã–ø–∞–π—Å—è',
          etaMin: 480, // 8 —á–∞—Å–æ–≤
          expectedEffect: '+15-20 –∫ —Å—Ç–∞—Ç—É—Å—É',
          why: '–ù–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –≥–æ–ª–æ–¥',
          priority: 1
        });
      } else if (reason.id === 'calories_off') {
        steps.push({
          id: 'adjust_calories',
          label: '–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π –∫–∞–ª–æ—Ä–∏–∏',
          etaMin: 15,
          expectedEffect: '+10-20 –∫ —Å—Ç–∞—Ç—É—Å—É',
          why: '–°–æ–±–ª—é–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ = —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å',
          priority: 1
        });
      } else if (reason.id === 'low_activity') {
        steps.push({
          id: 'add_activity',
          label: '–ë–æ–ª—å—à–µ –¥–≤–∏–∂–µ–Ω–∏—è',
          etaMin: 30,
          expectedEffect: '+5-10 –∫ —Å—Ç–∞—Ç—É—Å—É',
          why: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏',
          priority: 2
        });
      }
    }

    // –†–∏—Å–∫ —Å—Ä—ã–≤–∞
    if (crash.risk >= 60) {
      steps.unshift({
        id: 'prevent_crash',
        label: '–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ —Å—Ä—ã–≤–∞',
        etaMin: 60,
        expectedEffect: '–°–Ω–∏–∑–∏—Ç—å —Ä–∏—Å–∫ –¥–æ 30%',
        why: '–í—ã—Å–æ–∫ —Ä–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è ‚Äî –ø–ª–∞–Ω–∏—Ä—É–π –ø—Ä–∏—ë–º—ã –∑–∞—Ä–∞–Ω–µ–µ',
        priority: 0
      });
    }

    // –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è —Ñ–∞–∑–∞
    if (metabolicPhase.isLipolysis) {
      steps.push({
        id: 'extend_lipolysis',
        label: '–ü—Ä–æ–¥–ª–∏ –ª–∏–ø–æ–ª–∏–∑',
        etaMin: null,
        expectedEffect: '–ú–∞–∫—Å–∏–º—É–º –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è',
        why: '–ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –±–µ–∑ –µ–¥—ã = —Å–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞',
        priority: 3
      });
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ priority
    return steps.sort((a, b) => (a.priority || 999) - (b.priority || 999));
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
   */
  function clearCache() {
    _cache = {
      status: null,
      timestamp: 0,
      clientId: null,
      smoothedScore: null,
      lastRiskLevel: 'low'
    };
  }

  // === PHASE 2: PREDICTIVE LAYER ===

  /**
   * –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å—Ä—ã–≤–∞ –Ω–∞ 24-48 —á–∞—Å–æ–≤
   * –£—á—ë—Ç: —Å—Ç—Ä–µ—Å—Å, —Å–æ–Ω, —Ç—Ä–∏–≥–≥–µ—Ä—ã, –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å
   * @returns {Object} { risk, primaryTrigger, preventionStrategy, timeframe }
   */
  function calculateCrashRisk24h(dateStr, profile, history) {
    const lsGet = getScopedLsGet();

    // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å–∞ –∏–∑ A/B –≤–∞—Ä–∏–∞–Ω—Ç–∞
    const abWeights = getABWeights();

    const tomorrow = new Date(dateStr);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    const dayOfWeek = tomorrow.getDay();

    let risk = 0;
    let triggers = [];

    // 1. –¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫ (–±–∞–∑–æ–≤—ã–π) ‚Äî –≤–µ—Å –∏–∑ A/B —Ç–µ—Å—Ç–∞
    const currentRisk = calculateCrashRisk(dateStr, profile, history);
    // üîß FIX: –±—ã–ª–æ abWeights.current, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å abWeights.currentRisk
    risk += (currentRisk.risk || 0) * (abWeights.currentRisk || 0.6);

    // 2. –ù–µ–¥–æ—Å—ã–ø (–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞) ‚Äî –≤–µ—Å –∏–∑ A/B —Ç–µ—Å—Ç–∞
    const day = lsGet(`heys_dayv2_${dateStr}`, {});
    const sleepHours = day.sleepHours || 0;
    if (sleepHours < 6) {
      risk += abWeights.sleepDebt;
      triggers.push({
        id: 'sleep_debt_tomorrow',
        label: '–†–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ –Ω–µ–¥–æ—Å—ã–ø–∞',
        impact: abWeights.sleepDebt,
        confidence: 0.8
      });
    }

    // 3. –í—ã—Ö–æ–¥–Ω—ã–µ / –ü—è—Ç–Ω–∏—Ü–∞ ‚Äî –≤–µ—Å –∏–∑ A/B —Ç–µ—Å—Ç–∞
    if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) {
      risk += abWeights.weekend;
      triggers.push({
        id: 'weekend',
        label: '–í—ã—Ö–æ–¥–Ω—ã–µ ‚Äî –ø–æ–≤—ã—à–µ–Ω —Ä–∏—Å–∫',
        impact: abWeights.weekend,
        confidence: 0.7
      });
    }

    // 4. –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç (–Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å) ‚Äî –≤–µ—Å –∏–∑ A/B —Ç–µ—Å—Ç–∞
    const consecutiveDays = countConsecutiveDeficitDays(history);
    if (consecutiveDays >= 4) {
      risk += abWeights.chronicDeficit;
      triggers.push({
        id: 'metabolic_stress',
        label: '–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å –æ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞',
        impact: abWeights.chronicDeficit,
        confidence: 0.85
      });
    }

    // 5. –ü–∞—Ç—Ç–µ—Ä–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –≤–µ—Å –∏–∑ A/B —Ç–µ—Å—Ç–∞
    const historicalPattern = findHistoricalPattern(history, dayOfWeek);
    if (historicalPattern.hasCrashPattern) {
      risk += abWeights.historical;
      triggers.push({
        id: 'historical_pattern',
        label: '–í –ø—Ä–æ—à–ª–æ–º –±—ã–ª–∏ —Å—Ä—ã–≤—ã –≤ —Ç–∞–∫–∏–µ –¥–Ω–∏',
        impact: abWeights.historical,
        confidence: 0.6
      });
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
    const primaryTrigger = triggers.length > 0
      ? triggers.reduce((max, t) => t.impact > max.impact ? t : max, triggers[0])
      : null;

    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏
    const preventionStrategy = generatePreventionStrategy(triggers, risk);

    // üîß FIX: –∑–∞—â–∏—Ç–∞ –æ—Ç NaN
    const finalRisk = Math.min(100, Math.max(0, Math.round(risk || 0)));
    if (isNaN(finalRisk)) {
      console.warn('[Metabolic] calculateCrashRisk24h returned NaN, defaulting to 0');
    }

    // üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π —Ä–∏—Å–∫ –¥–ª—è A/B —Ç–µ—Å—Ç–∞ (–¢–û–õ–¨–ö–û –ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ cloud sync)
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
      localStorage.setItem(`heys_predicted_risk_${tomorrowStr}`, JSON.stringify(finalRisk));
    } catch (e) {
      // –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ localStorage
    }

    return {
      risk: finalRisk,
      riskLevel: finalRisk < 30 ? 'low' : finalRisk < 60 ? 'medium' : 'high',
      level: finalRisk < 30 ? 'low' : finalRisk < 60 ? 'medium' : 'high', // –ê–ª–∏–∞—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      primaryTrigger,
      triggers,
      factors: currentRisk.factors || [], // –§–∞–∫—Ç–æ—Ä—ã –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
      positiveFactors: currentRisk.positiveFactors || [], // üÜï –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
      preventionStrategy,
      timeframe: '24-48 —á–∞—Å–æ–≤',
      confidence: triggers.length > 0 ? 0.75 : 0.5,
      abVariant: getABVariant().id // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    };
  }

  /**
   * –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å—Ä—ã–≤–æ–≤
   */
  function findHistoricalPattern(history, targetDayOfWeek) {
    if (!history || history.length < 14) {
      return { hasCrashPattern: false };
    }

    let crashCount = 0;
    let totalDays = 0;

    for (const day of history) {
      const dayOfWeek = new Date(day.dateStr).getDay();
      if (dayOfWeek === targetDayOfWeek) {
        totalDays++;
        if (day.ratio && day.ratio > 1.3) { // –ü–µ—Ä–µ–µ–¥–∞–Ω–∏–µ
          crashCount++;
        }
      }
    }

    return {
      hasCrashPattern: crashCount >= 2 && crashCount / totalDays >= 0.5,
      crashCount,
      totalDays
    };
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏
   */
  function generatePreventionStrategy(triggers, risk) {
    const strategies = [];

    for (const trigger of triggers) {
      if (trigger.id === 'sleep_debt_tomorrow') {
        strategies.push({
          action: '–í—ã—Å—ã–ø–∞–π—Å—è —Å–µ–≥–æ–¥–Ω—è',
          reason: '–ù–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –≥–æ–ª–æ–¥ –Ω–∞ 15-28%',
          priority: 1
        });
      } else if (trigger.id === 'weekend') {
        strategies.push({
          action: '–ó–∞–ø–ª–∞–Ω–∏—Ä—É–π –ø—Ä–∏—ë–º—ã –∑–∞—Ä–∞–Ω–µ–µ',
          reason: '–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ = —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞',
          priority: 2
        });
      } else if (trigger.id === 'metabolic_stress') {
        strategies.push({
          action: '–†–∞—Å—Å–º–æ—Ç—Ä–∏ Refeed Day',
          reason: '–ü–µ—Ä–µ—Ä—ã–≤ –æ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
          priority: 1
        });
      }
    }

    // –û–±—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞
    if (risk >= 60) {
      strategies.unshift({
        action: '–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ —Å–∏–≥–Ω–∞–ª–∞–º –≥–æ–ª–æ–¥–∞',
        reason: '–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ ‚Äî —Ä–∞–∑–ª–∏—á–∞–π —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ–¥',
        priority: 0
      });
    }

    return strategies.sort((a, b) => a.priority - b.priority);
  }

  /**
   * –ü—Ä–æ–≥–Ω–æ–∑ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ñ–æ–∫—É—Å–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
   * @returns {Object} { energyWindows[], trainingWindow, optimalMeals[] }
   */
  function calculatePerformanceForecast(dateStr, profile, history) {
    const lsGet = getScopedLsGet();

    const day = lsGet(`heys_dayv2_${dateStr}`, {});

    // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–Ω–∞
    const sleepQuality = day.sleepQuality || (day.sleepHours >= 7 ? 7 : 5);
    const sleepHours = day.sleepHours || 7;

    const energyWindows = [];

    // –£—Ç—Ä–æ (7-11) ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–Ω–∞
    if (sleepHours >= 7) {
      energyWindows.push({
        period: '7:00-11:00',
        label: '–£—Ç—Ä–æ',
        energy: 'high',
        focus: 'high',
        optimal: true,
        recommendation: '–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫'
      });
    } else {
      energyWindows.push({
        period: '7:00-11:00',
        label: '–£—Ç—Ä–æ',
        energy: 'medium',
        focus: 'medium',
        optimal: false,
        recommendation: '–ù–µ–¥–æ—Å—ã–ø —Å–Ω–∏–∑–∏—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
      });
    }

    // –î–µ–Ω—å (12-15) ‚Äî –æ–±–µ–¥–µ–Ω–Ω—ã–π —Å–ø–∞–¥
    energyWindows.push({
      period: '12:00-15:00',
      label: '–û–±–µ–¥',
      energy: 'medium',
      focus: 'medium',
      optimal: false,
      recommendation: '–õ—ë–≥–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∏–∑–±–µ–≥–∞–π —Ç—è–∂—ë–ª—ã—Ö –ø—Ä–∏—ë–º–æ–≤'
    });

    // –í—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è (16-19)
    energyWindows.push({
      period: '16:00-19:00',
      label: '–í–µ—á–µ—Ä',
      energy: 'high',
      focus: 'high',
      optimal: true,
      recommendation: '–í—Ç–æ—Ä–æ–π –ø–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Ö–æ—Ä–æ—à–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫'
    });

    // –ù–æ—á—å (20-23)
    energyWindows.push({
      period: '20:00-23:00',
      label: '–ù–æ—á—å',
      energy: 'low',
      focus: 'low',
      optimal: false,
      recommendation: '–ì–æ—Ç–æ–≤—å—Å—è –∫–æ —Å–Ω—É, –∏–∑–±–µ–≥–∞–π —Ç—è–∂—ë–ª–æ–π –µ–¥—ã'
    });

    // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    const trainingWindow = sleepHours >= 7
      ? { time: '16:00-19:00', reason: '–ü–∏–∫ —Å–∏–ª—ã –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏' }
      : { time: '10:00-12:00', reason: '–ü–æ—Å–ª–µ –Ω–µ–¥–æ—Å—ã–ø–∞ ‚Äî –ª—É—á—à–µ —É—Ç—Ä–æ–º' };

    // –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏
    const optimalMeals = [
      {
        time: '8:00-9:00',
        name: '–ó–∞–≤—Ç—Ä–∞–∫',
        priority: 'high',
        focus: '–ë–µ–ª–æ–∫ + —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏',
        caloriesPct: 30
      },
      {
        time: '13:00-14:00',
        name: '–û–±–µ–¥',
        priority: 'high',
        focus: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏—ë–º',
        caloriesPct: 35
      },
      {
        time: '18:00-19:00',
        name: '–£–∂–∏–Ω',
        priority: 'medium',
        focus: '–õ—ë–≥–∫–∏–π, –Ω–µ –ø–æ–∑–∂–µ 19:00',
        caloriesPct: 25
      },
      {
        time: '11:00',
        name: '–ü–µ—Ä–µ–∫—É—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)',
        priority: 'low',
        focus: '–ï—Å–ª–∏ –≥–æ–ª–æ–¥ ‚Äî —Ñ—Ä—É–∫—Ç –∏–ª–∏ –æ—Ä–µ—Ö–∏',
        caloriesPct: 10
      }
    ];

    return {
      energyWindows,
      trainingWindow,
      optimalMeals,
      sleepImpact: sleepHours < 7 ? 'negative' : 'positive',
      confidence: 0.7
    };
  }

  // === PHASE 3: PERSONALIZATION ===

  /**
   * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Ñ–µ–Ω–æ—Ç–∏–ø–∞
   * v1.1.0 ‚Äî –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ:
   *   7+ –¥–Ω–µ–π  ‚Üí –ë–∞–∑–æ–≤—ã–π —Ñ–µ–Ω–æ—Ç–∏–ø (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ)
   *   14+ –¥–Ω–µ–π ‚Üí + –ü–æ—Ä–æ–≥–∏ + –°–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
   *   30+ –¥–Ω–µ–π ‚Üí + –ü–æ–ª–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + –¶–∏—Ä–∫–∞–¥–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   * 
   * @returns {Object} { phenotype, tolerances, recommendations, tier, ... }
   */
  function identifyPhenotype(history, profile) {
    const daysAvailable = history?.length || 0;
    const tiers = CONFIG.PHENOTYPE_TIERS;

    // –ú–µ–Ω—å—à–µ 7 –¥–Ω–µ–π ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if (daysAvailable < tiers.BASIC) {
      return {
        available: false,
        reason: 'insufficient_data',
        daysRequired: tiers.BASIC,
        daysAvailable
      };
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º tier (—É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
    let tier = 'basic';
    let tierLabel = '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ';
    let tierColor = '#f59e0b'; // yellow
    let confidence = 0.5;

    if (daysAvailable >= tiers.ADVANCED) {
      tier = 'advanced';
      tierLabel = '–¢–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑';
      tierColor = '#22c55e'; // green
      confidence = 0.85;
    } else if (daysAvailable >= tiers.STANDARD) {
      tier = 'standard';
      tierLabel = '–•–æ—Ä–æ—à–∏–π –∞–Ω–∞–ª–∏–∑';
      tierColor = '#3b82f6'; // blue
      confidence = 0.7;
    }

    // === –ë–ê–ó–û–í–´–ô –ê–ù–ê–õ–ò–ó (7+ –¥–Ω–µ–π) ===
    // –ê–Ω–∞–ª–∏–∑ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∫ –º–∞–∫—Ä–æ—Å–∞–º
    const carbTolerance = analyzeCarbTolerance(history);
    const fatTolerance = analyzeFatTolerance(history);
    const proteinResponse = analyzeProteinResponse(history);

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–µ–Ω–æ—Ç–∏–ø–∞
    let phenotype = 'balanced';
    if (carbTolerance.score > 75 && fatTolerance.score < 60) {
      phenotype = 'carb_preferring';
    } else if (fatTolerance.score > 75 && carbTolerance.score < 60) {
      phenotype = 'fat_preferring';
    } else if (proteinResponse.score > 80) {
      phenotype = 'protein_efficient';
    }

    const phenotypeLabels = {
      balanced: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π',
      carb_preferring: '–£–≥–ª–µ–≤–æ–¥–Ω—ã–π —Ç–∏–ø',
      fat_preferring: '–ñ–∏—Ä–æ–≤–æ–π —Ç–∏–ø',
      protein_efficient: '–ë–µ–ª–∫–æ–≤—ã–π —Ç–∏–ø'
    };

    const phenotypeDescriptions = {
      balanced: '–•–æ—Ä–æ—à–æ —É—Å–≤–∞–∏–≤–∞–µ—à—å –≤—Å–µ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ',
      carb_preferring: '–û—Ä–≥–∞–Ω–∏–∑–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É–≥–ª–µ–≤–æ–¥–∞—Ö',
      fat_preferring: '–õ—É—á—à–µ —É—Å–≤–∞–∏–≤–∞–µ—à—å –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∂–∏—Ä—ã –∫–∞–∫ —Ç–æ–ø–ª–∏–≤–æ',
      protein_efficient: '–í—ã—Å–æ–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Å–≤–æ–µ–Ω–∏—è –±–µ–ª–∫–∞'
    };

    // –ë–∞–∑–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const result = {
      available: true,
      phenotype,
      label: phenotypeLabels[phenotype],
      description: phenotypeDescriptions[phenotype],
      tier,
      tierLabel,
      tierColor,
      confidence,
      dataPoints: daysAvailable,
      nextTier: tier === 'basic' ? {
        name: 'standard',
        daysNeeded: tiers.STANDARD - daysAvailable,
        unlocks: ['–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏', '–°–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã']
      } : tier === 'standard' ? {
        name: 'advanced',
        daysNeeded: tiers.ADVANCED - daysAvailable,
        unlocks: ['–ü–æ–ª–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '–¶–∏—Ä–∫–∞–¥–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã', '–°—Ç—Ä–µ—Å—Å-–∞–Ω–∞–ª–∏–∑']
      } : null,
      // Radar –¥–∞–Ω–Ω—ã–µ (–¥–æ—Å—Ç—É–ø–Ω—ã —Å 7 –¥–Ω–µ–π)
      radarData: {
        stability: calculateMealTimingStability(history).score,
        recovery: Math.round(carbTolerance.score * 0.8 + 20),
        insulinSensitivity: Math.round(70 + Math.random() * 20), // TODO: —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç
        consistency: Math.min(100, Math.round(50 + daysAvailable * 1.5)), // Clamp to 0-100
        chronotype: analyzeCircadianPattern(history).chronotypeScore
      },
      tolerances: {
        carbs: carbTolerance,
        fat: fatTolerance,
        protein: proteinResponse
      }
    };

    // === –°–¢–ê–ù–î–ê–†–¢–ù–´–ô –ê–ù–ê–õ–ò–ó (14+ –¥–Ω–µ–π) ===
    if (tier === 'standard' || tier === 'advanced') {
      // –°—Ç—Ä–µ—Å—Å-–æ—Ç–≤–µ—Ç
      result.stressResponse = analyzeStressResponse(history);

      // –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
      result.strengths = [];
      result.weaknesses = [];

      if (carbTolerance.score > 70) {
        result.strengths.push('–•–æ—Ä–æ—à–∞—è —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º');
      } else if (carbTolerance.score < 50) {
        result.weaknesses.push('–ù–∏–∑–∫–∞—è —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —É–≥–ª–µ–≤–æ–¥–∞–º');
      }

      if (fatTolerance.score > 70) {
        result.strengths.push('–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É—Å–≤–æ–µ–Ω–∏–µ –∂–∏—Ä–æ–≤');
      }

      if (proteinResponse.score > 75) {
        result.strengths.push('–û—Ç–ª–∏—á–Ω—ã–π –±–µ–ª–∫–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º');
      }

      if (result.stressResponse.type === 'resilient') {
        result.strengths.push('–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å—Ç—Ä–µ—Å—Å—É');
      } else if (result.stressResponse.type === 'stress_eater') {
        result.weaknesses.push('–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ');
      }

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ)
      result.thresholds = {
        optimalKcalRange: profile?.optimum
          ? [Math.round(profile.optimum * 0.9), Math.round(profile.optimum * 1.1)]
          : [1800, 2200],
        waveHours: phenotype === 'carb_preferring' ? 3.5 : phenotype === 'fat_preferring' ? 4.0 : 3.0,
        mealGap: phenotype === 'carb_preferring' ? 3 : 4
      };
    }

    // === –ü–†–û–î–í–ò–ù–£–¢–´–ô –ê–ù–ê–õ–ò–ó (30+ –¥–Ω–µ–π) ===
    if (tier === 'advanced') {
      // –¶–∏—Ä–∫–∞–¥–Ω–∞—è —Å–∏–ª–∞
      result.circadianStrength = analyzeCircadianPattern(history);

      // –û–±–Ω–æ–≤–ª—è–µ–º radar —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      result.radarData.chronotype = result.circadianStrength.chronotypeScore;
      // stability —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω —á–µ—Ä–µ–∑ calculateMealTimingStability –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ radarData

      // –ü–æ–ª–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
      result.recommendations = generatePhenotypeRecommendations(
        phenotype,
        carbTolerance,
        fatTolerance,
        result.circadianStrength
      );

      // –ü–æ—Ä–æ–≥ —Ä–∏—Å–∫–∞ —Å—Ä—ã–≤–∞
      result.thresholds.crashRiskThreshold =
        result.stressResponse?.type === 'stress_eater' ? 60 : 75;

      // –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
      result.dataProgress = Math.min(100, Math.round((daysAvailable / 30) * 100));
    } else {
      // –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–Ω–Ω–∏—Ö —ç—Ç–∞–ø–æ–≤
      result.recommendations = [
        {
          category: 'data',
          text: `–ï—â—ë ${result.nextTier?.daysNeeded || 0} –¥–Ω–µ–π –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞`
        }
      ];
      result.dataProgress = Math.round((daysAvailable / tiers.ADVANCED) * 100);
    }

    return result;
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∫ —É–≥–ª–µ–≤–æ–¥–∞–º
   */
  function analyzeCarbTolerance(history) {
    // –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ progress
    let highCarbDays = [];
    let lowCarbDays = [];

    for (const day of history) {
      if (!day.carbsPct) continue;

      if (day.carbsPct > 0.45) {
        highCarbDays.push(day);
      } else if (day.carbsPct < 0.35) {
        lowCarbDays.push(day);
      }
    }

    const highCarbAvgRatio = highCarbDays.length > 0
      ? highCarbDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / highCarbDays.length
      : 1;

    const lowCarbAvgRatio = lowCarbDays.length > 0
      ? lowCarbDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / lowCarbDays.length
      : 1;

    // –ï—Å–ª–∏ –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —É–≥–ª–µ–≤–æ–¥–∞—Ö ratio –±–ª–∏–∂–µ –∫ 1 = —Ö–æ—Ä–æ—à–∞—è —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å
    const score = Math.round((1 - Math.abs(1 - highCarbAvgRatio)) * 100);

    return {
      score: Math.max(0, Math.min(100, score)),
      label: score > 75 ? '–í—ã—Å–æ–∫–∞—è' : score > 50 ? '–°—Ä–µ–¥–Ω—è—è' : '–ù–∏–∑–∫–∞—è',
      details: `–ù–∞ –≤—ã—Å–æ–∫–∏—Ö —É–≥–ª–µ–≤–æ–¥–∞—Ö (>45%): ratio ${highCarbAvgRatio.toFixed(2)}`
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∫ –∂–∏—Ä–∞–º
   */
  function analyzeFatTolerance(history) {
    let highFatDays = [];

    for (const day of history) {
      if (!day.fatPct) continue;

      if (day.fatPct > 0.35) {
        highFatDays.push(day);
      }
    }

    const avgRatio = highFatDays.length > 0
      ? highFatDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / highFatDays.length
      : 1;

    const score = Math.round((1 - Math.abs(1 - avgRatio)) * 100);

    return {
      score: Math.max(0, Math.min(100, score)),
      label: score > 75 ? '–í—ã—Å–æ–∫–∞—è' : score > 50 ? '–°—Ä–µ–¥–Ω—è—è' : '–ù–∏–∑–∫–∞—è',
      details: `–ù–∞ –≤—ã—Å–æ–∫–∏—Ö –∂–∏—Ä–∞—Ö (>35%): ratio ${avgRatio.toFixed(2)}`
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ –±–µ–ª–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
   */
  function analyzeProteinResponse(history) {
    let highProteinDays = [];

    for (const day of history) {
      if (!day.protPct) continue;

      if (day.protPct > 0.25) {
        highProteinDays.push(day);
      }
    }

    const avgRatio = highProteinDays.length > 0
      ? highProteinDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / highProteinDays.length
      : 1;

    const score = Math.round((1 - Math.abs(1 - avgRatio)) * 100);

    return {
      score: Math.max(0, Math.min(100, score)),
      label: score > 80 ? '–û—Ç–ª–∏—á–Ω–æ' : score > 60 ? '–•–æ—Ä–æ—à–æ' : '–ù–æ—Ä–º–∞',
      details: `–ù–∞ –≤—ã—Å–æ–∫–æ–º –±–µ–ª–∫–µ (>25%): ratio ${avgRatio.toFixed(2)}`
    };
  }

  /**
   * –†–∞—Å—á—ë—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∂–∏–º–∞ –ø–∏—Ç–∞–Ω–∏—è
   * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
   * @param {Array} history - –ò—Å—Ç–æ—Ä–∏—è –¥–Ω–µ–π
   * @returns {{score: number, label: string, details: string}}
   */
  function calculateMealTimingStability(history) {
    try {
      // –°–æ–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
      const firstMealTimes = [];

      for (const day of history) {
        if (!day.meals || !Array.isArray(day.meals) || day.meals.length === 0) continue;

        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (—Å–∞–º–æ–µ —Ä–∞–Ω–Ω–µ–µ –≤—Ä–µ–º—è)
        let earliestMinutes = Infinity;
        for (const meal of day.meals) {
          if (!meal.time) continue;
          const [hours, mins] = meal.time.split(':').map(Number);
          if (isNaN(hours) || isNaN(mins)) continue;
          const totalMins = hours * 60 + mins;
          if (totalMins < earliestMinutes) {
            earliestMinutes = totalMins;
          }
        }

        if (earliestMinutes !== Infinity) {
          firstMealTimes.push(earliestMinutes);
        }
      }

      // –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –¥–Ω—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
      if (firstMealTimes.length < 3) {
        return {
          score: 50,
          label: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö',
          details: `–î–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏: ${firstMealTimes.length}/3`
        };
      }

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞
      const avgTime = firstMealTimes.reduce((a, b) => a + b, 0) / firstMealTimes.length;

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
      const variance = firstMealTimes.reduce((sum, t) => sum + Math.pow(t - avgTime, 2), 0) / firstMealTimes.length;
      const stdDev = Math.sqrt(variance);

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ score (0-100)
      // stdDev < 15 –º–∏–Ω = –æ—á–µ–Ω—å —Å—Ç–∞–±–∏–ª—å–Ω–æ (score ~95)
      // stdDev 15-30 –º–∏–Ω = —Å—Ç–∞–±–∏–ª—å–Ω–æ (score ~80)
      // stdDev 30-60 –º–∏–Ω = —É–º–µ—Ä–µ–Ω–Ω–æ (score ~60)
      // stdDev 60-90 –º–∏–Ω = –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ (score ~40)
      // stdDev > 90 –º–∏–Ω = –æ—á–µ–Ω—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ (score ~20)
      let score;
      if (stdDev < 15) {
        score = 90 + (15 - stdDev) * 0.67; // 90-100
      } else if (stdDev < 30) {
        score = 75 + (30 - stdDev) * 1; // 75-90
      } else if (stdDev < 60) {
        score = 50 + (60 - stdDev) * 0.83; // 50-75
      } else if (stdDev < 90) {
        score = 30 + (90 - stdDev) * 0.67; // 30-50
      } else {
        score = Math.max(10, 30 - (stdDev - 90) * 0.2); // 10-30
      }

      score = Math.round(Math.max(0, Math.min(100, score)));

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const avgHours = Math.floor(avgTime / 60);
      const avgMins = Math.round(avgTime % 60);
      const avgTimeStr = `${avgHours.toString().padStart(2, '0')}:${avgMins.toString().padStart(2, '0')}`;

      return {
        score,
        label: score >= 80 ? '–°—Ç–∞–±–∏–ª—å–Ω—ã–π' : score >= 60 ? '–£–º–µ—Ä–µ–Ω–Ω—ã–π' : score >= 40 ? '–í–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π' : '–•–∞–æ—Ç–∏—á–Ω—ã–π',
        details: `–ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º ~${avgTimeStr}, œÉ=${Math.round(stdDev)} –º–∏–Ω`,
        avgFirstMealTime: avgTimeStr,
        stdDevMinutes: Math.round(stdDev),
        daysAnalyzed: firstMealTimes.length
      };
    } catch (e) {
      console.warn('[MetabolicIntelligence] calculateMealTimingStability error:', e);
      return {
        score: 50,
        label: '–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞',
        details: e.message
      };
    }
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
   */
  function analyzeCircadianPattern(history) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ PredictiveInsights –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    if (HEYS.PredictiveInsights?.analyzeCircadianTiming) {
      try {
        const analysis = HEYS.PredictiveInsights.analyzeCircadianTiming(history);
        if (analysis.available) {
          return {
            score: analysis.score,
            label: analysis.score >= 85 ? '–°–∏–ª—å–Ω—ã–π' : analysis.score >= 70 ? '–°—Ä–µ–¥–Ω–∏–π' : '–°–ª–∞–±—ã–π',
            pattern: 'morning_focused'
          };
        }
      } catch (e) {
        // Fallback
      }
    }

    return {
      score: 70,
      label: '–°—Ä–µ–¥–Ω–∏–π',
      pattern: 'balanced'
    };
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–µ—Å—Å-–æ—Ç–≤–µ—Ç–∞
   */
  function analyzeStressResponse(history) {
    let highStressDays = [];
    let lowStressDays = [];

    for (const day of history) {
      if (!day.stressAvg) continue;

      if (day.stressAvg >= 6) {
        highStressDays.push(day);
      } else if (day.stressAvg <= 3) {
        lowStressDays.push(day);
      }
    }

    const highStressAvgRatio = highStressDays.length > 0
      ? highStressDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / highStressDays.length
      : 1;

    const lowStressAvgRatio = lowStressDays.length > 0
      ? lowStressDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / lowStressDays.length
      : 1;

    // –ï—Å–ª–∏ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ ratio —Å–∏–ª—å–Ω–æ –≤—ã—à–µ = —Å—Ç—Ä–µ—Å—Å-–µ–¥–æ–∫
    const diff = highStressAvgRatio - lowStressAvgRatio;

    return {
      type: diff > 0.15 ? 'stress_eater' : diff < -0.1 ? 'stress_suppressed' : 'resilient',
      label: diff > 0.15 ? '–°—Ç—Ä–µ—Å—Å-–µ–¥–æ–∫' : diff < -0.1 ? '–ü–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–π –∞–ø–ø–µ—Ç–∏—Ç' : '–£—Å—Ç–æ–π—á–∏–≤—ã–π',
      impact: Math.abs(diff),
      details: `–ü—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ: ratio ${highStressAvgRatio.toFixed(2)} vs –Ω–æ—Ä–º–∞ ${lowStressAvgRatio.toFixed(2)}`
    };
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Ñ–µ–Ω–æ—Ç–∏–ø—É
   */
  function generatePhenotypeRecommendations(phenotype, carbTol, fatTol, circadian) {
    const recs = [];

    if (phenotype === 'carb_preferring') {
      recs.push({
        category: 'macros',
        text: '–£–≥–ª–µ–≤–æ–¥—ã 45-50%, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã —É—Ç—Ä–æ–º'
      });
      recs.push({
        category: 'timing',
        text: '–ë–æ–ª—å—à—É—é —á–∞—Å—Ç—å —É–≥–ª–µ–≤–æ–¥–æ–≤ —Å—ä–µ–¥–∞–π –¥–æ 15:00'
      });
    } else if (phenotype === 'fat_preferring') {
      recs.push({
        category: 'macros',
        text: '–ñ–∏—Ä—ã 35-40%, –ø–æ–ª–µ–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: –æ—Ä–µ—Ö–∏, –∞–≤–æ–∫–∞–¥–æ, —Ä—ã–±–∞'
      });
      recs.push({
        category: 'timing',
        text: '–ñ–∏—Ä—ã –ª—É—á—à–µ –≤–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è'
      });
    } else if (phenotype === 'protein_efficient') {
      recs.push({
        category: 'macros',
        text: '–ë–µ–ª–æ–∫ 25-30%, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –ø—Ä–∏—ë–º–∞–º'
      });
    }

    if (circadian.score < 70) {
      recs.push({
        category: 'circadian',
        text: '–£–ª—É—á—à–∏ —Ü–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º: 60% –∫–∞–ª–æ—Ä–∏–π –¥–æ 15:00'
      });
    }

    return recs;
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
   * @returns {Object} –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–æ–Ω—ã streak, –¥–µ—Ñ–∏—Ü–∏—Ç–∞, crash/binge
   */
  function calculatePersonalThresholds(history, profile) {
    if (!history || history.length < 14) {
      return {
        available: false,
        reason: 'insufficient_data',
        daysRequired: 14,
        daysAvailable: history?.length || 0
      };
    }

    // –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    const ratios = history.map(d => d.ratio).filter(r => r);
    const avgRatio = ratios.reduce((sum, r) => sum + r, 0) / ratios.length;
    const stdDevRatio = Math.sqrt(
      ratios.reduce((sum, r) => sum + Math.pow(r - avgRatio, 2), 0) / ratios.length
    );

    // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–æ–Ω—ã (¬±1 —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)
    const streakRange = {
      min: Math.max(0.75, avgRatio - stdDevRatio * 0.5),
      max: Math.min(1.25, avgRatio + stdDevRatio * 0.5),
      label: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞ streak'
    };

    // –ü–æ—Ä–æ–≥ crash (–∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å—Ä—ã–≤—ã)
    const crashThreshold = history
      .filter(d => d.ratio && d.ratio > 1.3)
      .map(d => d.ratio)
      .sort((a, b) => a - b)[0] || 1.3;

    // –ü–æ—Ä–æ–≥ deficit (–∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç)
    const deficitThreshold = history
      .filter(d => d.ratio && d.ratio < 0.85 && d.ratio > 0.5)
      .map(d => d.ratio)
      .sort((a, b) => b - a)[0] || 0.85;

    return {
      available: true,
      streakRange,
      crashThreshold: {
        value: crashThreshold,
        label: '–ü–æ—Ä–æ–≥ —Å—Ä—ã–≤–∞ (–ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ)'
      },
      deficitThreshold: {
        value: deficitThreshold,
        label: '–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç'
      },
      personalWave: {
        duration: profile?.insulinWaveHours || BASELINE.WAVE_DURATION,
        label: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞'
      },
      confidence: 0.7,
      dataPoints: history.length
    };
  }

  /**
   * Feedback —Å–∏—Å—Ç–µ–º–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  function submitFeedback(predictionId, correct, details = {}) {
    const lsGet = getScopedLsGet();
    const lsSet = U.lsSet || ((k, v) => {
      try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { }
    });

    const feedbackKey = 'heys_metabolic_feedback';
    const feedback = lsGet(feedbackKey, []);

    feedback.push({
      predictionId,
      correct,
      timestamp: Date.now(),
      details
    });

    lsSet(feedbackKey, feedback);

    // Analytics
    if (HEYS.analytics?.trackEvent) {
      HEYS.analytics.trackEvent('metabolic_feedback', {
        predictionId,
        correct,
        hasDetails: Object.keys(details).length > 0
      });
    }

    return { success: true };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ feedback
   */
  function getFeedbackStats() {
    const lsGet = getScopedLsGet();

    const feedbackKey = 'heys_metabolic_feedback';
    const feedback = lsGet(feedbackKey, []);

    const total = feedback.length;
    const correct = feedback.filter(f => f.correct).length;
    const accuracy = total > 0 ? (correct / total) * 100 : 0;

    return {
      total,
      correct,
      incorrect: total - correct,
      accuracy: Math.round(accuracy)
    };
  }

  // === PHASE 4: INTEGRATION & REPORTING ===

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
   * @param {string} period - 'week' | 'month'
   * @returns {Object} —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç
   */
  function generateReport(period = 'week') {
    const lsGet = getScopedLsGet();

    const daysBack = period === 'week' ? 7 : 30;
    const history = getDaysHistory(daysBack);

    if (history.length === 0) {
      return {
        available: false,
        reason: 'no_data',
        period
      };
    }

    const profile = lsGet('heys_profile', {});
    // üîß Fix: buildIndex —á–µ—Ä–µ–∑ dayUtils
    const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
    const prods = HEYS.products?.getAll?.() || lsGet('heys_products', []);
    const pIndex = buildIdx ? buildIdx(prods) : null;

    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
    const dailyStatuses = [];
    for (const day of history) {
      const status = getStatus({
        dateStr: day.dateStr,
        pIndex,
        profile,
        forceRefresh: false
      });

      if (status.available) {
        dailyStatuses.push({
          date: day.dateStr,
          score: status.score,
          risk: status.risk,
          riskLevel: status.riskLevel
        });
      }
    }

    // –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    const avgScore = dailyStatuses.length > 0
      ? Math.round(dailyStatuses.reduce((sum, d) => sum + d.score, 0) / dailyStatuses.length)
      : 0;

    const avgRisk = dailyStatuses.length > 0
      ? Math.round(dailyStatuses.reduce((sum, d) => sum + d.risk, 0) / dailyStatuses.length)
      : 0;

    const highRiskDays = dailyStatuses.filter(d => d.riskLevel === 'high').length;

    // –õ—É—á—à–∏–π –∏ —Ö—É–¥—à–∏–π –¥–µ–Ω—å
    const bestDay = dailyStatuses.length > 0
      ? dailyStatuses.reduce((max, d) => d.score > max.score ? d : max, dailyStatuses[0])
      : null;

    const worstDay = dailyStatuses.length > 0
      ? dailyStatuses.reduce((min, d) => d.score < min.score ? d : min, dailyStatuses[0])
      : null;

    // –¢—Ä–µ–Ω–¥—ã
    const scoreTrend = calculateTrend(dailyStatuses.map(d => d.score));
    const riskTrend = calculateTrend(dailyStatuses.map(d => d.risk));

    return {
      available: true,
      period,
      periodLabel: period === 'week' ? '–ù–µ–¥–µ–ª—è' : '–ú–µ—Å—è—Ü',
      daysAnalyzed: dailyStatuses.length,

      summary: {
        avgScore,
        avgRisk,
        highRiskDays,
        bestDay,
        worstDay
      },

      trends: {
        score: {
          direction: scoreTrend > 0.5 ? 'up' : scoreTrend < -0.5 ? 'down' : 'stable',
          slope: Math.round(scoreTrend * 100) / 100
        },
        risk: {
          direction: riskTrend > 0.5 ? 'up' : riskTrend < -0.5 ? 'down' : 'stable',
          slope: Math.round(riskTrend * 100) / 100
        }
      },

      dailyStatuses,

      generatedAt: new Date().toISOString()
    };
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç—Ä–µ–Ω–¥ (slope)
   */
  function calculateTrend(values) {
    if (!values || values.length < 2) return 0;

    const n = values.length;
    const x = values.map((_, i) => i);
    const y = values;

    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
    const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    return isNaN(slope) ? 0 : slope;
  }

  // === PHASE 5: AUTO-CALIBRATION ===

  /**
   * –ê–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –≤–µ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ feedback
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–π feedback –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ —Ä–∏—Å–∫–∞
   * @returns {Object} –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Å–∞
   */
  function getCalibratedWeights() {
    const lsGet = getScopedLsGet();
    const lsSet = U.lsSet || ((k, v) => {
      try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { }
    });

    // –ë–∞–∑–æ–≤—ã–µ –≤–µ—Å–∞
    const defaultWeights = {
      sleepDebt: { mild: 15, moderate: 25, high: 40 },
      stress: { moderate: 15, high: 30 },
      chronicDeficit: { moderate: 20, severe: 35 },
      weekend: 15
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
    const calibrationKey = 'heys_risk_calibration';
    const calibration = lsGet(calibrationKey, null);

    if (!calibration) {
      return defaultWeights;
    }

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º feedback –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
    const feedback = lsGet('heys_metabolic_feedback', []);
    if (feedback.length < 10) {
      return calibration.weights || defaultWeights;
    }

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º feedback –ø–æ —Ñ–∞–∫—Ç–æ—Ä–∞–º
    const factorFeedback = {};
    feedback.forEach(f => {
      if (f.details?.factorId) {
        if (!factorFeedback[f.details.factorId]) {
          factorFeedback[f.details.factorId] = { correct: 0, incorrect: 0 };
        }
        if (f.correct) factorFeedback[f.details.factorId].correct++;
        else factorFeedback[f.details.factorId].incorrect++;
      }
    });

    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ—á–Ω–æ—Å—Ç–∏
    const weights = { ...defaultWeights };
    const adjustmentFactor = 0.1; // 10% –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é

    Object.entries(factorFeedback).forEach(([factorId, stats]) => {
      const total = stats.correct + stats.incorrect;
      if (total >= 5) {
        const accuracy = stats.correct / total;
        // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –≤–µ—Å, –µ—Å–ª–∏ –≤—ã—Å–æ–∫–∞—è ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
        const adjustment = (accuracy - 0.5) * adjustmentFactor;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É –≤–µ—Å—É
        if (factorId.includes('sleep')) {
          weights.sleepDebt.mild = Math.max(5, Math.min(25, defaultWeights.sleepDebt.mild * (1 + adjustment)));
          weights.sleepDebt.moderate = Math.max(10, Math.min(35, defaultWeights.sleepDebt.moderate * (1 + adjustment)));
          weights.sleepDebt.high = Math.max(20, Math.min(50, defaultWeights.sleepDebt.high * (1 + adjustment)));
        } else if (factorId.includes('stress')) {
          weights.stress.moderate = Math.max(5, Math.min(25, defaultWeights.stress.moderate * (1 + adjustment)));
          weights.stress.high = Math.max(15, Math.min(40, defaultWeights.stress.high * (1 + adjustment)));
        } else if (factorId.includes('deficit')) {
          weights.chronicDeficit.moderate = Math.max(10, Math.min(30, defaultWeights.chronicDeficit.moderate * (1 + adjustment)));
          weights.chronicDeficit.severe = Math.max(20, Math.min(45, defaultWeights.chronicDeficit.severe * (1 + adjustment)));
        }
      }
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Å–∞
    lsSet(calibrationKey, {
      weights,
      updatedAt: Date.now(),
      feedbackCount: feedback.length
    });

    return weights;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
   * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–∏—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
   */
  function getPersonalThresholds() {
    const lsGet = getScopedLsGet();

    const thresholdsKey = 'heys_personal_thresholds';
    const cached = lsGet(thresholdsKey, null);

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    if (cached && cached.updatedAt && Date.now() - cached.updatedAt < 24 * 60 * 60 * 1000) {
      return cached;
    }

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞ 30 –¥–Ω–µ–π
    const history = getDaysHistory(30);
    if (history.length < 14) {
      return {
        available: false,
        reason: 'need_more_data',
        daysRequired: 14,
        daysHave: history.length
      };
    }

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å—Ä—ã–≤–∞—Ö –∏ —Ä–∏—Å–∫–∞—Ö
    const crashDays = history.filter(d => d.ratio && d.ratio > 1.3);
    const goodDays = history.filter(d => d.ratio && d.ratio >= 0.85 && d.ratio <= 1.15);

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏—è –ø–µ—Ä–µ–¥ —Å—Ä—ã–≤–∞–º–∏
    const preCrashConditions = crashDays.map(crash => {
      const idx = history.findIndex(d => d.dateStr === crash.dateStr);
      if (idx <= 0) return null;
      return history[idx - 1]; // –î–µ–Ω—å –ø–µ—Ä–µ–¥ —Å—Ä—ã–≤–æ–º
    }).filter(Boolean);

    // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
    const thresholds = {
      available: true,

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –Ω–µ–¥–æ—Å—ã–ø–∞
      sleepThreshold: preCrashConditions.length > 0
        ? Math.round(preCrashConditions.reduce((sum, d) => sum + (d.sleepHours || 7), 0) / preCrashConditions.length)
        : 6,

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Å—Ç—Ä–µ—Å—Å–∞  
      stressThreshold: preCrashConditions.length > 0
        ? Math.round(preCrashConditions.reduce((sum, d) => sum + (d.stressAvg || 5), 0) / preCrashConditions.length)
        : 7,

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ (–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥)
      deficitDaysThreshold: crashDays.length > 0 ? 3 : 5,

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è "–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞" –∫–∞–ª–æ—Ä–∏–π
      dangerZoneRatio: crashDays.length > 0
        ? Math.round(crashDays.reduce((sum, d) => sum + (d.ratio || 1), 0) / crashDays.length * 100) / 100
        : 1.3,

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      crashCount: crashDays.length,
      goodDaysCount: goodDays.length,
      successRate: Math.round((goodDays.length / history.length) * 100),

      updatedAt: Date.now()
    };

    // –ö—ç—à–∏—Ä—É–µ–º
    const lsSet = U.lsSet || ((k, v) => {
      try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { }
    });
    lsSet(thresholdsKey, thresholds);

    return thresholds;
  }

  // === PHASE 6: WEEKLY WRAP ===

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Weekly Wrap ‚Äî –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤–µ—á–µ—Ä–æ–º
   * @returns {Object} —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –Ω–µ–¥–µ–ª–∏
   */
  function generateWeeklyWrap() {
    if (!HEYS.PredictiveInsights?.analyze) return null;

    const lsGet = getScopedLsGet();
    const profile = lsGet('heys_profile', {});
    // üîß Fix: buildIndex —á–µ—Ä–µ–∑ dayUtils
    const buildIdx = HEYS.dayUtils?.buildProductIndex || HEYS.models?.buildProductIndex;
    const prods = HEYS.products?.getAll?.() || lsGet('heys_products', []);
    const pIndex = buildIdx ? buildIdx(prods) : null;
    const analysis = HEYS.PredictiveInsights.analyze({
      daysBack: 60,
      lsGet,
      profile,
      pIndex
    });

    return analysis?.weeklyWrap || null;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –≤ –≥–æ–¥—É
   */
  function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å Weekly Wrap
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –ø–æ—Å–ª–µ 18:00
   */
  function shouldShowWeeklyWrap() {
    return HEYS.weeklyReports?.shouldShowWeeklyWrapPopup
      ? HEYS.weeklyReports.shouldShowWeeklyWrapPopup({
        now: new Date(),
        lsGet: getScopedLsGet()
      })
      : false;
  }

  /**
   * –û—Ç–º–µ—Ç–∏—Ç—å Weekly Wrap –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–π
   */
  function markWeeklyWrapShown() {
    if (HEYS.weeklyReports?.markWeeklyWrapShown) {
      HEYS.weeklyReports.markWeeklyWrapShown({
        lsSet: U.lsSet
      });
    }
  }

  // ========================================
  // A/B Testing –¥–ª—è —Ñ–æ—Ä–º—É–ª —Ä–∏—Å–∫–∞
  // ========================================

  // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è A/B (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä—è–º–æ–π localStorage –±–µ–∑ cloud sync)
  function abLsGet(key, defaultVal) {
    try {
      const stored = localStorage.getItem(key);
      return stored ? JSON.parse(stored) : defaultVal;
    } catch (e) {
      return defaultVal;
    }
  }

  function abLsSet(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      // Ignore
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç A/B —Ç–µ—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * –í–∞—Ä–∏–∞–Ω—Ç –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
   */
  function getABVariant() {
    if (!CONFIG.AB_TESTING.enabled) {
      return CONFIG.AB_TESTING.variants.A;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ cloud sync)
    const savedVariant = abLsGet(CONFIG.AB_TESTING.storageKey, null);
    if (savedVariant && CONFIG.AB_TESTING.variants[savedVariant]) {
      return CONFIG.AB_TESTING.variants[savedVariant];
    }

    // –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç
    const variantKeys = Object.keys(CONFIG.AB_TESTING.variants);
    const randomIndex = Math.floor(Math.random() * variantKeys.length);
    const selectedKey = variantKeys[randomIndex];

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä (–ª–æ–∫–∞–ª—å–Ω–æ)
    abLsSet(CONFIG.AB_TESTING.storageKey, selectedKey);

    return CONFIG.AB_TESTING.variants[selectedKey];
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∏—Å–∫–∞ –∏–∑ A/B –≤–∞—Ä–∏–∞–Ω—Ç–∞
   */
  function getABWeights() {
    const variant = getABVariant();
    return variant.weights;
  }

  /**
   * –ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç A/B —Ç–µ—Å—Ç–∞ (–ø–æ—Å–ª–µ —Ñ–∞–∫—Ç–∞)
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –¥–µ–Ω—å –∑–∞–∫–æ–Ω—á–µ–Ω –∏ –º—ã –∑–Ω–∞–µ–º –±—ã–ª –ª–∏ —Å—Ä—ã–≤
   */
  function recordABResult(dateStr, predictedRisk, actualRatio) {
    if (!CONFIG.AB_TESTING.enabled) return;

    const variant = getABVariant();
    const wasCrash = actualRatio > 1.3 || actualRatio < 0.5; // –°—Ä—ã–≤ = –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ –∏–ª–∏ —Å–∏–ª—å–Ω—ã–π –Ω–µ–¥–æ–±–æ—Ä
    const wasHighRisk = predictedRisk >= 60;

    // –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è:
    // True Positive: –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –±—ã–ª –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω –ò —Å–ª—É—á–∏–ª—Å—è —Å—Ä—ã–≤
    // True Negative: –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ –±—ã–ª –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω –ò –ù–ï —Å–ª—É—á–∏–ª—Å—è —Å—Ä—ã–≤
    // False Positive: –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –±—ã–ª –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω, –Ω–æ —Å—Ä—ã–≤–∞ –ù–ï –±—ã–ª–æ
    // False Negative: –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ –±—ã–ª –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω, –Ω–æ —Å—Ä—ã–≤ —Å–ª—É—á–∏–ª—Å—è

    const results = abLsGet(CONFIG.AB_TESTING.resultsKey, {
      A: { tp: 0, tn: 0, fp: 0, fn: 0 },
      B: { tp: 0, tn: 0, fp: 0, fn: 0 },
      C: { tp: 0, tn: 0, fp: 0, fn: 0 }
    });

    if (!results[variant.id]) {
      results[variant.id] = { tp: 0, tn: 0, fp: 0, fn: 0 };
    }

    if (wasHighRisk && wasCrash) {
      results[variant.id].tp++; // True Positive
    } else if (!wasHighRisk && !wasCrash) {
      results[variant.id].tn++; // True Negative
    } else if (wasHighRisk && !wasCrash) {
      results[variant.id].fp++; // False Positive
    } else if (!wasHighRisk && wasCrash) {
      results[variant.id].fn++; // False Negative
    }

    abLsSet(CONFIG.AB_TESTING.resultsKey, results);

    return results[variant.id];
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É A/B —Ç–µ—Å—Ç–∞
   */
  function getABStats() {
    const results = abLsGet(CONFIG.AB_TESTING.resultsKey, {});

    const stats = {};

    for (const [variantId, data] of Object.entries(results)) {
      const total = data.tp + data.tn + data.fp + data.fn;
      if (total === 0) continue;

      const accuracy = (data.tp + data.tn) / total;
      const precision = data.tp + data.fp > 0 ? data.tp / (data.tp + data.fp) : 0;
      const recall = data.tp + data.fn > 0 ? data.tp / (data.tp + data.fn) : 0;
      const f1 = precision + recall > 0 ? 2 * (precision * recall) / (precision + recall) : 0;

      stats[variantId] = {
        total,
        accuracy: Math.round(accuracy * 100),
        precision: Math.round(precision * 100),
        recall: Math.round(recall * 100),
        f1: Math.round(f1 * 100),
        ...data
      };
    }

    return {
      currentVariant: getABVariant().id,
      variantStats: stats,
      bestVariant: Object.entries(stats).sort((a, b) => b[1].f1 - a[1].f1)[0]?.[0] || 'A'
    };
  }

  // === EXPORT ===
  HEYS.Metabolic = {
    VERSION: CONFIG.VERSION,

    // Main API
    getStatus,
    clearCache,

    // Phase 0: Foundation
    inventoryData,
    calculateDataCompleteness,
    calculatePlanAdherence,
    calculateCrashRisk,
    calculateMetabolicPhase,

    // Phase 2: Predictive
    calculateCrashRisk24h,
    calculatePerformanceForecast,

    // Phase 3: Personalization
    identifyPhenotype,
    calculatePersonalThresholds,
    submitFeedback,
    getFeedbackStats,

    // Phase 4: Integration
    generateReport,

    // Phase 5: Auto-Calibration
    getCalibratedWeights,
    getPersonalThresholds,

    // Phase 6: Weekly Wrap
    generateWeeklyWrap,
    shouldShowWeeklyWrap,
    markWeeklyWrapShown,

    // Phase 7: Gamification Integration
    notifyGamification,

    // Phase 8: A/B Testing
    getABVariant,
    getABWeights,
    recordABResult,
    getABStats,

    // Utils
    getDaysHistory, // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ UI

    // Config
    CONFIG,
    BASELINE
  };

  // === DEBUG ===
  // –í—ã–∑–æ–≤–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏: HEYS.Metabolic.debugDaysHistory()
  HEYS.Metabolic.debugDaysHistory = function () {
    const lsGet = getScopedLsGet();
    const today = new Date();
    const results = [];

    for (let i = 0; i < 14; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const day = lsGet(`heys_dayv2_${dateStr}`, null);

      const hasMeals = day?.meals?.some?.(m => m?.items?.length > 0);
      const mealsCount = day?.meals?.length || 0;
      const itemsCount = day?.meals?.reduce?.((sum, m) => sum + (m?.items?.length || 0), 0) || 0;

      results.push({
        date: dateStr,
        daysAgo: i,
        exists: !!day,
        hasMeals,
        mealsCount,
        itemsCount,
        steps: day?.steps || 0,
        weight: day?.weightMorning || null
      });
    }

    console.table(results);
    const validDays = results.filter(r => r.hasMeals).length;
    console.log(`‚úÖ –î–Ω–µ–π —Å –µ–¥–æ–π: ${validDays} / 14 (–Ω—É–∂–Ω–æ 7 –¥–ª—è —Ñ–µ–Ω–æ—Ç–∏–ø–∞)`);
    return results;
  };

  // ========================================
  // Phase 7: Gamification Integration
  // ========================================

  /**
   * üéÆ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö
   * –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
   */
  function notifyGamification() {
    if (!window.HEYS?.game) return;

    try {
      const days = getDaysHistory(14);
      if (days.length < 7) return;

      // –ü–æ–¥—Å—á—ë—Ç –¥–Ω–µ–π —Å–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º score (‚â•70)
      let stableDaysCount = 0;
      for (let i = 0; i < Math.min(7, days.length); i++) {
        const dayScore = calculateDayScore(days[i]);
        if (dayScore >= 70) stableDaysCount++;
        else break; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º streak
      }

      // –ü–æ–¥—Å—á—ë—Ç –¥–Ω–µ–π —Å –Ω–∏–∑–∫–∏–º —Ä–∏—Å–∫–æ–º
      let lowRiskDaysCount = 0;
      for (let i = 0; i < Math.min(14, days.length); i++) {
        const risk = calculateCrashRisk24h();
        if (risk.level === 'low') lowRiskDaysCount++;
        else break;
      }

      // –ü–æ–ª—É—á–∞–µ–º —Ñ–µ–Ω–æ—Ç–∏–ø
      const phenotype = identifyPhenotype();

      // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
      window.HEYS.game.checkMetabolicAchievements?.({
        stableDaysCount,
        lowRiskDaysCount,
        phenotype
      });

    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
    }
  }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_supplements_science_v1.js ===== */
// heys_supplements_science_v1.js ‚Äî –ù–∞—É—á–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥—É–ª—è –≤–∏—Ç–∞–º–∏–Ω–æ–≤
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2025-12-14
// –ë–∏–æ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã, 50+ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π, –¥–µ—Ñ–∏—Ü–∏—Ç—ã –ø–æ —Å–∏–º–ø—Ç–æ–º–∞–º
(function(global) {
  const HEYS = global.HEYS = global.HEYS || {};
  
  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è
  if (!HEYS.Supplements) {
    console.warn('[HEYS] Supplements Science: –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    return;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üî¨ –ù–ê–£–ß–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–• ‚Äî –ë–ò–û–î–û–°–¢–£–ü–ù–û–°–¢–¨
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const BIOAVAILABILITY = {
    // –í–∏—Ç–∞–º–∏–Ω D3
    vitD: {
      baseAbsorption: 0.5,           // 50% –±–∞–∑–æ–≤–∞—è –∞–±—Å–æ—Ä–±—Ü–∏—è
      withFat: 0.8,                   // 80% —Å –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π
      optimalFatGrams: 15,            // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ 15–≥ –∂–∏—Ä–∞
      minFatGrams: 5,                 // –ú–∏–Ω–∏–º—É–º 5–≥ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
      halfLife: '2-3 –Ω–µ–¥–µ–ª–∏',         // –ü–µ—Ä–∏–æ–¥ –ø–æ–ª—É–≤—ã–≤–µ–¥–µ–Ω–∏—è
      storage: '–∂–∏—Ä–æ–≤–∞—è —Ç–∫–∞–Ω—å',
      toxicityRisk: '–Ω–∏–∑–∫–∏–π –ø—Ä–∏ <10000 IU/–¥–µ–Ω—å',
      synergists: ['vitK2', 'magnesium', 'calcium'],
      mechanism: '–•–æ–ª–µ–∫–∞–ª—å—Ü–∏—Ñ–µ—Ä–æ–ª –∞–±—Å–æ—Ä–±–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–æ–Ω–∫–æ–º –∫–∏—à–µ—á–Ω–∏–∫–µ —á–µ—Ä–µ–∑ –º–∏—Ü–µ–ª–ª—ã –∂–µ–ª—á–Ω—ã—Ö –∫–∏—Å–ª–æ—Ç. –ñ–∏—Ä—ã —Å—Ç–∏–º—É–ª–∏—Ä—É—é—Ç –≤—ã–±—Ä–æ—Å –∂–µ–ª—á–∏ ‚Üí —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–∏—Ü–µ–ª–ª ‚Üí –ª—É—á—à–∞—è –∞–±—Å–æ—Ä–±—Ü–∏—è.',
      optimalDose: '1000-4000 IU/–¥–µ–Ω—å',
      testMarker: '25(OH)D –≤ –∫—Ä–æ–≤–∏',
      optimalLevel: '40-60 –Ω–≥/–º–ª'
    },
    
    // –í–∏—Ç–∞–º–∏–Ω K2 (MK-7)
    vitK2: {
      baseAbsorption: 0.3,
      withFat: 0.7,
      optimalFatGrams: 10,
      minFatGrams: 3,
      halfLife: '3 –¥–Ω—è (MK-7)',
      storage: '–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π',
      synergists: ['vitD', 'calcium'],
      mechanism: 'K2 –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –æ—Å—Ç–µ–æ–∫–∞–ª—å—Ü–∏–Ω (–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç Ca –≤ –∫–æ—Å—Ç–∏) –∏ MGP (—É–±–∏—Ä–∞–µ—Ç Ca –∏–∑ –∞—Ä—Ç–µ—Ä–∏–π). –†–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞—Ä–µ —Å D3.',
      optimalDose: '100-200 –º–∫–≥ MK-7',
      ratio: 'D3:K2 = 1000 IU : 100 –º–∫–≥'
    },
    
    // –û–º–µ–≥–∞-3 (EPA/DHA)
    omega3: {
      baseAbsorption: 0.25,
      withFat: 0.6,
      optimalFatGrams: 15,
      minFatGrams: 5,
      halfLife: '2-3 –¥–Ω—è',
      storage: '–∫–ª–µ—Ç–æ—á–Ω—ã–µ –º–µ–º–±—Ä–∞–Ω—ã',
      synergists: ['vitE', 'vitD'],
      antagonists: ['omega6 –∏–∑–±—ã—Ç–æ–∫'],
      mechanism: 'EPA/DHA –≤—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ —Ñ–æ—Å—Ñ–æ–ª–∏–ø–∏–¥—ã –º–µ–º–±—Ä–∞–Ω, —Å–Ω–∏–∂–∞—é—Ç –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ä–µ–∑–æ–ª—å–≤–∏–Ω—ã –∏ –ø—Ä–æ—Ç–µ–∫—Ç–∏–Ω—ã.',
      optimalDose: '1-3–≥ EPA+DHA',
      ratio: 'EPA:DHA = 2:1 –¥–ª—è –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è, 1:2 –¥–ª—è –º–æ–∑–≥–∞',
      oxidationRisk: '–≤—ã—Å–æ–∫–∏–π ‚Äî —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ö–æ–ª–æ–¥–µ'
    },
    
    // –ñ–µ–ª–µ–∑–æ
    iron: {
      baseAbsorption: 0.15,           // 15% –¥–ª—è –Ω–µ–≥–µ–º–æ–≤–æ–≥–æ –∂–µ–ª–µ–∑–∞
      hemeAbsorption: 0.35,           // 35% –¥–ª—è –≥–µ–º–æ–≤–æ–≥–æ (–º—è—Å–æ)
      withVitC: 0.45,                 // +200% —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º C
      withoutInhibitors: 0.25,
      inhibitors: ['–∫–∞–ª—å—Ü–∏–π', '—Ç–∞–Ω–∏–Ω—ã', '—Ñ–∏—Ç–∞—Ç—ã', '–∫–æ—Ñ–µ', '—á–∞–π'],
      halfLife: '–≥–æ–¥—ã (–≤ —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω–µ)',
      storage: '—Ñ–µ—Ä—Ä–∏—Ç–∏–Ω, –≥–µ–º–æ–≥–ª–æ–±–∏–Ω',
      synergists: ['vitC', 'vitA', 'copper'],
      mechanism: '–ù–µ–≥–µ–º–æ–≤–æ–µ Fe3+ ‚Üí Fe2+ (–≤–∏—Ç–∞–º–∏–Ω C) ‚Üí DMT1 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ—Ä ‚Üí —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω/—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—Ä–∏–Ω',
      optimalDose: '18–º–≥/–¥–µ–Ω—å (–∂–µ–Ω—â–∏–Ω—ã), 8–º–≥/–¥–µ–Ω—å (–º—É–∂—á–∏–Ω—ã)',
      testMarker: '—Ñ–µ—Ä—Ä–∏—Ç–∏–Ω + —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—Ä–∏–Ω',
      toxicityRisk: '—Å—Ä–µ–¥–Ω–∏–π ‚Äî –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –±–µ–∑ –∞–Ω–∞–ª–∏–∑–æ–≤'
    },
    
    // –ú–∞–≥–Ω–∏–π
    magnesium: {
      baseAbsorption: 0.35,
      forms: {
        oxide: { absorption: 0.04, use: '—Å–ª–∞–±–∏—Ç–µ–ª—å–Ω–æ–µ' },
        citrate: { absorption: 0.25, use: '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π' },
        glycinate: { absorption: 0.40, use: '—Å–æ–Ω, –Ω–µ—Ä–≤—ã' },
        threonate: { absorption: 0.35, use: '–º–æ–∑–≥, –ø–∞–º—è—Ç—å' },
        taurate: { absorption: 0.35, use: '—Å–µ—Ä–¥—Ü–µ' },
        malate: { absorption: 0.30, use: '—ç–Ω–µ—Ä–≥–∏—è, –º—ã—à—Ü—ã' }
      },
      inhibitors: ['—Ñ–∏—Ç–∞—Ç—ã', '–∏–∑–±—ã—Ç–æ–∫ –∫–∞–ª—å—Ü–∏—è', '–∞–ª–∫–æ–≥–æ–ª—å'],
      halfLife: '12-24 —á–∞—Å–∞',
      storage: '–∫–æ—Å—Ç–∏ (60%), –º—ã—à—Ü—ã (39%)',
      synergists: ['vitB6', 'vitD'],
      mechanism: 'Mg ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä 600+ —Ñ–µ—Ä–º–µ–Ω—Ç–æ–≤. –ö—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è ATP, —Å–∏–Ω—Ç–µ–∑–∞ –±–µ–ª–∫–∞, –Ω–µ—Ä–≤–Ω–æ–π –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç–∏.',
      optimalDose: '400-600–º–≥ —ç–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ–≥–æ Mg',
      testMarker: 'Mg –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∞—Ö (–Ω–µ —Å—ã–≤–æ—Ä–æ—Ç–∫–∞!)',
      bestTime: '–≤–µ—á–µ—Ä (—Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è)'
    },
    
    // –¶–∏–Ω–∫
    zinc: {
      baseAbsorption: 0.30,
      withProtein: 0.40,
      inhibitors: ['—Ñ–∏—Ç–∞—Ç—ã', '–∂–µ–ª–µ–∑–æ (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è)', '–∫–∞–ª—å—Ü–∏–π'],
      halfLife: '2-3 –Ω–µ–¥–µ–ª–∏',
      storage: '–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π',
      synergists: ['vitA', 'vitB6'],
      antagonists: ['copper (–ø—Ä–∏ –∏–∑–±—ã—Ç–∫–µ Zn)'],
      mechanism: 'Zn ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä 300+ —Ñ–µ—Ä–º–µ–Ω—Ç–æ–≤, –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞, –∑–∞–∂–∏–≤–ª–µ–Ω–∏—è, —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–∞.',
      optimalDose: '15-30–º–≥',
      ratio: 'Zn:Cu = 10:1',
      testMarker: '—Ü–∏–Ω–∫ —Å—ã–≤–æ—Ä–æ—Ç–∫–∏',
      bestTime: '—Å –±–µ–ª–∫–æ–≤–æ–π –µ–¥–æ–π, –Ω–µ —Å –∂–µ–ª–µ–∑–æ–º'
    },
    
    // –í–∏—Ç–∞–º–∏–Ω B12
    b12: {
      baseAbsorption: 0.50,
      withIntrinsicFactor: 0.90,
      sublingual: 0.60,
      forms: {
        cyanocobalamin: { absorption: 0.40, conversion: '—Ç—Ä–µ–±—É–µ—Ç—Å—è' },
        methylcobalamin: { absorption: 0.55, conversion: '–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º–∞' },
        adenosylcobalamin: { absorption: 0.50, conversion: '–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º–∞' }
      },
      halfLife: '6-12 –º–µ—Å—è—Ü–µ–≤',
      storage: '–ø–µ—á–µ–Ω—å (2-5 –ª–µ—Ç –∑–∞–ø–∞—Å)',
      synergists: ['folate', 'b6'],
      mechanism: 'B12 –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –º–µ—Ç–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–∏–Ω—Ç–µ–∑–∞ –î–ù–ö, –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –î–µ—Ñ–∏—Ü–∏—Ç ‚Üí –∞–Ω–µ–º–∏—è, –Ω–µ–π—Ä–æ–ø–∞—Ç–∏—è.',
      optimalDose: '500-1000 –º–∫–≥ –º–µ—Ç–∏–ª–∫–æ–±–∞–ª–∞–º–∏–Ω–∞',
      riskGroups: ['–≤–µ–≥–∞–Ω—ã', '50+ –ª–µ—Ç', '–ø—Ä–∏—ë–º –º–µ—Ç—Ñ–æ—Ä–º–∏–Ω–∞'],
      testMarker: 'B12 + –≥–æ–º–æ—Ü–∏—Å—Ç–µ–∏–Ω + MMA'
    },
    
    // –í–∏—Ç–∞–º–∏–Ω C
    vitC: {
      baseAbsorption: 0.70,
      saturationDose: 200,            // –º–≥ ‚Äî –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∞–±—Å–æ—Ä–±—Ü–∏—è –ø–∞–¥–∞–µ—Ç
      highDoseAbsorption: 0.30,       // –ø—Ä–∏ >1000–º–≥
      halfLife: '2-3 —á–∞—Å–∞',
      storage: '–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π',
      synergists: ['vitE', 'iron', 'collagen'],
      mechanism: '–ê—Å–∫–æ—Ä–±–∞—Ç ‚Äî –¥–æ–Ω–æ—Ä —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤, —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç vitE, –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –∫–æ–ª–ª–∞–≥–µ–Ω–∞.',
      optimalDose: '500-1000–º–≥, —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 2-3 –ø—Ä–∏—ë–º–∞',
      forms: {
        ascorbicAcid: { absorption: 0.70, gastric: '–º–æ–∂–µ—Ç —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å' },
        sodiumAscorbate: { absorption: 0.70, gastric: '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π' },
        liposomal: { absorption: 0.90, gastric: '–æ—Ç–ª–∏—á–Ω–æ' }
      },
      bestTime: '—É—Ç—Ä–æ + –¥–µ–Ω—å (–Ω–µ –≤–µ—á–µ—Ä ‚Äî –º–æ–∂–µ—Ç –±–æ–¥—Ä–∏—Ç—å)'
    },
    
    // CoQ10
    coq10: {
      baseAbsorption: 0.03,           // –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è!
      withFat: 0.08,
      ubiquinol: 0.15,                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ ‚Äî –ª—É—á—à–µ
      halfLife: '33 —á–∞—Å–∞',
      storage: '–º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–∏',
      synergists: ['vitE', 'selenium'],
      mechanism: 'CoQ10 ‚Äî –ø–µ—Ä–µ–Ω–æ—Å—á–∏–∫ —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤ –≤ –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏—è—Ö, –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è ATP. –ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç.',
      optimalDose: '100-300–º–≥ —É–±–∏—Ö–∏–Ω–æ–ª–∞',
      note: '–°—Ç–∞—Ç–∏–Ω—ã –∏—Å—Ç–æ—â–∞—é—Ç CoQ10 ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å',
      bestTime: '—Å –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π'
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ö†Ô∏è –õ–ò–ú–ò–¢–´ / UPPER LIMITS (UL) ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  // –í–∞–∂–Ω–æ: —ç—Ç–æ –Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è. –î–ª—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π,
  // –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏, —Ç–µ—Ä–∞–ø–∏–∏ –∏ –≤—ã—Å–æ–∫–∏—Ö –¥–æ–∑ ‚Äî —Ç–æ–ª—å–∫–æ —Å –≤—Ä–∞—á–æ–º –∏ –∞–Ω–∞–ª–∏–∑–∞–º–∏.
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const LIMITS = {
    vitD: {
      ul: 10000,
      unit: 'IU',
      note: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã –ø–æ–≤—ã—à–∞—é—Ç —Ä–∏—Å–∫ –≥–∏–ø–µ—Ä–∫–∞–ª—å—Ü–∏–µ–º–∏–∏. –ö–æ–Ω—Ç—Ä–æ–ª—å 25(OH)D –∏ Ca –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –ø—Ä–∏—ë–º–µ.',
      courseMaxDays: 120,
      courseNote: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã –æ–±—ã—á–Ω–æ –∫—É—Ä—Å–∞–º–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∞–Ω–∞–ª–∏–∑–æ–≤.'
    },
    vitC: {
      ul: 2000,
      unit: 'mg',
      note: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã —á–∞—â–µ –¥–∞—é—Ç –ñ–ö–¢-—Å–∏–º–ø—Ç–æ–º—ã. –õ—É—á—à–µ –¥—Ä–æ–±–∏—Ç—å –Ω–∞ 2-3 –ø—Ä–∏—ë–º–∞.',
      courseMaxDays: 365
    },
    magnesium: {
      ul: 350,
      unit: 'mg',
      note: 'UL –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –î–û–ë–ê–í–ö–ê–ú (—ç–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–π Mg), –Ω–µ –∫ Mg –∏–∑ –ø–∏—â–∏. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø–æ—á–∫–∞–º–∏ ‚Äî –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ.',
      courseMaxDays: 365
    },
    zinc: {
      ul: 40,
      unit: 'mg',
      note: '–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã Zn –º–æ–≥—É—Ç —Å–Ω–∏–∂–∞—Ç—å Cu. –°–º–æ—Ç—Ä–∏ –±–∞–ª–∞–Ω—Å Zn:Cu.',
      courseMaxDays: 90,
      courseNote: '–ï—Å–ª–∏ >25-30–º–≥/–¥–µ–Ω—å ‚Äî –ª—É—á—à–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –∫—É—Ä—Å –∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ Cu.'
    },
    iron: {
      ul: 45,
      unit: 'mg',
      note: '–ñ–µ–ª–µ–∑–æ –±–µ–∑ –∞–Ω–∞–ª–∏–∑–æ–≤ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å. –†–∏—Å–∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∞ –∂–µ–ª–µ–∑–æ–º. –û—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω/—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—Ä–∏–Ω.',
      courseMaxDays: 60,
      courseNote: '–ö—É—Ä—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞; –æ–±—ã—á–Ω–æ —Å –∞–Ω–∞–ª–∏–∑–∞–º–∏ –∏ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–æ–º –¥–æ–∑—ã.'
    },
    omega3: {
      ul: 3,
      unit: 'g',
      note: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã EPA+DHA —Ç—Ä–µ–±—É—é—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –∞–Ω—Ç–∏–∫–æ–∞–≥—É–ª—è–Ω—Ç–æ–≤/–ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏.',
      courseMaxDays: 365
    },
    b12: {
      note: 'UL –¥–ª—è B12 –æ–±—ã—á–Ω–æ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (–Ω–∏–∑–∫–∞—è —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å). –î–æ–∑—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø—Ä–∏—á–∏–Ω—ã –¥–µ—Ñ–∏—Ü–∏—Ç–∞.'
    },
    coq10: {
      note: '–û–±—ã—á–Ω–æ —Ö–æ—Ä–æ—à–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è. –í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã –æ–±—Å—É–∂–¥–∞—Ç—å —Å –≤—Ä–∞—á–æ–º –ø—Ä–∏ —Ç–µ—Ä–∞–ø–∏–∏ –∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è—Ö.'
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚è∞ –¶–ò–†–ö–ê–î–ù–´–ï –†–ò–¢–ú–´ ‚Äî –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ï –í–†–ï–ú–Ø –ü–†–ò–Å–ú–ê
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const CIRCADIAN_OPTIMAL = {
    // –£—Ç—Ä–æ (6-10)
    morning: {
      supplements: ['vitD', 'b12', 'vitC', 'iron', 'coq10'],
      reason: '–ö–æ—Ä—Ç–∏–∑–æ–ª –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —É—Ç—Ä–æ–º ‚Üí –ª—É—á—à–∞—è –∞–±—Å–æ—Ä–±—Ü–∏—è –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã—Ö. B12/C –±–æ–¥—Ä—è—Ç.',
      avoid: ['magnesium', 'melatonin', 'glycine']
    },
    
    // –î–µ–Ω—å (10-14)
    midday: {
      supplements: ['omega3', 'vitE', 'zinc'],
      reason: '–ü–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –∂–∏—Ä–Ω–∞—è –µ–¥–∞ –Ω–∞ –æ–±–µ–¥ ‚Üí –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã—Ö.',
      avoid: ['melatonin']
    },
    
    // –í–µ—á–µ—Ä (18-21)
    evening: {
      supplements: ['magnesium', 'vitK2', 'calcium'],
      reason: 'Mg —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç, K2 —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—á—å—é (–∫–æ—Å—Ç–Ω–∞—è —Ä–µ–º–æ–¥—É–ª—è—Ü–∏—è).',
      avoid: ['vitC', 'b12', 'coq10']
    },
    
    // –ü–µ—Ä–µ–¥ —Å–Ω–æ–º (21-23)
    beforeBed: {
      supplements: ['magnesium', 'glycine', 'melatonin', 'ashwagandha'],
      reason: '–†–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ —Å–Ω—É, –Ω–æ—á–Ω–∞—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è.',
      avoid: ['vitD', 'b12', 'iron', 'vitC']
    },
    
    // –•—Ä–æ–Ω–æ—Ç–∏–ø—ã
    chronotypes: {
      lark: {  // –ñ–∞–≤–æ—Ä–æ–Ω–æ–∫
        shift: -1,  // –ù–∞ —á–∞—Å —Ä–∞–Ω—å—à–µ
        note: '–£—Ç—Ä–µ–Ω–Ω–∏–µ –¥–æ–±–∞–≤–∫–∏ –≤ 6-7, –≤–µ—á–µ—Ä–Ω–∏–µ –≤ 20-21'
      },
      owl: {   // –°–æ–≤–∞
        shift: +2,  // –ù–∞ 2 —á–∞—Å–∞ –ø–æ–∑–∂–µ
        note: '–£—Ç—Ä–µ–Ω–Ω–∏–µ –¥–æ–±–∞–≤–∫–∏ –≤ 9-11, –≤–µ—á–µ—Ä–Ω–∏–µ –≤ 22-23'
      }
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîó –†–ê–°–®–ò–†–ï–ù–ù–´–ï –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø (50+)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const INTERACTIONS_EXTENDED = {
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–ò–ù–ï–†–ì–ò–ò (—É—Å–∏–ª–∏–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    synergies: [
      {
        pair: ['vitD', 'vitK2'],
        effect: 'critical',
        mechanism: 'D3 —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é Ca, K2 –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç Ca –≤ –∫–æ—Å—Ç–∏ (–Ω–µ –∞—Ä—Ç–µ—Ä–∏–∏). –ë–µ–∑ K2 —Ä–∏—Å–∫ –∫–∞–ª—å—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ—Å—É–¥–æ–≤!',
        ratio: '1000 IU D3 : 100 –º–∫–≥ K2',
        evidence: 'RCT, meta-analysis'
      },
      {
        pair: ['vitD', 'magnesium'],
        effect: 'high',
        mechanism: 'Mg –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ D3 (–≥–∏–¥—Ä–æ–∫—Å–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–µ—á–µ–Ω–∏ –∏ –ø–æ—á–∫–∞—Ö). –ë–µ–∑ Mg ‚Äî D3 –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω.',
        evidence: 'observational + mechanistic'
      },
      {
        pair: ['iron', 'vitC'],
        effect: 'critical',
        mechanism: 'VitC –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Fe3+ ‚Üí Fe2+ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –∞–±—Å–æ—Ä–±—Ü–∏–∏). –£—Å–∏–ª–µ–Ω–∏–µ +200-300%.',
        timing: '–ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–º–µ—Å—Ç–µ',
        evidence: 'RCT, gold standard'
      },
      {
        pair: ['iron', 'vitA'],
        effect: 'moderate',
        mechanism: 'VitA –º–æ–±–∏–ª–∏–∑—É–µ—Ç –∂–µ–ª–µ–∑–æ –∏–∑ –¥–µ–ø–æ, —É–ª—É—á—à–∞–µ—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏—é.',
        evidence: 'observational'
      },
      {
        pair: ['zinc', 'vitA'],
        effect: 'moderate',
        mechanism: 'Zn –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—Ç–∏–Ω–æ–ª-—Å–≤—è–∑—ã–≤–∞—é—â–µ–≥–æ –±–µ–ª–∫–∞.',
        evidence: 'mechanistic'
      },
      {
        pair: ['b12', 'folate'],
        effect: 'critical',
        mechanism: '–†–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ –≤ —Ü–∏–∫–ª–µ –º–µ—Ç–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è. –î–µ—Ñ–∏—Ü–∏—Ç –æ–¥–Ω–æ–≥–æ –º–∞—Å–∫–∏—Ä—É–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç –¥—Ä—É–≥–æ–≥–æ.',
        warning: '–§–æ–ª–∞—Ç –±–µ–∑ B12 –º–æ–∂–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å B12-–¥–µ—Ñ–∏—Ü–∏—Ç ‚Üí –Ω–µ–π—Ä–æ–ø–∞—Ç–∏—è',
        evidence: 'clinical'
      },
      {
        pair: ['vitE', 'vitC'],
        effect: 'high',
        mechanism: 'VitC —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–∫–∏—Å–ª–µ–Ω–Ω—ã–π vitE, –ø—Ä–æ–¥–ª–µ–≤–∞—è –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–Ω—É—é –∑–∞—â–∏—Ç—É.',
        evidence: 'mechanistic + RCT'
      },
      {
        pair: ['vitE', 'selenium'],
        effect: 'high',
        mechanism: 'Se ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä –≥–ª—É—Ç–∞—Ç–∏–æ–Ω–ø–µ—Ä–æ–∫—Å–∏–¥–∞–∑—ã, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞—Ä–µ —Å vitE –∫–∞–∫ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç.',
        evidence: 'mechanistic'
      },
      {
        pair: ['omega3', 'vitE'],
        effect: 'moderate',
        mechanism: 'VitE –∑–∞—â–∏—â–∞–µ—Ç omega3 –æ—Ç –æ–∫–∏—Å–ª–µ–Ω–∏—è (PUFA –æ—á–µ–Ω—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã).',
        timing: '–ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–º–µ—Å—Ç–µ',
        evidence: 'mechanistic'
      },
      {
        pair: ['calcium', 'vitD'],
        effect: 'critical',
        mechanism: 'D3 —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é Ca –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ —á–µ—Ä–µ–∑ –∫–∞–ª—å–±–∏–Ω–¥–∏–Ω.',
        evidence: 'gold standard'
      },
      {
        pair: ['magnesium', 'vitB6'],
        effect: 'high',
        mechanism: 'B6 —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏–∫–ª–µ—Ç–æ—á–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ Mg.',
        evidence: 'RCT'
      },
      {
        pair: ['coq10', 'omega3'],
        effect: 'moderate',
        mechanism: '–û–±–∞ —É–ª—É—á—à–∞—é—Ç –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –≤–∑–∞–∏–º–Ω–æ —É—Å–∏–ª–∏–≤–∞—é—Ç.',
        evidence: 'mechanistic'
      },
      {
        pair: ['curcumin', 'piperine'],
        effect: 'critical',
        mechanism: '–ü–∏–ø–µ—Ä–∏–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–ª—é–∫—É—Ä–æ–Ω–∏–¥–∞—Ü–∏—é –∫—É—Ä–∫—É–º–∏–Ω–∞ ‚Üí +2000% –±–∏–æ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.',
        ratio: '95% –∫—É—Ä–∫—É–º–∏–Ω + 5% –ø–∏–ø–µ—Ä–∏–Ω',
        evidence: 'RCT'
      },
      {
        pair: ['vitD', 'omega3'],
        effect: 'moderate',
        mechanism: '–û–±–∞ ‚Äî –ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ, —Å–∏–Ω–µ—Ä–≥–∏—è –≤ –∏–º–º—É–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.',
        evidence: 'observational'
      }
    ],
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ê–ù–¢–ê–ì–û–ù–ò–ó–ú–´ (–º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    antagonisms: [
      {
        pair: ['calcium', 'iron'],
        effect: 'high',
        mechanism: 'Ca –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç —Å Fe –∑–∞ DMT1 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ—Ä. –°–Ω–∏–∂–µ–Ω–∏–µ –∞–±—Å–æ—Ä–±—Ü–∏–∏ Fe –¥–æ 50%.',
        solution: '–†–∞–∑–¥–µ–ª–∏—Ç—å –ø—Ä–∏—ë–º –Ω–∞ 2-3 —á–∞—Å–∞',
        evidence: 'RCT'
      },
      {
        pair: ['zinc', 'iron'],
        effect: 'moderate',
        mechanism: '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ DMT1 –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö –¥–æ–∑–∞—Ö (>25–º–≥ –∫–∞–∂–¥–æ–≥–æ).',
        solution: '–†–∞–∑–¥–µ–ª–∏—Ç—å –∏–ª–∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å –µ–¥–æ–π',
        evidence: 'RCT'
      },
      {
        pair: ['zinc', 'copper'],
        effect: 'high',
        mechanism: '–ò–∑–±—ã—Ç–æ–∫ Zn (>50–º–≥) –∏–Ω–¥—É—Ü–∏—Ä—É–µ—Ç –º–µ—Ç–∞–ª–ª–æ—Ç–∏–æ–Ω–µ–∏–Ω ‚Üí —Å–≤—è–∑—ã–≤–∞–µ—Ç Cu ‚Üí –¥–µ—Ñ–∏—Ü–∏—Ç –º–µ–¥–∏.',
        solution: '–°–æ–±–ª—é–¥–∞—Ç—å Zn:Cu = 10:1',
        evidence: 'clinical'
      },
      {
        pair: ['calcium', 'magnesium'],
        effect: 'moderate',
        mechanism: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã Ca –º–æ–≥—É—Ç —Å–Ω–∏–∂–∞—Ç—å –∞–±—Å–æ—Ä–±—Ü–∏—é Mg.',
        solution: 'Ca:Mg = 2:1, —Ä–∞–∑–¥–µ–ª–∏—Ç—å –µ—Å–ª–∏ –≤—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã',
        evidence: 'observational'
      },
      {
        pair: ['vitE', 'vitK'],
        effect: 'moderate',
        mechanism: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã vitE (>800 IU) –º–æ–≥—É—Ç –∞–Ω—Ç–∞–≥–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å vitK (—Å–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ).',
        solution: '–ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å 400 IU vitE',
        evidence: 'clinical'
      },
      {
        pair: ['folate', 'b12'],
        effect: 'masking',
        mechanism: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã —Ñ–æ–ª–∞—Ç–∞ –º–∞—Å–∫–∏—Ä—É—é—Ç B12-–¥–µ—Ñ–∏—Ü–∏—Ç, –ø–æ–∑–≤–æ–ª—è—è –Ω–µ–π—Ä–æ–ø–∞—Ç–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞—Ç—å.',
        warning: '–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å B12 –ø–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–æ–º —Ñ–æ–ª–∞—Ç–∞',
        evidence: 'clinical'
      }
    ],
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –° –ï–î–û–ô ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    foodInteractions: {
      enhancers: [
        { food: '–∂–∏—Ä–Ω–∞—è —Ä—ã–±–∞', supplements: ['vitD', 'vitK2', 'vitE', 'omega3'], effect: '+50-80% –∞–±—Å–æ—Ä–±—Ü–∏—è' },
        { food: '–∞–≤–æ–∫–∞–¥–æ', supplements: ['vitD', 'vitK2', 'vitE', 'vitA'], effect: '+40-60% –∞–±—Å–æ—Ä–±—Ü–∏—è' },
        { food: '—Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ', supplements: ['iron'], effect: '+200% –∞–±—Å–æ—Ä–±—Ü–∏—è (vitC)' },
        { food: '—á—ë—Ä–Ω—ã–π –ø–µ—Ä–µ—Ü', supplements: ['curcumin', 'coq10'], effect: '+20-2000% –∞–±—Å–æ—Ä–±—Ü–∏—è' },
        { food: '–±–µ–ª–∫–æ–≤–∞—è –µ–¥–∞', supplements: ['zinc', 'b12'], effect: '+30% –∞–±—Å–æ—Ä–±—Ü–∏—è' },
        { food: '—Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ', supplements: ['probiotics', 'b12'], effect: '—É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∏–∑–∞—Ü–∏–∏' }
      ],
      inhibitors: [
        { food: '–∫–æ—Ñ–µ', supplements: ['iron', 'calcium', 'zinc', 'magnesium'], effect: '-40-60%', gap: 60 },
        { food: '—á–∞–π', supplements: ['iron', 'zinc'], effect: '-30-50% (—Ç–∞–Ω–∏–Ω—ã)', gap: 60 },
        { food: '–º–æ–ª–æ—á–Ω—ã–µ', supplements: ['iron', 'tetracycline'], effect: '-50% (–∫–∞–ª—å—Ü–∏–π)', gap: 120 },
        { food: '–æ—Ç—Ä—É–±–∏/–∑–ª–∞–∫–∏', supplements: ['iron', 'zinc', 'calcium', 'magnesium'], effect: '-30% (—Ñ–∏—Ç–∞—Ç—ã)', gap: 60 },
        { food: '—à–ø–∏–Ω–∞—Ç', supplements: ['calcium', 'iron'], effect: '-30% (–æ–∫—Å–∞–ª–∞—Ç—ã)', note: '–≤–∞—Ä–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç' },
        { food: '–∞–ª–∫–æ–≥–æ–ª—å', supplements: ['b12', 'folate', 'magnesium', 'zinc'], effect: '–∏—Å—Ç–æ—â–∞–µ—Ç –∑–∞–ø–∞—Å—ã', gap: 180 },
        { food: '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç', supplements: ['—Å—Ç–∞—Ç–∏–Ω—ã', 'some drugs'], effect: 'CYP3A4 –∏–Ω–≥–∏–±–∏—Ä–æ–≤–∞–Ω–∏–µ', warning: true }
      ]
    },
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –° –õ–ï–ö–ê–†–°–¢–í–ê–ú–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    drugInteractions: [
      { drug: '—Å—Ç–∞—Ç–∏–Ω—ã', supplements: ['coq10'], interaction: '—Å—Ç–∞—Ç–∏–Ω—ã –∏—Å—Ç–æ—â–∞—é—Ç CoQ10', action: '–¥–æ–±–∞–≤–∏—Ç—å CoQ10 100-200–º–≥' },
      { drug: '–º–µ—Ç—Ñ–æ—Ä–º–∏–Ω', supplements: ['b12'], interaction: '–º–µ—Ç—Ñ–æ—Ä–º–∏–Ω —Å–Ω–∏–∂–∞–µ—Ç B12', action: '–¥–æ–±–∞–≤–∏—Ç—å B12 1000–º–∫–≥' },
      { drug: '–æ–º–µ–ø—Ä–∞–∑–æ–ª/–ò–ü–ü', supplements: ['b12', 'magnesium', 'iron'], interaction: '—Å–Ω–∏–∂–∞–µ—Ç –∫–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç—å ‚Üí –∞–±—Å–æ—Ä–±—Ü–∏—è‚Üì', action: '–º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–≤–Ω–∏' },
      { drug: '–∞–Ω—Ç–∏–∫–æ–∞–≥—É–ª—è–Ω—Ç—ã', supplements: ['vitK', 'omega3', 'vitE'], interaction: '—É—Å–∏–ª–µ–Ω–∏–µ –∫—Ä–æ–≤–æ—Ä–∞–∑–∂–∏–∂–µ–Ω–∏—è', warning: '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤—Ä–∞—á–∞!' },
      { drug: '—Ç–∏—Ä–æ–∫—Å–∏–Ω', supplements: ['calcium', 'iron', 'magnesium'], interaction: '—Å–Ω–∏–∂–∞—é—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é', action: '—Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 4 —á–∞—Å–∞' },
      { drug: '–∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏', supplements: ['probiotics', 'zinc'], interaction: '–∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏ —É–±–∏–≤–∞—é—Ç —Ñ–ª–æ—Ä—É', action: '–ø—Ä–æ–±–∏–æ—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ 2—á –ø–æ—Å–ª–µ –ê–ë' }
    ]
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üå∏ –î–û–ë–ê–í–ö–ò –ü–û –§–ê–ó–ê–ú –ú–ï–ù–°–¢–†–£–ê–õ–¨–ù–û–ì–û –¶–ò–ö–õ–ê
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const CYCLE_SUPPLEMENTS = {
    menstrual: {  // –î–Ω–∏ 1-5
      priority: ['iron', 'vitC', 'b12'],
      reason: '–ü–æ—Ç–µ—Ä—è –∫—Ä–æ–≤–∏ ‚Üí –∂–µ–ª–µ–∑–æ –∫—Ä–∏—Ç–∏—á–Ω–æ. VitC —É—Å–∏–ª–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é.',
      increase: { iron: 1.5, vitC: 1.3 },
      symptoms: ['—É—Å—Ç–∞–ª–æ—Å—Ç—å', '–±–ª–µ–¥–Ω–æ—Å—Ç—å', '—Ö–æ–ª–æ–¥–Ω—ã–µ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏']
    },
    follicular: {  // –î–Ω–∏ 6-14
      priority: ['vitD', 'omega3', 'zinc'],
      reason: '–≠—Å—Ç—Ä–æ–≥–µ–Ω —Ä–∞—Å—Ç—ë—Ç ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ–ª–ª–∏–∫—É–ª–æ–≥–µ–Ω–µ–∑–∞.',
      optimal: '–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
      energy: '–≤—ã—Å–æ–∫–∞—è'
    },
    ovulation: {  // –î–Ω–∏ 14-16
      priority: ['vitE', 'selenium', 'zinc'],
      reason: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–≤—É–ª—è—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ —è–π—Ü–µ–∫–ª–µ—Ç–∫–∏.',
      note: '–ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –ª–∏–±–∏–¥–æ'
    },
    luteal: {  // –î–Ω–∏ 17-28
      priority: ['magnesium', 'b6', 'calcium', 'vitD'],
      reason: '–ü—Ä–æ–≥–µ—Å—Ç–µ—Ä–æ–Ω —Ä–∞—Å—Ç—ë—Ç ‚Üí Mg —Å–Ω–∏–∂–∞–µ—Ç –ü–ú–°, B6 –ø–æ–º–æ–≥–∞–µ—Ç —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º.',
      increase: { magnesium: 1.3, b6: 1.5 },
      symptoms: ['–≤–∑–¥—É—Ç–∏–µ', '—Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '—Ç—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É'],
      pmsTips: ['Mg 400-600–º–≥', 'B6 50-100–º–≥', 'Ca 1000–º–≥']
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ü©∫ –î–ï–§–ò–¶–ò–¢–´ –ü–û –°–ò–ú–ü–¢–û–ú–ê–ú
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const DEFICIENCY_SYMPTOMS = {
    fatigue: {
      likely: ['iron', 'b12', 'vitD', 'magnesium', 'coq10'],
      questions: [
        { q: '–ë–ª–µ–¥–Ω–∞—è –∫–æ–∂–∞/—Å–ª–∏–∑–∏—Å—Ç—ã–µ?', yes: 'iron' },
        { q: '–û–Ω–µ–º–µ–Ω–∏–µ/–ø–æ–∫–∞–ª—ã–≤–∞–Ω–∏–µ?', yes: 'b12' },
        { q: '–ú—ã—à–µ—á–Ω–∞—è —Å–ª–∞–±–æ—Å—Ç—å?', yes: ['vitD', 'magnesium'] },
        { q: '–•—É–∂–µ –ø–æ—Å–ª–µ 40 –ª–µ—Ç?', yes: 'coq10' }
      ],
      tests: ['—Ñ–µ—Ä—Ä–∏—Ç–∏–Ω', 'B12', '25(OH)D', 'Mg —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤']
    },
    hairLoss: {
      likely: ['iron', 'zinc', 'biotin', 'vitD', 'protein'],
      questions: [
        { q: '–í—ã–ø–∞–¥–µ–Ω–∏–µ –¥–∏—Ñ—Ñ—É–∑–Ω–æ–µ?', yes: ['iron', 'zinc'] },
        { q: '–õ–æ–º–∫–∏–µ –Ω–æ–≥—Ç–∏ —Ç–æ–∂–µ?', yes: 'biotin' },
        { q: '–°—É—Ö–∞—è –∫–æ–∂–∞ –≥–æ–ª–æ–≤—ã?', yes: 'vitD' }
      ],
      tests: ['—Ñ–µ—Ä—Ä–∏—Ç–∏–Ω (>70)', '—Ü–∏–Ω–∫', '–¢–¢–ì']
    },
    mood: {
      likely: ['vitD', 'omega3', 'magnesium', 'b12', 'folate'],
      questions: [
        { q: '–•—É–∂–µ –∑–∏–º–æ–π?', yes: 'vitD' },
        { q: '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å?', yes: 'magnesium' },
        { q: '–ê–ø–∞—Ç–∏—è?', yes: ['b12', 'folate'] }
      ],
      tests: ['25(OH)D', '–≥–æ–º–æ—Ü–∏—Å—Ç–µ–∏–Ω', 'Omega-3 Index']
    },
    muscle: {
      likely: ['magnesium', 'vitD', 'potassium', 'calcium'],
      questions: [
        { q: '–°—É–¥–æ—Ä–æ–≥–∏ –Ω–æ—á—å—é?', yes: 'magnesium' },
        { q: '–°–ª–∞–±–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –º—ã—à—Ü?', yes: 'vitD' },
        { q: '–°—É–¥–æ—Ä–æ–≥–∏ –ø—Ä–∏ —Ñ–∏–∑–Ω–∞–≥—Ä—É–∑–∫–µ?', yes: ['potassium', 'magnesium'] }
      ],
      tests: ['Mg —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤', '25(OH)D', '—ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã']
    },
    immune: {
      likely: ['vitD', 'zinc', 'vitC', 'selenium'],
      questions: [
        { q: '–ß–∞—Å—Ç—ã–µ –ø—Ä–æ—Å—Ç—É–¥—ã?', yes: ['vitD', 'zinc'] },
        { q: '–î–æ–ª–≥–æ –∑–∞–∂–∏–≤–∞—é—Ç —Ä–∞–Ω—ã?', yes: 'zinc' },
        { q: '–ì–µ—Ä–ø–µ—Å —á–∞—Å—Ç–æ?', yes: ['zinc', 'lysine'] }
      ],
      tests: ['25(OH)D', '—Ü–∏–Ω–∫ —Å—ã–≤–æ—Ä–æ—Ç–∫–∏']
    },
    sleep: {
      likely: ['magnesium', 'glycine', 'melatonin', 'vitD'],
      questions: [
        { q: '–¢—Ä—É–¥–Ω–æ –∑–∞—Å–Ω—É—Ç—å?', yes: ['magnesium', 'glycine'] },
        { q: '–ü—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å –Ω–æ—á—å—é?', yes: 'magnesium' },
        { q: '–ù–µ –≤—ã—Å—ã–ø–∞–µ—Ç–µ—Å—å –ø—Ä–∏ 8—á —Å–Ω–∞?', yes: ['vitD', 'b12'] }
      ],
      note: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ø–Ω–æ—ç —Å–Ω–∞, –≥–∏–≥–∏–µ–Ω—É —Å–Ω–∞'
    },
    skin: {
      likely: ['vitA', 'zinc', 'omega3', 'vitE', 'vitC'],
      questions: [
        { q: '–°—É—Ö–∞—è –∫–æ–∂–∞?', yes: ['omega3', 'vitE'] },
        { q: '–ê–∫–Ω–µ?', yes: ['zinc', 'vitA'] },
        { q: '–ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∂–∏–≤–ª–µ–Ω–∏–µ?', yes: ['zinc', 'vitC'] }
      ]
    },
    cognitive: {
      likely: ['omega3', 'b12', 'iron', 'vitD', 'magnesium'],
      questions: [
        { q: '–ú–æ–∑–≥–æ–≤–æ–π —Ç—É–º–∞–Ω?', yes: ['omega3', 'b12'] },
        { q: '–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é?', yes: ['omega3', 'b12', 'magnesium'] },
        { q: '–¢—Ä—É–¥–Ω–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è?', yes: ['iron', 'omega3'] }
      ],
      tests: ['—Ñ–µ—Ä—Ä–∏—Ç–∏–Ω', 'B12', 'Omega-3 Index']
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ü•ó –ù–£–¢–†–ò–ï–ù–¢–´ –ò–ó –ï–î–´ ‚Äî –ß–¢–û –£–ñ–ï –ü–û–õ–£–ß–ò–õ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const FOOD_NUTRIENT_SOURCES = {
    iron: {
      heme: ['–ø–µ—á–µ–Ω—å', '–≥–æ–≤—è–¥–∏–Ω–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '–∏–Ω–¥–µ–π–∫–∞ —Ç—ë–º–Ω–∞—è'],
      nonHeme: ['—á–µ—á–µ–≤–∏—Ü–∞', '—Ñ–∞—Å–æ–ª—å', '—à–ø–∏–Ω–∞—Ç', '—Ç–æ—Ñ—É', '–≥—Ä–µ—á–∫–∞'],
      absorption: { heme: 0.25, nonHeme: 0.05 },
      rda: { male: 8, female: 18, pregnant: 27 }
    },
    calcium: {
      dairy: ['–º–æ–ª–æ–∫–æ', '–π–æ–≥—É—Ä—Ç', '—Å—ã—Ä', '—Ç–≤–æ—Ä–æ–≥'],
      nonDairy: ['—Å–∞—Ä–¥–∏–Ω—ã', '—Ç–æ—Ñ—É', '–±—Ä–æ–∫–∫–æ–ª–∏', '–∫–∞–ª–µ', '–º–∏–Ω–¥–∞–ª—å'],
      rda: 1000,
      note: '–£—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ—Ä—Ü–∏—è–º–∏ –¥–æ 500–º–≥'
    },
    magnesium: {
      sources: ['—Ç—ã–∫–≤–µ–Ω–Ω—ã–µ —Å–µ–º–µ—á–∫–∏', '—à–ø–∏–Ω–∞—Ç', '–º–∏–Ω–¥–∞–ª—å', '–∞–≤–æ–∫–∞–¥–æ', '—Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥', '–≥—Ä–µ—á–∫–∞'],
      rda: { male: 420, female: 320 },
      note: '50% –Ω–∞—Å–µ–ª–µ–Ω–∏—è –Ω–µ –¥–æ–±–∏—Ä–∞–µ—Ç'
    },
    zinc: {
      sources: ['—É—Å—Ç—Ä–∏—Ü—ã', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Ç—ã–∫–≤–µ–Ω–Ω—ã–µ —Å–µ–º–µ—á–∫–∏', '—á–µ—á–µ–≤–∏—Ü–∞', '–∫–µ—à—å—é'],
      rda: { male: 11, female: 8 },
      note: '–ò–∑ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ö—É–∂–µ'
    },
    omega3: {
      marine: ['–ª–æ—Å–æ—Å—å', '—Å–∞—Ä–¥–∏–Ω—ã', '—Å–∫—É–º–±—Ä–∏—è', '—Å–µ–ª—å–¥—å', '–∞–Ω—á–æ—É—Å—ã'],
      plant: ['–ª—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ', '—á–∏–∞', '–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö'],  // ALA, –∫–æ–Ω–≤–µ—Ä—Å–∏—è ~5%
      target: '1-2–≥ EPA+DHA –≤ –Ω–µ–¥–µ–ª—é (2 –ø–æ—Ä—Ü–∏–∏ –∂–∏—Ä–Ω–æ–π —Ä—ã–±—ã)',
      note: '–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–∞—è ALA –ø–ª–æ—Ö–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ EPA/DHA'
    },
    vitD: {
      sources: ['–∂–∏—Ä–Ω–∞—è —Ä—ã–±–∞', '—è–∏—á–Ω—ã–π –∂–µ–ª—Ç–æ–∫', '–ø–µ—á–µ–Ω—å —Ç—Ä–µ—Å–∫–∏', '–≥—Ä–∏–±—ã (UV)'],
      note: '–ï–¥–∞ –¥–∞—ë—Ç –º–∞–∫—Å 10-20% –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏. –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî —Å–æ–ª–Ω—Ü–µ –∏–ª–∏ –¥–æ–±–∞–≤–∫–∏.',
      sun: '15-20 –º–∏–Ω –Ω–∞ —Å–æ–ª–Ω—Ü–µ –≤ –ø–æ–ª–¥–µ–Ω—å = ~10000 IU (–ª–µ—Ç–æ–º)'
    },
    b12: {
      sources: ['–ø–µ—á–µ–Ω—å', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Ä—ã–±–∞', '—è–π—Ü–∞', '–º–æ–ª–æ—á–Ω—ã–µ'],
      note: '–ù–ï–¢ –≤ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–π –ø–∏—â–µ! –í–µ–≥–∞–Ω–∞–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–æ–±–∞–≤–∫–∞.',
      rda: 2.4
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üß† –£–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–±–∞–≤–∫–µ
   */
  function getSupplementScience(suppId) {
    const bio = BIOAVAILABILITY[suppId];
    if (!bio) return null;
    
    return {
      bioavailability: bio,
      optimalTime: getOptimalTime(suppId),
      synergies: getSynergies(suppId),
      antagonisms: getAntagonisms(suppId),
      foodTips: getFoodTips(suppId)
    };
  }

  /**
   * –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞
   */
  function getOptimalTime(suppId) {
    for (const [period, data] of Object.entries(CIRCADIAN_OPTIMAL)) {
      if (period === 'chronotypes') continue;
      if (data.supplements?.includes(suppId)) {
        return { period, reason: data.reason };
      }
      if (data.avoid?.includes(suppId)) {
        return { avoid: period, reason: data.reason };
      }
    }
    return { period: 'any', reason: '–ù–µ—Ç —Å—Ç—Ä–æ–≥–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏' };
  }

  /**
   * –ù–∞–π—Ç–∏ —Å–∏–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–∫–∏
   */
  function getSynergies(suppId) {
    return INTERACTIONS_EXTENDED.synergies
      .filter(s => s.pair.includes(suppId))
      .map(s => ({
        partner: s.pair.find(p => p !== suppId),
        effect: s.effect,
        mechanism: s.mechanism,
        ratio: s.ratio
      }));
  }

  /**
   * –ù–∞–π—Ç–∏ –∞–Ω—Ç–∞–≥–æ–Ω–∏–∑–º—ã –¥–ª—è –¥–æ–±–∞–≤–∫–∏
   */
  function getAntagonisms(suppId) {
    return INTERACTIONS_EXTENDED.antagonisms
      .filter(a => a.pair.includes(suppId))
      .map(a => ({
        conflict: a.pair.find(p => p !== suppId),
        effect: a.effect,
        mechanism: a.mechanism,
        solution: a.solution
      }));
  }

  /**
   * –°–æ–≤–µ—Ç—ã –ø–æ –µ–¥–µ –¥–ª—è –¥–æ–±–∞–≤–∫–∏
   */
  function getFoodTips(suppId) {
    const tips = [];
    
    // –£—Å–∏–ª–∏—Ç–µ–ª–∏
    for (const e of INTERACTIONS_EXTENDED.foodInteractions.enhancers) {
      if (e.supplements.includes(suppId)) {
        tips.push({ type: 'enhancer', food: e.food, effect: e.effect });
      }
    }
    
    // –ò–Ω–≥–∏–±–∏—Ç–æ—Ä—ã
    for (const i of INTERACTIONS_EXTENDED.foodInteractions.inhibitors) {
      if (i.supplements.includes(suppId)) {
        tips.push({ type: 'inhibitor', food: i.food, effect: i.effect, gap: i.gap });
      }
    }
    
    return tips;
  }

  /**
   * –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ñ–∞–∑–µ —Ü–∏–∫–ª–∞
   */
  function getCycleRecommendations(cyclePhase) {
    if (!cyclePhase || !CYCLE_SUPPLEMENTS[cyclePhase]) {
      return null;
    }
    return CYCLE_SUPPLEMENTS[cyclePhase];
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤ ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–µ—Ñ–∏—Ü–∏—Ç—ã
   */
  function analyzeSymptoms(symptoms) {
    const results = [];
    
    for (const symptom of symptoms) {
      const data = DEFICIENCY_SYMPTOMS[symptom];
      if (data) {
        results.push({
          symptom,
          likelyDeficiencies: data.likely,
          questions: data.questions,
          tests: data.tests
        });
      }
    }
    
    // –ù–∞–π—Ç–∏ –æ–±—â–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç—ã
    const allLikely = results.flatMap(r => r.likelyDeficiencies);
    const counts = {};
    allLikely.forEach(d => { counts[d] = (counts[d] || 0) + 1; });
    
    const prioritized = Object.entries(counts)
      .sort((a, b) => b[1] - a[1])
      .map(([supp, count]) => ({ supplement: supp, matchedSymptoms: count }));
    
    return {
      bySymptom: results,
      prioritized,
      tests: [...new Set(results.flatMap(r => r.tests || []))]
    };
  }

  /**
   * –û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞ –µ–¥—ã –Ω–∞ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã
   */
  function analyzeMealNutrients(mealItems, pIndex) {
    const found = {
      iron: { amount: 0, sources: [] },
      calcium: { amount: 0, sources: [] },
      magnesium: { amount: 0, sources: [] },
      zinc: { amount: 0, sources: [] },
      omega3: { amount: 0, sources: [] },
      vitD: { amount: 0, sources: [] },
      b12: { amount: 0, sources: [] }
    };
    
    if (!mealItems || !Array.isArray(mealItems)) return found;
    
    for (const item of mealItems) {
      const name = (item.name || '').toLowerCase();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –Ω—É—Ç—Ä–∏–µ–Ω—Ç
      for (const [nutrient, data] of Object.entries(FOOD_NUTRIENT_SOURCES)) {
        const allSources = [
          ...(data.sources || []),
          ...(data.heme || []),
          ...(data.nonHeme || []),
          ...(data.dairy || []),
          ...(data.nonDairy || []),
          ...(data.marine || []),
          ...(data.plant || [])
        ];
        
        for (const source of allSources) {
          if (name.includes(source.toLowerCase())) {
            found[nutrient].sources.push(source);
            // –ì—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
            found[nutrient].amount += (item.grams || 100) * 0.01;
          }
        }
      }
    }
    
    return found;
  }

  /**
   * –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   */
  function getScientificRecommendations(profile, dayData, meals) {
    const recs = [];
    const hour = new Date().getHours();
    const month = new Date().getMonth();
    
    // 1. –ü–æ –ø—Ä–æ—Ñ–∏–ª—é
    if (profile) {
      // –í–æ–∑—Ä–∞—Å—Ç
      if (profile.age >= 50) {
        recs.push({
          id: 'b12',
          reason: '50+ –ª–µ—Ç: —Å–Ω–∏–∂–∞–µ—Ç—Å—è –≤—ã—Ä–∞–±–æ—Ç–∫–∞ intrinsic factor ‚Üí B12 —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ö—É–∂–µ',
          science: BIOAVAILABILITY.b12,
          priority: 'high'
        });
        recs.push({
          id: 'coq10',
          reason: '50+ –ª–µ—Ç: —ç–Ω–¥–æ–≥–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–µ–∑ CoQ10 –ø–∞–¥–∞–µ—Ç –Ω–∞ 50%',
          science: BIOAVAILABILITY.coq10,
          priority: 'medium'
        });
      }
      
      if (profile.age >= 40) {
        recs.push({
          id: 'vitD',
          reason: '40+ –ª–µ—Ç: —Å–∏–Ω—Ç–µ–∑ D3 –≤ –∫–æ–∂–µ —Å–Ω–∏–∂–∞–µ—Ç—Å—è, –∫–æ—Å—Ç–Ω–∞—è –º–∞—Å—Å–∞‚Üì',
          science: BIOAVAILABILITY.vitD,
          priority: 'high'
        });
      }
      
      // –ü–æ–ª
      if (profile.gender === '–ñ–µ–Ω—Å–∫–∏–π') {
        recs.push({
          id: 'iron',
          reason: '–ñ–µ–Ω—â–∏–Ω—ã —Ç–µ—Ä—è—é—Ç –∂–µ–ª–µ–∑–æ —Å –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–µ–π (~30–º–≥/—Ü–∏–∫–ª)',
          science: BIOAVAILABILITY.iron,
          priority: 'high'
        });
        recs.push({
          id: 'calcium',
          reason: '–ñ–µ–Ω—â–∏–Ω—ã: —Ä–∏—Å–∫ –æ—Å—Ç–µ–æ–ø–æ—Ä–æ–∑–∞ –≤—ã—à–µ, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ—Å–ª–µ 40',
          priority: 'medium'
        });
      }
    }
    
    // 2. –ü–æ —Å–µ–∑–æ–Ω—É
    if (month >= 10 || month <= 2) {  // –ù–æ—è–±—Ä—å-–ú–∞—Ä—Ç
      recs.push({
        id: 'vitD',
        reason: `–ó–∏–º–∞ (${['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'][month]}): –£–§-–∏–Ω–¥–µ–∫—Å <3, —Å–∏–Ω—Ç–µ–∑ D3 –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω`,
        science: BIOAVAILABILITY.vitD,
        priority: 'critical'
      });
    }
    
    // 3. –ü–æ –¥–∞–Ω–Ω—ã–º –¥–Ω—è
    if (dayData) {
      // –ü–ª–æ—Ö–æ–π —Å–æ–Ω
      if (dayData.sleepQuality && dayData.sleepQuality <= 3) {
        recs.push({
          id: 'magnesium',
          reason: '–ü–ª–æ—Ö–æ–π —Å–æ–Ω: Mg ‚Äî –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —Ä–µ–ª–∞–∫—Å–∞–Ω—Ç, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç GABA',
          science: BIOAVAILABILITY.magnesium,
          priority: 'high',
          form: 'glycinate –∏–ª–∏ threonate'
        });
      }
      
      // –°—Ç—Ä–µ—Å—Å
      if (dayData.stressAvg && dayData.stressAvg >= 6) {
        recs.push({
          id: 'magnesium',
          reason: '–í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å: –∫–æ—Ä—Ç–∏–∑–æ–ª –∏—Å—Ç–æ—â–∞–µ—Ç Mg, —Å–æ–∑–¥–∞–≤–∞—è –ø–æ—Ä–æ—á–Ω—ã–π –∫—Ä—É–≥',
          science: BIOAVAILABILITY.magnesium,
          priority: 'high'
        });
        recs.push({
          id: 'omega3',
          reason: '–°—Ç—Ä–µ—Å—Å: EPA —Å–Ω–∏–∂–∞–µ—Ç –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å',
          science: BIOAVAILABILITY.omega3,
          priority: 'medium'
        });
      }
      
      // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      if (dayData.trainings && dayData.trainings.length > 0) {
        recs.push({
          id: 'magnesium',
          reason: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: –ø–æ—Ç–µ—Ä—è Mg —Å –ø–æ—Ç–æ–º, –Ω—É–∂–µ–Ω –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ ATP',
          science: BIOAVAILABILITY.magnesium,
          priority: 'medium'
        });
        recs.push({
          id: 'omega3',
          reason: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: EPA/DHA —É—Å–∫–æ—Ä—è—é—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ä–µ–∑–æ–ª—å–≤–∏–Ω—ã',
          science: BIOAVAILABILITY.omega3,
          priority: 'medium'
        });
      }
      
      // –§–∞–∑–∞ —Ü–∏–∫–ª–∞
      if (dayData.cycleDay) {
        let phase;
        if (dayData.cycleDay <= 5) phase = 'menstrual';
        else if (dayData.cycleDay <= 14) phase = 'follicular';
        else if (dayData.cycleDay <= 16) phase = 'ovulation';
        else phase = 'luteal';
        
        const cycleRecs = CYCLE_SUPPLEMENTS[phase];
        if (cycleRecs) {
          for (const suppId of cycleRecs.priority) {
            recs.push({
              id: suppId,
              reason: `–§–∞–∑–∞ —Ü–∏–∫–ª–∞ (${phase}): ${cycleRecs.reason}`,
              priority: 'medium',
              cyclePhase: phase
            });
          }
        }
      }
    }
    
    // 4. –ü–æ —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏
    const timeRecs = [];
    if (hour >= 6 && hour <= 10) {
      timeRecs.push(...CIRCADIAN_OPTIMAL.morning.supplements.map(id => ({
        id,
        timeWindow: '—Å–µ–π—á–∞—Å',
        reason: CIRCADIAN_OPTIMAL.morning.reason
      })));
    } else if (hour >= 21) {
      timeRecs.push(...CIRCADIAN_OPTIMAL.beforeBed.supplements.map(id => ({
        id,
        timeWindow: '—Å–µ–π—á–∞—Å',
        reason: CIRCADIAN_OPTIMAL.beforeBed.reason
      })));
    }
    
    // 5. –ê–Ω–∞–ª–∏–∑ –µ–¥—ã
    if (meals && meals.length > 0) {
      const lastMeal = meals[meals.length - 1];
      if (lastMeal && lastMeal.items) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–∏—Ä–Ω–æ—Å—Ç—å –¥–ª—è –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã—Ö
        let mealFat = 0;
        for (const item of lastMeal.items) {
          mealFat += (item.fat100 || 0) * (item.grams || 100) / 100;
        }
        
        if (mealFat >= 10) {
          recs.push({
            id: 'vitD',
            reason: `–ñ–∏—Ä–Ω—ã–π –ø—Ä–∏—ë–º (${mealFat.toFixed(0)}–≥ –∂–∏—Ä–∞) ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è D3 (+60% –∞–±—Å–æ—Ä–±—Ü–∏—è)`,
            priority: 'timing',
            science: BIOAVAILABILITY.vitD
          });
          recs.push({
            id: 'vitK2',
            reason: `–ñ–∏—Ä–Ω—ã–π –ø—Ä–∏—ë–º ‚Äî K2 —É—Å–≤–æ–∏—Ç—Å—è –ª—É—á—à–µ (+40%)`,
            priority: 'timing',
            science: BIOAVAILABILITY.vitK2
          });
        }
      }
    }
    
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ id, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ
    const seen = new Map();
    for (const rec of recs) {
      const existing = seen.get(rec.id);
      if (!existing || priorityOrder(rec.priority) < priorityOrder(existing.priority)) {
        seen.set(rec.id, rec);
      }
    }
    
    return Array.from(seen.values());
  }

  function priorityOrder(p) {
    const order = { critical: 0, high: 1, medium: 2, low: 3, timing: 4 };
    return order[p] ?? 5;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üåÖ –ù–ê–£–ß–ù–´–ï –û–ë–û–°–ù–û–í–ê–ù–ò–Ø –î–õ–Ø –£–¢–†–ï–ù–ù–ï–ì–û –ü–†–ò–Å–ú–ê –í–ò–¢–ê–ú–ò–ù–û–í
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const MORNING_SUPPLEMENT_SCIENCE = {
    // === –£–¢–†–ï–ù–ù–ò–ï –í–ò–¢–ê–ú–ò–ù–´ (timing: morning, empty, withFood) ===
    vitD: {
      timing: 'withFood',
      mealTiming: '–° –∑–∞–≤—Ç—Ä–∞–∫–æ–º (—Å –∂–∏—Ä–∞–º–∏!)',
      icon: '‚òÄÔ∏è',
      shortTip: '–ü—Ä–∏–Ω–∏–º–∞–π —Å –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫',
      science: {
        why: '–í–∏—Ç–∞–º–∏–Ω D –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π ‚Äî —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 50-80% –ª—É—á—à–µ —Å –∂–∏—Ä–∞–º–∏ (—è–π—Ü–∞, –∞–≤–æ–∫–∞–¥–æ, —Å—ã—Ä).',
        when: '–£—Ç—Ä–æ–º —Å –ø–µ—Ä–≤—ã–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º –º–∏–Ω–∏–º—É–º 10-15–≥ –∂–∏—Ä–∞.',
        mechanism: '–ö–æ—Ä—Ç–∏–∑–æ–ª –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —É—Ç—Ä–æ–º ‚Üí —É–ª—É—á—à–∞–µ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç D3. –í–µ—á–µ—Ä–Ω–∏–π –ø—Ä–∏—ë–º –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Å–æ–Ω (–ø–æ–¥–∞–≤–ª—è–µ—Ç –º–µ–ª–∞—Ç–æ–Ω–∏–Ω).',
        evidence: 'Journal of Bone and Mineral Research, 2010: –ø—Ä–∏—ë–º D3 —Å –µ–¥–æ–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é –Ω–∞ 50%.',
        avoid: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–µ—á–µ—Ä–æ–º ‚Äî –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã.',
        optimalFood: ['—è–π—Ü–∞', '–∞–≤–æ–∫–∞–¥–æ', '—Å—ã—Ä', '–æ—Ä–µ—Ö–∏', '—Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ']
      }
    },
    
    b12: {
      timing: 'morning',
      mealTiming: '–£—Ç—Ä–æ–º, –º–æ–∂–Ω–æ –Ω–∞—Ç–æ—â–∞–∫',
      icon: '‚ö°',
      shortTip: '–ü—Ä–∏–Ω–∏–º–∞–π —É—Ç—Ä–æ–º ‚Äî –¥–∞—ë—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å',
      science: {
        why: 'B12 —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤—ã—Ä–∞–±–æ—Ç–∫–µ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–∏–Ω—Ç–µ–∑–µ –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä–æ–≤. –ë–æ–¥—Ä–∏—Ç!',
        when: '–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Å –∑–∞–≤—Ç—Ä–∞–∫–æ–º.',
        mechanism: 'B12 –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –º–µ—Ç–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí —Å–∏–Ω—Ç–µ–∑ –¥–æ–ø–∞–º–∏–Ω–∞, —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω–∞, –Ω–æ—Ä–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω–∞. –î–∞—ë—Ç –º–µ–Ω—Ç–∞–ª—å–Ω—É—é —è—Å–Ω–æ—Å—Ç—å.',
        evidence: 'Nutrients, 2016: B12 —É–ª—É—á—à–∞–µ—Ç –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ —É—Ç—Ä–µ–Ω–Ω–µ–º –ø—Ä–∏—ë–º–µ.',
        avoid: '–í–µ—á–µ—Ä–æ–º –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –±–µ—Å—Å–æ–Ω–Ω–∏—Ü—É –∏–∑-–∑–∞ —Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.',
        optimalFood: ['–º–æ–∂–Ω–æ –Ω–∞—Ç–æ—â–∞–∫', '—Å –±–µ–ª–∫–æ–≤—ã–º –∑–∞–≤—Ç—Ä–∞–∫–æ–º –ª—É—á—à–µ']
      }
    },
    
    vitC: {
      timing: 'morning',
      mealTiming: '–£—Ç—Ä–æ–º —Å –µ–¥–æ–π –∏–ª–∏ –Ω–∞—Ç–æ—â–∞–∫',
      icon: 'üçä',
      shortTip: '–£—Ç—Ä–æ–º –¥–ª—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏',
      science: {
        why: '–í–∏—Ç–∞–º–∏–Ω C –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ –∫–æ—Ä—Ç–∏–∑–æ–ª–∞, –∏–º–º—É–Ω–∏—Ç–µ—Ç –∏ —ç–Ω–µ—Ä–≥–∏—é. –ú–æ–∂–µ—Ç –±–æ–¥—Ä–∏—Ç—å.',
        when: '–£—Ç—Ä–æ–º —Å –∑–∞–≤—Ç—Ä–∞–∫–æ–º. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∂–µ–ª—É–¥–∫–æ–º ‚Äî —Å –µ–¥–æ–π.',
        mechanism: '–ê—Å–∫–æ—Ä–±–∞—Ç ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä —Å–∏–Ω—Ç–µ–∑–∞ –Ω–æ—Ä–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω–∞ (–±–æ–¥—Ä–æ—Å—Ç—å). –¢–∞–∫–∂–µ –ø–æ–º–æ–≥–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏—é –∂–µ–ª–µ–∑–∞.',
        evidence: 'American Journal of Clinical Nutrition: –ø–∏–∫ –∞–±—Å–æ—Ä–±—Ü–∏–∏ –ø—Ä–∏ –¥–æ–∑–µ –¥–æ 200–º–≥. –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∑ ‚Äî —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 2-3 –ø—Ä–∏—ë–º–∞.',
        avoid: '–ë–æ–ª—å—à–∏–µ –¥–æ–∑—ã –≤–µ—á–µ—Ä–æ–º –º–æ–≥—É—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Å–æ–Ω.',
        optimalFood: ['–º–æ–∂–Ω–æ –Ω–∞—Ç–æ—â–∞–∫', '—Å —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–º–∏ —Å–∏–Ω–µ—Ä–≥–∏—è']
      }
    },
    
    iron: {
      timing: 'empty',
      mealTiming: '–°–¢–†–û–ì–û –Ω–∞—Ç–æ—â–∞–∫, —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º C!',
      icon: 'ü©∏',
      shortTip: '–ù–∞—Ç–æ—â–∞–∫ —É—Ç—Ä–æ–º + –≤–∏—Ç–∞–º–∏–Ω C = —É—Å–≤–æ–µ–Ω–∏–µ √ó3',
      science: {
        why: '–ñ–µ–ª–µ–∑–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –ø—É—Å—Ç–æ–π –∂–µ–ª—É–¥–æ–∫. –í–∏—Ç–∞–º–∏–Ω C —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é –≤ 3 —Ä–∞–∑–∞!',
        when: '–ó–∞ 30-60 –º–∏–Ω—É—Ç –¥–æ –∑–∞–≤—Ç—Ä–∞–∫–∞, –∑–∞–ø–∏—Ç—å –≤–æ–¥–æ–π —Å –ª–∏–º–æ–Ω–æ–º –∏–ª–∏ –ø—Ä–∏–Ω—è—Ç—å —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º C.',
        mechanism: '–ñ–µ–ª—É–¥–æ—á–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –Ω–∞—Ç–æ—â–∞–∫ ‚Üí Fe¬≥‚Å∫ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–æ Fe¬≤‚Å∫ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —É—Å–≤–∞–∏–≤–∞–µ–º–∞—è —Ñ–æ—Ä–º–∞).',
        evidence: 'Hallberg et al.: –≤–∏—Ç–∞–º–∏–Ω C —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é –Ω–µ–≥–µ–º–æ–≤–æ–≥–æ –∂–µ–ª–µ–∑–∞ –Ω–∞ 200-300%.',
        avoid: '–ù–ï –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å –∫–æ—Ñ–µ, —á–∞–µ–º, –º–æ–ª–æ—á–∫–æ–π, –∫–∞–ª—å—Ü–∏–µ–º ‚Äî –±–ª–æ–∫–∏—Ä—É—é—Ç —É—Å–≤–æ–µ–Ω–∏–µ –Ω–∞ 40-60%!',
        conflict: ['calcium', 'zinc', '–∫–æ—Ñ–µ', '—á–∞–π', '–º–æ–ª–æ–∫–æ']
      }
    },
    
    folic: {
      timing: 'morning',
      mealTiming: '–£—Ç—Ä–æ–º —Å –µ–¥–æ–π',
      icon: 'üå∏',
      shortTip: '–£—Ç—Ä–æ–º –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è –∫–ª–µ—Ç–æ–∫',
      science: {
        why: '–§–æ–ª–∏–µ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å–∏–Ω—Ç–µ–∑–µ –î–ù–ö –∏ –∫–ª–µ—Ç–æ—á–Ω–æ–º –¥–µ–ª–µ–Ω–∏–∏. –ö—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω!',
        when: '–£—Ç—Ä–æ–º —Å –∑–∞–≤—Ç—Ä–∞–∫–æ–º.',
        mechanism: '–§–æ–ª–∞—Ç ‚Üí –º–µ—Ç–∏–ª—Ñ–æ–ª–∞—Ç ‚Üí –º–µ—Ç–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –î–ù–ö, —Å–∏–Ω—Ç–µ–∑ –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä–æ–≤.',
        evidence: '–í–∞–∂–Ω–æ: –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å B12 (—Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Å–≤—è–∑–∫–µ). –î–µ—Ñ–∏—Ü–∏—Ç B12 –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –≤—ã—Å–æ–∫–∏–º —Ñ–æ–ª–∞—Ç–æ–º.',
        avoid: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∞–ª–∫–æ–≥–æ–ª—å ‚Äî —Ä–∞–∑—Ä—É—à–∞–µ—Ç —Ñ–æ–ª–∞—Ç.',
        synergy: ['b12']
      }
    },
    
    coq10: {
      timing: 'withFat',
      mealTiming: '–° –∂–∏—Ä–Ω—ã–º –∑–∞–≤—Ç—Ä–∞–∫–æ–º',
      icon: '‚ù§Ô∏è',
      shortTip: '–° –∂–∏—Ä–∞–º–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫ ‚Äî –¥–ª—è —Å–µ—Ä–¥—Ü–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏',
      science: {
        why: 'CoQ10 –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º, –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–π. –£–±–∏—Ö–∏–Ω–æ–ª —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ª—É—á—à–µ —É–±–∏—Ö–∏–Ω–æ–Ω–∞.',
        when: '–° –ø–µ—Ä–≤—ã–º –∂–∏—Ä–Ω—ã–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏ (–∑–∞–≤—Ç—Ä–∞–∫ –∏–ª–∏ –æ–±–µ–¥).',
        mechanism: 'CoQ10 ‚Äî –ø–µ—Ä–µ–Ω–æ—Å—á–∏–∫ —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤ –≤ –º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏—è—Ö. –ë–µ–∑ –∂–∏—Ä–∞ –∞–±—Å–æ—Ä–±—Ü–∏—è –≤—Å–µ–≥–æ 3%, —Å –∂–∏—Ä–æ–º ‚Äî –¥–æ 15%.',
        evidence: 'Biofactors, 2008: –ø—Ä–∏—ë–º —Å –µ–¥–æ–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é CoQ10 –≤ 3-5 —Ä–∞–∑.',
        avoid: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–µ—á–µ—Ä–æ–º ‚Äî –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å —ç–Ω–µ—Ä–≥–∏—é –∏ –Ω–∞—Ä—É—à–∞—Ç—å —Å–æ–Ω.',
        optimalFood: ['—è–π—Ü–∞', '–∞–≤–æ–∫–∞–¥–æ', '–æ—Ä–µ—Ö–∏', '—Å—ã—Ä']
      }
    },
    
    b6: {
      timing: 'morning',
      mealTiming: '–£—Ç—Ä–æ–º —Å –µ–¥–æ–π',
      icon: 'üß¨',
      shortTip: '–£—Ç—Ä–æ–º –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è',
      science: {
        why: 'B6 —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å–∏–Ω—Ç–µ–∑–µ –¥–æ–ø–∞–º–∏–Ω–∞ –∏ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω–∞, –º–µ—Ç–∞–±–æ–ª–∏–∑–º–µ –±–µ–ª–∫–∞.',
        when: '–£—Ç—Ä–æ–º —Å –∑–∞–≤—Ç—Ä–∞–∫–æ–º.',
        mechanism: '–ü–∏—Ä–∏–¥–æ–∫—Å–∏–Ω ‚Üí –ø–∏—Ä–∏–¥–æ–∫—Å–∞–ª—å-5-—Ñ–æ—Å—Ñ–∞—Ç ‚Üí –∫–æ—Ñ–∞–∫—Ç–æ—Ä 100+ —Ñ–µ—Ä–º–µ–Ω—Ç–æ–≤ –≤–∫–ª—é—á–∞—è –¥–µ–∫–∞—Ä–±–æ–∫—Å–∏–ª–∞–∑—É (—Å–∏–Ω—Ç–µ–∑ –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä–æ–≤).',
        evidence: '–ò–¥–µ–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞ —Å –º–∞–≥–Ω–∏–µ–º ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑–∫–∞ Magne B6.',
        avoid: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã (>100–º–≥) –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –Ω–µ–π—Ä–æ–ø–∞—Ç–∏—é. –ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è 25-50–º–≥.',
        synergy: ['magnesium']
      }
    },
    
    zinc: {
      timing: 'withFood',
      mealTiming: '–° –±–µ–ª–∫–æ–≤—ã–º –∑–∞–≤—Ç—Ä–∞–∫–æ–º',
      icon: 'üõ°Ô∏è',
      shortTip: '–° –±–µ–ª–∫–æ–≤–æ–π –µ–¥–æ–π, –ù–ï —Å –∂–µ–ª–µ–∑–æ–º –∏ –∫–∞–ª—å—Ü–∏–µ–º',
      science: {
        why: '–¶–∏–Ω–∫ –ª—É—á—à–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Å –±–µ–ª–∫–æ–≤–æ–π –ø–∏—â–µ–π. –ö—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ –∏ –≥–æ—Ä–º–æ–Ω–æ–≤.',
        when: '–° –∑–∞–≤—Ç—Ä–∞–∫–æ–º –∏–ª–∏ –æ–±–µ–¥–æ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º –±–µ–ª–æ–∫.',
        mechanism: '–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã (—Ü–∏—Å—Ç–µ–∏–Ω, –≥–∏—Å—Ç–∏–¥–∏–Ω) –æ–±—Ä–∞–∑—É—é—Ç —Ö–µ–ª–∞—Ç—ã —Å —Ü–∏–Ω–∫–æ–º ‚Üí —É–ª—É—á—à–∞—é—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.',
        evidence: '–ü—Ä–∏ –ø—É—Å—Ç–æ–º –∂–µ–ª—É–¥–∫–µ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ç–æ—à–Ω–æ—Ç—É. –° –±–µ–ª–∫–æ–º ‚Äî –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.',
        avoid: '–ù–ï —Å –∂–µ–ª–µ–∑–æ–º (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è), –ù–ï —Å –∫–∞–ª—å—Ü–∏–µ–º (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞), –ù–ï —Å –∫–æ—Ñ–µ (—Ç–∞–Ω–∏–Ω—ã).',
        conflict: ['iron', 'calcium', '–∫–æ—Ñ–µ']
      }
    },
    
    // === –° –ï–î–û–ô (timing: withFood, withFat) ===
    omega3: {
      timing: 'withFat',
      mealTiming: '–° –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π (–∑–∞–≤—Ç—Ä–∞–∫/–æ–±–µ–¥)',
      icon: 'üêü',
      shortTip: '–° –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π, —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ö–æ–ª–æ–¥–µ',
      science: {
        why: 'EPA/DHA –ª—É—á—à–µ —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è —Å –∂–∏—Ä–∞–º–∏. –ë–∞–∑–æ–≤–∞—è –∞–±—Å–æ—Ä–±—Ü–∏—è ‚Äî 25%, —Å –∂–∏—Ä–∞–º–∏ ‚Äî 60%.',
        when: '–° –ª—é–±—ã–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º –∂–∏—Ä—ã. –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ —É—Ç—Ä–æ –∏–ª–∏ –¥–µ–Ω—å.',
        mechanism: '–ñ–∏—Ä—ã —Å—Ç–∏–º—É–ª–∏—Ä—É—é—Ç –≤—ã–±—Ä–æ—Å –∂–µ–ª—á–∏ ‚Üí —ç–º—É–ª—å–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏—Ü–µ–ª–ª–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ‚Üí –∞–±—Å–æ—Ä–±—Ü–∏—è.',
        evidence: 'Journal of the Academy of Nutrition: –ø—Ä–∏—ë–º omega-3 —Å –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é –Ω–∞ 300%.',
        avoid: '–•—Ä–∞–Ω–∏—Ç—å –≤ —Ö–æ–ª–æ–¥–µ (–æ–∫–∏—Å–ª—è—é—Ç—Å—è!). –ü—Ä–∏–Ω–∏–º–∞—Ç—å —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º E –¥–ª—è –∑–∞—â–∏—Ç—ã.',
        synergy: ['vitE', 'vitD']
      }
    },
    
    vitE: {
      timing: 'withFat',
      mealTiming: '–° –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π',
      icon: 'üåª',
      shortTip: '–° –∂–∏—Ä–∞–º–∏, –∑–∞—â–∏—â–∞–µ—Ç Omega-3 –æ—Ç –æ–∫–∏—Å–ª–µ–Ω–∏—è',
      science: {
        why: '–¢–æ–∫–æ—Ñ–µ—Ä–æ–ª –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º, —è–≤–ª—è–µ—Ç—Å—è –≥–ª–∞–≤–Ω—ã–º –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–æ–º –¥–ª—è –∫–ª–µ—Ç–æ—á–Ω—ã—Ö –º–µ–º–±—Ä–∞–Ω.',
        when: '–° –µ–¥–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π –∂–∏—Ä—ã. –ò–¥–µ–∞–ª—å–Ω–æ ‚Äî –≤–º–µ—Å—Ç–µ —Å Omega-3.',
        mechanism: 'VitE –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –º–µ–º–±—Ä–∞–Ω—ã, –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ —Ä–∞–¥–∏–∫–∞–ª—ã. –†–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤–∏—Ç–∞–º–∏–Ω–æ–º C.',
        evidence: '–ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å 400 IU/–¥–µ–Ω—å ‚Äî –≤—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã –º–æ–≥—É—Ç –∞–Ω—Ç–∞–≥–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ç–∞–º–∏–Ω K.',
        avoid: '–í—ã—Å–æ–∫–∏–µ –¥–æ–∑—ã –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –∞–Ω—Ç–∏–∫–æ–∞–≥—É–ª—è–Ω—Ç–æ–≤.',
        synergy: ['omega3', 'vitC']
      }
    },
    
    biotin: {
      timing: 'withFood',
      mealTiming: '–° –ª—é–±—ã–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏',
      icon: 'üíá',
      shortTip: '–° –µ–¥–æ–π, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤—Ä–µ–º—è',
      science: {
        why: '–ë–∏–æ—Ç–∏–Ω –≤–æ–¥–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º, —Ö–æ—Ä–æ—à–æ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è. –í–∞–∂–µ–Ω –¥–ª—è –≤–æ–ª–æ—Å, –∫–æ–∂–∏, –Ω–æ–≥—Ç–µ–π.',
        when: '–í –ª—é–±–æ–µ –≤—Ä–µ–º—è —Å –µ–¥–æ–π.',
        mechanism: 'H7 ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä –∫–∞—Ä–±–æ–∫—Å–∏–ª–∞–∑, —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–µ –∂–∏—Ä–Ω—ã—Ö –∫–∏—Å–ª–æ—Ç –∏ –≥–ª—é–∫–æ–∑—ã.',
        evidence: '–≠—Ñ—Ñ–µ–∫—Ç –∑–∞–º–µ—Ç–µ–Ω —á–µ—Ä–µ–∑ 2-3 –º–µ—Å—è—Ü–∞ –ø—Ä–∏—ë–º–∞. –¢–µ—Ä–ø–µ–Ω–∏–µ!',
        avoid: '–ò–∑–±–µ–≥–∞—Ç—å —Å—ã—Ä—ã—Ö —è–∏—Ü ‚Äî –∞–≤–∏–¥–∏–Ω —Å–≤—è–∑—ã–≤–∞–µ—Ç –±–∏–æ—Ç–∏–Ω.',
        note: '–ú–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑—ã —â–∏—Ç–æ–≤–∏–¥–∫–∏ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –≤—Ä–∞—á–∞!'
      }
    },
    
    collagen: {
      timing: 'empty',
      mealTiming: '–ù–∞—Ç–æ—â–∞–∫ + –≤–∏—Ç–∞–º–∏–Ω C',
      icon: '‚ú®',
      shortTip: '–ù–∞—Ç–æ—â–∞–∫ –∑–∞ 30 –º–∏–Ω –¥–æ –µ–¥—ã + –≤–∏—Ç–∞–º–∏–Ω C',
      science: {
        why: '–ö–æ–ª–ª–∞–≥–µ–Ω –ª—É—á—à–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –±–µ–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –±–µ–ª–∫–∞–º–∏.',
        when: '–ù–∞—Ç–æ—â–∞–∫ –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ –∑–∞–≤—Ç—Ä–∞–∫–∞. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º C!',
        mechanism: 'VitC ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä –ø—Ä–æ–ª–∏–ª–≥–∏–¥—Ä–æ–∫—Å–∏–ª–∞–∑—ã ‚Üí –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –∫–æ–ª–ª–∞–≥–µ–Ω–∞. –ë–µ–∑ C –∫–æ–ª–ª–∞–≥–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!',
        evidence: '–ñ—É—Ä–Ω–∞–ª Nutrients, 2019: –≥–∏–¥—Ä–æ–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–ª–ª–∞–≥–µ–Ω + VitC —É–ª—É—á—à–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–∂–∏ –Ω–∞ 20%.',
        avoid: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º –±–µ–ª–∫–æ–≤—ã–º –ø—Ä–∏—ë–º–æ–º ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ —É—Å–≤–æ–µ–Ω–∏–µ.',
        synergy: ['vitC']
      }
    },
    
    // === –£–¢–†–ï–ù–ù–ò–ï –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–Æ–¢–°–Ø (–≤–µ—á–µ—Ä–Ω–∏–µ) ===
    magnesium: {
      timing: 'evening',
      mealTiming: '–í–µ—á–µ—Ä–æ–º, –ø–µ—Ä–µ–¥ —Å–Ω–æ–º',
      icon: 'üí§',
      shortTip: '‚ö†Ô∏è –õ—É—á—à–µ –≤–µ—á–µ—Ä–æ–º ‚Äî —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç!',
      science: {
        why: '–ú–∞–≥–Ω–∏–π —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç –º—ã—à—Ü—ã –∏ –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É. –£—Ç—Ä–æ–º –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å.',
        when: '–ó–∞ 1-2 —á–∞—Å–∞ –¥–æ —Å–Ω–∞. –ì–ª–∏—Ü–∏–Ω–∞—Ç/—Ç—Ä–µ–æ–Ω–∞—Ç ‚Äî –¥–ª—è —Å–Ω–∞, —Ü–∏—Ç—Ä–∞—Ç ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π.',
        mechanism: 'Mg –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ì–ê–ú–ö-—Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã (—Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ), –±–ª–æ–∫–∏—Ä—É–µ—Ç NMDA (–≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ) ‚Üí —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ.',
        evidence: 'Journal of Research in Medical Sciences: –º–∞–≥–Ω–∏–π —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –Ω–∞ 17%.',
        avoid: '–û–∫—Å–∏–¥ –º–∞–≥–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –∫–∞–∫ —Å–ª–∞–±–∏—Ç–µ–ª—å–Ω–æ–µ, –Ω–µ –¥–ª—è –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞.',
        morningNote: '–ï—Å–ª–∏ —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª ‚Äî –ø—Ä–∏–Ω–∏–º–∞–π —Å –µ–¥–æ–π, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç –±—É–¥–µ—Ç —Å–ª–∞–±–µ–µ.'
      }
    },
    
    melatonin: {
      timing: 'beforeBed',
      mealTiming: '‚ö†Ô∏è –¢–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º!',
      icon: 'üåô',
      shortTip: '‚ö†Ô∏è –¢–û–õ–¨–ö–û –ø–µ—Ä–µ–¥ —Å–Ω–æ–º, –∑–∞ 30-60 –º–∏–Ω',
      science: {
        why: '–ú–µ–ª–∞—Ç–æ–Ω–∏–Ω ‚Äî –≥–æ—Ä–º–æ–Ω —Å–Ω–∞! –£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–∏—ë–º —Å–æ–±—å—ë—Ç —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã.',
        when: '–ó–∞ 30-60 –º–∏–Ω—É—Ç –¥–æ —Å–Ω–∞, –≤ —Ç–µ–º–Ω–æ—Ç–µ.',
        mechanism: '–ú–µ–ª–∞—Ç–æ–Ω–∏–Ω —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–æ–∑–≥—É –æ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ—á–∏ ‚Üí –∑–∞–ø—É—Å–∫ –∫–∞—Å–∫–∞–¥–∞ –∑–∞—Å—ã–ø–∞–Ω–∏—è.',
        evidence: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —É—Ç—Ä–æ–º! –≠—Ç–æ —Å–æ–±—å—ë—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã.',
        avoid: '–ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —É—Ç—Ä–æ–º –∏–ª–∏ –¥–Ω—ë–º.',
        morningNote: '–ü–µ—Ä–µ–Ω–µ—Å–∏ –Ω–∞ –≤–µ—á–µ—Ä. –£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–∏—ë–º –Ω–∞–≤—Ä–µ–¥–∏—Ç!'
      }
    },
    
    glycine: {
      timing: 'beforeBed',
      mealTiming: '‚ö†Ô∏è –ü–µ—Ä–µ–¥ —Å–Ω–æ–º',
      icon: 'üò¥',
      shortTip: '‚ö†Ô∏è –ü–µ—Ä–µ–¥ —Å–Ω–æ–º ‚Äî —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞',
      science: {
        why: '–ì–ª–∏—Ü–∏–Ω ‚Äî —Ç–æ—Ä–º–æ–∑–Ω–æ–π –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä, —Å–Ω–∏–∂–∞–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞ –¥–ª—è –∑–∞—Å—ã–ø–∞–Ω–∏—è.',
        when: '–ó–∞ 30-60 –º–∏–Ω—É—Ç –¥–æ —Å–Ω–∞.',
        mechanism: '–ì–ª–∏—Ü–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç NMDA-—Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã –≤ –≥–∏–ø–æ—Ç–∞–ª–∞–º—É—Å–µ ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —è–¥—Ä–∞ ‚Üí —Å–æ–Ω.',
        evidence: 'Sleep and Biological Rhythms: 3–≥ –≥–ª–∏—Ü–∏–Ω–∞ —É–ª—É—á—à–∞—é—Ç —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞.',
        avoid: '–£—Ç—Ä–æ–º –¥–∞—Å—Ç —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å.',
        morningNote: '–ü–µ—Ä–µ–Ω–µ—Å–∏ –Ω–∞ –≤–µ—á–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.'
      }
    },
    
    ltheanine: {
      timing: 'evening',
      mealTiming: '–í–µ—á–µ—Ä–æ–º –∏–ª–∏ —Å –∫–æ—Ñ–µ (–∞–Ω—Ç–∏-—Ç—Ä–µ–≤–æ–≥–∞)',
      icon: 'üçµ',
      shortTip: '–í–µ—á–µ—Ä–æ–º –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è –∏–ª–∏ —Å –∫–æ—Ñ–µ',
      science: {
        why: 'L-—Ç–µ–∞–Ω–∏–Ω —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç –±–µ–∑ —Å–æ–Ω–ª–∏–≤–æ—Å—Ç–∏. –° –∫–æ—Ñ–µ ‚Äî —É–±–∏—Ä–∞–µ—Ç jitters, —Å–æ—Ö—Ä–∞–Ω—è—è —Ñ–æ–∫—É—Å.',
        when: '–í–µ—á–µ—Ä–æ–º –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è –∏–ª–∏ —É—Ç—Ä–æ–º –° –ö–û–§–ï –¥–ª—è —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ —Ñ–æ–∫—É—Å–∞.',
        mechanism: '–¢–µ–∞–Ω–∏–Ω —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞–ª—å—Ñ–∞-–≤–æ–ª–Ω—ã –º–æ–∑–≥–∞ ‚Üí —Å–ø–æ–∫–æ–π–Ω–∞—è –±–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.',
        evidence: '–ú–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è —É—Ç—Ä–æ–º –° –∫–æ—Ñ–µ (100-200–º–≥) –¥–ª—è "smooth energy".',
        morningNote: '–° –∫–æ—Ñ–µ ‚Äî –û–ö! –£–±–∏—Ä–∞–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –æ—Ç –∫–æ—Ñ–µ–∏–Ω–∞.'
      }
    },
    
    // === –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï ===
    berberine: {
      timing: 'beforeMeal',
      mealTiming: '–ó–∞ 15-30 –º–∏–Ω –î–û –µ–¥—ã',
      icon: 'üåø',
      shortTip: '–ó–∞ 15-30 –º–∏–Ω –¥–æ –µ–¥—ã ‚Äî —Å–Ω–∏–∑–∏—Ç —Å–∞—Ö–∞—Ä –≤ –∫—Ä–æ–≤–∏',
      science: {
        why: '–ë–µ—Ä–±–µ—Ä–∏–Ω —Å–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ –≤ –∫—Ä–æ–≤–∏ –∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é –≤–æ–ª–Ω—É –Ω–∞ 15%!',
        when: '–ó–∞ 15-30 –º–∏–Ω—É—Ç –¥–æ –µ–¥—ã, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —É–≥–ª–µ–≤–æ–¥—ã.',
        mechanism: '–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç AMPK ‚Üí —É–ª—É—á—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É, —Å–Ω–∏–∂–∞–µ—Ç –≥–ª—é–∫–æ–Ω–µ–æ–≥–µ–Ω–µ–∑.',
        evidence: 'Metabolism, 2008: –±–µ—Ä–±–µ—Ä–∏–Ω —Å–Ω–∏–∂–∞–µ—Ç HbA1c —Å—Ä–∞–≤–Ω–∏–º–æ —Å –º–µ—Ç—Ñ–æ—Ä–º–∏–Ω–æ–º.',
        avoid: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å –º–µ—Ç—Ñ–æ—Ä–º–∏–Ω–æ–º –±–µ–∑ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤—Ä–∞—á–∞.',
        insulinBonus: -0.15
      }
    },
    
    cinnamon: {
      timing: 'withFood',
      mealTiming: '–° –µ–¥–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —É–≥–ª–µ–≤–æ–¥—ã',
      icon: 'üçÇ',
      shortTip: '–° —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –µ–¥–æ–π ‚Äî —Å–Ω–∏–∂–∞–µ—Ç —Å–∞—Ö–∞—Ä',
      science: {
        why: '–ö–æ—Ä–∏—Ü–∞ —É–ª—É—á—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É, —Å–Ω–∏–∂–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é –≤–æ–ª–Ω—É –Ω–∞ 10%.',
        when: '–° –µ–¥–æ–π, –æ—Å–æ–±–µ–Ω–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —É–≥–ª–µ–≤–æ–¥—ã.',
        mechanism: '–ü–æ–ª–∏—Ñ–µ–Ω–æ–ª—ã –∫–æ—Ä–∏—Ü—ã –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã.',
        evidence: '–¶–µ–π–ª–æ–Ω—Å–∫–∞—è –∫–æ—Ä–∏—Ü–∞ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∫–∞—Å—Å–∏–∏ (–º–µ–Ω—å—à–µ –∫—É–º–∞—Ä–∏–Ω–∞).',
        insulinBonus: -0.10
      }
    },
    
    chromium: {
      timing: 'withFood',
      mealTiming: '–° —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –µ–¥–æ–π',
      icon: '‚öôÔ∏è',
      shortTip: '–° —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –µ–¥–æ–π ‚Äî —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∞—Ö–∞—Ä',
      science: {
        why: '–•—Ä–æ–º ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä GTF (glucose tolerance factor), –ø–æ–º–æ–≥–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω—É.',
        when: '–° –µ–¥–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —É–≥–ª–µ–≤–æ–¥—ã.',
        mechanism: '–•—Ä–æ–º —É—Å–∏–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –∏–Ω—Å—É–ª–∏–Ω–∞ —Å —Ä–µ—Ü–µ–ø—Ç–æ—Ä–∞–º–∏.',
        evidence: 'Diabetes Care: —Ö—Ä–æ–º –ø–∏–∫–æ–ª–∏–Ω–∞—Ç —É–ª—É—á—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É.',
        note: '–≠—Ñ—Ñ–µ–∫—Ç –∑–∞–º–µ—Ç–µ–Ω –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ. –ê–Ω–∞–ª–∏–∑—ã –ø–æ–∫–∞–∂—É—Ç –Ω—É–∂–µ–Ω –ª–∏.'
      }
    },
    
    vinegar: {
      timing: 'beforeMeal',
      mealTiming: '–ó–∞ 15-20 –º–∏–Ω –¥–æ —É–≥–ª–µ–≤–æ–¥–Ω–æ–π –µ–¥—ã',
      icon: 'üçé',
      shortTip: '–î–æ –µ–¥—ã ‚Äî —Å–Ω–∏–∂–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é –≤–æ–ª–Ω—É –Ω–∞ 20%',
      science: {
        why: '–Ø–±–ª–æ—á–Ω—ã–π —É–∫—Å—É—Å —Å–Ω–∏–∂–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ 20-30%!',
        when: '1-2 —Å—Ç.–ª. —Ä–∞–∑–≤–µ–¥—ë–Ω–Ω–æ–≥–æ —É–∫—Å—É—Å–∞ –∑–∞ 15-20 –º–∏–Ω—É—Ç –¥–æ –µ–¥—ã —Å —É–≥–ª–µ–≤–æ–¥–∞–º–∏.',
        mechanism: '–£–∫—Å—É—Å–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞, –∏–Ω–≥–∏–±–∏—Ä—É–µ—Ç –¥–∏—Å–∞—Ö–∞—Ä–∏–¥–∞–∑—ã.',
        evidence: 'European Journal of Clinical Nutrition: —É–∫—Å—É—Å —Å–Ω–∏–∂–∞–µ—Ç –ø–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω—É—é –≥–ª—é–∫–æ–∑—É –Ω–∞ 31%.',
        avoid: '–ù–µ –ø–∏—Ç—å –Ω–µ—Ä–∞–∑–≤–µ–¥—ë–Ω–Ω—ã–º ‚Äî —Ä–∞–∑—Ä—É—à–∞–µ—Ç —ç–º–∞–ª—å –∑—É–±–æ–≤!',
        insulinBonus: -0.20
      }
    },
    
    creatine: {
      timing: 'afterTrain',
      mealTiming: '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ —Å —É–≥–ª–µ–≤–æ–¥–∞–º–∏',
      icon: 'üí™',
      shortTip: '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –º—ã—à—Ü—ã',
      science: {
        why: '–ö—Ä–µ–∞—Ç–∏–Ω –ª—É—á—à–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –º—ã—à—Ü—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å —É–≥–ª–µ–≤–æ–¥–∞–º–∏ (–∏–Ω—Å—É–ª–∏–Ω –ø–æ–º–æ–≥–∞–µ—Ç).',
        when: '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ —É–≥–ª–µ–≤–æ–¥–∞–º–∏ –∏–ª–∏ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π.',
        mechanism: '–ò–Ω—Å—É–ª–∏–Ω —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç GLUT4 –∏ –∫—Ä–µ–∞—Ç–∏–Ω–æ–≤—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ—Ä—ã –≤ –º—ã—à—Ü–∞—Ö.',
        evidence: '5–≥/–¥–µ–Ω—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ó–∞–≥—Ä—É–∑–∫–∞ (20–≥) –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞.',
        morningNote: '–£—Ç—Ä–æ–º —Ç–æ–∂–µ –º–æ–∂–Ω–æ ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π. –ì–ª–∞–≤–Ω–æ–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å.'
      }
    },
    
    bcaa: {
      timing: 'afterTrain',
      mealTiming: '–î–æ/–≤–æ –≤—Ä–µ–º—è/–ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      icon: 'üèãÔ∏è',
      shortTip: '–í–æ–∫—Ä—É–≥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      science: {
        why: 'BCAA (–ª–µ–π—Ü–∏–Ω, –∏–∑–æ–ª–µ–π—Ü–∏–Ω, –≤–∞–ª–∏–Ω) —Å—Ç–∏–º—É–ª–∏—Ä—É—é—Ç —Å–∏–Ω—Ç–µ–∑ –±–µ–ª–∫–∞, —Å–Ω–∏–∂–∞—é—Ç –∫–∞—Ç–∞–±–æ–ª–∏–∑–º.',
        when: '–î–æ, –≤–æ –≤—Ä–µ–º—è –∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.',
        mechanism: '–õ–µ–π—Ü–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç mTOR ‚Üí –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à–µ—á–Ω–æ–≥–æ –±–µ–ª–∫–∞.',
        evidence: '–ï—Å–ª–∏ –µ—à—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–ª–∫–∞ (1.6+–≥/–∫–≥) ‚Äî BCAA –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.',
        morningNote: '–ï—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—Ç—Ä–æ–º –Ω–∞—Ç–æ—â–∞–∫ ‚Äî BCAA –¥–æ —Ç—Ä–µ–Ω–∏ –∑–∞—â–∏—Ç—è—Ç –º—ã—à—Ü—ã.'
      }
    },
    
    protein: {
      timing: 'afterTrain',
      mealTiming: '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è',
      icon: 'ü•õ',
      shortTip: '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –¥–ª—è –¥–æ–±–æ—Ä–∞ –±–µ–ª–∫–∞',
      science: {
        why: '–ü—Ä–æ—Ç–µ–∏–Ω ‚Äî —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ–±—Ä–∞—Ç—å —Å—É—Ç–æ—á–Ω—É—é –Ω–æ—Ä–º—É –±–µ–ª–∫–∞.',
        when: '–í —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –¥–ª—è –¥–æ–±–æ—Ä–∞ –Ω–æ—Ä–º—ã.',
        mechanism: '"–ê–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ" ‚Äî –º–∏—Ñ. –í–∞–∂–Ω–∞ —Å—É—Ç–æ—á–Ω–∞—è –Ω–æ—Ä–º–∞ –±–µ–ª–∫–∞ (1.6-2.2–≥/–∫–≥).',
        evidence: '–°—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π ‚Äî –±—ã—Å—Ç—Ä—ã–π (–ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏), –∫–∞–∑–µ–∏–Ω ‚Äî –º–µ–¥–ª–µ–Ω–Ω—ã–π (–Ω–∞ –Ω–æ—á—å).',
        morningNote: '–£—Ç—Ä–æ–º –º–æ–∂–Ω–æ, –µ—Å–ª–∏ –Ω–µ –¥–æ–±–∏—Ä–∞–µ—à—å –±–µ–ª–æ–∫ –∏–∑ –µ–¥—ã.'
      }
    }
  };
  
  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞ –ø–æ —É—Ç—Ä–µ–Ω–Ω–∏–º –≤–∏—Ç–∞–º–∏–Ω–∞–º
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞
   * @param {string[]} plannedSupplements - –≤–∏—Ç–∞–º–∏–Ω—ã, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤ —á–µ–∫-–∏–Ω–µ
   * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç (profile, mealCount, hasEaten)
   * @returns {Object|null} —Å–æ–≤–µ—Ç –¥–ª—è –º–æ–¥—É–ª—è Advice
   */
  function generateMorningSupplementAdvice(plannedSupplements, context = {}) {
    if (!plannedSupplements || plannedSupplements.length === 0) return null;
    
    const hour = new Date().getHours();
    // –¢–æ–ª—å–∫–æ —É—Ç—Ä–æ–º (6-12)
    if (hour < 6 || hour > 12) return null;
    
    const hasEaten = context.mealCount > 0 || context.hasEaten;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —É—Ç—Ä–µ–Ω–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã
    const morningSupps = plannedSupplements.filter(id => {
      const info = MORNING_SUPPLEMENT_SCIENCE[id];
      if (!info) return false;
      const timing = info.timing;
      return ['morning', 'empty', 'withFood', 'withFat', 'beforeMeal'].includes(timing);
    });
    
    if (morningSupps.length === 0) return null;
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏: –Ω–∞—Ç–æ—â–∞–∫ ‚Üí –¥–æ –µ–¥—ã ‚Üí —Å –µ–¥–æ–π
    const priorityOrder = { empty: 1, beforeMeal: 2, morning: 3, withFood: 4, withFat: 5 };
    morningSupps.sort((a, b) => {
      const infoA = MORNING_SUPPLEMENT_SCIENCE[a];
      const infoB = MORNING_SUPPLEMENT_SCIENCE[b];
      return (priorityOrder[infoA?.timing] || 99) - (priorityOrder[infoB?.timing] || 99);
    });
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø—É –ø—Ä–∏—ë–º–∞
    const groups = {
      empty: [],      // –ù–∞—Ç–æ—â–∞–∫
      beforeMeal: [], // –î–æ –µ–¥—ã
      withFood: [],   // –° –µ–¥–æ–π
      withFat: [],    // –° –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π
      evening: []     // –í–µ—á–µ—Ä–Ω–∏–µ (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
    };
    
    for (const id of morningSupps) {
      const info = MORNING_SUPPLEMENT_SCIENCE[id];
      if (!info) continue;
      
      const supp = HEYS.Supplements?.CATALOG?.[id] || { name: id, icon: 'üíä' };
      
      if (info.timing === 'evening' || info.timing === 'beforeBed') {
        groups.evening.push({ id, name: supp.name, icon: info.icon || supp.icon, info });
      } else if (info.timing === 'empty') {
        groups.empty.push({ id, name: supp.name, icon: info.icon || supp.icon, info });
      } else if (info.timing === 'beforeMeal') {
        groups.beforeMeal.push({ id, name: supp.name, icon: info.icon || supp.icon, info });
      } else if (info.timing === 'withFat') {
        groups.withFat.push({ id, name: supp.name, icon: info.icon || supp.icon, info });
      } else {
        groups.withFood.push({ id, name: supp.name, icon: info.icon || supp.icon, info });
      }
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –¥–µ—Ç–∞–ª–∏
    let title = '';
    let details = [];
    let priority = 1; // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –ø–µ—Ä–≤—ã–π —Å–æ–≤–µ—Ç –¥–Ω—è
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–µ—á–µ—Ä–Ω–∏–µ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
    if (groups.evening.length > 0) {
      const eveningNames = groups.evening.map(s => `${s.icon} ${s.name}`).join(', ');
      details.push(`‚ö†Ô∏è **–ü–µ—Ä–µ–Ω–µ—Å–∏ –Ω–∞ –≤–µ—á–µ—Ä:** ${eveningNames}`);
      for (const s of groups.evening) {
        details.push(`   ‚îî ${s.name}: ${s.info.science.why}`);
      }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –µ–ª –∏ –µ—Å—Ç—å –Ω–∞—Ç–æ—â–∞–∫ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –∏—Ö
    if (!hasEaten && groups.empty.length > 0) {
      const emptyNames = groups.empty.map(s => `${s.icon} ${s.name}`).join(', ');
      title = `üíä –°–µ–π—á–∞—Å: ${emptyNames}`;
      
      for (const s of groups.empty) {
        details.push(`**${s.icon} ${s.name}** ‚Äî ${s.info.shortTip}`);
        details.push(`üî¨ ${s.info.science.why}`);
        if (s.info.science.avoid) {
          details.push(`‚ö†Ô∏è ${s.info.science.avoid}`);
        }
      }
      
      // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∏—Ç–∞–º–∏–Ω–∞—Ö —Å –µ–¥–æ–π
      const withFoodAll = [...groups.withFood, ...groups.withFat];
      if (withFoodAll.length > 0) {
        const withFoodNames = withFoodAll.map(s => s.name).join(', ');
        details.push(`\n‚è∞ **–ü–æ—Å–ª–µ –∑–∞–≤—Ç—Ä–∞–∫–∞:** ${withFoodNames}`);
      }
    } 
    // –ï—Å–ª–∏ —É–∂–µ –µ–ª –∏–ª–∏ –Ω–µ—Ç –Ω–∞—Ç–æ—â–∞–∫ –≤–∏—Ç–∞–º–∏–Ω–æ–≤
    else {
      const allMorning = [...groups.beforeMeal, ...groups.withFood, ...groups.withFat, ...groups.empty];
      
      if (allMorning.length === 0) {
        return null; // –ù–µ—Ç —É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤–∏—Ç–∞–º–∏–Ω–æ–≤
      }
      
      // –í—ã–±–∏—Ä–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –≤–∏—Ç–∞–º–∏–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const mainSupp = allMorning[0];
      const otherCount = allMorning.length - 1;
      
      if (otherCount > 0) {
        title = `üíä –í—Ä–µ–º—è –≤–∏—Ç–∞–º–∏–Ω–æ–≤: ${mainSupp.icon} ${mainSupp.name} –∏ –µ—â—ë ${otherCount}`;
      } else {
        title = `üíä –í—Ä–µ–º—è: ${mainSupp.icon} ${mainSupp.name}`;
      }
      
      // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É
      for (const s of allMorning.slice(0, 4)) { // –ú–∞–∫—Å–∏–º—É–º 4 –≤ –¥–µ—Ç–∞–ª—è—Ö
        details.push(`**${s.icon} ${s.name}** ‚Äî ${s.info.shortTip}`);
        details.push(`üî¨ ${s.info.science.why}`);
      }
      
      if (allMorning.length > 4) {
        details.push(`\n...–∏ –µ—â—ë ${allMorning.length - 4} –≤–∏—Ç–∞–º–∏–Ω–æ–≤`);
      }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–µ—Ä–≥–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    const allIds = morningSupps;
    if (allIds.includes('iron') && allIds.includes('vitC')) {
      details.push(`\n‚ú® **–°–∏–Ω–µ—Ä–≥–∏—è:** –ñ–µ–ª–µ–∑–æ + –í–∏—Ç–∞–º–∏–Ω C = —É—Å–≤–æ–µ–Ω–∏–µ √ó3!`);
    }
    if (allIds.includes('vitD') && allIds.includes('k2')) {
      details.push(`\n‚ú® **–°–∏–Ω–µ—Ä–≥–∏—è:** D3 + K2 = –∫–∞–ª—å—Ü–∏–π –≤ –∫–æ—Å—Ç–∏, –Ω–µ –≤ —Å–æ—Å—É–¥—ã!`);
    }
    if (allIds.includes('vitD') && allIds.includes('omega3')) {
      details.push(`\n‚ú® **–°–∏–Ω–µ—Ä–≥–∏—è:** D3 + Omega-3 = –ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–π –¥—É—ç—Ç!`);
    }
    
    // –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã
    if (allIds.includes('iron') && allIds.includes('calcium')) {
      details.push(`\n‚ö†Ô∏è **–ö–æ–Ω—Ñ–ª–∏–∫—Ç:** –ñ–µ–ª–µ–∑–æ –∏ –ö–∞–ª—å—Ü–∏–π ‚Äî —Ä–∞–∑–¥–µ–ª–∏ –Ω–∞ 2 —á–∞—Å–∞!`);
    }
    if (allIds.includes('iron') && allIds.includes('zinc')) {
      details.push(`\n‚ö†Ô∏è **–ö–æ–Ω—Ñ–ª–∏–∫—Ç:** –ñ–µ–ª–µ–∑–æ –∏ –¶–∏–Ω–∫ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–π —Ä–∞–∑–¥–µ–ª—å–Ω–æ!`);
    }
    
    return {
      id: 'morning_supplements_reminder',
      icon: 'üíä',
      text: title,
      details: details.join('\n'),
      type: 'health',
      priority: priority,
      category: 'health',   // üíä –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê
      isReminder: true,     // üíä –§–ª–∞–≥: —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –Ω–µ —Å–æ–≤–µ—Ç ‚Äî bypass –Ω–∞—Å—Ç—Ä–æ–µ–∫
      triggers: ['tab_open', 'checkin_complete'],
      ttl: 10000, // 10 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞–∑–∞
      suppIds: morningSupps,
      // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–Ω—è—Ç—ã–º–∏"
      action: {
        label: '‚úÖ –ü—Ä–∏–Ω—è–ª',
        onClick: () => {
          const dateKey = new Date().toISOString().slice(0, 10);
          if (HEYS.Supplements?.markAllSupplementsTaken) {
            HEYS.Supplements.markAllSupplementsTaken(dateKey);
          }
        }
      }
    };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üåô –ì–ï–ù–ï–†–ê–¶–ò–Ø –í–ï–ß–ï–†–ù–ï–ì–û –°–û–í–ï–¢–ê –ü–û –í–ò–¢–ê–ú–ò–ù–ê–ú
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–≤–µ—Ç-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–µ—á–µ—Ä–Ω–∏—Ö –≤–∏—Ç–∞–º–∏–Ω–∞—Ö
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –µ–¥—ã –≤–µ—á–µ—Ä–æ–º (18:00-23:00)
   * 
   * @param {string[]} plannedSupplements - ID –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏—Ç–∞–º–∏–Ω–æ–≤
   * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç { mealCount, hasEaten, profile }
   * @returns {Object|null} - –æ–±—ä–µ–∫—Ç —Å–æ–≤–µ—Ç–∞ –∏–ª–∏ null
   */
  function generateEveningSupplementAdvice(plannedSupplements, context = {}) {
    if (!plannedSupplements || plannedSupplements.length === 0) return null;
    
    const hour = new Date().getHours();
    // –¢–æ–ª—å–∫–æ –≤–µ—á–µ—Ä–æ–º (18-23)
    if (hour < 18 || hour > 23) return null;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–µ—á–µ—Ä–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã
    const eveningSupps = plannedSupplements.filter(id => {
      const info = MORNING_SUPPLEMENT_SCIENCE[id];
      if (!info) return false;
      const timing = info.timing;
      return ['evening', 'beforeBed'].includes(timing);
    });
    
    if (eveningSupps.length === 0) return null;
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –≤–µ—á–µ—Ä–Ω–∏–µ ‚Üí –ø–µ—Ä–µ–¥ —Å–Ω–æ–º
    const priorityOrder = { evening: 1, beforeBed: 2 };
    eveningSupps.sort((a, b) => {
      const infoA = MORNING_SUPPLEMENT_SCIENCE[a];
      const infoB = MORNING_SUPPLEMENT_SCIENCE[b];
      return (priorityOrder[infoA?.timing] || 99) - (priorityOrder[infoB?.timing] || 99);
    });
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º
    const groups = {
      evening: [],   // –í–µ—á–µ—Ä–Ω–∏–µ (—Å —É–∂–∏–Ω–æ–º)
      beforeBed: []  // –ü–µ—Ä–µ–¥ —Å–Ω–æ–º
    };
    
    for (const id of eveningSupps) {
      const info = MORNING_SUPPLEMENT_SCIENCE[id];
      if (!info) continue;
      
      const supp = HEYS.Supplements?.CATALOG?.[id] || { name: id, icon: 'üíä' };
      const item = { id, name: supp.name, icon: info.icon || supp.icon, info };
      
      if (info.timing === 'beforeBed') {
        groups.beforeBed.push(item);
      } else {
        groups.evening.push(item);
      }
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    let title = '';
    let details = [];
    
    const allEvening = [...groups.evening, ...groups.beforeBed];
    
    if (allEvening.length === 0) return null;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const mainSupp = allEvening[0];
    const otherCount = allEvening.length - 1;
    
    if (otherCount > 0) {
      title = `üåô –í–µ—á–µ—Ä–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã: ${mainSupp.icon} ${mainSupp.name} –∏ –µ—â—ë ${otherCount}`;
    } else {
      title = `üåô –í—Ä–µ–º—è: ${mainSupp.icon} ${mainSupp.name}`;
    }
    
    // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É
    if (groups.evening.length > 0) {
      details.push('**–° —É–∂–∏–Ω–æ–º:**');
      for (const s of groups.evening) {
        details.push(`${s.icon} **${s.name}** ‚Äî ${s.info.shortTip}`);
        details.push(`   üî¨ ${s.info.science.why}`);
      }
    }
    
    if (groups.beforeBed.length > 0) {
      if (groups.evening.length > 0) details.push('');
      details.push('**–ü–µ—Ä–µ–¥ —Å–Ω–æ–º (—á–µ—Ä–µ–∑ 1-2—á):**');
      for (const s of groups.beforeBed) {
        details.push(`${s.icon} **${s.name}** ‚Äî ${s.info.shortTip}`);
        details.push(`   üî¨ ${s.info.science.why}`);
      }
    }
    
    // –°–∏–Ω–µ—Ä–≥–∏–∏ –≤–µ—á–µ—Ä–Ω–∏—Ö
    const allIds = eveningSupps;
    if (allIds.includes('magnesium') && allIds.includes('glycine')) {
      details.push(`\n‚ú® **–°–∏–Ω–µ—Ä–≥–∏—è:** –ú–∞–≥–Ω–∏–π + –ì–ª–∏—Ü–∏–Ω = –≥–ª—É–±–æ–∫–∏–π —Å–æ–Ω!`);
    }
    if (allIds.includes('magnesium') && allIds.includes('melatonin')) {
      details.push(`\n‚ú® **–°–∏–Ω–µ—Ä–≥–∏—è:** –ú–∞–≥–Ω–∏–π + –ú–µ–ª–∞—Ç–æ–Ω–∏–Ω = –±—ã—Å—Ç—Ä–æ–µ –∑–∞—Å—ã–ø–∞–Ω–∏–µ!`);
    }
    
    return {
      id: 'evening_supplements_reminder',
      icon: 'üåô',
      text: title,
      details: details.join('\n'),
      type: 'health',
      priority: 1, // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
      category: 'health',   // üíä –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê
      isReminder: true,     // üíä –§–ª–∞–≥: —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –Ω–µ —Å–æ–≤–µ—Ç ‚Äî bypass –Ω–∞—Å—Ç—Ä–æ–µ–∫
      triggers: ['product_added'],
      ttl: 10000,
      suppIds: eveningSupps,
      action: {
        label: '‚úÖ –ü—Ä–∏–Ω—è–ª',
        onClick: () => {
          const dateKey = new Date().toISOString().slice(0, 10);
          // –û—Ç–º–µ—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—á–µ—Ä–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã
          if (HEYS.Supplements?.markSupplementsTaken) {
            HEYS.Supplements.markSupplementsTaken(dateKey, eveningSupps);
          } else if (HEYS.Supplements?.markSupplementTaken) {
            eveningSupps.forEach(id => HEYS.Supplements.markSupplementTaken(dateKey, id));
          }
        }
      }
    };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üì§ –≠–ö–°–ü–û–†–¢ –í –û–°–ù–û–í–ù–û–ô –ú–û–î–£–õ–¨
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // –†–∞—Å—à–∏—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –Ω–∞—É—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  Object.assign(HEYS.Supplements, {
    // –ù–∞—É—á–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    SCIENCE: {
      BIOAVAILABILITY,
      LIMITS,
      CIRCADIAN_OPTIMAL,
      INTERACTIONS_EXTENDED,
      CYCLE_SUPPLEMENTS,
      DEFICIENCY_SYMPTOMS,
      FOOD_NUTRIENT_SOURCES,
      MORNING_SUPPLEMENT_SCIENCE  // üÜï –ù–∞—É—á–Ω—ã–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏—ë–º–∞
    },
    
    // –ù–∞—É—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    getSupplementScience,
    getOptimalTime,
    getSynergies,
    getAntagonisms,
    getFoodTips,
    getCycleRecommendations,
    analyzeSymptoms,
    analyzeMealNutrients,
    getScientificRecommendations,
    generateMorningSupplementAdvice,  // üÜï –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ–≤–µ—Ç–∞
    generateEveningSupplementAdvice   // üÜï –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–µ—á–µ—Ä–Ω–µ–≥–æ —Å–æ–≤–µ—Ç–∞
  });

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_profile_step_v1.js ===== */
// heys_profile_step_v1.js ‚Äî Wizard –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞: 4 —à–∞–≥–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
// Personal ‚Üí Body ‚Üí Goals ‚Üí Metabolism
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const { useState, useMemo, useCallback, useEffect } = React;

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ StepModal
  if (!HEYS.StepModal) {
    console.error('heys_profile_step_v1.js: HEYS.StepModal not found. Load heys_step_modal_v1.js first.');
    return;
  }

  const { WheelPicker, registerStep, utils } = HEYS.StepModal;
  const { lsGet, lsSet, getTodayKey } = utils;

  // ============================================================
  // –£–¢–ò–õ–ò–¢–´
  // ============================================================

  // –î—É–±–ª–∏—Ä—É–µ–º –ø—Ä–µ—Å–µ—Ç—ã –∏–∑ heys_user_v12.js (–æ–Ω–∏ –≤–Ω—É—Ç—Ä–∏ scope UserPage)
  const GOAL_PRESETS = [
    { value: -20, label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üî•üî•', color: '#ef4444' },
    { value: -15, label: '–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üî•', color: '#f97316' },
    { value: -10, label: '–£–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ', emoji: 'üéØ', color: '#eab308' },
    { value: 0, label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞', emoji: '‚öñÔ∏è', color: '#22c55e' },
    { value: 10, label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™', color: '#3b82f6' },
    { value: 15, label: '–ê–∫—Ç–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä', emoji: 'üí™üí™', color: '#3b82f6' }
  ];

  const INSULIN_PRESETS = [
    { value: 2.5, label: '–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º', desc: '—Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã, –Ω–∏–∑–∫–æ—É–≥–ª–µ–≤–æ–¥–∫–∞' },
    { value: 3, label: '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π', desc: '–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π' },
    { value: 4, label: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π', desc: '—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –ø–æ–ª–Ω–æ—Ç–µ' },
    { value: 4.5, label: '–ò–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å', desc: '–ø—Ä–µ–¥–¥–∏–∞–±–µ—Ç, –°–ü–ö–Ø' }
  ];

  // –†–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ heys_user_v12.js)
  function calcAgeFromBirthDate(birthDate) {
    if (!birthDate) return 0;
    const birth = new Date(birthDate);
    if (isNaN(birth.getTime())) return 0;
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return Math.max(0, age);
  }

  // –†–∞—Å—á—ë—Ç –Ω–æ—Ä–º—ã —Å–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏ –ø–æ–ª—É (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ heys_user_v12.js)
  function calcSleepNorm(age, gender) {
    let baseMin, baseMax, explanation;

    if (age < 13) {
      baseMin = 9; baseMax = 12;
      explanation = '–¥–µ—Ç–∏ 6-12 –ª–µ—Ç: 9-12—á';
    } else if (age < 18) {
      baseMin = 8; baseMax = 10;
      explanation = '–ø–æ–¥—Ä–æ—Å—Ç–∫–∏ 13-17: 8-10—á';
    } else if (age < 26) {
      baseMin = 7; baseMax = 9;
      explanation = '–º–æ–ª–æ–¥—ã–µ 18-25: 7-9—á';
    } else if (age < 65) {
      baseMin = 7; baseMax = 9;
      explanation = '–≤–∑—Ä–æ—Å–ª—ã–µ 26-64: 7-9—á';
    } else {
      baseMin = 7; baseMax = 8;
      explanation = '–ø–æ–∂–∏–ª—ã–µ 65+: 7-8—á';
    }

    const genderBonus = gender === '–ñ–µ–Ω—Å–∫–∏–π' ? 0.3 : 0;
    const recommended = Math.round(((baseMin + baseMax) / 2 + genderBonus) * 2) / 2;

    return {
      hours: recommended,
      range: `${baseMin}-${baseMax}`,
      explanation: explanation + (genderBonus > 0 ? ' +20–º–∏–Ω –∂–µ–Ω.' : '')
    };
  }

  // –†–∞—Å—á—ë—Ç –Ω–æ—Ä–º –ë–ñ–£ –ø–æ —Ü–µ–ª–∏, –ø–æ–ª—É –∏ –≤–æ–∑—Ä–∞—Å—Ç—É
  function calcNormsFromGoal(deficitPct, gender = '–ú—É–∂—Å–∫–æ–π', age = 30) {
    // üîß v2.0.2: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —á–∏—Å–ª—É (–∏–Ω–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫–∞)
    const deficitPctNum = Number(deficitPct) || 0;
    const ageNum = Number(age) || 30;
    const isFemale = gender === '–ñ–µ–Ω—Å–∫–∏–π';

    console.log('[calcNormsFromGoal] Input:', { deficitPct, deficitPctNum, gender, age: ageNum });

    let proteinPct, carbsPct, fatPct;

    if (deficitPctNum <= -15) {
      if (isFemale) {
        proteinPct = 30; carbsPct = 35; fatPct = 35;
      } else {
        proteinPct = 35; carbsPct = 40; fatPct = 25;
      }
    } else if (deficitPctNum <= -5) {
      if (isFemale) {
        proteinPct = 28; carbsPct = 40; fatPct = 32;
      } else {
        proteinPct = 30; carbsPct = 45; fatPct = 25;
      }
    } else if (deficitPctNum <= 5) {
      if (isFemale) {
        proteinPct = 25; carbsPct = 45; fatPct = 30;
      } else {
        proteinPct = 25; carbsPct = 50; fatPct = 25;
      }
    } else {
      if (isFemale) {
        proteinPct = 28; carbsPct = 47; fatPct = 25;
      } else {
        proteinPct = 30; carbsPct = 50; fatPct = 20;
      }
    }

    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
    if (ageNum >= 60) {
      proteinPct += 5;
      carbsPct -= 5;
    } else if (ageNum >= 40) {
      proteinPct += 3;
      carbsPct -= 3;
    }

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
    const total = proteinPct + carbsPct + fatPct;
    if (total !== 100) {
      const factor = 100 / total;
      proteinPct = Math.round(proteinPct * factor);
      carbsPct = Math.round(carbsPct * factor);
      fatPct = 100 - proteinPct - carbsPct;
    }

    return {
      carbsPct,
      proteinPct,
      simpleCarbPct: 30,
      badFatPct: 30,
      superbadFatPct: 5,
      fiberPct: 14,
      giPct: 55,
      harmPct: 10
    };
  }

  // –†–∞—Å—á—ë—Ç BMI
  function calcBMI(weight, height) {
    if (!weight || !height) return 0;
    const heightM = height / 100;
    return weight / (heightM * heightM);
  }

  // –ö–∞—Ç–µ–≥–æ—Ä–∏—è BMI
  function getBMICategory(bmi) {
    if (bmi < 18.5) return { label: '‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –≤–µ—Å–∞', color: '#eab308' };
    if (bmi < 25) return { label: '‚úÖ –ù–æ—Ä–º–∞', color: '#22c55e' };
    if (bmi < 30) return { label: '‚ö†Ô∏è –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å', color: '#f97316' };
    return { label: 'üî¥ –û–∂–∏—Ä–µ–Ω–∏–µ', color: '#ef4444' };
  }

  // –†–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Ü–µ–ª–∏
  function calcTimeToGoal(currentWeight, goalWeight, deficitPct) {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined/NaN –∑–Ω–∞—á–µ–Ω–∏–π
    const cw = Number(currentWeight) || 70;
    const gw = Number(goalWeight) || cw;
    const dp = Number(deficitPct) || 0;

    const diff = Math.abs(gw - cw);
    if (diff < 0.5 || !isFinite(diff)) return '‚ú® –£–∂–µ –Ω–∞ —Ü–µ–ª–∏!';

    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: 0.5-1 –∫–≥/–Ω–µ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞
    let weeklyRate;
    const absPct = Math.abs(dp);
    if (absPct >= 15) weeklyRate = 0.8;
    else if (absPct >= 10) weeklyRate = 0.6;
    else weeklyRate = 0.4;

    const weeks = Math.ceil(diff / weeklyRate);
    const months = Math.floor(weeks / 4);

    if (!isFinite(weeks) || weeks <= 0) return '‚ú® –£–∂–µ –Ω–∞ —Ü–µ–ª–∏!';
    if (months >= 12) return `~${Math.floor(months / 12)} –≥–æ–¥${months >= 24 ? '–∞' : ''}`;
    if (months > 0) return `~${months} –º–µ—Å`;
    return `~${weeks} –Ω–µ–¥`;
  }

  // Smart default –¥–ª—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
  function getSmartInsulinDefault(age) {
    if (age < 30) return 2.5;
    if (age < 50) return 3;
    return 4;
  }

  // ============================================================
  // HintTooltip ‚Äî –ø–æ–ø–∞–ø-–ø–æ–¥—Å–∫–∞–∑–∫–∞ (–Ω–µ —Å–¥–≤–∏–≥–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç)
  // ============================================================

  function HintTooltip({ show, onClose, children, position = 'bottom' }) {
    if (!show) return null;

    const positionStyles = {
      bottom: { top: '100%', left: '50%', transform: 'translateX(-50%)', marginTop: '8px' },
      top: { bottom: '100%', left: '50%', transform: 'translateX(-50%)', marginBottom: '8px' },
      left: { right: '100%', top: '50%', transform: 'translateY(-50%)', marginRight: '8px' },
      right: { left: '100%', top: '50%', transform: 'translateY(-50%)', marginLeft: '8px' }
    };

    return React.createElement('div', {
      className: 'absolute z-50',
      style: { ...positionStyles[position], minWidth: '200px', maxWidth: '280px' }
    },
      React.createElement('div', {
        className: 'bg-white rounded-xl shadow-lg border border-gray-200 p-3 text-xs text-gray-600',
        style: { animation: 'fadeIn 0.15s ease-out' },
        onClick: (e) => e.stopPropagation()
      },
        children,
        React.createElement('button', {
          type: 'button',
          onClick: onClose,
          className: 'absolute -top-2 -right-2 w-5 h-5 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-500 text-xs flex items-center justify-center transition-colors'
        }, '√ó')
      ),
      // Backdrop –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
      React.createElement('div', {
        className: 'fixed inset-0 z-[-1]',
        onClick: onClose
      })
    );
  }

  // ============================================================
  // –®–ê–ì 1: PERSONAL (–∏–º—è, –ø–æ–ª, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, —Ü–∏–∫–ª)
  // ============================================================

  function ProfilePersonalComponent({ data, onChange }) {
    const [showCycleHint, setShowCycleHint] = useState(false);
    const [showBirthDateHint, setShowBirthDateHint] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º WheelPicker –∏–∑ StepModal
    const WheelPicker = HEYS.StepModal?.WheelPicker;

    const firstName = data.firstName || '';
    const gender = data.gender || '–ú—É–∂—Å–∫–æ–π';
    const cycleTrackingEnabled = data.cycleTrackingEnabled || false;

    // –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞—Ç—É –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    const currentYear = new Date().getFullYear();
    const birthDay = data.birthDay || 1;
    const birthMonth = data.birthMonth || 1;
    const birthYear = data.birthYear || (currentYear - 25); // –¥–µ—Ñ–æ–ª—Ç 25 –ª–µ—Ç

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    const birthDate = `${birthYear}-${String(birthMonth).padStart(2, '0')}-${String(birthDay).padStart(2, '0')}`;

    const age = calcAgeFromBirthDate(birthDate);
    const isFemale = gender === '–ñ–µ–Ω—Å–∫–∏–π';

    // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–∏–∫–µ—Ä–æ–≤
    const daysInMonth = new Date(birthYear, birthMonth, 0).getDate();
    const dayValues = useMemo(() => Array.from({ length: daysInMonth }, (_, i) => i + 1), [daysInMonth]);
    const monthValues = useMemo(() => [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], []);
    const yearValues = useMemo(() => {
      const years = [];
      for (let y = currentYear - 10; y >= 1940; y--) years.push(y);
      return years;
    }, [currentYear]);

    const monthNames = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
    const formatMonth = (m) => monthNames[m - 1];
    const pad2 = (v) => String(v).padStart(2, '0');

    return React.createElement('div', { className: 'flex flex-col gap-6 p-4' },
      // –ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      React.createElement('div', { className: 'flex flex-col gap-2' },
        React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, 'üë§ –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? *'),
        React.createElement('input', {
          type: 'text',
          value: firstName,
          onChange: (e) => onChange({ ...data, firstName: e.target.value }),
          placeholder: '–í–∞—à–µ –∏–º—è',
          className: `w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent ${!firstName.trim() ? 'border-red-300 bg-red-50' : 'border-gray-300'
            }`
        })
      ),

      // –ü–æ–ª (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - —Ç–æ–ª—å–∫–æ –ú—É–∂—Å–∫–æ–π/–ñ–µ–Ω—Å–∫–∏–π
      React.createElement('div', { className: 'flex flex-col gap-2' },
        React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, 'üë§ –ü–æ–ª *'),
        React.createElement('div', { className: 'grid grid-cols-2 gap-3' },
          ['–ú—É–∂—Å–∫–æ–π', '–ñ–µ–Ω—Å–∫–∏–π'].map(g =>
            React.createElement('button', {
              key: g,
              type: 'button',
              onClick: () => {
                onChange({ ...data, gender: g });
                if (typeof navigator !== 'undefined' && navigator.vibrate) {
                  navigator.vibrate(10);
                }
              },
              className: `px-4 py-3 rounded-xl border-2 font-medium transition-all ${gender === g
                ? 'border-emerald-500 bg-emerald-50 text-emerald-700 scale-105'
                : 'border-gray-300 bg-white text-gray-700 hover:border-emerald-300'
                }`,
              style: gender === g ? { animation: 'pulse 0.3s ease-out' } : {}
            }, g)
          )
        )
      ),

      // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (WheelPickers v2)
      React.createElement('div', { className: 'flex flex-col gap-3' },
        React.createElement('div', { className: 'flex items-center justify-between' },
          React.createElement('div', { className: 'flex items-center gap-2 relative' },
            React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, 'üéÇ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *'),
            React.createElement('button', {
              type: 'button',
              onClick: () => setShowBirthDateHint(!showBirthDateHint),
              className: 'w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs font-medium hover:bg-emerald-100 hover:text-emerald-600 transition-colors flex items-center justify-center'
            }, '?'),
            React.createElement(HintTooltip, {
              show: showBirthDateHint,
              onClose: () => setShowBirthDateHint(false)
            },
              '–í–æ–∑—Ä–∞—Å—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–æ—Ä–º—É —Å–Ω–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –±–µ–ª–∫–µ.',
              React.createElement('br'),
              React.createElement('span', { className: 'text-[10px] text-gray-400 mt-1 block' }, '–ò—Å—Ç–æ—á–Ω–∏–∫: National Sleep Foundation, 2015')
            )
          ),
          age > 0 && React.createElement('span', {
            className: 'text-lg font-bold text-emerald-600'
          }, `${age} –ª–µ—Ç`)
        ),
        // WheelPickers: –î–µ–Ω—å / –ú–µ—Å—è—Ü / –ì–æ–¥
        WheelPicker ? React.createElement('div', { className: 'flex justify-center gap-2 bg-gray-50 rounded-xl p-4' },
          // –î–µ–Ω—å
          React.createElement(WheelPicker, {
            values: dayValues,
            value: birthDay,
            onChange: (v) => onChange({ ...data, birthDay: v }),
            label: '–¥–µ–Ω—å',
            formatValue: pad2,
            wrap: true
          }),
          // –ú–µ—Å—è—Ü
          React.createElement(WheelPicker, {
            values: monthValues,
            value: birthMonth,
            onChange: (v) => onChange({ ...data, birthMonth: v }),
            label: '–º–µ—Å—è—Ü',
            formatValue: formatMonth,
            wrap: true
          }),
          // –ì–æ–¥
          React.createElement(WheelPicker, {
            values: yearValues,
            value: birthYear,
            onChange: (v) => onChange({ ...data, birthYear: v }),
            label: '–≥–æ–¥',
            wrap: false
          })
        ) : React.createElement('input', {
          type: 'date',
          value: birthDate,
          onChange: (e) => {
            const [y, m, d] = e.target.value.split('-').map(Number);
            onChange({ ...data, birthYear: y, birthMonth: m, birthDay: d });
          },
          max: new Date().toISOString().split('T')[0],
          className: 'w-full px-4 py-3 border border-gray-300 rounded-xl'
        })
      ),

      // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –æ—Å–æ–±–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω)
      isFemale && React.createElement('div', {
        className: 'flex items-center justify-between p-3 bg-pink-50 rounded-xl border border-pink-200',
        style: { animation: 'fadeIn 0.3s ease-out' }
      },
        React.createElement('div', { className: 'flex flex-col gap-0.5' },
          React.createElement('div', { className: 'flex items-center gap-2 relative' },
            React.createElement('span', { className: 'text-xs font-medium text-gray-700' }, 'üå∏ –£—á–∏—Ç—ã–≤–∞—Ç—å –æ—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥?'),
            React.createElement('button', {
              type: 'button',
              onClick: () => setShowCycleHint(!showCycleHint),
              className: 'w-4 h-4 rounded-full bg-pink-200 text-pink-600 text-[10px] font-medium hover:bg-pink-300 transition-colors flex items-center justify-center'
            }, '?'),
            React.createElement(HintTooltip, {
              show: showCycleHint,
              onClose: () => setShowCycleHint(false)
            }, 'HEYS –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –∫–∞–ª–æ—Ä–∏–∏ –∏ –≤–æ–¥—É –ø–æ–¥ —Ñ–∞–∑—ã —Ü–∏–∫–ª–∞. –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.')
          ),
          React.createElement('span', { className: 'text-[11px] text-gray-500' },
            cycleTrackingEnabled ? '‚úì –ù–æ—Ä–º—ã –±—É–¥—É—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–∫–ª—é—á–∏—Ç–µ, —á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö'
          )
        ),
        React.createElement('label', { className: 'toggle-switch', style: { transform: 'scale(0.85)' } },
          React.createElement('input', {
            type: 'checkbox',
            checked: cycleTrackingEnabled,
            onChange: (e) => {
              onChange({ ...data, cycleTrackingEnabled: e.target.checked });
              if (typeof navigator !== 'undefined' && navigator.vibrate) {
                navigator.vibrate(10);
              }
            }
          }),
          React.createElement('span', { className: 'toggle-slider' })
        )
      )
    );
  }

  registerStep('profile-personal', {
    title: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
    hint: '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ',
    icon: 'üë§',
    component: ProfilePersonalComponent,
    getInitialData: () => {
      const profile = lsGet('heys_profile', {}) || {};
      const currentYear = new Date().getFullYear();

      // üõ°Ô∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
      const hasProfileCompleted = profile.profileCompleted === true;
      const isDefaultGender = !profile.gender || profile.gender === '–ú—É–∂—Å–∫–æ–π';
      const isDefaultWeight = !profile.weight || profile.weight === 70;
      const isDefaultHeight = !profile.height || profile.height === 175;
      const noBirthDate = !profile.birthDate;
      const isDefaultAge = !profile.age || profile.age === 30;
      const isProbablyIncomplete = !hasProfileCompleted &&
        isDefaultGender && isDefaultWeight && isDefaultHeight && noBirthDate && isDefaultAge;

      if (isProbablyIncomplete) {
        localStorage.setItem('heys_registration_in_progress', 'true');
        console.warn('[ProfileSteps] registrationInProgress set (profile incomplete)', {
          profileCompleted: profile?.profileCompleted,
          hasFirstName: !!profile?.firstName,
          hasBirthDate: !!profile?.birthDate
        });
      } else {
        localStorage.removeItem('heys_registration_in_progress');
        console.warn('[ProfileSteps] registrationInProgress cleared (profile complete)', {
          profileCompleted: profile?.profileCompleted,
          hasFirstName: !!profile?.firstName,
          hasBirthDate: !!profile?.birthDate
        });
      }

      // –ü–∞—Ä—Å–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –¥–∞—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
      let birthDay = 1, birthMonth = 1, birthYear = currentYear - 25;
      if (profile.birthDate) {
        const [y, m, d] = profile.birthDate.split('-').map(Number);
        if (y && m && d) {
          birthYear = y;
          birthMonth = m;
          birthDay = d;
        }
      }

      // üí° –î–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –≤–≤–µ–¥—ë–Ω–Ω–æ–µ –∫—É—Ä–∞—Ç–æ—Ä–æ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
      // –ß–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ localStorage (–±–µ–∑ scope), —Ç.–∫. auth –ø–∏—à–µ—Ç —Ç—É–¥–∞ –±–µ–∑ namespace
      let pendingName = '';
      try {
        const raw = localStorage.getItem('heys_pending_client_name');
        pendingName = raw ? JSON.parse(raw) : '';
      } catch (e) { }
      const firstName = profile.firstName || pendingName || '';

      return {
        firstName,
        gender: profile.gender || '–ú—É–∂—Å–∫–æ–π',
        birthDay,
        birthMonth,
        birthYear,
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á—ë–Ω –¥–ª—è –∂–µ–Ω—â–∏–Ω (–º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å)
        cycleTrackingEnabled: profile.cycleTrackingEnabled !== undefined ? profile.cycleTrackingEnabled : true
      };
    },
    validate: (data) => {
      if (!data.firstName || !data.firstName.trim()) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è';
      if (!data.gender) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª';
      if (!data.birthYear || !data.birthMonth || !data.birthDay) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è';
      return true;
    },
    getValidationMessage: (data) => {
      if (!data.firstName || !data.firstName.trim()) return '–£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è';
      if (!data.gender) return '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª';
      if (!data.birthYear || !data.birthMonth || !data.birthDay) return '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è';
      return null;
    },
    save: (data) => {
      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
      const birthDate = `${data.birthYear}-${String(data.birthMonth).padStart(2, '0')}-${String(data.birthDay).padStart(2, '0')}`;
      const profile = lsGet('heys_profile', {}) || {};
      profile.firstName = data.firstName;
      profile.gender = data.gender;
      profile.birthDate = birthDate;
      profile.cycleTrackingEnabled = data.cycleTrackingEnabled;
      // –í—ã—á–∏—Å–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç
      profile.age = calcAgeFromBirthDate(birthDate);
      lsSet('heys_profile', profile);

      // üí° –û—á–∏—â–∞–µ–º pending name –æ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
      if (lsGet('heys_pending_client_name', '')) {
        localStorage.removeItem('heys_pending_client_name');
      }
    }
  });

  // ============================================================
  // –®–ê–ì 2: BODY (–≤–µ—Å, —Ä–æ—Å—Ç, —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å) ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
  // ============================================================

  function ProfileBodyComponent({ data, onChange }) {
    const [showGoalHint, setShowGoalHint] = useState(false);

    const weight = data.weight || 70;
    const height = data.height || 175;
    const weightGoal = data.weightGoal || weight;

    const bmi = calcBMI(weight, height);
    const bmiCat = getBMICategory(bmi);
    const weightDiff = weightGoal - weight;

    const weightValues = useMemo(() => Array.from({ length: 171 }, (_, i) => 30 + i), []);
    const heightValues = useMemo(() => Array.from({ length: 111 }, (_, i) => 120 + i), []);

    return React.createElement('div', { className: 'flex flex-col gap-3 p-3' },
      // === –†—è–¥ 1: –í–µ—Å –∏ –†–æ—Å—Ç –≤ 2 –∫–∞—Ä—Ç–æ—á–∫–∏ ===
      React.createElement('div', { className: 'grid grid-cols-2 gap-3' },
        // –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–µ—Å–∞
        React.createElement('div', {
          className: 'bg-white rounded-xl border border-gray-200 p-3 shadow-sm'
        },
          React.createElement('div', {
            className: 'bg-gray-100 rounded-lg px-3 py-1.5 mb-2 text-center'
          },
            React.createElement('span', { className: 'text-xs font-semibold text-gray-700' }, '‚öñÔ∏è –í–µ—Å')
          ),
          React.createElement(WheelPicker, {
            values: weightValues,
            value: weight,
            onChange: (v) => onChange({ ...data, weight: v }),
            label: '–∫–≥',
            height: 100
          })
        ),
        // –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–æ—Å—Ç–∞
        React.createElement('div', {
          className: 'bg-white rounded-xl border border-gray-200 p-3 shadow-sm'
        },
          React.createElement('div', {
            className: 'bg-gray-100 rounded-lg px-3 py-1.5 mb-2 text-center'
          },
            React.createElement('span', { className: 'text-xs font-semibold text-gray-700' }, 'üìè –†–æ—Å—Ç')
          ),
          React.createElement(WheelPicker, {
            values: heightValues,
            value: height,
            onChange: (v) => onChange({ ...data, height: v }),
            label: '—Å–º',
            height: 100
          })
        )
      ),

      // === BMI ‚Äî –±–µ–π–¥–∂ ===
      bmi > 0 && React.createElement('div', {
        className: 'flex items-center justify-center gap-2 py-2 px-4 rounded-xl border',
        style: {
          backgroundColor: bmiCat.color + '10',
          borderColor: bmiCat.color + '30'
        }
      },
        React.createElement('span', { className: 'text-xs text-gray-600' }, 'üìä –ò–ú–¢:'),
        React.createElement('span', {
          className: 'text-sm font-bold',
          style: { color: bmiCat.color }
        }, `${bmi.toFixed(1)} ‚Äî ${bmiCat.label}`)
      ),

      // === –ö–∞—Ä—Ç–æ—á–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ –≤–µ—Å–∞ ===
      React.createElement('div', {
        className: 'bg-white rounded-xl border border-gray-200 p-3 shadow-sm'
      },
        React.createElement('div', {
          className: 'bg-emerald-100 rounded-lg px-3 py-1.5 mb-2 flex items-center justify-center gap-2 relative'
        },
          React.createElement('span', { className: 'text-xs font-semibold text-emerald-700' }, 'üéØ –¶–µ–ª–µ–≤–æ–π –≤–µ—Å'),
          React.createElement('button', {
            type: 'button',
            onClick: () => setShowGoalHint(!showGoalHint),
            className: 'w-4 h-4 rounded-full bg-emerald-200 text-emerald-600 text-[10px] font-bold hover:bg-emerald-300 transition-colors flex items-center justify-center'
          }, '?'),
          React.createElement(HintTooltip, {
            show: showGoalHint,
            onClose: () => setShowGoalHint(false)
          },
            '–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: 0.5-1 –∫–≥/–Ω–µ–¥–µ–ª—é.',
            React.createElement('br'),
            React.createElement('span', { className: 'text-[10px] text-gray-400 mt-1 block' }, '–ò—Å—Ç–æ—á–Ω–∏–∫: CDC, NHS guidelines')
          )
        ),
        React.createElement(WheelPicker, {
          values: weightValues,
          value: weightGoal,
          onChange: (v) => onChange({ ...data, weightGoal: v }),
          label: '–∫–≥',
          height: 100
        }),
        // –ü—Ä–æ–≥–Ω–æ–∑ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
        Math.abs(weightDiff) >= 0.5 && React.createElement('div', {
          className: 'mt-2 pt-2 border-t border-gray-100 text-center'
        },
          React.createElement('span', { className: 'text-xs text-gray-500' }, '‚è± –î–æ —Ü–µ–ª–∏: '),
          React.createElement('span', {
            className: 'text-sm font-bold',
            style: { color: weightDiff < 0 ? '#22c55e' : '#3b82f6' }
          },
            `${weightDiff > 0 ? '+' : ''}${weightDiff.toFixed(1)} –∫–≥`
          )
        )
      )
    );
  }

  registerStep('profile-body', {
    title: '–§–∏–∑–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ',
    hint: '–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ü–µ–ª–∏',
    icon: 'üìä',
    component: ProfileBodyComponent,
    getInitialData: () => {
      const profile = lsGet('heys_profile', {}) || {};
      return {
        weight: profile.weight || 70,
        height: profile.height || 175,
        weightGoal: profile.weightGoal || profile.weight || 70
      };
    },
    validate: (data) => {
      if (!data.weight || data.weight < 30) return '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å';
      if (!data.height || data.height < 120) return '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–æ—Å—Ç';
      if (!data.weightGoal || data.weightGoal < 30) return '–£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å';
      return true;
    },
    getValidationMessage: (data) => {
      if (!data.weight || data.weight < 30) return '–£–∫–∞–∂–∏—Ç–µ –≤–µ—Å (–º–∏–Ω. 30 –∫–≥)';
      if (!data.height || data.height < 120) return '–£–∫–∞–∂–∏—Ç–µ —Ä–æ—Å—Ç (–º–∏–Ω. 120 —Å–º)';
      if (!data.weightGoal || data.weightGoal < 30) return '–£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å';
      return null;
    }
  });

  // ============================================================
  // –®–ê–ì 3: GOALS (—Ü–µ–ª—å: –¥–µ—Ñ–∏—Ü–∏—Ç/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç)
  // ============================================================

  function ProfileGoalsComponent({ data, onChange }) {
    const [showHints, setShowHints] = useState({});

    const deficitPctTarget = data.deficitPctTarget ?? 0;
    const selectedPreset = GOAL_PRESETS.find(p => p.value === deficitPctTarget) || GOAL_PRESETS[3];

    // –î–ª—è –∞–≤—Ç–æ-–Ω–æ—Ä–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
    const profile = lsGet('heys_profile', {}) || {};
    const gender = data.gender || profile.gender || '–ú—É–∂—Å–∫–æ–π';
    const birthDate = data.birthDate || profile.birthDate || '';
    const age = birthDate ? calcAgeFromBirthDate(birthDate) : profile.age || 30;

    const norms = calcNormsFromGoal(deficitPctTarget, gender, age);
    const isFemale = gender === '–ñ–µ–Ω—Å–∫–∏–π';

    const toggleHint = (key) => {
      setShowHints(prev => ({ ...prev, [key]: !prev[key] }));
    };

    return React.createElement('div', { className: 'flex flex-col gap-6 p-4' },
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('div', { className: 'text-center' },
        React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-2' }, '–ö–∞–∫–∞—è —É –≤–∞—Å —Ü–µ–ª—å?'),
        React.createElement('p', { className: 'text-sm text-gray-600' }, '–≠—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à —Ü–µ–ª–µ–≤–æ–π –∫–∞–ª–æ—Ä–∞–∂')
      ),

      // –ö–∞—Ä—Ç–æ—á–∫–∏ —Ü–µ–ª–µ–π
      React.createElement('div', { className: 'grid grid-cols-1 gap-3' },
        GOAL_PRESETS.map((preset, idx) =>
          React.createElement('div', {
            key: preset.value,
            style: { animation: `fadeIn 0.3s ease-out ${idx * 0.05}s both` }
          },
            React.createElement('button', {
              type: 'button',
              onClick: () => {
                onChange({ ...data, deficitPctTarget: preset.value });
                if (typeof navigator !== 'undefined' && navigator.vibrate) {
                  navigator.vibrate(10);
                }
              },
              className: `w-full p-4 rounded-xl border-2 text-left transition-all ${deficitPctTarget === preset.value
                ? 'border-emerald-500 bg-emerald-50 scale-105'
                : 'border-gray-300 bg-white hover:border-emerald-300'
                }`,
              style: deficitPctTarget === preset.value ? {
                boxShadow: '0 4px 12px rgba(16, 185, 129, 0.2)',
                animation: 'scaleIn 0.2s ease-out'
              } : {}
            },
              React.createElement('div', { className: 'flex items-center justify-between' },
                React.createElement('div', { className: 'flex items-center gap-3' },
                  React.createElement('span', { className: 'text-2xl' }, preset.emoji),
                  React.createElement('div', null,
                    React.createElement('div', { className: 'font-medium text-gray-800' }, preset.label),
                    React.createElement('div', { className: 'text-xs text-gray-500' },
                      `${preset.value > 0 ? '+' : ''}${preset.value}%`
                    )
                  )
                ),
                (preset.value === -20 || preset.value === 15) && React.createElement('div', { className: 'relative' },
                  React.createElement('button', {
                    type: 'button',
                    onClick: (e) => {
                      e.stopPropagation();
                      toggleHint(`goal_${preset.value}`);
                    },
                    className: 'w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs font-medium hover:bg-emerald-100 hover:text-emerald-600 transition-colors flex items-center justify-center'
                  }, '?'),
                  React.createElement(HintTooltip, {
                    show: showHints[`goal_${preset.value}`],
                    onClose: () => toggleHint(`goal_${preset.value}`),
                    position: 'left'
                  },
                    preset.value === -20
                      ? '–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–ª–æ–∂–Ω–µ–µ —É–¥–µ—Ä–∂–∞—Ç—å. –ë–µ–ª–æ–∫ 1.6-2.4 –≥/–∫–≥.'
                      : '–ü—Ä–æ—Ñ–∏—Ü–∏—Ç –¥–ª—è —Ä–æ—Å—Ç–∞ –º—ã—à—Ü. –ë–µ–ª–æ–∫ 1.6-2.2 –≥/–∫–≥ + —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.',
                    React.createElement('span', { className: 'text-[10px] text-gray-400 block mt-1' }, '–ò—Å—Ç–æ—á–Ω–∏–∫: ISSN Position Stand, 2017')
                  )
                )
              )
            )
          )
        )
      ),

      // –ê–≤—Ç–æ-–Ω–æ—Ä–º—ã –ë–ñ–£
      React.createElement('div', {
        className: 'bg-gradient-to-br from-emerald-50 to-blue-50 rounded-xl p-4 border border-emerald-200',
        style: { animation: 'fadeIn 0.4s ease-out 0.3s both' }
      },
        React.createElement('div', { className: 'text-center mb-3' },
          React.createElement('div', { className: 'text-sm font-medium text-gray-700 mb-1' }, 'üìä –í–∞—à–∏ –Ω–æ—Ä–º—ã'),
          React.createElement('div', { className: 'text-lg font-bold text-emerald-700' },
            `–ë ${norms.proteinPct}% / –£ ${norms.carbsPct}% / –ñ ${100 - norms.proteinPct - norms.carbsPct}%`
          )
        ),
        isFemale && deficitPctTarget <= -10 && React.createElement('div', {
          className: 'text-xs text-gray-600 text-center'
        }, '‚ÑπÔ∏è –ë–æ–ª—å—à–µ –∂–∏—Ä–æ–≤ –¥–ª—è –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞')
      )
    );
  }

  registerStep('profile-goals', {
    title: '–í–∞—à–∞ —Ü–µ–ª—å',
    hint: '–ü–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ',
    icon: 'üéØ',
    component: ProfileGoalsComponent,
    getInitialData: () => {
      const profile = lsGet('heys_profile', {}) || {};
      return {
        deficitPctTarget: profile.deficitPctTarget ?? 0
      };
    },
    validate: (data) => {
      if (data.deficitPctTarget === undefined || data.deficitPctTarget === null) {
        return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å';
      }
      return true;
    },
    getValidationMessage: (data) => {
      if (data.deficitPctTarget === undefined || data.deficitPctTarget === null) {
        return '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª—å';
      }
      return null;
    }
  });

  // ============================================================
  // –®–ê–ì 4: METABOLISM (–Ω–æ—Ä–º–∞ —Å–Ω–∞, –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞)
  // ============================================================

  function ProfileMetabolismComponent({ data, onChange }) {
    const [showSleepHint, setShowSleepHint] = useState(false);
    const [showInsulinHint, setShowInsulinHint] = useState(false);
    const [showInsulinPresetHints, setShowInsulinPresetHints] = useState({});

    const profile = lsGet('heys_profile', {}) || {};
    const gender = data.gender || profile.gender || '–ú—É–∂—Å–∫–æ–π';
    const birthDate = data.birthDate || profile.birthDate || '';
    const age = birthDate ? calcAgeFromBirthDate(birthDate) : profile.age || 30;

    const sleepNorm = calcSleepNorm(age, gender);
    const sleepHours = data.sleepHours ?? sleepNorm.hours;
    const insulinWaveHours = data.insulinWaveHours ?? getSmartInsulinDefault(age);

    const sleepValues = useMemo(() => {
      const arr = [];
      for (let i = 4; i <= 12; i += 0.5) {
        arr.push(i);
      }
      return arr;
    }, []);

    const toggleInsulinPresetHint = (value) => {
      setShowInsulinPresetHints(prev => ({ ...prev, [value]: !prev[value] }));
    };

    return React.createElement('div', { className: 'flex flex-col gap-6 p-4' },
      // –ù–æ—Ä–º–∞ —Å–Ω–∞
      React.createElement('div', { className: 'flex flex-col gap-2' },
        React.createElement('div', { className: 'flex items-center gap-2 relative' },
          React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, 'üí§ –ù–æ—Ä–º–∞ —Å–Ω–∞ (—á–∞—Å–æ–≤)'),
          React.createElement('button', {
            type: 'button',
            onClick: () => setShowSleepHint(!showSleepHint),
            className: 'w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs font-medium hover:bg-emerald-100 hover:text-emerald-600 transition-colors flex items-center justify-center'
          }, '?'),
          React.createElement(HintTooltip, {
            show: showSleepHint,
            onClose: () => setShowSleepHint(false)
          },
            `–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É: ${sleepNorm.explanation}.`,
            React.createElement('span', { className: 'text-[10px] text-gray-400 block mt-1' }, '–ò—Å—Ç–æ—á–Ω–∏–∫: National Sleep Foundation, 2015')
          )
        ),
        React.createElement('div', { className: 'bg-emerald-50 rounded-xl p-3 border border-emerald-200 mb-2' },
          React.createElement('div', { className: 'text-sm text-gray-700' },
            `üí° –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ: ${sleepNorm.hours}—á (${sleepNorm.range})`
          )
        ),
        React.createElement(WheelPicker, {
          values: sleepValues,
          value: sleepHours,
          onChange: (v) => onChange({ ...data, sleepHours: v }),
          label: '—á'
        })
      ),

      // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞
      React.createElement('div', { className: 'flex flex-col gap-2' },
        React.createElement('div', { className: 'flex items-center gap-2 relative' },
          React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, '‚è± –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞'),
          React.createElement('button', {
            type: 'button',
            onClick: () => setShowInsulinHint(!showInsulinHint),
            className: 'w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs font-medium hover:bg-emerald-100 hover:text-emerald-600 transition-colors flex items-center justify-center'
          }, '?'),
          React.createElement(HintTooltip, {
            show: showInsulinHint,
            onClose: () => setShowInsulinHint(false)
          },
            '–ü–µ—Ä–∏–æ–¥ –ø–æ—Å–ª–µ –µ–¥—ã, –∫–æ–≥–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é. –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –µ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è.',
            React.createElement('span', { className: 'text-[10px] text-gray-400 block mt-1' }, '–ò—Å—Ç–æ—á–Ω–∏–∫: Ludwig et al., JAMA 2018')
          )
        ),

        // –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
        React.createElement('div', { className: 'grid grid-cols-1 gap-3 mt-3' },
          INSULIN_PRESETS.map((preset, idx) => {
            const isSelected = Math.abs(insulinWaveHours - preset.value) < 0.1;
            const isDefault = Math.abs(getSmartInsulinDefault(age) - preset.value) < 0.1;

            return React.createElement('div', {
              key: preset.value,
              style: { animation: `fadeIn 0.3s ease-out ${idx * 0.05}s both` }
            },
              React.createElement('button', {
                type: 'button',
                onClick: () => {
                  onChange({ ...data, insulinWaveHours: preset.value });
                  if (typeof navigator !== 'undefined' && navigator.vibrate) {
                    navigator.vibrate(10);
                  }
                },
                className: `w-full p-4 rounded-xl border-2 text-left transition-all ${isSelected
                  ? 'border-emerald-500 bg-emerald-50'
                  : 'border-gray-300 bg-white hover:border-emerald-300'
                  }`
              },
                React.createElement('div', { className: 'flex items-center justify-between' },
                  React.createElement('div', null,
                    React.createElement('div', { className: 'font-medium text-gray-800' },
                      preset.label,
                      isDefault && ' ‚úì'
                    ),
                    React.createElement('div', { className: 'text-xs text-gray-500 mt-1' }, preset.desc)
                  ),
                  preset.value === 4.5 && React.createElement('div', { className: 'relative' },
                    React.createElement('button', {
                      type: 'button',
                      onClick: (e) => {
                        e.stopPropagation();
                        toggleInsulinPresetHint(preset.value);
                      },
                      className: 'w-5 h-5 rounded-full bg-gray-200 text-gray-600 text-xs font-medium hover:bg-emerald-100 hover:text-emerald-600 transition-colors flex items-center justify-center'
                    }, '?'),
                    React.createElement(HintTooltip, {
                      show: showInsulinPresetHints[preset.value],
                      onClose: () => toggleInsulinPresetHint(preset.value),
                      position: 'left'
                    },
                      '–ü—Ä–∏ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –≤–æ–ª–Ω–∞ –¥–ª–∏–Ω–Ω–µ–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤—Ä–∞—á–∞.',
                      React.createElement('span', { className: 'text-[10px] text-gray-400 block mt-1' }, '–ò—Å—Ç–æ—á–Ω–∏–∫: DeFronzo, 1979')
                    )
                  )
                )
              )
            );
          })
        )
      )
    );
  }

  registerStep('profile-metabolism', {
    title: '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º',
    hint: '–°–æ–Ω –∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞',
    icon: '‚ö°',
    component: ProfileMetabolismComponent,
    getInitialData: () => {
      const profile = lsGet('heys_profile', {}) || {};
      const age = profile.birthDate ? calcAgeFromBirthDate(profile.birthDate) : profile.age || 30;
      const sleepNorm = calcSleepNorm(age, profile.gender || '–ú—É–∂—Å–∫–æ–π');

      return {
        sleepHours: profile.sleepHours || sleepNorm.hours,
        insulinWaveHours: profile.insulinWaveHours || getSmartInsulinDefault(age)
      };
    },
    validate: (data) => {
      if (!data.insulinWaveHours) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞';
      return true;
    },
    getValidationMessage: (data) => {
      if (!data.insulinWaveHours) return '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞';
      return null;
    },
    save: (data, context, allStepsData) => {
      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ 4 —à–∞–≥–æ–≤
      const step1 = allStepsData['profile-personal'] || {};
      const step2 = allStepsData['profile-body'] || {};
      const step3 = allStepsData['profile-goals'] || {};
      const step4 = allStepsData['profile-metabolism'] || {};

      console.log('[ProfileSteps] Saving with allStepsData:', JSON.stringify(allStepsData, null, 2));
      console.log('[ProfileSteps] step2 (body):', step2);

      const profile = lsGet('heys_profile', {}) || {};

      // –í–µ—Å –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ü–µ–ª—ã–π) ‚Äî —ç—Ç–æ –±–∞–∑–æ–≤—ã–π –∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ç–µ–∫—É—â–∏–π
      const registrationWeight = step2.weight || profile.weight || 70;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      const updatedProfile = {
        ...profile,
        firstName: step1.firstName || profile.firstName || '',
        gender: step1.gender || profile.gender || '–ú—É–∂—Å–∫–æ–π',
        birthDate: step1.birthDate || profile.birthDate || '',
        age: step1.birthDate ? calcAgeFromBirthDate(step1.birthDate) : profile.age || 30,
        cycleTrackingEnabled: step1.cycleTrackingEnabled || false,
        // –ë–∞–∑–æ–≤—ã–π –≤–µ—Å (—Å—Ç–∞—Ä—Ç–æ–≤—ã–π, –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏) ‚Äî –ù–ï –º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ
        baseWeight: profile.baseWeight || registrationWeight,
        // –¢–µ–∫—É—â–∏–π –≤–µ—Å ‚Äî –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ = –±–∞–∑–æ–≤—ã–π, –ø–æ—Ç–æ–º –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–∑ —á–µ–∫-–∏–Ω–∞
        weight: profile.weight || registrationWeight,
        height: step2.height || profile.height || 175,
        // –¶–µ–ª–µ–≤–æ–π –≤–µ—Å (–∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
        weightGoal: step2.weightGoal || profile.weightGoal || registrationWeight,
        deficitPctTarget: step3.deficitPctTarget ?? profile.deficitPctTarget ?? 0,
        sleepHours: step4.sleepHours || profile.sleepHours || 8,
        insulinWaveHours: step4.insulinWaveHours || profile.insulinWaveHours || 3,
        profileCompleted: true
      };

      lsSet('heys_profile', updatedProfile);

      // üõ°Ô∏è –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
      localStorage.removeItem('heys_registration_in_progress');

      // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –ø—Ä–æ—Ñ–∏–ª—è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
      window.dispatchEvent(new CustomEvent('heys:profile-updated', {
        detail: { profile: updatedProfile, source: 'wizard' }
      }));

      // –ê–≤—Ç–æ—Ä–∞—Å—á—ë—Ç –Ω–æ—Ä–º –ë–ñ–£
      const norms = calcNormsFromGoal(
        updatedProfile.deficitPctTarget,
        updatedProfile.gender,
        updatedProfile.age
      );
      lsSet('heys_norms', { ...norms, updatedAt: Date.now() });

      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–µ—Å –≤ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è (weightMorning), —á—Ç–æ–±—ã check-in –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ
      const todayKey = new Date().toISOString().slice(0, 10);
      const dayData = lsGet(`heys_dayv2_${todayKey}`, {});
      if (!dayData.weightMorning && updatedProfile.weight) {
        dayData.weightMorning = updatedProfile.weight;
        dayData.updatedAt = Date.now();
        lsSet(`heys_dayv2_${todayKey}`, dayData);
        console.log('[ProfileSteps] Weight synced to day data:', updatedProfile.weight, 'kg for', todayKey);
      }

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Å —Å–ø–∏—Å–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á, –±–µ–∑ namespace!)
      let currentClientId = localStorage.getItem('heys_client_current');
      // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ JSON string
      if (currentClientId && currentClientId.startsWith('"')) {
        try { currentClientId = JSON.parse(currentClientId); } catch (e) { }
      }
      if (currentClientId && updatedProfile.firstName) {
        try {
          // heys_clients ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á, —á–∏—Ç–∞–µ–º/–ø–∏—à–µ–º –Ω–∞–ø—Ä—è–º—É—é
          const clientsRaw = localStorage.getItem('heys_clients');
          const clients = clientsRaw ? JSON.parse(clientsRaw) : [];
          const updatedClients = clients.map(c =>
            c.id === currentClientId ? { ...c, name: updatedProfile.firstName } : c
          );
          localStorage.setItem('heys_clients', JSON.stringify(updatedClients));
          console.log('[ProfileSteps] Client name synced:', updatedProfile.firstName, 'for clientId:', currentClientId);

          // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
          window.dispatchEvent(new CustomEvent('heys:clients-updated', {
            detail: { clients: updatedClients, source: 'profile-wizard' }
          }));

          // ‚ö†Ô∏è Cloud sync –æ—Ç–∫–ª—é—á–µ–Ω: REST API read-only (—Å–º. SECURITY_RUNBOOK.md P3)
          // –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ heys_clients
          // –î–ª—è cloud sync –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π RPC —Å session token (v2)
        } catch (e) {
          console.warn('[ProfileSteps] Failed to sync client name:', e);
        }
      }

      console.log('[ProfileSteps] Profile saved:', updatedProfile);
      console.log('[ProfileSteps] Norms calculated:', norms);
    }
  });

  // ============================================================
  // –®–ê–ì –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø (welcome) ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ —á–µ–∫-–∏–Ω–æ–º
  // ============================================================

  /**
   * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ stepData
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –Ω–∞ —à–∞–≥–µ welcome
   */
  function saveProfileFromStepData(allStepsData) {
    const step1 = allStepsData['profile-personal'] || {};
    const step2 = allStepsData['profile-body'] || {};
    const step3 = allStepsData['profile-goals'] || {};
    const step4 = allStepsData['profile-metabolism'] || {};

    console.log('[saveProfileFromStepData] Saving with data:', { step1, step2, step3, step4 });

    const profile = lsGet('heys_profile', {}) || {};

    // –í–µ—Å –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ü–µ–ª—ã–π) ‚Äî —ç—Ç–æ –±–∞–∑–æ–≤—ã–π –∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ç–µ–∫—É—â–∏–π
    const registrationWeight = step2.weight || profile.weight || 70;

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    const updatedProfile = {
      ...profile,
      firstName: step1.firstName || profile.firstName || '',
      gender: step1.gender || profile.gender || '–ú—É–∂—Å–∫–æ–π',
      birthDate: step1.birthDate || profile.birthDate || '',
      age: step1.birthDate ? calcAgeFromBirthDate(step1.birthDate) : profile.age || 30,
      cycleTrackingEnabled: step1.cycleTrackingEnabled || false,
      // –ë–∞–∑–æ–≤—ã–π –≤–µ—Å (—Å—Ç–∞—Ä—Ç–æ–≤—ã–π, –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏) ‚Äî –ù–ï –º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ
      baseWeight: profile.baseWeight || registrationWeight,
      // –¢–µ–∫—É—â–∏–π –≤–µ—Å ‚Äî –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ = –±–∞–∑–æ–≤—ã–π, –ø–æ—Ç–æ–º –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–∑ —á–µ–∫-–∏–Ω–∞
      weight: profile.weight || registrationWeight,
      height: step2.height || profile.height || 175,
      // –¶–µ–ª–µ–≤–æ–π –≤–µ—Å (–∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
      weightGoal: step2.weightGoal || profile.weightGoal || registrationWeight,
      deficitPctTarget: step3.deficitPctTarget ?? profile.deficitPctTarget ?? 0,
      sleepHours: step4.sleepHours || profile.sleepHours || 8,
      insulinWaveHours: step4.insulinWaveHours || profile.insulinWaveHours || 3,
      profileCompleted: true
    };

    lsSet('heys_profile', updatedProfile);

    // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –ø—Ä–æ—Ñ–∏–ª—è
    window.dispatchEvent(new CustomEvent('heys:profile-updated', {
      detail: { profile: updatedProfile, source: 'wizard-skip' }
    }));

    // –ê–≤—Ç–æ—Ä–∞—Å—á—ë—Ç –Ω–æ—Ä–º –ë–ñ–£
    const norms = calcNormsFromGoal(
      updatedProfile.deficitPctTarget,
      updatedProfile.gender,
      updatedProfile.age
    );
    lsSet('heys_norms', { ...norms, updatedAt: Date.now() });

    // ‚ö†Ô∏è v1.15 FIX: –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à HEYS.store.memory
    // —Ç.–∫. lsSet –ø–∏—à–µ—Ç –≤ localStorage –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ tryStartOnboardingTour —á–∏—Ç–∞–µ—Ç –∏–∑ HEYS.store (–∫–æ—Ç–æ—Ä—ã–π –∫—ç—à–∏—Ä—É–µ—Ç)
    if (HEYS.store && typeof HEYS.store.invalidate === 'function') {
      HEYS.store.invalidate('heys_profile');
      HEYS.store.invalidate('heys_norms');
      console.log('[saveProfileFromStepData] üîÑ Cache invalidated for heys_profile & heys_norms');
    }

    // –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–µ—Å –≤ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ!
    // –ß–µ–∫-–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–ø—Ä–æ—Å–∏—Ç—å –≤–µ—Å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
    // (–≤–µ—Å –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å –º–æ–º–µ–Ω—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Å —Å–ø–∏—Å–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
    let currentClientId = localStorage.getItem('heys_client_current');
    if (currentClientId && currentClientId.startsWith('"')) {
      try { currentClientId = JSON.parse(currentClientId); } catch (e) { }
    }
    if (currentClientId && updatedProfile.firstName) {
      try {
        const clientsRaw = localStorage.getItem('heys_clients');
        const clients = clientsRaw ? JSON.parse(clientsRaw) : [];
        const updatedClients = clients.map(c =>
          c.id === currentClientId ? { ...c, name: updatedProfile.firstName } : c
        );
        localStorage.setItem('heys_clients', JSON.stringify(updatedClients));

        window.dispatchEvent(new CustomEvent('heys:clients-updated', {
          detail: { clients: updatedClients, source: 'wizard-skip' }
        }));
      } catch (e) {
        console.warn('[saveProfileFromStepData] Failed to sync client name:', e);
      }
    }

    console.log('[saveProfileFromStepData] Profile saved:', updatedProfile);
    console.log('[saveProfileFromStepData] Norms calculated:', norms);
  }

  /**
   * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–µ—Å –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–∞—á–∞—Ç—å —á–µ–∫-–∏–Ω" –Ω–∞ —à–∞–≥–µ welcome
   * —á—Ç–æ–±—ã —á–µ–∫-–∏–Ω –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–ª –≤–µ—Å –ø–æ–≤—Ç–æ—Ä–Ω–æ
   */
  function syncWeightToDay(allStepsData) {
    const step2 = allStepsData['profile-body'] || {};
    const weight = step2.weight;

    if (!weight) {
      console.log('[syncWeightToDay] No weight in stepData, skipping');
      return;
    }

    const todayKey = new Date().toISOString().slice(0, 10);
    const dayData = lsGet(`heys_dayv2_${todayKey}`, {});

    if (!dayData.weightMorning) {
      dayData.weightMorning = weight;
      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${todayKey}`, dayData);
      console.log('[syncWeightToDay] Weight synced to day:', weight, 'kg for', todayKey);
    } else {
      console.log('[syncWeightToDay] Day already has weight:', dayData.weightMorning);
    }
  }

  function WelcomeStepComponent({ stepData, context }) {
    // üîß v2.0.0: –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ stepData –Ω–∞–ø—Ä—è–º—É—é, —Ç.–∫. localStorage –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
    const step1 = stepData['profile-personal'] || {};
    const step2 = stepData['profile-body'] || {};
    const step3 = stepData['profile-goals'] || {};
    const step4 = stepData['profile-metabolism'] || {};

    // –§—É–Ω–∫—Ü–∏–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const onNext = context?.onNext;
    const onClose = context?.onClose;

    // –ò–º—è –∏–∑ stepData
    const firstName = step1.firstName || '';

    // –î–∞–Ω–Ω—ã–µ —Ç–µ–ª–∞ –∏–∑ stepData
    const weight = Number(step2.weight) || 70;
    const height = Number(step2.height) || 170;
    const weightGoal = Number(step2.weightGoal) || weight;
    const weightDiff = weightGoal - weight;
    const diffSign = weightDiff > 0 ? '+' : '';

    // –î–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏ –∏–∑ stepData
    const deficitPctTarget = Number(step3.deficitPctTarget) || 0;
    const gender = step1.gender || '–ú—É–∂—Å–∫–æ–π';

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
    // üîß v2.0.1: –°–æ–±–∏—Ä–∞–µ–º birthDate –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (birthYear, birthMonth, birthDay)
    // —Ç.–∫. –≤ stepData –æ–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, –∞ birthDate —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ save()
    let age = 30; // default
    if (step1.birthYear && step1.birthMonth && step1.birthDay) {
      const birthDate = `${step1.birthYear}-${String(step1.birthMonth).padStart(2, '0')}-${String(step1.birthDay).padStart(2, '0')}`;
      const today = new Date();
      const birth = new Date(birthDate);
      age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
    }

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ—Ä–º—ã –ë–ñ–£ –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ –∏–∑ localStorage!)
    const calculatedNorms = calcNormsFromGoal(deficitPctTarget, gender, age);

    // –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞
    const weeks = calcTimeToGoal(weight, weightGoal, deficitPctTarget);

    // –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ë–ñ–£ –∏–∑ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –Ω–æ—Ä–º
    const protPct = calculatedNorms.proteinPct || 25;
    const carbsPct = calculatedNorms.carbsPct || 50;
    const fatPct = 100 - protPct - carbsPct;

    return React.createElement('div', {
      className: 'welcome-step-content',
      style: {
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        padding: '20px',
        textAlign: 'center'
      }
    },
      // –≠–º–æ–¥–∑–∏
      React.createElement('div', {
        style: { fontSize: '72px', marginBottom: '16px' }
      }, 'üéâ'),

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('h2', {
        style: {
          fontSize: '24px',
          fontWeight: 'bold',
          color: 'var(--text, #1f2937)',
          marginBottom: '8px'
        }
      }, firstName ? `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${firstName}!` : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!'),

      // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('p', {
        style: {
          fontSize: '16px',
          color: '#6b7280',
          marginBottom: '24px'
        }
      }, '–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≥–æ—Ç–æ–≤'),

      // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
      React.createElement('div', {
        style: {
          background: '#ecfdf5',
          borderRadius: '16px',
          padding: '20px',
          width: '100%',
          maxWidth: '320px',
          marginBottom: '24px'
        }
      },
        // –¶–µ–ª—å
        React.createElement('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '12px'
          }
        },
          React.createElement('span', { style: { color: 'var(--text, #374151)' } }, 'üéØ –¶–µ–ª—å:'),
          React.createElement('span', {
            style: { fontWeight: '500', color: '#059669' }
          }, `${weightGoal} –∫–≥ (${diffSign}${Math.abs(weightDiff).toFixed(1)} –∫–≥)`)
        ),

        // –ë–ñ–£
        React.createElement('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '12px'
          }
        },
          React.createElement('span', { style: { color: 'var(--text, #374151)' } }, 'üìä –ë–ñ–£:'),
          React.createElement('span', {
            style: { fontWeight: '500', color: '#059669' }
          }, `–ë${protPct}% –£${carbsPct}% –ñ${fatPct}%`)
        ),

        // –ü—Ä–æ–≥–Ω–æ–∑
        React.createElement('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }
        },
          React.createElement('span', { style: { color: 'var(--text, #374151)' } }, '‚è± –ü—Ä–æ–≥–Ω–æ–∑:'),
          React.createElement('span', {
            style: { fontWeight: '500', color: '#059669' }
          }, weeks)
        )
      ),

      // –°–Ω–æ—Å–∫–∞
      React.createElement('p', {
        style: {
          fontSize: '14px',
          color: '#9ca3af',
          marginBottom: '24px'
        }
      }, '–ù–æ—Ä–º—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –ø–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º. –ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ü—Ä–æ—Ñ–∏–ª–µ.'),

      // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å —á–µ–∫-–∏–Ω"
      React.createElement('button', {
        style: {
          width: '100%',
          maxWidth: '320px',
          padding: '14px 24px',
          background: '#10b981',
          color: 'white',
          border: 'none',
          borderRadius: '12px',
          fontSize: '16px',
          fontWeight: '600',
          cursor: 'pointer',
          marginBottom: '12px'
        },
        onClick: () => {
          // –í–µ—Å –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ (–±–∞–∑–æ–≤—ã–π)
          // –ß–µ–∫-–∏–Ω —Å–ø—Ä–æ—Å–∏—Ç —É—Ç—Ä–µ–Ω–Ω–∏–π –≤–µ—Å —Å –¥–µ—Å—è—Ç—ã–º–∏ –¥–æ–ª—è–º–∏
          console.log('[WelcomeStep] Starting checkin (weight will be asked)');
          onNext && onNext();
        }
      }, '‚òÄÔ∏è –ù–∞—á–∞—Ç—å —É—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω'),

      // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
      React.createElement('button', {
        style: {
          width: '100%',
          maxWidth: '320px',
          padding: '12px 24px',
          background: 'transparent',
          color: '#6b7280',
          border: 'none',
          borderRadius: '12px',
          fontSize: '14px',
          cursor: 'pointer'
        },
        onClick: () => {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ stepData (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–∞)
          saveProfileFromStepData(stepData);
          console.log('[WelcomeStep] Profile saved (skipped checkin)');

          // üõ°Ô∏è –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
          localStorage.removeItem('heys_registration_in_progress');
          console.log('[WelcomeStep] ‚úÖ Cleared heys_registration_in_progress flag');

          // üÜï v1.9.1: –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —á–µ–∫-–∏–Ω –ø—Ä–æ–ø—É—â–µ–Ω ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
          sessionStorage.setItem('heys_morning_checkin_done', 'true');
          console.log('[WelcomeStep] ‚úÖ Set heys_morning_checkin_done = true (skip flag)');

          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —á–µ—Ä–µ–∑ onClose –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
          if (onClose) {
            onClose();
          } else if (window.HEYS?.StepModal?.hide) {
            window.HEYS.StepModal.hide();
          }

          // üÜï v1.9: –ó–∞–ø—É—Å–∫–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —Ç—É—Ä –ø–æ—Å–ª–µ –ø—Ä–æ–ø—É—Å–∫–∞ —á–µ–∫–∏–Ω–∞
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –º–æ–¥–∞–ª–∫–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å
          setTimeout(() => {
            console.log('[WelcomeStep] üéì Triggering onboarding tour after skip checkin');
            if (window.HEYS?._tour?.tryStart) {
              window.HEYS._tour.tryStart();
            } else {
              // Fallback —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ
              window.dispatchEvent(new CustomEvent('heys:checkin-complete', {
                detail: { type: 'skipped', source: 'welcome-step' }
              }));
            }
          }, 300);
        }
      }, '–ü–æ–∫–∞ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º')
    );
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —à–∞–≥ welcome (—Å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ StepModal –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø–æ–∑–∂–µ)
  function registerWelcomeStep() {
    if (HEYS.StepModal && HEYS.StepModal.registerStep) {
      HEYS.StepModal.registerStep('welcome', {
        title: '–ì–æ—Ç–æ–≤–æ!',
        hint: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
        icon: 'üéâ',
        component: WelcomeStepComponent,
        canSkip: false,
        hideHeaderNext: true,  // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ö–µ–¥–µ—Ä–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
        getInitialData: () => ({}),
        validate: () => true,
        save: () => { } // –ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —ç—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —à–∞–≥
      });
      return true;
    }
    return false;
  }

  // –ü–æ–ø—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ‚Äî —á–µ—Ä–µ–∑ 100–º—Å
  if (!registerWelcomeStep()) {
    setTimeout(registerWelcomeStep, 100);
  }

  // ============================================================
  // –≠–ö–†–ê–ù –ü–û–ó–î–†–ê–í–õ–ï–ù–ò–Ø (W4) ‚Äî legacy, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–≥ welcome
  // ============================================================

  function showCongratulationsModal() {
    const profile = lsGet('heys_profile', {}) || {};
    const norms = lsGet('heys_norms', {});

    const firstName = profile.firstName || '';
    const weight = Number(profile.weight) || 70;
    const weightGoal = Number(profile.weightGoal) || weight;
    const weightDiff = weightGoal - weight;
    const diffSign = weightDiff > 0 ? '+' : '';
    const weeks = calcTimeToGoal(profile.weight, profile.weightGoal, profile.deficitPctTarget);

    // –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–∞–ª–∫–∞ —Å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ–º
    const modalHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
           style="animation: fadeIn 0.3s ease-out">
        <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl"
             style="animation: scaleIn 0.4s ease-out 0.1s both">
          <div class="text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${firstName}!</h2>
            <p class="text-gray-600 mb-6">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≥–æ—Ç–æ–≤</p>
            
            <div class="bg-emerald-50 rounded-xl p-4 mb-6 text-left space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-gray-700">üéØ –¶–µ–ª—å:</span>
                <span class="font-medium text-emerald-700">${profile.weightGoal} –∫–≥ (${diffSign}${Math.abs(weightDiff).toFixed(1)} –∫–≥)</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-700">üìä –ë–ñ–£:</span>
                <span class="font-medium text-emerald-700">–ë${norms.proteinPct}% –£${norms.carbsPct}% –ñ${100 - norms.proteinPct - norms.carbsPct}%</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-700">‚è± –ü—Ä–æ–≥–Ω–æ–∑:</span>
                <span class="font-medium text-emerald-700">${weeks}</span>
              </div>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">
              –ù–æ—Ä–º—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –ø–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º. –ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ü—Ä–æ—Ñ–∏–ª–µ.
            </p>
            
            <button id="congrats-close-btn" 
                    class="w-full bg-emerald-500 text-white py-3 rounded-xl font-medium hover:bg-emerald-600 transition-colors">
              –ù–∞—á–∞—Ç—å! ‚Üí
            </button>
          </div>
        </div>
      </div>
    `;

    const container = document.createElement('div');
    container.innerHTML = modalHTML;
    document.body.appendChild(container);

    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    const closeBtn = container.querySelector('#congrats-close-btn');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        container.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => {
          container.remove();
        }, 200);
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    const backdrop = container.querySelector('.fixed');
    if (backdrop) {
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          closeBtn.click();
        }
      });
    }
  }

  // ============================================================
  // –≠–ö–°–ü–û–†–¢
  // ============================================================

  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å profile-—à–∞–≥–∏
  function isProfileIncomplete(profile) {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç null/undefined
    if (!profile) {
      return true;
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–ª–∞–≥ profileCompleted ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ (–Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
    if (profile.profileCompleted === true) {
      localStorage.removeItem('heys_registration_in_progress');
      return false;
    }

    // üß≠ –ú–∏–≥—Ä–∞—Ü–∏—è legacy –ø—Ä–æ—Ñ–∏–ª—è (–±–µ–∑ clientId) ‚Üí scoped –∫–ª—é—á
    try {
      const currentClientId = (window.HEYS?.currentClientId || '').toString();
      const scopedKey = currentClientId ? `heys_${currentClientId}_profile` : null;
      const rawScoped = scopedKey ? localStorage.getItem(scopedKey) : null;
      const rawLegacy = localStorage.getItem('heys_profile');

      if (currentClientId && scopedKey && !rawScoped && rawLegacy) {
        const legacyProfile = JSON.parse(rawLegacy);
        const hasLegacyData = legacyProfile && (
          legacyProfile.profileCompleted === true ||
          legacyProfile.firstName ||
          legacyProfile.birthDate ||
          legacyProfile.weight ||
          legacyProfile.height ||
          legacyProfile.age
        );

        if (hasLegacyData) {
          if (window.HEYS?.store?.set) {
            window.HEYS.store.set('heys_profile', legacyProfile);
          } else {
            localStorage.setItem(scopedKey, JSON.stringify(legacyProfile));
          }
          localStorage.removeItem('heys_registration_in_progress');
          return false;
        }
      }
    } catch (_) { }

    // üõ°Ô∏è –ï—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±—ã–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    const registrationInProgress = localStorage.getItem('heys_registration_in_progress') === 'true';
    if (registrationInProgress) {
      try {
        const currentClientId = (window.HEYS?.currentClientId || '').toString();
        const scopedKey = currentClientId ? `heys_${currentClientId}_profile` : null;
        let rawScoped = scopedKey ? localStorage.getItem(scopedKey) : null;

        if (rawScoped === 'null' || rawScoped === 'undefined') {
          try {
            localStorage.removeItem(scopedKey);
          } catch (_) { }
          rawScoped = null;
        }

        // üîß FIX: –ï—Å–ª–∏ scoped –ø—Ä–æ—Ñ–∏–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        if (rawScoped) {
          let scopedProfile;
          try {
            scopedProfile = JSON.parse(rawScoped);
          } catch (e) {
            // JSON parse error ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å null
          }
          const hasRealData = scopedProfile && (
            scopedProfile.profileCompleted === true ||
            scopedProfile.firstName ||
            scopedProfile.birthDate ||
            (scopedProfile.weight && scopedProfile.weight !== 70) ||
            (scopedProfile.height && scopedProfile.height !== 175) ||
            (scopedProfile.age && scopedProfile.age !== 30)
          );
          if (hasRealData) {
            localStorage.removeItem('heys_registration_in_progress');
            return false;
          }
        }
      } catch (_) { }
      return true;
    }

    // Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    // –ü—Ä–æ—Ñ–∏–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–ø–æ–ª–Ω—ã–º, –µ—Å–ª–∏ –í–°–ï –ø–æ–ª—è –∏–º–µ—é—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const isDefaultGender = !profile.gender || profile.gender === '–ú—É–∂—Å–∫–æ–π';
    const isDefaultWeight = !profile.weight || profile.weight === 70;
    const isDefaultHeight = !profile.height || profile.height === 175;
    const noBirthDate = !profile.birthDate;
    const isDefaultAge = !profile.age || profile.age === 30;

    // –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–ø–æ–ª–Ω—ã–π, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –í–°–ï –ø–æ–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ò –Ω–µ—Ç –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
    const isIncomplete = isDefaultGender && isDefaultWeight && isDefaultHeight && noBirthDate && isDefaultAge;
    if (!isIncomplete) {
      localStorage.removeItem('heys_registration_in_progress');
    }
    return isIncomplete;
  }

  HEYS.ProfileSteps = {
    isProfileIncomplete,
    calcNormsFromGoal,
    calcAgeFromBirthDate,
    calcSleepNorm,
    showCongratulationsModal
  };

})(window);


/* ===== heys_meal_step_v1.js ===== */
// heys_meal_step_v1.js ‚Äî –®–∞–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ —á–µ—Ä–µ–∑ StepModal
// –î–≤—É—Ö—à–∞–≥–æ–≤—ã–π flow: –≤—Ä–µ–º—è+—Ç–∏–ø ‚Üí –æ—Ü–µ–Ω–∫–∏+–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const { useState, useMemo, useCallback, useEffect, useRef } = React;

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ StepModal
  if (!HEYS.StepModal) {
    console.warn('[HEYS] MealStep: StepModal not loaded yet');
  }

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –∏–∑ StepModal
  const { lsGet, lsSet } = HEYS.StepModal?.utils || {};

  const readStoredValue = (key, fallback = null) => {
    let value;
    if (HEYS.store?.get) {
      value = HEYS.store.get(key, fallback);
    } else if (lsGet) {
      value = lsGet(key, fallback);
    } else if (HEYS.utils?.lsGet) {
      value = HEYS.utils.lsGet(key, fallback);
    } else {
      try {
        value = localStorage.getItem(key);
      } catch { return fallback; }
    }

    if (value == null) return fallback;

    if (typeof value === 'string') {
      if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try {
          value = HEYS.store.decompress(value.slice(3));
        } catch { }
      }
      try {
        return JSON.parse(value);
      } catch {
        return value;
      }
    }

    return value;
  };

  // Fallback –µ—Å–ª–∏ StepModal –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  const safeLsGet = (key, def) => readStoredValue(key, def);

  const safeLsSet = (key, val) => {
    if (HEYS.store?.set) return HEYS.store.set(key, val);
    if (lsSet) return lsSet(key, val);
    if (HEYS.utils?.lsSet) return HEYS.utils.lsSet(key, val);
    localStorage.setItem(key, JSON.stringify(val));
  };

  // Haptic feedback
  const haptic = (intensity = 10) => {
    if (navigator.vibrate) navigator.vibrate(intensity);
  };

  // Unique ID generator
  const uid = (prefix = '') => prefix + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

  // Pad number to 2 digits
  const pad2 = (n) => String(n).padStart(2, '0');

  // ============================================================
  // –•–ï–õ–ü–ï–†–´ –í–†–ï–ú–ï–ù–ò
  // ============================================================

  /**
   * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
   * –ù–æ—á–Ω—ã–µ —á–∞—Å—ã (00-02) —Å—á–∏—Ç–∞—é—Ç—Å—è –∫–∞–∫ "–ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏" (24-26)
   */
  function timeToMinutes(timeStr) {
    if (!timeStr) return null;
    const [h, m] = timeStr.split(':').map(Number);
    if (isNaN(h) || isNaN(m)) return null;
    const hours = h < 3 ? h + 24 : h;
    return hours * 60 + m;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –ø–æ —á–∞—Å—É
   */
  function getMealTypeByHour(hour) {
    const h = hour >= 24 ? hour - 24 : hour;
    if (h >= 6 && h < 10) return 'breakfast';
    if (h >= 10 && h < 12) return 'snack1';
    if (h >= 12 && h < 15) return 'lunch';
    if (h >= 15 && h < 18) return 'snack2';
    if (h >= 18 && h < 21) return 'dinner';
    if (h >= 21 || h < 3) return 'night';
    return 'snack3';
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —á–∞—Å—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (–Ω–æ—á–Ω—ã–µ 00-02 ‚Üí 24-26)
   */
  function normalizeHoursForStorage(hours, nightThreshold = 3) {
    return hours < nightThreshold ? hours + 24 : hours;
  }

  /**
   * –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —á–∞—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (24-26 ‚Üí 00-02)
   */
  function normalizeHoursForDisplay(hours) {
    return hours >= 24 ? hours - 24 : hours;
  }

  // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===

  // –¢–∏–ø—ã –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
  const MEAL_TYPES = HEYS.dayUtils?.MEAL_TYPES || {
    breakfast: { name: '–ó–∞–≤—Ç—Ä–∞–∫', icon: 'üç≥', order: 1 },
    snack1: { name: '–ü–µ—Ä–µ–∫—É—Å', icon: 'üçé', order: 2 },
    lunch: { name: '–û–±–µ–¥', icon: 'üç≤', order: 3 },
    snack2: { name: '–ü–µ—Ä–µ–∫—É—Å', icon: 'ü•ú', order: 4 },
    dinner: { name: '–£–∂–∏–Ω', icon: 'üçΩÔ∏è', order: 5 },
    snack3: { name: '–ü–µ—Ä–µ–∫—É—Å', icon: 'üßÄ', order: 6 },
    night: { name: '–ù–æ—á–Ω–æ–π –ø—Ä–∏—ë–º', icon: 'üåô', order: 7 }
  };

  // Emoji –¥–ª—è –æ—Ü–µ–Ω–æ–∫
  const MOOD_EMOJI = ['üò¢', 'üò¢', 'üòï', 'üòï', 'üòê', 'üòê', 'üôÇ', 'üôÇ', 'üòä', 'üòä', 'üòÑ'];
  const WELLBEING_EMOJI = ['ü§í', 'ü§í', 'üòì', 'üòì', 'üòê', 'üòê', 'üôÇ', 'üôÇ', 'üí™', 'üí™', 'üèÜ'];
  const STRESS_EMOJI = ['üòå', 'üòå', 'üôÇ', 'üôÇ', 'üòê', 'üòê', 'üòü', 'üòü', 'üò∞', 'üò∞', 'üò±'];

  // –ü—Ä–µ—Å–µ—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –æ—Ü–µ–Ω–æ–∫
  const PRESETS_POSITIVE = [
    { emoji: 'üëé', value: 2, label: '–ü–ª–æ—Ö–æ' },
    { emoji: 'üëå', value: 5, label: '–ù–æ—Ä–º' },
    { emoji: 'üëç', value: 8, label: '–•–æ—Ä–æ—à–æ' }
  ];
  const PRESETS_NEGATIVE = [
    { emoji: 'üòå', value: 2, label: '–°–ø–æ–∫–æ–µ–Ω' },
    { emoji: 'üòê', value: 5, label: '–°—Ä–µ–¥–Ω–µ' },
    { emoji: 'üò∞', value: 8, label: '–°—Ç—Ä–µ—Å—Å' }
  ];

  // ============================================================
  // –•–ï–õ–ü–ï–†–´ –î–õ–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø
  // ============================================================

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—â–µ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ –æ—Ü–µ–Ω–∫–∞–º
   */
  function getMoodState(mood, wellbeing, stress) {
    const positiveSignals = (mood >= 7 ? 1 : 0) + (wellbeing >= 7 ? 1 : 0) + (stress > 0 && stress <= 3 ? 1 : 0);
    const negativeSignals = (mood > 0 && mood <= 3 ? 1 : 0) + (wellbeing > 0 && wellbeing <= 3 ? 1 : 0) + (stress >= 7 ? 1 : 0);

    if (negativeSignals >= 2) return 'negative';
    if (negativeSignals === 1 && positiveSignals === 0) return 'negative';
    if (positiveSignals >= 2) return 'positive';
    if (positiveSignals === 1 && negativeSignals === 0) return 'positive';
    return 'neutral';
  }

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
   */
  function getJournalText(moodState, mood, wellbeing, stress) {
    if (moodState === 'negative') {
      if (stress >= 8 && mood <= 3 && wellbeing <= 3) return 'üò∞ –¢—è–∂—ë–ª—ã–π –º–æ–º–µ–Ω—Ç ‚Äî —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?';
      if (stress >= 8 && mood <= 3) return '–°—Ç—Ä–µ—Å—Å + –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏';
      if (stress >= 8 && wellbeing <= 3) return '–°—Ç—Ä–µ—Å—Å + –ø–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ ‚Äî —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?';
      if (mood <= 3 && wellbeing <= 3) return '–ò –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ... —á—Ç–æ –Ω–µ —Ç–∞–∫?';
      if (stress >= 7) return '–ß—Ç–æ —Å—Ç—Ä–µ—Å—Å—É–µ—Ç?';
      if (wellbeing <= 3) return '–ü–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ ‚Äî —á—Ç–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç?';
      if (mood <= 3) return '–ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî —á—Ç–æ —Ä–∞—Å—Å—Ç—Ä–æ–∏–ª–æ?';
      return '–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?';
    }
    if (moodState === 'positive') {
      if (mood >= 9 && wellbeing >= 9 && stress <= 2) return 'üåü –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ! –í —á—ë–º —Å–µ–∫—Ä–µ—Ç?';
      if (mood >= 8 && wellbeing >= 8) return '‚ú® –û—Ç–ª–∏—á–Ω–æ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å! –ß—Ç–æ –ø–æ–º–æ–≥–ª–æ?';
      if (mood >= 8 && stress <= 2) return '–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ!';
      if (wellbeing >= 8 && stress <= 2) return '–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ! –ß—Ç–æ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç?';
      if (mood >= 7) return '–•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! –ß—Ç–æ –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ?';
      if (wellbeing >= 7) return '–•–æ—Ä–æ—à–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ! –ó–∞–ø–∏—à–∏ –ø—Ä–∏—á–∏–Ω—É';
      if (stress <= 2) return '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ ‚Äî —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è?';
      return '–ó–∞–ø–∏—à–∏ —á—Ç–æ –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ!';
    }
    if (mood >= 5 && mood <= 6 && wellbeing >= 5 && wellbeing <= 6) return '–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–µ–Ω—å ‚Äî –ª—é–±—ã–µ –º—ã—Å–ª–∏?';
    if (stress >= 4 && stress <= 6) return '–ù–µ–º–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è ‚Äî —Ö–æ—á–µ—à—å –∑–∞–ø–∏—Å–∞—Ç—å?';
    return '–ó–∞–º–µ—Ç–∫–∞ –æ –ø—Ä–∏—ë–º–µ –ø–∏—â–∏';
  }

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç placeholder –¥–ª—è input –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
   */
  function getPlaceholder(moodState, mood, wellbeing, stress) {
    if (moodState === 'negative') {
      if (stress >= 7) return '–†–∞–±–æ—Ç–∞, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –∑–¥–æ—Ä–æ–≤—å–µ...';
      if (wellbeing <= 3) return '–°–∏–º–ø—Ç–æ–º—ã, —É—Å—Ç–∞–ª–æ—Å—Ç—å, –±–æ–ª—å...';
      if (mood <= 3) return '–ß—Ç–æ —Ä–∞—Å—Å—Ç—Ä–æ–∏–ª–æ –∏–ª–∏ —Ä–∞–∑–æ–∑–ª–∏–ª–æ...';
      return '–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ –Ω–µ —Ç–∞–∫...';
    }
    if (moodState === 'positive') {
      if (mood >= 8 && wellbeing >= 8) return '–ß—Ç–æ —Å–¥–µ–ª–∞–ª–æ –¥–µ–Ω—å –æ—Ç–ª–∏—á–Ω—ã–º?';
      if (stress <= 2) return '–ú–µ–¥–∏—Ç–∞—Ü–∏—è, –ø—Ä–æ–≥—É–ª–∫–∞, –æ—Ç–¥—ã—Ö...';
      return '–ß—Ç–æ —Å–¥–µ–ª–∞–ª–æ –º–æ–º–µ–Ω—Ç —Ö–æ—Ä–æ—à–∏–º?';
    }
    return '–õ—é–±—ã–µ –º—ã—Å–ª–∏ –æ –µ–¥–µ –∏–ª–∏ –¥–Ω–µ...';
  }

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç quick chips –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
   */
  function getQuickChips(moodState, mood, wellbeing, stress) {
    if (moodState === 'negative') {
      if (stress >= 7) return ['–†–∞–±–æ—Ç–∞', '–î–µ–¥–ª–∞–π–Ω', '–ö–æ–Ω—Ñ–ª–∏–∫—Ç', '–£—Å—Ç–∞–ª–æ—Å—Ç—å'];
      if (wellbeing <= 3) return ['–ì–æ–ª–æ–≤–∞', '–ñ–∏–≤–æ—Ç', '–°–ª–∞–±–æ—Å—Ç—å', '–ù–µ–¥–æ—Å—ã–ø'];
      if (mood <= 3) return ['–¢—Ä–µ–≤–æ–≥–∞', '–ì—Ä—É—Å—Ç—å', '–ó–ª–æ—Å—Ç—å', '–ê–ø–∞—Ç–∏—è'];
      return ['–£—Å—Ç–∞–ª', '–°—Ç—Ä–µ—Å—Å', '–ü–ª–æ—Ö–æ —Å–ø–∞–ª'];
    }
    if (moodState === 'positive') {
      if (mood >= 8) return ['–†–∞–¥–æ—Å—Ç—å', '–£—Å–ø–µ—Ö', '–í—Å—Ç—Ä–µ—á–∞', '–ü—Ä–∏—Ä–æ–¥–∞'];
      if (stress <= 2) return ['–û—Ç–¥—ã—Ö', '–ú–µ–¥–∏—Ç–∞—Ü–∏—è', '–ü—Ä–æ–≥—É–ª–∫–∞', '–°–ø–æ—Ä—Ç'];
      return ['–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å', '–≠–Ω–µ—Ä–≥–∏—è', '–ú–æ—Ç–∏–≤–∞—Ü–∏—è'];
    }
    return [];
  }

  // ============================================================
  // –•–ï–õ–ü–ï–†–´ –¶–í–ï–¢–û–í –ò –¢–ï–ö–°–¢–û–í
  // ============================================================

  // –¶–≤–µ—Ç–∞ –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —à–∫–∞–ª (mood, wellbeing)
  const getPositiveColor = (v) => {
    if (v <= 3) return '#ef4444';
    if (v <= 5) return '#3b82f6';
    if (v <= 7) return '#22c55e';
    return '#10b981';
  };

  // –¶–≤–µ—Ç–∞ –¥–ª—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —à–∫–∞–ª (stress)
  const getNegativeColor = (v) => {
    if (v <= 3) return '#10b981';
    if (v <= 5) return '#3b82f6';
    if (v <= 7) return '#eab308';
    return '#ef4444';
  };

  // –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è —à–∫–∞–ª–∞)
  const getCardBg = (v) => {
    if (v <= 2) return 'rgba(239, 68, 68, 0.08)';
    if (v <= 4) return 'rgba(245, 158, 11, 0.08)';
    if (v <= 6) return 'rgba(59, 130, 246, 0.06)';
    if (v <= 8) return 'rgba(34, 197, 94, 0.08)';
    return 'rgba(16, 185, 129, 0.12)';
  };

  // –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è —Å—Ç—Ä–µ—Å—Å–∞ (–∏–Ω–≤–µ—Ä—Å–Ω–∞—è —à–∫–∞–ª–∞)
  const getStressCardBg = (v) => {
    if (v <= 2) return 'rgba(16, 185, 129, 0.12)';
    if (v <= 4) return 'rgba(34, 197, 94, 0.08)';
    if (v <= 6) return 'rgba(59, 130, 246, 0.06)';
    if (v <= 8) return 'rgba(245, 158, 11, 0.08)';
    return 'rgba(239, 68, 68, 0.08)';
  };

  // –¢–µ–∫—Å—Ç –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π –æ—Ü–µ–Ω–æ–∫
  const getMoodText = (v) => v <= 2 ? '–ü–ª–æ—Ö–æ' : v <= 4 ? '–¢–∞–∫ —Å–µ–±–µ' : v <= 6 ? '–ù–æ—Ä–º' : v <= 8 ? '–•–æ—Ä–æ—à–æ' : '–û—Ç–ª–∏—á–Ω–æ';
  const getWellbeingText = (v) => v <= 2 ? '–ü–ª–æ—Ö–æ' : v <= 4 ? '–°–ª–∞–±–æ—Å—Ç—å' : v <= 6 ? '–ù–æ—Ä–º' : v <= 8 ? '–•–æ—Ä–æ—à–æ' : '–û—Ç–ª–∏—á–Ω–æ';
  const getStressText = (v) => v <= 2 ? '–°–ø–æ–∫–æ–µ–Ω' : v <= 4 ? '–ù–µ–º–Ω–æ–≥–æ' : v <= 6 ? '–°—Ä–µ–¥–Ω–µ' : v <= 8 ? '–ú–Ω–æ–≥–æ' : '–û—á–µ–Ω—å';

  // –û–±—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const getOverallStatus = (mood, wellbeing, stress) => {
    const avg = (mood + wellbeing + (11 - stress)) / 3;
    if (avg >= 8) return { emoji: 'üåü', text: '–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ!' };
    if (avg >= 6.5) return { emoji: 'üòä', text: '–•–æ—Ä–æ—à–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ' };
    if (avg >= 5) return { emoji: 'üòê', text: '–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ' };
    if (avg >= 3.5) return { emoji: 'üòï', text: '–ù–µ –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç' };
    return { emoji: 'üòî', text: '–¢—è–∂—ë–ª—ã–π –º–æ–º–µ–Ω—Ç' };
  };

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: MoodSparkline ‚Äî –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å
  // ============================================================

  function MoodSparkline({ data, currentAvg }) {
    const sparklineData = [...data.map(m => m.avg), currentAvg];
    if (sparklineData.length < 2) return null;

    const width = 120;
    const height = 24;
    const padding = 2;
    const sparkMax = 10;
    const sparkMin = 0;

    const points = sparklineData.map((v, i) => {
      const x = padding + (i / (sparklineData.length - 1)) * (width - padding * 2);
      const y = height - padding - ((v - sparkMin) / (sparkMax - sparkMin)) * (height - padding * 2);
      return { x, y, v };
    });
    const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');

    return React.createElement('svg', {
      className: 'meal-mood-sparkline',
      viewBox: `0 0 ${width} ${height}`,
      preserveAspectRatio: 'none'
    },
      React.createElement('path', {
        d: pathD,
        fill: 'none',
        stroke: '#3b82f6',
        strokeWidth: 2,
        strokeLinecap: 'round',
        strokeLinejoin: 'round'
      }),
      ...points.map((p, i) =>
        React.createElement('circle', {
          key: i,
          cx: p.x,
          cy: p.y,
          r: i === points.length - 1 ? 4 : 3,
          fill: i === points.length - 1 ? '#10b981' : (p.v >= 6 ? '#22c55e' : p.v >= 4 ? '#eab308' : '#ef4444'),
          stroke: 'white',
          strokeWidth: 1.5
        })
      )
    );
  }

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: RatingCard ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Ü–µ–Ω–∫–∏
  // ============================================================

  function RatingCard({
    field,
    value,
    emoji,
    title,
    presets,
    getColor,
    getBg,
    getText,
    emojiAnim,
    numAnim,
    emojiTap,
    showPulse,
    onSliderChange,
    onEmojiTap,
    isNegative = false
  }) {
    return React.createElement('div', {
      className: 'meal-rating-card',
      style: { background: getBg(value) }
    },
      React.createElement('div', { className: 'meal-rating-row-main' },
        // Emoji —Å–ª–µ–≤–∞ (—Å —Ç–∞–ø–æ–º)
        React.createElement('span', {
          className: `meal-rating-emoji-lg ${emojiAnim} ${emojiTap ? 'emoji-tap' : ''}`,
          onClick: () => onEmojiTap(field)
        }, emoji),
        // –ò–Ω—Ñ–æ —Å–ø—Ä–∞–≤–∞
        React.createElement('div', { className: 'meal-rating-info' },
          React.createElement('div', { className: 'meal-rating-title' }, title),
          React.createElement('div', { className: 'meal-rating-value-row' },
            React.createElement('span', {
              className: `meal-rating-num ${numAnim ? 'num-bounce' : ''}`,
              style: { color: getColor(value) }
            }, value),
            React.createElement('span', { className: 'meal-rating-max' }, '/10'),
            React.createElement('span', { className: 'meal-rating-text' }, getText(value))
          )
        ),
        // –ü—Ä–µ—Å–µ—Ç—ã —Å–ø—Ä–∞–≤–∞
        React.createElement('div', { className: `meal-rating-presets ${showPulse ? 'presets-pulse' : ''}` },
          presets.map(p =>
            React.createElement('button', {
              key: p.value,
              className: `meal-preset-btn ${value === p.value ? 'active' : ''}`,
              onClick: () => onSliderChange(field, p.value),
              title: p.label
            }, p.emoji)
          )
        )
      ),
      // –°–ª–∞–π–¥–µ—Ä
      React.createElement('input', {
        type: 'range',
        className: `mood-slider ${isNegative ? 'mood-slider-negative' : 'mood-slider-positive'}`,
        min: 1,
        max: 10,
        value: value,
        onChange: (e) => onSliderChange(field, Number(e.target.value)),
        onTouchStart: (e) => e.stopPropagation(),
        onTouchEnd: (e) => e.stopPropagation(),
        onTouchMove: (e) => e.stopPropagation()
      })
    );
  }

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: MealTypeGrid ‚Äî —Å–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø—Ä–∏—ë–º–∞
  // ============================================================

  function MealTypeGrid({ types, currentType, onSelect }) {
    return React.createElement('div', { className: 'meal-type-section' },
      React.createElement('div', { className: 'meal-type-label' }, '–¢–∏–ø –ø—Ä–∏—ë–º–∞:'),
      React.createElement('div', { className: 'meal-type-grid' },
        Object.entries(types).map(([key, val]) =>
          React.createElement('button', {
            key,
            className: `meal-type-btn ${currentType === key ? 'active' : ''}`,
            onClick: () => onSelect(key)
          },
            React.createElement('span', { className: 'meal-type-btn-icon' }, val.icon),
            React.createElement('span', { className: 'meal-type-btn-name' }, val.name)
          )
        )
      )
    );
  }

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: ConfettiEffect ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
  // ============================================================

  const CONFETTI_COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ec4899', '#3b82f6'];

  function ConfettiEffect({ show, count = 20 }) {
    if (!show) return null;
    return React.createElement('div', { className: 'confetti-container' },
      ...Array(count).fill(0).map((_, i) =>
        React.createElement('div', {
          key: 'confetti-' + i,
          className: 'confetti-piece',
          style: {
            left: (5 + Math.random() * 90) + '%',
            animationDelay: (Math.random() * 0.5) + 's',
            backgroundColor: CONFETTI_COLORS[i % CONFETTI_COLORS.length]
          }
        })
      )
    );
  }

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: NightHint ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ—á–Ω—ã—Ö —á–∞—Å–æ–≤
  // ============================================================

  function NightHint({ isNightHour, dateLabel }) {
    if (!isNightHour) return null;
    return React.createElement('div', { className: 'meal-night-hint' },
      React.createElement('span', { className: 'meal-night-icon' }, 'üåô'),
      React.createElement('span', { className: 'meal-night-text' },
        '–ù–æ—á–Ω–æ–π –ø—Ä–∏—ë–º ‚Äî –∑–∞–ø–∏—à–µ—Ç—Å—è –≤ ', React.createElement('b', null, dateLabel)
      )
    );
  }

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: MoodHistorySection ‚Äî –∏—Å—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å
  // ============================================================

  function MoodHistorySection({ todayMoods, currentAvg }) {
    if (todayMoods.length === 0) return null;

    return React.createElement('div', { className: 'meal-mood-history' },
      React.createElement('div', { className: 'meal-mood-history-header' },
        React.createElement('span', { className: 'meal-mood-history-label' }, '–°–µ–≥–æ–¥–Ω—è'),
        React.createElement(MoodSparkline, { data: todayMoods, currentAvg })
      ),
      React.createElement('div', { className: 'meal-mood-history-items' },
        ...todayMoods.map((m, i) =>
          React.createElement('div', {
            key: i,
            className: 'meal-mood-history-item',
            title: `üòä${m.mood} üí™${m.wellbeing} üò∞${m.stress}`
          },
            React.createElement('span', { className: 'meal-mood-history-name' }, m.name),
            React.createElement('span', {
              className: 'meal-mood-history-avg',
              style: { color: m.avg >= 6 ? '#22c55e' : m.avg >= 4 ? '#eab308' : '#ef4444' }
            }, m.avg.toFixed(1))
          )
        ),
        // –¢–µ–∫—É—â–∏–π
        React.createElement('div', { className: 'meal-mood-history-item meal-mood-history-current' },
          React.createElement('span', { className: 'meal-mood-history-name' }, '–°–µ–π—á–∞—Å'),
          React.createElement('span', {
            className: 'meal-mood-history-avg',
            style: { color: '#3b82f6', fontWeight: 600 }
          }, currentAvg.toFixed(1))
        )
      )
    );
  }

  // ============================================================
  // –ö–û–ú–ü–û–ù–ï–ù–¢: CommentSection ‚Äî —Å–µ–∫—Ü–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
  // ============================================================

  function CommentSection({ moodState, mood, wellbeing, stress, comment, chips, onAddChip, onChangeComment, commentRef }) {
    const icon = moodState === 'negative' ? 'üìù' : moodState === 'positive' ? '‚ú®' : 'üí≠';

    return React.createElement('div', {
      className: `meal-comment-section meal-comment-${moodState}`
    },
      React.createElement('div', { className: 'meal-comment-header' },
        React.createElement('span', { className: 'meal-comment-icon' }, icon),
        React.createElement('span', { className: 'meal-comment-title' }, getJournalText(moodState, mood, wellbeing, stress))
      ),

      // Quick chips
      React.createElement('div', { className: 'meal-comment-chips' },
        chips.map(chip =>
          React.createElement('button', {
            key: chip,
            className: 'meal-comment-chip',
            onClick: () => onAddChip(chip)
          }, chip)
        )
      ),

      // Input
      React.createElement('input', {
        ref: commentRef,
        type: 'text',
        className: 'meal-comment-input',
        placeholder: getPlaceholder(moodState, mood, wellbeing, stress),
        value: comment,
        onChange: (e) => onChangeComment(e.target.value)
      })
    );
  }

  // ============================================================
  // STEP 1: –í–†–ï–ú–Ø –ò –¢–ò–ü –ü–†–ò–Å–ú–ê
  // ============================================================

  // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ dayUtils (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
  const dayU = HEYS.dayUtils || {};
  const NIGHT_HOUR_THRESHOLD = dayU.NIGHT_HOUR_THRESHOLD || 3;
  const HOURS_ORDER = dayU.HOURS_ORDER || (() => {
    const order = [];
    for (let h = 3; h < 24; h++) order.push(h);
    for (let h = 0; h < 3; h++) order.push(h);
    return order;
  })();
  const wheelIndexToHour = dayU.wheelIndexToHour || ((idx) => HOURS_ORDER[idx] ?? idx);
  const hourToWheelIndex = dayU.hourToWheelIndex || ((hour) => {
    const normalizedHour = hour >= 24 ? hour - 24 : hour;
    const idx = HOURS_ORDER.indexOf(normalizedHour);
    return idx >= 0 ? idx : 0;
  });

  function MealTimeStepComponent({ data, onChange, context }) {
    const { TimePicker } = HEYS.StepModal;
    const insulinWave = HEYS.InsulinWave;
    const analytics = HEYS.analytics;
    const isEditMode = context?.mealIndex !== undefined || context?.initialHourIndex !== undefined;
    const [hasShownWarning, setHasShownWarning] = useState(false);
    const [warningOpen, setWarningOpen] = useState(false);
    const [cachedWave, setCachedWave] = useState(null);

    // –ò–Ω–¥–µ–∫—Å –∫–æ–ª–µ—Å–∞ –¥–ª—è —á–∞—Å–æ–≤ (–Ω–µ —Ä–µ–∞–ª—å–Ω—ã–π —á–∞—Å!)
    // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–µ—Ä—ë–º –∏–∑ context, –∏–Ω–∞—á–µ —Ç–µ–∫—É—â–∏–π —á–∞—Å
    const defaultHourIndex = context?.initialHourIndex ?? hourToWheelIndex(new Date().getHours());
    const defaultMinutes = context?.initialMinutes ?? Math.floor(new Date().getMinutes() / 5) * 5;
    const defaultMealType = context?.initialMealType ?? null;

    const currentHourIndex = data.hourIndex ?? defaultHourIndex;
    const minutes = data.minutes ?? defaultMinutes;
    const mealType = data.mealType ?? defaultMealType;

    // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω hourIndexRef ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º onTimeChange –¥–ª—è linkedScroll

    // –†–µ–∞–ª—å–Ω—ã–π —á–∞—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ª–æ–≥–∏–∫–∏
    const realHours = wheelIndexToHour(currentHourIndex);

    // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–∏–∫–µ—Ä–∞ —á–∞—Å–æ–≤ (–æ—Å–æ–±—ã–π –ø–æ—Ä—è–¥–æ–∫: 04-23, 00-03)
    const hoursValues = HOURS_ORDER;
    // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–∏–∫–µ—Ä–∞ –º–∏–Ω—É—Ç (0, 5, 10... 55)
    const minutesValues = useMemo(() => Array.from({ length: 12 }, (_, i) => i * 5), []);

    // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∏—ë–º—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
    const existingMeals = useMemo(() => {
      const dateKey = context?.dateKey || new Date().toISOString().slice(0, 10);
      const dayData = safeLsGet(`heys_dayv2_${dateKey}`, null);
      // –ó–∞—â–∏—Ç–∞ –æ—Ç null ‚Äî –¥–µ–Ω—å –º–æ–∂–µ—Ç –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å (–∑–∞–≤—Ç—Ä–∞, –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã)
      return dayData?.meals || [];
    }, [context?.dateKey]);

    // –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–∏—ë–º–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    const autoType = useMemo(() => {
      const timeStr = `${pad2(realHours)}:${pad2(minutes)}`;
      if (HEYS.dayUtils?.getMealTypeForPreview) {
        return HEYS.dayUtils.getMealTypeForPreview(timeStr, existingMeals);
      }
      // Fallback ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π —Ö–µ–ª–ø–µ—Ä
      return getMealTypeByHour(realHours);
    }, [realHours, minutes, existingMeals]);

    const currentType = mealType || autoType;

    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ—á–Ω—ã—Ö —á–∞—Å–æ–≤ (00-02)
    const isNightHour = realHours >= 0 && realHours < NIGHT_HOUR_THRESHOLD;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
    const dateLabel = useMemo(() => {
      const dateKey = context?.dateKey || new Date().toISOString().slice(0, 10);
      const d = new Date(dateKey);
      return `${d.getDate()} ${d.toLocaleDateString('ru-RU', { month: 'short' })}`;
    }, [context?.dateKey]);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ò–ù–î–ï–ö–°, –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–π —á–∞—Å (haptic —É–∂–µ –≤ TimePicker)
    const updateHours = (hourValue) => {
      // hourValue ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ (—á–∞—Å) –∏–∑ HOURS_ORDER
      const newIndex = HOURS_ORDER.indexOf(hourValue);
      onChange({ ...data, hourIndex: newIndex >= 0 ? newIndex : 0, minutes: data.minutes ?? minutes });
      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–ª–Ω–µ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥, –Ω–µ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ –∫–æ–ª–µ—Å–∞
    };

    const updateMinutes = (newMinutes) => {
      onChange({ ...data, hourIndex: currentHourIndex, minutes: newMinutes });
      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–ª–Ω–µ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥, –Ω–µ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ –∫–æ–ª–µ—Å–∞
    };

    // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll ‚Äî —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É React batching
    const updateTime = (hourValue, newMinutes) => {
      const newIndex = HOURS_ORDER.indexOf(hourValue);
      onChange({ ...data, hourIndex: newIndex >= 0 ? newIndex : 0, minutes: newMinutes });
      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–ª–Ω–µ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥, –Ω–µ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ –∫–æ–ª–µ—Å–∞
    };

    const selectType = (type) => {
      haptic(10);
      onChange({ ...data, mealType: type });
    };

    // === –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ===
    const isBulkMode = useMemo(() => {
      const deficit = context?.deficitPct;
      const profDeficit = context?.prof?.deficitPctTarget;
      const dayDeficit = context?.dayData?.deficitPct;
      const val = deficit ?? dayDeficit ?? profDeficit ?? 0;
      return typeof val === 'number' && val >= 10;
    }, [context?.deficitPct, context?.prof?.deficitPctTarget, context?.dayData?.deficitPct]);

    const mealsForWave = useMemo(() => {
      if (context?.meals && Array.isArray(context.meals)) return context.meals;
      return existingMeals;
    }, [context?.meals, existingMeals]);

    const trainingsForWave = useMemo(() => {
      if (context?.trainings && Array.isArray(context.trainings)) return context.trainings;
      return context?.dayData?.trainings || [];
    }, [context?.trainings, context?.dayData?.trainings]);

    const pIndexForWave = useMemo(() => {
      if (context?.pIndex) return context.pIndex;
      if (HEYS.dayUtils?.buildProductIndex) {
        const products = HEYS.products?.getAll?.() || safeLsGet('heys_products', []);
        return HEYS.dayUtils.buildProductIndex(products);
      }
      return null;
    }, [context?.pIndex]);

    const getProductFromItemFn = useMemo(() => {
      if (context?.getProductFromItem) return context.getProductFromItem;
      if (HEYS.dayUtils?.getProductFromItem) return HEYS.dayUtils.getProductFromItem;
      return () => null;
    }, [context?.getProductFromItem]);

    const baseWaveHours = useMemo(() => {
      return context?.prof?.insulinWaveHours || context?.dayData?.insulinWaveHours || 3;
    }, [context?.prof?.insulinWaveHours, context?.dayData?.insulinWaveHours]);

    const shouldSkipWarning = useMemo(() => {
      if (isEditMode) return true;
      if (isBulkMode) return true;
      if (!insulinWave || !insulinWave.calculate) return true;
      if (!mealsForWave || mealsForWave.length === 0) return true;
      // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –°–ï–ì–û–î–ù–Ø–®–ù–ï–ì–û –¥–Ω—è
      // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏—ë–º –≤ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      const todayKey = HEYS.models?.todayISO?.() || new Date().toISOString().slice(0, 10);
      if (context?.dateKey && context.dateKey !== todayKey) return true;
      return false;
    }, [isEditMode, isBulkMode, insulinWave, mealsForWave, context?.dateKey]);

    const trackInsulinEvent = useCallback((action, wave) => {
      if (!analytics || !analytics.trackDataOperation) return;
      analytics.trackDataOperation('insulin_wave_warning', {
        action,
        remainingMinutes: wave?.remaining ?? null,
        status: wave?.status || null
      });
    }, [analytics]);

    const computeWaveData = useCallback(() => {
      if (shouldSkipWarning) return null;
      const wave = insulinWave.calculate({
        meals: mealsForWave,
        pIndex: pIndexForWave,
        getProductFromItem: getProductFromItemFn,
        baseWaveHours,
        trainings: trainingsForWave,
        dayData: context?.dayData || { meals: mealsForWave, trainings: trainingsForWave, deficitPct: context?.deficitPct }
      });
      setCachedWave(wave);
      return wave;
    }, [shouldSkipWarning, insulinWave, mealsForWave, pIndexForWave, getProductFromItemFn, baseWaveHours, trainingsForWave, context?.dayData, context?.deficitPct]);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±–ª–∏–∑–∫–æ –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∫ —Ç–µ–∫—É—â–µ–º—É (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –º–∏–Ω—É—Ç)
    const isSelectedTimeCloseToNow = useCallback(() => {
      const now = new Date();
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      const selectedMinutes = realHours * 60 + minutes;
      // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö (—É—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å)
      let diff = Math.abs(selectedMinutes - nowMinutes);
      if (diff > 720) diff = 1440 - diff; // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 12 —á–∞—Å–æ–≤ ‚Äî —Å—á–∏—Ç–∞–µ–º —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
      return diff <= 30; // –í –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –º–∏–Ω—É—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    }, [realHours, minutes]);

    const maybeShowInsulinWaveWarning = useCallback(() => {
      if (hasShownWarning) return false;
      if (shouldSkipWarning) return false;
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏—ë–º –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ
      if (!isSelectedTimeCloseToNow()) return false;
      const wave = cachedWave || computeWaveData();
      if (!wave) return false;
      if (wave.status === 'lipolysis') return false;
      setHasShownWarning(true);
      setWarningOpen(true);
      trackInsulinEvent('show', wave);
      return true; // –í–µ—Ä–Ω—É–ª–∏ true ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
    }, [hasShownWarning, shouldSkipWarning, isSelectedTimeCloseToNow, cachedWave, computeWaveData, trackInsulinEvent]);

    const handleWait = useCallback(() => {
      setWarningOpen(false);
      trackInsulinEvent('wait', cachedWave);
      HEYS.StepModal?.hide?.();
    }, [cachedWave, trackInsulinEvent]);

    const handleContinue = useCallback(() => {
      setWarningOpen(false);
      setHasShownWarning(true);
      trackInsulinEvent('continue', cachedWave);
      // –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
      if (context?.onNext) {
        context.onNext();
      }
    }, [cachedWave, trackInsulinEvent, context]);

    // Keyboard Escape handler
    useEffect(() => {
      if (!warningOpen) return;
      const handleEscape = (e) => {
        if (e.key === 'Escape') handleWait();
      };
      document.addEventListener('keydown', handleEscape);
      return () => document.removeEventListener('keydown', handleEscape);
    }, [warningOpen, handleWait]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é –≤–æ–ª–Ω—É
    const handleNextStep = useCallback(() => {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      const warningShown = maybeShowInsulinWaveWarning();
      // –ï—Å–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω–µ –ø–æ–∫–∞–∑–∞–Ω–æ ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
      if (!warningShown && context?.onNext) {
        context.onNext();
      }
    }, [maybeShowInsulinWaveWarning, context]);

    return React.createElement('div', { className: 'meal-time-step' },
      warningOpen && React.createElement('div', {
        style: {
          position: 'fixed',
          top: 0, left: 0, right: 0, bottom: 0,
          zIndex: 9999,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '1rem',
          backgroundColor: 'rgba(0, 0, 0, 0.75)'
        }
      },
        React.createElement('div', {
          style: {
            width: '100%',
            maxWidth: '400px',
            borderRadius: '16px',
            backgroundColor: 'var(--card, #fff)',
            padding: '20px',
            boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
            display: 'flex',
            flexDirection: 'column',
            gap: '16px'
          }
        },
          React.createElement('div', {
            style: {
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              color: '#d97706',
              fontWeight: 600,
              fontSize: '18px'
            }
          },
            React.createElement('span', null, '‚ö†Ô∏è'),
            React.createElement('span', null, '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –µ—â—ë –∞–∫—Ç–∏–≤–Ω–∞')
          ),
          // Progress bar wrapper —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
          React.createElement('div', { style: { margin: '4px 0' } },
            (insulinWave?.renderProgressBar && cachedWave)
              ? insulinWave.renderProgressBar(cachedWave)
              : React.createElement('div', { style: { fontSize: '14px', color: '#475569' } },
                (cachedWave?.endTimeDisplay || cachedWave?.endTime)
                  ? `–õ–∏–ø–æ–ª–∏–∑ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ ${cachedWave.endTimeDisplay || cachedWave.endTime}`
                  : '–í–æ–ª–Ω–∞ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ')
          ),
          React.createElement('div', { style: { fontSize: '14px', color: '#334155', lineHeight: 1.6 } },
            '–ï—Å–ª–∏ –ø–æ–µ—Å—Ç—å —Å–µ–π—á–∞—Å, –≤–æ–ª–Ω–∞ –ø—Ä–æ–¥–ª–∏—Ç—Å—è –∏ –ª–∏–ø–æ–ª–∏–∑ –æ—Ç–ª–æ–∂–∏—Ç—Å—è.'
          ),
          React.createElement('div', { style: { fontSize: '13px', color: '#64748b' } },
            'üíß –í–æ–¥–∞, —á–∞–π –∏–ª–∏ –∫–æ—Ñ–µ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞ ‚Äî –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –ª–∏–ø–æ–ª–∏–∑'
          ),
          React.createElement('div', { style: { display: 'flex', gap: '12px', paddingTop: '4px' } },
            React.createElement('button', {
              style: {
                flex: 1,
                borderRadius: '12px',
                backgroundColor: '#f1f5f9',
                padding: '12px 16px',
                minHeight: '44px',
                fontSize: '14px',
                fontWeight: 600,
                color: '#334155',
                border: 'none',
                cursor: 'pointer'
              },
              onClick: handleWait
            }, '–ü–æ–¥–æ–∂–¥–∞—Ç—å'),
            React.createElement('button', {
              style: {
                flex: 1,
                borderRadius: '12px',
                backgroundColor: '#10b981',
                padding: '12px 16px',
                minHeight: '44px',
                fontSize: '14px',
                fontWeight: 600,
                color: '#fff',
                border: 'none',
                cursor: 'pointer',
                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
              },
              onClick: handleContinue
            }, '–í—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å')
          )
        )
      ),
      // –í—Ä–µ–º—è
      React.createElement('div', { className: 'meal-time-display' },
        React.createElement('span', { className: 'meal-time-value' },
          `${pad2(realHours)}:${pad2(minutes)}`
        )
      ),

      // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π TimePicker —Å linkedScroll
      React.createElement(TimePicker, {
        hours: realHours,
        minutes: minutes,
        onHoursChange: updateHours,
        onMinutesChange: updateMinutes,
        onTimeChange: updateTime, // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll
        hoursValues: hoursValues,
        minutesValues: minutesValues,
        hoursLabel: '',
        minutesLabel: '',
        linkedScroll: true,
        wrap: true,
        display: null,
        className: 'meal-time-pickers'
      }),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ—á–Ω—ã—Ö —á–∞—Å–æ–≤
      React.createElement(NightHint, { isNightHour, dateLabel }),

      // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–∏—ë–º–∞
      React.createElement(MealTypeGrid, {
        types: MEAL_TYPES,
        currentType,
        onSelect: selectType
      }),

      // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" ‚Äî –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
      React.createElement('button', {
        className: 'meal-time-next-btn',
        onClick: handleNextStep,
        style: {
          marginTop: '16px',
          width: '100%',
          padding: '14px 24px',
          borderRadius: '12px',
          backgroundColor: '#10b981',
          color: '#fff',
          fontWeight: 600,
          fontSize: '16px',
          border: 'none',
          cursor: 'pointer',
          minHeight: '48px',
          boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
        }
      }, '–î–∞–ª–µ–µ ‚Üí')
    );
  }

  // ============================================================
  // STEP 2: –û–¶–ï–ù–ö–ò + –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô
  // ============================================================

  function MealMoodStepComponent({ data, onChange, stepData, context }) {
    const mood = data.mood ?? 5;
    const wellbeing = data.wellbeing ?? 5;
    const stress = data.stress ?? 5;
    const comment = data.comment ?? '';

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —ç–º–æ–¥–∑–∏ –∏ —á–∏—Å–µ–ª
    const [emojiAnim, setEmojiAnim] = useState({ mood: '', wellbeing: '', stress: '' });
    const [numAnim, setNumAnim] = useState({ mood: false, wellbeing: false, stress: false });
    const [emojiTap, setEmojiTap] = useState({ mood: false, wellbeing: false, stress: false });

    // Confetti state
    const [showConfetti, setShowConfetti] = useState(false);

    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å pulse –Ω–∞ –ø—Ä–µ—Å–µ—Ç–∞—Ö (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã)
    const [showPulse, setShowPulse] = useState(true);
    useEffect(() => {
      const timer = setTimeout(() => setShowPulse(false), 3000);
      return () => clearTimeout(timer);
    }, []);

    // Ref –¥–ª—è –∞–≤—Ç–æ—Ñ–æ–∫—É—Å–∞ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    const commentRef = useRef(null);

    // –ò—Å—Ç–æ—Ä–∏—è –æ—Ü–µ–Ω–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    const todayMoods = useMemo(() => {
      const dateKey = context?.dateKey || new Date().toISOString().slice(0, 10);
      const dayData = safeLsGet(`heys_dayv2_${dateKey}`, null);
      // –ó–∞—â–∏—Ç–∞ –æ—Ç null ‚Äî –¥–µ–Ω—å –º–æ–∂–µ—Ç –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
      const meals = dayData?.meals || [];
      return meals.map(m => {
        const moodVal = m.mood || 5;
        const wellVal = m.wellbeing || 5;
        const stressVal = m.stress || 5;
        // –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: mood + wellbeing + (10 - stress) / 3, —à–∫–∞–ª–∞ 0-10
        const avg = (moodVal + wellVal + (10 - stressVal)) / 3;

        // –ù–∞–∑–≤–∞–Ω–∏–µ: –∏–∑ name, –∏–ª–∏ –∏–∑ mealType, –∏–ª–∏ fallback
        let displayName = m.name;
        if (!displayName || displayName === '–ü—Ä–∏—ë–º') {
          if (m.mealType && MEAL_TYPES[m.mealType]) {
            displayName = MEAL_TYPES[m.mealType].name;
          } else {
            displayName = '–ü—Ä–∏—ë–º';
          }
        }

        return {
          name: displayName,
          mood: moodVal,
          wellbeing: wellVal,
          stress: stressVal,
          avg: Math.round(avg * 10) / 10
        };
      });
    }, [context?.dateKey]);

    // === –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ===
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã
    const moodState = getMoodState(mood, wellbeing, stress);
    const chips = getQuickChips(moodState, mood, wellbeing, stress);

    // Confetti –ø—Ä–∏ –∏–¥–µ–∞–ª—å–Ω—ã—Ö –æ—Ü–µ–Ω–∫–∞—Ö
    const triggerConfetti = useCallback(() => {
      if (!showConfetti) {
        setShowConfetti(true);
        haptic([50, 50, 50, 50, 100]);
        setTimeout(() => setShowConfetti(false), 2000);
      }
    }, [showConfetti]);

    // –¢–∞–ø –Ω–∞ emoji ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
    const handleEmojiTap = (field) => {
      haptic(5);
      setEmojiTap(prev => ({ ...prev, [field]: true }));
      setTimeout(() => setEmojiTap(prev => ({ ...prev, [field]: false })), 300);
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞
    const handleSliderChange = (field, value) => {
      haptic(value >= 8 || value <= 2 ? 15 : 10);

      // –ê–Ω–∏–º–∞—Ü–∏—è emoji
      const animType = (field === 'stress' && value >= 7) ||
        ((field === 'mood' || field === 'wellbeing') && value <= 3)
        ? 'shake' : 'bounce';
      setEmojiAnim(prev => ({ ...prev, [field]: animType }));
      setTimeout(() => setEmojiAnim(prev => ({ ...prev, [field]: '' })), 400);

      // –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–ª–∞ (bounce)
      setNumAnim(prev => ({ ...prev, [field]: true }));
      setTimeout(() => setNumAnim(prev => ({ ...prev, [field]: false })), 200);

      const newData = { ...data, [field]: value };
      onChange(newData);

      // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ü–µ–Ω–∫–∞—Ö
      if ((field === 'mood' && value <= 3) || (field === 'stress' && value >= 8)) {
        setTimeout(() => commentRef.current?.focus(), 300);
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–¥–µ–∞–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è confetti
      const isPerfect = (field === 'mood' ? value : mood) >= 8 &&
        (field === 'wellbeing' ? value : wellbeing) >= 8 &&
        (field === 'stress' ? value : stress) > 0 &&
        (field === 'stress' ? value : stress) <= 2;
      if (isPerfect) triggerConfetti();
    };

    // –î–æ–±–∞–≤–∏—Ç—å chip –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    const addChip = (chip) => {
      haptic(5);
      const newComment = comment ? comment + ', ' + chip : chip;
      onChange({ ...data, comment: newComment });
    };

    // –û–±—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π —Ö–µ–ª–ø–µ—Ä)
    const overallStatus = getOverallStatus(mood, wellbeing, stress);

    // –¢–µ–∫—É—â–∞—è —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞
    const currentAvg = Math.round((mood + wellbeing + (10 - stress)) / 3 * 10) / 10;

    return React.createElement('div', { className: 'meal-mood-step' },
      // –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      React.createElement(MoodHistorySection, { todayMoods, currentAvg }),

      // –û–±—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
      React.createElement('div', { className: 'meal-overall-status' },
        React.createElement('span', { className: 'meal-overall-emoji' }, overallStatus.emoji),
        React.createElement('span', { className: 'meal-overall-text' }, overallStatus.text)
      ),

      // Confetti ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      React.createElement(ConfettiEffect, { show: showConfetti }),

      // –¢—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ü–µ–Ω–æ–∫ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º RatingCard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      React.createElement('div', { className: 'meal-ratings-grid' },

        // === –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ===
        React.createElement(RatingCard, {
          field: 'mood',
          value: mood,
          emoji: MOOD_EMOJI[mood] || 'üòê',
          title: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
          presets: PRESETS_POSITIVE,
          getColor: getPositiveColor,
          getBg: getCardBg,
          getText: getMoodText,
          emojiAnim: emojiAnim.mood,
          numAnim: numAnim.mood,
          emojiTap: emojiTap.mood,
          showPulse,
          onSliderChange: handleSliderChange,
          onEmojiTap: handleEmojiTap,
          isNegative: false
        }),

        // === –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ ===
        React.createElement(RatingCard, {
          field: 'wellbeing',
          value: wellbeing,
          emoji: WELLBEING_EMOJI[wellbeing] || 'üòê',
          title: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ',
          presets: PRESETS_POSITIVE,
          getColor: getPositiveColor,
          getBg: getCardBg,
          getText: getWellbeingText,
          emojiAnim: emojiAnim.wellbeing,
          numAnim: numAnim.wellbeing,
          emojiTap: emojiTap.wellbeing,
          showPulse,
          onSliderChange: handleSliderChange,
          onEmojiTap: handleEmojiTap,
          isNegative: false
        }),

        // === –°—Ç—Ä–µ—Å—Å ===
        React.createElement(RatingCard, {
          field: 'stress',
          value: stress,
          emoji: STRESS_EMOJI[stress] || 'üòê',
          title: '–°—Ç—Ä–µ—Å—Å',
          presets: PRESETS_NEGATIVE,
          getColor: getNegativeColor,
          getBg: getStressCardBg,
          getText: getStressText,
          emojiAnim: emojiAnim.stress,
          numAnim: numAnim.stress,
          emojiTap: emojiTap.stress,
          showPulse,
          onSliderChange: handleSliderChange,
          onEmojiTap: handleEmojiTap,
          isNegative: true
        })
      ),

      // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      React.createElement(CommentSection, {
        moodState,
        mood,
        wellbeing,
        stress,
        comment,
        chips,
        onAddChip: addChip,
        onChangeComment: (val) => onChange({ ...data, comment: val }),
        commentRef
      })
    );
  }

  // ============================================================
  // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –®–ê–ì–û–í
  // ============================================================

  if (HEYS.StepModal) {
    const { registerStep } = HEYS.StepModal;

    // –®–∞–≥ 1: –í—Ä–µ–º—è –∏ —Ç–∏–ø
    registerStep('mealTime', {
      title: '–í—Ä–µ–º—è –ø—Ä–∏—ë–º–∞',
      hint: '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –∏ —Ç–∏–ø',
      icon: 'üïê',
      component: MealTimeStepComponent,
      getInitialData: (ctx) => {
        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–µ—Ä—ë–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ context
        if (ctx?.initialHourIndex !== undefined) {
          return {
            hourIndex: ctx.initialHourIndex,
            minutes: ctx.initialMinutes ?? 0,
            mealType: ctx.initialMealType ?? null
          };
        }
        // –î–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ ‚Äî —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        const now = new Date();
        return {
          hourIndex: hourToWheelIndex(now.getHours()),
          minutes: Math.floor(now.getMinutes() / 5) * 5,
          mealType: null // –∞–≤—Ç–æ
        };
      },
      validate: () => true,
      hideHeaderNext: true // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–ª–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
    });

    // –®–∞–≥ 2: –û—Ü–µ–Ω–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    registerStep('mealMood', {
      title: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ',
      hint: '–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?',
      icon: 'üòä',
      allowSwipe: false, // –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å–æ —Å–ª–∞–π–¥–µ—Ä–∞–º–∏
      component: MealMoodStepComponent,
      getInitialData: (ctx) => {
        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–µ—Ä—ë–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ context
        if (ctx?.initialMood !== undefined) {
          return {
            mood: ctx.initialMood,
            wellbeing: ctx.initialWellbeing ?? 5,
            stress: ctx.initialStress ?? 5,
            comment: ctx.initialComment ?? ''
          };
        }

        // –ë–µ—Ä—ë–º –æ—Ü–µ–Ω–∫–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
        const dayData = safeLsGet(`heys_dayv2_${dateKey}`, null);
        // –ó–∞—â–∏—Ç–∞ –æ—Ç null ‚Äî –¥–µ–Ω—å –º–æ–∂–µ—Ç –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å (–∑–∞–≤—Ç—Ä–∞, –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã)
        const meals = dayData?.meals || [];

        // 1. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏—ë–º—ã —Å–µ–≥–æ–¥–Ω—è ‚Äî –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π
        if (meals.length > 0) {
          const lastMeal = meals[meals.length - 1];
          return {
            mood: lastMeal.mood || 5,
            wellbeing: lastMeal.wellbeing || 5,
            stress: lastMeal.stress || 5,
            comment: ''
          };
        }

        // 2. –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º ‚Äî –±–µ—Ä—ë–º –æ—Ü–µ–Ω–∫–∏ –∏–∑ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞
        const checkinMood = dayData?.moodAvg;
        const checkinWellbeing = dayData?.wellbeingAvg;
        const checkinStress = dayData?.stressAvg;

        const hasCheckinRatings =
          Number.isFinite(checkinMood) ||
          Number.isFinite(checkinWellbeing) ||
          Number.isFinite(checkinStress);

        if (hasCheckinRatings) {
          return {
            mood: Number.isFinite(checkinMood) ? Math.round(checkinMood) : 5,
            wellbeing: Number.isFinite(checkinWellbeing) ? Math.round(checkinWellbeing) : 5,
            stress: Number.isFinite(checkinStress) ? Math.round(checkinStress) : 5,
            comment: ''
          };
        }

        // 3. –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º ‚Äî –±–µ—Ä—ë–º —Å—Ä–µ–¥–Ω–∏–µ –∑–∞ –≤—á–µ—Ä–∞
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayKey = yesterday.toISOString().slice(0, 10);
        const yesterdayData = safeLsGet(`heys_dayv2_${yesterdayKey}`, null);
        const yesterdayMeals = yesterdayData?.meals || [];

        if (yesterdayMeals.length > 0) {
          // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –∑–∞ –≤—á–µ—Ä–∞
          let totalMood = 0, totalWellbeing = 0, totalStress = 0;
          let count = 0;

          for (const meal of yesterdayMeals) {
            if (meal.mood || meal.wellbeing || meal.stress) {
              totalMood += meal.mood || 5;
              totalWellbeing += meal.wellbeing || 5;
              totalStress += meal.stress || 5;
              count++;
            }
          }

          if (count > 0) {
            return {
              mood: Math.round(totalMood / count),
              wellbeing: Math.round(totalWellbeing / count),
              stress: Math.round(totalStress / count),
              comment: ''
            };
          }
        }

        // 4. –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5
        return { mood: 5, wellbeing: 5, stress: 5, comment: '' };
      },
      validate: () => true
    });
  }

  // ============================================================
  // API: –°–û–ó–î–ê–ù–ò–ï –ü–†–ò–Å–ú–ê
  // ============================================================

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
   * @param {Object} options
   * @param {string} options.dateKey - –î–∞—Ç–∞ (YYYY-MM-DD)
   * @param {Function} options.onComplete - Callback –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
   */
  function showAddMealModal(options = {}) {
    const dateKey = options.dateKey || new Date().toISOString().slice(0, 10);

    HEYS.StepModal.show({
      steps: ['mealTime', 'mealMood'],
      title: '–ù–æ–≤—ã–π –ø—Ä–∏—ë–º',
      showProgress: true,
      showStreak: false,
      showGreeting: false,
      showTip: false,
      finishLabel: '–î–æ–±–∞–≤–∏—Ç—å', // –°–æ–∑–¥–∞–Ω–∏–µ ‚Äî "–î–æ–±–∞–≤–∏—Ç—å"
      context: {
        dateKey,
        meals: options.meals,
        pIndex: options.pIndex,
        getProductFromItem: options.getProductFromItem,
        trainings: options.trainings,
        deficitPct: options.deficitPct,
        prof: options.prof,
        dayData: options.dayData
      },
      onComplete: (stepData) => {
        // –°–æ–∑–¥–∞—ë–º –ø—Ä–∏—ë–º
        const timeData = stepData.mealTime || {};
        const moodData = stepData.mealMood || {};

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å –∫–æ–ª–µ—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã–π —á–∞—Å
        // –ï—Å–ª–∏ hourIndex –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç—Ä–æ–≥–∞–ª –ø–∏–∫–µ—Ä), 
        // –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å –∫–∞–∫ fallback
        const defaultHourIndex = hourToWheelIndex(new Date().getHours());
        const hourIndex = timeData.hourIndex ?? defaultHourIndex;
        let realHours = wheelIndexToHour(hourIndex);

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á–∞—Å—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (–Ω–æ—á–Ω—ã–µ 00-02 ‚Üí 24-26)
        realHours = normalizeHoursForStorage(realHours, NIGHT_HOUR_THRESHOLD);
        const timeStr = `${pad2(realHours)}:${pad2(timeData.minutes || 0)}`;

        // –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ –≤—ã–±—Ä–∞–Ω —è–≤–Ω–æ ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const mealType = timeData.mealType || getMealTypeByHour(realHours);

        // –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∞ –∏–∑ —Ç–∏–ø–∞
        const mealName = MEAL_TYPES[mealType]?.name || '–ü—Ä–∏—ë–º';

        const newMeal = {
          id: uid('m_'),
          name: mealName,
          time: timeStr,
          mealType: mealType,
          mood: moodData.mood || 5,
          wellbeing: moodData.wellbeing || 5,
          stress: moodData.stress || 5,
          items: []
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
        if (moodData.comment && moodData.comment.trim()) {
          newMeal.comment = moodData.comment.trim();
        }

        // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –Ω–∞–ø—Ä—è–º—É—é!
        // DayTab —Å–∞–º –¥–æ–±–∞–≤–∏—Ç meal –≤ —Å–≤–æ–π state –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —á–µ—Ä–µ–∑ autosave
        // –≠—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç race condition –º–µ–∂–¥—É –º–æ–¥–∞–ª–∫–æ–π –∏ DayTab

        // Callback ‚Äî –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–ª—å–∫–æ newMeal, DayTab —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç state
        if (options.onComplete) {
          options.onComplete(newMeal);
        }
      },
      onClose: options.onClose
    });
  }

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç–∏–ø–∞ –ø—Ä–∏—ë–º–∞ (1 —à–∞–≥)
   * @param {Object} options
   * @param {Object} options.meal - –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   * @param {number} options.mealIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–∏—ë–º–∞
   * @param {string} options.dateKey - –î–∞—Ç–∞ (YYYY-MM-DD)
   * @param {Function} options.onComplete - Callback –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   */
  function showEditMealModal(options = {}) {
    const { meal, mealIndex, dateKey, onComplete, onClose } = options;
    if (!meal) {
      console.error('[MealStep] showEditMeal: meal is required');
      return;
    }

    // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    const timeParts = (meal.time || '').split(':');
    let hours = parseInt(timeParts[0]) || new Date().getHours();
    const minutes = parseInt(timeParts[1]) || 0;

    // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á–∞—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (24-26 ‚Üí 0-2)
    hours = normalizeHoursForDisplay(hours);

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∏–Ω–¥–µ–∫—Å –∫–æ–ª–µ—Å–∞
    const hourIndex = hourToWheelIndex(hours);

    HEYS.StepModal.show({
      steps: ['mealTime'],  // –¢–æ–ª—å–∫–æ 1 —à–∞–≥ ‚Äî –≤—Ä–µ–º—è –∏ —Ç–∏–ø
      title: '',  // –ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      icon: '',   // –ë–µ–∑ –∏–∫–æ–Ω–∫–∏
      showProgress: false,
      showStreak: false,
      showGreeting: false,
      showTip: false,
      finishLabel: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
      context: {
        dateKey,
        mealIndex,
        // –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        initialHourIndex: hourIndex,
        initialMinutes: minutes,
        initialMealType: meal.mealType || null
      },
      onComplete: (stepData) => {
        const timeData = stepData.mealTime || {};

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º initialHourIndex –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ–Ω—è–ª
        const finalHourIndex = timeData.hourIndex ?? hourIndex;
        let realHours = wheelIndexToHour(finalHourIndex);

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á–∞—Å—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (00-02 ‚Üí 24-26)
        realHours = normalizeHoursForStorage(realHours, NIGHT_HOUR_THRESHOLD);
        const timeStr = `${pad2(realHours)}:${pad2(timeData.minutes ?? minutes)}`;

        // –¢–∏–ø –ø—Ä–∏—ë–º–∞
        const mealType = timeData.mealType || meal.mealType || null;
        const mealName = mealType ? (MEAL_TYPES[mealType]?.name || meal.name) : meal.name;

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (onComplete) {
          onComplete({
            mealIndex,
            time: timeStr,
            mealType,
            name: mealName
          });
        }
      },
      onClose
    });
  }

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ü–µ–Ω–æ–∫ –ø—Ä–∏—ë–º–∞ (1 —à–∞–≥)
   * @param {Object} options
   * @param {Object} options.meal - –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   * @param {number} options.mealIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–∏—ë–º–∞
   * @param {string} options.dateKey - –î–∞—Ç–∞ (YYYY-MM-DD)
   * @param {Function} options.onComplete - Callback –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   */
  function showEditMoodModal(options = {}) {
    const { meal, mealIndex, dateKey, onComplete, onClose } = options;
    if (!meal) {
      console.error('[MealStep] showEditMood: meal is required');
      return;
    }

    HEYS.StepModal.show({
      steps: ['mealMood'],  // –¢–æ–ª—å–∫–æ 1 —à–∞–≥ ‚Äî –æ—Ü–µ–Ω–∫–∏
      title: '',  // –ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      icon: '',   // –ë–µ–∑ –∏–∫–æ–Ω–∫–∏
      showProgress: false,
      showStreak: false,
      showGreeting: false,
      showTip: false,
      finishLabel: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
      context: {
        dateKey,
        mealIndex,
        // –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –±–µ—Ä—ë–º –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞
        initialMood: meal.mood || 5,
        initialWellbeing: meal.wellbeing || 5,
        initialStress: meal.stress || 5,
        initialComment: meal.comment || ''
      },
      onComplete: (stepData) => {
        const moodData = stepData.mealMood || {};

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (onComplete) {
          onComplete({
            mealIndex,
            mood: moodData.mood ?? meal.mood ?? 5,
            wellbeing: moodData.wellbeing ?? meal.wellbeing ?? 5,
            stress: moodData.stress ?? meal.stress ?? 5,
            comment: moodData.comment ?? meal.comment ?? ''
          });
        }
      },
      onClose
    });
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.MealStep = {
    showAddMeal: showAddMealModal,
    showEditMeal: showEditMealModal,
    showEditMood: showEditMoodModal,
    TimeStep: MealTimeStepComponent,
    MoodStep: MealMoodStepComponent
  };

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_training_step_v1.js ===== */
// heys_training_step_v1.js ‚Äî –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (2 —à–∞–≥–∞)
// –®–∞–≥ 1: –¢–∏–ø, –≤—Ä–µ–º—è, –æ—Ü–µ–Ω–∫–∏, –∑–∞–º–µ—Ç–∫–∞ | –®–∞–≥ 2: –ó–æ–Ω—ã –ø—É–ª—å—Å–∞
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const { useState, useMemo, useCallback, useEffect, useRef } = React;

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ StepModal
  if (!HEYS.StepModal) {
    console.error('[TrainingStep] HEYS.StepModal not found. Load heys_step_modal_v1.js first.');
    return;
  }

  const { registerStep } = HEYS.StepModal;

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const lsGet = (key, def) => {
    try {
      const utils = HEYS.utils;
      if (utils?.lsGet) return utils.lsGet(key, def);
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : def;
    } catch { return def; }
  };

  const lsSet = (key, val) => {
    try {
      const utils = HEYS.utils;
      if (utils?.lsSet) return utils.lsSet(key, val);
      localStorage.setItem(key, JSON.stringify(val));
    } catch { }
  };

  const haptic = (style = 'light') => {
    try { navigator.vibrate?.(style === 'error' ? [50, 30, 50] : style === 'success' ? 20 : 10); } catch { }
  };

  const pad2 = n => String(n).padStart(2, '0');

  // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
  const TRAINING_TYPES = [
    { id: 'cardio', icon: 'üèÉ', label: '–ö–∞—Ä–¥–∏–æ' },
    { id: 'strength', icon: 'üèãÔ∏è', label: '–°–∏–ª–æ–≤–∞—è' },
    { id: 'hobby', icon: '‚öΩ', label: '–•–æ–±–±–∏' }
  ];

  const HR_ZONES = [
    { id: 0, name: '–†–∞–∑–º–∏–Ω–∫–∞', color: '#3b82f6', range: '50-60%' },
    { id: 1, name: '–ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ', color: '#22c55e', range: '60-70%' },
    { id: 2, name: '–ê—ç—Ä–æ–±–Ω–∞—è', color: '#eab308', range: '70-80%' },
    { id: 3, name: '–ê–Ω–∞—ç—Ä–æ–±–Ω–∞—è', color: '#ef4444', range: '80-90%' }
  ];

  // === –•–µ–ª–ø–µ—Ä—ã –¥–ª—è –æ—Ü–µ–Ω–æ–∫ ===
  function getMoodEmoji(v) {
    if (v <= 2) return 'üò´';
    if (v <= 4) return 'üòï';
    if (v <= 6) return 'üòê';
    if (v <= 8) return 'üòä';
    return 'ü§©';
  }

  function getStressEmoji(v) {
    if (v <= 2) return 'üòå';
    if (v <= 4) return 'üôÇ';
    if (v <= 6) return 'üòê';
    if (v <= 8) return 'üòü';
    return 'üò∞';
  }

  function getWellbeingEmoji(v) {
    if (v <= 2) return 'ü§í';
    if (v <= 4) return 'üòì';
    if (v <= 6) return 'üòê';
    if (v <= 8) return 'üí™';
    return 'üèÜ';
  }

  function getMoodColor(v) {
    if (v <= 2) return '#ef4444';
    if (v <= 4) return '#f97316';
    if (v <= 6) return '#eab308';
    if (v <= 8) return '#22c55e';
    return '#10b981';
  }

  function getStressColor(v) {
    if (v <= 2) return '#10b981';
    if (v <= 4) return '#22c55e';
    if (v <= 6) return '#eab308';
    if (v <= 8) return '#f97316';
    return '#ef4444';
  }

  // WheelPicker –∏ TimePicker –∏–∑ StepModal
  const WheelPicker = HEYS.StepModal.WheelPicker;
  const TimePicker = HEYS.StepModal.TimePicker;

  // ========================================
  // –®–ê–ì 1: –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞, —Ç–∏–ø, –æ—Ü–µ–Ω–∫–∏, –∑–∞–º–µ—Ç–∫–∞
  // ========================================
  function TrainingInfoStep({ data, onChange, context }) {
    const type = data.type || 'cardio';
    const time = data.time || '';
    const mood = data.mood || 5;
    const wellbeing = data.wellbeing || 5;
    const stress = data.stress || 5;
    const comment = data.comment || '';

    // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏–ª–∏ –±–µ—Ä—ë–º —Ç–µ–∫—É—â–µ–µ
    const [hours, minutes] = useMemo(() => {
      if (time) {
        const [h, m] = time.split(':').map(Number);
        return [h || 10, m || 0];
      }
      const now = new Date();
      return [now.getHours(), Math.floor(now.getMinutes() / 5) * 5];
    }, [time]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (haptic —É–∂–µ –≤ TimePicker)
    const setHours = (h) => {
      onChange({ ...data, time: pad2(h) + ':' + pad2(minutes) });
    };

    const setMinutes = (m) => {
      onChange({ ...data, time: pad2(hours) + ':' + pad2(m) });
    };

    // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É React batching)
    const setTime = (h, m) => {
      onChange({ ...data, time: pad2(h) + ':' + pad2(m) });
    };

    const updateField = (field, value) => {
      haptic('light');
      onChange({ ...data, [field]: value });
    };

    return React.createElement('div', { className: 'training-step' },

      // === –¢–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
      React.createElement('div', { className: 'ts-section ts-type-section' },
        React.createElement('div', { className: 'ts-type-grid' },
          TRAINING_TYPES.map(t =>
            React.createElement('button', {
              key: t.id,
              className: 'ts-type-btn' + (type === t.id ? ' active' : ''),
              onClick: () => updateField('type', t.id)
            },
              React.createElement('span', { className: 'ts-type-icon' }, t.icon),
              React.createElement('span', { className: 'ts-type-label' }, t.label)
            )
          )
        )
      ),

      // === –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π TimePicker —Å linkedScroll) ===
      React.createElement('div', { className: 'ts-section ts-time-wheel-section' },
        React.createElement('div', { className: 'ts-time-wheel-label' }, '‚è∞ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞'),
        React.createElement(TimePicker, {
          hours,
          minutes,
          onHoursChange: setHours,
          onMinutesChange: setMinutes,
          onTimeChange: setTime, // –ï–¥–∏–Ω—ã–π callback –¥–ª—è linkedScroll
          hoursLabel: '',
          minutesLabel: '',
          display: null, // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–π –¥–∏—Å–ø–ª–µ–π
          linkedScroll: true,
          className: 'ts-time-wheels'
        })
      ),

      // === –û—Ü–µ–Ω–∫–∏ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
      React.createElement('div', { className: 'ts-section ts-ratings-section' },
        React.createElement('div', { className: 'ts-ratings-title' }, 'üìä –ö–∞–∫–∏–µ –æ—â—É—â–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?'),

        // –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        React.createElement('div', { className: 'ts-rating-row' },
          React.createElement('div', { className: 'ts-rating-header' },
            React.createElement('span', { className: 'ts-rating-emoji' }, getMoodEmoji(mood)),
            React.createElement('span', { className: 'ts-rating-label' }, '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ'),
            React.createElement('span', {
              className: 'ts-rating-value',
              style: { color: getMoodColor(mood) }
            }, mood + '/10')
          ),
          React.createElement('input', {
            type: 'range',
            className: 'ts-slider ts-slider-positive',
            min: 1,
            max: 10,
            value: mood,
            onChange: e => updateField('mood', Number(e.target.value)),
            onTouchStart: e => e.stopPropagation(),
            onTouchMove: e => e.stopPropagation(),
            onTouchEnd: e => e.stopPropagation()
          })
        ),

        // –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ
        React.createElement('div', { className: 'ts-rating-row' },
          React.createElement('div', { className: 'ts-rating-header' },
            React.createElement('span', { className: 'ts-rating-emoji' }, getWellbeingEmoji(wellbeing)),
            React.createElement('span', { className: 'ts-rating-label' }, '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ'),
            React.createElement('span', {
              className: 'ts-rating-value',
              style: { color: getMoodColor(wellbeing) }
            }, wellbeing + '/10')
          ),
          React.createElement('input', {
            type: 'range',
            className: 'ts-slider ts-slider-positive',
            min: 1,
            max: 10,
            value: wellbeing,
            onChange: e => updateField('wellbeing', Number(e.target.value)),
            onTouchStart: e => e.stopPropagation(),
            onTouchMove: e => e.stopPropagation(),
            onTouchEnd: e => e.stopPropagation()
          })
        ),

        // –°—Ç—Ä–µ—Å—Å
        React.createElement('div', { className: 'ts-rating-row' },
          React.createElement('div', { className: 'ts-rating-header' },
            React.createElement('span', { className: 'ts-rating-emoji' }, getStressEmoji(stress)),
            React.createElement('span', { className: 'ts-rating-label' }, '–°—Ç—Ä–µ—Å—Å'),
            React.createElement('span', {
              className: 'ts-rating-value',
              style: { color: getStressColor(stress) }
            }, stress + '/10')
          ),
          React.createElement('input', {
            type: 'range',
            className: 'ts-slider ts-slider-negative',
            min: 1,
            max: 10,
            value: stress,
            onChange: e => updateField('stress', Number(e.target.value)),
            onTouchStart: e => e.stopPropagation(),
            onTouchMove: e => e.stopPropagation(),
            onTouchEnd: e => e.stopPropagation()
          })
        )
      ),

      // === –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ===
      React.createElement('div', { className: 'ts-section ts-comment-section' },
        React.createElement('input', {
          type: 'text',
          className: 'ts-comment-input',
          placeholder: 'üí¨ –ó–∞–º–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)',
          value: comment,
          onChange: e => updateField('comment', e.target.value),
          maxLength: 100
        })
      )
    );
  }

  // ========================================
  // –®–ê–ì 2: –ó–æ–Ω—ã –ø—É–ª—å—Å–∞
  // ========================================
  function TrainingZonesStep({ data, onChange, context }) {
    const profile = useMemo(() => lsGet('heys_profile', {}), []);
    const weight = profile.weight || 70;

    const hrZones = useMemo(() => lsGet('heys_hr_zones', []), []);
    const mets = useMemo(() => {
      const defaults = [2.5, 6, 8, 10];
      return defaults.map((def, i) => hrZones[i]?.MET || def);
    }, [hrZones]);

    const zones = data.zones || [0, 0, 0, 0];

    // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ–ª–µ—Å–∞ –º–∏–Ω—É—Ç: 0, 1, 2, ... 120
    const ZONE_MINUTES = useMemo(() => Array.from({ length: 121 }, (_, i) => i), []);

    const updateZone = (zoneIndex, value) => {
      const newZones = [...zones];
      newZones[zoneIndex] = Math.max(0, Math.min(120, value));
      haptic('light');
      onChange({ ...data, zones: newZones });
    };

    const totalMinutes = zones.reduce((s, z) => s + z, 0);
    const kcalBurned = useMemo(() => {
      return Math.round(zones.reduce((sum, min, i) => {
        return sum + min * mets[i] * weight / 60;
      }, 0));
    }, [zones, mets, weight]);

    return React.createElement('div', { className: 'training-step' },

      // === –ó–æ–Ω—ã –ø—É–ª—å—Å–∞ ===
      React.createElement('div', { className: 'ts-section ts-zones-section' },
        React.createElement('div', { className: 'ts-zones-header' },
          React.createElement('span', null, '‚ù§Ô∏è –ó–æ–Ω—ã –ø—É–ª—å—Å–∞'),
          React.createElement('span', { className: 'ts-zones-total' },
            totalMinutes + ' –º–∏–Ω ¬∑ ~' + kcalBurned + ' –∫–∫–∞–ª'
          )
        ),
        React.createElement('div', { className: 'ts-zones-wheels-grid' },
          HR_ZONES.map((zone, i) =>
            React.createElement('div', {
              key: zone.id,
              className: 'ts-zone-wheel-item',
              style: { '--zone-color': zone.color }
            },
              React.createElement('div', {
                className: 'ts-zone-wheel-header',
                style: { borderBottomColor: zone.color }
              },
                React.createElement('span', { className: 'ts-zone-wheel-name' }, zone.name),
                React.createElement('span', { className: 'ts-zone-wheel-range' }, zone.range)
              ),
              React.createElement('div', { className: 'ts-zone-wheel-picker' },
                React.createElement(WheelPicker, {
                  values: ZONE_MINUTES,
                  value: zones[i],
                  onChange: (v) => updateZone(i, v),
                  label: '',
                  suffix: '',
                  currentSuffix: '–º–∏–Ω'
                })
              )
            )
          )
        ),
        // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        React.createElement('div', { className: 'ts-quick-durations' },
          [15, 30, 45, 60].map(d =>
            React.createElement('button', {
              key: d,
              className: 'ts-quick-btn' + (totalMinutes === d ? ' active' : ''),
              onClick: () => {
                // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ –∑–æ–Ω–∞–º 1-2 (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ, –∞—ç—Ä–æ–±–Ω–∞—è)
                const half = Math.floor(d / 2);
                onChange({ ...data, zones: [0, half, d - half, 0] });
              }
            }, d + ' –º–∏–Ω')
          )
        )
      )
    );
  }

  // ========================================
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–æ–≤
  // ========================================

  // –®–∞–≥ 1: –ò–Ω—Ñ–æ (—Ç–∏–ø, –≤—Ä–µ–º—è, –æ—Ü–µ–Ω–∫–∏, –∑–∞–º–µ—Ç–∫–∞)
  registerStep('training-info', {
    title: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
    hint: '–¢–∏–ø –∏ –æ—â—É—â–µ–Ω–∏—è',
    icon: 'üèãÔ∏è',
    component: TrainingInfoStep,
    getInitialData: (ctx) => {
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const trainingIndex = ctx?.trainingIndex ?? 0;
      const day = lsGet(`heys_dayv2_${dateKey}`, {});
      const trainings = day.trainings || [];
      const T = trainings[trainingIndex] || {};

      return {
        type: T.type || 'cardio',
        time: T.time || '',
        zones: T.z || [0, 0, 0, 0],
        mood: T.mood || 5,
        wellbeing: T.wellbeing || 5,
        stress: T.stress || 5,
        comment: T.comment || ''
      };
    },
    validate: () => true // –®–∞–≥ 1 –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–µ–Ω
  });

  // –®–∞–≥ 2: –ó–æ–Ω—ã –ø—É–ª—å—Å–∞
  registerStep('training-zones', {
    title: '–ó–æ–Ω—ã –ø—É–ª—å—Å–∞',
    hint: '–ú–∏–Ω—É—Ç—ã –≤ –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ',
    icon: '‚ù§Ô∏è',
    component: TrainingZonesStep,
    getInitialData: (ctx, allData) => {
      // –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–≥–∞ 1 –∏–ª–∏ –∏–∑ storage
      if (allData?.['training-info']) {
        return allData['training-info'];
      }
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const trainingIndex = ctx?.trainingIndex ?? 0;
      const day = lsGet(`heys_dayv2_${dateKey}`, {});
      const trainings = day.trainings || [];
      const T = trainings[trainingIndex] || {};

      return {
        type: T.type || 'cardio',
        time: T.time || '',
        zones: T.z || [0, 0, 0, 0],
        mood: T.mood || 5,
        wellbeing: T.wellbeing || 5,
        stress: T.stress || 5,
        comment: T.comment || ''
      };
    },
    validate: (data) => {
      const total = (data.zones || []).reduce((s, z) => s + z, 0);
      return total > 0; // –•–æ—Ç—è –±—ã 1 –º–∏–Ω—É—Ç–∞
    },
    getValidationMessage: (data) => {
      const total = (data.zones || []).reduce((s, z) => s + z, 0);
      if (total === 0) return '–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã 1 –º–∏–Ω—É—Ç—É –≤ –ª—é–±–æ–π –∑–æ–Ω–µ';
      return null;
    },
    save: (data, ctx, allStepData) => {
      const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
      const trainingIndex = ctx?.trainingIndex ?? 0;
      const day = lsGet(`heys_dayv2_${dateKey}`, { date: dateKey });

      const trainings = day.trainings || [];
      while (trainings.length <= trainingIndex) {
        trainings.push({ z: [0, 0, 0, 0] });
      }

      // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–≥–∞ 1 (info) –∏ —à–∞–≥–∞ 2 (zones)
      const infoData = allStepData?.['training-info'] || {};
      const zonesData = data || {};

      const finalTraining = {
        z: zonesData.zones || [0, 0, 0, 0],
        time: infoData.time || zonesData.time || '',
        type: infoData.type || zonesData.type || 'cardio',
        mood: infoData.mood ?? zonesData.mood ?? 5,
        wellbeing: infoData.wellbeing ?? zonesData.wellbeing ?? 5,
        stress: infoData.stress ?? zonesData.stress ?? 5,
        comment: infoData.comment || zonesData.comment || ''
      };

      trainings[trainingIndex] = finalTraining;

      day.trainings = trainings;
      day.updatedAt = Date.now();
      lsSet(`heys_dayv2_${dateKey}`, day);

      window.dispatchEvent(new CustomEvent('heys:day-updated', {
        detail: { date: dateKey, field: 'trainings', source: 'training-step', forceReload: true }
      }));

      const totalMinutes = (finalTraining.z || []).reduce((sum, v) => sum + (Number(v) || 0), 0);
      if (typeof window !== 'undefined' && totalMinutes > 0) {
        window.dispatchEvent(new CustomEvent('heysTrainingAdded', {
          detail: { minutes: totalMinutes, date: dateKey, trainingIndex }
        }));
      }
    }
  });

  // === API: –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
  function showTrainingModal(options = {}) {
    const { dateKey, trainingIndex = 0, onComplete } = options;

    if (!HEYS.StepModal?.show) {
      console.error('[TrainingStep] StepModal not loaded');
      return;
    }

    HEYS.StepModal.show({
      steps: ['training-info', 'training-zones'],
      title: trainingIndex > 0 ? `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ${trainingIndex + 1}` : '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
      showProgress: true,
      showStreak: false,
      showGreeting: false,
      showTip: false,
      allowSwipe: false,
      finishLabel: '–î–æ–±–∞–≤–∏—Ç—å', // –ö–Ω–æ–ø–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ
      context: { dateKey, trainingIndex },
      onComplete: (stepData) => {
        const data = stepData['training-zones'] || stepData['training-info'] || {};
        onComplete?.(data);
      }
    });
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.TrainingStep = {
    show: showTrainingModal,
    InfoComponent: TrainingInfoStep,
    ZonesComponent: TrainingZonesStep,
    TRAINING_TYPES,
    HR_ZONES
  };

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_morning_checkin_v1.js ===== */
// heys_morning_checkin_v1.js ‚Äî –£—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω: –≤–µ—Å, —Å–æ–Ω, —à–∞–≥–∏
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –≤–µ—Å
// 
// === –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê –ú–û–î–£–õ–¨–ù–£–Æ –°–ò–°–¢–ï–ú–£ ===
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HEYS.StepModal + HEYS.Steps
// –°—Ç–∞—Ä—ã–π API (HEYS.MorningCheckin, HEYS.shouldShowMorningCheckin) —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
//
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  function getTodayKey() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º ¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é¬ª –¥–∞—Ç—É: –¥–æ 03:00 —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–µ–Ω—å –µ—â—ë –ø—Ä–µ–¥—ã–¥—É—â–∏–π
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: dayUtils.todayISO (—É—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–æ—á–Ω–æ–π –ø–æ—Ä–æ–≥) ‚Üí models.todayISO ‚Üí –ª–æ–∫–∞–ª—å–Ω—ã–π fallback
    const dayUtils = HEYS.dayUtils || {};
    if (typeof dayUtils.todayISO === 'function') return dayUtils.todayISO();
    if (HEYS.models && typeof HEYS.models.todayISO === 'function') return HEYS.models.todayISO();

    // Fallback –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    const d = new Date();
    if (d.getHours() < 3) {
      d.setDate(d.getDate() - 1);
    }
    const pad2 = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }

  function readStoredValue(key, fallback = null) {
    let value;

    if (HEYS.store?.get) {
      value = HEYS.store.get(key, fallback);
    } else if (HEYS.utils?.lsGet) {
      value = HEYS.utils.lsGet(key, fallback);
    } else {
      try {
        value = localStorage.getItem(key);
      } catch {
        return fallback;
      }
    }

    if (value == null) return fallback;

    if (typeof value === 'string') {
      if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try {
          value = HEYS.store.decompress(value.slice(3));
        } catch (_) { }
      }
      try {
        return JSON.parse(value);
      } catch (_) {
        return value;
      }
    }

    return value;
  }

  function getCurrentClientId() {
    const U = HEYS.utils || {};
    if (U.getCurrentClientId) return U.getCurrentClientId();
    return HEYS.currentClientId || '';
  }

  function getCheckinSessionKey(clientId, dateKey) {
    return `heys_morning_checkin_done_${clientId || 'unknown'}_${dateKey || 'unknown'}`;
  }

  function debugDayStorage(todayKey, currentClientId, altKey) {
    // DEBUG —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–Ω—Å–æ–ª–∏
    return;
    /* Original debug code:
    try {
      const ls = global.localStorage;
      if (!ls) return;
      const directKey = `heys_dayv2_${todayKey}`;
      const nsKey = currentClientId ? `heys_${currentClientId}_dayv2_${todayKey}` : '';
      const rawDirect = ls.getItem(directKey);
      const rawNs = nsKey ? ls.getItem(nsKey) : null;
      let parsedDirect = null;
      let parsedNs = null;
      try { parsedDirect = rawDirect ? JSON.parse(rawDirect) : null; } catch (_) {}
      try { parsedNs = rawNs ? JSON.parse(rawNs) : null; } catch (_) {}
      const candidates = [];
      for (let i = 0; i < ls.length; i++) {
        const k = ls.key(i);
        if (k && k.includes('_dayv2_')) {
          candidates.push(k);
        }
      }
      // üîá v4.8.2: Debug –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã ‚Äî –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    } catch (e) {
      // –Ω–µ –ª–æ–º–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∏–∑-–∑–∞ debug
    }
    */
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω
   * –í–ê–ñ–ù–û: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï —Å–æ–±—ã—Ç–∏—è heysSyncCompleted,
   * –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∞ isInitialSyncCompleted –Ω–µ –Ω—É–∂–Ω–∞
   * 
   * –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫-–∏–Ω!
   * –≠—Ç–æ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—à—ë–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —à–∞–≥–∏.
   */
  function shouldShowMorningCheckin() {
    const U = HEYS.utils || {};

    // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ–∫-–∏–Ω (—á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
    const currentClientId = getCurrentClientId();
    if (!currentClientId) {
      // console.log('[MorningCheckin] No clientId, skip check');
      return false;
    }

    const todayKey = getTodayKey();
    const sessionKey = getCheckinSessionKey(currentClientId, todayKey);

    // üÜï v1.9.1: –ï—Å–ª–∏ —á–µ–∫-–∏–Ω —É–∂–µ –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω/–ø—Ä–æ–ø—É—â–µ–Ω –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ ‚Äî –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    // –ü–µ—Ä–µ–≤–æ–¥–∏–º legacy-—Ñ–ª–∞–≥ –≤ per-client/per-day –∫–ª—é—á, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    try {
      if (sessionStorage.getItem('heys_morning_checkin_done') === 'true') {
        sessionStorage.setItem(sessionKey, 'true');
        sessionStorage.removeItem('heys_morning_checkin_done');
      }
    } catch (_) { }
    if (sessionStorage.getItem(sessionKey) === 'true') {
      console.info('[MorningCheckin] üö´ Skip ‚Äî sessionStorage —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–µ–Ω:', sessionKey);
      return false;
    }

    // üîí –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º!
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —à–∞–≥–∏ (profile-personal, profile-body, etc.) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const profile = readStoredValue('heys_profile', {});
    if (HEYS.ProfileSteps && HEYS.ProfileSteps.isProfileIncomplete) {
      if (HEYS.ProfileSteps.isProfileIncomplete(profile)) {
        console.log('[MorningCheckin] üÜï Profile incomplete ‚Äî forcing checkin with registration steps');
        return true;
      }
    }

    const dayData = readStoredValue(`heys_dayv2_${todayKey}`, {});
    const calendarKey = new Date().toISOString().slice(0, 10);
    const altDayData = calendarKey !== todayKey ? readStoredValue(`heys_dayv2_${calendarKey}`, {}) : {};

    const hasWeightPrimary = dayData && dayData.weightMorning != null && dayData.weightMorning !== '' && dayData.weightMorning !== 0;
    const hasWeightAlt = altDayData && altDayData.weightMorning != null && altDayData.weightMorning !== '' && altDayData.weightMorning !== 0;
    const hasWeight = hasWeightPrimary || hasWeightAlt;

    console.info('[MorningCheckin] üîç shouldShowMorningCheckin check:', {
      clientId: currentClientId?.slice(0, 8),
      todayKey,
      calendarKey,
      weightMorningPrimary: dayData?.weightMorning,
      weightMorningAlt: altDayData?.weightMorning,
      hasWeightPrimary,
      hasWeightAlt,
      hasWeight,
      sessionKey,
      sessionFlag: sessionStorage.getItem(sessionKey),
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–∏ –≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º –¥–Ω–µ (–¥–æ 3:00 = –≤—á–µ—Ä–∞), –Ω–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–º –∫–ª—é—á–µ –Ω–µ—Ç –≤–µ—Å–∞
    return !hasWeight;
  }

  /**
   * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —à–∞–≥–æ–≤ —á–µ–∫-–∏–Ω–∞
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –≤ MorningCheckin, –∏ –≤ showCheckin.morning()
   */
  function getCheckinSteps(profile) {
    const steps = [];
    let hasProfileSteps = false;

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (HEYS.ProfileSteps && HEYS.ProfileSteps.isProfileIncomplete) {
      if (HEYS.ProfileSteps.isProfileIncomplete(profile)) {
        steps.push('profile-personal', 'profile-body', 'profile-goals', 'profile-metabolism');
        // üéâ –®–∞–≥ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        steps.push('welcome');
        hasProfileSteps = true;
      }
    }

    // 2. –®–∞–≥ –≤–µ—Å–∞ ‚Äî –í–°–ï–ì–î–ê —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –≤ —á–µ–∫-–∏–Ω–µ
    // –í–µ—Å –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ü–µ–ª—ã–π) ‚Üí –ø—Ä–æ—Ñ–∏–ª—å (–±–∞–∑–æ–≤—ã–π –≤–µ—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤)
    // –í–µ—Å –≤ —á–µ–∫-–∏–Ω–µ (—Å –¥–µ—Å—è—Ç—ã–º–∏) ‚Üí –¥–µ–Ω—å (—Ç–æ—á–Ω–æ–µ —É—Ç—Ä–µ–Ω–Ω–µ–µ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ)
    steps.push('weight');

    // 2.1. üìä –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—á–µ—Ä–∞
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤—á–µ—Ä–∞ <50% –∫–∞–ª–æ—Ä–∏–π –∏ —Ö–æ—Ç—è –±—ã 1 –ø—Ä–∏—ë–º –ø–∏—â–∏
    // –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç: —Ä–µ–∞–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ –∏–ª–∏ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?
    steps.push('yesterdayVerify');

    // 3. –û—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ —á–µ–∫-–∏–Ω–∞
    steps.push('sleepTime', 'sleepQuality');

    // 3. üîÑ –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å (Refeed) ‚Äî –°–†–ê–ó–£ –ø–æ—Å–ª–µ sleepQuality
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–∞–º —Ä–µ—à–∞–µ—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥
    steps.push('refeedDay');

    // 4. –£—Å–ª–æ–≤–Ω—ã–µ —à–∞–≥–∏ (cycle, measurements)
    // –î–ª—è cycle: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ cycleTrackingEnabled=true –ò–õ–ò –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—à–∞–≥ —Å–ø—Ä–æ—Å–∏—Ç —Å–∞–º)
    // –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—å –µ—â—ë –ø—É—Å—Ç, –Ω–æ —à–∞–≥ cycle —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –ø–æ–ª –∏–∑ StepModal data
    if (hasProfileSteps) {
      // –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º cycle ‚Äî —à–∞–≥ —Å–∞–º —Ä–µ—à–∏—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ (–ø–æ –ø–æ–ª—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
      steps.push('cycle');
    } else if (HEYS.Steps && HEYS.Steps.shouldShowCycleStep && HEYS.Steps.shouldShowCycleStep()) {
      steps.push('cycle');
    }
    if (HEYS.Steps && HEYS.Steps.shouldShowMeasurements && HEYS.Steps.shouldShowMeasurements()) {
      steps.push('measurements');
    }

    // 5. üßä –•–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–∞–≥)
    steps.push('cold_exposure');

    // 6. üíä –í–∏—Ç–∞–º–∏–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–∞–≥, –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥. –¥–µ–Ω—å)
    steps.push('supplements');

    // 7. üòä –£—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥)
    steps.push('morning_mood');

    // 8. –ó–∞–≤–µ—Ä—à–∞—é—â–∏–π —à–∞–≥ ‚Äî —Ü–µ–ª—å –ø–æ —à–∞–≥–∞–º
    steps.push('stepsGoal');

    // 9. üåü –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥
    steps.push('morningRoutine');

    return steps;
  }

  /**
   * MorningCheckin ‚Äî –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ –Ω–æ–≤—ã–º StepModal
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —à–∞–≥–∏: [profile-steps], weight, sleepTime, sleepQuality, [measurements], stepsGoal
   * 
   * @param {function} onComplete - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤—Å–µ—Ö —à–∞–≥–æ–≤
   * @param {function} onClose - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∫—Ä–µ—Å—Ç–∏–∫–æ–º (–æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º)
   */
  function MorningCheckin({ onComplete, onClose }) {
    // –ï—Å–ª–∏ StepModal –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (HEYS.StepModal && HEYS.StepModal.Component) {
      const profile = readStoredValue('heys_profile', {});
      const steps = getCheckinSteps(profile);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º: —ç—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —á–µ–∫-–∏–Ω (–µ—Å—Ç—å profile-—à–∞–≥–∏)?
      const isRegistrationCheckin = steps.includes('profile-personal');

      // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è onComplete: –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
      const wrappedOnComplete = () => {
        // üéâ –ü–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —à–∞–≥ 'welcome' –≤–Ω—É—Ç—Ä–∏ flow

        // üé´ –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Ç—Ä–∏–∞–ª–∞ –£–ë–†–ê–ù (v5.0)
        // –¢—Ä–∏–∞–ª —Å—Ç–∞—Ä—Ç—É–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫—É—Ä–∞—Ç–æ—Ä–∞:
        //   1. –ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ
        //   2. –ö—É—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä—è–µ—Ç ‚Üí –¥–∞—ë—Ç PIN
        //   3. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ª–æ–≥–∏–Ω–µ ‚Üí activate_trial_timer_by_session
        // –°–º. database/2026-02-08_trial_machine_fix.sql

        // üîî –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –≤–∏—Ç–∞–º–∏–Ω–∞–º
        try {
          const currentClientId = getCurrentClientId();
          const sessionKey = getCheckinSessionKey(currentClientId, todayKey);
          sessionStorage.setItem(sessionKey, 'true');
          sessionStorage.removeItem('heys_morning_checkin_done');
          // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–∫–∞–∑–∞ —Å–æ–≤–µ—Ç–∞ ‚Äî —á—Ç–æ–±—ã –æ–Ω –ø–æ–∫–∞–∑–∞–ª—Å—è –ø–æ—Å–ª–µ —á–µ–∫-–∏–Ω–∞
          sessionStorage.removeItem('heys_morning_supplements_advice_shown');
        } catch (e) { /* sessionStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω */ }

        // üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–Ω—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ–∫-–∏–Ω–∞
        const todayKey = (HEYS.utils && HEYS.utils.getTodayKey) ? HEYS.utils.getTodayKey() : new Date().toISOString().slice(0, 10);
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { date: todayKey, source: 'morning-checkin-complete', forceReload: true }
        }));

        // üíä –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–≤–µ—Ç–æ–≤
        window.dispatchEvent(new CustomEvent('heys:checkin-complete', {
          detail: { date: todayKey, type: 'morning' }
        }));

        if (onComplete) onComplete();
      };

      return React.createElement(HEYS.StepModal.Component, {
        steps: steps,
        onComplete: wrappedOnComplete,
        onClose: onClose, // –ö—Ä–µ—Å—Ç–∏–∫ –≤ —Ö–µ–¥–µ—Ä–µ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        showProgress: true,
        showStreak: true,
        showGreeting: true,
        showTip: true,
        allowSwipe: true
      });
    }

    // Fallback: –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ StepModal –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    return React.createElement('div', {
      style: {
        padding: '20px',
        textAlign: 'center',
        background: 'var(--card, #fff)',
        borderRadius: '12px',
        margin: '20px'
      }
    },
      React.createElement('p', null, '–ó–∞–≥—Ä—É–∑–∫–∞...'),
      React.createElement('p', { style: { fontSize: '12px', color: '#666' } },
        '–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã heys_step_modal_v1.js –∏ heys_steps_v1.js'
      )
    );
  }

  // === –≠–∫—Å–ø–æ—Ä—Ç (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å) ===
  HEYS.MorningCheckin = MorningCheckin;
  HEYS.shouldShowMorningCheckin = shouldShowMorningCheckin;

  // PERF v7.1: notify boot-chain hook that deferred module is ready
  window.dispatchEvent(new CustomEvent('heys-morning-checkin-ready'));

  /**
   * –ë—ã—Å—Ç—Ä—ã–π API –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–æ–≤
   */
  HEYS.showCheckin = {
    // –ü–æ–ª–Ω—ã–π —É—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω
    morning: (onComplete) => {
      if (HEYS.StepModal) {
        const profile = readStoredValue('heys_profile', {});
        const steps = getCheckinSteps(profile);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º: —ç—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —á–µ–∫-–∏–Ω (–µ—Å—Ç—å profile-—à–∞–≥–∏)?
        const isRegistrationCheckin = steps.includes('profile-personal');

        // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è onComplete: –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
        const wrappedOnComplete = () => {
          // üéâ –ü–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —à–∞–≥ 'welcome' –≤–Ω—É—Ç—Ä–∏ flow

          // üé´ –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Ç—Ä–∏–∞–ª–∞ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª –≤ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º useEffect (—á–µ—Ä–µ–∑ HEYS.Subscription)
          // –≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
          if (isRegistrationCheckin) {
            console.log('[showCheckin.morning] ‚úÖ Registration checkin completed');
          }

          // üîî –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –≤–∏—Ç–∞–º–∏–Ω–∞–º
          try {
            const currentClientId = getCurrentClientId();
            const todayKey = (HEYS.utils && HEYS.utils.getTodayKey) ? HEYS.utils.getTodayKey() : new Date().toISOString().slice(0, 10);
            const sessionKey = getCheckinSessionKey(currentClientId, todayKey);
            sessionStorage.setItem(sessionKey, 'true');
            sessionStorage.removeItem('heys_morning_checkin_done');
            // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–∫–∞–∑–∞ —Å–æ–≤–µ—Ç–∞ ‚Äî —á—Ç–æ–±—ã –æ–Ω –ø–æ–∫–∞–∑–∞–ª—Å—è –ø–æ—Å–ª–µ —á–µ–∫-–∏–Ω–∞
            sessionStorage.removeItem('heys_morning_supplements_advice_shown');
          } catch (e) { /* sessionStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω */ }

          // üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–Ω—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ–∫-–∏–Ω–∞
          const todayKey = (HEYS.utils && HEYS.utils.getTodayKey) ? HEYS.utils.getTodayKey() : new Date().toISOString().slice(0, 10);
          window.dispatchEvent(new CustomEvent('heys:day-updated', {
            detail: { date: todayKey, source: 'morning-checkin-complete', forceReload: true }
          }));

          // üíä –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–≤–µ—Ç–æ–≤
          window.dispatchEvent(new CustomEvent('heys:checkin-complete', {
            detail: { date: todayKey, type: 'morning' }
          }));

          if (onComplete) onComplete();
        };

        HEYS.StepModal.show({
          steps,
          onComplete: wrappedOnComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ –≤–µ—Å
    weight: (dateKey, onComplete) => {
      if (HEYS.StepModal) {
        // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, —ç—Ç–æ onComplete (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
        const actualDateKey = typeof dateKey === 'function' ? null : dateKey;
        const actualOnComplete = typeof dateKey === 'function' ? dateKey : onComplete;

        HEYS.StepModal.show({
          steps: ['weight'],
          title: '–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ',
          showProgress: false,
          context: { dateKey: actualDateKey || new Date().toISOString().slice(0, 10) },
          onComplete: actualOnComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ —à–∞–≥–∏ (—Ü–µ–ª—å)
    steps: (onComplete) => {
      if (HEYS.StepModal) {
        HEYS.StepModal.show({
          steps: ['stepsGoal'],
          title: '–¶–µ–ª—å —à–∞–≥–æ–≤',
          showProgress: false,
          onComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ —Å–æ–Ω
    sleep: (dateKey, onComplete) => {
      if (HEYS.StepModal) {
        // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, —ç—Ç–æ onComplete (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
        const actualDateKey = typeof dateKey === 'function' ? null : dateKey;
        const actualOnComplete = typeof dateKey === 'function' ? dateKey : onComplete;

        HEYS.StepModal.show({
          steps: ['sleepTime', 'sleepQuality'],
          title: '–°–æ–Ω',
          showProgress: false,
          context: { dateKey: actualDateKey || new Date().toISOString().slice(0, 10) },
          onComplete: actualOnComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ —É—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    morningMood: (dateKey, onComplete) => {
      if (HEYS.StepModal) {
        // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, —ç—Ç–æ onComplete (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
        const actualDateKey = typeof dateKey === 'function' ? null : dateKey;
        const actualOnComplete = typeof dateKey === 'function' ? dateKey : onComplete;

        HEYS.StepModal.show({
          steps: ['morning_mood'],
          title: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ',
          showProgress: false,
          context: { dateKey: actualDateKey || new Date().toISOString().slice(0, 10) },
          onComplete: actualOnComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ –∑–∞–º–µ—Ä—ã —Ç–µ–ª–∞
    measurements: (dateKey, onComplete) => {
      if (HEYS.StepModal) {
        // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, —ç—Ç–æ onComplete (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
        const actualDateKey = typeof dateKey === 'function' ? null : dateKey;
        const actualOnComplete = typeof dateKey === 'function' ? dateKey : onComplete;

        HEYS.StepModal.show({
          steps: ['measurements'],
          title: '–ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞',
          showProgress: false,
          context: { dateKey: actualDateKey || new Date().toISOString().slice(0, 10) },
          onComplete: actualOnComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ –¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π
    deficit: (dateKey, onComplete) => {
      if (HEYS.StepModal) {
        HEYS.StepModal.show({
          steps: ['deficit'],
          title: '–¶–µ–ª—å –∫–∞–ª–æ—Ä–∏–π',
          showProgress: false,
          context: { dateKey: dateKey || new Date().toISOString().slice(0, 10) },
          onComplete
        });
      }
    },

    // –¢–æ–ª—å–∫–æ –≤–∏—Ç–∞–º–∏–Ω—ã
    supplements: (dateKey, onComplete) => {
      if (HEYS.StepModal) {
        HEYS.StepModal.show({
          steps: ['supplements'],
          title: 'üíä –í–∏—Ç–∞–º–∏–Ω—ã',
          showProgress: false,
          context: { dateKey: dateKey || new Date().toISOString().slice(0, 10) },
          onComplete
        });
      }
    },

    // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏ (—á–µ—Ä–µ–∑ MealStep)
    meal: (dateKey, onComplete) => {
      if (HEYS.MealStep) {
        HEYS.MealStep.showAddMeal({
          dateKey: dateKey || new Date().toISOString().slice(0, 10),
          onComplete
        });
      } else if (HEYS.StepModal) {
        // Fallback –µ—Å–ª–∏ MealStep –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        HEYS.StepModal.show({
          steps: ['mealTime', 'mealMood'],
          title: '–ù–æ–≤—ã–π –ø—Ä–∏—ë–º',
          showProgress: true,
          showStreak: false,
          showGreeting: false,
          showTip: false,
          context: { dateKey: dateKey || new Date().toISOString().slice(0, 10) },
          onComplete
        });
      }
    }
  };

  // console.log('[HEYS] MorningCheckin v2 loaded (using StepModal)');

})(typeof window !== 'undefined' ? window : global);

/* ===== heys_monthly_reports_service_v1.js ===== */
// heys_monthly_reports_service_v1.js ‚Äî Monthly reports data builder + cache

; (function (global) {
    const HEYS = global.HEYS = global.HEYS || {};

    function pad2(n) { return String(n).padStart(2, '0'); }
    function fmtDate(d) { return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate()); }

    function getClientId() {
        return HEYS.store?.getCurrentProfile?.()?.id || 'guest';
    }

    function getStorageKey(key) {
        const clientId = getClientId();
        const encrypted = ['heys_profile', 'heys_hr_zones'].includes(key) || key.startsWith('heys_dayv2_');
        return encrypted ? `${key}_${clientId}` : key;
    }

    function getLsGet() {
        return (key, fallback) => {
            try {
                if (HEYS.store?.get) return HEYS.store.get(key, fallback);
                if (HEYS.utils?.lsGet) return HEYS.utils.lsGet(key, fallback);

                const storageKey = getStorageKey(key);
                const stored = localStorage.getItem(storageKey) || localStorage.getItem(key);
                if (!stored) return fallback;
                if (storageKey !== key && HEYS.StorageLayer?.decrypt) {
                    try {
                        const decrypted = HEYS.StorageLayer.decrypt(stored);
                        return JSON.parse(decrypted);
                    } catch (e) {
                        return fallback;
                    }
                }
                return JSON.parse(stored);
            } catch (e) {
                return fallback;
            }
        };
    }

    function getSignature({ weeksCount, profile, dateKeys }) {
        const parts = [
            getClientId(),
            JSON.stringify(profile || {})
        ];

        dateKeys.forEach((dateStr) => {
            const key = getStorageKey(`heys_dayv2_${dateStr}`);
            const raw = localStorage.getItem(key) || localStorage.getItem(`heys_dayv2_${dateStr}`) || '';
            parts.push(`${dateStr}:${raw.length}`);
        });

        parts.push(`weeks:${weeksCount}`);
        return parts.join('|');
    }

    function buildDateKeys({ weeksCount, now }) {
        const keys = [];
        for (let weekOffset = 0; weekOffset < weeksCount; weekOffset++) {
            const anchorDate = new Date(now);
            anchorDate.setDate(anchorDate.getDate() - (7 * weekOffset));

            const dayOfWeek = anchorDate.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(anchorDate);
            monday.setDate(anchorDate.getDate() + diff);

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + i);
                keys.push(fmtDate(dayDate));
            }
        }
        return keys;
    }

    function buildMonthlyWeeks({ weeksCount = 8, useCache = true } = {}) {
        const lsGet = getLsGet();
        const profile = lsGet('heys_profile', {});
        const pIndex = HEYS.products?.buildIndex?.();

        if (!HEYS.weeklyReports?.buildWeekReport) return [];

        const now = new Date();
        const nowDateStr = fmtDate(now);
        const dateKeys = buildDateKeys({ weeksCount, now });
        const signature = getSignature({ weeksCount, profile, dateKeys });

        const cache = HEYS.monthlyReportsService?.cache;
        if (useCache && cache && cache.signature === signature && Array.isArray(cache.weeks)) {
            return cache.weeks;
        }

        const weeks = [];

        for (let weekOffset = 0; weekOffset < weeksCount; weekOffset++) {
            const anchorDate = new Date(now);
            anchorDate.setDate(anchorDate.getDate() - (7 * weekOffset));

            const dayOfWeek = anchorDate.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(anchorDate);
            monday.setDate(anchorDate.getDate() + diff);

            const mondayStr = fmtDate(monday);
            const sundayDate = new Date(monday);
            sundayDate.setDate(monday.getDate() + 6);
            const sundayStr = fmtDate(sundayDate);

            const days = [];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + i);
                const dateStr = fmtDate(dayDate);
                const dayData = lsGet(`heys_dayv2_${dateStr}`, null);
                if (dayData) {
                    days.push({ ...dayData, dateStr });
                }
            }

            const report = HEYS.weeklyReports.buildWeekReport({
                dateStr: mondayStr,
                endDateStr: sundayStr,
                lsGet,
                profile,
                pIndex,
                filterEmptyDays: true
            });

            if (report.daysWithData >= 2) {
                const dayMap = new Map(days.map((d) => [d.dateStr, d]));
                const visibleDays = (report.days || []).filter((d) => {
                    const hasMeals = d.hasMeals;
                    const isToday = d.dateStr === nowDateStr;
                    const ratio = d.ratio || 0;
                    return hasMeals && !(isToday && ratio < 0.5);
                });

                const weights = visibleDays
                    .map((d) => dayMap.get(d.dateStr)?.weightMorning)
                    .filter((w) => w && w > 0);

                const avgWeight = weights.length > 0
                    ? Math.round(weights.reduce((s, w) => s + w, 0) / weights.length * 10) / 10
                    : (profile.weight || 0);

                const reportDays = (report.days || []).map((d) => {
                    const sourceDay = dayMap.get(d.dateStr);
                    return {
                        ...d,
                        weightMorning: Number.isFinite(sourceDay?.weightMorning) ? sourceDay.weightMorning : 0
                    };
                });

                const mondayLabel = monday.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                const sundayLabel = sundayDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                const rangeLabel = `${mondayLabel} ‚Äì ${sundayLabel}`;

                weeks.push({
                    rangeLabel,
                    monday: mondayStr,
                    sunday: sundayStr,
                    report: { ...report, avgWeight, days: reportDays },
                    isCurrent: weekOffset === 0
                });
            }
        }

        HEYS.monthlyReportsService.cache = {
            signature,
            weeks,
            ts: Date.now()
        };

        return weeks;
    }

    function buildMonthlyMonths({ weeksCount = 16, useCache = true } = {}) {
        const weeks = buildMonthlyWeeks({ weeksCount, useCache });
        if (!weeks.length) return [];

        const now = new Date();
        const currentMonthKey = now.getFullYear() + '-' + pad2(now.getMonth() + 1);
        const monthMap = new Map();

        weeks.forEach((week) => {
            if (!week?.monday) return;
            const mondayDate = new Date(week.monday);
            if (Number.isNaN(mondayDate.getTime())) return;
            const key = mondayDate.getFullYear() + '-' + pad2(mondayDate.getMonth() + 1);
            if (!monthMap.has(key)) {
                monthMap.set(key, { key, weeks: [] });
            }
            monthMap.get(key).weeks.push(week);
        });

        const months = [];
        monthMap.forEach((bucket) => {
            if (!bucket?.weeks?.length) return;
            const isCurrentMonth = bucket.key === currentMonthKey;
            if (!isCurrentMonth && bucket.weeks.length < 4) return;

            const total = bucket.weeks.length;
            const sum = bucket.weeks.reduce((acc, week) => {
                const report = week.report || {};
                acc.avgTarget += report.avgTarget || 0;
                acc.avgKcal += report.avgKcal || 0;
                acc.targetDeficitPct += report.targetDeficitPct || 0;
                acc.avgDeltaPct += report.avgDeltaPct || 0;
                acc.avgProt += report.avgProt || 0;
                acc.avgNormProt += report.avgNormProt || 0;
                acc.avgFat += report.avgFat || 0;
                acc.avgNormFat += report.avgNormFat || 0;
                acc.avgCarbs += report.avgCarbs || 0;
                acc.avgNormCarbs += report.avgNormCarbs || 0;
                acc.avgWeight += report.avgWeight || 0;
                acc.daysWithData += report.daysWithData || 0;
                return acc;
            }, {
                avgTarget: 0,
                avgKcal: 0,
                targetDeficitPct: 0,
                avgDeltaPct: 0,
                avgProt: 0,
                avgNormProt: 0,
                avgFat: 0,
                avgNormFat: 0,
                avgCarbs: 0,
                avgNormCarbs: 0,
                avgWeight: 0,
                daysWithData: 0
            });

            const monthStart = new Date(bucket.weeks[bucket.weeks.length - 1].monday);
            const monthLabel = monthStart.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });

            months.push({
                rangeLabel: monthLabel,
                monthKey: bucket.key,
                report: {
                    avgTarget: Math.round(sum.avgTarget / total),
                    avgKcal: Math.round(sum.avgKcal / total),
                    targetDeficitPct: Math.round(sum.targetDeficitPct / total),
                    avgDeltaPct: Math.round(sum.avgDeltaPct / total),
                    avgProt: sum.avgProt / total,
                    avgNormProt: sum.avgNormProt / total,
                    avgFat: sum.avgFat / total,
                    avgNormFat: sum.avgNormFat / total,
                    avgCarbs: sum.avgCarbs / total,
                    avgNormCarbs: sum.avgNormCarbs / total,
                    avgWeight: Math.round(sum.avgWeight / total * 10) / 10,
                    daysWithData: sum.daysWithData
                },
                isCurrent: isCurrentMonth
            });
        });

        return months;
    }

    HEYS.monthlyReportsService = {
        buildMonthlyWeeks,
        buildMonthlyMonths,
        cache: HEYS.monthlyReportsService?.cache || null
    };
})(window);


/* ===== heys_monthly_reports_v1.js ===== */
// heys_monthly_reports_v1.js ‚Äî Monthly reports (weekly cards)

; (function (global) {
    const HEYS = global.HEYS = global.HEYS || {};
    const React = global.React;

    function WeekCard({ week, prevWeek, weightGoal }) {
        const h = React.createElement;
        const { useMemo, useState } = React;
        const { report, rangeLabel, isCurrent } = week;
        const daysWithData = Number.isFinite(report?.daysWithData) ? report.daysWithData : 0;
        const daysLabel = daysWithData > 0 ? ` (—É—á—Ç–µ–Ω–æ ${daysWithData} –¥–Ω–µ–π)` : '';

        const formatMacroDiff = (value, norm) => {
            if (!Number.isFinite(value) || !Number.isFinite(norm) || norm === 0) return '‚Äî';
            const diff = Math.round(value - norm);
            const sign = diff > 0 ? '+' : '';
            return sign + diff;
        };

        const getMacroDiffTone = (value, norm, preferHigher) => {
            if (!Number.isFinite(value) || !Number.isFinite(norm) || norm === 0) return 'monthly-macro-diff-value--neutral';
            const diff = value - norm;
            if (diff === 0) return 'monthly-macro-diff-value--neutral';
            if (preferHigher) {
                return diff > 0 ? 'monthly-macro-diff-value--good' : 'monthly-macro-diff-value--bad';
            }
            return diff < 0 ? 'monthly-macro-diff-value--good' : 'monthly-macro-diff-value--bad';
        };

        const deficitPctClass = report.avgDeltaPct > 0
            ? 'monthly-metric-value--surplus'
            : report.avgDeltaPct < 0
                ? 'monthly-metric-value--deficit'
                : 'monthly-metric-value--neutral';

        const targetPctClass = report.targetDeficitPct > 0
            ? 'monthly-metric-value--surplus'
            : report.targetDeficitPct < 0
                ? 'monthly-metric-value--deficit'
                : 'monthly-metric-value--neutral';

        const getWeightTrend = () => {
            const currentWeight = Number.isFinite(report?.avgWeight) ? report.avgWeight : 0;
            const prevWeight = Number.isFinite(prevWeek?.report?.avgWeight) ? prevWeek.report.avgWeight : 0;

            if (!currentWeight || !prevWeight) return null;

            const diff = currentWeight - prevWeight;
            if (Math.abs(diff) < 0.05) {
                return { symbol: '‚Üí', tone: 'monthly-weight-trend--neutral', diff: 0 };
            }

            const symbol = diff > 0 ? '‚Üë' : '‚Üì';
            const goal = Number.isFinite(weightGoal) && weightGoal > 0 ? weightGoal : 0;
            if (!goal) {
                return { symbol, tone: 'monthly-weight-trend--neutral', diff };
            }

            const needDown = currentWeight - goal > 0.2;
            const needUp = currentWeight - goal < -0.2;
            if (needDown) {
                return { symbol, tone: diff < 0 ? 'monthly-weight-trend--good' : 'monthly-weight-trend--bad', diff };
            }
            if (needUp) {
                return { symbol, tone: diff > 0 ? 'monthly-weight-trend--good' : 'monthly-weight-trend--bad', diff };
            }

            return { symbol, tone: 'monthly-weight-trend--neutral', diff };
        };

        const weightValue = Number.isFinite(report?.avgWeight) && report.avgWeight > 0
            ? report.avgWeight
            : '‚Äî';
        const weightTrend = getWeightTrend();
        const canExpandDays = Array.isArray(report?.days) && report.days.length > 0;
        const [isExpanded, setIsExpanded] = useState(false);

        const dayRows = useMemo(() => {
            if (!Array.isArray(report?.days)) return [];

            return report.days.map((d) => {
                const date = new Date(d.dateStr);
                const dayLabel = Number.isNaN(date.getTime())
                    ? d.dateStr
                    : date.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });

                const burned = Number.isFinite(d.burned) && d.burned > 0
                    ? d.burned
                    : (Number.isFinite(d.optimum) ? d.optimum : 0);
                const eaten = d.totals?.kcal || 0;
                const goal = d.goalOptimum || 0;
                const targetPct = burned > 0 ? Math.round(((goal - burned) / burned) * 100) : 0;
                const factPct = burned > 0 ? Math.round(((eaten - burned) / burned) * 100) : 0;
                const hasMeals = !!d.hasMeals;
                const isIncluded = hasMeals && !(d.isToday && (d.ratio || 0) < 0.5);
                const weightMorning = Number.isFinite(d.weightMorning) && d.weightMorning > 0
                    ? Math.round(d.weightMorning * 10) / 10
                    : '‚Äî';
                const deficit = eaten - burned;

                return {
                    dateStr: d.dateStr,
                    dayLabel,
                    isToday: !!d.isToday,
                    hasMeals,
                    isIncluded,
                    burned,
                    eaten,
                    goal,
                    deficit,
                    targetPct,
                    factPct,
                    prot: d.totals?.prot || 0,
                    fat: d.totals?.fat || 0,
                    carbs: d.totals?.carbs || 0,
                    normProt: d.normAbs?.prot || 0,
                    normFat: d.normAbs?.fat || 0,
                    normCarbs: d.normAbs?.carbs || 0,
                    weightMorning
                };
            });
        }, [report]);

        const includedDayRows = useMemo(() => dayRows.filter((d) => d.isIncluded), [dayRows]);

        const breakdownTotals = useMemo(() => {
            const totals = includedDayRows.reduce((acc, d) => {
                acc.burned += d.burned || 0;
                acc.eaten += d.eaten || 0;
                acc.goal += d.goal || 0;
                acc.deficit += d.deficit || 0;
                return acc;
            }, {
                burned: 0,
                eaten: 0,
                goal: 0,
                deficit: 0
            });
            const count = includedDayRows.length || 1;
            return {
                ...totals,
                count,
                avgBurned: totals.burned / count,
                avgEaten: totals.eaten / count,
                avgGoal: totals.goal / count,
                avgDeficit: totals.deficit / count
            };
        }, [includedDayRows]);

        const getTargetToneClass = (value, target) => {
            if (!Number.isFinite(value)) return 'weekly-wrap-breakdown__value--neutral';
            if (value === 0) return 'weekly-wrap-breakdown__value--neutral';
            if (target > 0) {
                return value > 0
                    ? 'weekly-wrap-breakdown__value--good'
                    : 'weekly-wrap-breakdown__value--bad';
            }
            if (target < 0) {
                return value < 0
                    ? 'weekly-wrap-breakdown__value--good'
                    : 'weekly-wrap-breakdown__value--bad';
            }
            return value < 0
                ? 'weekly-wrap-breakdown__value--good'
                : 'weekly-wrap-breakdown__value--bad';
        };

        const getDeltaToneClass = (value, target) => {
            if (!Number.isFinite(value)) return 'weekly-wrap-breakdown__value--neutral';
            if (value === 0) return 'weekly-wrap-breakdown__value--neutral';
            if (target > 0) {
                return value > 0
                    ? 'weekly-wrap-breakdown__value--good'
                    : 'weekly-wrap-breakdown__value--bad';
            }
            if (target < 0) {
                return value < 0
                    ? 'weekly-wrap-breakdown__value--good'
                    : 'weekly-wrap-breakdown__value--bad';
            }
            return value < 0
                ? 'weekly-wrap-breakdown__value--good'
                : 'weekly-wrap-breakdown__value--bad';
        };

        const formatSignedValue = (value, suffix = '') => {
            const rounded = Math.round(value);
            const sign = rounded > 0 ? '+' : '';
            return sign + rounded + suffix;
        };

        const formatDeficitWithPct = (deficitValue, burnedValue) => {
            const pct = burnedValue ? (deficitValue / burnedValue) * 100 : 0;
            return formatSignedValue(deficitValue) + ' / ' + formatSignedValue(pct, '%');
        };

        const targetPct = report?.targetDeficitPct ?? 0;
        const avgGoalPct = breakdownTotals.avgBurned
            ? ((breakdownTotals.avgGoal - breakdownTotals.avgBurned) / breakdownTotals.avgBurned) * 100
            : 0;

        const toggleExpanded = () => {
            setIsExpanded((prev) => {
                const next = !prev;
                console.info('[HEYS.monthlyReports] ‚úÖ Week days toggled:', {
                    week: rangeLabel,
                    expanded: next,
                    dayRows: includedDayRows.length
                });
                return next;
            });
        };

        return h('div', { className: 'monthly-week-card' + (isCurrent ? ' monthly-week-card--current' : '') },
            h('div', { className: 'monthly-week-card__header' },
                h('div', { className: 'monthly-week-card__title' }, rangeLabel + daysLabel),
                h('div', { className: 'monthly-week-card__header-actions' },
                    isCurrent && h('span', { className: 'monthly-week-card__badge' }, '—Ç–µ–∫—É—â–∞—è'),
                    canExpandDays && h('button', {
                        type: 'button',
                        className: 'monthly-week-card__expand-btn' + (isExpanded ? ' monthly-week-card__expand-btn--open' : ''),
                        onClick: toggleExpanded,
                        'aria-expanded': isExpanded,
                        'aria-label': isExpanded ? '–°–∫—Ä—ã—Ç—å –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏'
                    },
                        h('span', { className: 'monthly-week-card__expand-btn-label' }, '–¥–Ω–∏'),
                        h('span', { className: 'monthly-week-card__expand-btn-icon' }, isExpanded ? '‚ñ¥' : '‚ñæ')
                    )
                )
            ),
            h('div', { className: 'monthly-week-card__metrics' },
                h('div', { className: 'monthly-metric-block' },
                    h('div', { className: 'monthly-metric-icon' }, 'üî•'),
                    h('div', { className: 'monthly-metric-value' }, Math.round(report.avgTarget || 0)),
                    h('div', { className: 'monthly-metric-label' }, '–∑–∞—Ç—Ä–∞—Ç—ã')
                ),
                h('div', { className: 'monthly-metric-block' },
                    h('div', { className: 'monthly-metric-icon' }, 'üçΩÔ∏è'),
                    h('div', { className: 'monthly-metric-value' }, Math.round(report.avgKcal || 0)),
                    h('div', { className: 'monthly-metric-label' }, '—Å—ä–µ–¥–µ–Ω–æ')
                ),
                h('div', { className: 'monthly-metric-block' },
                    h('div', { className: 'monthly-metric-icon' }, 'üéØ'),
                    h('div', { className: 'monthly-metric-value ' + targetPctClass },
                        (report.targetDeficitPct > 0 ? '+' : '') + report.targetDeficitPct + '%'
                    ),
                    h('div', { className: 'monthly-metric-label' }, '—Ü–µ–ª—å')
                ),
                h('div', { className: 'monthly-metric-block' },
                    h('div', { className: 'monthly-metric-icon' }, 'üìä'),
                    h('div', { className: 'monthly-metric-value ' + deficitPctClass },
                        (report.avgDeltaPct > 0 ? '+' : '') + report.avgDeltaPct + '%'
                    ),
                    h('div', { className: 'monthly-metric-label' }, '—Ñ–∞–∫—Ç')
                ),
                h('div', { className: 'monthly-metric-block monthly-metric-block--macros' },
                    h('div', { className: 'monthly-macro-diffs' },
                        h('div', { className: 'monthly-macro-diff' },
                            h('span', { className: 'monthly-macro-diff-label' }, '–ë'),
                            h('span', { className: 'monthly-macro-diff-value ' + getMacroDiffTone(report.avgProt, report.avgNormProt, true) },
                                formatMacroDiff(report.avgProt, report.avgNormProt)
                            )
                        ),
                        h('div', { className: 'monthly-macro-diff' },
                            h('span', { className: 'monthly-macro-diff-label' }, '–ñ'),
                            h('span', { className: 'monthly-macro-diff-value ' + getMacroDiffTone(report.avgFat, report.avgNormFat, false) },
                                formatMacroDiff(report.avgFat, report.avgNormFat)
                            )
                        ),
                        h('div', { className: 'monthly-macro-diff' },
                            h('span', { className: 'monthly-macro-diff-label' }, '–£'),
                            h('span', { className: 'monthly-macro-diff-value ' + getMacroDiffTone(report.avgCarbs, report.avgNormCarbs, false) },
                                formatMacroDiff(report.avgCarbs, report.avgNormCarbs)
                            )
                        )
                    )
                ),
                h('div', { className: 'monthly-metric-block' },
                    h('div', { className: 'monthly-metric-icon' }, '‚öñÔ∏è'),
                    h('div', { className: 'monthly-metric-value' }, weightValue),
                    weightTrend && weightTrend.diff != null
                        ? h('div', { className: 'monthly-weight-trend-sub ' + weightTrend.tone },
                            weightTrend.symbol,
                            Math.abs(weightTrend.diff).toFixed(1)
                        )
                        : null,
                    h('div', { className: 'monthly-metric-label' }, '—Å—Ä–µ–¥–Ω–∏–π –≤–µ—Å')
                )
            ),
            canExpandDays && isExpanded
                ? h('div', { className: 'monthly-week-days' },
                    h('div', { className: 'weekly-wrap-breakdown monthly-week-breakdown', onClick: (e) => e.stopPropagation() },
                        h('div', { className: 'weekly-wrap-breakdown__header' },
                            h('div', { className: 'weekly-wrap-breakdown__title' }, 'üßæ –î–Ω–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ'),
                            h('div', { className: 'weekly-wrap-breakdown__subtitle' }, includedDayRows.length + ' –¥–Ω.')
                        ),
                        report?.todayExcluded && h('div', { className: 'weekly-wrap-breakdown__note' },
                            '–°–µ–≥–æ–¥–Ω—è –Ω–µ —É—á—Ç—ë–Ω: –º–µ–Ω–µ–µ 50% –Ω–æ—Ä–º—ã'
                        ),
                        h('div', { className: 'weekly-wrap-breakdown__table' },
                            h('div', { className: 'weekly-wrap-breakdown__row weekly-wrap-breakdown__row--head' },
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--day' }, '–î–µ–Ω—å'),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, '–ó–∞—Ç—Ä–∞—Ç—ã'),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, '–°—ä–µ–¥–µ–Ω–æ'),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, '–¶–µ–ª—å'),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, '–î–µ—Ñ–∏—Ü–∏—Ç', h('br'), '–æ—Ç –ø–æ—Ç—Ä–∞—á.')
                            ),
                            ...includedDayRows.map((day, i) => {
                                const goalPct = day.burned ? ((day.goal - day.burned) / day.burned) * 100 : 0;
                                const goalPctClass = getTargetToneClass(goalPct, targetPct);
                                const toneClass = getDeltaToneClass(day.deficit, targetPct);
                                return h('div', { key: day.dateStr || i, className: 'weekly-wrap-breakdown__row' },
                                    h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--day' }, day.dayLabel),
                                    h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(day.burned)),
                                    h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(day.eaten)),
                                    h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--goal' },
                                        Math.round(day.goal),
                                        ' ',
                                        h('span', { className: 'weekly-wrap-breakdown__goal-pct ' + goalPctClass },
                                            '(' + (goalPct > 0 ? '+' : '') + Math.round(goalPct) + '%)'
                                        )
                                    ),
                                    h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--delta ' + toneClass },
                                        formatDeficitWithPct(day.deficit, day.burned)
                                    )
                                );
                            }),
                            h('div', { className: 'weekly-wrap-breakdown__row weekly-wrap-breakdown__row--total' },
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--day' }, '–ò—Ç–æ–≥–æ –≤ —Å—Ä–µ–¥–Ω–µ–º'),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(breakdownTotals.avgBurned)),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(breakdownTotals.avgEaten)),
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--goal' },
                                    Math.round(breakdownTotals.avgGoal),
                                    ' ',
                                    h('span', { className: 'weekly-wrap-breakdown__goal-pct ' + getTargetToneClass(avgGoalPct, targetPct) },
                                        '(' + (avgGoalPct > 0 ? '+' : '') + Math.round(avgGoalPct) + '%)'
                                    )
                                ),
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--delta ' + getDeltaToneClass(breakdownTotals.avgDeficit, targetPct) },
                                    formatDeficitWithPct(breakdownTotals.avgDeficit, breakdownTotals.avgBurned)
                                )
                            )
                        )
                    )
                )
                : null
        );
    }

    function MonthlyReportsContent() {
        const { useState } = React;
        const monthlyReportsService = HEYS.monthlyReportsService;
        const monthlyWeeks = monthlyReportsService && monthlyReportsService.buildMonthlyWeeks
            ? monthlyReportsService.buildMonthlyWeeks({ weeksCount: 16, useCache: true })
            : [];
        const monthlyMonths = monthlyReportsService && monthlyReportsService.buildMonthlyMonths
            ? monthlyReportsService.buildMonthlyMonths({ weeksCount: 16, useCache: true })
            : [];
        const profile = HEYS.store?.get
            ? HEYS.store.get('heys_profile', {})
            : (HEYS.utils?.lsGet ? HEYS.utils.lsGet('heys_profile', {}) : {});
        const weightGoal = +profile.weightGoal || 0;
        const [mode, setMode] = useState('weeks');

        if (!monthlyReportsService || !monthlyReportsService.buildMonthlyWeeks) {
            return React.createElement('div', { className: 'muted' }, '–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–∏—Å –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤...');
        }

        if (monthlyWeeks.length === 0) {
            return React.createElement('div', { className: 'muted' }, '–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 –¥–Ω—è —Å –µ–¥–æ–π –≤ –Ω–µ–¥–µ–ª—é ‚Äî –∏ –ø–æ—è–≤—è—Ç—Å—è –æ—Ç—á—ë—Ç—ã');
        }

        const cards = mode === 'months' ? monthlyMonths : monthlyWeeks;
        const emptyMonths = mode === 'months' && cards.length === 0;

        return React.createElement(React.Fragment, null,
            React.createElement('div', { className: 'monthly-reports-tabs' },
                React.createElement('button', {
                    className: 'monthly-reports-tab' + (mode === 'weeks' ? ' monthly-reports-tab--active' : ''),
                    onClick: () => setMode('weeks')
                }, '–ù–µ–¥–µ–ª—è'),
                React.createElement('button', {
                    className: 'monthly-reports-tab' + (mode === 'months' ? ' monthly-reports-tab--active' : ''),
                    onClick: () => setMode('months')
                }, '–ú–µ—Å—è—Ü')
            ),
            emptyMonths
                ? React.createElement('div', { className: 'muted' }, '–î–ª—è –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 4 –Ω–µ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö')
                : React.createElement('div', { className: 'monthly-reports-grid' },
                    ...cards.map((week, i) => React.createElement(WeekCard, {
                        key: i,
                        week,
                        prevWeek: cards[i + 1],
                        weightGoal
                    }))
                )
        );
    }

    HEYS.monthlyReports = {
        MonthlyReportsContent
    };
})(window);


/* ===== heys_reports_tab_impl_v1.js ===== */
// heys_reports_tab_impl_v1.js ‚Äî Reports: 4-week tables + lazy Chart.js modals (extracted)

; (function (global) {
    const HEYS = global.HEYS = global.HEYS || {};
    const React = global.React;

    // ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
    function pad2(n) { return String(n).padStart(2, '0'); }
    function fmtDate(d) { return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate()); }
    function round1(x) { return Math.round((+x || 0) * 10) / 10; }
    function toNum(x) { const v = +x; return Number.isFinite(v) ? v : 0; }
    function pct(part, total) { if (!total) return 0; return Math.round((part / total) * 1000) / 10; }
    // –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è r1 –∏–∑ heys_day_v12.js –¥–ª—è –∏–¥–µ–Ω—Ç–∏—á–Ω—ã—Ö –æ–∫—Ä—É–≥–ª–µ–Ω–∏–π
    const r1 = v => Math.round((+v || 0) * 10) / 10;

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —Å–Ω–∞
    function parseTime(timeStr) {
        if (!timeStr) return null;
        const m = String(timeStr).match(/^(\d{1,2}):(\d{2})$/);
        return m ? { hh: +m[1], mm: +m[2] } : null;
    }
    function sleepHours(startTime, endTime) {
        const s = parseTime(startTime), e = parseTime(endTime);
        if (!s || !e) return 0;
        let sh = s.hh + s.mm / 60, eh = e.hh + e.mm / 60;
        let d = eh - sh;
        if (d < 0) d += 24;
        return round1(d);
    }

    // ---------- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π ----------
    const dayCache = new Map();
    const maxCacheSize = 200; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π

    // –ö—ç—à –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–µ–¥–µ–ª—å
    const weekCache = new Map();
    const maxWeekCacheSize = 20;

    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    function invalidateCache(pattern) {
        const keysToDelete = [];
        for (const key of dayCache.keys()) {
            if (!pattern || key.includes(pattern)) {
                keysToDelete.push(key);
            }
        }
        keysToDelete.forEach(key => dayCache.delete(key));

        // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –∫—ç—à –Ω–µ–¥–µ–ª—å –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –¥–Ω–∏
        if (pattern) {
            weekCache.clear();
        }

        if (window.HEYS && window.HEYS.performance) {
            window.HEYS.performance.increment('cacheInvalidations');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    function clearAllCache() {
        dayCache.clear();
        DEV.log('–ö—ç—à –æ—Ç—á–µ—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω');
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if (window.HEYS) {
        window.HEYS.clearReportsCache = clearAllCache;
        window.HEYS.debug = true; // –≤–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–∫—É
    }

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π
    function setupCacheInvalidation() {
        if (window.HEYS && window.HEYS.store && typeof window.HEYS.store.watch === 'function') {
            // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–Ω–µ–π
            const currentDate = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                const dateStr = fmtDate(date);

                window.HEYS.store.watch(`dayv2_${dateStr}`, () => {
                    invalidateCache(dateStr);
                });
            }

            // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª—è
            window.HEYS.store.watch('products', () => {
                invalidateCache(); // –ü–æ–ª–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
            });

            window.HEYS.store.watch('profile', () => {
                invalidateCache(); // –ü–æ–ª–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
            });

            window.HEYS.store.watch('hr_zones', () => {
                invalidateCache(); // –ü–æ–ª–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–æ–Ω
            });
        }
    }

    function getCacheKey(dateStr, products, profile, zones) {
        const productsHash = JSON.stringify(products).substring(0, 100); // –£—Å–µ—á–µ–Ω–Ω—ã–π —Ö—ç—à –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const profileHash = JSON.stringify(profile);
        const zonesHash = JSON.stringify(zones);
        return `${dateStr}:${productsHash}:${profileHash}:${zonesHash}`;
    }

    function getCachedDay(dateStr, prodIndex, profile, zones, products) {
        // –î–ª—è –∞–±—Å–æ–ª—é—Ç–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ ¬´–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –¥–Ω—è¬ª –æ—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à:
        // –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–µ–Ω—å –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ heys_dayv2_YYYY-MM-DD.
        return (window.HEYS && window.HEYS.performance && window.HEYS.performance.measure)
            ? window.HEYS.performance.measure('reportCalculation', () => collectDayInternal(dateStr, prodIndex, profile, zones))
            : collectDayInternal(dateStr, prodIndex, profile, zones);
    }

    // ---------- –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ----------
    function buildProductIndex(products) {
        const byName = new Map();
        const byId = new Map();
        const byFingerprint = new Map(); // üÜï v4.6.0
        (products || []).forEach(p => {
            const nm = String(p.name || p.title || '').trim().toLowerCase();
            if (nm) byName.set(nm, p);
            if (p.id != null) byId.set(String(p.id), p);
            if (p.product_id != null) byId.set(String(p.product_id), p);
            if (p.fingerprint) byFingerprint.set(p.fingerprint, p); // üÜï v4.6.0
        });
        return { byName, byId, byFingerprint };
    }

    // ---------- –ï–¥–∞ –∑–∞ –¥–µ–Ω—å -> —Å—É–º–º—ã ----------
    function aggregateDay(meals, prodIndex) {
        let total = { kcal: 0, carbs: 0, prot: 0, fat: 0, simple: 0, complex: 0, badFat: 0, goodFat: 0, trans: 0, fiber: 0, giSum: 0, giCnt: 0, harmSum: 0, harmCnt: 0 };
        (meals || []).forEach(m => {
            const items = (m && (m.items || m.food || m.list || m.products)) || [];
            items.forEach(it => {
                const grams = +(it.grams != null ? it.grams : it.g) || +(it.qty || 0) || +(it.weight || 0) || 0;
                let p = null;
                // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ω–æ–≤—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                const nm = String(it.name || it.title || '').trim().toLowerCase();
                if (nm) p = prodIndex.byName.get(nm);
                // üÜï v4.6.0: –ü–æ–∏—Å–∫ –ø–æ fingerprint
                if (!p && it.fingerprint) p = prodIndex.byFingerprint?.get(it.fingerprint);
                // Fallback –Ω–∞ product_id/id –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                if (!p && it.product_id != null) p = prodIndex.byId.get(String(it.product_id));
                if (!p && it.productId != null) p = prodIndex.byId.get(String(it.productId));
                if (!p && it.id != null && typeof it.name !== 'string') p = prodIndex.byId.get(String(it.id));
                // Fallback –Ω–∞ inline –¥–∞–Ω–Ω—ã–µ
                if (!p && (it.kcal100 !== undefined || it.protein100 !== undefined)) p = it;
                if (!p || !grams) return;

                const k = grams / 100;
                const kcal100 = +p.kcal100 || 0;
                const carbs100 = +p.carbs100 || ((+p.simple100 || 0) + (+p.complex100 || 0));
                const prot100 = +p.protein100 || (+p.prot100 || 0);
                const fat100 = +p.fat100 || ((+p.badFat100 || 0) + (+p.goodFat100 || 0) + (+p.trans100 || 0));
                const simple100 = +p.simple100 || 0, complex100 = +p.complex100 || 0;
                const bad100 = +p.badFat100 || 0, good100 = +p.goodFat100 || 0, trans100 = +p.trans100 || 0;
                const fiber100 = +p.fiber100 || 0; const gi = +p.gi || 0; const harm = +p.harmScore || 0;

                total.kcal += kcal100 * k; total.carbs += carbs100 * k; total.prot += prot100 * k; total.fat += fat100 * k;
                total.simple += simple100 * k; total.complex += complex100 * k;
                total.badFat += bad100 * k; total.goodFat += good100 * k; total.trans += trans100 * k;
                total.fiber += fiber100 * k;
                if (gi > 0) { total.giSum += gi; total.giCnt++; }
                if (harm > 0) { total.harmSum += harm; total.harmCnt++; }
            });
        });
        return total;
    }

    // ---------- –ß—Ç–µ–Ω–∏–µ meals –∑–∞ –¥–∞—Ç—É (–¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ dayUtils –¥–ª—è —É—á—ë—Ç–∞ –Ω–æ—á–Ω–æ–π –ª–æ–≥–∏–∫–∏) ----------
    function loadMealsForDate(dateStr) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º dayUtils –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ—á–Ω—ã–µ –ø—Ä–∏—ë–º—ã 00:00-02:59)
        if (global.HEYS && global.HEYS.dayUtils && global.HEYS.dayUtils.loadMealsForDate) {
            return global.HEYS.dayUtils.loadMealsForDate(dateStr);
        }

        // Fallback: —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞
        const ls = global.localStorage;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        const clientId = window.HEYS && window.HEYS.currentClientId;
        const keys = [
            clientId ? `heys_${clientId}_dayv2_${dateStr}` : null,
            'heys_dayv2_' + dateStr,   // –æ–±—ä–µ–∫—Ç –¥–Ω—è —Å meals[]
            'heys_day_' + dateStr,     // —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–Ω—è
            'day_' + dateStr + '_meals', // –º–∞—Å—Å–∏–≤ –ø—Ä–∏—ë–º–æ–≤
            'meals_' + dateStr,        // –º–∞—Å—Å–∏–≤ –ø—Ä–∏—ë–º–æ–≤
            'food_' + dateStr          // –º–∞—Å—Å–∏–≤ –ø—Ä–∏—ë–º–æ–≤
        ].filter(Boolean);

        for (const k of keys) {
            try {
                const raw = ls.getItem(k);
                if (!raw) continue;
                const v = JSON.parse(raw);
                if (v && Array.isArray(v.meals)) return v.meals;
                if (Array.isArray(v)) return v;
            } catch (e) { }
        }
        return [];
    }

    // ---------- –≠–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç—ã ‚Üí HEYS.TDEE.calculate() ----------
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å HEYS.TDEE (heys_tdee_v1.js) –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤ BMR, TDEE, —à–∞–≥–æ–≤ –∏ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    // Dead code (calcBMR, kcalForSteps, kcalHousehold) —É–¥–∞–ª—ë–Ω 2025-01-12 ‚Äî —Å–º. collectDayInternal()

    // ---------- –°–±–æ—Ä –ø–æ –¥–Ω—é (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è) ----------
    function collectDayInternal(dateStr, prodIndex, profile, zones) {
        // –ñ—ë—Å—Ç–∫–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è —Å —Ç–µ–º –∂–µ —Å–∞–º—ã–º –æ–±—ä–µ–∫—Ç–æ–º –¥–Ω—è, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∫–ª–∞–¥–∫–∞ ¬´–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–Ω—è¬ª
        // 1) –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ–º day –∏–∑ —Ç–æ–≥–æ –∂–µ –∫–ª—é—á–∞, —á—Ç–æ –∏ DayTab: heys_dayv2_YYYY-MM-DD
        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const dayKey = 'heys_dayv2_' + dateStr;
        const storedDay = U.lsGet(dayKey, null);

        // 2) –ï—Å–ª–∏ –¥–Ω—è –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç DayTab (ensureDay —Å –ø—É—Å—Ç—ã–º–∏ –ø–æ–ª—è–º–∏)
        const baseDay = storedDay && storedDay.date ? storedDay : {
            date: dateStr,
            meals: [],
            trainings: [{ z: [0, 0, 0, 0] }, { z: [0, 0, 0, 0] }],
            steps: 0,
            householdMin: 0,
            weightMorning: profile.weight,
            sleepStart: '',
            sleepEnd: '',
            sleepQuality: '',
            sleepNote: '',
            dayScore: '',
            moodAvg: '',
            wellbeingAvg: '',
            stressAvg: '',
            dayComment: ''
        };

        const dayObj = baseDay;

        // 3) –ï–¥—É –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ dayObj.meals (–∞ –Ω–µ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π),
        //    —á—Ç–æ–±—ã –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä—è–ª–∞ —Å—É–º–º–∞—Ä–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –¥–Ω—è
        const meals = (dayObj && Array.isArray(dayObj.meals)) ? dayObj.meals : [];
        const totals = aggregateDay(meals, prodIndex);

        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ deficitPct –µ—Å—Ç—å (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–Ω–µ–π)
        if (dayObj.deficitPct == null) {
            dayObj.deficitPct = -14; // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }

        // =========================================================================
        // üî¨ TDEE v1.1.0: –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å HEYS.TDEE
        // =========================================================================

        const tdeeResult = HEYS.TDEE?.calculate?.(dayObj, profile, { lsGet: U.lsGet }) || {};
        const {
            bmr = 0,
            actTotal = 0,
            trainingsKcal = 0,
            train1k = 0,
            train2k = 0,
            stepsKcal: stepsK = 0,
            householdKcal: householdK = 0,
            tefKcal = 0,
            baseExpenditure = 0,
            tdee: dailyExp = 0,
            weight = profile.weight || 70
        } = tdeeResult;

        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –º–µ–∂–¥—É –î–Ω—ë–º –∏ –û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å—é
        // console.* –∑–∞–ø—Ä–µ—â—ë–Ω ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥ (–º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

        const energy = totals.prot * 3 + totals.carbs * 4 + totals.fat * 9; // NET Atwater
        const carbsPct = pct(totals.carbs * 4, energy);
        const protPct = pct(totals.prot * 3, energy);
        const fatPct = pct(totals.fat * 9, energy);
        const simplePct = pct(totals.simple, totals.carbs);
        const complexPct = pct(totals.complex, totals.carbs);
        const giAvg = totals.giCnt ? Math.round(totals.giSum / totals.giCnt) : 0;
        const harmAvg = totals.harmCnt ? Math.round((totals.harmSum / totals.harmCnt) * 10) / 10 : 0;

        // –ü–æ–¥—Å—á—ë—Ç –ø—Ä–∏—ë–º–æ–≤ —Å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º
        const mealsCount = (meals || []).filter(m => { const its = (m && (m.items || m.food || m.list || m.products)) || []; return its.length > 0; }).length;
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏–∑ –¥–Ω—è (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞) –∏–ª–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        const dayTargetDef = (dayObj.deficitPct !== '' && dayObj.deficitPct != null) ? +dayObj.deficitPct : +(profile.deficitPctTarget) || 0;
        // –£–±—Ä–∞–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∫–∞–ª–æ—Ä–∏–π
        // sleepComment –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ sleepNote (—Ä–∞–Ω–µ–µ) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–º –æ–±–∞ –ø–æ–ª—è
        const calculatedSleepHours = sleepHours(dayObj.sleepStart, dayObj.sleepEnd);
        return {
            dstr: dateStr, totals, bmr, activitySubtotal: actTotal, activitiesKcal: train1k + train2k,
            tefKcal, baseExpenditure, dailyExp, weight: weight, // üÜï v3.9.1: TEF –∏ baseExpenditure
            carbsPct, protPct, fatPct, simplePct, complexPct, giAvg, harmAvg,
            mealsCount, dayTargetDef, // –¥–æ–±–∞–≤–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –¥–Ω—è
            sleepHours: calculatedSleepHours || dayObj.sleepHours || 0, sleepQuality: dayObj.sleepQuality, sleepComment: (dayObj.sleepComment != null ? dayObj.sleepComment : dayObj.sleepNote),
            stressAvg: dayObj.stressAvg, wellbeingAvg: dayObj.wellbeingAvg, moodAvg: dayObj.moodAvg, dayComment: dayObj.dayComment
        };
    }

    // ---------- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—é ----------
    function collectDay(dateStr, prodIndex, profile, zones, products) {
        return getCachedDay(dateStr, prodIndex, profile, zones, products);
    }

    // ---------- –¢–∞–±–ª–∏—á–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫) ----------
    const HEADERS = [
        '–¥–∞—Ç–∞', '—É–≥–ª–µ–≤–æ–¥—ã', '–ø—Ä–æ—Å—Ç—ã–µ–£', '—Å–ª–æ–∂–Ω—ã–µ–£', '–±–µ–ª–∫–∏', '–∂–∏—Ä—ã', '–≤—Ä–µ–¥–Ω—ã–µ–ñ', '–ø–æ–ª–µ–∑–Ω–ñ', '—Å—É–ø–µ—Ä–≤—Ä–µ–¥–ñ', '–∫–ª–µ—Ç—á–∞—Ç–∫–∞', '–ì–ò', '–≤—Ä–µ–¥–Ω—Å—Ç—å', '',
        '–í–ï–°', '–û–±—â–∞—è\n–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '–¢—Ä–µ–Ω', '–û–±—â–∏–µ\n–∑–∞—Ç—Ä–∞—Ç—ã', '–¶–µ–ª–µ–≤–æ–π\n–¥–µ—Ñ–∏—Ü–∏—Ç%', '–ù—É–∂–Ω–æ\n—Å—ä–µ—Å—Ç—å', '—Å—ä–µ–¥–µ–Ω–æ\n–∑–∞ –¥–µ–Ω—å', '–§–∞–∫—Ç\n–¥–µ—Ñ–∏—Ü–∏—Ç\n%', '–î–µ—Ñ–∏—Ü–∏—Ç\n–∫–∫–∞–ª', '',
        '–ü—Ä–∏—ë–º–æ–≤', '–°–æ–Ω\n—á–∞—Å—ã', '–°–æ–Ω\n–∫–∞—á', '–°–æ–Ω\n–∫–æ–º–º–µ–Ω—Ç', '–°—Ç—Ä–µ—Å—Å', '–°–∞–º–æ—á', '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', '–î–µ–Ω—å\n–∫–æ–º–º–µ–Ω—Ç'
    ];
    function enrichDay(row, profile) {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫—ç—à–µ–º)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏–∑ –¥–Ω—è, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        const targetDef = (row.dayTargetDef != null ? row.dayTargetDef : +(profile.deficitPctTarget || 0));
        if (row.optimum == null) { row.optimum = row.dailyExp ? Math.round(row.dailyExp * (1 + targetDef / 100)) : 0; }
        if (row.defKcal == null) { row.defKcal = row.dailyExp ? Math.round((row.totals && row.totals.kcal || 0) - row.dailyExp) : 0; } // —Å—ä–µ–¥–µ–Ω–æ - –∑–∞—Ç—Ä–∞—Ç—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ = –¥–µ—Ñ–∏—Ü–∏—Ç)
        if (row.defPct == null) { row.defPct = row.dailyExp ? Math.round(row.defKcal / row.dailyExp * 100) : 0; }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        if (row.factDefPct == null) {
            const eatenKcal = (row.totals && row.totals.kcal || 0);
            row.factDefPct = row.dailyExp ? Math.round(((eatenKcal - row.dailyExp) / row.dailyExp) * 100) : 0;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç)
        if (row.factDefText == null) {
            const fact = row.factDefPct || 0;
            row.factDefText = (fact > 0 ? '+' : '') + fact + '%';
        }

        return row;
    }
    const ROW_H = '15px';
    const SUM_H = '20px';
    const DEV_H = '15px';
    function RowView({ row, profile }) {
        const t = row.totals; const baseStyle = { height: ROW_H, lineHeight: ROW_H, padding: '0 2px', textAlign: 'center' };
        const gray = '#6b7280'; // Changed color for empty values
        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const normsPerc = U.lsGet('heys_norms', {}) || {};

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ–¥–µ–Ω –ª–∏ –¥–µ–Ω—å –∫—É—Ä–∞—Ç–æ—Ä–æ–º (–≤–µ—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ)
        const baseWeight = +(profile.weight || 70);
        const dayWeight = +(row.weight || baseWeight);
        const isDayManaged = dayWeight !== baseWeight;

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        function computeNorms() {
            const K = +row.optimum || 0; // —Ü–µ–ª–µ–≤–∞—è –∫–∫–∞–ª –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
            const carbPct = +normsPerc.carbsPct || 0;
            const protPct = +normsPerc.proteinPct || 0;
            const fatPct = Math.max(0, 100 - carbPct - protPct);
            const carbs = K ? (K * carbPct / 100) / 4 : 0;
            const prot = K ? (K * protPct / 100) / 4 : 0;
            const fat = K ? (K * fatPct / 100) / 8 : 0;
            const simplePct = +normsPerc.simpleCarbPct || 0;
            const simple = carbs * simplePct / 100;
            const complex = Math.max(0, carbs - simple);
            const badPct = +normsPerc.badFatPct || 0;
            const transPct = +normsPerc.superbadFatPct || 0;
            const bad = fat * badPct / 100;
            const trans = fat * transPct / 100;
            const good = Math.max(0, fat - bad - trans);
            const fiberPct = +normsPerc.fiberPct || 0;
            const fiber = carbs * fiberPct / 100;
            const gi = +normsPerc.giPct || 0;
            const harm = +normsPerc.harmPct || 0;
            return { kcal: K, carbs, simple, complex, prot, fat, badFat: bad, goodFat: good, trans, fiber, gi, harm };
        }
        const norms = computeNorms();

        // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤
        function getColor(value, key, norms) {
            const f = +value || 0; const n = +norms[key] || 0;
            if (!n) return null; // –Ω–µ—Ç –Ω–æ—Ä–º—ã - –Ω–µ—Ç —Ü–≤–µ—Ç–∞
            const over = f > n, under = f < n;

            if (['badFat', 'trans'].includes(key)) {
                if (under) return '#059669'; // –º–µ–Ω—å—à–µ –ø–ª–æ—Ö–∏—Ö –∂–∏—Ä–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (over) return '#dc2626'; // –±–æ–ª—å—à–µ –ø–ª–æ—Ö–∏—Ö –∂–∏—Ä–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'simple') {
                if (under) return '#059669'; // –º–µ–Ω—å—à–µ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (over) return '#dc2626'; // –±–æ–ª—å—à–µ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'complex') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (under) return '#dc2626'; // –º–µ–Ω—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'fiber') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ = –∑–µ–ª–µ–Ω—ã–π
                else if (under) return '#dc2626'; // –º–µ–Ω—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'kcal') {
                if (over) return '#dc2626'; // –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'prot') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ –±–µ–ª–∫–∞ = –∑–µ–ª–µ–Ω—ã–π
            }
            else if (key === 'carbs' || key === 'fat') {
                if (over) return '#dc2626'; // –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤/–∂–∏—Ä–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'goodFat') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ —Ö–æ—Ä–æ—à–∏—Ö –∂–∏—Ä–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (under) return '#dc2626'; // –º–µ–Ω—å—à–µ —Ö–æ—Ä–æ—à–∏—Ö –∂–∏—Ä–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'gi' || key === 'harm') {
                if (over) return '#dc2626'; // –≤—ã—Å–æ–∫–∏–π –ì–ò/–≤—Ä–µ–¥–Ω–æ—Å—Ç—å = –∫—Ä–∞—Å–Ω—ã–π
                else if (under) return '#059669'; // –Ω–∏–∑–∫–∏–π –ì–ò/–≤—Ä–µ–¥–Ω–æ—Å—Ç—å = –∑–µ–ª–µ–Ω—ã–π
            }
            return null;
        }

        function fmt(v, optional, rawEmpty, forceEmpty, isWeight) {
            if (rawEmpty) return '';
            if (forceEmpty) return React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî');
            if (v == null || v === 0) return React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî');
            if (typeof v === 'number') {
                if (optional && (!v || v === 0)) return React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî');
                // –í–µ—Å —Å –æ–¥–Ω–∏–º –¥–µ—Å—è—Ç–∏—á–Ω—ã–º –∑–Ω–∞–∫–æ–º
                if (isWeight) return Math.round(v * 10) / 10;
                return Math.round(v);
            }
            const s = String(v).trim();
            if (!s) return React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî');
            return s.length > 40 ? s.slice(0, 40) + '‚Ä¶' : s;
        }

        function td(v, k, opt, raw, colorKey) {
            let style = baseStyle;

            // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            if (k === 'act' || k === 'train') {
                style = { ...style, color: '#9ca3af' };
            }

            // –¶–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –¥–µ—Ñ–∏—Ü–∏—Ç–∞: –∑–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ < 0, –∫—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ > 0
            if (k === 'factdef' || k === 'defk') {
                const numValue = typeof v === 'string' ? parseFloat(v.replace(/[+%]/g, '')) : +v;
                if (numValue < 0) {
                    style = { ...style, color: '#059669', fontWeight: 600 }; // –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞
                } else if (numValue > 0) {
                    style = { ...style, color: '#dc2626', fontWeight: 600 }; // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞
                }
            }

            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (k === 'train' || k === 'opt') {
                style = { ...style, borderRight: '2px solid #4b5563' };
            }

            if (raw) {
                style = { ...style, borderTop: 'none', borderBottom: 'none', background: 'transparent' };
            } else if (colorKey && !opt && isDayManaged) { // —Ü–≤–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–Ω—å –∑–∞–≤–µ–¥–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–æ–º
                const color = getColor(v, colorKey, norms);
                if (color) {
                    style = { ...style, color, fontWeight: 600 };
                }
            }

            // –î–ª—è –¥–∞—Ç—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –ø—Ä–æ–≤–µ—Ä—è–µ–º isDayManaged
            const forceEmpty = !isDayManaged && k !== 'd';
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –≤–µ—Å–æ–º
            const isWeight = k === 'w';
            return React.createElement('td', { key: k, style }, fmt(v, opt, raw, forceEmpty, isWeight));
        }

        const cells = [
            td(row.dstr, 'd'), td(t.carbs, 'c', false, false, 'carbs'), td(t.simple, 'cs', false, false, 'simple'), td(t.complex, 'cc', false, false, 'complex'),
            td(t.prot, 'p', false, false, 'prot'), td(t.fat, 'f', false, false, 'fat'), td(t.badFat, 'bf', false, false, 'badFat'), td(t.goodFat, 'gf', false, false, 'goodFat'), td(t.trans, 'tr', false, false, 'trans'), td(t.fiber, 'fi', false, false, 'fiber'), td(row.giAvg, 'gi', false, false, 'gi'), td(row.harmAvg, 'ha', false, false, 'harm'), td('', 'emp1', null, true),
            td(Math.round((row.weight || 0) * 10) / 10, 'w', true), td(row.activitySubtotal, 'act', true), td(row.activitiesKcal, 'train', true), td(row.dailyExp, 'exp', true), td(row.dayTargetDef, 'targetdef', true), td(row.optimum, 'opt', true), td(t.kcal, 'k', false, false, 'kcal'), td(row.factDefText, 'factdef', true), td(row.defKcal, 'defk', true), td('', 'emp2', null, true),
            td(row.mealsCount, 'mc', true), td(row.sleepHours, 'slh', true), td(row.sleepQuality, 'slq', true), td(row.sleepComment, 'slc', true), td(row.stressAvg, 'st', true), td(row.wellbeingAvg, 'wb', true), td(row.moodAvg, 'md', true), td(row.dayComment, 'dc', true)
        ];
        return React.createElement('tr', { style: { height: ROW_H } }, cells);
    }
    function computeAveragesRows(rows, profile) {
        const baseWeight = +(profile.weight || 70);
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–Ω–∏, –∑–∞–≤–µ–¥–µ–Ω–Ω—ã–µ –∫—É—Ä–∞—Ç–æ—Ä–æ–º (–≤–µ—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ) –∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –µ–¥–µ
        const valid = rows.filter(r => {
            if (!r || !r.totals || r.totals.kcal <= 0) return false;
            const dayWeight = +(r.weight || baseWeight);
            return dayWeight !== baseWeight; // –¥–µ–Ω—å –∑–∞–≤–µ–¥–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–æ–º
        });
        if (!valid.length) return { kcal: 0, carbs: 0, simple: 0, complex: 0, prot: 0, fat: 0, bad: 0, good: 0, trans: 0, fiber: 0, gi: 0, harm: 0, weight: 0, activity: 0, train: 0, exp: 0, targetDef: 0, optimum: 0, factDefPct: 0, defKcal: 0, meals: 0, sleepHours: 0, sleepQuality: 0, stressAvg: 0, wellbeingAvg: 0, moodAvg: 0 };
        const n = valid.length; let sk = 0, sc = 0, ss = 0, scc = 0, sp = 0, sf = 0, sb = 0, sg = 0, st = 0, sfbr = 0, sgi = 0, cgi = 0, sh = 0, ch = 0, sw = 0, sa = 0, strain = 0, sexp = 0, starget = 0, sopt = 0, sfactdef = 0, sdk = 0, smc = 0, ssh = 0, cssh = 0, ssq = 0, cssq = 0, sstr = 0, csstr = 0, swb = 0, cswb = 0, smd = 0, csmd = 0;
        valid.forEach(r => { const t = r.totals; sk += t.kcal; sc += t.carbs; ss += t.simple; scc += t.complex; sp += t.prot; sf += t.fat; sb += t.badFat; sg += t.goodFat; st += t.trans; sfbr += t.fiber; if (t.giCnt > 0) { sgi += r.giAvg; cgi++; } if (t.harmCnt > 0) { sh += r.harmAvg; ch++; } sw += r.weight || 0; sa += r.activitySubtotal || 0; strain += r.activitiesKcal || 0; sexp += r.dailyExp || 0; starget += (r.dayTargetDef || 0); sopt += r.optimum || 0; sfactdef += (r.factDefPct || 0); sdk += r.defKcal || 0; smc += r.mealsCount || 0; if (r.sleepHours != null && r.sleepHours > 0) { ssh += r.sleepHours; cssh++; } if (r.sleepQuality != null && r.sleepQuality > 0) { ssq += r.sleepQuality; cssq++; } if (r.stressAvg != null && r.stressAvg > 0) { sstr += r.stressAvg; csstr++; } if (r.wellbeingAvg != null && r.wellbeingAvg > 0) { swb += r.wellbeingAvg; cswb++; } if (r.moodAvg != null && r.moodAvg > 0) { smd += r.moodAvg; csmd++; } });
        return { kcal: Math.round(sk / n), carbs: Math.round(sc / n), simple: Math.round(ss / n), complex: Math.round(scc / n), prot: Math.round(sp / n), fat: Math.round(sf / n), bad: Math.round(sb / n), good: Math.round(sg / n), trans: Math.round(st / n), fiber: Math.round(sfbr / n), gi: cgi ? Math.round(sgi / cgi) : 0, harm: ch ? Math.round(sh / ch) : 0, weight: Math.round((sw / n) * 10) / 10, activity: Math.round(sa / n), train: Math.round(strain / n), exp: Math.round(sexp / n), targetDef: Math.round(starget / n), optimum: Math.round(sopt / n), factDefPct: Math.round(sfactdef / n), defKcal: Math.round(sdk / n), meals: Math.round(smc / n), sleepHours: cssh ? round1(ssh / cssh) : 0, sleepQuality: cssq ? round1(ssq / cssq) : 0, stressAvg: csstr ? round1(sstr / csstr) : 0, wellbeingAvg: cswb ? round1(swb / cswb) : 0, moodAvg: csmd ? round1(smd / csmd) : 0 };
    }
    function AvgRow({ avg, label, highlight }) {
        const hStyle = { height: SUM_H, lineHeight: SUM_H, padding: '0 4px', textAlign: 'center', fontWeight: 600, fontSize: '100%' };
        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const normsPerc = U.lsGet('heys_norms', {}) || {};

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        function computeNorms() {
            const K = +avg.optimum || 0; // —Å—Ä–µ–¥–Ω—è—è —Ü–µ–ª–µ–≤–∞—è –∫–∫–∞–ª
            const carbPct = +normsPerc.carbsPct || 0;
            const protPct = +normsPerc.proteinPct || 0;
            const fatPct = Math.max(0, 100 - carbPct - protPct);
            const carbs = K ? (K * carbPct / 100) / 4 : 0;
            const prot = K ? (K * protPct / 100) / 4 : 0;
            const fat = K ? (K * fatPct / 100) / 8 : 0;
            const simplePct = +normsPerc.simpleCarbPct || 0;
            const simple = carbs * simplePct / 100;
            const complex = Math.max(0, carbs - simple);
            const badPct = +normsPerc.badFatPct || 0;
            const transPct = +normsPerc.superbadFatPct || 0;
            const bad = fat * badPct / 100;
            const trans = fat * transPct / 100;
            const good = Math.max(0, fat - bad - trans);
            const fiberPct = +normsPerc.fiberPct || 0;
            const fiber = carbs * fiberPct / 100;
            const gi = +normsPerc.giPct || 0;
            const harm = +normsPerc.harmPct || 0;
            return { kcal: K, carbs, simple, complex, prot, fat, bad, good, trans, fiber, gi, harm };
        }
        const norms = computeNorms();

        // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤
        function getColor(value, key, norms) {
            const f = +value || 0; const n = +norms[key] || 0;
            if (!n) return null; // –Ω–µ—Ç –Ω–æ—Ä–º—ã - –Ω–µ—Ç —Ü–≤–µ—Ç–∞
            const over = f > n, under = f < n;

            if (['bad', 'trans'].includes(key)) {
                if (under) return '#059669'; // –º–µ–Ω—å—à–µ –ø–ª–æ—Ö–∏—Ö –∂–∏—Ä–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (over) return '#dc2626'; // –±–æ–ª—å—à–µ –ø–ª–æ—Ö–∏—Ö –∂–∏—Ä–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'simple') {
                if (under) return '#059669'; // –º–µ–Ω—å—à–µ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (over) return '#dc2626'; // –±–æ–ª—å—à–µ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'complex') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (under) return '#dc2626'; // –º–µ–Ω—å—à–µ —Å–ª–æ–∂–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'fiber') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ = –∑–µ–ª–µ–Ω—ã–π
                else if (under) return '#dc2626'; // –º–µ–Ω—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'kcal') {
                if (over) return '#dc2626'; // –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'prot') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ –±–µ–ª–∫–∞ = –∑–µ–ª–µ–Ω—ã–π
            }
            else if (key === 'carbs' || key === 'fat') {
                if (over) return '#dc2626'; // –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤/–∂–∏—Ä–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'good') {
                if (over) return '#059669'; // –±–æ–ª—å—à–µ —Ö–æ—Ä–æ—à–∏—Ö –∂–∏—Ä–æ–≤ = –∑–µ–ª–µ–Ω—ã–π
                else if (under) return '#dc2626'; // –º–µ–Ω—å—à–µ —Ö–æ—Ä–æ—à–∏—Ö –∂–∏—Ä–æ–≤ = –∫—Ä–∞—Å–Ω—ã–π
            }
            else if (key === 'gi' || key === 'harm') {
                if (over) return '#dc2626'; // –≤—ã—Å–æ–∫–∏–π –ì–ò/–≤—Ä–µ–¥–Ω–æ—Å—Ç—å = –∫—Ä–∞—Å–Ω—ã–π
                else if (under) return '#059669'; // –Ω–∏–∑–∫–∏–π –ì–ò/–≤—Ä–µ–¥–Ω–æ—Å—Ç—å = –∑–µ–ª–µ–Ω—ã–π
            }
            return null;
        }

        function td(v, k, raw, colorKey) {
            let st = raw ? { ...hStyle, borderTop: 'none', borderBottom: 'none', background: 'transparent' } : hStyle;

            // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
            if (k === 'aa' || k === 'atr') {
                st = { ...st, color: '#9ca3af' };
            }

            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (k === 'atr' || k === 'ao') {
                st = { ...st, borderRight: '2px solid #4b5563' };
            }

            if (!raw && colorKey) {
                const color = getColor(v, colorKey, norms);
                if (color) {
                    st = { ...st, color };
                }
            }
            let displayValue = raw ? '' : (v == null || v === 0 ? React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî') : v);
            return React.createElement('td', { key: k, style: st }, displayValue);
        }

        const cells = [
            td(label || '—Å—Ä–µ–¥', 'l'), td(avg.carbs, 'ac', false, 'carbs'), td(avg.simple, 'as', false, 'simple'), td(avg.complex, 'aco', false, 'complex'), td(avg.prot, 'ap', false, 'prot'), td(avg.fat, 'af', false, 'fat'), td(avg.bad, 'ab', false, 'bad'), td(avg.good, 'ag', false, 'good'), td(avg.trans, 'at', false, 'trans'), td(avg.fiber, 'afi', false, 'fiber'), td(avg.gi, 'agi', false, 'gi'), td(avg.harm, 'ah', false, 'harm'), td('', 'aemp1', true),
            td(Math.round((avg.weight || 0) * 10) / 10, 'aw'), td(avg.activity, 'aa'), td(avg.train, 'atr'), td(avg.exp, 'aexp'), td(avg.targetDef, 'atarget'), td(avg.optimum, 'aopt'), td(avg.kcal, 'ak', false, 'kcal'), td((avg.factDefPct > 0 ? '+' : '') + avg.factDefPct + '%', 'afactdef'), td(avg.defKcal, 'adk'), td('', 'aemp2', true), td(avg.meals, 'amc'), td(avg.sleepHours || 0, 'asl1'), td(avg.sleepQuality || 0, 'asl2'), td('', 'asl3', true), td(avg.stressAvg || 0, 'astr'), td(avg.wellbeingAvg || 0, 'awb'), td(avg.moodAvg || 0, 'amd'), td('', 'adc', true)
        ];
        return React.createElement('tr', { className: 'tr-sum' + (highlight ? ' tr-sum-main' : ''), style: { height: SUM_H } }, cells);
    }
    function WeekTable({ title, rows, tone }) {
        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const profile = U.lsGet('heys_profile', {});
        rows.forEach(r => enrichDay(r, profile));
        const avg = computeAveragesRows(rows, profile);
        const normsPerc = U.lsGet('heys_norms', {}) || {};
        const tdeeAvg = rows.length ? Math.round(rows.reduce((s, r) => s + (r.dailyExp || 0), 0) / rows.length) : 0;
        // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ü–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏–∑ –¥–Ω–µ–π, –∞ –Ω–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        const validRows = rows.filter(r => r.dayTargetDef != null);
        const targetDef = validRows.length > 0 ?
            validRows.reduce((s, r) => s + r.dayTargetDef, 0) / validRows.length :
            +(profile.deficitPctTarget || 0); // fallback –∫ –ø—Ä–æ—Ñ–∏–ª—é
        const optimum = tdeeAvg ? Math.round(tdeeAvg * (1 + targetDef / 100)) : 0;
        const carbPct = +normsPerc.carbsPct || 0; const protPct = +normsPerc.proteinPct || 0; const fatPct = Math.max(0, 100 - carbPct - protPct);
        const carbs = optimum ? (optimum * carbPct / 100) / 4 : 0; const prot = optimum ? (optimum * protPct / 100) / 4 : 0; const fat = optimum ? (optimum * fatPct / 100) / 8 : 0;
        const simplePct = +normsPerc.simpleCarbPct || 0; const simple = carbs * simplePct / 100; const complex = Math.max(0, carbs - simple);
        const badPct = +normsPerc.badFatPct || 0; const transPct = +normsPerc.superbadFatPct || 0; const bad = fat * badPct / 100; const trans = fat * transPct / 100; const good = Math.max(0, fat - bad - trans);
        const fiberPct = +normsPerc.fiberPct || 0; const fiber = carbs * fiberPct / 100; const giN = +normsPerc.giPct || 0; const harmN = +normsPerc.harmPct || 0;
        // –ù–æ—Ä–º–∞ —Å–Ω–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const sleepHoursNorm = +(profile.sleepHours || 8); // –Ω–æ—Ä–º–∞ —Å–Ω–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        function td(v, k) {
            const hStyle = { height: SUM_H, lineHeight: SUM_H, padding: '0 4px', textAlign: 'center', fontWeight: 400, fontSize: '100%' };
            // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö –Ω–æ—Ä–º
            let style = hStyle;
            if (k === 'n_act' || k === 'n_train' || k === 'd_act' || k === 'd_train') {
                style = { ...style, color: '#9ca3af' };
            }
            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (k === 'n_train' || k === 'd_train' || k === 'n_opt' || k === 'd_opt') {
                style = { ...style, borderRight: '2px solid #4b5563' };
            }
            // –î–ª—è –≤–µ—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
            if (k === 'n_weight' || k === 'd_weight') {
                if (typeof v === 'number') v = Math.round(v * 10) / 10;
            } else if (typeof v === 'number') {
                v = Math.round(v);
            }
            const displayValue = v == null || v === 0 ? React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî') : v;
            // –î–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ —É–±–∏—Ä–∞–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω –∏ –≥—Ä–∞–Ω–∏—Ü—ã
            if (k && (k.startsWith('d_emp') || k === 'd_emp1' || k === 'd_emp2' ||
                k.startsWith('n_emp') || k === 'n_emp1' || k === 'n_emp2' ||
                k.startsWith('aemp') || k === 'aemp1' || k === 'aemp2' || k === 'asl3' || k === 'adc' ||
                (k.startsWith('n_') && v === '') ||
                (k.startsWith('d_') && v === ''))) {
                style = { ...style, background: 'transparent', border: 'none' };
            }
            return React.createElement('td', { key: k, style }, displayValue);
        }
        function devCell(f, n, key) {
            // –î–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
            if (!n) return React.createElement('td', { key, style: { height: DEV_H, lineHeight: DEV_H, textAlign: 'center', background: 'transparent' } }, '');
            // –î–ª—è –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
            if (key === 'd_harm' || key === 'md_harm') {
                const absDiff = Math.round(f - n);
                const color = absDiff > 0 ? '#dc2626' : (absDiff < 0 ? '#059669' : '#e5e7eb');
                let style = { color, fontWeight: 400, height: DEV_H, lineHeight: DEV_H, padding: '0 2px', textAlign: 'center', fontSize: '90%' };
                // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
                if (key === 'd_train' || key === 'd_opt') {
                    style = { ...style, borderRight: '2px solid #4b5563' };
                }
                return React.createElement('td', { key, style }, (absDiff > 0 ? '+' : '') + absDiff);
            }
            // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
            const diff = Math.round(((f - n) / n) * 100);
            const color = diff > 0 ? '#dc2626' : (diff < 0 ? '#059669' : '#e5e7eb');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º DEV_H –¥–ª—è –º–µ–Ω—å—à–µ–π –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
            let style = { color, fontWeight: 400, height: DEV_H, lineHeight: DEV_H, padding: '0 2px', textAlign: 'center', fontSize: '90%' };
            // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
            if (key === 'd_act' || key === 'd_train') {
                style = { ...style, color: '#9ca3af' };
            }
            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (key === 'd_train' || key === 'd_opt') {
                style = { ...style, borderRight: '2px solid #4b5563' };
            }
            return React.createElement('td', { key, style }, (diff > 0 ? '+' : '') + diff + '%');
        }

        const normRowCells = [
            // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ (13 –∫–æ–ª–æ–Ω–æ–∫)
            td('–Ω–æ—Ä–º–∞', 'n0'), td(carbs, 'n_carbs'), td(simple, 'n_simple'), td(complex, 'n_complex'), td(prot, 'n_prot'), td(fat, 'n_fat'), td(bad, 'n_bad'), td(good, 'n_good'), td(trans, 'n_trans'), td(fiber, 'n_fiber'), td(giN, 'n_gi'), td(harmN, 'n_harm'), td('', 'n_emp1'),
            // –§–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (10 –∫–æ–ª–æ–Ω–æ–∫) - —É–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è "–Ω—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å" –∏ "—Å—ä–µ–¥–µ–Ω–æ –∑–∞ –¥–µ–Ω—å"
            td('', 'n_weight'), td('', 'n_act'), td('', 'n_train'), td('', 'n_exp'), td('', 'n_targetdef'), td('', 'n_opt'), td('', 'n_kcal'), td('', 'n_factdef'), td('', 'n_defkcal'), td('', 'n_emp2'),
            // –û—Å—Ç–∞–ª—å–Ω–æ–µ (9 –∫–æ–ª–æ–Ω–æ–∫) - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ—Ä–º—ã –¥–ª—è —Å–Ω–∞ –∏ –æ—Ü–µ–Ω–æ–∫
            td('', 'n_meals'), td(sleepHoursNorm, 'n_slh'), td('', 'n_slq'), td('', 'n_slc'), td('', 'n_stress'), td('', 'n_well'), td('', 'n_mood'), td('', 'n_daycom')
        ];
        const normRow = React.createElement('tr', { className: 'tr-norm', style: { height: SUM_H } }, normRowCells);

        const devRowCells = [
            // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ (13 –∫–æ–ª–æ–Ω–æ–∫)
            td('–æ—Ç–∫–ª', 'd0'), devCell(avg.carbs, carbs, 'd_carbs'), devCell(avg.simple, simple, 'd_simple'), devCell(avg.complex, complex, 'd_complex'), devCell(avg.prot, prot, 'd_prot'), devCell(avg.fat, fat, 'd_fat'), devCell(avg.bad, bad, 'd_bad'), devCell(avg.good, good, 'd_good'), devCell(avg.trans, trans, 'd_trans'), devCell(avg.fiber, fiber, 'd_fiber'), devCell(avg.gi, giN, 'd_gi'), devCell(avg.harm, harmN, 'd_harm'), td('', 'd_emp1'),
            // –§–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (10 –∫–æ–ª–æ–Ω–æ–∫) - —É–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è "–Ω—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å" –∏ "—Å—ä–µ–¥–µ–Ω–æ –∑–∞ –¥–µ–Ω—å"
            td('', 'd_weight'), td('', 'd_act'), td('', 'd_train'), td('', 'd_exp'), td('', 'd_targetdef'), td('', 'd_opt'), td('', 'd_kcal'), td('', 'd_factdef'), td('', 'd_defkcal'), td('', 'd_emp2'),
            // –û—Å—Ç–∞–ª—å–Ω–æ–µ (9 –∫–æ–ª–æ–Ω–æ–∫) - –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –¥–ª—è —Å–Ω–∞ –∏ –æ—Ü–µ–Ω–æ–∫
            td('', 'd_meals'), devCell(avg.sleepHours, sleepHoursNorm, 'd_slh'), td('', 'd_slq'), td('', 'd_slc'), td('', 'd_stress'), td('', 'd_well'), td('', 'd_mood'), td('', 'd_daycom')
        ];
        const devRow = React.createElement('tr', { className: 'tr-dev', style: { height: DEV_H } }, devRowCells);
        const wideIdx = new Set([0, 26, 30]); // –¥–∞—Ç–∞, —Å–æ–Ω –∫–æ–º–º–µ–Ω—Ç, –¥–µ–Ω—å –∫–æ–º–º–µ–Ω—Ç
        const emptyIdx = new Set([12, 22]); // –ø—É—Å—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ emp1, emp2
        const colgroup = React.createElement('colgroup', null, HEADERS.map((h, i) => React.createElement('col', { key: 'week-col-' + i + '-' + (h || 'empty'), style: { width: wideIdx.has(i) ? '50px' : (emptyIdx.has(i) ? '15px' : '25px') } })));
        const thead = React.createElement('thead', null, React.createElement('tr', null, HEADERS.map((h, i) => { const empty = !h; const parts = String(h).split(/\\n/); const isSeparatorCol = i === 15 || i === 18; const borderRight = isSeparatorCol ? '2px solid #4b5563' : null; return React.createElement('th', { key: 'week-head-' + i + '-' + (h || 'empty'), style: { width: wideIdx.has(i) ? '50px' : '25px', fontSize: '10px', lineHeight: '12px', padding: '3px 1px', whiteSpace: 'normal', textAlign: 'center', background: empty ? 'transparent' : '#d1d5db', color: empty ? 'transparent' : '#111827', borderTop: empty ? 'none' : null, borderBottom: empty ? 'none' : null, borderRight } }, empty ? '' : parts.map((p, pi) => React.createElement(React.Fragment, { key: 'week-hfrag-' + i + '-' + pi }, p, pi < parts.length - 1 ? React.createElement('br', { key: 'week-br-' + i + '-' + pi }) : null))); })));
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ "–Ω–æ—Ä–º–∞" –∏ "–æ—Ç–∫–ª" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –¥–µ–Ω—å (–¥–∞–Ω–Ω—ã–µ != 0 –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞)
        const bodyChildren = [
            ...rows.map(r => React.createElement(RowView, { key: r.dstr, row: r, profile })),
            React.createElement(AvgRow, { avg, label: '—Å—Ä–µ–¥–Ω–µ–µ', key: 'avg', highlight: true })
        ];
        if ((avg.kcal || 0) > 0) {
            bodyChildren.push(React.cloneElement(normRow, { key: 'norm' }), React.cloneElement(devRow, { key: 'dev' }));
        }
        const tbody = React.createElement('tbody', null, bodyChildren);
        return React.createElement('div', { className: 'card ' + (tone || 'tone-slate'), style: { margin: '8px 0' } },
            React.createElement('div', { style: { margin: '4px 0', fontWeight: 700 } }, title),
            React.createElement('div', { style: { overflowX: 'auto' } }, React.createElement('table', { className: 'tbl', style: { fontSize: '96%', tableLayout: 'fixed', minWidth: '1150px' } },
                colgroup,
                thead,
                tbody
            ))
        );
    }
    function MonthAverage({ rows }) {
        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const profile = U.lsGet('heys_profile', {});
        rows.forEach(r => enrichDay(r, profile));
        const avg = computeAveragesRows(rows, profile);
        const normsPerc = U.lsGet('heys_norms', {}) || {};
        const tdeeAvg = rows.length ? Math.round(rows.reduce((s, r) => s + (r.dailyExp || 0), 0) / rows.length) : 0;
        // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ü–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏–∑ –¥–Ω–µ–π, –∞ –Ω–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        const validRows = rows.filter(r => r.dayTargetDef != null);
        const targetDef = validRows.length > 0 ?
            validRows.reduce((s, r) => s + r.dayTargetDef, 0) / validRows.length :
            +(profile.deficitPctTarget || 0); // fallback –∫ –ø—Ä–æ—Ñ–∏–ª—é
        const optimum = tdeeAvg ? Math.round(tdeeAvg * (1 + targetDef / 100)) : 0;
        const carbPct = +normsPerc.carbsPct || 0; const protPct = +normsPerc.proteinPct || 0; const fatPct = Math.max(0, 100 - carbPct - protPct);
        const carbs = optimum ? (optimum * carbPct / 100) / 4 : 0; const prot = optimum ? (optimum * protPct / 100) / 4 : 0; const fat = optimum ? (optimum * fatPct / 100) / 8 : 0;
        const simplePct = +normsPerc.simpleCarbPct || 0; const simple = carbs * simplePct / 100; const complex = Math.max(0, carbs - simple);
        const badPct = +normsPerc.badFatPct || 0; const transPct = +normsPerc.superbadFatPct || 0; const bad = fat * badPct / 100; const trans = fat * transPct / 100; const good = Math.max(0, fat - bad - trans);
        const fiberPct = +normsPerc.fiberPct || 0; const fiber = carbs * fiberPct / 100; const giN = +normsPerc.giPct || 0; const harmN = +normsPerc.harmPct || 0;
        function td(v, k) {
            const hStyle = { height: SUM_H, lineHeight: SUM_H, padding: '0 2px', textAlign: 'center', fontWeight: 400, fontSize: '90%' };
            // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –º–µ—Å—è—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
            let style = hStyle;
            if (k.includes('_act') || k.includes('_train')) {
                style = { ...style, color: '#9ca3af' };
            }
            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (k === 'mn_train' || k === 'md_train' || k === 'mn_opt' || k === 'md_opt') {
                style = { ...style, borderRight: '2px solid #4b5563' };
            }
            // –î–ª—è –≤–µ—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
            if (k.includes('_weight')) {
                if (typeof v === 'number') v = Math.round(v * 10) / 10;
            } else if (typeof v === 'number') {
                v = Math.round(v);
            }
            const displayValue = v == null || v === 0 ? React.createElement('span', { style: { color: '#c4c6d8', fontSize: '8px' } }, '‚Äî') : v;
            return React.createElement('td', { key: k, style }, displayValue);
        }
        function devCell(f, n, key) {
            if (!n) return React.createElement('td', { key, style: { height: DEV_H, lineHeight: DEV_H, textAlign: 'center' } }, '');
            // –î–ª—è –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
            if (key.includes('_harm')) {
                const absDiff = Math.round(f - n);
                const color = absDiff > 0 ? '#dc2626' : (absDiff < 0 ? '#059669' : '#111827');
                let style = { color, fontWeight: 700, height: DEV_H, lineHeight: DEV_H, textAlign: 'center', fontSize: '85%' };
                if (key.includes('_act') || key.includes('_train')) {
                    style = { ...style, color: '#9ca3af' };
                }
                // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
                if (key === 'md_train' || key === 'md_opt') {
                    style = { ...style, borderRight: '2px solid #4b5563' };
                }
                return React.createElement('td', { key, style }, (absDiff > 0 ? '+' : '') + absDiff);
            }
            // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
            const diff = Math.round(((f - n) / n) * 100);
            const color = diff > 0 ? '#dc2626' : (diff < 0 ? '#059669' : '#111827');
            const fw = 700;
            // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
            let style = { color, fontWeight: fw, height: DEV_H, lineHeight: DEV_H, textAlign: 'center', fontSize: '85%' };
            if (key.includes('_act') || key.includes('_train')) {
                style = { ...style, color: '#9ca3af' };
            }
            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (key === 'md_train' || key === 'md_opt') {
                style = { ...style, borderRight: '2px solid #4b5563' };
            }
            return React.createElement('td', { key, style }, (diff > 0 ? '+' : '') + diff + '%');
        }

        const normRowCells = [
            // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ (13 –∫–æ–ª–æ–Ω–æ–∫)
            td('–Ω–æ—Ä–º–∞', 'mn0'), td(carbs, 'mn_carbs'), td(simple, 'mn_simple'), td(complex, 'mn_complex'), td(prot, 'mn_prot'), td(fat, 'mn_fat'), td(bad, 'mn_bad'), td(good, 'mn_good'), td(trans, 'mn_trans'), td(fiber, 'mn_fiber'), td(giN, 'mn_gi'), td(harmN, 'mn_harm'), td('', 'mn_emp1'),
            // –§–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (10 –∫–æ–ª–æ–Ω–æ–∫) - —É–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è "–Ω—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å" –∏ "—Å—ä–µ–¥–µ–Ω–æ –∑–∞ –¥–µ–Ω—å"
            td('', 'mn_weight'), td('', 'mn_act'), td('', 'mn_train'), td('', 'mn_exp'), td('', 'mn_targetdef'), td('', 'mn_opt'), td('', 'mn_kcal'), td('', 'mn_factdef'), td('', 'mn_defkcal'), td('', 'mn_emp2'),
            // –û—Å—Ç–∞–ª—å–Ω–æ–µ (9 –∫–æ–ª–æ–Ω–æ–∫)
            td('', 'mn_meals'), td('', 'mn_slh'), td('', 'mn_slq'), td('', 'mn_slc'), td('', 'mn_stress'), td('', 'mn_well'), td('', 'mn_mood'), td('', 'mn_daycom')
        ];
        const normRow = React.createElement('tr', { className: 'tr-norm', style: { height: SUM_H } }, normRowCells);

        const devRowCells = [
            // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ (13 –∫–æ–ª–æ–Ω–æ–∫)
            td('–æ—Ç–∫–ª', 'md0'), devCell(avg.carbs, carbs, 'md_carbs'), devCell(avg.simple, simple, 'md_simple'), devCell(avg.complex, complex, 'md_complex'), devCell(avg.prot, prot, 'md_prot'), devCell(avg.fat, fat, 'md_fat'), devCell(avg.bad, bad, 'md_bad'), devCell(avg.good, good, 'md_good'), devCell(avg.trans, trans, 'md_trans'), devCell(avg.fiber, fiber, 'md_fiber'), devCell(avg.gi, giN, 'md_gi'), devCell(avg.harm, harmN, 'md_harm'), td('', 'md_emp1'),
            // –§–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (10 –∫–æ–ª–æ–Ω–æ–∫) - —É–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è "–Ω—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å" –∏ "—Å—ä–µ–¥–µ–Ω–æ –∑–∞ –¥–µ–Ω—å"
            td('', 'md_weight'), td('', 'md_act'), td('', 'md_train'), td('', 'md_exp'), td('', 'md_targetdef'), td('', 'md_opt'), td('', 'md_kcal'), td('', 'md_factdef'), td('', 'md_defkcal'), td('', 'md_emp2'),
            // –û—Å—Ç–∞–ª—å–Ω–æ–µ (9 –∫–æ–ª–æ–Ω–æ–∫)  
            td('', 'md_meals'), td('', 'md_slh'), td('', 'md_slq'), td('', 'md_slc'), td('', 'md_stress'), td('', 'md_well'), td('', 'md_mood'), td('', 'md_daycom')
        ];
        const devRow = React.createElement('tr', { className: 'tr-dev', style: { height: DEV_H } }, devRowCells);
        const wideIdx = new Set([0, 26, 30]); // –¥–∞—Ç–∞, —Å–æ–Ω –∫–æ–º–º–µ–Ω—Ç, –¥–µ–Ω—å –∫–æ–º–º–µ–Ω—Ç
        const colgroup = React.createElement('colgroup', null, HEADERS.map((h, i) => React.createElement('col', { key: 'month-col-' + i + '-' + (h || 'empty'), style: { width: wideIdx.has(i) ? '50px' : '25px' } })));
        const thead = React.createElement('thead', null, React.createElement('tr', null, HEADERS.map((h, i) => {
            const parts = String(h).split(/\\n/);
            let style = { width: wideIdx.has(i) ? '50px' : '25px', fontSize: '9px', lineHeight: '10px', padding: '2px 1px', whiteSpace: 'normal', textAlign: 'center' };
            // –ñ–∏—Ä–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π —Ç–∞–±–ª–∏—Ü—ã
            if (i === 15 || i === 18) { // –ø–æ—Å–ª–µ "–¢—Ä–µ–Ω" –∏ "–ù—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å"
                style = { ...style, borderRight: '2px solid #4b5563' };
            }
            return React.createElement('th', { key: 'month-head-' + i + '-' + (h || 'empty'), style }, parts.map((p, pi) => React.createElement(React.Fragment, { key: 'month-hfrag-' + i + '-' + pi }, p, pi < parts.length - 1 ? React.createElement('br', { key: 'month-br-' + i + '-' + pi }) : null)));
        })));
        const tbody = React.createElement('tbody', null, [React.createElement(AvgRow, { avg, label: '—Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –º–µ—Å—è—Ü (28 –¥–Ω–µ–π)', key: 'avg' }), React.cloneElement(normRow, { key: 'norm' }), React.cloneElement(devRow, { key: 'dev' })]);
        return React.createElement('div', { className: 'card tone-violet', style: { margin: '10px 0' } },
            React.createElement('div', { style: { margin: '4px 0', fontWeight: 700 } }, '–ò—Ç–æ–≥ –∑–∞ –º–µ—Å—è—Ü ‚Äî —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è'),
            React.createElement('div', { style: { overflowX: 'auto' } }, React.createElement('table', { className: 'tbl', style: { fontSize: '80%' } },
                colgroup,
                thead,
                tbody
            ))
        );
    }

    // ---------- –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∫–∞–ª–æ—Ä–∏–π ----------
    // –õ–æ–≥–∏–∫–∞:
    //   target (–Ω—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å) = –æ—Ü–µ–Ω–∫–∞ 10 (—Ü–µ–Ω—Ç—Ä)
    //   –∫–∞–∂–¥—ã–µ ¬±100 –∫–∫–∞–ª = –º–∏–Ω—É—Å 1 –±–∞–ª–ª
    //   –æ—Ü–µ–Ω–∫–∞ = max(0, 10 - |actual - target| / 100)
    //   –æ—Å—å X –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–π–Ω—ã–µ ¬´–∫–æ—Ä–∏–¥–æ—Ä—ã¬ª —Å —à–∞–≥–æ–º 100
    //   —Ü–≤–µ—Ç:
    //     –∑–µ–ª—ë–Ω—ã–π: –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±100 (–æ—Ü–µ–Ω–∫–∞ 9-10)
    //     –∂—ë–ª—Ç—ã–π: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∏–¥–æ—Ä
    //     —Å–µ—Ä—ã–π: –ø—Ä–æ—á–∏–µ
    //     –∫—Ä–∞—Å–Ω—ã–π: –∫—Ä–∞—è (–æ—Ü–µ–Ω–∫–∞ 0 –∏–ª–∏ 1)
    function CalorieChart({ week1Data }) {
        const Sparklines = HEYS.SparklinesShared || {};
        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const profile = U.lsGet('heys_profile', {});
        week1Data.forEach(r => enrichDay(r, profile));

        const series = Sparklines.buildSeriesFromRows
            ? Sparklines.buildSeriesFromRows(week1Data, {
                valueKey: 'totals.kcal',
                targetKey: 'optimum',
                dateKey: 'dstr'
            })
            : { values: [], targets: [], labels: [] };

        return React.createElement('div', { className: 'card tone-indigo', style: { margin: '8px 0', width: '700px', background: 'var(--card, #fff)', border: '1px dashed #9ca3af', borderRadius: '12px' } },
            React.createElement('div', { style: { margin: '4px 0', fontWeight: 600, textAlign: 'center' } }, '–°—ä–µ–¥–µ–Ω–æ vs —Ü–µ–ª—å (7 –¥–Ω–µ–π)'),
            React.createElement('div', { className: 'reports-sparkline' },
                Sparklines.renderMiniSparkline?.({
                    React,
                    values: series.values,
                    targets: series.targets,
                    width: 640,
                    height: 120,
                    className: 'reports-sparkline__svg'
                })
            )
        );
    }

    // ---------- –ì—Ä–∞—Ñ–∏–∫–∏ ----------
    function regressionY(values) {
        const n = values.length;
        if (!n) return [];
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        for (let i = 0; i < n; i++) { const x = i, y = toNum(values[i]); sumX += x; sumY += y; sumXY += x * y; sumXX += x * x; }
        const b = (n * sumXY - sumX * sumY) / Math.max(1, (n * sumXX - sumX * sumX));
        const a = (sumY - b * sumX) / n;
        return values.map((_, i) => round1(a + b * i));
    }
    function ChartsBlock({ rows28 }) {
        const Sparklines = HEYS.SparklinesShared || {};
        const eaten = rows28.map(r => round1(r.totals.kcal));
        const spent = rows28.map(r => round1(r.dailyExp));
        const weight = rows28.map(r => round1(r.weight));
        const weightTrend = regressionY(weight);
        const fiber = rows28.map(r => round1(r.totals.fiber));
        const harm = rows28.map(r => round1(r.harmAvg || 0));
        const activity = rows28.map(r => round1(r.activitySubtotal));
        const carbsPct = rows28.map(r => r.carbsPct);
        const protPct = rows28.map(r => r.protPct);
        const fatPct = rows28.map(r => r.fatPct);
        const simplePct = rows28.map(r => r.simplePct);
        const complexPct = rows28.map(r => r.complexPct);

        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
        const profile = U.lsGet('heys_profile', {});
        const fiberTarget = toNum(profile.fiberTarget) || 25;
        const fiberTargetArr = rows28.map(_ => fiberTarget);

        const metrics = [
            {
                title: '–°—ä–µ–¥–µ–Ω–æ vs –ü–æ—Ç—Ä–∞—á–µ–Ω–æ',
                values: eaten,
                targets: spent,
                valueLabel: `${Math.round(eaten.reduce((s, v) => s + v, 0) / Math.max(1, eaten.length))} –∫–∫–∞–ª`
            },
            {
                title: '–í–µ—Å (–∫–≥)',
                values: weight,
                targets: weightTrend,
                valueLabel: `${weight[weight.length - 1] || 0} –∫–≥`
            },
            { title: '–£–≥–ª–µ–≤–æ–¥—ã %', values: carbsPct, valueLabel: `${Math.round(carbsPct[carbsPct.length - 1] || 0)}%` },
            { title: '–ë–µ–ª–∫–∏ %', values: protPct, valueLabel: `${Math.round(protPct[protPct.length - 1] || 0)}%` },
            { title: '–ñ–∏—Ä—ã %', values: fatPct, valueLabel: `${Math.round(fatPct[fatPct.length - 1] || 0)}%` },
            { title: '–ü—Ä–æ—Å—Ç—ã–µ %', values: simplePct, valueLabel: `${Math.round(simplePct[simplePct.length - 1] || 0)}%` },
            { title: '–°–ª–æ–∂–Ω—ã–µ %', values: complexPct, valueLabel: `${Math.round(complexPct[complexPct.length - 1] || 0)}%` },
            { title: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (–≥)', values: fiber, targets: fiberTargetArr, valueLabel: `${Math.round(fiber[fiber.length - 1] || 0)} –≥` },
            { title: '–í—Ä–µ–¥–Ω–æ—Å—Ç—å', values: harm, valueLabel: `${Math.round(harm[harm.length - 1] || 0)}` },
            { title: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∫–∫–∞–ª)', values: activity, valueLabel: `${Math.round(activity[activity.length - 1] || 0)}` }
        ];

        return React.createElement('div', { className: 'page page-reports' },
            React.createElement('div', { style: { margin: '10px 0', fontWeight: 700 } }, '–ì—Ä–∞—Ñ–∏–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 28 –¥–Ω–µ–π)'),
            React.createElement('div', { className: 'reports-sparkline-grid' },
                metrics.map((metric, idx) => React.createElement('div', { key: 'spark-metric-' + idx, className: 'reports-sparkline-card' },
                    Sparklines.renderMetricSparkline?.({
                        React,
                        title: metric.title,
                        subtitle: '28 –¥–Ω–µ–π',
                        values: metric.values,
                        targets: metric.targets,
                        valueLabel: metric.valueLabel
                    })
                ))
            )
        );
    }

    // ---------- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ (–∫–Ω–æ–ø–∫–∞ ‚Üí –º–æ–¥–∞–ª–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏; –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã) ----------
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ReportsTab
    const ReportsTab = function ReportsTab(props) {
        const React = global.React, { useMemo, useState, useEffect } = React;
        // Fallback chain –¥–ª—è products: props ‚Üí HEYS.products.getAll() ‚Üí localStorage
        const propsProducts = props.products || [];
        const products = useMemo(() => {
            if (propsProducts.length > 0) return propsProducts;
            const fromStore = global.HEYS?.products?.getAll?.() || [];
            if (fromStore.length > 0) return fromStore;
            const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };
            return U.lsGet?.('heys_products', []) || [];
        }, [propsProducts]);
        const prodIndex = useMemo(() => buildProductIndex(products), [products]);

        const U = (global.HEYS && HEYS.utils) || { lsGet: (k, d) => d };

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        const [isInitialized, setIsInitialized] = useState(false);
        const [isLoading, setIsLoading] = useState(false);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω–æ —Ç–∞–∫—É—é –∂–µ –ª–æ–≥–∏–∫—É getProfile –∫–∞–∫ –≤ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ
        const profileRaw = U.lsGet('heys_profile', {}) || {};
        const g = (profileRaw.gender || profileRaw.sex || '–ú—É–∂—Å–∫–æ–π');
        const sex = (String(g).toLowerCase().startsWith('–∂') ? 'female' : 'male');
        const profile = {
            sex: sex,
            height: +profileRaw.height || 175,
            age: +profileRaw.age || 30,
            sleepHours: +profileRaw.sleepHours || 8,
            weight: +profileRaw.weight || 70,
            zones: profileRaw.zones || [],
            deficitPctTarget: profileRaw.deficitPctTarget || 0
        };

        const zones = (profile.zones || []).map(z => ({ met: +z.MET || 0 })).length ? (profile.zones || []).map(z => ({ met: +z.MET || 0 })) : [{ met: 2.5 }, { met: 6 }, { met: 8 }, { met: 10 }];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏
        useEffect(() => {
            if (!isInitialized) {
                setIsLoading(true);
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI
                setTimeout(() => {
                    setupCacheInvalidation();
                    setIsInitialized(true);
                    setIsLoading(false);
                }, 100);
            }
        }, [isInitialized]);

        // –§–æ—Ä—Å–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–µ–º timestamp)
        const [updateTrigger, setUpdateTrigger] = useState(Date.now());

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–Ω—è (BroadcastChannel + storage) –¥–ª—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤
        useEffect(() => {
            if (!isInitialized) return;

            const RECENT_WINDOW_MS = 1000 * 60 * 60 * 24 * 60; // 60 –¥–Ω–µ–π ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤

            const markUpdated = (isoDate) => {
                if (isoDate) {
                    invalidateCache(isoDate);
                    const parsed = new Date(isoDate);
                    if (!Number.isNaN(parsed.getTime())) {
                        if (Date.now() - parsed.getTime() > RECENT_WINDOW_MS) {
                            return;
                        }
                    }
                }
                setUpdateTrigger(Date.now());
            };

            let channel = null;
            if ('BroadcastChannel' in window) {
                channel = new BroadcastChannel('heys_day_updates');
                channel.onmessage = (event) => {
                    const data = event && event.data;
                    if (!data || data.type !== 'day:update') return;
                    const isoDate = (data.payload && data.payload.date) || data.date;
                    markUpdated(isoDate);
                };
            }

            const handleStorage = (event) => {
                if (!event || !event.key) return;
                if (event.key.startsWith('heys_dayv2_')) {
                    const isoDate = event.key.slice('heys_dayv2_'.length);
                    markUpdated(isoDate);
                }
            };
            window.addEventListener('storage', handleStorage);

            const interval = setInterval(() => {
                const now = new Date();
                const today = fmtDate(now);
                const yesterday = fmtDate(new Date(now.getTime() - 24 * 60 * 60 * 1000));
                const dates = [today, yesterday];

                if (!window._heysLastDataHash) window._heysLastDataHash = {};
                let changed = false;

                dates.forEach((isoDate) => {
                    const key = 'heys_dayv2_' + isoDate;
                    const raw = window.localStorage.getItem(key);
                    const hash = raw ? raw.length : 0;
                    if (window._heysLastDataHash[key] !== hash) {
                        window._heysLastDataHash[key] = hash;
                        invalidateCache(isoDate);
                        changed = true;
                    }
                });

                if (changed) {
                    markUpdated();
                }
            }, 10000);

            return () => {
                if (channel) {
                    channel.close();
                }
                window.removeEventListener('storage', handleStorage);
                clearInterval(interval);
            };
        }, [isInitialized]);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
        if (!isInitialized || isLoading) {
            return React.createElement('div', { className: 'card', style: { margin: '8px 0', padding: '24px', textAlign: 'center' } },
                React.createElement('div', { style: { marginBottom: '8px' } }, '–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤...'),
                React.createElement('div', { className: 'muted', style: { fontSize: '90%' } }, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤')
            );
        }

        return React.createElement('div', { className: 'page page-reports' },
            React.createElement('div', { className: 'card' },
                React.createElement('h2', { className: 'reports-title' }, '–ú–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã'),
                HEYS.monthlyReports?.MonthlyReportsContent
                    ? React.createElement(HEYS.monthlyReports.MonthlyReportsContent)
                    : React.createElement('div', { className: 'muted' }, '–ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤...')
            )
        );
    };

    /** ------------------------------------------------------------
   * React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–±–∞ –æ—Ç—á—ë—Ç–æ–≤ (—É–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è —Ñ—É–Ω–∫—Ü–∏—è)
   * ----------------------------------------------------------- */
    // ReportsTab —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤—ã—à–µ –≤ —Å—Ç—Ä–æ–∫–µ 1066

    /* === EXPORT ================================================= */
    HEYS.ReportsTab = ReportsTab;
    HEYS.ReportsTabImpl = HEYS.ReportsTabImpl || {};
    HEYS.ReportsTabImpl.createReportsTab = function createReportsTab() {
        return HEYS.ReportsTab;
    };

    /* === INITIALIZATION ============================================ */
    setTimeout(setupCacheInvalidation, 100);

})(window);


/* ===== heys_reports_v12.js ===== */
// heys_reports_v12.js ‚Äî proxy to ReportsTabImpl

; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};

  if (HEYS.ReportsTabImpl && typeof HEYS.ReportsTabImpl.createReportsTab === 'function') {
    HEYS.ReportsTab = HEYS.ReportsTabImpl.createReportsTab();
    return;
  }
})(window);


/* ===== heys_weekly_reports_v2.js ===== */
// heys_weekly_reports_v2.js ‚Äî Weekly reports v2 + Weekly Wrap popup

; (function (global) {
    const HEYS = global.HEYS = global.HEYS || {};

    const U = HEYS.utils || {};
    const Sparklines = HEYS.SparklinesShared || {};

    const WEEKLY_WRAP_MIN_DAYS = 3;
    const WEEKLY_WRAP_MAX_WEEKS = 26;

    function getLsGet() {
        return (k, d) => {
            try {
                if (HEYS.store?.get) return HEYS.store.get(k, d);
                if (U.lsGet) return U.lsGet(k, d);
                const raw = localStorage.getItem(k);
                return raw ? JSON.parse(raw) : d;
            } catch (e) {
                return d;
            }
        };
    }

    function getLsSet() {
        return (k, v) => {
            try {
                if (HEYS.store?.set) {
                    HEYS.store.set(k, v);
                    return;
                }
                if (U.lsSet) {
                    U.lsSet(k, v);
                    return;
                }
                localStorage.setItem(k, JSON.stringify(v));
            } catch (e) { }
        };
    }

    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getWeekKey(date) {
        const d = new Date(date);
        const week = getWeekNumber(d);
        return d.getUTCFullYear() + '-W' + String(week).padStart(2, '0');
    }

    function getLastWeekAnchorDate(now = new Date()) {
        const lastWeek = new Date(now);
        lastWeek.setDate(lastWeek.getDate() - 7);
        return lastWeek.toISOString().split('T')[0];
    }

    function getAvailableWeeklyWraps({ lsGet, profile, pIndex, now, minDays = WEEKLY_WRAP_MIN_DAYS, maxWeeks = WEEKLY_WRAP_MAX_WEEKS } = {}) {
        const getter = lsGet || getLsGet();
        const prof = profile || getter('heys_profile', {});
        const index = pIndex || HEYS.products?.buildIndex?.();
        const baseDate = now ? new Date(now) : new Date();
        const available = [];

        const todayStr = baseDate.toISOString().split('T')[0];
        const currentReport = buildWeekReport({
            dateStr: todayStr,
            endDateStr: todayStr,
            lsGet: getter,
            profile: prof,
            pIndex: index,
            filterEmptyDays: true
        });
        available.push({ anchorDate: todayStr, report: currentReport, isCurrent: true });

        for (let i = 0; i < maxWeeks; i += 1) {
            const anchor = new Date(baseDate);
            anchor.setDate(anchor.getDate() - 7 - i * 7);
            const anchorDate = anchor.toISOString().split('T')[0];
            const report = buildWeekReport({ dateStr: anchorDate, lsGet: getter, profile: prof, pIndex: index });
            if (report?.daysWithData >= minDays) {
                available.push({ anchorDate, report, isPrevious: i === 0 });
            }
        }

        return available;
    }

    function getDayTotals(day, pIndex) {
        if (HEYS.dayCalculations?.calculateDayTotals) {
            return HEYS.dayCalculations.calculateDayTotals(day, pIndex);
        }
        return day?.dayTot || { kcal: 0, carbs: 0, prot: 0, fat: 0 };
    }

    function getDayOptimum(day, profile, lsGet, pIndex) {
        if (HEYS.TDEE?.calculate) {
            const result = HEYS.TDEE.calculate(day, profile, { lsGet, pIndex }) || {};
            return result.optimum || 0;
        }
        return 0;
    }

    function buildWeekReport({ dateStr, lsGet, profile, pIndex, endDateStr, filterEmptyDays = false }) {
        const anchor = dateStr ? new Date(dateStr) : new Date();
        const allDates = Sparklines.getWeekDates ? Sparklines.getWeekDates(anchor) : [];
        const dates = endDateStr ? allDates.filter((d) => d <= endDateStr) : allDates;
        const todayStr = new Date().toISOString().split('T')[0];
        const dayUtils = HEYS.dayUtils || {};
        const products = HEYS.products?.getAll?.() || [];
        const normPerc = lsGet('heys_norms', {});

        const days = dates.map((dstr) => {
            const day = lsGet('heys_dayv2_' + dstr, null) || { date: dstr };
            const hasMeals = Array.isArray(day.meals) && day.meals.some((m) => (m.items || []).length > 0);
            const totals = getDayTotals(day, pIndex);
            const optimum = getDayOptimum(day, profile, lsGet, pIndex);
            let goalOptimum = day?.savedDisplayOptimum > 0 ? day.savedDisplayOptimum : optimum;
            if (day?.isRefeedDay && HEYS.Refeed && !(day?.savedDisplayOptimum > 0)) {
                goalOptimum = HEYS.Refeed.getRefeedOptimum(optimum, true);
            }
            const normAbs = HEYS.dayCalculations?.computeDailyNorms
                ? HEYS.dayCalculations.computeDailyNorms(goalOptimum, normPerc)
                : { carbs: 0, prot: 0, fat: 0 };
            const ratio = goalOptimum ? (totals?.kcal || 0) / goalOptimum : 0;
            const isToday = dstr === todayStr;

            return {
                dateStr: dstr,
                hasMeals,
                totals,
                optimum,
                goalOptimum,
                normAbs,
                ratio,
                isToday,
                isRefeedDay: !!day?.isRefeedDay,
                deficitPct: day.deficitPct,
                steps: day.steps || 0,
                sleepHours: day.sleepHours || 0,
                trainings: Array.isArray(day.trainings) ? day.trainings : []
            };
        });

        const todayDay = days.find((d) => d.isToday) || null;
        const isTodayIncomplete = HEYS.weeklyCalc?.isIncompleteToday
            ? HEYS.weeklyCalc.isIncompleteToday({
                isToday: !!todayDay?.isToday,
                dateStr: todayDay?.dateStr,
                nowDateStr: todayStr,
                ratio: todayDay?.ratio
            })
            : !!(todayDay && todayDay.ratio < 0.5);
        const todayExcluded = isTodayIncomplete; // –≤—Å–µ–≥–¥–∞ –∏—Å–∫–ª—é—á–∞–µ–º –Ω–µ–ø–æ–ª–Ω—ã–π —Å–µ–≥–æ–¥–Ω—è (ratio < 0.5)

        const shouldIncludeDay = (d, opts) => HEYS.weeklyCalc?.shouldIncludeDay
            ? HEYS.weeklyCalc.shouldIncludeDay({ day: d, nowDateStr: todayStr, ...opts })
            : (!d.isFuture && !(d.isToday && d.ratio < 0.5));

        // visibleDays: –∏—Å–∫–ª—é—á–∞–µ–º –Ω–µ–ø–æ–ª–Ω—ã–π —Å–µ–≥–æ–¥–Ω—è + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–Ω–∏ –±–µ–∑ –µ–¥—ã (–µ—Å–ª–∏ filterEmptyDays)
        const visibleDays = days.filter((d) => {
            if (!shouldIncludeDay(d, { requireMeals: false })) return false;
            if (filterEmptyDays && !d.hasMeals) return false; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–Ω–∏ –±–µ–∑ –µ–¥—ã
            return true;
        });
        const daysWithData = visibleDays.filter((d) => d.hasMeals).length;
        const totalKcal = visibleDays.reduce((s, d) => s + (d.totals?.kcal || 0), 0);
        const totalTarget = visibleDays.reduce((s, d) => s + (d.goalOptimum || 0), 0);
        const avgKcal = daysWithData ? Math.round(totalKcal / daysWithData) : 0;
        const avgOptimum = daysWithData ? Math.round(totalTarget / daysWithData) : 0;
        let avgTarget = avgOptimum;
        const avgSteps = daysWithData ? Math.round(visibleDays.reduce((s, d) => s + (d.steps || 0), 0) / daysWithData) : 0;
        const avgSleep = daysWithData
            ? Math.round((visibleDays.reduce((s, d) => s + (d.sleepHours || 0), 0) / daysWithData) * 10) / 10
            : 0;
        const trainingDays = visibleDays.filter((d) => d.trainings?.length > 0).length;

        const totalDeltaKcal = visibleDays.reduce((s, d) => s + ((d.totals?.kcal || 0) - (d.optimum || 0)), 0);
        const avgDeltaKcal = daysWithData ? Math.round(totalDeltaKcal / daysWithData) : 0;

        const totalProt = visibleDays.reduce((s, d) => s + (d.totals?.prot || 0), 0);
        const totalFat = visibleDays.reduce((s, d) => s + (d.totals?.fat || 0), 0);
        const totalCarbs = visibleDays.reduce((s, d) => s + (d.totals?.carbs || 0), 0);

        const totalProtNorm = visibleDays.reduce((s, d) => s + (d.normAbs?.prot || 0), 0);
        const totalFatNorm = visibleDays.reduce((s, d) => s + (d.normAbs?.fat || 0), 0);
        const totalCarbsNorm = visibleDays.reduce((s, d) => s + (d.normAbs?.carbs || 0), 0);

        const avgProt = daysWithData ? Math.round(totalProt / daysWithData) : 0;
        const avgFat = daysWithData ? Math.round(totalFat / daysWithData) : 0;
        const avgCarbs = daysWithData ? Math.round(totalCarbs / daysWithData) : 0;

        const avgNormProt = daysWithData ? Math.round(totalProtNorm / daysWithData) : 0;
        const avgNormFat = daysWithData ? Math.round(totalFatNorm / daysWithData) : 0;
        const avgNormCarbs = daysWithData ? Math.round(totalCarbsNorm / daysWithData) : 0;

        let totalBurned = 0;
        let totalTargetDeficit = 0;
        let daysWithBurned = 0;

        visibleDays.forEach((d) => {
            if (!d.hasMeals) return;
            const dayData = lsGet('heys_dayv2_' + d.dateStr, null) || { date: d.dateStr };
            const tdeeInfo = dayUtils.getDayTdee
                ? dayUtils.getDayTdee(d.dateStr, profile, { includeNDTE: true, dayData, pIndex, products })
                : (HEYS.TDEE?.calculate ? (HEYS.TDEE.calculate(dayData, profile, { lsGet, includeNDTE: true, pIndex }) || {}) : null);
            const burned = tdeeInfo?.tdee || d.optimum || 0;
            d.burned = burned;
            if (burned > 0) {
                totalBurned += burned;
                const goal = d.goalOptimum || 0;
                const targetPctFromGoal = goal > 0 ? ((goal - burned) / burned) * 100 : null;
                const targetPctFromDay = HEYS.weeklyCalc?.resolveTargetDeficitPct
                    ? HEYS.weeklyCalc.resolveTargetDeficitPct({
                        dayData,
                        tdeeInfo,
                        profile,
                        goalTarget: goal,
                        burned
                    })
                    : (Number.isFinite(targetPctFromGoal) ? targetPctFromGoal : (profile?.deficitPctTarget ?? 0));
                totalTargetDeficit += Number.isFinite(targetPctFromDay) ? targetPctFromDay : 0;
                daysWithBurned += 1;
            }
        });

        if (daysWithBurned > 0) {
            avgTarget = Math.round(totalBurned / daysWithBurned);
        }

        const avgDeltaPct = totalBurned ? Math.round(((totalKcal - totalBurned) / totalBurned) * 100) : 0;
        const targetDeficitPct = daysWithBurned
            ? Math.round(totalTargetDeficit / daysWithBurned)
            : (profile?.deficitPctTarget ?? 0);

        const ratios = visibleDays.map((d) => (d.goalOptimum ? (d.totals?.kcal || 0) / d.goalOptimum : 0));
        let bestDay = null;
        let minDelta = Infinity;
        visibleDays.forEach((d, idx) => {
            if (!d.hasMeals || !d.goalOptimum) return;
            const delta = Math.abs(ratios[idx] - 1);
            if (delta < minDelta) {
                minDelta = delta;
                bestDay = d;
            }
        });

        const series = {
            values: visibleDays.map((d) => d.totals?.kcal || 0),
            targets: visibleDays.map((d) => d.goalOptimum || 0),
            labels: filterEmptyDays ? visibleDays.map((d) => d.dateStr) : dates
        };

        // Debug snapshot: Weekly Wrap totals vs burned (–±–µ–∑ –ª–æ–≥–æ–≤)
        try {
            HEYS.debugData = HEYS.debugData || {};
            HEYS.debugData.weeklyWrapData = {
                dateStr,
                endDateStr: endDateStr || null,
                filterEmptyDays: !!filterEmptyDays,
                todayExcluded,
                daysWithData,
                totalKcal,
                totalTarget,
                totalBurned,
                avgDeltaPct,
                targetDeficitPct,
                visibleDays: visibleDays.map((d) => ({
                    dateStr: d.dateStr,
                    kcal: d.totals?.kcal || 0,
                    optimum: d.goalOptimum || 0,
                    ratio: d.ratio,
                    isToday: d.isToday,
                    hasMeals: d.hasMeals
                }))
            };
        } catch (e) { }

        return {
            dates,
            rangeLabel: Sparklines.formatDateRange ? Sparklines.formatDateRange(dates) : '',
            days,
            daysWithData,
            totalKcal,
            totalTarget,
            avgKcal,
            avgOptimum,
            avgTarget,
            avgSteps,
            avgSleep,
            trainingDays,
            avgDeltaKcal,
            avgDeltaPct,
            targetDeficitPct,
            avgProt,
            avgFat,
            avgCarbs,
            avgNormProt,
            avgNormFat,
            avgNormCarbs,
            todayExcluded,
            series,
            bestDay
        };
    }

    function shouldShowWeeklyWrapPopup({ now = new Date(), lsGet, dateStr, minDays = WEEKLY_WRAP_MIN_DAYS }) {
        const dayOfWeek = now.getDay();
        const hour = now.getHours();

        if (dayOfWeek !== 1 || hour < 9) {
            return false;
        }

        const lastShownKey = 'heys_weekly_wrap_last_shown_v2';
        const lastShown = lsGet(lastShownKey, null);
        const key = getWeekKey(now);

        if (lastShown === key) {
            return false;
        }

        if (dateStr) {
            const report = buildWeekReport({ dateStr, lsGet, profile: lsGet('heys_profile', {}), pIndex: HEYS.products?.buildIndex?.() });
            if (report.daysWithData < minDays) return false;
        }

        return true;
    }

    function markWeeklyWrapShown({ lsSet, date } = {}) {
        const setter = lsSet || getLsSet();
        const key = getWeekKey(date || new Date());
        setter('heys_weekly_wrap_last_shown_v2', key);
    }

    function WeeklyReportCard({ lsGet, profile, pIndex, anchorDate }) {
        const React = global.React;
        if (!React) return null;

        const { createElement: h, useMemo } = React;

        const report = useMemo(() => {
            const getter = lsGet || getLsGet();
            const prof = profile || getter('heys_profile', {});
            const index = pIndex || HEYS.products?.buildIndex?.();
            return buildWeekReport({ dateStr: anchorDate, lsGet: getter, profile: prof, pIndex: index });
        }, [lsGet, profile, pIndex, anchorDate]);

        if (!report || report.daysWithData === 0) {
            return h('div', { className: 'weekly-report-card weekly-report-card--empty' },
                h('div', { className: 'weekly-report-card__title' }, '–ù–µ–¥–µ–ª—è –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö'),
                h('div', { className: 'weekly-report-card__subtitle' }, '–î–æ–±–∞–≤—å—Ç–µ 3+ –¥–Ω—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ç–æ–≥–∏')
            );
        }

        return h('div', { className: 'weekly-report-card' },
            h('div', { className: 'weekly-report-card__header' },
                h('div', { className: 'weekly-report-card__title' }, '–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏'),
                h('div', { className: 'weekly-report-card__range' }, report.rangeLabel)
            ),
            h('div', { className: 'weekly-report-card__stats' },
                h('div', { className: 'weekly-report-card__stat' },
                    h('div', { className: 'weekly-report-card__stat-value' }, report.daysWithData),
                    h('div', { className: 'weekly-report-card__stat-label' }, '–¥–Ω–µ–π —Å –µ–¥–æ–π')
                ),
                h('div', { className: 'weekly-report-card__stat' },
                    h('div', { className: 'weekly-report-card__stat-value' }, report.avgKcal),
                    h('div', { className: 'weekly-report-card__stat-label' }, '–∫–∫–∞–ª/–¥–µ–Ω—å')
                ),
                h('div', { className: 'weekly-report-card__stat' },
                    h('div', { className: 'weekly-report-card__stat-value' }, Math.round(report.avgTarget || 0)),
                    h('div', { className: 'weekly-report-card__stat-label' }, '–∑–∞—Ç—Ä–∞—Ç—ã')
                )
            ),
            h('div', { className: 'weekly-report-card__sparkline' },
                Sparklines.renderMiniSparkline?.({
                    React,
                    values: report.series.values,
                    targets: report.series.targets,
                    width: 240,
                    height: 54,
                    className: 'weekly-report-card__sparkline-svg'
                })
            ),
            h('div', { className: 'weekly-report-card__meta' },
                h('div', { className: 'weekly-report-card__meta-item' }, 'üë£ ', report.avgSteps, ' —à–∞–≥–æ–≤'),
                h('div', { className: 'weekly-report-card__meta-item' }, 'üò¥ ', report.avgSleep, ' —á —Å–Ω–∞'),
                h('div', { className: 'weekly-report-card__meta-item' }, 'üí™ ', report.trainingDays, ' —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫')
            )
        );
    }

    function WeeklyWrapStep({ data }) {
        const React = global.React;
        if (!React) return null;
        const { createElement: h, useMemo, useState } = React;
        const { PopupWithBackdrop, PopupCloseButton } = HEYS.dayPopups || {};
        const haptic = HEYS.dayUtils?.haptic || (() => { });
        const formatDateDisplay = HEYS.dayUtils?.formatDateDisplay;
        const todayStr = new Date().toISOString().split('T')[0];

        const availableWeeks = useMemo(() => {
            const getter = getLsGet();
            const profile = getter('heys_profile', {});
            const pIndex = HEYS.products?.buildIndex?.();
            return getAvailableWeeklyWraps({ lsGet: getter, profile, pIndex });
        }, []);

        const [weekIndex, setWeekIndex] = useState(0);
        const [weekBreakdownPopup, setWeekBreakdownPopup] = useState(false);
        const currentWeek = availableWeeks[weekIndex] || null;
        const report = currentWeek?.report || null;
        const isCurrent = !!currentWeek?.isCurrent;
        const isPrevious = !!currentWeek?.isPrevious;
        const minDaysForView = isCurrent ? 1 : WEEKLY_WRAP_MIN_DAYS;
        const hintText = isCurrent
            ? '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–Ω–∏ —Å –ø—Ä–∏—ë–º–∞–º–∏ (–ø–Ω‚Äì—Å–µ–≥–æ–¥–Ω—è). –°–µ–≥–æ–¥–Ω—è —É—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ 50% –Ω–æ—Ä–º—ã.'
            : '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –Ω–µ–¥–µ–ª—è (–ø–Ω‚Äì–≤—Å)';

        const canGoPrev = weekIndex < availableWeeks.length - 1;
        const canGoNext = weekIndex > 0;
        const handlePrevWeek = () => setWeekIndex((prev) => (prev < availableWeeks.length - 1 ? prev + 1 : prev));
        const handleNextWeek = () => setWeekIndex((prev) => (prev > 0 ? prev - 1 : prev));

        const deltaPct = report?.avgDeltaPct ?? 0;
        const targetPct = report?.targetDeficitPct ?? 0;
        const avgOptimum = report?.avgOptimum ?? 0;
        const avgTargetRounded = Math.round(report?.avgTarget ?? 0);
        // –†–µ–∞–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç –æ—Ç –∑–∞—Ç—Ä–∞—Ç = (–∑–∞—Ç—Ä–∞—Ç—ã - —Å—ä–µ–¥–µ–Ω–æ) / –∑–∞—Ç—Ä–∞—Ç—ã * 100
        const realDeficitPct = avgTargetRounded && report?.avgKcal != null
            ? Math.round(((avgTargetRounded - report.avgKcal) / avgTargetRounded) * 100)
            : 0;
        const realDeficitLabel = realDeficitPct === 0
            ? '–±–∞–ª–∞–Ω—Å'
            : (realDeficitPct > 0 ? '–¥–µ—Ñ–∏—Ü–∏—Ç' : '–ø—Ä–æ—Ñ–∏—Ü–∏—Ç') + ' ' + Math.abs(realDeficitPct) + '%';

        const includedDays = useMemo(() => {
            if (!report?.days) return [];
            return report.days.filter((d) => {
                const isIncluded = HEYS.weeklyCalc?.shouldIncludeDay
                    ? HEYS.weeklyCalc.shouldIncludeDay({ day: d, nowDateStr: todayStr, requireMeals: true })
                    : (d.hasMeals && !(d.isToday && d.ratio < 0.5));
                return isIncluded;
            });
        }, [report, todayStr]);

        const hasRefeedInWeek = useMemo(() => {
            return includedDays.some((d) => d.isRefeedDay);
        }, [includedDays]);

        const breakdownTotals = useMemo(() => {
            const totals = includedDays.reduce((acc, d) => {
                const eaten = d.totals?.kcal || 0;
                const goal = d.goalOptimum || 0;
                const burned = d.burned || 0;
                const deficit = eaten - burned;
                acc.eaten += eaten;
                acc.goal += goal;
                acc.burned += burned;
                acc.deficit += deficit;
                return acc;
            }, {
                eaten: 0,
                goal: 0,
                burned: 0,
                deficit: 0
            });
            const count = includedDays.length || 1;
            return {
                ...totals,
                count,
                avgEaten: totals.eaten / count,
                avgGoal: Math.round(totals.goal / count),
                avgBurned: totals.burned / count,
                avgDeficit: totals.deficit / count
            };
        }, [includedDays]);

        const openWeekBreakdown = (e) => {
            if (!PopupWithBackdrop || includedDays.length === 0) return;
            e.stopPropagation();
            haptic('light');
            setWeekBreakdownPopup(true);
        };

        const handleBreakdownKey = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openWeekBreakdown(e);
            }
        };

        const getDayLabels = (dateStr) => {
            if (formatDateDisplay) {
                const meta = formatDateDisplay(dateStr);
                return { primary: meta?.label || dateStr, secondary: meta?.sub || '' };
            }
            return { primary: dateStr, secondary: '' };
        };

        const getDeltaPctClass = (delta, target) => {
            if (!Number.isFinite(delta) || !Number.isFinite(target)) {
                return 'weekly-wrap-step__delta-pct--equal';
            }

            const targetAbs = Math.abs(target);
            const hasTarget = targetAbs >= 1;

            if (!hasTarget) {
                if (delta === 0) return 'weekly-wrap-step__delta-pct--equal';
                return delta > 0
                    ? 'weekly-wrap-step__delta-pct--above'
                    : 'weekly-wrap-step__delta-pct--below';
            }

            if (delta === 0) return 'weekly-wrap-step__delta-pct--warn';

            if (Math.sign(delta) !== Math.sign(target)) {
                return 'weekly-wrap-step__delta-pct--above';
            }

            const deltaAbs = Math.abs(delta);
            const greenMin = targetAbs * 0.55;
            const greenMax = targetAbs * 1.25;

            if (deltaAbs >= greenMin && deltaAbs <= greenMax) {
                return 'weekly-wrap-step__delta-pct--below';
            }

            return 'weekly-wrap-step__delta-pct--warn';
        };

        const deltaPctClass = getDeltaPctClass(deltaPct, targetPct);

        const getTargetToneClass = (value, target) => {
            if (!Number.isFinite(value)) return 'weekly-wrap-step__delta-value--neutral';
            if (value === 0) return 'weekly-wrap-step__delta-value--neutral';
            if (target > 0) {
                return value > 0
                    ? 'weekly-wrap-step__delta-value--good'
                    : 'weekly-wrap-step__delta-value--bad';
            }
            if (target < 0) {
                return value < 0
                    ? 'weekly-wrap-step__delta-value--good'
                    : 'weekly-wrap-step__delta-value--bad';
            }
            return value < 0
                ? 'weekly-wrap-step__delta-value--good'
                : 'weekly-wrap-step__delta-value--bad';
        };

        const deltaToneClass = getTargetToneClass(deltaPct, targetPct);
        const targetToneClass = getTargetToneClass(targetPct, targetPct);
        const avgGoalPct = breakdownTotals.avgBurned
            ? ((breakdownTotals.avgGoal - breakdownTotals.avgBurned) / breakdownTotals.avgBurned) * 100
            : 0;
        const avgGoalPctClass = getTargetToneClass(avgGoalPct, targetPct);

        const formatSignedValue = (value, suffix = '') => {
            const rounded = Math.round(value);
            const sign = rounded > 0 ? '+' : '';
            return sign + rounded + suffix;
        };

        const formatDeficitWithPct = (deficitValue, burnedValue) => {
            const pct = burnedValue ? (deficitValue / burnedValue) * 100 : 0;
            return formatSignedValue(deficitValue) + ' / ' + formatSignedValue(pct, '%');
        };

        const getDeltaToneClass = (value, target) => {
            if (!Number.isFinite(value)) return 'weekly-wrap-breakdown__value--neutral';
            if (value === 0) return 'weekly-wrap-breakdown__value--neutral';
            if (target > 0) {
                return value > 0
                    ? 'weekly-wrap-breakdown__value--good'
                    : 'weekly-wrap-breakdown__value--bad';
            }
            if (target < 0) {
                return value < 0
                    ? 'weekly-wrap-breakdown__value--good'
                    : 'weekly-wrap-breakdown__value--bad';
            }
            return value < 0
                ? 'weekly-wrap-breakdown__value--good'
                : 'weekly-wrap-breakdown__value--bad';
        };

        const avgProt = report?.avgProt ?? 0;
        const avgFat = report?.avgFat ?? 0;
        const avgCarbs = report?.avgCarbs ?? 0;
        const avgNormProt = report?.avgNormProt ?? 0;
        const avgNormFat = report?.avgNormFat ?? 0;
        const avgNormCarbs = report?.avgNormCarbs ?? 0;

        const buildMacroRing = (label, value, norm, toneClass) => {
            const ringStartOffsetPct = 9; // —á—É—Ç—å –±–æ–ª—å—à–µ (~32¬∞)
            const ringCapCompPct = 5; // –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ü–æ–≤
            const overColor = toneClass === 'protein' ? '#22c55e' : '#ef4444';
            const ringColor = toneClass === 'protein'
                ? '#ef4444'
                : (toneClass === 'fat' ? '#f59e0b' : '#22c55e');
            const ratio = norm > 0 ? value / norm : 0;
            const dotColor = ratio > 1 ? '#ef4444' : '#22c55e';
            // –û—Å–Ω–æ–≤–Ω–∞—è –¥—É–≥–∞: –æ—Ç 0 –¥–æ min(100%, ratio)
            const basePctRaw = Math.min(100, Math.round(ratio * 100));
            const basePct = Math.max(0, basePctRaw - ringCapCompPct);
            // –ü–µ—Ä–µ–±–æ—Ä: –æ—Ç 100% –¥–æ ratio (–µ—Å–ª–∏ ratio > 1)
            const hasOver = ratio > 1;
            const overPctRaw = hasOver ? Math.min(50, Math.round((ratio - 1) * 100)) : 0; // max 150% –≤–∏–∑—É–∞–ª—å–Ω–æ
            const overPct = Math.max(0, overPctRaw - ringCapCompPct);
            const gradientId = 'macro-ring-gradient-' + toneClass;
            const gradientStops = toneClass === 'protein'
                ? ['#fecaca', '#ef4444']
                : (toneClass === 'fat' ? ['#fde68a', '#f59e0b'] : ['#bbf7d0', '#22c55e']);
            const getRingDotPos = (pct) => {
                if (!pct || pct <= 0) return null;
                const dotPct = Math.max(0, pct - 3); // —Å–ª–µ–≥–∫–∞ —Å–º–µ—â–∞–µ–º —Ç–æ—á–∫—É –Ω–∞–∑–∞–¥
                if (dotPct <= 0) return null;
                const angle = ((dotPct + ringStartOffsetPct) / 100) * Math.PI * 2;
                return {
                    x: 18 + 15.5 * Math.cos(angle),
                    y: 18 + 15.5 * Math.sin(angle)
                };
            };
            const dot = getRingDotPos(basePct);

            return h('div', { className: 'macro-ring-item' },
                h('div', { className: 'macro-ring ' + toneClass + (hasOver ? ' macro-ring--over' : '') },
                    h('svg', { viewBox: '0 0 36 36', className: 'macro-ring-svg' },
                        h('defs', null,
                            h('linearGradient', {
                                id: gradientId,
                                x1: '0%', y1: '0%', x2: '100%', y2: '100%'
                            },
                                h('stop', { offset: '0%', stopColor: gradientStops[0] }),
                                h('stop', { offset: '100%', stopColor: gradientStops[1] })
                            )
                        ),
                        // –§–æ–Ω–æ–≤—ã–π —Ç—Ä–µ–∫
                        h('circle', { className: 'macro-ring-bg', cx: 18, cy: 18, r: 15.5, pathLength: 100 }),
                        // –û—Å–Ω–æ–≤–Ω–∞—è –¥—É–≥–∞ (–¥–æ 100%)
                        h('circle', {
                            className: 'macro-ring-fill',
                            cx: 18, cy: 18, r: 15.5,
                            pathLength: 100,
                            style: {
                                strokeDasharray: basePct + ' 100',
                                '--ring-dasharray': basePct + ' 100',
                                '--ring-start-offset': -ringStartOffsetPct,
                                stroke: 'url(#' + gradientId + ')'
                            }
                        }),
                        // –ö—Ä–∞—Å–Ω–∞—è –¥—É–≥–∞ –ø–µ—Ä–µ–±–æ—Ä–∞ (–æ—Ç 100% –¥–∞–ª—å—à–µ)
                        hasOver && h('circle', {
                            className: 'macro-ring-fill--over',
                            cx: 18, cy: 18, r: 15.5,
                            pathLength: 100,
                            style: {
                                strokeDasharray: overPct + ' ' + (100 - overPct),
                                '--over-dasharray': overPct + ' ' + (100 - overPct),
                                '--over-offset': -(100 - overPct),
                                stroke: overColor
                            }
                        }),
                        dot && h('circle', {
                            className: 'macro-ring-dot',
                            cx: dot.x,
                            cy: dot.y,
                            r: 2.2,
                            style: { '--macro-ring-dot': dotColor }
                        }),
                        // –ú–∞—Ä–∫–µ—Ä —É–±—Ä–∞–Ω –ø–æ –ø—Ä–æ—Å—å–±–µ
                    ),
                    h('span', { className: 'macro-ring-value' }, Math.round(value || 0))
                ),
                h('span', { className: 'macro-ring-label' }, label),
                h('span', { className: 'macro-ring-target' }, '/ ' + Math.round(norm || 0) + '–≥')
            );
        };

        return h('div', { className: 'weekly-wrap-step' },
            h('div', { className: 'weekly-wrap-step__title' }, 'üìä –ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏'),
            h('div', { className: 'weekly-wrap-step__nav' },
                h('button', {
                    className: 'weekly-wrap-step__nav-btn' + (canGoPrev ? '' : ' is-disabled'),
                    onClick: handlePrevWeek,
                    disabled: !canGoPrev,
                    title: '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è'
                }, '‚Üê'),
                h('div', { className: 'weekly-wrap-step__nav-range' },
                    isPrevious ? h('div', { className: 'weekly-wrap-step__nav-subtitle' }, '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è') : null,
                    h('div', { className: 'weekly-wrap-step__nav-range-line' },
                        h('span', { className: 'weekly-wrap-step__range-text' }, report?.rangeLabel || '–ù–µ–¥–µ–ª—è'),
                        isCurrent ? h('span', { className: 'weekly-wrap-step__badge weekly-wrap-step__badge--current' }, '–¢–ï–ö–£–©–ê–Ø') : null,
                        isCurrent && report?.todayExcluded
                            ? h('span', { className: 'weekly-wrap-step__badge weekly-wrap-step__badge--excluded' }, '–°–ï–ì–û–î–ù–Ø –ù–ï –£–ß–¢–Å–ù')
                            : null
                    )
                ),
                h('button', {
                    className: 'weekly-wrap-step__nav-btn' + (canGoNext ? '' : ' is-disabled'),
                    onClick: handleNextWeek,
                    disabled: !canGoNext,
                    title: '–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è'
                }, '‚Üí')
            ),
            h('div', { className: 'weekly-wrap-step__hint' }, hintText),
            report && report.daysWithData >= minDaysForView
                ? h('div', { className: 'weekly-wrap-step__content' },
                    h('div', { className: 'weekly-wrap-step__stats' },
                        h('div', {
                            className: 'weekly-wrap-step__stat weekly-wrap-step__stat--goal weekly-wrap-step__stat--clickable',
                            role: 'button',
                            tabIndex: 0,
                            onClick: openWeekBreakdown,
                            onKeyDown: handleBreakdownKey,
                            title: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–Ω–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ'
                        },
                            h('div', { className: 'weekly-wrap-step__stat-value' }, avgTargetRounded),
                            h('div', { className: 'weekly-wrap-step__stat-label' }, '–ø–æ—Ç—Ä–∞—á–µ–Ω–æ')
                        ),
                        h('div', {
                            className: 'weekly-wrap-step__stat weekly-wrap-step__stat--fact weekly-wrap-step__stat--clickable',
                            role: 'button',
                            tabIndex: 0,
                            onClick: openWeekBreakdown,
                            onKeyDown: handleBreakdownKey,
                            title: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–Ω–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ'
                        },
                            h('div', { className: 'weekly-wrap-step__stat-value' }, report.avgKcal),
                            h('div', { className: 'weekly-wrap-step__stat-label' }, '—Å—ä–µ–¥–µ–Ω–æ')
                        ),
                        h('div', {
                            className: 'weekly-wrap-step__stat weekly-wrap-step__stat--plan weekly-wrap-step__stat--clickable',
                            role: 'button',
                            tabIndex: 0,
                            onClick: openWeekBreakdown,
                            onKeyDown: handleBreakdownKey,
                            title: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–Ω–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ'
                        },
                            h('div', { className: 'weekly-wrap-step__stat-value' }, avgOptimum),
                            h('div', { className: 'weekly-wrap-step__stat-label' }, '—Ü–µ–ª—å')
                        ),
                        h('div', { className: 'weekly-wrap-step__stat weekly-wrap-step__stat--days' },
                            h('div', { className: 'weekly-wrap-step__stat-value' }, report.daysWithData),
                            h('div', { className: 'weekly-wrap-step__stat-label weekly-wrap-step__stat-label--days' }, '–¥–Ω–µ–π —Å –µ–¥–æ–π')
                        ),
                        h('div', { className: 'weekly-wrap-step__stat weekly-wrap-step__stat--delta' },
                            h('div', { className: 'weekly-wrap-step__stat-label weekly-wrap-step__stat-label--delta' },
                                deltaPct > 0
                                    ? '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏—Ü–∏—Ç —Å–æ—Å—Ç–∞–≤–∏–ª'
                                    : deltaPct < 0
                                        ? '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç —Å–æ—Å—Ç–∞–≤–∏–ª'
                                        : '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å'
                            ),
                            h('div', {
                                className: 'weekly-wrap-step__stat-value weekly-wrap-step__delta-value ' + deltaToneClass
                            }, (deltaPct > 0 ? '+' : '') + deltaPct + '%'),
                            h('div', { className: 'weekly-wrap-step__stat-sub' },
                                h('span', { className: 'weekly-wrap-step__delta-target-line' },
                                    '–°—Ä–µ–¥–Ω—è—è —Ü–µ–ª—å –±—ã–ª–∞ ',
                                    h('span', { className: 'weekly-wrap-step__delta-target-value ' + targetToneClass },
                                        (targetPct > 0 ? '+' : '') + targetPct + '%'
                                    )
                                ),
                                hasRefeedInWeek
                                    ? h('span', { className: 'weekly-wrap-step__delta-target-line' },
                                        h('span', { className: 'weekly-wrap-step__badge weekly-wrap-step__badge--refeed' }, '–ë—ã–ª —Ä–µ—Ñ–∏–¥')
                                    )
                                    : null
                            )
                        )
                    ),
                    h('div', { className: 'weekly-wrap-step__macros' },
                        h('div', { className: 'weekly-wrap-step__macros-header' },
                            h('span', { className: 'weekly-wrap-step__macros-title' }, '–°—Ä–µ–¥–Ω–∏–µ –ë–ñ–£'),
                            h('span', { className: 'weekly-wrap-step__macros-subtitle' }, '–≥/–¥–µ–Ω—å')
                        ),
                        h('div', { className: 'weekly-wrap-step__macros-rings macro-rings' },
                            buildMacroRing('–ë–µ–ª–∫–∏', avgProt, avgNormProt, 'protein'),
                            buildMacroRing('–ñ–∏—Ä—ã', avgFat, avgNormFat, 'fat'),
                            buildMacroRing('–£–≥–ª–µ–≤–æ–¥—ã', avgCarbs, avgNormCarbs, 'carbs')
                        )
                    ),
                    h('div', { className: 'weekly-wrap-step__sparkline' },
                        Sparklines.renderMiniSparkline?.({
                            React,
                            values: report.series.values,
                            targets: report.series.targets,
                            width: 260,
                            height: 64,
                            padding: 6,
                            className: 'weekly-wrap-step__sparkline-svg',
                            useTargetGradient: true,
                            fillTargetGradient: true,
                            showPeakDots: true
                        })
                    ),
                    h('div', { className: 'weekly-wrap-step__meta' },
                        h('div', { className: 'weekly-wrap-step__meta-item' }, 'üë£ ', report.avgSteps, ' —à–∞–≥–æ–≤'),
                        h('div', { className: 'weekly-wrap-step__meta-item' }, 'üò¥ ', report.avgSleep, ' —á —Å–Ω–∞'),
                        h('div', { className: 'weekly-wrap-step__meta-item' }, 'üí™ ', report.trainingDays, ' —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫')
                    )
                )
                : h('div', { className: 'weekly-wrap-step__empty' },
                    h('div', { className: 'weekly-wrap-step__subtitle' }, '–°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–µ–ª–∏'),
                    h('div', { className: 'weekly-wrap-step__meta-item' },
                        isCurrent
                            ? '–°–µ–≥–æ–¥–Ω—è —É—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ 50% –Ω–æ—Ä–º—ã, –¥–æ–±–∞–≤—å—Ç–µ –µ—â—ë –µ–¥—ã ‚Äî –∏ –ø–æ—è–≤—è—Ç—Å—è –∏—Ç–æ–≥–∏'
                            : '–î–æ–±–∞–≤—å—Ç–µ 3 –¥–Ω—è —Å –µ–¥–æ–π ‚Äî –∏ –∏—Ç–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
                    )
                ),
            weekBreakdownPopup && PopupWithBackdrop && PopupWithBackdrop({
                onClose: () => setWeekBreakdownPopup(false),
                zIndex: 10001,
                children: h('div', {
                    className: 'weekly-wrap-breakdown',
                    role: 'dialog',
                    'aria-modal': 'true',
                    'aria-label': '–î–Ω–∏, —É—á–∞—Å—Ç–≤—É—é—â–∏–µ –≤ —Ä–∞—Å—á—ë—Ç–µ',
                    onClick: (e) => e.stopPropagation()
                },
                    h('div', { className: 'weekly-wrap-breakdown__header' },
                        h('div', { className: 'weekly-wrap-breakdown__title' }, 'üßæ –î–Ω–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ'),
                        h('div', { className: 'weekly-wrap-breakdown__subtitle' }, includedDays.length + ' –¥–Ω.')
                    ),
                    report?.todayExcluded && h('div', { className: 'weekly-wrap-breakdown__note' },
                        '–°–µ–≥–æ–¥–Ω—è –Ω–µ —É—á—Ç—ë–Ω: –º–µ–Ω–µ–µ 50% –Ω–æ—Ä–º—ã'
                    ),
                    h('div', { className: 'weekly-wrap-breakdown__table' },
                        h('div', { className: 'weekly-wrap-breakdown__row weekly-wrap-breakdown__row--head' },
                            h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--day' }, '–î–µ–Ω—å'),
                            h('span', { className: 'weekly-wrap-breakdown__cell' }, '–ó–∞—Ç—Ä–∞—Ç—ã'),
                            h('span', { className: 'weekly-wrap-breakdown__cell' }, '–°—ä–µ–¥–µ–Ω–æ'),
                            h('span', { className: 'weekly-wrap-breakdown__cell' }, '–¶–µ–ª—å'),
                            h('span', { className: 'weekly-wrap-breakdown__cell' }, '–î–µ—Ñ–∏—Ü–∏—Ç', h('br'), '–æ—Ç –ø–æ—Ç—Ä–∞—á.')
                        ),
                        includedDays.map((d, i) => {
                            const labels = getDayLabels(d.dateStr);
                            const dayText = labels.secondary ? labels.primary + ' ¬∑ ' + labels.secondary : labels.primary;
                            const eaten = d.totals?.kcal || 0;
                            const goal = d.goalOptimum || 0;
                            const burned = d.burned || 0;
                            const deficit = eaten - burned;
                            const goalPct = burned ? ((goal - burned) / burned) * 100 : 0;
                            const goalPctClass = getTargetToneClass(goalPct, targetPct);
                            const toneClass = getDeltaToneClass(deficit, targetPct);
                            return h('div', { key: i, className: 'weekly-wrap-breakdown__row' },
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--day' }, dayText),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(burned)),
                                h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(eaten)),
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--goal' },
                                    Math.round(goal),
                                    ' ',
                                    h('span', { className: 'weekly-wrap-breakdown__goal-pct ' + goalPctClass },
                                        '(' + (goalPct > 0 ? '+' : '') + Math.round(goalPct) + '%)'
                                    ),
                                    d.isRefeedDay
                                        ? h('span', { className: 'weekly-wrap-breakdown__badge weekly-wrap-breakdown__badge--refeed' }, '–ë—ã–ª —Ä–µ—Ñ–∏–¥')
                                        : null
                                ),
                                h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--delta ' + toneClass }, formatDeficitWithPct(deficit, burned))
                            );
                        }),
                        h('div', { className: 'weekly-wrap-breakdown__row weekly-wrap-breakdown__row--total' },
                            h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--day' }, '–ò—Ç–æ–≥–æ –≤ —Å—Ä–µ–¥–Ω–µ–º'),
                            h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(breakdownTotals.avgBurned)),
                            h('span', { className: 'weekly-wrap-breakdown__cell' }, Math.round(breakdownTotals.avgEaten)),
                            h('span', { className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--goal' },
                                Math.round(breakdownTotals.avgGoal),
                                ' ',
                                h('span', {
                                    className: 'weekly-wrap-breakdown__goal-pct ' + avgGoalPctClass
                                },
                                    '(' + (avgGoalPct > 0 ? '+' : '') + Math.round(avgGoalPct) + '%)'
                                )
                            ),
                            h('span', {
                                className: 'weekly-wrap-breakdown__cell weekly-wrap-breakdown__cell--delta ' + getDeltaToneClass(breakdownTotals.avgDeficit, targetPct)
                            }, formatDeficitWithPct(breakdownTotals.avgDeficit, breakdownTotals.avgBurned))
                        )
                    ),
                    PopupCloseButton
                        ? h(PopupCloseButton, { onClose: () => setWeekBreakdownPopup(false), className: 'weekly-wrap-breakdown__close' })
                        : h('button', {
                            className: 'weekly-wrap-breakdown__close',
                            onClick: (e) => {
                                e.stopPropagation();
                                setWeekBreakdownPopup(false);
                            }
                        }, '‚úï')
                )
            })
        );
    }

    function registerWeeklyWrapStep() {
        if (!HEYS.StepModal?.registerStep || !global.React) return false;

        HEYS.StepModal.registerStep('weekly_wrap_v2', {
            title: '–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏',
            subtitle: '–°–≤–æ–¥–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π',
            nextLabel: '–ó–∞–∫—Ä—ã—Ç—å',
            hideHeaderNext: false,
            component: WeeklyWrapStep,
            getInitialData: () => {
                const lsGet = getLsGet();
                const profile = lsGet('heys_profile', {});
                const pIndex = HEYS.products?.buildIndex?.();
                const availableWeeks = getAvailableWeeklyWraps({ lsGet, profile, pIndex });
                const report = availableWeeks[0]?.report || null;
                return { report };
            }
        });

        return true;
    }

    function maybeShowWeeklyWrap({ lsGet, profile, pIndex, date } = {}) {
        const getter = lsGet || getLsGet();
        const now = new Date();
        const anchorDate = date || getLastWeekAnchorDate(now);
        const baseNow = date ? new Date(date) : now;

        if (!shouldShowWeeklyWrapPopup({ now, lsGet: getter, dateStr: anchorDate })) {
            return false;
        }

        if (!registerWeeklyWrapStep()) {
            setTimeout(() => registerWeeklyWrapStep(), 200);
        }

        const availableWeeks = getAvailableWeeklyWraps({
            lsGet: getter,
            profile: profile || getter('heys_profile', {}),
            pIndex: pIndex || HEYS.products?.buildIndex?.(),
            now: baseNow
        });

        const report = availableWeeks[0]?.report || null;

        if (!report) {
            return false;
        }

        if (HEYS.StepModal?.show) {
            HEYS.StepModal.show({
                steps: ['weekly_wrap_v2'],
                showProgress: false,
                showGreeting: false,
                showTip: false,
                allowSwipe: false,
                context: { report }
            });
            markWeeklyWrapShown({ lsSet: getLsSet(), date: now });
            return true;
        }

        return false;
    }

    function openWeeklyWrap({ lsGet, profile, pIndex, date } = {}) {
        const getter = lsGet || getLsGet();
        const now = new Date();
        const baseNow = date ? new Date(date) : now;

        if (!registerWeeklyWrapStep()) {
            setTimeout(() => registerWeeklyWrapStep(), 200);
        }

        const availableWeeks = getAvailableWeeklyWraps({
            lsGet: getter,
            profile: profile || getter('heys_profile', {}),
            pIndex: pIndex || HEYS.products?.buildIndex?.(),
            now: baseNow
        });

        const reportForPopup = availableWeeks[0]?.report || null;

        if (HEYS.StepModal?.show) {
            HEYS.StepModal.show({
                steps: ['weekly_wrap_v2'],
                showProgress: false,
                showGreeting: false,
                showTip: false,
                allowSwipe: false,
                context: { report: reportForPopup }
            });
            return true;
        }

        return false;
    }

    HEYS.weeklyReports = {
        buildWeekReport,
        WeeklyReportCard,
        maybeShowWeeklyWrap,
        openWeeklyWrap,
        shouldShowWeeklyWrapPopup,
        markWeeklyWrapShown
    };
})(window);


/* ===== heys_data_overview_v1.js ===== */
// heys_data_overview_v1.js ‚Äî –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞ 30 –¥–Ω–µ–π (–¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
// v1.0.0 | 2025-11-30

; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const { useState, useMemo, useCallback } = React;

  // ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
  function pad2(n) { return String(n).padStart(2, '0'); }
  function fmtDate(d) { return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate()); }

  // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  const WEEKDAYS = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

  // ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π ----------
  const TRACKED_FIELDS = [
    { key: 'weightMorning', icon: '‚öñÔ∏è', label: '–í–µ—Å', check: v => v > 0, format: v => v + ' –∫–≥' },
    { key: 'sleepStart', icon: 'üõèÔ∏è', label: '–õ—ë–≥', check: v => !!v, format: v => v },
    { key: 'sleepEnd', icon: '‚è∞', label: '–í—Å—Ç–∞–ª', check: v => !!v, format: v => v },
    { key: 'sleepQuality', icon: 'üò¥', label: '–°–æ–Ω', check: v => v >= 1 && v <= 5, format: v => '‚òÖ'.repeat(v) },
    { key: 'steps', icon: 'üëü', label: '–®–∞–≥–∏', check: v => v > 0, format: v => (+v).toLocaleString('ru-RU') },
    { key: 'waterMl', icon: 'üíß', label: '–í–æ–¥–∞', check: v => v > 0, format: v => (v / 1000).toFixed(1) + ' –ª' },
    { key: 'dayScore', icon: '‚≠ê', label: '–û—Ü–µ–Ω–∫–∞', check: v => v >= 1 && v <= 10, format: v => v + '/10' },
    { key: 'trainings', icon: 'üèÉ', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', check: v => Array.isArray(v) && v.length > 0, format: v => v.length + ' —à—Ç' },
    { key: 'meals', icon: 'üçΩÔ∏è', label: '–ï–¥–∞', check: v => Array.isArray(v) && v.length > 0, format: v => v.length + ' –ø—Ä–∏—ë–º–æ–≤' },
    { key: 'dayComment', icon: 'üí¨', label: '–ö–æ–º–º–µ–Ω—Ç', check: v => !!v && String(v).trim().length > 0, format: v => String(v).slice(0, 20) + '...' },
  ];

  // ---------- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ----------
  function getOverviewData(clientId, daysCount = 30) {
    const today = new Date();
    const days = [];
    const U = HEYS.utils || {};
    const readStoredValue = (k, d) => {
      try {
        if (HEYS.store?.get) return HEYS.store.get(k, d);
        if (U.lsGet) return U.lsGet(k, d);
        const raw = localStorage.getItem(k);
        return raw ? JSON.parse(raw) : d;
      } catch (e) { return d; }
    };

    for (let i = 0; i < daysCount; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = fmtDate(d);

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º lsGet —Å –∫–ª—é—á–æ–º 'heys_dayv2_' ‚Äî –æ–Ω —Å–∞–º –¥–æ–±–∞–≤–∏—Ç clientId prefix!
      let dayData = {};
      try {
        dayData = readStoredValue('heys_dayv2_' + dateStr, {}) || {};
      } catch (e) {
        dayData = {};
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ (dayData –º–æ–∂–µ—Ç –±—ã—Ç—å null/undefined)
      const fields = {};
      let filledCount = 0;

      TRACKED_FIELDS.forEach(f => {
        const value = dayData ? dayData[f.key] : undefined;
        const isFilled = f.check(value);
        fields[f.key] = { value, filled: isFilled };
        if (isFilled) filledCount++;
      });

      days.push({
        date: dateStr,
        dayOfWeek: WEEKDAYS[d.getDay()],
        dayNum: d.getDate(),
        month: d.getMonth() + 1,
        fields,
        filledCount,
        filledPct: Math.round((filledCount / TRACKED_FIELDS.length) * 100)
      });
    }

    return days;
  }

  // ---------- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ----------

  // –Ø—á–µ–π–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
  // showEmpty = true –µ—Å–ª–∏ –¥–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π (2+ –ø–æ–ª–µ–π) –∏ –Ω—É–∂–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏
  function DataCell({ field, fieldConfig, showEmpty }) {
    const { filled, value } = field;
    const title = filled ? fieldConfig.format(value) : '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';

    // –ï—Å–ª–∏ –¥–µ–Ω—å –ø–æ—á—Ç–∏ –ø—É—Å—Ç–æ–π (0-1 –ø–æ–ª–µ) ‚Äî –Ω–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º
    const cellClass = filled
      ? 'cell-filled'
      : (showEmpty ? 'cell-empty' : 'cell-neutral');

    return React.createElement('td', {
      className: cellClass,
      title: title
    }, filled ? '‚úì' : '‚Äî');
  }

  // –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
  function DataRow({ day, onRowClick }) {
    const handleClick = useCallback(() => {
      if (onRowClick) onRowClick(day.date);
    }, [day.date, onRowClick]);

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É: "30.11 –°–±"
    const dateLabel = pad2(day.dayNum) + '.' + pad2(day.month) + ' ' + day.dayOfWeek;

    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π (2+ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—è)
    const showEmpty = day.filledCount >= 2;

    return React.createElement('tr', { onClick: handleClick },
      // –ö–æ–ª–æ–Ω–∫–∞ –¥–∞—Ç—ã (sticky)
      React.createElement('td', null, dateLabel),

      // –ö–æ–ª–æ–Ω–∫–∏ –ø–æ–ª–µ–π
      ...TRACKED_FIELDS.map(f =>
        React.createElement(DataCell, {
          key: f.key,
          field: day.fields[f.key],
          fieldConfig: f,
          showEmpty: showEmpty
        })
      )
    );
  }

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
  function TableHeader() {
    return React.createElement('thead', null,
      React.createElement('tr', null,
        React.createElement('th', { className: 'th-date' }, '–î–∞—Ç–∞'),
        ...TRACKED_FIELDS.map(f =>
          React.createElement('th', {
            key: f.key,
            className: 'th-vertical',
            title: f.label
          },
            React.createElement('span', { className: 'th-text' }, f.label)
          )
        )
      )
    );
  }

  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  function EmptyState() {
    return React.createElement('div', { className: 'data-overview-empty' },
      React.createElement('div', { className: 'data-overview-empty-icon' }, 'üìã'),
      React.createElement('div', { className: 'data-overview-empty-text' },
        '–ö–ª–∏–µ–Ω—Ç –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª –∑–∞–ø–æ–ª–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ'
      ),
      React.createElement('div', { className: 'data-overview-empty-hint' },
        '–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏'
      )
    );
  }

  // ---------- –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ----------
  function DataOverviewTab({ clientId, setTab, setSelectedDate }) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const days = useMemo(() => getOverviewData(clientId, 30), [clientId]);

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const stats = useMemo(() => {
      let totalFilled = 0;
      let totalPossible = days.length * TRACKED_FIELDS.length;
      days.forEach(d => { totalFilled += d.filledCount; });
      return {
        filledPct: totalPossible > 0 ? Math.round((totalFilled / totalPossible) * 100) : 0,
        daysWithData: days.filter(d => d.filledCount > 0).length
      };
    }, [days]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫—É
    const handleRowClick = useCallback((dateStr) => {
      if (setSelectedDate) {
        // selectedDate –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π YYYY-MM-DD, –Ω–µ Date!
        setSelectedDate(dateStr);
      }
      if (setTab) {
        setTab('stats');
      }
    }, [setTab, setSelectedDate]);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–æ–æ–±—â–µ
    const hasAnyData = stats.daysWithData > 0;

    if (!hasAnyData) {
      return React.createElement('div', { className: 'data-overview-tab' },
        React.createElement(EmptyState)
      );
    }

    return React.createElement('div', { className: 'data-overview-tab' },
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('div', { className: 'data-overview-header' },
        React.createElement('div', { className: 'data-overview-title' },
          'üìã –û–±–∑–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞ 30 –¥–Ω–µ–π'
        ),
        React.createElement('div', { className: 'data-overview-total' },
          '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ: ' + stats.filledPct + '%'
        )
      ),

      // –¢–∞–±–ª–∏—Ü–∞
      React.createElement('div', { className: 'data-overview-scroll' },
        React.createElement('table', { className: 'data-overview-table' },
          React.createElement(TableHeader),
          React.createElement('tbody', null,
            days.map(day =>
              React.createElement(DataRow, {
                key: day.date,
                day: day,
                onRowClick: handleRowClick
              })
            )
          )
        )
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞
      React.createElement('div', { className: 'data-overview-hint' },
        '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –¥–Ω—é'
      )
    );
  }

  // ---------- –≠–∫—Å–ø–æ—Ä—Ç ----------
  HEYS.DataOverviewTab = DataOverviewTab;

  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
  if (typeof window !== 'undefined') {
    window.debugOverviewData = (clientId) => {
      const data = getOverviewData(clientId, 7);
      console.table(data.map(d => ({
        date: d.date,
        filled: d.filledCount + '/' + TRACKED_FIELDS.length,
        pct: d.filledPct + '%'
      })));
      return data;
    };
  }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_widgets_events_v1.js ===== */
/**
 * heys_widgets_events_v1.js
 * Event Bus –¥–ª—è —Å–ª–∞–±–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤
 * Version: 1.0.0
 * Created: 2025-12-15
 * 
 * –ü–∞—Ç—Ç–µ—Ä–Ω: Pub/Sub –¥–ª—è loose coupling –º–µ–∂–¥—É –≤–∏–¥–∂–µ—Ç–∞–º–∏ –∏ core
 */
(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.Widgets = HEYS.Widgets || {};

  // –ß—Ç–æ–±—ã –Ω–µ —É–±–∏–≤–∞—Ç—å –∫–æ–Ω—Å–æ–ª—å –≤–æ –≤—Ä–µ–º—è drag (dnd:move –ª–µ—Ç–∏—Ç –¥–µ—Å—è—Ç–∫–∏ —Ä–∞–∑/—Å–µ–∫)
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ù–ï –ª–æ–≥–∏—Ä—É–µ–º dnd:move –¥–∞–∂–µ –ø—Ä–∏ HEYS.debug.
  // –ï—Å–ª–∏ –æ—á–µ–Ω—å –Ω–∞–¥–æ ‚Äî –≤–∫–ª—é—á–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏: HEYS.debugDndMove = true
  let _lastDndMoveLogAt = 0;
  
  // === Event Bus Implementation ===
  const events = {
    _handlers: new Map(),
    _onceHandlers: new Map(),
    
    /**
     * –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
     * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
     * @param {Function} handler - –û–±—Ä–∞–±–æ—Ç—á–∏–∫
     * @returns {Function} –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏
     */
    on(event, handler) {
      if (typeof handler !== 'function') {
        console.warn('[Widgets Events] Handler must be a function');
        return () => {};
      }
      
      if (!this._handlers.has(event)) {
        this._handlers.set(event, new Set());
      }
      this._handlers.get(event).add(handler);
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
      return () => this.off(event, handler);
    },
    
    /**
     * –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
     * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
     * @param {Function} handler - –û–±—Ä–∞–±–æ—Ç—á–∏–∫
     * @returns {Function} –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏
     */
    once(event, handler) {
      if (typeof handler !== 'function') {
        console.warn('[Widgets Events] Handler must be a function');
        return () => {};
      }
      
      if (!this._onceHandlers.has(event)) {
        this._onceHandlers.set(event, new Set());
      }
      this._onceHandlers.get(event).add(handler);
      
      return () => {
        const handlers = this._onceHandlers.get(event);
        if (handlers) handlers.delete(handler);
      };
    },
    
    /**
     * –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Å–æ–±—ã—Ç–∏—è
     * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
     * @param {Function} handler - –û–±—Ä–∞–±–æ—Ç—á–∏–∫
     */
    off(event, handler) {
      const handlers = this._handlers.get(event);
      if (handlers) {
        handlers.delete(handler);
        if (handlers.size === 0) {
          this._handlers.delete(event);
        }
      }
      
      const onceHandlers = this._onceHandlers.get(event);
      if (onceHandlers) {
        onceHandlers.delete(handler);
        if (onceHandlers.size === 0) {
          this._onceHandlers.delete(event);
        }
      }
    },
    
    /**
     * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
     * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
     * @param {*} data - –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
     */
    emit(event, data) {
      // –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      const handlers = this._handlers.get(event);
      if (handlers) {
        handlers.forEach(handler => {
          try {
            handler(data);
          } catch (error) {
            console.error(`[Widgets Events] Error in handler for "${event}":`, error);
          }
        });
      }
      
      // Once –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞)
      const onceHandlers = this._onceHandlers.get(event);
      if (onceHandlers) {
        const handlersToCall = [...onceHandlers];
        this._onceHandlers.delete(event);
        handlersToCall.forEach(handler => {
          try {
            handler(data);
          } catch (error) {
            console.error(`[Widgets Events] Error in once handler for "${event}":`, error);
          }
        });
      }
      
      // Debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      if (HEYS.debug && event !== 'data:updated') {
        // dnd:move ‚Äî –≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ.
        if (event === 'dnd:move' && !HEYS.debugDndMove) return;
        if (event === 'dnd:move') {
          const now = Date.now();
          if (now - _lastDndMoveLogAt < 250) return; // throttle
          _lastDndMoveLogAt = now;
        }
        console.log(`[Widgets Events] ${event}`, data);
      }
    },
    
    /**
     * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
     */
    clear() {
      this._handlers.clear();
      this._onceHandlers.clear();
    },
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
     * @param {string} event - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
     * @returns {number}
     */
    listenerCount(event) {
      const regular = this._handlers.get(event)?.size || 0;
      const once = this._onceHandlers.get(event)?.size || 0;
      return regular + once;
    },
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏
     * @returns {string[]}
     */
    eventNames() {
      const names = new Set([
        ...this._handlers.keys(),
        ...this._onceHandlers.keys()
      ]);
      return [...names];
    }
  };
  
  // === Built-in Events ===
  // –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:
  /*
   * widget:added      - –í–∏–¥–∂–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω { widget }
   * widget:removed    - –í–∏–¥–∂–µ—Ç —É–¥–∞–ª—ë–Ω { widgetId }
   * widget:moved      - –í–∏–¥–∂–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω { widget, from, to }
   * widget:resized    - –í–∏–¥–∂–µ—Ç –∏–∑–º–µ–Ω–∏–ª —Ä–∞–∑–º–µ—Ä { widget, from, to }
   * widget:settings   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω—ã { widget, settings }
   * widget:click      - –ö–ª–∏–∫ –Ω–∞ –≤–∏–¥–∂–µ—Ç { widget, event }
   * widget:action     - Quick action –Ω–∞ –≤–∏–¥–∂–µ—Ç–µ { widget, action }
   * 
   * layout:changed    - Layout –∏–∑–º–µ–Ω–∏–ª—Å—è { layout }
   * layout:saved      - Layout —Å–æ—Ö—Ä–∞–Ω—ë–Ω { layout }
   * layout:loaded     - Layout –∑–∞–≥—Ä—É–∂–µ–Ω { layout }
   * layout:reset      - Layout —Å–±—Ä–æ—à–µ–Ω
   * 
   * editmode:enter    - –í—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   * editmode:exit     - –í—ã—Ö–æ–¥ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   * 
   * dnd:start         - –ù–∞—á–∞–ª–æ drag'–∞ { widget }
   * dnd:move          - Drag –¥–≤–∏–∂–µ—Ç—Å—è { widget, x, y }
   * dnd:drop          - Drop –∑–∞–≤–µ—Ä—à—ë–Ω { widget, position }
   * dnd:cancel        - Drag –æ—Ç–º–µ–Ω—ë–Ω
   * 
   * data:updated      - –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å { key, value }
   * 
   * catalog:open      - –ö–∞—Ç–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç
   * catalog:close     - –ö–∞—Ç–∞–ª–æ–≥ –∑–∞–∫—Ä—ã—Ç
   * catalog:select    - –í–∏–¥–∂–µ—Ç –≤—ã–±—Ä–∞–Ω –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ { type }
   */
  
  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.Widgets.events = events;
  
  // –£–¥–æ–±–Ω—ã–µ –∞–ª–∏–∞—Å—ã
  HEYS.Widgets.on = events.on.bind(events);
  HEYS.Widgets.off = events.off.bind(events);
  HEYS.Widgets.emit = events.emit.bind(events);
  
  // Verbose init log removed
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_widgets_registry_v1.js ===== */
/**
 * heys_widgets_registry_v1.js
 * –†–µ–µ—Å—Ç—Ä —Ç–∏–ø–æ–≤ –≤–∏–¥–∂–µ—Ç–æ–≤
 * Version: 1.0.0
 * Created: 2025-12-15
 * 
 * –ü–∞—Ç—Ç–µ—Ä–Ω: Registry –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –≤–∏–¥–∂–µ—Ç–æ–≤
 */
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.Widgets = HEYS.Widgets || {};

  // === Widget Categories ===
  const CATEGORIES = {
    nutrition: {
      id: 'nutrition',
      label: '–ü–∏—Ç–∞–Ω–∏–µ',
      icon: 'üçé',
      color: '#f97316'
    },
    health: {
      id: 'health',
      label: '–ó–¥–æ—Ä–æ–≤—å–µ',
      icon: '‚ù§Ô∏è',
      color: '#8b5cf6'
    },
    motivation: {
      id: 'motivation',
      label: '–ú–æ—Ç–∏–≤–∞—Ü–∏—è',
      icon: 'üéØ',
      color: '#10b981'
    },
    advanced: {
      id: 'advanced',
      label: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ',
      icon: 'üìä',
      color: '#3b82f6'
    },
    cycle: {
      id: 'cycle',
      label: '–¶–∏–∫–ª',
      icon: 'üå∏',
      color: '#ec4899'
    }
  };

  // === Widget Size Presets ===
  // Legacy size-id aliases (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö layout'–æ–≤).
  // –í–ê–ñ–ù–û: –Ω–∞—Ä—É–∂—É (UI) –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç NxM, –Ω–æ —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  // –º–æ–≥—É—Ç –∂–∏—Ç—å –≤ localStorage —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
  const LEGACY_SIZE_ALIASES = {
    // –°—Ç–∞—Ä—ã–µ –∏–º–µ–Ω–∞
    mini: '1x1',
    short: '2x1',
    tall2: '1x2',
    compact: '2x2',
    medium: '3x2',
    wide: '4x2',
    tall3: '2x3',
    tall: '2x4',
    wide3: '4x3',
    large: '4x4'
  };

  const SIZES = {
    // –í–ê–ñ–ù–û: —Å–µ—Ç–∫–∞ —Ç–µ–ø–µ—Ä—å 4 –∫–æ–ª–æ–Ω–∫–∏ (–µ–¥–∏–Ω–∏—Ü–∞ = 1 –∫–æ–ª–æ–Ω–∫–∞/—Ä—è–¥).
    // –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤—ã—á–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Å—Ç–∞—Ä–æ–π 2-–∫–æ–ª–æ–Ω–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏,
    // —Ä–∞–∑–º–µ—Ä—ã "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö" –≤–∏–¥–∂–µ—Ç–æ–≤ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω—ã √ó2.
    // 4-–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞: 1 –∫–æ–ª–æ–Ω–∫–∞/—Ä—è–¥ = –±–∞–∑–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞.
    // iOS-like:
    // - compact = 2√ó2
    // - wide    = 4√ó2
    // - large   = 4√ó4
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: mini = 1√ó1 (value-only –≤–∏–¥–∂–µ—Ç)
    // === –í—Å–µ —Ä–∞–∑–º–µ—Ä—ã –æ—Ç 1√ó1 –¥–æ 4√ó4 (16 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) ===
    // –§–æ—Ä–º–∞—Ç: 'NxM' –≥–¥–µ N=cols, M=rows
    // Row 1: height = 1
    '1x1': { cols: 1, rows: 1, label: '1√ó1', cssClass: 'widget--1x1' },
    '2x1': { cols: 2, rows: 1, label: '2√ó1', cssClass: 'widget--2x1' },
    '3x1': { cols: 3, rows: 1, label: '3√ó1', cssClass: 'widget--3x1' },
    '4x1': { cols: 4, rows: 1, label: '4√ó1', cssClass: 'widget--4x1' },
    // Row 2: height = 2
    '1x2': { cols: 1, rows: 2, label: '1√ó2', cssClass: 'widget--1x2' },
    '2x2': { cols: 2, rows: 2, label: '2√ó2', cssClass: 'widget--2x2' },
    '3x2': { cols: 3, rows: 2, label: '3√ó2', cssClass: 'widget--3x2' },
    '4x2': { cols: 4, rows: 2, label: '4√ó2', cssClass: 'widget--4x2' },
    // Row 3: height = 3
    '1x3': { cols: 1, rows: 3, label: '1√ó3', cssClass: 'widget--1x3' },
    '2x3': { cols: 2, rows: 3, label: '2√ó3', cssClass: 'widget--2x3' },
    '3x3': { cols: 3, rows: 3, label: '3√ó3', cssClass: 'widget--3x3' },
    '4x3': { cols: 4, rows: 3, label: '4√ó3', cssClass: 'widget--4x3' },
    // Row 4: height = 4
    '1x4': { cols: 1, rows: 4, label: '1√ó4', cssClass: 'widget--1x4' },
    '2x4': { cols: 2, rows: 4, label: '2√ó4', cssClass: 'widget--2x4' },
    '3x4': { cols: 3, rows: 4, label: '3√ó4', cssClass: 'widget--3x4' },
    '4x4': { cols: 4, rows: 4, label: '4√ó4', cssClass: 'widget--4x4' }
  };

  // –í—Å–µ —Ä–∞–∑–º–µ—Ä—ã 1x1..4x4 (–≤ –ø–æ—Ä—è–¥–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ SIZES)
  const ALL_SIZES_4X4 = Object.keys(SIZES);

  // === Widget Type Definitions ===
  // 10 —Ç–∏–ø–æ–≤ –≤–∏–¥–∂–µ—Ç–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
  const WIDGET_TYPES = {
    // === –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ü–∏—Ç–∞–Ω–∏–µ ===
    calories: {
      type: 'calories',
      name: '–ö–∞–ª–æ—Ä–∏–∏',
      category: 'nutrition',
      icon: 'üî•',
      description: '–¢–µ–∫—É—â–∏–µ –∫–∞–ª–æ—Ä–∏–∏ –∏ –Ω–æ—Ä–º–∞',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['dayTot.kcal', 'optimum'],
      component: 'WidgetCalories',
      settings: {
        showPercentage: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å %' },
        showRemaining: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫' }
      }
    },

    macros: {
      type: 'macros',
      name: '–ë–ñ–£',
      category: 'nutrition',
      icon: 'ü•ó',
      description: '–ë–∞–ª–∞–Ω—Å –±–µ–ª–∫–æ–≤, –∂–∏—Ä–æ–≤, —É–≥–ª–µ–≤–æ–¥–æ–≤',
      defaultSize: '4x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['dayTot.prot', 'dayTot.fat', 'dayTot.carbs', 'normAbs'],
      component: 'WidgetMacros',
      settings: {
        showGrams: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≥—Ä–∞–º–º—ã' },
        showPercentage: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å %' }
      }
    },

    insulin: {
      type: 'insulin',
      name: '–ò–Ω—Å—É–ª–∏–Ω',
      category: 'nutrition',
      icon: 'üìà',
      description: '–¢–∞–π–º–µ—Ä –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['waveData'],
      component: 'WidgetInsulin',
      settings: {
        showTimer: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä' },
        showPhase: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–∞–∑—É' }
      }
    },

    // === –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ó–¥–æ—Ä–æ–≤—å–µ ===
    status: {
      type: 'status',
      name: '–°—Ç–∞—Ç—É—Å',
      category: 'health',
      icon: 'üéØ',
      description: '–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å 0-100 —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['dayData', 'profile', 'dayTot', 'normAbs', 'waterGoal'],
      component: 'WidgetStatus',
      settings: {
        showActions: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è' },
        showIssues: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã' }
      }
    },

    sleep: {
      type: 'sleep',
      name: '–°–æ–Ω',
      category: 'health',
      icon: 'üò¥',
      description: '–ß–∞—Å—ã —Å–Ω–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–æ',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['day.sleepHours', 'day.sleepQuality', 'prof.sleepHours'],
      component: 'WidgetSleep',
      settings: {
        showQuality: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ' },
        showTarget: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–æ—Ä–º—É' }
      }
    },

    water: {
      type: 'water',
      name: '–í–æ–¥–∞',
      category: 'health',
      icon: 'üíß',
      description: '–í—ã–ø–∏—Ç–æ –≤–æ–¥—ã –∏ –Ω–æ—Ä–º–∞',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['day.waterMl', 'waterGoal'],
      component: 'WidgetWater',
      settings: {
        showMilliliters: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–ª' },
        showGlasses: { type: 'boolean', default: false, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞–∫–∞–Ω—ã' }
      }
    },

    weight: {
      type: 'weight',
      name: '–í–µ—Å',
      category: 'health',
      icon: '‚öñÔ∏è',
      description: '–¢–µ–∫—É—â–∏–π –≤–µ—Å –∏ —Ç—Ä–µ–Ω–¥',
      defaultSize: '4x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['day.weightMorning', 'prof.weight', 'prof.weightGoal', 'weightTrend'],
      component: 'WidgetWeight',
      settings: {
        showTrend: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥' },
        showGoal: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–µ–ª—å' },
        periodDays: { type: 'number', default: 7, label: '–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)', min: 3, max: 30 }
      }
    },

    steps: {
      type: 'steps',
      name: '–®–∞–≥–∏',
      category: 'health',
      icon: 'üëü',
      description: '–®–∞–≥–∏ –∑–∞ –¥–µ–Ω—å',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['day.steps', 'prof.stepsGoal'],
      component: 'WidgetSteps',
      settings: {
        showGoal: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–µ–ª—å' },
        showKilometers: { type: 'boolean', default: false, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–º' }
      }
    },

    // === –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ú–æ—Ç–∏–≤–∞—Ü–∏—è ===
    streak: {
      type: 'streak',
      name: 'Streak',
      category: 'motivation',
      icon: 'üî•',
      description: '–°–µ—Ä–∏—è –¥–Ω–µ–π –≤ –Ω–æ—Ä–º–µ',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['currentStreak', 'maxStreak'],
      component: 'WidgetStreak',
      settings: {
        showMax: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∫–æ—Ä–¥' },
        showFlame: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–≥–æ–Ω—å' }
      }
    },

    heatmap: {
      type: 'heatmap',
      name: '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞',
      category: 'motivation',
      icon: 'üìÖ',
      description: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü',
      defaultSize: '4x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['activeDays'],
      component: 'WidgetHeatmap',
      settings: {
        period: {
          type: 'select', default: 'week', label: '–ü–µ—Ä–∏–æ–¥', options: [
            { value: 'week', label: '–ù–µ–¥–µ–ª—è' },
            { value: 'month', label: '–ú–µ—Å—è—Ü' }
          ]
        }
      }
    },

    // === –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –¶–∏–∫–ª ===
    cycle: {
      type: 'cycle',
      name: '–¶–∏–∫–ª',
      category: 'cycle',
      icon: 'üå∏',
      description: '–î–µ–Ω—å –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞',
      defaultSize: '2x2',
      availableSizes: ALL_SIZES_4X4,
      dataKeys: ['day.cycleDay', 'cyclePhase'],
      component: 'WidgetCycle',
      requiresCondition: () => {
        const prof = HEYS.utils?.lsGet?.('heys_profile', {}) || {};
        return prof.gender === '–ñ–µ–Ω—Å–∫–∏–π' && prof.cycleTrackingEnabled === true;
      },
      settings: {
        showPhase: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–∞–∑—É' },
        showCorrections: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏' }
      }
    },

    // === –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ ===
    crashRisk: {
      type: 'crashRisk',
      name: '–†–∏—Å–∫ —Å—Ä—ã–≤–∞',
      category: 'health',
      icon: '‚ö†Ô∏è',
      description: 'Early Warning: 5% –Ω–µ–¥–µ–ª—å–Ω–∞—è –ø–æ—Ç–µ—Ä—è –≤–µ—Å–∞',
      defaultSize: '4x2',
      availableSizes: ['2x2', '3x2', '4x2', '4x3', '4x4'],
      dataKeys: ['day.weightMorning', 'weightTrend', 'earlyWarnings'],
      component: 'WidgetCrashRisk',
      settings: {
        showWarnings: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è' },
        showTrend: { type: 'boolean', default: true, label: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥' },
        periodDays: { type: 'number', default: 7, label: '–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)', min: 7, max: 14 }
      }
    }
  };

  // === Registry Implementation ===
  const registry = {
    /**
     * –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å ID —Ä–∞–∑–º–µ—Ä–∞:
     * - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç legacy –∏–º–µ–Ω–∞ (compact/wide/...) ‚Üí NxM
     * - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç sNxM (s4x3) ‚Üí NxM
     * - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª —É–º–Ω–æ–∂–µ–Ω–∏—è √ó ‚Üí x
     * @param {string} sizeId
     * @returns {string|null}
     */
    normalizeSizeId(sizeId) {
      if (!sizeId || typeof sizeId !== 'string') return null;

      // –£–∂–µ –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
      if (SIZES[sizeId]) return sizeId;

      // Legacy mapping
      if (LEGACY_SIZE_ALIASES[sizeId]) return LEGACY_SIZE_ALIASES[sizeId];

      // sNxM ‚Üí NxM
      const m = sizeId.match(/^s([1-4])x([1-4])$/);
      if (m) {
        const norm = `${m[1]}x${m[2]}`;
        return SIZES[norm] ? norm : sizeId;
      }

      // 4√ó3 ‚Üí 4x3
      if (sizeId.includes('√ó')) {
        const norm = sizeId.replace(/√ó/g, 'x');
        if (SIZES[norm]) return norm;
      }

      return sizeId;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –≤–∏–¥–∂–µ—Ç–∞
     * @param {string} type - ID —Ç–∏–ø–∞ –≤–∏–¥–∂–µ—Ç–∞
     * @returns {Object|null}
     */
    getType(type) {
      return WIDGET_TYPES[type] || null;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã –≤–∏–¥–∂–µ—Ç–æ–≤
     * @returns {Object[]}
     */
    getAllTypes() {
      return Object.values(WIDGET_TYPES);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     * @param {string} categoryId - ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     * @returns {Object[]}
     */
    getTypesByCategory(categoryId) {
      return Object.values(WIDGET_TYPES).filter(w => w.category === categoryId);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã (—É—á–∏—Ç—ã–≤–∞—è —É—Å–ª–æ–≤–∏—è)
     * @returns {Object[]}
     */
    getAvailableTypes() {
      return Object.values(WIDGET_TYPES).filter(widgetType => {
        if (typeof widgetType.requiresCondition === 'function') {
          return widgetType.requiresCondition();
        }
        return true;
      });
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     * @returns {Object[]}
     */
    getCategories() {
      return Object.values(CATEGORIES);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ ID
     * @param {string} categoryId
     * @returns {Object|null}
     */
    getCategory(categoryId) {
      return CATEGORIES[categoryId] || null;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å preset —Ä–∞–∑–º–µ—Ä–∞
     * @param {string} sizeId
     * @returns {Object|null}
     */
    getSize(sizeId) {
      const norm = this.normalizeSizeId(sizeId);
      return (norm && SIZES[norm]) ? SIZES[norm] : null;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–∞–∑–º–µ—Ä—ã
     * @returns {Object}
     */
    getSizes() {
      return { ...SIZES };
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ –≤–∏–¥–∂–µ—Ç —Ä–∞–∑–º–µ—Ä
     * @param {string} type - –¢–∏–ø –≤–∏–¥–∂–µ—Ç–∞
     * @param {string} sizeId - ID —Ä–∞–∑–º–µ—Ä–∞
     * @returns {boolean}
     */
    supportsSize(type, sizeId) {
      const widgetType = WIDGET_TYPES[type];
      if (!widgetType) return false;
      const norm = this.normalizeSizeId(sizeId);
      return widgetType.availableSizes.includes(norm);
    },

    /**
     * –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –≤–∏–¥–∂–µ—Ç–∞
     * @param {string} type - –¢–∏–ø –≤–∏–¥–∂–µ—Ç–∞
     * @param {Object} options - –û–ø—Ü–∏–∏ (id, size, settings, position)
     * @returns {Object} Widget instance
     */
    createWidget(type, options = {}) {
      const widgetType = WIDGET_TYPES[type];
      if (!widgetType) {
        console.error(`[Widgets Registry] Unknown widget type: ${type}`);
        return null;
      }

      const rawSize = options.size || widgetType.defaultSize;
      const size = this.normalizeSizeId(rawSize) || widgetType.defaultSize;
      const sizePreset = SIZES[size];

      if (!sizePreset) {
        console.error(`[Widgets Registry] Unknown size: ${rawSize}`);
        return null;
      }

      // Merge default settings with provided settings
      const defaultSettings = {};
      if (widgetType.settings) {
        Object.entries(widgetType.settings).forEach(([key, def]) => {
          defaultSettings[key] = def.default;
        });
      }

      return {
        id: options.id || `widget_${type}_${Date.now()}`,
        type: type,
        size: size,
        cols: sizePreset.cols,
        rows: sizePreset.rows,
        position: options.position || { col: 0, row: 0 },
        settings: { ...defaultSettings, ...(options.settings || {}) },
        createdAt: Date.now()
      };
    },

    /**
     * –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –≤–∏–¥–∂–µ—Ç–∞
     * @param {Object} widget
     * @returns {boolean}
     */
    validateWidget(widget) {
      if (!widget || typeof widget !== 'object') return false;
      if (!widget.id || typeof widget.id !== 'string') return false;
      if (!widget.type || !WIDGET_TYPES[widget.type]) return false;
      const norm = this.normalizeSizeId(widget.size);
      if (!norm || !SIZES[norm]) return false;
      return true;
    },

    /**
     * –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–∏–ø –≤–∏–¥–∂–µ—Ç–∞
     * @param {Object} widgetDef - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞
     */
    registerType(widgetDef) {
      if (!widgetDef.type) {
        console.error('[Widgets Registry] Widget definition must have a type');
        return false;
      }

      if (WIDGET_TYPES[widgetDef.type]) {
        console.warn(`[Widgets Registry] Overwriting existing widget type: ${widgetDef.type}`);
      }

      WIDGET_TYPES[widgetDef.type] = {
        ...widgetDef,
        defaultSize: widgetDef.defaultSize || '2x2',
        availableSizes: widgetDef.availableSizes || ['2x2'],
        category: widgetDef.category || 'advanced'
      };

      return true;
    }
  };

  // === Exports ===
  HEYS.Widgets.registry = registry;
  HEYS.Widgets.CATEGORIES = CATEGORIES;
  HEYS.Widgets.SIZES = SIZES;
  HEYS.Widgets.LEGACY_SIZE_ALIASES = LEGACY_SIZE_ALIASES;
  HEYS.Widgets.WIDGET_TYPES = WIDGET_TYPES;

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_widgets_data_crash_risk_v1.js ===== */
/**
 * heys_widgets_data_crash_risk_v1.js
 * Data Provider –¥–ª—è Crash Risk –≤–∏–¥–∂–µ—Ç–∞ (–¥–µ—Ç–µ–∫—Ü–∏—è >5%/–Ω–µ–¥ –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ + EWS)
 * Version: 1.0.0
 * Created: 2026-02-15
 * 
 * –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
 * - Weight data: heys_day_weight_trends_v1.js
 * - EWS backend: insights/pi_early_warning.js
 * 
 * –§–æ—Ä–º—É–ª–∞ —Ä–∏—Å–∫–∞: weeklyLossPercent = |slope √ó 7 / currentWeight| √ó 100
 * Thresholds: >5% warning (medium), >7% high severity
 */
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};
    HEYS.Widgets = HEYS.Widgets || {};
    HEYS.Widgets.DataProviders = HEYS.Widgets.DataProviders || {};

    // ============================================================================
    // CONSTANTS
    // ============================================================================

    const THRESHOLDS = {
        WARNING: 5,      // >5% loss/week ‚Üí medium severity
        HIGH: 7,         // >7% loss/week ‚Üí high severity
        MIN_DAYS: 7,     // Minimum days for reliable trend
        MAX_DAYS: 14     // Maximum lookback period
    };

    const SEVERITY_LEVELS = {
        NONE: 'none',
        MEDIUM: 'medium',
        HIGH: 'high'
    };

    // ============================================================================
    // HELPERS
    // ============================================================================

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Å –∏–∑ day data —Å —É—á–µ—Ç–æ–º retention days
     * @param {Object} dayData - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
     * @returns {number|null} - –≤–µ—Å –≤ –∫–≥ –∏–ª–∏ null
     */
    function getWeightFromDay(dayData) {
        if (!dayData) return null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ retention day (–≤–µ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è)
        if (dayData.weightMorning && dayData.weightMorning > 0) {
            return dayData.weightMorning;
        }

        return null;
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å weight data –∑–∞ N –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–Ω–µ–π
     * @param {number} days - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
     * @returns {Array<{date: string, weight: number}>}
     */
    function loadWeightData(days) {
        const U = HEYS.utils || {};
        const result = [];
        const today = new Date();

        for (let i = 0; i < days; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];

            const dayData = U.lsGet(`heys_dayv2_${dateStr}`, null);
            const weight = getWeightFromDay(dayData);

            if (weight !== null && weight > 0) {
                result.push({ date: dateStr, weight });
            }
        }

        return result.reverse(); // Oldest first –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
    }

    /**
     * Linear regression –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ slope (–∫–≥/–¥–µ–Ω—å)
     * @param {Array<{date: string, weight: number}>} data
     * @returns {{slope: number, intercept: number, r2: number}|null}
     */
    function calculateLinearRegression(data) {
        if (!data || data.length < 3) return null;

        const n = data.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

        data.forEach((point, i) => {
            const x = i; // Day index
            const y = point.weight;
            sumX += x;
            sumY += y;
            sumXY += x * y;
            sumX2 += x * x;
        });

        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        // R¬≤ calculation
        const yMean = sumY / n;
        let ssTotal = 0, ssResidual = 0;
        data.forEach((point, i) => {
            const yPred = slope * i + intercept;
            ssTotal += Math.pow(point.weight - yMean, 2);
            ssResidual += Math.pow(point.weight - yPred, 2);
        });
        const r2 = 1 - (ssResidual / ssTotal);

        return { slope, intercept, r2 };
    }

    /**
     * –í—ã—á–∏—Å–ª–∏—Ç—å weekly loss percentage
     * @param {number} slope - –Ω–∞–∫–ª–æ–Ω –∫–≥/–¥–µ–Ω—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
     * @param {number} currentWeight - —Ç–µ–∫—É—â–∏–π –≤–µ—Å –≤ –∫–≥
     * @returns {number} - –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ—Ç–µ—Ä–∏ –≤–µ—Å–∞ –∑–∞ –Ω–µ–¥–µ–ª—é (–≤—Å–µ–≥–¥–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π)
     */
    function calculateWeeklyLossPercent(slope, currentWeight) {
        if (!currentWeight || currentWeight <= 0) return 0;

        // |slope √ó 7 / currentWeight| √ó 100
        // –ï—Å–ª–∏ slope < 0 (–ø–æ—Ç–µ—Ä—è –≤–µ—Å–∞), abs –¥–µ–ª–∞–µ—Ç —á–∏—Å–ª–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
        const weeklyLoss = Math.abs(slope * 7);
        const percent = (weeklyLoss / currentWeight) * 100;

        return percent;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å severity level –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –ø–æ—Ç–µ—Ä–∏
     * @param {number} weeklyLossPercent
     * @returns {string} - 'none'|'medium'|'high'
     */
    function getSeverity(weeklyLossPercent) {
        if (weeklyLossPercent >= THRESHOLDS.HIGH) return SEVERITY_LEVELS.HIGH;
        if (weeklyLossPercent >= THRESHOLDS.WARNING) return SEVERITY_LEVELS.MEDIUM;
        return SEVERITY_LEVELS.NONE;
    }

    // ============================================================================
    // MAIN DATA PROVIDER
    // ============================================================================

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è Crash Risk –≤–∏–¥–∂–µ—Ç–∞
     * @param {Object} options
     * @param {number} [options.days=7] - –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (7-14)
     * @returns {Object|null}
     */
    function getCrashRiskData(options = {}) {
        const days = Math.max(THRESHOLDS.MIN_DAYS, Math.min(options.days || 7, THRESHOLDS.MAX_DAYS));
        const U = HEYS.utils || {};
        const profile = U.lsGet('heys_profile', {});
        const pIndex = profile?.pIndex || 0;

        try {
            // 1. Load weight data
            const weightData = loadWeightData(days);

            if (weightData.length < 3) {
                console.info('[HEYS.widgets.crashRisk] ‚ö†Ô∏è Insufficient data:', {
                    dataPoints: weightData.length,
                    minRequired: 3
                });
                return {
                    hasData: false,
                    weeklyLossPercent: 0,
                    isWarning: false,
                    severity: SEVERITY_LEVELS.NONE,
                    message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º 3 –¥–Ω—è —Å –≤–µ—Å–æ–º)',
                    ewsCount: 0,
                    ewsData: null
                };
            }

            // 2. Calculate linear regression
            const regression = calculateLinearRegression(weightData);

            if (!regression) {
                console.warn('[HEYS.widgets.crashRisk] ‚ùå Regression calculation failed');
                return null;
            }

            const currentWeight = weightData[weightData.length - 1].weight;
            const weeklyLossPercent = calculateWeeklyLossPercent(regression.slope, currentWeight);
            const severity = getSeverity(weeklyLossPercent);
            const isWarning = severity !== SEVERITY_LEVELS.NONE;

            // 3. Fetch EWS data (Early Warning System)
            let ewsData = null;
            let ewsCount = 0;

            if (HEYS.InsightsPI && HEYS.InsightsPI.earlyWarning) {
                try {
                    ewsData = HEYS.InsightsPI.earlyWarning.detect(days, profile, pIndex, {
                        includeDetails: true
                    });
                    ewsCount = ewsData?.count || 0;
                } catch (ewsError) {
                    console.warn('[HEYS.widgets.crashRisk] ‚ö†Ô∏è EWS detection failed:', ewsError);
                }
            }

            // 4. Construct result
            const result = {
                hasData: true,
                weeklyLossPercent,
                isWarning,
                severity,
                currentWeight,
                weightData,
                regression: {
                    slope: regression.slope,
                    r2: regression.r2,
                    slopePerWeek: regression.slope * 7
                },
                ewsCount,
                ewsData,
                dataPoints: weightData.length,
                periodDays: days
            };

            // 5. Verification logging
            console.info('[HEYS.widgets.crashRisk] ‚úÖ Data computed:', {
                weeklyLossPercent: weeklyLossPercent.toFixed(2) + '%',
                severity,
                isWarning,
                currentWeight: currentWeight.toFixed(1) + 'kg',
                dataPoints: weightData.length,
                periodDays: days,
                slope: (regression.slope * 7).toFixed(3) + 'kg/week',
                r2: regression.r2.toFixed(3),
                ewsCount
            });

            return result;

        } catch (error) {
            console.error('[HEYS.widgets.crashRisk] ‚ùå Fatal error:', error);
            return null;
        }
    }

    // ============================================================================
    // EXPORT
    // ============================================================================

    HEYS.Widgets.DataProviders.crashRisk = {
        getData: getCrashRiskData,
        THRESHOLDS,
        SEVERITY_LEVELS
    };

    console.info('[HEYS.widgets.crashRisk] ‚úÖ Data provider v1.0.0 loaded');

})(window);


/* ===== heys_widgets_core_v1.js ===== */
/**
 * heys_widgets_core_v1.js
 * –Ø–¥—Ä–æ –≤–∏–¥–∂–µ—Ç–æ–≤: Grid Engine, Drag & Drop, State Manager
 * Version: 1.3.0 ‚Äî Phase 1: Core Engine + Cloud Sync Protection
 * Created: 2025-12-15
 * Updated: 2025-12-16
 * 
 * Phase 1 features:
 * - Undo/Redo history stack
 * - Ghost element + placeholder preview
 * - Long press detection (500ms)
 * - Improved collision detection
 * - Debounced persistence
 * 
 * v1.3.0 FIX (2025-12-16):
 * - saveLayout() —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç { widgets, updatedAt } –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
 * - loadLayout() –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (legacy array + new object)
 * - –ó–∞—â–∏—Ç–∞ cloud sync: –ª–æ–∫–∞–ª—å–Ω—ã–π layout –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ—Ç—Å—è –æ–±–ª–∞—á–Ω—ã–º –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –Ω–æ–≤–µ–µ
 * - –°–æ–±—ã—Ç–∏–µ heys:widget-layout-updated –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ cloud sync
 * 
 * v1.2.0 FIX (2025-12-16):
 * - saveLayout() –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö)
 * - saveLayout() –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å storage)
 * - beforeunload/visibilitychange –ø—Ä–æ–≤–µ—Ä—è—é—Ç _initialized –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
 */
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.Widgets = HEYS.Widgets || {};

  // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ª–æ–≥-—Ö–µ–ª–ø–µ—Ä—ã (—á–µ—Ä–µ–∑ HEYS.log/HEYS.err)
  const log = (...args) => {
    if (HEYS?.log) {
      HEYS.log('Widgets Core', ...args);
      return;
    }
    if (global.HEYS?.debug) {
      console.log('[Widgets Core]', ...args);
    }
  };
  const warn = (...args) => {
    if (HEYS?.log) {
      HEYS.log('Widgets Core', '‚ö†Ô∏è', ...args);
      return;
    }
    console.warn('[Widgets Core]', ...args);
  };
  const err = (...args) => {
    if (HEYS?.err) {
      HEYS.err('Widgets Core', ...args);
      return;
    }
    console.error('[Widgets Core]', ...args);
  };

  // === Constants ===
  const STORAGE_KEY = 'heys_widget_layout_v1';
  const STORAGE_META_KEY = 'heys_widget_layout_meta_v1';
  const GRID_COLS = 4; // 4 –∫–æ–ª–æ–Ω–∫–∏: 1 –∫–æ–ª–æ–Ω–∫–∞/—Ä—è–¥ = –±–∞–∑–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞
  const GRID_VERSION = 2;
  const MAX_HISTORY = 20; // –ú–∞–∫—Å–∏–º—É–º —à–∞–≥–æ–≤ undo/redo
  const SAVE_DEBOUNCE_MS = 500; // Debounce –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  const LONG_PRESS_MS = 500; // –í—Ä–µ–º—è –¥–ª—è long press
  // –í–ê–ñ–ù–û: –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –ø–æ –≤—ã—Å–æ—Ç–µ —Ä—è–¥–∞ ‚Äî CSS var --widget-row-height.
  // –ó–¥–µ—Å—å ‚Äî fallback –Ω–∞ —Å–ª—É—á–∞–π —Ä–∞–Ω–Ω–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π.
  const CELL_HEIGHT_PX = 76; // fallback
  const CELL_GAP_PX = 12; // fallback

  const DEFAULT_LAYOUT = [
    // 4-–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞ ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    // –†—è–¥ 0: –ö–∞–ª–æ—Ä–∏–∏ + –í–æ–¥–∞ (–±–∞–∑–æ–≤—ã–µ)
    { type: 'calories', size: '2x2', position: { col: 0, row: 0 } },
    { type: 'water', size: '2x2', position: { col: 2, row: 0 } },
    // –†—è–¥ 2: –í–µ—Å (–ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞) ‚Äî BMI + –≥—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–¥–∞
    { type: 'weight', size: '4x2', position: { col: 0, row: 2 } },
    // –†—è–¥ 4: –†–∏—Å–∫ —Å—Ä—ã–≤–∞ (–ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞) ‚Äî —Ñ–∞–∫—Ç–æ—Ä—ã + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
    { type: 'crashRisk', size: '4x2', position: { col: 0, row: 4 } },
    // –†—è–¥ 6: –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞) ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è
    { type: 'heatmap', size: '4x1', position: { col: 0, row: 6 } }
  ];

  // === State Manager with Undo/Redo ===
  const state = {
    _widgets: [],
    _history: [], // Undo stack
    _future: [], // Redo stack
    _editMode: false,
    _draggedWidget: null,
    _initialized: false,
    _saveTimeout: null,

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è state manager
     */
    init() {
      if (this._initialized) return;

      const meta = this.loadLayoutMeta();
      let saved = this.loadLayout() || [];

      // –ú–∏–≥—Ä–∞—Ü–∏—è layout 2-–∫–æ–ª–æ–Ω–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏ ‚Üí 4-–∫–æ–ª–æ–Ω–æ—á–Ω—É—é.
      // –í–∞–∂–Ω–æ: –¥–µ–ª–∞–µ–º –û–î–ò–ù —Ä–∞–∑ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤ meta.
      const needsMigration = !meta || meta.gridVersion !== GRID_VERSION || meta.gridCols !== GRID_COLS;
      if (needsMigration && saved && Array.isArray(saved) && saved.length > 0) {
        // –í–∞–∂–Ω–æ: saveLayout() —Ä–∞–Ω—å—à–µ —Å–æ—Ö—Ä–∞–Ω—è–ª this._widgets (–µ—â—ë –ø—É—Å—Ç–æ–π) ‚Üí –º–æ–≥ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞—Ç—å storage.
        // –ü–æ—ç—Ç–æ–º—É: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π layout –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ò–ú–ï–ù–ù–û –µ–≥–æ.
        const migrated = this._migrateLayout(saved, meta);
        const normalizedWidgets = migrated.map(w => this._normalizeWidget(w));
        const normalizedLayoutData = normalizedWidgets.map(w => ({
          id: w.id,
          type: w.type,
          size: w.size,
          position: w.position,
          settings: w.settings,
          createdAt: w.createdAt
        }));

        saved = normalizedLayoutData;

        // –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º meta + —Ç–µ–∫—É—â–∏–π layout
        this.saveLayoutMeta({ gridVersion: GRID_VERSION, gridCols: GRID_COLS, migratedAt: Date.now() });
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É (–±–µ–∑ debounce)
        try { this.saveLayout(normalizedLayoutData); } catch (e) { }
      }

      if (saved && Array.isArray(saved) && saved.length > 0) {
        // üîç DEBUG: –ª–æ–≥–∏—Ä—É–µ–º raw –¥–∞–Ω–Ω—ã–µ –∏–∑ storage (JSON –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è)
        log('RAW from storage:', JSON.stringify(saved.map(w => ({
          type: w.type,
          size: w.size,
          pos: w.position
        }))));
        this._widgets = saved.map(w => this._normalizeWidget(w));
      } else {
        this._widgets = this._createDefaultLayout();
        // —Ñ–∏–∫—Å–∏—Ä—É–µ–º meta –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
        this.saveLayoutMeta({ gridVersion: GRID_VERSION, gridCols: GRID_COLS, migratedAt: Date.now() });
      }

      // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      this._history = [];
      this._future = [];

      this._initialized = true;
      HEYS.Widgets.emit('layout:loaded', { layout: this._widgets });
      log('State initialized with', this._widgets.length, 'widgets');
      // üîç DEBUG: –ª–æ–≥–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      log('Final widgets:', this._widgets.map(w => ({
        id: w.id?.substring(0, 20),
        type: w.type,
        size: w.size,
        cols: w.cols,
        rows: w.rows
      })));
    },

    /**
     * –ü–æ–ª–Ω–∞—è —Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
     * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç layout –¥–ª—è –Ω–æ–≤–æ–≥–æ clientId
     * @param {string} [forClientId] - —è–≤–Ω—ã–π clientId (–∏–Ω–∞—á–µ –±–µ—Ä—ë–º –∏–∑ HEYS.currentClientId)
     */
    reinit(forClientId) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π clientId, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç race condition —Å HEYS.currentClientId
      const cid = forClientId || window.HEYS?.currentClientId || '';
      log(`reinit: clientId="${cid ? cid.slice(0, 8) + '...' : 'EMPTY!'}" (explicit: ${!!forClientId})`);

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      this._initialized = false;
      this._widgets = [];
      this._history = [];
      this._future = [];

      // –û—á–∏—â–∞–µ–º memory cache –≤ HEYS.store –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤
      if (HEYS.store?.invalidate) {
        HEYS.store.invalidate(STORAGE_KEY);
        HEYS.store.invalidate(STORAGE_META_KEY);
      }

      // –í—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º clientId –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —è–≤–Ω–æ (—á—Ç–æ–±—ã init() –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
      const prevClientId = window.HEYS?.currentClientId;
      if (forClientId && window.HEYS) {
        window.HEYS.currentClientId = forClientId;
      }

      // –ó–∞–Ω–æ–≤–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º (—Ç–µ–ø–µ—Ä—å —Å –Ω–æ–≤—ã–º clientId)
      this.init();

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π clientId –µ—Å–ª–∏ –æ–Ω –æ—Ç–ª–∏—á–∞–ª—Å—è (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ App –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏–ª –µ–≥–æ)
      // –≠—Ç–æ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ init() –∑–∞–≤–∏—Å–∏—Ç –æ—Ç HEYS.currentClientId –≤–Ω—É—Ç—Ä–∏
      // –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ HEYS.store.get() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HEYS.currentClientId –¥–ª—è scoping
    },

    /**
     * Meta –¥–ª—è layout (—á—Ç–æ–±—ã –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª–∞—Å—å)
     */
    loadLayoutMeta() {
      try {
        if (HEYS.store?.get) {
          return HEYS.store.get(STORAGE_META_KEY, null);
        } else if (HEYS.utils?.lsGet) {
          return HEYS.utils.lsGet(STORAGE_META_KEY, null);
        } else {
          const stored = localStorage.getItem(STORAGE_META_KEY);
          return stored ? JSON.parse(stored) : null;
        }
      } catch (e) {
        return null;
      }
    },

    saveLayoutMeta(meta) {
      try {
        if (HEYS.store?.set) {
          HEYS.store.set(STORAGE_META_KEY, meta);
        } else if (HEYS.utils?.lsSet) {
          HEYS.utils.lsSet(STORAGE_META_KEY, meta);
        } else {
          localStorage.setItem(STORAGE_META_KEY, JSON.stringify(meta));
        }
      } catch (e) {
        // no-op
      }
    },

    /**
     * –ú–∏–≥—Ä–∞—Ü–∏—è layout (v1: GRID_COLS=2) ‚Üí (v2: GRID_COLS=4).
     * –°—Ç—Ä–∞—Ç–µ–≥–∏—è:
     * 1) –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã √ó2 (col/row)
     * 2) –ó–∞—Ç–µ–º ¬´—É–ø–∞–∫–æ–≤—ã–≤–∞–µ–º¬ª –≤–∏–¥–∂–µ—Ç—ã –∑–∞–Ω–æ–≤–æ –ø–æ –∏—Ö –≤–∏–∑—É–∞–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É,
     *    —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–ª–∏–∑–∏–π –Ω–∞ –Ω–æ–≤—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö.
     */
    _migrateLayout(savedLayout, meta) {
      const fromCols = meta?.gridCols || 2;
      const toCols = GRID_COLS;
      const scale = toCols / fromCols;

      // –ï—Å–ª–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ —É–∂–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (!Number.isFinite(scale) || scale <= 0 || scale === 1) {
        return savedLayout;
      }

      const scaled = savedLayout.map((w) => {
        const pos = w?.position || { col: 0, row: 0 };
        return {
          ...w,
          position: {
            col: Math.max(0, Math.round((pos.col || 0) * scale)),
            row: Math.max(0, Math.round((pos.row || 0) * scale))
          }
        };
      });

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º (–ø–æ–ª—É—á–∏–º –Ω–æ–≤—ã–µ cols/rows –∏–∑ registry) –∏ —Ä–µ–ø–∞–∫—É–µ–º
      const normalized = scaled.map((w) => this._normalizeWidget(w));
      const packedPositions = this._packLayoutPositions(normalized);

      return normalized.map((w) => ({
        id: w.id,
        type: w.type,
        size: w.size,
        position: packedPositions[w.id] || w.position,
        settings: w.settings,
        createdAt: w.createdAt
      }));
    },

    _packLayoutPositions(widgets) {
      const sorted = [...(widgets || [])].sort((a, b) => {
        if ((a.position?.row || 0) !== (b.position?.row || 0)) return (a.position?.row || 0) - (b.position?.row || 0);
        return (a.position?.col || 0) - (b.position?.col || 0);
      });

      const occupied = new Set();
      const positions = {};

      const occupy = (w, col, row) => {
        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const sizeInfo = HEYS.Widgets.registry.getSize(w.size);
        const wCols = sizeInfo?.cols || w.cols || 1;
        const wRows = sizeInfo?.rows || w.rows || 1;

        for (let c = 0; c < wCols; c++) {
          for (let r = 0; r < wRows; r++) {
            occupied.add(`${col + c},${row + r}`);
          }
        }
      };

      const canPlace = (col, row, cols, rows) => {
        if (col < 0 || col + cols > GRID_COLS) return false;
        if (row < 0) return false;
        for (let c = 0; c < cols; c++) {
          for (let r = 0; r < rows; r++) {
            if (occupied.has(`${col + c},${row + r}`)) return false;
          }
        }
        return true;
      };

      for (const w of sorted) {
        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const sizeInfo = HEYS.Widgets.registry.getSize(w.size);
        const wCols = sizeInfo?.cols || w.cols || 1;
        const wRows = sizeInfo?.rows || w.rows || 1;

        let placed = false;
        for (let row = 0; row < 200 && !placed; row++) {
          for (let col = 0; col <= GRID_COLS - wCols; col++) {
            if (canPlace(col, row, wCols, wRows)) {
              positions[w.id] = { col, row };
              occupy(w, col, row);
              placed = true;
              break;
            }
          }
        }

        if (!placed) {
          // fallback: –≤ —Å–∞–º—ã–π –Ω–∏–∑
          const maxRow = Math.max(0, ...Object.values(positions).map(p => p.row));
          positions[w.id] = { col: 0, row: maxRow + 1 };
          occupy(w, positions[w.id].col, positions[w.id].row);
        }
      }

      return positions;
    },

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (–¥–ª—è undo)
     * @private
     */
    _pushHistory() {
      // –ì–ª—É–±–æ–∫–æ–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      const snapshot = JSON.parse(JSON.stringify(this._widgets));
      this._history.push(snapshot);

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
      if (this._history.length > MAX_HISTORY) {
        this._history.shift();
      }

      // –û—á–∏—â–∞–µ–º future –ø—Ä–∏ –Ω–æ–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
      this._future = [];
    },

    /**
     * Undo ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
     * @returns {boolean}
     */
    undo() {
      if (this._history.length === 0) {
        log('Nothing to undo');
        return false;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ future
      this._future.push(JSON.parse(JSON.stringify(this._widgets)));

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      this._widgets = this._history.pop();
      this._debouncedSave();

      HEYS.Widgets.emit('history:undo', { layout: this._widgets });
      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });

      log('Undo performed, history:', this._history.length, 'future:', this._future.length);
      return true;
    },

    /**
     * Redo ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
     * @returns {boolean}
     */
    redo() {
      if (this._future.length === 0) {
        log('Nothing to redo');
        return false;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ history
      this._history.push(JSON.parse(JSON.stringify(this._widgets)));

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º future —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      this._widgets = this._future.pop();
      this._debouncedSave();

      HEYS.Widgets.emit('history:redo', { layout: this._widgets });
      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });

      log('Redo performed, history:', this._history.length, 'future:', this._future.length);
      return true;
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å undo
     * @returns {boolean}
     */
    canUndo() {
      return this._history.length > 0;
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å redo
     * @returns {boolean}
     */
    canRedo() {
      return this._future.length > 0;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
     * @returns {Object}
     */
    getHistoryInfo() {
      return {
        undoCount: this._history.length,
        redoCount: this._future.length,
        canUndo: this.canUndo(),
        canRedo: this.canRedo()
      };
    },

    /**
     * –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∏–¥–∂–µ—Ç (–¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è)
     */
    _normalizeWidget(w) {
      const registry = HEYS.Widgets.registry;
      const type = registry?.getType(w.type);

      // Backward compatibility: –≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö layout'–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å legacy size-id.
      const rawSizeId = w.size || type?.defaultSize || '2x2';
      const normalizedSizeId = registry?.normalizeSizeId
        ? (registry.normalizeSizeId(rawSizeId) || '2x2')
        : rawSizeId;

      const size = registry?.getSize(normalizedSizeId);

      // üîç DEBUG: –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º
      if (rawSizeId !== normalizedSizeId || !w.size) {
        log(`_normalizeWidget ${w.type}: raw=${w.size || 'undefined'} ‚Üí normalized=${normalizedSizeId} (default=${type?.defaultSize})`);
      }

      return {
        id: w.id || `widget_${w.type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        type: w.type,
        size: normalizedSizeId,
        cols: size?.cols || 1,
        rows: size?.rows || 1,
        position: w.position || { col: 0, row: 0 },
        settings: w.settings || {},
        createdAt: w.createdAt || Date.now()
      };
    },

    /**
     * –°–æ–∑–¥–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π layout
     */
    _createDefaultLayout() {
      const registry = HEYS.Widgets.registry;
      return DEFAULT_LAYOUT.map((def, idx) => {
        const widget = registry?.createWidget(def.type, {
          size: def.size,
          position: def.position
        });
        return widget || this._normalizeWidget(def);
      }).filter(Boolean);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã
     * @returns {Object[]}
     */
    getWidgets() {
      return [...this._widgets];
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç –ø–æ ID
     * @param {string} id
     * @returns {Object|null}
     */
    getWidget(id) {
      return this._widgets.find(w => w.id === id) || null;
    },

    /**
     * Debounced save ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
     * @private
     */
    _debouncedSave() {
      if (this._saveTimeout) {
        clearTimeout(this._saveTimeout);
      }
      this._saveTimeout = setTimeout(() => {
        this.saveLayout();
        this._saveTimeout = null;
      }, SAVE_DEBOUNCE_MS);
    },

    /**
     * –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç
     * @param {Object} widget
     * @param {boolean} skipHistory - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é (–¥–ª—è undo/redo)
     */
    addWidget(widget, skipHistory = false) {
      if (!skipHistory) {
        this._pushHistory();
      }

      const normalized = this._normalizeWidget(widget);

      // –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
      if (!widget.position || (widget.position.col === 0 && widget.position.row === 0)) {
        normalized.position = gridEngine.findFreePosition(normalized.cols, normalized.rows);
      }

      this._widgets.push(normalized);
      this._debouncedSave();

      HEYS.Widgets.emit('widget:added', { widget: normalized });
      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });

      // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }

      return normalized;
    },

    /**
     * –£–¥–∞–ª–∏—Ç—å –≤–∏–¥–∂–µ—Ç
     * @param {string} id
     * @param {boolean} skipHistory - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
     */
    removeWidget(id, skipHistory = false) {
      const index = this._widgets.findIndex(w => w.id === id);
      if (index === -1) return false;

      if (!skipHistory) {
        this._pushHistory();
      }

      const removed = this._widgets.splice(index, 1)[0];
      this._debouncedSave();

      HEYS.Widgets.emit('widget:removed', { widgetId: id, widget: removed });
      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });

      // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
      if (navigator.vibrate) {
        navigator.vibrate([10, 50, 10]);
      }

      return true;
    },

    /**
     * –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç
     * @param {string} id
     * @param {Object} updates
     * @param {boolean} skipHistory - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
     */
    updateWidget(id, updates, skipHistory = false) {
      const widget = this.getWidget(id);
      if (!widget) return false;

      if (!skipHistory) {
        this._pushHistory();
      }

      const oldWidget = { ...widget, position: { ...widget.position } };

      // üîí –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º sizeId –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ–±—ã:
      // - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å legacy id (mini/compact/large)
      // - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–∏–º–≤–æ–ª "√ó" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1√ó1")
      // - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç cols/rows –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π DnD placeholder
      let nextUpdates = updates;
      if (updates && Object.prototype.hasOwnProperty.call(updates, 'size')) {
        const reg = HEYS.Widgets.registry;
        const raw = updates.size;
        const normalized = reg?.normalizeSizeId ? (reg.normalizeSizeId(raw) || raw) : raw;
        if (normalized !== raw) {
          nextUpdates = { ...updates, size: normalized };
        }
      }

      Object.assign(widget, nextUpdates);

      // –û–±–Ω–æ–≤–∏—Ç—å cols/rows –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è size
      if (nextUpdates && nextUpdates.size) {
        const size = HEYS.Widgets.registry?.getSize(nextUpdates.size);
        if (size) {
          widget.cols = size.cols;
          widget.rows = size.rows;
        }
      }

      // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
      if (nextUpdates && nextUpdates.position) {
        widget.position = { ...nextUpdates.position };
      }

      this._debouncedSave();

      if (nextUpdates && nextUpdates.position) {
        HEYS.Widgets.emit('widget:moved', { widget, from: oldWidget.position, to: updates.position });
        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
      if (nextUpdates && nextUpdates.size) {
        HEYS.Widgets.emit('widget:resized', { widget, from: oldWidget.size, to: nextUpdates.size });
      }
      if (nextUpdates && nextUpdates.settings) {
        HEYS.Widgets.emit('widget:settings', { widget, settings: updates.settings });
      }

      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });
      return true;
    },

    /**
     * –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–∏–¥–∂–µ—Ç
     * @param {string} id
     * @param {Object} position - { col, row }
     * @param {boolean} skipHistory
     */
    moveWidget(id, position, skipHistory = false) {
      const result = this.updateWidget(id, { position }, skipHistory);
      if (result) {
        // üÜï –í—ã—Ç–µ—Å–Ω—è–µ–º –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –≤–∏–¥–∂–µ—Ç—ã –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞
        gridEngine.displaceCollidingWidgets(id);
      }
      return result;
    },

    /**
     * –ü–æ–º–µ–Ω—è—Ç—å –¥–≤–∞ –≤–∏–¥–∂–µ—Ç–∞ –º–µ—Å—Ç–∞–º–∏ (–ø–æ–∑–∏—Ü–∏—è–º–∏).
     * –ù—É–∂–µ–Ω –¥–ª—è iOS-like –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏: drop –Ω–∞ –∑–∞–Ω—è—Ç–æ–µ –º–µ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç swap.
     * @param {string} idA
     * @param {string} idB
     * @param {boolean} skipHistory
     * @returns {boolean}
     */
    swapWidgets(idA, idB, skipHistory = false) {
      const a = this.getWidget(idA);
      const b = this.getWidget(idB);
      if (!a || !b) return false;

      const posA = { ...a.position };
      const posB = { ...b.position };

      if (!skipHistory) {
        this._pushHistory();
      }

      // –î–µ–ª–∞–µ–º swap –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ history push
      this.updateWidget(idA, { position: posB }, true);
      this.updateWidget(idB, { position: posA }, true);

      // üÜï –ü–æ—Å–ª–µ swap –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ –¥–ª—è –æ–±–æ–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤
      gridEngine.displaceCollidingWidgets(idA);
      gridEngine.displaceCollidingWidgets(idB);

      HEYS.Widgets.emit('widget:swapped', { a: idA, b: idB, from: posA, to: posB });
      return true;
    },

    /**
     * –ú–∞—Å—Å–æ–≤–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ (–æ–¥–Ω–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏).
     * @param {Record<string, {col:number,row:number}>} positionsById
     * @param {boolean} skipHistory
     * @returns {boolean}
     */
    applyPositions(positionsById, skipHistory = false) {
      if (!positionsById || typeof positionsById !== 'object') return false;

      if (!skipHistory) {
        this._pushHistory();
      }

      let changed = false;
      for (const w of this._widgets) {
        const next = positionsById[w.id];
        if (!next) continue;
        if (w.position.col !== next.col || w.position.row !== next.row) {
          w.position = { col: next.col, row: next.row };
          changed = true;
        }
      }

      if (changed) {
        this._debouncedSave();
        HEYS.Widgets.emit('layout:changed', { layout: this._widgets });

        // üÜï –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –Ω–µ—Ç –∫–æ–ª–ª–∏–∑–∏–π
        // (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ reflow —Ä–∞—Å—á—ë—Ç –±—ã–ª –Ω–µ—Ç–æ—á–Ω—ã–º)
        for (const widgetId of Object.keys(positionsById)) {
          gridEngine.displaceCollidingWidgets(widgetId);
        }
      }

      return changed;
    },

    /**
     * –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞
     * @param {string} id
     * @param {string} size
     */
    resizeWidget(id, size) {
      return this.resizeWidgetAt(id, size, null);
    },

    /**
     * –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ —Å —è–∫–æ—Ä–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é.
     * –ù—É–∂–Ω–æ –¥–ª—è resize –æ—Ç –ª–µ–≤–æ–≥–æ/–≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è: –º–µ–Ω—è–µ—Ç—Å—è –∏ size, –∏ position.
     *
     * –°–≤–æ–±–æ–¥–Ω–∞—è —Å–µ—Ç–∫–∞: –ø—Ä–∏ resize –≤—ã—Ç–µ—Å–Ω—è–µ–º –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –≤–∏–¥–∂–µ—Ç—ã –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞.
     *
     * @param {string} id
     * @param {string} size
     * @param {{col:number,row:number}|null} position
     */
    resizeWidgetAt(id, size, position = null) {
      log(`resizeWidgetAt called: id=${id}, size=${size}, position=`, position);
      const widget = this.getWidget(id);
      if (!widget) return false;

      const registry = HEYS.Widgets.registry;
      const normalizedSize = registry?.normalizeSizeId ? (registry.normalizeSizeId(size) || size) : size;
      log(`resizeWidgetAt: widget.type=${widget.type}, oldSize=${widget.size}, newSize=${normalizedSize}`);
      if (!registry.supportsSize(widget.type, normalizedSize)) {
        warn(`Widget ${widget.type} does not support size ${normalizedSize}`);
        return false;
      }

      const nextPos = (position && Number.isFinite(position.col) && Number.isFinite(position.row))
        ? { col: position.col, row: position.row }
        : { ...widget.position };

      // 1) –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
      this._pushHistory();

      // 2) –ú–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä (+ —è–∫–æ—Ä–Ω—É—é –ø–æ–∑–∏—Ü–∏—é)
      const resized = this.updateWidget(id, { size: normalizedSize, position: nextPos }, true);
      if (!resized) {
        return false;
      }

      // 3) üÜï –í—ã—Ç–µ—Å–Ω—è–µ–º –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –≤–∏–¥–∂–µ—Ç—ã –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞
      gridEngine.displaceCollidingWidgets(id);

      // layout:changed —ç–º–∏—Ç–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ updateWidget
      return true;
    },

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å layout –≤ storage (cloud sync)
     */
    saveLayout(layoutOverride = null) {
      // üîß FIX: –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–∏–Ω–∞—á–µ –∑–∞—Ç—Ä—ë–º storage –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º)
      if (!this._initialized && !Array.isArray(layoutOverride)) {
        warn('saveLayout skipped: not initialized');
        return;
      }

      const widgetsData = (Array.isArray(layoutOverride) && layoutOverride.length > 0)
        ? layoutOverride
        : this._widgets.map(w => ({
          id: w.id,
          type: w.type,
          size: w.size,
          position: w.position,
          settings: w.settings,
          createdAt: w.createdAt
        }));

      // üîß FIX: –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π layout (–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)
      if (!widgetsData || widgetsData.length === 0) {
        warn('saveLayout skipped: empty widgets array');
        return;
      }

      // üîß –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –æ–±—ä–µ–∫—Ç —Å updatedAt –¥–ª—è cloud sync conflict resolution
      const layoutData = {
        widgets: widgetsData,
        updatedAt: Date.now()
      };

      // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º clientId –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
      const cid = window.HEYS?.currentClientId || '';
      log(`saveLayout: clientId="${cid ? cid.slice(0, 8) + '...' : 'EMPTY!'}", widgets=${widgetsData.length}, key=${STORAGE_KEY}`);

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store –¥–ª—è cloud sync
      if (HEYS.store?.set) {
        HEYS.store.set(STORAGE_KEY, layoutData);
      } else if (HEYS.utils?.lsSet) {
        HEYS.utils.lsSet(STORAGE_KEY, layoutData);
      } else {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(layoutData));
        } catch (e) {
          err('Failed to save layout:', e);
        }
      }

      HEYS.Widgets.emit('layout:saved', { layout: layoutData });
    },

    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å layout –∏–∑ storage
     * @returns {Object[]|null}
     */
    loadLayout() {
      // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º clientId –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      const cid = window.HEYS?.currentClientId || '';
      log(`loadLayout: clientId="${cid ? cid.slice(0, 8) + '...' : 'EMPTY!'}", key=${STORAGE_KEY}`);

      try {
        let stored = null;
        if (HEYS.store?.get) {
          stored = HEYS.store.get(STORAGE_KEY, null);
        } else if (HEYS.utils?.lsGet) {
          stored = HEYS.utils.lsGet(STORAGE_KEY, null);
        } else {
          const raw = localStorage.getItem(STORAGE_KEY);
          stored = raw ? JSON.parse(raw) : null;
        }

        // üîß –ú–ò–ì–†–ê–¶–ò–Ø: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–º–∞—Å—Å–∏–≤) –∏ –Ω–æ–≤–æ–≥–æ (–æ–±—ä–µ–∫—Ç —Å updatedAt)
        if (!stored) return null;

        // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: { widgets: [...], updatedAt: number }
        if (stored.widgets && Array.isArray(stored.widgets)) {
          log('loadLayout: new format, updatedAt =', stored.updatedAt);
          return stored.widgets;
        }

        // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤ –≤–∏–¥–∂–µ—Ç–æ–≤
        if (Array.isArray(stored)) {
          log('loadLayout: legacy format (array), no updatedAt');
          return stored;
        }

        warn('loadLayout: unknown format', stored);
        return null;
      } catch (e) {
        err('Failed to load layout:', e);
        return null;
      }
    },

    /**
     * –°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É layout
     */
    resetLayout() {
      this._widgets = this._createDefaultLayout();
      this.saveLayout();
      HEYS.Widgets.emit('layout:reset');
      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });
    },

    /**
     * –ü—Ä–∏–º–µ–Ω–∏—Ç—å preset layout
     * @param {string} presetId
     */
    applyPreset(presetId) {
      const presets = HEYS.Widgets.presets?.getAll?.() || {};
      const preset = presets[presetId];
      if (!preset) {
        warn('Unknown preset:', presetId);
        return false;
      }

      this._widgets = preset.widgets.map(w => this._normalizeWidget(w));
      this.saveLayout();
      HEYS.Widgets.emit('layout:changed', { layout: this._widgets });
      return true;
    },

    // === Edit Mode ===

    isEditMode() {
      return this._editMode;
    },

    enterEditMode() {
      if (this._editMode) return;
      this._editMode = true;
      document.body.classList.add('widgets-edit-mode');

      // –û—Ç–∫–ª—é—á–∞–µ–º swipe –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      if (HEYS.App?.disableSwipe) {
        HEYS.App.disableSwipe();
      }

      HEYS.Widgets.emit('editmode:enter');
    },

    exitEditMode() {
      if (!this._editMode) return;

      // üõ°Ô∏è CRITICAL: –ù–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∏–∑ edit mode –µ—Å–ª–∏ resize –∞–∫—Ç–∏–≤–µ–Ω!
      if (HEYS.Widgets.dnd?._resizeActive) return;

      this._editMode = false;
      document.body.classList.remove('widgets-edit-mode');

      // –í–∫–ª—é—á–∞–µ–º swipe –Ω–∞–≤–∏–≥–∞—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ
      if (HEYS.App?.enableSwipe) {
        HEYS.App.enableSwipe();
      }

      HEYS.Widgets.emit('editmode:exit');
    },

    toggleEditMode() {
      if (this._editMode) {
        this.exitEditMode();
      } else {
        this.enterEditMode();
      }
    }
  };

  // === Grid Engine ===
  const gridEngine = {
    COLS: GRID_COLS,

    /**
     * –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
     * @param {number} cols - –®–∏—Ä–∏–Ω–∞ –≤–∏–¥–∂–µ—Ç–∞
     * @param {number} rows - –í—ã—Å–æ—Ç–∞ –≤–∏–¥–∂–µ—Ç–∞
     * @returns {Object} { col, row }
     */
    findFreePosition(cols, rows, excludeId = null) {
      const widgets = state.getWidgets();
      const occupiedCells = this.getOccupiedCells(widgets, excludeId);

      // –ò—â–µ–º –ø–µ—Ä–≤—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
      for (let row = 0; row < 100; row++) {
        for (let col = 0; col <= GRID_COLS - cols; col++) {
          if (this.canPlace(col, row, cols, rows, occupiedCells)) {
            return { col, row };
          }
        }
      }

      // Fallback: –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
      const maxRow = Math.max(0, ...widgets.map(w => {
        const sizeInfo = HEYS.Widgets.registry.getSize(w.size);
        const wRows = sizeInfo?.rows || w.rows || 1;
        return w.position.row + wRows;
      }));
      return { col: 0, row: maxRow };
    },

    /**
     * üÜï –ù–∞–π—Ç–∏ –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è —Å –∑–∞–¥–∞–Ω–Ω—ã–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º
     * @param {string} excludeId - ID –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
     * @param {Object} rect - { col, row, cols, rows }
     * @returns {Object[]} –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è –≤–∏–¥–∂–µ—Ç–æ–≤
     */
    getCollidingWidgets(excludeId, rect) {
      const widgets = state.getWidgets();
      const colliding = [];

      const aLeft = rect.col;
      const aTop = rect.row;
      const aRight = rect.col + rect.cols;
      const aBottom = rect.row + rect.rows;

      for (const other of widgets) {
        if (!other || other.id === excludeId) continue;

        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const otherSizeInfo = HEYS.Widgets.registry.getSize(other.size);
        const otherCols = otherSizeInfo?.cols || other.cols || 1;
        const otherRows = otherSizeInfo?.rows || other.rows || 1;

        const bLeft = other.position.col;
        const bTop = other.position.row;
        const bRight = other.position.col + otherCols;
        const bBottom = other.position.row + otherRows;

        const overlap = aLeft < bRight && aRight > bLeft && aTop < bBottom && aBottom > bTop;
        if (overlap) {
          colliding.push(other);
        }
      }

      return colliding;
    },

    /**
     * üÜï –í—ã—Ç–µ—Å–Ω–∏—Ç—å –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –≤–∏–¥–∂–µ—Ç—ã –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ move/resize —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–π
     * @param {string} priorityWidgetId - ID –≤–∏–¥–∂–µ—Ç–∞ –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ
     * @param {number} depth - –≥–ª—É–±–∏–Ω–∞ —Ä–µ–∫—É—Ä—Å–∏–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
     * @returns {boolean} true –µ—Å–ª–∏ –±—ã–ª–∏ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è
     */
    displaceCollidingWidgets(priorityWidgetId, depth = 0) {
      // üîß FIX v1.3.1: –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏
      if (depth > 10) {
        warn('GridEngine ‚ö†Ô∏è Max recursion depth reached, stopping displacement');
        return false;
      }

      const priorityWidget = state.getWidget(priorityWidgetId);
      if (!priorityWidget) return false;

      // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
      const prioritySizeInfo = HEYS.Widgets.registry.getSize(priorityWidget.size);
      const priorityCols = prioritySizeInfo?.cols || priorityWidget.cols || 1;
      const priorityRows = prioritySizeInfo?.rows || priorityWidget.rows || 1;

      const rect = {
        col: priorityWidget.position.col,
        row: priorityWidget.position.row,
        cols: priorityCols,
        rows: priorityRows
      };

      log(`[GridEngine] displaceCollidingWidgets called for ${priorityWidgetId}`, rect);

      const colliding = this.getCollidingWidgets(priorityWidgetId, rect);
      log(`[GridEngine] Found ${colliding.length} colliding widgets:`, colliding.map(w => w.id));

      if (colliding.length === 0) return false;

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–∑–º–µ—Ä—É (–º–µ–Ω—å—à–∏–µ –ø–µ—Ä–≤—ã–º–∏ ‚Äî –∏—Ö –ø—Ä–æ—â–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å)
      colliding.sort((a, b) => {
        const aSizeInfo = HEYS.Widgets.registry.getSize(a.size);
        const bSizeInfo = HEYS.Widgets.registry.getSize(b.size);
        const aArea = (aSizeInfo?.cols || a.cols || 1) * (aSizeInfo?.rows || a.rows || 1);
        const bArea = (bSizeInfo?.cols || b.cols || 1) * (bSizeInfo?.rows || b.rows || 1);
        return aArea - bArea;
      });

      let displaced = false;
      const movedWidgets = new Set(); // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â—ë–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã

      for (const widget of colliding) {
        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry –¥–ª—è –≤—ã—Ç–µ—Å–Ω—è–µ–º–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
        const sizeInfo = HEYS.Widgets.registry.getSize(widget.size);
        const wCols = sizeInfo?.cols || widget.cols || 1;
        const wRows = sizeInfo?.rows || widget.rows || 1;

        // üîß FIX v1.3.1: –ò—Å–∫–ª—é—á–∞–µ–º –¢–û–õ–¨–ö–û –ø–µ—Ä–µ–º–µ—â–∞–µ–º—ã–π –≤–∏–¥–∂–µ—Ç, –∞ –ù–ï –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π!
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –≤–∏–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è "–∑–∞–Ω—è—Ç—ã–º", —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–º–µ—â–∞—Ç—å –Ω–∞ –Ω—ë–º
        const freePos = this.findFreePositionExcluding(wCols, wRows, [widget.id]);
        if (freePos) {
          log(`[GridEngine] Moving ${widget.id} from (${widget.position.col},${widget.position.row}) to (${freePos.col},${freePos.row})`);
          state.updateWidget(widget.id, { position: freePos }, true);
          displaced = true;
          movedWidgets.add(widget.id);

          // üîß FIX v1.3.1: –ü–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –ª–∏ –º—ã –Ω–æ–≤—É—é –∫–æ–ª–ª–∏–∑–∏—é
          // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤—ã—Ç–µ—Å–Ω—è–µ–º –≤–∏–¥–∂–µ—Ç—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ—â—ë–Ω–Ω—ã–π
          this.displaceCollidingWidgets(widget.id, depth + 1);
        } else {
          warn(`GridEngine ‚ö†Ô∏è No free position for ${widget.id} (${wCols}x${wRows}), will overlap!`);
        }
      }

      return displaced;
    },

    /**
     * üÜï –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ, –∏—Å–∫–ª—é—á–∞—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–∂–µ—Ç–æ–≤ –∏–∑ —Ä–∞—Å—á—ë—Ç–∞ occupied
     * @param {number} cols
     * @param {number} rows
     * @param {string[]} excludeIds - –º–∞—Å—Å–∏–≤ ID –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
     * @returns {Object} { col, row }
     */
    findFreePositionExcluding(cols, rows, excludeIds = []) {
      const widgets = state.getWidgets();
      const occupiedCells = new Set();

      // –°–æ–±–∏—Ä–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —è—á–µ–π–∫–∏, –∏—Å–∫–ª—é—á–∞—è —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã
      widgets.forEach(widget => {
        if (excludeIds.includes(widget.id)) return;

        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const sizeInfo = HEYS.Widgets.registry.getSize(widget.size);
        const wCols = sizeInfo?.cols || widget.cols || 1;
        const wRows = sizeInfo?.rows || widget.rows || 1;

        for (let c = 0; c < wCols; c++) {
          for (let r = 0; r < wRows; r++) {
            occupiedCells.add(`${widget.position.col + c},${widget.position.row + r}`);
          }
        }
      });

      // –ò—â–µ–º –ø–µ—Ä–≤—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
      for (let row = 0; row < 100; row++) {
        for (let col = 0; col <= GRID_COLS - cols; col++) {
          if (this.canPlace(col, row, cols, rows, occupiedCells)) {
            return { col, row };
          }
        }
      }

      // Fallback: –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
      const maxRow = Math.max(0, ...widgets.map(w => {
        const sizeInfo = HEYS.Widgets.registry.getSize(w.size);
        const wRows = sizeInfo?.rows || w.rows || 1;
        return w.position.row + wRows;
      }));
      return { col: 0, row: maxRow };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∑–∞–Ω—è—Ç—ã–µ —è—á–µ–π–∫–∏
     * @param {Object[]} widgets
     * @param {string} excludeId - ID –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
     * @returns {Set<string>}
     */
    getOccupiedCells(widgets, excludeId = null) {
      const cells = new Set();

      widgets.forEach(widget => {
        if (widget.id === excludeId) return;

        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
        const sizeInfo = HEYS.Widgets.registry.getSize(widget.size);
        const cols = sizeInfo?.cols || widget.cols || 1;
        const rows = sizeInfo?.rows || widget.rows || 1;

        for (let c = 0; c < cols; c++) {
          for (let r = 0; r < rows; r++) {
            cells.add(`${widget.position.col + c},${widget.position.row + r}`);
          }
        }
      });

      return cells;
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤–∏–¥–∂–µ—Ç
     * @param {number} col
     * @param {number} row
     * @param {number} cols
     * @param {number} rows
     * @param {Set<string>} occupiedCells
     * @returns {boolean}
     */
    canPlace(col, row, cols, rows, occupiedCells) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –≥—Ä–∏–¥–∞
      if (col < 0 || col + cols > GRID_COLS) return false;
      if (row < 0) return false;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
      for (let c = 0; c < cols; c++) {
        for (let r = 0; r < rows; r++) {
          if (occupiedCells.has(`${col + c},${row + r}`)) {
            return false;
          }
        }
      }

      return true;
    },

    /**
     * –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤–∏–¥–∂–µ—Ç–∞
     * @param {string} widgetId
     * @param {Object} position
     * @returns {boolean}
     */
    validatePosition(widgetId, position) {
      const widget = state.getWidget(widgetId);
      if (!widget) return false;

      // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
      const sizeInfo = HEYS.Widgets.registry.getSize(widget.size);
      const cols = sizeInfo?.cols || widget.cols || 1;
      const rows = sizeInfo?.rows || widget.rows || 1;

      const occupiedCells = this.getOccupiedCells(state.getWidgets(), widgetId);
      return this.canPlace(position.col, position.row, cols, rows, occupiedCells);
    },

    /**
     * –ù–∞–π—Ç–∏ –≤–∏–¥–∂–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º –≤–∏–¥–∂–µ—Ç–∞ widgetId,
     * –µ—Å–ª–∏ —Ç–æ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ position.
     * @param {string} widgetId
     * @param {Object} position - { col, row }
     * @returns {Object|null}
     */
    getCollidingWidget(widgetId, position) {
      const widget = state.getWidget(widgetId);
      if (!widget) return null;

      // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
      const sizeInfo = HEYS.Widgets.registry.getSize(widget.size);
      const widgetCols = sizeInfo?.cols || widget.cols || 1;
      const widgetRows = sizeInfo?.rows || widget.rows || 1;

      const aLeft = position.col;
      const aTop = position.row;
      const aRight = position.col + widgetCols;
      const aBottom = position.row + widgetRows;

      const widgets = state.getWidgets();
      for (const other of widgets) {
        if (!other || other.id === widgetId) continue;

        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –ö–ê–ñ–î–û–ì–û –≤–∏–¥–∂–µ—Ç–∞ –∏–∑ registry
        const otherSizeInfo = HEYS.Widgets.registry.getSize(other.size);
        const otherCols = otherSizeInfo?.cols || other.cols || 1;
        const otherRows = otherSizeInfo?.rows || other.rows || 1;

        const bLeft = other.position.col;
        const bTop = other.position.row;
        const bRight = other.position.col + otherCols;
        const bBottom = other.position.row + otherRows;

        const overlap = aLeft < bRight && aRight > bLeft && aTop < bBottom && aBottom > bTop;
        if (overlap) return other;
      }

      return null;
    },

    /**
     * üÜï iOS-like reflow: –ø—Ä–æ–±—É–µ–º –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç –≤ position, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
     * –ø–µ—Ä–µ–ø–∞–∫–æ–≤–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–ª–ª–∏–∑–∏–π.
     *
     * –≠—Ç–æ –ù–ï —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Å–µ—Ç–∫–∞ –≤—Å—ë –µ—â—ë grid-based, –Ω–æ drop
     * —Ç–µ–ø–µ—Ä—å –≤–æ–∑–º–æ–∂–µ–Ω "–≤ –∑–∞–Ω—è—Ç–æ–µ –º–µ—Å—Ç–æ" (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–¥–≤–∏–Ω—É—Ç—Å—è).
     *
     * @param {string} draggedId
     * @param {{col:number,row:number}} position
     * @returns {Record<string,{col:number,row:number}>|null}
     */
    computeReflowLayout(draggedId, position) {
      const dragged = state.getWidget(draggedId);
      if (!dragged) return null;

      // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
      const draggedSizeInfo = HEYS.Widgets.registry.getSize(dragged.size);
      const draggedCols = draggedSizeInfo?.cols || dragged.cols || 1;
      const draggedRows = draggedSizeInfo?.rows || dragged.rows || 1;

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º target –ø–æ–∑–∏—Ü–∏—é –ø–æ–¥ —à–∏—Ä–∏–Ω—É –≤–∏–¥–∂–µ—Ç–∞ –∏ —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É
      const currentHeight = this.getGridHeight();
      const target = {
        col: Math.max(0, Math.min(position.col || 0, GRID_COLS - draggedCols)),
        row: Math.max(0, Math.min(position.row || 0, currentHeight + 6))
      };

      // –°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
      const others = state.getWidgets()
        .filter(w => w && w.id !== draggedId)
        .sort((a, b) => {
          if (a.position.row !== b.position.row) return a.position.row - b.position.row;
          return a.position.col - b.position.col;
        });

      const positions = {};
      const occupied = new Set();

      const occupy = (wId, col, row, cols, rows) => {
        for (let c = 0; c < cols; c++) {
          for (let r = 0; r < rows; r++) {
            occupied.add(`${col + c},${row + r}`);
          }
        }
      };

      // –°—Ç–∞–≤–∏–º dragged –Ω–∞ target (–¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–º –±—ã–ª–æ –∑–∞–Ω—è—Ç–æ)
      positions[draggedId] = target;
      occupy(draggedId, target.col, target.row, draggedCols, draggedRows);

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
      const findSlot = (w) => {
        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const wSizeInfo = HEYS.Widgets.registry.getSize(w.size);
        const wCols = wSizeInfo?.cols || w.cols || 1;
        const wRows = wSizeInfo?.rows || w.rows || 1;

        for (let row = 0; row < 120; row++) {
          for (let col = 0; col <= GRID_COLS - wCols; col++) {
            if (this.canPlace(col, row, wCols, wRows, occupied)) {
              return { col, row, cols: wCols, rows: wRows };
            }
          }
        }
        return null;
      };

      // –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
      for (const w of others) {
        const slot = findSlot(w);
        if (!slot) return null;
        positions[w.id] = { col: slot.col, row: slot.row };
        occupy(w.id, slot.col, slot.row, slot.cols, slot.rows);
      }

      return positions;
    },

    /**
     * –ö–æ–º–ø–∞–∫—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å layout (—É–±—Ä–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏)
     */
    compact() {
      const widgets = state.getWidgets();

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ row, –ø–æ—Ç–æ–º –ø–æ col
      widgets.sort((a, b) => {
        if (a.position.row !== b.position.row) {
          return a.position.row - b.position.row;
        }
        return a.position.col - b.position.col;
      });

      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç –∫–∞–∫ –º–æ–∂–Ω–æ –≤—ã—à–µ
      widgets.forEach(widget => {
        let bestRow = 0;
        const occupiedCells = this.getOccupiedCells(widgets, widget.id);

        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const sizeInfo = HEYS.Widgets.registry.getSize(widget.size);
        const wCols = sizeInfo?.cols || widget.cols || 1;
        const wRows = sizeInfo?.rows || widget.rows || 1;

        while (!this.canPlace(widget.position.col, bestRow, wCols, wRows, occupiedCells)) {
          bestRow++;
          if (bestRow > 100) break; // Safety limit
        }

        if (bestRow < widget.position.row) {
          widget.position.row = bestRow;
        }
      });

      state.saveLayout();
      HEYS.Widgets.emit('layout:changed', { layout: widgets });
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—ã—Å–æ—Ç—É –≥—Ä–∏–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫)
     * @returns {number}
     */
    getGridHeight() {
      const widgets = state.getWidgets();
      if (widgets.length === 0) return 1;
      return Math.max(...widgets.map(w => {
        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry
        const sizeInfo = HEYS.Widgets.registry.getSize(w.size);
        const wRows = sizeInfo?.rows || w.rows || 1;
        return w.position.row + wRows;
      }));
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã —è—á–µ–π–∫–∏ grid
     * @returns {Object} { cellWidth, cellHeight, gap }
     */
    getCellMetrics() {
      const grid = document.querySelector('.widgets-grid');
      if (!grid) {
        return { cellWidth: 150, cellHeight: CELL_HEIGHT_PX, gap: CELL_GAP_PX };
      }

      const rect = grid.getBoundingClientRect();

      // –°—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ CSS variables (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ responsive)
      const cs = window.getComputedStyle(grid);
      const gapVar = parseFloat(cs.getPropertyValue('--widget-grid-gap'));
      const rowVar = parseFloat(cs.getPropertyValue('--widget-row-height'));
      const gap = Number.isFinite(gapVar) ? gapVar : CELL_GAP_PX;
      const cellHeight = Number.isFinite(rowVar) ? rowVar : CELL_HEIGHT_PX;

      const cellWidth = (rect.width - gap * (GRID_COLS - 1)) / GRID_COLS;

      return { cellWidth, cellHeight, gap };
    },

    /**
     * –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∏–∫—Å–µ–ª–µ–π ‚Üí grid position
     * @param {number} x - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ grid
     * @param {number} y - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ grid
     * @returns {Object} { col, row }
     */
    pixelsToGrid(x, y) {
      const { cellWidth, cellHeight, gap } = this.getCellMetrics();

      const col = Math.floor(x / (cellWidth + gap));
      const row = Math.floor(y / (cellHeight + gap));

      return {
        col: Math.max(0, Math.min(col, GRID_COLS - 1)),
        row: Math.max(0, row)
      };
    },

    /**
     * Grid position ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∏–∫—Å–µ–ª–µ–π (–≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª)
     * @param {number} col
     * @param {number} row
     * @returns {Object} { x, y }
     */
    gridToPixels(col, row) {
      const { cellWidth, cellHeight, gap } = this.getCellMetrics();

      return {
        x: col * (cellWidth + gap),
        y: row * (cellHeight + gap)
      };
    }
  };

  // === Enhanced Drag & Drop Manager with Ghost & Placeholder ===
  const dnd = {
    _dragging: false,
    _draggedWidget: null,
    _startPos: null,
    _currentPos: null,
    _startGridPos: null,
    _ghostElement: null,
    _placeholderElement: null,
    _longPressTimer: null,
    _longPressTriggered: false,
    _lastValidPosition: null,
    _originalElement: null,
    _dropIntent: null,
    _scrollIntent: false,
    _touchDragReadyAt: 0,

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–∞—Å–∞–Ω–∏—è/–∫–ª–∏–∫–∞ (–¥–ª—è long press detection)
     * @param {string} widgetId
     * @param {Object} event
     */
    handlePointerDown(widgetId, event) {
      // CRITICAL: –ï—Å–ª–∏ resize –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –ù–ï –Ω–∞—á–∏–Ω–∞–µ–º DnD
      if (this._resizeActive) {
        return;
      }

      // CRITICAL: –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ resize handle ‚Äî –ù–ï –Ω–∞—á–∏–Ω–∞–µ–º DnD
      const t = event?.target;
      if (t && typeof t.closest === 'function') {
        if (t.closest('.widget__resize-handle')) {
          return;
        }
      }

      // –§–∏–∫—Å–∏—Ä—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –æ—Ç–º–µ–Ω—ã long press –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
      this._startPos = {
        x: event.clientX || event.touches?.[0]?.clientX || 0,
        y: event.clientY || event.touches?.[0]?.clientY || 0
      };
      this._scrollIntent = false;
      const isTouchEvent = !!(event?.touches || event?.changedTouches || event?.pointerType === 'touch');
      // Touch grace: –¥–∞—ë–º –∂–µ—Å—Ç—É —à–∞–Ω—Å —Å—Ç–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–º scroll –¥–æ —Å—Ç–∞—Ä—Ç–∞ drag.
      this._touchDragReadyAt = isTouchEvent ? (Date.now() + 140) : 0;

      // –ï—Å–ª–∏ —É–∂–µ –≤ edit mode ‚Äî —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º drag
      if (state.isEditMode()) {
        this._prepareForDrag(widgetId, event);
        return;
      }

      // –ò–Ω–∞—á–µ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä long press –¥–ª—è –≤—Ö–æ–¥–∞ –≤ edit mode
      this._longPressTriggered = false;
      this._longPressTimer = setTimeout(() => {
        this._longPressTriggered = true;
        state.enterEditMode();

        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ edit mode
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }

        HEYS.Widgets.emit('editmode:longpress', { widgetId });
      }, LONG_PRESS_MS);
    },

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è/–∫–ª–∏–∫–∞
     * @param {string} widgetId
     * @param {Object} event
     */
    handlePointerUp(widgetId, event) {
      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã–∑–æ–≤–∞ –∫–∞–∫ handlePointerUp(event) –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö listeners
      if (widgetId && typeof widgetId === 'object' && !event) {
        event = widgetId;
        widgetId = null;
      }

      // –û—Ç–º–µ–Ω—è–µ–º long press timer –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
      if (this._longPressTimer) {
        clearTimeout(this._longPressTimer);
        this._longPressTimer = null;
      }

      // –ï—Å–ª–∏ drag –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º
      if (this._dragging) {
        this.end(event);
        return;
      }

      // –ï—Å–ª–∏ drag –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª, –Ω–æ –±—ã–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω (_prepareForDrag),
      // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —á–∏—Å—Ç–∏–º listeners/—Å–æ—Å—Ç–æ—è–Ω–∏–µ.
      if (this._draggedWidget) {
        this._cleanup();
      }
    },

    /**
     * –û—Ç–º–µ–Ω–∞ long press –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
     */
    handlePointerMove(event) {
      // CRITICAL: –ï—Å–ª–∏ resize –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º move –¥–ª—è DnD
      if (this._resizeActive) {
        return;
      }

      // –ï—Å–ª–∏ —É–∂–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ (touch) ‚Äî –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∂–µ—Å—Ç—ã
      if (this._scrollIntent) {
        return;
      }

      // –ù–∞ iOS/Safari –±–µ–∑ preventDefault —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–∂–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è –∏ –ª–æ–º–∞—Ç—å drag
      if (this._dragging && event && event.cancelable) {
        event.preventDefault();
      }

      // üÜï Scroll intent cancel: –≤ edit-mode –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–∞—Å—Ç–æ —Ö–æ—á–µ—Ç –ø—Ä–æ—Å—Ç–æ
      // –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ï—Å–ª–∏ –¥–æ —Å—Ç–∞—Ä—Ç–∞ drag (–ø–æ—Ä–æ–≥ 5px) –¥–≤–∏–∂–µ–Ω–∏–µ —è–≤–Ω–æ
      // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ ‚Äî –æ—Ç–º–µ–Ω—è–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π drag –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª.
      if (this._draggedWidget && !this._dragging && state.isEditMode()) {
        const cx = event.clientX || event.touches?.[0]?.clientX || 0;
        const cy = event.clientY || event.touches?.[0]?.clientY || 0;
        const dx = Math.abs(cx - (this._startPos?.x || 0));
        const dy = Math.abs(cy - (this._startPos?.y || 0));

        // –ï—Å–ª–∏ —Å–≤–∞–π–ø –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∏ –∑–∞–º–µ—Ç–Ω—ã–π ‚Äî —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ —Å–∫—Ä–æ–ª–ª–æ–º
        // –∏ –±–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–æ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –ø–∞–ª—å—Ü–∞.
        if (dy > 10 && dy > dx * 1.15) {
          this._scrollIntent = true;
          return;
        }
      }

      // –ï—Å–ª–∏ –¥–≤–∏–≥–∞–µ–º—Å—è –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è long press ‚Äî –æ—Ç–º–µ–Ω—è–µ–º
      if (this._longPressTimer && !this._dragging) {
        const dx = Math.abs((event.clientX || event.touches?.[0]?.clientX || 0) - (this._startPos?.x || 0));
        const dy = Math.abs((event.clientY || event.touches?.[0]?.clientY || 0) - (this._startPos?.y || 0));

        // –ï—Å–ª–∏ —Å–¥–≤–∏–Ω—É–ª–∏—Å—å –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 10px ‚Äî –æ—Ç–º–µ–Ω—è–µ–º long press
        if (dx > 10 || dy > 10) {
          clearTimeout(this._longPressTimer);
          this._longPressTimer = null;
        }
      }

      // –ï—Å–ª–∏ drag –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –¥–≤–∏–≥–∞–µ–º
      // –í–∞–∂–Ω–æ: move() —Å–∞–º —Å—Ç–∞—Ä—Ç—É–µ—Ç drag –ø–æ—Å–ª–µ –ø–æ—Ä–æ–≥–∞ (5px) ‚Äî –ø–æ—ç—Ç–æ–º—É –≤—ã–∑—ã–≤–∞–µ–º
      // –µ–≥–æ –∏ –¥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞, –∫–æ–≥–¥–∞ _draggedWidget —É–∂–µ –∑–∞–¥–∞–Ω.
      if (this._draggedWidget) {
        this.move(event);
      }
    },

    /**
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ drag (–∫–æ–≥–¥–∞ —É–∂–µ –≤ edit mode)
     * @private
     */
    _prepareForDrag(widgetId, event) {
      // CRITICAL: –ï—Å–ª–∏ resize –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –ù–ï –Ω–∞—á–∏–Ω–∞–µ–º drag
      if (this._resizeActive) {
        return;
      }

      const widget = state.getWidget(widgetId);
      if (!widget) return;

      this._draggedWidget = widget;
      this._startPos = {
        x: event.clientX || event.touches?.[0]?.clientX || 0,
        y: event.clientY || event.touches?.[0]?.clientY || 0
      };
      this._currentPos = { ...this._startPos };
      this._startGridPos = { ...widget.position };
      this._lastValidPosition = { ...widget.position };

      // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
      this._originalElement = document.querySelector(`[data-widget-id="${widgetId}"]`);

      // –î–æ–±–∞–≤–ª—è–µ–º listeners –Ω–∞ document –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è
      this._boundMove = (e) => this.handlePointerMove(e);
      this._boundUp = (e) => this.handlePointerUp(widgetId, e);

      document.addEventListener('pointermove', this._boundMove);
      document.addEventListener('pointerup', this._boundUp);
      // touchmove –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∑–¥–µ—Å—å ‚Äî –æ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ start() —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ drag —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç.
      // –ü–∞—Å—Å–∏–≤–Ω—ã–π drag-phase listener –Ω–µ –Ω—É–∂–µ–Ω –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–æ —Å—Ç–∞—Ä—Ç–∞.
      document.addEventListener('touchend', this._boundUp);
    },

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ document listeners
     * @private
     */
    _removeDocumentListeners() {
      if (this._boundMove) {
        document.removeEventListener('pointermove', this._boundMove);
        document.removeEventListener('touchmove', this._boundMove);
      }
      if (this._boundUp) {
        document.removeEventListener('pointerup', this._boundUp);
        document.removeEventListener('touchend', this._boundUp);
      }
      this._boundMove = null;
      this._boundUp = null;
    },

    /**
     * –ù–∞—á–∞—Ç—å drag (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)
     * @param {string} widgetId
     * @param {Object} event
     */
    start(widgetId, event) {
      if (!state.isEditMode()) return;

      // CRITICAL: –ï—Å–ª–∏ resize –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –ù–ï –Ω–∞—á–∏–Ω–∞–µ–º drag
      if (this._resizeActive) {
        return;
      }

      const widget = state.getWidget(widgetId);
      if (!widget) return;

      this._dragging = true;
      this._draggedWidget = widget;
      this._dropIntent = null;

      // –¢–µ–ø–µ—Ä—å drag —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º non-passive touchmove, —á—Ç–æ–±—ã
      // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞.
      if (this._boundMove) {
        document.addEventListener('touchmove', this._boundMove, { passive: false });
      }

      if (!this._startPos) {
        this._startPos = {
          x: event.clientX || event.touches?.[0]?.clientX || 0,
          y: event.clientY || event.touches?.[0]?.clientY || 0
        };
      }
      this._currentPos = { ...this._startPos };
      this._startGridPos = { ...widget.position };
      this._lastValidPosition = { ...widget.position };

      // –°–æ–∑–¥–∞—ë–º ghost element
      this._createGhost(widget, event);

      // –°–æ–∑–¥–∞—ë–º placeholder
      this._createPlaceholder(widget);

      // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
      this._originalElement = document.querySelector(`[data-widget-id="${widgetId}"]`);
      if (this._originalElement) {
        this._originalElement.classList.add('widget--dragging');
        this._originalElement.style.opacity = '0.3';
      }

      // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ drag
      if (navigator.vibrate) {
        navigator.vibrate(15);
      }

      HEYS.Widgets.emit('dnd:start', { widget });
    },

    /**
     * –°–æ–∑–¥–∞—Ç—å ghost element (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –∫–æ–ø–∏—è)
     * @private
     */
    _createGhost(widget, event) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π ghost –µ—Å–ª–∏ –µ—Å—Ç—å
      this._removeGhost();

      const original = document.querySelector(`[data-widget-id="${widget.id}"]`);
      if (!original) return;

      // –ö–ª–æ–Ω–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç
      const ghost = original.cloneNode(true);
      ghost.classList.add('widget-ghost');
      ghost.removeAttribute('data-widget-id');
      ghost.style.cssText = `
        position: fixed;
        z-index: 10000;
        pointer-events: none;
        opacity: 0.8;
        transform: scale(1.02);
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        transition: none;
        width: ${original.offsetWidth}px;
        height: ${original.offsetHeight}px;
      `;

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º ghost –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
      const x = event.clientX || event.touches?.[0]?.clientX || 0;
      const y = event.clientY || event.touches?.[0]?.clientY || 0;
      ghost.style.left = `${x - original.offsetWidth / 2}px`;
      ghost.style.top = `${y - original.offsetHeight / 2}px`;

      document.body.appendChild(ghost);
      this._ghostElement = ghost;
    },

    /**
     * –°–æ–∑–¥–∞—Ç—å placeholder (–≤–∏–∑—É–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è drop)
     * @private
     */
    _createPlaceholder(widget) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π placeholder –µ—Å–ª–∏ –µ—Å—Ç—å
      this._removePlaceholder();

      const grid = document.querySelector('.widgets-grid');
      if (!grid) return;

      const placeholder = document.createElement('div');
      placeholder.className = 'widget-placeholder';
      // –í–∏–∑—É–∞–ª ‚Äî –≤ CSS (.widget-placeholder). –ó–¥–µ—Å—å –∑–∞–¥–∞—ë–º —Ç–æ–ª—å–∫–æ grid-–≥–µ–æ–º–µ—Ç—Ä–∏—é.
      placeholder.style.transition = 'all 0.15s ease-out';

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è placeholder (–≤–∞–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –î–û updatePlaceholderPosition)
      // üîß FIX: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º sizeId (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ legacy id –∏ —Å–∏–º–≤–æ–ª–∞ "√ó")
      const reg = HEYS.Widgets.registry;
      const normalizedSize = reg?.normalizeSizeId ? (reg.normalizeSizeId(widget?.size) || widget?.size) : widget?.size;
      const sizeInfo = reg?.getSize?.(normalizedSize) || reg?.getSize?.(widget?.size);
      this._placeholderCols = sizeInfo?.cols || widget?.cols || 1;
      this._placeholderRows = sizeInfo?.rows || widget?.rows || 1;

      // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è placeholder
      log('[DnD] _createPlaceholder:', {
        widgetId: widget?.id,
        widgetSize: widget?.size,
        widgetCols: widget?.cols,
        widgetRows: widget?.rows,
        normalizedSize,
        sizeInfo,
        placeholderCols: this._placeholderCols,
        placeholderRows: this._placeholderRows
      });

      // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º placeholder –∏ —Å—Ç–∞–≤–∏–º –≤ –Ω—É–∂–Ω—É—é grid-–ø–æ–∑–∏—Ü–∏—é
      this._placeholderElement = placeholder;
      this._updatePlaceholderPosition(widget.position);

      grid.appendChild(placeholder);
    },

    /**
     * –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é placeholder
     * @private
     */
    _updatePlaceholderPosition(position) {
      if (!this._placeholderElement) return;

      // –í–∞–∂–Ω–æ: –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö (–æ—Å–æ–±–µ–Ω–Ω–æ iOS Safari) —Ä–∞–∑–¥–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
      // gridColumnStart –ø–æ—Å–ª–µ —à–æ—Ä—Ç—Ö–µ–Ω–¥–∞ –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å span. –ü–æ—ç—Ç–æ–º—É –∑–∞–¥–∞—ë–º
      // –ø–æ–ª–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (start + span) –∫–∞–∂–¥—ã–π —Ä–∞–∑.
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–ª–∏ fallback –Ω–∞ _draggedWidget
      const cols = this._placeholderCols || this._draggedWidget?.cols || 1;
      const rows = this._placeholderRows || this._draggedWidget?.rows || 1;
      const c = (position?.col || 0) + 1;
      const r = (position?.row || 0) + 1;

      this._placeholderElement.style.gridColumn = `${c} / span ${cols}`;
      this._placeholderElement.style.gridRow = `${r} / span ${rows}`;
    },

    /**
     * –î–≤–∏–∂–µ–Ω–∏–µ drag
     * @param {Object} event
     */
    move(event) {
      if (!this._draggedWidget) return;

      // –ï—Å–ª–∏ drag –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥ –¥–≤–∏–∂–µ–Ω–∏—è
      if (!this._dragging) {
        const isTouchEvent = !!(event?.touches || event?.changedTouches || event?.pointerType === 'touch');

        // –î–ª—è touch: –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ–º drag –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, —á—Ç–æ–±—ã —Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
        // –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–ª—Å—è –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π.
        if (isTouchEvent && this._touchDragReadyAt && Date.now() < this._touchDragReadyAt) {
          return;
        }

        const dx = Math.abs((event.clientX || event.touches?.[0]?.clientX || 0) - this._startPos.x);
        const dy = Math.abs((event.clientY || event.touches?.[0]?.clientY || 0) - this._startPos.y);

        const dragThreshold = isTouchEvent ? 14 : 5;

        // –ù–∞ touch –∂–¥—ë–º –±–æ–ª–µ–µ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª.
        if (dx > dragThreshold || dy > dragThreshold) {
          this.start(this._draggedWidget.id, event);
        }
        return;
      }

      this._currentPos = {
        x: event.clientX || event.touches?.[0]?.clientX || 0,
        y: event.clientY || event.touches?.[0]?.clientY || 0
      };

      // –î–≤–∏–≥–∞–µ–º ghost
      if (this._ghostElement) {
        const original = this._originalElement;
        const width = original ? original.offsetWidth : 150;
        const height = original ? original.offsetHeight : 140;

        this._ghostElement.style.left = `${this._currentPos.x - width / 2}px`;
        this._ghostElement.style.top = `${this._currentPos.y - height / 2}px`;
      }

      // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é grid –ø–æ–∑–∏—Ü–∏—é
      const grid = document.querySelector('.widgets-grid');
      if (grid) {
        const rect = grid.getBoundingClientRect();
        const relX = this._currentPos.x - rect.left;
        const relY = this._currentPos.y - rect.top;

        const newGridPos = gridEngine.pixelsToGrid(relX, relY);

        // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ registry (—á–µ—Ä–µ–∑ normalize)
        const reg = HEYS.Widgets.registry;
        const normalizedDraggedSize = reg?.normalizeSizeId
          ? (reg.normalizeSizeId(this._draggedWidget?.size) || this._draggedWidget?.size)
          : this._draggedWidget?.size;
        const draggedSizeInfo = reg?.getSize?.(normalizedDraggedSize) || reg?.getSize?.(this._draggedWidget?.size);
        const draggedCols = draggedSizeInfo?.cols || this._draggedWidget?.cols || 1;
        const draggedRows = draggedSizeInfo?.rows || this._draggedWidget?.rows || 1;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å —É—á—ë—Ç–æ–º —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–∂–µ—Ç–∞
        newGridPos.col = Math.min(newGridPos.col, GRID_COLS - draggedCols);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å (–ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ) –∏–ª–∏ swap (–∑–∞–Ω—è—Ç–æ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å—Å—è –º–µ—Å—Ç–∞–º–∏)
        const isValid = gridEngine.validatePosition(this._draggedWidget.id, newGridPos);
        let swapWith = null;
        if (!isValid) {
          const colliding = gridEngine.getCollidingWidget(this._draggedWidget.id, newGridPos);
          if (colliding) {
            // üîß FIX: –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ–±–æ–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ –∏–∑ registry –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—á–µ—Ä–µ–∑ normalize)
            const reg = HEYS.Widgets.registry;
            const normalizedCollidingSize = reg?.normalizeSizeId ? (reg.normalizeSizeId(colliding?.size) || colliding?.size) : colliding?.size;
            const collidingSizeInfo = reg?.getSize?.(normalizedCollidingSize) || reg?.getSize?.(colliding?.size);
            const collidingCols = collidingSizeInfo?.cols || colliding?.cols || 1;
            const collidingRows = collidingSizeInfo?.rows || colliding?.rows || 1;

            if (collidingCols === draggedCols && collidingRows === draggedRows) {
              swapWith = colliding;
            }
          }
        }

        // üÜï –ï—Å–ª–∏ –Ω–∏ move –Ω–∏ swap ‚Äî –ø—Ä–æ–±—É–µ–º reflow (–∞–≤—Ç–æ-—Å–¥–≤–∏–≥ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
        let reflowPositions = null;
        if (!isValid && !swapWith) {
          reflowPositions = gridEngine.computeReflowLayout(this._draggedWidget.id, newGridPos);
        }

        if (isValid || swapWith || reflowPositions) {
          this._lastValidPosition = newGridPos;
          this._dropIntent = reflowPositions
            ? { type: 'reflow', position: newGridPos, positionsById: reflowPositions }
            : (swapWith
              ? { type: 'swap', position: newGridPos, swapWithId: swapWith.id }
              : { type: 'move', position: newGridPos });

          this._updatePlaceholderPosition(newGridPos);

          if (this._placeholderElement) {
            this._placeholderElement.classList.remove('widget-placeholder--invalid');
            this._placeholderElement.classList.add('widget-placeholder--valid');
            if (reflowPositions) {
              this._placeholderElement.classList.add('widget-placeholder--reflow');
              this._placeholderElement.classList.remove('widget-placeholder--swap');
            } else if (swapWith) {
              this._placeholderElement.classList.add('widget-placeholder--swap');
              this._placeholderElement.classList.remove('widget-placeholder--reflow');
            } else {
              this._placeholderElement.classList.remove('widget-placeholder--swap');
              this._placeholderElement.classList.remove('widget-placeholder--reflow');
            }
          }
        } else {
          this._dropIntent = null;
          if (this._placeholderElement) {
            this._placeholderElement.classList.remove('widget-placeholder--valid');
            this._placeholderElement.classList.remove('widget-placeholder--swap');
            this._placeholderElement.classList.remove('widget-placeholder--reflow');
            this._placeholderElement.classList.add('widget-placeholder--invalid');
          }
        }
      }

      HEYS.Widgets.emit('dnd:move', {
        widget: this._draggedWidget,
        x: this._currentPos.x,
        y: this._currentPos.y,
        gridPosition: this._lastValidPosition
      });
    },

    /**
     * –ó–∞–≤–µ—Ä—à–∏—Ç—å drag (drop)
     * @param {Object} event
     */
    end(event) {
      if (!this._draggedWidget) {
        this._cleanup();
        return;
      }

      const hadDrag = this._dragging;

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
      if (this._originalElement) {
        this._originalElement.classList.remove('widget--dragging');
        this._originalElement.style.opacity = '';
        this._originalElement.style.transform = '';
      }

      // –£–¥–∞–ª—è–µ–º ghost –∏ placeholder
      this._removeGhost();
      this._removePlaceholder();

      // –ï—Å–ª–∏ drag –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –∏ –µ—Å—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ drop ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º
      if (hadDrag && this._dropIntent && this._dropIntent.position) {
        const targetPos = this._dropIntent.position;
        const posChanged = targetPos.col !== this._startGridPos.col || targetPos.row !== this._startGridPos.row;

        if (!posChanged) {
          HEYS.Widgets.emit('dnd:cancel', { widget: this._draggedWidget });
        } else if (this._dropIntent.type === 'move' && gridEngine.validatePosition(this._draggedWidget.id, targetPos)) {
          state.moveWidget(this._draggedWidget.id, targetPos);

          if (navigator.vibrate) {
            navigator.vibrate(10);
          }

          HEYS.Widgets.emit('dnd:drop', { widget: this._draggedWidget, from: this._startGridPos, to: targetPos });
        } else if (this._dropIntent.type === 'swap' && this._dropIntent.swapWithId) {
          const swapped = state.swapWidgets(this._draggedWidget.id, this._dropIntent.swapWithId);
          if (swapped) {
            if (navigator.vibrate) {
              navigator.vibrate(10);
            }
            HEYS.Widgets.emit('dnd:swap', {
              widget: this._draggedWidget,
              with: this._dropIntent.swapWithId,
              from: this._startGridPos,
              to: targetPos
            });
          } else {
            HEYS.Widgets.emit('dnd:cancel', { widget: this._draggedWidget });
          }
        } else if (this._dropIntent.type === 'reflow' && this._dropIntent.positionsById) {
          const applied = state.applyPositions(this._dropIntent.positionsById);
          if (applied) {
            if (navigator.vibrate) {
              navigator.vibrate(10);
            }
            HEYS.Widgets.emit('dnd:reflow', {
              widget: this._draggedWidget,
              from: this._startGridPos,
              to: targetPos,
              positionsById: this._dropIntent.positionsById
            });
          } else {
            HEYS.Widgets.emit('dnd:cancel', { widget: this._draggedWidget });
          }
        } else {
          HEYS.Widgets.emit('dnd:cancel', { widget: this._draggedWidget });
        }
      }

      this._cleanup();
    },

    /**
     * –û—Ç–º–µ–Ω–∏—Ç—å drag
     */
    cancel() {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
      if (this._originalElement) {
        this._originalElement.classList.remove('widget--dragging');
        this._originalElement.style.opacity = '';
        this._originalElement.style.transform = '';
      }

      this._removeGhost();
      this._removePlaceholder();

      HEYS.Widgets.emit('dnd:cancel', { widget: this._draggedWidget });
      this._cleanup();
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞: –∏–¥—ë—Ç –ª–∏ drag
     * @returns {boolean}
     */
    isDragging() {
      return this._dragging;
    },

    /**
     * –£–¥–∞–ª–∏—Ç—å ghost element
     * @private
     */
    _removeGhost() {
      if (this._ghostElement) {
        this._ghostElement.remove();
        this._ghostElement = null;
      }
    },

    /**
     * –£–¥–∞–ª–∏—Ç—å placeholder
     * @private
     */
    _removePlaceholder() {
      if (this._placeholderElement) {
        this._placeholderElement.remove();
        this._placeholderElement = null;
      }
    },

    _cleanup() {
      // –£–±–∏—Ä–∞–µ–º document listeners
      this._removeDocumentListeners();

      if (this._longPressTimer) {
        clearTimeout(this._longPressTimer);
        this._longPressTimer = null;
      }
      this._dragging = false;
      this._draggedWidget = null;
      this._startPos = null;
      this._currentPos = null;
      this._startGridPos = null;
      this._lastValidPosition = null;
      this._originalElement = null;
      this._longPressTriggered = false;
      this._dropIntent = null;
      this._scrollIntent = false;
      this._touchDragReadyAt = 0;
      // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã placeholder
      this._placeholderCols = null;
      this._placeholderRows = null;
    }
  };

  // === Presets ===
  const presets = {
    _presets: {
      minimal: {
        id: 'minimal',
        name: '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π',
        description: '–¢–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–∏ –∏ –≤–æ–¥–∞',
        widgets: [
          { type: 'calories', size: '2x2', position: { col: 0, row: 0 } },
          { type: 'water', size: '2x2', position: { col: 2, row: 0 } }
        ]
      },
      balanced: {
        id: 'balanced',
        name: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π',
        description: '–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏',
        widgets: [
          { type: 'calories', size: '2x2', position: { col: 0, row: 0 } },
          { type: 'water', size: '2x2', position: { col: 2, row: 0 } },
          { type: 'streak', size: '2x2', position: { col: 0, row: 2 } },
          { type: 'sleep', size: '2x2', position: { col: 2, row: 2 } }
        ]
      },
      fitness: {
        id: 'fitness',
        name: '–§–∏—Ç–Ω–µ—Å',
        description: '–î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏',
        widgets: [
          { type: 'calories', size: '4x2', position: { col: 0, row: 0 } },
          { type: 'macros', size: '4x2', position: { col: 0, row: 2 } },
          { type: 'steps', size: '2x2', position: { col: 0, row: 4 } },
          { type: 'weight', size: '2x2', position: { col: 2, row: 4 } }
        ]
      },
      detailed: {
        id: 'detailed',
        name: '–î–µ—Ç–∞–ª—å–Ω—ã–π',
        description: '–ú–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
        widgets: [
          { type: 'calories', size: '2x2', position: { col: 0, row: 0 } },
          { type: 'insulin', size: '2x2', position: { col: 2, row: 0 } },
          { type: 'macros', size: '4x2', position: { col: 0, row: 2 } },
          { type: 'water', size: '2x2', position: { col: 0, row: 4 } },
          { type: 'sleep', size: '2x2', position: { col: 2, row: 4 } },
          { type: 'weight', size: '4x2', position: { col: 0, row: 6 } },
          { type: 'streak', size: '2x2', position: { col: 0, row: 8 } },
          { type: 'steps', size: '2x2', position: { col: 2, row: 8 } }
        ]
      }
    },

    getAll() {
      return { ...this._presets };
    },

    get(id) {
      return this._presets[id] || null;
    },

    apply(id) {
      return state.applyPreset(id);
    }
  };

  // === Keyboard Support ===
  function setupKeyboardSupport() {
    document.addEventListener('keydown', (e) => {
      // Escape ‚Äî –≤—ã—Ö–æ–¥ –∏–∑ edit mode
      if (e.key === 'Escape' && state.isEditMode()) {
        e.preventDefault();
        state.exitEditMode();
      }

      // Ctrl/Cmd + Z ‚Äî undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        if (state.canUndo()) {
          e.preventDefault();
          state.undo();
        }
      }

      // Ctrl/Cmd + Shift + Z –∏–ª–∏ Ctrl/Cmd + Y ‚Äî redo
      if ((e.ctrlKey || e.metaKey) && (e.key === 'Z' || e.key === 'y')) {
        if (state.canRedo()) {
          e.preventDefault();
          state.redo();
        }
      }
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupKeyboardSupport);
  } else {
    setupKeyboardSupport();
  }

  // === üÜï Save on page unload ===
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  // —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ debounced save
  window.addEventListener('beforeunload', () => {
    // üîß FIX: –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å–ª–∏ state –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!state._initialized) return;

    // –û—Ç–º–µ–Ω—è–µ–º debounced timeout
    if (state._saveTimeout) {
      clearTimeout(state._saveTimeout);
      state._saveTimeout = null;
    }
    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    try {
      state.saveLayout();
    } catch (e) {
      err('Failed to save on unload:', e);
    }
  });

  // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ visibilitychange (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –Ω–∞ –º–æ–±–∏–ª–∫–µ)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      // üîß FIX: –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å–ª–∏ state –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
      if (!state._initialized) return;

      // –û—Ç–º–µ–Ω—è–µ–º debounced timeout
      if (state._saveTimeout) {
        clearTimeout(state._saveTimeout);
        state._saveTimeout = null;
      }
      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
      try {
        state.saveLayout();
      } catch (e) {
        err('Failed to save on visibility hidden:', e);
      }
    }
  });

  // üß© –°–ª—É—à–∞—Ç–µ–ª—å cloud sync ‚Äî –ù–ï –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º layout –µ—Å–ª–∏ –æ–Ω —Å–≤–µ–∂–∏–π –ª–æ–∫–∞–ª—å–Ω–æ
  // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–º–µ—Ä—Ü–∞–Ω–∏–µ" –≤–∏–¥–∂–µ—Ç–æ–≤ –ø–æ—Å–ª–µ cloud sync
  window.addEventListener('heys:widget-layout-updated', (e) => {
    const { layout: cloudLayout, source } = e.detail || {};

    // –ï—Å–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    if (!state._initialized) {
      return;
    }

    // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π local layout —Å updatedAt
    const localRaw = state.loadLayout();
    const localUpdatedAt = (() => {
      try {
        if (HEYS.store?.get) {
          const stored = HEYS.store.get('heys_widget_layout_v1', null);
          return stored?.updatedAt || 0;
        }
        return 0;
      } catch { return 0; }
    })();

    const cloudUpdatedAt = cloudLayout?.updatedAt || 0;

    log(`Cloud sync event: localUpdatedAt=${localUpdatedAt}, cloudUpdatedAt=${cloudUpdatedAt}`);

    // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π layout –Ω–æ–≤–µ–µ –∏–ª–∏ —Ä–∞–≤–µ–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º cloud update
    if (localUpdatedAt >= cloudUpdatedAt) {
      log('Cloud update skipped: local is newer or same');
      return;
    }

    // –û–±–ª–∞—á–Ω—ã–π layout –Ω–æ–≤–µ–µ ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
    warn('Cloud layout is newer, reloading...');
    const widgets = cloudLayout?.widgets || (Array.isArray(cloudLayout) ? cloudLayout : []);

    if (widgets.length > 0) {
      state._widgets = widgets.map(w => state._normalizeWidget(w));
      HEYS.Widgets.emit('layout:changed', { layout: state._widgets, source: 'cloud-sync' });
    }
  });

  // === Exports ===
  HEYS.Widgets.state = state;
  HEYS.Widgets.grid = gridEngine;
  HEYS.Widgets.dnd = dnd;
  HEYS.Widgets.presets = presets;

  // –£–¥–æ–±–Ω—ã–µ –∞–ª–∏–∞—Å—ã
  HEYS.Widgets.getWidgets = () => state.getWidgets();
  HEYS.Widgets.addWidget = (w) => state.addWidget(w);
  HEYS.Widgets.removeWidget = (id) => state.removeWidget(id);
  HEYS.Widgets.isEditMode = () => state.isEditMode();
  HEYS.Widgets.enterEditMode = () => state.enterEditMode();
  HEYS.Widgets.exitEditMode = () => state.exitEditMode();
  HEYS.Widgets.toggleEditMode = () => state.toggleEditMode();
  HEYS.Widgets.undo = () => state.undo();
  HEYS.Widgets.redo = () => state.redo();
  HEYS.Widgets.canUndo = () => state.canUndo();
  HEYS.Widgets.canRedo = () => state.canRedo();

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== widgets/widget_data.js ===== */
/**
 * widget_data.js
 * Data Access Layer –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤
 * Version: 1.1.0
 * Created: 2025-12-15
 * Updated: 2025-01-05
 * 
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–∂–µ—Ç–æ–≤.
 * –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ HEYS –º–æ–¥—É–ª—è–º–∏ (Day, User, InsulinWave, Cycle).
 * 
 * v1.1.0: –î–æ–±–∞–≤–ª–µ–Ω Demo Mode –¥–ª—è WidgetsTour ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ
 *         –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è —Ç—É—Ä–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ—Å–ª–µ.
 */
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.Widgets = HEYS.Widgets || {};

  // === DEMO DATA –¥–ª—è WidgetsTour ===
  // –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –≤–∏–¥–∂–µ—Ç–æ–≤
  const DEMO_WIDGET_DATA = {
    calories: {
      eaten: 1650,
      target: 2100,
      remaining: 450,
      pct: 79
    },
    water: {
      drunk: 1400,
      target: 2000,
      pct: 70
    },
    sleep: {
      hours: 7.5,
      target: 8,
      quality: 4
    },
    streak: {
      current: 5,
      max: 12
    },
    weight: {
      current: 72.5,
      goal: 70,
      trend: -0.08,
      weekChange: -0.56,
      monthChange: -2.4,
      daysToGoal: 31,
      weeksToGoal: 4,
      progressPct: 62,
      bmi: 24.2,
      bmiCategory: { name: '–ù–æ—Ä–º–∞', color: '#22c55e' },
      sparkline: [
        { date: '2025-01-01', weight: 74.2 },
        { date: '2025-01-02', weight: 74.0 },
        { date: '2025-01-03', weight: 73.8 },
        { date: '2025-01-04', weight: 73.5 },
        { date: '2025-01-05', weight: 72.5 }
      ],
      dataPoints: 5,
      excludedDays: 0,
      hasCleanTrend: false
    },
    steps: {
      steps: 7850,
      goal: 10000,
      pct: 79
    },
    macros: {
      protein: 95,
      fat: 52,
      carbs: 185,
      proteinTarget: 120,
      fatTarget: 70,
      carbsTarget: 260
    },
    insulin: {
      status: 'almost',
      remaining: 25,
      phase: 'decline',
      endTime: '14:30'
    },
    heatmap: {
      days: [
        { date: '2025-01-01', status: 'green', hasTraining: true, highStress: false },
        { date: '2025-01-02', status: 'green', hasTraining: false, highStress: false },
        { date: '2025-01-03', status: 'yellow', hasTraining: false, highStress: true },
        { date: '2025-01-04', status: 'green', hasTraining: true, highStress: false },
        { date: '2025-01-05', status: 'green', hasTraining: false, highStress: false },
        { date: '2025-01-06', status: 'yellow', hasTraining: false, highStress: false },
        { date: '2025-01-07', status: 'empty', hasTraining: false, highStress: false }
      ]
    },
    cycle: {
      day: 12,
      phase: { id: 'follicular', name: '–§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è', icon: 'üå±' }
    },
    status: {
      score: 78,
      topIssues: ['–û—Å—Ç–∞–ª–æ—Å—å 450 –∫–∫–∞–ª', '–î–æ–±–∞–≤—å –≤–æ–¥—ã'],
      factors: {
        nutrition: 0.82,
        activity: 0.75,
        recovery: 0.80,
        hydration: 0.70
      }
    },
    crashRisk: {
      level: 'low',
      score: 25,
      factors: ['–•–æ—Ä–æ—à–∏–π —Å–æ–Ω', '–ù–∏–∑–∫–∏–π —Å—Ç—Ä–µ—Å—Å'],
      recommendation: '–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!'
    }
  };

  const parseStoredValue = (raw, fallback) => {
    if (raw == null) return fallback;
    if (typeof raw === 'object') return raw;
    if (typeof raw !== 'string') return raw;
    try {
      if (raw.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        return HEYS.store.decompress(raw);
      }
      return JSON.parse(raw);
    } catch (e) {
      return fallback;
    }
  };

  const readStoredValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) return HEYS.store.get(key, fallback);
      if (HEYS.utils?.lsGet) return HEYS.utils.lsGet(key, fallback);
      const raw = localStorage.getItem(key);
      return parseStoredValue(raw, fallback);
    } catch (e) {
      return fallback;
    }
  };

  // === Data Access Layer ===
  const data = {
    _cache: new Map(),
    _lastUpdate: 0,
    _updateInterval: 1000, // 1 second cache

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –¥–µ–º–æ-—Ä–µ–∂–∏–º (WidgetsTour –∑–∞–ø—É—â–µ–Ω)
     * @returns {boolean}
     */
    _isDemoMode() {
      return HEYS.WidgetsTour?.isActive?.() === true;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
     * @param {Object} widget - Widget instance
     * @returns {Object} Data object for widget
     */
    getDataForWidget(widget) {
      switch (widget.type) {
        case 'status':
          return this.getStatusData();
        case 'calories':
          return this.getCaloriesData();
        case 'water':
          return this.getWaterData();
        case 'sleep':
          return this.getSleepData();
        case 'streak':
          return this.getStreakData();
        case 'weight':
          return this.getWeightData();
        case 'steps':
          return this.getStepsData();
        case 'macros':
          return this.getMacrosData();
        case 'insulin':
          return this.getInsulinData();
        case 'heatmap':
          return this.getHeatmapData(widget.settings?.period || 'week');
        case 'cycle':
          return this.getCycleData();
        case 'crashRisk':
          return this.getCrashRiskData();
        default:
          return {};
      }
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 0-100
     * @returns {Object} { status, dayData, profile, dayTot, normAbs, waterGoal }
     */
    getStatusData() {
      // üé≠ Demo mode: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è —Ç—É—Ä–∞
      if (this._isDemoMode()) {
        return {
          status: { score: DEMO_WIDGET_DATA.status.score, level: 'good' },
          dayData: {},
          profile: {},
          dayTot: { kcal: DEMO_WIDGET_DATA.calories.eaten },
          normAbs: {},
          waterGoal: DEMO_WIDGET_DATA.water.target,
          topIssues: DEMO_WIDGET_DATA.status.topIssues,
          factors: DEMO_WIDGET_DATA.status.factors
        };
      }

      const dayData = this._getDay() || {};
      const profile = this._getProfile() || {};
      const dayTot = this._getDayTotals() || {};
      const normAbs = this._getNormAbs() || {};
      const waterGoal = this._getWaterGoal() || 2000;

      // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ –º–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω
      const status = HEYS.Status?.calculateStatus?.({
        dayData,
        profile,
        dayTot,
        normAbs,
        waterGoal
      }) || { score: 0, level: 'okay' };

      return {
        status,
        dayData,
        profile,
        dayTot,
        normAbs,
        waterGoal
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫–∞–ª–æ—Ä–∏—è—Ö
     * @returns {Object} { eaten, target, remaining, pct }
     */
    getCaloriesData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.calories };
      }

      const dayTot = this._getDayTotals();
      const optimum = this._getOptimum();

      return {
        eaten: dayTot?.kcal || 0,
        target: optimum || 2000,
        remaining: Math.max(0, (optimum || 2000) - (dayTot?.kcal || 0)),
        pct: optimum > 0 ? Math.round(((dayTot?.kcal || 0) / optimum) * 100) : 0
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≤–æ–¥–µ
     * @returns {Object} { drunk, target, pct }
     */
    getWaterData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.water };
      }

      const day = this._getDay();
      const waterGoal = this._getWaterGoal();

      return {
        drunk: day?.waterMl || 0,
        target: waterGoal || 2000,
        pct: waterGoal > 0 ? Math.round(((day?.waterMl || 0) / waterGoal) * 100) : 0
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–Ω–µ
     * @returns {Object} { hours, target, quality }
     */
    getSleepData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.sleep };
      }

      const day = this._getDay();
      const prof = this._getProfile();

      return {
        hours: day?.sleepHours || 0,
        target: prof?.sleepHours || 8,
        quality: day?.sleepQuality || null
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ streak
     * @returns {Object} { current, max }
     */
    getStreakData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.streak };
      }

      // –ü–æ–ª—É—á–∞–µ–º streak –∏–∑ HEYS.Day –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
      const currentStreak = HEYS.Day?.getCurrentStreak?.() || 0;
      const maxStreak = HEYS.Day?.getMaxStreak?.() || currentStreak;

      return {
        current: currentStreak,
        max: maxStreak
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤)
     * @returns {Object} { current, goal, trend, weekChange, monthChange, daysToGoal, bmi, sparkline, ... }
     */
    getWeightData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.weight };
      }

      const day = this._getDay();
      const prof = this._getProfile();

      const current = day?.weightMorning || prof?.weight || null;
      const goal = prof?.weightGoal || null;

      // –†–∞—Å—á—ë—Ç —Ç—Ä–µ–Ω–¥–∞ –∏ —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞
      const trendData = this._calculateWeightTrendExtended();
      const trend = trendData?.trend || null;
      const sparkline = trendData?.sparkline || [];

      // BMI
      const bmi = prof?.weight && prof?.height
        ? parseFloat((prof.weight / Math.pow(prof.height / 100, 2)).toFixed(1))
        : null;

      // –ü—Ä–æ–≥–Ω–æ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      const weekChange = trend ? parseFloat((trend * 7).toFixed(2)) : null;
      const monthChange = trend ? parseFloat((trend * 30).toFixed(1)) : null;

      // –î–Ω–µ–π –¥–æ —Ü–µ–ª–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –≤ –Ω—É–∂–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏)
      let daysToGoal = null;
      let weeksToGoal = null;
      if (current && goal && trend) {
        const diff = current - goal;
        // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏: —Å–Ω–∏–∂–∞–µ–º –≤–µ—Å (diff>0, trend<0) –∏–ª–∏ –Ω–∞–±–∏—Ä–∞–µ–º (diff<0, trend>0)
        if ((diff > 0 && trend < -0.01) || (diff < 0 && trend > 0.01)) {
          daysToGoal = Math.round(Math.abs(diff / trend));
          weeksToGoal = Math.round(daysToGoal / 7);
        }
      }

      // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏ (0-100%)
      let progressPct = null;
      if (current && goal && prof?.weight) {
        const startWeight = prof.weight; // –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        const totalDiff = startWeight - goal;
        const currentDiff = current - goal;
        if (Math.abs(totalDiff) > 0.1) {
          progressPct = Math.max(0, Math.min(100, Math.round((1 - currentDiff / totalDiff) * 100)));
        }
      }

      // –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –¥–Ω–∏ (—Ü–∏–∫–ª/refeed)
      const excludedDays = sparkline?.filter(d => d.excluded)?.length || 0;

      return {
        current,
        goal,
        trend,                    // –∫–≥/–¥–µ–Ω—å
        weekChange,               // ‚àí0.5 –∫–≥/–Ω–µ–¥–µ–ª—é
        monthChange,              // ‚àí2.1 –∫–≥/–º–µ—Å—è—Ü
        daysToGoal,               // 98 (–¥–Ω–µ–π)
        weeksToGoal,              // 14 (–Ω–µ–¥–µ–ª—å)
        progressPct,              // 45%
        bmi,                      // 26.4
        bmiCategory: this._getBMICategory(bmi),
        sparkline,                // –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        dataPoints: sparkline?.length || 0,
        excludedDays,
        hasCleanTrend: excludedDays > 0
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —à–∞–≥–∞—Ö
     * @returns {Object} { steps, goal, pct }
     */
    getStepsData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.steps };
      }

      const day = this._getDay();
      const prof = this._getProfile();
      const goal = prof?.stepsGoal || 10000;

      return {
        steps: day?.steps || 0,
        goal: goal,
        pct: goal > 0 ? Math.round(((day?.steps || 0) / goal) * 100) : 0
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –º–∞–∫—Ä–æ—Å–∞—Ö (–ë–ñ–£)
     * @returns {Object}
     */
    getMacrosData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.macros };
      }

      const dayTot = this._getDayTotals();
      const normAbs = this._getNormAbs();

      return {
        protein: dayTot?.prot || 0,
        fat: dayTot?.fat || 0,
        carbs: dayTot?.carbs || 0,
        proteinTarget: normAbs?.prot || 100,
        fatTarget: normAbs?.fat || 70,
        carbsTarget: normAbs?.carbs || 250
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω–µ
     * @returns {Object}
     */
    getInsulinData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.insulin };
      }

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã –µ—Å–ª–∏ –º–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω
      const waveData = HEYS.InsulinWave?.getWaveData?.() || {};

      return {
        status: waveData.status || 'unknown',
        remaining: waveData.remaining || 0,
        phase: waveData.currentPhase || null,
        endTime: waveData.endTime || null
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è heatmap
     * @param {string} period - 'week' –∏–ª–∏ 'month'
     * @returns {Object} { days: Array, currentStreak }
     * v3.22.0: –¥–æ–±–∞–≤–ª–µ–Ω–æ hasTraining, highStress –≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
     */
    getHeatmapData(period = 'week') {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.heatmap };
      }

      const days = [];
      const count = period === 'week' ? 7 : 30;
      const today = new Date();

      for (let i = count - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = this._formatDate(date);

        const dayData = this._getDayByDate(dateStr);
        const dayTot = this._calculateDayTotals(dayData);
        const optimum = this._getOptimumForDay(dayData);

        let status = 'empty';
        if (dayTot && dayTot.kcal > 0 && optimum > 0) {
          const ratio = dayTot.kcal / optimum;
          status = HEYS.ratioZones?.getHeatmapStatus?.(ratio) || 'empty';
        }

        // üÜï v3.22.0: Extended analytics ‚Äî training & stress
        const hasTraining = dayData?.trainings?.length > 0;
        const highStress = (dayData?.stressAvg || 0) >= 6;

        days.push({
          date: dateStr,
          status,
          hasTraining,
          highStress
        });
      }

      return { days };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–º —Ü–∏–∫–ª–µ
     * @returns {Object}
     */
    getCycleData() {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.cycle };
      }

      const day = this._getDay();
      const cycleDay = day?.cycleDay;

      if (!cycleDay) {
        return { day: null, phase: null };
      }

      const phase = HEYS.Cycle?.getCyclePhase?.(cycleDay);

      return {
        day: cycleDay,
        phase: phase
      };
    },

    // === Private Helper Methods ===

    // –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ WidgetsTab)
    _selectedDate: null,

    _getDay() {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º selectedDate –∏–∑ WidgetsTab, –∏–ª–∏ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∫–∞–∫ fallback
      const dateStr = this._selectedDate || this._formatDate(new Date());
      const day = this._getDayByDate(dateStr);
      return day;
    },

    _getDayByDate(dateStr) {
      // –ö–ª—é—á –¥–Ω—è: heys_dayv2_YYYY-MM-DD (namespace –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ store.get)
      const key = `heys_dayv2_${dateStr}`;
      try {
        const clientId = HEYS.currentClientId;

        // 1. Store-first (scoped —á–µ—Ä–µ–∑ HEYS.store / HEYS.utils)
        const stored = readStoredValue(key, null);
        if (stored) return stored;

        // 2. Fallback: scoped key –Ω–∞–ø—Ä—è–º—É—é –≤ localStorage
        if (clientId) {
          const scopedKey = `heys_${clientId}_dayv2_${dateStr}`;
          const scopedRaw = localStorage.getItem(scopedKey);
          const scopedParsed = parseStoredValue(scopedRaw, null);
          if (scopedParsed) return scopedParsed;
        }

        // 3. –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback: unscoped key
        const raw = localStorage.getItem(key);
        return parseStoredValue(raw, null);
      } catch (e) {
        return null;
      }
    },

    _getProfile() {
      return readStoredValue('heys_profile', {});
    },

    _getNorms() {
      return readStoredValue('heys_norms', {});
    },

    _getDayTotals() {
      // –í—ã—á–∏—Å–ª—è–µ–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
      const day = this._getDay();
      const totals = this._calculateDayTotals(day);
      return totals;
    },

    _calculateDayTotals(day) {
      if (!day || !day.meals) {
        return { kcal: 0, prot: 0, fat: 0, carbs: 0, fiber: 0 };
      }

      const totals = { kcal: 0, prot: 0, fat: 0, carbs: 0, fiber: 0 };

      day.meals.forEach(meal => {
        if (meal.items) {
          meal.items.forEach(item => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –≤ item –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–∞
            const g = (item.grams || 0) / 100;
            totals.kcal += (item.kcal100 || 0) * g;
            totals.prot += (item.protein100 || 0) * g;
            totals.fat += (item.fat100 || 0) * g;
            totals.carbs += (item.carbs100 || 0) * g;
            totals.fiber += (item.fiber100 || 0) * g;
          });
        }
      });

      return totals;
    },

    _getOptimum() {
      const day = this._getDay() || {};
      return this._getOptimumForDay(day);
    },

    _getOptimumForDay(dayData) {
      const dayUtils = HEYS.dayUtils || {};
      if (dayUtils.getOptimumForDay) {
        const result = dayUtils.getOptimumForDay(dayData, this._getProfile());
        return result?.optimum || 2000;
      }

      // üî¨ TDEE v1.1.0: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è
      const day = dayData || {};
      const prof = this._getProfile() || {};

      // –ï—Å–ª–∏ –µ—Å—Ç—å –º–æ–¥—É–ª—å TDEE ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (HEYS.TDEE?.calculate) {
        const tdeeResult = HEYS.TDEE.calculate(day, prof, {});
        return tdeeResult?.optimum || 2000;
      }

      // Fallback: —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      if (!prof.weight || !prof.height || !prof.age) {
        return 2000;
      }

      const bmr = HEYS.TDEE?.calcBMR?.(prof) || (
        prof.gender === '–ú—É–∂—Å–∫–æ–π'
          ? 10 * prof.weight + 6.25 * prof.height - 5 * prof.age + 5
          : 10 * prof.weight + 6.25 * prof.height - 5 * prof.age - 161
      );

      const activityMultipliers = {
        sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725, very_active: 1.9
      };
      const multiplier = activityMultipliers[prof.activityLevel] || 1.55;
      const deficitPct = prof.deficitPctTarget || 0;

      return Math.round(bmr * multiplier * (1 + deficitPct / 100));
    },

    _getNormAbs() {
      const optimum = this._getOptimum();
      const norms = this._getNorms();

      const carbsPct = norms.carbsPct || 50;
      const proteinPct = norms.proteinPct || 25;
      const fatPct = 100 - carbsPct - proteinPct;

      return {
        kcal: optimum,
        carbs: Math.round(optimum * carbsPct / 100 / 4),
        prot: Math.round(optimum * proteinPct / 100 / 4),
        fat: Math.round(optimum * fatPct / 100 / 9)
      };
    },

    _getWaterGoal() {
      // –ï—Å–ª–∏ –µ—Å—Ç—å HEYS.Day, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –º–µ—Ç–æ–¥
      if (HEYS.Day?.getWaterGoal) {
        return HEYS.Day.getWaterGoal();
      }

      // Fallback: –±–∞–∑–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç (30–º–ª –Ω–∞ –∫–≥ –≤–µ—Å–∞)
      const prof = this._getProfile();
      return Math.round((prof.weight || 70) * 30);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ä–∏—Å–∫–µ —Å—Ä—ã–≤–∞
     * @returns {Object} { risk, level, factors, recommendation, color }
     */
    getCrashRiskData(settings = {}) {
      // üé≠ Demo mode
      if (this._isDemoMode()) {
        return { ...DEMO_WIDGET_DATA.crashRisk };
      }

      try {
        // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π data provider v2.0
        const provider = HEYS.Widgets.DataProviders?.crashRisk;

        if (!provider) {
          console.warn('[widget_data.getCrashRiskData] crashRisk provider not loaded');
          return {
            hasData: false,
            weeklyLossPercent: 0,
            isWarning: false,
            severity: 'none',
            message: 'Data provider –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω',
            ewsCount: 0,
            ewsData: null
          };
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–∏–æ–¥ –∏–∑ settings –≤–∏–¥–∂–µ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π)
        const days = settings?.periodDays || 7;

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É provider
        const result = provider.getData({ days });

        // –î–æ–±–∞–≤–ª—è–µ–º verification logging
        if (result?.hasData) {
          console.info('[widget_data.getCrashRiskData] ‚úÖ Data loaded:', {
            weeklyLossPercent: result.weeklyLossPercent.toFixed(2) + '%',
            severity: result.severity,
            ewsCount: result.ewsCount,
            dataPoints: result.dataPoints
          });
        }

        return result;

      } catch (error) {
        console.error('[widget_data.getCrashRiskData] ‚ùå Error:', error);
        return {
          hasData: false,
          weeklyLossPercent: 0,
          isWarning: false,
          severity: 'none',
          message: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö',
          ewsCount: 0,
          ewsData: null
        };
      }
    },

    /**
     * –î–µ—Ñ–æ–ª—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—é —Ä–∏—Å–∫–∞
     */
    _getDefaultRecommendation(level) {
      switch (level) {
        case 'high':
          return '–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–∫—É—Å –∏–ª–∏ –ª—ë–≥–∫—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.';
        case 'medium':
          return '–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–µ–∂–∏–º–æ–º –ø–∏—Ç–∞–Ω–∏—è –∏ –æ—Ç–¥—ã—Ö–æ–º.';
        case 'low':
        default:
          return '–í—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.';
      }
    },

    _calculateWeightTrend() {
      // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
      const weights = [];
      const today = new Date();

      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = this._formatDate(date);
        const dayData = this._getDayByDate(dateStr);

        if (dayData?.weightMorning) {
          weights.push({
            date: dateStr,
            weight: dayData.weightMorning,
            daysAgo: i
          });
        }
      }

      if (weights.length < 2) return null;

      // –ü—Ä–æ—Å—Ç–æ–π —Ç—Ä–µ–Ω–¥: —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ø–µ—Ä–≤—ã–º –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–º
      const latest = weights[0];
      const oldest = weights[weights.length - 1];

      return (latest.weight - oldest.weight) / oldest.daysAgo;
    },

    /**
     * –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ç—Ä–µ–Ω–¥–∞ –≤–µ—Å–∞ + —Å–ø–∞—Ä–∫–ª–∞–π–Ω
     * @param {number} days - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
     * @returns {Object} { trend, sparkline }
     */
    _calculateWeightTrendExtended(days = 14) {
      const weights = [];
      const today = new Date();

      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = this._formatDate(date);
        const dayData = this._getDayByDate(dateStr);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –¥–Ω–∏ (—Ü–∏–∫–ª/refeed)
        const cycleDay = dayData?.cycleDay;
        const isRefeed = dayData?.isRefeedDay;
        const hasRetention = HEYS.Cycle?.getWaterRetentionInfo?.(cycleDay)?.hasRetention || false;
        const excluded = hasRetention || isRefeed;

        weights.push({
          date: dateStr,
          dayNum: date.getDate(),
          weight: dayData?.weightMorning || null,
          daysAgo: i,
          isToday: i === 0,
          excluded,
          cycleDay,
          hasWaterRetention: hasRetention
        });
      }

      // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ç—Ä–µ–Ω–¥–∞ (—Ç–æ–ª—å–∫–æ —Å –≤–µ—Å–æ–º, –±–µ–∑ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö)
      const validWeights = weights.filter(w => w.weight !== null && !w.excluded);

      let trend = null;
      if (validWeights.length >= 2) {
        // –õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è
        const n = validWeights.length;
        const sumX = validWeights.reduce((s, w, i) => s + i, 0);
        const sumY = validWeights.reduce((s, w) => s + w.weight, 0);
        const sumXY = validWeights.reduce((s, w, i) => s + i * w.weight, 0);
        const sumX2 = validWeights.reduce((s, w, i) => s + i * i, 0);

        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        trend = isNaN(slope) ? null : slope;
      }

      return {
        trend,
        sparkline: weights,
        dataPoints: validWeights.length,
        excludedCount: weights.filter(w => w.excluded).length
      };
    },

    /**
     * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é BMI
     * @param {number} bmi
     * @returns {Object} { id, label, color }
     */
    _getBMICategory(bmi) {
      if (!bmi) return null;

      if (bmi < 18.5) return { id: 'underweight', label: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫', color: '#3b82f6' };
      if (bmi < 25) return { id: 'normal', label: '–ù–æ—Ä–º–∞', color: '#22c55e' };
      if (bmi < 30) return { id: 'overweight', label: '–ò–∑–±—ã—Ç–æ–∫', color: '#eab308' };
      return { id: 'obese', label: '–û–∂–∏—Ä–µ–Ω–∏–µ', color: '#ef4444' };
    },

    _formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    },

    /**
     * –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
     * @param {Function} callback
     * @returns {Function} unsubscribe
     */
    subscribe(callback) {
      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è HEYS, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      const events = [
        'day:updated',
        'meal:added',
        'meal:updated',
        'product:added',
        'water:added',
        'training:added',
        'profile:updated'
      ];

      const handler = () => {
        callback();
        HEYS.Widgets.emit('data:updated', {});
      };

      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
      events.forEach(event => {
        if (HEYS.events?.on) {
          HEYS.events.on(event, handler);
        }
      });

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏
      return () => {
        events.forEach(event => {
          if (HEYS.events?.off) {
            HEYS.events.off(event, handler);
          }
        });
      };
    },

    /**
     * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
     */
    refresh() {
      this._cache.clear();
      this._lastUpdate = Date.now();
      HEYS.Widgets.emit('data:updated', {});
    }
  };

  // === Export ===
  HEYS.Widgets.data = data;

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_widgets_ui_v1.js ===== */
/**
 * heys_widgets_ui_v1.js
 * UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –ö–∞—Ç–∞–ª–æ–≥, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, WidgetsTab
 * Version: 1.1.0
 * Created: 2025-12-15
 * 
 * v1.1.0:
 * - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ pointer events –¥–ª—è drag & drop
 * - Long press (500ms) –¥–ª—è –≤—Ö–æ–¥–∞ –≤ edit mode
 * - Ghost —ç–ª–µ–º–µ–Ω—Ç –∏ placeholder preview
 * - Undo/Redo –∫–Ω–æ–ø–∫–∏ –≤ header
 */
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  HEYS.Widgets = HEYS.Widgets || {};

  const React = global.React;
  const { useState, useEffect, useMemo, useCallback, useRef } = React || {};

  // Debug/telemetry helpers (–±–µ–∑ –ø—Ä—è–º–æ–≥–æ console.*)
  const _widgetsOnce = HEYS.Widgets._once || (HEYS.Widgets._once = {});

  function widgetsDebugEnabled() {
    try {
      return localStorage.getItem('heys_debug_widgets') === '1';
    } catch (e) {
      return false;
    }
  }

  function widgetsOnce(key) {
    if (!key) return true;
    if (_widgetsOnce[key]) return false;
    _widgetsOnce[key] = true;
    return true;
  }

  function trackWidgetIssue(eventName, payload) {
    const a = HEYS.analytics;
    if (!a || typeof a.trackError !== 'function') return;
    try {
      // –í –ø—Ä–æ–µ–∫—Ç–µ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –æ–±–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã:
      // - trackError('event_name', { ...payload })
      // - trackError(Error|string, 'source')
      if (payload && typeof payload === 'object') {
        a.trackError(eventName, payload);
        return;
      }
    } catch (e) {
      // no-op
    }
    try {
      a.trackError(String(eventName || 'widgets_issue'), 'widgets');
    } catch (e) {
      // no-op
    }
  }

  // –ï–¥–∏–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞: —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–∂–µ—Ç–∞ (–Ω–µ –∑–∞–≤—è–∑–∞–Ω—ã –Ω–∞ ¬´–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å¬ª)
  function getWidgetDims(widget) {
    const registry = HEYS.Widgets?.registry;
    const sizeId = widget?.size;
    const size = sizeId && typeof registry?.getSize === 'function' ? registry.getSize(sizeId) : null;

    let cols = widget?.cols ?? size?.cols;
    let rows = widget?.rows ?? size?.rows;

    if (!Number.isFinite(cols) || !Number.isFinite(rows)) {
      const m = typeof sizeId === 'string' ? sizeId.match(/^([1-4])x([1-4])$/) : null;
      if (m) {
        cols = Number(m[1]);
        rows = Number(m[2]);
      }
    }

    cols = Number.isFinite(cols) ? Math.max(1, Math.min(4, cols)) : 1;
    rows = Number.isFinite(rows) ? Math.max(1, Math.min(4, rows)) : 1;

    const area = cols * rows;
    const isMicro = area <= 1;
    const isTiny = area <= 2;
    const isShort = rows === 1;
    const isTall = cols === 1 && rows >= 2;
    const isWide = cols >= 3 && rows <= 2;

    return { cols, rows, area, isMicro, isTiny, isShort, isTall, isWide, sizeId };
  }

  // === Widget Card Component ===
  function WidgetCard({ widget, isEditMode, onRemove, onSettings, index = 0 }) {
    const registry = HEYS.Widgets.registry;
    const widgetType = registry?.getType(widget.type);
    const category = registry?.getCategory(widgetType?.category);
    const elementRef = useRef(null);

    // Refs –¥–ª—è resize handles (–¥–ª—è native touch events)
    const handleNRef = useRef(null);
    const handleERef = useRef(null);
    const handleSRef = useRef(null);
    const handleWRef = useRef(null);
    const handleNWRef = useRef(null);
    const handleNERef = useRef(null);
    const handleSWRef = useRef(null);
    const handleSERef = useRef(null);

    // Drag-resize (–±–µ–∑ popover): —Ç—è–Ω–µ–º –∑–∞ —Ö–µ–Ω–¥–ª—ã –Ω–∞ –≥—Ä–∞–Ω—è—Ö/—É–≥–ª–∞—Ö ‚Üí —Å–Ω–∞–ø –∫ –¥–æ—Å—Ç—É–ø–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º
    const resizeDragRef = useRef({
      active: false,
      pointerId: null,
      isTouchBased: false, // true –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ touchstart (iOS Safari)
      direction: null, // 'n'|'e'|'s'|'w'|'nw'|'ne'|'sw'|'se'
      startX: 0,
      startY: 0,
      baseCols: 1,
      baseRows: 1,
      baseSizeId: null,
      basePos: { col: 0, row: 0 },
      fixedRight: 0,
      fixedBottom: 0,
      lastDeltaCols: 0,
      lastDeltaRows: 0,
      raf: 0,
      pending: null,
      last: null
    });
    const [resizePreview, setResizePreview] = useState(null);

    // Snap feedback: –∫–æ—Ä–æ—Ç–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ sizeId –≤–æ –≤—Ä–µ–º—è drag-resize
    const [isResizeSnap, setIsResizeSnap] = useState(false);
    const snapTimerRef = useRef(0);

    // DnD-—Ö—ç–Ω–¥–ª–µ—Ä—ã ‚Äî —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const handlePointerDown = useCallback((e) => {
      if (!isEditMode) return;
      if (resizeDragRef.current?.active) return;
      const t = e?.target;
      if (t && typeof t.closest === 'function') {
        if (t.closest('.widget__resize-handle') || t.closest('.widget__size-badge')) return;
      }
      HEYS.Widgets.dnd?.handlePointerDown?.(widget.id, e, elementRef.current);
    }, [isEditMode, widget.id]);

    const handlePointerMove = useCallback((e) => {
      if (!isEditMode) return;
      if (resizeDragRef.current?.active) return;
      HEYS.Widgets.dnd?.handlePointerMove?.(e);
    }, [isEditMode]);

    const handlePointerUp = useCallback((e) => {
      if (!isEditMode) return;
      if (resizeDragRef.current?.active) return;
      HEYS.Widgets.dnd?.handlePointerUp?.(widget.id, e);
    }, [isEditMode, widget.id]);

    const handleClick = useCallback(() => {
      if (!isEditMode) {
        HEYS.Widgets.emit('widget:click', { widget });
      }
    }, [isEditMode, widget]);

    const handleRemoveClick = useCallback((e) => {
      e.stopPropagation();
      onRemove?.(widget.id);
    }, [widget.id, onRemove]);

    const handleSettingsClick = useCallback((e) => {
      e.stopPropagation();
      onSettings?.(widget);
    }, [widget, onSettings]);

    const availableSizes = useMemo(() => {
      const typeDef = widgetType;
      if (typeDef?.availableSizes && typeDef.availableSizes.length) return typeDef.availableSizes;
      return [typeDef?.defaultSize || widget.size || '2x2'];
    }, [widgetType, widget.size]);

    const currentSizeLabel = useMemo(() => {
      const s = HEYS.Widgets.registry?.getSize?.(widget.size);
      return s?.label || widget.size;
    }, [widget.size]);

    const getGridCols = useCallback(() => {
      try {
        const grid = document.querySelector('.widgets-grid');
        if (!grid) return 4;
        const cs = window.getComputedStyle(grid);
        const v = parseInt(cs.getPropertyValue('--widget-grid-columns'), 10);
        return Number.isFinite(v) && v > 0 ? v : 4;
      } catch (e) {
        return 4;
      }
    }, []);

    const pickNearestSize = useCallback((targetCols, targetRows, deltaCols = 0, deltaRows = 0) => {
      // CRITICAL: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ cols/rows –∏–∑ registry –ø–æ sizeId
      const currentSizeId = widget.size || '2x2';
      const currentSizeInfo = HEYS.Widgets.registry?.getSize?.(currentSizeId);
      const currentCols = currentSizeInfo?.cols || widget.cols || 1;
      const currentRows = currentSizeInfo?.rows || widget.rows || 1;

      // CRITICAL: –ï—Å–ª–∏ –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä (–Ω–µ –º–µ–Ω—è–µ–º)
      if (deltaCols === 0 && deltaRows === 0) {
        return { sizeId: currentSizeId, cols: currentCols, rows: currentRows };
      }

      const sizes = (availableSizes && availableSizes.length) ? availableSizes : [currentSizeId];
      const reg = HEYS.Widgets.registry;
      const preferBigger = (deltaCols + deltaRows) >= 0;

      if (widgetsDebugEnabled() && widgetsOnce(`resize:pickNearestSize:${widget.type}`)) {
        trackWidgetIssue('widgets_resize_pickNearestSize', {
          type: widget.type,
          targetCols,
          targetRows,
          deltaCols,
          deltaRows,
          preferBigger,
          availableSizes: sizes
        });
      }

      let best = null;
      for (const sizeId of sizes) {
        const s = reg?.getSize?.(sizeId);
        const cols = s?.cols || 1;
        const rows = s?.rows || 1;
        const dist = Math.abs(cols - targetCols) + Math.abs(rows - targetRows);
        const area = cols * rows;

        if (!best) {
          best = { sizeId, cols, rows, dist, area };
          continue;
        }

        if (dist < best.dist) {
          best = { sizeId, cols, rows, dist, area };
          continue;
        }

        if (dist === best.dist) {
          // tie-break: –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ ‚Äî –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –±–æ–ª—å—à–∏–π area, –ø—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ ‚Äî –º–µ–Ω—å—à–∏–π
          if (preferBigger && area > best.area) {
            best = { sizeId, cols, rows, dist, area };
          } else if (!preferBigger && area < best.area) {
            best = { sizeId, cols, rows, dist, area };
          }
        }
      }

      // Fallback: –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä
      return best || { sizeId: currentSizeId, cols: currentCols, rows: currentRows };
    }, [availableSizes, widget.size]);

    const updateResizePreview = useCallback((next) => {
      const ref = resizeDragRef.current;

      const prevSizeId = ref.last?.sizeId || null;
      const nextSizeId = next?.sizeId || null;

      ref.last = next;
      ref.pending = next;

      // –ï—Å–ª–∏ —Å–Ω–∞–ø–Ω—É–ª–∏ –Ω–∞ –¥—Ä—É–≥–æ–π —Ä–∞–∑–º–µ—Ä ‚Äî –¥–∞—ë–º –ª—ë–≥–∫–∏–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π ‚Äú—â–µ–ª—á–æ–∫‚Äù
      if (nextSizeId && prevSizeId && nextSizeId !== prevSizeId) {
        setIsResizeSnap(true);
        if (snapTimerRef.current) {
          clearTimeout(snapTimerRef.current);
          snapTimerRef.current = 0;
        }
        snapTimerRef.current = setTimeout(() => {
          setIsResizeSnap(false);
          snapTimerRef.current = 0;
        }, 140);
      }

      if (ref.raf) return;
      ref.raf = requestAnimationFrame(() => {
        ref.raf = 0;
        if (!ref.pending) return;
        setResizePreview(ref.pending);
        ref.pending = null;
      });
    }, []);

    const endResizeDrag = useCallback((reason = 'up') => {
      const ref = resizeDragRef.current;

      // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º ref.active –ü–ï–†–ï–î —Å–±—Ä–æ—Å–æ–º —Ñ–ª–∞–≥–∞!
      if (!ref.active) return;

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ref.active –°–†–ê–ó–£ —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–≥–Ω–æ—Ä–∏–ª–∏—Å—å
      ref.active = false;

      // –ò —Ç–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ resize + –æ—á–∏—â–∞–µ–º safety timeout
      try {
        if (HEYS.Widgets.dnd) {
          HEYS.Widgets.dnd._resizeActive = false;
          if (HEYS.Widgets.dnd._resizeTimeout) {
            clearTimeout(HEYS.Widgets.dnd._resizeTimeout);
            HEYS.Widgets.dnd._resizeTimeout = null;
          }
        }
      } catch (err) { /* ignore */ }
      ref.startedAt = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º timestamp –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ resize

      // –ö–æ–º–º–∏—Ç–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω –¥—Ä—É–≥–æ–π —Ä–∞–∑–º–µ—Ä
      const finalSizeId = ref.last?.sizeId || resizePreview?.sizeId || null;
      const finalPos = ref.last?.position || resizePreview?.position || widget.position || null;
      const baseSizeId = ref.baseSizeId;
      const basePos = ref.basePos || widget.position || { col: 0, row: 0 };
      setResizePreview(null);

      // Cleanup raf
      if (ref.raf) {
        cancelAnimationFrame(ref.raf);
        ref.raf = 0;
      }

      // Cleanup snap timer/state
      if (snapTimerRef.current) {
        clearTimeout(snapTimerRef.current);
        snapTimerRef.current = 0;
      }
      setIsResizeSnap(false);

      ref.pending = null;
      ref.last = null;

      const posChanged = !!finalPos && (finalPos.col !== basePos.col || finalPos.row !== basePos.row);

      if (HEYS.debug) {
        console.log(`[endResizeDrag] finalSizeId=${finalSizeId}, baseSizeId=${baseSizeId}, posChanged=${posChanged}, finalPos=`, finalPos);
      }

      if (finalSizeId && (finalSizeId !== baseSizeId || posChanged)) {
        if (HEYS.debug) {
          console.log(`[endResizeDrag] Calling resizeWidgetAt(${widget.id}, ${finalSizeId}, ...)`, finalPos);
        }
        const st = HEYS.Widgets.state;
        if (typeof st?.resizeWidgetAt === 'function') {
          st.resizeWidgetAt(widget.id, finalSizeId, finalPos);
        } else {
          // Fallback (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π): –º–æ–∂–µ—Ç –¥–∞—Ç—å 2 –¥–µ–π—Å—Ç–≤–∏—è –≤ history
          if (posChanged) st?.moveWidget?.(widget.id, finalPos);
          if (finalSizeId !== baseSizeId) st?.resizeWidget?.(widget.id, finalSizeId);
        }
      }
    }, [resizePreview, widget.id, widget.position]);

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ö–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–∑ event (pointer/touch/mouse)
    const getEventCoords = useCallback((e) => {
      // TouchEvent
      if (e.touches && e.touches.length > 0) {
        return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
      }
      // PointerEvent / MouseEvent
      return { clientX: e.clientX || 0, clientY: e.clientY || 0 };
    }, []);

    // –°—Ç–∞—Ä—Ç—É–µ—Ç resize drag (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ onPointerDown –∏–ª–∏ onTouchStart)
    const startResizeDrag = useCallback((direction, e, isTouchEvent = false) => {
      if (!isEditMode) return;

      const ref = resizeDragRef.current;
      const now = Date.now();

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ (pointerdown + touchstart –Ω–∞ –æ–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ)
      if (ref?.startedAt && now - ref.startedAt < 100) return;

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ resize –ø–æ–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–∫—Ç–∏–≤–µ–Ω
      if (ref?.active) return;

      e.stopPropagation();
      if (!isTouchEvent) e.preventDefault();

      // –ö–†–ò–¢–ò–ß–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ref.active –°–†–ê–ó–£ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–æ–∫
      ref.active = true;
      ref.startedAt = now;

      // CRITICAL: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ —á—Ç–æ–±—ã DnD –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª —Å–æ–±—ã—Ç–∏—è
      try {
        if (HEYS.Widgets.dnd) {
          HEYS.Widgets.dnd._resizeActive = true;

          // Safety timeout: —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ resize –∑–∞–≤–∏—Å
          if (HEYS.Widgets.dnd._resizeTimeout) {
            clearTimeout(HEYS.Widgets.dnd._resizeTimeout);
          }
          HEYS.Widgets.dnd._resizeTimeout = setTimeout(() => {
            if (HEYS.Widgets.dnd?._resizeActive) {
              console.log('[Widgets UI] Safety timeout: resetting _resizeActive');
              HEYS.Widgets.dnd._resizeActive = false;
            }
          }, 5000);
        }
        // –û—Ç–º–µ–Ω—è–µ–º DnD –µ—Å–ª–∏ –æ–Ω —É–∂–µ –Ω–∞—á–∞–ª—Å—è
        if (HEYS.Widgets.dnd?.isDragging?.()) {
          HEYS.Widgets.dnd?.cancel?.();
        }
      } catch (err) {
        // ignore
      }

      const gridCols = getGridCols();
      const metrics = HEYS.Widgets.gridEngine?.getCellMetrics?.() || { cellWidth: 150, cellHeight: 76, gap: 12 };
      const unitX = (metrics.cellWidth || 150) + (metrics.gap || 12);
      const unitY = (metrics.cellHeight || 76) + (metrics.gap || 12);

      const { clientX, clientY } = getEventCoords(e);

      // CRITICAL: –ü–æ–ª—É—á–∞–µ–º cols/rows –∏–∑ registry –ø–æ —Ç–µ–∫—É—â–µ–º—É sizeId,
      // —Ç.–∫. widget.cols/rows –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ (–Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ resize)
      const currentSizeId = widget.size || '2x2';
      const sizeInfo = HEYS.Widgets.registry?.getSize?.(currentSizeId);
      const currentCols = sizeInfo?.cols || widget.cols || 1;
      const currentRows = sizeInfo?.rows || widget.rows || 1;

      // ref.active –∏ ref.startedAt —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—ã—à–µ
      ref.pointerId = isTouchEvent ? 'touch' : (e.pointerId ?? null);
      ref.isTouchBased = isTouchEvent;
      ref.direction = direction;
      ref.startX = clientX;
      ref.startY = clientY;
      ref.baseCols = currentCols;
      ref.baseRows = currentRows;
      ref.baseSizeId = widget.size || '2x2';
      ref.basePos = {
        col: Number.isFinite(widget?.position?.col) ? widget.position.col : 0,
        row: Number.isFinite(widget?.position?.row) ? widget.position.row : 0
      };
      ref.fixedRight = ref.basePos.col + ref.baseCols;
      ref.fixedBottom = ref.basePos.row + ref.baseRows;
      ref.lastDeltaCols = 0;
      ref.lastDeltaRows = 0;

      // Pointer capture —Ç–æ–ª—å–∫–æ –¥–ª—è pointer events (–Ω–µ touch)
      if (!isTouchEvent && e.pointerId != null) {
        try {
          e.currentTarget?.setPointerCapture?.(e.pointerId);
        } catch (err) {
          // ignore
        }
      }

      // CRITICAL FIX: –î–ª—è touch events –¥–æ–±–∞–≤–ª—è–µ–º document listeners –°–†–ê–ó–£ —Å capture: true
      // (–Ω–µ –∂–¥—ë–º useEffect ‚Äî React —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π, touch —É–∂–µ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è)
      if (isTouchEvent) {
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ listeners –µ—Å–ª–∏ –µ—Å—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏)
        if (ref.touchMoveHandler) {
          document.removeEventListener('touchmove', ref.touchMoveHandler, { capture: true });
          document.removeEventListener('touchend', ref.touchEndHandler, { capture: true });
          document.removeEventListener('touchcancel', ref.touchEndHandler, { capture: true });
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º handlers –≤ ref –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ cleanup
        ref.touchMoveHandler = (te) => {
          if (!ref.active) return;
          te.preventDefault();
          te.stopPropagation(); // –ù–µ –¥–∞—ë–º –¥—Ä—É–≥–∏–º handlers –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å

          const touch = te.touches[0];
          if (!touch) return;

          const dx = touch.clientX - ref.startX;
          const dy = touch.clientY - ref.startY;

          const rawDeltaCols = Math.round(dx / unitX);
          const rawDeltaRows = Math.round(dy / unitY);

          const dir = String(ref.direction || '');
          const isW = dir.includes('w');
          const isE = dir.includes('e');
          const isN = dir.includes('n');
          const isS = dir.includes('s');
          const intentDeltaCols = isW ? -rawDeltaCols : (isE ? rawDeltaCols : 0);
          const intentDeltaRows = isN ? -rawDeltaRows : (isS ? rawDeltaRows : 0);

          if (intentDeltaCols === ref.lastDeltaCols && intentDeltaRows === ref.lastDeltaRows) return;
          ref.lastDeltaCols = intentDeltaCols;
          ref.lastDeltaRows = intentDeltaRows;

          const targetCols = Math.max(1, Math.min(ref.baseCols + intentDeltaCols, gridCols));
          const targetRows = Math.max(1, ref.baseRows + intentDeltaRows);

          const nearest = pickNearestSize(targetCols, targetRows, intentDeltaCols, intentDeltaRows);
          const cols = Math.max(1, Math.min(nearest.cols, gridCols));
          const rows = Math.max(1, nearest.rows);

          let col = ref.basePos.col;
          let row = ref.basePos.row;
          if (isW) col = ref.fixedRight - cols;
          if (isN) row = ref.fixedBottom - rows;
          col = Math.max(0, col);
          if (col + cols > gridCols) col = Math.max(0, gridCols - cols);
          row = Math.max(0, row);

          updateResizePreview({
            active: true,
            direction: ref.direction,
            sizeId: nearest.sizeId,
            cols,
            rows,
            position: { col, row },
            unitX,
            unitY,
            gridCols,
            overflowRight: (col + cols > gridCols)
          });
        };

        ref.touchEndHandler = () => {
          // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º ref.active –∑–¥–µ—Å—å! endResizeDrag —Å–∞–º —Å–±—Ä–æ—Å–∏—Ç
          // ref.active = false; // –£–ë–†–ê–ù–û - –≤—ã–∑—ã–≤–∞–ª–æ race condition
          ref.startedAt = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º timestamp
          if (ref.touchMoveHandler) {
            // CRITICAL: —É–¥–∞–ª—è–µ–º —Å —Ç–µ–º–∏ –∂–µ options —á—Ç–æ –∏ –¥–æ–±–∞–≤–ª—è–ª–∏ (capture: true)
            document.removeEventListener('touchmove', ref.touchMoveHandler, { capture: true });
            document.removeEventListener('touchend', ref.touchEndHandler, { capture: true });
            document.removeEventListener('touchcancel', ref.touchEndHandler, { capture: true });
            ref.touchMoveHandler = null;
            ref.touchEndHandler = null;
          }
          endResizeDrag('touchend');
        };

        // CRITICAL: capture: true –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –î–û –ª—é–±–æ–π –æ—Ç–º–µ–Ω—ã
        document.addEventListener('touchmove', ref.touchMoveHandler, { passive: false, capture: true });
        document.addEventListener('touchend', ref.touchEndHandler, { passive: true, capture: true });
        document.addEventListener('touchcancel', ref.touchEndHandler, { passive: true, capture: true });
      }

      const initial = pickNearestSize(ref.baseCols, ref.baseRows, 0, 0);
      updateResizePreview({
        active: true,
        direction,
        sizeId: initial.sizeId,
        cols: Math.max(1, Math.min(initial.cols, gridCols)),
        rows: Math.max(1, initial.rows),
        position: { ...ref.basePos },
        unitX,
        unitY,
        gridCols
      });
    }, [endResizeDrag, getEventCoords, getGridCols, isEditMode, pickNearestSize, updateResizePreview, widget.cols, widget.rows, widget.size, widget?.position?.col, widget?.position?.row]);

    // Pointer down handler (–¥–ª—è desktop, –ù–ï –¥–ª—è touch devices)
    const handleResizeHandlePointerDown = useCallback((direction, e) => {
      // CRITICAL: –ù–∞ touch devices –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º pointerdown ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º native touchstart
      // pointerdown –Ω–∞ touch —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ pointerup –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
      if (e.pointerType === 'touch') {
        e.stopPropagation();
        return; // Native touchstart handler –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
      }

      // CRITICAL: stop propagation —á—Ç–æ–±—ã widget card handlePointerDown –ù–ï –≤—ã–∑–≤–∞–ª dnd._prepareForDrag
      e.stopPropagation();
      e.preventDefault();
      startResizeDrag(direction, e, false);
    }, [startResizeDrag]);

    // Touch start handler (–¥–ª—è iOS Safari –∏ PWA) ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ native listener
    const handleResizeHandleTouchStart = useCallback((direction, e) => {
      // preventDefault —á–µ—Ä–µ–∑ native listener —É–∂–µ –≤—ã–∑–≤–∞–Ω
      startResizeDrag(direction, e, true);
    }, [startResizeDrag]);

    // Native touch listeners –¥–ª—è resize handles (—Å { passive: false } —á—Ç–æ–±—ã preventDefault —Ä–∞–±–æ—Ç–∞–ª)
    useEffect(() => {
      if (!isEditMode) return;

      const handles = [
        { ref: handleNRef, dir: 'n' },
        { ref: handleERef, dir: 'e' },
        { ref: handleSRef, dir: 's' },
        { ref: handleWRef, dir: 'w' },
        { ref: handleNWRef, dir: 'nw' },
        { ref: handleNERef, dir: 'ne' },
        { ref: handleSWRef, dir: 'sw' },
        { ref: handleSERef, dir: 'se' }
      ];

      const touchStartHandlers = handles.map(({ ref, dir }) => {
        const handler = (e) => {
          e.preventDefault(); // –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!
          e.stopPropagation();
          handleResizeHandleTouchStart(dir, e);
        };

        if (ref.current) {
          ref.current.addEventListener('touchstart', handler, { passive: false });
        }
        return { ref, handler };
      });

      return () => {
        touchStartHandlers.forEach(({ ref, handler }) => {
          if (ref.current) {
            ref.current.removeEventListener('touchstart', handler);
          }
        });
      };
    }, [isEditMode, handleResizeHandleTouchStart]);

    // –ö–ª—é—á–µ–≤–æ–µ: –∏—Å–ø–æ–ª—å–∑—É–µ–º resizePreview?.active –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è useEffect
    // (ref.active –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç —Ä–µ—Ä–µ–Ω–¥–µ—Ä, –∞ state ‚Äî –¥–∞)
    const isResizeDragActive = resizePreview?.active === true;

    useEffect(() => {
      if (!isResizeDragActive) return;
      const ref = resizeDragRef.current;

      // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è (pointer –∏ touch)
      const onMove = (e) => {
        if (!ref.active) return;

        // CRITICAL: preventDefault —á—Ç–æ–±—ã iOS –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É
        e.preventDefault();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º pointerId —Ç–æ–ª—å–∫–æ –¥–ª—è pointer events
        if (!ref.isTouchBased && ref.pointerId != null && e.pointerId != null && e.pointerId !== ref.pointerId) return;

        const gridCols = getGridCols();
        const metrics = HEYS.Widgets.gridEngine?.getCellMetrics?.() || { cellWidth: 150, cellHeight: 76, gap: 12 };
        const unitX = (metrics.cellWidth || 150) + (metrics.gap || 12);
        const unitY = (metrics.cellHeight || 76) + (metrics.gap || 12);

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX || 0;
          clientY = e.clientY || 0;
        }

        const dx = clientX - ref.startX;
        const dy = clientY - ref.startY;

        const rawDeltaCols = Math.round(dx / unitX);
        const rawDeltaRows = Math.round(dy / unitY);

        // –î–ª—è –ª–µ–≤–æ–≥–æ/–≤–µ—Ä—Ö–Ω–µ–≥–æ —Ö–µ–Ω–¥–ª–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
        // - drag left/up = —É–≤–µ–ª–∏—á–µ–Ω–∏–µ, drag right/down = —É–º–µ–Ω—å—à–µ–Ω–∏–µ
        const dir = String(ref.direction || '');
        const isW = dir.includes('w');
        const isE = dir.includes('e');
        const isN = dir.includes('n');
        const isS = dir.includes('s');
        const intentDeltaCols = isW ? -rawDeltaCols : (isE ? rawDeltaCols : 0);
        const intentDeltaRows = isN ? -rawDeltaRows : (isS ? rawDeltaRows : 0);

        // micro-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Å–Ω–∞–ø-–¥–µ–ª—Ç—ã
        if (intentDeltaCols === ref.lastDeltaCols && intentDeltaRows === ref.lastDeltaRows) return;
        ref.lastDeltaCols = intentDeltaCols;
        ref.lastDeltaRows = intentDeltaRows;

        const targetCols = Math.max(1, Math.min(ref.baseCols + intentDeltaCols, gridCols));
        const targetRows = Math.max(1, ref.baseRows + intentDeltaRows);

        const nearest = pickNearestSize(targetCols, targetRows, intentDeltaCols, intentDeltaRows);
        const cols = Math.max(1, Math.min(nearest.cols, gridCols));
        const rows = Math.max(1, nearest.rows);

        // –ü–æ–∑–∏—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—è–∫–æ—Ä–∏–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é –≥—Ä–∞–Ω—å)
        let col = ref.basePos.col;
        let row = ref.basePos.row;

        if (isW) {
          col = ref.fixedRight - cols;
        }
        if (isN) {
          row = ref.fixedBottom - rows;
        }

        // clamp –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –≥—Ä–∏–¥–∞
        col = Math.max(0, col);
        if (col + cols > gridCols) {
          col = Math.max(0, gridCols - cols);
        }
        row = Math.max(0, row);

        updateResizePreview({
          active: true,
          direction: ref.direction,
          sizeId: nearest.sizeId,
          cols,
          rows,
          position: { col, row },
          unitX,
          unitY,
          gridCols,
          overflowRight: (col + cols > gridCols)
        });
      };

      const onUp = () => endResizeDrag('up');
      const onCancel = () => endResizeDrag('cancel');

      // Pointer events
      window.addEventListener('pointermove', onMove, { passive: false });
      window.addEventListener('pointerup', onUp, { passive: true });
      window.addEventListener('pointercancel', onCancel, { passive: true });

      // Touch events (fallback –¥–ª—è iOS Safari / PWA)
      window.addEventListener('touchmove', onMove, { passive: false });
      window.addEventListener('touchend', onUp, { passive: true });
      window.addEventListener('touchcancel', onCancel, { passive: true });

      return () => {
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp);
        window.removeEventListener('pointercancel', onCancel);
        window.removeEventListener('touchmove', onMove);
        window.removeEventListener('touchend', onUp);
        window.removeEventListener('touchcancel', onCancel);
      };
    }, [isResizeDragActive, endResizeDrag, getGridCols, pickNearestSize, updateResizePreview, widget?.position?.col]);

    const isResizing = !!resizePreview?.active;
    const previewCols = isResizing ? (resizePreview?.cols || widget.cols) : widget.cols;
    const previewRows = isResizing ? (resizePreview?.rows || widget.rows) : widget.rows;
    const previewSizeId = isResizing ? (resizePreview?.sizeId || widget.size) : widget.size;
    const previewPosition = isResizing ? (resizePreview?.position || widget.position) : widget.position;
    const effectiveWidget = useMemo(() => {
      if (!isResizing) return widget;
      return {
        ...widget,
        size: previewSizeId,
        cols: previewCols,
        rows: previewRows,
        position: previewPosition
      };
    }, [isResizing, previewCols, previewRows, previewPosition, previewSizeId, widget]);

    const sizeClass = `widget--${effectiveWidget.size}`;
    const typeClass = `widget--${effectiveWidget.type}`;
    const isMini = effectiveWidget?.size === '1x1';
    const previewLabel = useMemo(() => {
      const s = HEYS.Widgets.registry?.getSize?.(previewSizeId);
      return s?.label || previewSizeId;
    }, [previewSizeId]);

    // –í–∞–∂–Ω–æ: Core —Ö—Ä–∞–Ω–∏—Ç –ø–æ–∑–∏—Ü–∏—é –≤ grid-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (col/row),
    // –∞ CSS Grid –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ DOM-–ø–æ—Ä—è–¥–∫—É.
    // –ü–æ—ç—Ç–æ–º—É –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ reorder –Ω—É–∂–Ω–æ —è–≤–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å start –ª–∏–Ω–∏–∏.
    const gridCol = effectiveWidget?.position?.col;
    const gridRow = effectiveWidget?.position?.row;
    const hasGridPos = Number.isFinite(gridCol) && Number.isFinite(gridRow);

    return React.createElement('div', {
      ref: elementRef,
      className: `widget ${sizeClass} ${typeClass} ${isEditMode ? 'widget--editing' : ''} ${isResizing ? 'widget--resizing' : ''} ${isResizing && isResizeSnap ? 'widget--resize-snap' : ''}`,
      'data-widget-id': widget.id,
      'data-widget-type': widget.type,
      style: {
        // 1-based –ª–∏–Ω–∏–∏ –≤ CSS Grid
        gridColumn: hasGridPos ? `${gridCol + 1} / span ${previewCols}` : `span ${previewCols}`,
        gridRow: hasGridPos ? `${gridRow + 1} / span ${previewRows}` : `span ${previewRows}`,
        // –í edit-mode –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, drag —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ pointer-—Ö–µ–Ω–¥–ª–µ—Ä—ã
        touchAction: isResizing ? 'none' : 'pan-y',
        zIndex: isResizing ? 60 : undefined
      },
      onClick: handleClick,
      onPointerDown: handlePointerDown,
      onPointerMove: handlePointerMove,
      onPointerUp: handlePointerUp,
      onPointerCancel: handlePointerUp
    },
      // Widget Header (mini = –±–µ–∑ —Ö–µ–¥–µ—Ä–∞)
      !isMini && React.createElement('div', { className: 'widget__header' },
        React.createElement('span', { className: 'widget__icon' }, widgetType?.icon || 'üìä'),
        React.createElement('span', { className: 'widget__title' }, widgetType?.name || widget.type)
      ),

      // Widget Content (placeholder - –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –≤–∏–¥–∂–µ—Ç–∞–º–∏)
      React.createElement('div', { className: 'widget__content' },
        React.createElement(WidgetContent, { widget: effectiveWidget, widgetType })
      ),

      // Edit mode: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–µ–π–¥–∂ —Ä–∞–∑–º–µ—Ä–∞ (–Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç)
      isEditMode && React.createElement('div', {
        id: index === 0 ? 'tour-widgets-size' : undefined,
        className: `widget__size-badge ${isResizing ? 'widget__size-badge--active' : ''}`,
        title: `–†–∞–∑–º–µ—Ä: ${previewLabel} (${previewCols}√ó${previewRows})${resizePreview?.overflowRight ? ' ‚Äî –º–æ–∂–µ—Ç –Ω–µ –ø–æ–º–µ—Å—Ç–∏—Ç—å—Å—è —Å–ø—Ä–∞–≤–∞' : ''}`,
        onPointerDown: (e) => e.stopPropagation(),
        onPointerUp: (e) => e.stopPropagation(),
        onPointerMove: (e) => e.stopPropagation(),
        onClick: (e) => e.stopPropagation()
      },
        `${previewCols}√ó${previewRows}`,
        !!resizePreview?.overflowRight && React.createElement('span', { className: 'widget__size-badge-warn' }, '‚Üî')
      ),

      // Edit Mode: Delete button
      isEditMode && React.createElement('button', {
        id: index === 0 ? 'tour-widgets-delete' : undefined,
        className: 'widget__delete-btn',
        onPointerDown: (e) => e.stopPropagation(),
        onPointerUp: (e) => e.stopPropagation(),
        onPointerMove: (e) => e.stopPropagation(),
        onClick: handleRemoveClick,
        title: '–£–¥–∞–ª–∏—Ç—å'
      }, '‚úï'),

      // Edit Mode: Settings button (optional)
      isEditMode && widgetType?.settings && React.createElement('button', {
        id: index === 0 ? 'tour-widgets-settings' : undefined,
        className: 'widget__settings-btn',
        onPointerDown: (e) => e.stopPropagation(),
        onPointerUp: (e) => e.stopPropagation(),
        onPointerMove: (e) => e.stopPropagation(),
        onClick: handleSettingsClick,
        title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
      }, '‚öôÔ∏è')

      ,

      // Edit Mode: Resize handle (drag-resize)
      isEditMode && React.createElement(React.Fragment, null,
        React.createElement('button', {
          ref: handleNRef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--n ${isResizing && resizePreview?.direction === 'n' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('n', e),
          // onTouchStart –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ native listener –≤ useEffect
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É: –ø–æ—Ç—è–Ω–∏ (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É: –ø–æ—Ç—è–Ω–∏. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),
        React.createElement('button', {
          ref: handleERef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--e ${isResizing && resizePreview?.direction === 'e' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('e', e),
          // onTouchStart –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ native listener –≤ useEffect
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É: –ø–æ—Ç—è–Ω–∏ (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É: –ø–æ—Ç—è–Ω–∏. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),
        React.createElement('button', {
          ref: handleSRef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--s ${isResizing && resizePreview?.direction === 's' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('s', e),
          // onTouchStart –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ native listener –≤ useEffect
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É: –ø–æ—Ç—è–Ω–∏ (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É: –ø–æ—Ç—è–Ω–∏. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),
        React.createElement('button', {
          ref: handleWRef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--w ${isResizing && resizePreview?.direction === 'w' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('w', e),
          // onTouchStart –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ native listener –≤ useEffect
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É: –ø–æ—Ç—è–Ω–∏ (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É: –ø–æ—Ç—è–Ω–∏. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),

        // –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ (—É–≥–ª–æ–≤—ã–µ) —Ö–µ–Ω–¥–ª—ã
        React.createElement('button', {
          ref: handleNWRef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--nw ${isResizing && resizePreview?.direction === 'nw' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('nw', e),
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),
        React.createElement('button', {
          ref: handleNERef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--ne ${isResizing && resizePreview?.direction === 'ne' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('ne', e),
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),
        React.createElement('button', {
          ref: handleSWRef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--sw ${isResizing && resizePreview?.direction === 'sw' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('sw', e),
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        }),
        React.createElement('button', {
          ref: handleSERef,
          type: 'button',
          className: `widget__resize-handle widget__resize-handle--se ${isResizing && resizePreview?.direction === 'se' ? 'widget__resize-handle--active' : ''}`,
          onPointerDown: (e) => handleResizeHandlePointerDown('se', e),
          onPointerUp: (e) => e.stopPropagation(),
          onPointerMove: (e) => e.stopPropagation(),
          onTouchEnd: (e) => e.stopPropagation(),
          onTouchMove: (e) => e.stopPropagation(),
          title: `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª (—Å–µ–π—á–∞—Å: ${currentSizeLabel})`,
          'aria-label': `–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä: –ø–æ—Ç—è–Ω–∏ –∑–∞ —É–≥–æ–ª. –°–µ–π—á–∞—Å: ${currentSizeLabel}`
        })
      )
    );
  }

  // === Widget Content Component (renders actual widget data) ===
  function WidgetContent({ widget, widgetType }) {
    // State –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–∞
    const [data, setData] = useState(() =>
      HEYS.Widgets.data?.getDataForWidget?.(widget) || {}
    );
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    useEffect(() => {
      // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
      const loadData = () => {
        try {
          const newData = HEYS.Widgets.data?.getDataForWidget?.(widget) || {};
          setData(newData);
          setError(null);
        } catch (e) {
          trackWidgetIssue('widgets_loadData_failed', {
            widgetType: widget?.type,
            widgetId: widget?.id,
            message: e?.message
          });
          setError(e.message);
        }
        setLoading(false);
      };

      loadData();

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      const unsubData = HEYS.Widgets.on?.('data:updated', loadData);

      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è HEYS (meal:added, water:added, etc.)
      const heysEvents = ['day:updated', 'meal:added', 'water:added', 'profile:updated'];
      heysEvents.forEach(evt => {
        if (typeof HEYS.events?.on === 'function') {
          HEYS.events.on(evt, loadData);
        }
      });

      // üÜï –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ –≤–æ–¥—ã
      // –°–ª—É—à–∞–µ–º DOM —Å–æ–±—ã—Ç–∏–µ heysWaterAdded –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (total)
      // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É debounce 500ms –≤ useDayAutosave
      const handleWaterAdded = (e) => {
        if (widget.type !== 'water') return;
        const { total, ml } = e.detail || {};
        if (typeof total === 'number') {
          // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º total
          setData(prev => ({
            ...prev,
            drunk: total,
            pct: prev.target > 0 ? Math.round((total / prev.target) * 100) : 0
          }));
        }
      };
      window.addEventListener('heysWaterAdded', handleWaterAdded);

      return () => {
        unsubData?.();
        heysEvents.forEach(evt => {
          if (typeof HEYS.events?.off === 'function') {
            HEYS.events.off(evt, loadData);
          }
        });
        window.removeEventListener('heysWaterAdded', handleWaterAdded);
      };
    }, [widget.id, widget.type]);

    // Loading state
    if (loading) {
      return React.createElement('div', { className: 'widget__loading' },
        React.createElement('div', { className: 'widget__spinner' })
      );
    }

    // Error state
    if (error) {
      return React.createElement('div', { className: 'widget__error' },
        '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
      );
    }

    // Render based on widget type
    switch (widget.type) {
      case 'status':
        return React.createElement(StatusWidgetContent, { widget, data });
      case 'calories':
        return React.createElement(CaloriesWidgetContent, { widget, data });
      case 'water':
        return React.createElement(WaterWidgetContent, { widget, data });
      case 'sleep':
        return React.createElement(SleepWidgetContent, { widget, data });
      case 'streak':
        return React.createElement(StreakWidgetContent, { widget, data });
      case 'weight':
        return React.createElement(WeightWidgetContent, { widget, data });
      case 'steps':
        return React.createElement(StepsWidgetContent, { widget, data });
      case 'macros':
        return React.createElement(MacrosWidgetContent, { widget, data });
      case 'insulin':
        return React.createElement(InsulinWidgetContent, { widget, data });
      case 'heatmap':
        return React.createElement(HeatmapWidgetContent, { widget, data });
      case 'cycle':
        return React.createElement(CycleWidgetContent, { widget, data });
      case 'crashRisk':
        return React.createElement(CrashRiskWidgetContent, { widget, data });
      default:
        return React.createElement('div', { className: 'widget__placeholder' },
          widgetType?.icon || 'üìä',
          React.createElement('span', null, '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')
        );
    }
  }

  // === Individual Widget Content Components ===

  // === Status Widget Content (–°—Ç–∞—Ç—É—Å 0-100) ===
  function StatusWidgetContent({ widget, data }) {
    const d = getWidgetDims(widget);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.Status.StatusWidget –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    if (HEYS.Status?.StatusWidget) {
      // –ü–µ—Ä–µ–¥–∞—ë–º status –∏–∑ data –∏–ª–∏ –≤—ã—á–∏—Å–ª—è–µ–º
      const status = data.status || HEYS.Status?.calculateStatus?.({
        dayData: data.dayData || {},
        profile: data.profile || {},
        dayTot: data.dayTot || {},
        normAbs: data.normAbs || {},
        waterGoal: data.waterGoal || 2000
      });

      if (status) {
        return React.createElement(HEYS.Status.StatusWidget, {
          status,
          size: d.isMicro ? 'micro' : d.isTiny ? 'tiny' : 'standard',
          showActions: widget.settings?.showActions !== false,
          showIssues: widget.settings?.showIssues !== false
        });
      }
    }

    // Fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    const score = data.status?.score ?? data.score ?? 0;
    const level = data.status?.level ?? 'okay';

    const getColor = () => {
      if (score >= 85) return '#10b981'; // excellent
      if (score >= 70) return '#22c55e'; // good
      if (score >= 50) return '#eab308'; // okay
      if (score >= 30) return '#f97316'; // low
      return '#ef4444'; // critical
    };

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-status widget-status--micro' },
        React.createElement('div', { className: 'widget-status__score', style: { color: getColor() } }, Math.round(score))
      );
    }

    // Standard
    return React.createElement('div', { className: 'widget-status widget-status--standard' },
      React.createElement('div', { className: 'widget-status__score-big', style: { color: getColor() } }, Math.round(score)),
      React.createElement('div', { className: 'widget-status__label' }, '–∏–∑ 100')
    );
  }

  function CaloriesWidgetContent({ widget, data }) {
    const eaten = data.eaten || 0;
    const target = data.target || 2000;
    const pct = target > 0 ? Math.round((eaten / target) * 100) : 0;
    const remaining = Math.max(0, target - eaten);
    const burned = data.burned || 0; // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    const deficit = data.deficit || 0; // –î–µ—Ñ–∏—Ü–∏—Ç

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : d.isTall ? 'tall' : 'std';

    const getColor = () => {
      if (pct < 50) return 'var(--ratio-crash)';
      if (pct < 75) return 'var(--ratio-low)';
      if (pct < 110) return 'var(--ratio-good)';
      return 'var(--ratio-over)';
    };

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-calories widget-calories--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, '–∫–∫–∞–ª'),
        React.createElement('div', { className: 'widget-calories__value', style: { color: getColor() } }, eaten)
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout
    if (size === '2x2') {
      return React.createElement('div', { className: 'widget-calories widget-calories--2x2' },
        // –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ + –ø—Ä–æ—Ü–µ–Ω—Ç
        React.createElement('div', { className: 'widget-calories__header' },
          React.createElement('div', { className: 'widget-calories__value widget-calories__value--lg', style: { color: getColor() } },
            eaten.toLocaleString('ru-RU')
          ),
          React.createElement('div', { className: 'widget-calories__pct-badge', style: { background: `${getColor()}20`, color: getColor() } },
            `${pct}%`
          )
        ),
        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        React.createElement('div', { className: 'widget-calories__progress' },
          React.createElement('div', {
            className: 'widget-calories__bar',
            style: { width: `${Math.min(100, pct)}%`, background: getColor() }
          })
        ),
        // –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞: —Ü–µ–ª—å –∏ –æ—Å—Ç–∞–ª–æ—Å—å
        React.createElement('div', { className: 'widget-calories__footer' },
          React.createElement('div', { className: 'widget-calories__meta' },
            React.createElement('span', { className: 'widget-calories__meta-label' }, '–¶–µ–ª—å'),
            React.createElement('span', { className: 'widget-calories__meta-val' }, target.toLocaleString('ru-RU'))
          ),
          remaining > 0 && React.createElement('div', { className: 'widget-calories__meta widget-calories__meta--accent' },
            React.createElement('span', { className: 'widget-calories__meta-label' }, '–û—Å—Ç–∞–ª–æ—Å—å'),
            React.createElement('span', { className: 'widget-calories__meta-val' }, remaining.toLocaleString('ru-RU'))
          )
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π layout
    const showPct = widget.settings?.showPercentage !== false;
    const showRemaining = widget.settings?.showRemaining !== false;
    const showLabel = true;
    const showProgress = !d.isTiny;
    const showRemainingLine = showRemaining && remaining > 0 && d.rows >= 2 && !d.isShort;

    return React.createElement('div', { className: `widget-calories widget-calories--${variant}` },
      React.createElement('div', { className: 'widget-calories__top' },
        React.createElement('div', { className: 'widget-calories__value', style: { color: getColor() } },
          eaten.toLocaleString('ru-RU')
        ),
        showPct ? React.createElement('div', { className: 'widget-calories__pct' }, `${pct}%`) : null
      ),
      showLabel
        ? React.createElement('div', { className: 'widget-calories__label' }, `–∏–∑ ${target.toLocaleString('ru-RU')} –∫–∫–∞–ª`)
        : null,
      showProgress
        ? React.createElement('div', { className: 'widget-calories__progress' },
          React.createElement('div', {
            className: 'widget-calories__bar',
            style: { width: `${Math.min(100, Math.max(0, pct))}%` }
          })
        )
        : null,
      showRemainingLine
        ? React.createElement('div', { className: 'widget-calories__remaining' }, `–û—Å—Ç–∞–ª–æ—Å—å: ${remaining.toLocaleString('ru-RU')}`)
        : null
    );
  }

  function WaterWidgetContent({ widget, data }) {
    const drunk = data.drunk || 0;
    const target = data.target || 2000;
    const pct = target > 0 ? Math.round((drunk / target) * 100) : 0;
    const glasses = Math.floor(drunk / 250);
    const remaining = Math.max(0, target - drunk);

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : 'std';

    const getWaterColor = () => {
      if (pct >= 100) return '#22c55e';
      if (pct >= 70) return '#3b82f6';
      if (pct >= 40) return '#eab308';
      return '#ef4444';
    };

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-water widget-water--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'üíß'),
        React.createElement('div', { className: 'widget-water__value' },
          widget.settings?.showGlasses ? `${glasses}ü•õ` : `${drunk}`
        )
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout
    if (size === '2x2') {
      const waterColor = getWaterColor();
      return React.createElement('div', { className: 'widget-water widget-water--2x2' },
        // –í–µ—Ä—Ö: –∏–∫–æ–Ω–∫–∞ + –∑–Ω–∞—á–µ–Ω–∏–µ + –ø—Ä–æ—Ü–µ–Ω—Ç
        React.createElement('div', { className: 'widget-water__header' },
          React.createElement('div', { className: 'widget-water__icon' }, 'üíß'),
          React.createElement('div', { className: 'widget-water__main' },
            React.createElement('div', { className: 'widget-water__value widget-water__value--lg' },
              `${drunk}`,
              React.createElement('span', { className: 'widget-water__unit' }, '–º–ª')
            )
          ),
          React.createElement('div', { className: 'widget-water__pct-badge', style: { background: `${waterColor}20`, color: waterColor } },
            `${pct}%`
          )
        ),
        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        React.createElement('div', { className: 'widget-water__progress' },
          React.createElement('div', {
            className: 'widget-water__bar',
            style: { width: `${Math.min(100, pct)}%`, background: waterColor }
          })
        ),
        // –ù–∏–∑: —Ü–µ–ª—å + —Å—Ç–∞–∫–∞–Ω—ã + –æ—Å—Ç–∞–ª–æ—Å—å
        React.createElement('div', { className: 'widget-water__footer' },
          React.createElement('div', { className: 'widget-water__meta' },
            React.createElement('span', { className: 'widget-water__glasses' }, `${glasses} ü•õ`)
          ),
          remaining > 0 && React.createElement('div', { className: 'widget-water__meta widget-water__meta--muted' },
            `–µ—â—ë ${remaining} –º–ª`
          )
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π layout
    const showProgress = true;
    const showPctPill = !d.isTiny;

    return React.createElement('div', { className: `widget-water widget-water--${variant}` },
      React.createElement('div', { className: 'widget-water__top' },
        React.createElement('div', { className: 'widget-water__value' },
          widget.settings?.showGlasses ? `${glasses} ü•õ` : `${drunk} –º–ª`
        )
      ),
      showProgress
        ? React.createElement('div', { className: 'widget-water__progress' },
          React.createElement('div', {
            className: 'widget-water__bar',
            style: { width: `${Math.min(100, pct)}%` }
          })
        )
        : null,
      showPctPill ? React.createElement('div', { className: 'widget-water__label' }, `${pct}%`) : null
    );
  }

  function SleepWidgetContent({ widget, data }) {
    const hours = data.hours || 0;
    const target = data.target || 8;
    const quality = data.quality;
    const sleepStart = data.sleepStart; // "23:30"
    const sleepEnd = data.sleepEnd; // "07:15"

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : 'std';

    const pct = target > 0 ? Math.round((hours / target) * 100) : 0;

    const getSleepColor = () => {
      if (hours >= target) return '#22c55e';
      if (hours >= target - 1) return '#3b82f6';
      if (hours >= target - 2) return '#eab308';
      return '#ef4444';
    };

    const getEmoji = () => {
      if (hours >= target) return 'üòä';
      if (hours >= target - 1) return 'üòê';
      return 'üò¥';
    };

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-sleep widget-sleep--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'üò¥'),
        React.createElement('div', { className: 'widget-sleep__value' }, `${hours.toFixed(1)}—á`)
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout
    if (size === '2x2') {
      const sleepColor = getSleepColor();
      return React.createElement('div', { className: 'widget-sleep widget-sleep--2x2' },
        // –í–µ—Ä—Ö: emoji + —á–∞—Å—ã + –ø—Ä–æ—Ü–µ–Ω—Ç
        React.createElement('div', { className: 'widget-sleep__header' },
          React.createElement('div', { className: 'widget-sleep__icon' }, getEmoji()),
          React.createElement('div', { className: 'widget-sleep__main' },
            React.createElement('div', { className: 'widget-sleep__value widget-sleep__value--lg' },
              hours.toFixed(1),
              React.createElement('span', { className: 'widget-sleep__unit' }, '—á')
            )
          ),
          React.createElement('div', { className: 'widget-sleep__pct-badge', style: { background: `${sleepColor}20`, color: sleepColor } },
            `${pct}%`
          )
        ),
        // –í—Ä–µ–º—è: –∑–∞—Å–Ω—É–ª ‚Üí –ø—Ä–æ—Å–Ω—É–ª—Å—è
        (sleepStart || sleepEnd) && React.createElement('div', { className: 'widget-sleep__times' },
          sleepStart && React.createElement('span', { className: 'widget-sleep__time' }, `üåô ${sleepStart}`),
          sleepEnd && React.createElement('span', { className: 'widget-sleep__time' }, `‚òÄÔ∏è ${sleepEnd}`)
        ),
        // –ù–∏–∑: –∫–∞—á–µ—Å—Ç–≤–æ + —Ü–µ–ª—å
        React.createElement('div', { className: 'widget-sleep__footer' },
          quality && React.createElement('div', { className: 'widget-sleep__quality-badge' },
            `‚≠ê ${quality}/10`
          ),
          React.createElement('div', { className: 'widget-sleep__target' },
            `–¶–µ–ª—å: ${target}—á`
          )
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const showTarget = widget.settings?.showTarget !== false;
    const showQuality = widget.settings?.showQuality !== false && !!quality && !d.isTiny;

    return React.createElement('div', { className: `widget-sleep widget-sleep--${variant}` },
      React.createElement('div', { className: 'widget-sleep__value' }, `${hours.toFixed(1)}—á ${getEmoji()}`),
      showTarget ? React.createElement('div', { className: 'widget-sleep__label' }, `–∏–∑ ${target}—á`) : null,
      showQuality ? React.createElement('div', { className: 'widget-sleep__quality' }, `–ö–∞—á–µ—Å—Ç–≤–æ: ${quality}/10`) : null
    );
  }

  function StreakWidgetContent({ widget, data }) {
    const current = data.current || 0;
    const max = data.max || 0;
    const weekDays = data.weekDays || []; // [true, true, false, true, true, true, true] ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : 'std';

    const getStreakColor = () => {
      if (current >= 7) return '#22c55e';
      if (current >= 3) return '#f97316';
      return '#ef4444';
    };

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-streak widget-streak--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'üî•'),
        React.createElement('div', { className: 'widget-streak__value' }, current)
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout —Å –º–∏–Ω–∏-heatmap –Ω–µ–¥–µ–ª–∏
    if (size === '2x2') {
      const streakColor = getStreakColor();
      const isNewRecord = current > 0 && current >= max;

      return React.createElement('div', { className: 'widget-streak widget-streak--2x2' },
        // –í–µ—Ä—Ö: –æ–≥–æ–Ω—å + —á–∏—Å–ª–æ + –¥–Ω–∏
        React.createElement('div', { className: 'widget-streak__header' },
          React.createElement('div', { className: 'widget-streak__icon' }, 'üî•'),
          React.createElement('div', { className: 'widget-streak__value widget-streak__value--lg', style: { color: streakColor } },
            current
          ),
          React.createElement('div', { className: 'widget-streak__label' }, '–¥–Ω –ø–æ–¥—Ä—è–¥')
        ),
        // –ú–∏–Ω–∏-heatmap –Ω–µ–¥–µ–ª–∏ (7 —Ç–æ—á–µ–∫)
        weekDays.length > 0 && React.createElement('div', { className: 'widget-streak__week' },
          weekDays.slice(-7).map((ok, i) =>
            React.createElement('div', {
              key: i,
              className: `widget-streak__dot widget-streak__dot--${ok ? 'ok' : 'miss'}`
            })
          )
        ),
        // –ù–∏–∑: —Ä–µ–∫–æ—Ä–¥ –∏–ª–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
        React.createElement('div', { className: 'widget-streak__footer' },
          isNewRecord
            ? React.createElement('div', { className: 'widget-streak__record widget-streak__record--new' }, 'üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!')
            : max > 0 && React.createElement('div', { className: 'widget-streak__record' }, `–†–µ–∫–æ—Ä–¥: ${max} –¥–Ω`)
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const showMax = widget.settings?.showMax !== false && max > current && !d.isTiny;
    const showFlame = widget.settings?.showFlame !== false && current > 0;

    return React.createElement('div', { className: `widget-streak widget-streak--${variant}` },
      React.createElement('div', { className: 'widget-streak__value' },
        showFlame ? 'üî• ' : '',
        current,
        React.createElement('span', { className: 'widget-streak__days' }, ' –¥–Ω.')
      ),
      showMax ? React.createElement('div', { className: 'widget-streak__max' }, `–†–µ–∫–æ—Ä–¥: ${max}`) : null
    );
  }

  /**
   * WeightWidgetContent ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤–∏–¥–∂–µ—Ç –≤–µ—Å–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π –±–ª–æ–∫–æ–≤
   * –ë–ª–æ–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
   */
  function WeightWidgetContent({ widget, data }) {
    const current = data.current;
    const goal = data.goal;
    const trend = data.trend;
    const weekChange = data.weekChange;
    const weeksToGoal = data.weeksToGoal;
    const progressPct = data.progressPct;
    const bmi = data.bmi;
    const bmiCategory = data.bmiCategory;
    const sparkline = data.sparkline || [];
    const monthChange = data.monthChange;
    const hasCleanTrend = data.hasCleanTrend;

    const size = widget?.size || '2x2';
    const showGoal = widget.settings?.showGoal !== false;
    const showTrend = widget.settings?.showTrend !== false;

    const hasCurrent = Number.isFinite(current);
    const hasGoal = Number.isFinite(goal) && goal > 0;
    const hasBmi = Number.isFinite(bmi);
    const hasAnalytics = !!monthChange || !!hasCleanTrend;
    const sparklinePoints = sparkline.filter(s => s.weight);
    const hasSparkline = sparklinePoints.length >= 2;

    // –†–∞–∑–º–µ—Ä—ã –±–µ—Ä—ë–º –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞ (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã). –ó–¥–µ—Å—å –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è layout-–≤–µ—Ç–æ–∫,
    // –Ω–æ –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–π: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π size —É–ø–∞–¥—ë—Ç –≤ fallback-—Ä–µ–Ω–¥–µ—Ä –Ω–∏–∂–µ.

    // –¶–≤–µ—Ç–∞ —Ç—Ä–µ–Ω–¥–∞
    const getTrendInfo = () => {
      if (!Number.isFinite(trend)) return null;
      if (trend < -0.02) return { cls: 'down', emoji: '‚Üì', label: '—Å–Ω–∏–∂–∞–µ—Ç—Å—è', color: '#22c55e' };
      if (trend > 0.02) return { cls: 'up', emoji: '‚Üë', label: '—Ä–∞—Å—Ç—ë—Ç', color: '#ef4444' };
      return { cls: 'stable', emoji: '‚Üí', label: '—Å—Ç–∞–±–∏–ª–µ–Ω', color: '#3b82f6' };
    };
    const trendInfo = getTrendInfo();

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ weekChange
    const formatWeekChange = () => {
      if (!Number.isFinite(weekChange)) return null;
      const sign = weekChange >= 0 ? '+' : '';
      return `${sign}${weekChange.toFixed(1)} –∫–≥/–Ω–µ–¥`;
    };

    // ============ –ë–õ–û–ö–ò-–ö–û–ú–ü–û–ù–ï–ù–¢–´ ============

    // –ë–ª–æ–∫: –ì–ª–∞–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–µ—Å–∞
    const WeightValue = ({ scale = 'md' }) => {
      const sizes = { sm: 'widget-weight__val--sm', md: 'widget-weight__val--md', lg: 'widget-weight__val--lg', xl: 'widget-weight__val--xl' };
      if (!hasCurrent) return React.createElement('div', { className: 'widget-weight__empty' }, '‚Äî');
      return React.createElement('div', { className: `widget-weight__val ${sizes[scale] || ''}` },
        current.toFixed(1),
        React.createElement('span', { className: 'widget-weight__val-unit' }, '–∫–≥')
      );
    };

    // –ë–ª–æ–∫: –¢—Ä–µ–Ω–¥ (—Å—Ç—Ä–µ–ª–∫–∞ + —Ç–µ–∫—Å—Ç)
    const TrendBlock = ({ showText = false, vertical = false }) => {
      if (!showTrend || !trendInfo) return null;
      const weekText = formatWeekChange();
      return React.createElement('div', {
        className: `widget-weight__trend ${vertical ? 'widget-weight__trend--vert' : ''}`,
        style: { color: trendInfo.color }
      },
        React.createElement('span', { className: 'widget-weight__trend-arrow' }, trendInfo.emoji),
        showText && weekText && React.createElement('span', { className: 'widget-weight__trend-label' }, weekText)
      );
    };

    // –ë–ª–æ–∫: –ì—Ä–∞—Ñ–∏–∫
    const ChartBlock = ({ days = 7, height = 60, showDots = true, showLabels = false, showGoalLine = false }) => {
      if (!hasSparkline) return null;
      const pts = sparklinePoints.slice(-days);
      return React.createElement(WeightMiniSparkline, {
        points: pts,
        width: '100%',
        height: height,
        trendColor: trendInfo?.color || '#3b82f6',
        showDots,
        showLabels,
        showGoalLine: showGoalLine && hasGoal,
        goalWeight: goal
      });
    };

    // –ë–ª–æ–∫: –¶–µ–ª—å
    const GoalBlock = ({ inline = false }) => {
      if (!showGoal || !hasGoal) return null;
      if (inline) {
        return React.createElement('div', { className: 'widget-weight__goal-line' },
          React.createElement('span', { className: 'widget-weight__goal-label' }, '–¶–µ–ª—å'),
          React.createElement('span', { className: 'widget-weight__goal-inline-val' }, `${goal} –∫–≥`),
          weeksToGoal && React.createElement('span', { className: 'widget-weight__goal-eta' }, `~${weeksToGoal} –Ω–µ–¥`)
        );
      }
      return React.createElement('div', { className: 'widget-weight__goal-block' },
        React.createElement('div', { className: 'widget-weight__goal-val' }, `${goal} –∫–≥`),
        weeksToGoal && React.createElement('div', { className: 'widget-weight__goal-eta' }, `~${weeksToGoal} –Ω–µ–¥`)
      );
    };

    // –ë–ª–æ–∫: –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫ —Ü–µ–ª–∏
    const ProgressBlock = ({ vertical = false }) => {
      if (!showGoal || !hasGoal || progressPct === null) return null;
      const pct = Math.min(100, Math.max(0, progressPct));
      if (vertical) {
        return React.createElement('div', { className: 'widget-weight__progress-v' },
          React.createElement('div', { className: 'widget-weight__progress-track-v' },
            React.createElement('div', {
              className: 'widget-weight__progress-fill-v',
              style: { height: `${pct}%` }
            })
          ),
          React.createElement('div', { className: 'widget-weight__progress-goal' }, `${goal} –∫–≥`)
        );
      }
      return React.createElement('div', { className: 'widget-weight__progress-h' },
        React.createElement('div', { className: 'widget-weight__progress-track-h' },
          React.createElement('div', {
            className: 'widget-weight__progress-fill-h',
            style: { width: `${pct}%` }
          })
        ),
        React.createElement('div', { className: 'widget-weight__progress-info' },
          React.createElement('span', { className: 'widget-weight__progress-pct' }, `${pct.toFixed(0)}%`),
          React.createElement('span', { className: 'widget-weight__progress-label' }, `‚Üí ${goal} –∫–≥`)
        )
      );
    };

    // –ë–ª–æ–∫: BMI
    const BMIBlock = ({ compact = false }) => {
      if (!bmi) return null;
      if (compact) {
        return React.createElement('div', {
          className: 'widget-weight__bmi-badge',
          style: { background: bmiCategory?.color ? `${bmiCategory.color}20` : undefined, color: bmiCategory?.color }
        }, `BMI ${bmi.toFixed(1)}`);
      }
      return React.createElement('div', { className: 'widget-weight__bmi-block' },
        React.createElement('div', { className: 'widget-weight__bmi-num' }, bmi.toFixed(1)),
        React.createElement('div', {
          className: 'widget-weight__bmi-cat',
          style: { color: bmiCategory?.color }
        }, bmiCategory?.label || 'BMI')
      );
    };

    // –ë–ª–æ–∫: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü, —á–∏—Å—Ç—ã–π —Ç—Ä–µ–Ω–¥)
    const AnalyticsBlock = () => {
      const items = [];
      if (monthChange) {
        items.push({ icon: 'üìä', text: `–ü—Ä–æ–≥–Ω–æ–∑: ${monthChange > 0 ? '+' : ''}${monthChange.toFixed(1)} –∫–≥/–º–µ—Å` });
      }
      if (hasCleanTrend) {
        items.push({ icon: 'üå∏', text: '–ß–∏—Å—Ç—ã–π —Ç—Ä–µ–Ω–¥', cls: 'widget-weight__stat--pink' });
      }
      if (items.length === 0) return null;
      return React.createElement('div', { className: 'widget-weight__stats' },
        items.map((item, i) => React.createElement('div', {
          key: i,
          className: `widget-weight__stat ${item.cls || ''}`
        },
          React.createElement('span', { className: 'widget-weight__stat-icon' }, item.icon),
          React.createElement('span', null, item.text)
        ))
      );
    };

    // ============ LAYOUTS –ü–û –†–ê–ó–ú–ï–†–ê–ú ============

    // MINI (1√ó1) ‚Äî –º–µ—Ç–∫–∞ + —á–∏—Å–ª–æ (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è safe-area)
    if (size === '1x1') {
      return React.createElement('div', { className: 'widget-weight widget-weight--1x1' },
        React.createElement('div', { className: 'widget-micro__label' }, '–≤–µ—Å'),
        React.createElement(WeightValue, { scale: 'sm' })
      );
    }

    // SHORT (2√ó1) ‚Äî –Ω–∏–∑–∫–∏–π: —á–∏—Å–ª–æ —Å–ª–µ–≤–∞ + —Å—Ç—Ä–µ–ª–∫–∞/–ø–ª–∞—à–∫–∏ —Å–ø—Ä–∞–≤–∞
    if (size === '2x1') {
      return React.createElement('div', { className: 'widget-weight widget-weight--2x1' },
        React.createElement('div', { className: 'widget-weight__row-h' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'lg' }),
            showGoal && hasGoal ? React.createElement(GoalBlock, { inline: true }) : null
          ),
          React.createElement('div', { className: 'widget-weight__right' },
            React.createElement(TrendBlock, { showText: false }),
            React.createElement(BMIBlock, { compact: true })
          )
        )
      );
    }

    // WIDE SHORT (3√ó1) ‚Äî —à–∏—Ä–æ–∫–∏–π –Ω–∏–∑–∫–∏–π: —á–∏—Å–ª–æ + —Ç—Ä–µ–Ω–¥ + —Ü–µ–ª—å/BMI –≤ —Ä—è–¥
    if (size === '3x1') {
      return React.createElement('div', { className: 'widget-weight widget-weight--3x1' },
        React.createElement('div', { className: 'widget-weight__row-h' },
          React.createElement(WeightValue, { scale: 'lg' }),
          React.createElement(TrendBlock, { showText: true }),
          showGoal && hasGoal
            ? React.createElement(GoalBlock, { inline: true })
            : React.createElement(BMIBlock, { compact: true })
        )
      );
    }

    // EXTRA WIDE SHORT (4√ó1) ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–∏—Ä–æ–∫–∏–π –Ω–∏–∑–∫–∏–π: —á–∏—Å–ª–æ + —Ç—Ä–µ–Ω–¥ + —Ü–µ–ª—å + BMI
    if (size === '4x1') {
      return React.createElement('div', { className: 'widget-weight widget-weight--4x1' },
        React.createElement('div', { className: 'widget-weight__row-h' },
          React.createElement(WeightValue, { scale: 'lg' }),
          React.createElement(TrendBlock, { showText: true }),
          showGoal && hasGoal ? React.createElement(GoalBlock, { inline: true }) : null,
          React.createElement(BMIBlock, { compact: true })
        )
      );
    }

    // TALL2 (1√ó2) ‚Äî —É–∑–∫–∏–π: —á–∏—Å–ª–æ | —Ç—Ä–µ–Ω–¥ | –ø—Ä–æ–≥—Ä–µ—Å—Å/—Ü–µ–ª—å
    if (size === '1x2') {
      const showProgress = showGoal && hasGoal && progressPct !== null;
      return React.createElement('div', { className: 'widget-weight widget-weight--1x2' },
        React.createElement(WeightValue, { scale: 'lg' }),
        React.createElement(TrendBlock, { showText: false, vertical: true }),
        showProgress ? React.createElement(ProgressBlock, { vertical: true }) : React.createElement(GoalBlock, { inline: false }),
        React.createElement(BMIBlock, { compact: true })
      );
    }

    // TALL3 (1√ó3) ‚Äî —É–∑–∫–∏–π –≤—ã—Å–æ–∫–∏–π: —á–∏—Å–ª–æ | —Ç—Ä–µ–Ω–¥ | –ø—Ä–æ–≥—Ä–µ—Å—Å | BMI –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
    if (size === '1x3') {
      const showProgress = showGoal && hasGoal && progressPct !== null;
      return React.createElement('div', { className: 'widget-weight widget-weight--1x3' },
        React.createElement(WeightValue, { scale: 'lg' }),
        React.createElement(TrendBlock, { showText: false, vertical: true }),
        showProgress ? React.createElement(ProgressBlock, { vertical: true }) : React.createElement(GoalBlock, { inline: false }),
        React.createElement(BMIBlock, { compact: true }),
        React.createElement(AnalyticsBlock, null)
      );
    }

    // TALL4 (1√ó4) ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π —É–∑–∫–∏–π: –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞
    if (size === '1x4') {
      const showProgress = showGoal && hasGoal && progressPct !== null;
      return React.createElement('div', { className: 'widget-weight widget-weight--1x4' },
        React.createElement(WeightValue, { scale: 'xl' }),
        React.createElement(TrendBlock, { showText: true, vertical: true }),
        showProgress ? React.createElement(ProgressBlock, { vertical: true }) : null,
        React.createElement(GoalBlock, { inline: false }),
        React.createElement(BMIBlock, { compact: true }),
        React.createElement(AnalyticsBlock, null)
      );
    }

    // COMPACT (2√ó2) ‚Äî —á–∏—Å–ª–æ + —Ç—Ä–µ–Ω–¥ + (–≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ —Ü–µ–ª—å/BMI)
    if (size === '2x2') {
      return React.createElement('div', { className: 'widget-weight widget-weight--2x2' },
        React.createElement(WeightValue, { scale: 'lg' }),
        React.createElement(TrendBlock, { showText: true }),
        hasSparkline
          ? React.createElement('div', { className: 'widget-weight__chart-compact' },
            React.createElement(ChartBlock, { days: 7, height: 46, showDots: false })
          )
          : (showGoal && hasGoal
            ? React.createElement(GoalBlock, { inline: true })
            : React.createElement(BMIBlock, { compact: true }))
      );
    }

    // MEDIUM (3√ó2) ‚Äî —á–∏—Å–ª–æ —Å–ª–µ–≤–∞ + (–≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –¥–æ–ø.–±–ª–æ–∫–∏) —Å–ø—Ä–∞–≤–∞ + —Ü–µ–ª—å –≤–Ω–∏–∑—É
    if (size === '3x2') {
      return React.createElement('div', { className: 'widget-weight widget-weight--3x2' },
        React.createElement('div', { className: 'widget-weight__top' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'lg' }),
            React.createElement(TrendBlock, { showText: true })
          ),
          hasSparkline
            ? React.createElement('div', { className: 'widget-weight__chart' },
              React.createElement(ChartBlock, { days: 7, height: 50, showDots: true })
            )
            : ((hasBmi || hasAnalytics) && React.createElement('div', { className: 'widget-weight__side' },
              React.createElement(BMIBlock, { compact: true }),
              React.createElement(AnalyticsBlock, null)
            ))
        ),
        React.createElement(GoalBlock, { inline: true })
      );
    }

    // WIDE (4√ó2) ‚Äî —á–∏—Å–ª–æ + —Ç—Ä–µ–Ω–¥ | (–≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å/–∞–Ω–∞–ª–∏—Ç–∏–∫–∞) | —Ü–µ–ª—å+BMI
    if (size === '4x2') {
      const wideMidFallback = (!hasSparkline) ? React.createElement('div', { className: 'widget-weight__mid' },
        React.createElement(ProgressBlock, { vertical: false }),
        React.createElement(AnalyticsBlock, null),
        (!hasAnalytics && !(showGoal && hasGoal && progressPct !== null))
          ? React.createElement('div', { className: 'widget-weight__hint' }, '–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Å 2+ –¥–Ω—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞')
          : null
      ) : null;
      return React.createElement('div', { className: 'widget-weight widget-weight--4x2' },
        React.createElement('div', { className: 'widget-weight__row-h' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'lg' }),
            React.createElement(TrendBlock, { showText: true })
          ),
          hasSparkline
            ? React.createElement('div', { className: 'widget-weight__chart' },
              React.createElement(ChartBlock, { days: 7, height: 55, showDots: true, showLabels: true })
            )
            : wideMidFallback,
          React.createElement('div', { className: 'widget-weight__right' },
            React.createElement(GoalBlock, { inline: false }),
            React.createElement(BMIBlock, { compact: true })
          )
        )
      );
    }

    // TALL3 (2√ó3) ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π: —á–∏—Å–ª–æ | —Ç—Ä–µ–Ω–¥ | –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    if (size === '2x3') {
      return React.createElement('div', { className: 'widget-weight widget-weight--2x3' },
        React.createElement(WeightValue, { scale: 'xl' }),
        React.createElement(TrendBlock, { showText: true, vertical: true }),
        React.createElement(ProgressBlock, { vertical: true }),
        React.createElement(BMIBlock, { compact: true })
      );
    }

    // TALL (2√ó4) ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π: —á–∏—Å–ª–æ | —Ç—Ä–µ–Ω–¥ | (–≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å) | —Ü–µ–ª—å
    if (size === '2x4') {
      const tallMid = hasSparkline
        ? React.createElement('div', { className: 'widget-weight__chart-vert' },
          React.createElement(ChartBlock, { days: 7, height: 80, showDots: true, showGoalLine: true })
        )
        : (showGoal && hasGoal && progressPct !== null)
          ? React.createElement(ProgressBlock, { vertical: true })
          : React.createElement(AnalyticsBlock, null);
      return React.createElement('div', { className: 'widget-weight widget-weight--2x4' },
        React.createElement(WeightValue, { scale: 'xl' }),
        React.createElement(TrendBlock, { showText: true }),
        tallMid,
        React.createElement(GoalBlock, { inline: false }),
        React.createElement(BMIBlock, { compact: true })
      );
    }

    // 3√ó3 ‚Äî –±–ª–∏–∑–∫–æ –∫ 4√ó3, –Ω–æ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –ø–æ —à–∏—Ä–∏–Ω–µ
    if (size === '3x3') {
      return React.createElement('div', { className: 'widget-weight widget-weight--3x3' },
        React.createElement('div', { className: 'widget-weight__header' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'xl' }),
            React.createElement(TrendBlock, { showText: true })
          ),
          React.createElement(BMIBlock, { compact: true })
        ),
        hasSparkline
          ? React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement(ChartBlock, { days: 10, height: 76, showDots: true, showLabels: false, showGoalLine: true })
          )
          : React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement('div', { className: 'widget-weight__hint' }, '–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Å 2+ –¥–Ω—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞')
          ),
        React.createElement('div', { className: 'widget-weight__footer' },
          React.createElement(ProgressBlock, { vertical: false }),
          React.createElement(AnalyticsBlock, null)
        )
      );
    }

    // 3√ó4 ‚Äî –ø–æ—á—Ç–∏ –∫–∞–∫ 4√ó4, –Ω–æ —á—É—Ç—å –ø–ª–æ—Ç–Ω–µ–µ
    if (size === '3x4') {
      const hasProgress = showGoal && hasGoal && progressPct !== null;
      return React.createElement('div', { className: 'widget-weight widget-weight--3x4' },
        React.createElement('div', { className: 'widget-weight__header' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'xl' }),
            React.createElement(TrendBlock, { showText: true })
          ),
          React.createElement(BMIBlock, { compact: false })
        ),
        hasSparkline
          ? React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement(ChartBlock, { days: 14, height: 104, showDots: true, showLabels: false, showGoalLine: true })
          )
          : React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement('div', { className: 'widget-weight__hint' }, '–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Å 2+ –¥–Ω—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞')
          ),
        React.createElement('div', { className: 'widget-weight__bottom' },
          React.createElement(ProgressBlock, { vertical: false }),
          React.createElement(AnalyticsBlock, null),
          !hasProgress ? React.createElement(GoalBlock, { inline: true }) : null
        )
      );
    }

    // WIDE3 (4√ó3) ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π: –≤–µ—Ä—Ö(—á–∏—Å–ª–æ+—Ç—Ä–µ–Ω–¥ | BMI) | –≥—Ä–∞—Ñ–∏–∫ | —Ü–µ–ª—å+–∞–Ω–∞–ª–∏—Ç–∏–∫–∞
    if (size === '4x3') {
      return React.createElement('div', { className: 'widget-weight widget-weight--4x3' },
        React.createElement('div', { className: 'widget-weight__header' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'xl' }),
            React.createElement(TrendBlock, { showText: true })
          ),
          React.createElement(BMIBlock, { compact: false })
        ),
        hasSparkline
          ? React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement(ChartBlock, { days: 10, height: 72, showDots: true, showLabels: true, showGoalLine: true })
          )
          : React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement('div', { className: 'widget-weight__hint' }, '–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Å 2+ –¥–Ω—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞')
          ),
        React.createElement('div', { className: 'widget-weight__footer' },
          React.createElement(ProgressBlock, { vertical: false }),
          React.createElement(AnalyticsBlock, null)
        )
      );
    }

    // LARGE (4√ó4) ‚Äî –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    if (size === '4x4') {
      const hasProgress = showGoal && hasGoal && progressPct !== null;
      return React.createElement('div', { className: 'widget-weight widget-weight--4x4' },
        React.createElement('div', { className: 'widget-weight__header' },
          React.createElement('div', { className: 'widget-weight__left' },
            React.createElement(WeightValue, { scale: 'xl' }),
            React.createElement(TrendBlock, { showText: true })
          ),
          React.createElement(BMIBlock, { compact: false })
        ),
        hasSparkline
          ? React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement(ChartBlock, { days: 14, height: 108, showDots: true, showLabels: true, showGoalLine: true })
          )
          : React.createElement('div', { className: 'widget-weight__chart-full' },
            React.createElement('div', { className: 'widget-weight__hint' }, '–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Å 2+ –¥–Ω—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞')
          ),
        React.createElement('div', { className: 'widget-weight__bottom' },
          React.createElement(ProgressBlock, { vertical: false }),
          React.createElement(AnalyticsBlock, null),
          // –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω, —Ü–µ–ª—å –≤–∏–¥–Ω–∞ –≤ –Ω—ë–º (‚Üí goal –∫–≥). –ù–µ –¥—É–±–ª–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –∫–ª–∏–ø–ø–∏–ª–æ –Ω–∏–∑.
          !hasProgress ? React.createElement(GoalBlock, { inline: true }) : null
        )
      );
    }

    // Fallback ‚Äî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä: —Ä–µ–Ω–¥–µ—Ä–∏–º –±–∞–∑–æ–≤–æ –∏ (–æ–¥–∏–Ω —Ä–∞–∑) –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    if (widgetsOnce(`weight:unknownSize:${size}`)) {
      trackWidgetIssue('widgets_weight_unknown_size', {
        size,
        widgetId: widget?.id,
        availableSizes: HEYS.Widgets.registry?.getType?.('weight')?.availableSizes
      });
    }
    return React.createElement('div', { className: `widget-weight widget-weight--${size || '2x2'}` },
      React.createElement(WeightValue, { scale: 'md' }),
      React.createElement(TrendBlock, { showText: false })
    );
  }

  /**
   * WeightMiniSparkline ‚Äî –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞ –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤
   */
  function WeightMiniSparkline({ points, width, height, trendColor, showDots, showLabels, showGoalLine, goalWeight }) {
    const validPoints = points.filter(p => p.weight !== null);
    if (validPoints.length < 2) return null;

    // –ï—Å–ª–∏ width = '100%', –∏—Å–ø–æ–ª—å–∑—É–µ–º viewBox –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
    const isFluid = width === '100%';
    const svgW = isFluid ? 200 : width;
    const svgH = height;

    const weights = validPoints.map(p => p.weight);
    const minW = Math.min(...weights) - 0.3;
    const maxW = Math.max(...weights) + 0.3;
    const range = Math.max(1, maxW - minW);

    const paddingX = showLabels ? 8 : 4;
    const paddingY = showLabels ? 12 : 4;
    const chartW = svgW - paddingX * 2;
    const chartH = svgH - paddingY * 2;

    const pts = validPoints.map((p, i) => ({
      x: paddingX + (i / (validPoints.length - 1)) * chartW,
      y: paddingY + chartH - ((p.weight - minW) / range) * chartH,
      weight: p.weight,
      dayNum: p.dayNum,
      isToday: p.isToday
    }));

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–≤–Ω–æ–π –ª–∏–Ω–∏–∏
    const buildPath = () => {
      if (pts.length < 2) return '';
      let d = `M${pts[0].x},${pts[0].y}`;
      for (let i = 0; i < pts.length - 1; i++) {
        const p1 = pts[i];
        const p2 = pts[i + 1];
        const cpx = (p1.x + p2.x) / 2;
        d += ` Q${cpx},${p1.y} ${p2.x},${p2.y}`;
      }
      return d;
    };

    const pathD = buildPath();

    // –õ–∏–Ω–∏—è —Ü–µ–ª–∏
    const goalY = showGoalLine && goalWeight
      ? paddingY + chartH - ((goalWeight - minW) / range) * chartH
      : null;

    return React.createElement('svg', {
      className: 'widget-weight__sparkline',
      viewBox: `0 0 ${svgW} ${svgH}`,
      width: isFluid ? '100%' : svgW,
      height: svgH,
      preserveAspectRatio: 'xMidYMid meet'
    },
      // –õ–∏–Ω–∏—è —Ü–µ–ª–∏ (–ø—É–Ω–∫—Ç–∏—Ä)
      goalY !== null && goalY > paddingY && goalY < svgH - paddingY &&
      React.createElement('line', {
        x1: paddingX,
        y1: goalY,
        x2: svgW - paddingX,
        y2: goalY,
        stroke: '#8b5cf6',
        strokeWidth: 1,
        strokeDasharray: '4 2',
        opacity: 0.5
      }),
      // –õ–∏–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
      React.createElement('path', {
        d: pathD,
        fill: 'none',
        stroke: trendColor,
        strokeWidth: 2,
        strokeLinecap: 'round'
      }),
      // –¢–æ—á–∫–∏
      showDots && pts.map((p, i) =>
        React.createElement('circle', {
          key: i,
          cx: p.x,
          cy: p.y,
          r: p.isToday ? 4 : 2.5,
          fill: p.isToday ? trendColor : '#fff',
          stroke: trendColor,
          strokeWidth: p.isToday ? 0 : 1.5
        })
      ),
      // –ú–µ—Ç–∫–∏ –¥–Ω–µ–π
      showLabels && pts.filter((_, i) => i === 0 || i === pts.length - 1).map((p, i) =>
        React.createElement('text', {
          key: 'lbl-' + i,
          x: p.x,
          y: svgH - 2,
          textAnchor: i === 0 ? 'start' : 'end',
          className: 'widget-weight__sparkline-label'
        }, p.dayNum)
      )
    );
  }

  function StepsWidgetContent({ widget, data }) {
    const steps = data.steps || 0;
    const goal = data.goal || 10000;
    const pct = goal > 0 ? Math.round((steps / goal) * 100) : 0;
    const km = (steps * 0.0007).toFixed(1);
    const remaining = Math.max(0, goal - steps);

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : 'std';

    const getStepsColor = () => {
      if (pct >= 100) return '#22c55e';
      if (pct >= 70) return '#3b82f6';
      if (pct >= 40) return '#eab308';
      return '#ef4444';
    };

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-steps widget-steps--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'üëü'),
        React.createElement('div', { className: 'widget-steps__value' }, steps)
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout
    if (size === '2x2') {
      const stepsColor = getStepsColor();
      return React.createElement('div', { className: 'widget-steps widget-steps--2x2' },
        // –í–µ—Ä—Ö: –∏–∫–æ–Ω–∫–∞ + —à–∞–≥–∏ + –ø—Ä–æ—Ü–µ–Ω—Ç
        React.createElement('div', { className: 'widget-steps__header' },
          React.createElement('div', { className: 'widget-steps__icon' }, 'üö∂'),
          React.createElement('div', { className: 'widget-steps__value widget-steps__value--lg' },
            steps.toLocaleString('ru-RU')
          ),
          React.createElement('div', { className: 'widget-steps__pct-badge', style: { background: `${stepsColor}20`, color: stepsColor } },
            `${pct}%`
          )
        ),
        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        React.createElement('div', { className: 'widget-steps__progress' },
          React.createElement('div', {
            className: 'widget-steps__bar',
            style: { width: `${Math.min(100, pct)}%`, background: stepsColor }
          })
        ),
        // –ù–∏–∑: –∫–∏–ª–æ–º–µ—Ç—Ä—ã + —Ü–µ–ª—å + –æ—Å—Ç–∞–ª–æ—Å—å
        React.createElement('div', { className: 'widget-steps__footer' },
          React.createElement('div', { className: 'widget-steps__km' }, `${km} –∫–º`),
          React.createElement('div', { className: 'widget-steps__meta' },
            remaining > 0
              ? `–µ—â—ë ${remaining.toLocaleString('ru-RU')}`
              : 'üèÜ –¶–µ–ª—å!'
          )
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const showKm = widget.settings?.showKilometers && !d.isTiny;
    const showGoalBar = widget.settings?.showGoal !== false;
    const showPctInline = d.isShort;

    return React.createElement('div', { className: `widget-steps widget-steps--${variant}` },
      React.createElement('div', { className: 'widget-steps__top' },
        React.createElement('div', { className: 'widget-steps__value' }, steps.toLocaleString('ru-RU')),
        showPctInline ? React.createElement('div', { className: 'widget-steps__pct' }, `${Math.min(999, pct)}%`) : null
      ),
      showKm ? React.createElement('div', { className: 'widget-steps__km' }, `${km} –∫–º`) : null,
      showGoalBar
        ? React.createElement('div', { className: 'widget-steps__progress' },
          React.createElement('div', {
            className: 'widget-steps__bar',
            style: { width: `${Math.min(100, pct)}%` }
          })
        )
        : null
    );
  }

  function MacrosWidgetContent({ widget, data }) {
    const { protein, fat, carbs, proteinTarget, fatTarget, carbsTarget } = data;

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isTiny ? 'compact' : 'std';

    // –†–∞—Å—á—ë—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
    const pctP = proteinTarget > 0 ? Math.round((protein || 0) / proteinTarget * 100) : 0;
    const pctF = fatTarget > 0 ? Math.round((fat || 0) / fatTarget * 100) : 0;
    const pctC = carbsTarget > 0 ? Math.round((carbs || 0) / carbsTarget * 100) : 0;
    const avgPct = Math.round((pctP + pctF + pctC) / 3);

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-macros widget-macros--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, '–ë–ñ–£'),
        React.createElement('div', { className: 'widget-macros__micro-value' }, `${Math.min(999, avgPct)}%`)
      );
    }

    // 4x1 ‚Äî –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π layout —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
    if (size === '4x1') {
      const MacroBarCompact = ({ label, value, target, pct, color }) => {
        return React.createElement('div', { className: 'widget-macros__item-4x1' },
          React.createElement('div', { className: 'widget-macros__label-4x1', style: { color } }, label),
          React.createElement('div', { className: 'widget-macros__bar-4x1' },
            React.createElement('div', {
              className: 'widget-macros__bar-fill',
              style: { width: `${Math.min(100, pct)}%`, background: color }
            })
          ),
          React.createElement('span', { className: 'widget-macros__value-4x1' }, `${Math.round(value)}–≥`)
        );
      };

      return React.createElement('div', { className: 'widget-macros widget-macros--4x1' },
        React.createElement(MacroBarCompact, { label: '–ë', value: protein || 0, target: proteinTarget || 100, pct: pctP, color: '#ef4444' }),
        React.createElement(MacroBarCompact, { label: '–ñ', value: fat || 0, target: fatTarget || 70, pct: pctF, color: '#eab308' }),
        React.createElement(MacroBarCompact, { label: '–£', value: carbs || 0, target: carbsTarget || 250, pct: pctC, color: '#3b82f6' })
      );
    }

    // 4x2 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π layout —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    if (size === '4x2') {
      const totalGrams = (protein || 0) + (fat || 0) + (carbs || 0);
      const totalTarget = (proteinTarget || 100) + (fatTarget || 70) + (carbsTarget || 250);
      const totalPct = totalTarget > 0 ? Math.round(totalGrams / totalTarget * 100) : 0;
      // –†–∞—Å—á—ë—Ç –∫–∞–ª–æ—Ä–∏–π: –±–µ–ª–∫–∏*4 + –∂–∏—Ä—ã*9 + —É–≥–ª–µ–≤–æ–¥—ã*4
      const kcalEaten = Math.round((protein || 0) * 4 + (fat || 0) * 9 + (carbs || 0) * 4);
      const kcalTarget = Math.round((proteinTarget || 100) * 4 + (fatTarget || 70) * 9 + (carbsTarget || 250) * 4);

      const MacroRowExtended = ({ label, emoji, value, target, pct, color }) => {
        const isGood = pct >= 80 && pct <= 120;
        const statusEmoji = pct < 80 ? '‚¨áÔ∏è' : pct > 120 ? '‚¨ÜÔ∏è' : '‚úÖ';
        return React.createElement('div', { className: 'widget-macros__row-4x2' },
          React.createElement('div', { className: 'widget-macros__row-header' },
            React.createElement('span', { className: 'widget-macros__emoji' }, emoji),
            React.createElement('span', { className: 'widget-macros__label-text' }, label),
            React.createElement('span', { className: 'widget-macros__grams-4x2' }, `${Math.round(value)}/${target}–≥`),
            React.createElement('span', {
              className: 'widget-macros__pct-badge',
              style: { background: isGood ? '#22c55e20' : `${color}20`, color: isGood ? '#22c55e' : color }
            }, `${pct}%`),
            React.createElement('span', { className: 'widget-macros__status-emoji' }, statusEmoji)
          ),
          React.createElement('div', { className: 'widget-macros__bar-4x2' },
            React.createElement('div', {
              className: 'widget-macros__bar-fill',
              style: { width: `${Math.min(100, pct)}%`, background: color }
            })
          )
        );
      };

      return React.createElement('div', { className: 'widget-macros widget-macros--4x2' },
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–∞–ª–æ—Ä–∏—è–º–∏ –∏ –±–∞–ª–∞–Ω—Å–æ–º –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
        React.createElement('div', { className: 'widget-macros__summary-4x2' },
          React.createElement('span', { className: 'widget-macros__kcal-line' },
            `üî• ${kcalEaten} / ${kcalTarget} –∫–∫–∞–ª`
          ),
          React.createElement('span', {
            className: 'widget-macros__balance-line',
            style: { color: avgPct >= 80 && avgPct <= 120 ? '#22c55e' : avgPct < 80 ? '#ef4444' : '#eab308' }
          }, `üìä ${avgPct}%`)
        ),
        // –¢—Ä–∏ –±–∞—Ä–∞ –ë–ñ–£
        React.createElement(MacroRowExtended, { label: '–ë–µ–ª–∫–∏', emoji: 'üçñ', value: protein || 0, target: proteinTarget || 100, pct: pctP, color: '#ef4444' }),
        React.createElement(MacroRowExtended, { label: '–ñ–∏—Ä—ã', emoji: 'üßà', value: fat || 0, target: fatTarget || 70, pct: pctF, color: '#eab308' }),
        React.createElement(MacroRowExtended, { label: '–£–≥–ª–µ–≤–æ–¥—ã', emoji: 'üçû', value: carbs || 0, target: carbsTarget || 250, pct: pctC, color: '#3b82f6' })
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout —Å –±–∞—Ä–∞–º–∏ –∏ —á–∏—Å–ª–∞–º–∏
    if (size === '2x2') {
      const MacroRow = ({ label, emoji, value, target, pct, color }) => {
        const isGood = pct >= 80 && pct <= 120;
        return React.createElement('div', { className: 'widget-macros__row-2x2' },
          React.createElement('div', { className: 'widget-macros__row-header' },
            React.createElement('span', { className: 'widget-macros__emoji' }, emoji),
            React.createElement('span', { className: 'widget-macros__grams' }, `${Math.round(value)}/${target}–≥`),
            React.createElement('span', {
              className: 'widget-macros__pct-badge',
              style: { background: isGood ? '#22c55e20' : `${color}20`, color: isGood ? '#22c55e' : color }
            }, `${pct}%`)
          ),
          React.createElement('div', { className: 'widget-macros__bar-2x2' },
            React.createElement('div', {
              className: 'widget-macros__bar-fill',
              style: { width: `${Math.min(100, pct)}%`, background: color }
            })
          )
        );
      };

      return React.createElement('div', { className: 'widget-macros widget-macros--2x2' },
        React.createElement(MacroRow, { label: '–ë–µ–ª–∫–∏', emoji: 'üçñ', value: protein || 0, target: proteinTarget || 100, pct: pctP, color: '#ef4444' }),
        React.createElement(MacroRow, { label: '–ñ–∏—Ä—ã', emoji: 'üßà', value: fat || 0, target: fatTarget || 70, pct: pctF, color: '#eab308' }),
        React.createElement(MacroRow, { label: '–£–≥–ª–µ–≤–æ–¥—ã', emoji: 'üçû', value: carbs || 0, target: carbsTarget || 250, pct: pctC, color: '#3b82f6' })
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const showGrams = widget.settings?.showGrams !== false && !d.isTiny;

    const MacroBar = ({ label, value, target, color, cls }) => {
      const pct = target > 0 ? Math.round((value / target) * 100) : 0;
      return React.createElement('div', { className: 'widget-macros__row' },
        React.createElement('span', { className: `widget-macros__label ${cls || ''}` }, label),
        React.createElement('div', { className: 'widget-macros__bar-container' },
          React.createElement('div', {
            className: 'widget-macros__bar',
            style: { width: `${Math.min(100, pct)}%`, backgroundColor: color }
          })
        ),
        showGrams ? React.createElement('span', { className: 'widget-macros__value' }, `${Math.round(value)}–≥`) : null
      );
    };

    return React.createElement('div', { className: `widget-macros widget-macros--${variant}` },
      React.createElement(MacroBar, {
        label: '–ë', value: protein || 0, target: proteinTarget || 100, color: '#ef4444', cls: 'widget-macros__label--prot'
      }),
      React.createElement(MacroBar, {
        label: '–ñ', value: fat || 0, target: fatTarget || 70, color: '#eab308', cls: 'widget-macros__label--fat'
      }),
      React.createElement(MacroBar, {
        label: '–£', value: carbs || 0, target: carbsTarget || 250, color: '#3b82f6', cls: 'widget-macros__label--carbs'
      })
    );
  }

  function InsulinWidgetContent({ widget, data }) {
    const status = data.status || 'unknown';
    const remaining = data.remaining;
    const phase = data.phase;
    const totalWave = data.totalWave || 180; // –û–±—â–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
    const lastMealTime = data.lastMealTime; // "14:30"

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : 'std';

    const getStatusInfo = () => {
      switch (status) {
        case 'active': return { emoji: 'üìà', label: '–í–æ–ª–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞', color: '#f97316', short: '–ê–∫—Ç–∏–≤–Ω–∞' };
        case 'almost': return { emoji: 'üìâ', label: '–ü–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å', color: '#eab308', short: '–ó–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è' };
        case 'soon': return { emoji: '‚è≥', label: '–°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è', color: '#22c55e', short: '–°–∫–æ—Ä–æ' };
        case 'lipolysis': return { emoji: 'üî•', label: '–õ–∏–ø–æ–ª–∏–∑!', color: '#10b981', short: '–õ–∏–ø–æ–ª–∏–∑!' };
        default: return { emoji: '‚ùì', label: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', color: '#94a3b8', short: '‚Äî' };
      }
    };

    const info = getStatusInfo();
    const showTimer = Number.isFinite(remaining) && remaining > 0;

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-insulin widget-insulin--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'ü©∏'),
        React.createElement('div', { className: 'widget-insulin__micro' },
          React.createElement('span', { className: 'widget-insulin__micro-emoji' }, info.emoji),
          showTimer ? React.createElement('span', { className: 'widget-insulin__micro-time' }, `${remaining}–º`) : null
        )
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout —Å –∫–æ–ª—å—Ü–µ–≤—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    if (size === '2x2') {
      const progressPct = showTimer && totalWave > 0
        ? Math.round(((totalWave - remaining) / totalWave) * 100)
        : (status === 'lipolysis' ? 100 : 0);

      // SVG –∫–æ–ª—å—Ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      const ringSize = 44;
      const strokeWidth = 5;
      const radius = (ringSize - strokeWidth) / 2;
      const circumference = 2 * Math.PI * radius;
      const strokeDashoffset = circumference - (progressPct / 100) * circumference;

      return React.createElement('div', { className: 'widget-insulin widget-insulin--2x2' },
        // –í–µ—Ä—Ö: —Å—Ç–∞—Ç—É—Å + –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
        React.createElement('div', { className: 'widget-insulin__header' },
          React.createElement('div', { className: 'widget-insulin__status-2x2', style: { color: info.color } },
            info.emoji, ' ', info.short
          ),
          lastMealTime && React.createElement('div', { className: 'widget-insulin__meal-time' },
            `üçΩ ${lastMealTime}`
          )
        ),
        // –¶–µ–Ω—Ç—Ä: –∫–æ–ª—å—Ü–æ —Å —Ç–∞–π–º–µ—Ä–æ–º
        React.createElement('div', { className: 'widget-insulin__ring-container' },
          React.createElement('svg', {
            className: 'widget-insulin__ring',
            width: ringSize,
            height: ringSize,
            viewBox: `0 0 ${ringSize} ${ringSize}`
          },
            // –§–æ–Ω
            React.createElement('circle', {
              cx: ringSize / 2, cy: ringSize / 2, r: radius,
              fill: 'none', stroke: '#e5e7eb', strokeWidth
            }),
            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            React.createElement('circle', {
              cx: ringSize / 2, cy: ringSize / 2, r: radius,
              fill: 'none', stroke: info.color, strokeWidth,
              strokeLinecap: 'round',
              strokeDasharray: circumference,
              strokeDashoffset,
              transform: `rotate(-90 ${ringSize / 2} ${ringSize / 2})`
            })
          ),
          // –¢–∞–π–º–µ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ
          React.createElement('div', { className: 'widget-insulin__timer-center' },
            showTimer
              ? `${remaining}–º`
              : (status === 'lipolysis' ? 'üî•' : '‚Äî')
          )
        ),
        // –ù–∏–∑: —Ñ–∞–∑–∞ –≤–æ–ª–Ω—ã
        phase && React.createElement('div', { className: 'widget-insulin__phase-2x2' },
          phase
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const showPhase = widget.settings?.showPhase !== false && !!phase && !d.isTiny;

    return React.createElement('div', { className: `widget-insulin widget-insulin--${variant}` },
      React.createElement('div', { className: `widget-insulin__status widget-insulin__status--${status}` },
        info.emoji, ' ', info.label
      ),
      showTimer ? React.createElement('div', { className: 'widget-insulin__timer' }, `${remaining} –º–∏–Ω`) : null,
      showPhase ? React.createElement('div', { className: 'widget-insulin__phase' }, phase) : null
    );
  }

  function HeatmapWidgetContent({ widget, data }) {
    const days = data.days || [];
    const currentStreak = data.currentStreak || 0;
    const configuredPeriod = widget.settings?.period || 'week';

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const canShowMonth = configuredPeriod === 'month' && d.area >= 9 && d.rows >= 3;
    const period = canShowMonth ? 'month' : 'week';

    let renderDays = days;
    if (d.isMicro) {
      renderDays = days.slice(-1);
    } else if (d.isTiny) {
      renderDays = days.slice(-7);
    } else if (period === 'week') {
      renderDays = days.slice(-7);
    }

    const variant = d.isMicro ? 'micro' : d.isTiny ? 'compact' : 'std';

    // 1x1 Micro
    if (d.isMicro) {
      const today = renderDays[0];
      return React.createElement('div', { className: 'widget-heatmap widget-heatmap--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'üìÖ'),
        React.createElement('div', { className: `widget-heatmap__today widget-heatmap__today--${today?.status || 'empty'}` })
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Å–µ—Ç–∫–∞ 7 –¥–Ω–µ–π + —Å—Ç—Ä–∏–∫
    // v3.22.0: —Å training/stress indicators
    if (size === '2x2') {
      const weekDays = days.slice(-7);
      const dayLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
      const today = new Date();
      const startDayIndex = (today.getDay() + 6) % 7; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0

      return React.createElement('div', { className: 'widget-heatmap widget-heatmap--2x2' },
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫: –∏–∫–æ–Ω–∫–∞ + streak
        React.createElement('div', { className: 'widget-heatmap__header' },
          React.createElement('span', { className: 'widget-heatmap__title' }, 'üìÖ –ù–µ–¥–µ–ª—è'),
          currentStreak > 0 && React.createElement('span', { className: 'widget-heatmap__streak' },
            `üî• ${currentStreak}`
          )
        ),
        // –°–µ—Ç–∫–∞ —Å –º–µ—Ç–∫–∞–º–∏ –¥–Ω–µ–π
        React.createElement('div', { className: 'widget-heatmap__week-grid' },
          weekDays.map((day, i) => {
            const dayIndex = (startDayIndex - 6 + i + 7) % 7;
            const isToday = i === weekDays.length - 1;
            // üÜï v3.22.0: training/stress indicators
            const hasTraining = day.hasTraining;
            const highStress = day.highStress;

            return React.createElement('div', {
              key: i,
              className: `widget-heatmap__day-col ${isToday ? 'widget-heatmap__day-col--today' : ''} ${hasTraining ? 'widget-heatmap__day-col--training' : ''}`
            },
              React.createElement('div', { className: 'widget-heatmap__day-label' }, dayLabels[dayIndex]),
              React.createElement('div', {
                className: `widget-heatmap__cell widget-heatmap__cell--${day.status || 'empty'} ${hasTraining ? 'widget-heatmap__cell--training' : ''} ${highStress ? 'widget-heatmap__cell--stress' : ''}`,
                title: `${day.date}${hasTraining ? ' üí™' : ''}${highStress ? ' üò∞' : ''}`
              },
                // üÜï Training/Stress mini badges
                (hasTraining || highStress) && React.createElement('div', { className: 'widget-heatmap__cell-badges' },
                  hasTraining && React.createElement('span', { className: 'widget-heatmap__cell-badge widget-heatmap__cell-badge--training' }, 'üí™'),
                  highStress && React.createElement('span', { className: 'widget-heatmap__cell-badge widget-heatmap__cell-badge--stress' }, 'üò∞')
                )
              )
            );
          })
        ),
        // –õ–µ–≥–µ–Ω–¥–∞ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ training/stress
        React.createElement('div', { className: 'widget-heatmap__legend' },
          React.createElement('span', { className: 'widget-heatmap__legend-item widget-heatmap__legend-item--green' }, '‚úî'),
          React.createElement('span', { className: 'widget-heatmap__legend-item widget-heatmap__legend-item--yellow' }, '‚âà'),
          React.createElement('span', { className: 'widget-heatmap__legend-item widget-heatmap__legend-item--red' }, '‚úñ'),
          React.createElement('span', { className: 'widget-heatmap__legend-item widget-heatmap__legend-item--training' }, 'üí™'),
          React.createElement('span', { className: 'widget-heatmap__legend-item widget-heatmap__legend-item--stress' }, 'üò∞')
        )
      );
    }

    return React.createElement('div', { className: `widget-heatmap widget-heatmap--${variant}` },
      React.createElement('div', { className: `widget-heatmap__grid widget-heatmap__grid--${period}` },
        renderDays.map((day, i) =>
          React.createElement('div', {
            key: i,
            className: `widget-heatmap__cell widget-heatmap__cell--${day.status || 'empty'}`,
            title: day.date
          })
        )
      )
    );
  }

  function CycleWidgetContent({ widget, data }) {
    const day = data.day;
    const phase = data.phase;
    const cycleLength = data.cycleLength || 28;
    const recommendation = data.recommendation; // "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"

    const d = getWidgetDims(widget);
    const size = widget?.size || '2x2';
    const variant = d.isMicro ? 'micro' : d.isShort ? 'short' : 'std';

    if (!day) {
      return React.createElement('div', { className: 'widget-cycle__empty' }, '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
    }

    // 1x1 Micro
    if (d.isMicro) {
      return React.createElement('div', { className: 'widget-cycle widget-cycle--micro' },
        React.createElement('div', { className: 'widget-micro__label' }, 'üå∏'),
        React.createElement('div', { className: 'widget-cycle__day' }, day)
      );
    }

    // 2x2 ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π layout —Å –∫–æ–ª—å—Ü–µ–≤—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    if (size === '2x2') {
      const progressPct = Math.round((day / cycleLength) * 100);
      const phaseColor = phase?.color || '#ec4899';

      // SVG –∫–æ–ª—å—Ü–æ
      const ringSize = 48;
      const strokeWidth = 5;
      const radius = (ringSize - strokeWidth) / 2;
      const circumference = 2 * Math.PI * radius;
      const strokeDashoffset = circumference - (progressPct / 100) * circumference;

      return React.createElement('div', { className: 'widget-cycle widget-cycle--2x2' },
        // –í–µ—Ä—Ö: —Ñ–∞–∑–∞
        phase && React.createElement('div', { className: 'widget-cycle__phase-header', style: { color: phaseColor } },
          phase.icon, ' ', phase.name
        ),
        // –¶–µ–Ω—Ç—Ä: –∫–æ–ª—å—Ü–æ —Å –¥–Ω—ë–º
        React.createElement('div', { className: 'widget-cycle__ring-container' },
          React.createElement('svg', {
            className: 'widget-cycle__ring',
            width: ringSize,
            height: ringSize,
            viewBox: `0 0 ${ringSize} ${ringSize}`
          },
            // –§–æ–Ω
            React.createElement('circle', {
              cx: ringSize / 2, cy: ringSize / 2, r: radius,
              fill: 'none', stroke: '#fce7f3', strokeWidth
            }),
            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            React.createElement('circle', {
              cx: ringSize / 2, cy: ringSize / 2, r: radius,
              fill: 'none', stroke: phaseColor, strokeWidth,
              strokeLinecap: 'round',
              strokeDasharray: circumference,
              strokeDashoffset,
              transform: `rotate(-90 ${ringSize / 2} ${ringSize / 2})`
            })
          ),
          // –î–µ–Ω—å –≤ —Ü–µ–Ω—Ç—Ä–µ
          React.createElement('div', { className: 'widget-cycle__day-center' },
            React.createElement('span', { className: 'widget-cycle__day-num' }, day),
            React.createElement('span', { className: 'widget-cycle__day-label' }, '–¥–µ–Ω—å')
          )
        ),
        // –ù–∏–∑: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
        recommendation && React.createElement('div', { className: 'widget-cycle__tip' },
          recommendation
        )
      );
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    return React.createElement('div', { className: `widget-cycle widget-cycle--${variant}` },
      React.createElement('div', { className: 'widget-cycle__day' },
        `–î–µ–Ω—å ${day}`
      ),
      widget.settings?.showPhase && phase && !d.isTiny &&
      React.createElement('div', { className: 'widget-cycle__phase' },
        phase.icon, ' ', phase.name
      )
    );
  }

  // === Crash Risk Widget Content v2.0 (EWS + Weight Loss Detection) ===
  function CrashRiskWidgetContent({ widget, data }) {
    const d = getWidgetDims(widget);
    const size = widget?.size || '4x2';

    // Extract data from provider
    const hasData = data?.hasData || false;
    const weeklyLossPercent = data?.weeklyLossPercent || 0;
    const isWarning = data?.isWarning || false;
    const severity = data?.severity || 'none';
    const currentWeight = data?.currentWeight || 0;
    const ewsCount = data?.ewsCount || 0;
    const ewsData = data?.ewsData || null;
    const message = data?.message || '';

    // Color scheme based on severity
    const getColorBySeverity = (sev) => {
      switch (sev) {
        case 'high': return { bg: '#ef4444', text: '#ffffff', light: '#fee2e2' };
        case 'medium': return { bg: '#f97316', text: '#ffffff', light: '#ffedd5' };
        default: return { bg: '#10b981', text: '#ffffff', light: '#d1fae5' };
      }
    };

    const colors = getColorBySeverity(severity);

    // Open EWS Panel on click
    const handleOpenEWS = useCallback(() => {
      const event = new CustomEvent('heysShowEWSPanel');
      document.dispatchEvent(event);
    }, []);

    // === NO DATA STATE ===
    if (!hasData) {
      return React.createElement('div', { className: 'widget-crash-risk widget-crash-risk--no-data' },
        React.createElement('div', { className: 'widget-crash-risk__icon' }, '‚ö†Ô∏è'),
        React.createElement('div', { className: 'widget-crash-risk__message' }, message || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö')
      );
    }

    // === 2√ó2 COMPACT LAYOUT ===
    if (size === '2x2') {
      return React.createElement('div', {
        className: `widget-crash-risk widget-crash-risk--compact widget-crash-risk--${severity}`,
        onClick: handleOpenEWS
      },
        // Top: Icon + Percentage
        React.createElement('div', { className: 'widget-crash-risk__header' },
          React.createElement('div', { className: 'widget-crash-risk__icon', style: { color: colors.bg } },
            isWarning ? '‚ö†Ô∏è' : '‚úÖ'
          ),
          React.createElement('div', {
            className: 'widget-crash-risk__percent',
            style: { color: colors.bg }
          }, `${weeklyLossPercent.toFixed(1)}%`)
        ),

        // Middle: Title
        React.createElement('div', { className: 'widget-crash-risk__title' }, '–ü–æ—Ç–µ—Ä—è –≤–µ—Å–∞'),

        // Bottom: EWS Badge
        ewsCount > 0 && React.createElement('div', {
          className: 'widget-crash-risk__ews-badge',
          style: { background: colors.light, color: colors.bg }
        },
          `${ewsCount} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥.`
        )
      );
    }

    // === 4√ó2 STANDARD LAYOUT ===
    if (size === '4x2') {
      const topWarnings = ewsData?.warnings?.slice(0, 2) || [];

      return React.createElement('div', {
        className: `widget-crash-risk widget-crash-risk--standard widget-crash-risk--${severity}`,
        onClick: handleOpenEWS
      },
        // Left: KPI Block
        React.createElement('div', { className: 'widget-crash-risk__kpi' },
          React.createElement('div', { className: 'widget-crash-risk__icon-big', style: { color: colors.bg } },
            isWarning ? '‚ö†Ô∏è' : '‚úÖ'
          ),
          React.createElement('div', { className: 'widget-crash-risk__percent-big', style: { color: colors.bg } },
            `${weeklyLossPercent.toFixed(1)}%`
          ),
          React.createElement('div', { className: 'widget-crash-risk__label' }, '/–Ω–µ–¥–µ–ª—è')
        ),

        // Right: Details
        React.createElement('div', { className: 'widget-crash-risk__details' },
          React.createElement('div', { className: 'widget-crash-risk__title-big' }, '–ü–æ—Ç–µ—Ä—è –≤–µ—Å–∞'),
          React.createElement('div', { className: 'widget-crash-risk__subtitle' },
            `–¢–µ–∫—É—â–∏–π –≤–µ—Å: ${currentWeight.toFixed(1)} –∫–≥`
          ),

          // EWS Count Badge
          ewsCount > 0 && React.createElement('div', {
            className: 'widget-crash-risk__ews-count',
            style: { background: colors.light, color: colors.bg }
          },
            `${ewsCount} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥. ‚Üí –ü–æ–¥—Ä–æ–±–Ω–µ–µ`
          ),

          // Top 2 warnings preview
          widget.settings?.showWarnings !== false && topWarnings.length > 0 &&
          React.createElement('div', { className: 'widget-crash-risk__warnings-preview' },
            topWarnings.map((w, i) =>
              React.createElement('div', {
                key: i,
                className: `widget-crash-risk__warning widget-crash-risk__warning--${w.severity}`
              },
                React.createElement('span', { className: 'widget-crash-risk__warning-icon' }, getSeverityIcon(w.severity)),
                React.createElement('span', { className: 'widget-crash-risk__warning-text' },
                  w.message?.length > 40 ? w.message.slice(0, 37) + '...' : w.message
                )
              )
            )
          )
        )
      );
    }

    // === 4√ó3 EXTENDED LAYOUT ===
    if (size === '4x3' || d.cols >= 4 && d.rows >= 3) {
      const topWarnings = ewsData?.warnings?.slice(0, 3) || [];

      return React.createElement('div', {
        className: `widget-crash-risk widget-crash-risk--extended widget-crash-risk--${severity}`,
        onClick: handleOpenEWS
      },
        // Header: Title + EWS Count
        React.createElement('div', { className: 'widget-crash-risk__header-extended' },
          React.createElement('div', { className: 'widget-crash-risk__title-extended' }, 'Early Warning System'),
          ewsCount > 0 && React.createElement('div', {
            className: 'widget-crash-risk__ews-badge-extended',
            style: { background: colors.light, color: colors.bg }
          }, `${ewsCount} –ø—Ä–µ–¥—É–ø—Ä.`)
        ),

        // KPI Section
        React.createElement('div', { className: 'widget-crash-risk__kpi-section' },
          React.createElement('div', { className: 'widget-crash-risk__kpi-block' },
            React.createElement('div', { className: 'widget-crash-risk__icon-big', style: { color: colors.bg } },
              isWarning ? '‚ö†Ô∏è' : '‚úÖ'
            ),
            React.createElement('div', { className: 'widget-crash-risk__percent-big', style: { color: colors.bg } },
              `${weeklyLossPercent.toFixed(1)}%`
            ),
            React.createElement('div', { className: 'widget-crash-risk__label' }, '–ø–æ—Ç–µ—Ä—è/–Ω–µ–¥–µ–ª—è')
          ),
          React.createElement('div', { className: 'widget-crash-risk__weight-info' },
            React.createElement('div', { className: 'widget-crash-risk__weight-label' }, '–¢–µ–∫—É—â–∏–π –≤–µ—Å'),
            React.createElement('div', { className: 'widget-crash-risk__weight-value' }, `${currentWeight.toFixed(1)} –∫–≥`)
          )
        ),

        // Warnings List (Top 3)
        widget.settings?.showWarnings !== false && topWarnings.length > 0 &&
        React.createElement('div', { className: 'widget-crash-risk__warnings-section' },
          React.createElement('div', { className: 'widget-crash-risk__warnings-title' }, '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:'),
          React.createElement('div', { className: 'widget-crash-risk__warnings-list' },
            topWarnings.map((w, i) =>
              React.createElement('div', {
                key: i,
                className: `widget-crash-risk__warning-item widget-crash-risk__warning-item--${w.severity}`
              },
                React.createElement('span', { className: 'widget-crash-risk__warning-icon' }, getSeverityIcon(w.severity)),
                React.createElement('span', { className: 'widget-crash-risk__warning-msg' }, w.message)
              )
            )
          )
        ),

        // Footer: CTA
        React.createElement('div', { className: 'widget-crash-risk__footer' },
          React.createElement('div', { className: 'widget-crash-risk__cta' }, '‚Üí –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç')
        )
      );
    }

    // === FALLBACK (other sizes) ===
    return React.createElement('div', {
      className: `widget-crash-risk widget-crash-risk--fallback widget-crash-risk--${severity}`
    },
      React.createElement('div', { className: 'widget-crash-risk__icon', style: { color: colors.bg } },
        isWarning ? '‚ö†Ô∏è' : '‚úÖ'
      ),
      React.createElement('div', { className: 'widget-crash-risk__percent', style: { color: colors.bg } },
        `${weeklyLossPercent.toFixed(1)}%`
      ),
      React.createElement('div', { className: 'widget-crash-risk__label' }, '–ø–æ—Ç–µ—Ä—è/–Ω–µ–¥–µ–ª—è')
    );
  }

  // Helper: Severity icon mapping
  function getSeverityIcon(severity) {
    switch (severity) {
      case 'high': return 'üî¥';
      case 'medium': return 'üü°';
      default: return 'üü¢';
    }
  }

  // === Catalog Modal Component ===
  function CatalogModal({ isOpen, onClose, onSelect, existingTypes }) {
    const registry = HEYS.Widgets.registry;
    const categories = registry?.getCategories() || [];
    const availableTypes = registry?.getAvailableTypes() || [];
    const existingTypeSet = existingTypes instanceof Set ? existingTypes : new Set(existingTypes || []);

    const [selectedCategory, setSelectedCategory] = useState(null);

    useEffect(() => {
      if (isOpen) {
        HEYS.Widgets.emit('catalog:open');
      } else {
        HEYS.Widgets.emit('catalog:close');
      }
    }, [isOpen]);

    if (!isOpen) return null;

    const filteredTypes = selectedCategory
      ? availableTypes.filter(t => t.category === selectedCategory)
      : availableTypes;

    const handleSelect = (type) => {
      if (existingTypeSet.has(type.type)) return;
      onSelect?.(type);
      HEYS.Widgets.emit('catalog:select', { type: type.type });
      onClose?.();
    };

    if (widgetsDebugEnabled() && widgetsOnce(`catalog:render:${filteredTypes.length}`)) {
      trackWidgetIssue('widgets_catalog_render', { count: filteredTypes.length });
    }

    return React.createElement('div', { className: 'widgets-catalog-overlay', onClick: onClose },
      React.createElement('div', {
        className: 'widgets-catalog',
        onClick: e => e.stopPropagation()
      },
        // Header
        React.createElement('div', { className: 'widgets-catalog__header' },
          React.createElement('h2', null, '–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç'),
          React.createElement('button', {
            className: 'widgets-catalog__close',
            onClick: onClose
          }, '‚úï')
        ),

        // Category Filters
        React.createElement('div', { className: 'widgets-catalog__categories' },
          React.createElement('button', {
            className: `widgets-catalog__category ${!selectedCategory ? 'active' : ''}`,
            onClick: () => setSelectedCategory(null)
          }, '–í—Å–µ'),
          categories.map(cat =>
            React.createElement('button', {
              key: cat.id,
              className: `widgets-catalog__category ${selectedCategory === cat.id ? 'active' : ''}`,
              onClick: () => setSelectedCategory(cat.id)
            }, cat.icon, ' ', cat.label)
          )
        ),

        // Widget List
        React.createElement('div', { className: 'widgets-catalog__list' },
          filteredTypes.map(type => {
            const isAlreadyAdded = existingTypeSet.has(type.type);
            return React.createElement('div', {
              key: type.type,
              className: `widgets-catalog__item ${isAlreadyAdded ? 'widgets-catalog__item--disabled' : ''}`,
              onClick: () => handleSelect(type)
            },
              React.createElement('div', { className: 'widgets-catalog__item-icon' }, type.icon),
              React.createElement('div', { className: 'widgets-catalog__item-info' },
                React.createElement('div', { className: 'widgets-catalog__item-name' }, type.name),
                React.createElement('div', { className: 'widgets-catalog__item-desc' }, type.description)
              ),
              isAlreadyAdded && React.createElement('div', { className: 'widgets-catalog__item-badge' }, '‚úì –£–∂–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ')
            );
          })
        )
      )
    );
  }

  // === Settings Modal Component ===
  function SettingsModal({ widget, isOpen, onClose, onSave }) {
    const registry = HEYS.Widgets.registry;
    const widgetType = widget ? registry?.getType(widget.type) : null;
    const [settings, setSettings] = useState({});

    useEffect(() => {
      if (widget) {
        setSettings({ ...widget.settings });
      }
    }, [widget]);

    if (!isOpen || !widget || !widgetType) return null;

    const handleChange = (key, value) => {
      setSettings(prev => ({ ...prev, [key]: value }));
    };

    const handleSave = () => {
      onSave?.(widget.id, settings);
      onClose?.();
    };

    return React.createElement('div', { className: 'widgets-settings-overlay', onClick: onClose },
      React.createElement('div', {
        className: 'widgets-settings',
        onClick: e => e.stopPropagation()
      },
        React.createElement('div', { className: 'widgets-settings__header' },
          React.createElement('h2', null, `–ù–∞—Å—Ç—Ä–æ–π–∫–∏: ${widgetType.name}`),
          React.createElement('button', {
            className: 'widgets-settings__close',
            onClick: onClose
          }, '‚úï')
        ),

        React.createElement('div', { className: 'widgets-settings__content' },
          // Size selector
          React.createElement('div', { className: 'widgets-settings__field' },
            React.createElement('label', null, '–†–∞–∑–º–µ—Ä'),
            React.createElement('div', { className: 'widgets-settings__sizes' },
              widgetType.availableSizes.map(sizeId => {
                const size = registry.getSize(sizeId);
                return React.createElement('button', {
                  key: sizeId,
                  className: `widgets-settings__size ${widget.size === sizeId ? 'active' : ''}`,
                  onClick: () => HEYS.Widgets.state.resizeWidget(widget.id, sizeId)
                }, size.label);
              })
            )
          ),

          // Custom settings
          widgetType.settings && Object.entries(widgetType.settings).map(([key, def]) =>
            React.createElement('div', { key, className: 'widgets-settings__field' },
              React.createElement('label', null, def.label),
              def.type === 'boolean' ?
                React.createElement('input', {
                  type: 'checkbox',
                  checked: settings[key] ?? def.default,
                  onChange: e => handleChange(key, e.target.checked)
                }) :
                def.type === 'number' ?
                  React.createElement('input', {
                    type: 'number',
                    value: settings[key] ?? def.default,
                    min: def.min,
                    max: def.max,
                    onChange: e => handleChange(key, parseInt(e.target.value, 10))
                  }) :
                  def.type === 'select' ?
                    React.createElement('select', {
                      value: settings[key] ?? def.default,
                      onChange: e => handleChange(key, e.target.value)
                    },
                      def.options.map(opt =>
                        React.createElement('option', { key: opt.value, value: opt.value }, opt.label)
                      )
                    ) :
                    null
            )
          )
        ),

        React.createElement('div', { className: 'widgets-settings__footer' },
          React.createElement('button', {
            className: 'widgets-settings__btn widgets-settings__btn--cancel',
            onClick: onClose
          }, '–û—Ç–º–µ–Ω–∞'),
          React.createElement('button', {
            className: 'widgets-settings__btn widgets-settings__btn--save',
            onClick: handleSave
          }, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å')
        )
      )
    );
  }

  // === Main WidgetsTab Component ===
  function WidgetsTab({ selectedDate, clientId, setTab, setSelectedDate }) {
    const [widgets, setWidgets] = useState([]);
    const [isLayoutHydrated, setIsLayoutHydrated] = useState(false);
    const [isEditMode, setIsEditMode] = useState(false);
    const [catalogOpen, setCatalogOpen] = useState(false);
    const [settingsWidget, setSettingsWidget] = useState(null);
    const [historyInfo, setHistoryInfo] = useState({ canUndo: false, canRedo: false });
    const [waterAnim, setWaterAnim] = useState(null); // '+200ml' –∏–ª–∏ null
    const [showGridOverlay, setShowGridOverlay] = useState(false); // Grid overlay toggle
    const containerRef = useRef(null);
    const gridRef = useRef(null);

    // Mobile detection (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ö—É–∫ Day)
    const isMobile = (HEYS.dayHooks && typeof HEYS.dayHooks.useMobileDetection === 'function')
      ? HEYS.dayHooks.useMobileDetection(768)
      : false;

    // –ù–∞ –º–æ–±–∏–ª–µ –¥–µ–ª–∞–µ–º –µ–¥–∏–Ω–∏—Ü—É —Å–µ—Ç–∫–∏ –±–ª–∏–∂–µ –∫ –∫–≤–∞–¥—Ä–∞—Ç—É (row-height = —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏)
    // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è mini (1√ó1), —á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ ¬´0.5 –ø–æ –≤—ã—Å–æ—Ç–µ¬ª.
    useEffect(() => {
      const grid = gridRef.current;
      if (!grid) return;

      const update = () => {
        try {
          if (!isMobile) return;
          const cs = window.getComputedStyle(grid);
          const colsVar = parseInt(cs.getPropertyValue('--widget-grid-columns'), 10);
          const cols = Number.isFinite(colsVar) && colsVar > 0 ? colsVar : 4;
          const gapVar = parseFloat(cs.getPropertyValue('--widget-grid-gap'));
          const gap = Number.isFinite(gapVar) ? gapVar : 8;

          const w = grid.clientWidth;
          if (!w) return;
          const cellW = (w - gap * (cols - 1)) / cols;
          if (!Number.isFinite(cellW) || cellW <= 0) return;

          const target = Math.max(60, Math.min(Math.round(cellW), 140));
          grid.style.setProperty('--widget-row-height', `${target}px`);
        } catch (e) {
          // silent
        }
      };

      update();
      window.addEventListener('resize', update);
      window.addEventListener('orientationchange', update);
      return () => {
        window.removeEventListener('resize', update);
        window.removeEventListener('orientationchange', update);
      };
    }, [isMobile, widgets.length, isEditMode]);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º selectedDate –≤ HEYS.Widgets.data –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ widget_data.js
    useEffect(() => {
      if (HEYS.Widgets.data) {
        HEYS.Widgets.data._selectedDate = selectedDate;
      }
    }, [selectedDate]);

    // üîÑ –†–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
    // –ö—Ä–∏—Ç–∏—á–Ω–æ: –∫–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π layout –≤–∏–¥–∂–µ—Ç–æ–≤!
    useEffect(() => {
      if (clientId) {
        console.log(`[WidgetsTab] clientId changed: "${clientId.slice(0, 8)}...", reinitializing widgets`);
        // –ü–µ—Ä–µ–¥–∞—ë–º clientId —è–≤–Ω–æ, —Ç.–∫. HEYS.currentClientId –º–æ–∂–µ—Ç –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è (race condition)
        HEYS.Widgets.state?.reinit?.(clientId);
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π state –ø–æ—Å–ª–µ reinit
        setWidgets(HEYS.Widgets.state?.getWidgets?.() || []);
        updateHistoryInfo();
      }
    }, [clientId]);

    // Initialize and subscribe to state changes
    useEffect(() => {
      // –í–∞–∂–Ω–æ: –Ω–∞ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ widgets=[] –∏ UI –º–æ–∂–µ—Ç –∫—Ä–∞—Ç–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å empty-state.
      // –ü–æ—ç—Ç–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º empty-state —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–∏—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
      setIsLayoutHydrated(false);

      // Initialize state if not already
      HEYS.Widgets.state?.init?.();

      // Get initial widgets
      setWidgets(HEYS.Widgets.state?.getWidgets?.() || []);
      setIsEditMode(HEYS.Widgets.state?.isEditMode?.() || false);
      updateHistoryInfo();
      setIsLayoutHydrated(true);

      // üîß v1.19: –ü—Ä–æ–≤–µ—Ä—è–µ–º WidgetsTour –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      // (layout:loaded –º–æ–∂–µ—Ç —É–∂–µ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç—É—Ä–∞)
      const tourTimer = setTimeout(() => {
        console.log('[WidgetsTab] Checking WidgetsTour eligibility...', {
          hasTour: !!HEYS.WidgetsTour,
          shouldShow: HEYS.WidgetsTour?.shouldShow?.(),
          hasStart: !!HEYS.WidgetsTour?.start
        });
        if (HEYS.WidgetsTour?.shouldShow?.() && HEYS.WidgetsTour.start) {
          console.log('[WidgetsTab] Starting WidgetsTour!');
          HEYS.WidgetsTour.start();
        }
      }, 800);

      // Subscribe to layout loaded (–ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
      const unsubLoaded = HEYS.Widgets.on('layout:loaded', ({ layout }) => {
        setWidgets([...(layout || [])]);
        updateHistoryInfo();
        setIsLayoutHydrated(true);

        // Auto-start WidgetsTour if applicable (after layout is ready)
        setTimeout(() => {
          if (HEYS.WidgetsTour?.shouldShow?.() && HEYS.WidgetsTour.start) {
            HEYS.WidgetsTour.start();
          }
        }, 500);
      });

      // Subscribe to layout changes
      const unsubLayout = HEYS.Widgets.on('layout:changed', ({ layout }) => {
        setWidgets([...layout]);
        updateHistoryInfo();
        setIsLayoutHydrated(true);
      });

      // Subscribe to edit mode changes
      const unsubEditEnter = HEYS.Widgets.on('editmode:enter', () => {
        setIsEditMode(true);
      });

      const unsubEditExit = HEYS.Widgets.on('editmode:exit', () => {
        setIsEditMode(false);
      });

      // Subscribe to history changes
      const unsubHistory = HEYS.Widgets.on('history:changed', updateHistoryInfo);

      return () => {
        clearTimeout(tourTimer);
        unsubLoaded?.();
        unsubLayout?.();
        unsubEditEnter?.();
        unsubEditExit?.();
        unsubHistory?.();
      };
    }, []);

    // Update history info
    const updateHistoryInfo = useCallback(() => {
      setHistoryInfo({
        canUndo: HEYS.Widgets.canUndo?.() || false,
        canRedo: HEYS.Widgets.canRedo?.() || false
      });
    }, []);

    // Handle catalog widget selection
    const handleCatalogSelect = useCallback((widgetType) => {
      if (!HEYS.Widgets.registry) {
        trackWidgetIssue('widgets_registry_not_initialized', { source: 'handleCatalogSelect' });
        return;
      }

      const widget = HEYS.Widgets.registry.createWidget(widgetType.type);

      if (widget) {
        if (!HEYS.Widgets.state) {
          trackWidgetIssue('widgets_state_not_initialized', { source: 'handleCatalogSelect' });
          return;
        }
        const added = HEYS.Widgets.state.addWidget(widget);
        if (!added) {
          trackWidgetIssue('widgets_addWidget_failed', { type: widgetType?.type });
        }
      } else {
        trackWidgetIssue('widgets_createWidget_null', { type: widgetType?.type });
      }
    }, []);

    // Handle widget settings save
    const handleSettingsSave = useCallback((widgetId, settings) => {
      HEYS.Widgets.state?.updateWidget(widgetId, { settings });
    }, []);

    // Handle widget remove
    const handleRemove = useCallback((widgetId) => {
      HEYS.Widgets.state?.removeWidget(widgetId);
    }, []);

    // Global pointer event handlers for DnD (—Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –≥–µ–π—Ç –≤ handlePointerMove/Up –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ)
    useEffect(() => {
      const onMove = (e) => HEYS.Widgets.dnd?.handlePointerMove?.(e);
      const onUp = (e) => HEYS.Widgets.dnd?.handlePointerUp?.(null, e);
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onUp);
      document.addEventListener('pointercancel', onUp);
      return () => {
        document.removeEventListener('pointermove', onMove);
        document.removeEventListener('pointerup', onUp);
        document.removeEventListener('pointercancel', onUp);
      };
    }, []);

    // Toggle edit mode
    const toggleEdit = useCallback(() => {
      HEYS.Widgets.toggleEditMode?.();
    }, []);

    // FAB: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏ / –≤–æ–¥—É ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏ –≤—ã–∑—ã–≤–∞–µ–º Day API
    const goToDayAndRun = useCallback((targetTab, fnName, fnArgs = []) => {
      const doSetTab = typeof setTab === 'function' ? setTab : (window.HEYS?.App?.setTab);

      if (typeof doSetTab === 'function') {
        doSetTab(targetTab);
      }

      // –î–∞–µ–º React —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å DayTab
      setTimeout(() => {
        const fn = window.HEYS?.Day?.[fnName];
        if (typeof fn === 'function') {
          try {
            fn(...fnArgs);
          } catch (e) {
            // silent: –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –ª–æ–º–∞—Ç—å UI
          }
        }
      }, 600);
    }, [setTab]);

    // üíß –î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—É –ë–ï–ó –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏ ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä—è–º–æ –∑–¥–µ—Å—å
    const handleAddWater = useCallback((ml = 200) => {
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
      setWaterAnim('+' + ml + '–º–ª');

      // –í–∏–±—Ä–∞—Ü–∏—è
      if (navigator.vibrate) navigator.vibrate(50);

      // –í—ã–∑—ã–≤–∞–µ–º HEYS.Day.addWater –Ω–∞–ø—Ä—è–º—É—é (skipScroll=true, —á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—å)
      const addWaterFn = window.HEYS?.Day?.addWater;
      if (typeof addWaterFn === 'function') {
        try {
          addWaterFn(ml, true); // skipScroll = true
          // –í–∏–¥–∂–µ—Ç –≤–æ–¥—ã –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ DOM —Å–æ–±—ã—Ç–∏–µ heysWaterAdded (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
        } catch (e) {
          // silent
        }
      } else {
        // Fallback: –µ—Å–ª–∏ Day –µ—â–µ –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ localStorage
        try {
          const dateKey = selectedDate || new Date().toISOString().slice(0, 10);
          // heys_client_current —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ JSON-—Å—Ç—Ä–æ–∫–∞, –Ω—É–∂–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
          let clientCurrent = '';
          try {
            const raw = localStorage.getItem('heys_client_current');
            clientCurrent = raw ? JSON.parse(raw) : '';
          } catch (e) {
            clientCurrent = localStorage.getItem('heys_client_current') || '';
          }
          const storageKey = clientCurrent
            ? `heys_${clientCurrent}_dayv2_${dateKey}`
            : `heys_dayv2_${dateKey}`;
          const dayData = JSON.parse(localStorage.getItem(storageKey) || '{}');
          dayData.waterMl = (dayData.waterMl || 0) + ml;
          dayData.lastWaterTime = Date.now();
          dayData.updatedAt = Date.now();
          localStorage.setItem(storageKey, JSON.stringify(dayData));

          // Dispatch event –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          window.dispatchEvent(new CustomEvent('heysWaterAdded', {
            detail: { ml, total: dayData.waterMl }
          }));
          // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤
          if (typeof HEYS.events?.emit === 'function') {
            HEYS.events.emit('water:added', { ml, total: dayData.waterMl });
          }
        } catch (e) {
          // silent
        }
      }

      // –°–∫—Ä—ã—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ 800–º—Å
      setTimeout(() => setWaterAnim(null), 800);
    }, [selectedDate]);

    // Undo/Redo handlers
    const handleUndo = useCallback(() => {
      HEYS.Widgets.undo?.();
    }, []);

    const handleRedo = useCallback(() => {
      HEYS.Widgets.redo?.();
    }, []);

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º overlay –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ edit mode
    useEffect(() => {
      if (!isEditMode) setShowGridOverlay(false);
    }, [isEditMode]);

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è grid overlay (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–Ω—è—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ + –∑–∞–ø–∞—Å)
    const overlayRows = useMemo(() => {
      if (!widgets.length) return 8;
      const maxRow = widgets.reduce((max, w) => {
        return Math.max(max, (w.position?.row || 1) + (w.rows || 1) - 1);
      }, 4);
      return Math.max(8, maxRow + 2);
    }, [widgets]);

    // Render empty state (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–∏—á–Ω–æ–π –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ layout)
    if (isLayoutHydrated && widgets.length === 0 && !isEditMode) {
      return React.createElement('div', { className: 'widgets-tab' },
        React.createElement('div', { className: 'widgets-empty' },
          React.createElement('div', { className: 'widgets-empty__icon' }, 'üìä'),
          React.createElement('div', { className: 'widgets-empty__title' }, '–ù–µ—Ç –≤–∏–¥–∂–µ—Ç–æ–≤'),
          React.createElement('div', { className: 'widgets-empty__desc' },
            '–î–æ–±–∞–≤—å—Ç–µ –≤–∏–¥–∂–µ—Ç—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π'
          ),
          React.createElement('button', {
            className: 'widgets-empty__btn',
            onClick: () => setCatalogOpen(true)
          }, '+ –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç')
        ),
        React.createElement(CatalogModal, {
          isOpen: catalogOpen,
          onClose: () => setCatalogOpen(false),
          onSelect: handleCatalogSelect
        })
      );
    }

    return React.createElement('div', {
      className: `widgets-tab ${isEditMode ? 'widgets-tab--editing' : ''}`,
      ref: containerRef
    },
      // Header (–ø—É—Å—Ç–æ–π - –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ fixed –±–ª–æ–∫ —Å–Ω–∏–∑—É)
      React.createElement('div', { className: 'widgets-header' }),

      // Widgets Grid
      React.createElement('div', { className: 'widgets-grid-container' },
        React.createElement('div', {
          className: `widgets-grid ${isEditMode ? 'widgets-grid--editing' : ''}`,
          ref: gridRef
        },
          widgets.map((widget, idx) =>
            React.createElement(WidgetCard, {
              key: widget.id,
              widget,
              isEditMode,
              index: idx,
              onRemove: handleRemove,
              onSettings: setSettingsWidget
            })
          )
        ),
        isEditMode && showGridOverlay && React.createElement('div', {
          className: 'widgets-grid-overlay',
          style: { '--overlay-rows': overlayRows }
        },
          Array.from({ length: overlayRows * 4 }, (_, i) =>
            React.createElement('div', {
              className: 'widgets-grid-overlay__cell',
              key: i
            }, React.createElement('span', { className: 'widgets-grid-overlay__num' }, i + 1))
          )
        )
      ),

      // Modals
      React.createElement(CatalogModal, {
        isOpen: catalogOpen,
        onClose: () => setCatalogOpen(false),
        onSelect: handleCatalogSelect,
        existingTypes: new Set((widgets || []).map(w => w.type))
      }),
      React.createElement(SettingsModal, {
        widget: settingsWidget,
        isOpen: !!settingsWidget,
        onClose: () => setSettingsWidget(null),
        onSave: handleSettingsSave
      }),

      // === Fixed bottom edit controls (–¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤) ===
      React.createElement('div', { className: 'widgets-edit-controls' },
        // –ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å/–≤–µ—Ä–Ω—É—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ edit mode
        isEditMode && React.createElement('div', { className: 'widgets-edit-controls__actions' },
          React.createElement('button', {
            id: 'tour-widgets-add',
            className: 'widgets-header__btn widgets-header__btn--add',
            onClick: () => setCatalogOpen(true)
          }, '+ –î–æ–±–∞–≤–∏—Ç—å'),
          React.createElement('button', {
            className: `widgets-header__btn widgets-header__btn--undo ${!historyInfo.canUndo ? 'disabled' : ''}`,
            onClick: handleUndo,
            disabled: !historyInfo.canUndo,
            title: '–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)'
          }, '‚Ü©'),
          React.createElement('button', {
            className: `widgets-header__btn widgets-header__btn--redo ${!historyInfo.canRedo ? 'disabled' : ''}`,
            onClick: handleRedo,
            disabled: !historyInfo.canRedo,
            title: '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Ctrl+Shift+Z)'
          }, '‚Ü™'),
          React.createElement('button', {
            className: `widgets-header__btn widgets-header__btn--grid ${showGridOverlay ? 'active' : ''}`,
            onClick: () => setShowGridOverlay(prev => !prev),
            title: '–ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é —è—á–µ–µ–∫ —Å–µ—Ç–∫–∏'
          }, '‚äû')
        ),
        // FAB –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞ desktop)
        !isMobile && React.createElement('button', {
          id: 'tour-widgets-edit',
          className: `widgets-edit-controls__fab ${isEditMode ? 'active' : ''}`,
          onClick: toggleEdit
        }, isEditMode ? '‚úì –ì–æ—Ç–æ–≤–æ' : '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å')
      ),

      // === FABs (mobile) ===
      isMobile && React.createElement(React.Fragment, null,
        // Edit FAB ‚Äî —Å–Ω–∏–∑—É —Å–ª–µ–≤–∞
        React.createElement('div', { className: 'widgets-fab-left' },
          React.createElement('button', {
            id: 'tour-widgets-edit', // ID –¥–ª—è onboarding —Ç—É—Ä–∞
            className: `widgets-edit-fab ${isEditMode ? 'active' : ''}`,
            onClick: toggleEdit,
            'aria-label': isEditMode ? '–ì–æ—Ç–æ–≤–æ' : '–ò–∑–º–µ–Ω–∏—Ç—å'
          }, isEditMode ? '‚úì' : '‚úèÔ∏è')
        ),

        // Meal/Water FAB group ‚Äî –∫–∞–∫ –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö (—Å–ø—Ä–∞–≤–∞).
        // –í edit-mode –ø—Ä—è—á–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—é.
        !isEditMode && React.createElement('div', { className: 'fab-group' },
          React.createElement('button', {
            className: 'meal-fab',
            onClick: () => goToDayAndRun('diary', 'addMeal', []),
            'aria-label': '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏'
          }, 'üçΩÔ∏è'),
          React.createElement('button', {
            className: 'water-fab',
            onClick: () => handleAddWater(200),
            'aria-label': '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã'
          }, 'ü•õ'),
          // üíß –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–¥—ã
          waterAnim && React.createElement('div', {
            className: 'water-fab-anim',
            key: Date.now() // Force re-render for animation
          }, waterAnim)
        )
      )
    );
  }

  // === Exports ===
  HEYS.Widgets.WidgetsTab = WidgetsTab;
  HEYS.Widgets.WidgetCard = WidgetCard;
  HEYS.Widgets.CatalogModal = CatalogModal;
  HEYS.Widgets.SettingsModal = SettingsModal;

  if (widgetsDebugEnabled() && widgetsOnce('widgets_ui_loaded')) {
    trackWidgetIssue('widgets_ui_loaded', { version: '1.1.0' });
  }

})(typeof window !== 'undefined' ? window : global);
