
/* ===== heys_dev_utils.js ===== */
// üÜï PERF v9.2: –ú–µ—Ç–∫–∞ –º–æ–º–µ–Ω—Ç–∞ –∫–æ–≥–¥–∞ boot-core –Ω–∞—á–∞–ª –∏—Å–ø–æ–ª–Ω—è—Ç—å—Å—è
window.__heysPerfMark && window.__heysPerfMark('boot-core: execute start');

/**
 * HEYS Development Utils v1.1
 * =============================
 * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ development/production —Ä–µ–∂–∏–º–∞—Ö
 * 
 * üîá v4.7.0: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–æ–≥–∏ –û–¢–ö–õ–Æ–ß–ï–ù–´ –¥–∞–∂–µ –Ω–∞ localhost
 *            –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è: DEV.enable() –∏–ª–∏ ?debug=verbose –≤ URL
 */

(function () {
  'use strict';

  // üîá v4.7.0: –õ–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–Ω—Å–æ–ª–∏
  // –í–∫–ª—é—á–∏—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑:
  // 1. URL –ø–∞—Ä–∞–º–µ—Ç—Ä: ?debug=verbose
  // 2. –í –∫–æ–Ω—Å–æ–ª–∏: DEV.enable()
  // 3. localStorage: localStorage.setItem('heys_debug_verbose', 'true')
  const forceVerbose = location.search.includes('debug=verbose') ||
    localStorage.getItem('heys_debug_verbose') === 'true';

  let isVerbose = forceVerbose;

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ window.DEV
  window.DEV = {
    /**
     * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º verbose —Ä–µ–∂–∏–º–µ
     * @param {...any} args - –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è console.log
     */
    log: function (...args) {
      if (isVerbose) {
        console.log(...args);
      }
    },

    /**
     * –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º verbose —Ä–µ–∂–∏–º–µ
     * @param {...any} args - –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è console.warn
     */
    warn: function (...args) {
      if (isVerbose) {
        console.warn(...args);
      }
    },

    /**
     * –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º verbose —Ä–µ–∂–∏–º–µ
     * @param {...any} args - –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è console.info
     */
    info: function (...args) {
      if (isVerbose) {
        console.info(...args);
      }
    },

    /**
     * Debug —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º verbose —Ä–µ–∂–∏–º–µ
     * @param {...any} args - –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è console.debug
     */
    debug: function (...args) {
      if (isVerbose) {
        console.debug(...args);
      }
    },

    /**
     * –í–∫–ª—é—á–∏—Ç—å verbose –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
     */
    enable: function () {
      isVerbose = true;
      localStorage.setItem('heys_debug_verbose', 'true');
      console.log('üîä DEV logging ENABLED. Reload to see all logs.');
    },

    /**
     * –í—ã–∫–ª—é—á–∏—Ç—å verbose –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
     */
    disable: function () {
      isVerbose = false;
      localStorage.removeItem('heys_debug_verbose');
      console.log('üîá DEV logging DISABLED.');
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ verbose
     * @returns {boolean} true –µ—Å–ª–∏ verbose —Ä–µ–∂–∏–º
     */
    isVerbose: function () {
      return isVerbose;
    }
  };

  // –ê–ª–∏–∞—Å –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
  window.devLog = window.DEV.log;
  window.devWarn = window.DEV.warn;
})();


/* ===== heys_feature_flags_v1.js ===== */
/**
 * HEYS Feature Flags v1.0
 * =======================
 * –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è feature flags –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π
 * 
 * –ü–∞—Ç—Ç–µ—Ä–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
 *   HEYS.featureFlags.isEnabled('newModularApp') // boolean
 *   HEYS.featureFlags.enable('newModularApp')
 *   HEYS.featureFlags.disable('newModularApp')
 * 
 * –ù–∞—É—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞: Feature Toggles (Martin Fowler 2017)
 */

(function () {
  'use strict';

  const HEYS = window.HEYS = window.HEYS || {};
  const devLog = (...args) => window.DEV?.log?.(...args);
  const devWarn = (...args) => window.DEV?.warn?.(...args);

  // Storage key –¥–ª—è —Ñ–ª–∞–≥–æ–≤
  const FLAGS_KEY = 'heys_feature_flags';

  // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤
  const DEFAULT_FLAGS = {
    // === App Refactoring Flags ===
    'modular_platform_apis': false,     // –ù–æ–≤—ã–π –º–æ–¥—É–ª—å Platform APIs
    'modular_pwa': false,               // –ù–æ–≤—ã–π –º–æ–¥—É–ª—å PWA
    'modular_auth': false,              // –ù–æ–≤—ã–π –º–æ–¥—É–ª—å Auth Integration
    'modular_navigation': false,        // –ù–æ–≤—ã–π –º–æ–¥—É–ª—å Navigation
    'modular_sync': false,              // –ù–æ–≤—ã–π –º–æ–¥—É–ª—å Sync State Machine
    'modular_bootstrap': false,         // –ù–æ–≤—ã–π –º–æ–¥—É–ª—å Bootstrap (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)

    // === –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ===
    'dev_module_logging': false,        // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
    'dev_performance_tracking': false,  // –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π

    // === Rollback —Ñ–ª–∞–≥ ===
    'use_legacy_monolith': false,       // true = —Å—Ç–∞—Ä—ã–π –∫–æ–¥, false = –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
  };

  /**
   * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–ª–∞–≥–∏ –∏–∑ localStorage
   * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ñ–ª–∞–≥–∞–º–∏
   */
  function loadFlags() {
    try {
      const stored = localStorage.getItem(FLAGS_KEY);
      if (!stored) return { ...DEFAULT_FLAGS };

      const parsed = JSON.parse(stored);
      // –ú–µ—Ä–∂–∏–º —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –Ω–∞ —Å–ª—É—á–∞–π –Ω–æ–≤—ã—Ö —Ñ–ª–∞–≥–æ–≤
      return { ...DEFAULT_FLAGS, ...parsed };
    } catch (e) {
      devWarn('[FeatureFlags] Failed to load flags:', e);
      return { ...DEFAULT_FLAGS };
    }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥–∏ –≤ localStorage
   * @param {Object} flags - –û–±—ä–µ–∫—Ç —Å —Ñ–ª–∞–≥–∞–º–∏
   */
  function saveFlags(flags) {
    try {
      localStorage.setItem(FLAGS_KEY, JSON.stringify(flags));
    } catch (e) {
      devWarn('[FeatureFlags] Failed to save flags:', e);
    }
  }

  // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤
  let currentFlags = loadFlags();

  /**
   * Feature Flags API
   */
  HEYS.featureFlags = {
    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–∫–ª—é—á–µ–Ω –ª–∏ —Ñ–ª–∞–≥
     * @param {string} flagName - –ò–º—è —Ñ–ª–∞–≥–∞
     * @returns {boolean} true –µ—Å–ª–∏ —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω
     */
    isEnabled(flagName) {
      return currentFlags[flagName] === true;
    },

    /**
     * –í–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥
     * @param {string} flagName - –ò–º—è —Ñ–ª–∞–≥–∞
     */
    enable(flagName) {
      if (!(flagName in DEFAULT_FLAGS)) {
        devWarn(`[FeatureFlags] Unknown flag: ${flagName}`);
        return;
      }
      currentFlags[flagName] = true;
      saveFlags(currentFlags);
      devLog(`[FeatureFlags] Enabled: ${flagName}`);
    },

    /**
     * –í—ã–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥
     * @param {string} flagName - –ò–º—è —Ñ–ª–∞–≥–∞
     */
    disable(flagName) {
      if (!(flagName in DEFAULT_FLAGS)) {
        devWarn(`[FeatureFlags] Unknown flag: ${flagName}`);
        return;
      }
      currentFlags[flagName] = false;
      saveFlags(currentFlags);
      devLog(`[FeatureFlags] Disabled: ${flagName}`);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ñ–ª–∞–≥–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
     * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤
     */
    getAll() {
      return { ...currentFlags };
    },

    /**
     * –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–ª–∞–≥–∏ –∫ –¥–µ—Ñ–æ–ª—Ç–∞–º
     */
    reset() {
      currentFlags = { ...DEFAULT_FLAGS };
      saveFlags(currentFlags);
      devLog('[FeatureFlags] Reset to defaults');
    },

    /**
     * –í–∫–ª—é—á–∏—Ç—å –≤—Å–µ –º–æ–¥—É–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞)
     */
    enableAllModules() {
      currentFlags.modular_platform_apis = true;
      currentFlags.modular_pwa = true;
      currentFlags.modular_auth = true;
      currentFlags.modular_navigation = true;
      currentFlags.modular_sync = true;
      currentFlags.modular_bootstrap = true;
      currentFlags.use_legacy_monolith = false;
      saveFlags(currentFlags);
      devLog('[FeatureFlags] Enabled all modules');
    },

    /**
     * –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ legacy –º–æ–Ω–æ–ª–∏—Ç—É (–æ—Ç–∫–∞—Ç)
     */
    rollbackToLegacy() {
      currentFlags.modular_platform_apis = false;
      currentFlags.modular_pwa = false;
      currentFlags.modular_auth = false;
      currentFlags.modular_navigation = false;
      currentFlags.modular_sync = false;
      currentFlags.modular_bootstrap = false;
      currentFlags.use_legacy_monolith = true;
      saveFlags(currentFlags);
      devLog('[FeatureFlags] Rolled back to legacy monolith');
    },

    /**
     * –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π (—Ñ–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π rollout)
     * @param {number} phase - –ù–æ–º–µ—Ä —Ñ–∞–∑—ã (1-6)
     */
    enablePhase(phase) {
      // –§–∞–∑–∞ 1: Platform APIs
      if (phase >= 1) {
        currentFlags.modular_platform_apis = true;
      }
      // –§–∞–∑–∞ 2: PWA
      if (phase >= 2) {
        currentFlags.modular_pwa = true;
      }
      // –§–∞–∑–∞ 3: Bootstrap (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
      if (phase >= 3) {
        currentFlags.modular_bootstrap = true;
      }
      // –§–∞–∑–∞ 4: Auth
      if (phase >= 4) {
        currentFlags.modular_auth = true;
      }
      // –§–∞–∑–∞ 5: Navigation
      if (phase >= 5) {
        currentFlags.modular_navigation = true;
      }
      // –§–∞–∑–∞ 6: Sync + –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ legacy
      if (phase >= 6) {
        currentFlags.modular_sync = true;
        currentFlags.use_legacy_monolith = false;
      }

      saveFlags(currentFlags);
      devLog(`[FeatureFlags] Enabled phase ${phase}`);
    }
  };

  // –ê–ª–∏–∞—Å –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
  HEYS.flags = HEYS.featureFlags;

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ)
  if (window.DEV?.isDev?.()) {
    devLog('[FeatureFlags] Initialized with flags:', currentFlags);
  }
})();


/* ===== heys_module_perf_v1.js ===== */
/**
 * HEYS Module Performance Tracker v1.0
 * =====================================
 * –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª–µ–π
 * 
 * –ü–∞—Ç—Ç–µ—Ä–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
 *   HEYS.modulePerf.startLoad('module_name')
 *   HEYS.modulePerf.endLoad('module_name')
 *   HEYS.modulePerf.getReport() // –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç
 * 
 * –ù–∞—É—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞: User-centric Performance Metrics (Google Web Vitals)
 */

(function () {
  'use strict';

  const HEYS = window.HEYS = window.HEYS || {};
  const devLog = (...args) => window.DEV?.log?.(...args);
  const devWarn = (...args) => window.DEV?.warn?.(...args);

  // Storage –¥–ª—è –º–µ—Ç—Ä–∏–∫
  const PERF_KEY = 'heys_module_perf';
  const PERF_HISTORY_LIMIT = 10; // —Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–≥—Ä—É–∑–æ–∫

  // –¢–µ–∫—É—â–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–≤ –ø–∞–º—è—Ç–∏)
  const measurements = new Map();

  const readStoredValue = (key, fallback = null) => {
    let value;
    if (HEYS.store?.get) {
      value = HEYS.store.get(key, fallback);
    } else if (HEYS.utils?.lsGet) {
      value = HEYS.utils.lsGet(key, fallback);
    } else {
      try {
        value = localStorage.getItem(key);
      } catch (e) {
        return fallback;
      }
    }

    if (value == null) return fallback;

    if (typeof value === 'string') {
      if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try {
          value = HEYS.store.decompress(value.slice(3));
        } catch (e) { }
      }
      try {
        return JSON.parse(value);
      } catch (e) {
        return value;
      }
    }

    return value;
  };

  const writeStoredValue = (key, value) => {
    if (HEYS.store?.set) {
      return HEYS.store.set(key, value);
    }
    if (HEYS.utils?.lsSet) {
      return HEYS.utils.lsSet(key, value);
    }
    localStorage.setItem(key, JSON.stringify(value));
  };

  // –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ (–≤ localStorage)
  let perfHistory = loadHistory();

  /**
   * –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage
   * @returns {Array} –ú–∞—Å—Å–∏–≤ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∑–∞–≥—Ä—É–∑–æ–∫
   */
  function loadHistory() {
    try {
      return readStoredValue(PERF_KEY, []);
    } catch (e) {
      devWarn('[ModulePerf] Failed to load history:', e);
      return [];
    }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ localStorage
   */
  function saveHistory() {
    try {
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
      const limited = perfHistory.slice(-PERF_HISTORY_LIMIT);
      writeStoredValue(PERF_KEY, limited);
    } catch (e) {
      devWarn('[ModulePerf] Failed to save history:', e);
    }
  }

  /**
   * Module Performance API
   */
  HEYS.modulePerf = {
    /**
     * –ù–∞—á–∞—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
     * @param {string} moduleName - –ò–º—è –º–æ–¥—É–ª—è
     */
    startLoad(moduleName) {
      if (!performance || !performance.now) {
        devWarn('[ModulePerf] Performance API not available');
        return;
      }

      measurements.set(moduleName, {
        name: moduleName,
        startTime: performance.now(),
        startTimestamp: Date.now(),
        endTime: null,
        duration: null,
        success: null,
        error: null
      });

      if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
        devLog(`[ModulePerf] üì¶ Loading: ${moduleName}`);
      }
    },

    /**
     * –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
     * @param {string} moduleName - –ò–º—è –º–æ–¥—É–ª—è
     * @param {boolean} success - –£—Å–ø–µ—à–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω
     * @param {Error} error - –û—à–∏–±–∫–∞ (–µ—Å–ª–∏ –±—ã–ª–∞)
     */
    endLoad(moduleName, success = true, error = null) {
      const measurement = measurements.get(moduleName);
      if (!measurement) {
        devWarn(`[ModulePerf] No start measurement for: ${moduleName}`);
        return;
      }

      const endTime = performance.now();
      measurement.endTime = endTime;
      measurement.duration = endTime - measurement.startTime;
      measurement.success = success;
      measurement.error = error ? error.message : null;

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
      perfHistory.push({ ...measurement });
      saveHistory();

      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      const emoji = success ? '‚úÖ' : '‚ùå';
      const duration = measurement.duration.toFixed(2);

      if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
        devLog(`[ModulePerf] ${emoji} ${moduleName}: ${duration}ms`);
      }

      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–µ–¥–ª–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ (>500ms)
      if (success && measurement.duration > 500) {
        devWarn(`[ModulePerf] ‚ö†Ô∏è Slow load: ${moduleName} took ${duration}ms`);
      }

      // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π
      measurements.delete(moduleName);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
     * @returns {Object} –û–±—ä–µ–∫—Ç —Å –æ—Ç—á—ë—Ç–æ–º
     */
    getReport() {
      const history = [...perfHistory];

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–æ–¥—É–ª—è–º
      const byModule = {};
      history.forEach(m => {
        if (!byModule[m.name]) {
          byModule[m.name] = [];
        }
        byModule[m.name].push(m);
      });

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –º–æ–¥—É–ª—é
      const stats = {};
      Object.keys(byModule).forEach(name => {
        const loads = byModule[name];
        const durations = loads.filter(l => l.success).map(l => l.duration);

        stats[name] = {
          totalLoads: loads.length,
          successfulLoads: loads.filter(l => l.success).length,
          failedLoads: loads.filter(l => !l.success).length,
          avgDuration: durations.length > 0
            ? (durations.reduce((a, b) => a + b, 0) / durations.length).toFixed(2)
            : null,
          minDuration: durations.length > 0 ? Math.min(...durations).toFixed(2) : null,
          maxDuration: durations.length > 0 ? Math.max(...durations).toFixed(2) : null,
          lastLoad: loads[loads.length - 1]
        };
      });

      return {
        totalModules: Object.keys(stats).length,
        stats,
        rawHistory: history
      };
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º—ã–π –æ—Ç—á—ë—Ç –≤ –∫–æ–Ω—Å–æ–ª—å
     */
    printReport() {
      const report = this.getReport();
      devLog('[ModulePerf] Performance Report', report);
    },

    /**
     * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
     */
    clearHistory() {
      perfHistory = [];
      saveHistory();
      devLog('[ModulePerf] History cleared');
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π
     * @returns {Array} –ú–∞—Å—Å–∏–≤ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏
     */
    getActiveMeasurements() {
      return Array.from(measurements.values());
    },

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
     * @returns {string} JSON —Å—Ç—Ä–æ–∫–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
     */
    export() {
      const report = this.getReport();
      const data = {
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        ...report
      };
      return JSON.stringify(data, null, 2);
    }
  };

  // –ê–ª–∏–∞—Å –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
  HEYS.perf = HEYS.modulePerf;

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  if (window.DEV?.isDev?.()) {
    devLog('[ModulePerf] Initialized');
  }
})();


/* ===== heys_module_loader_v1.js ===== */
/**
 * HEYS Module Loader v1.0
 * =======================
 * –°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π feature flags –∏ rollback
 * 
 * –ü–∞—Ç—Ç–µ—Ä–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
 *   await HEYS.moduleLoader.load('module_name', 'path/to/module.js')
 *   HEYS.moduleLoader.getStatus('module_name')
 *   await HEYS.moduleLoader.loadAll(moduleList)
 * 
 * –ù–∞—É—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞: Progressive Enhancement (Aaron Gustafson 2008)
 */

(function () {
  'use strict';

  const HEYS = window.HEYS = window.HEYS || {};
  const devLog = (...args) => window.DEV?.log?.(...args);
  const devWarn = (...args) => window.DEV?.warn?.(...args);
  const trackError = (err, context) => HEYS.analytics?.trackError?.(err, context);

  // –°—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π
  const MODULE_STATUS = {
    PENDING: 'pending',
    LOADING: 'loading',
    LOADED: 'loaded',
    ERROR: 'error',
    SKIPPED: 'skipped'
  };

  // –†–µ–µ—Å—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
  const loadedModules = new Map();

  // –†–µ–µ—Å—Ç—Ä –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  const manifests = new Map();

  const trackModuleError = (err, context) => {
    trackError(err, context);
  };

  /**
   * Module Loader API
   */
  HEYS.moduleLoader = {
    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å
     * @param {string} moduleName - –ò–º—è –º–æ–¥—É–ª—è
     * @param {string} modulePath - –ü—É—Ç—å –∫ –º–æ–¥—É–ª—é
     * @param {Object} options - –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
     * @returns {Promise<boolean>} true –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω
     */
    async load(moduleName, modulePath, options = {}) {
      const {
        required = false,      // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å?
        retry = 2,            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        timeout = 10000,      // –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (–º—Å)
        flagName = null       // Feature flag –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      } = options;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º feature flag –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
      if (flagName && !HEYS.featureFlags?.isEnabled(flagName)) {
        loadedModules.set(moduleName, {
          name: moduleName,
          status: MODULE_STATUS.SKIPPED,
          reason: `Feature flag '${flagName}' is disabled`
        });

        if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
          devLog(`[ModuleLoader] ‚è≠Ô∏è Skipped: ${moduleName} (flag disabled)`);
        }

        return false;
      }

      // –ú–æ–¥—É–ª—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω?
      if (loadedModules.has(moduleName) &&
        loadedModules.get(moduleName).status === MODULE_STATUS.LOADED) {
        if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
          devLog(`[ModuleLoader] ‚ôªÔ∏è Already loaded: ${moduleName}`);
        }
        return true;
      }

      // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      loadedModules.set(moduleName, {
        name: moduleName,
        status: MODULE_STATUS.LOADING,
        startTime: Date.now()
      });

      // –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      HEYS.modulePerf?.startLoad(moduleName);

      // –ü–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å retry
      let lastError = null;
      for (let attempt = 1; attempt <= retry; attempt++) {
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç
          await loadScript(modulePath, timeout);

          // –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω
          loadedModules.set(moduleName, {
            name: moduleName,
            status: MODULE_STATUS.LOADED,
            startTime: loadedModules.get(moduleName).startTime,
            endTime: Date.now(),
            duration: Date.now() - loadedModules.get(moduleName).startTime,
            path: modulePath
          });

          HEYS.modulePerf?.endLoad(moduleName, true);

          // üÜï Heartbeat –¥–ª—è watchdog ‚Äî –º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω, app –µ—â—ë –∂–∏–≤
          if (typeof window !== 'undefined') {
            window.__heysLoadingHeartbeat = Date.now();
          }

          if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
            devLog(`[ModuleLoader] ‚úÖ Loaded: ${moduleName}`);
          }

          return true;

        } catch (error) {
          lastError = error;

          if (attempt < retry) {
            // –ñ–¥—ë–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π (exponential backoff)
            const delay = Math.pow(2, attempt) * 100;
            await new Promise(resolve => setTimeout(resolve, delay));

            if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
              devLog(`[ModuleLoader] üîÑ Retry ${attempt}/${retry}: ${moduleName}`);
            }
          }
        }
      }

      // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã
      loadedModules.set(moduleName, {
        name: moduleName,
        status: MODULE_STATUS.ERROR,
        error: lastError?.message || 'Unknown error',
        path: modulePath
      });

      HEYS.modulePerf?.endLoad(moduleName, false, lastError);

      const errorMsg = `Failed to load ${moduleName}: ${lastError?.message}`;

      if (required) {
        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å ‚Äî –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É
        trackError(lastError || new Error(errorMsg), { source: 'heys_module_loader_v1.js', moduleName, required: true });
        devWarn(`[ModuleLoader] ‚ùå ${errorMsg}`);
        throw new Error(errorMsg);
      } else {
        // –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        devWarn(`[ModuleLoader] ‚ö†Ô∏è ${errorMsg}`);
        return false;
      }
    },

    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥—É–ª–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
     * @param {Array} modules - –ú–∞—Å—Å–∏–≤ –º–æ–¥—É–ª–µ–π [{name, path, options}]
     * @returns {Promise<Object>} –û–±—ä–µ–∫—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
     */
    async loadAll(modules) {
      const results = await Promise.allSettled(
        modules.map(m => this.load(m.name, m.path, m.options || {}))
      );

      const summary = {
        total: modules.length,
        loaded: 0,
        failed: 0,
        skipped: 0
      };

      results.forEach((result, index) => {
        const module = modules[index];
        const status = loadedModules.get(module.name)?.status;

        if (status === MODULE_STATUS.LOADED) summary.loaded++;
        else if (status === MODULE_STATUS.ERROR) summary.failed++;
        else if (status === MODULE_STATUS.SKIPPED) summary.skipped++;
      });

      if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
        devLog('[ModuleLoader] Batch load complete:', summary);
      }

      return summary;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è
     * @param {string} moduleName - –ò–º—è –º–æ–¥—É–ª—è
     * @returns {Object|null} –û–±—ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∏–ª–∏ null
     */
    getStatus(moduleName) {
      return loadedModules.get(moduleName) || null;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
     * @returns {Array} –ú–∞—Å—Å–∏–≤ —Å –º–æ–¥—É–ª—è–º–∏
     */
    getAllModules() {
      return Array.from(loadedModules.values());
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ –º–æ–¥—É–ª—å
     * @param {string} moduleName - –ò–º—è –º–æ–¥—É–ª—è
     * @returns {boolean} true –µ—Å–ª–∏ –º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω
     */
    isLoaded(moduleName) {
      const status = loadedModules.get(moduleName)?.status;
      return status === MODULE_STATUS.LOADED;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç –æ –∑–∞–≥—Ä—É–∑–∫–µ
     */
    getReport() {
      const modules = this.getAllModules();

      return {
        total: modules.length,
        loaded: modules.filter(m => m.status === MODULE_STATUS.LOADED).length,
        failed: modules.filter(m => m.status === MODULE_STATUS.ERROR).length,
        skipped: modules.filter(m => m.status === MODULE_STATUS.SKIPPED).length,
        modules
      };
    },

    /**
     * –í—ã–≤–µ—Å—Ç–∏ –æ—Ç—á—ë—Ç –≤ –∫–æ–Ω—Å–æ–ª—å
     */
    printReport() {
      const report = this.getReport();

      devLog('[ModuleLoader] Load Report', {
        total: report.total,
        loaded: report.loaded,
        failed: report.failed,
        skipped: report.skipped,
        modules: report.modules
      });
    }
    ,
    /**
     * –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
     * @param {string} name
     * @param {Array<{id:string,test:Function,required?:boolean}>} entries
     */
    setManifest(name, entries = []) {
      if (!name || !Array.isArray(entries)) return false;
      manifests.set(name, {
        name,
        entries: entries.filter((e) => e && typeof e.test === 'function' && e.id)
      });
      return true;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç
     * @param {string} name
     */
    getManifest(name) {
      return manifests.get(name) || null;
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
     * @param {string} name
     * @param {Object} options
     * @returns {{ok:boolean, missing:string[]}}
     */
    checkManifest(name, options = {}) {
      const manifest = manifests.get(name);
      if (!manifest) {
        const missing = [`manifest:${name}`];
        if (!options.silent) {
          trackModuleError(new Error('Missing manifest'), {
            source: 'heys_module_loader_v1.js',
            type: 'missing_manifest',
            missing
          });
        }
        return { ok: false, missing };
      }

      const missing = [];
      manifest.entries.forEach((entry) => {
        if (entry.required === false) return;
        let ok = false;
        try {
          ok = !!entry.test();
        } catch (e) {
          ok = false;
        }
        if (!ok) missing.push(entry.id);
      });

      if (missing.length > 0 && !options.silent) {
        trackModuleError(new Error('Missing manifest dependencies'), {
          source: 'heys_module_loader_v1.js',
          type: 'missing_manifest_deps',
          manifest: manifest.name,
          missing
        });
        return { ok: false, missing };
      }

      return { ok: true, missing: [] };
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö day-–º–æ–¥—É–ª–µ–π
     * @returns {{ok:boolean, missing:string[]}}
     */
    checkDayDeps() {
      if (this.checkManifest) {
        return this.checkManifest('day');
      }
      const missing = [];

      if (!HEYS.dayUtils) missing.push('HEYS.dayUtils');
      if (!HEYS.dayHooks) missing.push('HEYS.dayHooks');
      if (!HEYS.dayPopups) missing.push('HEYS.dayPopups');
      if (!HEYS.dayGallery) missing.push('HEYS.dayGallery');
      if (!HEYS.mealScoring) missing.push('HEYS.mealScoring');

      if (!HEYS.dayComponents?.MealAddProduct) missing.push('HEYS.dayComponents.MealAddProduct');
      if (!HEYS.dayComponents?.ProductRow) missing.push('HEYS.dayComponents.ProductRow');
      if (!HEYS.dayComponents?.MealCard) missing.push('HEYS.dayComponents.MealCard');
      if (!HEYS.dayComponents?.AdviceCard) missing.push('HEYS.dayComponents.AdviceCard');

      if (!HEYS.dayMealsDisplay) missing.push('HEYS.dayMealsDisplay');
      if (!HEYS.dayMealsList) missing.push('HEYS.dayMealsList');

      if (missing.length > 0) {
        trackModuleError(new Error('Missing day module dependencies'), {
          source: 'heys_module_loader_v1.js',
          type: 'missing_day_deps',
          missing
        });
        return { ok: false, missing };
      }

      return { ok: true, missing: [] };
    }
  };

  HEYS.moduleLoader.setManifest('day', [
    { id: 'HEYS.dayUtils', test: () => !!HEYS.dayUtils },
    { id: 'HEYS.dayHooks', test: () => !!HEYS.dayHooks },
    { id: 'HEYS.dayPopups', test: () => !!HEYS.dayPopups },
    { id: 'HEYS.dayGallery', test: () => !!HEYS.dayGallery },
    { id: 'HEYS.mealScoring', test: () => !!HEYS.mealScoring },
    { id: 'HEYS.dayComponents.MealAddProduct', test: () => !!HEYS.dayComponents?.MealAddProduct },
    { id: 'HEYS.dayComponents.ProductRow', test: () => !!HEYS.dayComponents?.ProductRow },
    { id: 'HEYS.dayComponents.MealCard', test: () => !!HEYS.dayComponents?.MealCard },
    { id: 'HEYS.dayComponents.AdviceCard', test: () => !!HEYS.dayComponents?.AdviceCard },
    { id: 'HEYS.dayMealsDisplay', test: () => !!HEYS.dayMealsDisplay },
    { id: 'HEYS.dayMealsList', test: () => !!HEYS.dayMealsList }
  ]);

  /**
   * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º
   * @param {string} src - –ü—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É
   * @param {number} timeout - –¢–∞–π–º–∞—É—Ç (–º—Å)
   * @returns {Promise<void>}
   */
  function loadScript(src, timeout) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.defer = true;

      // –¢–∞–π–º–∞—É—Ç
      const timeoutId = setTimeout(() => {
        script.remove();
        reject(new Error(`Timeout loading ${src}`));
      }, timeout);

      script.onload = () => {
        clearTimeout(timeoutId);
        resolve();
      };

      script.onerror = () => {
        clearTimeout(timeoutId);
        script.remove();
        reject(new Error(`Failed to load ${src}`));
      };

      document.head.appendChild(script);
    });
  }

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  if (window.DEV?.isDev?.()) {
    devLog('[ModuleLoader] Initialized');
  }
})();


/* ===== heys_bootstrap_v1.js ===== */
/**
 * HEYS App Initialization (Bootstrap) v1.0
 * =========================================
 * Application initialization utilities and dependency management
 * 
 * Features:
 * - Dependency waiting and detection
 * - React and HEYS core readiness checks
 * - Initialization retry logic with exponential backoff
 * - Loading UI management
 * - Error handling and timeout protection
 * - Client authorization utilities
 * - Curator session detection
 * 
 * Scientific Foundation:
 * - Progressive Enhancement (Aaron Gustafson, 2008)
 * - Defensive Programming
 * - Circuit Breaker Pattern (Michael Nygard)
 * 
 * @version 1.0.0
 * @feature-flag modular_bootstrap
 */

(function () {
  'use strict';

  const HEYS = window.HEYS = window.HEYS || {};

  // üÜï Heartbeat –¥–ª—è watchdog ‚Äî bootstrap –∑–∞–≥—Ä—É–∂–µ–Ω
  window.__heysLoadingHeartbeat = Date.now();

  // Default feature flags (safe, local-only)
  HEYS.features = HEYS.features || {
    unifiedTables: true,
    extendedNutrients: true
  };

  // Check feature flag - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è legacy mode, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–æ–¥—É–ª—å
  if (HEYS.featureFlags?.isEnabled('use_legacy_monolith')) {
    if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
      console.log('[Bootstrap] ‚è≠Ô∏è Skipped (legacy monolith mode)');
    }
    return;
  }

  // Performance tracking start
  HEYS.modulePerf?.startLoad('bootstrap');

  if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
    console.log('[Bootstrap] üì¶ Loading module...');
  }

  // ============================================================================
  // CONSTANTS
  // ============================================================================

  const INIT_RETRY_DELAY = 100; // ms between dependency checks
  const MAX_INIT_RETRIES = 50; // max 50 retries = 5 seconds

  let reactCheckCount = 0;

  // ==========================================================================
  // STORAGE HELPERS (store-first + ¬§Z¬§)
  // ==========================================================================

  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const readGlobalValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      const raw = localStorage.getItem(key);
      if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
      return fallback;
    } catch {
      return fallback;
    }
  };

  // ============================================================================
  // DEPENDENCY DETECTION
  // ============================================================================

  /**
   * Check if React is loaded and ready
   * @returns {boolean} true if React and ReactDOM are available
   */
  function isReactReady() {
    return !!(window.React && window.ReactDOM);
  }

  /**
   * Check if HEYS core modules are ready
   * @returns {boolean} true if required HEYS modules are loaded
   */
  function isHeysReady() {
    return !!(
      window.HEYS &&
      window.HEYS.core &&
      window.HEYS.store &&
      window.HEYS.YandexAPI
    );
  }

  // ============================================================================
  // LOADING UI
  // ============================================================================

  /**
   * Show minimal loading spinner
   */
  function showInitLoader() {
    if (document.getElementById('heys-init-loader')) return;

    const bootLog = (msg) => window.__heysLog && window.__heysLog('[DEPS] ' + msg);
    bootLog('showing loader (waiting for deps)');

    const loader = document.createElement('div');
    loader.id = 'heys-init-loader';
    loader.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:99999';
    loader.innerHTML = '<div style="width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#10b981;border-radius:50%;animation:spin 0.8s linear infinite"></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
    document.body.appendChild(loader);
  }

  /**
   * Hide loading spinner
   */
  function hideInitLoader() {
    document.getElementById('heys-init-loader')?.remove();
  }

  /**
   * Show error message when initialization fails
   */
  function showInitError() {
    hideInitLoader();
    document.body.innerHTML = '<div style="padding:40px;text-align:center;font-family:system-ui"><h1>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h1><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p><button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:#10b981;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer">–û–±–Ω–æ–≤–∏—Ç—å</button></div>';
  }

  // ============================================================================
  // DEPENDENCY WAITING
  // ============================================================================

  /**
   * Wait for dependencies with retry logic
   * @param {Function} onReady - Callback to execute when ready
   */
  function waitForDependencies(onReady) {
    const bootLog = (msg) => window.__heysLog && window.__heysLog('[DEPS] ' + msg);

    // Show loader after 200ms (2 checks)
    if (reactCheckCount === 2) {
      showInitLoader();
    }

    // Check if all dependencies are ready
    if (isReactReady() && isHeysReady()) {
      bootLog('deps ready, init app');
      hideInitLoader();
      reactCheckCount = 0; // Reset counter
      onReady();
      return;
    }

    reactCheckCount++;
    bootLog('waiting #' + reactCheckCount + ' React:' + isReactReady() + ' HEYS:' + isHeysReady());

    // Timeout protection - max 50 attempts (5 seconds)
    if (reactCheckCount > MAX_INIT_RETRIES) {
      console.error('[Bootstrap] ‚ùå Timeout waiting for dependencies!');
      console.error('[Bootstrap] React ready:', isReactReady());
      console.error('[Bootstrap] HEYS ready:', isHeysReady());
      bootLog('TIMEOUT! React:' + isReactReady() + ' HEYS:' + isHeysReady());

      showInitError();
      return;
    }

    // Retry after delay
    setTimeout(() => waitForDependencies(onReady), INIT_RETRY_DELAY);
  }

  // ============================================================================
  // AUTHORIZATION UTILITIES
  // ============================================================================

  /**
   * Check if current session is curator (vs client)
   * @returns {boolean} true if curator session
   */
  function isCuratorSession() {
    if (HEYS.auth?.isCuratorSession) return HEYS.auth.isCuratorSession();
    const curatorSession = readGlobalValue('heys_curator_session', null);
    if (curatorSession && curatorSession.length > 10) return true;
    const legacy = readGlobalValue('heys_supabase_auth_token', null);
    if (legacy?.access_token) return true;
    return !!HEYS.cloud?.getUser?.();
  }

  /**
   * Check if user is authorized as CLIENT (not curator, not guest)
   * @returns {boolean} true if client is authorized
   */
  function isClientAuthorized() {
    let clientId = null;

    // 1. Try heys_pin_auth_client first (for PIN auth)
    const pinAuthClient = readGlobalValue('heys_pin_auth_client', null);
    if (pinAuthClient && pinAuthClient.length > 10) {
      clientId = pinAuthClient;
    }

    // 2. Then try heys_client_current (for curator-managed clients)
    if (!clientId) {
      const raw = readGlobalValue('heys_client_current', null);
      if (raw) clientId = raw;
    }

    const isCurator = isCuratorSession();
    const result = clientId && clientId.length > 10 && !isCurator;

    if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
      console.log('[Bootstrap] isClientAuthorized:', {
        clientId: clientId ? 'present' : 'missing',
        length: clientId?.length,
        isCurator,
        result
      });
    }

    return result;
  }

  // ============================================================================
  // MODULE EXPORTS
  // ============================================================================

  // Export Bootstrap API to HEYS namespace
  HEYS.Bootstrap = {
    // Dependency detection
    isReactReady: isReactReady,
    isHeysReady: isHeysReady,

    // Initialization
    waitForDependencies: waitForDependencies,

    // Authorization
    isCuratorSession: isCuratorSession,
    isClientAuthorized: isClientAuthorized,

    // UI
    showInitLoader: showInitLoader,
    hideInitLoader: hideInitLoader,
    showInitError: showInitError,

    // Constants
    INIT_RETRY_DELAY: INIT_RETRY_DELAY,
    MAX_INIT_RETRIES: MAX_INIT_RETRIES
  };

  // Export to window for backward compatibility
  window.waitForDependencies = waitForDependencies;
  window.isReactReady = isReactReady;
  window.isHeysReady = isHeysReady;
  window.isCuratorSession = isCuratorSession;
  window.isClientAuthorized = isClientAuthorized;

  // Also export to legacy _tour namespace if it exists
  if (window.HEYS._tour) {
    window.HEYS._tour.isCuratorSession = isCuratorSession;
    window.HEYS._tour.isClientAuthorized = isClientAuthorized;
  }

  // Performance tracking end
  HEYS.modulePerf?.endLoad('bootstrap', true);

  if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
    console.log('[Bootstrap] ‚úÖ Module loaded successfully');
  }
})();


/* ===== heys_platform_apis_v1.js ===== */
/**
 * HEYS Platform APIs v1.0
 * =======================
 * Modern Web Platform APIs integration for PWA functionality
 * 
 * Includes 16 Platform APIs:
 * - Service Worker (registration, updates, background sync)
 * - Storage Management (persistent storage, estimates)
 * - Device Capabilities (memory, CPU, network)
 * - Idle Detection (user return detection)
 * - Window Controls Overlay (desktop PWA)
 * - Barcode Detection (product scanning)
 * - Web Share API (content sharing)
 * - Contact Picker API
 * - Speech Recognition API
 * - Launch Handler API
 * - Protocol Handler API
 * - File System Access API
 * - Credential Management API
 * - Screen Orientation API
 * - Fullscreen API
 * - Vibration API
 * - Web Animations API
 * 
 * @version 1.0.0
 * @feature-flag modular_platform_apis
 */

(function () {
  'use strict';

  const HEYS = window.HEYS = window.HEYS || {};
  const DEV = window.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };
  const devWarn = typeof DEV.warn === 'function' ? DEV.warn.bind(DEV) : function () { };
  const devInfo = typeof DEV.info === 'function' ? DEV.info.bind(DEV) : function () { };
  const devDebug = typeof DEV.debug === 'function' ? DEV.debug.bind(DEV) : function () { };
  const trackError = (error, context) => {
    if (!HEYS?.analytics?.trackError) return;
    try {
      const err = error instanceof Error ? error : new Error(String(error || 'PlatformAPIs error'));
      HEYS.analytics.trackError(err, context);
    } catch (_) { }
  };
  const quietConsole = {
    trace: (...args) => { if (window.console && typeof window.console.trace === 'function') window.console.trace(...args); },
    log: (...args) => devLog(...args),
    info: (...args) => devInfo(...args),
    debug: (...args) => devDebug(...args),
    warn: (...args) => devWarn(...args),
    error: (...args) => {
      devWarn(...args);
      trackError(args[0], { scope: 'HEYS.PlatformAPIs', details: args.slice(1) });
    }
  };
  const console = quietConsole;

  // Check feature flag - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è legacy mode, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–æ–¥—É–ª—å
  if (HEYS.featureFlags?.isEnabled('use_legacy_monolith')) {
    if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
      console.log('[PlatformAPIs] ‚è≠Ô∏è Skipped (legacy monolith mode)');
    }
    return;
  }

  // Performance tracking start
  HEYS.modulePerf?.startLoad('platform_apis');

  if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
    console.log('[PlatformAPIs] üì¶ Loading module...');
  }

  // ============================================================================
  // EXTRACTED CODE FROM heys_app_v12.js (lines 481-2057)
  // ============================================================================

  // === Service Worker Registration (Production only) ===
  const UPDATE_BANNER_ID = 'heys-sw-update-banner';
  const OFFLINE_BANNER_ID = 'heys-offline-banner';
  const UPDATE_LOCK_KEY = 'heys_update_in_progress';
  const UPDATE_LOCK_TIMEOUT = 30000;
  const UPDATE_ATTEMPT_KEY = 'heys_update_attempt';
  const MAX_UPDATE_ATTEMPTS = 2;
  const UPDATE_COOLDOWN_MS = 60000;

  let _updateAvailable = false;
  let _updateVersion = null;

  function getAppVersion() {
    return HEYS.version || window.APP_VERSION || 'unknown';
  }

  // === –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π ===
  // –í–µ—Ä—Å–∏—è: YYYY.MM.DD.HHMM.hash ‚Üí —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å
  function isNewerVersion(serverVersion, currentVersion) {
    if (!serverVersion || !currentVersion) return false;
    if (serverVersion === currentVersion) return false;

    const extractNumeric = (v) => {
      const parts = v.split('.');
      if (parts.length < 4) return 0;
      return parseInt(parts.slice(0, 4).join(''), 10) || 0;
    };

    const serverNum = extractNumeric(serverVersion);
    const currentNum = extractNumeric(currentVersion);

    return serverNum > currentNum;
  }

  function isUpdateLocked() {
    try {
      const lockData = localStorage.getItem(UPDATE_LOCK_KEY);
      if (!lockData) return false;
      const { timestamp } = JSON.parse(lockData);
      if (Date.now() - timestamp > UPDATE_LOCK_TIMEOUT) {
        localStorage.removeItem(UPDATE_LOCK_KEY);
        return false;
      }
      return true;
    } catch {
      return false;
    }
  }

  function setUpdateLock() {
    localStorage.setItem(UPDATE_LOCK_KEY, JSON.stringify({ timestamp: Date.now() }));
  }

  function clearUpdateLock() {
    localStorage.removeItem(UPDATE_LOCK_KEY);
  }

  function showUpdateBadge(version) {
    _updateAvailable = true;
    _updateVersion = version;

    document.getElementById('heys-update-badge')?.remove();

    const badge = document.createElement('div');
    badge.id = 'heys-update-badge';
    badge.className = 'heys-update-badge';

    const button = document.createElement('button');
    button.id = 'heys-update-badge-btn';
    button.type = 'button';
    button.className = 'heys-update-badge__btn';
    button.innerHTML = `
      <span class="heys-update-badge__emoji">üÜï</span>
      <span class="heys-update-badge__label">–û–±–Ω–æ–≤–∏—Ç—å HEYS</span>
      <span class="heys-update-badge__version">v${version?.split('.').slice(0, 3).join('.') || 'new'}</span>
    `;
    button.addEventListener('click', () => installUpdate());

    badge.appendChild(button);
    document.body.appendChild(badge);

    if (navigator.vibrate) navigator.vibrate(50);
  }

  function hideUpdateBadge() {
    _updateAvailable = false;
    _updateVersion = null;

    const badge = document.getElementById('heys-update-badge');
    if (badge) {
      badge.classList.add('heys-update-badge--hide');
      setTimeout(() => badge.remove(), 300);
    }
  }

  function getProgressClass(progress) {
    const value = Number(progress) || 0;
    return `heys-update-modal__progress-bar--${value}`;
  }

  function showUpdateModal(stage = 'checking') {
    document.getElementById('heys-update-modal')?.remove();

    const stages = {
      checking: { icon: 'üîç', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π', subtitle: '–ü–æ–¥–æ–∂–¥–∏—Ç–µ...', isSpinner: false },
      found: { icon: 'üÜï', title: '–ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!', subtitle: '–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é...', isSpinner: false },
      downloading: { icon: 'üì•', title: '–ó–∞–≥—Ä—É–∑–∫–∞', subtitle: '–≠—Ç–æ –∑–∞–π–º—ë—Ç –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥...', isSpinner: false },
      installing: { icon: '‚öôÔ∏è', title: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞', subtitle: '–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ...', isSpinner: false },
      ready: { icon: '‚ú®', title: '–ì–æ—Ç–æ–≤–æ!', subtitle: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', isSpinner: false },
      reloading: { icon: 'spinner', title: '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞', subtitle: '–ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...', isSpinner: true }
    };

    const s = stages[stage] || stages.checking;

    const iconHtml = `
      <div id="heys-update-icon" class="heys-update-modal__icon ${s.isSpinner ? 'is-spinner' : ''}">
        ${s.isSpinner ? '<div class="heys-update-modal__spinner"></div>' : s.icon}
      </div>
    `;

    const progressWidth = stage === 'checking'
      ? '20%'
      : stage === 'found'
        ? '40%'
        : stage === 'downloading'
          ? '60%'
          : stage === 'installing'
            ? '80%'
            : '100%';

    const progressValue = parseInt(progressWidth, 10) || 0;
    const progressClass = getProgressClass(progressValue);

    const progressHtml = `
      <div class="heys-update-modal__progress">
        <div id="heys-update-progress" class="heys-update-modal__progress-bar ${progressClass}"></div>
      </div>
    `;

    const footerHtml = `<p class="heys-update-modal__version">–í–µ—Ä—Å–∏—è ${getAppVersion()}</p>`;

    return renderUpdateDialog({
      dialogType: 'modal',
      id: 'heys-update-modal',
      rootClass: 'heys-update-modal',
      backdropClass: 'heys-update-modal__backdrop',
      cardClass: 'heys-update-modal__card',
      cardAttrs: 'role="dialog" aria-modal="true" aria-labelledby="heys-update-title" aria-describedby="heys-update-subtitle"',
      iconHtml,
      titleId: 'heys-update-title',
      titleClass: 'heys-update-modal__title',
      title: s.title,
      textId: 'heys-update-subtitle',
      textClass: 'heys-update-modal__subtitle',
      text: s.subtitle,
      progressHtml,
      footerHtml,
    });
  }

  function updateModalStage(stage) {
    const stages = {
      checking: { icon: 'üîç', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π', subtitle: '–ü–æ–¥–æ–∂–¥–∏—Ç–µ...', progress: 20, isSpinner: false },
      found: { icon: 'üÜï', title: '–ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!', subtitle: '–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é...', progress: 40, isSpinner: false },
      downloading: { icon: 'üì•', title: '–ó–∞–≥—Ä—É–∑–∫–∞', subtitle: '–≠—Ç–æ –∑–∞–π–º—ë—Ç –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥...', progress: 60, isSpinner: false },
      installing: { icon: '‚öôÔ∏è', title: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞', subtitle: '–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ...', progress: 80, isSpinner: false },
      ready: { icon: '‚ú®', title: '–ì–æ—Ç–æ–≤–æ!', subtitle: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', progress: 100, isSpinner: false },
      reloading: { icon: 'spinner', title: '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞', subtitle: '–ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...', progress: 100, isSpinner: true }
    };

    const s = stages[stage];
    if (!s) return;

    const icon = document.getElementById('heys-update-icon');
    const title = document.getElementById('heys-update-title');
    const subtitle = document.getElementById('heys-update-subtitle');
    const progress = document.getElementById('heys-update-progress');

    if (icon) {
      if (s.isSpinner) {
        icon.innerHTML = '<div class="heys-update-modal__spinner"></div>';
        icon.classList.add('is-spinner');
      } else {
        icon.textContent = s.icon;
        icon.innerHTML = s.icon;
        icon.classList.remove('is-spinner');
      }
    }
    if (title) title.textContent = s.title;
    if (subtitle) subtitle.textContent = s.subtitle;
    if (progress) {
      progress.className = `heys-update-modal__progress-bar ${getProgressClass(s.progress)}`;
    }
  }

  function hideUpdateModal() {
    const modal = document.getElementById('heys-update-modal');
    if (modal) {
      modal.classList.add('heys-update-modal--hide');
      releaseUpdateDialogFocus(modal);
      setTimeout(() => modal.remove(), 300);
    }
  }

  function showManualRefreshPrompt(targetVersion) {
    document.getElementById('heys-update-modal')?.remove();

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    const iconHtml = '<div class="heys-update-prompt__spinner"></div>';
    const text = isIOS
      ? '–ó–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∑–∞–Ω–æ–≤–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ v' + targetVersion
      : '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ v' + targetVersion;

    const actionsHtml = `${isIOS ? '' : `
      <button id="heys-manual-update-btn" class="heys-update-prompt__btn heys-update-prompt__btn--primary">–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å</button>
    `}
      <button id="heys-update-later-btn" class="heys-update-prompt__btn heys-update-prompt__btn--ghost">–ü–æ–∑–∂–µ</button>
    `;

    const modal = renderUpdateDialog({
      dialogType: 'prompt',
      id: 'heys-update-modal',
      rootClass: 'heys-update-prompt',
      backdropClass: 'heys-update-prompt__backdrop',
      cardClass: 'heys-update-prompt__card',
      cardAttrs: 'role="dialog" aria-modal="true" aria-labelledby="heys-update-prompt-title" aria-describedby="heys-update-prompt-text"',
      iconHtml,
      titleId: 'heys-update-prompt-title',
      titleClass: 'heys-update-prompt__title',
      title: '–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
      textId: 'heys-update-prompt-text',
      textClass: 'heys-update-prompt__text',
      text,
      footerHtml: actionsHtml,
    });

    const updateBtn = document.getElementById('heys-manual-update-btn');
    if (updateBtn) {
      updateBtn.addEventListener('click', () => {
        localStorage.removeItem(UPDATE_ATTEMPT_KEY);
        const url = new URL(window.location.href);
        url.searchParams.set('_v', Date.now().toString());
        window.location.href = url.toString();
      });
    }

    const laterBtn = document.getElementById('heys-update-later-btn');
    if (laterBtn) {
      laterBtn.addEventListener('click', () => {
        releaseUpdateDialogFocus(modal);
        modal?.remove();
      });
    }
  }

  function renderUpdateDialog({
    dialogType,
    id,
    rootClass,
    backdropClass,
    cardClass,
    cardAttrs,
    iconHtml = '',
    titleId,
    titleClass,
    title,
    textId,
    textClass,
    text,
    progressHtml = '',
    footerHtml = '',
  }) {
    const modal = document.createElement('div');
    modal.id = id;
    modal.className = rootClass;
    if (dialogType) {
      modal.dataset.updateDialog = dialogType;
    }

    const titleHtml = title
      ? `<h2 id="${titleId}" class="${titleClass}">${title}</h2>`
      : '';
    const textHtml = text
      ? `<p id="${textId}" class="${textClass}">${text}</p>`
      : '';

    modal.innerHTML = `
      <div class="${backdropClass}">
        <div class="${cardClass}" ${cardAttrs || ''}>
          ${iconHtml}
          ${titleHtml}
          ${textHtml}
          ${progressHtml}
          ${footerHtml}
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    trapUpdateDialogFocus(modal);
    return modal;
  }

  function trapUpdateDialogFocus(modal) {
    if (!modal) return;

    const focusables = getFocusableElements(modal);
    const previousActive = document.activeElement instanceof HTMLElement ? document.activeElement : null;

    const focusTarget = focusables[0] || modal.querySelector('[role="dialog"]') || modal;
    if (focusTarget && typeof focusTarget.focus === 'function') {
      setTimeout(() => {
        try {
          focusTarget.focus({ preventScroll: true });
        } catch (_) {
          focusTarget.focus();
        }
      }, 0);
    }

    const handleKeydown = (event) => {
      if (event.key !== 'Tab') return;

      const items = getFocusableElements(modal);
      if (items.length === 0) {
        event.preventDefault();
        return;
      }

      const first = items[0];
      const last = items[items.length - 1];
      const isShift = event.shiftKey;
      const active = document.activeElement;

      if (isShift && active === first) {
        event.preventDefault();
        last.focus();
      } else if (!isShift && active === last) {
        event.preventDefault();
        first.focus();
      }
    };

    modal.addEventListener('keydown', handleKeydown);
    modal._heysFocusTrap = { previousActive, handleKeydown };
  }

  function releaseUpdateDialogFocus(modal) {
    const trap = modal?._heysFocusTrap;
    if (!trap) return;

    modal.removeEventListener('keydown', trap.handleKeydown);
    if (trap.previousActive && typeof trap.previousActive.focus === 'function') {
      try {
        trap.previousActive.focus({ preventScroll: true });
      } catch (_) {
        trap.previousActive.focus();
      }
    }
    delete modal._heysFocusTrap;
  }

  function getFocusableElements(container) {
    if (!container) return [];
    const selectors = [
      'a[href]:not([tabindex="-1"])',
      'button:not([disabled]):not([tabindex="-1"])',
      'input:not([disabled]):not([type="hidden"]):not([tabindex="-1"])',
      'select:not([disabled]):not([tabindex="-1"])',
      'textarea:not([disabled]):not([tabindex="-1"])',
      '[tabindex]:not([tabindex="-1"])'
    ];
    return Array.from(container.querySelectorAll(selectors.join(',')))
      .filter((el) => el instanceof HTMLElement && !el.hasAttribute('disabled'));
  }

  function installUpdate() {
    hideUpdateBadge();
    showUpdateModal('found');
    setTimeout(() => updateModalStage('downloading'), 800);
    setTimeout(() => updateModalStage('installing'), 1600);
    setTimeout(() => {
      updateModalStage('reloading');
      forceUpdateAndReload(false);
    }, 2400);
  }

  function getNetworkQuality() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (!connection) return { type: 'unknown', quality: 'good' };

    const effectiveType = connection.effectiveType;
    const downlink = connection.downlink;
    const rtt = connection.rtt;

    let quality = 'good';
    if (effectiveType === 'slow-2g' || effectiveType === '2g' || rtt > 500) {
      quality = 'poor';
    } else if (effectiveType === '3g' || rtt > 200 || downlink < 1) {
      quality = 'moderate';
    }

    return { type: effectiveType || 'unknown', downlink, rtt, quality, saveData: connection.saveData };
  }

  async function smartVersionCheck() {
    const network = getNetworkQuality();

    if (network.quality === 'poor' || network.saveData) {
      return;
    }

    try {
      const hasUpdate = await checkServerVersion(true);

      if (hasUpdate) {
        showUpdateBadge(_updateVersion);
      }
    } catch (e) {
      return;
    }
  }

  async function checkServerVersion(silent = true) {
    try {
      const cacheBust = Date.now();
      const response = await fetch(`/build-meta.json?_cb=${cacheBust}`, {
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      });

      if (!response.ok) return false;

      const data = await response.json();
      const currentVersion = getAppVersion();

      if (data.version && isNewerVersion(data.version, currentVersion)) {
        _updateVersion = data.version;

        const attempt = JSON.parse(localStorage.getItem(UPDATE_ATTEMPT_KEY) || '{}');
        const now = Date.now();

        if (attempt.timestamp && (now - attempt.timestamp) < UPDATE_COOLDOWN_MS) {
          return false;
        }

        if (attempt.targetVersion === data.version) {
          attempt.count = (attempt.count || 0) + 1;
        } else {
          attempt.targetVersion = data.version;
          attempt.count = 1;
        }
        attempt.timestamp = now;
        localStorage.setItem(UPDATE_ATTEMPT_KEY, JSON.stringify(attempt));

        if (attempt.count > MAX_UPDATE_ATTEMPTS) {
          showManualRefreshPrompt(data.version);
          return true;
        }

        if (isUpdateLocked()) {
          return true;
        }
        setUpdateLock();

        showUpdateModal('found');
        setTimeout(() => updateModalStage('downloading'), 1200);
        setTimeout(() => updateModalStage('installing'), 2400);
        setTimeout(() => {
          updateModalStage('reloading');
          forceUpdateAndReload(false);
        }, 3600);

        setTimeout(() => {
          const modal = document.getElementById('heys-update-modal');
          if (modal) {
            hideUpdateModal();
            clearUpdateLock();
          }
        }, 12000);

        return true;
      } else if (data.version && data.version !== currentVersion) {
        return false;
      }

      return false;
    } catch (e) {
      return false;
    }
  }

  function createSystemBanner({ id, className, text, actions }) {
    if (!document?.body || document.getElementById(id)) return;

    const banner = document.createElement('div');
    banner.id = id;
    banner.className = className;

    const textEl = document.createElement('span');
    textEl.className = 'heys-system-banner__text';
    textEl.textContent = text;
    banner.appendChild(textEl);

    if (Array.isArray(actions) && actions.length > 0) {
      const actionsEl = document.createElement('div');
      actionsEl.className = 'heys-system-banner__actions';
      actions.forEach((action) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = action.className;
        btn.textContent = action.label;
        btn.addEventListener('click', action.onClick);
        actionsEl.appendChild(btn);
      });
      banner.appendChild(actionsEl);
    }

    document.body.appendChild(banner);
  }

  function showUpdateNotification() {
    createSystemBanner({
      id: UPDATE_BANNER_ID,
      className: 'heys-system-banner heys-system-banner--update',
      text: '–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è',
      actions: [
        {
          label: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å',
          className: 'heys-system-banner__btn heys-system-banner__btn--primary',
          onClick: () => {
            triggerSkipWaiting({
              fallbackMs: 5000,
              showModal: true,
              source: 'update-banner',
            });
          }
        },
        {
          label: '‚úï',
          className: 'heys-system-banner__btn heys-system-banner__btn--ghost',
          onClick: () => {
            const banner = document.getElementById(UPDATE_BANNER_ID);
            if (banner) banner.remove();
          }
        }
      ]
    });
  }

  function showOfflineNotification() {
    createSystemBanner({
      id: OFFLINE_BANNER_ID,
      className: 'heys-system-banner heys-system-banner--offline',
      text: 'üì¥ –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ',
      actions: []
    });
  }

  function hideOfflineNotification() {
    const banner = document.getElementById(OFFLINE_BANNER_ID);
    if (banner) banner.remove();
  }

  function registerServiceWorker() {
    const bootLog = (msg) => window.__heysLog && window.__heysLog('[SW] ' + msg);

    if (!('serviceWorker' in navigator)) {
      bootLog('not supported');
      return;
    }

    // ‚ùå –ù–ï —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º SW –Ω–∞ localhost ‚Äî –º–µ—à–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (HMR, updatefound –∏ —Ç.–¥.)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log('[SW] ‚è≠Ô∏è Skipped on localhost (dev mode)');
      bootLog('skipped (localhost)');
      // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π SW –µ—Å–ª–∏ –µ—Å—Ç—å (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(reg => {
          reg.unregister().then(() => {
            console.log('[SW] üóëÔ∏è Unregistered SW on localhost');
          });
        });
      });
      return;
    }

    bootLog('registering...');
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('[SW] ‚úÖ Registered successfully');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è Background Sync
        window.swRegistration = registration;

        // Background Sync ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –¥–∞–Ω–Ω—ã—Ö
        window.requestBackgroundSync = function () {
          if ('sync' in registration) {
            registration.sync.register('heys-sync')
              .then(function () { console.log('[SW] Background sync scheduled'); })
              .catch(function () { /* Background sync not available */ });
          }
        };

        // üÜï Periodic Background Sync ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ñ–æ–Ω–µ
        // (—Ä–∞–∑ –≤ —á–∞—Å –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ, —Å WiFi)
        if ('periodicSync' in registration) {
          (async () => {
            try {
              const status = await navigator.permissions.query({ name: 'periodic-background-sync' });
              if (status.state === 'granted') {
                await registration.periodicSync.register('heys-periodic-update', {
                  minInterval: 60 * 60 * 1000, // 1 —á–∞—Å
                });
                console.log('[SW] ‚è∞ Periodic Background Sync registered (1h)');
              }
            } catch (e) {
              console.log('[SW] Periodic Background Sync not supported');
            }
          })();
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW (–≤–∫–ª—é—á–∞—è UPDATE_AVAILABLE)
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data?.type === 'UPDATE_AVAILABLE') {
            console.log('[SW] üÜï Background update detected:', event.data.version);
            showUpdateBadge(event.data.version);
            showUpdateNotification();
          }
          if (event.data?.type === 'UPDATE_REQUIRED') {
            console.log('[SW] üß≠ Version mismatch ‚Äî forcing update:', event.data.version);
            if (typeof HEYS.forceCheckAndUpdate === 'function') {
              HEYS.forceCheckAndUpdate();
            } else {
              triggerSkipWaiting({
                fallbackMs: 5000,
                showModal: true,
                source: 'update-required',
              });
            }
          }
          if (event.data?.type === 'CACHES_CLEARED') {
            // üîí Guard: –µ—Å–ª–∏ update_checks —É–ø—Ä–∞–≤–ª—è–µ—Ç lifecycle, –Ω–µ –¥–µ–ª–∞–µ–º reload –æ—Ç—Å—é–¥–∞.
            // update_checks —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç triggerSkipWaiting ‚Üí controllerchange ‚Üí cache-busted reload.
            const managedByChecks = sessionStorage.getItem('heys_update_managed_by_checks') === 'true';
            if (managedByChecks) {
              console.log('[SW] ‚úÖ Caches cleared ‚Äî lifecycle managed by update_checks, skipping reload here');
              try { sessionStorage.removeItem('heys_update_managed_by_checks'); } catch (e) { }
              return;
            }

            const requiresLogout = sessionStorage.getItem('heys_update_requires_logout') === 'true';
            console.log('[SW] ‚úÖ Caches cleared ‚Äî resetting session for fresh data from cloud');

            if (requiresLogout) {
              // ‚úÖ Guard –¥–ª—è —Ö—É–∫–æ–≤ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã—Ö–æ–¥–∞ –¥–æ –æ—á–∏—Å—Ç–∫–∏
              window.HEYS = window.HEYS || {};
              window.HEYS._isLoggingOut = true;
            }

            // üîÑ –°–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏ –¢–û–õ–¨–ö–û –ø—Ä–∏ –∞–ø–¥–µ–π—Ç–µ
            // ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –æ—á–∏—â–∞–µ–º localStorage.clear() ‚Äî —ç—Ç–æ —É–¥–∞–ª—è–µ—Ç heys_products!
            // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –∫–ª—é—á–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            if (requiresLogout) {
              try {
                // 1. –ó–∞–≤–µ—Ä—à–∞–µ–º auth —Å–µ—Å—Å–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (HEYS.cloud?.signOut) {
                  HEYS.cloud.signOut();
                }

                // 2. –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ù–ï —Ç—Ä–æ–≥–∞—è products/profile
                // ‚ùå –ë–´–õ–û: localStorage.clear(); ‚Äî —É–¥–∞–ª—è–ª–æ –í–°–Æ –±–∞–∑—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤!
                // ‚úÖ –°–¢–ê–õ–û: –≤—ã–±–æ—Ä–æ—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
                const keysToRemove = [];
                const keysToKeep = ['heys_products', 'heys_profile', 'heys_norms', 'heys_hr_zones'];

                for (let i = 0; i < localStorage.length; i++) {
                  const key = localStorage.key(i);
                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏ –∏ –¥–∞–Ω–Ω—ã–µ –¥–Ω–µ–π
                  if (!keysToKeep.some(k => key.includes(k)) && !key.startsWith('heys_dayv2_')) {
                    keysToRemove.push(key);
                  }
                }

                keysToRemove.forEach(key => localStorage.removeItem(key));
                console.log(`[SW] üóëÔ∏è Removed ${keysToRemove.length} session keys, kept critical data`);

                // 3. –û—á–∏—â–∞–µ–º sessionStorage –ø–æ–ª–Ω–æ—Å—Ç—å—é (—Ç–∞–º —Ç–æ–ª—å–∫–æ –∫—ç—à)
                sessionStorage.clear();

                console.log('[SW] ‚úÖ Session cleared safely, reloading...');
              } catch (e) {
                console.warn('[SW] Session clear error:', e);
              }
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            try {
              sessionStorage.removeItem('heys_update_requires_logout');
            } catch (e) { }

            // 4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å cache-busting ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            setTimeout(() => {
              const url = new URL(window.location.href);
              url.searchParams.set('_v', Date.now().toString());
              window.location.href = url.toString();
            }, 100);
          }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
          registration.update().catch(() => { });
        }, 60000);

        // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('[SW] üîÑ New version downloading...');

          // üîí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π SW)
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º registration.active ‚Äî –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –µ—Å—Ç—å –ª–∏ –ê–ö–¢–ò–í–ù–´–ô SW –¥–æ —ç—Ç–æ–≥–æ
          // controller –º–æ–∂–µ—Ç –±—ã—Ç—å null –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ SW
          const hasExistingSW = registration.active || navigator.serviceWorker.controller;
          if (!hasExistingSW) {
            console.log('[SW] First-time install, no update modal needed');
            return;
          }

          console.log('[SW] üÜï Update detected! Existing SW:', registration.active?.state || 'controller');

          // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞–¥—ë–∂–Ω—ã–π —Ñ–ª–∞–≥ –≤ localStorage)
          if (isUpdateLocked()) {
            console.log('[SW] Update already in progress (locked), skipping');
            return;
          }

          // üîí –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –î–û –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ ‚Äî —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          sessionStorage.setItem('heys_pending_update', 'true');
          setUpdateLock();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          showUpdateModal('downloading');

          // üîí Fallback: –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –º–æ–¥–∞–ª–∫–∞ –µ—â—ë –Ω–∞ —ç–∫—Ä–∞–Ω–µ ‚Äî —É–±–∏—Ä–∞–µ–º
          const swUpdateTimeout = setTimeout(() => {
            const modal = document.getElementById('heys-update-modal');
            if (modal) {
              console.warn('[SW] Update modal timeout, hiding...');
              hideUpdateModal();
              clearUpdateLock();
            }
          }, 10000);

          newWorker?.addEventListener('statechange', () => {
            if (newWorker.state === 'installed') {
              console.log('[SW] üéâ New version ready!');
              clearTimeout(swUpdateTimeout); // –û—Ç–º–µ–Ω—è–µ–º fallback
              // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è: ready ‚Üí reloading ‚Üí reload
              updateModalStage('ready');
              setTimeout(() => {
                updateModalStage('reloading');
                forceUpdateAndReload(false);
              }, 800);
            }
          });
        });
      })
      .catch((error) => {
        console.log('[SW] ‚ùå Registration failed', error);
      });

    // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data?.type === 'SYNC_START' && window.HEYS?.cloud?.sync) {
        window.HEYS.cloud.sync();
      }
      if (event.data?.type === 'SYNC_COMPLETE') {
        window.dispatchEvent(new CustomEvent('heys:sync-complete'));
      }
    });

    // Offline/Online banner
    window.addEventListener('offline', showOfflineNotification);
    window.addEventListener('online', hideOfflineNotification);
    if (navigator.onLine === false) {
      showOfflineNotification();
    }

    // –°–ª—É—à–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–æ–≥–¥–∞ SW –≤–∑—è–ª –∫–æ–Ω—Ç—Ä–æ–ª—å)
    // ‚úÖ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô reload –ø—Ä–∏ —Å–º–µ–Ω–µ SW –¥–ª—è –±–µ—Å—à–æ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è PWA
    let refreshing = false;
    let hadControllerBefore = !!navigator.serviceWorker.controller;

    navigator.serviceWorker.addEventListener('controllerchange', () => {
      console.log('[SW] Controller changed ‚Äî new SW activated!');
      if (refreshing) return;

      // üîí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –¥–µ–ª–∞–µ–º reload –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      // –†–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –±—ã–ª –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ —ç—Ç–æ–≥–æ –ò–õ–ò –µ—Å—Ç—å —Ñ–ª–∞–≥ pending_update
      const isRealUpdate = hadControllerBefore ||
        sessionStorage.getItem('heys_pending_update') === 'true' ||
        isUpdateLocked();

      console.log('[SW] Update check:', { hadControllerBefore, isRealUpdate });

      if (isRealUpdate) {
        // –†–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –¥–µ–ª–∞–µ–º reload
        refreshing = true;
        showUpdateModal('reloading');

        // v61/v62: Defer reload until active sync completes (prevents mid-sync page interruption)
        const doReload = () => {
          console.info('[SW] üîÑ Reloading page with new SW... (triggered by controllerchange)');
          const url = new URL(window.location.href);
          url.searchParams.set('_v', Date.now().toString());
          window.location.href = url.toString();
        };
        const syncInFlight = typeof HEYS !== 'undefined' && HEYS.cloud && typeof HEYS.cloud.isSyncing === 'function'
          ? HEYS.cloud.isSyncing()
          : null;
        // v62: Also check _authSyncPending ‚Äî set SYNCHRONOUSLY in PIN auth restore BEFORE
        // cloud.syncClient() is called (covers the race window where _syncInFlight isn't set yet).
        const authPending = typeof HEYS !== 'undefined' && HEYS.cloud && typeof HEYS.cloud.isAuthSyncPending === 'function'
          ? HEYS.cloud.isAuthSyncPending()
          : false;
        if (syncInFlight) {
          console.info('[SW] ‚è≥ Sync in progress ‚Äî deferring reload until sync completes (max 15s)...');
          Promise.race([
            syncInFlight,
            new Promise(resolve => setTimeout(resolve, 15000))
          ]).finally(doReload);
        } else if (authPending) {
          // v62: Auth sync is about to start (PIN restore fire-and-forget race).
          // Poll until syncClient creates _syncInFlight, then defer to it.
          console.info('[SW] ‚è≥ Auth sync pending ‚Äî polling for sync start (max 15s)...');
          const deadline = Date.now() + 15000;
          const pollId = setInterval(() => {
            const inflightNow = typeof HEYS !== 'undefined' && HEYS.cloud?.isSyncing?.();
            if (inflightNow) {
              clearInterval(pollId);
              console.info('[SW] ‚è≥ Sync detected after auth ‚Äî deferring reload...');
              Promise.race([
                inflightNow,
                new Promise(resolve => setTimeout(resolve, 15000))
              ]).finally(doReload);
            } else if (!HEYS.cloud?.isAuthSyncPending?.() || Date.now() > deadline) {
              clearInterval(pollId);
              doReload();
            }
          }, 200);
        } else {
          setTimeout(doReload, 500);
        }
      } else {
        // –ü–µ—Ä–≤–∏—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ SW ‚Äî –ù–ï –¥–µ–ª–∞–µ–º reload, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        console.log('[SW] First-time controller activation, no reload needed');
      }
    });
  }

  // === –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è skipWaiting —Å debounce –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ ===
  let _skipWaitingInProgress = false;
  const SKIP_WAITING_DEBOUNCE_MS = 500;

  async function triggerSkipWaiting(options = {}) {
    const { fallbackMs = 5000, showModal = false, source = 'unknown' } = options;

    // Debounce: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
    if (_skipWaitingInProgress) {
      console.log('[SW] ‚è≥ skipWaiting already in progress, skipping duplicate from:', source);
      return false;
    }

    _skipWaitingInProgress = true;
    console.log('[SW] üîÑ triggerSkipWaiting called from:', source);

    try {
      // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SW controller
      if (!navigator.serviceWorker?.controller) {
        console.warn('[SW] ‚ö†Ô∏è No active SW controller ‚Äî skipping skipWaiting');
        return false;
      }

      // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ waiting SW (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≥–æ—Ç–æ–≤–∞)
      const registration = await navigator.serviceWorker.getRegistration();
      if (registration?.waiting) {
        console.log('[SW] ‚úÖ Found waiting SW ‚Äî sending skipWaiting');
        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      } else {
        // Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ controller (–¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞)
        console.log('[SW] ‚ö†Ô∏è No waiting SW found ‚Äî sending to controller (legacy)');
        navigator.serviceWorker.controller.postMessage('skipWaiting');
      }

      // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ reload
      sessionStorage.setItem('heys_pending_update', 'true');
      sessionStorage.setItem('heys_force_sync_after_update', 'true');

      // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (showModal && typeof showUpdateModal === 'function') {
        showUpdateModal('reloading');
      }

      // 5. Fallback —Ç–∞–π–º–µ—Ä (–µ—Å–ª–∏ controllerchange –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
      setTimeout(() => {
        if (sessionStorage.getItem('heys_pending_update') === 'true') {
          console.log('[SW] ‚ö° Fallback reload after', fallbackMs, 'ms (triggered by triggerSkipWaiting fallback)');
          const url = new URL(window.location.href);
          url.searchParams.set('_v', Date.now().toString());
          window.location.href = url.toString();
        }
      }, fallbackMs);

      return true;
    } catch (err) {
      console.error('[SW] ‚ùå triggerSkipWaiting error:', err);
      return false;
    } finally {
      // –°–±—Ä–æ—Å debounce —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
      setTimeout(() => {
        _skipWaitingInProgress = false;
      }, SKIP_WAITING_DEBOUNCE_MS);
    }
  }

  // === –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ===
  function forceUpdateAndReload(showModal = true) {

    if (showModal) {
      showUpdateModal('reloading');
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å debounce –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    triggerSkipWaiting({
      fallbackMs: 5000,
      showModal: false, // –º–æ–¥–∞–ª —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –≤—ã—à–µ
      source: 'forceUpdateAndReload'
    });
  }

  // === Persistent Storage API ===
  // –ó–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–æ–º –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞
  // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è PWA —Å –æ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–º–∏
  async function requestPersistentStorage() {
    if (!navigator.storage?.persist) {
      console.log('[Storage] Persistent Storage API not supported');
      return false;
    }

    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      const isPersisted = await navigator.storage.persisted();

      if (isPersisted) {
        console.log('[Storage] ‚úÖ Already persistent');
        return true;
      }

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
      const granted = await navigator.storage.persist();

      if (granted) {
        console.log('[Storage] ‚úÖ Persistent storage granted!');
        // –í–∏–±—Ä–∞—Ü–∏—è-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        return true;
      } else {
        console.log('[Storage] ‚ö†Ô∏è Persistent storage denied by browser');
        return false;
      }
    } catch (e) {
      console.error('[Storage] Error requesting persistence:', e);
      return false;
    }
  }

  // Storage Estimate ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
  async function getStorageEstimate() {
    if (!navigator.storage?.estimate) {
      return { usage: 0, quota: 0, usageDetails: {} };
    }

    try {
      const estimate = await navigator.storage.estimate();
      const usageMB = (estimate.usage / (1024 * 1024)).toFixed(2);
      const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
      const usagePercent = ((estimate.usage / estimate.quota) * 100).toFixed(1);

      console.log(`[Storage] üìä Usage: ${usageMB}MB / ${quotaMB}MB (${usagePercent}%)`);

      // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
      if (estimate.usageDetails) {
        Object.entries(estimate.usageDetails).forEach(([key, value]) => {
          console.log(`[Storage]   - ${key}: ${(value / (1024 * 1024)).toFixed(2)}MB`);
        });
      }

      return {
        usage: estimate.usage,
        quota: estimate.quota,
        usageMB: parseFloat(usageMB),
        quotaMB: parseFloat(quotaMB),
        usagePercent: parseFloat(usagePercent),
        usageDetails: estimate.usageDetails || {}
      };
    } catch (e) {
      console.error('[Storage] Error getting estimate:', e);
      return { usage: 0, quota: 0, usageDetails: {} };
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
  HEYS.storage = HEYS.storage || {};
  HEYS.storage.requestPersistent = requestPersistentStorage;
  HEYS.storage.getEstimate = getStorageEstimate;

  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º Persistent Storage –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  // (–∫–æ–≥–¥–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –∑–∞—â–∏—Ç–∏—Ç—å)
  setTimeout(async () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –Ω–∞—Å –∑–Ω–∞—á–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
    const hasLocalData = Object.keys(localStorage).some(k => k.startsWith('heys_'));
    if (hasLocalData) {
      await requestPersistentStorage();
    }
  }, 5000);

  // === Device Capabilities API ===
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  function getDeviceCapabilities() {
    const capabilities = {
      // –ü–∞–º—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (GB) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞
      memory: navigator.deviceMemory || 4, // fallback 4GB

      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ ‚Äî –¥–ª—è Web Workers
      cores: navigator.hardwareConcurrency || 4,

      // –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      connection: navigator.connection ? {
        type: navigator.connection.effectiveType || 'unknown',
        downlink: navigator.connection.downlink || 0,
        rtt: navigator.connection.rtt || 0,
        saveData: navigator.connection.saveData || false
      } : { type: 'unknown', downlink: 0, rtt: 0, saveData: false },

      // –†–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
      screen: {
        width: window.screen.width,
        height: window.screen.height,
        pixelRatio: window.devicePixelRatio || 1,
        colorDepth: window.screen.colorDepth || 24
      },

      // Touch capabilities
      hasTouch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
      maxTouchPoints: navigator.maxTouchPoints || 0,

      // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
      platform: navigator.platform || 'unknown',
      isStandalone: window.matchMedia('(display-mode: standalone)').matches,

      // –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
      prefersColorScheme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
      prefersReducedData: window.matchMedia('(prefers-reduced-data: reduce)').matches
    };

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    let performanceLevel = 'high'; // default

    if (capabilities.memory <= 2 || capabilities.cores <= 2) {
      performanceLevel = 'low';
    } else if (capabilities.memory <= 4 || capabilities.cores <= 4) {
      performanceLevel = 'medium';
    }

    // –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º —ç–∫–æ–Ω–æ–º–∏–∏ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Å–Ω–∏–∂–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
    if (capabilities.connection.saveData) {
      performanceLevel = 'low';
    }

    capabilities.performanceLevel = performanceLevel;

    console.log(`[Device] üì± Capabilities:`, {
      memory: `${capabilities.memory}GB`,
      cores: capabilities.cores,
      connection: capabilities.connection.type,
      performanceLevel,
      standalone: capabilities.isStandalone
    });

    return capabilities;
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º capabilities
  HEYS.device = getDeviceCapabilities();

  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  if (navigator.connection) {
    navigator.connection.addEventListener('change', () => {
      HEYS.device = getDeviceCapabilities();
    });
  }

  // === Idle Detection API ===
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
  // –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —É–º–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
  let idleDetector = null;
  let lastIdleTime = null;

  async function startIdleDetection() {
    if (!('IdleDetector' in window)) {
      console.log('[Idle] IdleDetector API not supported');
      return false;
    }

    try {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
      const state = await IdleDetector.requestPermission();
      if (state !== 'granted') {
        console.log('[Idle] Permission denied');
        return false;
      }

      idleDetector = new IdleDetector();

      idleDetector.addEventListener('change', () => {
        const { userState, screenState } = idleDetector;

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–æ—Å—Ç–æ—è
        if (userState === 'active' && lastIdleTime) {
          const idleDuration = Date.now() - lastIdleTime;
          const idleMinutes = Math.round(idleDuration / 60000);

          console.log(`[Idle] üëã User returned after ${idleMinutes} min`);

          // –ï—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –±–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
          if (idleMinutes >= 5 && window.HEYS?.cloud?.sync) {
            console.log('[Idle] Syncing after idle period...');
            window.HEYS.cloud.sync().catch(() => { });
          }

          // –ï—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –±–æ–ª—å—à–µ 30 –º–∏–Ω—É—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          if (idleMinutes >= 30) {
            checkServerVersion(true);
          }

          // Dispatch custom event –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          window.dispatchEvent(new CustomEvent('heys:user-returned', {
            detail: { idleMinutes }
          }));

          lastIdleTime = null;
        }

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
        if (userState === 'idle' || screenState === 'locked') {
          lastIdleTime = Date.now();
          console.log('[Idle] üí§ User went idle/screen locked');
        }
      });

      // –ü–æ—Ä–æ–≥ –ø—Ä–æ—Å—Ç–æ—è ‚Äî 60 —Å–µ–∫—É–Ω–¥
      await idleDetector.start({ threshold: 60000 });
      console.log('[Idle] ‚úÖ Idle detection started');
      return true;

    } catch (e) {
      console.error('[Idle] Error starting detection:', e);
      return false;
    }
  }

  function stopIdleDetection() {
    if (idleDetector) {
      idleDetector.abort();
      idleDetector = null;
      console.log('[Idle] Stopped');
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
  HEYS.idle = {
    start: startIdleDetection,
    stop: stopIdleDetection
  };

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ –≤ standalone —Ä–µ–∂–∏–º–µ
  if (window.matchMedia('(display-mode: standalone)').matches) {
    setTimeout(startIdleDetection, 10000); // –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
  }

  // === Window Controls Overlay API ===
  // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö PWA ‚Äî –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ–∫–Ω–∞
  function initWindowControlsOverlay() {
    if (!('windowControlsOverlay' in navigator)) {
      console.log('[WCO] Window Controls Overlay not supported');
      return;
    }

    const overlay = navigator.windowControlsOverlay;

    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—é
    function updateTitlebarGeometry() {
      const { visible, x, y, width, height } = overlay.getTitlebarAreaRect?.() || {};

      if (visible) {
        console.log(`[WCO] üìê Titlebar area: ${width}x${height} at (${x}, ${y})`);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å—Ç–∏–ª—è—Ö
        document.documentElement.style.setProperty('--titlebar-area-x', `${x}px`);
        document.documentElement.style.setProperty('--titlebar-area-y', `${y}px`);
        document.documentElement.style.setProperty('--titlebar-area-width', `${width}px`);
        document.documentElement.style.setProperty('--titlebar-area-height', `${height}px`);

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
        document.body.classList.add('wco-enabled');
      } else {
        document.body.classList.remove('wco-enabled');
      }
    }

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    overlay.addEventListener('geometrychange', updateTitlebarGeometry);

    // –ù–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updateTitlebarGeometry();

    console.log('[WCO] ‚úÖ Window Controls Overlay initialized');
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WCO –µ—Å–ª–∏ —ç—Ç–æ –¥–µ—Å–∫—Ç–æ–ø PWA
  if (window.matchMedia('(display-mode: window-controls-overlay)').matches) {
    initWindowControlsOverlay();
  }

  // === Barcode Detection API ===
  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –∫–∞–º–µ—Ä—ã
  let barcodeDetector = null;

  async function initBarcodeDetector() {
    if (!('BarcodeDetector' in window)) {
      console.log('[Barcode] BarcodeDetector API not supported');
      return null;
    }

    try {
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
      const formats = await BarcodeDetector.getSupportedFormats();
      console.log('[Barcode] Supported formats:', formats);

      // –°–æ–∑–¥–∞—ë–º –¥–µ—Ç–µ–∫—Ç–æ—Ä –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã—Ö —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤
      const productFormats = formats.filter(f =>
        ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39'].includes(f)
      );

      if (productFormats.length === 0) {
        console.log('[Barcode] No product barcode formats supported');
        return null;
      }

      barcodeDetector = new BarcodeDetector({ formats: productFormats });
      console.log('[Barcode] ‚úÖ Detector initialized with formats:', productFormats);
      return barcodeDetector;
    } catch (e) {
      console.error('[Barcode] Error initializing:', e);
      return null;
    }
  }

  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  async function scanBarcodeFromImage(imageSource) {
    if (!barcodeDetector) {
      await initBarcodeDetector();
    }

    if (!barcodeDetector) {
      return { success: false, error: 'BarcodeDetector not available' };
    }

    try {
      const barcodes = await barcodeDetector.detect(imageSource);

      if (barcodes.length > 0) {
        const barcode = barcodes[0];
        console.log('[Barcode] üì¶ Detected:', barcode.rawValue, barcode.format);

        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
        if (window.HEYS?.haptic) {
          HEYS.haptic.medium();
        }

        return {
          success: true,
          value: barcode.rawValue,
          format: barcode.format,
          bounds: barcode.boundingBox
        };
      }

      return { success: false, error: 'No barcode found' };
    } catch (e) {
      console.error('[Barcode] Scan error:', e);
      return { success: false, error: e.message };
    }
  }

  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
  async function startBarcodeScanning(videoElement, onDetected) {
    if (!barcodeDetector) {
      await initBarcodeDetector();
    }

    if (!barcodeDetector) {
      return { success: false, error: 'BarcodeDetector not available' };
    }

    let scanning = true;
    let lastDetectedCode = null;
    let lastDetectedTime = 0;

    const scanFrame = async () => {
      if (!scanning || videoElement.paused || videoElement.ended) return;

      try {
        const barcodes = await barcodeDetector.detect(videoElement);

        if (barcodes.length > 0) {
          const barcode = barcodes[0];
          const now = Date.now();

          // Debounce ‚Äî –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ–¥ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
          if (barcode.rawValue !== lastDetectedCode || (now - lastDetectedTime) > 2000) {
            lastDetectedCode = barcode.rawValue;
            lastDetectedTime = now;

            console.log('[Barcode] üì¶ Scanned:', barcode.rawValue);

            if (window.HEYS?.haptic) {
              HEYS.haptic.medium();
            }

            onDetected?.({
              value: barcode.rawValue,
              format: barcode.format,
              bounds: barcode.boundingBox
            });
          }
        }
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
      }

      if (scanning) {
        requestAnimationFrame(scanFrame);
      }
    };

    requestAnimationFrame(scanFrame);

    return {
      success: true,
      stop: () => { scanning = false; }
    };
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  initBarcodeDetector();

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
  HEYS.barcode = {
    isSupported: () => 'BarcodeDetector' in window,
    scanImage: scanBarcodeFromImage,
    startScanning: startBarcodeScanning
  };

  // === Web Share API (–∏—Å—Ö–æ–¥—è—â–∏–π) ===
  // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, —Ä–µ—Ü–µ–ø—Ç–∞–º–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
  async function shareContent(data) {
    if (!navigator.share) {
      console.log('[Share] Web Share API not supported');
      // Fallback –Ω–∞ clipboard
      if (navigator.clipboard && data.text) {
        await navigator.clipboard.writeText(data.text);
        HEYS.Toast?.success?.('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!');
        return { success: true, method: 'clipboard' };
      }
      return { success: false, error: 'Share not supported' };
    }

    try {
      await navigator.share(data);
      console.log('[Share] ‚úÖ Shared successfully');

      if (window.HEYS?.haptic) {
        HEYS.haptic.light();
      }

      return { success: true, method: 'native' };
    } catch (e) {
      if (e.name === 'AbortError') {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        return { success: false, error: 'cancelled' };
      }
      console.error('[Share] Error:', e);
      return { success: false, error: e.message };
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —à–∞—Ä–∏–Ω–≥–∞ —Ñ–∞–π–ª–æ–≤
  function canShareFiles() {
    return navigator.canShare && navigator.canShare({ files: [new File([''], 'test.txt')] });
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
  HEYS.share = {
    isSupported: () => !!navigator.share,
    canShareFiles: canShareFiles,
    share: shareContent,

    // –£–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    async shareProgress(stats) {
      const text = `üéØ –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ HEYS:\n` +
        `üìä ${stats.streak || 0} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –Ω–æ—Ä–º–µ\n` +
        `üî• ${stats.kcal || 0} –∫–∫–∞–ª —Å–µ–≥–æ–¥–Ω—è\n` +
        `üíß ${stats.water || 0} –º–ª –≤–æ–¥—ã\n\n` +
        `–ü–æ–ø—Ä–æ–±—É–π HEYS: https://app.heyslab.ru`;

      return shareContent({ title: '–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ HEYS', text });
    },

    async shareDay(date, stats) {
      const text = `üìÖ ${date}\n` +
        `üî• –ö–∞–ª–æ—Ä–∏–∏: ${stats.kcal || 0}/${stats.norm || 0}\n` +
        `ü•© –ë–µ–ª–æ–∫: ${stats.protein || 0}–≥\n` +
        `üíß –í–æ–¥–∞: ${stats.water || 0} –º–ª\n` +
        `üëü –®–∞–≥–∏: ${stats.steps || 0}`;

      return shareContent({ title: `–î–µ–Ω—å ${date}`, text });
    }
  };

  // === Contact Picker API ===
  // –í—ã–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π
  async function pickContacts(options = {}) {
    if (!('contacts' in navigator && 'ContactsManager' in window)) {
      console.log('[Contacts] Contact Picker API not supported');
      return { success: false, error: 'Not supported' };
    }

    try {
      const properties = options.properties || ['name', 'tel'];
      const opts = { multiple: options.multiple ?? true };

      const contacts = await navigator.contacts.select(properties, opts);

      if (contacts.length > 0) {
        console.log(`[Contacts] ‚úÖ Selected ${contacts.length} contacts`);

        if (window.HEYS?.haptic) {
          HEYS.haptic.light();
        }

        return { success: true, contacts };
      }

      return { success: false, error: 'No contacts selected' };
    } catch (e) {
      if (e.name === 'InvalidStateError') {
        // –£–∂–µ –æ—Ç–∫—Ä—ã—Ç picker ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
        return { success: false, error: 'picker_busy' };
      }
      console.error('[Contacts] Error:', e);
      return { success: false, error: e.message };
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
  async function getSupportedContactProperties() {
    if (!('contacts' in navigator)) {
      return [];
    }

    try {
      return await navigator.contacts.getProperties();
    } catch (e) {
      return [];
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
  HEYS.contacts = {
    isSupported: () => 'contacts' in navigator && 'ContactsManager' in window,
    pick: pickContacts,
    getSupportedProperties: getSupportedContactProperties
  };

  // === Speech Recognition API ===
  // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
  let speechRecognition = null;

  function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      console.log('[Speech] Speech Recognition not supported');
      return null;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'ru-RU';
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.maxAlternatives = 3;

    return recognition;
  }

  // –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å (Promise-based)
  function recognizeSpeech(options = {}) {
    return new Promise((resolve, reject) => {
      const recognition = initSpeechRecognition();

      if (!recognition) {
        reject(new Error('Speech recognition not supported'));
        return;
      }

      let finalTranscript = '';
      let interimCallback = options.onInterim;

      recognition.onresult = (event) => {
        let interim = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];

          if (result.isFinal) {
            finalTranscript += result[0].transcript;
          } else {
            interim += result[0].transcript;
          }
        }

        if (interimCallback && interim) {
          interimCallback(interim);
        }
      };

      recognition.onend = () => {
        if (finalTranscript) {
          console.log('[Speech] ‚úÖ Recognized:', finalTranscript);

          if (window.HEYS?.haptic) {
            HEYS.haptic.light();
          }

          resolve({ success: true, text: finalTranscript.trim() });
        } else {
          resolve({ success: false, error: 'No speech detected' });
        }
      };

      recognition.onerror = (event) => {
        console.error('[Speech] Error:', event.error);
        reject(new Error(event.error));
      };

      try {
        recognition.start();
        console.log('[Speech] üé§ Listening...');

        if (window.HEYS?.haptic) {
          HEYS.haptic.light();
        }
      } catch (e) {
        reject(e);
      }

      // –¢–∞–π–º–∞—É—Ç ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ N —Å–µ–∫—É–Ω–¥
      const timeout = options.timeout || 10000;
      setTimeout(() => {
        try {
          recognition.stop();
        } catch (e) { }
      }, timeout);

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–æ—Å–æ–± –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
      speechRecognition = recognition;
    });
  }

  function stopSpeechRecognition() {
    if (speechRecognition) {
      try {
        speechRecognition.stop();
      } catch (e) { }
      speechRecognition = null;
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
  HEYS.speech = {
    isSupported: () => !!(window.SpeechRecognition || window.webkitSpeechRecognition),
    recognize: recognizeSpeech,
    stop: stopSpeechRecognition
  };

  // === Launch Handler API ===
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  if ('launchQueue' in window) {
    window.launchQueue.setConsumer((launchParams) => {
      console.log('[Launch] üöÄ App launched with params:', launchParams);

      // –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ —Å —Ñ–∞–π–ª–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ –µ–¥—ã)
      if (launchParams.files?.length > 0) {
        console.log('[Launch] Files:', launchParams.files.map(f => f.name));

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        window.HEYS_LAUNCH_FILES = launchParams.files;

        // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        window.dispatchEvent(new CustomEvent('heys:launch-files', {
          detail: { files: launchParams.files }
        }));
      }

      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ü–µ–ª–µ–≤–æ–π URL
      if (launchParams.targetURL) {
        const url = new URL(launchParams.targetURL);
        console.log('[Launch] Target URL:', url.href);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        const action = url.searchParams.get('action');
        const tab = url.searchParams.get('tab');

        if (action) {
          window.dispatchEvent(new CustomEvent('heys:url-action', {
            detail: { action }
          }));
        }

        if (tab) {
          window.dispatchEvent(new CustomEvent('heys:url-tab', {
            detail: { tab }
          }));
        }
      }
    });
    console.log('[Launch] ‚úÖ Launch handler registered');
  }

  // === Protocol Handler ===
  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª web+heys://
  function registerProtocolHandler() {
    if (!navigator.registerProtocolHandler) {
      console.log('[Protocol] Protocol handler not supported');
      return false;
    }

    try {
      navigator.registerProtocolHandler(
        'web+heys',
        '/?protocol=%s',
        'HEYS Nutrition'
      );
      console.log('[Protocol] ‚úÖ Registered web+heys:// protocol');
      return true;
    } catch (e) {
      console.error('[Protocol] Registration error:', e);
      return false;
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ protocol deep links
  function handleProtocolUrl() {
    const params = new URLSearchParams(window.location.search);
    const protocolUrl = params.get('protocol');

    if (protocolUrl) {
      console.log('[Protocol] Handling:', protocolUrl);

      // –ü–∞—Ä—Å–∏–º web+heys://action/params
      const match = protocolUrl.match(/^web\+heys:\/\/([^/]+)\/?(.*)$/);

      if (match) {
        const [, action, data] = match;

        window.dispatchEvent(new CustomEvent('heys:protocol-action', {
          detail: { action, data: decodeURIComponent(data) }
        }));

        // –û—á–∏—â–∞–µ–º URL –æ—Ç protocol –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        params.delete('protocol');
        const newUrl = params.toString()
          ? `${window.location.pathname}?${params.toString()}`
          : window.location.pathname;
        window.history.replaceState({}, '', newUrl);
      }
    }
  }

  // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  handleProtocolUrl();

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º
  HEYS.protocol = {
    register: registerProtocolHandler,
    handleUrl: handleProtocolUrl
  };

  // === File System Access API ===
  // –î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
  async function saveToFile(data, filename = 'heys-export.json', type = 'application/json') {
    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π File System Access API
    if ('showSaveFilePicker' in window) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{
            description: type === 'application/json' ? 'JSON —Ñ–∞–π–ª' : '–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª',
            accept: { [type]: [filename.split('.').pop() ? `.${filename.split('.').pop()}` : '.json'] }
          }]
        });

        const writable = await handle.createWritable();
        await writable.write(typeof data === 'string' ? data : JSON.stringify(data, null, 2));
        await writable.close();

        console.log('[FileSystem] ‚úÖ Saved to:', handle.name);

        if (window.HEYS?.haptic) {
          HEYS.haptic.success();
        }

        return { success: true, filename: handle.name };
      } catch (e) {
        if (e.name === 'AbortError') {
          return { success: false, cancelled: true };
        }
        console.error('[FileSystem] Save error:', e);
      }
    }

    // Fallback: download link
    const blob = new Blob([typeof data === 'string' ? data : JSON.stringify(data, null, 2)], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    console.log('[FileSystem] üì• Downloaded:', filename);
    return { success: true, filename, fallback: true };
  }

  // –û—Ç–∫—Ä—ã—Ç—å –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
  async function openFile(accept = ['.json']) {
    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π File System Access API
    if ('showOpenFilePicker' in window) {
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{
            description: '–§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö',
            accept: { 'application/*': accept }
          }],
          multiple: false
        });

        const file = await handle.getFile();
        const content = await file.text();

        console.log('[FileSystem] ‚úÖ Opened:', file.name);

        return {
          success: true,
          filename: file.name,
          content,
          data: accept.includes('.json') ? JSON.parse(content) : content
        };
      } catch (e) {
        if (e.name === 'AbortError') {
          return { success: false, cancelled: true };
        }
        console.error('[FileSystem] Open error:', e);
      }
    }

    // Fallback: input file
    return new Promise((resolve) => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = accept.join(',');

      input.onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) {
          resolve({ success: false, cancelled: true });
          return;
        }

        const content = await file.text();
        resolve({
          success: true,
          filename: file.name,
          content,
          data: accept.includes('.json') ? JSON.parse(content) : content,
          fallback: true
        });
      };

      input.oncancel = () => resolve({ success: false, cancelled: true });
      input.click();
    });
  }

  // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async function exportUserData() {
    const data = {
      exportDate: new Date().toISOString(),
      appVersion: getAppVersion(),
      profile: HEYS.utils?.lsGet?.('heys_profile') || {},
      norms: HEYS.utils?.lsGet?.('heys_norms') || {},
      products: HEYS.products?.getAll?.() || [],
      // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö
      days: []
    };

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ 90 –¥–Ω–µ–π
    const today = new Date();
    for (let i = 0; i < 90; i++) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const dayData = HEYS.utils?.lsGet?.(`heys_dayv2_${dateStr}`);
      if (dayData) {
        data.days.push({ date: dateStr, ...dayData });
      }
    }

    const filename = `heys-export-${today.toISOString().split('T')[0]}.json`;
    return saveToFile(data, filename);
  }

  // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async function importUserData() {
    const result = await openFile(['.json']);

    if (!result.success || result.cancelled) {
      return result;
    }

    const data = result.data;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!data.appVersion || !data.exportDate) {
      return { success: false, error: 'Invalid export file' };
    }

    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    let imported = { profile: false, norms: false, products: 0, days: 0 };

    if (data.profile && HEYS.utils?.lsSet) {
      HEYS.utils.lsSet('heys_profile', data.profile);
      imported.profile = true;
    }

    if (data.norms && HEYS.utils?.lsSet) {
      HEYS.utils.lsSet('heys_norms', data.norms);
      imported.norms = true;
    }

    if (data.products?.length && HEYS.products?.setAll) {
      const existing = HEYS.products.getAll() || [];
      const merged = [...existing];

      for (const product of data.products) {
        if (!merged.find(p => p.id === product.id)) {
          merged.push(product);
          imported.products++;
        }
      }

      HEYS.products.setAll(merged, { source: 'import-user-data' });
    }

    if (data.days?.length && HEYS.utils?.lsSet) {
      for (const day of data.days) {
        const key = `heys_dayv2_${day.date}`;
        const existing = HEYS.utils.lsGet(key);

        // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        if (!existing) {
          HEYS.utils.lsSet(key, day);
          imported.days++;
        }
      }
    }

    console.log('[FileSystem] ‚úÖ Imported:', imported);

    if (window.HEYS?.haptic) {
      HEYS.haptic.success();
    }

    return { success: true, imported, fromFile: result.filename };
  }

  HEYS.fileSystem = {
    isSupported: () => 'showSaveFilePicker' in window,
    saveToFile,
    openFile,
    exportUserData,
    importUserData
  };

  // === Credential Management API ===
  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

  async function saveCredentials(phone, pin, name = 'HEYS Nutrition') {
    if (!('credentials' in navigator) || !window.PasswordCredential) {
      console.log('[Credentials] API not supported');
      return { success: false, reason: 'not_supported' };
    }

    try {
      const credential = new PasswordCredential({
        id: phone,
        password: pin,
        name: name
      });

      await navigator.credentials.store(credential);
      console.log('[Credentials] ‚úÖ Saved credentials');
      return { success: true };
    } catch (e) {
      console.error('[Credentials] Save error:', e);
      return { success: false, error: e.message };
    }
  }

  async function getCredentials() {
    if (!('credentials' in navigator)) {
      return { success: false, reason: 'not_supported' };
    }

    try {
      const credential = await navigator.credentials.get({
        password: true,
        mediation: 'optional'
      });

      if (credential) {
        console.log('[Credentials] ‚úÖ Retrieved credentials for:', credential.id);
        return {
          success: true,
          phone: credential.id,
          pin: credential.password,
          name: credential.name
        };
      }

      return { success: false, reason: 'no_credentials' };
    } catch (e) {
      console.error('[Credentials] Get error:', e);
      return { success: false, error: e.message };
    }
  }

  async function clearCredentials() {
    if (!('credentials' in navigator)) {
      return { success: false, reason: 'not_supported' };
    }

    try {
      await navigator.credentials.preventSilentAccess();
      console.log('[Credentials] ‚úÖ Cleared silent access');
      return { success: true };
    } catch (e) {
      console.error('[Credentials] Clear error:', e);
      return { success: false, error: e.message };
    }
  }

  HEYS.credentials = {
    isSupported: () => 'credentials' in navigator && !!window.PasswordCredential,
    save: saveCredentials,
    get: getCredentials,
    clear: clearCredentials
  };

  // === Screen Orientation API ===
  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–µ–π —ç–∫—Ä–∞–Ω–∞

  async function lockOrientation(orientation = 'portrait') {
    if (!screen.orientation?.lock) {
      console.log('[Orientation] Lock not supported');
      return { success: false, reason: 'not_supported' };
    }

    try {
      await screen.orientation.lock(orientation);
      console.log('[Orientation] ‚úÖ Locked to:', orientation);
      return { success: true, orientation };
    } catch (e) {
      console.error('[Orientation] Lock error:', e);
      return { success: false, error: e.message };
    }
  }

  function unlockOrientation() {
    if (!screen.orientation?.unlock) {
      return { success: false, reason: 'not_supported' };
    }

    screen.orientation.unlock();
    console.log('[Orientation] ‚úÖ Unlocked');
    return { success: true };
  }

  HEYS.orientation = {
    isSupported: () => !!screen.orientation?.lock,
    lock: lockOrientation,
    unlock: unlockOrientation,
    get current() { return screen.orientation?.type || 'unknown'; },
    get angle() { return screen.orientation?.angle || 0; },
    onChange: (callback) => {
      screen.orientation?.addEventListener('change', callback);
      return () => screen.orientation?.removeEventListener('change', callback);
    }
  };

  // === Fullscreen API ===
  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º

  async function enterFullscreen(element = document.documentElement) {
    try {
      if (element.requestFullscreen) {
        await element.requestFullscreen();
      } else if (element.webkitRequestFullscreen) {
        await element.webkitRequestFullscreen();
      } else if (element.msRequestFullscreen) {
        await element.msRequestFullscreen();
      } else {
        return { success: false, reason: 'not_supported' };
      }

      console.log('[Fullscreen] ‚úÖ Entered fullscreen');

      if (window.HEYS?.haptic) {
        HEYS.haptic.light();
      }

      return { success: true };
    } catch (e) {
      console.error('[Fullscreen] Enter error:', e);
      return { success: false, error: e.message };
    }
  }

  async function exitFullscreen() {
    try {
      if (document.exitFullscreen) {
        await document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        await document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        await document.msExitFullscreen();
      } else {
        return { success: false, reason: 'not_supported' };
      }

      console.log('[Fullscreen] ‚úÖ Exited fullscreen');
      return { success: true };
    } catch (e) {
      console.error('[Fullscreen] Exit error:', e);
      return { success: false, error: e.message };
    }
  }

  function isFullscreen() {
    return !!(
      document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.msFullscreenElement
    );
  }

  HEYS.fullscreen = {
    isSupported: () => !!(document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen),
    enter: enterFullscreen,
    exit: exitFullscreen,
    toggle: async (element) => isFullscreen() ? exitFullscreen() : enterFullscreen(element),
    get isActive() { return isFullscreen(); },
    onChange: (callback) => {
      const events = ['fullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'];
      events.forEach(e => document.addEventListener(e, callback));
      return () => events.forEach(e => document.removeEventListener(e, callback));
    }
  };

  // === Vibration Pattern API ===
  // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∏–±—Ä–∞—Ü–∏–∏

  const VIBRATION_PATTERNS = {
    success: [50, 30, 50],           // –ö–æ—Ä–æ—Ç–∫–∏–π –¥–≤–æ–π–Ω–æ–π
    error: [100, 50, 100, 50, 100],  // –¢—Ä–æ–π–Ω–æ–π
    warning: [200, 100, 200],        // –î–≤–æ–π–Ω–æ–π –¥–ª–∏–Ω–Ω—ã–π
    notification: [50, 100, 50, 100, 50], // –ë—ã—Å—Ç—Ä–∞—è —Å–µ—Ä–∏—è
    heartbeat: [100, 200, 100, 400], // –ö–∞–∫ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ
    sos: [100, 50, 100, 50, 100, 200, 300, 50, 300, 50, 300, 200, 100, 50, 100, 50, 100], // SOS
    countdown: [100, 800, 100, 800, 100, 800, 500], // –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç
    levelUp: [50, 50, 50, 50, 50, 50, 200] // –ù–∞—Ä–∞—Å—Ç–∞—é—â–∏–π
  };

  function vibratePattern(pattern) {
    if (!navigator.vibrate) {
      return false;
    }

    const p = typeof pattern === 'string' ? VIBRATION_PATTERNS[pattern] : pattern;

    if (!p) {
      console.warn('[Vibration] Unknown pattern:', pattern);
      return false;
    }

    navigator.vibrate(p);
    return true;
  }

  HEYS.vibration = {
    isSupported: () => 'vibrate' in navigator,
    patterns: VIBRATION_PATTERNS,
    play: vibratePattern,
    stop: () => navigator.vibrate?.(0),
    // –£–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    success: () => vibratePattern('success'),
    error: () => vibratePattern('error'),
    warning: () => vibratePattern('warning'),
    notification: () => vibratePattern('notification'),
    heartbeat: () => vibratePattern('heartbeat'),
    levelUp: () => vibratePattern('levelUp')
  };

  // === Web Animations API utilities ===
  // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π

  function animateElement(element, keyframes, options = {}) {
    if (!element?.animate) {
      return null;
    }

    const defaultOptions = {
      duration: 300,
      easing: 'ease-out',
      fill: 'forwards'
    };

    return element.animate(keyframes, { ...defaultOptions, ...options });
  }

  // –ì–æ—Ç–æ–≤—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
  const ANIMATIONS = {
    fadeIn: [
      { opacity: 0 },
      { opacity: 1 }
    ],
    fadeOut: [
      { opacity: 1 },
      { opacity: 0 }
    ],
    slideUp: [
      { transform: 'translateY(100%)', opacity: 0 },
      { transform: 'translateY(0)', opacity: 1 }
    ],
    slideDown: [
      { transform: 'translateY(-100%)', opacity: 0 },
      { transform: 'translateY(0)', opacity: 1 }
    ],
    scaleIn: [
      { transform: 'scale(0.8)', opacity: 0 },
      { transform: 'scale(1)', opacity: 1 }
    ],
    scaleOut: [
      { transform: 'scale(1)', opacity: 1 },
      { transform: 'scale(0.8)', opacity: 0 }
    ],
    shake: [
      { transform: 'translateX(0)' },
      { transform: 'translateX(-10px)' },
      { transform: 'translateX(10px)' },
      { transform: 'translateX(-10px)' },
      { transform: 'translateX(10px)' },
      { transform: 'translateX(0)' }
    ],
    pulse: [
      { transform: 'scale(1)' },
      { transform: 'scale(1.05)' },
      { transform: 'scale(1)' }
    ],
    bounce: [
      { transform: 'translateY(0)' },
      { transform: 'translateY(-20px)' },
      { transform: 'translateY(0)' },
      { transform: 'translateY(-10px)' },
      { transform: 'translateY(0)' }
    ],
    spin: [
      { transform: 'rotate(0deg)' },
      { transform: 'rotate(360deg)' }
    ],
    confetti: [
      { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
      { transform: 'translateY(-200px) rotate(720deg)', opacity: 0 }
    ]
  };

  HEYS.animate = {
    isSupported: () => !!document.documentElement.animate,
    element: animateElement,
    presets: ANIMATIONS,
    fadeIn: (el, opts) => animateElement(el, ANIMATIONS.fadeIn, opts),
    fadeOut: (el, opts) => animateElement(el, ANIMATIONS.fadeOut, opts),
    slideUp: (el, opts) => animateElement(el, ANIMATIONS.slideUp, opts),
    slideDown: (el, opts) => animateElement(el, ANIMATIONS.slideDown, opts),
    scaleIn: (el, opts) => animateElement(el, ANIMATIONS.scaleIn, opts),
    scaleOut: (el, opts) => animateElement(el, ANIMATIONS.scaleOut, opts),
    shake: (el, opts = { duration: 500 }) => animateElement(el, ANIMATIONS.shake, opts),
    pulse: (el, opts = { duration: 400, iterations: 2 }) => animateElement(el, ANIMATIONS.pulse, opts),
    bounce: (el, opts = { duration: 600 }) => animateElement(el, ANIMATIONS.bounce, opts),
    spin: (el, opts = { duration: 500 }) => animateElement(el, ANIMATIONS.spin, opts)
  };

  // ============================================================================
  // MODULE EXPORTS
  // ============================================================================

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ Platform APIs –≤ namespace
  HEYS.PlatformAPIs = {
    // Service Worker
    registerServiceWorker: registerServiceWorker,
    triggerSkipWaiting: triggerSkipWaiting,
    forceUpdateAndReload: forceUpdateAndReload,

    // Update helpers
    getAppVersion: getAppVersion,
    isNewerVersion: isNewerVersion,
    isUpdateLocked: isUpdateLocked,
    setUpdateLock: setUpdateLock,
    clearUpdateLock: clearUpdateLock,
    showUpdateBadge: showUpdateBadge,
    hideUpdateBadge: hideUpdateBadge,
    showUpdateModal: showUpdateModal,
    updateModalStage: updateModalStage,
    hideUpdateModal: hideUpdateModal,
    showManualRefreshPrompt: showManualRefreshPrompt,
    installUpdate: installUpdate,
    getNetworkQuality: getNetworkQuality,
    smartVersionCheck: smartVersionCheck,
    checkServerVersion: checkServerVersion,
    getUpdateState: () => ({ available: _updateAvailable, version: _updateVersion }),

    // Storage
    storage: {
      requestPersistent: requestPersistentStorage,
      getEstimate: getStorageEstimate
    },

    // –£–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ API –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ HEYS.*
    // (device, idle, barcode, share, contacts, speech, etc.)
  };

  // Performance tracking end
  HEYS.modulePerf?.endLoad('platform_apis', true);

  // Backward compatibility globals
  window.isUpdateLocked = window.isUpdateLocked || isUpdateLocked;
  window.setUpdateLock = window.setUpdateLock || setUpdateLock;
  window.clearUpdateLock = window.clearUpdateLock || clearUpdateLock;
  window.showUpdateBadge = window.showUpdateBadge || showUpdateBadge;
  window.hideUpdateModal = window.hideUpdateModal || hideUpdateModal;
  window.showUpdateModal = window.showUpdateModal || showUpdateModal;
  window.updateModalStage = window.updateModalStage || updateModalStage;
  window.getNetworkQuality = window.getNetworkQuality || getNetworkQuality;
  window.showManualRefreshPrompt = window.showManualRefreshPrompt || showManualRefreshPrompt;
  window.checkServerVersion = window.checkServerVersion || checkServerVersion;

  // üöÄ Auto-register Service Worker on module load
  // This was previously called from runVersionGuard() in heys_app_v12.js
  registerServiceWorker();

  if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
    console.log('[PlatformAPIs] ‚úÖ Module loaded successfully');
  }
})();


/* ===== heys_pwa_module_v1.js ===== */
/**
 * HEYS PWA Update Manager v1.0
 * =============================
 * Progressive Web App update management and version control
 * 
 * Features:
 * - Version tracking & semantic comparison
 * - Update badge notification (non-intrusive)
 * - Update modal with progress stages
 * - Network quality detection
 * - Smart periodic version checks
 * - Manual refresh prompts (iOS fallback)
 * - Update lock/unlock mechanisms
 * - Exponential backoff for failed checks
 * 
 * Scientific Foundation:
 * - Progressive Enhancement (Aaron Gustafson, 2008)
 * - User-Centric Performance Metrics (Google Web Vitals)
 * - Service Worker Lifecycle (W3C)
 * 
 * @version 1.0.0
 * @feature-flag modular_pwa
 */

(function () {
  'use strict';

  const HEYS = window.HEYS = window.HEYS || {};

  // Check feature flag - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è legacy mode, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–æ–¥—É–ª—å
  if (HEYS.featureFlags?.isEnabled('use_legacy_monolith')) {
    if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
      console.log('[PWA] ‚è≠Ô∏è Skipped (legacy monolith mode)');
    }
    return;
  }

  // Performance tracking start
  HEYS.modulePerf?.startLoad('pwa_module');

  if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
    console.log('[PWA] üì¶ Loading module...');
  }

  // ============================================================================
  // EXTRACTED CODE FROM heys_app_v12.js (lines 18-479)
  // ============================================================================

  // === App Version & Auto-logout on Update ===
  const APP_VERSION = '2026.02.28.0012.1ca916fe'; // synced with build-meta.json on 2026-02-26

  HEYS.version = APP_VERSION;

  // üîç PWA Debug helper ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å boot –ª–æ–≥ (–≤—ã–∑–≤–∞—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
  HEYS.showBootLog = function () {
    try {
      const log = JSON.parse(localStorage.getItem('heys_boot_log') || '[]');
      console.table(log);
      return log;
    } catch (e) {
      console.log('No boot log');
      return [];
    }
  };

  // üîç PWA Debug ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å vConsole
  HEYS.enableDebug = function (enabled = true) {
    localStorage.setItem('heys_debug', enabled ? '1' : '0');
    console.log('Debug mode:', enabled ? 'ON (reload to see vConsole)' : 'OFF');
  };

  // === –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π ===
  // –í–µ—Ä—Å–∏—è: YYYY.MM.DD.HHMM.hash ‚Üí —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å
  const getUpdateHelpers = () => HEYS.PlatformAPIs || {};

  const isNewerVersion = (serverVersion, currentVersion) => {
    return HEYS.PlatformAPIs?.isNewerVersion?.(serverVersion, currentVersion) ?? false;
  };

  const isUpdateLocked = () => getUpdateHelpers().isUpdateLocked?.() ?? false;
  const setUpdateLock = () => getUpdateHelpers().setUpdateLock?.();
  const clearUpdateLock = () => getUpdateHelpers().clearUpdateLock?.();
  const showUpdateBadge = (version) => getUpdateHelpers().showUpdateBadge?.(version);
  const hideUpdateBadge = () => getUpdateHelpers().hideUpdateBadge?.();
  const showUpdateModal = (stage) => getUpdateHelpers().showUpdateModal?.(stage);
  const updateModalStage = (stage) => getUpdateHelpers().updateModalStage?.(stage);
  const hideUpdateModal = () => getUpdateHelpers().hideUpdateModal?.();
  const showManualRefreshPrompt = (version) => getUpdateHelpers().showManualRefreshPrompt?.(version);
  const checkServerVersion = (silent = true) => getUpdateHelpers().checkServerVersion?.(silent);
  const getNetworkQuality = () => getUpdateHelpers().getNetworkQuality?.() || { type: 'unknown', quality: 'good' };
  const smartVersionCheck = () => getUpdateHelpers().smartVersionCheck?.();

  HEYS.installUpdate = async () => {
    return getUpdateHelpers().installUpdate?.();
  };

  // ============================================================================
  // MODULE EXPORTS
  // ============================================================================

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º PWA API –≤ namespace
  HEYS.PWA = {
    // Version
    version: APP_VERSION,
    isNewerVersion: isNewerVersion,

    // Update lock
    isUpdateLocked: isUpdateLocked,
    setUpdateLock: setUpdateLock,
    clearUpdateLock: clearUpdateLock,

    // Update badge
    showUpdateBadge: showUpdateBadge,
    hideUpdateBadge: hideUpdateBadge,
    installUpdate: HEYS.installUpdate,

    // Network quality
    getNetworkQuality: getNetworkQuality,

    // Smart checks
    smartVersionCheck: smartVersionCheck,
    checkServerVersion: checkServerVersion,

    // Update modal
    showUpdateModal: showUpdateModal,
    updateModalStage: updateModalStage,
    hideUpdateModal: hideUpdateModal,

    // Manual refresh
    showManualRefreshPrompt: showManualRefreshPrompt,

    // Expose globals for backward compatibility
    _updateAvailable: () => (HEYS.PlatformAPIs?.getUpdateState?.().available ?? false),
    _updateVersion: () => (HEYS.PlatformAPIs?.getUpdateState?.().version ?? null)
  };

  // Performance tracking end
  HEYS.modulePerf?.endLoad('pwa_module', true);

  if (HEYS.featureFlags?.isEnabled('dev_module_logging')) {
    console.log('[PWA] ‚úÖ Module loaded successfully');
  }
})();


/* ===== heys_simple_analytics.js ===== */
/**
 * HEYS Simple Analytics v1.0
 * –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É—á–µ—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è
 * 
 * –ó–∞–º–µ–Ω—è–µ—Ç 11,500+ —Å—Ç—Ä–æ–∫ –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ ~100 —Å—Ç—Ä–æ–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞
 * 
 * –ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:
 * - –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (>1s)
 * - –ú–µ–¥–ª–µ–Ω–Ω—ã–µ API –≤—ã–∑–æ–≤—ã (>2s)
 * - –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ (–∫–µ—à, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
 * - JavaScript –æ—à–∏–±–∫–∏
 * 
 * –ß—Ç–æ –ù–ï –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è (–∏–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è nutrition app):
 * - FPS –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
 * - –î–µ—Ç–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å
 * - –ö–ª–∏–∫–∏ –∏ —Å–∫—Ä–æ–ª–ª—ã
 * - Browser fingerprinting
 */

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================

  // –ü–æ—Ä–æ–≥–∏ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
  const THRESHOLDS = {
    SLOW_SEARCH: 1000,      // 1 —Å–µ–∫—É–Ω–¥–∞
    SLOW_API: 2000,         // 2 —Å–µ–∫—É–Ω–¥—ã
    CRITICAL_API: 5000      // 5 —Å–µ–∫—É–Ω–¥
  };

  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
  const CONVERSION = {
    MS_TO_SECONDS: 1000     // –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã ‚Üí —Å–µ–∫—É–Ω–¥—ã
  };

  // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  const stats = {
    searches: { total: 0, slow: 0 },
    apiCalls: { total: 0, slow: 0, failed: 0 },
    errors: { total: 0 },
    cacheHits: 0,
    cacheMisses: 0,
    sessionStart: Date.now()
  };

  const DEBUG_EVENTS_KEY = 'heys_debug_events';
  const DEBUG_EVENTS_LIMIT = 50;
  const debugEvents = [];

  const readStoredValue = (key, fallback = null) => {
    let value;
    if (HEYS.store?.get) {
      value = HEYS.store.get(key, fallback);
    } else if (HEYS.utils?.lsGet) {
      value = HEYS.utils.lsGet(key, fallback);
    } else {
      try {
        value = localStorage.getItem(key);
      } catch (e) {
        return fallback;
      }
    }

    if (value == null) return fallback;

    if (typeof value === 'string') {
      if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try {
          value = HEYS.store.decompress(value.slice(3));
        } catch (e) { }
      }
      try {
        return JSON.parse(value);
      } catch (e) {
        return value;
      }
    }

    return value;
  };

  const writeStoredValue = (key, value) => {
    if (HEYS.store?.set) {
      return HEYS.store.set(key, value);
    }
    if (HEYS.utils?.lsSet) {
      return HEYS.utils.lsSet(key, value);
    }
    localStorage.setItem(key, JSON.stringify(value));
  };

  function recordDebugEvent(type, payload) {
    try {
      const entry = {
        t: Date.now(),
        type: type || 'unknown',
        payload: payload || null
      };
      debugEvents.push(entry);
      if (debugEvents.length > DEBUG_EVENTS_LIMIT) {
        debugEvents.splice(0, debugEvents.length - DEBUG_EVENTS_LIMIT);
      }
      try {
        writeStoredValue(DEBUG_EVENTS_KEY, debugEvents);
      } catch (e) { }
    } catch (e) { }
  }

  // ==================== CORE –§–£–ù–ö–¶–ò–ò ====================

  /**
   * –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   * –õ–æ–≥–∏—Ä—É–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   * 
   * @param {string} query - –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {number} resultsCount - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   * @param {number} duration - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
   * 
   * @example
   * trackSearch('—Ç–≤–æ—Ä–æ–≥', 15, 450); // –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫, –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
   * trackSearch('–º–æ–ª–æ–∫–æ', 120, 1500); // –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
   */
  function trackSearch(query, resultsCount, duration) {
    stats.searches.total++;

    if (duration > THRESHOLDS.SLOW_SEARCH) {
      stats.searches.slow++;
      DEV.warn('[HEYS Analytics] –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫:', {
        query: query,
        duration: `${duration.toFixed(0)}ms`,
        results: resultsCount,
        threshold: `${THRESHOLDS.SLOW_SEARCH}ms`
      });
    }
  }

  /**
   * –¢—Ä–µ–∫–∏–Ω–≥ API –≤—ã–∑–æ–≤–æ–≤ (Supabase, –ø–∞—Ä—Å–∏–Ω–≥ –∏ —Ç.–¥.)
   * –ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ backend
   * 
   * @param {string} apiName - –ù–∞–∑–≤–∞–Ω–∏–µ API –º–µ—Ç–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'supabase.products.list')
   * @param {number} duration - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
   * @param {boolean} [success=true] - –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
   * 
   * @example
   * trackApiCall('supabase.signin', 800, true); // –ë—ã—Å—Ç—Ä—ã–π —É—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤
   * trackApiCall('fdc.search', 3000, true); // –ú–µ–¥–ª–µ–Ω–Ω—ã–π, –Ω–æ —É—Å–ø–µ—à–Ω—ã–π
   * trackApiCall('fdc.search', 500, false); // –ë—ã—Å—Ç—Ä–∞—è –æ—à–∏–±–∫–∞
   */
  function trackApiCall(apiName, duration, success = true) {
    stats.apiCalls.total++;

    if (!success) {
      stats.apiCalls.failed++;
      console.error('[HEYS Analytics] API –æ—à–∏–±–∫–∞:', {
        api: apiName,
        duration: `${duration.toFixed(0)}ms`
      });
      return;
    }

    if (duration > THRESHOLDS.CRITICAL_API) {
      stats.apiCalls.slow++;
      console.error('[HEYS Analytics] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π API:', {
        api: apiName,
        duration: `${duration.toFixed(0)}ms`,
        threshold: `${THRESHOLDS.CRITICAL_API}ms`
      });
    } else if (duration > THRESHOLDS.SLOW_API) {
      stats.apiCalls.slow++;
      DEV.warn('[HEYS Analytics] –ú–µ–¥–ª–µ–Ω–Ω—ã–π API:', {
        api: apiName,
        duration: `${duration.toFixed(0)}ms`,
        threshold: `${THRESHOLDS.SLOW_API}ms`
      });
    }
  }

  /**
   * –¢—Ä–µ–∫–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏
   * –ü–æ–º–æ–≥–∞–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
   * 
   * @param {string} operationType - –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: 'cache-hit' | 'cache-miss'
  * @param {number} [count=1] - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π (–¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π)
  * @param {Object} [meta] - –î–æ–ø. –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è debug-—Å–æ–±—ã—Ç–∏–π)
   * 
   * @example
   * trackDataOperation('cache-hit'); // –ù–∞–π–¥–µ–Ω–æ –≤ –∫–µ—à–µ
   * trackDataOperation('cache-miss'); // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
   * trackDataOperation('cache-hit', 50); // Batch –æ–ø–µ—Ä–∞—Ü–∏—è
   */
  function trackDataOperation(operationType, count = 1, meta) {
    switch (operationType) {
      case 'cache-hit':
        stats.cacheHits += count;
        break;
      case 'cache-miss':
        stats.cacheMisses += count;
        break;
      default:
        recordDebugEvent(operationType, {
          count: typeof count === 'number' ? count : 1,
          meta: meta || null
        });
        break;
    }
  }

  /**
   * –ë–∞–∑–æ–≤—ã–π error tracking
   * –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ JavaScript –æ—à–∏–±–∫–∏
   * 
   * @param {Error|string} error - –û–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
   * @param {string} [source='unknown'] - –ò—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–∫–∏ (–º–æ–¥—É–ª—å, —Ñ—É–Ω–∫—Ü–∏—è)
   * 
   * @example
   * trackError(new Error('Failed to fetch'), 'ProductsManager.search');
   * trackError('Invalid JSON format', 'localStorage.parse');
   */
  function trackError(error, source = 'unknown') {
    stats.errors.total++;
    console.error('[HEYS Analytics] –û—à–∏–±–∫–∞:', {
      message: error.message || String(error),
      source: source,
      stack: error.stack || 'N/A'
    });
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Å—Å–∏–∏
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –ø–æ–∏—Å–∫—É, API, –∫–µ—à—É –∏ –æ—à–∏–±–∫–∞–º
   * 
   * @returns {Object} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   * 
   * @example
   * const stats = getStats();
   * console.log(stats.searches.slowRate); // "15.5%"
   * console.log(stats.cache.hitRate); // "87.3%"
   */
  function getStats() {
    const sessionDuration = Date.now() - stats.sessionStart;
    const cacheTotal = stats.cacheHits + stats.cacheMisses;
    const cacheHitRate = cacheTotal > 0
      ? ((stats.cacheHits / cacheTotal) * 100).toFixed(1)
      : 0;

    return {
      session: {
        duration: `${(sessionDuration / CONVERSION.MS_TO_SECONDS).toFixed(0)}s`,
        start: new Date(stats.sessionStart).toISOString()
      },
      searches: {
        ...stats.searches,
        slowRate: stats.searches.total > 0
          ? `${((stats.searches.slow / stats.searches.total) * 100).toFixed(1)}%`
          : '0%'
      },
      apiCalls: {
        ...stats.apiCalls,
        slowRate: stats.apiCalls.total > 0
          ? `${((stats.apiCalls.slow / stats.apiCalls.total) * 100).toFixed(1)}%`
          : '0%',
        failRate: stats.apiCalls.total > 0
          ? `${((stats.apiCalls.failed / stats.apiCalls.total) * 100).toFixed(1)}%`
          : '0%'
      },
      cache: {
        hits: stats.cacheHits,
        misses: stats.cacheMisses,
        hitRate: `${cacheHitRate}%`
      },
      errors: stats.errors
    };
  }

  /**
   * –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ heysStats() –≤ DevTools
   * 
   * @returns {Object} –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏
   * 
   * @example
   * // –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:
   * heysStats(); // –í—ã–≤–µ–¥–µ—Ç –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   */
  function exportMetrics() {
    const metrics = getStats();
    DEV.log('[HEYS Analytics] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏:', metrics);
    return metrics;
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
  global.addEventListener('error', function (event) {
    trackError(event.error || new Error(event.message), 'window.onerror');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ promise rejections
  global.addEventListener('unhandledrejection', function (event) {
    trackError(new Error(event.reason), 'unhandledRejection');
  });

  // –≠–∫—Å–ø–æ—Ä—Ç –≤ HEYS namespace
  HEYS.analytics = {
    trackSearch,
    trackApiCall,
    trackDataOperation,
    trackError,
    getStats,
    exportMetrics,

    // Aliases –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å legacy –∫–æ–¥–æ–º
    trackModuleLoad: () => { }, // no-op
    trackComponentRender: () => { }, // no-op
    trackUserInteraction: () => { }, // no-op
    startTracking: () => { },
    stopTracking: () => { },
    reset: () => {
      stats.searches = { total: 0, slow: 0 };
      stats.apiCalls = { total: 0, slow: 0, failed: 0 };
      stats.errors = { total: 0 };
      stats.cacheHits = 0;
      stats.cacheMisses = 0;
      stats.sessionStart = Date.now();
    },
    getMetrics: getStats,
    trackEvent: () => { } // no-op alias
  };

  // Alias –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å heys_reports_v12.js
  HEYS.performance = {
    // –ú–µ—Ç–æ–¥—ã –∏–∑ analytics
    ...HEYS.analytics,

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è reports
    increment: (metric) => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º trackDataOperation –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      trackDataOperation(metric, 1);
    },

    measure: (name, fn) => {
      // –ü—Ä–æ—Å—Ç–æ–π wrapper –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
      // (–¥–ª—è reports –≤—Ä–µ–º—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
      return fn();
    }
  };

  // –õ–æ–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —á–∏—Å—Ç–æ–π –∫–æ–Ω—Å–æ–ª–∏

  // Debug: —ç–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π scope –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  global.heysStats = getStats;

})(window);


/* ===== heys_smart_search_v2.js ===== */
// heys_smart_search_v2.js ‚Äî –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ–ø–µ—á–∞—Ç–æ–∫, —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
// –í–µ—Ä—Å–∏—è 2.7.0 | 2025-12-17
// ‚úÖ Nutrient Search (high protein, keto, etc.)
// ‚úÖ Context Search (breakfast, gym)
// ‚úÖ Improved Fuzzy Search (translit + typos)
// ‚úÖ üÜï Visual Feedback ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–ª–∏/—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–ª–∏
// ‚úÖ üÜï Brand Matching ‚Äî fuzzy –ø–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥–∞–º (Danone, –ü—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ)
// ‚úÖ üÜï ML-lite Similarity ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –±–ª–∏–∑–æ—Å—Ç—å –±–µ–∑ ML
// ‚úÖ üÜï Smart Suggestions ‚Äî —É–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
// ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —ë ‚Üí –µ
// ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫ (–õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω)
// ‚úÖ –°–∏–Ω–æ–Ω–∏–º—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (100+ –≥—Ä—É–ø–ø)
// ‚úÖ –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
// ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
// ‚úÖ –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
// ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (highlightMatches)
// ‚úÖ "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" (getDidYouMean)
// ‚úÖ –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è (ru ‚Üî en): protein ‚Üí –ø—Ä–æ—Ç–µ–∏–Ω, —Ç–æ–ø–ø–∏–Ω–≥ ‚Üí topping
// ‚úÖ Fuzzy-—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è: fines ‚Üí fitness/—Ñ–∏—Ç–Ω–µ—Å, —Ñ–∏–Ω—Ç–µ—Å ‚Üí —Ñ–∏—Ç–Ω–µ—Å
// ‚úÖ üÜï QWERTY‚Üî–ô–¶–£–ö–ï–ù: vfkjrj ‚Üí –º–æ–ª–æ–∫–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞)
// ‚úÖ üÜï –°–æ–∫—Ä–∞—â–µ–Ω–∏—è: –±/–∂, 0%, –∫–∫–∞–ª ‚Üí –±–µ–∑ –∂–∏—Ä–∞, –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π, –∫–∞–ª–æ—Ä–∏–∏
// ‚úÖ üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤: "—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π" = "–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π —Ç–≤–æ—Ä–æ–≥"
// ‚úÖ üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã—à–µ
// ‚úÖ üÜï N-gram –ø–æ–∏—Å–∫: –ø–æ–∏—Å–∫ –ø–æ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —Å–ª–æ–≤–∞
// ‚úÖ üÜï –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: –ø–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É –ø—Ä–æ–¥—É–∫—Ç–∞
// ‚úÖ üÜï Token-aware scoring: —É–º–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–ª–æ–≤–∞–º –∑–∞–ø—Ä–æ—Å–∞
// ‚úÖ üÜï Numeric-aware –ø–æ–∏—Å–∫: 2.5% / 0% / 250–≥ / 1–ª ‚Äî —Ç–æ—á–Ω–µ–µ –ø–æ —Ü–∏—Ñ—Ä–∞–º
// ‚úÖ üÜï –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤: –±—ã—Å—Ç—Ä–µ–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤

; (function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
  const CONFIG = {
    minQueryLength: 2,        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞
    maxResults: 50,           // –ú–∞–∫—Å–∏–º—É–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    maxSuggestions: 5,        // –ú–∞–∫—Å–∏–º—É–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    cacheEnabled: true,       // –í–∫–ª—é—á–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    cacheTimeout: 300000,     // 5 –º–∏–Ω—É—Ç –∫–µ—à–∞
    enablePhonetic: true,     // –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
    enableSynonyms: true,     // –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
    enableTypoCorrection: true, // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
    enableTranslit: true,     // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è ru ‚Üî en
    enableKeyboardFix: true,  // üÜï –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ QWERTY‚Üî–ô–¶–£–ö–ï–ù
    enableAbbreviations: true, // üÜï –°–æ–∫—Ä–∞—â–µ–Ω–∏—è (–±/–∂, 0%, –∫–∫–∞–ª)
    enableWordPermutations: true, // üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
    enableNgram: true,        // üÜï N-gram –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç—è–º —Å–ª–æ–≤–∞
    enablePersonalization: true, // üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    debugMode: false,         // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏

    // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
    getMaxTypoDistance(queryLength) {
      if (queryLength <= 3) return 1;
      if (queryLength <= 5) return 2;
      return 3;
    }
  };

  // === –ö–ï–®–ò –ò –ò–ù–î–ï–ö–°–´ ===
  let searchCache = new Map();
  let productIndex = null;      // –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  let lastProductsHash = null;  // –•–µ—à –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–Ω–¥–µ–∫—Å–∞

  // === –°–õ–û–í–ê–†–ò ===

  // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–∏)
  const commonWords = new Set([
    '—Ö–ª–µ–±', '–º–æ–ª–æ–∫–æ', '–º—è—Å–æ', '—Ä—ã–±–∞', '–æ–≤–æ—â–∏', '—Ñ—Ä—É–∫—Ç—ã', '–∫—Ä—É–ø–∞', '–º–∞–∫–∞—Ä–æ–Ω—ã',
    '—Å—ã—Ä', '–º–∞—Å–ª–æ', '—è–π—Ü–∞', '–∫—É—Ä–∏—Ü–∞', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å',
    '–º–æ—Ä–∫–æ–≤—å', '–ª—É–∫', '–ø–æ–º–∏–¥–æ—Ä', '–æ–≥—É—Ä–µ—Ü', '—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω',
    '—Ç–≤–æ—Ä–æ–≥', '–∫–µ—Ñ–∏—Ä', '–π–æ–≥—É—Ä—Ç', '—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–æ–≤—Å—è–Ω–∫–∞', '–∫–∞—à–∞',
    '—Å–∞–ª–∞—Ç', '–∫–∞–ø—É—Å—Ç–∞', '–ø–µ—Ä–µ—Ü', '—á–µ—Å–Ω–æ–∫', '–∑–µ–ª–µ–Ω—å', '—É–∫—Ä–æ–ø', '–ø–µ—Ç—Ä—É—à–∫–∞',
    '–º–µ–¥', '—Å–∞—Ö–∞—Ä', '—Å–æ–ª—å', '–∫–æ—Ñ–µ', '—á–∞–π', '—Å–æ–∫', '–≤–æ–¥–∞', '–∫–æ–º–ø–æ—Ç',
    '–∫–æ–ª–±–∞—Å–∞', '—Å–æ—Å–∏—Å–∫–∏', '–≤–µ—Ç—á–∏–Ω–∞', '–±–µ–∫–æ–Ω', '—Ñ–∞—Ä—à', '–∫–æ—Ç–ª–µ—Ç–∞', '—Å—Ç–µ–π–∫',
    '—Ä—ã–±–∞', '—Å–µ–º–≥–∞', '–ª–æ—Å–æ—Å—å', '—Ç—Ä–µ—Å–∫–∞', '—Ç—É–Ω–µ—Ü', '–∫—Ä–µ–≤–µ—Ç–∫–∏', '–∫–∞–ª—å–º–∞—Ä',
    '—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–ø–µ—á–µ–Ω—å–µ', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–≥', '–±—É–ª–æ—á–∫–∞', '–∫—Ä—É–∞—Å—Å–∞–Ω',
    '–æ—Ä–µ—Ö–∏', '–º–∏–Ω–¥–∞–ª—å', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '–∞—Ä–∞—Ö–∏—Å', '—Å–µ–º–µ—á–∫–∏',
    '–∞–≤–æ–∫–∞–¥–æ', '–º–∞–Ω–≥–æ', '–∫–∏–≤–∏', '–∞–Ω–∞–Ω–∞—Å', '–≤–∏–Ω–æ–≥—Ä–∞–¥', '–∫–ª—É–±–Ω–∏–∫–∞', '–º–∞–ª–∏–Ω–∞'
  ]);

  // –°–∏–Ω–æ–Ω–∏–º—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å)
  const synonyms = {
    // –ú–æ–ª–æ—á–Ω—ã–µ
    '–º–æ–ª–æ–∫–æ': ['–º–æ–ª–æ—á–∫–æ', '–º–æ–ª–æ—á–Ω—ã–π', '–º–æ–ª–æ—á–∫–∞'],
    '—Ç–≤–æ—Ä–æ–≥': ['—Ç–≤–æ—Ä–æ–∂–æ–∫', '—Ç–≤–æ—Ä–æ–∂–Ω—ã–π', '—Ç–≤–æ—Ä–æ–∂–Ω–∞—è'],
    '—Å—ã—Ä': ['—Å—ã—Ä–æ–∫', '—Å—ã—Ä–Ω—ã–π'],
    '–∫–µ—Ñ–∏—Ä': ['–∫–µ—Ñ–∏—Ä–Ω—ã–π', '–∫–µ—Ñ–∏—Ä—á–∏–∫'],
    '–π–æ–≥—É—Ä—Ç': ['–π–æ–≥—É—Ä—Ç–æ–≤—ã–π', '–π–æ–≥—É—Ä—Ç–∏–∫'],
    '—Å–º–µ—Ç–∞–Ω–∞': ['—Å–º–µ—Ç–∞–Ω–∫–∞', '—Å–º–µ—Ç–∞–Ω–Ω—ã–π'],
    '—Å–ª–∏–≤–∫–∏': ['—Å–ª–∏–≤–æ—á–Ω—ã–π', '—Å–ª–∏–≤–æ—á–∫–∏'],

    // –ú—è—Å–æ
    '–∫—É—Ä–∏—Ü–∞': ['–∫—É—Ä–∏–Ω—ã–π', '–∫—É—Ä–∏–Ω–∞—è', '–∫—É—Ä—è—Ç–∏–Ω–∞', '—Ü—ã–ø–ª–µ–Ω–æ–∫', '–ø—Ç–∏—Ü–∞', '–∫—É—Ä–∞'],
    '–≥–æ–≤—è–¥–∏–Ω–∞': ['–≥–æ–≤—è–∂–∏–π', '–≥–æ–≤—è–∂—å—è', '—Ç–µ–ª—è—Ç–∏–Ω–∞', '—Ç–µ–ª–µ–Ω–æ–∫'],
    '—Å–≤–∏–Ω–∏–Ω–∞': ['—Å–≤–∏–Ω–æ–π', '—Å–≤–∏–Ω–∞—è', '–ø–æ—Ä–æ—Å–µ–Ω–æ–∫'],
    '–∏–Ω–¥–µ–π–∫–∞': ['–∏–Ω–¥—é—à–∫–∞', '–∏–Ω–¥—é—à–∞—Ç–∏–Ω–∞', '–∏–Ω–¥—é—à–∏–Ω—ã–π'],
    '–±–∞—Ä–∞–Ω–∏–Ω–∞': ['–±–∞—Ä–∞–Ω–∏–π', '–±–∞—Ä–∞–Ω—å—è', '—è–≥–Ω–µ–Ω–æ–∫'],
    '–º—è—Å–æ': ['–º—è—Å–Ω–æ–π', '–º—è—Å–Ω–∞—è', '–º—è—Å–Ω—ã–µ'],
    '—Ñ–∞—Ä—à': ['—Ñ–∞—Ä—à–µ–≤—ã–π'],

    // –†—ã–±–∞
    '—Ä—ã–±–∞': ['—Ä—ã–±–Ω—ã–π', '—Ä—ã–±–Ω–∞—è', '—Ä—ã–±–∫–∞'],
    '—Å–µ–º–≥–∞': ['—Å–µ–º—É–∂–∫–∞', '–ª–æ—Å–æ—Å—å', '–∫—Ä–∞—Å–Ω–∞—è —Ä—ã–±–∞'],
    '–ª–æ—Å–æ—Å—å': ['—Å–µ–º–≥–∞', '–∫—Ä–∞—Å–Ω–∞—è —Ä—ã–±–∞'],
    '—Ç—Ä–µ—Å–∫–∞': ['—Ç—Ä–µ—Å–∫–æ–≤—ã–π'],
    '—Ç—É–Ω–µ—Ü': ['—Ç—É–Ω—Ü–æ–≤—ã–π'],

    // –û–≤–æ—â–∏
    '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å': ['–∫–∞—Ä—Ç–æ—à–∫–∞', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π', '–∫–∞—Ä—Ç–æ—à–µ—á–∫–∞', '–∫–∞—Ä—Ç–æ—Ö–∞'],
    '–ø–æ–º–∏–¥–æ—Ä': ['—Ç–æ–º–∞—Ç', '—Ç–æ–º–∞—Ç–Ω—ã–π', '–ø–æ–º–∏–¥–æ—Ä–∫–∞', '–ø–æ–º–∏–¥–æ—Ä—á–∏–∫'],
    '–æ–≥—É—Ä–µ—Ü': ['–æ–≥—É—Ä—á–∏–∫', '–æ–≥—É—Ä–µ—á–Ω—ã–π', '–∫–æ—Ä–Ω–∏—à–æ–Ω'],
    '–∫–∞–ø—É—Å—Ç–∞': ['–∫–∞–ø—É—Å—Ç–Ω—ã–π', '–∫–∞–ø—É—Å—Ç–∫–∞'],
    '–º–æ—Ä–∫–æ–≤—å': ['–º–æ—Ä–∫–æ–≤–∫–∞', '–º–æ—Ä–∫–æ–≤–Ω—ã–π', '–º–æ—Ä–∫–æ–≤–æ—á–∫–∞'],
    '–ª—É–∫': ['–ª—É–∫–æ–≤—ã–π', '–ª—É—á–æ–∫', '—Ä–µ–ø—á–∞—Ç—ã–π'],
    '—á–µ—Å–Ω–æ–∫': ['—á–µ—Å–Ω–æ—á–Ω—ã–π', '—á–µ—Å–Ω–æ—á–æ–∫'],
    '–ø–µ—Ä–µ—Ü': ['–ø–µ—Ä—á–∏–∫', '–ø–µ—Ä—Ü–æ–≤—ã–π', '–±–æ–ª–≥–∞—Ä—Å–∫–∏–π'],
    '–±–∞–∫–ª–∞–∂–∞–Ω': ['–±–∞–∫–ª–∞–∂–∞–Ω–Ω—ã–π', '—Å–∏–Ω–µ–Ω—å–∫–∏–π'],
    '–∫–∞–±–∞—á–æ–∫': ['–∫–∞–±–∞—á–∫–æ–≤—ã–π', '—Ü—É–∫–∫–∏–Ω–∏'],
    '—Å–≤–µ–∫–ª–∞': ['—Å–≤–µ–∫–æ–ª—å–Ω—ã–π', '–±—É—Ä—è–∫'],
    '—Ä–µ–¥–∏—Å': ['—Ä–µ–¥–∏—Å–∫–∞', '—Ä–µ–¥–∏—Å–æ—á–∫–∞'],

    // –§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã
    '—è–±–ª–æ–∫–æ': ['—è–±–ª–æ—á–∫–æ', '—è–±–ª–æ—á–Ω—ã–π'],
    '–±–∞–Ω–∞–Ω': ['–±–∞–Ω–∞–Ω—á–∏–∫', '–±–∞–Ω–∞–Ω–æ–≤—ã–π'],
    '–∞–ø–µ–ª—å—Å–∏–Ω': ['–∞–ø–µ–ª—å—Å–∏–Ω—á–∏–∫', '–∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π', '—Ü–∏—Ç—Ä—É—Å'],
    '–ª–∏–º–æ–Ω': ['–ª–∏–º–æ–Ω—á–∏–∫', '–ª–∏–º–æ–Ω–Ω—ã–π'],
    '–≥—Ä—É—à–∞': ['–≥—Ä—É—à–∫–∞', '–≥—Ä—É—à–µ–≤—ã–π'],
    '–≤–∏–Ω–æ–≥—Ä–∞–¥': ['–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π', '–≤–∏–Ω–æ–≥—Ä–∞–¥–∏–∫'],
    '–∫–ª—É–±–Ω–∏–∫–∞': ['–∫–ª—É–±–Ω–∏—á–∫–∞', '–∫–ª—É–±–Ω–∏—á–Ω—ã–π', '–∑–µ–º–ª—è–Ω–∏–∫–∞'],
    '–º–∞–ª–∏–Ω–∞': ['–º–∞–ª–∏–Ω–∫–∞', '–º–∞–ª–∏–Ω–æ–≤—ã–π'],
    '—á–µ—Ä–Ω–∏–∫–∞': ['—á–µ—Ä–Ω–∏—á–∫–∞', '—á–µ—Ä–Ω–∏—á–Ω—ã–π'],
    '–∞—Ä–±—É–∑': ['–∞—Ä–±—É–∑–∏–∫', '–∞—Ä–±—É–∑–Ω—ã–π'],
    '–¥—ã–Ω—è': ['–¥—ã–Ω—å–∫–∞', '–¥—ã–Ω–Ω—ã–π'],

    // –ö—Ä—É–ø—ã –∏ –≥–∞—Ä–Ω–∏—Ä—ã
    '—Ä–∏—Å': ['—Ä–∏—Å–æ–≤—ã–π', '—Ä–∏—Å–æ–≤–∞—è'],
    '–≥—Ä–µ—á–∫–∞': ['–≥—Ä–µ—á–Ω–µ–≤—ã–π', '–≥—Ä–µ—á–Ω–µ–≤–∞—è', '–≥—Ä–µ—á–∞'],
    '–æ–≤—Å—è–Ω–∫–∞': ['–æ–≤—Å—è–Ω—ã–π', '–æ–≤—Å—è–Ω–∞—è', '–æ–≤–µ—Å', '–≥–µ—Ä–∫—É–ª–µ—Å'],
    '–º–∞–∫–∞—Ä–æ–Ω—ã': ['–º–∞–∫–∞—Ä–æ–Ω–Ω—ã–π', '–ø–∞—Å—Ç–∞', '—Å–ø–∞–≥–µ—Ç—Ç–∏', '–ª–∞–ø—à–∞'],
    '–∫–∞—à–∞': ['–∫–∞—à–∫–∞', '–∫–∞—à–Ω—ã–π'],
    '–ø—à–µ–Ω–æ': ['–ø—à–µ–Ω–Ω—ã–π', '–ø—à–µ–Ω–Ω–∞—è', '–ø—à–µ–Ω–∫–∞'],
    '–ø–µ—Ä–ª–æ–≤–∫–∞': ['–ø–µ—Ä–ª–æ–≤—ã–π', '–ø–µ—Ä–ª–æ–≤–∞—è'],
    '–±—É–ª–≥—É—Ä': ['–±—É–ª–≥—É—Ä–æ–≤—ã–π'],
    '–∫—É—Å–∫—É—Å': ['–∫—É—Å–∫—É—Å–æ–≤—ã–π'],
    '–∫–∏–Ω–æ–∞': ['–∫–∏–Ω–æ–∞'],

    // –•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞
    '—Ö–ª–µ–±': ['—Ö–ª–µ–±—É—à–µ–∫', '—Ö–ª–µ–±–Ω—ã–π', '–±–∞—Ç–æ–Ω', '–±—É—Ö–∞–Ω–∫–∞', '–±—É–ª–∫–∞', '–±–∞–≥–µ—Ç'],
    '–±—É–ª–æ—á–∫–∞': ['–±—É–ª–∫–∞', '—Å–¥–æ–±–∞', '–ø–ª—é—à–∫–∞'],
    '–∫—Ä—É–∞—Å—Å–∞–Ω': ['—Ä–æ–≥–∞–ª–∏–∫'],
    '–ø–µ—á–µ–Ω—å–µ': ['–ø–µ—á–µ–Ω—å–∫–∞', '–ø–µ—á–µ–Ω—å–∫–∏'],
    '—Ç–æ—Ä—Ç': ['—Ç–æ—Ä—Ç–∏–∫', '—Ç–æ—Ä—Ç—ã'],
    '–ø–∏—Ä–æ–≥': ['–ø–∏—Ä–æ–∂–æ–∫', '–ø–∏—Ä–æ–∂–∫–∏'],

    // –°–ª–∞–¥–∫–æ–µ
    '—Å–∞—Ö–∞—Ä': ['—Å–∞—Ö–∞—Ä–Ω—ã–π', '—Å–∞—Ö–∞—Ä–æ–∫'],
    '–º–µ–¥': ['–º–µ–¥–æ–∫', '–º–µ–¥–æ–≤—ã–π'],
    '—à–æ–∫–æ–ª–∞–¥': ['—à–æ–∫–æ–ª–∞–¥–∫–∞', '—à–æ–∫–æ–ª–∞–¥–Ω—ã–π'],
    '–∫–æ–Ω—Ñ–µ—Ç—ã': ['–∫–æ–Ω—Ñ–µ—Ç–∞', '–∫–æ–Ω—Ñ–µ—Ç–∫–∞'],
    '–≤–∞—Ä–µ–Ω—å–µ': ['–¥–∂–µ–º', '–ø–æ–≤–∏–¥–ª–æ'],

    // –ù–∞–ø–∏—Ç–∫–∏
    '–∫–æ—Ñ–µ': ['–∫–æ—Ñ–µ–µ–∫', '–∫–æ—Ñ–µ–π–Ω—ã–π', '—ç—Å–ø—Ä–µ—Å—Å–æ', '–∞–º–µ—Ä–∏–∫–∞–Ω–æ', '–∫–∞–ø—É—á–∏–Ω–æ', '–ª–∞—Ç—Ç–µ'],
    '—á–∞–π': ['—á–∞–µ–∫', '—á–∞–π–Ω—ã–π'],
    '—Å–æ–∫': ['—Å–æ—á–æ–∫', '—Å–æ–∫–æ–≤—ã–π', '—Ñ—Ä–µ—à'],
    '–≤–æ–¥–∞': ['–≤–æ–¥–∏—á–∫–∞', '–º–∏–Ω–µ—Ä–∞–ª–∫–∞'],
    '–∫–æ–º–ø–æ—Ç': ['–∫–æ–º–ø–æ—Ç–∏–∫'],
    '–º–æ—Ä—Å': ['–º–æ—Ä—Å–∏–∫'],

    // –û—Ä–µ—Ö–∏
    '–æ—Ä–µ—Ö–∏': ['–æ—Ä–µ—à–∫–∏', '–æ—Ä–µ—Ö–æ–≤—ã–π'],
    '–º–∏–Ω–¥–∞–ª—å': ['–º–∏–Ω–¥–∞–ª—å–Ω—ã–π'],
    '—Ñ—É–Ω–¥—É–∫': ['–ª–µ—Å–Ω–æ–π –æ—Ä–µ—Ö'],
    '–≥—Ä–µ—Ü–∫–∏–π': ['–≥—Ä–µ—Ü–∫–∏–µ –æ—Ä–µ—Ö–∏'],
    '–∫–µ—à—å—é': ['–∫–µ—à—å—é–≤—ã–π'],
    '–∞—Ä–∞—Ö–∏—Å': ['–∞—Ä–∞—Ö–∏—Å–æ–≤—ã–π', '–∑–µ–º–ª—è–Ω–æ–π –æ—Ä–µ—Ö'],

    // –î—Ä—É–≥–æ–µ
    '—è–π—Ü–æ': ['—è–π—Ü–∞', '—è–∏—á–∫–æ', '—è–∏—á–Ω—ã–π', '–æ–º–ª–µ—Ç', '—è–∏—á–Ω–∏—Ü–∞'],
    '–º–∞—Å–ª–æ': ['–º–∞—Å–ª–∏—Ü–µ', '–º–∞—Å–ª—è–Ω—ã–π'],
    '—Å–æ—É—Å': ['—Å–æ—É—Å–∏–∫', '—Å–æ—É—Å–Ω—ã–π', '–∑–∞–ø—Ä–∞–≤–∫–∞'],
    '–º–∞–π–æ–Ω–µ–∑': ['–º–∞–π–æ–Ω–µ–∑–∏–∫', '–º–∞–π–æ–Ω–µ–∑–Ω—ã–π'],
    '–∫–µ—Ç—á—É–ø': ['–∫–µ—Ç—á—É–ø–∏–∫'],
    '–≥–æ—Ä—á–∏—Ü–∞': ['–≥–æ—Ä—á–∏—á–Ω—ã–π']
  };

  // –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
  const phoneticRules = [
    { from: /[—ë–µ]/g, to: '–µ' },       // —ë = –µ (–≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ!)
    { from: /[—å—ä]/g, to: '' },        // –º—è–≥–∫–∏–π/—Ç–≤–µ—Ä–¥—ã–π –∑–Ω–∞–∫
    { from: /—Ç—Å|—Ç—Ü/g, to: '—Ü' },      // —Ç—Å ‚Üí —Ü
    { from: /—Å—á|—â/g, to: '—â' },       // —Å—á = —â
    { from: /–∂—à|—à–∂/g, to: '—à' },      // –æ–≥–ª—É—à–µ–Ω–∏–µ
    // –û–≥–ª—É—à–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
    // { from: /[–±–ø]/g, to: '–ø' },
    // { from: /[–¥—Ç]/g, to: '—Ç' },
    // { from: /[–≥–∫]/g, to: '–∫' },
    // { from: /[–≤—Ñ]/g, to: '—Ñ' },
    // { from: /[–∑—Å]/g, to: '—Å' }
  ];

  // === üÜï –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø (ru ‚Üî en) ===

  // –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏: —Ä—É—Å—Å–∫–∏–π ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞ (–ì–û–°–¢ + –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
  const TRANSLIT_RU_TO_EN = {
    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd',
    '–µ': 'e', '—ë': 'yo', '–∂': 'zh', '–∑': 'z', '–∏': 'i',
    '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n',
    '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't',
    '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch',
    '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '',
    '—ç': 'e', '—é': 'yu', '—è': 'ya'
  };

  // –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏: –ª–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí —Ä—É—Å—Å–∫–∏–π (–æ–±—Ä–∞—Ç–Ω–∞—è + –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã)
  // –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω! –î–ª–∏–Ω–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏
  const TRANSLIT_EN_TO_RU = [
    // –°–ª–æ–∂–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
    ['sch', '—â'], ['sh', '—à'], ['ch', '—á'], ['zh', '–∂'],
    ['ts', '—Ü'], ['yu', '—é'], ['ya', '—è'], ['yo', '—ë'],
    ['ye', '–µ'], ['yi', '–∏'], ['ph', '—Ñ'], ['th', '—Ç'],
    ['ck', '–∫'], ['qu', '–∫–≤'], ['x', '–∫—Å'], ['w', '–≤'],
    // –ü—Ä–æ—Å—Ç—ã–µ –±—É–∫–≤—ã
    ['a', '–∞'], ['b', '–±'], ['c', '–∫'], ['d', '–¥'], ['e', '–µ'],
    ['f', '—Ñ'], ['g', '–≥'], ['h', '—Ö'], ['i', '–∏'], ['j', '–¥–∂'],
    ['k', '–∫'], ['l', '–ª'], ['m', '–º'], ['n', '–Ω'], ['o', '–æ'],
    ['p', '–ø'], ['r', '—Ä'], ['s', '—Å'], ['t', '—Ç'], ['u', '—É'],
    ['v', '–≤'], ['y', '–π'], ['z', '–∑']
  ];

  // –ß–∞—Å—Ç—ã–µ –ø–∞—Ä—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ (—Ç–æ—á–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
  // –≠—Ç–æ –¥–ª—è 100% —Ç–æ—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤, –≥–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –æ—à–∏–±–∏—Ç—å—Å—è
  const TRANSLIT_PAIRS = {
    // –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
    'protein': '–ø—Ä–æ—Ç–µ–∏–Ω',
    '–ø—Ä–æ—Ç–µ–∏–Ω': 'protein',
    'whey': '–≤–µ–π',
    '–≤–µ–π': 'whey',
    'casein': '–∫–∞–∑–µ–∏–Ω',
    '–∫–∞–∑–µ–∏–Ω': 'casein',
    'bcaa': '–±—Ü–∞–∞',
    '–±—Ü–∞–∞': 'bcaa',
    'creatine': '–∫—Ä–µ–∞—Ç–∏–Ω',
    '–∫—Ä–µ–∞—Ç–∏–Ω': 'creatine',
    'gainer': '–≥–µ–π–Ω–µ—Ä',
    '–≥–µ–π–Ω–µ—Ä': 'gainer',
    'isolate': '–∏–∑–æ–ª—è—Ç',
    '–∏–∑–æ–ª—è—Ç': 'isolate',
    'fitness': '—Ñ–∏—Ç–Ω–µ—Å',
    '—Ñ–∏—Ç–Ω–µ—Å': 'fitness',
    'sport': '—Å–ø–æ—Ä—Ç',
    '—Å–ø–æ—Ä—Ç': 'sport',

    // –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
    'topping': '—Ç–æ–ø–ø–∏–Ω–≥',
    '—Ç–æ–ø–ø–∏–Ω–≥': 'topping',
    'smoothie': '—Å–º—É–∑–∏',
    '—Å–º—É–∑–∏': 'smoothie',
    'granola': '–≥—Ä–∞–Ω–æ–ª–∞',
    '–≥—Ä–∞–Ω–æ–ª–∞': 'granola',
    'muesli': '–º—é—Å–ª–∏',
    '–º—é—Å–ª–∏': 'muesli',
    'yogurt': '–π–æ–≥—É—Ä—Ç',
    '–π–æ–≥—É—Ä—Ç': 'yogurt',
    'milk': '–º–∏–ª–∫',
    '–º–∏–ª–∫': 'milk',
    'shake': '—à–µ–π–∫',
    '—à–µ–π–∫': 'shake',
    'bar': '–±–∞—Ä',
    '–±–∞—Ä': 'bar',
    'snack': '—Å–Ω—ç–∫',
    '—Å–Ω—ç–∫': 'snack',
    'chips': '—á–∏–ø—Å—ã',
    '—á–∏–ø—Å—ã': 'chips',
    'cookie': '–∫—É–∫–∏',
    '–∫—É–∫–∏': 'cookie',
    'cookies': '–∫—É–∫–∏—Å',
    '–∫—É–∫–∏—Å': 'cookies',
    'oatmeal': '–æ–≤—Å—è–Ω–∫–∞',
    'oat': '–æ–≤—Å—è–Ω—ã–π',
    '–æ–≤—Å—è–Ω—ã–π': 'oat',
    'quinoa': '–∫–∏–Ω–æ–∞',
    '–∫–∏–Ω–æ–∞': 'quinoa',
    'hummus': '—Ö—É–º—É—Å',
    '—Ö—É–º—É—Å': 'hummus',
    'falafel': '—Ñ–∞–ª–∞—Ñ–µ–ª—å',
    '—Ñ–∞–ª–∞—Ñ–µ–ª—å': 'falafel',
    'avocado': '–∞–≤–æ–∫–∞–¥–æ',
    '–∞–≤–æ–∫–∞–¥–æ': 'avocado',
    'salmon': '—Å—ç–ª–º–æ–Ω',
    'tuna': '—Ç—É–Ω–µ—Ü',
    '—Ç—É–Ω–µ—Ü': 'tuna',
    'chicken': '—á–∏–∫–µ–Ω',
    '—á–∏–∫–µ–Ω': 'chicken',
    'beef': '–±–∏—Ñ',
    '–±–∏—Ñ': 'beef',
    'turkey': '–∏–Ω–¥–µ–π–∫–∞',
    '–∏–Ω–¥–µ–π–∫–∞': 'turkey',
    'steak': '—Å—Ç–µ–π–∫',
    '—Å—Ç–µ–π–∫': 'steak',

    // –î–æ–±–∞–≤–∫–∏
    'omega': '–æ–º–µ–≥–∞',
    '–æ–º–µ–≥–∞': 'omega',
    'vitamin': '–≤–∏—Ç–∞–º–∏–Ω',
    '–≤–∏—Ç–∞–º–∏–Ω': 'vitamin',
    'fiber': '—Ñ–∞–π–±–µ—Ä',
    '—Ñ–∞–π–±–µ—Ä': 'fiber',
    'collagen': '–∫–æ–ª–ª–∞–≥–µ–Ω',
    '–∫–æ–ª–ª–∞–≥–µ–Ω': 'collagen',
    'magnesium': '–º–∞–≥–Ω–∏–π',
    '–º–∞–≥–Ω–∏–π': 'magnesium',
    'zinc': '—Ü–∏–Ω–∫',
    '—Ü–∏–Ω–∫': 'zinc',
    'iron': '–∂–µ–ª–µ–∑–æ',
    'calcium': '–∫–∞–ª—å—Ü–∏–π',
    '–∫–∞–ª—å—Ü–∏–π': 'calcium',

    // –î–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
    'low': '–ª–æ—É',
    '–ª–æ—É': 'low',
    'high': '—Ö–∞–π',
    '—Ö–∞–π': 'high',
    'sugar': '—à—É–≥–∞—Ä',
    '—à—É–≥–∞—Ä': 'sugar',
    'free': '—Ñ—Ä–∏',
    '—Ñ—Ä–∏': 'free',
    'zero': '–∑–µ—Ä–æ',
    '–∑–µ—Ä–æ': 'zero',
    'light': '–ª–∞–π—Ç',
    '–ª–∞–π—Ç': 'light',
    'diet': '–¥–∏–µ—Ç',
    '–¥–∏–µ—Ç': 'diet',
    'organic': '–æ—Ä–≥–∞–Ω–∏–∫',
    '–æ—Ä–≥–∞–Ω–∏–∫': 'organic',
    'bio': '–±–∏–æ',
    '–±–∏–æ': 'bio',
    'eco': '—ç–∫–æ',
    '—ç–∫–æ': 'eco',
    'vegan': '–≤–µ–≥–∞–Ω',
    '–≤–µ–≥–∞–Ω': 'vegan',
    'keto': '–∫–µ—Ç–æ',
    '–∫–µ—Ç–æ': 'keto',
    'detox': '–¥–µ—Ç–æ–∫—Å',
    '–¥–µ—Ç–æ–∫—Å': 'detox',
    'slim': '—Å–ª–∏–º',
    '—Å–ª–∏–º': 'slim',
    'energy': '—ç–Ω–µ—Ä–¥–∂–∏',
    '—ç–Ω–µ—Ä–¥–∂–∏': 'energy',
    'power': '–ø–∞—É—ç—Ä',
    '–ø–∞—É—ç—Ä': 'power',
    'super': '—Å—É–ø–µ—Ä',
    '—Å—É–ø–µ—Ä': 'super',

    // –ë—Ä–µ–Ω–¥—ã –∏ —Ç–∏–ø–∏—á–Ω—ã–µ —Å–ª–æ–≤–∞
    'pro': '–ø—Ä–æ',
    '–ø—Ä–æ': 'pro',
    'plus': '–ø–ª—é—Å',
    '–ø–ª—é—Å': 'plus',
    'max': '–º–∞–∫—Å',
    '–º–∞–∫—Å': 'max',
    'ultra': '—É–ª—å—Ç—Ä–∞',
    '—É–ª—å—Ç—Ä–∞': 'ultra',
    'premium': '–ø—Ä–µ–º–∏—É–º',
    '–ø—Ä–µ–º–∏—É–º': 'premium',
    'gold': '–≥–æ–ª–¥',
    '–≥–æ–ª–¥': 'gold',
    'classic': '–∫–ª–∞—Å—Å–∏–∫',
    '–∫–ª–∞—Å—Å–∏–∫': 'classic',
    'original': '–æ—Ä–∏–¥–∂–∏–Ω–∞–ª',
    '–æ—Ä–∏–¥–∂–∏–Ω–∞–ª': 'original',
    'natural': '–Ω–∞—Ç—É—Ä–∞–ª',
    '–Ω–∞—Ç—É—Ä–∞–ª': 'natural',
    'fresh': '—Ñ—Ä–µ—à',
    '—Ñ—Ä–µ—à': 'fresh'
  };

  // –í–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è/–Ω–∞–ø–∏—Å–∞–Ω–∏—è (–¥–ª—è –Ω–µ—á—ë—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  // –ö–ª—é—á - –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞, –∑–Ω–∞—á–µ–Ω–∏—è - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
  const SPELLING_VARIANTS = {
    '—Ñ–∏—Ç–Ω–µ—Å': ['—Ñ–∏–Ω—Ç–µ—Å', '—Ñ–∏—Ç–Ω–µ—Å—Å', '—Ñ–∏—Ç–Ω–µ—Åc', 'fitness', 'fintess', 'fitnes'],
    '–ø—Ä–æ—Ç–µ–∏–Ω': ['–ø—Ä–æ—Ç—ç–∏–Ω', 'protein', 'protien', 'proteen', '–ø—Ä—É—Ç–µ–∏–Ω'],
    '—Ç–æ–ø–ø–∏–Ω–≥': ['—Ç–æ–ø–∏–Ω–≥', 'topping', 'toping', '—Ç–æ–ø–ø–∏–Ω–∫'],
    '–≥—Ä–∞–Ω–æ–ª–∞': ['–≥—Ä–æ–Ω–æ–ª–∞', 'granola', 'granolla', '–≥—Ä–∞–Ω–Ω–æ–ª–∞'],
    '—Å–º—É–∑–∏': ['—Å–º—É–∑–∑–∏', 'smoothie', 'smoothi', '—Å–º—É—Å–∏'],
    '–π–æ–≥—É—Ä—Ç': ['–π–æ–≥—É—Ä—Ç', '–π–æ–≥—É—Ç', 'yogurt', 'yoghurt', '–π–æ–≥—Ä—É—Ç'],
    '–º—é—Å–ª–∏': ['–º—é—Å–ª–∏', '–º—É—Å–ª–∏', 'muesli', 'musli', 'myusli'],
    '–∫—Ä–µ–∞—Ç–∏–Ω': ['–∫—Ä–µ–æ—Ç–∏–Ω', 'creatine', 'creatin', 'kreatine'],
    '–∫–æ–ª–ª–∞–≥–µ–Ω': ['–∫–æ–ª–∞–≥–µ–Ω', 'collagen', 'colagen', '–∫–∞–ª–∞–≥–µ–Ω'],
    '–∫–∞–∑–µ–∏–Ω': ['–∫–æ–∑–µ–∏–Ω', 'casein', 'casien', '–∫–∞–∑–∏–µ–Ω'],
    '–∫–∞–ª—å—Ü–∏–π': ['–∫–∞–ª—Ü–∏–π', 'calcium', 'kalsiy', '–∫–∞–ª—å—Ü—ã–π'],
    '–º–∞–≥–Ω–∏–π': ['–º–∞–≥–Ω–∏', 'magnesium', 'magniy', '–º–∞–≥–Ω–µ–∑–∏–π'],
    '–æ–º–µ–≥–∞': ['–æ–º–µ–≥–æ', 'omega', '–æmega', '–∞–º–µ–≥–∞'],
    '–≤–∏—Ç–∞–º–∏–Ω': ['–≤–∏—Ç–æ–º–∏–Ω', 'vitamin', 'vitamen', '–≤–∏—Ç–æ–º–µ–Ω'],
    '—ç–Ω–µ—Ä–≥–∏—è': ['—ç–Ω–µ—Ä–¥–∂–∏', 'energy', 'energi', '—ç–Ω–µ—Ä–≥–∏—è'],
    '—à–æ–∫–æ–ª–∞–¥': ['—á–æ–∫–æ–ª–∞–¥', 'chocolate', 'chocolat', '—à–∞–∫–æ–ª–∞–¥'],
    '–∫–∞—Ä–∞–º–µ–ª—å': ['–∫–∞—Ä–∞–º–µ–ª', 'caramel', 'karamel', '–∫–∞—Ä–æ–º–µ–ª—å'],
    '–≤–∞–Ω–∏–ª—å': ['–≤–∞–Ω–∏–ª', 'vanilla', 'vanila', '–≤–∞–Ω–∏–ª–∞'],
    '–∫–ª—É–±–Ω–∏–∫–∞': ['–∫–ª—É–±–Ω–∫–∞', 'strawberry', '–∫–ª—é–±–Ω–∏–∫–∞'],
    '–±–∞–Ω–∞–Ω': ['banan', 'banana', '–±–∞–Ω–Ω–∞'],
    '–∫–æ–∫–æ—Å': ['–∫–æ–∫–∞—Å', 'coconut', 'cocnut', '–∫–æ–∫–æ—Å—Å'],
    '–∞—Ä–∞—Ö–∏—Å': ['–∞—Ä–æ—Ö–∏—Å', 'peanut', 'arachis', '–∞—Ä–∞—Ö–∏–∑'],
    '–º–∏–Ω–¥–∞–ª—å': ['–º–∏–Ω–¥–∞–ª', 'almond', 'mindal', '–º–∏–Ω—Ç–∞–ª—å']
  };

  // === üÜï QWERTY ‚Üî –ô–¶–£–ö–ï–ù (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã) ===
  const QWERTY_TO_CYRILLIC = {
    'q': '–π', 'w': '—Ü', 'e': '—É', 'r': '–∫', 't': '–µ', 'y': '–Ω', 'u': '–≥',
    'i': '—à', 'o': '—â', 'p': '–∑', '[': '—Ö', ']': '—ä', 'a': '—Ñ', 's': '—ã',
    'd': '–≤', 'f': '–∞', 'g': '–ø', 'h': '—Ä', 'j': '–æ', 'k': '–ª', 'l': '–¥',
    ';': '–∂', "'": '—ç', 'z': '—è', 'x': '—á', 'c': '—Å', 'v': '–º', 'b': '–∏',
    'n': '—Ç', 'm': '—å', ',': '–±', '.': '—é', '/': '.'
  };

  const CYRILLIC_TO_QWERTY = Object.fromEntries(
    Object.entries(QWERTY_TO_CYRILLIC).map(([k, v]) => [v, k])
  );

  // === üÜï –°–û–ö–†–ê–©–ï–ù–ò–Ø –ò –ê–ë–ë–†–ï–í–ò–ê–¢–£–†–´ ===
  const ABBREVIATIONS = {
    // –ñ–∏—Ä–Ω–æ—Å—Ç—å
    '–±/–∂': ['–±–µ–∑ –∂–∏—Ä–∞', '–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–Ω–µ–∂–∏—Ä–Ω—ã–π', '0% –∂–∏—Ä–Ω–æ—Å—Ç–∏'],
    '–± –∂': ['–±–µ–∑ –∂–∏—Ä–∞', '–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π'],
    '–±–∂': ['–±–µ–∑ –∂–∏—Ä–∞', '–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π'],
    '0%': ['–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–Ω—É–ª–µ–≤–æ–π –∂–∏—Ä–Ω–æ—Å—Ç–∏', '–±–µ–∑ –∂–∏—Ä–∞'],
    '0.5%': ['–ø–æ–ª—É–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π', '–º–∞–ª–æ–∂–∏—Ä–Ω—ã–π'],
    '1%': ['–æ–¥–Ω–æ–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π', '–º–∞–ª–æ–∂–∏—Ä–Ω—ã–π'],
    '2%': ['–¥–≤—É—Ö–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π'],
    '5%': ['–ø—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π'],
    '9%': ['–¥–µ–≤—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π'],

    // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    '–∫–∫–∞–ª': ['–∫–∞–ª–æ—Ä–∏–∏', '–∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å', '—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å'],
    '–∫–∫': ['–∫–∞–ª–æ—Ä–∏–∏', '–∫–∫–∞–ª'],
    '–±–∂—É': ['–±–µ–ª–∫–∏ –∂–∏—Ä—ã —É–≥–ª–µ–≤–æ–¥—ã', '–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã', '–º–∞–∫—Ä–æ—Å—ã'],
    '–ø–ø': ['–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ', '–∑–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ', '–ø–æ–ª–µ–∑–Ω—ã–π'],
    '–∑–æ–∂': ['–∑–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏', '–∑–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ'],

    // –†–∞–∑–º–µ—Ä—ã
    '–º–ª': ['–º–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤', '–º–∏–ª–ª–∏–ª–∏—Ç—Ä'],
    '–≥—Ä': ['–≥—Ä–∞–º–º', '–≥—Ä–∞–º–º–æ–≤'],
    '–∫–≥': ['–∫–∏–ª–æ–≥—Ä–∞–º–º', '–∫–∏–ª–æ–≥—Ä–∞–º–º–æ–≤'],
    '–ª': ['–ª–∏—Ç—Ä', '–ª–∏—Ç—Ä–æ–≤'],
    '—à—Ç': ['—à—Ç—É–∫', '—à—Ç—É–∫–∞'],

    // –¢–∏–ø—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    '–æ–±': ['–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π'],
    '–Ω–∂': ['–Ω–µ–∂–∏—Ä–Ω—ã–π', '–º–∞–ª–æ–∂–∏—Ä–Ω—ã–π'],
    '–¥–æ–º': ['–¥–æ–º–∞—à–Ω–∏–π', '–¥–æ–º–∞—à–Ω–µ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è'],
    '—Å–≤': ['—Å–≤–µ–∂–∏–π'],
    '–∑–∞–º': ['–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π', '–∑–∞–º–æ—Ä–æ–∑–∫–∞'],
    '–∫–æ–Ω—Å': ['–∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', '–∫–æ–Ω—Å–µ—Ä–≤—ã'],
    '–∫–æ–ø': ['–∫–æ–ø—á–µ–Ω—ã–π', '–∫–æ–ø—á—ë–Ω—ã–π'],
    '–≤–∞—Ä': ['–≤–∞—Ä–µ–Ω—ã–π', '–≤–∞—Ä—ë–Ω—ã–π', '–æ—Ç–≤–∞—Ä–Ω–æ–π'],
    '–∂–∞—Ä': ['–∂–∞—Ä–µ–Ω—ã–π', '–∂–∞—Ä–µ–Ω–Ω—ã–π'],
    '–∑–∞–ø': ['–∑–∞–ø–µ—á–µ–Ω–Ω—ã–π', '–∑–∞–ø–µ—á—ë–Ω–Ω—ã–π'],
    '—Å—ã—Ä': ['—Å—ã—Ä–æ–π'],
    '—Å—É—à': ['—Å—É—à–µ–Ω—ã–π', '—Å—É—à—ë–Ω—ã–π'],
    '–º–∞—Ä': ['–º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–π'],
    '—Å–æ–ª': ['—Å–æ–ª–µ–Ω—ã–π', '—Å–æ–ª—ë–Ω—ã–π', '–º–∞–ª–æ—Å–æ–ª—å–Ω—ã–π'],

    // –°–ø–æ—Ä—Ç–ø–∏—Ç
    '–∏–∑–æ': ['–∏–∑–æ–ª—è—Ç', '–∏–∑–æ–ª—è—Ç –ø—Ä–æ—Ç–µ–∏–Ω–∞'],
    '–∫–æ–Ω—Ü': ['–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç'],
    '–≥–∏–¥—Ä–æ': ['–≥–∏–¥—Ä–æ–ª–∏–∑–∞—Ç'],

    // –ú–∞—Ä–∫–∏/—Ç–∏–ø—ã
    '–±/–ª': ['–±–µ–∑ –ª–∞–∫—Ç–æ–∑—ã', '–±–µ–∑–ª–∞–∫—Ç–æ–∑–Ω—ã–π'],
    '–±/–≥': ['–±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞', '–±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤—ã–π'],
    '–±/—Å': ['–±–µ–∑ —Å–∞—Ö–∞—Ä–∞', '–Ω–µ—Å–ª–∞–¥–∫–∏–π'],
    '–Ω–∏–∑–∫–æ–∫–∞–ª': ['–Ω–∏–∑–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π', '–¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–π'],
    '–≤—ã—Å–∫–æ–∫–æ–±–µ–ª': ['–≤—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤—ã–π', '–ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π']
  };

  // === üÜï –ï–î–ò–ù–ò–¶–´ –ò–ó–ú–ï–†–ï–ù–ò–Ø (v2.5.0) ===
  const UNIT_CONVERSION = {
    '–∫–≥': { base: '–≥', factor: 1000 },
    'kg': { base: '–≥', factor: 1000 },
    '–≥': { base: '–≥', factor: 1 },
    '–≥—Ä': { base: '–≥', factor: 1 },
    'g': { base: '–≥', factor: 1 },
    '–ª': { base: '–º–ª', factor: 1000 },
    'l': { base: '–º–ª', factor: 1000 },
    '–º–ª': { base: '–º–ª', factor: 1 },
    'ml': { base: '–º–ª', factor: 1 },
    '—à—Ç': { base: '—à—Ç', factor: 1 },
    'pcs': { base: '—à—Ç', factor: 1 }
  };

  // === üÜï –ö–ê–¢–ï–ì–û–†–ò–ò –ü–†–û–î–£–ö–¢–û–í (–¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É) ===
  const CATEGORY_KEYWORDS = {
    '–º–æ–ª–æ—á–Ω—ã–µ': ['–º–æ–ª–æ–∫–æ', '—Ç–≤–æ—Ä–æ–≥', '—Å—ã—Ä', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '—Å–º–µ—Ç–∞–Ω–∞', '—Å–ª–∏–≤–∫–∏', '—Ä—è–∂–µ–Ω–∫–∞', '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∞', '–º–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ'],
    '–º—è—Å–æ': ['–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '–∫—É—Ä–∏—Ü–∞', '–∏–Ω–¥–µ–π–∫–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '—Ç–µ–ª—è—Ç–∏–Ω–∞', '–∫—Ä–æ–ª–∏–∫', '—É—Ç–∫–∞', '–≥—É—Å—å', '—Ñ–∞—Ä—à', '–∫–æ—Ç–ª–µ—Ç–∞', '—Å—Ç–µ–π–∫', '—Ñ–∏–ª–µ', '–≥—Ä—É–¥–∫–∞', '–±–µ–¥—Ä–æ', '–æ–∫–æ—Ä–æ–∫', '–≤–µ—Ç—á–∏–Ω–∞', '–±–µ–∫–æ–Ω', '–∫–æ–ª–±–∞—Å–∞', '—Å–æ—Å–∏—Å–∫–∏'],
    '—Ä—ã–±–∞': ['—Ä—ã–±–∞', '–ª–æ—Å–æ—Å—å', '—Å–µ–º–≥–∞', '—Ñ–æ—Ä–µ–ª—å', '—Ç—É–Ω–µ—Ü', '—Ç—Ä–µ—Å–∫–∞', '–º–∏–Ω—Ç–∞–π', '—Å–∫—É–º–±—Ä–∏—è', '—Å–µ–ª—å–¥—å', '–≥–æ—Ä–±—É—à–∞', '–∫–µ—Ç–∞', '—Å—É–¥–∞–∫', '–æ–∫—É–Ω—å', '–∫–∞—Ä–ø', '—â—É–∫–∞'],
    '–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã': ['–∫—Ä–µ–≤–µ—Ç–∫–∏', '–∫–∞–ª—å–º–∞—Ä', '–º–∏–¥–∏–∏', '—É—Å—Ç—Ä–∏—Ü—ã', '–∫—Ä–∞–±—ã', '–∏–∫—Ä–∞', '–º–æ—Ä—Å–∫–æ–π –∫–æ–∫—Ç–µ–π–ª—å', '–æ—Å—å–º–∏–Ω–æ–≥'],
    '–æ–≤–æ—â–∏': ['–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–º–æ—Ä–∫–æ–≤—å', '–ª—É–∫', '—á–µ—Å–Ω–æ–∫', '–∫–∞–ø—É—Å—Ç–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '—Ü–≤–µ—Ç–Ω–∞—è –∫–∞–ø—É—Å—Ç–∞', '–ø–æ–º–∏–¥–æ—Ä', '–æ–≥—É—Ä–µ—Ü', '–ø–µ—Ä–µ—Ü', '–±–∞–∫–ª–∞–∂–∞–Ω', '–∫–∞–±–∞—á–æ–∫', '—Ç—ã–∫–≤–∞', '—Å–≤–µ–∫–ª–∞', '—Ä–µ–¥–∏—Å', '—Å–µ–ª—å–¥–µ—Ä–µ–π', '—à–ø–∏–Ω–∞—Ç', '—Å–∞–ª–∞—Ç'],
    '—Ñ—Ä—É–∫—Ç—ã': ['—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–≥—Ä—É—à–∞', '–ø–µ—Ä—Å–∏–∫', '–∞–±—Ä–∏–∫–æ—Å', '—Å–ª–∏–≤–∞', '–≤–∏–Ω–æ–≥—Ä–∞–¥', '–∫–∏–≤–∏', '–º–∞–Ω–≥–æ', '–∞–Ω–∞–Ω–∞—Å', '–∞—Ä–±—É–∑', '–¥—ã–Ω—è', '–≥—Ä–∞–Ω–∞—Ç', '—Ö—É—Ä–º–∞'],
    '—è–≥–æ–¥—ã': ['–∫–ª—É–±–Ω–∏–∫–∞', '–º–∞–ª–∏–Ω–∞', '—á–µ—Ä–Ω–∏–∫–∞', '–≥–æ–ª—É–±–∏–∫–∞', '–µ–∂–µ–≤–∏–∫–∞', '—Å–º–æ—Ä–æ–¥–∏–Ω–∞', '–∫—Ä—ã–∂–æ–≤–Ω–∏–∫', '–≤–∏—à–Ω—è', '—á–µ—Ä–µ—à–Ω—è', '–∫–ª—é–∫–≤–∞', '–±—Ä—É—Å–Ω–∏–∫–∞'],
    '–∫—Ä—É–ø—ã': ['—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–æ–≤—Å—è–Ω–∫–∞', '–ø—à–µ–Ω–æ', '–ø–µ—Ä–ª–æ–≤–∫–∞', '–±—É–ª–≥—É—Ä', '–∫—É—Å–∫—É—Å', '–∫–∏–Ω–æ–∞', '–º–∞–Ω–∫–∞', '–∫—É–∫—É—Ä—É–∑–Ω–∞—è –∫—Ä—É–ø–∞', '—è—á–Ω–µ–≤–∞—è'],
    '–º–∞–∫–∞—Ä–æ–Ω—ã': ['–º–∞–∫–∞—Ä–æ–Ω—ã', '—Å–ø–∞–≥–µ—Ç—Ç–∏', '–ø–∞—Å—Ç–∞', '–ª–∞–ø—à–∞', '–≤–µ—Ä–º–∏—à–µ–ª—å', '–ø–µ–Ω–Ω–µ', '—Ñ—É–∑–∏–ª–ª–∏', '—Ñ–∞—Ä—Ñ–∞–ª–ª–µ'],
    '—Ö–ª–µ–±': ['—Ö–ª–µ–±', '–±–∞—Ç–æ–Ω', '–±—É–ª–∫–∞', '–ª–∞–≤–∞—à', '–ø–∏—Ç–∞', '–±–∞–≥–µ—Ç', '—á–∏–∞–±–∞—Ç—Ç–∞', '—Ö–ª–µ–±—Ü—ã', '—Ç–æ—Å—Ç', '—Å—É—Ö–∞—Ä–∏'],
    '–≤—ã–ø–µ—á–∫–∞': ['–ø–µ—á–µ–Ω—å–µ', '–ø–∏—Ä–æ–≥', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–∂–Ω–æ–µ', '–∫—Ä—É–∞—Å—Å–∞–Ω', '–±—É–ª–æ—á–∫–∞', '–∫–µ–∫—Å', '–º–∞—Ñ—Ñ–∏–Ω', '—Ä—É–ª–µ—Ç', '—ç–∫–ª–µ—Ä'],
    '—Å–ª–∞–¥–æ—Å—Ç–∏': ['—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–º–∞—Ä–º–µ–ª–∞–¥', '–∑–µ—Ñ–∏—Ä', '–ø–∞—Å—Ç–∏–ª–∞', '—Ö–∞–ª–≤–∞', '–º–µ–¥', '–≤–∞—Ä–µ–Ω—å–µ', '–¥–∂–µ–º'],
    '–æ—Ä–µ—Ö–∏': ['–º–∏–Ω–¥–∞–ª—å', '–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '–∞—Ä–∞—Ö–∏—Å', '—Ñ–∏—Å—Ç–∞—à–∫–∏', '–∫–µ–¥—Ä–æ–≤—ã–µ –æ—Ä–µ—Ö–∏', '–º–∞–∫–∞–¥–∞–º–∏—è', '–ø–µ–∫–∞–Ω'],
    '–Ω–∞–ø–∏—Ç–∫–∏': ['–≤–æ–¥–∞', '—Å–æ–∫', '—á–∞–π', '–∫–æ—Ñ–µ', '–∫–æ–º–ø–æ—Ç', '–º–æ—Ä—Å', '–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—Å–º—É–∑–∏', '–∫–æ–∫—Ç–µ–π–ª—å'],
    '—Å–ø–æ—Ä—Ç–ø–∏—Ç': ['–ø—Ä–æ—Ç–µ–∏–Ω', '–≥–µ–π–Ω–µ—Ä', 'bcaa', '–∫—Ä–µ–∞—Ç–∏–Ω', '–∏–∑–æ–ª—è—Ç', '–∫–∞–∑–µ–∏–Ω', '–∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã', 'l-–∫–∞—Ä–Ω–∏—Ç–∏–Ω', '–ø—Ä–µ–¥—Ç—Ä–µ–Ω–∏–∫', '–∫–æ–ª–ª–∞–≥–µ–Ω']
  };

  // üÜï v2.6.0 –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º
  const NUTRIENT_RULES = {
    'high_protein': {
      keywords: ['–≤—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤—ã–π', '–º–Ω–æ–≥–æ –±–µ–ª–∫–∞', '–ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π', 'high protein'],
      check: (p) => (p.protein100 || 0) >= 15
    },
    'low_carb': {
      keywords: ['–Ω–∏–∑–∫–æ—É–≥–ª–µ–≤–æ–¥–Ω—ã–π', '–º–∞–ª–æ —É–≥–ª–µ–π', 'low carb', '–±–µ–∑ —É–≥–ª–µ–π'],
      check: (p) => (p.carbs100 || 0) <= 10
    },
    'sugar_free': {
      keywords: ['–±–µ–∑ —Å–∞—Ö–∞—Ä–∞', 'sugar free', '0 —Å–∞—Ö–∞—Ä–∞', 'zero sugar'],
      check: (p) => (p.simple100 || 0) <= 2
    },
    'keto': {
      keywords: ['–∫–µ—Ç–æ', 'keto', 'lchf'],
      check: (p) => (p.carbs100 || 0) <= 10 && (p.fat100 || 0) >= 10
    },
    'low_fat': {
      keywords: ['–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–±–µ–∑ –∂–∏—Ä–∞', 'low fat', '0%'],
      check: (p) => (p.fat100 || 0) <= 2
    }
  };

  // üÜï v2.6.0 –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–≤—Ä–µ–º—è –¥–Ω—è, —Å–∏—Ç—É–∞—Ü–∏—è)
  const CONTEXT_RULES = {
    'breakfast': {
      keywords: ['–∑–∞–≤—Ç—Ä–∞–∫', 'breakfast', '—É—Ç—Ä–æ'],
      boostCategories: ['–∫—Ä—É–ø—ã', '–º–æ–ª–æ—á–Ω—ã–µ', '—Ñ—Ä—É–∫—Ç—ã', '—Ö–ª–µ–±', '–≤—ã–ø–µ—á–∫–∞'],
      boostProducts: ['–æ–≤—Å—è–Ω–∫–∞', '—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥', '–∫–æ—Ñ–µ', '–æ–º–ª–µ—Ç']
    },
    'gym': {
      keywords: ['–∑–∞–ª', 'gym', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '–ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏'],
      boostCategories: ['—Å–ø–æ—Ä—Ç–ø–∏—Ç', '–º—è—Å–æ'],
      check: (p) => (p.protein100 || 0) >= 20
    }
  };

  // === üÜï v2.7.0 –°–õ–û–í–ê–†–¨ –ë–†–ï–ù–î–û–í ===
  const BRAND_DICTIONARY = {
    // –ú–æ–ª–æ—á–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
    'danone': ['–¥–∞–Ω–æ–Ω', 'danone', '–¥—ç–Ω–æ–Ω', '–¥–µ–Ω–æ–Ω'],
    '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ': ['–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ', 'prostokvashino', '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à'],
    '–∞–∫—Ç–∏–≤–∏–∞': ['–∞–∫—Ç–∏–≤–∏–∞', 'activia', '–∞–∫—Ç–∏–≤–∞'],
    '—á—É–¥–æ': ['—á—É–¥–æ', 'chudo'],
    '–¥–æ–º–∏–∫ –≤ –¥–µ—Ä–µ–≤–Ω–µ': ['–¥–æ–º–∏–∫ –≤ –¥–µ—Ä–µ–≤–Ω–µ', '–¥–æ–º–∏–∫', '–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏–π'],
    'parmalat': ['–ø–∞—Ä–º–∞–ª–∞—Ç', 'parmalat'],
    'president': ['–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç', 'president', 'prezident'],
    'valio': ['–≤–∞–ª–∏–æ', 'valio'],
    'viola': ['–≤–∏–æ–ª–∞', 'viola'],
    'hochland': ['—Ö–æ—Ö–ª–∞–Ω–¥', 'hochland', 'hohland'],
    'svalia': ['—Å–≤–∞–ª–∏—è', 'svalia'],
    '–∞–≥—É—à–∞': ['–∞–≥—É—à–∞', 'agusha'],
    'epica': ['—ç–ø–∏–∫–∞', 'epica', 'epika'],

    // –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
    'optimum nutrition': ['–æ–ø—Ç–∏–º—É–º', 'optimum', 'on'],
    'myprotein': ['–º–∞–π–ø—Ä–æ—Ç–µ–∏–Ω', 'myprotein', 'my protein'],
    'bsn': ['–±—Å–Ω', 'bsn'],
    'dymatize': ['–¥–∏–º–∞—Ç–∞–π–∑', 'dymatize', 'dimatize'],
    'muscletech': ['–º–∞—Å–ª—Ç–µ–∫', 'muscletech', 'muscle tech'],

    // –ù–∞–ø–∏—Ç–∫–∏
    'coca-cola': ['–∫–æ–∫–∞-–∫–æ–ª–∞', '–∫–æ–ª–∞', 'coca cola', 'cocacola'],
    'pepsi': ['–ø–µ–ø—Å–∏', 'pepsi'],
    'sprite': ['—Å–ø—Ä–∞–π—Ç', 'sprite'],
    'fanta': ['—Ñ–∞–Ω—Ç–∞', 'fanta'],
    'lipton': ['–ª–∏–ø—Ç–æ–Ω', 'lipton'],
    'nescafe': ['–Ω–µ—Å–∫–∞—Ñ–µ', 'nescafe', '–Ω–µ—Å–∫–∞—Ñ—ç'],

    // –ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∏–µ
    'nestle': ['–Ω–µ—Å—Ç–ª–µ', 'nestle', 'nestl√©'],
    'milka': ['–º–∏–ª–∫–∞', 'milka'],
    'oreo': ['–æ—Ä–µ–æ', 'oreo'],
    'snickers': ['—Å–Ω–∏–∫–µ—Ä—Å', 'snickers'],
    'mars': ['–º–∞—Ä—Å', 'mars'],
    'twix': ['—Ç–≤–∏–∫—Å', 'twix'],
    'bounty': ['–±–∞—É–Ω—Ç–∏', 'bounty'],
    'kinder': ['–∫–∏–Ω–¥–µ—Ä', 'kinder'],
    'raffaello': ['—Ä–∞—Ñ—Ñ–∞—ç–ª–ª–æ', 'raffaello', '—Ä–∞—Ñ–∞—ç–ª–ª–æ'],
    'ferrero': ['—Ñ–µ—Ä—Ä–µ—Ä–æ', 'ferrero', 'ferrero rocher'],

    // –ö—Ä—É–ø—ã/–ö–∞—à–∏
    'makfa': ['–º–∞–∫—Ñ–∞', 'makfa'],
    '–º–∏—Å—Ç—Ä–∞–ª—å': ['–º–∏—Å—Ç—Ä–∞–ª—å', 'mistral'],
    '—É–≤–µ–ª–∫–∞': ['—É–≤–µ–ª–∫–∞', 'uvelka'],
    'heinz': ['—Ö–∞–π–Ω—Ü', 'heinz'],
    'nesquik': ['–Ω–µ—Å–∫–≤–∏–∫', 'nesquik']
  };

  // === üÜï v2.7.0 –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–ò–ï –ö–õ–ê–°–¢–ï–†–´ (ML-lite) ===
  const SEMANTIC_CLUSTERS = {
    // –ü–æ—Ö–æ–∂–∏–µ –ø–æ —Å–º—ã—Å–ª—É –ø—Ä–æ–¥—É–∫—Ç—ã
    '–∫–∞—à–∞': ['–æ–≤—Å—è–Ω–∫–∞', '–≥—Ä–µ—á–∫–∞', '—Ä–∏—Å', '–ø—à–µ–Ω–æ', '–º–∞–Ω–∫–∞', '–±—É–ª–≥—É—Ä', '–∫–∏–Ω–æ–∞', '–ø–µ—Ä–ª–æ–≤–∫–∞'],
    '—É—Ç—Ä–µ–Ω–Ω—è—è –µ–¥–∞': ['–æ–≤—Å—è–Ω–∫–∞', '—Ç–≤–æ—Ä–æ–≥', '—è–π—Ü–∞', '–æ–º–ª–µ—Ç', '–π–æ–≥—É—Ä—Ç', '–º—é—Å–ª–∏', '–≥—Ä–∞–Ω–æ–ª–∞', '–∫–∞—à–∞'],
    '–±–µ–ª–∫–æ–≤–∞—è –µ–¥–∞': ['–∫—É—Ä–∏—Ü–∞', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Ä—ã–±–∞', '—è–π—Ü–∞', '—Ç–≤–æ—Ä–æ–≥', '–ø—Ä–æ—Ç–µ–∏–Ω', '–∏–Ω–¥–µ–π–∫–∞'],
    '–ª–µ–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å': ['—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–π–æ–≥—É—Ä—Ç', '–æ—Ä–µ—Ö–∏', '—Ö–ª–µ–±—Ü—ã', '—Ç–≤–æ—Ä–æ–∂–æ–∫'],
    '–¥–∏–µ—Ç–∏—á–µ—Å–∫–æ–µ': ['—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', '–æ–≤–æ—â–∏', '—Ä—ã–±–∞', '–≥—Ä–µ—á–∫–∞'],
    '—Å–ª–∞–¥–∫–æ–µ': ['—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–ø–µ—á–µ–Ω—å–µ', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–∂–Ω–æ–µ', '–º–æ—Ä–æ–∂–µ–Ω–æ–µ', '–∑–µ—Ñ–∏—Ä'],
    '–Ω–∞–ø–∏—Ç–∫–∏': ['–≤–æ–¥–∞', '—á–∞–π', '–∫–æ—Ñ–µ', '—Å–æ–∫', '–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '–∫–æ–º–ø–æ—Ç', '—Å–º—É–∑–∏', '–∫–æ–ª–∞'],
    '—á—Ç–æ –ø–æ–ø–∏—Ç—å': ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—á–∞–π', '–∫–æ—Ñ–µ', '—Å–æ–∫', '–≤–æ–¥–∞', '–∫–æ–ª–∞', '–∫–æ–º–ø–æ—Ç', '–∫–∞–∫–∞–æ'],
    '—á—Ç–æ –≤—ã–ø–∏—Ç—å': ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—á–∞–π', '–∫–æ—Ñ–µ', '—Å–æ–∫', '–≤–æ–¥–∞', '–∫–æ–ª–∞', '–∫–æ–º–ø–æ—Ç'],
    '–∑–¥–æ—Ä–æ–≤–∞—è –µ–¥–∞': ['–∞–≤–æ–∫–∞–¥–æ', '–±—Ä–æ–∫–∫–æ–ª–∏', '—à–ø–∏–Ω–∞—Ç', '–ª–æ—Å–æ—Å—å', '–∫–∏–Ω–æ–∞', '–æ—Ä–µ—Ö–∏', '—è–≥–æ–¥—ã'],
    '–±—ã—Å—Ç—Ä–∞—è –µ–¥–∞': ['—è–π—Ü–∞', '—Ö–ª–µ–±', '—Å—ã—Ä', '–∫–æ–ª–±–∞—Å–∞', '–π–æ–≥—É—Ä—Ç', '–±–∞–Ω–∞–Ω', '–æ—Ä–µ—Ö–∏'],
    '—É–∂–∏–Ω': ['—Ä—ã–±–∞', '–æ–≤–æ—â–∏', '—Å–∞–ª–∞—Ç', '–∫—É—Ä–∏—Ü–∞', '–æ–º–ª–µ—Ç', '—Ç–≤–æ—Ä–æ–≥'],
    '–≥–∞—Ä–Ω–∏—Ä': ['—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–º–∞–∫–∞—Ä–æ–Ω—ã', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–±—É–ª–≥—É—Ä', '–∫—É—Å–∫—É—Å'],
    '–º–æ–ª–æ—á–∫–∞': ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—Ç–≤–æ—Ä–æ–≥', '–π–æ–≥—É—Ä—Ç', '—Å–º–µ—Ç–∞–Ω–∞', '—Å—ã—Ä', '—Ä—è–∂–µ–Ω–∫–∞']
  };

  // === üÜï v2.7.0 –£–ú–ù–´–ï –ü–û–î–°–ö–ê–ó–ö–ò ===
  const SMART_SUGGESTIONS_CONFIG = {
    emptyResultTips: [
      { condition: 'keyboard_layout', message: 'üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—Ä—É—Å/eng)' },
      { condition: 'too_specific', message: 'üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ—Ä–æ—á–µ: ¬´—Ç–≤–æ—Ä–æ–≥¬ª –≤–º–µ—Å—Ç–æ ¬´—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π 0% –¥–æ–º–∏–∫¬ª' },
      { condition: 'typo', message: 'üí° –í–æ–∑–º–æ–∂–Ω–æ, –≤ —Å–ª–æ–≤–µ –æ–ø–µ—á–∞—Ç–∫–∞' },
      { condition: 'category', message: 'üí° –ü–æ–∏—â–∏—Ç–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –º–æ–ª–æ—á–Ω—ã–µ, –º—è—Å–æ, –∫—Ä—É–ø—ã' }
    ],
    popularSearches: ['—Ç–≤–æ—Ä–æ–≥', '–∫—É—Ä–∏—Ü–∞', '—è–π—Ü–∞', '–º–æ–ª–æ–∫–æ', '–æ–≤—Å—è–Ω–∫–∞', '–≥—Ä–µ—á–∫–∞', '—Ä–∏—Å', '–±–∞–Ω–∞–Ω', '—è–±–ª–æ–∫–æ', '—Å—ã—Ä']
  };

  // === üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ===
  let userProductStats = new Map(); // product_id ‚Üí { count, lastUsed }
  let _statsSaveTimer = null;
  const USER_STATS_KEY = 'heys_product_usage_stats';
  const USER_STATS_MIGRATED_KEY = 'heys_product_usage_stats_migrated';
  const USER_STATS_SYNC_KEY = 'heys_product_usage_stats_last_sync';
  const USER_STATS_MAX_AGE_DAYS = 60;

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   */
  function trackProductUsage(productId) {
    if (!CONFIG.enablePersonalization || !productId) {
      return;
    }
    const idKey = String(productId);
    const stats = userProductStats.get(idKey) || { count: 0, lastUsed: 0 };
    stats.count++;
    stats.lastUsed = Date.now();
    userProductStats.set(idKey, stats);

    try {
      if (HEYS.store?.isHiddenProduct?.(idKey)) {
        HEYS.store.unhideProduct?.(idKey);
      }
    } catch (e) { /* ignore */ }

    // –ù–µ –ø–∏—à–µ–º –≤ storage –Ω–∞ –∫–∞–∂–¥—ã–π –∫–ª–∏–∫ ‚Äî –¥–µ–±–∞—É–Ω—Å
    if (_statsSaveTimer) clearTimeout(_statsSaveTimer);
    _statsSaveTimer = setTimeout(() => {
      saveUserStats();
      _statsSaveTimer = null;
    }, 500);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±—É—Å—Ç –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ (0-20 –±–∞–ª–ª–æ–≤)
   */
  function getPersonalBoost(productId) {
    if (!CONFIG.enablePersonalization || !productId) return 0;
    const stats = userProductStats.get(String(productId));
    if (!stats) return 0;

    // –§–æ—Ä–º—É–ª–∞: —á–∞—Å—Ç–æ—Ç–∞ √ó —Å–≤–µ–∂–µ—Å—Ç—å
    const frequencyBoost = Math.min(stats.count * 2, 10); // max 10
    const daysSinceUse = (Date.now() - stats.lastUsed) / (1000 * 60 * 60 * 24);
    const recencyBoost = Math.max(0, 10 - daysSinceUse); // max 10, —É–±—ã–≤–∞–µ—Ç —Å –∫–∞–∂–¥—ã–º –¥–Ω—ë–º

    return Math.round(frequencyBoost + recencyBoost * 0.5);
  }

  /**
   * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ localStorage
   */
  function loadUserStats() {
    try {
      // Prefer HEYS.store (cloud sync), then HEYS.utils.lsGet, fallback to localStorage
      const storeAvailable = !!(HEYS.store && HEYS.store.get);
      const storedObj = storeAvailable
        ? HEYS.store.get(USER_STATS_KEY, null)
        : (HEYS.utils && HEYS.utils.lsGet)
          ? HEYS.utils.lsGet(USER_STATS_KEY, null)
          : (localStorage.getItem(USER_STATS_KEY) ? JSON.parse(localStorage.getItem(USER_STATS_KEY)) : null);

      if (storedObj && typeof storedObj === 'object') {
        // –ö–ª—é—á–∏ —Ö—Ä–∞–Ω–∏–º —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (productId –º–æ–∂–µ—Ç –±—ã—Ç—å number/string)
        userProductStats = new Map(Object.entries(storedObj));
      }
    } catch (e) {
      console.warn('[HEYS.search] loadUserStats error:', e);
    }
  }

  function normalizeClientId(raw) {
    if (!raw) return '';
    if (typeof raw === 'string') {
      const trimmed = raw.trim();
      if (!trimmed || trimmed === 'null' || trimmed === 'undefined') return '';
      try {
        const parsed = JSON.parse(trimmed);
        if (typeof parsed === 'string') return parsed;
        if (parsed && typeof parsed === 'object' && typeof parsed.id === 'string') return parsed.id;
      } catch (e) {
        return trimmed.replace(/^"|"$/g, '');
      }
      return trimmed.replace(/^"|"$/g, '');
    }
    if (typeof raw === 'object' && typeof raw.id === 'string') return raw.id;
    return '';
  }

  function inferClientIdFromDayKeys() {
    try {
      const keys = Object.keys(localStorage);
      let best = { cid: '', ts: 0 };
      keys.forEach((key) => {
        const match = key.match(/^heys_(.+?)_dayv2_(\d{4}-\d{2}-\d{2})$/i);
        if (!match) return;
        const cid = match[1];
        if (!cid || cid === 'dayv2') return;
        const dateStr = match[2];
        const ts = Date.parse(dateStr);
        if (!Number.isFinite(ts)) return;
        if (ts >= best.ts) best = { cid, ts };
      });
      return best.cid || '';
    } catch (e) {
      return '';
    }
  }

  function getClientIdSafe() {
    let cid = HEYS?.currentClientId || '';
    if (!cid) cid = HEYS?.cloud?._pinAuthClientId || '';
    if (!cid) {
      cid = normalizeClientId(localStorage.getItem('heys_pin_auth_client'));
    }
    if (!cid) {
      cid = normalizeClientId(localStorage.getItem('heys_client_current'));
    }
    if (!cid) {
      cid = inferClientIdFromDayKeys();
    }
    return typeof cid === 'string' ? cid : '';
  }

  function hasDayHistory(clientId = getClientIdSafe()) {
    try {
      const keys = Object.keys(localStorage);
      const scopedPrefix = clientId ? `heys_${clientId}_dayv2_` : '';
      return keys.some((key) =>
        key.startsWith('heys_dayv2_')
        || (scopedPrefix && key.startsWith(scopedPrefix))
        || /^heys_(.+?)_dayv2_\d{4}-\d{2}-\d{2}$/i.test(key)
      );
    } catch (e) {
      return false;
    }
  }

  function pruneOldUsageStats(maxAgeDays = USER_STATS_MAX_AGE_DAYS) {
    if (!userProductStats || userProductStats.size === 0) return false;
    const now = Date.now();
    const maxAgeMs = Math.max(1, Number(maxAgeDays) || USER_STATS_MAX_AGE_DAYS) * 24 * 60 * 60 * 1000;
    let changed = false;

    userProductStats.forEach((stats, key) => {
      const lastUsed = Number(stats?.lastUsed || 0) || 0;
      if (!lastUsed || now - lastUsed > maxAgeMs) {
        userProductStats.delete(key);
        changed = true;
      }
    });

    if (changed) saveUserStats();
    return changed;
  }

  function markUsageStatsMigrated() {
    try {
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(USER_STATS_MIGRATED_KEY, true);
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet(USER_STATS_MIGRATED_KEY, true);
      } else {
        localStorage.setItem(USER_STATS_MIGRATED_KEY, JSON.stringify(true));
      }
    } catch (e) { /* ignore */ }
  }

  function isUsageStatsMigrated() {
    try {
      if (HEYS.store && HEYS.store.get) {
        return !!HEYS.store.get(USER_STATS_MIGRATED_KEY, false);
      }
      if (HEYS.utils && HEYS.utils.lsGet) {
        return !!HEYS.utils.lsGet(USER_STATS_MIGRATED_KEY, false);
      }
      const raw = localStorage.getItem(USER_STATS_MIGRATED_KEY);
      return raw ? JSON.parse(raw) === true : false;
    } catch (e) {
      return false;
    }
  }

  function ensureUsageStatsMigrated() {
    if (isUsageStatsMigrated()) return true;

    if (userProductStats && userProductStats.size > 0) {
      markUsageStatsMigrated();
      return true;
    }

    if (!hasDayHistory()) {
      markUsageStatsMigrated();
      return true;
    }

    if (typeof syncUsageStatsFromDays === 'function') {
      syncUsageStatsFromDays({
        daysWindow: 21,
        dateKey: new Date().toISOString().slice(0, 10),
        lsGet: (HEYS.utils && HEYS.utils.lsGet) ? HEYS.utils.lsGet : undefined
      });
    }

    markUsageStatsMigrated();
    return true;
  }

  function scheduleUsageStatsMigration() {
    const migrated = ensureUsageStatsMigrated();
    if (migrated) return;

    if (typeof document !== 'undefined' && document.addEventListener) {
      document.addEventListener('heysClientReady', () => {
        ensureUsageStatsMigrated();
      }, { once: true });
    }

    setTimeout(() => {
      ensureUsageStatsMigrated();
    }, 2000);
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   */
  function saveUserStats() {
    try {
      const data = Object.fromEntries(userProductStats);
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(USER_STATS_KEY, data);
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet(USER_STATS_KEY, data);
      } else {
        localStorage.setItem(USER_STATS_KEY, JSON.stringify(data));
      }
    } catch (e) { /* ignore */ }
  }

  function getUsageStatsLastSync() {
    try {
      if (HEYS.store && HEYS.store.get) {
        return Number(HEYS.store.get(USER_STATS_SYNC_KEY, 0)) || 0;
      }
      if (HEYS.utils && HEYS.utils.lsGet) {
        return Number(HEYS.utils.lsGet(USER_STATS_SYNC_KEY, 0)) || 0;
      }
      const raw = localStorage.getItem(USER_STATS_SYNC_KEY);
      return raw ? Number(JSON.parse(raw)) || 0 : 0;
    } catch (e) {
      return 0;
    }
  }

  function setUsageStatsLastSync(ts) {
    try {
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(USER_STATS_SYNC_KEY, ts);
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet(USER_STATS_SYNC_KEY, ts);
      } else {
        localStorage.setItem(USER_STATS_SYNC_KEY, JSON.stringify(ts));
      }
    } catch (e) { /* ignore */ }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å snapshot —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   * @returns {Map<string, {count:number, lastUsed:number}>}
   */
  function getUsageStats() {
    return new Map(userProductStats);
  }

  /**
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å usage stats –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–Ω–µ–π (–¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)
   * @param {Object} options
   * @param {number} options.daysWindow
   * @param {Function} options.lsGet
   * @param {string} options.dateKey
   * @returns {Map<string, {count:number, lastUsed:number}>}
   */
  function syncUsageStatsFromDays(options = {}) {
    const daysWindow = Math.max(1, Math.min(60, Number(options.daysWindow) || 21));
    const bumpStat = (statsMap, key, ts) => {
      const k = String(key || '').trim();
      if (!k) return;
      const s = statsMap.get(k) || { count: 0, lastUsed: 0 };
      s.count += 1;
      if (!s.lastUsed || ts > s.lastUsed) s.lastUsed = ts;
      statsMap.set(k, s);
    };
    const resolveScopedKey = (rawKey) => {
      const cid = getClientIdSafe();
      if (!cid) return rawKey;
      if (/^heys_(clients|client_current)$/i.test(rawKey)) return rawKey;
      if (rawKey.includes(cid)) return rawKey;
      if (rawKey.startsWith('heys_')) {
        return `heys_${cid}_${rawKey.substring('heys_'.length)}`;
      }
      return `heys_${cid}_${rawKey}`;
    };
    const lsGetFn = options.lsGet
      || (HEYS.store && HEYS.store.get)
      || (HEYS.utils && HEYS.utils.lsGet)
      || ((k, d) => {
        try {
          const scopedKey = resolveScopedKey(k);
          const raw = localStorage.getItem(scopedKey) ?? localStorage.getItem(k);
          if (!raw) return d;
          if (HEYS.store?.decompress) return HEYS.store.decompress(raw);
          return JSON.parse(raw);
        } catch (_) { return d; }
      });
    const readDayRaw = (rawKey) => {
      try {
        const scopedKey = resolveScopedKey(rawKey);
        const raw = localStorage.getItem(scopedKey) ?? localStorage.getItem(rawKey);
        if (!raw) return null;
        if (HEYS.store?.decompress) return HEYS.store.decompress(raw);
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    };
    const today = new Date(options.dateKey || new Date().toISOString().slice(0, 10));
    const nextStats = new Map();

    const scanFromDayKeys = () => {
      try {
        const keys = Object.keys(localStorage);
        const cutoff = new Date(today);
        cutoff.setDate(cutoff.getDate() - (daysWindow - 1));
        const stats = new Map();

        keys.forEach((key) => {
          if (!key.includes('_dayv2_')) return;
          const m = key.match(/_dayv2_(\d{4}-\d{2}-\d{2})/);
          if (!m) return;
          const dateStr = m[1];
          const ts = Date.parse(dateStr);
          if (!Number.isFinite(ts)) return;
          if (ts < cutoff.getTime()) return;

          const raw = localStorage.getItem(key);
          if (!raw) return;
          let dayData = null;
          try {
            if (HEYS.store?.decompress) {
              dayData = HEYS.store.decompress(raw);
            } else if (raw.startsWith('¬§Z¬§')) {
              dayData = JSON.parse(raw.substring(3));
            } else {
              dayData = JSON.parse(raw);
            }
          } catch (e) {
            dayData = null;
          }
          if (!dayData?.meals) return;

          dayData.meals.forEach((meal) => {
            if (!meal?.items) return;
            meal.items.forEach((item) => {
              const pid = String(item.product_id || item.productId || '');
              const rawName = String(item.name || '').trim();
              const normName = normalizeText(rawName);
              if (pid) bumpStat(stats, pid, ts);
              if (rawName) bumpStat(stats, rawName, ts);
              if (normName) bumpStat(stats, normName, ts);
            });
          });
        });

        return stats;
      } catch (e) {
        return new Map();
      }
    };

    let scannedDays = 0;
    let foundMeals = 0;
    let foundItems = 0;
    for (let i = 0; i < daysWindow; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayKey = `heys_dayv2_${key}`;
      if (HEYS.store?.invalidate) {
        HEYS.store.invalidate(dayKey);
      }
      const dayData = lsGetFn(dayKey, null) || readDayRaw(dayKey);
      const dayTs = d.getTime();

      if (dayData && dayData.meals) {
        scannedDays++;
        dayData.meals.forEach(meal => {
          if (!meal.items) return;
          foundMeals++;
          meal.items.forEach(item => {
            const pid = String(item.product_id || item.productId || '');
            const rawName = String(item.name || '').trim();
            const normName = normalizeText(rawName);
            if (!pid && !rawName && !normName) return;
            foundItems++;
            if (pid) bumpStat(nextStats, pid, dayTs);
            if (rawName) bumpStat(nextStats, rawName, dayTs);
            if (normName) bumpStat(nextStats, normName, dayTs);
          });
        });
      }
    }

    let finalStats = nextStats;
    if (finalStats.size === 0) {
      finalStats = scanFromDayKeys();
    }

    if (finalStats.size === 0) {
      console.warn('[HEYS.search] syncUsageStatsFromDays: no stats found in', scannedDays, 'days');
    }

    if (finalStats.size > 0) {
      userProductStats = new Map(finalStats);
      saveUserStats();
      setUsageStatsLastSync(Date.now());
      console.info('[HEYS.search] ‚úÖ Usage stats synced:', {
        statsKeys: finalStats.size,
        scannedDays,
        foundItems,
        sample: Array.from(finalStats.entries()).slice(0, 3).map(([k, v]) => `${k}: ${v.count}√ó`)
      });
    }

    try {
      HEYS._usageStatsDebug = {
        ...(HEYS._usageStatsDebug || {}),
        sync: {
          daysWindow,
          scannedDays,
          foundMeals,
          foundItems,
          statsSize: nextStats.size,
          clientId: getClientIdSafe(),
          sample: Array.from(nextStats.entries()).slice(0, 5)
        }
      };
    } catch (e) { }

    if (HEYS.DEBUG_MODE) {
      const payload = HEYS._usageStatsDebug?.sync || {
        daysWindow,
        scannedDays,
        foundMeals,
        foundItems,
        statsSize: finalStats.size,
        clientId: getClientIdSafe()
      };
      console.log('üîé [UsageStats] syncUsageStatsFromDays', payload);
      if (finalStats.size === 0) {
        console.log('‚ö†Ô∏è [UsageStats] no stats found from day keys');
      }
      if (global.DEV?.log) {
        global.DEV.log('üîé [UsageStats] syncUsageStatsFromDays', payload);
      }
    }

    return new Map(userProductStats);
  }

  function ensureUsageStatsFresh(options = {}) {
    const maxHours = Math.max(1, Number(options.maxHours) || 12);
    const lastSync = getUsageStatsLastSync();
    const maxAgeMs = maxHours * 60 * 60 * 1000;
    const shouldSync = !lastSync || (Date.now() - lastSync) > maxAgeMs;
    if (!shouldSync) return false;

    syncUsageStatsFromDays({
      daysWindow: Math.max(1, Math.min(60, Number(options.daysWindow) || 21)),
      dateKey: options.dateKey,
      lsGet: options.lsGet
    });
    return true;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  loadUserStats();
  scheduleUsageStatsMigration();
  pruneOldUsageStats();

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ (ru/en/mixed)
   */
  function detectLanguage(text) {
    if (!text) return 'unknown';
    const hasRu = /[–∞-—è—ë]/i.test(text);
    const hasEn = /[a-z]/i.test(text);
    if (hasRu && hasEn) return 'mixed';
    if (hasRu) return 'ru';
    if (hasEn) return 'en';
    return 'unknown';
  }

  /**
   * üÜï –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
   * vfkjrj ‚Üí –º–æ–ª–æ–∫–æ, –º–æ–ª–æ–∫–æ ‚Üí vjkjrj
   */
  function convertKeyboardLayout(text) {
    if (!CONFIG.enableKeyboardFix || !text) return null;

    const lang = detectLanguage(text);
    const lower = text.toLowerCase();
    let converted = '';

    if (lang === 'en') {
      // QWERTY ‚Üí –ô–¶–£–ö–ï–ù
      for (const char of lower) {
        converted += QWERTY_TO_CYRILLIC[char] || char;
      }
    } else if (lang === 'ru') {
      // –ô–¶–£–ö–ï–ù ‚Üí QWERTY
      for (const char of lower) {
        converted += CYRILLIC_TO_QWERTY[char] || char;
      }
    } else {
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–ª–∞ –¥—Ä—É–≥–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return converted !== lower ? converted : null;
  }

  /**
   * üÜï –†–∞—Å–∫—Ä—ã—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
   */
  function expandAbbreviations(query) {
    if (!CONFIG.enableAbbreviations || !query) return [];

    const normalized = normalizeText(query);
    const expansions = new Set();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ
    for (const [abbr, meanings] of Object.entries(ABBREVIATIONS)) {
      if (normalized.includes(abbr) || normalized === abbr) {
        meanings.forEach(m => {
          // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª–Ω—É—é —Ñ–æ—Ä–º—É
          expansions.add(normalized.replace(abbr, m));
          expansions.add(m);
        });
      }
    }

    return [...expansions];
  }

  /**
   * üÜï –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
   * "—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π" ‚Üí ["–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π —Ç–≤–æ—Ä–æ–≥"]
   */
  function generateWordPermutations(query) {
    if (!CONFIG.enableWordPermutations || !query) return [];

    const words = normalizeText(query).split(/\s+/).filter(w => w.length >= 2);
    if (words.length < 2 || words.length > 4) return []; // –¢–æ–ª—å–∫–æ 2-4 —Å–ª–æ–≤–∞

    const permutations = new Set();

    // –î–ª—è 2 —Å–ª–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º
    if (words.length === 2) {
      permutations.add(`${words[1]} ${words[0]}`);
    }

    // –î–ª—è 3-4 —Å–ª–æ–≤ ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏
    if (words.length >= 3) {
      // –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ –≤ –Ω–∞—á–∞–ª–æ
      permutations.add([words[words.length - 1], ...words.slice(0, -1)].join(' '));
      // –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –≤ –∫–æ–Ω–µ—Ü
      permutations.add([...words.slice(1), words[0]].join(' '));
    }

    return [...permutations];
  }

  /**
   * üÜï –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * "–º–æ–ª–æ—á–Ω—ã–µ" ‚Üí –≤—Å–µ –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
   */
  function findCategoryProducts(query, dataSource) {
    const normalized = normalizeText(query);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏?
    for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
      if (normalized === category || normalized === category.slice(0, -2)) { // –º–æ–ª–æ—á–Ω—ã–µ/–º–æ–ª–æ—á–Ω
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        return dataSource.filter(item => {
          const itemName = normalizeText(item.name || '');
          return keywords.some(kw => itemName.includes(kw));
        }).map(item => ({
          ...item,
          matchType: 'category',
          matchedCategory: category
        }));
      }
    }

    return [];
  }

  /**
   * üÜï N-gram –ø–æ–∏—Å–∫ (–ø–æ–∏—Å–∫ –ø–æ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —Å–ª–æ–≤–∞)
   */
  function ngramSearch(query, dataSource, minGramSize = 3) {
    if (!CONFIG.enableNgram || !query || query.length < minGramSize) return [];

    const normalized = normalizeText(query);
    const results = [];

    dataSource.forEach(item => {
      const itemName = normalizeText(item.name || '');

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º n-–≥—Ä–∞–º–º—ã –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
      for (let i = 0; i <= itemName.length - normalized.length; i++) {
        const gram = itemName.substring(i, i + normalized.length);

        // Fuzzy —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ n-–≥—Ä–∞–º–º—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º
        const distance = levenshteinDistance(normalized, gram, 1);
        if (distance <= 1) {
          results.push({
            ...item,
            matchType: 'ngram',
            matchPosition: i,
            ngramDistance: distance
          });
          break; // –û–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç –æ–¥–∏–Ω —Ä–∞–∑
        }
      }
    });

    return results;
  }

  /**
   * –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
   * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
   * @param {string} direction - 'ru-to-en' | 'en-to-ru' | 'auto' (–æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   * @returns {string} —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
   */
  function transliterate(text, direction = 'auto') {
    if (!text) return '';
    const lower = text.toLowerCase();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω—ã–µ –ø–∞—Ä—ã
    if (TRANSLIT_PAIRS[lower]) {
      return TRANSLIT_PAIRS[lower];
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (direction === 'auto') {
      const lang = detectLanguage(lower);
      direction = lang === 'ru' ? 'ru-to-en' : 'en-to-ru';
    }

    if (direction === 'ru-to-en') {
      // –†—É—Å—Å–∫–∏–π ‚Üí –õ–∞—Ç–∏–Ω–∏—Ü–∞
      let result = '';
      for (const char of lower) {
        result += TRANSLIT_RU_TO_EN[char] || char;
      }
      return result;
    } else {
      // –õ–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí –†—É—Å—Å–∫–∏–π (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
      let result = lower;
      for (const [from, to] of TRANSLIT_EN_TO_RU) {
        result = result.split(from).join(to);
      }
      return result;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @returns {string[]} –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –∏—Å—Ö–æ–¥–Ω—ã–π)
   */
  function getTranslitVariants(query) {
    if (!CONFIG.enableTranslit || !query) return [query];

    const normalized = normalizeText(query);
    const variants = new Set([normalized]);

    // –¢–æ—á–Ω–∞—è –ø–∞—Ä–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
    if (TRANSLIT_PAIRS[normalized]) {
      variants.add(normalizeText(TRANSLIT_PAIRS[normalized]));
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    const lang = detectLanguage(normalized);
    if (lang === 'ru') {
      // –†—É—Å—Å–∫–∏–π ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞
      variants.add(transliterate(normalized, 'ru-to-en'));
    } else if (lang === 'en') {
      // –õ–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí —Ä—É—Å—Å–∫–∏–π
      variants.add(transliterate(normalized, 'en-to-ru'));
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    for (const [canonical, spellings] of Object.entries(SPELLING_VARIANTS)) {
      if (spellings.some(s => normalizeText(s) === normalized)) {
        // –ù–∞—à–ª–∏ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É
        variants.add(normalizeText(canonical));
      }
      if (normalizeText(canonical) === normalized) {
        // –≠—Ç–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        spellings.forEach(s => variants.add(normalizeText(s)));
      }
    }

    return [...variants].filter(v => v && v.length >= 2);
  }

  /**
   * –ù–∞–π—Ç–∏ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   */
  function getCanonicalForm(query) {
    const normalized = normalizeText(query);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ SPELLING_VARIANTS
    for (const [canonical, spellings] of Object.entries(SPELLING_VARIANTS)) {
      if (normalizeText(canonical) === normalized) {
        return canonical;
      }
      if (spellings.some(s => normalizeText(s) === normalized)) {
        return canonical;
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ TRANSLIT_PAIRS (–±–µ—Ä—ë–º —Ä—É—Å—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∫ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)
    if (TRANSLIT_PAIRS[normalized]) {
      const pair = TRANSLIT_PAIRS[normalized];
      // –ï—Å–ª–∏ –ø–∞—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º - —ç—Ç–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞
      if (detectLanguage(pair) === 'ru') {
        return pair;
      }
    }

    return null;
  }

  // === –£–¢–ò–õ–ò–¢–´ ===

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
   * –ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: —ë ‚Üí –µ, lowercase, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ
   */
  function normalizeText(text) {
    if (!text) return '';
    return String(text)
      .toLowerCase()
      .replace(/—ë/g, '–µ')              // —ë ‚Üí –µ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
      .replace(/[^\w–∞-—è—ë\s-]/gi, ' ')  // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å
      .replace(/\s+/g, ' ')            // –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã ‚Üí –æ–¥–∏–Ω
      .trim();
  }

  // –ß–∞—Å—Ç—ã–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞ ‚Äî –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Å–º—ã—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
  const STOPWORDS = new Set([
    '–∏', '–∞', '–Ω–æ', '–∏–ª–∏', '–≤', '–≤–æ', '–Ω–∞', '–ø–æ', '–∫', '–∫–æ', '—Å', '—Å–æ', '—É', '–∏–∑', '–æ—Ç',
    '–∑–∞', '–¥–ª—è', '–ø—Ä–∏', '–±–µ–∑', '–Ω–∞–¥', '–ø–æ–¥', '–ø—Ä–æ', '–¥–æ', '–ø–æ—Å–ª–µ', '—ç—Ç–æ', '—Ç–æ—Ç', '—Ç–∞',
    'the', 'a', 'an', 'and', 'or', 'to', 'of', 'in', 'on', 'for', 'with', 'without'
  ]);

  /**
   * üÜï –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏–π (stemming-lite)
   * –£–±–∏—Ä–∞–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
   */
  function normalizeRussianWord(word) {
    if (!word || word.length < 4) return word;

    // –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: -–∞—è, -—è—è, -–æ–µ, -–µ–µ, -—ã–π, -–∏–π, -—ã–µ, -–∏–µ
    if (/(–∞—è|—è—è|–æ–µ|–µ–µ|—ã–π|–∏–π|—ã–µ|–∏–µ)$/.test(word)) {
      return word.replace(/(–∞—è|—è—è|–æ–µ|–µ–µ|—ã–π|–∏–π|—ã–µ|–∏–µ)$/, '');
    }

    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ: -—ã, -–∏ (–µ—Å–ª–∏ –Ω–µ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–ª–æ–≤–æ)
    if (word.length > 4 && /(—ã|–∏)$/.test(word)) {
      return word.slice(0, -1);
    }

    return word;
  }

  /**
   * üÜï v2.5.0 –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–ª–æ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏
   * "–º–æ–ª–æ–∫–æ 1.5%" -> [{ value: 1.5, unit: '%', raw: '1.5%' }]
   * "—Ç–≤–æ—Ä–æ–≥ 5%" -> [{ value: 5, unit: '%', raw: '5%' }]
   * "–∫–µ—Ñ–∏—Ä 1–ª" -> [{ value: 1000, unit: 'ml', raw: '1–ª' }]
   */
  function parseNumericConstraints(text) {
    if (!text) return [];

    // –ü–∞—Ç—Ç–µ—Ä–Ω: —á–∏—Å–ª–æ (—Å —Ç–æ—á–∫–æ–π/–∑–∞–ø—è—Ç–æ–π) + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–æ–±–µ–ª + –µ–¥–∏–Ω–∏—Ü–∞
    // –ì—Ä—É–ø–ø—ã: 1=—á–∏—Å–ª–æ, 3=–µ–¥–∏–Ω–∏—Ü–∞
    const regex = /(\d+(?:[.,]\d+)?)\s*([%a-zA-Z–∞-—è–ê-–Ø—ë–Å]+)?/g;
    const constraints = [];
    let match;

    while ((match = regex.exec(text)) !== null) {
      const valStr = match[1].replace(',', '.');
      const unitStr = (match[2] || '').toLowerCase();

      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ—Ö–æ–∂–∏ –Ω–∞ –≥–æ–¥ –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª (4 —Ü–∏—Ñ—Ä—ã)
      // –ù–æ –±–µ—Ä–µ–º –º–∞–ª–µ–Ω—å–∫–∏–µ —á–∏—Å–ª–∞ (–∂–∏—Ä–Ω–æ—Å—Ç—å, –≤–µ—Å)
      const value = parseFloat(valStr);

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü—ã
      let normalizedUnit = null;
      let normalizedValue = value;

      if (unitStr) {
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        if (UNIT_CONVERSION[unitStr]) {
          const conv = UNIT_CONVERSION[unitStr];
          normalizedUnit = conv.base;
          normalizedValue = value * conv.factor;
        } else {
          // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
          normalizedUnit = unitStr;
        }
      } else {
        // –ß–∏—Å–ª–æ –±–µ–∑ –µ–¥–∏–Ω–∏—Ü—ã.
        // –ï—Å–ª–∏ —ç—Ç–æ 0-100, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º (–∂–∏—Ä–Ω–æ—Å—Ç—å)
        // –ï—Å–ª–∏ >100, –º–æ–∂–µ—Ç –±—ã—Ç—å –≥—Ä–∞–º–º–∞–º–∏
        // –ü–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º 'generic'
        normalizedUnit = 'generic';
      }

      constraints.push({
        value: normalizedValue,
        unit: normalizedUnit,
        rawUnit: unitStr,
        rawValue: value,
        original: match[0]
      });
    }

    return constraints;
  }

  /**
   * üÜï v2.5.0 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å–ª–æ–≤–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
   * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —á–∏—Å–ª–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —Å —á–∏—Å–ª–∞–º–∏ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ
   */
  function checkNumericMatch(queryConstraints, productConstraintsOrText) {
    if (!queryConstraints || queryConstraints.length === 0) return 1.0;

    // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–∞ –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞
    const productNumbers = Array.isArray(productConstraintsOrText)
      ? productConstraintsOrText
      : parseNumericConstraints(productConstraintsOrText);

    if (productNumbers.length === 0) return 0.9; // –ù–µ—Ç —á–∏—Å–µ–ª –≤ –ø—Ä–æ–¥—É–∫—Ç–µ - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ

    let matchScore = 0;
    let matchedCount = 0;

    for (const qNum of queryConstraints) {
      // –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —á–∏—Å–ª–æ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ
      const bestMatch = productNumbers.find(pNum => {
        // 1. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü (–∏–ª–∏ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö generic)
        const unitMatch = (qNum.unit === pNum.unit) ||
          (qNum.unit === 'generic' && pNum.unit !== '%') || // generic –Ω–µ –º–∞—Ç—á–∏—Ç %
          (pNum.unit === 'generic' && qNum.unit !== '%');

        if (!unitMatch) return false;

        // 2. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π (—Å –¥–æ–ø—É—Å–∫–æ–º)
        // –î–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ–ø—É—Å–∫ –º–∞–ª–µ–Ω—å–∫–∏–π (0.1), –¥–ª—è –≥—Ä–∞–º–º–æ–≤ –±–æ–ª—å—à–æ–π (10%)
        const tolerance = qNum.unit === '%' ? 0.1 : Math.max(0.1, qNum.value * 0.1);
        return Math.abs(qNum.value - pNum.value) <= tolerance;
      });

      if (bestMatch) {
        matchedCount++;
        matchScore += 1.0;
      } else {
        // –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –±—ã–ª–æ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 5%), –∞ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ –µ–≥–æ –Ω–µ—Ç –∏–ª–∏ –¥—Ä—É–≥–æ–µ - —à—Ç—Ä–∞—Ñ
        // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ (%, –∫–≥, –ª)
        if (qNum.unit !== 'generic') {
          matchScore -= 0.5;
        }
      }
    }

    if (matchedCount === 0 && queryConstraints.length > 0) return 0.8; // –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏

    return Math.max(0.5, Math.min(1.5, 1.0 + (matchScore * 0.2)));
  }

  /**
   * üÜï –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞/–Ω–∞–∑–≤–∞–Ω–∏—è (—Å–ª–æ–≤–∞)
   */
  function tokenize(text) {
    const norm = normalizeText(text);
    if (!norm) return [];
    return norm
      .split(/\s+/)
      .map(t => t.trim())
      .filter(t => t.length >= 2)
      .filter(t => !STOPWORDS.has(t))
      .map(t => normalizeRussianWord(t)); // üÜï v2.5.0 Stemming
  }

  /**
   * üÜï –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ —Å—ã—Ä–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
   * –ü—Ä–∏–º–µ—Ä—ã:
   *  - "2.5%" ‚Üí ["2.5%", "2.5"]
   *  - "0%"   ‚Üí ["0%", "0"]
   *  - "250–≥" ‚Üí ["250"]
   */
  function extractNumericTokens(rawText) {
    if (!rawText) return [];
    const s = String(rawText).toLowerCase();
    const out = new Set();

    // 1) –î–µ—Å—è—Ç–∏—á–Ω—ã–µ/—Ü–µ–ª—ã–µ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º %
    const re = /\b(\d+(?:[\.,]\d+)?)(\s*%?)\b/g;
    let m;
    while ((m = re.exec(s))) {
      const num = (m[1] || '').replace(',', '.');
      const hasPct = (m[2] || '').includes('%');
      if (!num) continue;
      out.add(num);
      if (hasPct) out.add(num + '%');
    }

    // 2) –ß–∏—Å–ª–æ + –µ–¥–∏–Ω–∏—Ü—ã (–≥/–≥—Ä/ml/–º–ª/–ª/–∫–≥) ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ (–µ–¥–∏–Ω–∏—Ü—ã –Ω–µ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ —Ç–æ–∫–µ–Ω)
    const reUnits = /\b(\d+(?:[\.,]\d+)?)(?:\s*)(–≥|–≥—Ä|kg|–∫–≥|ml|–º–ª|–ª|—à—Ç)\b/g;
    while ((m = reUnits.exec(s))) {
      const num = (m[1] || '').replace(',', '.');
      if (num) out.add(num);
    }

    return [...out];
  }

  /**
   * üÜï –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø—Ä–æ–¥—É–∫—Ç–µ.
   * –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å "2.5" ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ–º –∏ "2.5%".
   */
  function numbersMatchAll(queryNums, itemNums) {
    if (!queryNums || queryNums.length === 0) return true;
    if (!itemNums || itemNums.length === 0) return false;
    const set = new Set(itemNums);
    return queryNums.every(q => {
      if (set.has(q)) return true;
      // 2.5 –º–æ–∂–µ—Ç –º–∞—Ç—á–∏—Ç—å—Å—è —Å 2.5%
      if (!q.endsWith('%') && set.has(q + '%')) return true;
      // 0% –º–æ–∂–µ—Ç –º–∞—Ç—á–∏—Ç—å—Å—è —Å 0
      if (q.endsWith('%') && set.has(q.replace('%', ''))) return true;
      return false;
    });
  }

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Ç–æ–∫–µ–Ω–∞–º –∑–∞–ø—Ä–æ—Å–∞.
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { coverage, bonus }
   */
  function computeTokenMatchScore(queryTokens, itemNameNorm, itemTokens) {
    if (!queryTokens || queryTokens.length === 0) return { coverage: 0, bonus: 0 };
    const name = itemNameNorm || '';
    const tokens = itemTokens || [];
    const isMultiTokenQuery = queryTokens.length >= 2;
    let hit = 0;

    for (const qt of queryTokens) {
      if (!qt) continue;

      // 1) —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
      if (tokens.includes(qt)) {
        hit++;
        continue;
      }
      // 2) –ø—Ä–µ—Ñ–∏–∫—Å ("—Ç–≤–æ—Ä" ‚Üí "—Ç–≤–æ—Ä–æ–≥"). –î–ª—è multi-token –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã ("–≥—Ä" ‚Üí "–≥—Ä–µ—á–µ—Å–∫–∏–π").
      if (tokens.some(t => t.startsWith(qt) && (qt.length >= 3 || (isMultiTokenQuery && qt.length >= 2)))) {
        hit++;
        continue;
      }
      // 3) fallback: –ø–æ–¥—Å—Ç—Ä–æ–∫–∞
      if (name.includes(qt) && (qt.length >= 3 || (isMultiTokenQuery && qt.length >= 2))) {
        hit++;
        continue;
      }
    }

    const coverage = hit / Math.max(1, queryTokens.length);

    // –ë–æ–Ω—É—Å: —á–µ–º –≤—ã—à–µ coverage, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ. –ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–ª–æ–≤–∞–º ‚Äî –∂–∏—Ä–Ω—ã–π –±—É—Å—Ç.
    let bonus = 0;
    if (coverage >= 1) bonus = 18;
    else if (coverage >= 0.75) bonus = 10;
    else if (coverage >= 0.5) bonus = 5;

    return { coverage, bonus };
  }

  /**
   * –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–¥–ª—è fuzzy-–ø–æ–∏—Å–∫–∞)
   */
  function phoneticNormalize(text) {
    if (!CONFIG.enablePhonetic) return normalizeText(text);

    let result = normalizeText(text);
    phoneticRules.forEach(rule => {
      result = result.replace(rule.from, rule.to);
    });
    return result;
  }

  /**
   * –†–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞ (–¥–ª—è –æ–ø–µ—á–∞—Ç–æ–∫)
   * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —Ä–∞–Ω–Ω–∏–º –≤—ã—Ö–æ–¥–æ–º
   */
  function levenshteinDistance(str1, str2, maxDistance = Infinity) {
    const len1 = str1.length;
    const len2 = str2.length;

    // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (len1 === 0) return len2;
    if (len2 === 0) return len1;
    if (Math.abs(len1 - len2) > maxDistance) return maxDistance + 1;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
    const prev = new Array(len2 + 1);
    const curr = new Array(len2 + 1);

    for (let j = 0; j <= len2; j++) prev[j] = j;

    for (let i = 1; i <= len1; i++) {
      curr[0] = i;
      let minInRow = i;

      for (let j = 1; j <= len2; j++) {
        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
        curr[j] = Math.min(
          prev[j] + 1,      // —É–¥–∞–ª–µ–Ω–∏–µ
          curr[j - 1] + 1,  // –≤—Å—Ç–∞–≤–∫–∞
          prev[j - 1] + cost // –∑–∞–º–µ–Ω–∞
        );
        minInRow = Math.min(minInRow, curr[j]);
      }

      // –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –µ—Å–ª–∏ –º–∏–Ω–∏–º—É–º –≤ —Å—Ç—Ä–æ–∫–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç maxDistance
      if (minInRow > maxDistance) return maxDistance + 1;

      // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –≤ prev (swap —Ç—É—Ç –Ω–µ –Ω—É–∂–µ–Ω)
      for (let j = 0; j <= len2; j++) prev[j] = curr[j];
    }

    return prev[len2];
  }

  /**
   * üÜï –ë—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è) ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –ø–æ–∏—Å–∫–∞.
   */
  function computeDataSourceHash(dataSource) {
    try {
      const len = dataSource.length;
      const first = dataSource[0];
      const last = dataSource[len - 1];
      const fKey = (first && (first.id || first.name)) ? String(first.id || first.name) : '';
      const lKey = (last && (last.id || last.name)) ? String(last.id || last.name) : '';
      return `${len}|${fKey}|${lKey}`;
    } catch (e) {
      return String(dataSource.length || 0);
    }
  }

  function getIndexedProducts(dataSource, opts) {
    if (!dataSource || !Array.isArray(dataSource)) return [];
    const hash = computeDataSourceHash(dataSource);
    if (productIndex && lastProductsHash === hash) {
      return productIndex;
    }

    const indexed = dataSource.map(item => {
      const nameRaw = item?.name || '';
      const nameNorm = normalizeText(nameRaw);
      const namePhon = (opts && opts.enablePhonetic) ? phoneticNormalize(nameRaw) : nameNorm;
      const tokens = tokenize(nameRaw);
      const numbers = parseNumericConstraints(nameRaw); // üÜï v2.5.0
      const key = item?.id || item?.name;
      return { key, item, nameRaw, nameNorm, namePhon, tokens, numbers };
    });

    productIndex = indexed;
    lastProductsHash = hash;
    return indexed;
  }

  /**
   * –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –¥–ª—è —Å–ª–æ–≤–∞
   */
  function findSynonyms(query) {
    if (!CONFIG.enableSynonyms) return [];

    const normalized = normalizeText(query);
    const result = new Set();

    // –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫
    if (synonyms[normalized]) {
      synonyms[normalized].forEach(s => result.add(s));
    }

    // –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–ª–æ–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º–æ–º)
    for (const [key, values] of Object.entries(synonyms)) {
      if (values.some(v => normalizeText(v) === normalized)) {
        result.add(key);
        values.forEach(v => {
          if (normalizeText(v) !== normalized) result.add(v);
        });
      }
    }

    return [...result];
  }

  /**
   * –ü–æ–∏—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–ø–µ—á–∞—Ç–æ–∫
   */
  function findTypoCorrections(query, wordList) {
    if (!CONFIG.enableTypoCorrection) return [];

    const normalized = normalizeText(query);
    if (normalized.length < CONFIG.minQueryLength) return [];

    const maxDistance = CONFIG.getMaxTypoDistance(normalized.length);
    const corrections = [];
    const seen = new Set();

    // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    const uniqueWords = new Set();
    wordList.forEach(item => {
      const name = normalizeText(item.name || item);
      uniqueWords.add(name);
      // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
      name.split(/\s+/).forEach(w => {
        if (w.length >= 3) uniqueWords.add(w);
      });
    });

    // –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞
    for (const word of uniqueWords) {
      if (seen.has(word)) continue;

      const distance = levenshteinDistance(normalized, word, maxDistance);
      if (distance > 0 && distance <= maxDistance) {
        seen.add(word);
        corrections.push({
          original: query,
          corrected: word,
          distance,
          confidence: 1 - (distance / Math.max(normalized.length, word.length))
        });
      }
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    return corrections.sort((a, b) => b.confidence - a.confidence).slice(0, 5);
  }

  /**
   * üÜï v2.7.0 –ü–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥–∞–º (fuzzy matching)
   * –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞
   */
  function findBrandVariants(query) {
    const normalized = normalizeText(query);
    const variants = new Set();

    for (const [canonical, spellings] of Object.entries(BRAND_DICTIONARY)) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ª—é–±—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º
      if (spellings.some(s => normalizeText(s) === normalized)) {
        // –ù–∞—à–ª–∏ –±—Ä–µ–Ω–¥ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        variants.add(normalizeText(canonical));
        spellings.forEach(s => variants.add(normalizeText(s)));
      }

      // Fuzzy match –¥–ª—è –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –±—Ä–µ–Ω–¥–∞
      for (const spelling of spellings) {
        const normSpelling = normalizeText(spelling);
        const distance = levenshteinDistance(normalized, normSpelling, 2);
        if (distance > 0 && distance <= 2 && normalized.length >= 4) {
          variants.add(normSpelling);
          variants.add(normalizeText(canonical));
          spellings.forEach(s => variants.add(normalizeText(s)));
        }
      }
    }

    return [...variants];
  }

  /**
   * üÜï v2.7.0 –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (ML-lite)
   * –ò—â–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ —Å–º—ã—Å–ª–æ–≤–æ–π –±–ª–∏–∑–æ—Å—Ç–∏
   */
  function findSemanticMatches(query, dataSource, limit = 10) {
    const normalized = normalizeText(query);
    const matches = [];

    // –ò—â–µ–º –≤ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö
    for (const [cluster, products] of Object.entries(SEMANTIC_CLUSTERS)) {
      const clusterNorm = normalizeText(cluster);

      // –ó–∞–ø—Ä–æ—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞?
      if (clusterNorm.includes(normalized) || normalized.includes(clusterNorm)) {
        // –ò—â–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ dataSource
        dataSource.forEach(item => {
          const itemName = normalizeText(item.name || '');
          for (const clusterProduct of products) {
            if (itemName.includes(normalizeText(clusterProduct))) {
              matches.push({
                ...item,
                matchType: 'semantic',
                semanticCluster: cluster,
                relevance: 55
              });
              break;
            }
          }
        });
      }

      // –ó–∞–ø—Ä–æ—Å ‚Äî –æ–¥–∏–Ω –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞?
      if (products.some(p => normalizeText(p) === normalized)) {
        // –ù–∞—Ö–æ–¥–∏–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ –∂–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–ø–æ—Ö–æ–∂–∏–µ)
        dataSource.forEach(item => {
          const itemName = normalizeText(item.name || '');
          for (const clusterProduct of products) {
            const cpNorm = normalizeText(clusterProduct);
            if (cpNorm !== normalized && itemName.includes(cpNorm)) {
              matches.push({
                ...item,
                matchType: 'semantic',
                semanticCluster: cluster,
                relatedTo: query,
                relevance: 45
              });
              break;
            }
          }
        });
      }
    }

    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ª–∏–º–∏—Ç–∏—Ä—É–µ–º
    const seen = new Set();
    return matches.filter(m => {
      const key = m.id || m.name;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    }).slice(0, limit);
  }

  /**
   * üÜï v2.7.0 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
   */
  function generateSmartSuggestions(query, dataSource) {
    const normalized = normalizeText(query);
    const suggestions = {
      tips: [],
      alternatives: [],
      popular: [],
      didYouMean: []
    };

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ
    const lang = detectLanguage(query);
    if (lang === 'en') {
      const keyboardFixed = convertKeyboardLayout(query);
      if (keyboardFixed && keyboardFixed !== normalized && keyboardFixed !== query.toLowerCase()) {
        suggestions.tips.push({
          type: 'keyboard_layout',
          message: `üí° –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: "${keyboardFixed}"`,
          action: keyboardFixed
        });
      }
    }

    // 2. –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π/—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    const words = normalized.split(/\s+/).filter(w => w.length > 1);
    if (words.length >= 3) {
      suggestions.tips.push({
        type: 'too_specific',
        message: `üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ—Ä–æ—á–µ: "${words[0]}"`,
        action: words[0]
      });
    }

    // 3. –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ (typo correction)
    if (dataSource && dataSource.length > 0) {
      const typoCorrections = findTypoCorrections(query, dataSource);
      if (typoCorrections.length > 0) {
        suggestions.didYouMean = typoCorrections.slice(0, 3).map(c => ({
          type: 'typo',
          message: `üîß –í–æ–∑–º–æ–∂–Ω–æ: "${c.corrected}"`,
          action: c.corrected,
          confidence: c.confidence
        }));
      }
    }

    // 4. –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    const translitVariants = getTranslitVariants(query);
    translitVariants.forEach(v => {
      if (v !== normalized) {
        suggestions.alternatives.push({
          type: 'translit',
          message: `üåê –ù–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ: "${v}"`,
          action: v
        });
      }
    });

    // 5. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
    const matchingCategories = [];
    for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
      if (keywords.some(kw => normalizeText(kw).includes(normalized) || normalized.includes(normalizeText(kw)))) {
        matchingCategories.push(category);
      }
    }
    if (matchingCategories.length > 0) {
      suggestions.tips.push({
        type: 'category',
        message: `üìÇ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: ${matchingCategories.slice(0, 2).join(', ')}`,
        action: matchingCategories[0]
      });
    }

    // 6. –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    suggestions.popular = SMART_SUGGESTIONS_CONFIG.popularSearches.slice(0, 5);

    return suggestions;
  }

  /**
   * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   * üÜï v2.8.1: –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ > startsWith –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Å–ª–æ–≤–∞
   */
  function calculateRelevance(item, query, matchType = 'exact') {
    const itemName = normalizeText(item.name || '');
    const normalizedQuery = normalizeText(query);
    let relevance = 0;

    // –ë–∞–∑–æ–≤—ã–µ –±–∞–ª–ª—ã –ø–æ —Ç–∏–ø—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    switch (matchType) {
      case 'exact':
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Å–ª–æ–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        const words = itemName.split(/\s+/);
        const isExactWord = words.includes(normalizedQuery); // "—Å—ã—Ä" –∫–∞–∫ –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ
        const firstWordMatch = words[0] === normalizedQuery; // "—Å—ã—Ä" = –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
        const startsWithQuery = itemName.startsWith(normalizedQuery); // "—Å—ã—Ä–Ω–∏–∫–∏" –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "—Å—ã—Ä"
        const startsWithQueryIsOwnWord = startsWithQuery && words[0] === normalizedQuery; // –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ = –∑–∞–ø—Ä–æ—Å

        if (itemName === normalizedQuery) {
          relevance = 100; // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        } else if (firstWordMatch) {
          relevance = 95; // üÜï –ó–∞–ø—Ä–æ—Å = –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ: "—Å—ã—Ä —Ç–≤—ë—Ä–¥—ã–π" –¥–ª—è "—Å—ã—Ä"
        } else if (isExactWord) {
          relevance = 92; // üÜï –ó–∞–ø—Ä–æ—Å = –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏: "—Å—ã—Ä –ø–ª–∞–≤–ª–µ–Ω—ã–π –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π"
        } else if (startsWithQuery) {
          // startsWith –Ω–æ –ù–ï –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî "—Å—ã—Ä–Ω–∏–∫–∏" –¥–ª—è "—Å—ã—Ä"
          relevance = 82; // üÜï –ü–æ–Ω–∏–∂–µ–Ω–æ —Å 90 –¥–æ 82
        } else if (itemName.includes(' ' + normalizedQuery)) {
          relevance = 85; // —Å–ª–æ–≤–æ —Ü–µ–ª–∏–∫–æ–º –ø–æ—Å–ª–µ –ø—Ä–æ–±–µ–ª–∞
        } else if (itemName.includes(normalizedQuery + ' ')) {
          relevance = 85; // —Å–ª–æ–≤–æ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Å—Ç–∏  
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ query –Ω–∞—á–∞–ª–æ–º –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Å–ª–æ–≤–∞ (–Ω–µ –ø–µ—Ä–≤–æ–≥–æ)
          const startsWord = words.slice(1).some(w => w.startsWith(normalizedQuery));
          if (startsWord) {
            relevance = 78; // —á–µ—Ä–∫ ‚Üí –ß–µ—Ä–∫–∏–∑–æ–≤–æ (–Ω–∞—á–∞–ª–æ —Å–ª–æ–≤–∞, –Ω–µ –ø–µ—Ä–≤–æ–≥–æ)
          } else {
            relevance = 60; // –ü—Ä–æ—Å—Ç–æ contains –≤–Ω—É—Ç—Ä–∏ —Å–ª–æ–≤–∞
          }
        }
        break;
      case 'keyboard':   // üÜï –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
        relevance = 82;
        break;
      case 'translit':  // üÜï –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
        relevance = 78; // –ú–µ–∂–¥—É exact –∏ synonym
        break;
      case 'abbreviation': // üÜï –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
        relevance = 75;
        break;
      case 'permutation':  // üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–≤
        relevance = 72;
        break;
      case 'category':     // üÜï –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        relevance = 70;
        break;
      case 'synonym':
        relevance = 68;
        break;
      case 'typo':
        relevance = 45;
        break;
      case 'ngram':        // üÜï N-gram –ø–æ–∏—Å–∫
        relevance = 40;
        break;
      case 'phonetic':
        relevance = 35;
        break;
    }

    // üÜï v2.8.1: –ë–æ–Ω—É—Å—ã ‚Äî –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    // –¶–µ–ª—å: –∏–∑–±—Ä–∞–Ω–Ω—ã–π "–°—ã—Ä —Ç–≤—ë—Ä–¥—ã–π" (95+15=110) –≤—ã—à–µ —á–µ–º "–°—ã—Ä–Ω–∏–∫–∏" (82)
    if (item.isFavorite) relevance += 15; // üÜï –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≤ –¢–û–ü (–±—ã–ª–æ +5, —Ç–µ–ø–µ—Ä—å +15)
    if (item.usageCount) relevance += Math.min(item.usageCount, 8); // —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ (max +8)

    // –ë–æ–Ω—É—Å –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Ç–æ—á–Ω–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
    const lengthRatio = normalizedQuery.length / itemName.length;
    if (lengthRatio > 0.7) relevance += 4;      // –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    else if (lengthRatio > 0.5) relevance += 2; // –°—Ä–µ–¥–Ω–µ–µ

    return Math.max(0, relevance);
  }

  /**
   * üÜï v2.6.0 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ (–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç)
   */
  function detectSearchIntent(query) {
    const normalized = normalizeText(query);
    const activeRules = {
      nutrient: [],
      context: []
    };

    // Check nutrient rules
    Object.entries(NUTRIENT_RULES).forEach(([key, rule]) => {
      if (rule.keywords.some(kw => normalized.includes(normalizeText(kw)))) {
        activeRules.nutrient.push(rule);
      }
    });

    // Check context rules
    Object.entries(CONTEXT_RULES).forEach(([key, rule]) => {
      if (rule.keywords.some(kw => normalized.includes(normalizeText(kw)))) {
        activeRules.context.push(rule);
      }
    });

    return activeRules;
  }

  // === –û–°–ù–û–í–ù–û–ô –ü–û–ò–°–ö ===

  /**
   * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @param {Array} dataSource - –º–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @param {Object} options - –æ–ø—Ü–∏–∏ –ø–æ–∏—Å–∫–∞
   * @returns {Object} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
   */
  function smartSearch(query, dataSource, options = {}) {
    const startTime = performance.now();
    const opts = { ...CONFIG, ...options };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!query || !dataSource || !Array.isArray(dataSource)) {
      return { results: [], suggestions: [], corrections: [], searchTime: 0, query };
    }

    const trimmedQuery = query.trim();
    if (trimmedQuery.length < opts.minQueryLength) {
      return { results: [], suggestions: [], corrections: [], searchTime: 0, query: trimmedQuery };
    }

    // üÜï v2.6.0 Detect Intent
    const intent = detectSearchIntent(trimmedQuery);
    const hasIntent = intent.nutrient.length > 0 || intent.context.length > 0;

    // Calculate core query (remove intent keywords)
    let coreQuery = normalizeText(trimmedQuery);
    if (hasIntent) {
      [...intent.nutrient, ...intent.context].forEach(rule => {
        rule.keywords.forEach(kw => {
          const normKw = normalizeText(kw);
          coreQuery = coreQuery.replace(normKw, '').trim();
        });
      });
    }

    // If core query is empty (e.g. just "high protein"), we search ALL products but filter by intent
    const isPureIntentSearch = hasIntent && coreQuery.length < 2;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
    const cacheKey = `${trimmedQuery}_${dataSource.length}`;
    if (opts.cacheEnabled && searchCache.has(cacheKey)) {
      const cached = searchCache.get(cacheKey);
      if (Date.now() - cached.timestamp < opts.cacheTimeout) {
        return { ...cached.result, fromCache: true };
      }
    }

    const normalizedQuery = isPureIntentSearch ? '' : coreQuery;
    const phoneticQuery = isPureIntentSearch ? '' : phoneticNormalize(coreQuery);
    const queryConstraints = parseNumericConstraints(trimmedQuery); // üÜï v2.5.0
    const results = new Map();
    const corrections = [];
    const suggestions = [];

    // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –æ–¥–∏–Ω —Ä–∞–∑
    const indexedProducts = getIndexedProducts(dataSource, opts);

    // üÜï –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
    const translitVariants = opts.enableTranslit ? getTranslitVariants(trimmedQuery) : [normalizedQuery];

    // üÜï –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (vjkjrj ‚Üí –º–æ–ª–æ–∫–æ)
    const keyboardFixedQuery = opts.enableKeyboardFix ? convertKeyboardLayout(trimmedQuery) : null;
    // üÜï v2.7.0 –ú–∞—Å—Å–∏–≤ –¥–ª—è visual feedback
    const keyboardVariants = keyboardFixedQuery && keyboardFixedQuery !== trimmedQuery
      ? [keyboardFixedQuery] : [];
    if (keyboardFixedQuery) {
      translitVariants.push(keyboardFixedQuery);
    }

    // üÜï –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è (–±/–∂ ‚Üí –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π)
    const abbreviationExpansions = opts.enableAbbreviations ? expandAbbreviations(trimmedQuery) : [];

    // üÜï –í—ã–±–∏—Ä–∞–µ–º ¬´–ª—É—á—à–∏–µ¬ª —Ç–æ–∫–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞: —É—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–∫—Å —Ä–∞—Å–∫–ª–∞–¥–∫–∏ –∏ —Ä–∞—Å–∫—Ä—ã—Ç—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
    const tokenCandidates = [trimmedQuery];
    if (keyboardFixedQuery) tokenCandidates.push(keyboardFixedQuery);
    if (abbreviationExpansions && abbreviationExpansions.length) {
      abbreviationExpansions.forEach(x => tokenCandidates.push(x));
    }
    let queryTokens = [];
    let bestTokenScore = -1;
    for (const candidate of tokenCandidates) {
      const t = tokenize(candidate);
      const score = t.length * 10 + t.reduce((sum, w) => sum + Math.min(w.length, 10), 0);
      if (score > bestTokenScore) {
        bestTokenScore = score;
        queryTokens = t;
      }
    }

    // üÜï –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
    const wordPermutations = opts.enableWordPermutations ? generateWordPermutations(trimmedQuery) : [];

    // === üÜï v2.6.0 PURE INTENT SEARCH ===
    if (isPureIntentSearch) {
      indexedProducts.forEach(entry => {
        const item = entry.item;
        let matchesIntent = true;
        let intentScore = 0;

        // Check nutrient rules
        for (const rule of intent.nutrient) {
          if (rule.check && !rule.check(item)) {
            matchesIntent = false;
            break;
          }
          intentScore += 20;
        }

        if (matchesIntent) {
          // Check context rules
          for (const rule of intent.context) {
            if (rule.check && !rule.check(item)) {
              matchesIntent = false;
              break;
            }

            let isBoosted = false;
            const nameNorm = entry.nameNorm;

            // Check boosted products
            if (rule.boostProducts && rule.boostProducts.some(bp => nameNorm.includes(normalizeText(bp)))) {
              isBoosted = true;
            }

            // Check boosted categories
            if (!isBoosted && rule.boostCategories) {
              rule.boostCategories.forEach(cat => {
                const catKeywords = CATEGORY_KEYWORDS[cat.toLowerCase()];
                if (catKeywords && catKeywords.some(kw => nameNorm.includes(normalizeText(kw)))) {
                  isBoosted = true;
                }
              });
            }

            if (isBoosted) {
              intentScore += 30;
            } else if (rule.boostCategories || rule.boostProducts) {
              // If rule has boost lists and item doesn't match, it's not a context match
              matchesIntent = false;
            }
          }
        }

        if (matchesIntent) {
          const key = item.id || item.name;
          results.set(key, { ...item, relevance: 50 + intentScore, matchType: 'intent' });
        }
      });

      const sorted = Array.from(results.values())
        .sort((a, b) => b.relevance - a.relevance)
        .slice(0, opts.maxResults);

      return {
        results: sorted,
        suggestions: [],
        corrections: [],
        searchTime: performance.now() - startTime,
        query: trimmedQuery
      };
    }

    // === 0. üÜï –ü–û–ò–°–ö –ü–û –ö–ê–¢–ï–ì–û–†–ò–ò ===
    const categoryResults = findCategoryProducts(trimmedQuery, dataSource);
    categoryResults.forEach(item => {
      const relevance = 80;
      const key = item.id || item.name;
      results.set(key, { ...item, relevance, matchType: 'category' });
    });

    // === 1. –¢–û–ß–ù–´–ô –ü–û–ò–°–ö (+ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è + keyboard fix) ===
    indexedProducts.forEach(entry => {
      const item = entry.item;
      const itemName = entry.nameNorm;

      // üÜï v2.5.0 Numeric-aware —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏
      const numericScore = checkNumericMatch(queryConstraints, entry.numbers);
      if (numericScore < 0.6) return; // –°–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ–µ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ

      // üÜï v2.6.0 Intent Check (Mixed Search)
      let intentBoost = 0;
      if (hasIntent) {
        let matchesIntent = true;
        for (const rule of intent.nutrient) {
          if (rule.check && !rule.check(item)) {
            matchesIntent = false;
            break;
          }
        }
        if (!matchesIntent) return; // Skip

        for (const rule of intent.context) {
          if (rule.check && !rule.check(item)) return;

          let isBoosted = false;
          if (rule.boostProducts && rule.boostProducts.some(bp => itemName.includes(normalizeText(bp)))) isBoosted = true;
          if (!isBoosted && rule.boostCategories) {
            rule.boostCategories.forEach(cat => {
              const catKeywords = CATEGORY_KEYWORDS[cat.toLowerCase()];
              if (catKeywords && catKeywords.some(kw => itemName.includes(normalizeText(kw)))) isBoosted = true;
            });
          }
          if (isBoosted) intentBoost += 20;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –≤—Å–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
      for (const variant of translitVariants) {
        if (itemName.includes(variant)) {
          const matchType = variant === normalizedQuery ? 'exact' :
            variant === keyboardFixedQuery ? 'keyboard' : 'translit';
          let relevance = calculateRelevance(item, trimmedQuery, matchType);

          // üÜï v2.5.0 Numeric adjustment
          relevance *= numericScore;

          // üÜï v2.6.0 Intent Boost
          relevance += intentBoost;

          // Token-aware –±–æ–Ω—É—Å
          const tokenScore = computeTokenMatchScore(queryTokens, itemName, entry.tokens);
          relevance += tokenScore.bonus;

          // üÜï –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±—É—Å—Ç
          if (opts.enablePersonalization) {
            relevance += getPersonalBoost(item.id);
          }

          const key = item.id || item.name;
          if (!results.has(key) || results.get(key).relevance < relevance) {
            results.set(key, {
              ...item,
              relevance,
              matchType,
              matchedVariant: variant !== normalizedQuery ? variant : undefined
            });
          }
          break; // –ù–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî –≤—ã—Ö–æ–¥–∏–º
        }
      }
    });

    // === 1.5. üÜï –ü–û–ò–°–ö –ü–û –†–ê–°–ö–†–´–¢–´–ú –°–û–ö–†–ê–©–ï–ù–ò–Ø–ú ===
    if (abbreviationExpansions.length > 0) {
      abbreviationExpansions.forEach(expanded => {
        const normalizedExpanded = normalizeText(expanded);
        indexedProducts.forEach(entry => {
          const item = entry.item;
          const itemName = entry.nameNorm;

          const numericScore = checkNumericMatch(queryConstraints, entry.numbers);
          if (numericScore < 0.6) return;
          if (itemName.includes(normalizedExpanded)) {
            let relevance = calculateRelevance(item, expanded, 'exact') - 5;
            relevance *= numericScore; // üÜï v2.5.0

            const tokenScore = computeTokenMatchScore(queryTokens, itemName, entry.tokens);
            relevance += tokenScore.bonus;
            if (opts.enablePersonalization) {
              relevance += getPersonalBoost(item.id);
            }
            const key = item.id || item.name;
            if (!results.has(key) || results.get(key).relevance < relevance) {
              results.set(key, {
                ...item,
                relevance,
                matchType: 'abbreviation',
                expandedFrom: trimmedQuery,
                expandedTo: expanded
              });
            }
          }
        });
      });
    }

    // === 1.6. üÜï –ü–û–ò–°–ö –ü–û –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê–ú –°–õ–û–í ===
    if (wordPermutations.length > 0) {
      wordPermutations.forEach(permuted => {
        const normalizedPermuted = normalizeText(permuted);
        indexedProducts.forEach(entry => {
          const item = entry.item;
          const itemName = entry.nameNorm;

          const numericScore = checkNumericMatch(queryConstraints, entry.numbers);
          if (numericScore < 0.6) return;
          if (itemName.includes(normalizedPermuted)) {
            let relevance = calculateRelevance(item, permuted, 'exact') - 3;
            relevance *= numericScore; // üÜï v2.5.0

            const tokenScore = computeTokenMatchScore(queryTokens, itemName, entry.tokens);
            relevance += tokenScore.bonus;
            if (opts.enablePersonalization) {
              relevance += getPersonalBoost(item.id);
            }
            const key = item.id || item.name;
            if (!results.has(key) || results.get(key).relevance < relevance) {
              results.set(key, {
                ...item,
                relevance,
                matchType: 'permutation',
                permutedQuery: permuted
              });
            }
          }
        });
      });
    }

    // === 1.7. üÜï TOKEN-AWARE AND-SEARCH (—Å–ª–æ–≤–∞ –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ, –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ä—è–¥) ===
    // –ü—Ä–∏–º–µ—Ä: "–≥—Ä–µ—á–∫–∞ 800" –º–∞—Ç—á–∏—Ç—Å—è —Å "–≥—Ä–µ—á–∫–∞ —è–¥—Ä–∏—Ü–∞ 800–≥"
    if (queryTokens.length > 0 && results.size < 5) {
      indexedProducts.forEach(entry => {
        const item = entry.item;

        if (checkNumericMatch(queryConstraints, entry.numbers) < 0.6) return;

        const tokenScore = computeTokenMatchScore(queryTokens, entry.nameNorm, entry.tokens);
        // –î–ª—è 1 —Ç–æ–∫–µ–Ω–∞ —Ç—Ä–µ–±—É–µ–º –≤—ã—Å–æ–∫–∏–π —Å–∏–≥–Ω–∞–ª; –¥–ª—è 2+ –¥–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ø–æ–∫—Ä—ã—Ç–∏—è.
        const threshold = queryTokens.length >= 2 ? 0.5 : 1;
        if (tokenScore.coverage < threshold) return;

        let relevance = 55 + Math.round(tokenScore.coverage * 25) + tokenScore.bonus;
        if (opts.enablePersonalization) {
          relevance += getPersonalBoost(item.id);
        }

        const key = item.id || item.name;
        if (!results.has(key) || results.get(key).relevance < relevance) {
          results.set(key, {
            ...item,
            relevance,
            matchType: 'tokens'
          });
        }
      });
    }

    // === 2. –ü–û–ò–°–ö –ü–û –°–ò–ù–û–ù–ò–ú–ê–ú ===
    if (opts.enableSynonyms) {
      const synonymList = findSynonyms(trimmedQuery);
      synonymList.forEach(synonym => {
        const normalizedSynonym = normalizeText(synonym);
        indexedProducts.forEach(entry => {
          const item = entry.item;
          const itemName = entry.nameNorm;

          if (checkNumericMatch(queryConstraints, entry.numbers) < 0.6) return;
          if (itemName.includes(normalizedSynonym)) {
            const relevance = calculateRelevance(item, synonym, 'synonym');
            const key = item.id || item.name;
            if (!results.has(key) || results.get(key).relevance < relevance) {
              results.set(key, { ...item, relevance, matchType: 'synonym', matchedSynonym: synonym });
            }
          }
        });
      });
    }

    // === 2.5. üÜï v2.7.0 –ü–û–ò–°–ö –ü–û –ë–†–ï–ù–î–ê–ú ===
    // –ò—â–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞ (Danone = –î–∞–Ω–æ–Ω = –î—ç–Ω–æ–Ω)
    let matchedBrand = null;
    if (opts.enableBrands !== false) {
      const brandVariants = findBrandVariants(trimmedQuery);
      if (brandVariants.length > 0) {
        matchedBrand = brandVariants[0]; // –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        brandVariants.forEach(variant => {
          const normalizedVariant = normalizeText(variant);
          indexedProducts.forEach(entry => {
            const item = entry.item;
            const itemName = entry.nameNorm;

            if (itemName.includes(normalizedVariant)) {
              let relevance = calculateRelevance(item, variant, 'exact') + 5; // –ë—Ä–µ–Ω–¥-–±–æ–Ω—É—Å
              if (opts.enablePersonalization) {
                relevance += getPersonalBoost(item.id);
              }
              const key = item.id || item.name;
              if (!results.has(key) || results.get(key).relevance < relevance) {
                results.set(key, {
                  ...item,
                  relevance,
                  matchType: 'brand',
                  matchedBrand: matchedBrand
                });
              }
            }
          });
        });
      }
    }

    // === 3. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–ü–ï–ß–ê–¢–û–ö (–µ—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤) ===
    if (opts.enableTypoCorrection && results.size < 3) {
      // üÜï v2.6.0: Check translit variants for typos too (e.g. "mloko" -> "–º–ª–æ–∫–æ" -> "–º–æ–ª–æ–∫–æ")
      const candidates = new Set([trimmedQuery]);
      if (opts.enableTranslit) {
        translitVariants.forEach(v => candidates.add(v));
      }

      candidates.forEach(candidate => {
        const typoCorrections = findTypoCorrections(candidate, dataSource);

        typoCorrections.slice(0, 3).forEach(correction => {
          // Avoid duplicates in corrections list
          if (!corrections.some(c => c.corrected === correction.corrected)) {
            corrections.push(correction);
          }

          const normalizedCorrected = normalizeText(correction.corrected);

          indexedProducts.forEach(entry => {
            const item = entry.item;
            const itemName = entry.nameNorm;

            if (checkNumericMatch(queryConstraints, entry.numbers) < 0.6) return;
            if (itemName.includes(normalizedCorrected)) {
              const baseRelevance = calculateRelevance(item, correction.corrected, 'typo');
              const relevance = baseRelevance * correction.confidence;
              const key = item.id || item.name;
              if (!results.has(key) || results.get(key).relevance < relevance) {
                results.set(key, {
                  ...item,
                  relevance,
                  matchType: 'typo',
                  originalQuery: trimmedQuery,
                  correctedQuery: correction.corrected,
                  confidence: correction.confidence
                });
              }
            }
          });
        });
      });
    }

    // === 4. –§–û–ù–ï–¢–ò–ß–ï–°–ö–ò–ô –ü–û–ò–°–ö (–µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –º–∞–ª–æ) ===
    if (opts.enablePhonetic && results.size < 3 && phoneticQuery !== normalizedQuery) {
      indexedProducts.forEach(entry => {
        const item = entry.item;
        const itemPhonetic = entry.namePhon;

        if (!numbersMatchAll(queryConstraints, entry.numbers)) return;
        if (itemPhonetic.includes(phoneticQuery)) {
          let relevance = calculateRelevance(item, trimmedQuery, 'phonetic');

          const tokenScore = computeTokenMatchScore(queryTokens, entry.nameNorm, entry.tokens);
          relevance += tokenScore.bonus;
          if (opts.enablePersonalization) {
            relevance += getPersonalBoost(item.id);
          }
          const key = item.id || item.name;
          if (!results.has(key) || results.get(key).relevance < relevance) {
            results.set(key, { ...item, relevance, matchType: 'phonetic' });
          }
        }
      });
    }

    // === 5. üÜï N-GRAM –ü–û–ò–°–ö (–≥–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç—è–º —Å–ª–æ–≤) ===
    if (opts.enableNgram && results.size < 5 && normalizedQuery.length >= 4) {
      const ngramResults = ngramSearch(trimmedQuery, dataSource);
      ngramResults.forEach(item => {
        let relevance = 30 + (5 - (item.ngramDistance || 0)) * 5;
        if (opts.enablePersonalization) {
          relevance += getPersonalBoost(item.id);
        }
        const key = item.id || item.name;
        if (!results.has(key)) {
          results.set(key, { ...item, relevance, matchType: 'ngram' });
        }
      });
    }

    // === 6. üÜï v2.7.0 –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–ò–ô –ü–û–ò–°–ö (ML-lite –∫–ª–∞—Å—Ç–µ—Ä—ã) ===
    // –ï—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏—â–µ–º –ø–æ —Å–º—ã—Å–ª–æ–≤—ã–º –∫–ª–∞—Å—Ç–µ—Ä–∞–º
    if (opts.enableSemantic !== false && results.size < 3) {
      const semanticResults = findSemanticMatches(trimmedQuery, dataSource, 10);
      semanticResults.forEach(item => {
        let relevance = 25; // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —ç—Ç–æ "–ø–æ—Ö–æ–∂–∏–µ" —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if (opts.enablePersonalization) {
          relevance += getPersonalBoost(item.id);
        }
        const key = item.id || item.name;
        if (!results.has(key)) {
          results.set(key, {
            ...item,
            relevance,
            matchType: 'semantic',
            semanticCluster: item.semanticCluster
          });
        }
      });
    }

    // === 7. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô ===
    if (normalizedQuery.length >= 2) {
      const suggestionSet = new Set();

      // –ò–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤
      commonWords.forEach(word => {
        if (word.startsWith(normalizedQuery) && word !== normalizedQuery) {
          suggestionSet.add(word);
        }
      });

      // –ò–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      Array.from(results.values()).slice(0, 10).forEach(result => {
        const words = normalizeText(result.name).split(/\s+/);
        words.forEach(word => {
          if (word.length > 2 && word.startsWith(normalizedQuery) && word !== normalizedQuery) {
            suggestionSet.add(word);
          }
        });
      });

      suggestions.push(...Array.from(suggestionSet).slice(0, opts.maxSuggestions));
    }

    // === üÜï v2.8.2 USAGE STATS BOOST (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑ opts.usageStats) ===
    if (opts.usageStats instanceof Map && opts.usageStats.size > 0) {
      const windowDays = Number(opts.usageWindowDays) || 21;
      const nowMs = Date.now();
      results.forEach((entry) => {
        const pid = String(entry.id || entry.product_id || '');
        const nameRaw = String(entry.name || '');
        const nameNorm = normalizeText(nameRaw);
        const stats = (pid && opts.usageStats.get(pid))
          || opts.usageStats.get(nameNorm)
          || opts.usageStats.get(nameRaw);
        if (stats && stats.count > 0 && stats.lastUsed) {
          const daysAgo = Math.floor((nowMs - stats.lastUsed) / (1000 * 60 * 60 * 24));
          if (daysAgo <= windowDays) {
            entry.relevance = (entry.relevance || 0) + Math.min(stats.count, 8);
          }
        }
      });
    }

    // === üÜï v2.8.2 FAVORITES BOOST (–∏–∑ opts.favorites ‚Äî Set product ids) ===
    if (opts.favorites instanceof Set && opts.favorites.size > 0) {
      results.forEach((entry) => {
        const pid = String(entry.id || entry.product_id || '');
        if (pid && opts.favorites.has(pid)) {
          entry.relevance = (entry.relevance || 0) + 15; // –∏–¥–µ–Ω—Ç–∏—á–Ω–æ calculateRelevance isFavorite bonus
        }
      });
    }

    // === –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê ===
    const finalResults = Array.from(results.values())
      .sort((a, b) => b.relevance - a.relevance)
      .slice(0, opts.maxResults || opts.limit || 50);

    const searchTime = performance.now() - startTime;

    // === üÜï v2.7.0 VISUAL FEEDBACK ‚Äî —á—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ/—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ===
    const visualFeedback = {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ–ø–µ—á–∞—Ç–∫–∏
      correctedFrom: corrections.length > 0 ? trimmedQuery : null,
      correctedTo: corrections.length > 0 ? corrections[0].corrected : null,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª —Ç—Ä–∞–Ω—Å–ª–∏—Ç (–ª–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
      transliteratedFrom: finalResults.some(r => r.matchType === 'translit') ? trimmedQuery : null,
      transliteratedTo: finalResults.some(r => r.matchType === 'translit') && translitVariants.length > 0
        ? translitVariants[0] : null,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∞
      keyboardFixed: finalResults.some(r => r.matchType === 'keyboard'),
      keyboardFrom: finalResults.some(r => r.matchType === 'keyboard') ? trimmedQuery : null,
      keyboardTo: finalResults.some(r => r.matchType === 'keyboard') && keyboardVariants.length > 0
        ? keyboardVariants[0] : null,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –±—Ä–µ–Ω–¥
      matchedBrand: matchedBrand,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –µ—Å–ª–∏ –∏—Å–∫–∞–ª–∏ –ø–æ –Ω–µ–π
      matchedCategory: finalResults.some(r => r.matchType === 'category')
        ? finalResults.find(r => r.matchType === 'category')?.matchedCategory : null,
      // Semantic cluster
      semanticCluster: finalResults.some(r => r.matchType === 'semantic')
        ? finalResults.find(r => r.matchType === 'semantic')?.semanticCluster : null
    };

    // === üÜï v2.7.0 SMART SUGGESTIONS ‚Äî –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç ===
    let smartSuggestions = null;
    if (finalResults.length === 0) {
      smartSuggestions = generateSmartSuggestions(trimmedQuery, dataSource);
    }

    const result = {
      results: finalResults,
      suggestions,
      corrections,
      searchTime: Math.round(searchTime * 100) / 100,
      query: trimmedQuery,
      totalFound: finalResults.length,
      hasTypoCorrections: corrections.length > 0,
      hasSynonyms: finalResults.some(r => r.matchType === 'synonym'),
      hasTranslit: finalResults.some(r => r.matchType === 'translit'), // üÜï
      hasKeyboardFix: finalResults.some(r => r.matchType === 'keyboard'), // üÜï
      hasAbbreviation: finalResults.some(r => r.matchType === 'abbreviation'), // üÜï
      hasPermutation: finalResults.some(r => r.matchType === 'permutation'), // üÜï
      hasCategory: finalResults.some(r => r.matchType === 'category'), // üÜï
      hasBrand: finalResults.some(r => r.matchType === 'brand'), // üÜï v2.7.0
      hasSemantic: finalResults.some(r => r.matchType === 'semantic'), // üÜï v2.7.0
      // üÜï v2.7.0 Visual Feedback
      visualFeedback,
      // üÜï v2.7.0 Smart Suggestions (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
      smartSuggestions,
      searchStats: {
        exactMatches: finalResults.filter(r => r.matchType === 'exact').length,
        translitMatches: finalResults.filter(r => r.matchType === 'translit').length, // üÜï
        keyboardMatches: finalResults.filter(r => r.matchType === 'keyboard').length, // üÜï
        abbreviationMatches: finalResults.filter(r => r.matchType === 'abbreviation').length, // üÜï
        permutationMatches: finalResults.filter(r => r.matchType === 'permutation').length, // üÜï
        categoryMatches: finalResults.filter(r => r.matchType === 'category').length, // üÜï
        ngramMatches: finalResults.filter(r => r.matchType === 'ngram').length, // üÜï
        brandMatches: finalResults.filter(r => r.matchType === 'brand').length, // üÜï v2.7.0
        semanticMatches: finalResults.filter(r => r.matchType === 'semantic').length, // üÜï v2.7.0
        typoMatches: finalResults.filter(r => r.matchType === 'typo').length,
        synonymMatches: finalResults.filter(r => r.matchType === 'synonym').length,
        phoneticMatches: finalResults.filter(r => r.matchType === 'phonetic').length
      }
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
    if (opts.cacheEnabled) {
      searchCache.set(cacheKey, { result, timestamp: Date.now() });

      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
      if (searchCache.size > 200) {
        const oldestKey = searchCache.keys().next().value;
        searchCache.delete(oldestKey);
      }
    }

    // –û—Ç–ª–∞–¥–∫–∞
    if (opts.debugMode) {
      console.group(`üîç SmartSearch: "${trimmedQuery}"`);
      console.log('‚è±Ô∏è –í—Ä–µ–º—è:', searchTime.toFixed(2), '–º—Å');
      console.log('üìä –ù–∞–π–¥–µ–Ω–æ:', finalResults.length);
      console.log('üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:', suggestions);
      console.log('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', corrections);
      console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', result.searchStats);
      console.groupEnd();
    }

    return result;
  }

  /**
   * –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
   */
  function suggest(partialQuery, dataSource, maxSuggestions = 5) {
    if (!partialQuery || partialQuery.length < 2) return [];

    const normalized = normalizeText(partialQuery);
    const suggestions = new Set();

    // –ò–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤
    commonWords.forEach(word => {
      if (word.startsWith(normalized)) {
        suggestions.add(word);
      }
    });

    // –ò–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (dataSource && Array.isArray(dataSource)) {
      dataSource.forEach(item => {
        const name = normalizeText(item.name || '');
        if (name.startsWith(normalized)) {
          suggestions.add(item.name);
        }
        // –°–ª–æ–≤–∞ –≤–Ω—É—Ç—Ä–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
        name.split(/\s+/).forEach(word => {
          if (word.length > 2 && word.startsWith(normalized)) {
            suggestions.add(word);
          }
        });
      });
    }

    return Array.from(suggestions).slice(0, maxSuggestions);
  }

  /**
   * "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∏ –ø—Ä–∏—á–∏–Ω–æ–π
   */
  function getDidYouMean(query, dataSource, maxSuggestions = 3) {
    if (!query || query.length < 2) return [];

    const normalized = normalizeText(query);
    const suggestions = [];
    const seen = new Set();

    // üÜï 0. –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ
    if (CONFIG.enableTranslit) {
      const canonical = getCanonicalForm(query);
      if (canonical && !seen.has(canonical)) {
        suggestions.push({
          text: canonical,
          reason: 'translit',
          label: 'üåê —Ç—Ä–∞–Ω—Å–ª–∏—Ç'
        });
        seen.add(canonical);
      }

      // –¢–∞–∫–∂–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
      const transliterated = transliterate(query);
      if (transliterated !== normalized && !seen.has(transliterated)) {
        suggestions.push({
          text: transliterated,
          reason: 'translit',
          label: 'üåê —Ç—Ä–∞–Ω—Å–ª–∏—Ç'
        });
        seen.add(transliterated);
      }
    }

    // 1. –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å = —Å–∏–Ω–æ–Ω–∏–º, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–ª–æ–≤–æ)
    for (const [mainWord, syns] of Object.entries(synonyms)) {
      if (syns.some(s => normalizeText(s) === normalized || s.includes(normalized))) {
        if (!seen.has(mainWord)) {
          suggestions.push({
            text: mainWord,
            reason: 'synonym',
            label: '‚âà —Å–∏–Ω–æ–Ω–∏–º'
          });
          seen.add(mainWord);
        }
      }
    }

    // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫ ‚Äî –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ –∏–∑ dataSource
    if (dataSource && Array.isArray(dataSource)) {
      const maxDist = CONFIG.getMaxTypoDistance(normalized.length);
      const candidates = [];

      dataSource.forEach(item => {
        const name = normalizeText(item.name || '');
        const words = name.split(/\s+/);

        words.forEach(word => {
          if (word.length < 2 || seen.has(word)) return;

          const dist = levenshteinDistance(normalized, word, maxDist + 1);
          if (dist > 0 && dist <= maxDist) {
            candidates.push({
              text: word,
              distance: dist,
              reason: 'typo',
              label: 'üîß –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'
            });
            seen.add(word);
          }
        });
      });

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –∏ –±–µ—Ä—ë–º –ª—É—á—à–∏–µ
      candidates.sort((a, b) => a.distance - b.distance);
      suggestions.push(...candidates.slice(0, maxSuggestions - suggestions.length));
    }

    // 3. –ü–æ—Ö–æ–∂–∏–µ –ø–æ –Ω–∞—á–∞–ª—É —Å–ª–æ–≤–∞ (–∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
    if (suggestions.length < maxSuggestions && dataSource) {
      const completions = [];

      dataSource.forEach(item => {
        const name = item.name || '';
        const normalizedName = normalizeText(name);

        if (normalizedName.startsWith(normalized) && !seen.has(normalizedName)) {
          completions.push({
            text: name,
            reason: 'completion',
            label: '‚Üí –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ'
          });
          seen.add(normalizedName);
        }
      });

      suggestions.push(...completions.slice(0, maxSuggestions - suggestions.length));
    }

    return suggestions.slice(0, maxSuggestions);
  }

  /**
   * –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç–µ
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —á–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞ —Å —Ñ–ª–∞–≥–æ–º isMatch
   * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @returns {Array<{text: string, isMatch: boolean}>}
   */
  function highlightMatches(text, query) {
    if (!text || !query) {
      return [{ text: text || '', isMatch: false }];
    }

    const normalizedText = normalizeText(text);
    const normalizedQuery = normalizeText(query);
    const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length >= 2);

    if (queryWords.length === 0) {
      return [{ text, isMatch: false }];
    }

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    const matches = [];

    // üÜï –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ (–≤–∫–ª—é—á–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é)
    const allVariants = new Set();
    queryWords.forEach(queryWord => {
      allVariants.add(queryWord);

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã
      const synonymList = findSynonyms(queryWord);
      synonymList.forEach(syn => allVariants.add(syn));

      // üÜï –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
      if (CONFIG.enableTranslit) {
        const translitVariants = getTranslitVariants(queryWord);
        translitVariants.forEach(v => allVariants.add(v));
      }
    });

    // –ò—â–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ
    allVariants.forEach(variant => {
      let searchIndex = 0;
      while (true) {
        const pos = normalizedText.indexOf(variant, searchIndex);
        if (pos === -1) break;

        matches.push({
          start: pos,
          end: pos + variant.length
        });
        searchIndex = pos + 1;
      }
    });

    if (matches.length === 0) {
      return [{ text, isMatch: false }];
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
    matches.sort((a, b) => a.start - b.start);
    const merged = [matches[0]];

    for (let i = 1; i < matches.length; i++) {
      const last = merged[merged.length - 1];
      const current = matches[i];

      if (current.start <= last.end) {
        last.end = Math.max(last.end, current.end);
      } else {
        merged.push(current);
      }
    }

    // –°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ —á–∞—Å—Ç–µ–π
    // –í–∞–∂–Ω–æ: –ø–æ–∑–∏—Ü–∏–∏ –≤ normalizedText –º–æ–≥—É—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å text –∏–∑-–∑–∞ —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã —Å–∏–º–≤–æ–ª–æ–≤
    // –ü–æ—ç—Ç–æ–º—É —Ä–∞–±–æ—Ç–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ lowercase
    const lowerText = text.toLowerCase().replace(/—ë/g, '–µ');
    const parts = [];
    let lastEnd = 0;

    merged.forEach(match => {
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
      if (match.start > lastEnd) {
        parts.push({
          text: text.substring(lastEnd, match.start),
          isMatch: false
        });
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä –∏–∑ text)
      parts.push({
        text: text.substring(match.start, match.end),
        isMatch: true
      });

      lastEnd = match.end;
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Ç–µ–∫—Å—Ç–∞
    if (lastEnd < text.length) {
      parts.push({
        text: text.substring(lastEnd),
        isMatch: false
      });
    }

    return parts;
  }

  /**
   * –†–µ–Ω–¥–µ—Ä –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (React —ç–ª–µ–º–µ–Ω—Ç—ã)
   * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å  
   * @param {Object} React - React –æ–±—ä–µ–∫—Ç
   * @returns {Array} –º–∞—Å—Å–∏–≤ React —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   */
  function renderHighlightedText(text, query, React) {
    if (!React) {
      console.warn('renderHighlightedText: React –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω');
      return text;
    }

    const parts = highlightMatches(text, query);

    return parts.map((part, i) => {
      if (part.isMatch) {
        return React.createElement('mark', {
          key: i,
          className: 'search-highlight',
          style: {
            backgroundColor: 'rgba(255, 213, 0, 0.35)', // –ü—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π –∂—ë–ª—Ç—ã–π
            borderRadius: '2px',
            padding: '0 1px'
          }
        }, part.text);
      }
      return part.text;
    });
  }

  /**
   * –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
   */
  function clearCache() {
    searchCache.clear();
    productIndex = null;
    lastProductsHash = null;
    if (CONFIG.debugMode) console.log('üßπ SmartSearch: –∫–µ—à –æ—á–∏—â–µ–Ω');
  }

  /**
   * –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞
   */
  function getStats() {
    return {
      cacheSize: searchCache.size,
      commonWordsCount: commonWords.size,
      synonymsCount: Object.keys(synonyms).length,
      phoneticRulesCount: phoneticRules.length,
      translitPairsCount: Object.keys(TRANSLIT_PAIRS).length,
      spellingVariantsCount: Object.keys(SPELLING_VARIANTS).length,
      abbreviationsCount: Object.keys(ABBREVIATIONS).length,
      categoriesCount: Object.keys(CATEGORY_KEYWORDS).length,
      userStatsCount: userProductStats.size,
      config: { ...CONFIG }
    };
  }

  // === API ===
  const SmartSearchWithTypos = {
    // –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–∏—Å–∫
    search: smartSearch,

    // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    suggest,

    // "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    getDidYouMean,

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    highlightMatches,

    // –†–µ–Ω–¥–µ—Ä –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (React)
    renderHighlightedText,

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
    correctTypos: findTypoCorrections,

    // –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
    findSynonyms,

    // üÜï –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    transliterate,

    // üÜï –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ (–≤–∫–ª. —Ç—Ä–∞–Ω—Å–ª–∏—Ç)
    getTranslitVariants,

    // üÜï –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞
    detectLanguage,

    // üÜï –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ —Å–ª–æ–≤–∞
    getCanonicalForm,

    // üÜï –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞—Å–∫–ª–∞–¥–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    convertKeyboardLayout,

    // üÜï –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π  
    expandAbbreviations,

    // üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
    generateWordPermutations,

    // üÜï N-gram –ø–æ–∏—Å–∫
    ngramSearch,

    // üÜï –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    findCategoryProducts,

    // üÜï v2.7.0 –ü–æ–∏—Å–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±—Ä–µ–Ω–¥–∞
    findBrandVariants,

    // üÜï v2.7.0 –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (ML-lite)
    findSemanticMatches,

    // üÜï v2.7.0 –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    generateSmartSuggestions,

    // üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —Ç—Ä–µ–∫–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
    trackProductUsage,

    // üÜï –î–æ—Å—Ç—É–ø –∫ usage stats
    getUsageStats,
    syncUsageStatsFromDays,
    ensureUsageStatsFresh,

    // üÜï –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    saveUserStats,

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞
    configure(newConfig) {
      Object.assign(CONFIG, newConfig);
    },

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
    addSynonyms(word, synonymList) {
      const key = normalizeText(word);
      if (!synonyms[key]) synonyms[key] = [];
      synonymList.forEach(s => {
        const normalized = normalizeText(s);
        if (!synonyms[key].includes(normalized)) {
          synonyms[key].push(normalized);
        }
      });
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
    addTranslitPairs(pairs) {
      Object.entries(pairs).forEach(([key, value]) => {
        const normalizedKey = normalizeText(key);
        const normalizedValue = normalizeText(value);
        TRANSLIT_PAIRS[normalizedKey] = normalizedValue;
        TRANSLIT_PAIRS[normalizedValue] = normalizedKey;
      });
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    addSpellingVariants(canonical, variants) {
      const normalizedCanonical = normalizeText(canonical);
      if (!SPELLING_VARIANTS[normalizedCanonical]) {
        SPELLING_VARIANTS[normalizedCanonical] = [];
      }
      variants.forEach(v => {
        const normalized = normalizeText(v);
        if (!SPELLING_VARIANTS[normalizedCanonical].includes(normalized)) {
          SPELLING_VARIANTS[normalizedCanonical].push(normalized);
        }
      });
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
    addAbbreviations(abbr, meanings) {
      const key = normalizeText(abbr);
      ABBREVIATIONS[key] = meanings.map(m => normalizeText(m));
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    addCategoryKeywords(category, keywords) {
      CATEGORY_KEYWORDS[category] = keywords;
    },

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤
    addCommonWords(words) {
      words.forEach(word => commonWords.add(normalizeText(word)));
    },

    // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
    clearCache,

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    getStats,

    // –£—Ç–∏–ª–∏—Ç—ã (–¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
    utils: {
      normalizeText,
      phoneticNormalize,
      levenshteinDistance,
      calculateRelevance,
      highlightMatches,
      renderHighlightedText,
      transliterate,
      getTranslitVariants,
      detectLanguage,
      getCanonicalForm,
      convertKeyboardLayout,
      expandAbbreviations,
      generateWordPermutations,
      getPersonalBoost,
      // üÜï v2.7.0
      findBrandVariants,
      findSemanticMatches,
      generateSmartSuggestions
    },

    // üÜï v2.7.0 –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è UI
    BRAND_DICTIONARY,
    SEMANTIC_CLUSTERS,
    SMART_SUGGESTIONS_CONFIG
  };

  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.SmartSearchWithTypos = SmartSearchWithTypos;
  HEYS.SmartSearch = SmartSearchWithTypos; // alias

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : globalThis);


/* ===== heys_shared_products_export_fields_v1.js ===== */
// heys_shared_products_export_fields_v1.js ‚Äî shared products export field descriptions
(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.SharedProductsExportFields = HEYS.SharedProductsExportFields || {};

    const FIELD_DESCRIPTIONS = {
        id: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞ (UUID)',
        name: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞',
        simple100: '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (—Å–∞—Ö–∞—Ä–∞) –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã',
        complex100: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã',
        protein100: '–ë–µ–ª–æ–∫ –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã',
        badFat100: '–ù–∞—Å—ã—â–µ–Ω–Ω—ã–µ (–≤—Ä–µ–¥–Ω—ã–µ) –∂–∏—Ä—ã –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã',
        goodFat100: '–ù–µ–Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ (–ø–æ–ª–µ–∑–Ω—ã–µ) –∂–∏—Ä—ã –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã',
        trans100: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã (—Å–∞–º—ã–µ –≤—Ä–µ–¥–Ω—ã–µ)',
        fiber100: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –Ω–∞ 100–≥, –≥—Ä–∞–º–º—ã',
        gi: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å (0-100). –ù–∏–∑–∫–∏–π <55, —Å—Ä–µ–¥–Ω–∏–π 55-70, –≤—ã—Å–æ–∫–∏–π >70',
        harm: '–ò–Ω–¥–µ–∫—Å –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ (0-10). 0=—Å—É–ø–µ—Ä–ø–æ–ª–µ–∑–Ω—ã–π, 10=—Å—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–π. –§–æ—Ä–º—É–ª–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã, —Å–∞—Ö–∞—Ä, –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã vs –∫–ª–µ—Ç—á–∞—Ç–∫—É, –±–µ–ª–æ–∫',
        category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ (–º–æ–ª–æ—á–Ω—ã–µ, –º—è—Å–æ, –æ–≤–æ—â–∏ –∏ —Ç.–¥.)',
        portions: '–ü–æ—Ä—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON [{name: "1 —à—Ç", grams: 50}]',
        sodium100: '–ù–∞—Ç—Ä–∏–π (—Å–æ–ª—å) –Ω–∞ 100–≥, –º–∏–ª–ª–∏–≥—Ä–∞–º–º—ã. –ù–æ—Ä–º–∞ <2000–º–≥/–¥–µ–Ω—å. –ò–∑–±—ã—Ç–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—é',
        nova_group: 'NOVA –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ (1-4). 1=–Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π, 2=–∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç, 3=–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, 4=—É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π (–≤—Ä–µ–¥–Ω–æ!)',
        vitamin_a: '–í–∏—Ç–∞–º–∏–Ω A, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ó—Ä–µ–Ω–∏–µ, –∏–º–º—É–Ω–∏—Ç–µ—Ç',
        vitamin_c: '–í–∏—Ç–∞–º–∏–Ω C, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ò–º–º—É–Ω–∏—Ç–µ—Ç, –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç',
        vitamin_d: '–í–∏—Ç–∞–º–∏–Ω D, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ö–æ—Å—Ç–∏, –∏–º–º—É–Ω–∏—Ç–µ—Ç',
        vitamin_e: '–í–∏—Ç–∞–º–∏–Ω E, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç',
        vitamin_k: '–í–∏—Ç–∞–º–∏–Ω K, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –°–≤—ë—Ä—Ç—ã–≤–∞–µ–º–æ—Å—Ç—å –∫—Ä–æ–≤–∏',
        vitamin_b1: '–í–∏—Ç–∞–º–∏–Ω B1 (—Ç–∏–∞–º–∏–Ω), % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
        vitamin_b2: '–í–∏—Ç–∞–º–∏–Ω B2 (—Ä–∏–±–æ—Ñ–ª–∞–≤–∏–Ω), % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ú–µ—Ç–∞–±–æ–ª–∏–∑–º',
        vitamin_b3: '–í–∏—Ç–∞–º–∏–Ω B3 (–Ω–∏–∞—Ü–∏–Ω), % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –≠–Ω–µ—Ä–≥–∏—è, –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞',
        vitamin_b6: '–í–∏—Ç–∞–º–∏–Ω B6 (–ø–∏—Ä–∏–¥–æ–∫—Å–∏–Ω), % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ë–µ–ª–∫–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
        vitamin_b9: '–í–∏—Ç–∞–º–∏–Ω B9 (—Ñ–æ–ª–∞—Ç), % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ö—Ä–æ–≤–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ, –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å',
        vitamin_b12: '–í–∏—Ç–∞–º–∏–Ω B12 (–∫–æ–±–∞–ª–∞–º–∏–Ω), % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ù–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –∫—Ä–æ–≤—å',
        calcium: '–ö–∞–ª—å—Ü–∏–π, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ö–æ—Å—Ç–∏, –∑—É–±—ã',
        iron: '–ñ–µ–ª–µ–∑–æ, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ö—Ä–æ–≤—å, —ç–Ω–µ—Ä–≥–∏—è',
        magnesium: '–ú–∞–≥–Ω–∏–π, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ú—ã—à—Ü—ã, –Ω–µ—Ä–≤—ã, —Å–æ–Ω',
        phosphorus: '–§–æ—Å—Ñ–æ—Ä, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ö–æ—Å—Ç–∏, —ç–Ω–µ—Ä–≥–∏—è',
        potassium: '–ö–∞–ª–∏–π, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –°–µ—Ä–¥—Ü–µ, –¥–∞–≤–ª–µ–Ω–∏–µ',
        zinc: '–¶–∏–Ω–∫, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ò–º–º—É–Ω–∏—Ç–µ—Ç, –∫–æ–∂–∞',
        selenium: '–°–µ–ª–µ–Ω, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç, —â–∏—Ç–æ–≤–∏–¥–∫–∞',
        iodine: '–ô–æ–¥, % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã. –©–∏—Ç–æ–≤–∏–¥–Ω–∞—è –∂–µ–ª–µ–∑–∞',
        is_organic: '–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–¥—É–∫—Ç (true/false). –ë–µ–∑ –ø–µ—Å—Ç–∏—Ü–∏–¥–æ–≤ –∏ –ì–ú–û',
        is_whole_grain: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π (true/false). –ò–∑ —Ü–µ–ª—å–Ω–æ–≥–æ –∑–µ—Ä–Ω–∞, –±–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏',
        is_fermented: '–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (true/false). –ö–≤–∞—à–µ–Ω—ã–π, —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–∏–æ—Ç–∏–∫–∏',
        is_raw: '–°—ã—Ä–æ–π/–Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ—Ä–º–∏—á–µ—Å–∫–∏ (true/false)',
    };

    HEYS.SharedProductsExportFields.getFieldDescriptions = function () {
        return { ...FIELD_DESCRIPTIONS };
    };
})();


/* ===== heys_export_utils_v1.js ===== */
// heys_export_utils_v1.js ‚Äî shared export helpers
(function () {
    const HEYS = window.HEYS = window.HEYS || {};
    HEYS.ExportUtils = HEYS.ExportUtils || {};

    const getIsoDate = (date) => {
        const d = date instanceof Date ? date : new Date();
        return d.toISOString().slice(0, 10);
    };

    HEYS.ExportUtils.buildDatedFileName = function (prefix, date) {
        return `${prefix}-${getIsoDate(date)}.json`;
    };

    HEYS.ExportUtils.downloadJSON = function ({ data, fileName }) {
        const payload = JSON.stringify(data, null, 2);
        const blob = new Blob([payload], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };
})();


/* ===== heys_core_v12.js ===== */
// heys_core_v12.js ‚Äî Product search, localStorage, RationTab, utilities
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const Store = (HEYS.store) || (HEYS.store = {});

  // üÜï Heartbeat –¥–ª—è watchdog ‚Äî core –∑–∞–≥—Ä—É–∂–µ–Ω
  if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîç DEBUG MODE + MODULE FALLBACK LOGGER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const isDebugMode = (() => {
    try {
      const params = new URLSearchParams(global.location?.search || '');
      const debugParam = params.get('debug');
      const debugLs = global.localStorage?.getItem('heys_debug');
      return debugParam === '1' || debugParam === 'true' || debugLs === '1' || debugLs === 'true';
    } catch (e) {
      return false;
    }
  })();

  if (HEYS.DEBUG_MODE == null) {
    HEYS.DEBUG_MODE = isDebugMode;
  }

  HEYS._missingModules = HEYS._missingModules || new Set();
  HEYS._debugMissingModule = function (name) {
    if (!HEYS.DEBUG_MODE) return;
    if (HEYS._missingModules.has(name)) return;
    HEYS._missingModules.add(name);
    if (HEYS.analytics?.trackError) {
      try {
        HEYS.analytics.trackError(new Error('Missing module: ' + name), {
          scope: 'module-fallback',
          module: name
        });
      } catch (e) { }
    }
  };

  HEYS._getModule = function (name, fallback) {
    const mod = HEYS[name];
    if (!mod) {
      HEYS._debugMissingModule?.(name);
      return fallback || {};
    }
    return mod;
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üõ†Ô∏è –ë–ê–ó–û–í–´–ï –£–¢–ò–õ–ò–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /** –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–ø—Ä–æ–±–µ–ª—ã, zero-width –∏ —Ç.–¥.) */
  const INVIS = /[\u00A0\u1680\u180E\u2000-\u200A\u200B-\u200F\u202F\u205F\u3000\uFEFF]/g;

  /** –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∏—Å–µ–ª (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ ',' –∏ '.') */
  const NUM_RE = /[-+]?\d+(?:[\.,]\d+)?/g;

  /** –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 1 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π */
  const round1 = (v) => Math.round(v * 10) / 10;

  /** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID (8 —Å–∏–º–≤–æ–ª–æ–≤) */
  const uuid = () => Math.random().toString(36).slice(2, 10);

  /**
   * –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∏—Å–ª–æ
   * @param {*} x - –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   * @returns {number} –ß–∏—Å–ª–æ –∏–ª–∏ 0 –ø—Ä–∏ –æ—à–∏–±–∫–µ
   */
  const toNum = (x) => {
    if (x === undefined || x === null) return 0;
    if (typeof x === 'number') return x;
    const s = String(x).trim().replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };

  /**
   * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ –≤ —á–∏—Å–ª–æ
   * @param {string|number} v - –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ input –ø–æ–ª—è
   * @returns {number} –ß–∏—Å–ª–æ –∏–ª–∏ 0
   */
  const toNumInput = (v) => {
    const n = Number(String(v).replace(',', '.'));
    return Number.isFinite(n) ? n : 0;
  };

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ clientId –∏–∑ localStorage –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
   * –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   * @returns {string} clientId –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
   */
  function getCurrentClientId() {
    // 1) –°–Ω–∞—á–∞–ª–∞ –∏–∑ –≥–ª–æ–±–∞–ª–∞ (–±—ã—Å—Ç—Ä–µ–µ)
    if (global.HEYS && HEYS.currentClientId) {
      return HEYS.currentClientId;
    }
    // 2) –ò–∑ localStorage —Å JSON.parse
    try {
      const raw = localStorage.getItem('heys_client_current');
      if (!raw) return '';
      // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
      const parsed = JSON.parse(raw);
      return typeof parsed === 'string' ? parsed : '';
    } catch (e) {
      // –ï—Å–ª–∏ –Ω–µ JSON ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (legacy)
      const raw = localStorage.getItem('heys_client_current');
      return raw || '';
    }
  }

  /**
   * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–∞ (—É–≥–ª–µ–≤–æ–¥—ã, –∂–∏—Ä—ã, –∫–∫–∞–ª)
   * @param {Object} p - –û–±—ä–µ–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ —Å –ø–æ–ª—è–º–∏ *100 (–Ω–∞ 100–≥)
   * @returns {{carbs100: number, fat100: number, kcal100: number, harm?: number}}
   */
  function computeDerived(p) {
    const hasCarbs = p && p.carbs100 != null;
    const hasFat = p && p.fat100 != null;
    const carbs100 = hasCarbs ? toNum(p.carbs100) : (toNum(p.simple100) + toNum(p.complex100));
    const fat100 = hasFat ? toNum(p.fat100) : (toNum(p.badFat100) + toNum(p.goodFat100) + toNum(p.trans100));
    // NET Atwater: protein 3 kcal/g (TEF 25% built-in: 4√ó0.75=3), carbs 4 kcal/g, fat 9 kcal/g
    const kcal100 = 3 * toNum(p.protein100) + 4 * carbs100 + 9 * fat100;

    const derived = {
      carbs100: round1(carbs100),
      fat100: round1(fat100),
      kcal100: round1(kcal100)
    };

    // Auto-calculate harm if not provided (v2.0.0)
    // HEYS.Harm.calculateHarmScore uses scientific formula based on trans/simple/badFat/sodium vs fiber/protein/goodFat
    if (p.harm == null && p.harmScore == null && window.HEYS?.Harm?.calculateHarmScore) {
      derived.harm = window.HEYS.Harm.calculateHarmScore(p);
    }

    return derived;
  }
  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage —Å JSON –ø–∞—Ä—Å–∏–Ω–≥–æ–º
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HEYS.store.get –¥–ª—è scoped-–∫–ª—é—á–µ–π (—Å clientId) –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
   * @param {string} key - –ö–ª—é—á –¥–ª—è —á—Ç–µ–Ω–∏—è
   * @param {*} def - –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
   * @returns {*} –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ def
   */
  function lsGet(key, def) {
    try {
      // üîß FIX: –î–ª—è client-specific –∫–ª—é—á–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store.get (—Å scoped-–∫–ª—é—á–∞–º–∏)
      // –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ heys_${clientId}_products,
      // –∞ —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ heys_products (legacy –∫–ª—é—á —Å –¥—Ä—É–≥–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
      if (window.HEYS?.store?.get && window.HEYS?.currentClientId) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ client-specific –∫–ª—é—á?
        const clientSpecificKeys = ['heys_products', 'heys_profile', 'heys_hr_zones', 'heys_norms', 'heys_game'];
        const isClientSpecific = clientSpecificKeys.some(k => key === k || key.includes('dayv2_'));
        if (isClientSpecific) {
          const result = window.HEYS.store.get(key, def);
          // üîç DEBUG v59: –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É dayv2
          if (key.includes('dayv2_') && HEYS.DEBUG_MODE && window.DEV?.log) {
            window.DEV.log(`[lsGet] key=${key}, clientId=${window.HEYS.currentClientId?.substring(0, 8)}, hasData=${result !== def && result !== null}, meals=${result?.meals?.length || 0}`);
          }
          return result;
        }
      }
      // Fallback –Ω–∞ –ø—Ä—è–º–æ–π localStorage –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π
      // üîß FIX v60: –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—ã—Ç–∞–µ–º—Å—è —á–∏—Ç–∞—Ç—å scoped-–∫–ª—é—á –Ω–∞–ø—Ä—è–º—É—é
      const clientSpecificKeys = ['heys_products', 'heys_profile', 'heys_hr_zones', 'heys_norms', 'heys_game'];
      const isClientSpecific = clientSpecificKeys.some(k => key === k || key.includes('dayv2_'));
      if (isClientSpecific) {
        const clientId = getCurrentClientId();
        if (clientId) {
          const keyPart = key.startsWith('heys_') ? key.substring('heys_'.length) : key;
          const scopedKey = `heys_${clientId}_${keyPart}`;
          const scopedV = localStorage.getItem(scopedKey);
          if (scopedV) {
            return JSON.parse(scopedV);
          }
        }
      }
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : def;
    } catch (e) {
      return def;
    }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage —Å JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HEYS.store.set –¥–ª—è scoped-–∫–ª—é—á–µ–π (—Å clientId) –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
   * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç window.HEYS.saveClientKey –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
   * @param {string} key - –ö–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   * @param {*} val - –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   */
  function lsSet(key, val) {
    try {
      // üîß FIX: –î–ª—è client-specific –∫–ª—é—á–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store.set (—Å scoped-–∫–ª—é—á–∞–º–∏)
      if (window.HEYS?.store?.set && window.HEYS?.currentClientId) {
        const clientSpecificKeys = ['heys_products', 'heys_profile', 'heys_hr_zones', 'heys_norms', 'heys_game'];
        // ‚ö†Ô∏è –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: heys_dayv2_date ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á (—Ç–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞), –ù–ï client-specific!
        const isGlobalKey = key === 'heys_dayv2_date';
        const isClientSpecific = !isGlobalKey && (clientSpecificKeys.some(k => key === k || key.includes('dayv2_')));
        if (isClientSpecific) {
          window.HEYS.store.set(key, val);
          // –°–æ–±—ã—Ç–∏–µ –¥–ª—è offline-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
          const type = key.includes('dayv2') ? 'meal'
            : key.includes('product') ? 'product'
              : key.includes('profile') ? 'profile'
                : 'data';
          window.dispatchEvent(new CustomEvent('heys:data-saved', { detail: { key, type } }));
          return;
        }
      }
      // Fallback –Ω–∞ –ø—Ä—è–º–æ–π localStorage –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π
      localStorage.setItem(key, JSON.stringify(val));
      // –°–æ–±—ã—Ç–∏–µ –¥–ª—è offline-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å —Ç–∏–ø–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      const type = key.includes('dayv2') ? 'meal'
        : key.includes('product') ? 'product'
          : key.includes('profile') ? 'profile'
            : 'data';
      window.dispatchEvent(new CustomEvent('heys:data-saved', { detail: { key, type } }));
    } catch (e) {
      console.error('[lsSet] Error saving:', key, e);
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìÑ –ü–ê–†–°–ò–ù–ì –í–°–¢–ê–í–õ–ï–ù–ù–´–• –î–ê–ù–ù–´–•
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —Ç–∞–±–ª–∏—Ü—ã
   * @param {string} line - –°—Ç—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   * @returns {boolean} true –µ—Å–ª–∏ —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
   */
  function isHeaderLine(line) {
    const l = line.toLowerCase();
    return l.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') && (l.includes('–∫–∫–∞–ª') || l.includes('–∫–∞–ª–æ—Ä–∏') || l.includes('—É–≥–ª–µ–≤–æ–¥'));
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ (—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–º–µ–Ω–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π)
   * @param {string} raw - –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
   * @returns {string} –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
   */
  function normalizeLine(raw) {
    let s = raw.replace(INVIS, ' ');
    s = s.replace(/\u060C/g, ',').replace(/\u066B/g, ',').replace(/\u066C/g, ',').replace(/\u201A/g, ',');
    s = s.replace(/\u00B7/g, '.').replace(/[‚Äì‚Äî‚àí]/g, '-').replace(/%/g, '');
    s = s.replace(/\t+/g, ' ').replace(/\s+/g, ' ').trim();
    return s;
  }

  /**
   * –ü–æ–∏—Å–∫ –ø–æ–∑–∏—Ü–∏–π —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ
   * @param {string} s - –°—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
   * @param {string[]} tokens - –ú–∞—Å—Å–∏–≤ —Ç–æ–∫–µ–Ω–æ–≤
   * @returns {(number|null)[]} –ú–∞—Å—Å–∏–≤ –ø–æ–∑–∏—Ü–∏–π (null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω)
   */
  function findTokenPositions(s, tokens) {
    const positions = [];
    let start = 0;
    for (const tok of tokens) {
      const idx = s.indexOf(tok, start);
      positions.push(idx === -1 ? null : idx);
      if (idx !== -1) start = idx + tok.length;
    }
    return positions;
  }

  /**
   * –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
   * –û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç: "–ù–∞–∑–≤–∞–Ω–∏–µ <12 —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π>"
   * @param {string} raw - –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–∑ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
   * @returns {{name: string, nums: number[]}|null} –û–±—ä–µ–∫—Ç —Å –∏–º–µ–Ω–µ–º –∏ –º–∞—Å—Å–∏–≤–æ–º –∏–∑ 12 —á–∏—Å–µ–ª, –∏–ª–∏ null
   */
  function extractRow(raw) {
    DEV.log('üîç [EXTRACT] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É:', raw);

    const clean = normalizeLine(raw);
    DEV.log('üßπ [EXTRACT] –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:', clean);

    const tokens = clean.match(NUM_RE) || [];
    DEV.log('üî¢ [EXTRACT] –ù–∞–π–¥–µ–Ω–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã:', tokens);

    if (!tokens.length) {
      DEV.warn('‚ö†Ô∏è [EXTRACT] –ß–∏—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      return null;
    }

    let last = tokens.slice(-12);
    DEV.log('üìä [EXTRACT] –ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 —Ç–æ–∫–µ–Ω–æ–≤:', last);

    if (last.length < 12) {
      last = Array(12 - last.length).fill('0').concat(last);
      DEV.log('üìä [EXTRACT] –î–æ–ø–æ–ª–Ω–µ–Ω–æ –Ω—É–ª—è–º–∏ –¥–æ 12:', last);
    }

    const positions = findTokenPositions(clean, last);
    DEV.log('üìç [EXTRACT] –ü–æ–∑–∏—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:', positions);

    const firstPos = positions[0] ?? clean.length;
    const name = clean.slice(0, firstPos).trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    DEV.log('üìù [EXTRACT] –ò–∑–≤–ª–µ—á–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', name);

    const nums = last.map(toNum);
    DEV.log('üî¢ [EXTRACT] –ß–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:', nums);

    const result = { name, nums };
    DEV.log('‚úÖ [EXTRACT] –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:', result);

    return result;
  }
  // --- Web Worker proxy for heavy parsePasted ---
  let _parseWorker = null;
  function getParseWorker() {
    DEV.log('üë∑ [WORKER] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π worker:', !!_parseWorker);

    if (!_parseWorker) {
      try {
        DEV.log('üë∑ [WORKER] –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Web Worker: parse_worker.js');
        _parseWorker = new Worker('parse_worker.js');
        DEV.log('‚úÖ [WORKER] Web Worker —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        _parseWorker.onerror = (error) => {
          console.error('‚ùå [WORKER] –û—à–∏–±–∫–∞ Web Worker:', error);
        };

      } catch (error) {
        console.error('‚ùå [WORKER] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Web Worker:', error);
        throw error;
      }
    }

    return _parseWorker;
  }
  function parsePasted(text) {
    DEV.log('üîç [PARSE] –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞');
    DEV.log('üìä [PARSE] –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', text?.length || 0);
    DEV.log('üîß [PARSE] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Web Worker:', typeof Worker !== 'undefined');

    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º Web Worker –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
    DEV.log('‚ö†Ô∏è [PARSE] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (Worker –æ—Ç–∫–ª—é—á–µ–Ω)');
    return Promise.resolve(parsePastedSync(text));

    // fallback sync for environments without Worker
    if (typeof Worker === 'undefined') {
      DEV.log('‚ö†Ô∏è [PARSE] Web Worker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥');
      return parsePastedSync(text);
    }

    DEV.log('üîÑ [PARSE] –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Worker –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞');

    return new Promise((resolve, reject) => {
      try {
        const worker = getParseWorker();
        DEV.log('üë∑ [PARSE] Web Worker —Å–æ–∑–¥–∞–Ω:', !!worker);

        const handler = (e) => {
          DEV.log('üì® [PARSE] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Worker:', e.data);
          worker.removeEventListener('message', handler);

          const result = e.data.result && e.data.result.rows ? e.data.result.rows : [];
          DEV.log('‚úÖ [PARSE] –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞:', result.length, '–ø—Ä–æ–¥—É–∫—Ç–æ–≤');
          resolve(result);
        };

        const errorHandler = (error) => {
          console.error('‚ùå [PARSE] –û—à–∏–±–∫–∞ Web Worker:', error);
          worker.removeEventListener('message', handler);
          worker.removeEventListener('error', errorHandler);
          reject(new Error('Worker error: ' + error.message));
        };

        worker.addEventListener('message', handler);
        worker.addEventListener('error', errorHandler);

        DEV.log('üì§ [PARSE] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Worker');
        worker.postMessage({ text });

        setTimeout(() => {
          DEV.warn('‚è∞ [PARSE] –¢–∞–π–º–∞—É—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ (10 —Å–µ–∫)');
          worker.removeEventListener('message', handler);
          worker.removeEventListener('error', errorHandler);
          reject(new Error('parse timeout'));
        }, 10000);
      } catch (error) {
        console.error('‚ùå [PARSE] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
        reject(error);
      }
    });
  }
  // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–∫–µ—Ä–∞ –∏ –∫–∞–∫ fallback)
  function parsePastedSync(text) {
    DEV.log('üîç [PARSE_SYNC] –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥');
    DEV.log('üìä [PARSE_SYNC] –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', text?.length || 0);

    if (!text || typeof text !== 'string') {
      DEV.warn('‚ö†Ô∏è [PARSE_SYNC] –ü—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç');
      return [];
    }

    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0 && !isHeaderLine(l));
    DEV.log('üìÑ [PARSE_SYNC] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', lines.length);
    DEV.log('üìù [PARSE_SYNC] –ü–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏:', lines.slice(0, 3));

    const rows = [];
    for (let i = 0; i < lines.length; i++) {
      const raw = lines[i];
      DEV.log(`üîç [PARSE_SYNC] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É ${i + 1}:`, raw.substring(0, 50) + '...');

      const st = extractRow(raw);
      if (!st) {
        DEV.warn(`‚ö†Ô∏è [PARSE_SYNC] –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ ${i + 1}:`, raw);
        continue;
      }

      DEV.log(`‚úÖ [PARSE_SYNC] –ò–∑–≤–ª–µ—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ ${i + 1}:`, st.name, st.nums);

      const [kcal, carbs, simple, complex, protein, fat, bad, good, trans, fiber, gi, harm] = st.nums;
      const base = { id: uuid(), name: st.name, carbs100: carbs, fat100: fat, simple100: simple, complex100: complex, protein100: protein, badFat100: bad, goodFat100: good, trans100: trans, fiber100: fiber, gi: gi, harm: harm, createdAt: Date.now() };

      try {
        const d = computeDerived(base);
        const product = { id: base.id, name: base.name, ...base, carbs100: d.carbs100, fat100: d.fat100, kcal100: d.kcal100 };
        rows.push(product);
        DEV.log(`‚úÖ [PARSE_SYNC] –ü—Ä–æ–¥—É–∫—Ç ${i + 1} —Å–æ–∑–¥–∞–Ω:`, product.name, '–∫–∫–∞–ª:', product.kcal100);
      } catch (error) {
        console.error(`‚ùå [PARSE_SYNC] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ ${i + 1}:`, error);
      }
    }

    DEV.log('‚úÖ [PARSE_SYNC] –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω, —Å–æ–∑–¥–∞–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', rows.length);
    return rows;
  }

  function RationTab(props) {
    const { setProducts } = props;
    const products = Array.isArray(props.products) ? props.products : [];

    // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –æ–±–ª–∞–∫–æ –∏ localStorage –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (—á–µ—Ä–µ–∑ HEYS.utils –¥–ª—è namespace)
    React.useEffect(() => {
      // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ
      if (products.length === 0) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ localStorage –∏–ª–∏ –æ–±–ª–∞–∫–µ
        const existingProducts = (window.HEYS && window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) ||
          (window.HEYS && window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', null));
        if (existingProducts && Array.isArray(existingProducts) && existingProducts.length > 0) {
          // –ï—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –≤ storage, –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º –∏—Ö –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
          console.info('[baza] üíæ useEffect[products]: SKIP ‚Äî products=0 –Ω–æ localStorage=', existingProducts.length);
          return;
        }
      }

      // üõ°Ô∏è –ó–ê–©–ò–¢–ê –æ—Ç race condition: –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å–ª–∏ –≤ storage –±–æ–ª—å—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
      // –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ _intentionalProductDelete ‚Äî —ç—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
      const existingProducts = (window.HEYS && window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) ||
        (window.HEYS && window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', null));
      if (existingProducts && Array.isArray(existingProducts) && existingProducts.length > products.length) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
        if (window.HEYS && window.HEYS._intentionalProductDelete) {
          console.info('[baza] üíæ useEffect[products]: ALLOWED intentional delete', existingProducts.length, '‚Üí', products.length);
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          window.HEYS._intentionalProductDelete = false;
        } else {
          console.warn('[baza] üíæ useEffect[products]: ‚ùå BLOCKED ‚Äî localStorage=', existingProducts.length, '> state=', products.length, '(–Ω–µ—Ç —Ñ–ª–∞–≥–∞ _intentionalProductDelete)');
          return;
        }
      }

      console.info('[baza] üíæ useEffect[products]: SAVE ‚Äî products.length=', products.length);

      if (Array.isArray(products) && window.HEYS && window.HEYS.store && typeof window.HEYS.store.set === 'function') {
        window.HEYS.store.set('heys_products', products);
      } else if (window.HEYS && window.HEYS.utils && typeof window.HEYS.utils.lsSet === 'function') {
        // fallback
        window.HEYS.utils.lsSet('heys_products', products);
      }
    }, [products]);

    // üî¥ FIX: –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ–º id –ø—Ä–æ–¥—É–∫—Ç–∞–º –±–µ–∑ id –ø—Ä—è–º–æ –≤ state
    // (–∏–Ω–∞—á–µ deleteRow(undefined) —É–¥–∞–ª–∏—Ç –≤—Å–µ—Ö –±–µ–∑ id)
    // –í–ê–ñ–ù–û: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –°–ò–ù–•–†–û–ù–ù–û, –∏–Ω–∞—á–µ useEffect([clientId])
    // –ø–µ—Ä–µ—á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ä—ã–π localStorage –∏ —Å–±—Ä–æ—Å–∏—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ id –æ–±—Ä–∞—Ç–Ω–æ –≤ undefined
    React.useEffect(() => {
      const genId = () => ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
        (c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))).toString(16)
      );

      // ü™¶ –°–Ω–∞—á–∞–ª–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ–º tombstone-–ø—Ä–æ–¥—É–∫—Ç—ã –ë–ï–ó id –ø–æ –∏–º–µ–Ω–∏.
      // –ï—Å–ª–∏ –æ–±–ª–∞–∫–æ –≤–µ—Ä–Ω—É–ª–æ —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –±–µ–∑ id ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞–∑–Ω–∞—á–∏—Ç –Ω–æ–≤—ã–π uuid,
      // –∏ tombstone –ø–æ —Å—Ç–∞—Ä–æ–º—É id —É–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ—ç—Ç–æ–º—É –ª–æ–≤–∏–º –∑–¥–µ—Å—å –ø–æ –∏–º–µ–Ω–∏.
      let cleaned = products;
      try {
        const tombstones = window.HEYS?.store?.get?.('heys_deleted_ids') || [];
        if (Array.isArray(tombstones) && tombstones.length > 0) {
          const deletedNames = new Set(tombstones.map(t => t.name).filter(Boolean));
          if (deletedNames.size > 0) {
            const noIdProducts = cleaned.filter(p => !p.id);
            const zombies = noIdProducts.filter(p => p.name && deletedNames.has(p.name));
            if (zombies.length > 0) {
              console.info(`[baza] ü™¶ migrate ids: —É–±—Ä–∞–Ω–æ ${zombies.length} zombie product(s) –±–µ–∑ id –ø–æ –∏–º–µ–Ω–∏ –∏–∑ tombstone`);
              cleaned = cleaned.filter(p => !((!p.id) && p.name && deletedNames.has(p.name)));
            }
          }
        }
      } catch (_) { }

      const missing = cleaned.filter(p => !p.id);
      if (missing.length > 0) {
        console.warn('[baza] üÜî migrate ids: –Ω–∞–π–¥–µ–Ω–æ', missing.length, '–ø—Ä–æ–¥—É–∫—Ç–æ–≤ –±–µ–∑ id ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ–º uuid');
        const patched = cleaned.map(p => p.id ? p : { ...p, id: genId() });
        console.info('[baza] üÜî migrate ids: –≥–æ—Ç–æ–≤–æ, –ø—Ä–∏–º–µ—Ä—ã:', patched.slice(0, 3).map(p => ({ id: p.id, name: p.name })));
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –°–ò–ù–•–†–û–ù–ù–û –¥–æ setProducts
        if (window.HEYS?.store?.set) {
          window.HEYS.store.set('heys_products', patched);
          console.info('[baza] üÜî migrate ids: localStorage –æ–±–Ω–æ–≤–ª—ë–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (HEYS.store.set)');
        } else if (window.HEYS?.utils?.lsSet) {
          window.HEYS.utils.lsSet('heys_products', patched);
          console.info('[baza] üÜî migrate ids: localStorage –æ–±–Ω–æ–≤–ª—ë–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (lsSet)');
        }
        setProducts(patched);
      } else if (cleaned.length < products.length) {
        // –ü—Ä–æ–¥—É–∫—Ç—ã –±—ã–ª–∏ —É–±—Ä–∞–Ω—ã zombie-—Ñ–∏–ª—å—Ç—Ä–æ–º, –Ω–æ id –≤—Å–µ –Ω–∞ –º–µ—Å—Ç–µ
        if (window.HEYS?.store?.set) {
          window.HEYS.store.set('heys_products', cleaned);
        }
        setProducts(cleaned);
      } else {
        console.info('[baza] üÜî migrate ids: –≤—Å–µ', products.length, '–ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–º–µ—é—Ç id ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞ ‚úÖ');
      }
    }, []);  // eslint-disable-line react-hooks/exhaustive-deps ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

    // ü™¶ TOMBSTONE FILTER ‚Äî –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –≤—Ö–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
    // –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª, –Ω–æ –æ–±–ª–∞–∫–æ –ø—ã—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–Ω—É—Ç—å
    function applyTombstoneFilter(productsList) {
      try {
        const tombstones = window.HEYS?.store?.get?.('heys_deleted_ids') || [];
        if (!Array.isArray(tombstones) || tombstones.length === 0) return productsList;
        // üîë –§–∏–ª—å—Ç—Ä—É–µ–º –¢–û–õ–¨–ö–û –ø–æ id, –ù–ï –ø–æ –∏–º–µ–Ω–∏.
        // –ò–º—è-—Ñ–∏–ª—å—Ç—Ä –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ —Å —Ç–µ–º –∂–µ –Ω–∞–∑–≤–∞–Ω–∏–µ–º (–Ω–æ–≤—ã–π id).
        // Cloud sync –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç —Å –¢–ï–ú –ñ–ï id ‚Üí tombstone –µ–≥–æ —Ä–µ–∂–µ—Ç.
        // –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç –ù–û–í–´–ô id ‚Üí tombstone –µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç.
        const deletedIds = new Set(tombstones.map(t => t.id).filter(Boolean));
        const before = productsList.length;
        const filtered = productsList.filter(p => !(p.id && deletedIds.has(p.id)));
        const removed = before - filtered.length;
        if (removed > 0) {
          console.info(`[baza] ü™¶ tombstone filter: —É–±—Ä–∞–Ω–æ ${removed} resurrection product(s)`);
          try { if (window.HEYS?.store?.set) window.HEYS.store.set('heys_products', filtered); } catch (_) { }
        }
        return filtered;
      } catch (_) {
        return productsList;
      }
    }

    const [query, setQuery] = React.useState('');
    const [paste, setPaste] = React.useState('');
    const [showModal, setShowModal] = React.useState(false);
    // === EXTENDED PRODUCT DRAFT (v4.4.0) ‚Äî –≤—Å–µ ~35 –ø–æ–ª–µ–π –∏–∑ DATA_MODEL_REFERENCE ===
    const INITIAL_DRAFT = {
      // –ë–∞–∑–æ–≤—ã–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
      name: '', simple100: 0, complex100: 0, protein100: 0, badFat100: 0, goodFat100: 0, trans100: 0, fiber100: 0, gi: 0, harm: 0,
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã
      sodium100: 0, cholesterol100: 0, sugar100: 0, omega3_100: 0, omega6_100: 0,
      // –í–∏—Ç–∞–º–∏–Ω—ã (% –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã)
      vitaminA: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0,
      vitaminB1: 0, vitaminB2: 0, vitaminB3: 0, vitaminB6: 0, vitaminB9: 0, vitaminB12: 0,
      // –ú–∏–Ω–µ—Ä–∞–ª—ã (% –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã)
      calcium: 0, iron: 0, magnesium: 0, phosphorus: 0, potassium: 0, zinc: 0, selenium: 0, iodine: 0,
      // NOVA –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞
      novaGroup: 0, // 0 = –∞–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç, 1-4 = —è–≤–Ω–æ –∑–∞–¥–∞–Ω–æ
      additives: '', // —Å—Ç—Ä–æ–∫–∞ E-–¥–æ–±–∞–≤–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
      // –§–ª–∞–≥–∏ –∫–∞—á–µ—Å—Ç–≤–∞
      isOrganic: false, isWholeGrain: false, isFermented: false, isRaw: false,
      // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
      harmNote: '',
      // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
      category: ''
    };
    const [draft, setDraft] = React.useState(INITIAL_DRAFT);
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö —Å–µ–∫—Ü–∏–π –≤ –º–æ–¥–∞–ª–∫–µ
    const [expandedSections, setExpandedSections] = React.useState({ base: true, extra: false, vitamins: false, minerals: false, nova: false, flags: false });
    const derived = computeDerived(draft);

    // === PHASE 2: Shared Products UI ===
    // –ü–æ–¥–≤–∫–ª–∞–¥–∫–∏: 'personal' (üë§ –ü—Ä–æ–¥—É–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞) | 'shared' (üåê –û–±—â–∞—è –±–∞–∑–∞)
    // üîß FIX: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ per-client, —á—Ç–æ–±—ã syncVer-remount –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª UI
    const getRationSubtabKey = () => {
      const clientId = window.HEYS?.currentClientId;
      return clientId ? `heys_${clientId}_ration_subtab` : 'heys_ration_subtab';
    };
    const readStoredSubtab = () => {
      try {
        const raw = localStorage.getItem(getRationSubtabKey());
        const stored = raw ? JSON.parse(raw) : null;
        return stored === 'shared' ? 'shared' : 'personal';
      } catch (_) {
        return 'personal';
      }
    };
    const [activeSubtab, setActiveSubtab] = React.useState(readStoredSubtab);
    // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏–∑ shared_products
    const [sharedResults, setSharedResults] = React.useState([]);
    const [sharedLoading, setSharedLoading] = React.useState(false);
    const [sharedQuery, setSharedQuery] = React.useState('');
    // –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã –æ–±—â–µ–π –±–∞–∑—ã (–¥–ª—è —Ç–∞–±–ª–∏—Ü—ã)
    const [allSharedProducts, setAllSharedProducts] = React.useState([]);
    const [allSharedLoading, setAllSharedLoading] = React.useState(false);
    const [sharedExportCount, setSharedExportCount] = React.useState(null);
    // Pending –∑–∞—è–≤–∫–∏ (–¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
    const [pendingProducts, setPendingProducts] = React.useState([]);
    const [pendingLoading, setPendingLoading] = React.useState(false);
    // Checkbox: –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤ shared (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ON)
    const [publishToShared, setPublishToShared] = React.useState(true);
    // –ú–æ–¥–∞–ª–∫–∞ –º—è–≥–∫–æ–≥–æ merge –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ fingerprint
    const [mergeModal, setMergeModal] = React.useState({ show: false, existing: null, draft: null });
    // Collapsible —Å–µ–∫—Ü–∏—è –±—ç–∫–∞–ø–æ–≤ (—Å–≤—ë—Ä–Ω—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    const [showBackupSection, setShowBackupSection] = React.useState(false);

    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ (1-99, 100-199, ...)
    const RANGE_STEP = 100;
    const getRangeSize = (start) => (start === 0 ? 99 : 100);
    const getRangeEnd = (start, total) => Math.min(start + getRangeSize(start), total);
    const buildRangeOptions = (total) => {
      if (!total || total <= 0) return [];
      const ranges = [];
      let index = 0;
      while (true) {
        const start = index === 0 ? 0 : (index * RANGE_STEP - 1);
        if (start >= total) break;
        const end = getRangeEnd(start, total);
        const label = `${start + 1}-${end}`;
        ranges.push({ start, end, label });
        index += 1;
      }
      return ranges;
    };
    const DEFAULT_DISPLAY_LIMIT = 5;
    const [personalRangeStart, setPersonalRangeStart] = React.useState(0);
    const [sharedRangeStart, setSharedRangeStart] = React.useState(0);
    const [personalRangeActive, setPersonalRangeActive] = React.useState(false);
    const [sharedRangeActive, setSharedRangeActive] = React.useState(false);
    const lastSharedLoadRef = React.useRef(0);
    const SHARED_LOAD_TTL_MS = 30000;

    // Normalization for personal products (legacy-safe)
    const normalizePersonalProduct = (product) => {
      if (!product || typeof product !== 'object') return product;
      if (product._normalizedPersonal) return product;
      try {
        let next = { ...product };
        // üî¥ FIX: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º id —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (–∏–Ω–∞—á–µ deleteRow —É–¥–∞–ª–∏—Ç –í–°–ï–• –±–µ–∑ id)
        if (!next.id) {
          const newId = (window.HEYS?.utils?.uuid?.() ||
            window.HEYS?.models?.uuid?.() ||
            ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
              (c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))).toString(16)
            ));
          next.id = newId;
          if (window.DEV) window.DEV.log('[baza] üÜî normalizePersonalProduct: –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–æ–≤—ã–π id –¥–ª—è "' + next.name + '":', newId);
        }
        if (HEYS.features?.unifiedTables === false) {
          if (HEYS.models?.normalizeProductFields) {
            next = HEYS.models.normalizeProductFields(next);
          }
        } else if (HEYS.models?.normalizeExtendedProduct) {
          next = HEYS.models.normalizeExtendedProduct(next);
        } else if (HEYS.models?.normalizeProductFields) {
          next = HEYS.models.normalizeProductFields(next);
        }
        const derived = HEYS.models?.computeDerivedProduct
          ? HEYS.models.computeDerivedProduct(next)
          : computeDerived(next);
        if (derived?.kcal100 != null) {
          next.kcal100 = derived.kcal100;
          next.carbs100 = derived.carbs100;
          next.fat100 = derived.fat100;
          if (derived.harm != null && next.harm == null) {
            next.harm = derived.harm;
            next.harmScore = derived.harm;
          }
        }
        next._normalizedPersonal = true;
        return next;
      } catch (e) {
        console.error('[HEYS.store] ‚ùå normalizePersonalProduct failed', e);
        return product;
      }
    };

    const normalizePersonalProducts = (list) => {
      if (!Array.isArray(list)) return [];
      return list.map(normalizePersonalProduct).filter(Boolean);
    };

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º curator-—Ä–µ–∂–∏–º (–µ—Å—Ç—å Supabase session)
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º state –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ auth
    // ‚úÖ FIX v47: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ cloudUser (curator login —Å–æ–∑–¥–∞—ë—Ç user),
    // –∞ –Ω–µ _rpcOnlyMode (–∫–æ—Ç–æ—Ä—ã–π true –¥–ª—è –í–°–ï–• –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API)
    // ‚úÖ FIX v48: –ó–∞–º–µ–Ω—ë–Ω setInterval(1s) –Ω–∞ event listener –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const [isCurator, setIsCurator] = React.useState(false);
    React.useEffect(() => {
      const checkCurator = () => {
        const isCuratorSession = window.HEYS?.auth?.isCuratorSession;
        const result = typeof isCuratorSession === 'function'
          ? isCuratorSession()
          : window.HEYS?.cloud?.getUser?.() != null;
        setIsCurator(result);
      };
      checkCurator();
      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è auth —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ (–≤–º–µ—Å—Ç–æ polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
      window.addEventListener('heys:auth-changed', checkCurator);
      return () => window.removeEventListener('heys:auth-changed', checkCurator);
    }, []);

    // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ shared (300ms)
    const searchSharedDebounced = React.useMemo(() => {
      let timeoutId = null;
      return (q) => {
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(async () => {
          if (!q || q.length < 2) {
            setSharedResults([]);
            return;
          }
          setSharedLoading(true);
          try {
            const result = await window.HEYS?.cloud?.searchSharedProducts?.(q, { limit: 50 });
            if (result?.data) {
              setSharedResults(result.data);
            }
          } catch (err) {
            console.error('[SHARED SEARCH] Error:', err);
          } finally {
            setSharedLoading(false);
          }
        }, 300);
      };
    }, []);

    // –ó–∞–≥—Ä—É–∑–∫–∞ pending –∑–∞—è–≤–æ–∫ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞
    const loadPendingProducts = React.useCallback(async () => {
      if (!isCurator) return;
      setPendingLoading(true);
      try {
        const result = await window.HEYS?.cloud?.getPendingProducts?.();
        if (result?.data) {
          setPendingProducts(result.data);
        }
      } catch (err) {
        console.error('[PENDING] Load error:', err);
      } finally {
        setPendingLoading(false);
      }
    }, [isCurator]);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –í–°–ï–• –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã
    const loadAllSharedProducts = React.useCallback(async (options = {}) => {
      const force = !!options.force;
      const now = Date.now();
      if (!force && Array.isArray(allSharedProducts) && allSharedProducts.length > 0) {
        const age = now - (lastSharedLoadRef.current || 0);
        if (age < SHARED_LOAD_TTL_MS) {
          console.info('[baza] ‚è≠Ô∏è CACHE HIT ‚Äî skip RPC, ttl remaining:', Math.round((SHARED_LOAD_TTL_MS - age) / 1000), 's, cached products:', allSharedProducts.length);
          // [baza] –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –∫—ç—à–µ
          if (allSharedProducts.length > 0) {
            const s = allSharedProducts[0];
            console.info('[baza] üóÉÔ∏è CACHED first product:', s?.name, '| keys:', Object.keys(s || {}).sort().join(', '));
            console.info('[baza] üóÉÔ∏è CACHED vitamins: vitamin_c=', s?.vitamin_c, 'vitaminC=', s?.vitaminC, 'calcium=', s?.calcium, 'sodium100=', s?.sodium100);
          }
          return;
        }
      }

      console.info('[baza] üöÄ LOADING from RPC ‚Äî force:', force, '| current count:', allSharedProducts?.length || 0);
      setAllSharedLoading(true);
      try {
        const result = await window.HEYS?.cloud?.getAllSharedProducts?.({ limit: 500 });
        if (result?.data) {
          // [baza] –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —á—Ç–æ –≤–µ—Ä–Ω—É–ª getAllSharedProducts
          console.info('[baza] üì¶ getAllSharedProducts returned', result.data.length, 'products');
          if (result.data.length > 0) {
            const s = result.data[0];
            console.info('[baza] üì¶ FIRST product:', s?.name, '| ALL KEYS:', Object.keys(s).sort().join(', '));
            console.info('[baza] üî¨ vitamin_c=', s?.vitamin_c, '| vitaminC=', s?.vitaminC, '| calcium=', s?.calcium, '| iron=', s?.iron, '| sodium100=', s?.sodium100, '| vitamin_b1=', s?.vitamin_b1);
          }
          setAllSharedProducts(result.data);
          lastSharedLoadRef.current = Date.now();
        } else {
          console.warn('[baza] ‚ö†Ô∏è getAllSharedProducts returned no data:', result);
        }
      } catch (err) {
        console.error('[SHARED ALL] Load error:', err);
      } finally {
        setAllSharedLoading(false);
      }
    }, [allSharedProducts]);

    React.useEffect(() => {
      const cached = window.HEYS?.cloud?.getCachedSharedProducts?.();
      if (Array.isArray(cached) && cached.length) {
        setSharedExportCount(cached.length);
        return;
      }
      if (Array.isArray(allSharedProducts) && allSharedProducts.length) {
        setSharedExportCount(allSharedProducts.length);
      }
    }, [allSharedProducts]);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º pending –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–û–±—â–∞—è –±–∞–∑–∞"
    React.useEffect(() => {
      if (activeSubtab === 'shared' && isCurator) {
        loadPendingProducts();
      }
    }, [activeSubtab, isCurator, loadPendingProducts]);

    // üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
    React.useEffect(() => {
      const handleClientChange = () => {
        const next = readStoredSubtab();
        setActiveSubtab((prev) => (prev === next ? prev : next));
      };
      window.addEventListener('heys:client-changed', handleClientChange);
      return () => window.removeEventListener('heys:client-changed', handleClientChange);
    }, []);

    // üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ (per-client key)
    React.useEffect(() => {
      try {
        if (activeSubtab !== 'personal' && activeSubtab !== 'shared') return;
        localStorage.setItem(getRationSubtabKey(), JSON.stringify(activeSubtab));
      } catch (_) { }
    }, [activeSubtab]);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã –æ–±—â–µ–π –±–∞–∑—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–û–±—â–∞—è –±–∞–∑–∞"
    React.useEffect(() => {
      if (activeSubtab === 'shared') {
        loadAllSharedProducts();
      }
    }, [activeSubtab, loadAllSharedProducts]);

    // –ü–æ–∏—Å–∫ –≤ shared –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ sharedQuery (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ shared)
    React.useEffect(() => {
      if (activeSubtab === 'shared') {
        searchSharedDebounced(sharedQuery || query);
      }
    }, [sharedQuery, query, activeSubtab, searchSharedDebounced]);

    // –ê–≤—Ç–æ-–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ extended –ø–æ–ª–µ–π –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ shared_products
    const sharedFieldsBackfillRef = React.useRef({ key: '', inFlight: false });
    React.useEffect(() => {
      if (!Array.isArray(products) || products.length === 0) return;

      const normalizeName = window.HEYS?.models?.normalizeProductName
        || ((name) => String(name || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));
      const isMissing = (v) => v === undefined || v === null || v === '';
      const listMissing = (v) => !Array.isArray(v) || v.length === 0;

      const missing = products
        .filter(p => (
          isMissing(p?.createdAt) || // üÜï v4.8.7: sort order
          isMissing(p?.sodium100) ||
          isMissing(p?.omega3_100) ||
          isMissing(p?.omega6_100) ||
          isMissing(p?.nova_group) ||
          listMissing(p?.additives) ||
          isMissing(p?.nutrient_density) ||
          isMissing(p?.is_organic) ||
          isMissing(p?.is_whole_grain) ||
          isMissing(p?.is_fermented) ||
          isMissing(p?.is_raw) ||
          isMissing(p?.vitamin_a) ||
          isMissing(p?.vitamin_c) ||
          isMissing(p?.vitamin_d) ||
          isMissing(p?.vitamin_e) ||
          isMissing(p?.vitamin_k) ||
          isMissing(p?.vitamin_b1) ||
          isMissing(p?.vitamin_b2) ||
          isMissing(p?.vitamin_b3) ||
          isMissing(p?.vitamin_b6) ||
          isMissing(p?.vitamin_b9) ||
          isMissing(p?.vitamin_b12) ||
          isMissing(p?.calcium) ||
          isMissing(p?.iron) ||
          isMissing(p?.magnesium) ||
          isMissing(p?.phosphorus) ||
          isMissing(p?.potassium) ||
          isMissing(p?.zinc) ||
          isMissing(p?.selenium) ||
          isMissing(p?.iodine)
        ))
        .map(p => ({ id: p?.shared_origin_id, name: normalizeName(p?.name) }))
        .filter(p => p.id || p.name);

      if (missing.length === 0) return;

      const missingKey = missing
        .map(p => p.id || p.name)
        .sort()
        .join('|');

      if (sharedFieldsBackfillRef.current.inFlight || sharedFieldsBackfillRef.current.key === missingKey) return;

      sharedFieldsBackfillRef.current = { key: missingKey, inFlight: true };

      (async () => {
        try {
          const cloud = window.HEYS?.cloud;
          if (!cloud?.getAllSharedProducts) return;

          const result = await cloud.getAllSharedProducts({ limit: 1000, excludeBlocklist: false });
          const shared = Array.isArray(result?.data) ? result.data : [];
          if (shared.length === 0) return;

          const byId = new Map();
          const byName = new Map();
          const nameCounts = new Map();

          shared.forEach(sp => {
            if (sp?.id) byId.set(sp.id, sp);
            const nm = normalizeName(sp?.name);
            if (nm) {
              nameCounts.set(nm, (nameCounts.get(nm) || 0) + 1);
              byName.set(nm, sp);
            }
          });

          const pickShared = (p) => {
            if (p?.shared_origin_id && byId.has(p.shared_origin_id)) {
              return byId.get(p.shared_origin_id);
            }
            const nm = normalizeName(p?.name);
            if (nm && nameCounts.get(nm) === 1) {
              return byName.get(nm);
            }
            return null;
          };

          const updated = products.map(p => {
            const sharedProduct = pickShared(p);
            if (!sharedProduct) return p;

            const next = { ...p };
            let changed = false;
            const setIfMissing = (key, value) => {
              if (isMissing(next[key]) && !isMissing(value)) {
                next[key] = value;
                changed = true;
              }
            };
            const setListIfMissing = (key, value) => {
              if (listMissing(next[key]) && Array.isArray(value) && value.length > 0) {
                next[key] = value;
                changed = true;
              }
            };

            setIfMissing('sodium100', sharedProduct.sodium100);
            setIfMissing('omega3_100', sharedProduct.omega3_100);
            setIfMissing('omega6_100', sharedProduct.omega6_100);
            setIfMissing('nova_group', sharedProduct.nova_group ?? sharedProduct.novaGroup);
            setListIfMissing('additives', sharedProduct.additives);
            setIfMissing('nutrient_density', sharedProduct.nutrient_density ?? sharedProduct.nutrientDensity);
            setIfMissing('is_organic', sharedProduct.is_organic ?? sharedProduct.isOrganic);
            setIfMissing('is_whole_grain', sharedProduct.is_whole_grain ?? sharedProduct.isWholeGrain);
            setIfMissing('is_fermented', sharedProduct.is_fermented ?? sharedProduct.isFermented);
            setIfMissing('is_raw', sharedProduct.is_raw ?? sharedProduct.isRaw);
            setIfMissing('vitamin_a', sharedProduct.vitamin_a ?? sharedProduct.vitaminA);
            setIfMissing('vitamin_c', sharedProduct.vitamin_c ?? sharedProduct.vitaminC);
            setIfMissing('vitamin_d', sharedProduct.vitamin_d ?? sharedProduct.vitaminD);
            setIfMissing('vitamin_e', sharedProduct.vitamin_e ?? sharedProduct.vitaminE);
            setIfMissing('vitamin_k', sharedProduct.vitamin_k ?? sharedProduct.vitaminK);
            setIfMissing('vitamin_b1', sharedProduct.vitamin_b1 ?? sharedProduct.vitaminB1);
            setIfMissing('vitamin_b2', sharedProduct.vitamin_b2 ?? sharedProduct.vitaminB2);
            setIfMissing('vitamin_b3', sharedProduct.vitamin_b3 ?? sharedProduct.vitaminB3);
            setIfMissing('vitamin_b6', sharedProduct.vitamin_b6 ?? sharedProduct.vitaminB6);
            setIfMissing('vitamin_b9', sharedProduct.vitamin_b9 ?? sharedProduct.vitaminB9);
            setIfMissing('vitamin_b12', sharedProduct.vitamin_b12 ?? sharedProduct.vitaminB12);
            setIfMissing('calcium', sharedProduct.calcium);
            setIfMissing('iron', sharedProduct.iron);
            setIfMissing('magnesium', sharedProduct.magnesium);
            setIfMissing('phosphorus', sharedProduct.phosphorus);
            setIfMissing('potassium', sharedProduct.potassium);
            setIfMissing('zinc', sharedProduct.zinc);
            setIfMissing('selenium', sharedProduct.selenium);
            setIfMissing('iodine', sharedProduct.iodine);

            // üÜï v4.8.7: Backfill createdAt from shared product's created_at
            // Allows correct sort order in personal list even without cloud sync
            if (isMissing(next.createdAt)) {
              const rawCreated = sharedProduct.created_at ?? sharedProduct.createdAt;
              if (rawCreated) {
                let tsCreated = typeof rawCreated === 'number' ? rawCreated : (() => {
                  let parsed = Date.parse(rawCreated);
                  if (!Number.isFinite(parsed)) {
                    const norm = String(rawCreated)
                      .replace(' ', 'T')
                      .replace(/(\.(\d{3}))\d+/, '$1')
                      .replace(/\+00$/, 'Z')
                      .replace(/([+-]\d{2})(\d{2})$/, '$1:$2');
                    parsed = Date.parse(norm);
                  }
                  return Number.isFinite(parsed) ? parsed : 0;
                })();
                if (tsCreated > 0) { next.createdAt = tsCreated; changed = true; }
              }
            }

            return changed ? next : p;
          });

          const changed = updated.some((p, i) => p !== products[i]);
          if (changed) {
            const withCreatedAt = updated.filter(p => p.createdAt).length;
            console.info(`[baza] üìÖ sharedBackfill: createdAt filled=${withCreatedAt}/${updated.length}, changed=${updated.filter((p, i) => p !== products[i]).length} products`);
            setProducts(updated);
          }
        } finally {
          sharedFieldsBackfillRef.current.inFlight = false;
        }
      })();
    }, [products]);

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π
    const searchIndex = React.useMemo(() => {
      const index = new Map();
      products.forEach((product, idx) => {
        const name = (product.name || '').toLowerCase();
        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ –ø–µ—Ä–≤—ã–º –±—É–∫–≤–∞–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
        for (let i = 1; i <= Math.min(name.length, 3); i++) {
          const prefix = name.substring(0, i);
          if (!index.has(prefix)) index.set(prefix, []);
          index.get(prefix).push(idx);
        }
        // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ —Å–ª–æ–≤–∞–º
        name.split(/\s+/).forEach(word => {
          if (word.length > 0) {
            if (!index.has(word)) index.set(word, []);
            index.get(word).push(idx);
          }
        });
      });
      return index;
    }, [products]);

    // –ê–Ω—Ç–∏—Å–ø–∞–º-–∫–ª—é—á –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ personal
    const personalSortLogRef = React.useRef('');

    // –õ–∏–º–∏—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
    const filtered = React.useMemo(() => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º normalizeText –∏–∑ SmartSearch (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
      const normalizeSearchText = window.HEYS?.SmartSearchWithTypos?.utils?.normalizeText
        || ((text) => String(text || '').toLowerCase().replace(/—ë/g, '–µ'));

      const toTs = (v) => {
        if (v == null) return 0;
        if (typeof v === 'number') return v;

        const raw = String(v || '').trim();
        if (!raw) return 0;

        // 1) –ü—Ä–æ–±—É–µ–º –∫–∞–∫ –µ—Å—Ç—å (ISO –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã)
        let parsed = Date.parse(raw);
        if (Number.isFinite(parsed)) return parsed;

        // 2) Fallback –¥–ª—è PostgreSQL timestamptz: "YYYY-MM-DD HH:mm:ss.ffffff+00"
        //    - –ø—Ä–æ–±–µ–ª -> T
        //    - –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã -> –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
        //    - +00 / +0000 / +00:00 –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
        const normalized = raw
          .replace(' ', 'T')
          .replace(/(\.\d{3})\d+/, '$1')
          .replace(/\+00$/, 'Z')
          .replace(/([+-]\d{2})(\d{2})$/, '$1:$2');

        parsed = Date.parse(normalized);
        return Number.isFinite(parsed) ? parsed : 0;
      };
      const sortByCreatedAtDesc = (list) => {
        return [...list].sort((a, b) => {
          // –î–û–õ–ñ–ù–û –ë–´–¢–¨ –ö–ê–ö –í shared: createdAt –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ, –∑–∞—Ç–µ–º updatedAt
          const aTs = toTs(a?.createdAt ?? a?.created_at ?? a?.updatedAt ?? a?.updated_at);
          const bTs = toTs(b?.createdAt ?? b?.created_at ?? b?.updatedAt ?? b?.updated_at);
          return bTs - aTs;
        });
      };

      function performSearch() {
        const q = normalizeSearchText(query.trim());
        if (!q) return sortByCreatedAtDesc(products);

        // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω —É–º–Ω—ã–π –ø–æ–∏—Å–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (window.HEYS && window.HEYS.SmartSearchWithTypos) {
          try {
            const smartResult = window.HEYS.SmartSearchWithTypos.search(q, products, {
              enablePhonetic: true,
              enableSynonyms: true,
              enableTranslit: true, // üÜï —Ä–∞—Ñ–∞ ‚Üí rafa ‚Üí Raffaello
              maxSuggestions: 50
            });

            if (smartResult && smartResult.results && smartResult.results.length > 0) {
              return smartResult.results;
            }
          } catch (error) {
            DEV.warn('[HEYS] –û—à–∏–±–∫–∞ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π:', error);
          }
        }

        if (q.length <= 3) {
          // –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
          const indices = searchIndex.get(q) || [];
          if (indices.length > 0) {
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackDataOperation('cache-hit');
            }
            return indices.map(idx => products[idx]);
          } else {
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackDataOperation('cache-miss');
            }
            return products.filter(p => normalizeSearchText(p.name).includes(q));
          }
        } else {
          // –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
          const candidateIndices = new Set();

          // –ò—â–µ–º –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º –∏ —Å–ª–æ–≤–∞–º
          for (const [key, indices] of searchIndex.entries()) {
            if (key.includes(q) || q.includes(key)) {
              indices.forEach(idx => candidateIndices.add(idx));
            }
          }

          // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö
          if (candidateIndices.size > 0) {
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackDataOperation('cache-hit');
            }
            const candidates = Array.from(candidateIndices).map(idx => products[idx]);
            return candidates.filter(p => normalizeSearchText(p.name).includes(q));
          }

          // Fallback –∫ –æ–±—ã—á–Ω–æ–º—É –ø–æ–∏—Å–∫—É
          if (window.HEYS && window.HEYS.analytics) {
            window.HEYS.analytics.trackDataOperation('cache-miss');
          }
          return products.filter(p => normalizeSearchText(p.name).includes(q));
        }
      }

      // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –∏ —Ç—Ä–µ–∫–∞–µ–º –≤—Ä–µ–º—è
      const startTime = performance.now();
      const result = performSearch();
      const duration = performance.now() - startTime;

      // –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–∏—Å–∫–∞
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackSearch(query, result.length, duration);
      }

      const sortedResult = sortByCreatedAtDesc(result);
      if (!query) {
        const preview = sortedResult.slice(0, 5).map((p, i) => {
          const createdRaw = p?.createdAt ?? p?.created_at ?? null;
          const updatedRaw = p?.updatedAt ?? p?.updated_at ?? null;
          return {
            rank: i + 1,
            name: p?.name || null,
            createdAt: createdRaw,
            updatedAt: updatedRaw,
            sortTs: toTs(createdRaw ?? updatedRaw)
          };
        });

        const top = preview[0] || {};
        const logKey = `${sortedResult.length}|${top.name || ''}|${top.sortTs || 0}`;
        if (personalSortLogRef.current !== logKey) {
          personalSortLogRef.current = logKey;
          console.info('[baza][filter] ‚úÖ Personal sort ‚Äî count:', sortedResult.length);
          preview.forEach(p => {
            const tsFormatted = p.sortTs ? new Date(p.sortTs).toISOString() : 'NO_TS';
            const createdStr = p.createdAt ? String(p.createdAt).slice(0, 19) : '‚Äî';
            const updatedStr = p.updatedAt ? String(p.updatedAt).slice(0, 19) : '‚Äî';
            console.info(`[baza][filter]   #${p.rank} "${p.name}" | created=${createdStr} | updated=${updatedStr} | sortTs=${tsFormatted}`);
          });
        }
      }
      return sortedResult;
    }, [products, query, searchIndex]);

    const personalRanges = React.useMemo(() => buildRangeOptions(filtered.length), [filtered.length]);

    React.useEffect(() => {
      setPersonalRangeStart(0);
      setPersonalRangeActive(false);
    }, [query]);

    React.useEffect(() => {
      if (personalRangeStart >= filtered.length) setPersonalRangeStart(0);
    }, [filtered.length, personalRangeStart]);

    const renderRangeButtons = (ranges, activeStart, onSelect, isActive) => {
      if (!ranges || ranges.length <= 1) return null;
      return React.createElement('div', { className: 'products-range row' },
        React.createElement('span', { className: 'products-range__label muted' }, '–ü–æ–∫–∞–∑–∞—Ç—å:'),
        ranges.map((range) => React.createElement('button', {
          key: `range_${range.start}_${range.end}`,
          className: (isActive && activeStart === range.start) ? 'btn acc products-range__btn' : 'btn products-range__btn',
          onClick: () => onSelect(range.start)
        }, range.label))
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìä UNIFIED: filteredShared ‚Äî –µ–¥–∏–Ω—ã–π useMemo –¥–ª—è shared –¥–∞–Ω–Ω—ã—Ö (–≤–º–µ—Å—Ç–æ inline IIFE)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const filteredShared = React.useMemo(() => {
      const toTs = (v) => {
        if (v == null) return 0;
        if (typeof v === 'number') return v;
        const parsed = Date.parse(v);
        return Number.isFinite(parsed) ? parsed : 0;
      };
      const sortByCreatedAtDesc = (list) => {
        return [...list].sort((a, b) => {
          const aTs = toTs(a?.createdAt ?? a?.created_at ?? a?.updatedAt ?? a?.updated_at);
          const bTs = toTs(b?.createdAt ?? b?.created_at ?? b?.updatedAt ?? b?.updated_at);
          return bTs - aTs;
        });
      };

      const q = (sharedQuery || '').toLowerCase().trim();
      const filtered = q.length >= 2
        ? allSharedProducts.filter(p => (p.name || '').toLowerCase().includes(q))
        : allSharedProducts;

      return sortByCreatedAtDesc(filtered);
    }, [allSharedProducts, sharedQuery]);

    const sharedRanges = React.useMemo(() => buildRangeOptions(filteredShared.length), [filteredShared.length]);

    React.useEffect(() => {
      setSharedRangeStart(0);
      setSharedRangeActive(false);
    }, [sharedQuery, activeSubtab]);

    React.useEffect(() => {
      if (sharedRangeStart >= filteredShared.length) setSharedRangeStart(0);
    }, [filteredShared.length, sharedRangeStart]);

    // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ sync)
    // üîí Ref –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ sync (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ)
    const initialSyncDoneRef = React.useRef(false);

    React.useEffect(() => {
      const handleProductsUpdated = (e) => {
        // üîí –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π heysSyncCompleted ‚Äî products —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (e.type === 'heysSyncCompleted') {
          if (!initialSyncDoneRef.current) {
            initialSyncDoneRef.current = true;
            return;
          }
        }

        const latest = (window.HEYS.store?.get?.('heys_products', null)) ||
          (window.HEYS.utils?.lsGet?.('heys_products', [])) || [];
        let normalizedLatest = applyTombstoneFilter(normalizePersonalProducts(latest));

        if (Array.isArray(normalizedLatest) && normalizedLatest.length > 0) {
          if (window.DEV) {
            window.DEV.log('üì¶ [RATION] Products updated via event:', normalizedLatest.length, 'items');
          }
          // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (race condition –∑–∞—â–∏—Ç–∞)
          setProducts(prev => {
            if (Array.isArray(prev) && prev.length > normalizedLatest.length) {
              if (window.DEV) {
                window.DEV.log('‚ö†Ô∏è [RATION] BLOCKED: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º', prev.length, '‚Üí', normalizedLatest.length);
              }
              return prev;
            }
            // üîí –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ
            if (Array.isArray(prev) && prev.length === normalizedLatest.length) {
              return prev;
            }
            return normalizedLatest;
          });
        }
      };

      const handleProductPatched = (event) => {
        const detail = event?.detail || {};
        const updatedProduct = detail.product || null;
        const updatedId = String(detail.productId ?? updatedProduct?.id ?? updatedProduct?.product_id ?? updatedProduct?.name ?? '');
        if (!updatedId) return;

        setProducts((prev) => {
          if (!Array.isArray(prev) || prev.length === 0) return prev;
          let changed = false;
          const next = prev.map((p) => {
            const pid = String(p?.id ?? p?.product_id ?? p?.name ?? '');
            if (pid !== updatedId) return p;
            const patched = {
              ...p,
              ...(updatedProduct || {})
            };
            if (Array.isArray(detail.portions)) {
              patched.portions = detail.portions;
            }
            changed = true;
            return patched;
          });
          return changed ? next : prev;
        });
      };

      // üîÑ FIX v1.1: –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ heys:orphans-recovered ‚Äî –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è orphan-–ø—Ä–æ–¥—É–∫—Ç–æ–≤
      // –≠—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã ‚Äî recovery –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –≤ localStorage, UI –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ç—è–Ω—É—Ç—å—Å—è
      // ü™¶ FIX v4.9.1: –î–æ–±–∞–≤–ª–µ–Ω–∞ BLOCKED-–∑–∞—â–∏—Ç–∞ ‚Äî –µ—Å–ª–∏ recovery –ø—É—Å—Ç (–≤—Å–µ orphans –±—ã–ª–∏ tombstoned),
      // –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º state —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
      const handleOrphansRecovered = () => {
        const latest = (window.HEYS.store?.get?.('heys_products', null)) ||
          (window.HEYS.utils?.lsGet?.('heys_products', [])) || [];
        const normalizedLatest = applyTombstoneFilter(normalizePersonalProducts(latest));
        if (Array.isArray(normalizedLatest) && normalizedLatest.length > 0) {
          setProducts((prev) => {
            // üõ°Ô∏è BLOCKED-–∑–∞—â–∏—Ç–∞: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º state —á–µ—Ä–µ–∑ orphan recovery
            if (Array.isArray(prev) && prev.length > normalizedLatest.length) {
              console.warn('[RATION] üö´ handleOrphansRecovered BLOCKED: prev=' + prev.length + ' > latest=' + normalizedLatest.length);
              return prev;
            }
            // üõ°Ô∏è –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ (–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ recovery)
            if (Array.isArray(prev) && prev.length === normalizedLatest.length) {
              return prev;
            }
            if (window.DEV) {
              window.DEV.log('üîÑ [RATION] Orphans recovered, updating state:', normalizedLatest.length, 'items');
            }
            return normalizedLatest;
          });
        }
      };

      window.addEventListener('heysProductsUpdated', handleProductsUpdated);
      window.addEventListener('heysSyncCompleted', handleProductsUpdated);
      window.addEventListener('heys:product-updated', handleProductPatched);
      window.addEventListener('heys:product-portions-updated', handleProductPatched);
      window.addEventListener('heys:local-product-updated', handleProductPatched);
      window.addEventListener('heys:orphans-recovered', handleOrphansRecovered);

      return () => {
        window.removeEventListener('heysProductsUpdated', handleProductsUpdated);
        window.removeEventListener('heysSyncCompleted', handleProductsUpdated);
        window.removeEventListener('heys:product-updated', handleProductPatched);
        window.removeEventListener('heys:product-portions-updated', handleProductPatched);
        window.removeEventListener('heys:local-product-updated', handleProductPatched);
        window.removeEventListener('heys:orphans-recovered', handleOrphansRecovered);
      };
    }, []);

    // –ü–æ–¥–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –æ–±–ª–∞–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
    React.useEffect(() => {
      const clientId = window.HEYS && window.HEYS.currentClientId;
      const cloud = window.HEYS && window.HEYS.cloud;
      const getDeduplicatedProducts = (latestProducts) => {
        const safeLatest = Array.isArray(latestProducts) ? latestProducts : [];
        if (window.HEYS?.products?.deduplicate) {
          const before = safeLatest.length;
          const stats = window.HEYS.products.deduplicate();
          const deduped = window.HEYS.products.getAll();
          if (stats?.removed > 0 && Array.isArray(deduped)) return normalizePersonalProducts(deduped);
          if (Array.isArray(deduped) && deduped.length === before) return normalizePersonalProducts(deduped);
        }
        return normalizePersonalProducts(safeLatest);
      };
      if (clientId && cloud && typeof cloud.syncClient === 'function') {
        const startTime = performance.now();
        const need = (typeof cloud.shouldSyncClient === 'function') ? cloud.shouldSyncClient(clientId, 4000) : true;
        if (need) {
          cloud.syncClient(clientId).then(() => {
            const duration = performance.now() - startTime;
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackApiCall('syncClient', duration, true);
              window.HEYS.analytics.trackDataOperation('cloud-sync');
            }
            const latest = (window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || (window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', [])) || [];

            if (window.DEV) {
              window.DEV.log('üîÑ [SYNC] –ü–æ—Å–ª–µ syncClient –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –∏–∑ localStorage:', latest.length, 'items');
              window.DEV.log('üîÑ [SYNC] –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ products:', products.length, 'items');
            }

            // üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ (>1000)
            if (Array.isArray(latest) && latest.length > 1000) {
              // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
              if (window.HEYS.products && window.HEYS.products.deduplicate) {
                window.HEYS.products.deduplicate();
                // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
                const deduplicated = window.HEYS.products.getAll();
                setProducts(Array.isArray(deduplicated) ? deduplicated : []);
                return;
              }
            }

            // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (race condition)
            if (latest.length < products.length) {
              if (window.DEV) {
                window.DEV.log('‚ö†Ô∏è [SYNC] BLOCKED: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º', products.length, '‚Üí', latest.length);
              }
              return;
            }

            if (Array.isArray(latest) && latest.length > 0) {
              if (window.HEYS && window.HEYS.analytics) {
                window.HEYS.analytics.trackDataOperation('products-loaded', latest.length);
              }
            }
            setProducts(applyTombstoneFilter(getDeduplicatedProducts(latest)));
          }).catch((error) => {
            const duration = performance.now() - startTime;
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackApiCall('syncClient', duration, false);
            }
            console.error('Client sync failed:', error);
          });
        } else {
          const latest = (window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || (window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', [])) || [];

          if (window.DEV) {
            window.DEV.log('üîÑ [SYNC] Sync –Ω–µ –Ω—É–∂–µ–Ω, —á–∏—Ç–∞–µ–º –∏–∑ localStorage:', latest.length, 'items');
          }

          // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          if (latest.length < products.length) {
            if (window.DEV) {
              window.DEV.log('‚ö†Ô∏è [SYNC] BLOCKED: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º', products.length, '‚Üí', latest.length);
            }
            return;
          }

          if (Array.isArray(latest) && latest.length > 0) {
            if (window.HEYS && window.HEYS.analytics) {
              window.HEYS.analytics.trackDataOperation('products-loaded', latest.length);
            }
          }
          setProducts(applyTombstoneFilter(getDeduplicatedProducts(latest)));
        }
      } else {
        const latest = (window.HEYS.store && window.HEYS.store.get && window.HEYS.store.get('heys_products', null)) || (window.HEYS.utils && window.HEYS.utils.lsGet && window.HEYS.utils.lsGet('heys_products', [])) || [];

        if (window.DEV) {
          window.DEV.log('üîÑ [SYNC] –ù–µ—Ç cloud/clientId, —á–∏—Ç–∞–µ–º –∏–∑ localStorage:', latest.length, 'items');
        }

        // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        if (latest.length < products.length) {
          if (window.DEV) {
            window.DEV.log('‚ö†Ô∏è [SYNC] BLOCKED: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º', products.length, '‚Üí', latest.length);
          }
          return;
        }

        setProducts(applyTombstoneFilter(getDeduplicatedProducts(latest)));
      }
    }, [window.HEYS && window.HEYS.currentClientId]);

    function resetDraft() { setDraft(INITIAL_DRAFT); setExpandedSections({ base: true, extra: false, vitamins: false, minerals: false, nova: false, flags: false }); }
    async function addProduct() {
      console.group('[baza] ‚ûï addProduct ‚Äî –ù–ê–ß–ê–õ–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø');
      const name = (draft.name || '').trim();
      console.info('[baza] ‚ûï –ò–º—è:', name, '| publishToShared:', publishToShared, '| isCurator:', isCurator);
      if (!name) {
        console.warn('[baza] ‚ûï –û–¢–ú–ï–ù–ê: –ø—É—Å—Ç–æ–µ –∏–º—è');
        console.groupEnd();
        HEYS.Toast?.warning('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞') || alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞');
        return;
      }
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –ª–∏—á–Ω–æ–π –±–∞–∑–µ
      const existingProduct = products.find(p => p.name && p.name.trim().toLowerCase() === name.toLowerCase());
      if (existingProduct) {
        console.warn('[baza] ‚ûï –û–¢–ú–ï–ù–ê: –¥—É–±–ª–∏–∫–∞—Ç –≤ –ª–∏—á–Ω–æ–π –±–∞–∑–µ, id=', existingProduct.id);
        console.groupEnd();
        HEYS.Toast?.warning(`–ü—Ä–æ–¥—É–∫—Ç "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.`) || alert(`–ü—Ä–æ–¥—É–∫—Ç "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ!`);
        return;
      }
      // === –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏ ===
      const base = {
        id: uuid(), name: name, createdAt: Date.now(),
        // –ë–∞–∑–æ–≤—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã
        simple100: toNum(draft.simple100), complex100: toNum(draft.complex100), protein100: toNum(draft.protein100),
        badFat100: toNum(draft.badFat100), goodFat100: toNum(draft.goodFat100), trans100: toNum(draft.trans100),
        fiber100: toNum(draft.fiber100), gi: toNum(draft.gi), harm: toNum(draft.harm),
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã
        sodium100: toNum(draft.sodium100), cholesterol100: toNum(draft.cholesterol100), sugar100: toNum(draft.sugar100),
        omega3_100: toNum(draft.omega3_100), omega6_100: toNum(draft.omega6_100),
        // –í–∏—Ç–∞–º–∏–Ω—ã (% –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã)
        vitaminA: toNum(draft.vitaminA), vitaminC: toNum(draft.vitaminC), vitaminD: toNum(draft.vitaminD),
        vitaminE: toNum(draft.vitaminE), vitaminK: toNum(draft.vitaminK),
        vitaminB1: toNum(draft.vitaminB1), vitaminB2: toNum(draft.vitaminB2), vitaminB3: toNum(draft.vitaminB3),
        vitaminB6: toNum(draft.vitaminB6), vitaminB9: toNum(draft.vitaminB9), vitaminB12: toNum(draft.vitaminB12),
        // –ú–∏–Ω–µ—Ä–∞–ª—ã (% –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã)
        calcium: toNum(draft.calcium), iron: toNum(draft.iron), magnesium: toNum(draft.magnesium),
        phosphorus: toNum(draft.phosphorus), potassium: toNum(draft.potassium), zinc: toNum(draft.zinc),
        selenium: toNum(draft.selenium), iodine: toNum(draft.iodine),
        // NOVA –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞
        novaGroup: toNum(draft.novaGroup) || undefined, // 0 = –∞–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç
        additives: draft.additives ? draft.additives.split(',').map(s => s.trim()).filter(Boolean) : [],
        // –§–ª–∞–≥–∏ –∫–∞—á–µ—Å—Ç–≤–∞
        isOrganic: !!draft.isOrganic, isWholeGrain: !!draft.isWholeGrain,
        isFermented: !!draft.isFermented, isRaw: !!draft.isRaw,
        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        harmNote: (draft.harmNote || '').trim() || undefined,
        category: (draft.category || '').trim() || undefined
      };
      const d = computeDerived(base);
      const newProduct = { ...base, ...d };

      // === –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ shared ===
      if (publishToShared && window.HEYS?.cloud) {
        try {
          // –í—ã—á–∏—Å–ª—è–µ–º fingerprint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
          const fingerprint = window.HEYS?.models?.computeProductFingerprint?.(newProduct);
          if (fingerprint) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ –≤ shared –ø—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º fingerprint (—á–µ—Ä–µ–∑ YandexAPI)
            let existing = null;
            if (window.HEYS.YandexAPI) {
              const { data } = await window.HEYS.YandexAPI.rest('shared_products', {
                select: 'id,name,simple100,complex100,protein100,badfat100,goodfat100,trans100,fiber100,gi,harm',
                'eq.fingerprint': fingerprint,
                limit: 1
              });
              existing = data?.[0] || null;
            }

            if (existing) {
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –º—è–≥–∫–æ–≥–æ merge
              console.info('[baza] ‚ûï fingerprint match ‚Üí merge modal | existing:', existing.id, existing.name);
              console.groupEnd();
              setMergeModal({ show: true, existing, draft: newProduct });
              return; // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –∂–¥—ë–º —Ä–µ—à–µ–Ω–∏—è
            }
          }

          // –ü—É–±–ª–∏–∫—É–µ–º –≤ shared (async, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º)
          if (isCurator) {
            // –ö—É—Ä–∞—Ç–æ—Ä ‚Äî —Å—Ä–∞–∑—É –≤ shared_products
            window.HEYS.cloud.publishToShared?.(newProduct).catch(err => {
              console.error('[SHARED] Failed to publish:', err);
            });
          } else {
            // PIN-–∫–ª–∏–µ–Ω—Ç ‚Äî –≤ pending –æ—á–µ—Ä–µ–¥—å (—á–µ—Ä–µ–∑ YandexAPI)
            const clientId = window.HEYS?.currentClientId;
            if (clientId && fingerprint) {
              const nameNorm = window.HEYS?.models?.normalizeProductName?.(name) || name.toLowerCase().trim();
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase RPC
              if (window.HEYS.YandexAPI) {
                window.HEYS.YandexAPI.createPendingProduct({
                  client_id: clientId,
                  product_data: newProduct,
                  name_norm: nameNorm,
                  fingerprint: fingerprint
                }).catch(err => {
                  console.error('[SHARED] Failed to create pending:', err);
                });
              }
            }
          }
        } catch (err) {
          console.error('[SHARED] Error during publish check:', err);
        }
      }

      const newList = [...products, newProduct];
      console.info('[baza] ‚ûï setProducts: –±—ã–ª–æ', products.length, '‚Üí —Å—Ç–∞–ª–æ', newList.length, '| –Ω–æ–≤—ã–π id:', newProduct.id);
      // ü™¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–µ –≤ tombstone –ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç?
      try {
        const tombstones = window.HEYS?.store?.get?.('heys_deleted_ids') || [];
        if (Array.isArray(tombstones) && tombstones.length > 0) {
          const inTombById = tombstones.find(t => t.id === newProduct.id);
          const inTombByName = tombstones.find(t => t.name === newProduct.name);
          if (inTombById || inTombByName) {
            console.warn('[baza] ‚ûï ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ø—Ä–æ–¥—É–∫—Ç –≤ tombstone!', { byId: !!inTombById, byName: !!inTombByName });
            // –£–±–∏—Ä–∞–µ–º –∏–∑ tombstone —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            const cleaned = tombstones.filter(t => t.id !== newProduct.id && t.name !== newProduct.name);
            window.HEYS.store.set('heys_deleted_ids', cleaned);
            console.info('[baza] ‚ûï ü™¶ tombstone –æ—á–∏—â–µ–Ω –æ—Ç —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, –æ—Å—Ç–∞–ª–æ—Å—å:', cleaned.length);
          } else {
            console.info('[baza] ‚ûï ‚úÖ –ø—Ä–æ–¥—É–∫—Ç –ù–ï –≤ tombstone');
          }
        }
      } catch (_) { }
      setProducts(newList);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –ª–∏ –≤ localStorage?
      setTimeout(() => {
        try {
          const lsCheck = window.HEYS?.store?.get?.('heys_products') || [];
          const found = Array.isArray(lsCheck) && lsCheck.find(p => p.id === newProduct.id);
          console.info('[baza] ‚ûï üîç POST-CHECK (50ms): localStorage length=', lsCheck.length, '| –ø—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω:', !!found);
          if (!found) {
            console.error('[baza] ‚ûï ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ø—Ä–æ–¥—É–∫—Ç –ù–ï —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ localStorage! useEffect guard –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª?');
          }
        } catch (_) { }
      }, 50);
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('products-loaded', 1);
      }
      resetDraft();
      setShowModal(false);
      console.info('[baza] ‚ûï addProduct –ó–ê–í–ï–†–®–Å–ù');
      console.groupEnd();
    }

    /**
     * üÜï v4.8.0: Cascade update meal item names after product rename
     * Updates item.name in all stored days that reference the renamed product
     * @param {string} productId - ID of the renamed product
     * @param {string} oldName - Old product name
     * @param {string} newName - New product name
     * @returns {number} Number of updated items
     */
    function cascadeUpdateMealItemNames(productId, oldName, newName) {
      if (!productId || !oldName || !newName || oldName === newName) return 0;

      let totalUpdated = 0;
      const today = new Date();
      const startDate = new Date(today);
      startDate.setDate(startDate.getDate() - 90); // Last 90 days

      // Iterate through last 90 days
      for (let d = new Date(today); d >= startDate; d.setDate(d.getDate() - 1)) {
        const dateStr = d.toISOString().slice(0, 10);
        const dayKey = `heys_dayv2_${dateStr}`;

        try {
          const dayData = window.HEYS?.store?.get?.(dayKey) || lsGet(dayKey);
          if (!dayData || !Array.isArray(dayData.meals)) continue;

          let dayModified = false;

          dayData.meals.forEach(meal => {
            if (!Array.isArray(meal.items)) return;

            meal.items.forEach(item => {
              // Match by product_id (primary) or by old name (fallback)
              const matchById = item.product_id != null && String(item.product_id).toLowerCase() === String(productId).toLowerCase();
              const matchByName = !matchById && item.name && item.name.trim().toLowerCase() === oldName.trim().toLowerCase();

              if (matchById || matchByName) {
                item.name = newName;
                dayModified = true;
                totalUpdated++;
              }
            });
          });

          if (dayModified) {
            dayData.updatedAt = Date.now();
            if (window.HEYS?.store?.set) {
              window.HEYS.store.set(dayKey, dayData);
            } else {
              lsSet(dayKey, dayData);
            }
          }
        } catch (err) {
          console.warn('[CASCADE] Error updating day', dateStr, err);
        }
      }

      if (totalUpdated > 0) {
        window.DEV?.log?.(`[CASCADE] Updated ${totalUpdated} meal items from "${oldName}" to "${newName}"`);
        // Dispatch event for UI refresh
        window.dispatchEvent(new CustomEvent('heys:meals-updated', { detail: { reason: 'product-rename', productId, oldName, newName } }));
      }

      return totalUpdated;
    }

    function updateRow(id, patch) {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏
      if (patch.name !== undefined) {
        const newName = (patch.name || '').trim();
        if (!newName) {
          HEYS.Toast?.warning('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º') || alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
          return;
        }
        const existingProduct = products.find(p => p.id !== id && p.name && p.name.trim().toLowerCase() === newName.toLowerCase());
        if (existingProduct) {
          HEYS.Toast?.warning(`–ü—Ä–æ–¥—É–∫—Ç "${newName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ!`) || alert(`–ü—Ä–æ–¥—É–∫—Ç "${newName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!`);
          return;
        }
        patch.name = newName;

        // üÜï v4.8.0: Cascade update meal item names
        const currentProduct = products.find(p => p.id === id);
        if (currentProduct && currentProduct.name !== newName) {
          cascadeUpdateMealItemNames(id, currentProduct.name, newName);
        }
      }
      // üÜï v4.8.1: Mark as user_modified to prevent shared product overwrite
      setProducts(products.map(p => {
        if (p.id !== id) return p;
        const changed = { ...p, ...patch, user_modified: true, modified_at: Date.now() };
        const d = computeDerived(changed);
        return { ...changed, ...d };
      }));
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('storage-op');
      }
    }
    function openProductNameEditor(product) {
      if (!product) return;
      const currentName = (product.name || '').trim();

      if (window.HEYS?.StepModal?.show) {
        const stepId = 'edit_product_name';
        window.HEYS.StepModal.show({
          steps: [
            {
              id: stepId,
              title: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞',
              hint: '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ',
              icon: '‚úèÔ∏è',
              getInitialData: () => ({ name: currentName }),
              validate: (data) => {
                const newName = (data?.name || '').trim();
                if (!newName) return false;
                const exists = products.find(p => p.id !== product.id && p.name && p.name.trim().toLowerCase() === newName.toLowerCase());
                return !exists;
              },
              getValidationMessage: (data) => {
                const newName = (data?.name || '').trim();
                if (!newName) return '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞';
                const exists = products.find(p => p.id !== product.id && p.name && p.name.trim().toLowerCase() === newName.toLowerCase());
                if (exists) return `–ü—Ä–æ–¥—É–∫—Ç "${newName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`;
                return null;
              },
              component: function EditProductNameStep({ data, onChange }) {
                return React.createElement('div', { className: 'mc-form' },
                  React.createElement('label', { className: 'mc-label' }, '–ù–∞–∑–≤–∞–Ω–∏–µ'),
                  React.createElement('input', {
                    className: 'mc-input',
                    value: data?.name || '',
                    onChange: (e) => onChange({ name: e.target.value })
                  })
                );
              }
            }
          ],
          showProgress: false,
          showGreeting: false,
          showStreak: false,
          showTip: false,
          allowSwipe: false,
          finishLabel: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
          onComplete: (stepData) => {
            const newName = (stepData?.[stepId]?.name || '').trim();
            if (newName && newName !== currentName) {
              updateRow(product.id, { name: newName });
            }
          }
        });
        return;
      }

      const fallbackName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞', currentName);
      if (fallbackName !== null) {
        updateRow(product.id, { name: fallbackName });
      }
    }
    function openPortionsEditor(product) {
      if (!product) return;
      if (!window.HEYS?.StepModal || !window.HEYS?.AddProductStep?.PortionsStep) {
        HEYS.Toast?.warning('–ú–æ–¥–∞–ª–∫–∞ –ø–æ—Ä—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') || alert('–ú–æ–¥–∞–ª–∫–∞ –ø–æ—Ä—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        return;
      }

      window.HEYS.StepModal.show({
        steps: [
          {
            id: 'portions',
            title: '–ü–æ—Ä—Ü–∏–∏',
            hint: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä—Ü–∏–∏',
            icon: 'ü•£',
            component: window.HEYS.AddProductStep.PortionsStep,
            validate: () => true,
            hideHeaderNext: true,
            getInitialData: () => ({
              selectedProduct: product,
              portions: product.portions || []
            })
          }
        ],
        context: {
          isEditMode: true,
          editProduct: product,
          onFinish: ({ portions }) => {
            updateRow(product.id, { portions: portions || [] });
          }
        },
        showGreeting: false,
        showStreak: false,
        showTip: false,
        showProgress: false,
        allowSwipe: false,
        hidePrimaryOnFirst: true,
        title: ''
      });
    }
    async function updateSharedProductPortions(productId, portions) {
      if (!window.HEYS?.YandexAPI?.rest) {
        HEYS.Toast?.warning('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è') || alert('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        return { ok: false };
      }

      try {
        const { error } = await window.HEYS.YandexAPI.rest('shared_products', {
          method: 'PATCH',
          data: { portions },
          filters: { 'eq.id': productId },
          select: 'id,portions'
        });

        if (error) {
          HEYS.Toast?.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error) || alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error);
          return { ok: false };
        }

        setAllSharedProducts(prev => prev.map(p => p.id === productId ? { ...p, portions } : p));
        HEYS.Toast?.success('–ü–æ—Ä—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã') || alert('–ü–æ—Ä—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        return { ok: true };
      } catch (e) {
        const msg = e?.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
        HEYS.Toast?.error(msg) || alert(msg);
        return { ok: false };
      }
    }
    function openSharedPortionsEditor(product) {
      if (!product) return;
      if (!window.HEYS?.StepModal || !window.HEYS?.AddProductStep?.PortionsStep) {
        HEYS.Toast?.warning('–ú–æ–¥–∞–ª–∫–∞ –ø–æ—Ä—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') || alert('–ú–æ–¥–∞–ª–∫–∞ –ø–æ—Ä—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        return;
      }

      window.HEYS.StepModal.show({
        steps: [
          {
            id: 'portions',
            title: '–ü–æ—Ä—Ü–∏–∏',
            hint: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä—Ü–∏–∏',
            icon: 'ü•£',
            component: window.HEYS.AddProductStep.PortionsStep,
            validate: () => true,
            hideHeaderNext: true,
            getInitialData: () => ({
              selectedProduct: product,
              portions: product.portions || []
            })
          }
        ],
        context: {
          isEditMode: true,
          editProduct: product,
          onFinish: async ({ portions }) => {
            await updateSharedProductPortions(product.id, portions || []);
          }
        },
        showGreeting: false,
        showStreak: false,
        showTip: false,
        showProgress: false,
        allowSwipe: false,
        hidePrimaryOnFirst: true,
        title: ''
      });
    }
    function deleteRow(id) {
      console.group('[baza] üóëÔ∏è deleteRow ‚Äî –ù–ê–ß–ê–õ–û –£–î–ê–õ–ï–ù–ò–Ø –∏–∑ –ª–∏—á–Ω–æ–π –±–∞–∑—ã');
      console.info('[baza] üéØ id –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', id);

      // üî¥ GUARD: –µ—Å–ª–∏ id –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º, –∏–Ω–∞—á–µ —É–¥–∞–ª–∏–º –í–°–ï–• —É –∫–æ–≥–æ id=undefined
      if (id === undefined || id === null || id === '') {
        console.error('[baza] ‚ùå –û–¢–ú–ï–ù–ê deleteRow: –ø–µ—Ä–µ–¥–∞–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π id =', id, '‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ!');
        console.error('[baza] ‚ùå –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —É –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ—Ç –ø–æ–ª—è id. –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è localStorage.');
        console.groupEnd();
        return;
      }

      // --- –®–ê–ì 1: –Ω–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç –≤ state ---
      const targetProduct = products.find(p => p.id === id);
      console.info('[baza] üì¶ –®–ê–ì–ò 1/7 ‚Äî –ü—Ä–æ–¥—É–∫—Ç –Ω–∞–π–¥–µ–Ω –≤ state:', targetProduct
        ? { id: targetProduct.id, name: targetProduct.name, kcal100: targetProduct.kcal100, protein100: targetProduct.protein100 }
        : '‚ùå –ù–ï –ù–ê–ô–î–ï–ù (id –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –Ω–∏ —Å –æ–¥–Ω–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º!)');
      console.info('[baza] üìä –¢–µ–∫—É—â–∏–π React state: products.length =', products.length);

      // --- –®–ê–ì 2: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è ---
      const filtered = products.filter(p => p.id !== id);
      console.info('[baza] ‚úÇÔ∏è –®–ê–ì 2/7 ‚Äî –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', filtered.length, '–ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–±—ã–ª–æ:', products.length, ', —É–¥–∞–ª–µ–Ω–æ:', products.length - filtered.length, ')');
      if (products.length === filtered.length) {
        console.warn('[baza] ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å! –ü—Ä–æ–¥—É–∫—Ç —Å id', id, '–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ products[]');
      }

      // --- –®–ê–ì 3: localStorage –î–û –∑–∞–ø–∏—Å–∏ ---
      // üõ°Ô∏è v4.8.8: –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º. –ï—Å–ª–∏ localStorage –ø–æ–ª–æ–Ω, –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å,
      // –∏ React state –æ–±–Ω–æ–≤–∏—Ç—Å—è, –Ω–æ –¥–∏—Å–∫ ‚Äî –Ω–µ—Ç. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–¥—É–∫—Ç –≤–µ—Ä–Ω—ë—Ç—Å—è.
      try {
        const testKey = '__test_storage_quota__';
        localStorage.setItem(testKey, '1');
        localStorage.removeItem(testKey);
      } catch (e) {
        console.warn('[baza] ‚ö†Ô∏è localStorage –ü–û–õ–û–ù –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º ‚Äî –ø—Ä–æ–±—É–µ–º –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ...', e);
        // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–∑–≤–∞—Ç—å aggressiveCleanup –∏–∑ storage —Å–ª–æ—è
        if (window.HEYS?.cloud?.cleanupStorage) {
          window.HEYS.cloud.cleanupStorage(30); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–Ω–∏ (>30 –¥–Ω–µ–π)
          console.info('[baza] üßπ Cleanup executed to free space for deletion');
        }
      }

      const lsBefore = (window.HEYS?.store?.get?.('heys_products', null))
        || (window.HEYS?.utils?.lsGet?.('heys_products', null));
      console.info('[baza] üíæ –®–ê–ì 3/7 ‚Äî localStorage –î–û –∑–∞–ø–∏—Å–∏:', Array.isArray(lsBefore) ? lsBefore.length + ' –ø—Ä–æ–¥—É–∫—Ç–æ–≤' : '‚ö†Ô∏è null/–Ω–µ –º–∞—Å—Å–∏–≤');

      // --- –®–ê–ì 4: —Ñ–ª–∞–≥ intentionalDelete ---
      if (window.HEYS) {
        window.HEYS._intentionalProductDelete = true;
        console.info('[baza] üö© –®–ê–ì 4/7 ‚Äî –§–ª–∞–≥ _intentionalProductDelete —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: true');
      } else {
        console.warn('[baza] ‚ö†Ô∏è –®–ê–ì 4/7 ‚Äî window.HEYS –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω! –§–ª–∞–≥ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
      }

      // --- –®–ê–ì 5: —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ localStorage ---
      let lsWriteMethod = 'none';
      // üî¥ FIX: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –°–ò–ù–•–†–û–ù–ù–û –ø–µ—Ä–µ–¥ setProducts,
      // –∏–Ω–∞—á–µ –≥–æ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π: handleProductsUpdated —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ä—ã–π localStorage (N)
      // –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –∏–∑-–∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ "–Ω–µ —É–º–µ–Ω—å—à–∞–µ–º"
      if (window.HEYS) {
        if (window.HEYS.store && typeof window.HEYS.store.set === 'function') {
          window.HEYS.store.set('heys_products', filtered);
          lsWriteMethod = 'HEYS.store.set';
        } else if (window.HEYS.utils && typeof window.HEYS.utils.lsSet === 'function') {
          window.HEYS.utils.lsSet('heys_products', filtered);
          lsWriteMethod = 'HEYS.utils.lsSet';
        }
      }
      const lsAfter = (window.HEYS?.store?.get?.('heys_products', null))
        || (window.HEYS?.utils?.lsGet?.('heys_products', null));
      console.info('[baza] üíæ –®–ê–ì 5/7 ‚Äî localStorage –ü–û–°–õ–ï –∑–∞–ø–∏—Å–∏:', {
        –º–µ—Ç–æ–¥: lsWriteMethod,
        –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: Array.isArray(lsAfter) ? lsAfter.length : '‚ö†Ô∏è null',
        —Å–æ–≤–ø–∞–¥–∞–µ—Ç_—Å_filtered: Array.isArray(lsAfter) && lsAfter.length === filtered.length ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢',
      });
      if (Array.isArray(lsAfter) && lsAfter.find(p => p.id === id)) {
        console.error('[baza] ‚ùå –ö–†–ò–¢–ò–ß–ù–û: —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –í–°–Å –ï–©–Å –µ—Å—Ç—å –≤ localStorage! id=', id);
      } else {
        console.info('[baza] ‚úÖ –£–¥–∞–ª—ë–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ localStorage');
      }

      // --- –®–ê–ì 5.5: tombstone ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç cloud-sync resurrection ---
      // ü™¶ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º id+name —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫ tombstones.
      // handleProductsUpdated —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç tombstoned –ø—Ä–æ–¥—É–∫—Ç—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º cloud sync —Å–æ–±—ã—Ç–∏–∏,
      // –ø–æ—ç—Ç–æ–º—É –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±–ª–∞–∫–æ –≤–µ—Ä–Ω—ë—Ç –ø—Ä–æ–¥—É–∫—Ç –ø—Ä–∏ refresh ‚Äî –æ–Ω –±—É–¥–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω.
      try {
        const tombstoneKey = 'heys_deleted_ids';
        const existing = window.HEYS?.store?.get?.(tombstoneKey) || [];
        const validExisting = Array.isArray(existing) ? existing : [];
        const fingerprint = {
          id: targetProduct?.id ?? id,
          name: targetProduct?.name ?? null,
          ts: Date.now()
        };
        // –õ–∏–º–∏—Ç: —Ö—Ä–∞–Ω–∏–º –Ω–µ –±–æ–ª—å—à–µ 200 tombstones (—Å—Ç–∞—Ä—ã–µ ‚Äî –ø–µ—Ä–≤—ã–º–∏ –≤—ã—Ç–µ—Å–Ω—è–µ–º)
        const updated = [...validExisting.filter(t => t.id !== id), fingerprint].slice(-200);
        if (window.HEYS?.store?.set) {
          window.HEYS.store.set(tombstoneKey, updated);
          console.info('[baza] ü™¶ –®–ê–ì 5.5/7 ‚Äî tombstone –∑–∞–ø–∏—Å–∞–Ω:', { id: fingerprint.id, name: fingerprint.name, total_tombstones: updated.length });
        } else {
          console.warn('[baza] ‚ö†Ô∏è –®–ê–ì 5.5/7 ‚Äî tombstone: HEYS.store.set –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, tombstone –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
        }
        // üîó FIX: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å HEYS.deletedProducts —á—Ç–æ–±—ã mergeProductsData —Ç–æ–∂–µ –∑–Ω–∞–ª–∞ –æ deletion.
        // deleteRow –ø–∏—Å–∞–ª —Ç–æ–ª—å–∫–æ –≤ heys_deleted_ids, –∞ mergeProductsData –ø—Ä–æ–≤–µ—Ä—è–µ—Ç HEYS.deletedProducts.isProductDeleted()
        // ‚Üí –±–µ–∑ —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞ cloud merge –Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª —É–¥–∞–ª—ë–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã ‚Üí resurrection –ø—Ä–∏ refresh.
        if (window.HEYS?.deletedProducts?.add && fingerprint.name) {
          window.HEYS.deletedProducts.add(fingerprint.name, fingerprint.id);
          console.info('[baza] üîó –®–ê–ì 5.5/7 ‚Äî deletedProducts.add —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω (–∑–∞—â–∏—Ç–∞ –æ—Ç merge-resurrection):', fingerprint.name);
        }
      } catch (te) {
        console.warn('[baza] ‚ö†Ô∏è –®–ê–ì 5.5/7 ‚Äî tombstone save error:', te.message);
      }

      // --- –®–ê–ì 6: setProducts ---
      console.info('[baza] ‚öõÔ∏è –®–ê–ì 6/7 ‚Äî –í—ã–∑–æ–≤ setProducts(filtered) ‚Äî React state –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ');
      setProducts(filtered);

      // --- –®–ê–ì 7: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ---
      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('storage-op');
        console.info('[baza] üìà –®–ê–ì 7/7 ‚Äî analytics.trackDataOperation("storage-op") –≤—ã–∑–≤–∞–Ω');
      } else {
        console.info('[baza] ‚ÑπÔ∏è –®–ê–ì 7/7 ‚Äî analytics –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—â–µ–Ω–æ');
      }

      console.info('[baza] ‚úÖ deleteRow –ó–ê–í–ï–†–®–Å–ù ‚Äî –∏—Ç–æ–≥:', {
        —É–¥–∞–ª—ë–Ω–Ω—ã–π_id: id,
        —É–¥–∞–ª—ë–Ω–Ω—ã–π_–ø—Ä–æ–¥—É–∫—Ç: targetProduct?.name ?? '‚ùå –Ω–µ –Ω–∞–π–¥–µ–Ω',
        –±—ã–ª–æ: products.length,
        —Å—Ç–∞–ª–æ: filtered.length,
        localStorage_–æ–±–Ω–æ–≤–ª—ë–Ω: lsWriteMethod !== 'none' ? '‚úÖ' : '‚ùå',
      });
      console.groupEnd();
    }
    // üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –ª–∏—á–Ω–æ–π –±–∞–∑—ã –≤ –æ–±—â—É—é
    async function syncProductToShared(localProduct) {
      if (!localProduct) return;
      const normalizeProductName = HEYS.models?.normalizeProductName
        || ((name) => String(name || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));

      let sharedId = localProduct.shared_origin_id ?? localProduct.sharedOriginId ?? localProduct.shared_id ?? localProduct.sharedId;
      let matchedShared = null;

      const findSharedByName = (list) => {
        if (!Array.isArray(list)) return null;
        const nameKey = normalizeProductName(localProduct?.name);
        if (!nameKey) return null;
        return list.find((sp) => normalizeProductName(sp?.name) === nameKey) || null;
      };

      if (!sharedId) {
        const cached = window.HEYS?.cloud?.getCachedSharedProducts?.() || allSharedProducts || [];
        matchedShared = findSharedByName(cached);
        if (!matchedShared && window.HEYS?.cloud?.getAllSharedProducts) {
          try {
            const result = await window.HEYS.cloud.getAllSharedProducts({ limit: 500 });
            if (result?.data) {
              setAllSharedProducts(result.data);
              matchedShared = findSharedByName(result.data);
            }
          } catch (err) {
            console.warn('[SYNC SHARED] Load shared failed:', err);
          }
        }
        if (matchedShared?.id != null) {
          sharedId = matchedShared.id;
        }
      }

      if (!sharedId) {
        HEYS.Toast?.warning('–ù–µ—Ç —Å–≤—è–∑–∏ —Å –æ–±—â–µ–π –±–∞–∑–æ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞') || alert('–ù–µ—Ç —Å–≤—è–∑–∏ —Å –æ–±—â–µ–π –±–∞–∑–æ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞');
        return;
      }
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ shared (snake_case)
      const productForShared = {
        ...localProduct,
        id: sharedId,
        sodium100: localProduct.sodium100 ?? localProduct.Na ?? null,
        omega3_100: localProduct.omega3_100 ?? localProduct['Œ©3'] ?? null,
        omega6_100: localProduct.omega6_100 ?? localProduct['Œ©6'] ?? null,
        nova_group: localProduct.nova_group ?? localProduct.novaGroup ?? null,
        nutrient_density: localProduct.nutrient_density ?? localProduct.nutrientDensity ?? null,
        is_organic: localProduct.is_organic ?? localProduct.isOrganic ?? false,
        is_whole_grain: localProduct.is_whole_grain ?? localProduct.isWholeGrain ?? false,
        is_fermented: localProduct.is_fermented ?? localProduct.isFermented ?? false,
        is_raw: localProduct.is_raw ?? localProduct.isRaw ?? false,
        vitamin_a: localProduct.vitamin_a ?? localProduct.vitaminA ?? null,
        vitamin_c: localProduct.vitamin_c ?? localProduct.vitaminC ?? null,
        vitamin_d: localProduct.vitamin_d ?? localProduct.vitaminD ?? null,
        vitamin_e: localProduct.vitamin_e ?? localProduct.vitaminE ?? null,
        vitamin_k: localProduct.vitamin_k ?? localProduct.vitaminK ?? null,
        vitamin_b1: localProduct.vitamin_b1 ?? localProduct.vitaminB1 ?? null,
        vitamin_b2: localProduct.vitamin_b2 ?? localProduct.vitaminB2 ?? null,
        vitamin_b3: localProduct.vitamin_b3 ?? localProduct.vitaminB3 ?? null,
        vitamin_b6: localProduct.vitamin_b6 ?? localProduct.vitaminB6 ?? null,
        vitamin_b9: localProduct.vitamin_b9 ?? localProduct.vitaminB9 ?? null,
        vitamin_b12: localProduct.vitamin_b12 ?? localProduct.vitaminB12 ?? null
      };
      try {
        if (HEYS.AddProductStep?.updateSharedProduct) {
          const result = await HEYS.AddProductStep.updateSharedProduct(productForShared, sharedId);
          if (result?.ok) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç ‚Äî —É–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            setProducts(prev => prev.map(p => p.id === localProduct.id ? { ...p, _syncedAt: Date.now() } : p));
          }
        } else {
          HEYS.Toast?.error('–§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') || alert('–§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        }
      } catch (e) {
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + e.message) || alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }
    async function importAppend() {
      DEV.log('üîç [IMPORT] –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –≤ —Ä–µ–∂–∏–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
      DEV.log('üìã [IMPORT] –¢–µ–∫—Å—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:', paste.substring(0, 200) + '...');
      DEV.log('üìä [IMPORT] –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', paste.length);

      const startTime = performance.now();
      let rows = [];
      try {
        DEV.log('üîÑ [IMPORT] –í—ã–∑—ã–≤–∞–µ–º parsePasted...');
        rows = await parsePasted(paste);
        DEV.log('‚úÖ [IMPORT] parsePasted –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        DEV.log('üìà [IMPORT] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫:', rows.length);
        DEV.log('üìù [IMPORT] –ü–µ—Ä–≤—ã–µ 3 –ø—Ä–æ–¥—É–∫—Ç–∞:', rows.slice(0, 3));

        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, true);
        }
      } catch (e) {
        console.error('‚ùå [IMPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:', e);
        console.error('üìÑ [IMPORT] Stack trace:', e.stack);

        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, false);
        }
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message) || alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message);
        return;
      }

      if (!rows.length) {
        DEV.warn('‚ö†Ô∏è [IMPORT] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
        DEV.log('üìÑ [IMPORT] –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:', paste);
        HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ') || alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
        return;
      }

      DEV.log('üíæ [IMPORT] –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º');
      DEV.log('üìä [IMPORT] –ë—ã–ª–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', products.length);
      DEV.log('üìä [IMPORT] –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', rows.length);

      const newProducts = [...products, ...rows];
      DEV.log('üì¶ [IMPORT] –ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤ products:', newProducts.length, 'items');

      setProducts(newProducts);

      DEV.log('‚úÖ [IMPORT] –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');

      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('products-loaded', rows.length);
      }
    }
    async function importReplace() {
      DEV.log('üîç [IMPORT] –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –≤ —Ä–µ–∂–∏–º–µ –∑–∞–º–µ–Ω—ã');
      DEV.log('üìã [IMPORT] –¢–µ–∫—Å—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:', paste.substring(0, 200) + '...');
      DEV.log('üìä [IMPORT] –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', paste.length);

      const startTime = performance.now();
      let rows = [];
      try {
        DEV.log('üîÑ [IMPORT] –í—ã–∑—ã–≤–∞–µ–º parsePasted...');
        rows = await parsePasted(paste);
        DEV.log('‚úÖ [IMPORT] parsePasted –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        DEV.log('üìà [IMPORT] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫:', rows.length);
        DEV.log('üìù [IMPORT] –ü–µ—Ä–≤—ã–µ 3 –ø—Ä–æ–¥—É–∫—Ç–∞:', rows.slice(0, 3));

        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, true);
        }
      } catch (e) {
        console.error('‚ùå [IMPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:', e);
        console.error('üìÑ [IMPORT] Stack trace:', e.stack);

        const duration = performance.now() - startTime;
        if (window.HEYS && window.HEYS.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, false);
        }
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message) || alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message);
        return;
      }

      if (!rows.length) {
        DEV.warn('‚ö†Ô∏è [IMPORT] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
        DEV.log('üìÑ [IMPORT] –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:', paste);
        HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ') || alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
        return;
      }

      if (window.HEYS && window.HEYS.backupManager && typeof window.HEYS.backupManager.backupAll === 'function') {
        try {
          await window.HEYS.backupManager.backupAll({
            reason: 'import_replace',
            keys: ['heys_products'],
            includeDays: false,
            silent: true,
          });
        } catch (backupError) {
          console.error('‚ö†Ô∏è [IMPORT] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π:', backupError);
        }
      }

      DEV.log('üíæ [IMPORT] –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã');
      DEV.log('üìä [IMPORT] –ë—ã–ª–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', products.length);
      DEV.log('üìä [IMPORT] –ù–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', rows.length);

      setProducts(rows);

      DEV.log('‚úÖ [IMPORT] –ó–∞–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');

      if (window.HEYS && window.HEYS.analytics) {
        window.HEYS.analytics.trackDataOperation('products-loaded', rows.length);
      }
    }

    // –£–º–Ω—ã–π –∏–º–ø–æ—Ä—Ç: –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    async function importMerge() {
      DEV.log('üîç [IMPORT] –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –≤ —Ä–µ–∂–∏–º–µ —Å–ª–∏—è–Ω–∏—è (merge)');
      DEV.log('üìã [IMPORT] –¢–µ–∫—Å—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:', paste.substring(0, 200) + '...');

      const startTime = performance.now();
      let rows = [];
      try {
        rows = await parsePasted(paste);
        DEV.log('‚úÖ [IMPORT] parsePasted –∑–∞–≤–µ—Ä—à–µ–Ω, —Å—Ç—Ä–æ–∫:', rows.length);

        const duration = performance.now() - startTime;
        if (window.HEYS?.analytics) {
          window.HEYS.analytics.trackApiCall('parsePasted', duration, true);
        }
      } catch (e) {
        console.error('‚ùå [IMPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:', e);
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message) || alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message);
        return;
      }

      if (!rows.length) {
        HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ') || alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
        return;
      }

      // –°–æ–∑–¥–∞—ë–º Map —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
      const normalize = (name) => (name || '').trim().toLowerCase();
      const existingMap = new Map();
      products.forEach((p, idx) => {
        existingMap.set(normalize(p.name), { product: p, index: idx });
      });

      let updated = 0;
      let added = 0;
      const newProducts = [...products]; // –ö–æ–ø–∏—è –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏

      for (const row of rows) {
        const key = normalize(row.name);
        const existing = existingMap.get(key);

        if (existing) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–¥—É–∫—Ç (—Å–æ—Ö—Ä–∞–Ω—è–µ–º id)
          newProducts[existing.index] = {
            ...existing.product,
            ...row,
            id: existing.product.id // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π id
          };
          updated++;
          DEV.log(`üîÑ [MERGE] –û–±–Ω–æ–≤–ª—ë–Ω: ${row.name}`);
        } else {
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç
          newProducts.push(row);
          added++;
          DEV.log(`‚ûï [MERGE] –î–æ–±–∞–≤–ª–µ–Ω: ${row.name}`);
        }
      }

      setProducts(newProducts);

      DEV.log(`‚úÖ [IMPORT] –°–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: +${added} –Ω–æ–≤—ã—Ö, ‚Üª${updated} –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);
      HEYS.Toast?.success(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω: +${added} –Ω–æ–≤—ã—Ö, ${updated} –æ–±–Ω–æ–≤–ª–µ–Ω–æ`) || alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!`);

      if (window.HEYS?.analytics) {
        window.HEYS.analytics.trackDataOperation('products-merged', rows.length);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    function exportProductsOnly() {
      if (!products || products.length === 0) {
        HEYS.Toast?.warning('–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞') || alert('–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }

      const exportData = {
        exportedAt: new Date().toISOString(),
        type: 'products_only',
        count: products.length,
        products: products
      };

      const clientId = localStorage.getItem('heys_client_current') || 'unknown';
      const cleanClientId = clientId.replace(/"/g, '').slice(0, 8);
      const fileName = `heys-products-${cleanClientId}-${new Date().toISOString().slice(0, 10)}.json`;

      const downloadJSON = window.HEYS?.ExportUtils?.downloadJSON;
      if (downloadJSON) {
        downloadJSON({ data: exportData, fileName });
      } else {
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      DEV.log(`‚úÖ [EXPORT] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ ${fileName}`);
      HEYS.Toast?.success(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤!`) || alert(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤!`);
    }

    async function exportSharedProductsForAI() {
      try {
        let sharedProducts = HEYS.cloud?.getCachedSharedProducts?.() || [];
        if (!sharedProducts || sharedProducts.length === 0) {
          if (HEYS.YandexAPI?.rest) {
            HEYS.Toast?.info('–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é –±–∞–∑—É‚Ä¶') || alert('–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é –±–∞–∑—É‚Ä¶');
            const { data, error } = await HEYS.YandexAPI.rest('shared_products');
            if (error) {
              HEYS.Toast?.warning('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â—É—é –±–∞–∑—É') || alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â—É—é –±–∞–∑—É');
              return;
            }
            sharedProducts = Array.isArray(data) ? data : [];
          }
        }

        if (!sharedProducts || sharedProducts.length === 0) {
          HEYS.Toast?.warning('–û–±—â–∞—è –±–∞–∑–∞ –ø—É—Å—Ç–∞') || alert('–û–±—â–∞—è –±–∞–∑–∞ –ø—É—Å—Ç–∞');
          return;
        }

        setSharedExportCount(sharedProducts.length);

        const fieldDescriptions = window.HEYS?.SharedProductsExportFields?.getFieldDescriptions?.() || {};

        const normalizeValue = (obj, camel, snake) => {
          if (!obj) return null;
          if (obj[camel] !== undefined) return obj[camel];
          if (snake && obj[snake] !== undefined) return obj[snake];
          return null;
        };

        const normalizedProducts = sharedProducts.map((p) => ({
          id: p.id ?? null,
          name: p.name ?? null,
          simple100: normalizeValue(p, 'simple100'),
          complex100: normalizeValue(p, 'complex100'),
          protein100: normalizeValue(p, 'protein100'),
          badFat100: normalizeValue(p, 'badFat100', 'badfat100'),
          goodFat100: normalizeValue(p, 'goodFat100', 'goodfat100'),
          trans100: normalizeValue(p, 'trans100'),
          fiber100: normalizeValue(p, 'fiber100'),
          gi: normalizeValue(p, 'gi'),
          harm: HEYS.models?.normalizeHarm?.(p) ?? p.harm ?? p.harmScore ?? null,
          category: p.category ?? null,
          portions: p.portions ?? null,
          sodium100: normalizeValue(p, 'sodium100'),
          nova_group: normalizeValue(p, 'nova_group', 'novaGroup'),
          vitamin_a: normalizeValue(p, 'vitamin_a', 'vitaminA'),
          vitamin_c: normalizeValue(p, 'vitamin_c', 'vitaminC'),
          vitamin_d: normalizeValue(p, 'vitamin_d', 'vitaminD'),
          vitamin_e: normalizeValue(p, 'vitamin_e', 'vitaminE'),
          vitamin_k: normalizeValue(p, 'vitamin_k', 'vitaminK'),
          vitamin_b1: normalizeValue(p, 'vitamin_b1', 'vitaminB1'),
          vitamin_b2: normalizeValue(p, 'vitamin_b2', 'vitaminB2'),
          vitamin_b3: normalizeValue(p, 'vitamin_b3', 'vitaminB3'),
          vitamin_b6: normalizeValue(p, 'vitamin_b6', 'vitaminB6'),
          vitamin_b9: normalizeValue(p, 'vitamin_b9', 'vitaminB9'),
          vitamin_b12: normalizeValue(p, 'vitamin_b12', 'vitaminB12'),
          calcium: normalizeValue(p, 'calcium'),
          iron: normalizeValue(p, 'iron'),
          magnesium: normalizeValue(p, 'magnesium'),
          phosphorus: normalizeValue(p, 'phosphorus'),
          potassium: normalizeValue(p, 'potassium'),
          zinc: normalizeValue(p, 'zinc'),
          selenium: normalizeValue(p, 'selenium'),
          iodine: normalizeValue(p, 'iodine'),
          is_organic: normalizeValue(p, 'is_organic', 'isOrganic'),
          is_whole_grain: normalizeValue(p, 'is_whole_grain', 'isWholeGrain'),
          is_fermented: normalizeValue(p, 'is_fermented', 'isFermented'),
          is_raw: normalizeValue(p, 'is_raw', 'isRaw'),
        }));

        const exportData = {
          _meta: {
            description: '–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã HEYS –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ò–ò',
            total_products: normalizedProducts.length,
            export_date: new Date().toISOString().slice(0, 10),
            field_descriptions: fieldDescriptions,
          },
          products: normalizedProducts,
        };

        const buildDatedFileName = window.HEYS?.ExportUtils?.buildDatedFileName;
        const fileName = buildDatedFileName
          ? buildDatedFileName('heys-shared-products')
          : `heys-shared-products-${new Date().toISOString().slice(0, 10)}.json`;
        const downloadJSON = window.HEYS?.ExportUtils?.downloadJSON;
        if (downloadJSON) {
          downloadJSON({ data: exportData, fileName });
        } else {
          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        HEYS.Toast?.success(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${normalizedProducts.length} –æ–±—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`) || alert(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${normalizedProducts.length} –æ–±—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`);
      } catch (err) {
        HEYS.analytics?.trackError?.(err, { context: 'ration:exportSharedProductsForAI' });
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ–±—â–µ–π –±–∞–∑—ã') || alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ–±—â–µ–π –±–∞–∑—ã');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (–¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
    async function restoreFromSharedBase() {
      try {
        const debugLog = (step, payload) => {
          const entry = { ts: new Date().toISOString(), step, payload };
          HEYS._syncDebug = Array.isArray(HEYS._syncDebug) ? HEYS._syncDebug : [];
          HEYS._syncDebug.push(entry);
          if (HEYS._syncDebug.length > 200) {
            HEYS._syncDebug.shift();
          }
          if (window.DEV?.log) {
            if (payload !== undefined) {
              window.DEV.log(`üîÑ [SYNC] ${step}`, payload);
            } else {
              window.DEV.log(`üîÑ [SYNC] ${step}`);
            }
          }
        };

        debugLog('start');
        // 1. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        const confirmed = await (HEYS.ConfirmModal?.confirm?.({
          title: 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±—â–µ–π –±–∞–∑–æ–π',
          message: '–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å –ø—É—Å—Ç—ã–º–∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏?',
          confirmText: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å',
          cancelText: '–û—Ç–º–µ–Ω–∞'
        }) ?? Promise.resolve(window.confirm('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –æ–±—â–µ–π –±–∞–∑–æ–π? –î–æ–±–∞–≤—è—Ç—Å—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –æ–±–Ω–æ–≤—è—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å –ø—É—Å—Ç—ã–º–∏ –ø–æ–ª—è–º–∏.')));

        debugLog('confirm', { confirmed });
        if (!confirmed) return;

        // 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å shared products
        HEYS.Toast?.info('‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é –±–∞–∑—É‚Ä¶');

        let sharedProducts = [];
        let sharedSource = 'unknown';
        try {
          if (HEYS.cloud?.getAllSharedProducts) {
            const result = await HEYS.cloud.getAllSharedProducts({ limit: 1000 });
            // getAllSharedProducts –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å { data: [...] } –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –º–∞—Å—Å–∏–≤
            sharedProducts = Array.isArray(result) ? result : (result?.data || result?.products || []);
            sharedSource = 'cloud.getAllSharedProducts';
          } else if (HEYS.YandexAPI?.rpc) {
            const result = await HEYS.YandexAPI.rpc('get_shared_products', {
              p_search: null,
              p_limit: 1000,
              p_offset: 0
            });
            sharedProducts = Array.isArray(result) ? result : (result?.data || result?.products || []);
            sharedSource = 'YandexAPI.rpc(get_shared_products)';
          } else if (HEYS.YandexAPI?.rest) {
            const { data, error } = await HEYS.YandexAPI.rest('shared_products');
            if (error) throw new Error(error);
            sharedProducts = Array.isArray(data) ? data : [];
            sharedSource = 'YandexAPI.rest(shared_products)';
          }
        } catch (loadErr) {
          HEYS.analytics?.trackError?.(loadErr, { context: 'ration:restoreFromSharedBase:load' });
          HEYS.Toast?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–µ–π –±–∞–∑—ã');
          return;
        }

        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ sharedProducts ‚Äî –º–∞—Å—Å–∏–≤
        if (!Array.isArray(sharedProducts)) {
          console.warn('[RESTORE] sharedProducts –Ω–µ –º–∞—Å—Å–∏–≤:', typeof sharedProducts, sharedProducts);
          sharedProducts = [];
        }

        debugLog('shared-loaded', { source: sharedSource, count: sharedProducts.length });

        if (sharedProducts.length === 0) {
          HEYS.Toast?.warning('–û–±—â–∞—è –±–∞–∑–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
          return;
        }

        // 3. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        const currentProducts = products || [];
        debugLog('local-products', { count: currentProducts.length });

        // 4. –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã
        const normalizeName = HEYS.models?.normalizeProductName
          || ((name) => String(name || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));
        const sharedByName = new Map();
        const sharedById = new Map();
        sharedProducts.forEach(sp => {
          if (sp.name) sharedByName.set(normalizeName(sp.name), sp);
          if (sp.id != null) sharedById.set(String(sp.id), sp);
        });

        const existingBySharedOriginId = new Set();
        const existingByNormalizedName = new Map(); // name -> product (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

        currentProducts.forEach(p => {
          if (p.shared_origin_id != null) {
            existingBySharedOriginId.add(String(p.shared_origin_id));
          }
          if (p.name) {
            existingByNormalizedName.set(normalizeName(p.name), p);
          }
        });
        debugLog('indexes', {
          sharedById: sharedById.size,
          sharedByName: sharedByName.size,
          existingBySharedOriginId: existingBySharedOriginId.size,
          existingByNormalizedName: existingByNormalizedName.size
        });

        // 5. –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
        const isMissing = (v) => v === undefined || v === null || v === '' || (typeof v === 'number' && isNaN(v));
        const coreFields = ['simple100', 'complex100', 'protein100', 'badFat100', 'goodFat100', 'trans100', 'fiber100', 'gi', 'sodium100'];
        const getMissingFields = (p) => coreFields.filter((key) => isMissing(p?.[key]));
        const hasNonZeroMacros = (p) => {
          if (!p) return false;
          const vals = [p.simple100, p.complex100, p.protein100, p.badFat100, p.goodFat100, p.trans100];
          return vals.some((v) => {
            const n = Number(String(v ?? '').replace(',', '.'));
            return Number.isFinite(n) && n > 0;
          });
        };
        const needsUpdate = (p) => {
          if (!p) return false;
          if (isMissing(p.kcal100) || (p.kcal100 === 0 && hasNonZeroMacros(p))) return true;
          if (isMissing(p.harm)) return true;
          return getMissingFields(p).length > 0;
        };

        // 6. –§—É–Ω–∫—Ü–∏—è –º–µ—Ä–∂–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ shared –≤ local
        const mergeFromShared = (local, shared) => {
          const merged = { ...local };
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ "–ø—É—Å—Ç–æ–≥–æ" –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –≤–∫–ª—é—á–∞–µ—Ç undefined, null, '', NaN, 0
          const isEmpty = (v) => v === undefined || v === null || v === '' || (typeof v === 'number' && isNaN(v));
          const toNum = (v) => {
            if (v === undefined || v === null || v === '') return NaN;
            const n = Number(String(v).replace(',', '.'));
            return Number.isFinite(n) ? n : NaN;
          };
          // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º—ë–Ω –ø–æ–ª–µ–π (snake_case –≤ shared vs camelCase –≤ local)
          const fields = [
            ['simple100', 'simple100'],
            ['complex100', 'complex100'],
            ['protein100', 'protein100'],
            ['badFat100', 'badfat100'],
            ['goodFat100', 'goodfat100'],
            ['trans100', 'trans100'],
            ['fiber100', 'fiber100'],
            ['gi', 'gi'],
            ['sodium100', 'sodium100'],
          ];

          let changed = false;
          const debugInfo = {
            fieldsChecked: [],
            localEmpty: [],
            sharedEmpty: [],
            updated: [],
            reasons: [],
            localSnapshot: {},
            sharedSnapshot: {}
          };
          for (const [localKey, sharedKey] of fields) {
            const sharedVal = shared[localKey] ?? shared[sharedKey];
            const localVal = local[localKey];
            debugInfo.fieldsChecked.push(localKey);
            const localIsEmpty = isEmpty(localVal);
            const sharedIsEmpty = isEmpty(sharedVal);
            const localNum = toNum(localVal);
            const sharedNum = toNum(sharedVal);
            const shouldFillZero = (localNum === 0 || localVal === 0) && Number.isFinite(sharedNum) && sharedNum > 0;
            if (localIsEmpty || shouldFillZero) {
              debugInfo.localSnapshot[localKey] = localVal;
              debugInfo.sharedSnapshot[localKey] = sharedVal;
            }
            if (localIsEmpty) debugInfo.localEmpty.push(localKey);
            if (sharedIsEmpty) debugInfo.sharedEmpty.push(localKey);
            // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ local –ø—É—Å—Ç–æ–π, –∞ shared –∑–∞–ø–æ–ª–Ω–µ–Ω
            if ((localIsEmpty && !sharedIsEmpty) || shouldFillZero) {
              merged[localKey] = sharedVal;
              changed = true;
              debugInfo.updated.push({ key: localKey, from: localVal, to: sharedVal });
            } else if (localIsEmpty && sharedIsEmpty) {
              debugInfo.reasons.push({ key: localKey, reason: 'shared_empty' });
            }
          }

          // harm ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π
          const localHarm = HEYS.models?.normalizeHarm?.(local) ?? local.harm;
          const sharedHarm = HEYS.models?.normalizeHarm?.(shared) ?? shared.harm;
          const localHarmNum = toNum(localHarm);
          const sharedHarmNum = toNum(sharedHarm);
          const shouldFillHarmZero = localHarmNum === 0 && Number.isFinite(sharedHarmNum) && sharedHarmNum > 0;
          if ((isEmpty(localHarm) && !isEmpty(sharedHarm)) || shouldFillHarmZero) {
            merged.harm = sharedHarm;
            changed = true;
            debugInfo.updated.push({ key: 'harm', from: localHarm, to: sharedHarm });
          } else if (isEmpty(localHarm) && isEmpty(sharedHarm)) {
            debugInfo.reasons.push({ key: 'harm', reason: 'shared_empty' });
          }

          // üîß FIX: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è portions ‚Äî –±–µ—Ä—ë–º –∏–∑ shared –µ—Å–ª–∏ local –ø—É—Å—Ç–æ–π
          const localPortions = local?.portions;
          const sharedPortions = shared?.portions;
          const localHasPortions = Array.isArray(localPortions) && localPortions.length > 0;
          const sharedHasPortions = Array.isArray(sharedPortions) && sharedPortions.length > 0;
          if (!localHasPortions && sharedHasPortions) {
            merged.portions = sharedPortions;
            changed = true;
            debugInfo.updated.push({ key: 'portions', from: localPortions, to: sharedPortions });
          }

          // shared_origin_id –¥–ª—è —Å–≤—è–∑–∏
          if (!merged.shared_origin_id && shared.id) {
            merged.shared_origin_id = shared.id;
            changed = true;
          }

          // –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è
          const kcalMissing = isEmpty(merged.kcal100) || (merged.kcal100 === 0 && hasNonZeroMacros(merged));
          if (kcalMissing) {
            const derived = computeDerived(merged);
            if (derived.kcal100 > 0) {
              merged.kcal100 = derived.kcal100;
              merged.carbs100 = derived.carbs100;
              merged.fat100 = derived.fat100;
              merged._updatedFromShared = new Date().toISOString();
              debugInfo.reasons.push({ key: 'kcal100', reason: 'recomputed_from_macros' });
              changed = true;
            }
          } else if (changed) {
            const derived = computeDerived(merged);
            merged.kcal100 = derived.kcal100;
            merged.carbs100 = derived.carbs100;
            merged.fat100 = derived.fat100;
            merged._updatedFromShared = new Date().toISOString();
          }

          return { merged, changed, debugInfo };
        };

        // 7. –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –ø—É—Å—Ç—ã–º–∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏
        let updatedCount = 0;
        let matchedById = 0;
        let matchedByName = 0;
        let missingCount = 0;
        let noMatchCount = 0;
        const noMatchSamples = [];
        const updatedSamples = [];
        const notUpdatedSamples = [];
        const updatedProducts = currentProducts.map(localP => {
          // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –≤ shared
          let sharedP = null;
          if (localP.shared_origin_id != null) {
            sharedP = sharedById.get(String(localP.shared_origin_id));
            if (sharedP) matchedById++;
          }
          if (!sharedP && localP.name) {
            sharedP = sharedByName.get(normalizeName(localP.name));
            if (sharedP) matchedByName++;
          }

          const missingFields = getMissingFields(localP);
          const shouldUpdate = needsUpdate(localP);
          if (shouldUpdate) missingCount++;

          if (!sharedP) {
            if (shouldUpdate && noMatchSamples.length < 5) {
              noMatchSamples.push({
                name: localP?.name,
                shared_origin_id: localP?.shared_origin_id || null,
                missingFields,
                kcal100: localP?.kcal100,
                harm: localP?.harm
              });
            }
            if (shouldUpdate) noMatchCount++;
            return localP; // –ù–µ—Ç –≤ shared ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å
          if (shouldUpdate) {
            const { merged, changed, debugInfo } = mergeFromShared(localP, sharedP);
            if (changed) {
              updatedCount++;
              if (updatedSamples.length < 5) {
                updatedSamples.push({
                  name: localP?.name,
                  sharedId: sharedP?.id,
                  missingFields,
                  debugInfo
                });
              }
              return merged;
            } else {
              // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—á–µ–º—É –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
              if (notUpdatedSamples.length < 5) {
                notUpdatedSamples.push({
                  name: localP?.name,
                  sharedId: sharedP?.id,
                  missingFields,
                  debugInfo
                });
              }
            }
          }
          return localP;
        });

        debugLog('update-scan', {
          needsUpdate: missingCount,
          matchedById,
          matchedByName,
          noMatch: noMatchCount,
          updated: updatedCount,
          noMatchSamples,
          updatedSamples,
          notUpdatedSamples
        });

        // 8. –ù–∞–π—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        const missingProducts = sharedProducts.filter(shared => {
          if (existingBySharedOriginId.has(String(shared.id))) return false;
          const normalizedName = normalizeName(shared.name);
          if (existingByNormalizedName.has(normalizedName)) return false;
          return true;
        });
        debugLog('missing-products', { count: missingProducts.length });

        // 9. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É
        const uid = HEYS.utils?.uid || ((prefix = 'p_') => prefix + Date.now() + '_' + Math.random().toString(36).slice(2, 8));

        const newProducts = missingProducts.map(shared => {
          const harm = HEYS.models?.normalizeHarm?.(shared) ?? shared.harm ?? shared.harmScore ?? null;
          const base = {
            id: uid('p_'),
            shared_origin_id: shared.id,
            name: shared.name,
            simple100: shared.simple100 ?? 0,
            complex100: shared.complex100 ?? 0,
            protein100: shared.protein100 ?? 0,
            badFat100: shared.badFat100 ?? shared.badfat100 ?? 0,
            goodFat100: shared.goodFat100 ?? shared.goodfat100 ?? 0,
            trans100: shared.trans100 ?? 0,
            fiber100: shared.fiber100 ?? 0,
            gi: shared.gi ?? 0,
            harm: harm,
            harmScore: harm,
            category: shared.category ?? null,
            portions: shared.portions ?? null,
            sodium100: shared.sodium100 ?? null,
            novaGroup: shared.nova_group ?? shared.novaGroup ?? null,
            vitaminA: shared.vitamin_a ?? shared.vitaminA ?? null,
            vitaminC: shared.vitamin_c ?? shared.vitaminC ?? null,
            vitaminD: shared.vitamin_d ?? shared.vitaminD ?? null,
            vitaminE: shared.vitamin_e ?? shared.vitaminE ?? null,
            vitaminK: shared.vitamin_k ?? shared.vitaminK ?? null,
            vitaminB1: shared.vitamin_b1 ?? shared.vitaminB1 ?? null,
            vitaminB2: shared.vitamin_b2 ?? shared.vitaminB2 ?? null,
            vitaminB3: shared.vitamin_b3 ?? shared.vitaminB3 ?? null,
            vitaminB6: shared.vitamin_b6 ?? shared.vitaminB6 ?? null,
            vitaminB9: shared.vitamin_b9 ?? shared.vitaminB9 ?? null,
            vitaminB12: shared.vitamin_b12 ?? shared.vitaminB12 ?? null,
            calcium: shared.calcium ?? null,
            iron: shared.iron ?? null,
            magnesium: shared.magnesium ?? null,
            phosphorus: shared.phosphorus ?? null,
            potassium: shared.potassium ?? null,
            zinc: shared.zinc ?? null,
            selenium: shared.selenium ?? null,
            iodine: shared.iodine ?? null,
            isOrganic: shared.is_organic ?? shared.isOrganic ?? false,
            isWholeGrain: shared.is_whole_grain ?? shared.isWholeGrain ?? false,
            isFermented: shared.is_fermented ?? shared.isFermented ?? false,
            isRaw: shared.is_raw ?? shared.isRaw ?? false,
            _restoredFromShared: true,
            _restoredAt: new Date().toISOString()
          };
          // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è
          const derived = computeDerived(base);
          return { ...base, ...derived };
        });

        // 10. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
        const mergedProducts = [...updatedProducts, ...newProducts];
        debugLog('merged', { total: mergedProducts.length, added: newProducts.length, updated: updatedCount });

        if (HEYS.products?.setAll) {
          HEYS.products.setAll(mergedProducts, { source: 'import-pasted' });
        } else if (HEYS.store?.set) {
          HEYS.store.set('heys_products', mergedProducts);
        } else if (HEYS.utils?.lsSet) {
          HEYS.utils.lsSet('heys_products', mergedProducts);
        }

        // 11. –û–±–Ω–æ–≤–∏—Ç—å UI
        setProducts(mergedProducts);
        if (typeof buildSearchIndex === 'function') {
          buildSearchIndex(mergedProducts);
        }

        // 12. –û—Ç—á—ë—Ç
        const addedCount = newProducts.length;
        let message = '';
        if (addedCount > 0 && updatedCount > 0) {
          message = `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${updatedCount} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
        } else if (addedCount > 0) {
          message = `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
        } else if (updatedCount > 0) {
          message = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updatedCount} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
        } else {
          message = '‚úÖ –í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —É–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!';
        }

        debugLog('done', { message });
        HEYS.Toast?.success(message);

        if (window.HEYS?.analytics?.trackDataOperation) {
          window.HEYS.analytics.trackDataOperation('products-synced-from-shared', { added: addedCount, updated: updatedCount });
        }

      } catch (err) {
        HEYS.analytics?.trackError?.(err, { context: 'ration:restoreFromSharedBase' });
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (err.message || err)) || alert('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (err.message || err));
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –∏–∑ JSON —Ñ–∞–π–ª–∞
    async function importFromFile(file) {
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        DEV.log('[IMPORT FILE] –ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª:', file.name);
        DEV.log('[IMPORT FILE] –°—Ç—Ä—É–∫—Ç—É—Ä–∞:', Object.keys(data));

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
        let importedProducts = [];

        // –§–æ—Ä–º–∞—Ç –ø–æ–ª–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ HEYS (exportFullBackup)
        if (data.products && Array.isArray(data.products)) {
          importedProducts = data.products;
          DEV.log('[IMPORT FILE] –§–æ—Ä–º–∞—Ç: –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø HEYS, –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', importedProducts.length);
        }
        // –§–æ—Ä–º–∞—Ç –ø—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        else if (Array.isArray(data)) {
          importedProducts = data;
          DEV.log('[IMPORT FILE] –§–æ—Ä–º–∞—Ç: –º–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —à—Ç—É–∫:', importedProducts.length);
        }
        if (importedProducts.length === 0) {
          HEYS.Toast?.warning('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞') || alert('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.');
          return;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        const validProducts = importedProducts.filter(p => {
          if (!p.name || typeof p.name !== 'string') return false;
          return true;
        }).map(p => {
          // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π
          // Use centralized harm normalization
          const harmVal = HEYS.models?.normalizeHarm?.(p) ?? toNum(p.harm ?? p.harmScore ?? p.harmscore ?? p.harm100);
          const product = {
            id: p.id || uuid(),
            name: p.name,
            simple100: toNum(p.simple100),
            complex100: toNum(p.complex100),
            protein100: toNum(p.protein100),
            badFat100: toNum(p.badFat100),
            goodFat100: toNum(p.goodFat100),
            trans100: toNum(p.trans100),
            fiber100: toNum(p.fiber100),
            gi: toNum(p.gi || p.gi100 || p.GI || p.giIndex),
            harm: harmVal,  // Canonical field
            createdAt: p.createdAt || Date.now()
          };
          // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –ø–æ–ª—è
          return { ...product, ...computeDerived(product) };
        });

        if (validProducts.length === 0) {
          HEYS.Toast?.warning('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞') || alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.');
          return;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const normalize = (name) => (name || '').trim().toLowerCase();
        const existingMap = new Map();
        products.forEach((p, idx) => {
          existingMap.set(normalize(p.name), { product: p, index: idx });
        });

        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ
        let willBeAdded = 0;
        let willBeUpdated = 0;
        const newProductNames = [];
        const updateProductNames = [];

        for (const row of validProducts) {
          const key = normalize(row.name);
          if (existingMap.has(key)) {
            willBeUpdated++;
            if (updateProductNames.length < 5) updateProductNames.push(row.name);
          } else {
            willBeAdded++;
            if (newProductNames.length < 5) newProductNames.push(row.name);
          }
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        let previewMessage = `üì¶ –ù–∞–π–¥–µ–Ω–æ ${validProducts.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ\n\n`;

        if (willBeAdded > 0) {
          previewMessage += `‚úÖ –ù–æ–≤—ã—Ö (–¥–æ–±–∞–≤—è—Ç—Å—è): ${willBeAdded}\n`;
          if (newProductNames.length > 0) {
            previewMessage += `   ‚Ä¢ ${newProductNames.join('\n   ‚Ä¢ ')}`;
            if (willBeAdded > 5) previewMessage += `\n   ... –∏ –µ—â—ë ${willBeAdded - 5}`;
            previewMessage += '\n\n';
          }
        }

        if (willBeUpdated > 0) {
          previewMessage += `üîÑ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö (–æ–±–Ω–æ–≤—è—Ç—Å—è): ${willBeUpdated}\n`;
          if (updateProductNames.length > 0) {
            previewMessage += `   ‚Ä¢ ${updateProductNames.join('\n   ‚Ä¢ ')}`;
            if (willBeUpdated > 5) previewMessage += `\n   ... –∏ –µ—â—ë ${willBeUpdated - 5}`;
            previewMessage += '\n\n';
          }
        }

        previewMessage += `–¢–µ–∫—É—â–∞—è –±–∞–∑–∞: ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n`;
        previewMessage += `–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞: ${products.length + willBeAdded} –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n\n`;
        previewMessage += `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–º–ø–æ—Ä—Ç?`;

        // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º preview
        const confirmed = await (HEYS.ConfirmModal?.confirm?.({
          title: 'üì§ –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤',
          message: previewMessage,
          confirmText: `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å (${willBeAdded} –Ω–æ–≤—ã—Ö${willBeUpdated > 0 ? `, ${willBeUpdated} –æ–±–Ω–æ–≤–∏—Ç—å` : ''})`,
          cancelText: '–û—Ç–º–µ–Ω–∞'
        }) ?? Promise.resolve(window.confirm(previewMessage)));

        if (!confirmed) {
          DEV.log('[IMPORT FILE] –ò–º–ø–æ—Ä—Ç –æ—Ç–º–µ–Ω—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
          return;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // –í–´–ü–û–õ–ù–Ø–ï–ú –ò–ú–ü–û–†–¢
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let updated = 0;
        let added = 0;
        const newProducts = [...products];

        for (const row of validProducts) {
          const key = normalize(row.name);
          const existing = existingMap.get(key);

          if (existing) {
            newProducts[existing.index] = {
              ...existing.product,
              ...row,
              id: existing.product.id
            };
            updated++;
          } else {
            newProducts.push(row);
            existingMap.set(key, { product: row, index: newProducts.length - 1 });
            added++;
          }
        }

        setProducts(newProducts);

        DEV.log(`‚úÖ [IMPORT FILE] –ó–∞–≤–µ—Ä—à–µ–Ω–æ: +${added} –Ω–æ–≤—ã—Ö, ‚Üª${updated} –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);
        HEYS.Toast?.success(`‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!\n+${added} –Ω–æ–≤—ã—Ö, ${updated} –æ–±–Ω–æ–≤–ª–µ–Ω–æ`) || alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!`);

        if (window.HEYS?.analytics) {
          window.HEYS.analytics.trackDataOperation('products-imported-file', validProducts.length);
        }

      } catch (err) {
        console.error('[IMPORT FILE] –û—à–∏–±–∫–∞:', err);
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message) || alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message);
      }
    }

    // === PHASE 2: Helper —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI ===

    const formatTableValue = (value) => {
      if (value === null || value === undefined || value === '' || (typeof value === 'number' && isNaN(value))) return '‚Äî';
      return value;
    };

    const formatTableBool = (value) => {
      if (value === true) return '–¥–∞';
      if (value === false) return '–Ω–µ—Ç';
      return '‚Äî';
    };

    const formatTableList = (value) => {
      if (Array.isArray(value)) return value.length ? value.join(', ') : '‚Äî';
      if (value === null || value === undefined || value === '') return '‚Äî';
      return String(value);
    };

    const getDerivedKcal = (productLike) => {
      const derived = computeDerived(productLike || {});
      return derived.kcal100;
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìä UNIFIED TABLE HEAD ‚Äî –µ–¥–∏–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const renderProductTableHead = () => {
      return React.createElement('thead', null,
        React.createElement('tr', null,
          React.createElement('th', null, '–ù–∞–∑–≤–∞–Ω–∏–µ'),
          React.createElement('th', { title: '–ö–∞–ª–æ—Ä–∏–∏ –Ω–∞ 100–≥' }, '–ö–∫–∞–ª'),
          React.createElement('th', { title: '–£–≥–ª–µ–≤–æ–¥—ã (–∞–≤—Ç–æ)' }, '–£'),
          React.createElement('th', { title: '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã' }, '–ü—Ä'),
          React.createElement('th', { title: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã' }, '–°–ª'),
          React.createElement('th', { title: '–ë–µ–ª–∫–∏' }, '–ë'),
          React.createElement('th', { title: '–ñ–∏—Ä—ã (–∞–≤—Ç–æ)' }, '–ñ'),
          React.createElement('th', { title: '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã' }, '–í—Ä'),
          React.createElement('th', { title: '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã' }, '–ü–æ–ª'),
          React.createElement('th', { title: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã' }, '–¢—Ä'),
          React.createElement('th', { title: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞' }, '–ö–ª'),
          React.createElement('th', { title: '–ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å' }, '–ì–ò'),
          React.createElement('th', { title: '–ò–Ω–¥–µ–∫—Å –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏' }, '–í—Ä–µ–¥'),
          React.createElement('th', { title: '–ù–∞—Ç—Ä–∏–π (–º–≥/100–≥)' }, 'Na'),
          React.createElement('th', { title: '–û–º–µ–≥–∞-3 (–≥/100–≥)' }, 'Œ©3'),
          React.createElement('th', { title: '–û–º–µ–≥–∞-6 (–≥/100–≥)' }, 'Œ©6'),
          React.createElement('th', { title: 'NOVA –≥—Ä—É–ø–ø–∞' }, 'NOVA'),
          React.createElement('th', { title: '–î–æ–±–∞–≤–∫–∏ (E-–∫–æ–¥—ã)' }, 'Add'),
          React.createElement('th', { title: '–ù—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (0‚Äì100)' }, 'ND'),
          React.createElement('th', { title: '–û—Ä–≥–∞–Ω–∏–∫' }, 'Org'),
          React.createElement('th', { title: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π' }, '–¶–ó'),
          React.createElement('th', { title: '–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π' }, '–§–µ—Ä–º'),
          React.createElement('th', { title: '–°—ã—Ä–æ–π' }, 'Raw'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω A (% DV)' }, 'A'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω C (% DV)' }, 'C'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω D (% DV)' }, 'D'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω E (% DV)' }, 'E'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω K (% DV)' }, 'K'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω B1 (% DV)' }, 'B1'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω B2 (% DV)' }, 'B2'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω B3 (% DV)' }, 'B3'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω B6 (% DV)' }, 'B6'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω B9 (% DV)' }, 'B9'),
          React.createElement('th', { title: '–í–∏—Ç–∞–º–∏–Ω B12 (% DV)' }, 'B12'),
          React.createElement('th', { title: '–ö–∞–ª—å—Ü–∏–π (% DV)' }, 'Ca'),
          React.createElement('th', { title: '–ñ–µ–ª–µ–∑–æ (% DV)' }, 'Fe'),
          React.createElement('th', { title: '–ú–∞–≥–Ω–∏–π (% DV)' }, 'Mg'),
          React.createElement('th', { title: '–§–æ—Å—Ñ–æ—Ä (% DV)' }, 'P'),
          React.createElement('th', { title: '–ö–∞–ª–∏–π (% DV)' }, 'K'),
          React.createElement('th', { title: '–¶–∏–Ω–∫ (% DV)' }, 'Zn'),
          React.createElement('th', { title: '–°–µ–ª–µ–Ω (% DV)' }, 'Se'),
          React.createElement('th', { title: '–ô–æ–¥ (% DV)' }, 'I'),
          React.createElement('th', { title: '–ü–æ—Ä—Ü–∏–∏' }, '–ü–æ—Ä—Ü'),
          React.createElement('th', null, '')
        )
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìä UnifiedProductTable ‚Äî –µ–¥–∏–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è Personal –∏ Shared
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const UnifiedProductTable = ({ mode, data, loading, callbacks }) => {
      if (loading) {
        return React.createElement('div', {
          style: { padding: '32px', textAlign: 'center', color: 'var(--text-muted)' }
        }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...');
      }

      if (!data || data.length === 0) {
        return React.createElement('div', {
          style: { padding: '32px', textAlign: 'center', color: 'var(--text-muted)' }
        }, '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤');
      }

      return React.createElement('div', { className: 'products-table-scroll' },
        React.createElement('table', { className: 'products-table' },
          renderProductTableHead(),
          React.createElement('tbody', null,
            data.map((p, idx) => renderProductTableRow(p, {
              mode,
              idx,
              ...callbacks
            }))
          )
        )
      );
    };

    const renderProductTableRow = (product, options = {}) => {
      const {
        mode = 'personal',
        idx = 0,
        isCurator: canCurate = false,
        onUpdateRow,
        onDeleteRow,
        onOpenNameEditor,
        onOpenPortionsEditor,
        onOpenSharedPortionsEditor,
        onCloneShared,
        onHideShared,
        onDeleteShared,
        onSyncToShared,
        sharedNameMap
      } = options;

      const readOnly = mode === 'shared';
      const normalizeProductName = HEYS.models?.normalizeProductName
        || ((name) => String(name || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));
      const safeNum = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      };
      const toTs = (value) => {
        if (value == null) return 0;
        if (typeof value === 'number') return value;
        const parsed = Date.parse(value);
        return Number.isFinite(parsed) ? parsed : 0;
      };

      const normalizedForDerived = {
        ...product,
        protein100: safeNum(product?.protein100),
        simple100: safeNum(product?.simple100),
        complex100: safeNum(product?.complex100),
        badFat100: safeNum(product?.badFat100 ?? product?.badfat100),
        goodFat100: safeNum(product?.goodFat100 ?? product?.goodfat100),
        trans100: safeNum(product?.trans100)
      };
      const derived = computeDerived(normalizedForDerived);
      const kcal = derived.kcal100;
      const carbs = derived.carbs100;
      const fat = derived.fat100;
      const harmValue = HEYS.models?.normalizeHarm?.(product) ?? product.harm ?? product.harmScore ?? product.harmscore ?? product.harm100 ?? 0;
      const safeHarm = Number.isFinite(Number(harmValue)) ? harmValue : 0;
      const sharedUpdatedAt = toTs(product?.shared_updated_at ?? product?.sharedUpdatedAt);
      const clonedAt = toTs(product?.cloned_at ?? product?.clonedAt);
      const sharedMatch = sharedNameMap?.get(normalizeProductName(product?.name || '')) || null;
      const resolvedSharedId = product?.shared_origin_id ?? product?.sharedOriginId ?? product?.shared_id ?? product?.sharedId ?? sharedMatch?.id;
      const isSharedClone = !!product?.shared_origin_id;
      const hasSharedUpdate = mode === 'personal' && isSharedClone && !product?.user_modified && sharedUpdatedAt > clonedAt;

      // [baza] –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞ ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∞ (v5.0.1, –±—ã–ª–∞ —Å–ø–∞–º –≤ –∫–æ–Ω—Å–æ–ª–∏)

      const copyProductParams = async () => {
        const portionsValue = Array.isArray(product?.portions)
          ? (product.portions.length ? JSON.stringify(product.portions) : '‚Äî')
          : formatTableValue(product?.portions);

        const rows = [
          ['–ù–∞–∑–≤–∞–Ω–∏–µ', product?.name],
          ['–ö–∫–∞–ª', kcal],
          ['–£–≥–ª–µ–≤–æ–¥—ã', carbs],
          ['–ü—Ä–æ—Å—Ç—ã–µ', product?.simple100],
          ['–°–ª–æ–∂–Ω—ã–µ', product?.complex100],
          ['–ë–µ–ª–∫–∏', product?.protein100],
          ['–ñ–∏—Ä—ã', fat],
          ['–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã', product?.badFat100 ?? product?.badfat100],
          ['–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã', product?.goodFat100 ?? product?.goodfat100],
          ['–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã', product?.trans100],
          ['–ö–ª–µ—Ç—á–∞—Ç–∫–∞', product?.fiber100],
          ['–ì–ò', product?.gi],
          ['–í—Ä–µ–¥–Ω–æ—Å—Ç—å', safeHarm],
          ['Na', product?.sodium100],
          ['Œ©3', product?.omega3_100],
          ['Œ©6', product?.omega6_100],
          ['NOVA', product?.nova_group ?? product?.novaGroup],
          ['–î–æ–±–∞–≤–∫–∏', formatTableList(product?.additives)],
          ['ND', product?.nutrient_density ?? product?.nutrientDensity],
          ['–û—Ä–≥–∞–Ω–∏–∫', formatTableBool(product?.is_organic ?? product?.isOrganic)],
          ['–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π', formatTableBool(product?.is_whole_grain ?? product?.isWholeGrain)],
          ['–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', formatTableBool(product?.is_fermented ?? product?.isFermented)],
          ['–°—ã—Ä–æ–π', formatTableBool(product?.is_raw ?? product?.isRaw)],
          ['–í–∏—Ç–∞–º–∏–Ω A', product?.vitamin_a ?? product?.vitaminA],
          ['–í–∏—Ç–∞–º–∏–Ω C', product?.vitamin_c ?? product?.vitaminC],
          ['–í–∏—Ç–∞–º–∏–Ω D', product?.vitamin_d ?? product?.vitaminD],
          ['–í–∏—Ç–∞–º–∏–Ω E', product?.vitamin_e ?? product?.vitaminE],
          ['–í–∏—Ç–∞–º–∏–Ω K', product?.vitamin_k ?? product?.vitaminK],
          ['–í–∏—Ç–∞–º–∏–Ω B1', product?.vitamin_b1 ?? product?.vitaminB1],
          ['–í–∏—Ç–∞–º–∏–Ω B2', product?.vitamin_b2 ?? product?.vitaminB2],
          ['–í–∏—Ç–∞–º–∏–Ω B3', product?.vitamin_b3 ?? product?.vitaminB3],
          ['–í–∏—Ç–∞–º–∏–Ω B6', product?.vitamin_b6 ?? product?.vitaminB6],
          ['–í–∏—Ç–∞–º–∏–Ω B9', product?.vitamin_b9 ?? product?.vitaminB9],
          ['–í–∏—Ç–∞–º–∏–Ω B12', product?.vitamin_b12 ?? product?.vitaminB12],
          ['–ö–∞–ª—å—Ü–∏–π', product?.calcium],
          ['–ñ–µ–ª–µ–∑–æ', product?.iron],
          ['–ú–∞–≥–Ω–∏–π', product?.magnesium],
          ['–§–æ—Å—Ñ–æ—Ä', product?.phosphorus],
          ['–ö–∞–ª–∏–π', product?.potassium],
          ['–¶–∏–Ω–∫', product?.zinc],
          ['–°–µ–ª–µ–Ω', product?.selenium],
          ['–ô–æ–¥', product?.iodine],
          ['–ü–æ—Ä—Ü–∏–∏', portionsValue]
        ];

        const text = rows
          .map(([label, value]) => `${label}: ${formatTableValue(value)}`)
          .join('\n');

        try {
          if (navigator?.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }
          HEYS.Toast?.success('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã') || alert('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã');
        } catch (err) {
          HEYS.Toast?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å') || alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        }
      };

      const renderInput = (value, onChange, isReadOnly = false) => (
        React.createElement('input', {
          className: isReadOnly ? 'readOnly' : undefined,
          type: 'text',
          value: value,
          readOnly: isReadOnly,
          onChange: isReadOnly ? undefined : onChange
        })
      );

      const rowKey = product?.id != null
        ? String(product.id)
        : `${mode || 'table'}_${String(product?.name || 'row')}_${idx}`;

      return React.createElement('tr', { key: rowKey },
        React.createElement('td', null,
          readOnly
            ? React.createElement('div', { className: 'product-name-cell' },
              React.createElement('span', { className: 'product-name-text' }, product.name),
              React.createElement('button', {
                className: 'btn product-copy-btn',
                onClick: copyProductParams,
                title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
                'aria-label': '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'
              }, 'üìã'),
              product.is_mine && React.createElement('span', {
                className: 'product-owner-badge'
              }, '–í—ã')
            )
            : React.createElement('div', { className: 'product-name-cell' },
              React.createElement('button', {
                className: 'product-name-edit',
                onClick: () => onOpenNameEditor?.(product),
                title: '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å',
                'aria-label': '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å'
              }, '‚úèÔ∏è'),
              React.createElement('button', {
                className: 'btn product-copy-btn',
                onClick: copyProductParams,
                title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
                'aria-label': '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'
              }, 'üìã'),
              React.createElement('span', { className: 'product-name-text' }, product.name),
              hasSharedUpdate && React.createElement('span', {
                className: 'product-name-cell__badge',
                title: '–í –æ–±—â–µ–π –±–∞–∑–µ –µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
              }, 'üîÑ')
            )
        ),
        React.createElement('td', null, renderInput(kcal, null, true)),
        React.createElement('td', null, renderInput(carbs, null, true)),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.simple100), null, true)
          : renderInput(product.simple100, e => onUpdateRow?.(product.id, { simple100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.complex100), null, true)
          : renderInput(product.complex100, e => onUpdateRow?.(product.id, { complex100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.protein100), null, true)
          : renderInput(product.protein100, e => onUpdateRow?.(product.id, { protein100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, renderInput(fat, null, true)),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.badFat100 ?? product.badfat100), null, true)
          : renderInput(product.badFat100, e => onUpdateRow?.(product.id, { badFat100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.goodFat100 ?? product.goodfat100), null, true)
          : renderInput(product.goodFat100, e => onUpdateRow?.(product.id, { goodFat100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.trans100), null, true)
          : renderInput(product.trans100, e => onUpdateRow?.(product.id, { trans100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.fiber100), null, true)
          : renderInput(product.fiber100, e => onUpdateRow?.(product.id, { fiber100: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeNum(product.gi), null, true)
          : renderInput(product.gi, e => onUpdateRow?.(product.id, { gi: toNum(e.target.value) }))
        ),
        React.createElement('td', null, readOnly
          ? renderInput(safeHarm, null, true)
          : renderInput(HEYS.models?.normalizeHarm?.(product) ?? product.harm ?? product.harmScore ?? product.harmscore ?? product.harm100 ?? 0, e => onUpdateRow?.(product.id, { harm: toNum(e.target.value) }))
        ),
        React.createElement('td', null, renderInput(formatTableValue(product.sodium100), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.omega3_100), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.omega6_100), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.nova_group ?? product.novaGroup), null, true)),
        React.createElement('td', null, renderInput(formatTableList(product.additives), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.nutrient_density ?? product.nutrientDensity), null, true)),
        React.createElement('td', null, renderInput(formatTableBool(product.is_organic ?? product.isOrganic), null, true)),
        React.createElement('td', null, renderInput(formatTableBool(product.is_whole_grain ?? product.isWholeGrain), null, true)),
        React.createElement('td', null, renderInput(formatTableBool(product.is_fermented ?? product.isFermented), null, true)),
        React.createElement('td', null, renderInput(formatTableBool(product.is_raw ?? product.isRaw), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_a ?? product.vitaminA), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_c ?? product.vitaminC), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_d ?? product.vitaminD), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_e ?? product.vitaminE), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_k ?? product.vitaminK), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_b1 ?? product.vitaminB1), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_b2 ?? product.vitaminB2), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_b3 ?? product.vitaminB3), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_b6 ?? product.vitaminB6), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_b9 ?? product.vitaminB9), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.vitamin_b12 ?? product.vitaminB12), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.calcium), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.iron), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.magnesium), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.phosphorus), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.potassium), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.zinc), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.selenium), null, true)),
        React.createElement('td', null, renderInput(formatTableValue(product.iodine), null, true)),
        React.createElement('td', null,
          readOnly
            ? ((canCurate || product.is_mine)
              ? React.createElement('button', {
                className: 'btn',
                onClick: () => onOpenSharedPortionsEditor?.(product),
                title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ü–∏–∏'
              }, `ü•£ ${Array.isArray(product.portions) ? product.portions.length : 0}`)
              : React.createElement('span', null, `ü•£ ${Array.isArray(product.portions) ? product.portions.length : 0}`))
            : React.createElement('button', {
              className: 'btn',
              onClick: () => onOpenPortionsEditor?.(product),
              title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ü–∏–∏'
            }, `ü•£ ${Array.isArray(product.portions) ? product.portions.length : 0}`)
        ),
        React.createElement('td', null,
          readOnly
            ? React.createElement('div', { className: 'product-actions' },
              React.createElement('button', {
                className: 'btn acc product-action-btn',
                onClick: () => onCloneShared?.(product),
                title: '–î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ—é –±–∞–∑—É'
              }, '‚ûï'),
              !product.is_mine && React.createElement('button', {
                className: 'btn product-action-btn product-action-btn--ghost',
                onClick: () => onHideShared?.(product.id),
                title: '–°–∫—Ä—ã—Ç—å –¥–ª—è –º–µ–Ω—è'
              }, 'üö´'),
              (canCurate || product.is_mine) && React.createElement('button', {
                className: 'btn product-action-btn product-action-btn--danger',
                onClick: () => onDeleteShared?.(product.id, product.name),
                title: '–£–¥–∞–ª–∏—Ç—å –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã'
              }, 'üóëÔ∏è')
            )
            : React.createElement('div', { className: 'product-actions' },
              resolvedSharedId && React.createElement('button', {
                className: 'btn product-action-btn product-action-btn--sync',
                onClick: () => onSyncToShared?.(product),
                title: '–û–±–Ω–æ–≤–∏—Ç—å –≤ –æ–±—â–µ–π –±–∞–∑–µ'
              }, 'üîÑ'),
              React.createElement('button', { className: 'btn product-action-btn', onClick: () => onDeleteRow?.(product.id) }, '–£–¥–∞–ª–∏—Ç—å')
            )
        )
      );
    };

    // –û–¥–æ–±—Ä–∏—Ç—å pending –∑–∞—è–≤–∫—É
    async function approvePending(pending) {
      try {
        // –ü–µ—Ä–µ–¥–∞—ë–º –∏ pendingId –∏ productData
        const result = await window.HEYS?.cloud?.approvePendingProduct?.(pending.id, pending.product_data);
        if (result?.error) {
          HEYS.Toast?.error('–û—à–∏–±–∫–∞: ' + result.error.message) || alert('–û—à–∏–±–∫–∞: ' + result.error.message);
          return;
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        setPendingProducts(prev => prev.filter(p => p.id !== pending.id));
        if (result.existing) {
          HEYS.Toast?.info(`–ü—Ä–æ–¥—É–∫—Ç "${pending.product_data?.name || pending.name_norm}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –æ–±—â–µ–π –±–∞–∑–µ`) || alert(`‚ÑπÔ∏è –ü—Ä–æ–¥—É–∫—Ç "${pending.product_data?.name || pending.name_norm}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –æ–±—â–µ–π –±–∞–∑–µ`);
        } else {
          HEYS.Toast?.success(`–ü—Ä–æ–¥—É–∫—Ç "${pending.product_data?.name || pending.name_norm}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–±—â—É—é –±–∞–∑—É!`) || alert(`‚úÖ –ü—Ä–æ–¥—É–∫—Ç "${pending.product_data?.name || pending.name_norm}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–±—â—É—é –±–∞–∑—É!`);
        }
      } catch (err) {
        console.error('[APPROVE] Error:', err);
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: ' + err.message) || alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏: ' + err.message);
      }
    }

    // –û—Ç–∫–ª–æ–Ω–∏—Ç—å pending –∑–∞—è–≤–∫—É
    async function rejectPending(pending, reason = '') {
      try {
        const result = await window.HEYS?.cloud?.rejectPendingProduct?.(pending.id, reason);
        if (result?.error) {
          HEYS.Toast?.error('–û—à–∏–±–∫–∞: ' + result.error.message) || alert('–û—à–∏–±–∫–∞: ' + result.error.message);
          return;
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        setPendingProducts(prev => prev.filter(p => p.id !== pending.id));
        HEYS.Toast?.info(`–ó–∞—è–≤–∫–∞ "${pending.product_data?.name || pending.name_norm}" –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞`) || alert(`‚ùå –ó–∞—è–≤–∫–∞ "${pending.product_data?.name || pending.name_norm}" –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞`);
      } catch (err) {
        console.error('[REJECT] Error:', err);
        HEYS.Toast?.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: ' + err.message) || alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: ' + err.message);
      }
    }

    const getCloneName = (baseName, list) => {
      const safeBase = (baseName || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const normalizeName = (name) => (name || '').toLowerCase().trim();
      const hasName = (name) => list.some(p => normalizeName(p?.name) === normalizeName(name));

      if (!hasName(safeBase)) return safeBase;

      let candidate = `${safeBase} (–∫–æ–ø–∏—è)`;
      if (!hasName(candidate)) return candidate;

      let i = 2;
      while (hasName(`${safeBase} (–∫–æ–ø–∏—è ${i})`)) i += 1;
      return `${safeBase} (–∫–æ–ø–∏—è ${i})`;
    };

    const clonePortions = (portions) => {
      if (!Array.isArray(portions)) return portions ?? null;
      return portions.map((p) => ({ ...p }));
    };

    // –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å shared –ø—Ä–æ–¥—É–∫—Ç –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É
    function cloneSharedProduct(sharedProduct) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∫–ª–æ–Ω–∞ —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
      const existingClone = products.find(p => p.shared_origin_id === sharedProduct.id);
      if (existingClone) {
        HEYS.Toast?.warning(`–ü—Ä–æ–¥—É–∫—Ç "${sharedProduct.name}" —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –±–∞–∑–µ!`) || alert(`‚ö†Ô∏è –ü—Ä–æ–¥—É–∫—Ç "${sharedProduct.name}" —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –±–∞–∑–µ!`);
        return existingClone;
      }

      const cloneName = getCloneName(sharedProduct.name, products);

      // –°–æ–∑–¥–∞—ë–º –∫–ª–æ–Ω
      // Use centralized harm normalization
      const harmVal = HEYS.models?.normalizeHarm?.(sharedProduct);
      const clone = {
        id: uuid(),
        name: cloneName,
        simple100: toNum(sharedProduct.simple100),
        complex100: toNum(sharedProduct.complex100),
        protein100: toNum(sharedProduct.protein100),
        badFat100: toNum(sharedProduct.badfat100), // lowercase from Supabase
        goodFat100: toNum(sharedProduct.goodfat100),
        trans100: toNum(sharedProduct.trans100),
        fiber100: toNum(sharedProduct.fiber100),
        gi: toNum(sharedProduct.gi),
        harm: harmVal,  // Canonical field
        category: sharedProduct.category || '',
        portions: clonePortions(sharedProduct.portions),
        sodium100: toNum(sharedProduct.sodium100),
        omega3_100: toNum(sharedProduct.omega3_100),
        omega6_100: toNum(sharedProduct.omega6_100),
        nova_group: toNum(sharedProduct.nova_group ?? sharedProduct.novaGroup),
        additives: sharedProduct.additives || null,
        nutrient_density: toNum(sharedProduct.nutrient_density ?? sharedProduct.nutrientDensity),
        is_organic: sharedProduct.is_organic ?? sharedProduct.isOrganic ?? null,
        is_whole_grain: sharedProduct.is_whole_grain ?? sharedProduct.isWholeGrain ?? null,
        is_fermented: sharedProduct.is_fermented ?? sharedProduct.isFermented ?? null,
        is_raw: sharedProduct.is_raw ?? sharedProduct.isRaw ?? null,
        vitamin_a: toNum(sharedProduct.vitamin_a),
        vitamin_c: toNum(sharedProduct.vitamin_c),
        vitamin_d: toNum(sharedProduct.vitamin_d),
        vitamin_e: toNum(sharedProduct.vitamin_e),
        vitamin_k: toNum(sharedProduct.vitamin_k),
        vitamin_b1: toNum(sharedProduct.vitamin_b1),
        vitamin_b2: toNum(sharedProduct.vitamin_b2),
        vitamin_b3: toNum(sharedProduct.vitamin_b3),
        vitamin_b6: toNum(sharedProduct.vitamin_b6),
        vitamin_b9: toNum(sharedProduct.vitamin_b9),
        vitamin_b12: toNum(sharedProduct.vitamin_b12),
        calcium: toNum(sharedProduct.calcium),
        iron: toNum(sharedProduct.iron),
        magnesium: toNum(sharedProduct.magnesium),
        phosphorus: toNum(sharedProduct.phosphorus),
        potassium: toNum(sharedProduct.potassium),
        zinc: toNum(sharedProduct.zinc),
        selenium: toNum(sharedProduct.selenium),
        iodine: toNum(sharedProduct.iodine),
        shared_origin_id: sharedProduct.id, // –°–≤—è–∑—å —Å shared –ø—Ä–æ–¥—É–∫—Ç–æ–º
        shared_updated_at: sharedProduct.updated_at || null, // –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ shared (–¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
        cloned_at: Date.now(), // –ö–æ–≥–¥–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å shared_updated_at)
        user_modified: false, // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç shared –µ—Å–ª–∏ –æ–±–Ω–æ–≤–∏–ª—Å—è)
        createdAt: Date.now()
      };

      // –î–æ–±–∞–≤–ª—è–µ–º derived –ø–æ–ª—è
      const withDerived = { ...clone, ...computeDerived(clone) };

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
      const newProducts = [...products, withDerived];
      console.info('[baza] üîµ cloneSharedProduct: –±—ã–ª–æ', products.length, '‚Üí —Å—Ç–∞–ª–æ', newProducts.length, '| id:', withDerived.id, '| –∏–º—è:', cloneName);
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –°–ò–ù–•–†–û–ù–ù–û –¥–æ setProducts (–∑–∞—â–∏—Ç–∞ –æ—Ç race —Å handleProductsUpdated)
      try {
        if (window.HEYS?.store?.set) {
          window.HEYS.store.set('heys_products', newProducts);
          console.info('[baza] üîµ cloneSharedProduct: localStorage —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ');
        }
      } catch (_) { }
      setProducts(newProducts);
      // Post-check
      setTimeout(() => {
        try {
          const ls = window.HEYS?.store?.get?.('heys_products') || [];
          const found = ls.find(p => p.id === withDerived.id);
          console.info('[baza] üîµ cloneSharedProduct POST-CHECK (50ms): ls.length=', ls.length, '| –Ω–∞–π–¥–µ–Ω:', !!found);
          if (!found) console.error('[baza] üîµ ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –∫–ª–æ–Ω –ù–ï —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ localStorage!');
        } catch (_) { }
      }, 50);

      HEYS.Toast?.success(`–ü—Ä–æ–¥—É–∫—Ç "${cloneName}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –±–∞–∑—É!`) || alert(`‚úÖ –ü—Ä–æ–¥—É–∫—Ç "${cloneName}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –±–∞–∑—É!`);
      return withDerived;
    }

    // –°–∫—Ä—ã—Ç—å –ø—Ä–æ–¥—É–∫—Ç (blocklist)
    async function hideSharedProduct(productId) {
      try {
        const result = await window.HEYS?.cloud?.blockProduct?.(productId);
        if (result?.error) {
          HEYS.Toast?.error('–û—à–∏–±–∫–∞: ' + result.error.message) || alert('–û—à–∏–±–∫–∞: ' + result.error.message);
          return;
        }
        // –£–±–∏—Ä–∞–µ–º –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        setSharedResults(prev => prev.filter(p => p.id !== productId));
        HEYS.Toast?.info('–ü—Ä–æ–¥—É–∫—Ç —Å–∫—Ä—ã—Ç –¥–ª—è –≤–∞—Å –∏ –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤') || alert('üö´ –ü—Ä–æ–¥—É–∫—Ç —Å–∫—Ä—ã—Ç –¥–ª—è –≤–∞—Å –∏ –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤');
      } catch (err) {
        console.error('[BLOCKLIST] Error:', err);
        HEYS.Toast?.error('–û—à–∏–±–∫–∞: ' + err.message) || alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (—Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä –∏–ª–∏ –∞–≤—Ç–æ—Ä)
    async function deleteSharedProduct(productId, productName) {
      const confirmed = confirm(`üóëÔ∏è –£–¥–∞–ª–∏—Ç—å "${productName}" –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã?\n\n–ü—Ä–æ–¥—É–∫—Ç –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.\n–£ —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –¥–æ–±–∞–≤–∏–ª –µ–≥–æ –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É ‚Äî –æ–Ω –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.`);
      if (!confirmed) return;

      try {
        const result = await window.HEYS?.cloud?.deleteSharedProduct?.(productId);
        if (!result?.success) {
          HEYS.Toast?.error('–û—à–∏–±–∫–∞: ' + (result?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')) || alert('–û—à–∏–±–∫–∞: ' + (result?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          return;
        }

        // –£–±–∏—Ä–∞–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞
        setAllSharedProducts(prev => prev.filter(p => p.id !== productId));
        setSharedResults(prev => prev.filter(p => p.id !== productId));

        HEYS.Toast?.success(`–ü—Ä–æ–¥—É–∫—Ç "${productName}" —É–¥–∞–ª—ë–Ω –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã`) || alert(`‚úÖ –ü—Ä–æ–¥—É–∫—Ç "${productName}" —É–¥–∞–ª—ë–Ω –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã`);
      } catch (err) {
        console.error('[DELETE SHARED] Error:', err);
        HEYS.Toast?.error('–û—à–∏–±–∫–∞: ' + err.message) || alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ shared –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É (anti-orphan)
    function cloneSharedToPersonal(sharedProduct) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–ª–æ–Ω —ç—Ç–æ–≥–æ shared –ø—Ä–æ–¥—É–∫—Ç–∞
      const existingClone = products.find(p => p.shared_origin_id === sharedProduct.id);
      if (existingClone) {
        return existingClone; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–æ–Ω
      }

      const cloneName = getCloneName(sharedProduct.name, products);

      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–ª–æ–Ω —Å shared_origin_id
      // Use centralized harm normalization
      const harmVal = HEYS.models?.normalizeHarm?.(sharedProduct);
      const clone = {
        id: uuid(),
        name: cloneName,
        simple100: sharedProduct.simple100 || 0,
        complex100: sharedProduct.complex100 || 0,
        protein100: sharedProduct.protein100 || 0,
        badFat100: sharedProduct.badfat100 || sharedProduct.badFat100 || 0,
        goodFat100: sharedProduct.goodfat100 || sharedProduct.goodFat100 || 0,
        trans100: sharedProduct.trans100 || 0,
        fiber100: sharedProduct.fiber100 || 0,
        gi: sharedProduct.gi || 0,
        harm: harmVal,  // Canonical field
        category: sharedProduct.category || '',
        portions: clonePortions(sharedProduct.portions),
        sodium100: toNum(sharedProduct.sodium100),
        omega3_100: toNum(sharedProduct.omega3_100),
        omega6_100: toNum(sharedProduct.omega6_100),
        nova_group: toNum(sharedProduct.nova_group ?? sharedProduct.novaGroup),
        additives: sharedProduct.additives || null,
        nutrient_density: toNum(sharedProduct.nutrient_density ?? sharedProduct.nutrientDensity),
        is_organic: sharedProduct.is_organic ?? sharedProduct.isOrganic ?? null,
        is_whole_grain: sharedProduct.is_whole_grain ?? sharedProduct.isWholeGrain ?? null,
        is_fermented: sharedProduct.is_fermented ?? sharedProduct.isFermented ?? null,
        is_raw: sharedProduct.is_raw ?? sharedProduct.isRaw ?? null,
        vitamin_a: toNum(sharedProduct.vitamin_a),
        vitamin_c: toNum(sharedProduct.vitamin_c),
        vitamin_d: toNum(sharedProduct.vitamin_d),
        vitamin_e: toNum(sharedProduct.vitamin_e),
        vitamin_k: toNum(sharedProduct.vitamin_k),
        vitamin_b1: toNum(sharedProduct.vitamin_b1),
        vitamin_b2: toNum(sharedProduct.vitamin_b2),
        vitamin_b3: toNum(sharedProduct.vitamin_b3),
        vitamin_b6: toNum(sharedProduct.vitamin_b6),
        vitamin_b9: toNum(sharedProduct.vitamin_b9),
        vitamin_b12: toNum(sharedProduct.vitamin_b12),
        calcium: toNum(sharedProduct.calcium),
        iron: toNum(sharedProduct.iron),
        magnesium: toNum(sharedProduct.magnesium),
        phosphorus: toNum(sharedProduct.phosphorus),
        potassium: toNum(sharedProduct.potassium),
        zinc: toNum(sharedProduct.zinc),
        selenium: toNum(sharedProduct.selenium),
        iodine: toNum(sharedProduct.iodine),
        shared_origin_id: sharedProduct.id, // –°–≤—è–∑—å —Å shared
        shared_updated_at: sharedProduct.updated_at || null, // –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ shared
        cloned_at: Date.now(), // –ö–æ–≥–¥–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª–∏
        user_modified: false, // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª
        createdAt: Date.now()
      };
      const d = computeDerived(clone);
      const newProduct = { ...clone, ...d };

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ products (cloneSharedToPersonal)
      console.info('[baza] üîµ cloneSharedToPersonal: id:', newProduct.id, '| –∏–º—è:', newProduct.name);
      setProducts(prev => {
        const newList = [...prev, newProduct];
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –°–ò–ù–•–†–û–ù–ù–û (–∑–∞—â–∏—Ç–∞ –æ—Ç race)
        try {
          if (window.HEYS?.store?.set) {
            window.HEYS.store.set('heys_products', newList);
            console.info('[baza] üîµ cloneSharedToPersonal: localStorage —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, count:', newList.length);
          }
        } catch (_) { }
        return newList;
      });

      return newProduct;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ (—Å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º shared)
    function handleProductSelect(product) {
      if (product._source === 'shared') {
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º shared –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É
        return cloneSharedToPersonal(product);
      }
      return product;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—è–≥–∫–æ–≥–æ merge ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
    function handleMergeUseExisting() {
      const { existing } = mergeModal;
      if (!existing) return;

      // –ö–ª–æ–Ω–∏—Ä—É–µ–º existing –∏–∑ shared –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É
      cloneSharedToPersonal(existing);

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–±–µ –º–æ–¥–∞–ª–∫–∏
      setMergeModal({ show: false, existing: null, draft: null });
      resetDraft();
      setShowModal(false);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—è–≥–∫–æ–≥–æ merge ‚Äî —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π (–ù–ï –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ shared)
    function handleMergeCreateOwn() {
      const { draft: draftProduct } = mergeModal;
      if (!draftProduct) return;

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—É—é –±–∞–∑—É (–±–µ–∑ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ shared)
      console.info('[baza] üü° handleMergeCreateOwn: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω—É—é, id:', draftProduct.id, '| –∏–º—è:', draftProduct.name);
      setProducts(prev => {
        const newList = [...prev, draftProduct];
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –°–ò–ù–•–†–û–ù–ù–û (–∑–∞—â–∏—Ç–∞ –æ—Ç race)
        try {
          if (window.HEYS?.store?.set) {
            window.HEYS.store.set('heys_products', newList);
            console.info('[baza] üü° handleMergeCreateOwn: localStorage —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, count:', newList.length);
          }
        } catch (_) { }
        return newList;
      });

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
      setMergeModal({ show: false, existing: null, draft: null });
      resetDraft();
      setShowModal(false);
    }

    // –ù–∞ –≤–∫–ª–∞–¥–∫–µ "–õ–∏—á–Ω—ã–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–∏—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–±–µ–∑ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
    // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –º–æ–¥–∞–ª–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –ø—Ä–∏—ë–º –ø–∏—â–∏

    return React.createElement('div', { className: 'page page-ration' },
      // === –ü–û–î–í–ö–õ–ê–î–ö–ò (Subtabs) ===
      React.createElement('div', { className: 'card', style: { marginBottom: '8px', padding: '8px 12px' } },
        React.createElement('div', {
          className: 'ration-subtabs',
          style: { display: 'flex', gap: '4px', background: 'var(--bg-secondary, #f3f4f6)', borderRadius: '8px', padding: '4px' }
        },
          // üë§ –õ–∏—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: "–ú–æ–∏", –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞: "–ö–ª–∏–µ–Ω—Ç–∞")
          React.createElement('button', {
            className: activeSubtab === 'personal' ? 'btn acc' : 'btn',
            onClick: () => {
              if (activeSubtab !== 'personal') setActiveSubtab('personal');
            },
            style: { flex: 1, borderRadius: '6px' }
          }, isCurator ? 'üë§ –õ–∏—á–Ω—ã–µ' : 'üë§ –ú–æ–∏ –ø—Ä–æ–¥—É–∫—Ç—ã'),
          // üåê –û–±—â–∞—è –±–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
          isCurator && React.createElement('button', {
            className: activeSubtab === 'shared' ? 'btn acc' : 'btn',
            onClick: () => {
              if (activeSubtab !== 'shared') setActiveSubtab('shared');
            },
            style: { flex: 1, borderRadius: '6px', position: 'relative' }
          },
            'üåê –û–±—â–∞—è –±–∞–∑–∞',
            // –ë–µ–π–¥–∂ pending
            pendingProducts.length > 0 && React.createElement('span', {
              style: {
                position: 'absolute',
                top: '-4px',
                right: '-4px',
                background: '#ef4444',
                color: '#fff',
                borderRadius: '50%',
                minWidth: '18px',
                height: '18px',
                fontSize: '11px',
                fontWeight: '600',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }
            }, pendingProducts.length)
          )
        )
      ),

      // === –ö–û–ù–¢–ï–ù–¢ –ü–û–î–í–ö–õ–ê–î–ö–ò ===
      React.createElement('div', {
        key: `ration-subtab-${activeSubtab}`,
        className: 'ration-subtab-content'
      }, activeSubtab === 'personal' ? (
        // ============================================
        // üë§ –ü–û–î–í–ö–õ–ê–î–ö–ê: –ü—Ä–æ–¥—É–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞
        // ============================================
        React.createElement(React.Fragment, null,

          // === –ë–≠–ö–ê–ü –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï (collapsible) ===
          React.createElement('div', {
            className: 'card',
            style: { marginBottom: '8px', padding: '0', overflow: 'hidden' }
          },
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è)
            React.createElement('div', {
              onClick: () => setShowBackupSection(!showBackupSection),
              style: {
                display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                padding: '12px 16px', cursor: 'pointer',
                background: showBackupSection ? 'var(--bg-secondary, #f9fafb)' : 'transparent',
                transition: 'background 0.2s'
              }
            },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                React.createElement('span', { style: { fontSize: '18px' } }, 'üíæ'),
                React.createElement('span', { style: { fontWeight: '500', fontSize: '14px' } }, '–ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ')
              ),
              React.createElement('span', {
                style: { fontSize: '12px', color: 'var(--text-muted)', transition: 'transform 0.2s', transform: showBackupSection ? 'rotate(180deg)' : 'rotate(0deg)' }
              }, '‚ñº')
            ),
            // –ö–æ–Ω—Ç–µ–Ω—Ç (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏)
            showBackupSection && React.createElement('div', { style: { padding: '0 16px 16px', borderTop: '1px solid var(--border-color, #e5e5e5)' } },

              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              // üì• –°–ö–ê–ß–ê–¢–¨ –ë–≠–ö–ê–ü
              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              React.createElement('div', {
                style: { marginTop: '16px', padding: '12px', background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)', borderRadius: '8px', border: '1px solid #93c5fd' }
              },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px' } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontWeight: '600', fontSize: '14px', color: '#1e40af', marginBottom: '4px' } }, 'üì• –°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø'),
                    React.createElement('div', { style: { fontSize: '12px', color: '#3b82f6' } }, '–ü—Ä–æ–¥—É–∫—Ç—ã + –¥–Ω–µ–≤–Ω–∏–∫ + –ø—Ä–æ—Ñ–∏–ª—å + –æ–±—â–∞—è –±–∞–∑–∞')
                  ),
                  React.createElement('button', {
                    className: 'btn acc',
                    onClick: async () => {
                      if (window.HEYS && window.HEYS.exportFullBackup) {
                        const result = await window.HEYS.exportFullBackup();
                        if (result && result.ok) {
                          HEYS.Toast?.success(`‚úÖ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\nüì¶ –ü—Ä–æ–¥—É–∫—Ç–æ–≤: ${result.products}\nüåê –û–±—â–∏—Ö: ${result.sharedProducts || 0}\nüìÖ –î–Ω–µ–π: ${result.days}`);
                        }
                      } else {
                        HEYS.Toast?.warning('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                      }
                    },
                    style: { whiteSpace: 'nowrap', background: '#3b82f6', borderColor: '#2563eb' }
                  }, 'üíæ –°–∫–∞—á–∞—Ç—å')
                )
              ),

              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              // üì§ –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –ò–ó –§–ê–ô–õ–ê
              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              React.createElement('div', {
                style: { marginTop: '12px', padding: '12px', background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', borderRadius: '8px', border: '1px solid #86efac' }
              },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px' } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontWeight: '600', fontSize: '14px', color: '#166534', marginBottom: '4px' } }, 'üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞'),
                    React.createElement('div', { style: { fontSize: '12px', color: '#15803d' } }, '–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –±—ç–∫–∞–ø–∞')
                  ),
                  React.createElement('label', {
                    className: 'btn acc',
                    style: { whiteSpace: 'nowrap', background: '#22c55e', borderColor: '#16a34a', cursor: 'pointer' }
                  },
                    'üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª',
                    React.createElement('input', {
                      type: 'file',
                      accept: '.json,application/json',
                      style: { display: 'none' },
                      onChange: (e) => {
                        const file = e.target.files?.[0];
                        if (file) {
                          importFromFile(file);
                          e.target.value = '';
                        }
                      }
                    })
                  )
                )
              ),

              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              // üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –û–ë–©–ï–ô –ë–ê–ó–û–ô
              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              React.createElement('div', {
                style: { marginTop: '12px', padding: '12px', background: 'var(--bg-secondary, #f9fafb)', borderRadius: '8px', border: '1px solid var(--border-color, #e5e5e5)' }
              },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px' } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontWeight: '500', fontSize: '13px', color: 'var(--text-primary)', marginBottom: '2px' } }, 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±—â–µ–π –±–∞–∑–æ–π'),
                    React.createElement('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, '–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –±–∞–∑—ã')
                  ),
                  React.createElement('button', {
                    className: 'btn',
                    onClick: restoreFromSharedBase,
                    style: { whiteSpace: 'nowrap' }
                  }, '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å')
                )
              ),

              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              // üîß –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
              // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              isCurator && React.createElement('div', {
                style: { marginTop: '16px', paddingTop: '12px', borderTop: '1px dashed var(--border-color, #e5e5e5)' }
              },
                React.createElement('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫—É—Ä–∞—Ç–æ—Ä–∞'),

                // –¢–æ–ª—å–∫–æ –ø—Ä–æ–¥—É–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px', marginBottom: '8px' } },
                  React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                    React.createElement('span', { style: { fontSize: '14px' } }, 'ü•ó'),
                    React.createElement('span', { style: { fontSize: '12px', color: 'var(--text-muted)' } }, `–¢–æ–ª—å–∫–æ –ø—Ä–æ–¥—É–∫—Ç—ã (${products.length} —à—Ç)`)
                  ),
                  React.createElement('button', {
                    className: 'btn',
                    onClick: exportProductsOnly,
                    style: { padding: '4px 10px', fontSize: '11px' }
                  }, '–°–∫–∞—á–∞—Ç—å')
                ),

                // –û–±—â–∞—è –±–∞–∑–∞ –¥–ª—è AI
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px' } },
                  React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                    React.createElement('span', { style: { fontSize: '14px' } }, 'üåê'),
                    React.createElement('span', { style: { fontSize: '12px', color: 'var(--text-muted)' } }, '–û–±—â–∞—è –±–∞–∑–∞ –¥–ª—è AI'),
                    sharedExportCount != null && React.createElement('span', {
                      style: { fontSize: '10px', background: '#dbeafe', color: '#1d4ed8', padding: '1px 5px', borderRadius: '4px', marginLeft: '4px' }
                    }, sharedExportCount)
                  ),
                  React.createElement('button', {
                    className: 'btn',
                    onClick: exportSharedProductsForAI,
                    style: { padding: '4px 10px', fontSize: '11px' }
                  }, '–°–∫–∞—á–∞—Ç—å')
                )
              )
            )
          ),

          // === –¢–ê–ë–õ–ò–¶–ê –ü–†–û–î–£–ö–¢–û–í (Personal) ===
          React.createElement('div', { className: 'card tone-blue' },
            React.createElement('div', { className: 'topbar' },
              React.createElement('div', { className: 'row' },
                React.createElement('input', { placeholder: '–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶', value: query, onChange: e => setQuery(e.target.value), style: { minWidth: '260px' } }),
                React.createElement('span', { className: 'muted' }, `–ù–∞–π–¥–µ–Ω–æ: ${filtered.length} –∏–∑ ${products.length}`)
              ),
              React.createElement('div', { className: 'row' },
                React.createElement('button', { className: 'btn acc', onClick: () => setShowModal(true) }, '+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç')
              )
            ),
            renderRangeButtons(personalRanges, personalRangeStart, (start) => {
              setPersonalRangeStart(start);
              setPersonalRangeActive(true);
            }, personalRangeActive),
            // üìä Unified Table Component
            React.createElement(UnifiedProductTable, {
              mode: 'personal',
              data: personalRangeActive
                ? filtered.slice(personalRangeStart, getRangeEnd(personalRangeStart, filtered.length))
                : filtered.slice(0, DEFAULT_DISPLAY_LIMIT),
              loading: false,
              callbacks: {
                onUpdateRow: updateRow,
                onOpenNameEditor: openProductNameEditor,
                onOpenPortionsEditor: openPortionsEditor,
                onDeleteRow: deleteRow,
                onSyncToShared: syncProductToShared,
                sharedNameMap: (() => {
                  const normalizeProductName = HEYS.models?.normalizeProductName
                    || ((name) => String(name || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));
                  const map = new Map();
                  const cached = window.HEYS?.cloud?.getCachedSharedProducts?.() || [];
                  const source = Array.isArray(allSharedProducts) && allSharedProducts.length ? allSharedProducts : cached;
                  source.forEach((sp) => {
                    if (sp?.name && sp?.id != null) {
                      map.set(normalizeProductName(sp.name), sp);
                    }
                  });
                  return map;
                })()
              }
            }),
            React.createElement('div', { className: 'muted', style: { marginTop: '8px' } }, '–°–µ—Ä—ã–µ –ø–æ–ª—è ‚Äî –∞–≤—Ç–æ: –£=–ø—Ä–æ—Å—Ç—ã–µ+—Å–ª–æ–∂–Ω—ã–µ; –ñ=–≤—Ä–µ–¥–Ω—ã–µ+–ø–æ–ª–µ–∑–Ω—ã–µ+—Å—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ; –ö–∫–∞–ª=3√ó–ë+4√ó–£+9√ó–ñ (TEF-aware).')
          )
        ) // –ó–∞–∫—Ä—ã–≤–∞–µ–º React.Fragment –¥–ª—è –ª–∏—á–Ω–æ–π –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏
      ) : (
        // ============================================
        // üåê –ü–û–î–í–ö–õ–ê–î–ö–ê: –û–±—â–∞—è –±–∞–∑–∞ (Curator-only)
        // ============================================
        React.createElement(React.Fragment, null,
          // –ë–ª–æ–∫ Pending-–∑–∞—è–≤–æ–∫
          React.createElement('div', { className: 'card', style: { marginBottom: '8px' } },
            React.createElement('div', {
              className: 'section-title',
              style: { display: 'flex', alignItems: 'center', gap: '8px' }
            },
              'üÜï –û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
              pendingProducts.length > 0 && React.createElement('span', {
                style: {
                  background: '#ef4444',
                  color: '#fff',
                  borderRadius: '12px',
                  padding: '2px 8px',
                  fontSize: '12px',
                  fontWeight: '600'
                }
              }, pendingProducts.length)
            ),
            pendingLoading ? (
              React.createElement('div', { style: { padding: '16px', textAlign: 'center', color: 'var(--text-muted)' } }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...')
            ) : pendingProducts.length === 0 ? (
              React.createElement('div', { style: { padding: '16px', textAlign: 'center', color: 'var(--text-muted)' } }, '‚úÖ –ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é')
            ) : (
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                pendingProducts.map(pending => {
                  const p = pending.product_data || {};
                  return React.createElement('div', {
                    key: pending.id,
                    className: 'card',
                    style: { padding: '12px', background: 'var(--bg-secondary, #f9fafb)', border: '1px solid var(--border-color, #e5e5e5)' }
                  },
                    React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px' } },
                      React.createElement('div', { style: { flex: 1 } },
                        React.createElement('div', { style: { fontWeight: '500', marginBottom: '4px' } }, p.name || pending.name_norm),
                        React.createElement('div', { style: { fontSize: '12px', color: 'var(--text-muted)', display: 'flex', gap: '8px', flexWrap: 'wrap' } },
                          React.createElement('span', null, `${Math.round(getDerivedKcal(p))} –∫–∫–∞–ª`),
                          React.createElement('span', null, `–ë:${p.protein100 || 0}`),
                          React.createElement('span', null, `–£:${(p.simple100 || 0) + (p.complex100 || 0)}`),
                          React.createElement('span', null, `–ñ:${(p.badFat100 || 0) + (p.goodFat100 || 0) + (p.trans100 || 0)}`),
                          p.gi && React.createElement('span', null, `–ì–ò:${p.gi}`)
                        ),
                        React.createElement('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' } },
                          `üìÖ ${new Date(pending.created_at).toLocaleDateString('ru-RU')}`
                        )
                      ),
                      React.createElement('div', { style: { display: 'flex', gap: '4px' } },
                        React.createElement('button', {
                          className: 'btn acc',
                          onClick: () => approvePending(pending),
                          style: { padding: '6px 10px', fontSize: '12px' }
                        }, '‚úÖ'),
                        React.createElement('button', {
                          className: 'btn',
                          onClick: () => {
                            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):');
                            if (reason !== null) rejectPending(pending, reason);
                          },
                          style: { padding: '6px 10px', fontSize: '12px' }
                        }, '‚ùå')
                      )
                    )
                  );
                })
              )
            )
          ),

          // –¢–∞–±–ª–∏—Ü–∞ –í–°–ï–• –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–±—â–µ–π –±–∞–∑—ã (–∫–∞–∫ –≤ –ª–∏—á–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ)
          // === –¢–ê–ë–õ–ò–¶–ê –ü–†–û–î–£–ö–¢–û–í (Shared) ===
          React.createElement('div', { className: 'card tone-blue' },
            React.createElement('div', { className: 'topbar' },
              React.createElement('div', { className: 'row' },
                React.createElement('input', {
                  placeholder: '–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶',
                  value: sharedQuery,
                  onChange: e => setSharedQuery(e.target.value),
                  style: { minWidth: '260px' }
                }),
                React.createElement('span', { className: 'muted' },
                  allSharedLoading ? '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...' : `–ù–∞–π–¥–µ–Ω–æ: ${filteredShared.length} –∏–∑ ${allSharedProducts.length}`
                )
              ),
              React.createElement('button', {
                className: 'btn acc',
                onClick: () => loadAllSharedProducts({ force: true }),
                style: { marginLeft: '8px' }
              }, 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å')
            ),
            renderRangeButtons(sharedRanges, sharedRangeStart, (start) => {
              setSharedRangeStart(start);
              setSharedRangeActive(true);
            }, sharedRangeActive),
            // üìä Unified Table Component
            React.createElement(UnifiedProductTable, {
              mode: 'shared',
              data: sharedRangeActive
                ? filteredShared.slice(sharedRangeStart, getRangeEnd(sharedRangeStart, filteredShared.length))
                : filteredShared.slice(0, DEFAULT_DISPLAY_LIMIT),
              loading: allSharedLoading,
              callbacks: {
                isCurator,
                onCloneShared: cloneSharedProduct,
                onHideShared: hideSharedProduct,
                onDeleteShared: deleteSharedProduct,
                onOpenSharedPortionsEditor: openSharedPortionsEditor
              }
            })
          )
        )
      )),
      showModal && React.createElement('div', { className: 'modal-backdrop', onClick: (e) => { if (e.target.classList.contains('modal-backdrop')) setShowModal(false); } },
        React.createElement('div', { className: 'modal' },
          React.createElement('div', { className: 'row', style: { justifyContent: 'space-between' } },
            React.createElement('div', null, '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç'),
            React.createElement('button', { className: 'btn', onClick: () => setShowModal(false) }, '√ó')
          ),
          React.createElement('div', { className: 'grid grid-2', style: { marginTop: '8px' } },
            React.createElement('div', null, React.createElement('label', null, '–ù–∞–∑–≤–∞–Ω–∏–µ'), React.createElement('input', { value: draft.name, onChange: e => setDraft({ ...draft, name: e.target.value }) })),
            React.createElement('div', null, React.createElement('label', null, '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'), React.createElement('input', { value: draft.category, onChange: e => setDraft({ ...draft, category: e.target.value }) })),
            React.createElement('div', null, React.createElement('label', null, '–ì–ò'), React.createElement('input', { type: 'text', value: draft.gi, onChange: e => setDraft({ ...draft, gi: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ü—Ä–æ—Å—Ç—ã–µ (100–≥)'), React.createElement('input', { type: 'text', value: draft.simple100, onChange: e => setDraft({ ...draft, simple100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–°–ª–æ–∂–Ω—ã–µ (100–≥)'), React.createElement('input', { type: 'text', value: draft.complex100, onChange: e => setDraft({ ...draft, complex100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ë–µ–ª–∫–∏ (100–≥)'), React.createElement('input', { type: 'text', value: draft.protein100, onChange: e => setDraft({ ...draft, protein100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'), React.createElement('input', { type: 'text', value: draft.badFat100, onChange: e => setDraft({ ...draft, badFat100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'), React.createElement('input', { type: 'text', value: draft.goodFat100, onChange: e => setDraft({ ...draft, goodFat100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–°—É–ø–µ—Ä–≤—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã (100–≥)'), React.createElement('input', { type: 'text', value: draft.trans100, onChange: e => setDraft({ ...draft, trans100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ (100–≥)'), React.createElement('input', { type: 'text', value: draft.fiber100, onChange: e => setDraft({ ...draft, fiber100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í—Ä–µ–¥–Ω–æ—Å—Ç—å (0‚Äì10)'), React.createElement('input', { type: 'text', value: draft.harm, onChange: e => setDraft({ ...draft, harm: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–£–≥–ª–µ–≤–æ–¥—ã (100–≥) ‚Äî –∞–≤—Ç–æ'), React.createElement('input', { className: 'readOnly', readOnly: true, value: derived.carbs100 })),
            React.createElement('div', null, React.createElement('label', null, '–ñ–∏—Ä—ã (100–≥) ‚Äî –∞–≤—Ç–æ'), React.createElement('input', { className: 'readOnly', readOnly: true, value: derived.fat100 })),
            React.createElement('div', null, React.createElement('label', null, '–ö–∞–ª–æ—Ä–∏–∏ (100–≥) ‚Äî –∞–≤—Ç–æ'), React.createElement('input', { className: 'readOnly', readOnly: true, value: derived.kcal100 }))
          ),
          React.createElement('div', { className: 'row' },
            React.createElement('button', {
              className: 'btn',
              onClick: () => setExpandedSections({ ...expandedSections, extra: !expandedSections.extra })
            }, `${expandedSections.extra ? '‚ñº' : '‚ñ∂'} –î–æ–ø. –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã`)
          ),
          expandedSections.extra && React.createElement('div', { className: 'grid grid-2' },
            React.createElement('div', null, React.createElement('label', null, '–ù–∞—Ç—Ä–∏–π (–º–≥/100–≥)'), React.createElement('input', { type: 'text', value: draft.sodium100, onChange: e => setDraft({ ...draft, sodium100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω (–º–≥/100–≥)'), React.createElement('input', { type: 'text', value: draft.cholesterol100, onChange: e => setDraft({ ...draft, cholesterol100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä (–≥/100–≥)'), React.createElement('input', { type: 'text', value: draft.sugar100, onChange: e => setDraft({ ...draft, sugar100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–û–º–µ–≥–∞-3 (–≥/100–≥)'), React.createElement('input', { type: 'text', value: draft.omega3_100, onChange: e => setDraft({ ...draft, omega3_100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–û–º–µ–≥–∞-6 (–≥/100–≥)'), React.createElement('input', { type: 'text', value: draft.omega6_100, onChange: e => setDraft({ ...draft, omega6_100: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ó–∞–º–µ—Ç–∫–∞ –ø–æ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏'), React.createElement('input', { value: draft.harmNote, onChange: e => setDraft({ ...draft, harmNote: e.target.value }) }))
          ),
          React.createElement('div', { className: 'row' },
            React.createElement('button', {
              className: 'btn',
              onClick: () => setExpandedSections({ ...expandedSections, vitamins: !expandedSections.vitamins })
            }, `${expandedSections.vitamins ? '‚ñº' : '‚ñ∂'} –í–∏—Ç–∞–º–∏–Ω—ã (% –æ—Ç –Ω–æ—Ä–º—ã)`)
          ),
          expandedSections.vitamins && React.createElement('div', { className: 'grid grid-2' },
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω A'), React.createElement('input', { type: 'text', value: draft.vitaminA, onChange: e => setDraft({ ...draft, vitaminA: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω C'), React.createElement('input', { type: 'text', value: draft.vitaminC, onChange: e => setDraft({ ...draft, vitaminC: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω D'), React.createElement('input', { type: 'text', value: draft.vitaminD, onChange: e => setDraft({ ...draft, vitaminD: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω E'), React.createElement('input', { type: 'text', value: draft.vitaminE, onChange: e => setDraft({ ...draft, vitaminE: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω K'), React.createElement('input', { type: 'text', value: draft.vitaminK, onChange: e => setDraft({ ...draft, vitaminK: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω B1'), React.createElement('input', { type: 'text', value: draft.vitaminB1, onChange: e => setDraft({ ...draft, vitaminB1: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω B2'), React.createElement('input', { type: 'text', value: draft.vitaminB2, onChange: e => setDraft({ ...draft, vitaminB2: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω B3'), React.createElement('input', { type: 'text', value: draft.vitaminB3, onChange: e => setDraft({ ...draft, vitaminB3: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω B6'), React.createElement('input', { type: 'text', value: draft.vitaminB6, onChange: e => setDraft({ ...draft, vitaminB6: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω B9'), React.createElement('input', { type: 'text', value: draft.vitaminB9, onChange: e => setDraft({ ...draft, vitaminB9: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–í–∏—Ç–∞–º–∏–Ω B12'), React.createElement('input', { type: 'text', value: draft.vitaminB12, onChange: e => setDraft({ ...draft, vitaminB12: toNum(e.target.value) }) }))
          ),
          React.createElement('div', { className: 'row' },
            React.createElement('button', {
              className: 'btn',
              onClick: () => setExpandedSections({ ...expandedSections, minerals: !expandedSections.minerals })
            }, `${expandedSections.minerals ? '‚ñº' : '‚ñ∂'} –ú–∏–Ω–µ—Ä–∞–ª—ã (% –æ—Ç –Ω–æ—Ä–º—ã)`)
          ),
          expandedSections.minerals && React.createElement('div', { className: 'grid grid-2' },
            React.createElement('div', null, React.createElement('label', null, '–ö–∞–ª—å—Ü–∏–π'), React.createElement('input', { type: 'text', value: draft.calcium, onChange: e => setDraft({ ...draft, calcium: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ñ–µ–ª–µ–∑–æ'), React.createElement('input', { type: 'text', value: draft.iron, onChange: e => setDraft({ ...draft, iron: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ú–∞–≥–Ω–∏–π'), React.createElement('input', { type: 'text', value: draft.magnesium, onChange: e => setDraft({ ...draft, magnesium: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–§–æ—Å—Ñ–æ—Ä'), React.createElement('input', { type: 'text', value: draft.phosphorus, onChange: e => setDraft({ ...draft, phosphorus: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ö–∞–ª–∏–π'), React.createElement('input', { type: 'text', value: draft.potassium, onChange: e => setDraft({ ...draft, potassium: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–¶–∏–Ω–∫'), React.createElement('input', { type: 'text', value: draft.zinc, onChange: e => setDraft({ ...draft, zinc: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–°–µ–ª–µ–Ω'), React.createElement('input', { type: 'text', value: draft.selenium, onChange: e => setDraft({ ...draft, selenium: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–ô–æ–¥'), React.createElement('input', { type: 'text', value: draft.iodine, onChange: e => setDraft({ ...draft, iodine: toNum(e.target.value) }) }))
          ),
          React.createElement('div', { className: 'row' },
            React.createElement('button', {
              className: 'btn',
              onClick: () => setExpandedSections({ ...expandedSections, nova: !expandedSections.nova })
            }, `${expandedSections.nova ? '‚ñº' : '‚ñ∂'} NOVA –∏ –¥–æ–±–∞–≤–∫–∏`)
          ),
          expandedSections.nova && React.createElement('div', { className: 'grid grid-2' },
            React.createElement('div', null, React.createElement('label', null, 'NOVA –≥—Ä—É–ø–ø–∞ (1‚Äì4)'), React.createElement('input', { type: 'text', value: draft.novaGroup, onChange: e => setDraft({ ...draft, novaGroup: toNum(e.target.value) }) })),
            React.createElement('div', null, React.createElement('label', null, '–î–æ–±–∞–≤–∫–∏ (E-–∫–æ–¥—ã, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'), React.createElement('input', { value: draft.additives, onChange: e => setDraft({ ...draft, additives: e.target.value }) }))
          ),
          React.createElement('div', { className: 'row' },
            React.createElement('button', {
              className: 'btn',
              onClick: () => setExpandedSections({ ...expandedSections, flags: !expandedSections.flags })
            }, `${expandedSections.flags ? '‚ñº' : '‚ñ∂'} –§–ª–∞–≥–∏ –∫–∞—á–µ—Å—Ç–≤–∞`)
          ),
          expandedSections.flags && React.createElement('div', { className: 'grid grid-2' },
            React.createElement('label', null,
              React.createElement('input', { type: 'checkbox', checked: !!draft.isOrganic, onChange: e => setDraft({ ...draft, isOrganic: e.target.checked }) }),
              ' –û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π'
            ),
            React.createElement('label', null,
              React.createElement('input', { type: 'checkbox', checked: !!draft.isWholeGrain, onChange: e => setDraft({ ...draft, isWholeGrain: e.target.checked }) }),
              ' –¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π'
            ),
            React.createElement('label', null,
              React.createElement('input', { type: 'checkbox', checked: !!draft.isFermented, onChange: e => setDraft({ ...draft, isFermented: e.target.checked }) }),
              ' –§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π'
            ),
            React.createElement('label', null,
              React.createElement('input', { type: 'checkbox', checked: !!draft.isRaw, onChange: e => setDraft({ ...draft, isRaw: e.target.checked }) }),
              ' –°—ã—Ä–æ–π'
            )
          ),
          // Checkbox: –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±—â—É—é –±–∞–∑—É
          React.createElement('label', {
            style: { display: 'flex', alignItems: 'center', gap: '8px', marginTop: '12px', cursor: 'pointer' }
          },
            React.createElement('input', {
              type: 'checkbox',
              checked: publishToShared,
              onChange: e => setPublishToShared(e.target.checked),
              style: { width: '18px', height: '18px' }
            }),
            React.createElement('span', { style: { fontSize: '14px' } }, 'üåê –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±—â—É—é –±–∞–∑—É'),
            React.createElement('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } },
              isCurator ? '(—Å—Ä–∞–∑—É –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º)' : '(–Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –∫—É—Ä–∞—Ç–æ—Ä—É)'
            )
          ),
          React.createElement('div', { className: 'row', style: { justifyContent: 'flex-end', marginTop: '10px' } },
            React.createElement('button', { className: 'btn', onClick: () => { setShowModal(false); resetDraft(); } }, '–û—Ç–º–µ–Ω–∞'),
            React.createElement('button', { className: 'btn acc', onClick: addProduct }, '–î–æ–±–∞–≤–∏—Ç—å')
          )
        )
      ),
      // –ú–æ–¥–∞–ª–∫–∞ –º—è–≥–∫–æ–≥–æ merge –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ fingerprint
      mergeModal.show && React.createElement('div', { className: 'modal-backdrop', onClick: (e) => { if (e.target.classList.contains('modal-backdrop')) setMergeModal({ show: false, existing: null, draft: null }); } },
        React.createElement('div', { className: 'modal', style: { maxWidth: '400px' } },
          React.createElement('div', { style: { fontWeight: '600', fontSize: '16px', marginBottom: '12px' } }, 'üîç –ü–æ—Ö–æ–∂–∏–π –ø—Ä–æ–¥—É–∫—Ç —É–∂–µ –µ—Å—Ç—å'),
          React.createElement('div', { style: { background: 'var(--bg-secondary)', borderRadius: '8px', padding: '12px', marginBottom: '12px' } },
            React.createElement('div', { style: { fontWeight: '500' } }, mergeModal.existing?.name),
            React.createElement('div', { style: { fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' } },
              `${Math.round(getDerivedKcal(mergeModal.existing))} –∫–∫–∞–ª | ` +
              `–ë: ${mergeModal.existing?.protein100 || 0} | ` +
              `–£: ${(mergeModal.existing?.simple100 || 0) + (mergeModal.existing?.complex100 || 0)} | ` +
              `–ñ: ${(mergeModal.existing?.badfat100 || 0) + (mergeModal.existing?.goodfat100 || 0)}`
            )
          ),
          React.createElement('div', { style: { fontSize: '13px', color: 'var(--text-muted)', marginBottom: '16px' } },
            '–ü—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —É–∂–µ –µ—Å—Ç—å –≤ –æ–±—â–µ–π –±–∞–∑–µ. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:'
          ),
          React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
            React.createElement('button', {
              className: 'btn acc',
              onClick: handleMergeUseExisting,
              style: { width: '100%' }
            }, '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π'),
            React.createElement('button', {
              className: 'btn',
              onClick: handleMergeCreateOwn,
              style: { width: '100%' }
            }, '‚ûï –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—è)')
          )
        )
      )
    );
  }

  // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  const validateInput = (value, type) => {
    if (value === null || value === undefined) return false;
    if (type === 'number') return !isNaN(parseFloat(value));
    if (type === 'string') return typeof value === 'string' && value.length > 0;
    if (type === 'email') return typeof value === 'string' && value.includes('@');
    return true; // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞
  };

  // Emoji style management (twemoji | system)
  const getEmojiStyle = () => {
    try {
      const U = window.HEYS?.utils || {};
      return U.lsGet ? U.lsGet('heys_emoji_style', 'twemoji') : (localStorage.getItem('heys_emoji_style') || 'twemoji');
    } catch { return 'twemoji'; }
  };
  const setEmojiStyle = (style) => {
    const validStyles = ['twemoji', 'system'];
    if (!validStyles.includes(style)) style = 'twemoji';
    try {
      const U = window.HEYS?.utils || {};
      U.lsSet ? U.lsSet('heys_emoji_style', style) : localStorage.setItem('heys_emoji_style', style);
    } catch { }
    document.body.className = document.body.className.replace(/emoji-\w+/g, '') + ' emoji-' + style;
    // Reparse emoji if twemoji selected (single debounced pass)
    if (style === 'twemoji') {
      const target = document.getElementById('root') || document.body;
      if (window.scheduleTwemojiParse) {
        window.scheduleTwemojiParse(target);
      } else if (window.applyTwemoji) {
        window.applyTwemoji(target);
      }
    }
  };

  /**
   * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—á–∏—Å—Ç–∫–∏ localStorage
   * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: HEYS.utils.storageCleanup.analyze() / .cleanup()
   */
  const storageCleanup = {
    /**
     * –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è localStorage
     * @returns {Object} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
     */
    analyze: () => {
      const stats = {
        totalBytes: 0,
        itemCount: 0,
        items: [],
        byPrefix: {}
      };

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        const bytes = (key.length + value.length) * 2; // UTF-16

        stats.totalBytes += bytes;
        stats.itemCount++;
        stats.items.push({ key, bytes, kb: Math.round(bytes / 1024 * 10) / 10 });

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º
        const prefix = key.split('_').slice(0, 2).join('_');
        stats.byPrefix[prefix] = (stats.byPrefix[prefix] || 0) + bytes;
      }

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É
      stats.items.sort((a, b) => b.bytes - a.bytes);
      stats.totalKB = Math.round(stats.totalBytes / 1024 * 10) / 10;
      stats.totalMB = Math.round(stats.totalBytes / 1024 / 1024 * 100) / 100;

      console.log(`üìä localStorage: ${stats.totalKB}KB (${stats.totalMB}MB), ${stats.itemCount} items`);
      console.log('Top 10 by size:');
      stats.items.slice(0, 10).forEach((item, i) => {
        console.log(`  ${i + 1}. ${item.key}: ${item.kb}KB`);
      });

      return stats;
    },

    /**
     * –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
     * @param {Object} options - { daysOld: 90, dryRun: true }
     * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏
     */
    cleanup: (options = {}) => {
      const { daysOld = 90, dryRun = true } = options;
      const cutoff = Date.now() - (daysOld * 24 * 60 * 60 * 1000);
      const result = { removed: [], kept: [], freedBytes: 0 };

      // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–Ω–µ–π: heys_dayv2_YYYY-MM-DD –∏–ª–∏ heys_<clientId>_dayv2_YYYY-MM-DD
      const dayPattern = /heys_(?:[\w-]+_)?dayv2_(\d{4}-\d{2}-\d{2})/;

      for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        const match = key.match(dayPattern);

        if (match) {
          const dateStr = match[1];
          const date = new Date(dateStr);

          if (!isNaN(date.getTime()) && date.getTime() < cutoff) {
            const value = localStorage.getItem(key);
            const bytes = (key.length + value.length) * 2;

            if (dryRun) {
              result.removed.push({ key, date: dateStr, bytes });
            } else {
              localStorage.removeItem(key);
              result.removed.push({ key, date: dateStr, bytes });
            }
            result.freedBytes += bytes;
          } else {
            result.kept.push(key);
          }
        }
      }

      const freedKB = Math.round(result.freedBytes / 1024 * 10) / 10;

      if (dryRun) {
        console.log(`üßπ [DRY RUN] Would remove ${result.removed.length} old days (${freedKB}KB)`);
      } else {
        console.log(`‚úÖ Removed ${result.removed.length} old days (${freedKB}KB freed)`);
      }

      return result;
    }
  };

  /**
   * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–∑ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
   * @param {string} birthDate - –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
   * @returns {number} –í–æ–∑—Ä–∞—Å—Ç –≤ –≥–æ–¥–∞—Ö
   */
  function calcAgeFromBirthDate(birthDate) {
    if (!birthDate) return 0;
    const birth = new Date(birthDate);
    if (isNaN(birth.getTime())) return 0;

    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –≤–æ–∑—Ä–∞—Å—Ç–æ–º
   * @returns {Object} –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  function getProfile() {
    const p = lsGet('heys_profile', {}) || {};
    const g = p.gender || p.sex || '–ú—É–∂—Å–∫–æ–π';
    const sex = String(g).toLowerCase().startsWith('–∂') ? 'female' : 'male';

    // –í—ã—á–∏—Å–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∏–∑ birthDate (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –∏–ª–∏ –±–µ—Ä—ë–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π age
    let age = p.birthDate ? calcAgeFromBirthDate(p.birthDate) : (+p.age || 30);
    if (age < 10 || age > 120) age = 30; // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

    return {
      sex,
      gender: g,
      height: +p.height || 175,
      age,
      birthDate: p.birthDate || null,
      sleepHours: +p.sleepHours || 8,
      weight: +p.weight || 70,
      weightGoal: +p.weightGoal || 0,
      deficitPctTarget: +p.deficitPctTarget || 0,
      stepsGoal: +p.stepsGoal || 7000,
      insulinWaveHours: +p.insulinWaveHours || 3,
      cycleTrackingEnabled: !!p.cycleTrackingEnabled,
      firstName: p.firstName || '',
      lastName: p.lastName || ''
    };
  }

  HEYS.utils = { INVIS, NUM_RE, round1, uuid, toNum, toNumInput, computeDerived, lsGet, lsSet, parsePasted, validateInput, getEmojiStyle, setEmojiStyle, getCurrentClientId, storageCleanup, getProfile, calcAgeFromBirthDate };
  HEYS.validateInput = validateInput; // –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  HEYS.core = { validateInput }; // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç core —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

  // products helper API (thin wrapper over store + local fallback)
  const productsLogState = { lastGetAll: 0, lastSetAll: 0 };
  const shouldLogProducts = (type) => {
    // üîá v4.8.2: –û—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –≤–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ HEYS.debug.products = true
    const debugEnabled = !!(HEYS && HEYS.debug && HEYS.debug.products);
    if (!debugEnabled) return false; // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–æ –µ—Å–ª–∏ debug –Ω–µ –≤–∫–ª—é—á–µ–Ω
    const now = Date.now();
    const minInterval = 3000;
    const key = type === 'setAll' ? 'lastSetAll' : 'lastGetAll';
    if (now - productsLogState[key] < minInterval) return false;
    productsLogState[key] = now;
    return true;
  };

  HEYS.products = HEYS.products || {
    getAll: () => {
      const fromStore = (HEYS.store && HEYS.store.get && HEYS.store.get('heys_products', [])) || [];
      const fromUtils = (HEYS.utils && HEYS.utils.lsGet && HEYS.utils.lsGet('heys_products', [])) || [];
      let result = fromStore.length > 0 ? fromStore : fromUtils;

      // Fallback: if result is suspiciously small, try other clientId namespaces
      if (Array.isArray(result) && result.length <= 1) {
        try {
          const parseRaw = (raw) => {
            if (!raw) return null;
            if (typeof raw === 'object') return raw;
            if (typeof raw !== 'string') return null;
            if (raw.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
              return HEYS.store.decompress(raw);
            }
            try { return JSON.parse(raw); } catch { return null; }
          };

          const keys = Object.keys(localStorage).filter((key) => /^heys_[^_]+_products$/i.test(key));
          let best = null;
          let bestLen = 0;
          for (const key of keys) {
            const candidate = parseRaw(localStorage.getItem(key));
            const len = Array.isArray(candidate) ? candidate.length : 0;
            if (len > bestLen) {
              bestLen = len;
              best = candidate;
            }
          }

          if (best && bestLen > result.length) {
            if (HEYS.store?.set) {
              HEYS.store.set('heys_products', best);
            } else if (HEYS.utils?.lsSet) {
              HEYS.utils.lsSet('heys_products', best);
            }
            result = best;
          }
        } catch (e) { }
      }
      // üîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã
      if (shouldLogProducts('getAll')) {
        console.log('[PRODUCTS.getAll] fromStore:', fromStore.length, 'fromUtils:', fromUtils.length, 'result:', result.length);
      }
      return result;
    },
    setAll: (arr, opts = {}) => {
      const newLen = arr?.length || 0;
      const source = opts.source || 'unknown';

      // üîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º portions-sync
      if (source === 'portions-sync') {
        console.log('[PRODUCTS.setAll] portions-sync call', {
          newLen,
          firstProductPortions: arr?.[0]?.portions,
          hasStore: !!HEYS.store?.set,
          hasUtils: !!HEYS.utils?.lsSet
        });
      }

      // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω—å—à–∏–º –±–µ–∑ —è–≤–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –∫–æ–≥–¥–∞ sync –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
      // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –û–ë–ê –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Äî store (memory) –ò localStorage –Ω–∞–ø—Ä—è–º—É—é!
      // Memory cache –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º –µ—Å–ª–∏ sync –ø–∏—Å–∞–ª —á–µ—Ä–µ–∑ ls.setItem
      // v4.8.2: allowShrink –¥–ª—è cloud-sync —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º merge (—É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
      if (!opts.allowShrink) {
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º memory cache —á–µ—Ä–µ–∑ getAll
        const fromGetAll = HEYS.products.getAll?.() || [];

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –ù–ê–ü–†–Ø–ú–£–Æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ–≤–µ–µ —á–µ–º cache)
        // –ò—â–µ–º –í–°–ï –∫–ª—é—á–∏ —Å products —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –º–∞–∫—Å–∏–º—É–º
        let fromLocalStorage = [];
        try {
          const clientId = HEYS.currentClientId || '';
          // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–ª—é—á–µ–π
          const keysToTry = [
            clientId ? `heys_${clientId}_products` : null,
            'heys_products',
          ].filter(Boolean);

          // –¢–∞–∫–∂–µ –∏—â–µ–º –∫–ª—é—á–∏ –≤–∏–¥–∞ heys_{clientId}_products (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ clientId –¥—Ä—É–≥–æ–π)
          // üîß FIX v4.8.9: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–π regex –≤–º–µ—Å—Ç–æ includes('_products'),
          // –∏–Ω–∞—á–µ heys_hidden_products (–º–∞—Å—Å–∏–≤ ID, 300 —ç–ª–µ–º–µ–Ω—Ç–æ–≤) –º–∞—Ç—á–∏–ª—Å—è –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª setAll
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && /^heys_[^_]+_products$/.test(key)) {
              keysToTry.push(key);
            }
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏ –∏ –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º
          for (const key of keysToTry) {
            try {
              const raw = localStorage.getItem(key);
              if (raw) {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length > fromLocalStorage.length) {
                  fromLocalStorage = parsed;
                }
              }
            } catch (e) { /* skip invalid */ }
          }
        } catch (e) { /* ignore */ }

        // –ë–µ—Ä—ë–º –ú–ê–ö–°–ò–ú–£–ú –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        const currentLen = Math.max(fromGetAll.length, fromLocalStorage.length);

        if (currentLen > 0 && newLen < currentLen) {
          console.warn(`[PRODUCTS.setAll] ‚õî BLOCKED: –ø–æ–ø—ã—Ç–∫–∞ —É–º–µ–Ω—å—à–∏—Ç—å —Å ${currentLen} –¥–æ ${newLen} –±–µ–∑ allowShrink.`);
          console.warn(`[PRODUCTS.setAll] Source: ${opts.source || 'unknown'}, fromGetAll: ${fromGetAll.length}, fromLocalStorage: ${fromLocalStorage.length}`);
          console.warn('[PRODUCTS.setAll] Stack:', new Error().stack?.split('\n').slice(1, 5).join(' <- '));
          return; // –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º!
        }
      }

      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set('heys_products', arr);
        // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ portions-sync –∑–∞–ø–∏—Å–∞–ª–æ—Å—å
        if (source === 'portions-sync') {
          const verify = HEYS.store.get?.('heys_products') || [];
          console.log('[PRODUCTS.setAll] portions-sync STORED', {
            storedLen: verify.length,
            samplePortions: verify.find(p => p?.portions?.length > 0)?.portions
          });
        }
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet('heys_products', arr);
      }
    },
    watch: (fn) => { if (HEYS.store && HEYS.store.watch) return HEYS.store.watch('heys_products', fn); return () => { }; },

    /**
     * üåê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã –≤ –ª–∏—á–Ω—É—é
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ shared –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –ø—Ä–∏—ë–º –ø–∏—â–∏
     * @param {Object} sharedProduct - –ü—Ä–æ–¥—É–∫—Ç –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (—Å _fromShared —Ñ–ª–∞–≥–æ–º)
     * @returns {Object} –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å –ª–æ–∫–∞–ª—å–Ω—ã–º id (–∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å)
     */
    addFromShared: (sharedProduct) => {
      if (!sharedProduct) return null;

      // ü™¶ FIX v4.9.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º tombstones (heys_deleted_ids) –ø–æ NAME –ø–µ—Ä–µ–¥ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
      // Orphan recovery –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å addFromShared –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ ‚Äî –æ–Ω –ø–æ–ª—É—á–∏—Ç –ù–û–í–´–ô uuid,
      // –∏ id-only tombstone filter –µ–≥–æ –Ω–µ –ø–æ–π–º–∞–µ—Ç ‚Üí resurrection. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —ç—Ç–æ.
      try {
        const _tombstonesAdd = window.HEYS?.store?.get?.('heys_deleted_ids') || [];
        if (Array.isArray(_tombstonesAdd) && _tombstonesAdd.length > 0 && sharedProduct.name) {
          const normName = (n) => String(n || '').toLowerCase().trim();
          const deletedNames = new Set(_tombstonesAdd.map(t => normName(t.name)).filter(Boolean));
          if (deletedNames.has(normName(sharedProduct.name))) {
            console.info('[PRODUCTS.addFromShared] ü™¶ BLOCKED ‚Äî –ø—Ä–æ–¥—É–∫—Ç –≤ tombstones:', sharedProduct.name);
            return null;
          }
        }
      } catch (e) { /* ignore tombstone check errors */ }

      const products = HEYS.products.getAll();
      const mergeMissingFromShared = (existing) => {
        if (!existing) return existing;
        let changed = false;
        const next = { ...existing };
        // Use centralized harm normalization
        const sharedHarm = HEYS.models?.normalizeHarm?.(sharedProduct);
        if ((next.harm == null) && sharedHarm != null) {
          next.harm = sharedHarm;
          changed = true;
        }
        if (!next.shared_origin_id && sharedProduct.id) {
          next.shared_origin_id = sharedProduct.id;
          changed = true;
        }
        // üîß FIX: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º portions –∏–∑ shared –µ—Å–ª–∏ local –ø—É—Å—Ç–æ–π
        const localHasPortions = Array.isArray(next.portions) && next.portions.length > 0;
        const sharedHasPortions = Array.isArray(sharedProduct.portions) && sharedProduct.portions.length > 0;
        if (!localHasPortions && sharedHasPortions) {
          next.portions = sharedProduct.portions.map((p) => ({ ...p }));
          changed = true;
        }
        // üîß FIX: –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è (kcal100, carbs100, fat100) –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        // –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–≥ –∫–æ–≥–¥–∞ –ø—Ä–æ–¥—É–∫—Ç –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ –±–µ–∑ –∫–∞–ª–æ—Ä–∏–π
        if (next.kcal100 == null || next.kcal100 === 0) {
          const derived = computeDerived(next);
          if (derived.kcal100 > 0) {
            next.kcal100 = derived.kcal100;
            next.carbs100 = derived.carbs100;
            next.fat100 = derived.fat100;
            changed = true;
          }
        }
        if (!changed) return existing;
        const newProducts = products.map(p => p.id === existing.id ? { ...p, ...next } : p);
        HEYS.products.setAll(newProducts);
        return { ...existing, ...next };
      };

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ shared_origin_id (–µ—Å–ª–∏ —É–∂–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª–∏)
      if (sharedProduct.id) {
        const existingByOrigin = products.find(p => p.shared_origin_id === sharedProduct.id);
        if (existingByOrigin) {
          // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
          return mergeMissingFromShared(existingByOrigin);
        }
      }

      const normalizeName = (name) => (name || '').toLowerCase().trim();
      const getCloneName = (baseName) => {
        const safeBase = (baseName || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const hasName = (name) => products.some(p => normalizeName(p?.name) === normalizeName(name));

        if (!hasName(safeBase)) return safeBase;

        let candidate = `${safeBase} (–∫–æ–ø–∏—è)`;
        if (!hasName(candidate)) return candidate;

        let i = 2;
        while (hasName(`${safeBase} (–∫–æ–ø–∏—è ${i})`)) i += 1;
        return `${safeBase} (–∫–æ–ø–∏—è ${i})`;
      };

      const clonePortions = (portions) => {
        if (!Array.isArray(portions)) return portions ?? null;
        return portions.map((p) => ({ ...p }));
      };

      // –°–æ–∑–¥–∞—ë–º –∫–ª–æ–Ω
      // Use centralized harm normalization
      const harmVal = HEYS.models?.normalizeHarm?.(sharedProduct);
      const clone = {
        id: uuid(),
        name: getCloneName(sharedProduct.name),
        simple100: toNum(sharedProduct.simple100),
        complex100: toNum(sharedProduct.complex100),
        protein100: toNum(sharedProduct.protein100),
        badFat100: toNum(sharedProduct.badFat100 ?? sharedProduct.badfat100),
        goodFat100: toNum(sharedProduct.goodFat100 ?? sharedProduct.goodfat100),
        trans100: toNum(sharedProduct.trans100),
        fiber100: toNum(sharedProduct.fiber100),
        gi: toNum(sharedProduct.gi),
        harm: harmVal,  // Canonical field
        category: sharedProduct.category || '',
        portions: clonePortions(sharedProduct.portions),
        sodium100: toNum(sharedProduct.sodium100),
        omega3_100: toNum(sharedProduct.omega3_100),
        omega6_100: toNum(sharedProduct.omega6_100),
        nova_group: toNum(sharedProduct.nova_group ?? sharedProduct.novaGroup),
        additives: sharedProduct.additives || null,
        nutrient_density: toNum(sharedProduct.nutrient_density ?? sharedProduct.nutrientDensity),
        is_organic: sharedProduct.is_organic ?? sharedProduct.isOrganic ?? null,
        is_whole_grain: sharedProduct.is_whole_grain ?? sharedProduct.isWholeGrain ?? null,
        is_fermented: sharedProduct.is_fermented ?? sharedProduct.isFermented ?? null,
        is_raw: sharedProduct.is_raw ?? sharedProduct.isRaw ?? null,
        vitamin_a: toNum(sharedProduct.vitamin_a),
        vitamin_c: toNum(sharedProduct.vitamin_c),
        vitamin_d: toNum(sharedProduct.vitamin_d),
        vitamin_e: toNum(sharedProduct.vitamin_e),
        vitamin_k: toNum(sharedProduct.vitamin_k),
        vitamin_b1: toNum(sharedProduct.vitamin_b1),
        vitamin_b2: toNum(sharedProduct.vitamin_b2),
        vitamin_b3: toNum(sharedProduct.vitamin_b3),
        vitamin_b6: toNum(sharedProduct.vitamin_b6),
        vitamin_b9: toNum(sharedProduct.vitamin_b9),
        vitamin_b12: toNum(sharedProduct.vitamin_b12),
        calcium: toNum(sharedProduct.calcium),
        iron: toNum(sharedProduct.iron),
        magnesium: toNum(sharedProduct.magnesium),
        phosphorus: toNum(sharedProduct.phosphorus),
        potassium: toNum(sharedProduct.potassium),
        zinc: toNum(sharedProduct.zinc),
        selenium: toNum(sharedProduct.selenium),
        iodine: toNum(sharedProduct.iodine),
        shared_origin_id: sharedProduct.id, // –°–≤—è–∑—å —Å shared –ø—Ä–æ–¥—É–∫—Ç–æ–º
        fingerprint: sharedProduct.fingerprint, // üÜï v4.6.0: Fingerprint –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ recovery
        shared_updated_at: sharedProduct.updated_at || null, // –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ shared
        cloned_at: Date.now(), // –ö–æ–≥–¥–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª–∏
        user_modified: false, // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª
        createdAt: Date.now()
      };

      // –î–æ–±–∞–≤–ª—è–µ–º derived –ø–æ–ª—è (kcal100, carbs100, fat100)
      const withDerived = { ...clone, ...computeDerived(clone) };

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
      const newProducts = [...products, withDerived];
      HEYS.products.setAll(newProducts);

      // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
      return withDerived;
    },

    /**
     * –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ø–µ—Ä–≤—ã–π —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ—Å—Ç–∞—ë—Ç—Å—è)
     * @returns {{original: number, deduplicated: number, removed: number}} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
     */
    deduplicate: () => {
      const products = HEYS.products.getAll();
      const original = products.length;

      const seen = new Map();
      const unique = [];

      for (const p of products) {
        const key = (p.name || '').trim().toLowerCase();
        if (!seen.has(key)) {
          seen.set(key, true);
          unique.push(p);
        }
      }

      const removed = original - unique.length;

      if (removed > 0) {
        // allowShrink: true ‚Äî –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –î–û–õ–ñ–ù–ê —É–º–µ–Ω—å—à–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        HEYS.products.setAll(unique, { source: 'deduplicate', allowShrink: true });
      }

      return { original, deduplicated: unique.length, removed };
    },

    /**
     * üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º kcal100
     * –í—ã—á–∏—Å–ª—è–µ—Ç kcal100, carbs100, fat100 –∏–∑ –±–∞–∑–æ–≤—ã—Ö –ø–æ–ª–µ–π
     * @returns {{fixed: number, total: number}} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
     */
    fixMissingKcal: () => {
      const products = HEYS.products.getAll();
      let fixed = 0;
      const updated = products.map(p => {
        if (p.kcal100 == null || p.kcal100 === 0) {
          const derived = computeDerived(p);
          if (derived.kcal100 > 0) {
            fixed++;
            return { ...p, ...derived };
          }
        }
        return p;
      });
      if (fixed > 0) {
        HEYS.products.setAll(updated);
        console.log(`[HEYS] üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ${fixed} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –ø—É—Å—Ç—ã–º kcal100`);
      }
      return { fixed, total: products.length };
    }
  };
  HEYS.RationTab = RationTab;
  HEYS.Ration = RationTab;
})(window);


; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const U = HEYS.utils || {};
  if (!U.__clientScoped) {
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.store –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å compress/decompress
    const get0 = U.lsGet ? U.lsGet.bind(U) : (k, d) => {
      if (global.HEYS && global.HEYS.store && typeof global.HEYS.store.get === 'function') {
        return global.HEYS.store.get(k, d);
      }
      try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch (e) { return d; }
    };
    const set0 = U.lsSet ? U.lsSet.bind(U) : (k, v) => {
      if (global.HEYS && global.HEYS.store && typeof global.HEYS.store.set === 'function') {
        return global.HEYS.store.set(k, v);
      }
      try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { }
    };

    function nsKey(k) {
      // 1) —Ç–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç: –∏–∑ –≥–ª–æ–±–∞–ª–∞ –∏–ª–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
      let cid = (global.HEYS && HEYS.currentClientId) || '';
      if (!cid) {
        try { const raw = localStorage.getItem('heys_client_current'); if (raw) cid = JSON.parse(raw); } catch (e) { cid = ''; }
      }
      // 2) —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏ –ù–ï –ø—Ä–µ—Ñ–∏–∫—Å—É–µ–º (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
      // üîß v55 FIX: heys_session_token —Ç–æ–∂–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π (–Ω—É–∂–µ–Ω –î–û –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è clientId)
      if (/^heys_(clients|client_current|session_token)$/i.test(k)) return k;
      // 3) –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
      if (!cid) return k;
      // 4) –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—à–∏ –∫–ª—é—á–∏ –ø—Ä–µ—Ñ–∏–∫—Å—É–µ–º
      if (/^(heys_|day_)/i.test(k)) {
        return k.replace(/^(heys_|day_)/i, (m) => m + cid + '_');
      }
      return k;
    }

    U.lsGet = (k, d) => get0(nsKey(k), d);
    U.lsSet = (k, v) => set0(nsKey(k), v);
    U.__clientScoped = true;
  }
})(window);


/* ===== heys_yandex_api_v1.js ===== */
// heys_yandex_api_v1.js ‚Äî Yandex Cloud API adapter (152-–§–ó compliant)
// –ó–∞–º–µ–Ω–∞ Supabase –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API –≤ Yandex Cloud
// v58: Enhanced token detection with namespaced fallback + better diagnostics

; (function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const CONFIG = {
    // Production API (Yandex Cloud)
    API_URL: 'https://api.heyslab.ru',

    // Endpoints
    ENDPOINTS: {
      RPC: '/rpc',
      REST: '/rest',
      SMS: '/sms',
      LEADS: '/leads',
      HEALTH: '/health',
      AUTH_LOGIN: '/auth/login',
      AUTH_VERIFY: '/auth/verify'
    },

    // –¢–∞–π–º–∞—É—Ç—ã (–Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–µ: 1—è –ø–æ–ø—ã—Ç–∫–∞ 15—Å, 2—è 20—Å, 3—è 30—Å)
    TIMEOUT_MS: 15000,
    TIMEOUT_ESCALATION_MS: [15000, 20000, 30000],

    // Retry –ª–æ–≥–∏–∫–∞ (exponential backoff: 2—Å ‚Üí 5—Å ‚Üí 10—Å)
    // v59 FIX I: Increased delays for cold-start resilience.
    // 502 returns instantly (not timeout), so retry window = sum of delays.
    // Old [1000,3000,7000] gave only 4s ‚Äî less than CF cold start (>4s).
    // New [2000,5000,10000] gives 7s ‚Äî enough for CF warm-up.
    MAX_RETRIES: 2,
    RETRY_DELAY_MS: 2000,
    RETRY_DELAY_ESCALATION_MS: [2000, 5000, 10000]
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üåê –°–û–°–¢–û–Ø–ù–ò–ï
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let _isOnline = true;
  let _lastError = null;
  let _curatorTokenLogged = false;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß –£–¢–ò–õ–ò–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Debug –ª–æ–≥–∏ ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ localStorage.heys_debug_api = 'true'
  function log(...args) {
    if (global.localStorage?.getItem('heys_debug_api') === 'true') {
      console.info('[HEYS.api]', ...args);
    }
  }

  // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ ‚Äî –í–°–ï–ì–î–ê –≤–∏–¥–Ω—ã
  function logInfo(...args) {
    console.info('[HEYS.api]', ...args);
  }

  function err(...args) {
    console.error('[HEYS.api] ‚ùå', ...args);
  }

  /**
   * –í—ã–ø–æ–ª–Ω–∏—Ç—å fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º
   */
  async function fetchWithTimeout(url, options, timeoutMs = CONFIG.TIMEOUT_MS) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      return response;
    } catch (e) {
      clearTimeout(timeoutId);
      if (e.name === 'AbortError') {
        throw new Error('Request timeout');
      }
      throw e;
    }
  }

  /**
   * –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å retry (exponential backoff + –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–π —Ç–∞–π–º–∞—É—Ç)
   */
  async function fetchWithRetry(url, options, retries = CONFIG.MAX_RETRIES) {
    let lastError;

    for (let i = 0; i <= retries; i++) {
      // ‚è±Ô∏è –ù–∞—Ä–∞—Å—Ç–∞—é—â–∏–π —Ç–∞–π–º–∞—É—Ç: 15—Å ‚Üí 20—Å ‚Üí 30—Å
      const timeoutMs = CONFIG.TIMEOUT_ESCALATION_MS[i] || CONFIG.TIMEOUT_MS;
      try {
        const response = await fetchWithTimeout(url, options, timeoutMs);

        // üîÑ v58 FIX: Retry on server errors (502/503/504) ‚Äî cold start recovery
        // Yandex API Gateway returns 502 when cloud function times out on cold start.
        // Without this check, fetchWithRetry returns 502 as valid response (no retry).
        const retryableStatuses = [502, 503, 504];
        if (retryableStatuses.includes(response.status)) {
          const msg = `Server error ${response.status} (retryable)`;
          err(`Attempt ${i + 1}/${retries + 1}: ${msg}`);
          throw new Error(msg);
        }

        return response;
      } catch (e) {
        lastError = e;
        err(`Attempt ${i + 1}/${retries + 1} failed (timeout=${timeoutMs}ms):`, e.message);

        if (i < retries) {
          // ‚è±Ô∏è Exponential backoff: 1—Å ‚Üí 3—Å ‚Üí 7—Å
          const delay = CONFIG.RETRY_DELAY_ESCALATION_MS[i] || CONFIG.RETRY_DELAY_MS;
          console.info(`[HEYS.api] ‚Ü©Ô∏è Retry ${i + 1}/${retries} in ${delay}ms...`);
          await new Promise(r => setTimeout(r, delay));
        }
      }
    }

    _isOnline = false;
    _lastError = lastError;
    throw lastError;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å JWT —Ç–æ–∫–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–∑ localStorage
   * üîß v57 FIX: –ß–∏—Ç–∞–µ–º heys_curator_session (–∫—É—Ä–∞—Ç–æ—Ä JWT), –∞ –ù–ï heys_supabase_auth_token (Supabase auth)
   * @returns {string|null}
   */
  function getCuratorToken() {
    try {
      // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º curator JWT (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á)
      const curatorSession = localStorage.getItem('heys_curator_session');
      if (curatorSession) {
        log('getCuratorToken: using heys_curator_session');
        if (!_curatorTokenLogged) {
          logInfo('üîê [HEYS.auth] –¢–æ–∫–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞ –Ω–∞–π–¥–µ–Ω (heys_curator_session)');
          _curatorTokenLogged = true;
        }
        return curatorSession;
      }

      // 2. Fallback: legacy supabase auth (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      const supabaseAuth = localStorage.getItem('heys_supabase_auth_token');
      if (supabaseAuth) {
        const parsed = JSON.parse(supabaseAuth);
        if (parsed?.access_token) {
          log('getCuratorToken: fallback to heys_supabase_auth_token');
          if (!_curatorTokenLogged) {
            logInfo('üîê [HEYS.auth] –¢–æ–∫–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞ –Ω–∞–π–¥–µ–Ω (legacy heys_supabase_auth_token)');
            _curatorTokenLogged = true;
          }
          return parsed.access_token;
        }
      }

      return null;
    } catch (e) {
      err('getCuratorToken failed:', e.message);
      return null;
    }
  }

  /**
   * üîê v56: –ü–æ–ª—É—á–∏—Ç—å user_id –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–∑ auth token
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è REST upsert –æ–ø–µ—Ä–∞—Ü–∏–π
   * @returns {string|null}
   */
  function getCuratorUserId() {
    try {
      const stored = localStorage.getItem('heys_supabase_auth_token');
      if (!stored) return null;
      const parsed = JSON.parse(stored);
      return parsed?.user?.id || null;
    } catch (e) {
      err('getCuratorUserId failed:', e.message);
      return null;
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üì° API –ú–ï–¢–û–î–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // üîê –§—É–Ω–∫—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ JWT —Ç–æ–∫–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞
  const CURATOR_ONLY_FUNCTIONS = [
    // === CLIENT MANAGEMENT ===
    'create_client_with_pin',
    'reset_client_pin',
    'get_curator_clients',
    'admin_get_all_clients',

    // === SUBSCRIPTION MANAGEMENT ===
    'admin_extend_subscription',
    'admin_cancel_subscription',
    'admin_extend_trial',

    // === TRIAL QUEUE ADMIN ===
    'admin_get_trial_queue_list',
    'admin_add_to_queue',
    'admin_remove_from_queue',
    'admin_send_offer',
    'admin_activate_trial',           // üÜï v4.0: JWT-only
    'admin_reject_request',
    'admin_get_queue_stats',
    'admin_update_queue_settings',

    // === LEADS MANAGEMENT (v3.0) ===
    'admin_get_leads',
    'admin_convert_lead',
    'admin_update_lead_status',       // üÜï v3.0: –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ª–∏–¥–æ–≤

    // === GAMIFICATION AUDIT ===
    'log_gamification_event_by_curator',
    'get_gamification_events_by_curator',
    'delete_gamification_events_by_curator',
  ];

  /**
   * RPC –≤—ã–∑–æ–≤ (PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è)
   * @param {string} fnName - –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏ (get_client_salt, verify_client_pin, etc.)
   * @param {object} params - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏
   * @returns {Promise<{data: any, error: any}>}
   */
  async function rpc(fnName, params = {}) {
    const url = `${CONFIG.API_URL}${CONFIG.ENDPOINTS.RPC}?fn=${encodeURIComponent(fnName)}`;

    try {
      log(`RPC: ${fnName}`, params);

      // üîê –î–ª—è curator-only —Ñ—É–Ω–∫—Ü–∏–π –¥–æ–±–∞–≤–ª—è–µ–º JWT —Ç–æ–∫–µ–Ω
      const headers = {
        'Content-Type': 'application/json'
      };

      if (CURATOR_ONLY_FUNCTIONS.includes(fnName)) {
        const curatorToken = getCuratorToken();
        if (!curatorToken) {
          err(`RPC ${fnName} requires curator token, but none found`);
          return { data: null, error: { message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞', code: 'UNAUTHORIZED' } };
        }
        headers['Authorization'] = `Bearer ${curatorToken}`;
        log(`RPC: ${fnName} ‚Äî adding curator JWT`);
      }

      const response = await fetchWithRetry(url, {
        method: 'POST',
        headers,
        body: JSON.stringify(params)
      });

      const data = await response.json();

      if (!response.ok) {
        try {
          console.error('[HEYS.api] ‚ùå RPC failed', {
            fn: fnName,
            code: response.status,
            message: data?.error || 'RPC error',
            details: data?.details,
            rawKeys: data ? Object.keys(data) : []
          });
        } catch (_) { }
        return {
          data: null,
          error: {
            message: data.error || 'RPC error',
            code: response.status,
            details: data.details,
            raw: data
          }
        };
      }

      return { data, error: null };
    } catch (e) {
      err(`RPC ${fnName} failed:`, e.message);
      return { data: null, error: { message: e.message, code: 'NETWORK_ERROR' } };
    }
  }

  /**
   * REST –∑–∞–ø—Ä–æ—Å (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
   * @param {string} table - –ò–º—è —Ç–∞–±–ª–∏—Ü—ã
   * @param {object} options - { method, filters, data, select, limit, offset, order, upsert, onConflict }
   * @returns {Promise<{data: any, error: any}>}
   */
  async function rest(table, options = {}) {
    const { method = 'GET', filters = {}, data = null, select, limit, offset, order, upsert, onConflict } = options;

    // –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (—Ñ–æ—Ä–º–∞—Ç: /rest/v1/{table}?params)
    const params = new URLSearchParams();
    if (select) params.set('select', select);
    if (limit) params.set('limit', String(limit));
    if (offset) params.set('offset', String(offset));
    if (order) params.set('order', order);
    if (upsert) params.set('upsert', 'true');
    if (onConflict) params.set('on_conflict', onConflict);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Supabase: eq.column=value ‚Üí column=eq.value
    Object.entries(filters).forEach(([key, value]) => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º undefined –∑–Ω–∞—á–µ–Ω–∏—è
      if (value === undefined || value === 'undefined') return;
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç: eq.id ‚Üí id=eq.value, gt.updated_at ‚Üí updated_at=gt.value
      const dotIdx = key.indexOf('.');
      if (dotIdx > 0) {
        const op = key.slice(0, dotIdx);  // eq, in, gt, gte, lt, lte, like, neq
        const col = key.slice(dotIdx + 1);
        params.set(col, `${op}.${value}`);
      } else {
        params.set(key, String(value));
      }
    });

    const queryString = params.toString();
    const url = `${CONFIG.API_URL}/rest/v1/${table}${queryString ? '?' + queryString : ''}`;

    try {
      log(`REST: ${method} ${table}`, filters);

      const fetchOptions = {
        method,
        headers: {
          'Content-Type': 'application/json'
        }
      };

      if (data && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
        fetchOptions.body = JSON.stringify(data);
      }

      const response = await fetchWithRetry(url, fetchOptions);
      const result = await response.json();

      // v60: REST POST –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {success, rowCount, inserted} –≤–º–µ—Å—Ç–æ –º–∞—Å—Å–∏–≤–∞
      const displayCount = Array.isArray(result) ? result.length : (result?.rowCount || result?.inserted || 'obj');
      log(`REST RESPONSE: ${table}`, { status: response.status, rowCount: displayCount, success: result?.success, error: result?.error });

      if (!response.ok) {
        return { data: null, error: { message: result.error || result.message || 'REST error', code: response.status } };
      }

      return { data: result, error: null };
    } catch (e) {
      err(`REST ${method} ${table} failed:`, e.message);
      return { data: null, error: { message: e.message, code: 'NETWORK_ERROR' } };
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∫–∞ SMS
   * @param {string} phone - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  async function sendSMS(phone, message) {
    const url = `${CONFIG.API_URL}${CONFIG.ENDPOINTS.SMS}`;

    try {
      log(`SMS: ${phone}`);

      const response = await fetchWithRetry(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ to: phone, msg: message })
      });

      const data = await response.json();

      if (!response.ok || data.status_code !== 100) {
        return { success: false, error: data.status_text || data.error || 'SMS error' };
      }

      return { success: true };
    } catch (e) {
      err('SMS failed:', e.message);
      return { success: false, error: e.message };
    }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏–¥–∞ (—Å –ª–µ–Ω–¥–∏–Ω–≥–∞)
   * @param {object} leadData - { name, phone, messenger, utm_* }
   * @returns {Promise<{success: boolean, id?: string, error?: string}>}
   */
  async function saveLead(leadData) {
    const url = `${CONFIG.API_URL}${CONFIG.ENDPOINTS.LEADS}`;

    try {
      log('Lead:', leadData.phone);

      const response = await fetchWithRetry(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(leadData)
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        return { success: false, error: data.error || 'Lead save error' };
      }

      return { success: true, id: data.id };
    } catch (e) {
      err('Lead save failed:', e.message);
      return { success: false, error: e.message };
    }
  }

  /**
   * Health check
   * @returns {Promise<boolean>}
   */
  async function healthCheck() {
    const url = `${CONFIG.API_URL}${CONFIG.ENDPOINTS.HEALTH}`;

    try {
      const response = await fetchWithTimeout(url, { method: 'GET' }, 5000);
      const data = await response.json();
      _isOnline = response.ok && data.status === 'ok';
      return _isOnline;
    } catch (e) {
      _isOnline = false;
      return false;
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîê CURATOR AUTH (JWT-based)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –í—Ö–æ–¥ –∫—É—Ä–∞—Ç–æ—Ä–∞ (email + password)
   * @param {string} email - Email –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @param {string} password - –ü–∞—Ä–æ–ª—å
   * @returns {Promise<{data: {access_token, user, expires_in, expires_at}, error: any}>}
   */
  async function curatorLogin(email, password) {
    const url = `${CONFIG.API_URL}${CONFIG.ENDPOINTS.AUTH_LOGIN}`;

    try {
      log(`Curator login: ${email}`);

      const response = await fetchWithRetry(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        return {
          data: null,
          error: { message: data.error || 'Login failed', code: response.status }
        };
      }

      // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç: { access_token, token_type, expires_in, user }
      if (data?.user?.id) {
        logInfo('üîê [HEYS.auth] –í—Ö–æ–¥ –∫—É—Ä–∞—Ç–æ—Ä–∞ OK:', `${data.user.id.slice(0, 8)}...`);
      } else {
        logInfo('üîê [HEYS.auth] –í—Ö–æ–¥ –∫—É—Ä–∞—Ç–æ—Ä–∞ OK');
      }
      return {
        data: {
          access_token: data.access_token,
          user: data.user,
          expires_in: data.expires_in,
          expires_at: Math.floor(Date.now() / 1000) + (data.expires_in || 86400)
        },
        error: null
      };
    } catch (e) {
      err('Curator login failed:', e.message);
      return { data: null, error: { message: e.message, code: 'NETWORK_ERROR' } };
    }
  }

  /**
   * –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @param {string} token - JWT —Ç–æ–∫–µ–Ω
   * @returns {Promise<{data: {valid: boolean, user?: object}, error: any}>}
   */
  async function verifyCuratorToken(token) {
    const url = `${CONFIG.API_URL}${CONFIG.ENDPOINTS.AUTH_VERIFY}`;

    try {
      log('Verifying curator token');

      const response = await fetchWithRetry(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ token })
      });

      const data = await response.json();

      if (!response.ok || !data.valid) {
        logInfo('üîê [HEYS.auth] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: invalid');
        return {
          data: { valid: false },
          error: data.error ? { message: data.error } : null
        };
      }

      if (data?.user?.id) {
        logInfo('üîê [HEYS.auth] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: valid', `${data.user.id.slice(0, 8)}...`);
      } else {
        logInfo('üîê [HEYS.auth] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞: valid');
      }

      return { data: { valid: true, user: data.user }, error: null };
    } catch (e) {
      err('Token verification failed:', e.message);
      return { data: { valid: false }, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîê AUTH –ú–ï–¢–û–î–´ (REST-based ‚Äî –Ω–∞–¥—ë–∂–Ω–µ–µ —á–µ–º RPC!)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–ª—å –¥–ª—è PIN (REST-based)
   * @param {string} phone - –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
   * @returns {Promise<{data: {salt, client_id, locked_until}[], error: any}>}
   */
  async function getClientSalt(phone) {
    try {
      log(`getClientSalt (REST): phone=${phone}`);

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
      const result = await rest('clients', {
        filters: { 'eq.phone': phone },
        select: 'id,pin_salt,pin_locked_until,pin_failed_attempts'
      });

      if (result.error) {
        return { data: null, error: result.error };
      }

      const client = result.data?.[0];
      if (!client) {
        return { data: [], error: null }; // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ = –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
      if (client.pin_locked_until) {
        const lockedUntil = new Date(client.pin_locked_until);
        if (lockedUntil > new Date()) {
          return {
            data: [{
              salt: null,
              client_id: client.id,
              locked_until: client.pin_locked_until
            }],
            error: null
          };
        }
      }

      return {
        data: [{
          salt: client.pin_salt,
          client_id: client.id,
          locked_until: null
        }],
        error: null
      };
    } catch (e) {
      err('getClientSalt failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å PIN (REST-based)
   * @param {string} phone - –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
   * @param {string} pinHash - –•–µ—à PIN
   * @returns {Promise<{data: {success, client_id, name, error, remaining_attempts}[], error: any}>}
   */
  async function verifyClientPin(phone, pinHash) {
    try {
      log(`verifyClientPin (REST): phone=${phone}`);

      // –ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ —Å pin_hash
      const result = await rest('clients', {
        filters: { 'eq.phone': phone },
        select: 'id,name,pin_hash,pin_salt,pin_failed_attempts,pin_locked_until'
      });

      if (result.error) {
        return { data: null, error: result.error };
      }

      const client = result.data?.[0];
      if (!client) {
        return {
          data: [{ success: false, error: 'client_not_found' }],
          error: null
        };
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
      if (client.pin_locked_until) {
        const lockedUntil = new Date(client.pin_locked_until);
        if (lockedUntil > new Date()) {
          return {
            data: [{
              success: false,
              client_id: client.id,
              error: 'account_locked',
              locked_until: client.pin_locked_until
            }],
            error: null
          };
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º PIN hash
      if (client.pin_hash === pinHash) {
        // –£—Å–ø–µ—Ö! –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
        await rest('clients', {
          method: 'PATCH',
          filters: { 'eq.id': client.id },
          data: {
            pin_failed_attempts: 0,
            pin_locked_until: null
          }
        });

        return {
          data: [{
            success: true,
            client_id: client.id,
            name: client.name
          }],
          error: null
        };
      }

      // –ù–µ–≤–µ—Ä–Ω—ã–π PIN ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
      const attempts = (client.pin_failed_attempts || 0) + 1;
      const maxAttempts = 5;
      const remainingAttempts = maxAttempts - attempts;

      const updateData = { pin_failed_attempts: attempts };

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ 15 –º–∏–Ω—É—Ç
      if (attempts >= maxAttempts) {
        const lockUntil = new Date(Date.now() + 15 * 60 * 1000); // +15 –º–∏–Ω—É—Ç
        updateData.pin_locked_until = lockUntil.toISOString();
      }

      await rest('clients', {
        method: 'PATCH',
        filters: { 'eq.id': client.id },
        data: updateData
      });

      return {
        data: [{
          success: false,
          client_id: client.id,
          error: 'invalid_pin',
          remaining_attempts: Math.max(0, remainingAttempts)
        }],
        error: null
      };
    } catch (e) {
      err('verifyClientPin failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å shared products (REST-based)
   * @param {object} options - { search, limit, offset }
   * @returns {Promise<{data: Product[], error: any}>}
   */
  async function getSharedProducts(options = {}) {
    try {
      const { search, limit = null, offset = 0 } = options;

      // –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
      const filters = {};

      // TODO: –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ (ilike –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –ø—Ä–æ—Å—Ç–æ–º REST)
      // –î–ª—è MVP ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã

      const restOptions = {
        filters,
        offset
      };

      if (limit != null) {
        restOptions.limit = limit;
      }

      const result = await rest('shared_products', restOptions);

      if (result.error) {
        return { data: null, error: result.error };
      }

      let products = result.data || [];

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –µ—Å–ª–∏ –µ—Å—Ç—å search
      if (search && search.trim()) {
        const searchLower = search.toLowerCase().trim();
        products = products.filter(p =>
          p.name?.toLowerCase().includes(searchLower)
        );
      }

      return { data: products, error: null };
    } catch (e) {
      err('getSharedProducts failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üíæ KV STORE –ú–ï–¢–û–î–´ (REST-based –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîë KV –û–ü–ï–†–ê–¶–ò–ò (—á–µ—Ä–µ–∑ RPC, session-safe ‚Äî üîê P1 IDOR fix!)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü–æ–ª—É—á–∏—Ç—å session_token –¥–ª—è KV –æ–ø–µ—Ä–∞—Ü–∏–π
   * @returns {string|null}
   * üîß v58 FIX: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ fallback –Ω–∞ heys_pin_auth_client
   */
  function getSessionTokenForKV() {
    // 1) –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ HEYS.auth (–¥–æ–ª–∂–µ–Ω —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    if (typeof HEYS !== 'undefined' && HEYS.auth && typeof HEYS.auth.getSessionToken === 'function') {
      const token = HEYS.auth.getSessionToken();
      if (token) {
        log('getSessionTokenForKV: got token from HEYS.auth:', token.slice(0, 8) + '...');
        return token;
      }
    }

    // 2) Fallback: –Ω–∞–ø—Ä—è–º—É—é –∏–∑ localStorage
    const raw = localStorage.getItem('heys_session_token');
    if (raw) {
      log('getSessionTokenForKV: got token from localStorage');
      try {
        return JSON.parse(raw);
      } catch {
        return raw; // –ï—Å–ª–∏ –Ω–µ JSON ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
      }
    }

    // 3) üîß v58: –ï—â—ë –æ–¥–∏–Ω fallback ‚Äî –∏—â–µ–º –ø–æ–¥ namespaced –∫–ª—é—á–æ–º
    const pinClient = localStorage.getItem('heys_pin_auth_client');
    const currentClient = localStorage.getItem('heys_client_current');
    const clientId = (pinClient || currentClient || '').replace(/"/g, '');

    if (clientId) {
      const namespacedKey = `heys_${clientId}_session_token`;
      const namespacedRaw = localStorage.getItem(namespacedKey);
      if (namespacedRaw) {
        // –ú–∏–≥—Ä–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
        localStorage.setItem('heys_session_token', namespacedRaw);
        localStorage.removeItem(namespacedKey);
        try {
          return JSON.parse(namespacedRaw);
        } catch {
          return namespacedRaw;
        }
      }
    }

    // 4) –ù–µ—Ç session_token ‚Äî —ç—Ç–æ –ù–û–†–ú–ê–õ–¨–ù–û –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞ (—É –Ω–µ–≥–æ JWT, –Ω–µ PIN)
    // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∫ warning, —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã–π fallback –Ω–∞ REST path
    return null;
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ client_kv_store (RPC) ‚Äî üîê session-safe!
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞ (IGNORED –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!)
   * @param {string} key - –ö–ª—é—á
   * @param {any} value - –ó–Ω–∞—á–µ–Ω–∏–µ
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  async function saveKV(clientId, key, value) {
    try {
      const sessionToken = getSessionTokenForKV();
      if (!sessionToken) {
        return { success: false, error: 'No session token' };
      }

      // üîê P1: –ò—Å–ø–æ–ª—å–∑—É–µ–º session-–≤–µ—Ä—Å–∏—é (client_id –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!)
      const result = await rpc('upsert_client_kv_by_session', {
        p_session_token: sessionToken,
        p_key: key,
        p_value: value
      });

      if (result.error) {
        return { success: false, error: result.error.message || result.error };
      }

      // RPC –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {success: true/false, error?: string}
      const data = result.data;
      if (data?.success === false) {
        return { success: false, error: data.error || 'Unknown error' };
      }

      return { success: true };
    } catch (e) {
      err('saveKV failed:', e.message);
      return { success: false, error: e.message };
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ client_kv_store (RPC) ‚Äî üîê session-safe!
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞ (IGNORED –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!)
   * @param {string} key - –ö–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –≤—Å–µ –∫–ª—é—á–∏)
   * @returns {Promise<{data: any, error?: string}>}
   */
  async function getKV(clientId, key = null) {
    try {
      const sessionToken = getSessionTokenForKV();
      if (!sessionToken) {
        return { data: null, error: 'No session token' };
      }

      // üîê P1: –ò—Å–ø–æ–ª—å–∑—É–µ–º session-–≤–µ—Ä—Å–∏—é
      // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è "–≤—Å–µ –∫–ª—é—á–∏" –ø–æ–∫–∞ –Ω–µ—Ç session-–≤–µ—Ä—Å–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
      if (!key) {
        // TODO: –°–æ–∑–¥–∞—Ç—å get_all_client_kv_by_session –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        warn('getKV without key not supported in session mode');
        return { data: [], error: null };
      }

      const result = await rpc('get_client_kv_by_session', {
        p_session_token: sessionToken,
        p_key: key
      });

      if (result.error) {
        return { data: null, error: result.error.message || result.error };
      }

      // RPC –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {success, found, key, value}
      const data = result.data;
      if (data?.found) {
        return { data: data.value };
      }
      return { data: null };
    } catch (e) {
      err('getKV failed:', e.message);
      return { data: null, error: e.message };
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –í–°–ï KV –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {Object} [options] - –û–ø—Ü–∏–∏
   * @param {string} [options.since] - ISO timestamp –¥–ª—è delta sync (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞)
   * @returns {Promise<{data: Array<{k: string, v: any}>, error?: string, delta?: boolean}>}
   */
  async function getAllKV(clientId, options = {}) {
    if (!clientId) {
      return { data: [], error: 'No clientId provided' };
    }

    const since = options.since || null;

    try {
      log(`getAllKV: Loading ${since ? 'delta' : 'all'} data for client ${clientId.slice(0, 8)}...${since ? ' (since ' + since + ')' : ''}`);

      const sessionToken = getSessionTokenForKV();
      if (!sessionToken) {
        // üîê Fallback –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞: JWT + /auth/clients/:id/kv
        const curatorToken = getCuratorToken();
        if (!curatorToken) {
          return { data: [], error: 'No session token' };
        }

        // üöÄ Delta Sync: –¥–æ–±–∞–≤–ª—è–µ–º since –≤ query string
        let url = `${CONFIG.API_URL}/auth/clients/${encodeURIComponent(clientId)}/kv`;
        if (since) {
          url += `?since=${encodeURIComponent(since)}`;
        }
        const response = await fetchWithRetry(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${curatorToken}`
          }
        });

        const result = await response.json();
        if (!response.ok) {
          return { data: [], error: result?.error || 'Curator KV fetch failed' };
        }

        const rows = Array.isArray(result?.data) ? result.data : [];
        log(`getAllKV: Loaded ${rows.length} keys (curator${since ? ', delta' : ', full'})`);
        return { data: rows, error: null, delta: !!since };
      }

      const rpcParams = {
        p_session_token: sessionToken,
      };
      // üöÄ Delta Sync: –ø–µ—Ä–µ–¥–∞—ë–º p_since –¥–ª—è RPC
      if (since) {
        rpcParams.p_since = since;
      }

      const { data, error } = await rpc('get_client_data_by_session', rpcParams);

      if (error) {
        err('getAllKV RPC error:', error.message || error);
        return { data: [], error: error.message || error };
      }

      if (data?.error) {
        return { data: [], error: data.error };
      }

      const payload = data?.data || {};
      const entries = Object.entries(payload).map(([k, v]) => ({ k, v }));

      log(`getAllKV: Loaded ${entries.length} keys${data?.delta ? ' (delta)' : ' (full)'}`);
      return { data: entries, error: null, delta: !!data?.delta };
    } catch (e) {
      err('getAllKV failed:', e.message);
      return { data: [], error: e.message };
    }
  }

  /**
   * üîê v56: –ü–∞–∫–µ—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ KV —á–µ—Ä–µ–∑ REST API (–¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–µ—Ç session_token (–∫—É—Ä–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ JWT)
   * @param {string} curatorUserId - ID –∫—É—Ä–∞—Ç–æ—Ä–∞ (user_id –≤ —Ç–∞–±–ª–∏—Ü–µ)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞  
   * @param {Array<{k: string, v: any, updated_at?: string}>} items - –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö
   * @returns {Promise<{success: boolean, saved: number, error?: string}>}
   */
  async function batchSaveKVviaREST(curatorUserId, clientId, items) {
    log(`[v56] batchSaveKVviaREST: curator=${curatorUserId?.slice(0, 8)}, client=${clientId?.slice(0, 8)}, items=${items.length}`);

    if (!curatorUserId || !clientId || !items?.length) {
      return { success: false, saved: 0, error: 'Missing required params for REST save' };
    }

    try {
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è REST upsert
      // Primary Key: (user_id, client_id, k)
      const restData = items.map(item => ({
        user_id: curatorUserId,
        client_id: clientId,
        k: item.k,
        v: item.v,
        updated_at: item.updated_at || new Date().toISOString()
      }));

      // DIAGNOSTIC: –ª–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä payload –¥–ª—è –±–æ–ª—å—à–∏—Ö batch
      try {
        const payloadBytes = new TextEncoder().encode(JSON.stringify(restData)).length;
        if (payloadBytes >= 100 * 1024) {
          console.warn(
            `[HEYS.api] ‚ö†Ô∏è Large payload: ${Math.round(payloadBytes / 1024)}KB (${items.length} items)`
          );
        }
      } catch (e) {
        console.warn('[HEYS.api] ‚ö†Ô∏è Payload size check failed');
      }

      // REST POST —Å upsert
      // ‚ö†Ô∏è v59 FIX: PK —Ç–∞–±–ª–∏—Ü—ã client_kv_store = (client_id, k), –ù–ï (user_id, client_id, k)!
      const result = await rest('client_kv_store', {
        method: 'POST',
        data: restData,
        upsert: true,
        onConflict: 'client_id,k'
      });

      if (result.error) {
        err('[v56] REST upsert error:', result.error);
        return { success: false, saved: 0, error: result.error.message || result.error };
      }

      // v60: REST —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { success, rowCount, inserted } –¥–ª—è upsert
      const responseData = result.data;
      const actualSaved = responseData?.rowCount || responseData?.inserted || items.length;
      log(`[v56] REST upsert success: ${actualSaved} items saved (requested: ${items.length})`);
      return { success: true, saved: actualSaved };
    } catch (e) {
      err('[v56] batchSaveKVviaREST failed:', e.message);
      return { success: false, saved: 0, error: e.message };
    }
  }

  /**
   * –ü–∞–∫–µ—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ KV –¥–∞–Ω–Ω—ã—Ö ‚Äî üîê dual-path: RPC –¥–ª—è PIN –∫–ª–∏–µ–Ω—Ç–æ–≤, REST –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {Array<{k: string, v: any}>} items - –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö
   * @returns {Promise<{success: boolean, saved: number, error?: string}>}
   */
  async function batchSaveKV(clientId, items) {
    if (!items || items.length === 0) {
      return { success: true, saved: 0 };
    }

    try {
      // üîê Path 1: –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ session token (PIN auth –∫–ª–∏–µ–Ω—Ç)
      const sessionToken = getSessionTokenForKV();
      // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
      if (sessionToken) {
        const result = await rpc('batch_upsert_client_kv_by_session', {
          p_session_token: sessionToken,
          p_items: items
        });

        // üîá v4.7.0: DEBUG –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

        if (result.error) {
          console.error('[YandexAPI] batchSaveKV RPC ERROR:', result.error);
          return { success: false, saved: 0, error: result.error.message || result.error };
        }

        const data = result.data;
        return {
          success: data?.success !== false,
          saved: data?.saved || 0,
          error: data?.error
        };
      }

      // üîê v56 Path 2: Fallback –Ω–∞ REST –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞
      const curatorUserId = getCuratorUserId();
      if (curatorUserId) {
        log(`[v56] No session token, trying REST path (curator=${curatorUserId?.slice(0, 8)})`);
        return await batchSaveKVviaREST(curatorUserId, clientId, items);
      }

      // –ù–µ—Ç –Ω–∏ session token, –Ω–∏ curator token
      err('[v56] batchSaveKV: No auth token available (neither session nor curator)');
      return { success: false, saved: 0, error: 'No auth token available' };
    } catch (e) {
      err('batchSaveKV failed:', e.message);
      return { success: false, saved: 0, error: e.message };
    }
  }

  /**
   * üîê v56: –£–¥–∞–ª–∏—Ç—å KV —á–µ—Ä–µ–∑ REST API (–¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
   * @param {string} userId - ID –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} key - –ö–ª—é—á –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
   * @returns {Promise<{success: boolean, deleted?: number, error?: string}>}
   */
  async function deleteKVviaREST(userId, clientId, key) {
    try {
      const curatorToken = getCuratorToken();
      if (!curatorToken) {
        return { success: false, error: 'No curator token' };
      }

      const url = `${API_BASE}/rest/client_kv_store?user_id=eq.${userId}&client_id=eq.${clientId}&k=eq.${encodeURIComponent(key)}`;

      const response = await fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${curatorToken}`
        }
      });

      if (!response.ok) {
        const errData = await response.json().catch(() => ({}));
        throw new Error(errData.error || `REST DELETE failed: ${response.status}`);
      }

      const data = await response.json();
      log(`[v56] deleteKVviaREST success: deleted ${data.deleted || 0} rows`);
      return { success: true, deleted: data.deleted || 0 };
    } catch (e) {
      err('deleteKVviaREST failed:', e.message);
      return { success: false, error: e.message };
    }
  }

  /**
   * –£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ client_kv_store ‚Äî üîê v56: dual-path (RPC + REST fallback)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} key - –ö–ª—é—á
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  async function deleteKV(clientId, key) {
    try {
      // üîê –ü—É—Ç—å 1: RPC —Å session token (–¥–ª—è PIN auth –∫–ª–∏–µ–Ω—Ç–æ–≤)
      const sessionToken = getSessionTokenForKV();
      if (sessionToken) {
        const result = await rpc('delete_client_kv_by_session', {
          p_session_token: sessionToken,
          p_key: key
        });

        if (result.error) {
          return { success: false, error: result.error.message || result.error };
        }

        return { success: result.data?.success !== false };
      }

      // üîê –ü—É—Ç—å 2 (v56): REST DELETE –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞
      const curatorUserId = getCuratorUserId();
      if (curatorUserId && clientId) {
        log(`[v56] No session token, trying REST DELETE (curator=${curatorUserId?.slice(0, 8)})`);
        return await deleteKVviaREST(curatorUserId, clientId, key);
      }

      // –ù–∏ session token, –Ω–∏ curator ‚Äî –æ—à–∏–±–∫–∞
      return { success: false, error: 'No auth token available' };
    } catch (e) {
      err('deleteKV failed:', e.message);
      return { success: false, error: e.message };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üë• CLIENTS –ú–ï–¢–û–î–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @param {string} curatorId - ID –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @returns {Promise<{data: Array<{id, name}>, error: any}>}
   */
  async function getClients(curatorId) {
    try {
      // üîê –ò—Å–ø–æ–ª—å–∑—É–µ–º /auth/clients –≤–º–µ—Å—Ç–æ REST API (clients —É–±—Ä–∞–Ω –∏–∑ REST –ø–æ security)
      // –¢—Ä–µ–±—É–µ—Ç JWT —Ç–æ–∫–µ–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞
      const token = getCuratorToken();
      if (!token) {
        return { data: null, error: { message: 'Curator not authenticated' } };
      }

      const safeCuratorId = curatorId || 'self';
      log(`getClients: curatorId=${safeCuratorId}`);

      const url = `${CONFIG.API_URL}/auth/clients`;
      const response = await fetchWithRetry(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      const result = await response.json();

      if (!response.ok) {
        return { data: null, error: { message: result.error || 'Failed to get clients', code: response.status } };
      }

      const rawClients = result.data || [];
      const hasSubscriptionFields = rawClients.some((client) =>
        Object.prototype.hasOwnProperty.call(client, 'subscription_status') ||
        Object.prototype.hasOwnProperty.call(client, 'trial_ends_at')
      );

      let clients = rawClients.map((client) => ({
        ...client,
        subscription_status: typeof client.subscription_status === 'undefined'
          ? null
          : client.subscription_status,
        trial_ends_at: typeof client.trial_ends_at === 'undefined'
          ? null
          : client.trial_ends_at
      }));

      // üîß Fallback: –µ—Å–ª–∏ /auth/clients –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
      if (!hasSubscriptionFields && clients.length > 0) {
        logInfo('‚ö†Ô∏è [HEYS.clients] /auth/clients missing subscription fields, fallback to RPC', {
          total: clients.length
        });
        // üîê get_curator_clients —Ç—Ä–µ–±—É–µ—Ç JWT ‚Äî rpc() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç —Ç–æ–∫–µ–Ω –∏–∑ CURATOR_ONLY_FUNCTIONS
        const fallback = await rpc('get_curator_clients', {});
        if (!fallback.error && Array.isArray(fallback.data)) {
          clients = fallback.data;
          log('getClients: fallback to get_curator_clients');
        }
      }

      // üêõ DEBUG: –ª–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Trial Machine
      if (clients.length > 0) {
        console.info('[HEYS.clients] üêõ Client fields:', Object.keys(clients[0]));
        console.info('[HEYS.clients] üêõ First client sample:', {
          id: clients[0].id?.substring(0, 8),
          name: clients[0].name,
          subscription_status: clients[0].subscription_status,
          trial_ends_at: clients[0].trial_ends_at,
          active_until: clients[0].active_until
        });
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ updated_at (ascending)
      clients = clients.sort((a, b) => {
        const dateA = new Date(a.updated_at || 0);
        const dateB = new Date(b.updated_at || 0);
        return dateA - dateB;
      });

      log(`getClients: SUCCESS, ${clients.length} clients`);

      // üîê –ö—ç—à–∏—Ä—É–µ–º –¥–ª—è cloud.ensureClient (clients —É–±—Ä–∞–Ω –∏–∑ REST API)
      if (typeof window !== 'undefined') {
        window.HEYS = window.HEYS || {};
        window.HEYS.curatorClients = clients;
      }

      return { data: clients, error: null };
    } catch (e) {
      err('getClients failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (–±–µ–∑ phone/PIN)
   * üîê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç /auth/clients –≤–º–µ—Å—Ç–æ REST API (clients —É–±—Ä–∞–Ω –∏–∑ REST –ø–æ security)
   * @param {string} name - –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} curatorId - ID –∫—É—Ä–∞—Ç–æ—Ä–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –±–µ—Ä—ë–º –∏–∑ JWT)
   * @returns {Promise<{data: {id, name}, error: any}>}
   */
  async function createClient(name, curatorId) {
    try {
      log(`createClient: name=${name}`);

      const token = getCuratorToken();
      if (!token) {
        return { data: null, error: { message: 'Curator not authenticated' } };
      }

      const url = `${CONFIG.API_URL}/auth/clients`;
      const response = await fetchWithRetry(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ name: name || `–ö–ª–∏–µ–Ω—Ç ${Date.now()}` })
      });

      const result = await response.json();

      if (!response.ok) {
        return { data: null, error: { message: result.error || 'Failed to create client', code: response.status } };
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∫–ª–∏–µ–Ω—Ç–æ–≤
      if (result.data && window.HEYS?.curatorClients) {
        window.HEYS.curatorClients.push(result.data);
      }

      return { data: result.data, error: null };
    } catch (e) {
      err('createClient failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
   * üîê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç /auth/clients –≤–º–µ—Å—Ç–æ REST API (clients —É–±—Ä–∞–Ω –∏–∑ REST –ø–æ security)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {object} data - –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è { name, ... }
   * @returns {Promise<{data: any, error: any}>}
   */
  async function updateClient(clientId, data) {
    if (!clientId) {
      return { data: null, error: { message: 'clientId required' } };
    }

    try {
      log(`updateClient: id=${clientId}`, data);

      const token = getCuratorToken();
      if (!token) {
        return { data: null, error: { message: 'Curator not authenticated' } };
      }

      const url = `${CONFIG.API_URL}/auth/clients/${clientId}`;
      const response = await fetchWithRetry(url, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (!response.ok) {
        return { data: null, error: { message: result.error || 'Failed to update client', code: response.status } };
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∫–ª–∏–µ–Ω—Ç–æ–≤
      if (result.data && window.HEYS?.curatorClients) {
        const idx = window.HEYS.curatorClients.findIndex(c => c.id === clientId);
        if (idx >= 0) window.HEYS.curatorClients[idx] = result.data;
      }

      return { data: result.data, error: null };
    } catch (e) {
      err('updateClient failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
   * üîê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç /auth/clients –≤–º–µ—Å—Ç–æ REST API (clients —É–±—Ä–∞–Ω –∏–∑ REST –ø–æ security)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @returns {Promise<{data: any, error: any}>}
   */
  async function deleteClient(clientId) {
    if (!clientId) {
      return { data: null, error: { message: 'clientId required' } };
    }

    try {
      log(`deleteClient: id=${clientId}`);

      const token = getCuratorToken();
      if (!token) {
        return { data: null, error: { message: 'Curator not authenticated' } };
      }

      const url = `${CONFIG.API_URL}/auth/clients/${clientId}`;
      const response = await fetchWithRetry(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      const result = await response.json();

      if (!response.ok) {
        return { data: null, error: { message: result.error || 'Failed to delete client', code: response.status } };
      }

      // –£–¥–∞–ª—è–µ–º –∏–∑ –∫—ç—à–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
      if (window.HEYS?.curatorClients) {
        window.HEYS.curatorClients = window.HEYS.curatorClients.filter(c => c.id !== clientId);
      }

      return { data: { success: true }, error: null };
    } catch (e) {
      err('deleteClient failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìã SUBSCRIPTIONS –ú–ï–¢–û–î–´ (RPC)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @returns {Promise<{data: object, error: any}>}
   */
  async function checkSubscriptionStatus(sessionToken = null) {
    try {
      const token = sessionToken || HEYS.auth?.getSessionToken?.();
      if (!token) {
        return { data: null, error: { message: 'No session token' } };
      }

      log(`checkSubscriptionStatus: using session-based RPC`);

      const result = await rpc('get_subscription_status_by_session', {
        p_session_token: token
      });

      return result;
    } catch (e) {
      err('checkSubscriptionStatus failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∏–∞–ª –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @returns {Promise<{data: object, error: any}>}
   */
  async function startTrial(clientId) {
    try {
      log(`startTrial: clientId=${clientId}`);

      const result = await rpc('start_trial', {
        p_client_id: clientId
      });

      return result;
    } catch (e) {
      err('startTrial failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} plan - –ü–ª–∞–Ω (base/pro/proplus)
   * @param {number} months - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
   * @returns {Promise<{data: object, error: any}>}
   */
  async function activateSubscription(clientId, plan, months = 1) {
    try {
      log(`activateSubscription: clientId=${clientId}, plan=${plan}, months=${months}`);

      const result = await rpc('activate_subscription', {
        p_client_id: clientId,
        p_plan: plan,
        p_months: months
      });

      return result;
    } catch (e) {
      err('activateSubscription failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìù CONSENTS –ú–ï–¢–û–î–´ (RPC)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏—è –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {Array<{type, version, granted}>} consents - –°–æ–≥–ª–∞—Å–∏—è
   * @param {string} userAgent - User agent
   * @returns {Promise<{data: object, error: any}>}
   */
  async function logConsents(clientId, consents, userAgent = null) {
    try {
      log(`logConsents: clientId=${clientId}`, consents);

      // –í–ê–ñ–ù–û: pg –¥—Ä–∞–π–≤–µ—Ä —Ç—Ä–µ–±—É–µ—Ç JSONB –∫–∞–∫ —Å—Ç—Ä–æ–∫—É, –Ω–µ –æ–±—ä–µ–∫—Ç!
      const result = await rpc('log_consents', {
        p_client_id: clientId,
        p_consents: JSON.stringify(consents),  // Must be string for pg JSONB!
        p_ip: null,
        p_user_agent: userAgent || (typeof navigator !== 'undefined' ? navigator.userAgent : null)
      });

      return result;
    } catch (e) {
      err('logConsents failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–∏–π
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @returns {Promise<{data: {valid, missing}, error: any}>}
   */
  async function checkRequiredConsents(clientId) {
    try {
      log(`checkRequiredConsents: clientId=${clientId}`);

      const result = await rpc('check_required_consents', {
        p_client_id: clientId
      });

      return result;
    } catch (e) {
      err('checkRequiredConsents failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –û—Ç–æ–∑–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} consentType - –¢–∏–ø —Å–æ–≥–ª–∞—Å–∏—è
   * @returns {Promise<{data: object, error: any}>}
   */
  async function revokeConsent(clientId, consentType) {
    try {
      log(`revokeConsent: clientId=${clientId}, type=${consentType}`);

      const result = await rpc('revoke_consent', {
        p_client_id: clientId,
        p_consent_type: consentType
      });

      return result;
    } catch (e) {
      err('revokeConsent failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üè≠ SHARED PRODUCTS –ú–ï–¢–û–î–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –°–æ–∑–¥–∞—Ç—å pending –ø—Ä–æ–¥—É–∫—Ç (üîê P1: session-–≤–µ—Ä—Å–∏—è)
   * @param {object} product - –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {Promise<{data: object, error: any}>}
   */
  async function createPendingProduct(product) {
    try {
      log(`createPendingProduct:`, product.name);

      // üîê P1: –ò—Å–ø–æ–ª—å–∑—É–µ–º session-–≤–µ—Ä—Å–∏—é (IDOR fix)
      const sessionToken = getSessionToken();
      if (!sessionToken) {
        return { data: null, error: { message: 'No session token' } };
      }

      const result = await rpc('create_pending_product_by_session', {
        p_session_token: sessionToken,
        p_name: product.name,
        p_product_data: product
      });

      return result;
    } catch (e) {
      err('createPendingProduct failed:', e.message);
      return { data: null, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üí≥ PAYMENTS –ú–ï–¢–û–î–´ (–ÆKassa)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ –ÆKassa
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} plan - –ü–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ (base/pro/proplus)
   * @param {string} returnUrl - URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
   * @returns {Promise<{data: {paymentId, confirmationUrl}, error: any}>}
   */
  async function createPayment(clientId, plan, returnUrl) {
    try {
      log(`createPayment: clientId=${clientId}, plan=${plan}`);

      const response = await fetch(`${CONFIG.API_URL}/payments/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          clientId,
          plan,
          returnUrl
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }

      const data = await response.json();
      log(`createPayment success:`, data);

      return { data, error: null };
    } catch (e) {
      err('createPayment failed:', e.message);
      _lastError = e.message;
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
   * @param {string} paymentId - ID –ø–ª–∞—Ç–µ–∂–∞ –ÆKassa
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
   * @returns {Promise<{data: {status, paid, amount}, error: any}>}
   */
  async function getPaymentStatus(paymentId, clientId) {
    try {
      log(`getPaymentStatus: paymentId=${paymentId}`);

      const response = await fetch(
        `${CONFIG.API_URL}/payments/status?paymentId=${encodeURIComponent(paymentId)}&clientId=${encodeURIComponent(clientId)}`,
        {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }

      const data = await response.json();
      log(`getPaymentStatus success:`, data);

      return { data, error: null };
    } catch (e) {
      err('getPaymentStatus failed:', e.message);
      _lastError = e.message;
      return { data: null, error: { message: e.message } };
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üì§ –≠–ö–°–ü–û–†–¢
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const YandexAPI = {
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    CONFIG,

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    isOnline: () => _isOnline,
    getLastError: () => _lastError,

    // –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
    rpc,
    rest,
    sendSMS,
    saveLead,
    healthCheck,

    // Auth –º–µ—Ç–æ–¥—ã
    getClientSalt,
    verifyClientPin,
    curatorLogin,
    verifyCuratorToken,

    // üë• Clients
    getClients,
    createClient,
    updateClient,
    deleteClient,

    // üìã Subscriptions
    checkSubscriptionStatus,
    startTrial,
    activateSubscription,

    // ÔøΩ Payments (–ÆKassa)
    createPayment,
    getPaymentStatus,

    // ÔøΩüìù Consents
    logConsents,
    checkRequiredConsents,
    revokeConsent,

    // üè≠ Products
    getSharedProducts,
    createPendingProduct,

    // KV Store (REST-based –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
    saveKV,
    getKV,
    getAllKV,
    batchSaveKV,
    deleteKV,

    // –ê–ª–∏–∞—Å—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Supabase SDK
    from: (table) => ({
      select: (columns = '*') => ({
        eq: (col, val) => ({
          // Chainable .eq().in()
          in: (col2, vals) => rest(table, { select: columns, filters: { [`eq.${col}`]: val, [`in.${col2}`]: `(${vals.join(',')})` } }),
          // Chainable .eq().eq()
          eq: (col2, val2) => rest(table, { select: columns, filters: { [`eq.${col}`]: val, [`eq.${col2}`]: val2 } }),
          // Chainable .eq().like() 
          like: (col2, pattern) => rest(table, { select: columns, filters: { [`eq.${col}`]: val, [`like.${col2}`]: pattern } }),
          // Chainable .eq().order().limit() ‚Äî –¥–ª—è meta check queries
          order: (orderCol, opts = {}) => ({
            limit: (n) => rest(table, { select: columns, filters: { [`eq.${col}`]: val }, order: `${orderCol}.${opts.ascending ? 'asc' : 'desc'}`, limit: n }),
            then: (resolve) => rest(table, { select: columns, filters: { [`eq.${col}`]: val }, order: `${orderCol}.${opts.ascending ? 'asc' : 'desc'}` }).then(resolve)
          }),
          // Terminal .single() - throws if no row
          single: () => rest(table, { select: columns, filters: { [`eq.${col}`]: val }, limit: 1 }).then(r => ({ ...r, data: r.data?.[0] })),
          // Terminal .maybeSingle() - returns null if no row, no error
          maybeSingle: () => rest(table, { select: columns, filters: { [`eq.${col}`]: val }, limit: 1 }).then(r => ({ ...r, data: r.data?.[0] || null })),
          // Terminal .then()
          then: (resolve) => rest(table, { select: columns, filters: { [`eq.${col}`]: val } }).then(resolve)
        }),
        in: (col, vals) => rest(table, { select: columns, filters: { [`in.${col}`]: `(${vals.join(',')})` } }),
        like: (col, pattern) => rest(table, { select: columns, filters: { [`like.${col}`]: pattern } }),
        limit: (n) => rest(table, { select: columns, limit: n }),
        order: (col, opts = {}) => ({
          eq: (c, v) => rest(table, { select: columns, filters: { [`eq.${c}`]: v }, order: `${col}.${opts.ascending ? 'asc' : 'desc'}` }),
          limit: (n) => rest(table, { select: columns, limit: n, order: `${col}.${opts.ascending ? 'asc' : 'desc'}` }),
          then: (resolve) => rest(table, { select: columns, order: `${col}.${opts.ascending ? 'asc' : 'desc'}` }).then(resolve)
        }),
        single: () => rest(table, { select: columns, limit: 1 }).then(r => ({ ...r, data: r.data?.[0] })),
        then: (resolve) => rest(table, { select: columns }).then(resolve)
      }),
      insert: (data) => ({
        select: (columns = '*') => ({
          single: () => rest(table, { method: 'POST', data, select: columns }).then(r => ({ ...r, data: r.data?.[0] })),
          then: (resolve) => rest(table, { method: 'POST', data, select: columns }).then(resolve)
        }),
        then: (resolve) => rest(table, { method: 'POST', data }).then(resolve)
      }),
      update: (data) => ({
        eq: (col, val) => ({
          select: (columns = '*') => rest(table, { method: 'PATCH', data, filters: { [`eq.${col}`]: val }, select: columns }),
          then: (resolve) => rest(table, { method: 'PATCH', data, filters: { [`eq.${col}`]: val } }).then(resolve)
        }),
        then: (resolve) => rest(table, { method: 'PATCH', data }).then(resolve)
      }),
      upsert: (data, opts = {}) => ({
        select: (columns = '*') => rest(table, { method: 'POST', data, upsert: true, onConflict: opts.onConflict, select: columns }),
        then: (resolve) => rest(table, { method: 'POST', data, upsert: true, onConflict: opts.onConflict }).then(resolve)
      }),
      delete: () => ({
        eq: (col, val) => ({
          eq: (col2, val2) => rest(table, { method: 'DELETE', filters: { [`eq.${col}`]: val, [`eq.${col2}`]: val2 } }),
          then: (resolve) => rest(table, { method: 'DELETE', filters: { [`eq.${col}`]: val } }).then(resolve)
        }),
        in: (col, vals) => rest(table, { method: 'DELETE', filters: { [`in.${col}`]: `(${vals.join(',')})` } })
      })
    }),

    // Advanced: –ø—Ä—è–º–æ–π REST –¥–æ—Å—Ç—É–ø –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    rest
  };

  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.YandexAPI = YandexAPI;

  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
  if (typeof window !== 'undefined') {
    window.YandexAPI = YandexAPI;
  }

  log('‚úÖ YandexAPI module loaded (api.heyslab.ru)');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_cloud_merge_v1.js ===== */
// heys_cloud_merge_v1.js ‚Äî merge helpers for cloud sync
; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const cloud = HEYS.cloud = HEYS.cloud || {};

  function getLogger() {
    const logger = cloud._log || {};
    return {
      log: logger.log || function () { },
      logCritical: logger.logCritical || function () { },
    };
  }

  function mergeItemsById(remoteItems = [], localItems = [], preferLocal = true) {
    if (!preferLocal) {
      return remoteItems.filter(item => item && item.id);
    }

    const itemsMap = new Map();
    remoteItems.forEach(item => {
      if (item && item.id) {
        itemsMap.set(item.id, item);
      }
    });

    localItems.forEach(item => {
      if (item && item.id) {
        itemsMap.set(item.id, item);
      }
    });

    return Array.from(itemsMap.values());
  }

  function mergeDayData(local, remote, options = {}) {
    const { log, logCritical } = getLogger();
    const forceKeepAll = options.forceKeepAll || false;
    const preferRemote = options.preferRemote || false;

    const normalizeTrainings = (trainings = []) => trainings.map((t = {}) => {
      if (t.quality !== undefined || t.feelAfter !== undefined) {
        const { quality, feelAfter, ...rest } = t;
        return {
          ...rest,
          mood: rest.mood ?? quality ?? 5,
          wellbeing: rest.wellbeing ?? feelAfter ?? 5,
          stress: rest.stress ?? 5
        };
      }
      return t;
    });

    local = {
      ...local,
      trainings: normalizeTrainings(local?.trainings)
    };
    remote = {
      ...remote,
      trainings: normalizeTrainings(remote?.trainings)
    };

    if (!local || !remote) return null;

    const localJson = JSON.stringify({ ...local, updatedAt: 0, _sourceId: '' });
    const remoteJson = JSON.stringify({ ...remote, updatedAt: 0, _sourceId: '' });
    if (localJson === remoteJson) return null;

    const merged = {
      ...remote,
      date: local.date || remote.date,
      updatedAt: Math.max(local.updatedAt || 0, remote.updatedAt || 0, Date.now()),
      _mergedAt: Date.now(),
    };

    merged.steps = Math.max(local.steps || 0, remote.steps || 0);
    merged.waterMl = Math.max(local.waterMl || 0, remote.waterMl || 0);

    if ((local.updatedAt || 0) >= (remote.updatedAt || 0)) {
      merged.householdMin = local.householdMin ?? remote.householdMin ?? 0;
      merged.householdTime = local.householdTime ?? remote.householdTime ?? '';
      merged.householdActivities = local.householdActivities || remote.householdActivities || undefined;
    } else {
      merged.householdMin = remote.householdMin ?? local.householdMin ?? 0;
      merged.householdTime = remote.householdTime ?? local.householdTime ?? '';
      merged.householdActivities = remote.householdActivities || local.householdActivities || undefined;
    }

    if (local.weightMorning && remote.weightMorning) {
      merged.weightMorning = (local.updatedAt || 0) >= (remote.updatedAt || 0)
        ? local.weightMorning
        : remote.weightMorning;
    } else {
      merged.weightMorning = local.weightMorning || remote.weightMorning || 0;
    }

    merged.sleepStart = local.sleepStart || remote.sleepStart || '';
    merged.sleepEnd = local.sleepEnd || remote.sleepEnd || '';
    merged.sleepQuality = local.sleepQuality || remote.sleepQuality || '';
    merged.sleepNote = local.sleepNote || remote.sleepNote || '';

    if (local.dayScoreManual) {
      merged.dayScore = local.dayScore;
      merged.dayScoreManual = true;
    } else if (remote.dayScoreManual) {
      merged.dayScore = remote.dayScore;
      merged.dayScoreManual = true;
    } else {
      merged.dayScore = local.dayScore || remote.dayScore || '';
    }
    merged.dayComment = local.dayComment || remote.dayComment || '';

    if (local.cycleDay === null && (local.updatedAt || 0) >= (remote.updatedAt || 0)) {
      merged.cycleDay = null;
    } else if (remote.cycleDay === null && (remote.updatedAt || 0) > (local.updatedAt || 0)) {
      merged.cycleDay = null;
    } else {
      merged.cycleDay = local.cycleDay || remote.cycleDay || null;
    }

    const localMeals = local.meals || [];
    const remoteMeals = remote.meals || [];
    const mealsMap = new Map();
    const localMealIds = new Set(localMeals.filter(m => m?.id).map(m => m.id));
    const localIsNewer = (local.updatedAt || 0) >= (remote.updatedAt || 0);

    remoteMeals.forEach(meal => {
      if (!meal || !meal.id) return;

      if (!forceKeepAll && !preferRemote && localIsNewer && !localMealIds.has(meal.id)) {
        log(`üóëÔ∏è [MERGE] Meal ${meal.id} deleted locally, skipping from remote`);
        return;
      }

      mealsMap.set(meal.id, meal);
    });

    localMeals.forEach(meal => {
      if (!meal || !meal.id) return;
      const existing = mealsMap.get(meal.id);
      if (!existing) {
        mealsMap.set(meal.id, meal);
      } else {
        const preferLocal = preferRemote ? false : localIsNewer;
        const mergedItems = mergeItemsById(existing.items || [], meal.items || [], preferLocal);
        const mergedMeal = preferRemote
          ? { ...meal, ...existing, items: mergedItems }
          : localIsNewer
            ? { ...existing, ...meal, items: mergedItems }
            : { ...meal, ...existing, items: mergedItems };
        mealsMap.set(meal.id, mergedMeal);
      }
    });

    merged.meals = Array.from(mealsMap.values())
      .sort((a, b) => (a.time || '').localeCompare(b.time || ''));

    const localTrainings = local.trainings || [];
    const remoteTrainings = remote.trainings || [];
    merged.trainings = [];

    const localIsNewerForTrainings = (local.updatedAt || 0) >= (remote.updatedAt || 0);

    const maxTrainings = Math.max(localTrainings.length, remoteTrainings.length, 3);
    for (let i = 0; i < maxTrainings; i++) {
      const lt = localTrainings[i] || { z: [0, 0, 0, 0] };
      const rt = remoteTrainings[i] || { z: [0, 0, 0, 0] };

      const ltSum = (lt.z || []).reduce((a, b) => a + (b || 0), 0);
      const rtSum = (rt.z || []).reduce((a, b) => a + (b || 0), 0);

      let winner;
      if (localIsNewerForTrainings) {
        winner = lt;
      } else if (ltSum === 0 && rtSum > 0) {
        winner = rt;
      } else if (rtSum === 0 && ltSum > 0) {
        winner = lt;
      } else {
        winner = rt;
      }
      const loser = winner === lt ? rt : lt;

      const getMergedRating = (field) => {
        const wVal = winner[field];
        const lVal = loser[field];
        if (wVal !== undefined) return wVal;
        if (lVal !== undefined) return lVal;
        return undefined;
      };

      winner = {
        ...winner,
        mood: getMergedRating('mood'),
        wellbeing: getMergedRating('wellbeing'),
        stress: getMergedRating('stress'),
        quality: undefined,
        feelAfter: undefined
      };

      merged.trainings.push(winner);
    }

    log('üîÄ [MERGE] Result:', {
      meals: merged.meals.length,
      steps: merged.steps,
      water: merged.waterMl,
      trainings: merged.trainings.filter(t => t.z?.some(z => z > 0)).length
    });

    return merged;
  }

  function mergeProductsData(localProducts, remoteProducts) {
    const { log, logCritical } = getLogger();
    const local = Array.isArray(localProducts) ? localProducts : [];
    const remote = Array.isArray(remoteProducts) ? remoteProducts : [];

    const normalizeName = (name) => String(name || '').trim().toLowerCase();

    const isValidProduct = (p) => {
      if (!p) return false;
      const name = normalizeName(p.name);
      return name.length > 0;
    };

    const getProductScore = (p) => {
      let score = 0;
      if (p.id) score += 1;
      if (p.name) score += 2;
      if (p.kcal100 > 0) score += 1;
      if (p.protein100 > 0) score += 1;
      if (p.carbs100 > 0 || p.simple100 > 0 || p.complex100 > 0) score += 1;
      if (p.fat100 > 0 || p.badFat100 > 0 || p.goodFat100 > 0) score += 1;
      if (p.fiber100 > 0) score += 1;
      if (p.gi > 0) score += 1;
      if (p.portions && p.portions.length > 0) score += 2;
      if (p.createdAt) score += 1;
      return score;
    };

    const isBetterProduct = (p1, p2) => {
      const score1 = getProductScore(p1);
      const score2 = getProductScore(p2);
      if (score1 !== score2) return score1 > score2;
      const time1 = p1.createdAt || 0;
      const time2 = p2.createdAt || 0;
      return time1 > time2;
    };

    const dedupeArray = (arr, source) => {
      const seen = new Map();
      const duplicates = [];

      arr.forEach(p => {
        if (!isValidProduct(p)) return;
        const key = normalizeName(p.name);
        const existing = seen.get(key);

        if (!existing) {
          seen.set(key, p);
        } else {
          duplicates.push({ name: p.name, source });
          if (isBetterProduct(p, existing)) {
            seen.set(key, p);
          }
        }
      });

      if (duplicates.length > 0) {
        logCritical(`‚ö†Ô∏è [MERGE] Found ${duplicates.length} duplicate(s) in ${source}: ${duplicates.map(d => `"${d.name}"`).join(', ')}`);
      }

      return Array.from(seen.values());
    };

    const localDeduped = dedupeArray(local, 'local');
    const remoteDeduped = dedupeArray(remote, 'remote');

    if (localDeduped.length === 0) return remoteDeduped;
    if (remoteDeduped.length === 0) return localDeduped;

    const resultMap = new Map();

    remoteDeduped.forEach(p => {
      const key = normalizeName(p.name);
      resultMap.set(key, p);
    });

    let addedFromLocal = 0;
    let updatedFromLocal = 0;

    localDeduped.forEach(p => {
      const key = normalizeName(p.name);
      const existing = resultMap.get(key);

      if (!existing) {
        resultMap.set(key, p);
        addedFromLocal++;
      } else if (isBetterProduct(p, existing)) {
        resultMap.set(key, p);
        updatedFromLocal++;
      }
    });

    const merged = Array.from(resultMap.values());

    const localDupes = local.length - localDeduped.length;
    const remoteDupes = remote.length - remoteDeduped.length;
    const totalDupes = localDupes + remoteDupes;

    const stats = {
      local: local.length,
      localDeduped: localDeduped.length,
      remote: remote.length,
      remoteDeduped: remoteDeduped.length,
      merged: merged.length,
      addedFromLocal,
      updatedFromLocal,
      duplicatesRemoved: totalDupes
    };

    const delta = merged.length - remoteDeduped.length;
    logCritical(`üîÄ [MERGE PRODUCTS] local: ${stats.local}${localDupes ? ` (‚àí${localDupes} dupes)` : ''}, remote: ${stats.remote}${remoteDupes ? ` (‚àí${remoteDupes} dupes)` : ''} ‚Üí merged: ${merged.length} (${delta >= 0 ? '+' : ''}${delta})`);

    if (addedFromLocal > 0 || updatedFromLocal > 0) {
      log(`üì¶ [MERGE] Added ${addedFromLocal} new, updated ${updatedFromLocal} existing`);
    }

    return merged;
  }

  HEYS.CloudMerge = HEYS.CloudMerge || {};
  HEYS.CloudMerge.mergeItemsById = mergeItemsById;
  HEYS.CloudMerge.mergeDayData = mergeDayData;
  HEYS.CloudMerge.mergeProductsData = mergeProductsData;
})(window);


/* ===== heys_cloud_storage_utils_v1.js ===== */
// heys_cloud_storage_utils_v1.js ‚Äî localStorage helpers and cleanup
; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const cloud = HEYS.cloud = HEYS.cloud || {};

  function getLogger() {
    const logger = cloud._log || {};
    return {
      log: logger.log || function () { },
      logCritical: logger.logCritical || function () { },
      err: logger.err || function () { }
    };
  }

  HEYS.CloudStorageUtils = HEYS.CloudStorageUtils || {};

  HEYS.CloudStorageUtils.init = function (options = {}) {
    const MAX_STORAGE_MB = options.maxStorageMb || 4.5;
    const OLD_DATA_DAYS = options.oldDataDays || 90;
    const PENDING_QUEUE_KEY = options.pendingQueueKey || 'heys_pending_sync_queue';
    const PENDING_CLIENT_QUEUE_KEY = options.pendingClientQueueKey || 'heys_pending_client_sync_queue';
    const SYNC_LOG_KEY = options.syncLogKey || 'heys_sync_log';

    const { log, logCritical, err } = getLogger();

    function getStorageSize() {
      try {
        let total = 0;
        for (let key in global.localStorage) {
          if (global.localStorage.hasOwnProperty(key)) {
            total += (global.localStorage.getItem(key) || '').length * 2;
          }
        }
        return total / 1024 / 1024;
      } catch (e) {
        return 0;
      }
    }

    function getDateFromDayKey(key) {
      const match = key.match(/dayv2_(\d{4}-\d{2}-\d{2})/);
      if (match) {
        return new Date(match[1]);
      }
      return null;
    }

    function cleanupOldData(daysToKeep = OLD_DATA_DAYS) {
      try {
        const now = new Date();
        const cutoff = new Date(now.getTime() - daysToKeep * 24 * 60 * 60 * 1000);
        let cleaned = 0;

        const keysToRemove = [];
        for (let i = 0; i < global.localStorage.length; i++) {
          const key = global.localStorage.key(i);
          if (key && key.includes('dayv2_')) {
            const date = getDateFromDayKey(key);
            if (date && date < cutoff) {
              keysToRemove.push(key);
            }
          }
        }

        keysToRemove.forEach(key => {
          global.localStorage.removeItem(key);
          cleaned++;
        });

        if (cleaned > 0) {
          logCritical(`üßπ –û—á–∏—â–µ–Ω–æ ${cleaned} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (>${daysToKeep} –¥–Ω–µ–π)`);
        }

        return cleaned;
      } catch (e) {
        return 0;
      }
    }

    function aggressiveCleanup() {
      logCritical('üö® –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ storage...');

      cleanupOldData(14);

      const tempKeys = [];
      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (key && (key.includes('_debug') || key.includes('_temp') || key.includes('_cache') || key.includes('_log'))) {
          tempKeys.push(key);
        }
      }
      tempKeys.forEach(k => global.localStorage.removeItem(k));

      global.localStorage.removeItem(PENDING_QUEUE_KEY);
      global.localStorage.removeItem(PENDING_CLIENT_QUEUE_KEY);
      global.localStorage.removeItem(SYNC_LOG_KEY);

      const sizeMB = getStorageSize();
      logCritical(`üìä –†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: ${sizeMB.toFixed(2)} MB`);

      if (sizeMB > 4) {
        cleanupOldData(7);
        logCritical(`üìä –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è >7 –¥–Ω–µ–π: ${getStorageSize().toFixed(2)} MB`);
      }
    }

    function safeSetItem(key, value, originalSetItem) {
      const setFn = originalSetItem || global.localStorage.setItem.bind(global.localStorage);

      try {
        setFn(key, value);
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
          logCritical('‚ö†Ô∏è localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ...');
          cleanupOldData();

          try {
            setFn(key, value);
            return true;
          } catch (e2) {
            global.localStorage.removeItem(PENDING_QUEUE_KEY);
            global.localStorage.removeItem(PENDING_CLIENT_QUEUE_KEY);
            global.localStorage.removeItem(SYNC_LOG_KEY);

            try {
              setFn(key, value);
              return true;
            } catch (e3) {
              aggressiveCleanup();
              try {
                setFn(key, value);
                return true;
              } catch (e4) {
                logCritical('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: storage –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω');
                return false;
              }
            }
          }
        }
        return false;
      }
    }

    function loadPendingQueue(key) {
      try {
        const data = global.localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        return [];
      }
    }

    function savePendingQueue(key, queue) {
      try {
        if (queue.length > 0) {
          safeSetItem(key, JSON.stringify(queue));
        } else {
          global.localStorage.removeItem(key);
        }
      } catch (e) { }
    }

    function cleanupDuplicateKeys() {
      const keysToRemove = [];
      const currentClientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;

      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (!key) continue;

        if (key.match(/[a-f0-9-]{36}_[a-f0-9-]{36}_/)) {
          keysToRemove.push(key);
          continue;
        }

        if (key.includes('_heys_products')) {
          keysToRemove.push(key);
          continue;
        }

        if (key.includes('_products_backup') && currentClientId && key.includes(currentClientId)) {
          const normalKey = key.replace('_products_backup', '_products');
          if (global.localStorage.getItem(normalKey)) {
            keysToRemove.push(key);
          }
        }
      }

      if (keysToRemove.length > 0) {
        keysToRemove.forEach(k => global.localStorage.removeItem(k));
        log(`üßπ –û—á–∏—â–µ–Ω–æ ${keysToRemove.length} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–ª—é—á–µ–π`);
      }

      return keysToRemove.length;
    }

    function diagnoseStorage() {
      const items = [];
      let total = 0;

      for (let key in global.localStorage) {
        if (global.localStorage.hasOwnProperty(key)) {
          const value = global.localStorage.getItem(key) || '';
          const sizeKB = (value.length * 2) / 1024;
          total += sizeKB;
          items.push({ key, sizeKB: sizeKB.toFixed(2), chars: value.length });
        }
      }

      items.sort((a, b) => parseFloat(b.sizeKB) - parseFloat(a.sizeKB));

      console.log('üìä localStorage –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:');
      console.log(`–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${(total / 1024).toFixed(2)} MB`);
      console.log('–¢–æ–ø-10 –ø–æ —Ä–∞–∑–º–µ—Ä—É:');
      console.table(items.slice(0, 10));

      return { totalMB: (total / 1024).toFixed(2), items: items.slice(0, 20) };
    }

    function clearClientData(keepDays = 30) {
      const clientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
      const prefix = clientId ? clientId + '_' : '';
      let cleaned = 0;

      const keysToRemove = [];
      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (key && key.startsWith('heys_') && key.includes(prefix) && key.includes('dayv2_')) {
          const match = key.match(/dayv2_(\d{4}-\d{2}-\d{2})/);
          if (match) {
            const date = new Date(match[1]);
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - keepDays);
            if (date < cutoff) {
              keysToRemove.push(key);
            }
          }
        }
      }

      keysToRemove.forEach(k => {
        global.localStorage.removeItem(k);
        cleaned++;
      });

      console.log(`üßπ –û—á–∏—â–µ–Ω–æ ${cleaned} –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ ${keepDays} –¥–Ω–µ–π`);
      diagnoseStorage();
      return cleaned;
    }

    function cleanupOtherClientsProducts() {
      const currentClientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
      if (!currentClientId) {
        console.log('‚ùå –ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞');
        return 0;
      }

      const keysToRemove = [];
      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (key && key.includes('_products') && !key.includes(currentClientId)) {
          keysToRemove.push(key);
        }
      }

      keysToRemove.forEach(k => global.localStorage.removeItem(k));
      console.log(`üßπ –£–¥–∞–ª–µ–Ω–æ ${keysToRemove.length} –∫–ª—é—á–µ–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤`);
      diagnoseStorage();
      return keysToRemove.length;
    }

    cloud._storageUtils = {
      getStorageSize,
      getDateFromDayKey,
      cleanupOldData,
      aggressiveCleanup,
      safeSetItem,
      loadPendingQueue,
      savePendingQueue,
      cleanupDuplicateKeys,
      diagnoseStorage,
      clearClientData,
      cleanupOtherClientsProducts,
      maxStorageMb: MAX_STORAGE_MB
    };

    cloud.getStorageInfo = function () {
      const sizeMB = getStorageSize();
      const usedPercent = Math.round((sizeMB / MAX_STORAGE_MB) * 100);
      return {
        sizeMB: sizeMB.toFixed(2),
        maxMB: MAX_STORAGE_MB,
        usedPercent,
        isNearLimit: usedPercent > 80
      };
    };

    cloud.cleanupStorage = cleanupOldData;
    cloud.diagnoseStorage = diagnoseStorage;
    cloud.clearClientData = clearClientData;
    cloud.cleanupDuplicates = cleanupDuplicateKeys;
    cloud.cleanupOtherClientsProducts = cleanupOtherClientsProducts;
  };
})(window);


/* ===== heys_cloud_shared_v1.js ===== */
// heys_cloud_shared_v1.js ‚Äî shared products API
; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const cloud = HEYS.cloud = HEYS.cloud || {};

  function getLogger() {
    const logger = cloud._log || {};
    return {
      log: logger.log || function () { },
      err: logger.err || function () { }
    };
  }

  function getUser() {
    return cloud._getUser ? cloud._getUser() : null;
  }

  HEYS.CloudShared = HEYS.CloudShared || {};

  HEYS.CloudShared.init = function () {
    const { log, err } = getLogger();

    const readStoredValue = (key, fallback = null) => {
      let value;
      if (HEYS.store?.get) {
        value = HEYS.store.get(key, fallback);
      } else if (HEYS.utils?.lsGet) {
        value = HEYS.utils.lsGet(key, fallback);
      } else {
        try {
          value = localStorage.getItem(key);
        } catch {
          return fallback;
        }
      }

      if (value == null) return fallback;

      if (typeof value === 'string') {
        if (value.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
          try {
            value = HEYS.store.decompress(value.slice(3));
          } catch {
          }
        }
        try {
          return JSON.parse(value);
        } catch {
          return value;
        }
      }

      return value;
    };

    const toNum = (v) => {
      if (v == null || v === '') return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    /**
     * @architecture "Normalize Once, Render Anywhere"
     * - –í—Å–µ shared –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
     * - –†–µ–Ω–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
     * - SoT —Ñ–æ—Ä–º—É–ª—ã = computeDerivedProduct()
     */
    /**
     * Normalize shared product to have both harm and harmScore fields
     * Uses centralized HEYS.models.normalizeHarm() if available
     * Extended in v4.4.0 to normalize all extended nutrient fields
     */
    const normalizeSharedProduct = (p) => {
      if (!p || typeof p !== 'object') return p;

      if (HEYS.features?.unifiedTables === false) {
        return HEYS.models?.normalizeProductFields
          ? HEYS.models.normalizeProductFields({ ...p })
          : { ...p };
      }

      // Use extended normalization if available (v4.4.0+)
      if (HEYS.models?.normalizeExtendedProduct) {
        try {
          return HEYS.models.normalizeExtendedProduct(p);
        } catch (e) {
          err('[HEYS.shared] normalizeExtendedProduct failed:', e);
        }
      }

      // Fallback to basic normalization (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è extended mapping)
      let next = { ...p };

      if (HEYS.models?.normalizeProductFields) {
        next = HEYS.models.normalizeProductFields(next);
      }

      const harmVal = HEYS.models?.normalizeHarm?.(next) ?? toNum(next.harm ?? next.harmScore ?? next.harmscore);
      if (harmVal != null) {
        next.harm = harmVal;
        next.harmScore = harmVal;
      }

      if (next.gi != null) next.gi = toNum(next.gi);

      if (HEYS.models?.computeDerivedProduct) {
        const derived = HEYS.models.computeDerivedProduct(next);
        next.kcal100 = derived.kcal100;
        next.carbs100 = derived.carbs100;
        next.fat100 = derived.fat100;
        if (derived.harm != null && next.harm == null) {
          next.harm = derived.harm;
          next.harmScore = derived.harm;
        }
      }

      next._normalized = true;
      return next;
    };

    const backfillSharedHarm = async (items) => {
      if (!Array.isArray(items) || items.length === 0) return items;

      const calcHarm = HEYS?.Harm?.calculateHarmScore;
      if (typeof calcHarm !== 'function') return items;

      const needs = items.filter(p => p && p.id && (p.harm == null && p.harmScore == null));
      if (needs.length === 0) return items;

      const withHarm = items.map(p => {
        if (!p || p.harm != null || p.harmScore != null) return p;
        const harmValue = calcHarm(p);
        return { ...p, harm: harmValue, harmScore: harmValue };
      });

      const canPersist = HEYS?.utils?.lsGet && HEYS?.utils?.lsSet;
      const backfillKey = 'heys_shared_harm_backfill_v1';
      const missingKey = needs.map(p => p.id).sort().join('|');
      const lastKey = canPersist ? HEYS.utils.lsGet(backfillKey, '') : '';

      if (missingKey && missingKey !== lastKey) {
        try {
          const updates = needs.map(p => ({ id: p.id, harm: calcHarm(p) }));
          const { error } = await YandexAPI.rest('shared_products', {
            method: 'POST',
            data: updates,
            upsert: true,
            onConflict: 'id'
          });

          if (!error && canPersist) {
            HEYS.utils.lsSet(backfillKey, missingKey);
          }

          if (error) {
            HEYS.analytics?.trackError?.(error, { context: 'shared_harm_backfill' });
          }
        } catch (e) {
          HEYS.analytics?.trackError?.(e, { context: 'shared_harm_backfill' });
        }
      }

      return withHarm;
    };

    let _sharedProductsCache = [];
    let _sharedProductsCacheTime = 0;
    const SHARED_PRODUCTS_CACHE_TTL = 5 * 60 * 1000;

    cloud.getCachedSharedProducts = function () {
      return _sharedProductsCache || [];
    };

    // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –∫—ç—à–µ (–¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    cloud.updateCachedSharedProduct = function (productId, updates) {
      if (!productId || !_sharedProductsCache?.length) return false;
      const idx = _sharedProductsCache.findIndex((p) => String(p?.id) === String(productId));
      if (idx === -1) return false;
      _sharedProductsCache[idx] = { ..._sharedProductsCache[idx], ...updates };
      console.info('[HEYS.cloud] ‚úÖ –ö—ç—à shared product –æ–±–Ω–æ–≤–ª—ë–Ω', { productId, updates });
      return true;
    };

    // üîÑ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ (–∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ)
    cloud.invalidateSharedProductsCache = function () {
      _sharedProductsCacheTime = 0;
      console.info('[HEYS.cloud] üîÑ –ö—ç—à shared products –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω');
    };

    cloud.getAllSharedProducts = async function (options = {}) {
      const { limit = 500, excludeBlocklist = true } = options;

      try {
        let data = null;
        let error = null;

        if (YandexAPI?.rpc) {
          const rpcResult = await YandexAPI.rpc('get_shared_products', {
            p_search: null,
            p_limit: limit,
            p_offset: 0
          });
          data = rpcResult?.data;
          error = rpcResult?.error;
        }

        // [baza] –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ RPC
        if (Array.isArray(data) && data.length > 0) {
          const sample = data[0];
          const vitKeys = ['vitamin_a', 'vitamin_c', 'vitamin_d', 'vitamin_e', 'vitamin_k', 'vitamin_b1', 'vitamin_b2', 'vitamin_b3', 'vitamin_b6', 'vitamin_b9', 'vitamin_b12', 'vitaminA', 'vitaminC', 'vitaminD', 'vitaminB1', 'vitaminB6', 'vitaminB9', 'vitaminB12'];
          const minKeys = ['calcium', 'iron', 'magnesium', 'phosphorus', 'potassium', 'zinc', 'selenium', 'iodine'];
          const extKeys = ['sodium100', 'omega3_100', 'omega6_100', 'nova_group', 'novaGroup', 'nutrient_density', 'nutrientDensity'];
          const sampleVits = {}; vitKeys.forEach(k => { if (sample[k] !== undefined) sampleVits[k] = sample[k]; });
          const sampleMins = {}; minKeys.forEach(k => { if (sample[k] !== undefined) sampleMins[k] = sample[k]; });
          const sampleExt = {}; extKeys.forEach(k => { if (sample[k] !== undefined) sampleExt[k] = sample[k]; });
          console.info('[baza] üì¶ RPC raw data ‚Äî first product:', sample.name, '| ALL KEYS:', Object.keys(sample).sort().join(', '));
          console.info('[baza] üß™ vitamins:', JSON.stringify(sampleVits));
          console.info('[baza] üß™ minerals:', JSON.stringify(sampleMins));
          console.info('[baza] üß™ extended:', JSON.stringify(sampleExt));
          console.info('[baza] üìä total products:', data.length, '| products with vitamin_c:', data.filter(p => p.vitamin_c != null || p.vitaminC != null).length);
        } else {
          console.warn('[baza] ‚ö†Ô∏è RPC returned:', { dataIsArray: Array.isArray(data), dataLength: data?.length, error });
        }

        if (error || !Array.isArray(data)) {
          console.warn('[baza] ‚ö†Ô∏è RPC failed, trying REST fallback. error:', error);
          const restResult = await YandexAPI.from('shared_products')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(limit);
          data = restResult?.data;
          error = restResult?.error;
          if (Array.isArray(data) && data.length > 0) {
            console.info('[baza] üì¶ REST fallback data ‚Äî first product keys:', Object.keys(data[0]).sort().join(', '));
          }
        }

        if (error) {
          err('[SHARED PRODUCTS] Get all error:', error);
          return { data: null, error };
        }

        const safeNormalize = (item) => {
          try {
            return normalizeSharedProduct(item);
          } catch (e) {
            err('[HEYS.shared] normalizeSharedProduct failed:', e);
            return null;
          }
        };
        let filtered = (data || []).map(safeNormalize).filter(Boolean);

        // [baza] –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
        if (filtered.length > 0) {
          const s = filtered[0];
          console.info('[baza] ‚úÖ After normalize ‚Äî first product:', s.name, '| keys:', Object.keys(s).sort().join(', '));
          console.info('[baza] üî¨ vitaminC=', s.vitamin_c, '| vitaminC(camel)=', s.vitaminC, '| calcium=', s.calcium, '| sodium100=', s.sodium100, '| iron=', s.iron);
        }

        filtered = await backfillSharedHarm(filtered);
        const user = getUser();
        if (excludeBlocklist && user) {
          const blocklist = await cloud.getBlocklist();
          const blocklistSet = new Set(blocklist.map(id => id));
          filtered = filtered.filter(p => !blocklistSet.has(p.id));
        }

        _sharedProductsCache = filtered;
        _sharedProductsCacheTime = Date.now();
        log(`[SHARED PRODUCTS] Loaded ${filtered.length} products total, cached`);

        return { data: filtered, error: null };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message };
      }
    };

    cloud.searchSharedProducts = async function (query, options = {}) {
      const { limit = 50, excludeBlocklist = true, fingerprint = null } = options;
      const normQuery = (HEYS?.models?.normalizeProductName
        ? HEYS.models.normalizeProductName(query)
        : (query || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));

      try {
        const fetchByName = async (nameQ) => {
          const q = (nameQ || '').toString().trim();
          if (!q) return [];
          const { data, error } = await YandexAPI.rest('shared_products', {
            select: '*',
            filters: { 'ilike.name_norm': `%${q}%` },
            order: 'created_at.desc',
            limit
          });
          if (error) throw error;
          return data || [];
        };

        const filters = {};

        if (fingerprint) {
          filters['eq.fingerprint'] = fingerprint;
        } else if (normQuery) {
          filters['ilike.name_norm'] = `%${normQuery}%`;
        }

        let data;
        let error;
        ({ data, error } = await YandexAPI.rest('shared_products', {
          select: '*',
          filters,
          order: 'created_at.desc',
          limit
        }));

        if (error) {
          err('[SHARED PRODUCTS] Search error:', error);
          return { data: null, error };
        }

        if (!fingerprint && normQuery && Array.isArray(data)) {
          const baseCount = data.length;
          if (baseCount < 3 && normQuery.length >= 4) {
            const prefix3 = normQuery.slice(0, 3);
            if (prefix3 && prefix3.length === 3 && prefix3 !== normQuery) {
              try {
                const fallbackData = await fetchByName(prefix3);
                if (fallbackData && fallbackData.length) {
                  const byId = new Map();
                  (data || []).forEach(p => {
                    const key = p?.id || p?.fingerprint || p?.name;
                    if (key) byId.set(key, p);
                  });
                  fallbackData.forEach(p => {
                    const key = p?.id || p?.fingerprint || p?.name;
                    if (key && !byId.has(key)) byId.set(key, p);
                  });
                  data = Array.from(byId.values()).slice(0, limit);
                }
              } catch (e) {
              }
            }
          }
        }

        const safeNormalize = (item) => {
          try {
            return normalizeSharedProduct(item);
          } catch (e) {
            err('[HEYS.shared] normalizeSharedProduct failed:', e);
            return null;
          }
        };
        let filtered = (data || []).map(safeNormalize).filter(Boolean);
        const user = getUser();
        if (excludeBlocklist && user) {
          const blocklist = await cloud.getBlocklist();
          const blocklistSet = new Set(blocklist.map(id => id));
          filtered = filtered.filter(p => !blocklistSet.has(p.id));
        }

        log(`[SHARED PRODUCTS] Found ${filtered.length} products for "${query}"`);
        return { data: filtered, error: null };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message };
      }
    };

    cloud.publishToShared = async function (product) {
      const user = getUser();
      if (!user) {
        return { data: null, error: 'Not authenticated', status: 'error' };
      }

      try {
        const fingerprint = await HEYS.models.computeProductFingerprint(product);
        const name_norm = HEYS.models.normalizeProductName(product.name);

        const curatorId = user?.id;

        if (!curatorId) {
          console.error('[SHARED] No curator ID');
          return { data: null, error: 'Not authenticated as curator', status: 'error' };
        }

        const productData = {
          name: product.name,
          fingerprint,
          simple100: product.simple100 ?? 0,
          complex100: product.complex100 ?? 0,
          protein100: product.protein100 ?? 0,
          badFat100: product.badFat100 ?? product.badfat100 ?? 0,
          goodFat100: product.goodFat100 ?? product.goodfat100 ?? 0,
          trans100: product.trans100 ?? 0,
          fiber100: product.fiber100 ?? 0,
          gi: product.gi ?? null,
          harm: product.harm ?? product.harmScore ?? null,
          category: product.category ?? null,
          portions: product.portions ?? null,
          description: product.description ?? null,
          // Extended fields (v4.4.0) ‚Äî camelCase ‚Üî snake_case fallback
          sodium100: product.sodium100 ?? null,
          omega3_100: product.omega3_100 ?? null,
          omega6_100: product.omega6_100 ?? null,
          nova_group: product.nova_group ?? product.novaGroup ?? null,
          additives: product.additives ?? null,
          nutrient_density: product.nutrient_density ?? product.nutrientDensity ?? null,
          is_organic: product.is_organic ?? product.isOrganic ?? false,
          is_whole_grain: product.is_whole_grain ?? product.isWholeGrain ?? false,
          is_fermented: product.is_fermented ?? product.isFermented ?? false,
          is_raw: product.is_raw ?? product.isRaw ?? false,
          // Vitamins ‚Äî camelCase ‚Üî snake_case fallback
          vitamin_a: product.vitamin_a ?? product.vitaminA ?? null,
          vitamin_c: product.vitamin_c ?? product.vitaminC ?? null,
          vitamin_d: product.vitamin_d ?? product.vitaminD ?? null,
          vitamin_e: product.vitamin_e ?? product.vitaminE ?? null,
          vitamin_k: product.vitamin_k ?? product.vitaminK ?? null,
          vitamin_b1: product.vitamin_b1 ?? product.vitaminB1 ?? null,
          vitamin_b2: product.vitamin_b2 ?? product.vitaminB2 ?? null,
          vitamin_b3: product.vitamin_b3 ?? product.vitaminB3 ?? null,
          vitamin_b6: product.vitamin_b6 ?? product.vitaminB6 ?? null,
          vitamin_b9: product.vitamin_b9 ?? product.vitaminB9 ?? null,
          vitamin_b12: product.vitamin_b12 ?? product.vitaminB12 ?? null,
          // Minerals
          calcium: product.calcium ?? null,
          iron: product.iron ?? null,
          magnesium: product.magnesium ?? null,
          phosphorus: product.phosphorus ?? null,
          potassium: product.potassium ?? null,
          zinc: product.zinc ?? null,
          selenium: product.selenium ?? null,
          iodine: product.iodine ?? null
        };

        console.log('[SHARED] üìù Publishing via RPC:', productData.name);
        console.info('[baza] üì§ publishToShared input keys:', Object.keys(product).filter(k => k.match(/vitamin|calcium|iron|magnesium|sodium/i)).join(', '));
        console.info('[baza] üì§ publishToShared output: vitamin_c=', productData.vitamin_c, '| calcium=', productData.calcium, '| iron=', productData.iron, '| sodium100=', productData.sodium100, '| vitamin_b1=', productData.vitamin_b1);

        const { data, error } = await YandexAPI.rpc('publish_shared_product_by_curator', {
          p_curator_id: curatorId,
          p_product_data: productData
        });

        console.log('[SHARED] RPC result:', { data, error });

        if (error) {
          console.error('[SHARED] ‚ùå Publish error:', error);
          err('[SHARED PRODUCTS] Publish error:', error);
          return { data: null, error, status: 'error' };
        }

        if (data?.success === false) {
          console.error('[SHARED] ‚ùå RPC returned error:', data.error);
          return { data: null, error: data.error, status: 'error', message: data.message };
        }

        const status = data?.status || 'published';
        console.log('[SHARED] ‚úÖ Result:', status, product.name);
        log('[SHARED PRODUCTS] Result:', status, product.name);
        return {
          data: { id: data?.id },
          error: null,
          status,
          message: data?.message
        };
      } catch (e) {
        console.error('[SHARED] ‚ùå Unexpected error:', e);
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message, status: 'error' };
      }
    };

    cloud.deleteSharedProduct = async function (productId) {
      console.log('[SHARED] üóëÔ∏è deleteSharedProduct called:', productId);

      const user = getUser();
      if (!user) {
        console.log('[SHARED] ‚ùå Not authenticated');
        return { success: false, error: 'Not authenticated' };
      }

      try {
        const { error } = await YandexAPI.from('shared_products')
          .delete()
          .eq('id', productId);

        if (error) {
          console.error('[SHARED] ‚ùå Delete error:', error);
          return { success: false, error: error.message };
        }

        console.log('[SHARED] ‚úÖ Deleted from shared:', productId);
        return { success: true, error: null };
      } catch (e) {
        console.error('[SHARED] ‚ùå Unexpected error:', e);
        return { success: false, error: e.message };
      }
    };

    cloud.createPendingProduct = async function (clientId, product) {
      try {
        const sessionToken = (typeof HEYS !== 'undefined' && HEYS.Auth?.getSessionToken?.())
          || readStoredValue('heys_session_token', null);
        if (!sessionToken) {
          return { data: null, error: 'No session token', status: 'error' };
        }

        const { data, error } = await YandexAPI.rpc('create_pending_product_by_session', {
          p_session_token: sessionToken,
          p_name: product.name,
          p_product_data: product
        });

        if (error) {
          err('[SHARED PRODUCTS] Pending create error:', error);
          return { data: null, error, status: 'error' };
        }

        log('[SHARED PRODUCTS] Pending created:', data);
        return {
          data,
          error: null,
          status: data.status,
          message: data.message
        };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message, status: 'error' };
      }
    };

    cloud.getPendingProducts = async function () {
      const user = getUser();
      if (!user) {
        return { data: null, error: 'Not authenticated' };
      }

      try {
        const { data, error } = await YandexAPI.rest('shared_products_pending', {
          select: '*',
          filters: {
            'eq.curator_id': user.id,
            'eq.status': 'pending'
          },
          order: 'created_at.desc'
        });

        if (error) {
          err('[SHARED PRODUCTS] Get pending error:', error);
          return { data: null, error };
        }

        log(`[SHARED PRODUCTS] Found ${data?.length || 0} pending products`);
        return { data, error: null };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message };
      }
    };

    cloud.approvePendingProduct = async function (pendingId, productData) {
      const user = getUser();
      if (!user) {
        return { data: null, error: 'Not authenticated', status: 'error' };
      }

      try {
        const publishResult = await cloud.publishToShared(productData);

        if (publishResult.error && publishResult.status !== 'exists') {
          return publishResult;
        }

        const { error: updateError } = await YandexAPI.rest('shared_products_pending', {
          method: 'PATCH',
          filters: { 'eq.id': pendingId },
          data: {
            status: 'approved',
            moderated_at: new Date().toISOString(),
            moderated_by: user.id
          }
        });

        if (updateError) {
          err('[SHARED PRODUCTS] Approve update error:', updateError);
          return { data: null, error: updateError, status: 'error' };
        }

        log('[SHARED PRODUCTS] Approved pending:', pendingId);
        return {
          data: publishResult.data,
          error: null,
          status: 'approved',
          existing: publishResult.status === 'exists'
        };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message, status: 'error' };
      }
    };

    cloud.rejectPendingProduct = async function (pendingId, reason = '') {
      const user = getUser();
      if (!user) {
        return { data: null, error: 'Not authenticated' };
      }

      try {
        const { data, error } = await YandexAPI.rest('shared_products_pending', {
          method: 'PATCH',
          filters: { 'eq.id': pendingId },
          data: {
            status: 'rejected',
            reject_reason: reason,
            moderated_at: new Date().toISOString(),
            moderated_by: user.id
          },
          select: '*',
          limit: 1
        });

        if (error) {
          err('[SHARED PRODUCTS] Reject error:', error);
          return { data: null, error };
        }

        log('[SHARED PRODUCTS] Rejected pending:', pendingId);
        return { data, error: null };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message };
      }
    };

    cloud.getBlocklist = async function () {
      const user = getUser();
      if (!user) return [];

      try {
        const { data, error } = await YandexAPI.rest('shared_products_blocklist', {
          select: 'product_id',
          filters: { 'eq.curator_id': user.id }
        });

        if (error) {
          err('[SHARED PRODUCTS] Get blocklist error:', error);
          return [];
        }

        return (data || []).map(row => row.product_id);
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return [];
      }
    };

    cloud.blockProduct = async function (productId) {
      const user = getUser();
      if (!user) {
        return { data: null, error: 'Not authenticated' };
      }

      try {
        const { data, error } = await YandexAPI.rest('shared_products_blocklist', {
          method: 'POST',
          data: {
            curator_id: user.id,
            product_id: productId
          },
          select: '*',
          limit: 1
        });

        if (error) {
          err('[SHARED PRODUCTS] Block error:', error);
          return { data: null, error };
        }

        log('[SHARED PRODUCTS] Blocked product:', productId);
        return { data, error: null };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message };
      }
    };

    cloud.unblockProduct = async function (productId) {
      const user = getUser();
      if (!user) {
        return { data: null, error: 'Not authenticated' };
      }

      try {
        const { error } = await YandexAPI.rest('shared_products_blocklist', {
          method: 'DELETE',
          filters: {
            'eq.curator_id': user.id,
            'eq.product_id': productId
          }
        });

        if (error) {
          err('[SHARED PRODUCTS] Unblock error:', error);
          return { data: null, error };
        }

        log('[SHARED PRODUCTS] Unblocked product:', productId);
        return { data: true, error: null };
      } catch (e) {
        err('[SHARED PRODUCTS] Unexpected error:', e);
        return { data: null, error: e.message };
      }
    };
  };
})(window);


/* ===== heys_cloud_queue_v1.js ===== */
// heys_cloud_queue_v1.js ‚Äî persistent queues and upload scheduling
; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const cloud = HEYS.cloud = HEYS.cloud || {};

  function getLogger() {
    const logger = cloud._log || {};
    return {
      log: logger.log || function () { },
      logCritical: logger.logCritical || function () { }
    };
  }

  HEYS.CloudQueue = HEYS.CloudQueue || {};

  HEYS.CloudQueue.init = function () {
    const { log, logCritical } = getLogger();
    const trackError = (err, context) => HEYS.analytics?.trackError?.(err, context);

    const storageUtils = cloud._storageUtils || {};
    const loadPendingQueue = storageUtils.loadPendingQueue || function () { return []; };
    const savePendingQueue = storageUtils.savePendingQueue || function () { };

    const PENDING_QUEUE_KEY = 'heys_pending_sync_queue';
    const PENDING_CLIENT_QUEUE_KEY = 'heys_pending_client_sync_queue';

    let clientUpsertQueue = loadPendingQueue(PENDING_CLIENT_QUEUE_KEY);
    let clientUpsertTimer = null;
    let _uploadInProgress = false;
    let _uploadInFlightCount = 0;

    let upsertQueue = loadPendingQueue(PENDING_QUEUE_KEY);
    let upsertTimer = null;

    const getInternal = () => cloud._internal || {};

    function getUser() {
      return getInternal().getUser ? getInternal().getUser() : null;
    }

    function getRpcOnlyMode() {
      return getInternal().getRpcOnlyMode ? getInternal().getRpcOnlyMode() : false;
    }

    function getPinAuthClientId() {
      return getInternal().getPinAuthClientId ? getInternal().getPinAuthClientId() : null;
    }

    function getRetryDelay() {
      return getInternal().getRetryDelay ? getInternal().getRetryDelay() : 1000;
    }

    function resetRetry() {
      if (getInternal().resetRetry) getInternal().resetRetry();
    }

    function incrementRetry() {
      if (getInternal().incrementRetry) getInternal().incrementRetry();
    }

    function notifyPendingChange() {
      if (getInternal().notifyPendingChange) getInternal().notifyPendingChange();
    }

    function notifySyncCompletedIfDrained() {
      if (getInternal().notifySyncCompletedIfDrained) getInternal().notifySyncCompletedIfDrained();
    }

    function notifySyncError(error, retryIn) {
      if (getInternal().notifySyncError) getInternal().notifySyncError(error, retryIn);
    }

    function isAuthError(error) {
      if (getInternal().isAuthError) return getInternal().isAuthError(error);
      return false;
    }

    function handleAuthFailure(err) {
      if (getInternal().handleAuthFailure) getInternal().handleAuthFailure(err);
    }

    function setSyncProgressDone(count) {
      if (getInternal().addSyncProgressDone) getInternal().addSyncProgressDone(count);
    }

    async function doClientUpload(batch) {
      if (!batch.length) {
        _uploadInProgress = false;
        _uploadInFlightCount = 0;
        notifySyncCompletedIfDrained();
        return;
      }

      _uploadInProgress = true;
      _uploadInFlightCount = batch.length;

      const canSync = getRpcOnlyMode();
      log('üîê [UPLOAD] canSync check:', { _rpcOnlyMode: getRpcOnlyMode(), hasUser: !!getUser(), batchLen: batch.length, canSync });
      if (!canSync) {
        log('‚ö†Ô∏è [UPLOAD] canSync=false, returning batch to queue');
        clientUpsertQueue.push(...batch);
        _uploadInProgress = false;
        _uploadInFlightCount = 0;
        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();
        notifySyncCompletedIfDrained();
        return;
      }

      if (!navigator.onLine) {
        clientUpsertQueue.push(...batch);
        _uploadInProgress = false;
        _uploadInFlightCount = 0;
        incrementRetry();
        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();
        scheduleClientPush();
        notifySyncCompletedIfDrained();
        return;
      }

      const uniqueBatch = [];
      const seenKeys = new Set();
      for (let i = batch.length - 1; i >= 0; i--) {
        const item = batch[i];
        const key = `${item.client_id}:${item.k}`;
        if (!seenKeys.has(key)) {
          seenKeys.add(key);
          uniqueBatch.unshift(item);
        }
      }

      try {
        if (getRpcOnlyMode()) {
          const byClientId = {};
          uniqueBatch.forEach(item => {
            const cid = item.client_id;
            if (!byClientId[cid]) byClientId[cid] = [];
            byClientId[cid].push({ k: item.k, v: item.v, updated_at: item.updated_at });
          });

          log('üîê [UPLOAD] RPC mode: grouped by clientId:', Object.keys(byClientId).map(c => c.slice(0, 8)));

          let totalSaved = 0;
          let anyError = null;
          let isAuthErrorFlag = false;
          for (const [clientId, items] of Object.entries(byClientId)) {
            const result = await cloud.saveClientViaRPC(clientId, items);
            if (result.success) {
              totalSaved += result.saved || items.length;
            } else {
              anyError = result.error;
              if (anyError === 'No auth token available' || anyError === 'No session token') {
                isAuthErrorFlag = true;
              }
              items.forEach(item => clientUpsertQueue.push({ ...item, client_id: clientId }));
            }
          }

          if (anyError) {
            incrementRetry();
            savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
            notifyPendingChange();

            if (isAuthErrorFlag) {
              log('‚ö†Ô∏è [UPLOAD] Auth error, NOT retrying ‚Äî waiting for login');
            } else if ((getInternal().retryAttempt || 0) < (getInternal().maxRetryAttempts || 5)) {
              scheduleClientPush();
            } else {
              log('‚ö†Ô∏è [UPLOAD] Max retries reached, data saved locally');
            }
          } else {
            resetRetry();
            logCritical(`‚òÅÔ∏è [YANDEX] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ: ${totalSaved} –∑–∞–ø–∏—Å–µ–π`);
          }

          savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
          notifyPendingChange();

          _uploadInProgress = false;
          _uploadInFlightCount = 0;
          notifySyncCompletedIfDrained();
          return;
        }

        if (!getUser()) {
          log('‚ö†Ô∏è [SAVE] No user session, returning items to queue');
          clientUpsertQueue.push(...uniqueBatch);
          savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
          notifyPendingChange();
          _uploadInProgress = false;
          _uploadInFlightCount = 0;
          notifySyncCompletedIfDrained();
          return;
        }

        const promises = uniqueBatch.map(item => {
          const itemWithUser = item.user_id ? item : { ...item, user_id: getUser()?.id };
          return cloud.upsert('client_kv_store', itemWithUser, 'client_id,k')
            .then(() => ({ success: true, item: itemWithUser }))
            .catch(err => {
              trackError(err || new Error('Upsert error'), { source: 'heys_cloud_queue_v1.js', key: itemWithUser?.k });
              log('‚ö†Ô∏è [UPLOAD] Upsert error for key:', itemWithUser?.k);
              return { success: false, item: itemWithUser, error: err };
            });
        });

        const results = await Promise.all(promises);
        const failedItems = results.filter(r => !r.success).map(r => r.item);
        const successItems = results.filter(r => r.success).map(r => r.item);

        if (failedItems.length > 0) {
          clientUpsertQueue.push(...failedItems);
          incrementRetry();
          savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
          notifyPendingChange();

          const authError = results.find(r => !r.success && isAuthError(r.error))?.error;
          if (authError) {
            handleAuthFailure(authError);
            _uploadInProgress = false;
            _uploadInFlightCount = 0;
            notifySyncCompletedIfDrained();
            return;
          }

          scheduleClientPush();
        } else {
          resetRetry();
        }

        if (successItems.length > 0) {
          const types = {};
          const otherKeys = [];
          successItems.forEach(item => {
            const t = item.k.includes('dayv2_') ? 'day' :
              item.k.includes('products') ? 'products' :
                item.k.includes('profile') ? 'profile' : 'other';
            types[t] = (types[t] || 0) + 1;
            if (t === 'other') otherKeys.push(item.k);
          });
          const summary = Object.entries(types).map(([k, v]) => `${k}:${v}`).join(' ');
          logCritical('‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ:', summary);
          if (otherKeys.length > 0) {
            logCritical('  ‚îî other keys:', otherKeys.join(', '));
          }

          if (typeof window !== 'undefined' && window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('heys:data-uploaded', { detail: { saved: successItems.length } }));
          }
        }

        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();
      } catch (e) {
        clientUpsertQueue.push(...uniqueBatch);
        incrementRetry();
        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();
        trackError(e instanceof Error ? e : new Error(String(e)), { source: 'heys_cloud_queue_v1.js', stage: 'doClientUpload' });
        logCritical('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ:', e.message || e);

        if (isAuthError(e)) {
          handleAuthFailure(e);
          _uploadInProgress = false;
          _uploadInFlightCount = 0;
          notifySyncCompletedIfDrained();
          return;
        }

        if (typeof window !== 'undefined' && window.dispatchEvent) {
          const retryIn = Math.min(5, Math.ceil(getRetryDelay() / 1000));
          notifySyncError(e, retryIn);
        }

        scheduleClientPush();
      }

      setSyncProgressDone(uniqueBatch.length);

      _uploadInProgress = false;
      _uploadInFlightCount = 0;

      notifySyncCompletedIfDrained();
    }

    async function doImmediateClientUpload() {
      if (clientUpsertTimer) {
        clearTimeout(clientUpsertTimer);
        clientUpsertTimer = null;
      }

      const batch = clientUpsertQueue.splice(0, clientUpsertQueue.length);
      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();

      await doClientUpload(batch);
    }

    function scheduleClientPush() {
      if (clientUpsertTimer) return;

      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();

      const delay = navigator.onLine ? 500 : getRetryDelay();

      clientUpsertTimer = setTimeout(async () => {
        const batch = clientUpsertQueue.splice(0, clientUpsertQueue.length);
        clientUpsertTimer = null;
        await doClientUpload(batch);
      }, delay);
    }

    function schedulePush() {
      if (upsertTimer) return;

      savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
      notifyPendingChange();

      const delay = navigator.onLine ? 300 : getRetryDelay();

      upsertTimer = setTimeout(async () => {
        const batch = upsertQueue.splice(0, upsertQueue.length);
        upsertTimer = null;
        if (!cloud.client || !getUser() || !batch.length) {
          savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
          notifyPendingChange();
          return;
        }

        if (!navigator.onLine) {
          upsertQueue.push(...batch);
          incrementRetry();
          savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
          notifyPendingChange();
          schedulePush();
          return;
        }

        const uniqueBatch = [];
        const seenKeys = new Set();
        for (let i = batch.length - 1; i >= 0; i--) {
          const item = batch[i];
          const key = `${item.user_id}:${item.k}`;
          if (!seenKeys.has(key)) {
            seenKeys.add(key);
            uniqueBatch.unshift(item);
          }
        }

        try {
          const { error } = await YandexAPI.from('kv_store').upsert(uniqueBatch, { onConflict: 'user_id,k' });
          if (error) {
            upsertQueue.push(...uniqueBatch);
            incrementRetry();
            savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
            notifyPendingChange();
            if (isAuthError(error)) {
              handleAuthFailure(error);
              return;
            }
            notifySyncError(error, Math.min(5, Math.ceil(getRetryDelay() / 1000)));
            schedulePush();
            return;
          }
          resetRetry();
          savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
          notifyPendingChange();
        } catch (e) {
          upsertQueue.push(...uniqueBatch);
          incrementRetry();
          savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
          notifyPendingChange();
          if (isAuthError(e)) {
            handleAuthFailure(e);
            return;
          }
          notifySyncError(e, Math.min(5, Math.ceil(getRetryDelay() / 1000)));
          schedulePush();
        }

        setSyncProgressDone(uniqueBatch.length);
        notifySyncCompletedIfDrained();
      }, delay);
    }

    cloud.getPendingCount = function () {
      const isClientOnlyMode = getRpcOnlyMode() && getPinAuthClientId();
      const userQueueLen = isClientOnlyMode ? 0 : upsertQueue.length;
      return clientUpsertQueue.length + userQueueLen + (_uploadInProgress ? _uploadInFlightCount : 0);
    };

    cloud.isUploadInProgress = function () {
      return _uploadInProgress;
    };

    cloud.getPendingDetails = function () {
      const details = { days: 0, products: 0, profile: 0, other: 0 };

      const allItems = [...clientUpsertQueue, ...upsertQueue];
      allItems.forEach(item => {
        const k = item.k || '';
        if (k.includes('dayv2_')) details.days++;
        else if (k.includes('products')) details.products++;
        else if (k.includes('profile')) details.profile++;
        else details.other++;
      });

      return details;
    };

    cloud.flushPendingQueue = async function (timeoutMs = 5000) {
      const isClientOnlyMode = getRpcOnlyMode() && getPinAuthClientId();
      const clientQueueLen = clientUpsertQueue.length;
      const userQueueLen = isClientOnlyMode ? 0 : upsertQueue.length;
      const queueLen = clientQueueLen + userQueueLen;
      const inFlight = _uploadInProgress ? _uploadInFlightCount : 0;
      const total = queueLen + inFlight;

      log(`üîÑ [FLUSH] Check: clientQueue=${clientQueueLen}, userQueue=${upsertQueue.length}${isClientOnlyMode ? ' (ignored in PIN mode)' : ''}, inFlight=${inFlight}`);

      if (queueLen === 0 && !_uploadInProgress) {
        log('‚úÖ [FLUSH] Queue already empty and no uploads in progress');
        return true;
      }

      log(`üîÑ [FLUSH] Need to upload ${total} pending items IMMEDIATELY...`);

      if (queueLen > 0) {
        log('üîÑ [FLUSH] Starting IMMEDIATE upload (no debounce)...');
        try {
          await doImmediateClientUpload();
          log('‚úÖ [FLUSH] Immediate upload completed');
        } catch (e) {
          trackError(e instanceof Error ? e : new Error(String(e)), { source: 'heys_cloud_queue_v1.js', stage: 'flushPendingQueue' });
          log('‚ùå [FLUSH] Immediate upload failed');
        }
      }

      const stillClientQueue = clientUpsertQueue.length;
      const stillUserQueue = isClientOnlyMode ? 0 : upsertQueue.length;
      const stillInQueue = stillClientQueue + stillUserQueue;
      if (stillInQueue === 0 && !_uploadInProgress) {
        log('‚úÖ [FLUSH] All uploaded after immediate push');
        return true;
      }

      log(`üîÑ [FLUSH] ${stillInQueue} items still pending (client=${stillClientQueue}, user=${stillUserQueue}), waiting for queue-drained event...`);

      return new Promise((resolve) => {
        const startTime = Date.now();

        const timeoutId = setTimeout(() => {
          const stillPending = cloud.getPendingCount();
          log(`‚ö†Ô∏è [FLUSH] Timeout after ${timeoutMs}ms, ${stillPending} items still pending, inFlight=${_uploadInProgress}`);
          window.removeEventListener('heys:queue-drained', handler);
          resolve(false);
        }, timeoutMs);

        const handler = () => {
          if (_uploadInProgress) {
            log('üîÑ [FLUSH] queue-drained fired but upload still in progress, waiting...');
            return;
          }
          clearTimeout(timeoutId);
          const elapsed = Date.now() - startTime;
          log(`‚úÖ [FLUSH] Queue drained in ${elapsed}ms`);
          window.removeEventListener('heys:queue-drained', handler);
          resolve(true);
        };
        window.addEventListener('heys:queue-drained', handler);

        if (stillInQueue === 0 && _uploadInProgress) {
          log('üîÑ [FLUSH] Queue empty but upload in progress, waiting for completion...');
        }
      });
    };

    cloud.getSyncStatus = function (key) {
      if (clientUpsertQueue.some(item => item.k === key)) {
        return 'pending';
      }
      return 'synced';
    };

    cloud.waitForSync = function (key, timeout = 5000) {
      return new Promise((resolve) => {
        const startTime = Date.now();
        const checkSync = () => {
          if (cloud.getSyncStatus(key) === 'synced' || (Date.now() - startTime) > timeout) {
            resolve(cloud.getSyncStatus(key));
          } else {
            setTimeout(checkSync, 100);
          }
        };
        checkSync();
      });
    };

    cloud._queue = {
      getClientQueue: () => clientUpsertQueue,
      getUserQueue: () => upsertQueue,
      scheduleClientPush,
      schedulePush,
      doImmediateClientUpload
    };
  };
})(window);


/* ===== heys_storage_photos_v1.js ===== */
// heys_storage_photos_v1.js ‚Äî Photo storage (Yandex backend + pending queue)
; (function (global) {
    const HEYS = global.HEYS = global.HEYS || {};
    const Photos = HEYS.StoragePhotos = HEYS.StoragePhotos || {};

    const PENDING_PHOTOS_KEY = 'heys_pending_photos';
    const DEFAULT_BUCKET = 'meal-photos';
    let _cloud = null;

    const isDebug = () => {
        try {
            return global.localStorage.getItem('heys_debug_photos') === 'true' ||
                global.localStorage.getItem('heys_debug_sync') === 'true';
        } catch (_) {
            return false;
        }
    };

    function log() {
        if (!isDebug()) return;
        try {
            console.log.apply(console, ['[HEYS.photos]'].concat([].slice.call(arguments)));
        } catch (_) { }
    }

    function logCritical() {
        if (!isDebug()) return;
        try {
            console.info.apply(console, ['[HEYS.photos]'].concat([].slice.call(arguments)));
        } catch (_) { }
    }

    function getBucket() {
        return HEYS?.config?.photosBucket || DEFAULT_BUCKET;
    }

    function getSessionToken() {
        try {
            const fromAuth = HEYS?.Auth?.getSessionToken?.() || HEYS?.auth?.getSessionToken?.();
            if (fromAuth) return fromAuth;
            const raw = global.localStorage.getItem('heys_session_token');
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch (_) {
                return raw;
            }
        } catch (_) {
            return null;
        }
    }

    function getCuratorToken() {
        try {
            const curatorSession = global.localStorage.getItem('heys_curator_session');
            if (curatorSession) return curatorSession;
            const supabaseAuth = global.localStorage.getItem('heys_supabase_auth_token');
            if (supabaseAuth) {
                const parsed = JSON.parse(supabaseAuth);
                return parsed?.access_token || null;
            }
            return null;
        } catch (_) {
            return null;
        }
    }

    async function base64ToBlob(base64Data) {
        const response = await fetch(base64Data);
        return response.blob();
    }

    async function uploadViaYandex({ base64Data, clientId, date, mealId, blob }) {
        const api = HEYS?.YandexAPI;
        if (!api) {
            return { error: 'YandexAPI not available' };
        }

        if (typeof api.uploadPhoto === 'function') {
            return api.uploadPhoto({
                base64Data,
                clientId,
                date,
                mealId,
                bucket: getBucket()
            });
        }

        const apiBase = api.CONFIG?.API_URL || 'https://api.heyslab.ru';
        const sessionToken = getSessionToken();
        const curatorToken = getCuratorToken();

        const headers = {
            'Content-Type': 'application/json'
        };

        if (curatorToken) {
            headers['Authorization'] = `Bearer ${curatorToken}`;
        }

        const payload = {
            bucket: getBucket(),
            client_id: clientId,
            date,
            meal_id: mealId,
            session_token: sessionToken || undefined,
            data: base64Data
        };

        const response = await fetch(`${apiBase}/photos/upload`, {
            method: 'POST',
            headers,
            body: JSON.stringify(payload)
        });

        let result;
        try {
            result = await response.json();
        } catch (_) {
            result = null;
        }

        if (!response.ok || result?.error) {
            return { error: result?.error || `Upload failed (${response.status})` };
        }

        if (result?.uploadUrl) {
            const uploadHeaders = result?.uploadHeaders || { 'Content-Type': 'image/jpeg' };
            const uploadResponse = await fetch(result.uploadUrl, {
                method: result.uploadMethod || 'PUT',
                headers: uploadHeaders,
                body: blob
            });
            if (!uploadResponse.ok) {
                return { error: `Upload PUT failed (${uploadResponse.status})` };
            }
        }

        return {
            url: result?.url || result?.publicUrl || null,
            path: result?.path || result?.key || null
        };
    }

    async function deleteViaYandex(path) {
        const api = HEYS?.YandexAPI;
        if (!api) {
            return { error: 'YandexAPI not available' };
        }

        if (typeof api.deletePhoto === 'function') {
            return api.deletePhoto({ path, bucket: getBucket() });
        }

        const apiBase = api.CONFIG?.API_URL || 'https://api.heyslab.ru';
        const curatorToken = getCuratorToken();
        const sessionToken = getSessionToken();

        const headers = {
            'Content-Type': 'application/json'
        };

        if (curatorToken) {
            headers['Authorization'] = `Bearer ${curatorToken}`;
        }

        const payload = {
            bucket: getBucket(),
            path,
            session_token: sessionToken || undefined
        };

        const response = await fetch(`${apiBase}/photos/delete`, {
            method: 'POST',
            headers,
            body: JSON.stringify(payload)
        });

        let result;
        try {
            result = await response.json();
        } catch (_) {
            result = null;
        }

        if (!response.ok || result?.error) {
            return { error: result?.error || `Delete failed (${response.status})` };
        }

        return { success: true };
    }

    function savePendingPhoto(base64Data, clientId, date, mealId) {
        try {
            const pending = JSON.parse(global.localStorage.getItem(PENDING_PHOTOS_KEY) || '[]');
            const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);

            pending.push({
                id: photoId,
                data: base64Data,
                clientId,
                date,
                mealId,
                createdAt: Date.now()
            });

            global.localStorage.setItem(PENDING_PHOTOS_KEY, JSON.stringify(pending));
            log('üì∑ Photo saved to pending:', photoId);

            return {
                id: photoId,
                data: base64Data,
                pending: true,
                uploaded: false
            };
        } catch (e) {
            logCritical('üì∑ savePendingPhoto error:', e?.message || e);
            return {
                data: base64Data,
                pending: true,
                uploaded: false
            };
        }
    }

    async function updatePhotoUrlInDay(clientId, date, photoId, newUrl) {
        const utils = HEYS?.utils;
        if (!utils?.lsGet || !utils?.lsSet) return;

        const dayKey = 'heys_dayv2_' + date;
        const day = utils.lsGet(dayKey, null);
        if (!day?.meals) return;

        let updated = false;
        day.meals = day.meals.map((meal) => {
            if (!meal.photos) return meal;
            meal.photos = meal.photos.map((photo) => {
                if (photo.id === photoId || photo.pending) {
                    updated = true;
                    return {
                        ...photo,
                        url: newUrl,
                        data: undefined,
                        pending: false,
                        uploaded: true
                    };
                }
                return photo;
            });
            return meal;
        });

        if (updated) {
            utils.lsSet(dayKey, day);
            log('üì∑ Updated photo URL in day:', date, photoId);
        }
    }

    Photos.uploadPhoto = async function (base64Data, clientId, date, mealId) {
        if (!clientId) {
            log('üì∑ uploadPhoto: –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ pending');
            return savePendingPhoto(base64Data, clientId, date, mealId);
        }

        if (!navigator.onLine) {
            log('üì∑ uploadPhoto: offline, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ pending');
            return savePendingPhoto(base64Data, clientId, date, mealId);
        }

        try {
            const blob = await base64ToBlob(base64Data);
            const result = await uploadViaYandex({ base64Data, clientId, date, mealId, blob });

            if (result?.error) {
                logCritical('üì∑ uploadPhoto error:', result.error);
                return savePendingPhoto(base64Data, clientId, date, mealId);
            }

            log('üì∑ Photo uploaded:', result?.path || '(no path)');
            return {
                url: result?.url || null,
                path: result?.path || null,
                uploaded: true
            };
        } catch (e) {
            logCritical('üì∑ uploadPhoto exception:', e?.message || e);
            return savePendingPhoto(base64Data, clientId, date, mealId);
        }
    };

    Photos.uploadPendingPhotos = async function () {
        if (!navigator.onLine) return;

        try {
            const pending = JSON.parse(global.localStorage.getItem(PENDING_PHOTOS_KEY) || '[]');
            if (pending.length === 0) return;

            log('üì∑ Uploading', pending.length, 'pending photos...');

            const stillPending = [];

            for (const photo of pending) {
                try {
                    const result = await Photos.uploadPhoto(
                        photo.data,
                        photo.clientId,
                        photo.date,
                        photo.mealId
                    );

                    if (result?.uploaded) {
                        await updatePhotoUrlInDay(photo.clientId, photo.date, photo.id, result.url);
                        log('üì∑ Pending photo uploaded:', photo.id);
                    } else {
                        stillPending.push(photo);
                    }
                } catch (_) {
                    stillPending.push(photo);
                }
            }

            global.localStorage.setItem(PENDING_PHOTOS_KEY, JSON.stringify(stillPending));

            if (stillPending.length < pending.length) {
                log('üì∑ Uploaded', pending.length - stillPending.length, 'photos,', stillPending.length, 'still pending');
            }
        } catch (e) {
            logCritical('üì∑ uploadPendingPhotos error:', e?.message || e);
        }
    };

    Photos.deletePhoto = async function (path) {
        if (!path) {
            log('üì∑ deletePhoto: –Ω–µ—Ç –ø—É—Ç–∏');
            return false;
        }

        if (!navigator.onLine) {
            log('üì∑ deletePhoto: offline');
            return false;
        }

        try {
            const result = await deleteViaYandex(path);
            if (result?.error) {
                logCritical('üì∑ deletePhoto error:', result.error);
                return false;
            }

            log('üì∑ Photo deleted from storage:', path);
            return true;
        } catch (e) {
            logCritical('üì∑ deletePhoto exception:', e?.message || e);
            return false;
        }
    };

    Photos.getPendingPhotos = function () {
        try {
            return JSON.parse(global.localStorage.getItem(PENDING_PHOTOS_KEY) || '[]');
        } catch (_) {
            return [];
        }
    };

    Photos.attachToCloud = function (cloud) {
        if (!cloud) return;
        _cloud = cloud;
        cloud.uploadPhoto = Photos.uploadPhoto;
        cloud.uploadPendingPhotos = Photos.uploadPendingPhotos;
        cloud.deletePhoto = Photos.deletePhoto;
        cloud.getPendingPhotos = Photos.getPendingPhotos;
    };

    if (HEYS.cloud) {
        Photos.attachToCloud(HEYS.cloud);
    }

    if (typeof global.addEventListener === 'function') {
        global.addEventListener('online', () => {
            log('üåê Online detected, uploading pending photos...');
            setTimeout(() => Photos.uploadPendingPhotos(), 2000);
        });
    }
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_storage_supabase_v1.js ===== */
// heys_storage_supabase_v1.js ‚Äî Supabase bridge, auth, cloud sync, localStorage mirroring
// v59: Fix cache invalidation on cloud sync ‚Äî UI now shows synced data when changing dates
// v60: FIX dayv2 overwrite ‚Äî –ë–õ–û–ö–ò–†–û–í–ö–ê –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ cloud –≤ localStorage (timestamp check)
// v61: FIX offline‚Üíonline race ‚Äî flush before download + dayv2 backup + meals count guard
// v62: [HEYS.sinhron] dayv2 sync diagnostics
// v63: Fix backup keys in diagnostics, auto-cleanup old backups
// v64: Fix null dayv2 values from cloud, cleanup "null" in LS, debounce double heysSyncCompleted

; (function (global) {
  (global.console || console).info('[HEYS.sinhron] üöÄ Storage v64 –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç null dayv2 –∞–∫—Ç–∏–≤–Ω–∞');
  const HEYS = global.HEYS = global.HEYS || {};

  // üÜï Heartbeat –¥–ª—è watchdog ‚Äî storage –∑–∞–≥—Ä—É–∂–µ–Ω
  if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();

  const cloud = HEYS.cloud = HEYS.cloud || {};
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };
  const devWarn = typeof DEV.warn === 'function' ? DEV.warn.bind(DEV) : function () { };
  const devInfo = typeof DEV.info === 'function' ? DEV.info.bind(DEV) : function () { };
  const devDebug = typeof DEV.debug === 'function' ? DEV.debug.bind(DEV) : function () { };
  const trackError = (error, context) => {
    if (!HEYS?.analytics?.trackError) return;
    try {
      const err = error instanceof Error ? error : new Error(String(error || 'HEYS.cloud error'));
      HEYS.analytics.trackError(err, context);
    } catch (_) { }
  };
  const quietConsole = {
    log: (...args) => devLog(...args),
    info: (...args) => devInfo(...args),
    debug: (...args) => devDebug(...args),
    warn: (...args) => devWarn(...args),
    error: (...args) => {
      devWarn(...args);
      trackError(args[0], { scope: 'HEYS.cloud', details: args.slice(1) });
    },
    trace: (...args) => { if (window.console && typeof window.console.trace === 'function') window.console.trace(...args); }
  };
  const console = quietConsole;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß –ö–û–ù–°–¢–ê–ù–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /** –ü—Ä–µ—Ñ–∏–∫—Å—ã –∫–ª—é—á–µ–π –¥–ª—è –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ cloud */
  const KEY_PREFIXES = {
    HEYS: 'heys_',
    DAY: 'day'
  };

  /** –ö–ª—é—á–∏, —Ç—Ä–µ–±—É—é—â–∏–µ client-specific storage */
  const CLIENT_SPECIFIC_KEYS = [
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
    'heys_products',
    'heys_profile',
    'heys_hr_zones',
    'heys_norms',
    'heys_ratio_zones',       // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤—ã—Ö –∑–æ–Ω ratio
    'heys_grams_history',     // –ò—Å—Ç–æ—Ä–∏—è –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –≥—Ä–∞–º–º–æ–≤ (–¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞)

    // –°–æ–≤–µ—Ç—ã (advice)
    'heys_advice_settings',   // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∞–≤—Ç–æ–ø–æ–∫–∞–∑, –∑–≤—É–∫)
    'heys_advice_read_today',
    'heys_advice_hidden_today',
    'heys_first_meal_tip',
    'heys_best_day_last_check',
    'heys_evening_snacker_check',
    'heys_morning_skipper_check',
    'heys_last_visit',

    // Onboarding & Tours (FIX: Added missing keys)
    'heys_tour_completed',
    'heys_insights_tour_completed',
    'heys_tour_interrupted_step',
    'heys_onboarding_complete',

    // Gamification
    'heys_game',              // XP, —É—Ä–æ–≤–Ω–∏, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    'heys_best_streak',       // –õ—É—á—à–∏–π streak
    'heys_weekly_wrap_view_count' // –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏—Ç–æ–≥–æ–≤ –Ω–µ–¥–µ–ª–∏
  ];

  /** –ü—Ä–µ—Ñ–∏–∫—Å—ã –∫–ª—é—á–µ–π, —Ç—Ä–µ–±—É—é—â–∏—Ö client-specific storage */
  const CLIENT_SPECIFIC_PREFIXES = [
    'heys_milestone_'         // –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ –≤–µ—Ö–∏ (heys_milestone_7_days, etc.)
  ];

  /** –ü—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è client-specific –¥–∞–Ω–Ω—ã—Ö */
  const CLIENT_KEY_PATTERNS = {
    DAY_V2: 'dayv2_',
    HEYS_CLIENT: 'heys_',
    DAY_CLIENT: 'day_'
  };

  /** –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
  const CONNECTION_STATUS = {
    OFFLINE: 'offline',
    SIGNIN: 'signin',
    SYNC: 'sync',
    ONLINE: 'online'
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß –£–¢–ò–õ–ò–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∫–ª—é—á –¥–ª—è Supabase: —É–±–∏—Ä–∞–µ—Ç embedded client_id
   * heys_{clientId}_dayv2_2025-12-11 ‚Üí heys_dayv2_2025-12-11
   * @param {string} key - –∏—Å—Ö–æ–¥–Ω—ã–π –∫–ª—é—á
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @returns {string} –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
   */
  function normalizeKeyForSupabase(key, clientId) {
    if (!clientId || !key.includes(clientId)) return key;

    // –£–±–∏—Ä–∞–µ–º client_id –∏–∑ –∫–ª—é—á–∞: heys_{clientId}_X ‚Üí heys_X
    let normalized = key.replace(`heys_${clientId}_`, 'heys_');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥–≤–æ–π–Ω–æ–π client_id (–±–∞–≥): heys_{id}_{id}_X ‚Üí heys_X
    if (normalized.includes(clientId)) {
      normalized = normalized.replace(`${clientId}_`, '');
      logCritical(`üêõ [NORMALIZE] Fixed double client_id in key: ${key} ‚Üí ${normalized}`);
    }

    return normalized;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üåê –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let client = null;
  cloud.client = null;
  let status = CONNECTION_STATUS.OFFLINE;
  let user = null;
  let muteMirror = false;
  let _syncPauseUntil = 0;
  let _syncPauseToken = 0;
  let _syncPauseReason = '';

  cloud.pauseSync = function (durationMs = 10 * 60 * 1000, reason = '') {
    const now = Date.now();
    const until = now + Math.max(0, durationMs || 0);
    if (until > _syncPauseUntil) {
      _syncPauseUntil = until;
      _syncPauseReason = reason || _syncPauseReason || '';
    }
    _syncPauseToken += 1;
    return { token: _syncPauseToken, until: _syncPauseUntil, reason: _syncPauseReason };
  };

  cloud.resumeSync = function (token) {
    if (token && token.token && token.token !== _syncPauseToken) return false;
    _syncPauseUntil = 0;
    _syncPauseReason = '';
    return true;
  };

  cloud.isSyncPaused = function () {
    return Date.now() < _syncPauseUntil;
  };

  cloud.getSyncPauseUntil = function () {
    return _syncPauseUntil;
  };

  cloud.getSyncPauseReason = function () {
    return _syncPauseReason;
  };

  // üîê PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: client_id –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ verify_client_pin (–±–µ–∑ Supabase user)
  let _pinAuthClientId = null;
  let _rpcOnlyMode = false; // –†–µ–∂–∏–º RPC –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π (–±–µ–∑ Supabase user)

  cloud.setPinAuthClient = function (clientId) {
    _pinAuthClientId = clientId;
    _rpcOnlyMode = true;
    log('üîê PIN auth client set + RPC mode ON:', clientId?.substring(0, 8) + '...');
  };
  cloud.getPinAuthClient = function () { return _pinAuthClientId; };
  cloud.clearPinAuthClient = function () {
    _pinAuthClientId = null;
    _rpcOnlyMode = false;
  };

  // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  Object.defineProperty(cloud, '_rpcOnlyMode', { get: () => _rpcOnlyMode });
  Object.defineProperty(cloud, '_pinAuthClientId', { get: () => _pinAuthClientId });

  // üîÑ –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition –º–µ–∂–¥—É –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏ —è–≤–Ω—ã–º signIn
  let _signInInProgress = false;
  // v62: replaces dead _rpcSyncInProgress ‚Äî set SYNCHRONOUSLY before fire-and-forget cloud.syncClient()
  // in PIN auth restore so controllerchange can detect this window and defer PWA reload.
  let _authSyncPending = false;
  let originalSetItem = null;

  // üö® –§–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ sync
  let initialSyncCompleted = false;
  let failsafeTimerId = null;
  let _syncEverStarted = false; // üîÑ v5: true –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞ bootstrapClientSync
  cloud.isInitialSyncCompleted = function () { return initialSyncCompleted; };

  // üîß Debug getters (–¥–ª—è –∫–æ–Ω—Å–æ–ª–∏) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
  if (!Object.getOwnPropertyDescriptor(cloud, '_rpcOnlyMode')) {
    Object.defineProperty(cloud, '_initialSyncCompleted', { get: () => initialSyncCompleted });
    Object.defineProperty(cloud, '_authSyncPending', { get: () => _authSyncPending });
    Object.defineProperty(cloud, '_rpcOnlyMode', { get: () => _rpcOnlyMode });
    Object.defineProperty(cloud, '_pinAuthClientId', { get: () => _pinAuthClientId });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîÑ AUTO TOKEN REFRESH ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç—ë–∫—à–µ–≥–æ —Ç–æ–∫–µ–Ω–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –µ—Å–ª–∏ –∏—Å—Ç—ë–∫.
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ sync –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏.
   * 
   * @returns {Promise<{valid: boolean, refreshed: boolean, error?: string}>}
   */
  let _refreshInProgress = null; // Deduplication
  const TOKEN_REFRESH_BUFFER_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è ‚Äî —É–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º

  cloud.ensureValidToken = async function () {
    // PIN auth –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –∫—É—Ä–∞—Ç–æ—Ä–∞
    if (_rpcOnlyMode) {
      return { valid: true, refreshed: false };
    }

    // Deduplication: –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Äî –∂–¥—ë–º –µ—ë
    if (_refreshInProgress) {
      log('üîÑ [TOKEN] Verification already in progress, waiting...');
      return _refreshInProgress;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω
    const AUTH_KEY = 'heys_supabase_auth_token';
    let storedToken;
    try {
      const stored = global.localStorage?.getItem(AUTH_KEY);
      storedToken = stored ? JSON.parse(stored) : null;
    } catch (_) {
      storedToken = null;
    }

    if (!storedToken || !storedToken.access_token) {
      // –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –Ω—É–∂–µ–Ω –≤—Ö–æ–¥
      // üö® –ö–†–ò–¢–ò–ß–ù–û: –°–±—Ä–∞—Å—ã–≤–∞–µ–º user —á—Ç–æ–±—ã UI –º–æ–≥ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å
      user = null;
      status = CONNECTION_STATUS.OFFLINE;
      logCritical('üîê [TOKEN] –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥');
      return { valid: false, refreshed: false, error: 'no_token' };
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º expires_at
    const now = Date.now();
    const expiresAtMs = (storedToken.expires_at || 0) * 1000;
    const timeUntilExpiry = expiresAtMs - now;

    // ‚úÖ FIX 2025-12-25: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—â—ë —Å–≤–µ–∂–∏–π (>5 –º–∏–Ω) ‚Äî —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º valid!
    // –†–∞–Ω—å—à–µ –∑–¥–µ—Å—å –±—ã–ª –±–∞–≥: –ø—Ä–∏ client=null (Supabase SDK —É–¥–∞–ª—ë–Ω) –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è error
    if (timeUntilExpiry > TOKEN_REFRESH_BUFFER_MS) {
      logCritical('‚úÖ [TOKEN] –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑', Math.round(timeUntilExpiry / 60000), '–º–∏–Ω');
      return { valid: true, refreshed: false };
    }

    // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ –∏–ª–∏ —É–∂–µ –∏—Å—Ç—ë–∫ ‚Äî –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const isExpired = timeUntilExpiry <= 0;
    const minutesUntilExpiry = Math.round(timeUntilExpiry / 60000);
    logCritical(`üîÑ [TOKEN] ${isExpired ? '–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫' : `–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${minutesUntilExpiry} –º–∏–Ω`}, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...`);

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å deduplication
    _refreshInProgress = (async () => {
      try {
        // ‚úÖ FIX 2025-12-25: –ò—Å–ø–æ–ª—å–∑—É–µ–º Yandex API –≤–º–µ—Å—Ç–æ Supabase SDK
        // Supabase SDK –±—ã–ª —É–¥–∞–ª—ë–Ω, –ø–æ—ç—Ç–æ–º—É client = null –≤—Å–µ–≥–¥–∞
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ YandexAPI.verifyCuratorToken()

        if (!global.YandexAPI || !global.YandexAPI.verifyCuratorToken) {
          // YandexAPI –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –¥–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å–∏–ª—å–Ω–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
          if (timeUntilExpiry > -60 * 60 * 1000) { // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω –º–µ–Ω–µ–µ —á–µ–º –Ω–∞ —á–∞—Å
            logCritical('‚ö†Ô∏è [TOKEN] YandexAPI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –¥–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É');
            return { valid: true, refreshed: false };
          }
          logCritical('‚ö†Ô∏è [TOKEN] YandexAPI not loaded and token expired');
          return { valid: false, refreshed: false, error: 'api_not_loaded' };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const { data, error } = await global.YandexAPI.verifyCuratorToken(storedToken.access_token);

        if (error || !data?.valid) {
          logCritical('üîê [TOKEN] –°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª —Ç–æ–∫–µ–Ω:', error?.message || 'invalid');
          // –ù–ï –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –ø—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∏—Ç
          // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π logout –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é
          if (isExpired) {
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω —Ä–µ–∞–ª—å–Ω–æ –∏—Å—Ç—ë–∫ ‚Äî —Ç—Ä–µ–±—É–µ–º –ø–µ—Ä–µ–ª–æ–≥–∏–Ω
            user = null;
            status = CONNECTION_STATUS.OFFLINE;
            return { valid: false, refreshed: false, error: 'token_expired', authRequired: true };
          }
          // –ï—Å–ª–∏ –Ω–µ –∏—Å—Ç—ë–∫ ‚Äî –¥–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ç—å –≥–ª—é—á–∏—Ç
          logCritical('‚ö†Ô∏è [TOKEN] –°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª, –Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ –∏—Å—Ç—ë–∫ ‚Äî –¥–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É');
          return { valid: true, refreshed: false };
        }

        // –°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Ç–æ–∫–µ–Ω ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º expires_at –ª–æ–∫–∞–ª—å–Ω–æ
        // JWT —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∂–∏–≤—ë—Ç 24—á, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –Ω–∞ 1—á –ª–æ–∫–∞–ª—å–Ω–æ
        const freshExpiresAt = Math.floor(Date.now() / 1000) + 3600;
        const tokenData = {
          ...storedToken,
          expires_at: freshExpiresAt,
          user: data.user || storedToken.user
        };

        try {
          const setFn = originalSetItem || global.localStorage.setItem.bind(global.localStorage);
          setFn(AUTH_KEY, JSON.stringify(tokenData));
          logCritical('‚úÖ [TOKEN] –¢–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, –ø—Ä–æ–¥–ª–∏–ª–∏ expires_at –¥–æ', new Date(freshExpiresAt * 1000).toISOString());
        } catch (e) {
          logCritical('‚ö†Ô∏è [TOKEN] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e?.message);
        }

        if (data.user) {
          user = data.user;
        }
        status = CONNECTION_STATUS.ONLINE;
        return { valid: true, refreshed: true };

      } catch (e) {
        logCritical('‚ö†Ô∏è [TOKEN] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', e?.message);
        // –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏ ‚Äî –¥–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å–∏–ª—å–Ω–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
        if (timeUntilExpiry > -60 * 60 * 1000) {
          logCritical('‚ö†Ô∏è [TOKEN] –û—à–∏–±–∫–∞ —Å–µ—Ç–∏, –¥–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É');
          return { valid: true, refreshed: false };
        }
        return { valid: false, refreshed: false, error: e?.message };
      } finally {
        _refreshInProgress = null;
      }
    })();

    return _refreshInProgress;
  };

  /**
   * üîê –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π sync ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (RPC –¥–ª—è PIN auth, bootstrap –¥–ª—è –æ–±—ã—á–Ω–æ–π)
   * In-flight deduplication: –µ—Å–ª–∏ sync —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ—Ç –∂–µ Promise
   * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –æ–Ω –∏—Å—Ç—ë–∫.
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {Object} options - { force: boolean }
   * @returns {Promise<{ success?: boolean, authRequired?: boolean, error?: string }>}
   */
  let _syncInFlight = null; // { clientId, promise }
  let _syncLastCompleted = {}; // üöÄ PERF: { clientId: timestamp } ‚Äî cooldown after sync

  cloud.syncClient = async function (clientId, options = {}) {
    // Deduplication: –µ—Å–ª–∏ sync –¥–ª—è —ç—Ç–æ–≥–æ –∂–µ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –∏–¥—ë—Ç ‚Äî –≤–µ—Ä–Ω—ë–º —Ç–æ—Ç –∂–µ Promise
    if (_syncInFlight && _syncInFlight.clientId === clientId && !options.force) {
      log('üîÑ [SYNC] Already in flight for', clientId.slice(0, 8) + '..., reusing promise');
      return _syncInFlight.promise;
    }

    // üöÄ PERF: Cooldown ‚Äî skip sync if completed < 5s ago (unless force)
    if (!options.force && _syncLastCompleted[clientId]) {
      const elapsed = Date.now() - _syncLastCompleted[clientId];
      if (elapsed < 5000) {
        console.info('[HEYS.sync] ‚è≥ syncClient cooldown: ' + Math.round(elapsed) + 'ms since last sync, skipping');
        return { success: true, cached: true };
      }
    }

    logCritical('[syncClient] START clientId:', clientId?.slice(0, 8), 'user:', !!user, 'isPinAuth:', _rpcOnlyMode && _pinAuthClientId === clientId);

    const isPinAuth = _rpcOnlyMode && _pinAuthClientId === clientId;

    // ÔøΩ PERF v7.0: Set _syncInFlight IMMEDIATELY (before async ensureValidToken)
    // to prevent race condition: DayTabWithCloudSync and syncEffects can call syncClient
    // before ensureValidToken resolves, slipping past the dedup check.
    const syncPromise = (async () => {
      try {
        // üîÑ AUTO REFRESH: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ sync (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞)
        if (!isPinAuth && typeof cloud.ensureValidToken === 'function') {
          const tokenResult = await cloud.ensureValidToken();
          if (!tokenResult.valid) {
            logCritical('üîê [SYNC] –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω:', tokenResult.error);
            return {
              success: false,
              authRequired: true,
              error: tokenResult.error
            };
          }
          if (tokenResult.refreshed) {
            logCritical('üîÑ [SYNC] –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π');
          }
        }

        let result;
        // v60 FIX: PIN clients now use bootstrapClientSync (paginated REST)
        // instead of syncClientViaRPC (monolithic RPC that 502s on 530+ keys).
        // bootstrapClientSync uses heys-api-rest CF with PAGE_SIZE=400 pagination,
        // Phase A fast-load (5 critical keys ‚Üí UI unblocked), and delta sync.
        if (typeof cloud.bootstrapClientSync === 'function') {
          result = await cloud.bootstrapClientSync(clientId, options);
        } else if (isPinAuth && typeof cloud.syncClientViaRPC === 'function') {
          // Legacy fallback: syncClientViaRPC only if bootstrapClientSync unavailable
          result = await cloud.syncClientViaRPC(clientId);
        }

        // v61: Guard against undefined result (no sync method available yet at cold boot)
        if (!result) {
          result = { success: false, error: 'No sync method available at boot time' };
        }

        // ‚ö° v5.2.0: Invalidate pattern cache after successful sync
        if (result?.success && HEYS.InsightsPI?.cache?.invalidateCache) {
          HEYS.InsightsPI.cache.invalidateCache('all');
          logCritical('üîÑ [SYNC] Pattern cache invalidated after successful sync');
        }

        return result;
      } finally {
        // –û—á–∏—â–∞–µ–º in-flight –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        if (_syncInFlight && _syncInFlight.clientId === clientId) {
          _syncInFlight = null;
        }
        // üöÄ PERF: Record completion time for cooldown
        _syncLastCompleted[clientId] = Date.now();
      }
    })();

    _syncInFlight = { clientId, promise: syncPromise };
    return syncPromise;
  };

  // v61: Expose sync-in-flight state for PWA reload deferral (heys_platform_apis_v1.js checks this)
  cloud.isSyncing = () => (_syncInFlight ? _syncInFlight.promise : null);
  // v62: Expose pre-sync auth pending flag ‚Äî set BEFORE _syncInFlight is created (PIN auth race window)
  cloud.isAuthSyncPending = () => _authSyncPending;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîê AUTH TOKEN SANITIZE (RTR-safe)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º —ç—Ç–æ –°–†–ê–ó–£ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞, –¥–æ heys_app_v12.js.
  // –ò–Ω–∞—á–µ app –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ç—É—Ö—à–∏–π —Ç–æ–∫–µ–Ω –∏/–∏–ª–∏ Supabase SDK –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è
  // refresh'–Ω—É—Ç—å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π refresh_token (RTR) ‚Üí 400 refresh_token_already_used.
  const OLD_AUTH_KEY__BOOT = 'sb-ukqolcziqcuplqfgrmsh-auth-token';
  const NEW_AUTH_KEY__BOOT = 'heys_supabase_auth_token';

  function sanitizeStoredAuthToken__BOOT() {
    try {
      const stored = global.localStorage && global.localStorage.getItem
        ? global.localStorage.getItem(NEW_AUTH_KEY__BOOT)
        : null;
      if (!stored) return;

      const parsed = JSON.parse(stored);
      const accessToken = parsed?.access_token;
      const storedUser = parsed?.user;

      // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –±–∏—Ç—ã–π/–Ω–µ–ø–æ–ª–Ω—ã–π ‚Äî —É–¥–∞–ª—è–µ–º
      // ‚ö†Ô∏è –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º expires_at ‚Äî –≤ –Ω–∞—à–µ–º Supabase –ø—Ä–æ–µ–∫—Ç–µ —Ç–æ–∫–µ–Ω—ã INFINITE (–æ—Ç–∫–ª—é—á–µ–Ω—ã)
      // Supabase SDK –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç expires_at = now + 1 hour –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é,
      // –Ω–æ —ç—Ç–æ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ç–æ–∫–µ–Ω —Ä–µ–∞–ª—å–Ω–æ –∏—Å—Ç–µ—á—ë—Ç!
      if (!accessToken || !storedUser) {
        try {
          global.localStorage.removeItem(NEW_AUTH_KEY__BOOT);
          global.localStorage.removeItem(OLD_AUTH_KEY__BOOT);
        } catch (_) { }
        return;
      }

      // –¢–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–º ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º
      // (—Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ Supabase)
    } catch (e) {
      // –ù–µ –ø–∞—Ä—Å–∏—Ç—Å—è ‚Üí —É–¥–∞–ª—è–µ–º
      try {
        global.localStorage.removeItem(NEW_AUTH_KEY__BOOT);
        global.localStorage.removeItem(OLD_AUTH_KEY__BOOT);
      } catch (_) { }
    }
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–Ω–Ω—é—é —Å–∞–Ω–∞—Ü–∏—é (sync)
  sanitizeStoredAuthToken__BOOT();

  // üîÑ FAILSAFE: –ï—Å–ª–∏ sync –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∑–∞ N —Å–µ–∫—É–Ω–¥ ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  // –ù–∞ localhost: 30 —Å–µ–∫ (throttled network may need more time)
  // –í production: 45 —Å–µ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –Ω–∞ –≤–≤–æ–¥ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è)
  const isLocalhostDev = typeof window !== 'undefined' &&
    (window.location?.hostname === 'localhost' || window.location?.hostname === '127.0.0.1');
  const FAILSAFE_TIMEOUT_MS = isLocalhostDev ? 30000 : 45000;

  function startFailsafeTimer() {
    if (failsafeTimerId) clearTimeout(failsafeTimerId);
    failsafeTimerId = setTimeout(() => {
      if (!initialSyncCompleted) {
        // üîÑ v5: –ù–µ —Å—Ç—Ä–µ–ª—è–µ–º –µ—Å–ª–∏ sync –µ—â—ë –Ω–µ –Ω–∞—á–∏–Ω–∞–ª—Å—è (—Å–∫—Ä–∏–ø—Ç—ã –≥—Ä—É–∑—è—Ç—Å—è –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏)
        if (!_syncEverStarted) {
          logCritical('‚è≥ [FAILSAFE] Timer fired but sync not started yet (scripts still loading) ‚Äî deferring');
          return;
        }
        logCritical(`‚ö†Ô∏è [FAILSAFE] Sync timeout (${FAILSAFE_TIMEOUT_MS / 1000}s) ‚Äî enabling offline mode`);
        initialSyncCompleted = true;
      }
    }, FAILSAFE_TIMEOUT_MS);
  }

  function cancelFailsafeTimer() {
    if (failsafeTimerId) {
      clearTimeout(failsafeTimerId);
      failsafeTimerId = null;
    }
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º failsafe –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–±—É–¥–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω –ø—Ä–∏ signIn)
  startFailsafeTimer();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üì¶ –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–ê–Ø –û–ß–ï–†–ï–î–¨ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîÄ MERGE –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–û–ù–§–õ–ò–ö–¢–û–í
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * Merge items (–ø—Ä–æ–¥—É–∫—Ç—ã) –≤–Ω—É—Ç—Ä–∏ meal –ø–æ ID
   * @param {Array} remoteItems - items –∏–∑ –æ–±–ª–∞–∫–∞
   * @param {Array} localItems - –ª–æ–∫–∞–ª—å–Ω—ã–µ items
   * @param {boolean} preferLocal - –µ—Å–ª–∏ true, –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–±–µ–∂–¥–∞–µ—Ç –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
   *                                –µ—Å–ª–∏ false, –±–µ—Ä—ë–º –¢–û–õ–¨–ö–û remote items (–¥–ª—è pull-to-refresh)
   * @returns {Array} –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ items
   */
  function mergeItemsById(remoteItems = [], localItems = [], preferLocal = true) {
    // üÜï –ü—Ä–∏ preferLocal=false (preferRemote): –±–µ—Ä—ë–º –¢–û–õ–¨–ö–û remote items
    // –≠—Ç–æ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã —É–¥–∞–ª–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å –ø—Ä–∏ pull-to-refresh
    if (!preferLocal) {
      return remoteItems.filter(item => item && item.id);
    }

    // preferLocal=true: –æ–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±–∞ —Å–ø–∏—Å–∫–∞, local –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç remote
    const itemsMap = new Map();

    // –î–æ–±–∞–≤–ª—è–µ–º remote items
    remoteItems.forEach(item => {
      if (item && item.id) {
        itemsMap.set(item.id, item);
      }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º/–∑–∞–º–µ–Ω—è–µ–º local items
    localItems.forEach(item => {
      if (item && item.id) {
        itemsMap.set(item.id, item);
      }
    });

    return Array.from(itemsMap.values());
  }

  /**
   * –£–º–Ω—ã–π merge –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ local vs remote
   * –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å meals –ø–æ ID, –≤–∑—è—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
   * @param {Object} local - –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @param {Object} remote - –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
   * @returns {Object|null} merged –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null –µ—Å–ª–∏ merge –Ω–µ –Ω—É–∂–µ–Ω
   */
  /**
   * Merge day data from two sources
   * @param {Object} local - –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @param {Object} remote - –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
   * @param {Object} options - –æ–ø—Ü–∏–∏
   * @param {boolean} options.forceKeepAll - –ø—Ä–∏ true –ù–ï —Å—á–∏—Ç–∞—Ç—å meals "—É–¥–∞–ª—ë–Ω–Ω—ã–º–∏", –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –í–°–ï
   * @param {boolean} options.preferRemote - –ø—Ä–∏ true, remote items/meals –ø–æ–±–µ–∂–¥–∞—é—Ç (–¥–ª—è pull-to-refresh)
   */
  function mergeDayData(local, remote, options = {}) {
    const forceKeepAll = options.forceKeepAll || false;
    const preferRemote = options.preferRemote || false; // üÜï –î–ª—è pull-to-refresh: remote –ø–æ–±–µ–∂–¥–∞–µ—Ç
    // –ü—Ä–∏–≤–æ–¥–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫ –Ω–æ–≤–æ–π —Å—Ö–µ–º–µ (quality/feelAfter ‚Üí mood/wellbeing/stress)
    const normalizeTrainings = (trainings = []) => trainings.map((t = {}) => {
      if (t.quality !== undefined || t.feelAfter !== undefined) {
        const { quality, feelAfter, ...rest } = t;
        return {
          ...rest,
          mood: rest.mood ?? quality ?? 5,
          wellbeing: rest.wellbeing ?? feelAfter ?? 5,
          stress: rest.stress ?? 5
        };
      }
      return t;
    });

    local = {
      ...local,
      trainings: normalizeTrainings(local?.trainings)
    };
    remote = {
      ...remote,
      trainings: normalizeTrainings(remote?.trainings)
    };

    if (!local || !remote) return null;

    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã ‚Äî merge –Ω–µ –Ω—É–∂–µ–Ω
    const localJson = JSON.stringify({ ...local, updatedAt: 0, _sourceId: '' });
    const remoteJson = JSON.stringify({ ...remote, updatedAt: 0, _sourceId: '' });
    if (localJson === remoteJson) return null;

    const merged = {
      ...remote, // –ë–∞–∑–∞ ‚Äî remote
      date: local.date || remote.date,
      updatedAt: Math.max(local.updatedAt || 0, remote.updatedAt || 0, Date.now()),
      _mergedAt: Date.now(),
    };

    // üìä –ß–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è: –¥–ª—è —à–∞–≥–æ–≤/–≤–æ–¥—ã –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º, –¥–ª—è householdMin ‚Äî —Å–≤–µ–∂–µ–µ
    // –õ–æ–≥–∏–∫–∞ —à–∞–≥–∏/–≤–æ–¥–∞: –µ—Å–ª–∏ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –≤–≤–µ–ª–∏ 5000 —à–∞–≥–æ–≤, –∞ –Ω–∞ –¥—Ä—É–≥–æ–º 8000 ‚Äî –∑–Ω–∞—á–∏—Ç 8000 –∞–∫—Ç—É–∞–ª—å–Ω–µ–µ
    // –õ–æ–≥–∏–∫–∞ householdMin: —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –±–µ—Ä—ë–º —Å–≤–µ–∂–µ–µ
    merged.steps = Math.max(local.steps || 0, remote.steps || 0);
    merged.waterMl = Math.max(local.waterMl || 0, remote.waterMl || 0);

    // householdMin ‚Äî –±–µ—Ä—ë–º —Å–≤–µ–∂–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ)
    // householdActivities ‚Äî –º–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
    if ((local.updatedAt || 0) >= (remote.updatedAt || 0)) {
      merged.householdMin = local.householdMin ?? remote.householdMin ?? 0;
      merged.householdTime = local.householdTime ?? remote.householdTime ?? '';
      merged.householdActivities = local.householdActivities || remote.householdActivities || undefined;
    } else {
      merged.householdMin = remote.householdMin ?? local.householdMin ?? 0;
      merged.householdTime = remote.householdTime ?? local.householdTime ?? '';
      merged.householdActivities = remote.householdActivities || local.householdActivities || undefined;
    }

    // üìä –í–µ—Å: –±–µ—Ä—ë–º –õ–Æ–ë–û–ï –Ω–µ–Ω—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —Å–≤–µ–∂–µ–º—É)
    // –í–ê–ñ–ù–û: –≤–µ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å 0 —É –Ω–æ–≤–æ–≥–æ –ø—É—Å—Ç–æ–≥–æ –¥–Ω—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–º—É
    if (local.weightMorning && remote.weightMorning) {
      // –û–±–∞ –µ—Å—Ç—å ‚Äî –±–µ—Ä—ë–º —Å–≤–µ–∂–µ–µ
      merged.weightMorning = (local.updatedAt || 0) >= (remote.updatedAt || 0)
        ? local.weightMorning
        : remote.weightMorning;
    } else {
      // –ë–µ—Ä—ë–º –ª—é–±–æ–µ –Ω–µ–Ω—É–ª–µ–≤–æ–µ
      merged.weightMorning = local.weightMorning || remote.weightMorning || 0;
    }

    // üò¥ –°–æ–Ω: –±–µ—Ä—ë–º –Ω–µ–ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–≤–µ–∂–µ–º—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã)
    merged.sleepStart = local.sleepStart || remote.sleepStart || '';
    merged.sleepEnd = local.sleepEnd || remote.sleepEnd || '';
    merged.sleepQuality = local.sleepQuality || remote.sleepQuality || '';
    merged.sleepNote = local.sleepNote || remote.sleepNote || '';

    // ‚≠ê –û—Ü–µ–Ω–∫–∞ –¥–Ω—è: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π
    if (local.dayScoreManual) {
      merged.dayScore = local.dayScore;
      merged.dayScoreManual = true;
    } else if (remote.dayScoreManual) {
      merged.dayScore = remote.dayScore;
      merged.dayScoreManual = true;
    } else {
      merged.dayScore = local.dayScore || remote.dayScore || '';
    }
    merged.dayComment = local.dayComment || remote.dayComment || '';

    // üå∏ Cycle: –Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å (null) –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –µ—Å–ª–∏ local —Å–≤–µ–∂–µ–µ
    // cycleDay: 1-7 = –¥–µ–Ω—å —Ü–∏–∫–ª–∞, null = —Å–±—Ä–æ—à–µ–Ω–æ, undefined = –Ω–µ –±—ã–ª–æ –¥–∞–Ω–Ω—ã—Ö
    if (local.cycleDay === null && (local.updatedAt || 0) >= (remote.updatedAt || 0)) {
      // –ù–∞–º–µ—Ä–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å ‚Äî local —Å–≤–µ–∂–µ–µ –∏ —è–≤–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª null
      merged.cycleDay = null;
    } else if (remote.cycleDay === null && (remote.updatedAt || 0) > (local.updatedAt || 0)) {
      // Remote —Å–≤–µ–∂–µ–µ –∏ —Å–±—Ä–æ—Å–∏–ª
      merged.cycleDay = null;
    } else {
      // –ë–µ—Ä—ë–º –Ω–µ–ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      merged.cycleDay = local.cycleDay || remote.cycleDay || null;
    }

    // üçΩÔ∏è Meals: merge –ø–æ ID —Å —É—á—ë—Ç–æ–º –£–î–ê–õ–ï–ù–ò–ô
    // –ï—Å–ª–∏ local —Å–≤–µ–∂–µ–µ –∏ meal –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ local ‚Äî –∑–Ω–∞—á–∏—Ç —É–¥–∞–ª—ë–Ω!
    // –ù–û: –ø—Ä–∏ forceKeepAll ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ–º –í–°–Å (–¥–ª—è pull-to-refresh –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ –±–∞–≥–æ–≤)
    const localMeals = local.meals || [];
    const remoteMeals = remote.meals || [];
    const mealsMap = new Map();
    const localMealIds = new Set(localMeals.filter(m => m?.id).map(m => m.id));
    const localIsNewer = (local.updatedAt || 0) >= (remote.updatedAt || 0);

    // –î–æ–±–∞–≤–ª—è–µ–º remote meals, –Ω–æ –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
    // 1. forceKeepAll = true (pull-to-refresh: –±–µ—Ä—ë–º –í–°–ï meals), –ò–õ–ò
    // 2. Local –ù–ï —Å–≤–µ–∂–µ–µ (remote –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ), –ò–õ–ò
    // 3. Meal –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ local (–Ω–µ –±—ã–ª —É–¥–∞–ª—ë–Ω)
    remoteMeals.forEach(meal => {
      if (!meal || !meal.id) return;

      if (!forceKeepAll && !preferRemote && localIsNewer && !localMealIds.has(meal.id)) {
        // Local —Å–≤–µ–∂–µ–µ –∏ —ç—Ç–æ–≥–æ meal –Ω–µ—Ç –≤ local = –£–î–ê–õ–Å–ù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        log(`üóëÔ∏è [MERGE] Meal ${meal.id} deleted locally, skipping from remote`);
        return;
      }

      mealsMap.set(meal.id, meal);
    });

    // –ü–æ—Ç–æ–º local meals ‚Äî –µ—Å–ª–∏ ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –±–µ—Ä—ë–º –õ–û–ö–ê–õ–¨–ù–£–Æ –≤–µ—Ä—Å–∏—é (–æ–Ω–∞ –±–æ–ª–µ–µ —Å–≤–µ–∂–∞—è)
    // –í–ê–ñ–ù–û: –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ item –∏–∑ –ø—Ä–∏—ë–º–∞ ‚Äî loc–∞l –∏–º–µ–µ—Ç –º–µ–Ω—å—à–µ items, –Ω–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
    // –ü—Ä–∏ –î–û–ë–ê–í–õ–ï–ù–ò–ò item ‚Äî –Ω—É–∂–µ–Ω merge items –ø–æ ID —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    // üÜï –ü—Ä–∏ preferRemote ‚Äî remote items –ø–æ–±–µ–∂–¥–∞—é—Ç (–¥–ª—è pull-to-refresh)
    localMeals.forEach(meal => {
      if (!meal || !meal.id) return;
      const existing = mealsMap.get(meal.id);
      if (!existing) {
        // üÜï –ü—Ä–∏ preferRemote: –µ—Å–ª–∏ meal –Ω–µ—Ç –≤ remote ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
        // –∫–æ—Ç–æ—Ä–æ–µ –µ—â—ë –Ω–µ —Å–∏–Ω–∫–Ω—É–ª–æ—Å—å. –û—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ.
        mealsMap.set(meal.id, meal);
      } else {
        // –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø–æ ID ‚Äî MERGE items –≤–Ω—É—Ç—Ä–∏ meal!
        // üÜï –ü—Ä–∏ preferRemote: remote items –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è)
        const preferLocal = preferRemote ? false : localIsNewer;

        if (preferRemote) {
          // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ –ø—Ä–∏ merge
          // logCritical(`üîÑ [MERGE] preferRemote: meal "${meal.name}" | local items: ${meal.items?.length || 0} | remote items: ${existing.items?.length || 0} ‚Üí using remote`);
        }

        const mergedItems = mergeItemsById(existing.items || [], meal.items || [], preferLocal);

        // –ë–µ—Ä—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –±–æ–ª–µ–µ —Å–≤–µ–∂–µ–π –≤–µ—Ä—Å–∏–∏
        // üÜï –ü—Ä–∏ preferRemote: –±–µ—Ä—ë–º remote –∫–∞–∫ –±–∞–∑—É
        const mergedMeal = preferRemote
          ? { ...meal, ...existing, items: mergedItems } // remote (existing) –ø–æ–ª—è –ø–æ–≤–µ—Ä—Ö local
          : localIsNewer
            ? { ...existing, ...meal, items: mergedItems }
            : { ...meal, ...existing, items: mergedItems };

        mealsMap.set(meal.id, mergedMeal);
      }
    });

    merged.meals = Array.from(mealsMap.values())
      .sort((a, b) => (a.time || '').localeCompare(b.time || ''));

    // üèãÔ∏è Trainings: merge –ø–æ –∏–Ω–¥–µ–∫—Å—É, –±–µ—Ä—ë–º —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é
    const localTrainings = local.trainings || [];
    const remoteTrainings = remote.trainings || [];
    merged.trainings = [];

    // Local —Å–≤–µ–∂–µ–µ ‚Äî –±–µ—Ä—ë–º local —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫–∞–∫ –±–∞–∑—É
    const localIsNewerForTrainings = (local.updatedAt || 0) >= (remote.updatedAt || 0);

    const maxTrainings = Math.max(localTrainings.length, remoteTrainings.length, 3);
    for (let i = 0; i < maxTrainings; i++) {
      const lt = localTrainings[i] || { z: [0, 0, 0, 0] };
      const rt = remoteTrainings[i] || { z: [0, 0, 0, 0] };

      // –ë–µ—Ä—ë–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏–∑ –±–æ–ª–µ–µ —Å–≤–µ–∂–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
      const ltSum = (lt.z || []).reduce((a, b) => a + (b || 0), 0);
      const rtSum = (rt.z || []).reduce((a, b) => a + (b || 0), 0);

      // –í—ã–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—É—é –≤–µ—Ä—Å–∏—é –ø–æ updatedAt
      // –í–ê–ñ–ù–û: –µ—Å–ª–∏ local —Å–≤–µ–∂–µ–µ –∏ –ø—É—Å—Ç–∞—è ‚Äî —ç—Ç–æ –ù–ê–ú–ï–†–ï–ù–ù–û–ï —É–¥–∞–ª–µ–Ω–∏–µ!
      let winner;
      if (localIsNewerForTrainings) {
        // Local —Å–≤–µ–∂–µ–µ ‚Äî –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º local (–¥–∞–∂–µ –µ—Å–ª–∏ –ø—É—Å—Ç–∞—è = —É–¥–∞–ª–µ–Ω–∞)
        winner = lt;
      } else if (ltSum === 0 && rtSum > 0) {
        // Local –Ω–µ —Å–≤–µ–∂–µ–µ –∏ –ø—É—Å—Ç–∞—è ‚Äî –±–µ—Ä—ë–º remote
        winner = rt;
      } else if (rtSum === 0 && ltSum > 0) {
        // Remote –ø—É—Å—Ç–∞—è, local –Ω–µ–ø—É—Å—Ç–∞—è ‚Äî –±–µ—Ä—ë–º local
        winner = lt;
      } else {
        // –û–±–µ –Ω–µ–ø—É—Å—Ç—ã–µ, remote —Å–≤–µ–∂–µ–µ ‚Äî –±–µ—Ä—ë–º remote
        winner = rt;
      }
      const loser = winner === lt ? rt : lt;

      // –í–°–ï–ì–î–ê –æ–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ (mood/wellbeing/stress) –∏–∑ –æ–±–µ–∏—Ö –≤–µ—Ä—Å–∏–π
      // –ë–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –ó–ê–î–ê–ù–û (–Ω–µ undefined), –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º winner
      const getMergedRating = (field) => {
        const wVal = winner[field];
        const lVal = loser[field];
        // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç winner –µ—Å–ª–∏ –æ–Ω–æ –∑–∞–¥–∞–Ω–æ (–≤–∫–ª—é—á–∞—è 0!)
        if (wVal !== undefined) return wVal;
        if (lVal !== undefined) return lVal;
        return undefined; // –ù–µ –∑–∞–¥–∞–Ω–æ –Ω–∏ —Ç–∞–º –Ω–∏ —Ç–∞–º
      };

      winner = {
        ...winner,
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ ‚Äî –±–µ—Ä—ë–º –∑–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –ª—é–±–æ–π –≤–µ—Ä—Å–∏–∏
        mood: getMergedRating('mood'),
        wellbeing: getMergedRating('wellbeing'),
        stress: getMergedRating('stress'),
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ
        quality: undefined,
        feelAfter: undefined
      };

      merged.trainings.push(winner);
    }

    log('üîÄ [MERGE] Result:', {
      meals: merged.meals.length,
      steps: merged.steps,
      water: merged.waterMl,
      trainings: merged.trainings.filter(t => t.z?.some(z => z > 0)).length
    });

    return merged;
  }

  /**
   * Merge products when local and remote conflict.
   *
   * Strategy overview:
   * 1) Deduplicate each side by normalized name (name is the ONLY identity key).
   * 2) For duplicates, keep the "better" product by data completeness score.
   * 3) Merge remote + local by name, preferring the better product version.
   *
   * Architecture note:
   * - Name is the canonical identity key (UI prevents duplicates by name).
   * - Product IDs are not used for identity during merge.
   *
  * @param {Array<Object>} localProducts - Products from local storage.
  * @param {Array<Object>} remoteProducts - Products from cloud storage.
  * @returns {Array<Object>} Merged products (deduped by name).
  * @see isBetterProduct
  * @see normalizeName
   */
  function mergeProductsData(localProducts, remoteProducts) {
    const local = Array.isArray(localProducts) ? localProducts : [];
    const remote = Array.isArray(remoteProducts) ? remoteProducts : [];

    /**
     * Normalize product name for identity key comparison.
     * @param {string} name
     * @returns {string}
     */
    const normalizeName = (name) => String(name || '').trim().toLowerCase();

    /**
     * Check if product has a valid identity name.
     * @param {Object} p
     * @returns {boolean}
     */
    const isValidProduct = (p) => {
      if (!p) return false;
      const name = normalizeName(p.name);
      return name.length > 0;
    };

    /**
     * üÜï v4.8.0: Check if product is in deleted products ignore list.
     * Prevents "zombie" products from resurrecting via cloud sync.
     * @param {Object} p
     * @returns {boolean}
     */
    // üîß v4.8.10: –ó–∞–≥—Ä—É–∂–∞–µ–º tombstones –∏–∑ –û–ë–ï–ò–• —Å–∏—Å—Ç–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è merge
    const _tombstonesForMerge = global.HEYS?.store?.get?.('heys_deleted_ids') || [];
    const _tombstoneIdSetForMerge = new Set(Array.isArray(_tombstonesForMerge) ? _tombstonesForMerge.map(t => t.id).filter(Boolean) : []);
    const _tombstoneNameSetForMerge = new Set(Array.isArray(_tombstonesForMerge) ? _tombstonesForMerge.map(t => (t.name || '').trim().toLowerCase()).filter(Boolean) : []);

    const isDeletedProduct = (p) => {
      if (!p) return false;
      // 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º heys_deleted_ids (Store-based tombstones ‚Äî –≤—ã–∂–∏–≤–∞—é—Ç –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ localStorage)
      if (p.id && _tombstoneIdSetForMerge.has(p.id)) return true;
      if (p.name && _tombstoneNameSetForMerge.has(String(p.name).trim().toLowerCase())) return true;
      // 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º HEYS.deletedProducts API (localStorage-based ignore list)
      if (global.HEYS?.deletedProducts?.isProductDeleted) {
        return global.HEYS.deletedProducts.isProductDeleted(p);
      }
      // Fallback: –ø—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      if (global.HEYS?.deletedProducts?.isDeleted) {
        return global.HEYS.deletedProducts.isDeleted(p.name) ||
          global.HEYS.deletedProducts.isDeleted(p.id) ||
          global.HEYS.deletedProducts.isDeleted(p.fingerprint);
      }
      return false;
    };

    /**
     * Calculate data completeness score for product conflict resolution.
     * @param {Object} p
     * @returns {number}
     */
    const getProductScore = (p) => {
      let score = 0;
      if (p.id) score += 1;
      if (p.name) score += 2; // –ò–º—è –≤–∞–∂–Ω–µ–µ
      if (p.kcal100 > 0) score += 1;
      if (p.protein100 > 0) score += 1;
      if (p.carbs100 > 0 || p.simple100 > 0 || p.complex100 > 0) score += 1;
      if (p.fat100 > 0 || p.badFat100 > 0 || p.goodFat100 > 0) score += 1;
      if (p.fiber100 > 0) score += 1;
      if (p.gi > 0) score += 1;
      if (p.portions && p.portions.length > 0) score += 2; // –ü–æ—Ä—Ü–∏–∏ –≤–∞–∂–Ω—ã
      if (p.createdAt) score += 1;
      // v4.8.2: –ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –¥–∞—é—Ç –±–æ–Ω—É—Å ‚Äî –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      if (p.iron > 0 || p.vitamin_c > 0 || p.calcium > 0) score += 2;
      if (p.magnesium > 0 || p.zinc > 0 || p.potassium > 0) score += 1;
      return score;
    };

    /**
     * Compare two products and decide which one is "better" for merge.
     * @param {Object} p1
     * @param {Object} p2
     * @returns {boolean}
     */
    const isBetterProduct = (p1, p2) => {
      const score1 = getProductScore(p1);
      const score2 = getProductScore(p2);

      // 1. –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ø–æ–ª–Ω–æ—Ç–µ –¥–∞–Ω–Ω—ã—Ö
      if (score1 !== score2) return score1 > score2;

      // 2. –ü—Ä–∏ —Ä–∞–≤–Ω–æ–º score ‚Äî –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –±–æ–ª–µ–µ –Ω–æ–≤—ã–π (–ø–æ createdAt)
      const time1 = p1.createdAt || 0;
      const time2 = p2.createdAt || 0;
      return time1 > time2;
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –≠–¢–ê–ü 0.5: üÜï –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (v4.8.0)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let deletedFiltered = 0;
    const filterDeleted = (arr, source) => {
      return arr.filter(p => {
        if (isDeletedProduct(p)) {
          deletedFiltered++;
          return false;
        }
        return true;
      });
    };

    const localFiltered = filterDeleted(local, 'local');
    const remoteFiltered = filterDeleted(remote, 'remote');

    if (deletedFiltered > 0) {
      logCritical(`üö´ [MERGE] Filtered out ${deletedFiltered} deleted product(s) from ignore list`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –≠–¢–ê–ü 1: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –í–ù–£–¢–†–ò –∫–∞–∂–¥–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ (–¥–µ—Ç–µ–∫—Ç–∏–º legacy –¥—É–±–ª–∏)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Deduplicate products by normalized name within one source.
     * @param {Array<Object>} arr
     * @param {string} source
     * @returns {Array<Object>}
     */
    const dedupeArray = (arr, source) => {
      const seen = new Map(); // normalizedName ‚Üí bestProduct
      const duplicates = [];

      arr.forEach(p => {
        if (!isValidProduct(p)) return;
        const key = normalizeName(p.name);
        const existing = seen.get(key);

        if (!existing) {
          seen.set(key, p);
        } else {
          // –î—É–±–ª—å –≤–Ω—É—Ç—Ä–∏ –º–∞—Å—Å–∏–≤–∞! –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π
          duplicates.push({ name: p.name, source });
          if (isBetterProduct(p, existing)) {
            seen.set(key, p);
          }
        }
      });

      if (duplicates.length > 0) {
        logCritical(`‚ö†Ô∏è [MERGE] Found ${duplicates.length} duplicate(s) in ${source}: ${duplicates.map(d => `"${d.name}"`).join(', ')}`);
      }

      return Array.from(seen.values());
    };

    const localDeduped = dedupeArray(localFiltered, 'local');
    const remoteDeduped = dedupeArray(remoteFiltered, 'remote');

    // –ï—Å–ª–∏ –æ–¥–Ω–∞ –∏–∑ —Å—Ç–æ—Ä–æ–Ω –ø—É—Å—Ç–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥—Ä—É–≥—É—é
    if (localDeduped.length === 0) return remoteDeduped;
    if (remoteDeduped.length === 0) return localDeduped;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –≠–¢–ê–ü 2: Merge local + remote (name = –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª—é—á)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const resultMap = new Map(); // normalizedName ‚Üí product

    // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ remote (–±–∞–∑–∞)
    remoteDeduped.forEach(p => {
      const key = normalizeName(p.name);
      resultMap.set(key, p);
    });

    // üÜï v4.8.3: Field-level merge –¥–ª—è –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
    // –ö–æ–≥–¥–∞ –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç –≤—ã–±—Ä–∞–Ω –∫–∞–∫ "–ª—É—á—à–∏–π", –∫–æ–ø–∏—Ä—É–µ–º missing –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∏–∑ –¥—Ä—É–≥–æ–≥–æ
    const MICRO_FIELDS = ['iron', 'vitamin_c', 'calcium', 'vitamin_d', 'vitamin_b12',
      'vitamin_a', 'vitamin_e', 'magnesium', 'zinc', 'potassium', 'sodium', 'folate'];
    const enrichMicronutrients = (winner, donor) => {
      for (const f of MICRO_FIELDS) {
        const wVal = Number(winner[f]) || 0;
        const dVal = Number(donor[f]) || 0;
        if (wVal === 0 && dVal > 0) {
          winner[f] = dVal;
        }
      }
    };

    // –ó–∞—Ç–µ–º –º–µ—Ä–∂–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ
    let addedFromLocal = 0;
    let updatedFromLocal = 0;

    localDeduped.forEach(p => {
      const key = normalizeName(p.name);
      const existing = resultMap.get(key);

      if (!existing) {
        // –ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç (–µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)
        resultMap.set(key, p);
        addedFromLocal++;
      } else if (isBetterProduct(p, existing)) {
        // –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ª—É—á—à–µ ‚Äî –∑–∞–º–µ–Ω—è–µ–º, –Ω–æ –∫–æ–ø–∏—Ä—É–µ–º –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∏–∑ remote
        const enriched = { ...p };
        enrichMicronutrients(enriched, existing);
        resultMap.set(key, enriched);
        updatedFromLocal++;
      } else {
        // Remote –ª—É—á—à–µ ‚Äî –∫–æ–ø–∏—Ä—É–µ–º –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∏–∑ local –µ—Å–ª–∏ remote –∏—Ö –Ω–µ –∏–º–µ–µ—Ç
        const enriched = { ...existing };
        enrichMicronutrients(enriched, p);
        resultMap.set(key, enriched);
      }
    });

    const merged = Array.from(resultMap.values());

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –≠–¢–ê–ü 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const localDupes = local.length - localDeduped.length;
    const remoteDupes = remote.length - remoteDeduped.length;
    const totalDupes = localDupes + remoteDupes;

    const stats = {
      local: local.length,
      localDeduped: localDeduped.length,
      remote: remote.length,
      remoteDeduped: remoteDeduped.length,
      merged: merged.length,
      addedFromLocal,
      updatedFromLocal,
      duplicatesRemoved: totalDupes
    };

    // –ö—Ä–∞—Ç–∫–∏–π –ª–æ–≥
    const delta = merged.length - remoteDeduped.length;
    logCritical(`üîÄ [MERGE PRODUCTS] local: ${stats.local}${localDupes ? ` (‚àí${localDupes} dupes)` : ''}, remote: ${stats.remote}${remoteDupes ? ` (‚àí${remoteDupes} dupes)` : ''} ‚Üí merged: ${merged.length} (${delta >= 0 ? '+' : ''}${delta})`);

    if (addedFromLocal > 0 || updatedFromLocal > 0) {
      log(`üì¶ [MERGE] Added ${addedFromLocal} new, updated ${updatedFromLocal} existing`);
    }

    // üÜï v4.8.4: Set updatedAt for all merged products to enable timestamp-based stale detection
    // After sync, localStorage will have fresh timestamps, while stale React state has old ones
    const now = Date.now();

    // v4.8.5: DEBUG - –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã BEFORE timestamp update
    const beforeIron = merged.filter(p => p.iron && +p.iron > 0).length;
    const beforeVitC = merged.filter(p => p.vitamin_c && +p.vitamin_c > 0).length;
    const beforeCa = merged.filter(p => p.calcium && +p.calcium > 0).length;

    merged.forEach(p => {
      // üÜï v4.8.6: Preserve individual createdAt for correct sort order in personal list.
      // Priority: existing camelCase createdAt ‚Üí DB created_at ‚Üí existing updatedAt ‚Üí now
      // This way each product keeps its unique creation timestamp, not a batch sync time.
      if (!p.createdAt) {
        const dbCreated = p.created_at;
        if (dbCreated) {
          // Parse PostgreSQL timestamptz ‚Üí millis
          const ts = typeof dbCreated === 'number'
            ? dbCreated
            : (() => {
              let parsed = Date.parse(dbCreated);
              if (!Number.isFinite(parsed)) {
                const norm = String(dbCreated).replace(' ', 'T').replace(/(\.\d{3})\d+/, '$1').replace(/\+00$/, 'Z').replace(/([+-]\d{2})(\d{2})$/, '$1:$2');
                parsed = Date.parse(norm);
              }
              return Number.isFinite(parsed) ? parsed : 0;
            })();
          if (ts > 0) p.createdAt = ts;
        }
        // fallback: keep whatever was in updatedAt before (individual per-product, if existed)
        // –Ω–æ –Ω–µ —Å—Ç–∞–≤–∏–º now ‚Äî –∏–Ω–∞—á–µ –≤—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—É—á–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π batch-timestamp
      }
      p.updatedAt = now;
    });

    logCritical(`üïê [MERGE TIMESTAMP] Set updatedAt=${now} (${new Date(now).toISOString()}) for all ${merged.length} products`);
    const withCreatedAt = merged.filter(p => p.createdAt).length;
    logCritical(`üìÖ [MERGE TIMESTAMP] Products with individual createdAt: ${withCreatedAt}/${merged.length} (used for sort order)`);
    logCritical(`   Micronutrients: Fe=${beforeIron}, VitC=${beforeVitC}, Ca=${beforeCa}`);

    return merged;
  }

  const PENDING_QUEUE_KEY = 'heys_pending_sync_queue';
  const PENDING_CLIENT_QUEUE_KEY = 'heys_pending_client_sync_queue';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üßπ QUOTA MANAGEMENT ‚Äî –ó–ê–©–ò–¢–ê –û–¢ –ü–ï–†–ï–ü–û–õ–ù–ï–ù–ò–Ø STORAGE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const MAX_STORAGE_MB = 4.5; // –õ–∏–º–∏—Ç ~5MB, –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å
  const OLD_DATA_DAYS = 90; // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π

  /** –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä localStorage –≤ MB */
  function getStorageSize() {
    try {
      let total = 0;
      for (let key in global.localStorage) {
        if (global.localStorage.hasOwnProperty(key)) {
          total += (global.localStorage.getItem(key) || '').length * 2; // UTF-16
        }
      }
      return total / 1024 / 1024;
    } catch (e) {
      return 0;
    }
  }

  /** –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∏–∑ –∫–ª—é—á–∞ dayv2_YYYY-MM-DD */
  function getDateFromDayKey(key) {
    const match = key.match(/dayv2_(\d{4}-\d{2}-\d{2})/);
    if (match) {
      return new Date(match[1]);
    }
    return null;
  }

  /** –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞ */
  function cleanupOldData(daysToKeep = OLD_DATA_DAYS) {
    try {
      const now = new Date();
      const cutoff = new Date(now.getTime() - daysToKeep * 24 * 60 * 60 * 1000);
      let cleaned = 0;

      // –°–æ–±–∏—Ä–∞–µ–º –∫–ª—é—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      const keysToRemove = [];
      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (key && key.includes('dayv2_')) {
          const date = getDateFromDayKey(key);
          if (date && date < cutoff) {
            keysToRemove.push(key);
          }
        }
      }

      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
      keysToRemove.forEach(key => {
        global.localStorage.removeItem(key);
        cleaned++;
      });

      if (cleaned > 0) {
        logCritical(`üßπ –û—á–∏—â–µ–Ω–æ ${cleaned} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (>${daysToKeep} –¥–Ω–µ–π)`);
      }

      return cleaned;
    } catch (e) {
      return 0;
    }
  }

  /** –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
  function aggressiveCleanup() {
    logCritical('üö® –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ storage...');

    // 1. –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
    cleanupOldData(14);

    // 2. –£–¥–∞–ª—è–µ–º debug/temp/cache –∫–ª—é—á–∏
    const tempKeys = [];
    for (let i = 0; i < global.localStorage.length; i++) {
      const key = global.localStorage.key(i);
      if (key && (key.includes('_debug') || key.includes('_temp') || key.includes('_cache') || key.includes('_log'))) {
        tempKeys.push(key);
      }
    }
    tempKeys.forEach(k => global.localStorage.removeItem(k));

    // 3. –û—á–∏—â–∞–µ–º pending queues –∏ —Ç—è–∂—ë–ª—ã–µ –∫—ç—à–∏ insights
    global.localStorage.removeItem(PENDING_QUEUE_KEY);
    global.localStorage.removeItem(PENDING_CLIENT_QUEUE_KEY);
    global.localStorage.removeItem(SYNC_LOG_KEY);
    // –û—á–∏—â–∞–µ–º –∫—ç—à–∏ insights (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ)
    const insightsKeys = [
      'heys_adaptive_thresholds', 'heys_thresholds_rolling_stats',
      'heys_ews_trends_v1', 'heys_ews_weekly_v1', 'heys_insights_cache'
    ];
    insightsKeys.forEach(k => global.localStorage.removeItem(k));

    // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
    let sizeMB = getStorageSize();
    logCritical(`üìä –†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: ${sizeMB.toFixed(2)} MB`);

    // 5. –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë > 4MB ‚Äî —É–¥–∞–ª—è–µ–º –µ—â—ë —Å—Ç–∞—Ä–µ–µ (7 –¥–Ω–µ–π) –∏ insights
    if (sizeMB > 4) {
      cleanupOldData(7);

      // –°–∞–º–∞—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ - —É–¥–∞–ª—è–µ–º –≤—Å—ë —á—Ç–æ –º–æ–∂–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
      const aggressiveKeys = [];
      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (key && (key.includes('heys_ews_') || key.includes('heys_insights_') || key.includes('heys_adaptive_'))) {
          aggressiveKeys.push(key);
        }
      }
      aggressiveKeys.forEach(k => global.localStorage.removeItem(k));

      sizeMB = getStorageSize();
      logCritical(`üìä –ü–æ—Å–ª–µ ultra-aggressive –æ—á–∏—Å—Ç–∫–∏: ${sizeMB.toFixed(2)} MB`);
    }
  }

  /** –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ localStorage —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π QuotaExceeded */
  function safeSetItem(key, value) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π setItem –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω (–∏–∑–±–µ–≥–∞–µ–º —Ä–µ–∫—É—Ä—Å–∏–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Ö–≤–∞—Ç)
    const setFn = originalSetItem || global.localStorage.setItem.bind(global.localStorage);

    try {
      setFn(key, value);
      return true;
    } catch (e) {
      if (e.name === 'QuotaExceededError' || e.code === 22) {
        // –ü—Ä–æ–±—É–µ–º –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        logCritical('‚ö†Ô∏è localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ...');
        cleanupOldData();

        // –ü—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑
        try {
          setFn(key, value);
          return true;
        } catch (e2) {
          // –í—Å—ë –µ—â—ë –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è ‚Äî —É–¥–∞–ª—è–µ–º pending queues –∏ sync log
          global.localStorage.removeItem(PENDING_QUEUE_KEY);
          global.localStorage.removeItem(PENDING_CLIENT_QUEUE_KEY);
          global.localStorage.removeItem(SYNC_LOG_KEY);

          try {
            setFn(key, value);
            return true;
          } catch (e3) {
            // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ ‚Äî —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–Ω–∏ –∑–∞ 30 –¥–Ω–µ–π –≤–º–µ—Å—Ç–æ 90
            aggressiveCleanup();
            try {
              setFn(key, value);
              return true;
            } catch (e4) {
              logCritical('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: storage –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω');
              return false;
            }
          }
        }
      }
      return false;
    }
  }

  /** –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∏–∑ localStorage */
  function loadPendingQueue(key) {
    try {
      const data = global.localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      return [];
    }
  }

  /** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –≤ localStorage */
  function savePendingQueue(key, queue) {
    try {
      if (queue.length > 0) {
        safeSetItem(key, JSON.stringify(queue));
      } else {
        global.localStorage.removeItem(key);
      }
    } catch (e) { }
  }

  /** –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è in-flight) */
  cloud.getPendingCount = function () {
    // üîÑ v=51: –í PIN-auth —Ä–µ–∂–∏–º–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º upsertQueue ‚Äî –æ–Ω–∞ –¥–ª—è curator mode
    const isClientOnlyMode = _rpcOnlyMode && _pinAuthClientId;
    const userQueueLen = isClientOnlyMode ? 0 : upsertQueue.length;
    return clientUpsertQueue.length + userQueueLen + (_uploadInProgress ? _uploadInFlightCount : 0);
  };

  /** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
  cloud.isUploadInProgress = function () {
    return _uploadInProgress;
  };

  /** –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é pending (–¥–ª—è UI) */
  cloud.getPendingDetails = function () {
    const details = { days: 0, products: 0, profile: 0, other: 0 };

    const allItems = [...clientUpsertQueue, ...upsertQueue];
    allItems.forEach(item => {
      const k = item.k || '';
      if (k.includes('dayv2_')) details.days++;
      else if (k.includes('products')) details.products++;
      else if (k.includes('profile')) details.profile++;
      else details.other++;
    });

    return details;
  };

  /**
   * üîÑ Flush pending queue ‚Äî –¥–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö pending –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–±–ª–∞–∫–æ
   * –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è PullRefresh: —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –ø–æ—Ç–æ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
   * 
   * v=34 FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º doImmediateClientUpload() –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
   * –≤–º–µ—Å—Ç–æ scheduleClientPush() –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–≤–∞–ª 500ms debounce!
   * 
   * @param {number} timeoutMs - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (default: 5000ms)
   * @returns {Promise<boolean>} - true –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞, false –µ—Å–ª–∏ timeout
   */
  cloud.flushPendingQueue = async function (timeoutMs = 5000) {
    // üîÑ v=51: –í PIN-auth —Ä–µ–∂–∏–º–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º upsertQueue ‚Äî –æ–Ω–∞ –¥–ª—è curator mode
    // upsertQueue —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Supabase user, –≤ PIN mode –Ω–µ—Ç user
    const isClientOnlyMode = _rpcOnlyMode && _pinAuthClientId;
    const clientQueueLen = clientUpsertQueue.length;
    const userQueueLen = isClientOnlyMode ? 0 : upsertQueue.length; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤ PIN mode
    const queueLen = clientQueueLen + userQueueLen;
    const inFlight = _uploadInProgress ? _uploadInFlightCount : 0;
    const total = queueLen + inFlight;
    const flushStartTs = Date.now();
    const logFlushSummary = (label, afterCount) => {
      logCritical(`üßæ [FLUSH] ${label} before=${total} after=${afterCount} ms=${Date.now() - flushStartTs}`);
    };

    // üîÑ v=34: –í–°–ï–ì–î–ê –ª–æ–≥–∏—Ä—É–µ–º flush ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è!
    logCritical(`üîÑ [FLUSH] Check: clientQueue=${clientQueueLen}, userQueue=${upsertQueue.length}${isClientOnlyMode ? ' (ignored in PIN mode)' : ''}, inFlight=${inFlight}`);

    // –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ –ò –Ω–∏—á–µ–≥–æ –Ω–µ –≤ –ø–æ–ª—ë—Ç–µ ‚Äî –≥–æ—Ç–æ–≤–æ
    if (queueLen === 0 && !_uploadInProgress) {
      logCritical('‚úÖ [FLUSH] Queue already empty and no uploads in progress');
      logFlushSummary('noop', 0);
      return true;
    }

    logCritical(`üîÑ [FLUSH] Need to upload ${total} pending items IMMEDIATELY...`);

    // üîÑ v=34 FIX: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π upload –≤–º–µ—Å—Ç–æ debounce!
    // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äî —Ä–∞–Ω—å—à–µ scheduleClientPush —Å–æ–∑–¥–∞–≤–∞–ª 500ms –∑–∞–¥–µ—Ä–∂–∫—É
    // –∏ sync —É—Å–ø–µ–≤–∞–ª —Å–∫–∞—á–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –î–û upload
    if (queueLen > 0) {
      logCritical('üîÑ [FLUSH] Starting IMMEDIATE upload (no debounce)...');
      try {
        await doImmediateClientUpload();
        logCritical('‚úÖ [FLUSH] Immediate upload completed');
      } catch (e) {
        err('‚ùå [FLUSH] Immediate upload failed:', e);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ immediate upload
    const stillClientQueue = clientUpsertQueue.length;
    const stillUserQueue = isClientOnlyMode ? 0 : upsertQueue.length;
    const stillInQueue = stillClientQueue + stillUserQueue;
    if (stillInQueue === 0 && !_uploadInProgress) {
      logCritical('‚úÖ [FLUSH] All uploaded after immediate push');
      logFlushSummary('done', 0);
      return true;
    }

    // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî –∂–¥—ë–º —Å–æ–±—ã—Ç–∏–µ queue-drained —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    logCritical(`üîÑ [FLUSH] ${stillInQueue} items still pending (client=${stillClientQueue}, user=${stillUserQueue}), waiting for queue-drained event...`);

    return new Promise((resolve) => {
      const startTime = Date.now();

      // –¢–∞–π–º–∞—É—Ç
      const timeoutId = setTimeout(() => {
        const stillPending = cloud.getPendingCount();
        logCritical(`‚ö†Ô∏è [FLUSH] Timeout after ${timeoutMs}ms, ${stillPending} items still pending, inFlight=${_uploadInProgress}`);
        logFlushSummary('timeout', stillPending);
        window.removeEventListener('heys:queue-drained', handler);
        resolve(false);
      }, timeoutMs);

      // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ queue-drained
      const handler = () => {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—Å—ë –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        if (_uploadInProgress) {
          logCritical('üîÑ [FLUSH] queue-drained fired but upload still in progress, waiting...');
          return; // –ù–µ —Å–Ω–∏–º–∞–µ–º listener, –∂–¥—ë–º –µ—â—ë
        }
        clearTimeout(timeoutId);
        const elapsed = Date.now() - startTime;
        logCritical(`‚úÖ [FLUSH] Queue drained in ${elapsed}ms`);
        logFlushSummary('done', 0);
        window.removeEventListener('heys:queue-drained', handler);
        resolve(true);
      };
      window.addEventListener('heys:queue-drained', handler);

      // –ï—Å–ª–∏ –≤—Å—ë —É–∂–µ –≤ –ø–æ–ª—ë—Ç–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∂–¥—ë–º queue-drained
      if (stillInQueue === 0 && _uploadInProgress) {
        logCritical('üîÑ [FLUSH] Queue empty but upload in progress, waiting for completion...');
      }
    });
  };

  /** –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ storage */
  cloud.getStorageInfo = function () {
    const sizeMB = getStorageSize();
    const usedPercent = Math.round((sizeMB / MAX_STORAGE_MB) * 100);
    return {
      sizeMB: sizeMB.toFixed(2),
      maxMB: MAX_STORAGE_MB,
      usedPercent,
      isNearLimit: usedPercent > 80
    };
  };

  /** –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö */
  cloud.cleanupStorage = cleanupOldData;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìú SYNC HISTORY LOG ‚Äî –ñ–£–†–ù–ê–õ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ô
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const SYNC_LOG_KEY = 'heys_sync_log';
  const MAX_SYNC_LOG_ENTRIES = 50;
  const SYNC_PROGRESS_EVENT = 'heys:sync-progress';
  const SYNC_COMPLETED_EVENT = 'heysSyncCompleted';
  let syncProgressTotal = 0;
  let syncProgressDone = 0;
  const AUTH_ERROR_CODES = new Set(['401', '42501', 'PGRST301']);

  /** –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ –æ—à–∏–±–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401, RLS) */
  function isAuthError(error) {
    if (!error) return false;
    // HTTP —Å—Ç–∞—Ç—É—Å 401
    if (error.status === 401 || error.statusCode === 401) return true;
    // PostgreSQL RLS error
    if (error.code && AUTH_ERROR_CODES.has(String(error.code))) return true;
    // Supabase error message
    const msg = (error.message || '').toLowerCase();
    if (msg.includes('unauthorized') || msg.includes('jwt') || msg.includes('invalid claim')) return true;
    return false;
  }

  /** –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  function addSyncLogEntry(type, details) {
    try {
      const log = JSON.parse(global.localStorage.getItem(SYNC_LOG_KEY) || '[]');
      log.unshift({
        ts: Date.now(),
        type, // 'sync_ok' | 'sync_error' | 'offline' | 'online' | 'quota_error'
        details
      });
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ª–æ–≥–∞
      if (log.length > MAX_SYNC_LOG_ENTRIES) {
        log.length = MAX_SYNC_LOG_ENTRIES;
      }
      global.localStorage.setItem(SYNC_LOG_KEY, JSON.stringify(log));
    } catch (e) { }
  }

  /** –ü–æ–ª—É—á–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  cloud.getSyncLog = function () {
    try {
      return JSON.parse(global.localStorage.getItem(SYNC_LOG_KEY) || '[]');
    } catch (e) {
      return [];
    }
  };

  /** –û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  cloud.clearSyncLog = function () {
    global.localStorage.removeItem(SYNC_LOG_KEY);
  };

  /** –°–æ–±—ã—Ç–∏–µ –¥–ª—è UI –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ pending count */
  function notifyPendingChange() {
    const count = cloud.getPendingCount();
    const details = cloud.getPendingDetails();
    // Defer event dispatch to avoid setState during render
    queueMicrotask(() => {
      try {
        global.dispatchEvent(new CustomEvent('heys:pending-change', {
          detail: { count, details }
        }));
      } catch (e) { }
      updateSyncProgressTotal();
    });
  }

  /** –°–æ–±—ã—Ç–∏–µ: –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  function notifySyncProgress(total, done) {
    try {
      global.dispatchEvent(new CustomEvent(SYNC_PROGRESS_EVENT, { detail: { total, done } }));
    } catch (e) { }
  }

  /** –°–æ–±—ã—Ç–∏–µ: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–±–µ–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π (upload) */
  function notifySyncCompletedIfDrained() {
    if (clientUpsertQueue.length === 0 && upsertQueue.length === 0) {
      syncProgressTotal = 0;
      syncProgressDone = 0;
      // –°–æ–±—ã—Ç–∏–µ "–æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞" ‚Äî –¥–ª—è UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º heysSyncCompleted ‚Äî —ç—Ç–æ –¥–ª—è initial sync –∫–ª–∏–µ–Ω—Ç–∞!
      try {
        global.dispatchEvent(new CustomEvent('heys:queue-drained', { detail: {} }));
      } catch (e) { }
    }
  }

  /** –°–æ–±—ã—Ç–∏–µ: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ */
  function notifySyncRestored(syncedCount) {
    try {
      addSyncLogEntry('sync_ok', { count: syncedCount });
      global.dispatchEvent(new CustomEvent('heys:sync-restored', {
        detail: { count: syncedCount }
      }));
    } catch (e) { }
  }

  /** –°–æ–±—ã—Ç–∏–µ: –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  function notifySyncError(error, retryIn) {
    try {
      const errorMsg = error?.message || String(error);
      if (typeof navigator !== 'undefined') {
        logCritical(`üåê [NET] Sync error: ${navigator.onLine ? 'online' : 'offline'}`);
      }
      console.error('üî• [SYNC ERROR] Critical sync failure:', errorMsg);

      addSyncLogEntry('sync_error', { error: errorMsg });

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ —Å —Ñ–ª–∞–≥–æ–º persistent, —á—Ç–æ–±—ã UI –∑–Ω–∞–ª, —á—Ç–æ —ç—Ç–æ –≤–∞–∂–Ω–æ
      global.dispatchEvent(new CustomEvent('heys:sync-error', {
        detail: {
          error: errorMsg,
          retryIn,
          persistent: true // üÜï –§–ª–∞–≥ –¥–ª—è UI: –Ω–µ —Å–∫—Ä—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É —Å–∞–º–æ
        }
      }));
    } catch (e) { }
  }

  /** –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/RLS */
  function handleAuthFailure(err) {
    try {
      const errMsg = err?.message || err?.code || String(err);
      logCritical('üö® [handleAuthFailure] –í–´–ó–í–ê–ù! –ü—Ä–∏—á–∏–Ω–∞:', errMsg);
      console.trace('[handleAuthFailure] Stack trace:');

      // üõ°Ô∏è –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª —É—Å–ø–µ—à–Ω—ã–π signIn ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      if (Date.now() < _ignoreSignedOutUntil) {
        logCritical('üõ°Ô∏è [handleAuthFailure] –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ‚Äî –∑–∞—â–∏—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –ø–æ—Å–ª–µ signIn');
        return;
      }

      // üîê RTR (Refresh Token Rotation) –æ—à–∏–±–∫–∞ ‚Äî –ù–ï –£–î–ê–õ–Ø–ï–ú —Ç–æ–∫–µ–Ω!
      // –ü—Ä–∏ infinite —Ç–æ–∫–µ–Ω–∞—Ö access_token –≤—Å—ë –µ—â—ë –≤–∞–ª–∏–¥–µ–Ω, –¥–∞–∂–µ –µ—Å–ª–∏ refresh_token —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.
      // –ü—Ä–∏–º–µ—Ä: "Invalid Refresh Token: Already Used"
      const isRTRError = errMsg.includes('Refresh Token') || errMsg.includes('Already Used') || errMsg.includes('refresh_token');
      if (isRTRError) {
        logCritical('‚è≠Ô∏è [handleAuthFailure] RTR –æ—à–∏–±–∫–∞ ‚Äî —Ç–æ–∫–µ–Ω –ù–ï —É–¥–∞–ª—è–µ–º (access_token –≤–∞–ª–∏–¥–µ–Ω)');
        return; // –ù–µ —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º user
      }

      // üîê RLS –æ—à–∏–±–∫–∞ ‚Äî –ù–ï –£–î–ê–õ–Ø–ï–ú —Ç–æ–∫–µ–Ω!
      // RLS –æ—à–∏–±–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ü–†–û–®–Å–õ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (–∏–Ω–∞—á–µ –±—ã–ª –±—ã 401),
      // –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é. Access_token –≤—Å—ë –µ—â—ë –≤–∞–ª–∏–¥–µ–Ω!
      // –ü—Ä–∏–º–µ—Ä: "new row violates row-level security policy for table"
      const isRLSError = errMsg.includes('row-level security') || errMsg.includes('policy') || errMsg.includes('RLS');
      if (isRLSError) {
        logCritical('‚è≠Ô∏è [handleAuthFailure] RLS –æ—à–∏–±–∫–∞ ‚Äî —Ç–æ–∫–µ–Ω –ù–ï —É–¥–∞–ª—è–µ–º (access_token –≤–∞–ª–∏–¥–µ–Ω)');
        return; // –ù–µ —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º user
      }

      // –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (401 Unauthorized, invalid token) –¥–æ–ª–∂–Ω—ã —É–¥–∞–ª—è—Ç—å —Ç–æ–∫–µ–Ω
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∞ –Ω–µ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ
      // ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —á—Ç–æ–±—ã –Ω–µ –º–∞—Ç—á–∏—Ç—å "token valid" –∏–ª–∏ "policy token"
      const isRealAuthError = errMsg.includes('401') ||
        errMsg.includes('Unauthorized') ||
        errMsg.includes('invalid token') ||
        errMsg.includes('token expired') ||
        errMsg.includes('token invalid') ||
        errMsg.includes('missing token') ||
        errMsg.includes('no token') ||
        errMsg.includes('expired') ||
        errMsg.includes('JWT');

      if (!isRealAuthError) {
        logCritical('‚è≠Ô∏è [handleAuthFailure] –ù–µ-auth –æ—à–∏–±–∫–∞ ‚Äî —Ç–æ–∫–µ–Ω –ù–ï —É–¥–∞–ª—è–µ–º');
        return;
      }

      status = CONNECTION_STATUS.OFFLINE;
      user = null;
      // üîÑ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ 401 –æ—à–∏–±–∫–∏
      try {
        localStorage.removeItem('heys_supabase_auth_token');
      } catch (e) { }
      addSyncLogEntry('sync_error', { error: 'auth_required' });

      // üî• INSTANT FEEDBACK: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      global.dispatchEvent(new CustomEvent('heys:sync-error', {
        detail: {
          error: 'auth_required',
          persistent: true
        }
      }));

      logCritical('‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ (auth/RLS error)');
    } catch (e) { }
  }

  /** –û–±–Ω–æ–≤–∏—Ç—å total –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (max –º–µ–∂–¥—É —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–º –∏ –Ω–æ–≤—ã–º pending) */
  function updateSyncProgressTotal() {
    const pending = cloud.getPendingCount();
    const candidate = syncProgressDone + pending;
    if (candidate > syncProgressTotal) {
      syncProgressTotal = candidate;
      notifySyncProgress(syncProgressTotal, syncProgressDone);
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîÑ EXPONENTIAL BACKOFF –î–õ–Ø RETRY
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  let retryAttempt = 0;
  const MAX_RETRY_ATTEMPTS = 5;
  const BASE_RETRY_DELAY = 1000; // 1 —Å–µ–∫

  /** –í—ã—á–∏—Å–ª–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É —Å exponential backoff */
  function getRetryDelay() {
    // 1s, 2s, 4s, 8s, 16s (max)
    return Math.min(BASE_RETRY_DELAY * Math.pow(2, retryAttempt), 16000);
  }

  /** –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ retry –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  function resetRetry() {
    retryAttempt = 0;
  }

  /** –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ retry */
  function incrementRetry() {
    if (retryAttempt < MAX_RETRY_ATTEMPTS) {
      retryAttempt++;
    }
  }

  // –£–º–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  // –í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ localStorage: localStorage.setItem('heys_debug_sync', 'true')
  const isDebugSync = () => global.localStorage.getItem('heys_debug_sync') === 'true';

  function log() {
    // –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è debug
    if (isDebugSync()) {
      try {
        if (HEYS?.log) {
          HEYS.log('HEYS.cloud', ...arguments);
          return;
        }
        console.log.apply(console, ['[HEYS.cloud]'].concat([].slice.call(arguments)));
      } catch (e) { }
    }
  }
  function err() {
    try {
      if (HEYS?.err) {
        HEYS.err('HEYS.cloud:ERR', ...arguments);
        return;
      }
      console.error.apply(console, ['[HEYS.cloud:ERR]'].concat([].slice.call(arguments)));
    } catch (e) { }
  }

  // üîê –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥ ‚Äî –í–°–ï–ì–î–ê –≤–∏–¥–µ–Ω (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, auth, –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
  function logCritical() {
    try {
      if (global.console && typeof global.console.info === 'function') {
        global.console.info.apply(global.console, ['[HEYS.sync]'].concat([].slice.call(arguments)));
        return;
      }
      console.info.apply(console, ['[HEYS.sync]'].concat([].slice.call(arguments)));
    } catch (e) { }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–µ–≤–æ–π (QUIC, fetch failed, network error)
   * @param {Object|Error} error - –û–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
   * @returns {boolean} true –µ—Å–ª–∏ —ç—Ç–æ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞
   */
  function isNetworkError(error) {
    if (!error) return false;
    const msg = (error.message || error.details || '').toLowerCase();
    return msg.includes('failed to fetch') ||
      msg.includes('network') ||
      msg.includes('quic') ||
      msg.includes('connection') ||
      msg.includes('timeout') ||
      msg.includes('aborted');
  }

  /**
   * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å retry –∏ exponential backoff –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
   * @param {Function} requestFn - –§—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è Promise (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏–µ–π, –Ω–µ Promise!)
   * @param {Object} options - –û–ø—Ü–∏–∏
   * @param {number} options.maxRetries - –ú–∞–∫—Å–∏–º—É–º —Ä–µ—Ç—Ä–∞–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
   * @param {number} options.baseDelayMs - –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000)
   * @param {number} options.timeoutMs - –¢–∞–π–º–∞—É—Ç –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15000)
   * @param {string} options.label - –ú–µ—Ç–∫–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   * @returns {Promise} { data, error } –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
   */
  async function fetchWithRetry(requestFn, options = {}) {
    const maxRetries = options.maxRetries || 3;
    const baseDelayMs = options.baseDelayMs || 1000;
    const timeoutMs = options.timeoutMs || 15000;
    const label = options.label || 'request';

    let lastError = null;

    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`Timeout: ${label}`)), timeoutMs)
        );

        // requestFn ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π Promise –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
        const result = await Promise.race([requestFn(), timeoutPromise]);

        // Supabase –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { data, error } ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º error
        if (result && result.error && isNetworkError(result.error)) {
          throw new Error(result.error.message || 'Network error');
        }

        // –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
        registerSuccess();
        return result;
      } catch (e) {
        lastError = e;

        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ ‚Äî –Ω–µ —Ä–µ—Ç—Ä–∞–∏–º
        if (!isNetworkError({ message: e.message })) {
          return { data: null, error: { message: e.message } };
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        registerError();

        if (attempt < maxRetries) {
          // Exponential backoff: 1s, 2s, 4s —Å jitter ¬±20%
          const baseDelay = baseDelayMs * Math.pow(2, attempt);
          const jitter = baseDelay * (0.8 + Math.random() * 0.4); // ¬±20%
          const delay = Math.round(jitter);
          console.warn(`[HEYS.cloud] ‚ö° ${label}: —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞, retry ${attempt + 1}/${maxRetries} —á–µ—Ä–µ–∑ ${delay}ms...`);
          await new Promise(r => setTimeout(r, delay));
        }
      }
    }

    // –í—Å–µ —Ä–µ—Ç—Ä–∞–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º fallback
    if (options._afterFallback) {
      // –£–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ fallback ‚Äî —Å–¥–∞—ë–º—Å—è
      console.warn(`[HEYS.cloud] ‚ùå ${label}: fallback —Ç–æ–∂–µ –Ω–µ –ø–æ–º–æ–≥, –ø–µ—Ä–µ—Ö–æ–¥ –≤ offline —Ä–µ–∂–∏–º`);
      return { data: null, error: { message: lastError?.message || 'Network error after retries', isNetworkFailure: true } };
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è
    if (!canSwitch()) {
      console.warn(`[HEYS.cloud] ‚ùå ${label}: –≤—Å–µ ${maxRetries} –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (debounce)`);
      return { data: null, error: { message: lastError?.message || 'Network error after retries', isNetworkFailure: true } };
    }

    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º
    if (!_usingDirectConnection && cloud._directUrl && cloud._proxyUrl !== cloud._directUrl) {
      // –°–µ–π—á–∞—Å –Ω–∞ proxy ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ direct
      console.warn(`[HEYS.cloud] üîÑ ${label}: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...`);
      try {
        _lastSwitchTime = Date.now();
        _consecutiveErrors = 0;
        await switchToDirectConnection();
        return await fetchWithRetry(requestFn, { ...options, _afterFallback: true });
      } catch (fallbackErr) {
        console.warn(`[HEYS.cloud] ‚ùå Direct fallback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:`, fallbackErr?.message);
      }
    } else if (_usingDirectConnection && cloud._proxyUrl) {
      // –°–µ–π—á–∞—Å –Ω–∞ direct ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ proxy
      console.warn(`[HEYS.cloud] üîÑ ${label}: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ proxy...`);
      try {
        await switchToProxyConnection();
        return await fetchWithRetry(requestFn, { ...options, _afterFallback: true });
      } catch (fallbackErr) {
        console.warn(`[HEYS.cloud] ‚ùå Proxy fallback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:`, fallbackErr?.message);
      }
    }

    console.warn(`[HEYS.cloud] ‚ùå ${label}: –≤—Å–µ ${maxRetries} –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å, –ø–µ—Ä–µ—Ö–æ–¥ –≤ offline —Ä–µ–∂–∏–º`);
    return { data: null, error: { message: lastError?.message || 'Network error after retries', isNetworkFailure: true } };
  }

  /**
   * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase (fallback –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ proxy)
   * ‚ö†Ô∏è –ù–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º client —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "Multiple GoTrueClient" warning
   * –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è
   */
  async function switchToDirectConnection() {
    if (_usingDirectConnection) return; // –£–∂–µ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å
    if (!cloud._directUrl || !cloud._anonKey) {
      throw new Error('Direct URL not configured');
    }

    _usingDirectConnection = true;
    _lastSwitchTime = Date.now();
    _consecutiveErrors = 0;
    _successCount = 0;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    try {
      localStorage.setItem('heys_connection_mode', 'direct');
      logCritical('üîÑ [ROUTING] –†–µ–∂–∏–º "direct" —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏');
    } catch (e) {
      console.warn('[ROUTING] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º:', e.message);
    }

    // –ù–ï –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º client ‚Äî —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ proxy
    // –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å direct
    addSyncLogEntry('mode_change', { newMode: 'direct', appliedAt: 'next_reload' });
  }

  /**
   * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ proxy –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (fallback –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ direct)
   * ‚ö†Ô∏è –ù–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º client —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "Multiple GoTrueClient" warning
   * –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è
   */
  async function switchToProxyConnection() {
    if (!_usingDirectConnection) return; // –£–∂–µ –Ω–∞ –ø—Ä–æ–∫—Å–∏
    if (!cloud._proxyUrl || !cloud._anonKey) {
      throw new Error('Proxy URL not configured');
    }

    _usingDirectConnection = false;
    _lastSwitchTime = Date.now();
    _consecutiveErrors = 0;
    _successCount = 0;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    try {
      localStorage.setItem('heys_connection_mode', 'proxy');
      logCritical('üîÑ [ROUTING] –†–µ–∂–∏–º "proxy" —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏');
    } catch (e) {
      console.warn('[ROUTING] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º:', e.message);
    }

    // –ù–ï –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º client ‚Äî —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ direct
    // –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å proxy
    addSyncLogEntry('mode_change', { newMode: 'proxy', appliedAt: 'next_reload' });
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º
   */
  function canSwitch() {
    // Debounce: –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
    if (Date.now() - _lastSwitchTime < SWITCH_DEBOUNCE_MS) {
      log(`[ROUTING] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –ø—Ä–æ—à–ª–æ ${Date.now() - _lastSwitchTime}ms < ${SWITCH_DEBOUNCE_MS}ms`);
      return false;
    }
    // –¢—Ä–µ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
    if (_consecutiveErrors < MIN_ERRORS_FOR_SWITCH) {
      log(`[ROUTING] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ‚Äî —Ç–æ–ª—å–∫–æ ${_consecutiveErrors} –æ—à–∏–±–æ–∫ < ${MIN_ERRORS_FOR_SWITCH}`);
      return false;
    }
    return true;
  }

  /**
   * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   */
  function registerSuccess() {
    _consecutiveErrors = 0;
    _successCount++;

    // –ü–æ—Å–ª–µ 3+ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º
    if (_successCount === MIN_SUCCESS_FOR_SAVE) {
      const mode = _usingDirectConnection ? 'direct' : 'proxy';
      try {
        localStorage.setItem('heys_connection_mode', mode);
        log(`[ROUTING] ‚úÖ –†–µ–∂–∏–º '${mode}' —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ—Å–ª–µ ${_successCount} —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤`);
      } catch (e) {
        console.warn('[ROUTING] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º –≤ localStorage:', e.message);
      }
    }
  }

  /**
   * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
   */
  function registerError() {
    // –ù–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ offline —Ä–µ–∂–∏–º–µ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞ —Å routing
    if (typeof navigator !== 'undefined' && !navigator.onLine) {
      return;
    }
    _consecutiveErrors++;
    _successCount = 0;
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
  cloud.switchToDirectConnection = switchToDirectConnection;
  cloud.switchToProxyConnection = switchToProxyConnection;
  cloud.registerSuccess = registerSuccess;
  cloud.registerError = registerError;
  cloud.fetchWithRetry = fetchWithRetry; // –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö –º–æ–¥—É–ª–µ–π (heys_app_v12.js)
  cloud.getRoutingStatus = function () {
    return {
      mode: _usingDirectConnection ? 'direct' : 'proxy',
      consecutiveErrors: _consecutiveErrors,
      successCount: _successCount,
      lastSwitchTime: _lastSwitchTime,
      canSwitch: canSwitch()
    };
  };

  /**
   * –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç–∞–π–º–∞—É—Ç–æ–º (legacy, –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
   * @param {Promise} promise - Promise –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   * @param {number} ms - –¢–∞–π–º–∞—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10000)
   * @param {string} label - –ú–µ—Ç–∫–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–∫–∏
   * @returns {Promise} –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ {error} –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ
   */
  async function withTimeout(promise, ms = 10000, label = 'request') {
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error(`Timeout: ${label} took too long`)), ms)
    );
    try {
      return await Promise.race([promise, timeoutPromise]);
    } catch (e) {
      // –î–ª—è bootstrapSync —Ç–∞–π–º–∞—É—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏, –Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
      if (label.includes('bootstrap')) {
        console.warn(`[HEYS.cloud] ‚è≥ ${label}: –º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–µ—Ç—å, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...`);
      } else {
        err(`${label} timeout`, e.message);
      }
      return { data: null, error: { message: e.message } };
    }
  }

  /**
   * –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON
   * @param {string} v - –°—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
   * @returns {*} –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
   */
  function tryParse(v) {
    try {
      // üîß FIX 2025-12-26: –ò—Å–ø–æ–ª—å–∑—É–µ–º decompress –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∂–∞—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      // –ë–µ–∑ —ç—Ç–æ–≥–æ —Å–∂–∞—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ "¬§Z¬§[{..." —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ cloud –∫–∞–∫ –µ—Å—Ç—å, –ª–æ–º–∞—è sync
      const Store = global.HEYS?.store;
      if (Store && typeof Store.decompress === 'function') {
        return Store.decompress(v);
      }
      // Fallback –µ—Å–ª–∏ store –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      return JSON.parse(v);
    } catch (e) {
      return v;
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª—é—á –Ω–∞—à–∏–º (–¥–ª—è –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è/–æ—á–∏—Å—Ç–∫–∏)
   * @param {string} k - –ö–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   * @returns {boolean} true –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞—à –∫–ª—é—á
   */
  function isOurKey(k) {
    if (typeof k !== 'string') return false;

    // üîí –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º auth-—Å–µ—Å—Å–∏—é Supabase
    // –ò–Ω–∞—á–µ bootstrapSync/clearNamespace —É–¥–∞–ª–∏—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´–≤—ã–ª–µ—Ç–∏—Ç¬ª —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞.
    if (k === 'heys_supabase_auth_token') return false;
    if (k.indexOf('sb-') === 0) return false;

    // üß™ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ
    if (k.indexOf('heys_ab_') === 0) return false;
    if (k.indexOf('heys_predicted_risk_') === 0) return false;

    if (k.indexOf(KEY_PREFIXES.HEYS) === 0) return true;
    // —Ç–∞–∫–∂–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª—é—á–∏ –¥–Ω–µ–π
    const lower = k.toLowerCase();
    if (lower.indexOf(KEY_PREFIXES.DAY) >= 0) return true;
    return false;
  }

  /**
   * –û—á–∏—Å—Ç–∫–∞ namespace –≤ localStorage (–Ω–∞—à–∏ –∫–ª—é—á–∏)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π, –∏–ª–∏ null –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
   */
  function clearNamespace(clientId) {
    try {
      const ls = global.localStorage;
      for (let i = ls.length - 1; i >= 0; i--) {
        const k = ls.key(i);
        if (!k) continue;
        const lower = k.toLowerCase();

        if (clientId) {
          // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ client-specific –∫–ª—é—á–µ–π
          const heysClientPrefix = (KEY_PREFIXES.HEYS + clientId + '_').toLowerCase();
          const dayClientPrefix = (CLIENT_KEY_PATTERNS.DAY_CLIENT + clientId + '_').toLowerCase();

          if (lower.indexOf(heysClientPrefix) === 0) {
            ls.removeItem(k);
            continue;
          }
          if (lower.indexOf(dayClientPrefix) === 0) {
            ls.removeItem(k);
            continue;
          }

          // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –æ–±—â–∏–µ –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å client-specific
          if (CLIENT_SPECIFIC_KEYS.includes(k)) {
            ls.removeItem(k);
            continue;
          }
        } else {
          // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –Ω–∞—à–∏—Ö –∫–ª—é—á–µ–π
          if (isOurKey(k)) ls.removeItem(k);
        }
      }
    } catch (e) {
      err('clearNamespace', e);
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîÑ –ü–ï–†–ï–•–í–ê–¢ LOCALSTORAGE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ç—Ä–µ–±—É–µ—Ç –ª–∏ –∫–ª—é—á client-specific —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
   * @param {string} k - –ö–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å scoped: heys_{clientId}_game)
   * @returns {boolean} true –µ—Å–ª–∏ –Ω—É–∂–µ–Ω client_kv_store
   */
  function needsClientStorage(k) {
    if (!k) return false;
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (k.includes(CLIENT_KEY_PATTERNS.DAY_V2)) return true;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫–ª—é—á –∏–∑ scoped (heys_{clientId}_game ‚Üí heys_game)
    // Pattern: heys_{uuid}_suffix ‚Üí heys_suffix
    const baseKey = k.replace(/^heys_[a-f0-9-]{36}_/, 'heys_');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–µ client-specific –∫–ª—é—á–∏
    if (CLIENT_SPECIFIC_KEYS.includes(k) || CLIENT_SPECIFIC_KEYS.includes(baseKey)) return true;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏ —Ç–∏–ø–∞ heys_milestone_7_days)
    for (const prefix of CLIENT_SPECIFIC_PREFIXES) {
      if (k.startsWith(prefix) || baseKey.startsWith(prefix)) return true;
    }
    return false;
  }

  /**
   * –ü–µ—Ä–µ—Ö–≤–∞—Ç localStorage.setItem –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ cloud
   * –ó–µ—Ä–∫–∞–ª–∏—Ä—É–µ—Ç –Ω–∞—à–∏ –∫–ª—é—á–∏ (heys_*, day*) –≤ Supabase
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç QuotaExceededError –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π
   */
  // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–ª—é—á–∏ –∏ –∏—Ö updatedAt
  const _lastSavedKeys = new Map(); // key ‚Üí { updatedAt, timestamp }
  const DEDUP_WINDOW_MS = 1000; // –û–∫–Ω–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: 1 —Å–µ–∫—É–Ω–¥–∞

  // üîí –ö–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ò–ö–û–ì–î–ê –Ω–µ–ª—å–∑—è –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –≤ cloud (–∏ –Ω–µ–ª—å–∑—è —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å SDK –∑–∞–ø—Ä–æ—Å—ã)
  // –ü—Ä–∏—á–∏–Ω–∞: –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ Supabase session —ç—Ç–∏ –∫–ª—é—á–∏ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å _useSession/__loadSession
  // –∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ refresh_token 400 (RTR), –∞ —Ç–∞–∫–∂–µ —ç—Ç–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
  const AUTH_STORAGE_KEYS_TO_SKIP = new Set([
    'heys_supabase_auth_token',
    'sb-ukqolcziqcuplqfgrmsh-auth-token'
  ]);

  function interceptSetItem() {
    try {
      if (originalSetItem) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
      originalSetItem = global.localStorage.setItem.bind(global.localStorage);
      global.localStorage.setItem = function (k, v) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–ø–∏—Å—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π QuotaExceeded
        if (!safeSetItem(k, v)) {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º
          console.warn('[HEYS] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:', k);
          return;
        }

        // üîí –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–µ—Ä–∫–∞–ª–∏–º –∫–ª—é—á–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∏ –ª—é–±—ã–µ sb-* –∫–ª—é—á–∏)
        try {
          const keyStr = String(k || '');
          const lower = keyStr.toLowerCase();
          if (AUTH_STORAGE_KEYS_TO_SKIP.has(keyStr) || lower.startsWith('sb-')) {
            return;
          }
        } catch (_) { }

        // –í–æ –≤—Ä–µ–º—è signIn –Ω–µ –∑–µ—Ä–∫–∞–ª–∏–º –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ ‚Äî —ç—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –≥–æ–Ω–æ–∫ –∏ RTR refresh 400
        if (typeof _signInInProgress !== 'undefined' && _signInInProgress) {
          return;
        }

        // üö´ –ù–µ –∑–µ—Ä–∫–∞–ª–∏–º backup-–∫–ª—é—á–∏ (–≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –±–∞–∑—ã –ø—Ä–∏ sync)
        if (String(k || '').includes('_backup')) {
          return;
        }

        if (!muteMirror && isOurKey(k)) {
          // üîí –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å —Ç–µ–º –∂–µ updatedAt
          const parsed = tryParse(v);
          const updatedAt = parsed?.updatedAt || 0;
          const now = Date.now();
          const lastSaved = _lastSavedKeys.get(k);

          if (lastSaved && updatedAt > 0 && lastSaved.updatedAt === updatedAt && (now - lastSaved.timestamp) < DEDUP_WINDOW_MS) {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç
            // DEBUG (–æ—Ç–∫–ª—é—á–µ–Ω–æ): log(`üîÑ [DEDUP] Skipped duplicate save: ${k} | updatedAt: ${updatedAt}`);
            return;
          }

          // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
          if (updatedAt > 0) {
            _lastSavedKeys.set(k, { updatedAt, timestamp: now });
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (>10 —Å–µ–∫)
            for (const [key, val] of _lastSavedKeys) {
              if (now - val.timestamp > 10000) _lastSavedKeys.delete(key);
            }
          }

          if (needsClientStorage(k)) {
            cloud.saveClientKey(k, parsed);
          } else {
            cloud.saveKey(k, parsed);
          }
        }
      };
    } catch (e) {
      err('intercept setItem failed', e);
    }
  }

  // –§–ª–∞–≥ –¥–ª—è fallback –Ω–∞ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  let _usingDirectConnection = false;
  cloud.isUsingDirectConnection = function () { return _usingDirectConnection; };

  // –ó–∞—â–∏—Ç–∞ –æ—Ç ping-pong –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
  let _lastSwitchTime = 0;
  let _consecutiveErrors = 0;
  let _successCount = 0;
  const SWITCH_DEBOUNCE_MS = 30000; // –ù–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 30 —Å–µ–∫
  const MIN_ERRORS_FOR_SWITCH = 2; // –¢—Ä–µ–±—É–µ–º 2+ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  const MIN_SUCCESS_FOR_SAVE = 3; // 3+ —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞

  cloud.init = function ({ url, anonKey, localhostProxyUrl }) {
    // Idempotent init: avoid double creation & duplicate intercept logs
    if (cloud._inited) { return; }

    // ‚úÖ 2025-12-25: Supabase SDK –£–î–ê–õ–Å–ù ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI
    // –¢–µ–ø–µ—Ä—å –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º global.supabase, –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ heys_yandex_api_v1.js
    if (!global.supabase || !global.supabase.createClient) {
      // –ù–ï –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é! –†–∞–±–æ—Ç–∞–µ–º —á–µ—Ä–µ–∑ YandexAPI.
      log('Supabase SDK –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI mode');
    }

    // Legacy: URL –¥–ª—è fallback (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º YandexAPI)
    cloud._proxyUrl = localhostProxyUrl || url;
    cloud._directUrl = null; // Supabase –æ—Ç–∫–ª—é—á—ë–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º Yandex Cloud
    cloud._anonKey = anonKey;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ä–µ–¥—É
    const isLocalhost = typeof window !== 'undefined' &&
      (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1'));

    // üåê –°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ + —Å–ª—É—à–∞—Ç–µ–ª–∏ online/offline
    if (typeof navigator !== 'undefined') {
      logCritical(`üåê [NET] –°—Ç–∞—Ä—Ç: ${navigator.onLine ? 'online' : 'offline'}`);
      if (typeof window !== 'undefined') {
        window.addEventListener('online', () => {
          logCritical('üåê [NET] online');
        });
        window.addEventListener('offline', () => {
          logCritical('üåê [NET] offline');
        });
      }
    }

    // üîÑ Smart –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    let initialUrl = url;
    let needsHealthCheck = false;

    // –ù–∞ localhost: –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π URL (direct), –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º
    // –ù–∞ production: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º
    if (isLocalhost) {
      log('[ROUTING] Localhost ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º direct, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º');
      _usingDirectConnection = (url === cloud._directUrl);
      needsHealthCheck = true; // –ü—Ä–æ–≤–µ—Ä–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å direct, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏–º –Ω–∞ proxy
    } else {
      try {
        const savedMode = localStorage.getItem('heys_connection_mode');
        if (savedMode === 'direct' && cloud._directUrl) {
          log('[ROUTING] –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º: direct');
          initialUrl = cloud._directUrl;
          _usingDirectConnection = true;
          needsHealthCheck = true; // –ü—Ä–æ–≤–µ—Ä–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å direct –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        } else if (savedMode === 'proxy') {
          log('[ROUTING] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º: proxy');
        } else {
          log('[ROUTING] –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º proxy (default –¥–ª—è –†–§)');
        }
      } catch (e) {
        console.warn('[ROUTING] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –∏–∑ localStorage:', e.message);
      }
    }

    // Health-ping —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è client
    // ‚ö†Ô∏è –ù–∞ production: —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∂–∏–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ (–Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç client)
    // ‚ö†Ô∏è –ù–∞ localhost: –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç client —Å—Ä–∞–∑—É (dev —Ä–µ–∂–∏–º, —É–¥–æ–±—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ)
    const runHealthCheck = async () => {
      if (!needsHealthCheck || !client) return;
      try {
        log('[ROUTING] üè• Health-check –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');

        // üÜï –ò—Å–ø–æ–ª—å–∑—É–µ–º /health —ç–Ω–¥–ø–æ–∏–Ω—Ç Yandex Cloud Functions
        // –≤–º–µ—Å—Ç–æ Supabase-—Ñ–æ—Ä–º–∞—Ç–∞ /rest/v1/... –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è API Gateway
        const healthUrl = `${initialUrl.replace(/\/$/, '')}/health`;

        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Health-check timeout')), 3000),
        );

        const fetchPromise = fetch(healthUrl, {
          method: 'GET',
          headers: {
            apikey: anonKey,
            Authorization: `Bearer ${anonKey}`,
          },
        });

        const res = await Promise.race([fetchPromise, timeoutPromise]);
        if (!res || !res.ok) {
          const msg = res ? `${res.status} ${res.statusText}` : 'no response';
          log('[ROUTING] ‚ö†Ô∏è –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', msg);
          await handleHealthCheckFailure();
          return;
        }

        log('[ROUTING] ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
        registerSuccess();
      } catch (e) {
        log('[ROUTING] ‚ö†Ô∏è Health-check timeout/error:', e.message);
        await handleHealthCheckFailure();
      }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ health-check
    const handleHealthCheckFailure = async () => {
      const fallbackMode = _usingDirectConnection ? 'proxy' : 'direct';

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî –ù–ï –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç!
      // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã–∑—ã–≤–∞–µ—Ç "Multiple GoTrueClient instances" –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      // –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ race conditions —Å —Ç–æ–∫–µ–Ω–∞–º–∏
      try {
        localStorage.setItem('heys_connection_mode', fallbackMode);
        log('[ROUTING] üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω —Ä–µ–∂–∏–º', fallbackMode, '–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏');
      } catch (_) { }

      // –ù–∞ localhost –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
      if (isLocalhost && !cloud._healthCheckFallbackDone) {
        cloud._healthCheckFallbackDone = true;
        log('[ROUTING] ‚ö†Ô∏è Localhost: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞', fallbackMode);
      }
    };

    try {
      // ‚ö†Ô∏è RTR-safe: –ù–ï –º–∏–≥—Ä–∏—Ä—É–µ–º —Å–µ—Å—Å–∏–∏ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ sb-* –∫–ª—é—á–∞.
      // –ü—Ä–∏ Refresh Token Rotation —Å—Ç–∞—Ä—ã–µ refresh_token –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã,
      // –∏ –ª—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏—Ö ¬´–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ 400 refresh_token_already_used.
      const OLD_AUTH_KEY = 'sb-ukqolcziqcuplqfgrmsh-auth-token';
      const NEW_AUTH_KEY = 'heys_supabase_auth_token';

      // üîÑ RTR-safe v3: –û—á–∏—â–∞–µ–º –ò–°–¢–Å–ö–®–ò–ï —Ç–æ–∫–µ–Ω—ã –î–û —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
      // –ò–Ω–∞—á–µ SDK –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å refresh –∏ –ø–æ–ª—É—á–∏—Ç 400
      try {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–ª—é—á (sb-*)
        const hadOld = !!localStorage.getItem(OLD_AUTH_KEY);
        if (hadOld) {
          log('[AUTH] üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π auth —Ç–æ–∫–µ–Ω (sb-*)');
          localStorage.removeItem(OLD_AUTH_KEY);
        }

        // ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ expires_at –û–¢–ö–õ–Æ–ß–ï–ù–ê ‚Äî —Ç–æ–∫–µ–Ω—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ Supabase
        // –†–∞–Ω—å—à–µ —Ç—É—Ç –±—ã–ª –∫–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤, –Ω–æ —Ç.–∫. refresh tokens
        // –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ, expires_at –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ —Ç–æ–∫–µ–Ω "–∏—Å—Ç–µ–∫–∞–µ—Ç"
        // —Ö–æ—Ç—è —Å–µ—Å—Å–∏—è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤–∞–ª–∏–¥–Ω–∞. –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ JSON –≤–∞–ª–∏–¥–Ω—ã–π.
        const stored = localStorage.getItem(NEW_AUTH_KEY);
        if (stored) {
          try {
            JSON.parse(stored); // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ JSON –≤–∞–ª–∏–¥–Ω—ã–π
          } catch (_) {
            // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON ‚Äî —É–¥–∞–ª—è–µ–º
            localStorage.removeItem(NEW_AUTH_KEY);
          }
        }
      } catch (_) { }

      // ‚úÖ 2025-12-25: Supabase SDK –£–î–ê–õ–Å–ù ‚Äî –ù–ï —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç
      // –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ YandexAPI (heys_yandex_api_v1.js)
      if (global.supabase && global.supabase.createClient) {
        // –ï—Å–ª–∏ SDK –≤–¥—Ä—É–≥ –ø–æ—è–≤–∏–ª—Å—è ‚Äî —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç (legacy fallback)
        client = global.supabase.createClient(initialUrl, anonKey, {
          auth: {
            persistSession: false,
            autoRefreshToken: false,
          }
        });
        cloud.client = client;
      } else {
        // üÜï YandexAPI mode ‚Äî –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω—É–∂–µ–Ω
        client = null;
        cloud.client = null;
        log('‚òÅÔ∏è YandexAPI mode ‚Äî Supabase client –Ω–µ —Å–æ–∑–¥–∞–Ω');
      }

      status = 'offline';
      interceptSetItem();
      cloud._inited = true;
      log('cloud bridge loaded', _usingDirectConnection ? '(direct)' : '(proxy)');

      // üîê –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PIN auth –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      // ‚ö†Ô∏è –í–ê–ñ–ù–û: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PIN auth —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞!
      // –ò–Ω–∞—á–µ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫—É—Ä–∞—Ç–æ—Ä –ø–æ—Ç–µ—Ä—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤.
      try {
        const pinAuthClient = global.localStorage.getItem('heys_pin_auth_client');
        const curatorSession = global.localStorage.getItem('heys_supabase_auth_token');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω–∞—è —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞
        let hasCuratorSession = false;
        if (curatorSession) {
          try {
            const parsed = JSON.parse(curatorSession);
            hasCuratorSession = !!(parsed?.user && parsed?.access_token);
          } catch (_) { }
        }

        if (pinAuthClient && !hasCuratorSession) {
          // –ù–µ—Ç —Å–µ—Å—Å–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞ ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PIN auth —Ä–µ–∂–∏–º
          _pinAuthClientId = pinAuthClient;
          _rpcOnlyMode = true;
          logCritical('üîê PIN auth –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', pinAuthClient.substring(0, 8) + '...');

          // üîÑ v53 FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º cloud.syncClient() –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ syncClientViaRPC
          // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç deduplication —Ä–∞–±–æ—Ç–∞—Ç—å –µ—Å–ª–∏ App useEffect —Ç–æ–∂–µ –≤—ã–∑–æ–≤–µ—Ç syncClient
          // v62: _authSyncPending = true SYNCHRONOUSLY before async call so that
          // controllerchange (PWA reload) can detect this race window and defer reload.
          _authSyncPending = true;
          cloud.syncClient(pinAuthClient).then(result => {
            _authSyncPending = false;
            if (result?.success) {
              logCritical('‚úÖ [YANDEX RESTORE] Sync –∑–∞–≤–µ—Ä—à—ë–Ω:', result.loaded, '–∫–ª—é—á–µ–π');
            } else {
              logCritical('‚ö†Ô∏è [YANDEX RESTORE] Sync failed:', result?.error || 'no result');
            }
          }).catch(e => {
            _authSyncPending = false;
            logCritical('‚ùå [YANDEX RESTORE] Error:', e.message);
          });
        } else if (pinAuthClient && hasCuratorSession) {
          // –ï—Å—Ç—å —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞ ‚Äî –ù–ï –≤–∫–ª—é—á–∞–µ–º PIN auth —Ä–µ–∂–∏–º, —É–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥
          logCritical('üîê PIN auth –ø—Ä–æ–ø—É—â–µ–Ω ‚Äî –µ—Å—Ç—å —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞');
          global.localStorage.removeItem('heys_pin_auth_client');
        }
      } catch (_) { }

      // üè• Health-check –µ—Å–ª–∏ —Å—Ç–∞—Ä—Ç—É–µ–º –≤ direct —Ä–µ–∂–∏–º–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º VPN –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏)
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –Ω–æ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º ‚Äî fetchWithRetry —Å–∞–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
      if (needsHealthCheck) {
        // –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –µ—Å–ª–∏ direct –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è
        runHealthCheck().catch(() => { });
      }

      // üîÑ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (RTR-safe)
      // üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º expires_at ‚Äî –µ—Å–ª–∏ access_token –∏—Å—Ç—ë–∫, refresh_token —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ç–æ–∂–µ
      // (RTR = Refresh Token Rotation, –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã)
      const restoreSessionFromStorage = () => {
        try {
          const stored = localStorage.getItem('heys_supabase_auth_token');
          if (!stored) return { user: null };
          const parsed = JSON.parse(stored);
          const accessToken = parsed?.access_token;
          const refreshToken = parsed?.refresh_token;
          const storedUser = parsed?.user;
          const expiresAt = parsed?.expires_at;

          // –ú–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—è
          if (!accessToken || !storedUser) return { user: null };

          // üïê –ü—Ä–æ–≤–µ—Ä–∫–∞ expires_at: –µ—Å–ª–∏ access_token –∏—Å—Ç—ë–∫ –±–æ–ª–µ–µ 1 —á–∞—Å–∞ –Ω–∞–∑–∞–¥,
          // —Ç–æ refresh_token —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —É–∂–µ "Already Used" (RTR)
          // Supabase access_token –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∂–∏–≤—ë—Ç 1 —á–∞—Å
          const now = Math.floor(Date.now() / 1000);
          const bufferSeconds = 60 * 60; // 1 —á–∞—Å –∑–∞–ø–∞—Å –ø–æ—Å–ª–µ expiry
          const isExpired = expiresAt && (now > expiresAt + bufferSeconds);

          if (isExpired) {
            const hoursAgo = Math.round((now - expiresAt) / 3600);
            logCritical(`‚è∞ –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ ${hoursAgo}—á –Ω–∞–∑–∞–¥, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–ª–æ–≥–∏–Ω`);
            // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∏ PIN auth —Ñ–ª–∞–≥
            // –ò–Ω–∞—á–µ —Å–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∏—Ç PIN auth —Ä–µ–∂–∏–º –≤–º–µ—Å—Ç–æ –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞ –≤—Ö–æ–¥–∞
            try {
              localStorage.removeItem('heys_supabase_auth_token');
              localStorage.removeItem('heys_pin_auth_client');
            } catch (_) { }
            return { user: null };
          }

          return { user: storedUser, accessToken, refreshToken, expiresAt };
        } catch (_) {
          return { user: null };
        }
      };

      // ‚úÖ FIX 2025-12-25: Supabase SDK –£–î–ê–õ–Å–ù ‚Äî –≤—Å—è —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.
      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ YandexAPI (heys_yandex_api_v1.js).
      // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ user/status –∏–∑ localStorage.
      if (!_signInInProgress) {
        const restored = restoreSessionFromStorage();

        if (restored.user) {
          // –¢–æ–∫–µ–Ω –µ—Å—Ç—å ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º user/status
          user = restored.user;
          status = CONNECTION_STATUS.SYNC;
          logCritical('üîÑ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', user.email || user.id);
          logCritical('[AUTH] ‚úÖ user —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ restore:', user?.email, '| user:', !!user);

          // üîê v=35 FIX: –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API ‚Äî –í–ö–õ–Æ–ß–ê–ï–ú RPC —Ä–µ–∂–∏–º!
          // Supabase SDK —É–¥–∞–ª—ë–Ω, –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ REST API
          // PIN auth client —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ _pinAuthClientId (—ç—Ç–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ PIN)
          // –Ω–æ _rpcOnlyMode –æ—Å—Ç–∞–≤–ª—è–µ–º = true –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞!
          if (_pinAuthClientId) {
            logCritical('üîê –ö—É—Ä–∞—Ç–æ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º PIN auth clientId, –Ω–æ RPC mode –æ—Å—Ç–∞—ë—Ç—Å—è ON');
            _pinAuthClientId = null;
            try { global.localStorage.removeItem('heys_pin_auth_client'); } catch (_) { }
          }
          // üîÑ RPC —Ä–µ–∂–∏–º –í–ö–õ–Æ–ß–Å–ù –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞ (Yandex API)
          _rpcOnlyMode = true;
          // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º status = ONLINE –∏ –¥–µ–ª–∞–µ–º sync –µ—Å–ª–∏ –µ—Å—Ç—å clientId
          // ‚ö†Ô∏è –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º Supabase SDK (client.auth.setSession) ‚Äî –æ–Ω —É–¥–∞–ª—ë–Ω!
          setTimeout(() => {
            if (_signInInProgress) return;
            status = CONNECTION_STATUS.ONLINE;

            const clientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
            logCritical('[restoreSession] setTimeout fired, clientId:', clientId ? clientId.slice(0, 8) + '...' : 'NULL');
            if (clientId) {
              logCritical('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º bootstrap sync –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', clientId.substring(0, 8) + '...');
              cloud.syncClient(clientId).then(result => {
                const errorText = result?.error || (result?.success === false ? 'unknown_error' : null);
                if (errorText) {
                  logCritical('‚ö†Ô∏è Bootstrap sync failed:', errorText);
                } else {
                  logCritical('‚úÖ Bootstrap sync –∑–∞–≤–µ—Ä—à—ë–Ω');
                }
              }).catch(e => {
                logCritical('‚ö†Ô∏è Bootstrap sync error:', e?.message || e);
              });
            }
          }, 100);
        }
      }

      // ‚ö†Ô∏è Legacy Supabase onAuthStateChange ‚Äî –ü–û–õ–ù–û–°–¢–¨–Æ –û–¢–ö–õ–Æ–ß–Å–ù
      // client = null (Supabase SDK —É–¥–∞–ª—ë–Ω), –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ YandexAPI.
      // –ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ auth events —É–¥–∞–ª—ë–Ω 2025-12-25.

      // üîÑ AUTO-SYNC –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É (visibilitychange)
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è multi-device —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Ç–µ–ª–µ—Ñ–æ–Ω ‚Üî –Ω–æ—É—Ç–±—É–∫)
      let lastSyncOnFocusTime = 0;
      const SYNC_ON_FOCUS_DEBOUNCE = 30000; // –ù–µ —á–∞—â–µ —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ 5 ‚Äî —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ)

      const syncOnFocus = async () => {
        // Debounce: –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
        if (Date.now() - lastSyncOnFocusTime < SYNC_ON_FOCUS_DEBOUNCE) return;
        lastSyncOnFocusTime = Date.now();

        // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
        if (!user || status !== CONNECTION_STATUS.ONLINE) return;

        const clientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
        if (!clientId) return;

        log('[SYNC-ON-FOCUS] üîÑ –í–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');

        try {
          await cloud.bootstrapClientSync(clientId, { silent: true });
          log('[SYNC-ON-FOCUS] ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        } catch (e) {
          log('[SYNC-ON-FOCUS] ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', e?.message || e);
        }
      };

      if (typeof document !== 'undefined') {
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') {
            syncOnFocus();
          }
        });

        // –¢–∞–∫–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ focus –æ–∫–Ω–∞ (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞)
        window.addEventListener('focus', syncOnFocus);

        // üöÄ v10.1: –ì–æ—Ä—è—á–∏–π –ø–æ–¥—Ö–≤–∞—Ç —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –±–µ–∑ reload
        // LoginGate –≤ index.html –¥–∏—Å–ø–∞—Ç—á–∏—Ç —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤–º–µ—Å—Ç–æ location.reload()
        window.addEventListener('heys-auth-ready', function onAuthReady(e) {
          try {
            var detail = e && e.detail || {};
            logCritical('[AUTH] üîë heys-auth-ready received:', detail.mode);

            // –ü–æ–≤—Ç–æ—Ä—è–µ–º restoreSessionFromStorage —á—Ç–æ–±—ã –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            var restored = restoreSessionFromStorage();
            if (restored.user) {
              user = restored.user;
              status = CONNECTION_STATUS.ONLINE;
              _rpcOnlyMode = true;
              logCritical('[AUTH] ‚úÖ Hot session restore:', user.email || user.id);

              // –£–≤–µ–¥–æ–º–ª—è–µ–º React —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
              try {
                window.dispatchEvent(new CustomEvent('heys-session-restored', {
                  detail: { user: user, mode: detail.mode }
                }));
              } catch (_) { }
            } else {
              // –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî fallback reload
              logCritical('[AUTH] ‚ö†Ô∏è No session data found after login, reloading');
              window.location.reload();
            }
          } catch (err) {
            logCritical('[AUTH] ‚ùå heys-auth-ready handler error:', err);
            window.location.reload();
          }
        }, { once: true });
      }

    } catch (e) { err('init failed', e); }
  };

  cloud.signIn = async function (email, password) {
    // üÜï v2.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Yandex Cloud Auth (–Ω–µ Supabase SDK)
    // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å CORS –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 152-–§–ó

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º YandexAPI
    if (!HEYS.YandexAPI) {
      err('YandexAPI not initialized');
      return { error: { message: 'API —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' } };
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π –≤—Ö–æ–¥–∞
    if (!navigator.onLine) {
      status = 'offline';
      return { error: { message: '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É' } };
    }

    // üîÑ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –≤–æ –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞
    if (_signInInProgress) {
      log('[AUTH] ‚è≥ signIn —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∂–¥—ë–º...');
      // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ö–æ–¥–∞ (max 10 —Å–µ–∫)
      for (let i = 0; i < 100 && _signInInProgress; i++) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (user) return { user }; // –í—Ö–æ–¥ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
    }

    _signInInProgress = true;

    try {
      status = 'signin';

      // üßπ –ü–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º —É–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ storage.
      try {
        localStorage.removeItem('heys_supabase_auth_token');
        localStorage.removeItem('sb-ukqolcziqcuplqfgrmsh-auth-token');
      } catch (_) { }

      // üÜï –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à Yandex Cloud Auth endpoint
      const { data, error } = await HEYS.YandexAPI.curatorLogin(email, password);

      if (error) {
        status = 'offline';
        _signInInProgress = false;
        logCritical('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error.message || error);
        return { error };
      }

      if (!data?.user) {
        status = 'offline';
        _signInInProgress = false;
        err('no user after signin');
        return { error: { message: 'no user' } };
      }

      user = data.user;
      logCritical('[AUTH] ‚úÖ user —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', user?.email);

      // üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage (–≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º)
      try {
        const tokenData = {
          access_token: data.access_token,
          refresh_token: null, // –ù–∞—à JWT –Ω–µ –∏–º–µ–µ—Ç refresh token
          expires_at: data.expires_at,
          user: data.user
        };
        const tokenJson = JSON.stringify(tokenData);
        const setFn = originalSetItem || global.localStorage.setItem.bind(global.localStorage);
        setFn('heys_supabase_auth_token', tokenJson);
        logCritical('[AUTH] ‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (Yandex Auth), expires_at:', new Date(data.expires_at * 1000).toISOString());

        // üÜï v2.1: –°–æ—Ö—Ä–∞–Ω—è–µ–º curator session –¥–ª—è TrialQueue –∞–¥–º–∏–Ω–∫–∏
        // heys_trial_queue_v1.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ç–æ—Ç –∫–ª—é—á –¥–ª—è admin API calls
        setFn('heys_curator_session', data.access_token);
        logCritical('[AUTH] ‚úÖ Curator session —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è adminAPI');

        // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
        const check = global.localStorage.getItem('heys_supabase_auth_token');
        if (!check) {
          logCritical('[AUTH] ‚ùå –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê: —Ç–æ–∫–µ–Ω –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ!');
        } else {
          logCritical('[AUTH] ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è OK, —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        }
      } catch (saveErr) {
        logCritical('[AUTH] ‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', saveErr?.message || saveErr);
      }

      status = 'sync';
      await cloud.bootstrapSync();
      status = 'online';

      // üîê v=35 FIX: –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API –í–ö–õ–Æ–ß–ê–ï–ú RPC —Ä–µ–∂–∏–º –¥–ª—è –í–°–ï–•!
      // Supabase SDK –æ—Ç–∫–ª—é—á—ë–Ω, –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ REST API (= RPC —Ä–µ–∂–∏–º)
      // –†–∞–Ω—å—à–µ –±—ã–ª–æ _rpcOnlyMode = false, —á—Ç–æ –ª–æ–º–∞–ª–æ sync (canSync = false)
      _rpcOnlyMode = true;

      // üõ°Ô∏è –ó–∞—â–∏—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º SIGNED_OUT –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ signIn
      _ignoreSignedOutUntil = Date.now() + 10000;

      _signInInProgress = false;
      logCritical('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:', user.email);
      return { user };
    } catch (e) {
      status = 'offline';
      _signInInProgress = false;
      logCritical('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ (exception):', e.message || e);
      return { error: e };
    }
  };

  cloud.signOut = function () {
    // scope: 'local' ‚Äî –æ—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é, –ù–ï –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º refresh token –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
    // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç 400 Bad Request –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ,
    // —Ç.–∫. SDK –≤ –ø–∞–º—è—Ç–∏ –º–æ–≥ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π refresh token.
    if (client) client.auth.signOut({ scope: 'local' });
    user = null;
    status = 'offline';
    if (global.HEYS) {
      global.HEYS.currentClientId = null;
      if (global.HEYS.store?.flushMemory) {
        global.HEYS.store.flushMemory();
      }
    }
    clearNamespace();
    // üîÑ –û—á–∏—Å—Ç–∫–∞ auth —Ç–æ–∫–µ–Ω–∞ ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç 400 Bad Request –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
    try {
      localStorage.removeItem('heys_supabase_auth_token');
      // üÜï v2.1: –û—á–∏—Å—Ç–∫–∞ curator session –¥–ª—è TrialQueue –∞–¥–º–∏–Ω–∫–∏
      localStorage.removeItem('heys_curator_session');
    } catch (e) { }
    // üîÑ –°–±—Ä–æ—Å —Ñ–ª–∞–≥–æ–≤ sync ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –Ω—É–∂–Ω–∞ –Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    initialSyncCompleted = false;
    startFailsafeTimer(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å failsafe –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤—Ö–æ–¥–∞
    // üîÑ –°–±—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∑–∞–Ω–æ–≤–æ
    try {
      localStorage.removeItem('heys_connection_mode');
    } catch (e) { }
    logCritical('üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
  };

  cloud.getUser = function () { return user; };
  cloud.getStatus = function () { return status; };

  /**
   * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π push –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ localStorage –≤ –æ–±–ª–∞–∫–æ
   * –í—ã–∑—ã–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: HEYS.cloud.forcePushProducts()
   */
  cloud.forcePushProducts = async function () {
    const clientId = HEYS.utils?.getCurrentClientId?.() || HEYS.currentClientId;
    if (!clientId) {
      console.error('‚ùå –ù–µ—Ç clientId');
      return { error: 'No clientId' };
    }
    if (!user || !user.id) {
      console.error('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      return { error: 'Not authenticated' };
    }

    const key = `heys_${clientId}_products`;
    const raw = localStorage.getItem(key);
    if (!raw) {
      console.error(`‚ùå –ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ localStorage –ø–æ –∫–ª—é—á—É ${key}`);
      return { error: 'No products in localStorage' };
    }

    let products;
    try {
      products = JSON.parse(raw);
    } catch (e) {
      return { error: 'Parse error' };
    }

    if (!Array.isArray(products) || products.length === 0) {
      return { error: 'Empty products array' };
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
    const valid = products.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0);

    // üîá v4.7.1: Debug –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ YandexAPI
    const { error } = await YandexAPI.from('client_kv_store')
      .upsert({
        user_id: user.id,
        client_id: clientId,
        k: 'heys_products',
        v: valid,
        updated_at: new Date().toISOString()
      }, { onConflict: 'client_id,k' });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      return { error: error.message };
    }

    // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
    return { success: true, count: valid.length, clientId };
  };

  /**
   * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π push –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è –∏–∑ localStorage –≤ –æ–±–ª–∞–∫–æ
   * –í—ã–∑—ã–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: HEYS.cloud.forcePushDay('2025-12-12') –∏–ª–∏ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è
   */
  cloud.forcePushDay = async function (dateStr) {
    const clientId = HEYS.utils?.getCurrentClientId?.() || HEYS.currentClientId;
    if (!clientId) {
      console.error('‚ùå –ù–µ—Ç clientId');
      return { error: 'No clientId' };
    }
    if (!user || !user.id) {
      console.error('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      return { error: 'Not authenticated' };
    }

    // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è
    const date = dateStr || new Date().toISOString().split('T')[0];
    const key = `heys_${clientId}_dayv2_${date}`;
    const raw = localStorage.getItem(key);
    if (!raw) {
      console.error(`‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è –≤ localStorage –ø–æ –∫–ª—é—á—É ${key}`);
      return { error: 'No day data in localStorage' };
    }

    let dayData;
    try {
      dayData = JSON.parse(raw);
    } catch (e) {
      return { error: 'Parse error' };
    }

    // üîá v4.7.1: Debug –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ YandexAPI
    const { error } = await YandexAPI.from('client_kv_store')
      .upsert({
        user_id: user.id,
        client_id: clientId,
        k: `heys_dayv2_${date}`,
        v: dayData,
        updated_at: new Date().toISOString()
      }, { onConflict: 'client_id,k' });

    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      return { error: error.message };
    }

    // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
    return { success: true, date, mealsCount: dayData.meals?.length || 0, clientId };
  };

  /**
   * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π push –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
   * –í—ã–∑—ã–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: HEYS.cloud.forcePushAllDays(7) ‚Äî –∑–∞ –Ω–µ–¥–µ–ª—é
   */
  cloud.forcePushAllDays = async function (daysBack = 7) {
    const clientId = HEYS.utils?.getCurrentClientId?.() || HEYS.currentClientId;
    if (!clientId || !user || !user.id) {
      return { error: 'Not authenticated or no clientId' };
    }

    const results = [];
    for (let i = 0; i < daysBack; i++) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const result = await cloud.forcePushDay(dateStr);
      if (result.success) results.push(dateStr);
    }

    // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
    return { success: true, days: results };
  };

  /**
   * –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ auth-–¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏
   * –í—ã–∑—ã–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: HEYS.cloud.resetAuth()
   */
  cloud.resetAuth = function () {
    try {
      // –û—á–∏—â–∞–µ–º –≤—Å–µ auth-related –∫–ª—é—á–∏
      const keysToRemove = [
        'heys_supabase_auth_token',
        'sb-ukqolcziqcuplqfgrmsh-auth-token',
        'heys_connection_mode',
        'heys_remember_me',
        'heys_saved_email',
        'heys_remember_email'
      ];
      keysToRemove.forEach(key => {
        try { localStorage.removeItem(key); } catch (e) { }
      });

      // –í—ã—Ö–æ–¥–∏–º –∏–∑ Supabase
      if (client && client.auth) {
        client.auth.signOut().catch(() => { });
      }

      user = null;
      status = CONNECTION_STATUS.OFFLINE;

      logCritical('üîÑ Auth –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      return { success: true, message: 'Auth reset. Please reload the page.' };
    } catch (e) {
      console.error('[resetAuth] Error:', e);
      return { error: e.message };
    }
  };

  /**
   * –û—á–∏—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ localStorage (–±–µ–∑ name)
   * –í—ã–∑—ã–≤–∞—Ç—å –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –±–∞–≥–∞ —Å undefined –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
   */
  cloud.cleanupProducts = function () {
    try {
      const clientId = HEYS.utils?.getCurrentClientId?.() || '';
      // –ö–ª—é—á –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ localStorage –≤—Å–µ–≥–¥–∞ heys_{clientId}_products
      const key = clientId ? `heys_${clientId}_products` : 'heys_products';
      const raw = localStorage.getItem(key);

      // –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –±–µ–∑ clientId (legacy)
      if (!raw && clientId) {
        const legacyRaw = localStorage.getItem('heys_products');
        if (legacyRaw) {
          // –ú–∏–≥—Ä–∞—Ü–∏—è: —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–ª—é—á —Å clientId
          try {
            const parsed = JSON.parse(legacyRaw);
            if (Array.isArray(parsed) && parsed.length > 0) {
              localStorage.setItem(key, legacyRaw);
              // üîá v4.7.1: –õ–æ–≥ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á—ë–Ω
            }
          } catch (_) { }
        }
      }

      const finalRaw = localStorage.getItem(key);
      if (!finalRaw) return { cleaned: 0, total: 0 };

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–µ-JSON)
      let products;
      try {
        products = tryParse(finalRaw);
      } catch (parseError) {
        products = null;
      }

      if (!Array.isArray(products)) {
        // –î–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ race condition –ø—Ä–∏ –∑–∞–ø–∏—Å–∏)
        // –ù–ï —É–¥–∞–ª—è–µ–º ‚Äî –ø—É—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–π sync –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç
        console.warn(`‚ö†Ô∏è [CLEANUP] Temporary parse error for ${key}, skipping (will retry)`);
        return { cleaned: 0, total: 0, parseError: true };
      }

      if (!Array.isArray(products)) return { cleaned: 0, total: 0 };

      const before = products.length;
      const cleaned = products.filter(p =>
        p && typeof p.name === 'string' && p.name.trim().length > 0
      );
      const after = cleaned.length;

      if (after < before) {
        localStorage.setItem(key, JSON.stringify(cleaned));
        logCritical(`üßπ [CLEANUP] Removed ${before - after} invalid products (${before} ‚Üí ${after})`);
      }

      return { cleaned: before - after, total: after };
    } catch (e) {
      console.error('[CLEANUP] Error:', e);
      return { error: e.message };
    }
  };

  /**
   * –£–¥–∞–ª—è–µ—Ç orphan –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
   * @param {string[]} orphanNames - —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
   * @returns {Object} —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ { daysAffected, itemsRemoved }
   */
  cloud.cleanupOrphanMealItems = function (orphanNames) {
    if (!Array.isArray(orphanNames) || orphanNames.length === 0) {
      console.warn('[CLEANUP ORPHANS] No orphan names provided');
      return { daysAffected: 0, itemsRemoved: 0 };
    }

    const clientId = HEYS.utils?.getCurrentClientId?.() || '';
    const prefix = clientId ? `heys_${clientId}_dayv2_` : 'heys_dayv2_';
    const orphanSet = new Set(orphanNames.map(n => n.toLowerCase().trim()));

    let daysAffected = 0;
    let itemsRemoved = 0;

    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–ª—é—á–∞–º localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!key || !key.includes('dayv2_')) continue;

      try {
        const raw = localStorage.getItem(key);
        if (!raw) continue;

        const dayData = JSON.parse(raw);
        if (!dayData || !Array.isArray(dayData.meals)) continue;

        let dayModified = false;

        // –§–∏–ª—å—Ç—Ä—É–µ–º items –≤ –∫–∞–∂–¥–æ–º meal
        dayData.meals = dayData.meals.map(meal => {
          if (!meal || !Array.isArray(meal.items)) return meal;

          const beforeCount = meal.items.length;
          meal.items = meal.items.filter(item => {
            const itemName = (item.name || '').toLowerCase().trim();
            const isOrphan = orphanSet.has(itemName);
            if (isOrphan) itemsRemoved++;
            return !isOrphan;
          });

          if (meal.items.length !== beforeCount) {
            dayModified = true;
          }

          return meal;
        });

        // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ meals
        dayData.meals = dayData.meals.filter(meal =>
          meal && Array.isArray(meal.items) && meal.items.length > 0
        );

        if (dayModified) {
          daysAffected++;
          dayData.updatedAt = Date.now();
          localStorage.setItem(key, JSON.stringify(dayData));

          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ
          const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
          if (dateMatch && clientId) {
            const dayKey = `heys_dayv2_${dateMatch[1]}`;
            cloud.saveClientKey(clientId, dayKey, dayData);
          }
        }
      } catch (e) {
        console.warn('[CLEANUP ORPHANS] Error processing', key, e);
      }
    }

    if (itemsRemoved > 0) {
      logCritical(`üßπ [CLEANUP ORPHANS] Removed ${itemsRemoved} orphan items from ${daysAffected} days: ${orphanNames.join(', ')}`);
    } else {
      log(`üßπ [CLEANUP ORPHANS] No orphan items found for: ${orphanNames.join(', ')}`);
    }

    return { daysAffected, itemsRemoved };
  };

  /**
   * –û—á–∏—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –û–ë–õ–ê–ö–ï
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –û–ë–ï —Ç–∞–±–ª–∏—Ü—ã: kv_store –ò client_kv_store
   * –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å –º—É—Å–æ—Ä–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –∏ –ø—É—Å—Ç—ã–µ legacy –∑–∞–ø–∏—Å–∏
   */
  cloud.cleanupCloudProducts = async function () {
    try {
      if (!client || !user) return { error: 'Not authenticated' };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º user.id –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî user –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å null –≤–æ –≤—Ä–µ–º—è async –æ–ø–µ—Ä–∞—Ü–∏–π
      const userId = user.id;
      if (!userId) return { error: 'No userId' };

      const clientId = HEYS.utils?.getCurrentClientId?.() || '';
      if (!clientId) return { error: 'No clientId' };

      let totalCleaned = 0;
      let totalAfter = 0;
      let totalDeleted = 0;
      let totalRecords = 0;

      // ===== 1. –û–ß–ò–°–¢–ö–ê kv_store (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) =====
      const { data: kvData, error: kvError } = await YandexAPI.from('kv_store')
        .select('k,v')
        .eq('user_id', userId)
        .like('k', '%products%');

      if (kvError) {
        logCritical('‚òÅÔ∏è [CLOUD CLEANUP] kv_store error:', kvError.message);
      } else if (kvData && kvData.length > 0) {
        totalRecords += kvData.length;
        for (const row of kvData) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ user –µ—â—ë –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–º–æ–≥ logout –≤–æ –≤—Ä–µ–º—è —Ü–∏–∫–ª–∞)
          if (!user) {
            log('‚òÅÔ∏è [CLOUD CLEANUP] Aborted ‚Äî user logged out');
            return { error: 'User logged out during cleanup' };
          }
          const result = await cleanupProductRecord('kv_store', row, { user_id: userId }, clientId);
          totalCleaned += result.cleaned;
          totalAfter += result.kept;
          if (result.deleted) totalDeleted++;
        }
      }

      // ===== 2. –û–ß–ò–°–¢–ö–ê client_kv_store (–¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞) =====
      const { data: clientData, error: clientError } = await YandexAPI.from('client_kv_store')
        .select('k,v')
        .eq('client_id', clientId)
        .like('k', '%products%');

      if (clientError) {
        logCritical('‚òÅÔ∏è [CLOUD CLEANUP] client_kv_store error:', clientError.message);
      } else if (clientData && clientData.length > 0) {
        totalRecords += clientData.length;
        for (const row of clientData) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ user –µ—â—ë –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–º–æ–≥ logout –≤–æ –≤—Ä–µ–º—è —Ü–∏–∫–ª–∞)
          if (!user) {
            log('‚òÅÔ∏è [CLOUD CLEANUP] Aborted ‚Äî user logged out');
            return { error: 'User logged out during cleanup' };
          }
          const result = await cleanupProductRecord('client_kv_store', row, { client_id: clientId }, clientId);
          totalCleaned += result.cleaned;
          totalAfter += result.kept;
          if (result.deleted) totalDeleted++;
        }
      }

      // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π
      if (totalDeleted > 0 || totalCleaned > 0) {
        logCritical(`‚òÅÔ∏è [CLOUD CLEANUP] Done: ${totalRecords} records, deleted ${totalDeleted} empty, cleaned ${totalCleaned} invalid, kept ${totalAfter} valid`);
      } else if (totalRecords > 0) {
        log(`‚òÅÔ∏è [CLOUD CLEANUP] OK: ${totalRecords} records, ${totalAfter} products`);
      }

      return { cleaned: totalCleaned, deleted: totalDeleted, total: totalAfter };
    } catch (e) {
      console.error('[CLOUD CLEANUP] Error:', e);
      return { error: e.message };
    }
  };

  /**
   * –•–µ–ª–ø–µ—Ä: –æ—á–∏—Å—Ç–∫–∞ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * - –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å 0 –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ (–º—É—Å–æ—Ä)
   * - –£–¥–∞–ª—è–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –∑–∞–ø–∏—Å–µ–π
   * - –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º –¥–ª—è OK –∑–∞–ø–∏—Å–µ–π
   */
  async function cleanupProductRecord(table, row, filters, clientId) {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç race condition –ø—Ä–∏ logout
    if (!client || !user) {
      return { cleaned: 0, kept: 0, error: 'Not authenticated' };
    }

    // üîß FIX 2025-12-26: –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ–º row.v –µ—Å–ª–∏ —ç—Ç–æ —Å–∂–∞—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
    let products = row.v;
    const Store = global.HEYS?.store;
    if (typeof products === 'string' && products.startsWith('¬§Z¬§')) {
      try {
        if (Store && typeof Store.decompress === 'function') {
          products = Store.decompress(products);
        }
      } catch (e) {
        logCritical(`‚ö†Ô∏è [DECOMPRESS] Failed in cleanupProductRecord: ${e.message}`);
      }
    }

    // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤ ‚Äî —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
    if (!Array.isArray(products) || products.length === 0) {
      // –°—Ç—Ä–æ–∏–º filters –æ–±—ä–µ–∫—Ç –¥–ª—è YandexAPI.rest()
      const deleteFilters = {};
      for (const [key, val] of Object.entries(filters)) {
        deleteFilters[`eq.${key}`] = val;
      }
      deleteFilters['eq.k'] = row.k;

      const { error: deleteError } = await YandexAPI.rest(table, { method: 'DELETE', filters: deleteFilters });

      if (!deleteError) {
        logCritical(`‚òÅÔ∏è [CLOUD CLEANUP] DELETED empty ${table}.${row.k}`);
      }
      return { cleaned: 0, kept: 0, deleted: true };
    }

    const before = products.length;
    const cleaned = products.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0);
    const after = cleaned.length;

    // –í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤–∞–ª–∏–¥–Ω—ã–µ ‚Äî —Ç–∏—Ö–∏–π OK (–Ω–µ –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å)
    if (after === before) {
      return { cleaned: 0, kept: after };
    }

    // üö® –ï—Å–ª–∏ –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ ‚Äî —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é!
    if (after === 0) {
      // –°—Ç—Ä–æ–∏–º filters –æ–±—ä–µ–∫—Ç –¥–ª—è YandexAPI.rest()
      const deleteFilters = {};
      for (const [key, val] of Object.entries(filters)) {
        deleteFilters[`eq.${key}`] = val;
      }
      deleteFilters['eq.k'] = row.k;

      const { error: deleteError } = await YandexAPI.rest(table, { method: 'DELETE', filters: deleteFilters });

      if (deleteError) {
        logCritical(`‚òÅÔ∏è [CLOUD CLEANUP] Failed to delete ${table}.${row.k}:`, deleteError.message);
        return { cleaned: 0, kept: 0 };
      } else {
        logCritical(`‚òÅÔ∏è [CLOUD CLEANUP] DELETED garbage ${table}.${row.k} (had ${before} invalid)`);
        return { cleaned: before, kept: 0, deleted: true };
      }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
    const upsertData = {
      ...filters,
      k: table === 'client_kv_store' && clientId ? normalizeKeyForSupabase(row.k, clientId) : row.k,
      v: cleaned,
      updated_at: new Date().toISOString()
    };
    // client_kv_store —Ç—Ä–µ–±—É–µ—Ç client_id
    if (table === 'client_kv_store' && !upsertData.client_id) {
      upsertData.client_id = clientId;
    }

    const onConflict = table === 'kv_store' ? 'user_id,k' : 'client_id,k';
    const { error: upsertError } = await YandexAPI.from(table).upsert(upsertData, { onConflict });

    if (upsertError) {
      logCritical(`‚òÅÔ∏è [CLOUD CLEANUP] Failed to save ${table}.${row.k}:`, upsertError.message);
      return { cleaned: 0, kept: after };
    } else {
      logCritical(`‚òÅÔ∏è [CLOUD CLEANUP] ${table}.${row.k}: Cleaned ${before - after} invalid (${before} ‚Üí ${after})`);
      return { cleaned: before - after, kept: after };
    }
  }

  cloud.bootstrapSync = async function () {
    try {
      muteMirror = true;
      if (!client || !user) { muteMirror = false; return; }

      // üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
      cloud.cleanupProducts();

      // üá∑üá∫ –ò—Å–ø–æ–ª—å–∑—É–µ–º Yandex API –≤–º–µ—Å—Ç–æ Supabase (152-–§–ó compliant)
      const YandexAPI = global.HEYS?.YandexAPI;
      if (!YandexAPI) {
        err('bootstrapSync: YandexAPI not loaded');
        muteMirror = false;
        return;
      }

      const { data, error } = await YandexAPI.from('kv_store').select('k,v,updated_at');

      // Graceful degradation: –µ—Å–ª–∏ —Å–µ—Ç—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å localStorage
      if (error) {
        if (error.isNetworkFailure) {
          console.warn('[HEYS.cloud] üì¥ bootstrapSync: —Ä–∞–±–æ—Ç–∞–µ–º offline —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
        } else {
          err('bootstrap select', error);
        }
        muteMirror = false;
        return;
      }
      const ls = global.localStorage;

      // üîí –§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–ª–∏ –∫–ª—é—á–∏ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
      // kv_store —Å–æ–¥–µ—Ä–∂–∏—Ç legacy –¥–∞–Ω–Ω—ã–µ —Å clientId –≤–Ω—É—Ç—Ä–∏ –∫–ª—é—á–∞ ‚Äî –∏—Ö –Ω—É–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
      const currentClientId = ls.getItem('heys_client_current');
      let parsedClientId = null;
      try { parsedClientId = currentClientId ? JSON.parse(currentClientId) : null; } catch (e) { parsedClientId = currentClientId; }

      const uuidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi;

      // clear only global keys for full bootstrap (no clientId)
      clearNamespace();

      let loadedCount = 0;
      let skippedCount = 0;

      (data || []).forEach(row => {
        try {
          const key = row.k;

          // üîê –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º auth —Ç–æ–∫–µ–Ω –∏–∑ –æ–±–ª–∞–∫–∞!
          // Auth —Ç–æ–∫–µ–Ω —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ —Å–≤–µ–∂–∏–º expires_at –ø–æ—Å–ª–µ signIn.
          // –¢–æ–∫–µ–Ω –≤ –æ–±–ª–∞–∫–µ –∏–º–µ–µ—Ç —Å—Ç–∞—Ä—ã–π expires_at ‚Üí –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Å–≤–µ–∂–∏–π ‚Üí –æ—à–∏–±–∫–∞ –ø—Ä–∏ reload.
          if (key === 'heys_supabase_auth_token') {
            logCritical('‚è≠Ô∏è [BOOTSTRAP] Skipping auth token from cloud (use local fresh token)');
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º: —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∫–ª—é—á UUID (clientId)?
          const uuids = key.match(uuidPattern);

          if (uuids && uuids.length > 0) {
            // –ö–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç UUID ‚Äî —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ UUID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –∫–ª–∏–µ–Ω—Ç–æ–º
            const hasCurrentClient = parsedClientId && uuids.some(id =>
              id.toLowerCase() === parsedClientId.toLowerCase()
            );

            if (!hasCurrentClient) {
              // –ß—É–∂–æ–π –∫–ª–∏–µ–Ω—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
              skippedCount++;
              return;
            }
          }

          // üîß FIX 2025-12-26: –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ cloud
          // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –æ—à–∏–±–æ—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Å–∂–∞—Ç–æ–º –≤–∏–¥–µ ‚Äî –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ–º
          let valueToStore = row.v;
          if (typeof row.v === 'string' && row.v.startsWith('¬§Z¬§')) {
            const Store = global.HEYS?.store;
            if (Store && typeof Store.decompress === 'function') {
              valueToStore = Store.decompress(row.v);
              log(`üîß [BOOTSTRAP] Decompressed ${key} from cloud`);
            }
          }

          // üõ°Ô∏è v61 FIX: –ó–∞—â–∏—Ç–∞ dayv2 –æ—Ç –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–Ω–∏—è –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
          const isDayKey = key.includes('dayv2_');
          if (isDayKey) {
            const existingRaw = ls.getItem(key);
            if (existingRaw) {
              try {
                const existing = JSON.parse(existingRaw);
                const localMeaningful = isMeaningfulDayData(existing);
                const remoteMeaningful = isMeaningfulDayData(valueToStore);

                if (localMeaningful && !remoteMeaningful) {
                  logCritical(`üõ°Ô∏è [BOOTSTRAP] KEEP LOCAL: meaningful local, empty remote for ${key}`);
                  return;
                }

                const localMealsCount = Array.isArray(existing?.meals) ? existing.meals.length : 0;
                const remoteMealsCount = Array.isArray(valueToStore?.meals) ? valueToStore.meals.length : 0;
                if (localMealsCount > remoteMealsCount) {
                  logCritical(`üõ°Ô∏è [BOOTSTRAP] KEEP LOCAL: local has MORE meals (${localMealsCount} > ${remoteMealsCount}) for ${key}`);
                  return;
                }

                const existingUpdatedAt = existing?.updatedAt || 0;
                const incomingUpdatedAt = valueToStore?.updatedAt || 0;
                if (existingUpdatedAt > incomingUpdatedAt) {
                  logCritical(`üõ°Ô∏è [BOOTSTRAP] KEEP LOCAL: local is newer (${existingUpdatedAt} > ${incomingUpdatedAt}) for ${key}`);
                  return;
                }

                backupDayV2BeforeOverwrite(key, valueToStore, 'bootstrap');
              } catch (_) { }
            }
          }

          // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏–ª–∏ –∫–ª—é—á —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º
          ls.setItem(key, JSON.stringify(valueToStore));
          loadedCount++;
        } catch (e) { }
      });

      if (skippedCount > 0) {
        logCritical(`üîí [BOOTSTRAP] Loaded ${loadedCount} keys, skipped ${skippedCount} foreign client keys`);
      }

      muteMirror = false;
    } catch (e) { err('bootstrap exception', e); muteMirror = false; }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîê SYNC VIA YANDEX API ‚Äî –¥–ª—è –≤—Ö–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É+PIN (–†–§ 152-–§–ó)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Yandex API (–±–µ–∑ Supabase —Å–µ—Å—Å–∏–∏)
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ PIN –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} clientId - UUID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {Object} options - { force: boolean }
   * @returns {Promise<{success: boolean, loaded?: number, error?: string}>}
   */
  cloud.syncClientViaRPC = async function (clientId, options = {}) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è 152-–§–ó
    const YandexAPI = global.HEYS?.YandexAPI;
    if (!YandexAPI) {
      logCritical('‚ùå [YANDEX SYNC] YandexAPI not loaded!');
      return { success: false, error: 'yandex_api_not_loaded' };
    }

    if (!clientId) {
      return { success: false, error: 'no_client_id' };
    }

    if (!options?.force && typeof cloud.isSyncPaused === 'function' && cloud.isSyncPaused()) {
      return { success: false, error: 'sync_paused' };
    }

    const ls = global.localStorage;

    try {
      const syncStartTime = performance.now();
      logCritical(`üá∑üá∫ [YANDEX SYNC] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ ${clientId.slice(0, 8)}...`);

      // üî¥ CRITICAL FIX: –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ!
      // –ë–µ–∑ —ç—Ç–æ–≥–æ syncClientViaRPC —É–¥–∞–ª–∏—Ç –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ localStorage
      const pendingCount = cloud.getPendingCount?.() || 0;
      if (pendingCount > 0 || _uploadInProgress) {
        logCritical(`üîÑ [YANDEX SYNC] Flushing ${pendingCount} pending items (uploadInProgress: ${_uploadInProgress}) BEFORE download`);
        await cloud.flushPendingQueue?.(10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–ø–∏—Å–∏ –≤ –æ–±–ª–∞–∫–æ
        await new Promise(r => setTimeout(r, 200));
        logCritical(`‚úÖ [YANDEX SYNC] Flush completed`);
      }

      // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –æ –Ω–∞—á–∞–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      if (typeof window !== 'undefined' && window.dispatchEvent) {
        window.dispatchEvent(new CustomEvent('heysSyncStarting', { detail: { clientId } }));
      }

      // üöÄ Delta Sync: –µ—Å–ª–∏ –µ—Å—Ç—å last_sync_ts ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      const lastSyncKey = `heys_${clientId}_last_sync_ts`;
      const lastSyncTs = ls.getItem(lastSyncKey);
      const since = (lastSyncTs && !options?.force) ? lastSyncTs : null;
      if (since) {
        logCritical(`üöÄ [DELTA SYNC] Using delta mode since ${since}`);
      }

      // –í—ã–∑—ã–≤–∞–µ–º Yandex REST API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–≤–º–µ—Å—Ç–æ Supabase RPC)
      const { data, error, delta: isDelta } = await YandexAPI.getAllKV(clientId, { since });

      if (error) {
        logCritical(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error}`);

        // üîî v59 FIX G: Dispatch heysSyncCompleted on early-return error path
        // getAllKV catches 502 internally and returns { error } ‚Äî catch block never fires.
        // Without this dispatch, UI (cascade, skeleton) stays in loading state forever.
        if (typeof window !== 'undefined' && window.dispatchEvent) {
          window.dispatchEvent(new CustomEvent('heysSyncCompleted', {
            detail: { clientId, error: true, loaded: 0, viaYandex: true, phase: 'full' }
          }));
        }

        return { success: false, error: error };
      }

      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
      muteMirror = true;
      let loadedCount = 0;

      // –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–ª—é—á–∏ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–µ—à–∏—Ç—å –æ—á–∏—Å—Ç–∫—É
      const prefix = `heys_${clientId}_`;
      const keysToRemove = [];
      for (let i = 0; i < ls.length; i++) {
        const key = ls.key(i);
        if (key && key.startsWith(prefix)) {
          keysToRemove.push(key);
        }
      }

      // –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π, –ø—Ä–∏—à–µ–¥—à–∏—Ö –∏–∑ –æ–±–ª–∞–∫–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
      const remoteKeys = new Set((data || []).map(row => row?.k).filter(Boolean));
      const hasRemoteProfile = remoteKeys.has('heys_profile');

      // üõ°Ô∏è SAFE MODE: –ù–ï —á–∏—Å—Ç–∏–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏.
      // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –ø—Ä–∏—à–ª–∏ –∏–∑ –æ–±–ª–∞–∫–∞.
      const hasRemoteData = Array.isArray(data) && data.length > 0;
      if (!hasRemoteData) {
        logCritical(`‚ö†Ô∏è [YANDEX SYNC] Remote empty, local keys preserved (${keysToRemove.length})`);
      }

      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–±–∏—Ä–∞–µ–º –∫–ª—é—á–∏ –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
      const syncedKeys = [];
      (data || []).forEach(row => {
        try {
          // –ö–ª—é—á–∏ –≤ client_kv_store —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã (heys_profile, heys_dayv2_2025-12-12)
          // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å clientId –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
          const localKey = `heys_${clientId}_${row.k.replace(/^heys_/, '')}`;

          // üîß FIX 2025-12-26: –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ cloud
          // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –æ—à–∏–±–æ—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Å–∂–∞—Ç–æ–º –≤–∏–¥–µ ‚Äî –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ–º
          let valueToStore = row.v;
          if (typeof row.v === 'string' && row.v.startsWith('¬§Z¬§')) {
            const Store = global.HEYS?.store;
            if (Store && typeof Store.decompress === 'function') {
              valueToStore = Store.decompress(row.v);
              log(`üîß [YANDEX SYNC] Decompressed ${row.k} from cloud`);
            }
          }

          // üõ°Ô∏è v64 FIX: –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º null/undefined dayv2 –≤ localStorage
          // Cloud –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å row.v = null ‚Üí JSON.stringify(null) = "null" ‚Üí getDayData –ª–æ–º–∞–µ—Ç—Å—è
          const isDayKey = localKey.includes('dayv2_');
          if (isDayKey && (valueToStore == null || valueToStore === 'null')) {
            logCritical(`üõ°Ô∏è [YANDEX SYNC] SKIP NULL dayv2: ${localKey}`);
            return; // skip this row ‚Äî null data corrupts getDayData
          }

          // üõ°Ô∏è v61 FIX: –ó–∞—â–∏—Ç–∞ dayv2 –æ—Ç –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–Ω–∏—è –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ bootstrapClientSync)
          if (isDayKey) {
            const existingRaw = ls.getItem(localKey);
            if (existingRaw) {
              try {
                const existing = JSON.parse(existingRaw);
                const localMeaningful = isMeaningfulDayData(existing);
                const remoteMeaningful = isMeaningfulDayData(valueToStore);

                // –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º meaningful –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–º remote
                if (localMeaningful && !remoteMeaningful) {
                  logCritical(`üõ°Ô∏è [YANDEX SYNC] KEEP LOCAL: meaningful local, empty remote for ${localKey}`);
                  return; // skip this row
                }

                // –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –µ—Å–ª–∏ local –∏–º–µ–µ—Ç –ë–û–õ–¨–®–ï meals
                const localMealsCount = Array.isArray(existing?.meals) ? existing.meals.length : 0;
                const remoteMealsCount = Array.isArray(valueToStore?.meals) ? valueToStore.meals.length : 0;
                if (localMealsCount > remoteMealsCount) {
                  logCritical(`üõ°Ô∏è [YANDEX SYNC] KEEP LOCAL: local has MORE meals (${localMealsCount} > ${remoteMealsCount}) for ${localKey}`);
                  return; // skip this row
                }

                // –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –µ—Å–ª–∏ local –Ω–æ–≤–µ–µ –ø–æ timestamp
                const existingUpdatedAt = existing?.updatedAt || 0;
                const incomingUpdatedAt = valueToStore?.updatedAt || 0;
                if (existingUpdatedAt > incomingUpdatedAt) {
                  logCritical(`üõ°Ô∏è [YANDEX SYNC] KEEP LOCAL: local is newer (${existingUpdatedAt} > ${incomingUpdatedAt}) for ${localKey}`);
                  return; // skip this row
                }

                // üß∑ Backup –ø–µ—Ä–µ–¥ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é
                backupDayV2BeforeOverwrite(localKey, valueToStore, 'yandex-sync');
              } catch (_) { }
            }
          }

          ls.setItem(localKey, JSON.stringify(valueToStore));
          syncedKeys.push(row.k); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
          loadedCount++;
        } catch (e) {
          console.warn('[YANDEX SYNC] Failed to save key:', row.k, e);
        }
      });

      muteMirror = false;

      // üßπ –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –æ—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      try {
        const profileKey = `heys_${clientId}_profile`;
        const rawProfile = ls.getItem(profileKey);
        if (rawProfile) {
          const parsedProfile = JSON.parse(rawProfile);
          if (parsedProfile?.profileCompleted === true) {
            localStorage.removeItem('heys_registration_in_progress');
          }
        }
      } catch (_) { }

      // üîÑ CRITICAL: –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º memory cache –¥–ª—è –≤—Å–µ—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π
      // –ë–µ–∑ —ç—Ç–æ–≥–æ Store.get() –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏
      if (global.HEYS && global.HEYS.store && global.HEYS.store.invalidate) {
        syncedKeys.forEach(k => {
          global.HEYS.store.invalidate(k);
        });
        logCritical(`üóëÔ∏è [YANDEX SYNC] –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω –∫—ç—à –¥–ª—è ${syncedKeys.length} –∫–ª—é—á–µ–π`);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      cloud._lastClientSync = { clientId, ts: Date.now(), viaYandex: true };

      // üîê –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ currentClientId –≤—ã—Å—Ç–∞–≤–ª–µ–Ω (–≤–∞–∂–Ω–æ –¥–ª—è scoped store.get)
      try {
        if (global.HEYS) {
          if (!global.HEYS.currentClientId || global.HEYS.currentClientId !== clientId) {
            global.HEYS.currentClientId = clientId;
          }
        }
        const storedCurrent = localStorage.getItem('heys_client_current');
        if (!storedCurrent) {
          localStorage.setItem('heys_client_current', JSON.stringify(clientId));
        }
      } catch (_) { }

      // –ü–æ–º–µ—á–∞–µ–º initial sync –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∏ –æ—Ç–º–µ–Ω—è–µ–º failsafe
      if (!initialSyncCompleted) {
        initialSyncCompleted = true;
        cancelFailsafeTimer(); // üîê –û—Ç–º–µ–Ω—è–µ–º failsafe ‚Äî sync —É—Å–ø–µ—à–µ–Ω
      }

      logCritical(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} –∫–ª—é—á–µ–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${clientId.slice(0, 8)}`);
      const syncDuration = Math.round(performance.now() - syncStartTime);
      logCritical(`‚úÖ [SYNC DONE] client=${clientId.slice(0, 8)} keys=${loadedCount} ms=${syncDuration} via=rpc${isDelta ? ' (delta)' : ' (full)'}`);

      // üöÄ Delta Sync: —Å–æ—Ö—Ä–∞–Ω—è–µ–º timestamp –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ delta sync
      try {
        ls.setItem(`heys_${clientId}_last_sync_ts`, new Date().toISOString());
      } catch (_) { }

      // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      // üÜï PERF v9.2: Yandex full sync –∑–∞–≤–µ—Ä—à—ë–Ω
      window.__heysPerfMark && window.__heysPerfMark('heysSyncCompleted: viaYandex dispatch');
      if (typeof window !== 'undefined' && window.dispatchEvent) {
        window.dispatchEvent(new CustomEvent('heysSyncCompleted', {
          detail: { clientId, loaded: loadedCount, viaYandex: true, phase: 'full' }
        }));
      }

      return { success: true, loaded: loadedCount };

    } catch (e) {
      muteMirror = false;
      logCritical(`‚ùå [YANDEX SYNC] Exception: ${e.message}`);

      // üîî v58 FIX: Dispatch heysSyncCompleted even on error
      // Without this, UI (cascade, skeleton) stays in loading state forever
      // when sync fails ‚Äî it only received the event on success path.
      if (typeof window !== 'undefined' && window.dispatchEvent) {
        window.dispatchEvent(new CustomEvent('heysSyncCompleted', {
          detail: { clientId, error: true, loaded: 0, viaYandex: true, phase: 'full' }
        }));
      }

      return { success: false, error: e.message };
    }
  };

  /**
   * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Yandex API (–±–µ–∑ auth.uid())
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –≤–æ—à–µ–¥—à–∏—Ö –ø–æ PIN
   * @param {string} clientId - UUID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {Array<{k: string, v: any, updated_at?: string}>} items - –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   * @returns {Promise<{success: boolean, saved?: number, error?: string}>}
   */
  cloud.saveClientViaRPC = async function (clientId, items) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –≤–º–µ—Å—Ç–æ Supabase
    const YandexAPI = global.HEYS?.YandexAPI;
    if (!YandexAPI) {
      logCritical('‚ùå [YANDEX SAVE] YandexAPI not loaded!');
      return { success: false, error: 'yandex_api_not_loaded' };
    }

    if (!clientId || !items || items.length === 0) {
      return { success: false, error: 'invalid_params' };
    }

    try {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º items –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è YandexAPI
      const yandexItems = items.map(item => ({
        k: normalizeKeyForSupabase(item.k, clientId),
        v: item.v,
        updated_at: item.updated_at || new Date().toISOString()
      }));

      // üîß –õ–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      const jsonSize = JSON.stringify(yandexItems).length;
      const jsonSizeKB = Math.round(jsonSize / 1024);

      if (jsonSize > 100000) {
        logCritical(`‚ö†Ô∏è [YANDEX SAVE] Large payload: ${jsonSizeKB}KB, ${yandexItems.length} items`);
      }

      // üîß –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (>500KB) –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
      if (jsonSize > 500000) {
        logCritical(`üö® [YANDEX SAVE] VERY LARGE payload: ${jsonSizeKB}KB ‚Äî splitting into chunks`);
      }

      // üöÄ PERF: Split large payloads into chunks to prevent timeouts
      const CHUNK_MAX_BYTES = 100 * 1024; // 100KB per chunk
      if (jsonSize > CHUNK_MAX_BYTES) {
        const chunks = [];
        let currentChunk = [];
        let currentSize = 2; // account for []
        for (const item of yandexItems) {
          const itemSize = JSON.stringify(item).length + 1; // +1 for comma
          if (currentSize + itemSize > CHUNK_MAX_BYTES && currentChunk.length > 0) {
            chunks.push(currentChunk);
            currentChunk = [];
            currentSize = 2;
          }
          currentChunk.push(item);
          currentSize += itemSize;
        }
        if (currentChunk.length > 0) chunks.push(currentChunk);

        logCritical(`üì¶ [YANDEX SAVE] Split ${jsonSizeKB}KB payload into ${chunks.length} chunks`);
        let totalSaved = 0;
        for (let ci = 0; ci < chunks.length; ci++) {
          const chunkResult = await YandexAPI.batchSaveKV(clientId, chunks[ci]);
          if (!chunkResult.success) {
            logCritical(`‚ùå [YANDEX SAVE] Chunk ${ci + 1}/${chunks.length} failed: ${chunkResult.error}`);
            return { success: false, error: chunkResult.error, saved: totalSaved };
          }
          totalSaved += chunkResult.saved || chunks[ci].length;
        }
        logCritical(`‚òÅÔ∏è [YANDEX SAVE] Chunked save complete: ${totalSaved} records (${chunks.length} chunks, ${jsonSizeKB}KB) for ${clientId.slice(0, 8)}`);
        return { success: true, saved: totalSaved };
      }

      // üÜï –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI.batchSaveKV –≤–º–µ—Å—Ç–æ RPC
      const result = await YandexAPI.batchSaveKV(clientId, yandexItems);

      if (!result.success) {
        logCritical(`‚ùå [YANDEX SAVE] –û—à–∏–±–∫–∞: ${result.error || 'Unknown error'}`);
        return { success: false, error: result.error || 'Unknown error' };
      }

      logCritical(`‚òÅÔ∏è [YANDEX SAVE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${result.saved} –∑–∞–ø–∏—Å–µ–π (${jsonSizeKB}KB) –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${clientId.slice(0, 8)}`);
      return { success: true, saved: result.saved };

    } catch (e) {
      logCritical(`‚ùå [YANDEX SAVE] Exception: ${e.message}`);
      return { success: false, error: e.message };
    }
  };

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´–¥–µ–Ω—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ¬ª
  const isMeaningfulDayData = (data) => {
    if (!data || typeof data !== 'object') return false;
    const mealsCount = Array.isArray(data.meals) ? data.meals.length : 0;
    const trainingsCount = Array.isArray(data.trainings) ? data.trainings.length : 0;
    if (mealsCount > 0 || trainingsCount > 0) return true;
    if ((data.waterMl || 0) > 0) return true;
    if ((data.steps || 0) > 0) return true;
    if ((data.weightMorning || 0) > 0) return true;
    if (data.sleepStart || data.sleepEnd || data.sleepQuality || data.sleepNote) return true;
    if (data.dayScore || data.moodAvg || data.wellbeingAvg || data.stressAvg) return true;
    if (data.moodMorning || data.wellbeingMorning || data.stressMorning) return true;
    if (data.householdMin || (Array.isArray(data.householdActivities) && data.householdActivities.length > 0)) return true;
    if (data.isRefeedDay || data.refeedReason) return true;
    if (data.cycleDay !== null && data.cycleDay !== undefined) return true;
    if (data.deficitPct !== null && data.deficitPct !== undefined && data.deficitPct !== '') return true;
    if ((Array.isArray(data.supplementsPlanned) && data.supplementsPlanned.length > 0) ||
      (Array.isArray(data.supplementsTaken) && data.supplementsTaken.length > 0)) return true;
    return false;
  };

  /**
   * üß∑ Backup dayv2 before overwriting with remote data
   * –•—Ä–∞–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ race condition
   * Backup-–∫–ª—é—á–∏ –ù–ï –∑–µ—Ä–∫–∞–ª–∏—Ä—É—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ (—Å–º. interceptSetItem)
   */
  function backupDayV2BeforeOverwrite(key, incomingValue, source = 'sync') {
    try {
      if (!key || !key.includes('dayv2_') || key.includes('dayv2_backup_')) return;

      const ls = global.localStorage;
      const existingRaw = ls.getItem(key);
      if (!existingRaw) return;

      const existing = tryParse(existingRaw);
      if (!isMeaningfulDayData(existing)) return;

      const incomingMeaningful = isMeaningfulDayData(incomingValue);
      const existingUpdatedAt = existing?.updatedAt || 0;
      const incomingUpdatedAt = incomingValue?.updatedAt || 0;
      const existingMeals = Array.isArray(existing?.meals) ? existing.meals.length : 0;
      const incomingMeals = Array.isArray(incomingValue?.meals) ? incomingValue.meals.length : 0;

      // –ë—ç–∫–∞–ø –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ incoming –≤—ã–≥–ª—è–¥–∏—Ç ¬´—Ö—É–∂–µ¬ª –∏–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ
      const shouldBackup = !incomingMeaningful || incomingMeals < existingMeals || incomingUpdatedAt < existingUpdatedAt;
      if (!shouldBackup) return;

      const backupKey = key.replace('dayv2_', 'dayv2_backup_');
      const existingBackupRaw = ls.getItem(backupKey);
      if (existingBackupRaw) {
        try {
          const existingBackup = tryParse(existingBackupRaw);
          const lastTs = existingBackup?.ts || 0;
          const lastUpdatedAt = existingBackup?.localUpdatedAt || 0;
          if (Date.now() - lastTs < 5 * 60 * 1000 && lastUpdatedAt === existingUpdatedAt) {
            return; // –Ω–µ –ø–ª–æ–¥–∏–º —á–∞—Å—Ç—ã–µ –±—ç–∫–∞–ø—ã
          }
        } catch (_) { }
      }

      const payload = {
        ts: Date.now(),
        source,
        localUpdatedAt: existingUpdatedAt,
        incomingUpdatedAt,
        localMeals: existingMeals,
        incomingMeals,
        data: existing,
      };

      safeSetItem(backupKey, JSON.stringify(payload));
      logCritical(`üß∑ [DAYV2 BACKUP] Saved ${backupKey} (${existingMeals} meals) before overwrite | source=${source}`);
    } catch (e) { }
  }

  // –§–ª–∞–≥ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ bootstrapClientSync
  let _syncInProgress = null; // null | Promise
  // options.force = true ‚Äî bypass throttling (–¥–ª—è pull-to-refresh)
  cloud.bootstrapClientSync = async function (client_id, options) {
    console.info(`[HEYS.sync] üöÄ –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${client_id?.slice(0, 8)}...`);

    // üîê PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ user, –µ—Å–ª–∏ client_id –ø—Ä–æ–≤–µ—Ä–µ–Ω —á–µ—Ä–µ–∑ verify_client_pin
    const isPinAuth = _pinAuthClientId && _pinAuthClientId === client_id;

    // v60: PIN clients now use bootstrapClientSync (paginated REST).
    // Old guard (_rpcOnlyMode && isPinAuth ‚Üí skip) removed.
    // Deduplication handled by _syncInProgress + _syncInFlight in syncClient().

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–µ–Ω client_id
    // üîß FIX 2025-12-24: –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `client` ‚Äî –¥–ª—è Yandex API —Ä–µ–∂–∏–º–∞ client=null
    // –î–ª—è PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω—É–∂–µ–Ω user, –¥–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞ ‚Äî –Ω—É–∂–µ–Ω user —á–µ—Ä–µ–∑ YandexAPI
    if (!client_id) {
      log('[SYNC] Skipping ‚Äî no client_id');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –ª–∏–±–æ PIN auth, –ª–∏–±–æ curator (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è user)
    // üîß FIX 2025-12-24: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `user` –∏–∑ scope (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ signIn)
    const hasAuth = isPinAuth || user;
    if (!hasAuth) {
      console.warn('[HEYS.sync] ‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ ‚Äî –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      return;
    }

    console.info('[HEYS.sync] ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞');

    // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –µ—Å–ª–∏ sync —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –∂–¥—ë–º –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    if (_syncInProgress) {
      log('sync already in progress, waiting...');
      return _syncInProgress;
    }

    // üîÑ v5: –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ sync –Ω–∞—á–∞–ª—Å—è (–¥–ª—è failsafe –ª–æ–≥–∏–∫–∏)
    _syncEverStarted = true;

    // üîÑ v5: Smart failsafe reset ‚Äî –µ—Å–ª–∏ failsafe —Å—Ç—Ä–µ–ª—å–Ω—É–ª –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
    // (–¥–æ –Ω–∞—á–∞–ª–∞ sync), —Ç–æ initialSyncCompleted = true –æ—à–∏–±–æ—á–Ω–æ.
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ sync
    cancelFailsafeTimer();
    if (initialSyncCompleted && !cloud._lastClientSync) {
      // FAILSAFE fired during script loading (before any sync completed) ‚Üí reset
      logCritical('üîÑ [FAILSAFE] Resetting premature failsafe (fired before sync started)');
      initialSyncCompleted = false;
    }
    // –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ–º sync-specific failsafe (30 —Å–µ–∫ –Ω–∞ —Å–∞–º sync)
    if (!initialSyncCompleted) {
      failsafeTimerId = setTimeout(() => {
        if (!initialSyncCompleted) {
          logCritical('‚ö†Ô∏è [FAILSAFE] Sync timeout (30s) ‚Äî enabling saves');
          initialSyncCompleted = true;
        }
      }, 30000);
    }

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    let currentClientId = global.localStorage.getItem('heys_client_current');
    // –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    if (currentClientId) {
      try {
        currentClientId = JSON.parse(currentClientId);
      } catch (e) {
        // –£–∂–µ –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –Ω–µ JSON
      }
    }
    if (currentClientId && client_id !== currentClientId) {
      log('client bootstrap skipped (not current client)', client_id, 'current:', currentClientId);
      return;
    }

    const now = Date.now();

    // Throttling 15 —Å–µ–∫—É–Ω–¥ ‚Äî –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –Ω–∞–≥—Ä—É–∑–∫–æ–π –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö
    // 5 —Å–µ–∫ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ ‚Äî 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤—ã–∑—ã–≤–∞—é—Ç sync –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const SYNC_THROTTLE_MS = 15000;
    const forceSync = options && options.force;
    if (!forceSync && typeof cloud.isSyncPaused === 'function' && cloud.isSyncPaused()) {
      return;
    }
    if (!forceSync && cloud._lastClientSync && cloud._lastClientSync.clientId === client_id && (now - cloud._lastClientSync.ts) < SYNC_THROTTLE_MS) {
      // –¢–∏—Ö–∏–π –ø—Ä–æ–ø—É—Å–∫ throttled –∑–∞–ø—Ä–æ—Å–æ–≤
      log('sync throttled, last sync:', Math.round((now - cloud._lastClientSync.ts) / 1000), 'sec ago');
      return;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ sync –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
    _syncInProgress = (async () => {
      try {
        const ls = global.localStorage; // üöÄ used for delta sync ts and key processing

        // üîÑ –£–≤–µ–¥–æ–º–ª—è–µ–º UI —á—Ç–æ sync –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è (–¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–∫–µ–ª–µ—Ç–æ–Ω–∞)
        if (typeof window !== 'undefined' && window.dispatchEvent) {
          window.dispatchEvent(new CustomEvent('heysSyncStarting', { detail: { clientId: client_id } }));
        }

        // ÔøΩ PARALLEL: –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É shared products –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û —Å sync (–Ω–µ –ø–æ—Å–ª–µ)
        // –û–Ω–∏ –≥—Ä—É–∑—è—Ç—Å—è –≤ —Ñ–æ–Ω–µ –ø–æ–∫–∞ sync —Å–∫–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        let _sharedProductsPromise = null;
        const cachedSharedEarly = cloud.getCachedSharedProducts?.() || [];
        if (!cloud._sharedProductsLoaded && cachedSharedEarly.length === 0) {
          cloud._sharedProductsLoaded = true;
          _sharedProductsPromise = cloud.getAllSharedProducts({ limit: 1000, excludeBlocklist: true })
            .then(result => {
              if (result.data && result.data.length > 0) {
                logCritical(`üì¶ [SHARED PRODUCTS] Parallel pre-loaded ${result.data.length} products`);
              }
            })
            .catch(e => console.warn('[SHARED PRODUCTS] Parallel pre-load error:', e));
        }


        // DELTA FAST-PATH v2: check last_sync_ts IMMEDIATELY, before any other work
        // If exists - skip flush/cleanup/ensureClient/meta/PhaseA -> direct fetch
        // Saves 1.5-5 seconds (all heavy pre-work deferred after fetch)
        const lastSyncKey = `heys_${client_id}_last_sync_ts`;
        const lastSyncTs = ls.getItem(lastSyncKey);
        const isDeltaFastPath = !!lastSyncTs && !forceSync;
        const now = Date.now(); // needed for _lastClientSync and cloud cleanup

        if (isDeltaFastPath) {
          logCritical(`[DELTA FAST-PATH] Direct fetch, skipping all pre-work, since ${lastSyncTs}`);
        }

        // === PRE-WORK: flush + cleanup + ensureClient (skipped in delta fast-path) ===
        if (!isDeltaFastPath) {
          // ÔøΩüõ°Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∏–∑ –æ–±–ª–∞–∫–∞ ‚Äî –°–ù–ê–ß–ê–õ–ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pending –∏–∑–º–µ–Ω–µ–Ω–∏—è!
          // –ò–Ω–∞—á–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞—Ç—ë—Ä—Ç—ã –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
          // üõ°Ô∏è –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∏–∑ –æ–±–ª–∞–∫–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pending –∏–∑–º–µ–Ω–µ–Ω–∏—è
          // –ò–Ω–∞—á–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞—Ç—ë—Ä—Ç—ã –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
          const pendingCount = cloud.getPendingCount?.() || 0;

          // v9.4: Skip flush for fresh client syncs (no previous sync for this client)
          // Pending items are from old client or empty-data system writes (CRS=0, cascade empty)
          // They will be recomputed after real data is downloaded ‚Äî flushing is wasteful
          const hasPreviousSync = cloud._lastClientSync?.clientId === client_id;
          const shouldFlush = hasPreviousSync && (pendingCount > 0 || _uploadInProgress);

          if (shouldFlush) {
            logCritical(`üîÑ [SYNC] Flushing ${pendingCount} pending items (uploadInProgress: ${_uploadInProgress}) BEFORE download...`);
            const flushed = await cloud.flushPendingQueue(30000); // üîÑ v5: 30s (was 8s ‚Äî too short for throttled network)
            if (!flushed) {
              if (forceSync) {
                logCritical('‚ö†Ô∏è [FORCE SYNC] Queue flush timeout ‚Äî proceeding with extra guards');
              } else {
                logCritical('‚ö†Ô∏è [SYNC] Queue flush timeout ‚Äî aborting download to avoid overwrite');
                return;
              }
            }
          } else if (pendingCount > 0) {
            logCritical(`‚è≠Ô∏è [SYNC] Skip flush for fresh client sync (${pendingCount} pending items from previous context)`);
          }

          // üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π (–ª–æ–∫–∞–ª—å–Ω—ã–µ)
          cloud.cleanupProducts();

          // üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –û–ë–õ–ê–ö–ï (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π, –Ω–µ —á–∞—â–µ —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç)
          if (!cloud._lastCloudCleanup || (now - cloud._lastCloudCleanup) > 300000) {
            cloud._lastCloudCleanup = now;
            cloud.cleanupCloudProducts().catch(e => console.warn('[CLOUD CLEANUP] Error:', e));
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–µ–∑ –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è)
          const _exists = await cloud.ensureClient(client_id);
          logCritical(`üîç [SYNC DEBUG] ensureClient result: ${_exists}, client_id: ${client_id}`);
          if (!_exists) {
            log('client bootstrap skipped (no such client)', client_id);
            return;
          }
        }

        if (!isDeltaFastPath) {
          // === FULL SYNC PATH: meta check + Phase A (only when no last_sync_ts) ===

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –Ω—É–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
          const { data: metaData, error: metaError } = await YandexAPI.from('client_kv_store')
            .select('k,updated_at')
            .eq('client_id', client_id)
            .order('updated_at', { ascending: false })
            .limit(5);

          logCritical(`üîç [SYNC DEBUG] meta query result: rows=${metaData?.length}, error=${metaError?.message || 'none'}`);

          if (metaError) {
            // Graceful degradation –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
            if (metaError.isNetworkFailure) {
              console.warn('[HEYS.cloud] üì¥ clientSync: —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Ä–∞–±–æ—Ç–∞–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
              cloud._lastClientSync = { clientId: client_id, ts: now };
              // –ü–æ–º–µ—á–∞–µ–º sync –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
              if (!initialSyncCompleted) {
                initialSyncCompleted = true;
                logCritical('‚úÖ [OFFLINE] Sync –ø—Ä–æ–ø—É—â–µ–Ω (—Å–µ—Ç—å), –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã');
              }
              return;
            }
            err('client bootstrap meta check', metaError);
            throw new Error('Sync meta check failed: ' + (metaError.message || metaError));
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          // üîÑ –ü—Ä–∏ force=true (pull-to-refresh) ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É –ø—Ä–æ–≤–µ—Ä–∫—É
          const lastSyncTime = cloud._lastClientSync?.ts || 0;
          const hasUpdates = (metaData || []).some(row =>
            new Date(row.updated_at).getTime() > lastSyncTime
          );

          logCritical(`üîç [SYNC DEBUG] hasUpdates=${hasUpdates}, forceSync=${forceSync}, lastSyncTime=${lastSyncTime}, lastClientId=${cloud._lastClientSync?.clientId}`);

          if (!forceSync && !hasUpdates && cloud._lastClientSync?.clientId === client_id) {
            log('client bootstrap skipped (no updates)', client_id);
            cloud._lastClientSync.ts = now; // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –¥–ª—è throttling
            return;
          }

          if (forceSync) {
            log('üîÑ [FORCE SYNC] Pull-to-refresh ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ');
          }

          // üöÄ –§–ê–ó–ê A: –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ 5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º UI –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –ø–æ–ª–Ω–æ–≥–æ sync
          // –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (initialSyncCompleted === false)
          if (!initialSyncCompleted) {
            try {
              const today = new Date().toISOString().slice(0, 10);
              const criticalBaseKeys = [
                'heys_profile', 'heys_norms', 'heys_products',
                'heys_hr_zones', `heys_dayv2_${today}`
              ];
              const criticalScopedKeys = criticalBaseKeys.map(bk => `heys_${client_id}_${bk.slice('heys_'.length)}`);
              const allCriticalKeys = [...criticalBaseKeys, ...criticalScopedKeys];

              const { data: phaseAData, error: phaseAError } = await YandexAPI.from('client_kv_store')
                .select('k,v,updated_at')
                .eq('client_id', client_id)
                .in('k', allCriticalKeys);

              if (!phaseAError && phaseAData && phaseAData.length > 0) {
                muteMirror = true;
                const lsPhaseA = global.localStorage;
                phaseAData.forEach(row => {
                  if (row.v == null) return;
                  let pKey = row.k;
                  if (pKey.includes(client_id)) {
                    pKey = pKey.replace(`heys_${client_id}_`, 'heys_');
                  }
                  if (pKey.startsWith('heys_') && !pKey.includes(client_id)) {
                    pKey = 'heys_' + client_id + '_' + pKey.substring('heys_'.length);
                  }
                  try { lsPhaseA.setItem(pKey, JSON.stringify(row.v)); } catch (_) { }
                });
                muteMirror = false;

                // üîì –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º UI ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã
                initialSyncCompleted = true;
                cloud._syncCompletedAt = Date.now(); // ‚è±Ô∏è Grace period: –Ω–µ –ø–µ—Ä–µ-–∑–∞–≥—Ä—É–∂–∞–µ–º products
                cloud._productsFingerprint = null; // üîÑ Delta-sync: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ
                cancelFailsafeTimer();
                if (global.HEYS?.store?.flushMemory) global.HEYS.store.flushMemory();
                // üÜï PERF v9.2: –§–∞–∑–∞ A –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –ø–µ—Ä–≤—ã–π sync done
                window.__heysPerfMark && window.__heysPerfMark('heysSyncCompleted: phaseA dispatch');
                if (typeof window !== 'undefined' && window.dispatchEvent) {
                  window.dispatchEvent(new CustomEvent('heysSyncCompleted', {
                    detail: { clientId: client_id, phaseA: true }
                  }));
                }
                console.info(`[HEYS.sync] ‚úÖ –§–∞–∑–∞ A: ${phaseAData.length} –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ, UI —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`);
              }
            } catch (phaseAErr) {
              muteMirror = false;
              console.warn('[HEYS.sync] ‚ö†Ô∏è –§–∞–∑–∞ A –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ª–Ω—ã–π sync:', phaseAErr?.message || phaseAErr);
            }
          }
        } // end if (!isDeltaFastPath) ‚Äî full sync path

        // –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        // üöÄ Delta Sync: –µ—Å–ª–∏ –µ—Å—Ç—å last_sync_ts ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        const deltaSince = (lastSyncTs && !forceSync) ? lastSyncTs : null;
        const isDeltaSync = !!deltaSince;

        if (isDeltaSync) {
          logCritical(`üöÄ [DELTA SYNC] Loading only changes since ${deltaSince}`);
        }

        // üì¶ PAGINATED FETCH ‚Äî YC API Gateway limit ~3.5MB per response
        // –ü—Ä–∏ 530+ –∑–∞–ø–∏—Å—è—Ö –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ‚Üí 502 Bad Gateway
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Ä—Ü–∏—è–º–∏ –ø–æ 400 –∑–∞–ø–∏—Å–µ–π (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ—Ä–æ–≥ ~2.8MB)
        // üöÄ Delta Sync: –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ since ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ updated_at –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        log('üîÑ [CLIENT_SYNC] Loading data for client (paginated):', client_id);
        const PAGE_SIZE = 400;
        let allData = [];
        let pageOffset = 0;
        let fetchError = null;

        // üöÄ SPECULATIVE PREFETCH: check if HTML-time prefetch matches current request
        // If prefetch was fired at +0.0s and matches clientId+since ‚Üí reuse data, save ~1s
        let usedPrefetch = false;
        if (isDeltaSync && typeof window !== 'undefined' && window.__heysPrefetch
          && window.__heysPrefetch.clientId === client_id
          && window.__heysPrefetch.since === deltaSince) {
          try {
            const prefetchResult = await window.__heysPrefetch.promise;
            if (prefetchResult && prefetchResult.ok && Array.isArray(prefetchResult.data)) {
              allData = prefetchResult.data;
              usedPrefetch = true;
              logCritical(`üöÄ [PREFETCH HIT] Used pre-fetched delta data: ${allData.length} keys (saved ~1s)`);
            } else {
              logCritical(`‚ö†Ô∏è [PREFETCH MISS] Prefetch failed: ${prefetchResult?.error || 'unknown'}, falling back`);
            }
          } catch (e) {
            logCritical(`‚ö†Ô∏è [PREFETCH MISS] Error: ${e.message}, falling back`);
          }
          window.__heysPrefetch = null; // clear to prevent reuse
        }

        if (!usedPrefetch) {
          while (true) {
            const filters = { 'eq.client_id': client_id };
            // üöÄ Delta: –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä updated_at > since
            if (deltaSince) {
              filters['gt.updated_at'] = deltaSince;
            }

            const { data: pageData, error: pageError } = await YandexAPI.rest('client_kv_store', {
              select: 'k,v,updated_at',
              filters,
              limit: PAGE_SIZE,
              offset: pageOffset
            });

            if (pageError) {
              fetchError = pageError;
              break;
            }

            const rows = pageData || [];
            allData = allData.concat(rows);
            logCritical(`üîç [SYNC PAGINATED] page offset=${pageOffset}, rows=${rows.length}, total=${allData.length}`);

            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ PAGE_SIZE ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            if (rows.length < PAGE_SIZE) break;
            pageOffset += PAGE_SIZE;
          }
        }

        const data = allData;
        const error = fetchError;

        logCritical(`üîç [SYNC DEBUG] main data query: rows=${data?.length}, error=${error?.message || 'none'}, isNetworkFailure=${error?.isNetworkFailure}${isDeltaSync ? ' (DELTA)' : ' (FULL)'}`);

        if (error) {
          // Graceful degradation
          if (error.isNetworkFailure) {
            console.warn('[HEYS.cloud] üì¥ clientSync data: —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            cloud._lastClientSync = { clientId: client_id, ts: now };
            if (!initialSyncCompleted) {
              initialSyncCompleted = true;
              logCritical('‚úÖ [OFFLINE] Sync –ø—Ä–æ–ø—É—â–µ–Ω (—Å–µ—Ç—å), –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã');
            }
            return;
          }
          err('client bootstrap select', error);
          throw new Error('Sync data fetch failed: ' + (error.message || error));
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üöÄ DELTA LIGHT PATH: –ø—Ä–∏ delta sync —Å <= 10 –∫–ª—é—á–∞–º–∏ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        // –í–°–Æ —Ç—è–∂—ë–ª—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É (dedup, diagnostics, cleanup, deleted sync).
        // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç ~0.8s –∏–∑ post-fetch processing.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const deltaKeyCount = data?.length || 0;
        if (isDeltaSync && deltaKeyCount <= 10 && !forceSync) {
          const lightStart = performance.now();
          logCritical(`üöÄ [DELTA LIGHT] ${deltaKeyCount} keys ‚Äî fast processing, skip heavy ops`);

          // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–ø–∏—Å—å –≤ LS –±–µ–∑ dedup/merge (delta –Ω–µ –¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
          muteMirror = true;
          let lightKeysWritten = 0;
          const lightSyncedKeys = [];
          (data || []).forEach(row => {
            try {
              let key = row.k;
              // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–ª—é—á: —É–±–∏—Ä–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º clientId
              if (key.includes(client_id)) {
                key = key.replace(`heys_${client_id}_`, 'heys_');
                key = key.replace(`_${client_id}_`, '_');
              }
              if (key.startsWith('heys_') && !key.includes(client_id)) {
                key = 'heys_' + client_id + '_' + key.substring('heys_'.length);
              }

              let valueToStore = row.v;
              // –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
              if (typeof row.v === 'string' && row.v.startsWith('¬§Z¬§')) {
                const Store = global.HEYS?.store;
                if (Store && typeof Store.decompress === 'function') {
                  valueToStore = Store.decompress(row.v);
                }
              }
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º null dayv2
              if (key.includes('dayv2_') && (valueToStore == null || valueToStore === 'null')) return;

              ls.setItem(key, JSON.stringify(valueToStore));
              lightSyncedKeys.push(row.k);
              lightKeysWritten++;
            } catch (_) { }
          });
          muteMirror = false;

          // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à
          if (global.HEYS?.store?.invalidate && lightSyncedKeys.length > 0) {
            lightSyncedKeys.forEach(k => global.HEYS.store.invalidate(k));
          }
          if (global.HEYS?.store?.flushMemory) global.HEYS.store.flushMemory();

          // –û—Ç–º–µ—á–∞–µ–º sync –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π
          if (!initialSyncCompleted) {
            initialSyncCompleted = true;
            cancelFailsafeTimer();
          }
          cloud._lastClientSync = { clientId: client_id, ts: now };
          cloud._syncCompletedAt = Date.now();
          cloud._productsFingerprint = null;

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º timestamp –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ delta sync
          try { ls.setItem(`heys_${client_id}_last_sync_ts`, new Date().toISOString()); } catch (_) { }

          const lightDuration = Math.round(performance.now() - lightStart);
          logCritical(`‚úÖ [DELTA LIGHT DONE] client=${client_id.slice(0, 8)} keys=${lightKeysWritten} ms=${lightDuration}`);

          // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –ù–ï–ú–ï–î–õ–ï–ù–ù–û (–±–µ–∑ 300ms –∑–∞–¥–µ—Ä–∂–∫–∏)
          if (typeof window !== 'undefined' && window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('heysSyncCompleted', { detail: { clientId: client_id, loaded: lightKeysWritten, viaYandex: true, phase: 'full' } }));
          }

          // Shared products: –ù–ï –∂–¥—ë–º ‚Äî fire and forget
          // Cleanup, diagnostics, deleted sync ‚Äî defer –Ω–∞ 3s
          setTimeout(() => {
            try { cleanupDuplicateKeys(); } catch (_) { }
            if (isDeltaFastPath) {
              try { cloud.cleanupProducts(); } catch (_) { }
            }
          }, 3000);

          // üßπ Deleted products sync ‚Äî defer –Ω–∞ 5s
          setTimeout(() => {
            if (global.HEYS?.deletedProducts?.exportForSync) {
              try {
                const deletedListKey = `heys_${client_id}_deleted_products`;
                YandexAPI.from('client_kv_store')
                  .select('v')
                  .eq('client_id', client_id)
                  .eq('k', deletedListKey)
                  .then(({ data: cloudDeleted }) => {
                    const deletedRow = Array.isArray(cloudDeleted) ? cloudDeleted[0] : cloudDeleted;
                    if (deletedRow?.v) {
                      global.HEYS.deletedProducts.importFromSync(deletedRow.v);
                    }
                    const localExport = global.HEYS.deletedProducts.exportForSync();
                    if (Object.keys(localExport.entries).length > 0) {
                      clientUpsertQueue.push({
                        client_id: client_id,
                        k: deletedListKey,
                        v: localExport,
                        updated_at: new Date().toISOString()
                      });
                      scheduleClientPush();
                    }
                  }).catch(() => { });
              } catch (_) { }
            }
          }, 5000);

          _syncInProgress = null;
          return; // üöÄ Early return ‚Äî skip ALL heavy processing below
        }
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–º–µ—Å—Ç–æ 81 —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤
        const stats = { DAY: 0, PRODUCTS: 0, PROFILE: 0, NORMS: 0, OTHER: 0 };
        (data || []).forEach(row => {
          if (row.k === 'heys_products') stats.PRODUCTS++;
          else if (row.k.includes('dayv2_')) stats.DAY++;
          else if (row.k.includes('_profile')) stats.PROFILE++;
          else if (row.k.includes('_norms')) stats.NORMS++;
          else stats.OTHER++;
        });
        const summary = Object.entries(stats).filter(([, v]) => v > 0).map(([k, v]) => `${k}: ${v}`).join(', ');
        log(`‚úÖ [CLIENT_SYNC] Loaded ${data?.length || 0} keys (${summary})`);

        // ‚è±Ô∏è TIMING: –∑–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const syncStartTime = performance.now();

        // ‚îÄ‚îÄ [HEYS.sinhron] –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê dayv2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const cloudDayKeys = (data || []).filter(r => r.k && r.k.includes('dayv2_')).map(r => {
          const dm = r.k.match(/(\d{4}-\d{2}-\d{2})/);
          return dm ? dm[1] : r.k;
        }).sort();
        const localDayKeys = [];
        for (let lsi = 0; lsi < ls.length; lsi++) {
          const lsk = ls.key(lsi);
          if (lsk && lsk.includes('dayv2_') && !lsk.includes('dayv2_backup_') && (lsk.includes(client_id) || !client_id)) {
            const ldm = lsk.match(/(\d{4}-\d{2}-\d{2})/);
            if (ldm) localDayKeys.push(ldm[1]);
          }
        }
        localDayKeys.sort();
        window.console.info('[HEYS.sinhron] ‚òÅÔ∏è dayv2 –∏–∑ –æ–±–ª–∞–∫–∞ (' + cloudDayKeys.length + '):', cloudDayKeys.join(', '));
        window.console.info('[HEYS.sinhron] üíæ dayv2 –≤ localStorage (' + localDayKeys.length + '):', localDayKeys.join(', '));
        const onlyCloud = cloudDayKeys.filter(d => !localDayKeys.includes(d));
        const onlyLocal = localDayKeys.filter(d => !cloudDayKeys.includes(d));
        if (onlyCloud.length) window.console.warn('[HEYS.sinhron] ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –≤ –æ–±–ª–∞–∫–µ (–Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ):', onlyCloud.join(', '));
        if (onlyLocal.length) window.console.warn('[HEYS.sinhron] ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ—Ç –≤ –æ–±–ª–∞–∫–µ):', onlyLocal.join(', '));
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        muteMirror = true;
        // ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –û–ß–ò–©–ê–ï–ú –í–°–Å –ü–†–û–°–¢–†–ê–ù–°–¢–í–û –ö–õ–ò–ï–ù–¢–ê
        // clearNamespace —Å—Ç–∏—Ä–∞–ª –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–¥—É–∫—Ç—ã!
        // –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∫–ª—é—á–∏, —á—Ç–æ –ø—Ä–∏—à–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞

        // üîÑ –§–ê–ó 1: –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø ‚Äî –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π –≤ –ë–î –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –æ–¥–∏–Ω scoped key,
        // –±–µ—Ä—ë–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –ø–æ updated_at (–ø–æ–ª–µ –ë–î, –Ω–µ JSON)
        const keyGroups = new Map(); // scopedKey ‚Üí [{ row, updated_at_ts }]
        const uuidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi;

        (data || []).forEach(row => {
          let key = row.k;

          // üîí –§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–ª—é—á–∏
          // 1. –ö–ª—é—á–∏ —Å –¥–≤—É–º—è –∏–ª–∏ –±–æ–ª–µ–µ UUID (–±–∞–≥ –¥–≤–æ–π–Ω–æ–≥–æ clientId)
          const uuids = key.match(uuidPattern);
          if (uuids && uuids.length >= 2) {
            logCritical(`üêõ [LOAD SKIP] Skipping key with multiple UUIDs: ${key}`);
            return;
          }

          // 2. –ö–ª—é—á–∏ —Å –∫–∞–≤—ã—á–∫–∞–º–∏ –≤ –∏–º–µ–Ω–∏ (–±–∞–≥ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
          if (key.includes('"')) {
            logCritical(`üêõ [LOAD SKIP] Skipping key with quotes: ${key}`);
            return;
          }

          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º: —É–±–∏—Ä–∞–µ–º client_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è scoped key
          if (key.includes(client_id)) {
            key = key.replace(`heys_${client_id}_`, 'heys_');
            key = key.replace(`_${client_id}_`, '_');
          }

          // –î–æ–±–∞–≤–ª—è–µ–º client_id –¥–ª—è localStorage
          if (key.startsWith('heys_') && !key.includes(client_id)) {
            key = 'heys_' + client_id + '_' + key.substring('heys_'.length);
          }

          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ scoped key
          if (!keyGroups.has(key)) {
            keyGroups.set(key, []);
          }
          // –ü–∞—Ä—Å–∏–º updated_at –≤ timestamp –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
          const ts = row.updated_at ? new Date(row.updated_at).getTime() : 0;
          keyGroups.get(key).push({ row, updated_at_ts: ts, originalKey: row.k });
        });

        // –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –≤—ã–±–∏—Ä–∞–µ–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –ø–æ updated_at
        /**
         * Count valid products by name in a stored value.
         * @param {Array<Object>|any} value
         * @returns {number}
         */
        const getValidProductsCount = (value) => {
          if (!Array.isArray(value)) return 0;
          let count = 0;
          for (const p of value) {
            if (p && typeof p.name === 'string' && p.name.trim().length > 0) count++;
          }
          return count;
        };

        /**
         * Choose the best products row among duplicates by size, then by updated_at.
         * @param {Array<Object>} group
         * @param {string} scopedKey
         * @returns {Object}
         */
        const chooseBestProductsRow = (group, scopedKey) => {
          const scored = group.map(item => ({
            ...item,
            productsCount: getValidProductsCount(item?.row?.v)
          }));
          const maxCount = Math.max(...scored.map(item => item.productsCount));
          const hasLarge = maxCount > 1;
          const hasTiny = scored.some(item => item.productsCount <= 1);

          let candidates = scored;
          if (hasLarge) {
            candidates = scored.filter(item => item.productsCount === maxCount);
          }

          candidates.sort((a, b) => b.updated_at_ts - a.updated_at_ts);
          const winner = candidates[0];

          if (hasLarge && hasTiny) {
            const sizes = scored.map(item => `${item.originalKey}(${item.productsCount})`).join(', ');
            logCritical(`üõ°Ô∏è [DEDUP PRODUCTS] ${scopedKey}: chose ${winner.originalKey}(${winner.productsCount}) over tiny versions: ${sizes}`);
          }

          return winner;
        };

        // –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –≤—ã–±–∏—Ä–∞–µ–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –ø–æ updated_at
        const deduped = [];
        let dayv2DedupDropped = [];
        keyGroups.forEach((group, scopedKey) => {
          // üîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º products –∫–ª—é—á–∏
          if (scopedKey.includes('_products') && !scopedKey.includes('_backup')) {
            logCritical(`üì¶ [DEDUP PRODUCTS] scopedKey: "${scopedKey}" has ${group.length} versions: ${group.map(g => `"${g.originalKey}" (${Array.isArray(g.row.v) ? g.row.v.length : 'not array'})`).join(', ')}`);
          }

          if (group.length === 1) {
            deduped.push({ scopedKey, row: group[0].row });
          } else {
            if (scopedKey.includes('_products') && !scopedKey.includes('_backup')) {
              const winner = chooseBestProductsRow(group, scopedKey);
              const loser = group.find(item => item !== winner) || group[0];
              logCritical(`üîÄ [DEDUP] Key '${scopedKey}' has ${group.length} versions in DB. Using '${winner.originalKey}' (${new Date(winner.updated_at_ts).toISOString()}) over '${loser.originalKey}' (${new Date(loser.updated_at_ts).toISOString()})`);
              deduped.push({ scopedKey, row: winner.row });
            } else {
              // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ updated_at DESC –∏ –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
              group.sort((a, b) => b.updated_at_ts - a.updated_at_ts);
              const winner = group[0];
              const loser = group[1];
              logCritical(`üîÄ [DEDUP] Key '${scopedKey}' has ${group.length} versions in DB. Using '${winner.originalKey}' (${new Date(winner.updated_at_ts).toISOString()}) over '${loser.originalKey}' (${new Date(loser.updated_at_ts).toISOString()})`);
              deduped.push({ scopedKey, row: winner.row });
              // –¢—Ä–µ–∫–∞–µ–º –æ—Ç–±—Ä–æ—à–µ–Ω–Ω—ã–µ dayv2 –¥—É–±–ª–∏ –¥–ª—è [HEYS.sinhron]
              if (scopedKey.includes('dayv2_')) {
                const ddm = scopedKey.match(/(\d{4}-\d{2}-\d{2})/);
                dayv2DedupDropped.push(ddm ? ddm[1] : scopedKey);
              }
            }
          }
        });

        if (dayv2DedupDropped.length > 0) {
          window.console.warn('[HEYS.sinhron] üîÄ dayv2 –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: ' + dayv2DedupDropped.length + ' –¥—É–±–ª–µ–π –æ—Ç–±—Ä–æ—à–µ–Ω–æ:', dayv2DedupDropped.join(', '));
        }
        const dayv2AfterDedup = deduped.filter(d => d.scopedKey.includes('dayv2_')).map(d => {
          const dm = d.scopedKey.match(/(\d{4}-\d{2}-\d{2})/);
          return dm ? dm[1] : d.scopedKey;
        }).sort();
        window.console.info('[HEYS.sinhron] üì¶ dayv2 –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–∞ (' + dayv2AfterDedup.length + '):', dayv2AfterDedup.join(', '));

        log(`üìä [DEDUP] ${data?.length || 0} DB keys ‚Üí ${deduped.length} unique scoped keys`);

        // ‚è±Ô∏è TIMING: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 
        let keyProcessingStart = performance.now();
        let keysProcessed = 0;
        let productsUpdated = false;
        let latestProducts = null;
        // üÜï v5.0: Snapshot of products BEFORE applying cloud-sync.
        // Used by UI to cascade historical MealItems updates correctly.
        let previousProducts = null;
        // üöÄ PERF: Collect dayv2 writes and dispatch ONE event after loop
        const batchedDayV2Writes = [];

        // üîÑ –§–ê–ó 2: –û–ë–†–ê–ë–û–¢–ö–ê –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π
        deduped.forEach(({ scopedKey, row }) => {
          try {
            let key = scopedKey;

            //  FIX 2025-12-26: –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ–º row.v –µ—Å–ª–∏ —ç—Ç–æ —Å–∂–∞—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            // –î–∞–Ω–Ω—ã–µ –≤ –ë–î –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞–∫ —Å–∂–∞—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ "¬§Z¬§[{..." ‚Äî –Ω—É–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
            const Store = global.HEYS?.store;
            if (typeof row.v === 'string' && row.v.startsWith('¬§Z¬§')) {
              try {
                if (Store && typeof Store.decompress === 'function') {
                  row.v = Store.decompress(row.v);
                }
              } catch (decompErr) {
                logCritical(`‚ö†Ô∏è [DECOMPRESS] Failed for ${key}: ${decompErr.message}`);
              }
            }

            // –ö–æ–Ω—Ñ–ª–∏–∫—Ç: —Å—Ä–∞–≤–Ω–∏—Ç—å –≤–µ—Ä—Å–∏–∏ –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            let local = null;
            try { local = JSON.parse(ls.getItem(key)); } catch (e) { }

            // –î–ª—è –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è –∏—Å–ø–æ–ª—å–∑—É–µ–º MERGE –≤–º–µ—Å—Ç–æ "last write wins"
            if (key.includes('dayv2_')) {
              // ÔøΩÔ∏è v64 FIX: –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º null/undefined –∏–∑ cloud
              if (row.v == null || row.v === 'null') {
                logCritical(`üõ°Ô∏è [BOOTSTRAP PHASE2] SKIP NULL dayv2: ${key}`);
                return; // skip ‚Äî null data corrupts getDayData
              }

              // ÔøΩüîí –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º localStorage —Å–≤–µ–∂–∏–º –¥–ª—è dayv2!
              // –ü—Ä–æ–±–ª–µ–º–∞: `local` –±—ã–ª –ø—Ä–æ—á–∏—Ç–∞–Ω –≤ –Ω–∞—á–∞–ª–µ —Ü–∏–∫–ª–∞, –∞ store.set() –º–æ–≥ –∑–∞–ø–∏—Å–∞—Ç—å –ø–æ–∑–∂–µ
              try { local = JSON.parse(ls.getItem(key)); } catch (e) { local = null; }

              // üîí –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É cloud sync –≤–æ –≤—Ä–µ–º—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              // –ï—Å–ª–∏ HEYS.Day.isBlockingCloudUpdates() = true, –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º localStorage!
              // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –∫–æ–≥–¥–∞ sync —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ flush
              // ‚ö†Ô∏è –ù–û! –ü—Ä–∏ forceSync (pull-to-refresh) –ò–ì–ù–û–†–ò–†–£–ï–ú –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —Ö–æ—á–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å
              if (!forceSync && typeof global.HEYS?.Day?.isBlockingCloudUpdates === 'function' && global.HEYS.Day.isBlockingCloudUpdates()) {
                const remaining = (global.HEYS.Day.getBlockUntil?.() || 0) - Date.now();
                log(`üîí [SYNC BLOCKED] Skipping ${key} ‚Äî local edit in progress (${remaining}ms remaining)`);
                window.console.info('[HEYS.sinhron] üîí BLOCKED ' + key + ' ‚Äî local edit, remaining ' + remaining + 'ms');
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –∫–ª—é—á, –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º localStorage
              }

              const remoteUpdatedAt = row.v?.updatedAt || 0;
              const localUpdatedAt = local?.updatedAt || 0;

              // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º meaningful –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–º remote
              const localMeaningful = isMeaningfulDayData(local);
              const remoteMeaningful = isMeaningfulDayData(row.v);
              if (localMeaningful && !remoteMeaningful) {
                logCritical(`üõ°Ô∏è [DAYV2] KEEP LOCAL: meaningful local, empty remote for ${key}`);
                window.console.info('[HEYS.sinhron] üõ°Ô∏è KEEP_LOCAL (empty remote) ' + key);
                const pushObj = {
                  client_id: client_id,
                  k: normalizeKeyForSupabase(row.k, client_id),
                  v: local,
                  updated_at: new Date().toISOString()
                };
                clientUpsertQueue.push(pushObj);
                scheduleClientPush();
                return;
              }

              // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ local –∏–º–µ–µ—Ç –ë–û–õ–¨–®–ï meals ‚Äî –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º (race condition)
              if (!forceSync) {
                const localMealsCount = Array.isArray(local?.meals) ? local.meals.length : 0;
                const remoteMealsCount = Array.isArray(row.v?.meals) ? row.v.meals.length : 0;
                if (localMealsCount > remoteMealsCount) {
                  logCritical(`üõ°Ô∏è [DAYV2] KEEP LOCAL: local has MORE meals (${localMealsCount} > ${remoteMealsCount}) for ${key}`);
                  window.console.info('[HEYS.sinhron] üõ°Ô∏è KEEP_LOCAL (more meals ' + localMealsCount + '>' + remoteMealsCount + ') ' + key);
                  const pushObj = {
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: local,
                    updated_at: new Date().toISOString()
                  };
                  clientUpsertQueue.push(pushObj);
                  scheduleClientPush();
                  return;
                }
              }

              // üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ª–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ race conditions (–û–¢–ö–õ–Æ–ß–ï–ù–û - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤)
              // logCritical(`üìÖ [SYNC dayv2] key=${key} | local: ${local?.meals?.length || 0} meals, updatedAt=${localUpdatedAt} | remote: ${row.v?.meals?.length || 0} meals, updatedAt=${remoteUpdatedAt} | forceSync=${forceSync}`);

              // üîÑ FORCE MODE (pull-to-refresh): –í–°–ï–ì–î–ê –ø—Ä–∏–º–µ–Ω—è—Ç—å –æ–±–ª–∞—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
              // –ü—Ä–∏ force –±–µ—Ä—ë–º remote –∫–∞–∫ –±–∞–∑—É, remote items –ü–û–ë–ï–ñ–î–ê–Æ–¢ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
              if (forceSync && row.v) {
                // local —É–∂–µ –ø–µ—Ä–µ—á–∏—Ç–∞–Ω –≤—ã—à–µ (—Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage)
                // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ –Ω–∞ 256 –∫–ª—é—á–µ–π
                // logCritical(`üîÑ [FORCE SYNC] Processing day | key: ${key}`);
                // logCritical(`   üì¶ local: ${local?.meals?.length || 0} meals, updatedAt: ${local?.updatedAt}`);
                // logCritical(`   ‚òÅÔ∏è remote: ${row.v.meals?.length || 0} meals, updatedAt: ${row.v?.updatedAt}`);

                let valueToSave;
                // ‚úÖ –î–∞–∂–µ –≤ force-—Ä–µ–∂–∏–º–µ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º meaningful –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–º remote
                if (localMeaningful && !remoteMeaningful) {
                  valueToSave = local;
                  const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
                  if (dateMatch) {
                    const dayKey = `heys_dayv2_${dateMatch[1]}`;
                    local.updatedAt = Date.now();
                    const upsertObj = {
                      client_id: client_id,
                      k: dayKey,
                      v: local,
                      updated_at: new Date().toISOString()
                    };
                    clientUpsertQueue.push(upsertObj);
                    scheduleClientPush();
                  }
                } else if (local && local.meals?.length > 0) {
                  // üîÑ –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ local –ë–û–õ–¨–®–ï –¥–∞–Ω–Ω—ã—Ö —á–µ–º remote ‚Äî —ç—Ç–æ race condition!
                  // Remote –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω—è–µ–º local –∫–∞–∫ –µ—Å—Ç—å.
                  // ‚ö†Ô∏è –£—Å–ª–æ–≤–∏–µ: local –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ò–õ–ò local –Ω–æ–≤–µ–µ (–Ω–µ –ò!) ‚Äî –∑–∞—â–∏—â–∞–µ–º –æ—Ç –ø–æ—Ç–µ—Ä–∏ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                  const localHasMore = local.meals.length > (row.v.meals?.length || 0);
                  const localIsNewer = (local.updatedAt || 0) > (row.v.updatedAt || 0);

                  // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                  // logCritical(`   üîç CHECK: localHasMore=${localHasMore} (${local.meals.length} > ${row.v.meals?.length || 0}), localIsNewer=${localIsNewer} (${local.updatedAt} > ${row.v.updatedAt})`);

                  if (localHasMore || localIsNewer) {
                    // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                    // logCritical(`üõ°Ô∏è [FORCE SYNC] PROTECTED! Local wins: hasMore=${localHasMore}, isNewer=${localIsNewer}. Keeping local.`);
                    valueToSave = local;

                    // üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º local –≤ –æ–±–ª–∞–∫–æ —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π sync –ø–æ–ª—É—á–∏–ª –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
                    if (dateMatch) {
                      const dayKey = `heys_dayv2_${dateMatch[1]}`;
                      local.updatedAt = Date.now(); // –û–±–Ω–æ–≤–ª—è–µ–º timestamp
                      const upsertObj = {
                        client_id: client_id,
                        k: dayKey,
                        v: local,
                        updated_at: new Date().toISOString()
                      };
                      clientUpsertQueue.push(upsertObj);
                      scheduleClientPush();
                      // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                      // logCritical(`‚òÅÔ∏è [FORCE SYNC] Queued local data upload to cloud for ${dayKey}`);
                    }
                  } else {
                    // –ï—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî merge —Å preferRemote —á—Ç–æ–±—ã —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –æ–±–ª–∞–∫–∞ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
                    const merged = mergeDayData(local, row.v, { forceKeepAll: true, preferRemote: true });
                    valueToSave = merged || row.v; // –ï—Å–ª–∏ merge –≤–µ—Ä–Ω—É–ª null ‚Äî –±–µ—Ä—ë–º remote
                  }
                } else {
                  // –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë–º remote
                  valueToSave = row.v;
                }

                // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                // logCritical(`üîÑ [FORCE SYNC] Saving ${valueToSave.meals?.length || 0} meals to localStorage | key: ${key}`);
                // üß∑ Backup –ø–µ—Ä–µ–¥ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é dayv2
                backupDayV2BeforeOverwrite(key, valueToSave, 'force-sync');
                ls.setItem(key, JSON.stringify(valueToSave));
                window.console.info('[HEYS.sinhron] ‚úÖ FORCE_WRITE ' + key + ' meals=' + (valueToSave?.meals?.length || 0));

                const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
                if (dateMatch) {
                  window.dispatchEvent(new CustomEvent('heys:day-updated', {
                    detail: {
                      date: dateMatch[1],
                      source: 'force-sync',
                      forceReload: true  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ! –ò–Ω–∞—á–µ —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
                    }
                  }));
                  // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                  // logCritical(`üìÖ [EVENT] heys:day-updated dispatched for ${dateMatch[1]} (force-sync, forceReload=true)`);
                }
                return; // –ì–æ—Ç–æ–≤–æ
              }

              // –ï—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ò –æ–±–ª–∞—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω—É–∂–µ–Ω merge
              if (local && localUpdatedAt > 0 && remoteUpdatedAt > 0) {
                // MERGE: –æ–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
                const merged = mergeDayData(local, row.v);
                if (merged) {
                  // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                  // logCritical(`üîÄ [MERGE] Day conflict resolved | key: ${key} | local: ${new Date(localUpdatedAt).toLocaleTimeString()} | remote: ${new Date(remoteUpdatedAt).toLocaleTimeString()}`);
                  ls.setItem(key, JSON.stringify(merged));
                  window.console.info('[HEYS.sinhron] ‚úÖ MERGE ' + key + ' meals=' + (merged?.meals?.length || 0));

                  // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è (–¥–ª—è pull-to-refresh)
                  const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
                  if (dateMatch) {
                    window.dispatchEvent(new CustomEvent('heys:day-updated', { detail: { date: dateMatch[1], source: 'merge' } }));
                    // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                    // logCritical(`üìÖ [EVENT] heys:day-updated dispatched for ${dateMatch[1]} (merge)`);
                  }

                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º merged –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å (–≥–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏)
                  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á (–±–µ–∑ embedded client_id)
                  const mergedUpsertObj = {
                    user_id: user.id,
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: merged,
                    updated_at: (new Date()).toISOString(),
                  };
                  clientUpsertQueue.push(mergedUpsertObj);
                  scheduleClientPush();
                  return; // –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ merged
                }
              }

              // –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë–º –±–æ–ª–µ–µ —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é
              if (localUpdatedAt > remoteUpdatedAt) {
                log('conflict: keep local (by updatedAt)', key, localUpdatedAt, '>', remoteUpdatedAt);
                window.console.info('[HEYS.sinhron] üõ°Ô∏è KEEP_LOCAL (newer ' + localUpdatedAt + '>' + remoteUpdatedAt + ') ' + key);
                return;
              }
            } else {
              // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ revision –ò updatedAt
              const remoteRev = row.v && row.v.revision ? row.v.revision : 0;
              const localRev = local && local.revision ? local.revision : 0;
              const remoteUpdatedAt = row.v?.updatedAt || 0;
              const localUpdatedAt = local?.updatedAt || 0;

              // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –Ω–æ–≤–µ–µ –ø–æ revision –ò–õ–ò updatedAt ‚Äî –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º
              if (localRev > remoteRev || localUpdatedAt > remoteUpdatedAt) {
                log('conflict: keep local (by revision/updatedAt)', key,
                  `localRev=${localRev} remoteRev=${remoteRev}`,
                  `localUpdatedAt=${localUpdatedAt} remoteUpdatedAt=${remoteUpdatedAt}`);
                return;
              }

              // üõ°Ô∏è –ó–ê–©–ò–¢–ê –ü–†–û–§–ò–õ–Ø: –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
              if (key.includes('_profile')) {
                const remoteIsDefault = row.v &&
                  (row.v.weight === 70 && row.v.height === 175 && row.v.age === 30) &&
                  (!row.v.updatedAt || row.v.updatedAt === 0);
                const localHasData = local &&
                  (local.weight !== 70 || local.height !== 175 || local.age !== 30 ||
                    local.firstName || local.lastName || (local.updatedAt && local.updatedAt > 0));

                if (remoteIsDefault && localHasData) {
                  logCritical(`‚ö†Ô∏è [PROFILE] BLOCKED: Refusing to overwrite filled profile with default values`);
                  logCritical(`  Local: weight=${local.weight}, height=${local.height}, age=${local.age}, updatedAt=${local.updatedAt}`);
                  logCritical(`  Remote: weight=${row.v?.weight}, height=${row.v?.height}, age=${row.v?.age}, updatedAt=${row.v?.updatedAt}`);
                  return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                }
              }

              // üõ°Ô∏è –ó–ê–©–ò–¢–ê GAMIFICATION: XP –¥–æ–ª–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç–∏, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è
              // FIX v2.0: –ò—â–µ–º game –¥–∞–Ω–Ω—ã–µ –≤–æ –í–°–ï–• –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –∫–ª—é—á–∞ (legacy, —Ä–∞–∑–Ω—ã–µ clientId)
              if (key.includes('_game') && !key.includes('_gamification')) {
                const remoteTotalXP = row.v?.totalXP || 0;
                let localTotalXP = local?.totalXP || 0;
                let bestLocalGame = local;

                // üîç –ò—â–µ–º game –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –∫–ª—é—á–∞
                if (localTotalXP === 0) {
                  try {
                    const clientPrefix = client_id ? `heys_${client_id}_` : null;

                    // 1. –ü—Ä—è–º–æ–π –∫–ª—é—á heys_game (legacy –±–µ–∑ clientId)
                    // ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ client_id –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –∏–Ω–∞—á–µ —Ä–∏—Å–∫ —á—É–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (!clientPrefix) {
                      const legacyGame = tryParse(ls.getItem('heys_game'));
                      if (legacyGame?.totalXP > localTotalXP) {
                        localTotalXP = legacyGame.totalXP;
                        bestLocalGame = legacyGame;
                        logCritical(`üéÆ [GAME] Found legacy heys_game with XP: ${localTotalXP}`);
                      }
                    }

                    // 2. –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–∞–º *_game —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                    for (let i = 0; i < ls.length; i++) {
                      const k = ls.key(i);
                      if (!k) continue;
                      if (clientPrefix && !k.startsWith(clientPrefix)) continue;
                      if (!clientPrefix && k === 'heys_game') continue;
                      if (k.endsWith('_game') && !k.includes('_gamification')) {
                        const gameData = tryParse(ls.getItem(k));
                        if (gameData?.totalXP > localTotalXP) {
                          localTotalXP = gameData.totalXP;
                          bestLocalGame = gameData;
                          logCritical(`üéÆ [GAME] Found better game data in ${k}: XP=${localTotalXP}`);
                        }
                      }
                    }
                  } catch (e) { }
                }

                logCritical(`üéÆ [GAME SYNC] local XP=${localTotalXP}, remote XP=${remoteTotalXP}, key=${key}`);

                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π XP –±–æ–ª—å—à–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ò –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
                if (localTotalXP > remoteTotalXP) {
                  logCritical(`üéÆ [GAME] BLOCKED: Keeping local XP (${localTotalXP}) > remote (${remoteTotalXP})`);

                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                  if (bestLocalGame && user?.id) {
                    const gameUpsertObj = {
                      user_id: user.id,
                      client_id: client_id,
                      k: normalizeKeyForSupabase(row.k, client_id),
                      v: bestLocalGame,
                      updated_at: (new Date()).toISOString(),
                    };
                    clientUpsertQueue.push(gameUpsertObj);
                    scheduleClientPush();
                    logCritical(`üéÆ [GAME] Queued local game data to cloud (XP: ${localTotalXP})`);
                  }
                  return;
                }

                // –ï—Å–ª–∏ remote XP –±–æ–ª—å—à–µ ‚Äî –±–µ—Ä—ë–º remote, –Ω–æ –º–µ—Ä–∂–∏–º achievements
                if (remoteTotalXP > localTotalXP) {
                  const localAchievements = bestLocalGame?.unlockedAchievements || [];
                  const remoteAchievements = row.v?.unlockedAchievements || [];
                  const mergedAchievements = [...new Set([...remoteAchievements, ...localAchievements])];

                  row.v = {
                    ...row.v,
                    unlockedAchievements: mergedAchievements,
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ stats
                    stats: {
                      ...row.v?.stats,
                      bestStreak: Math.max(row.v?.stats?.bestStreak || 0, bestLocalGame?.stats?.bestStreak || 0),
                      perfectDays: Math.max(row.v?.stats?.perfectDays || 0, bestLocalGame?.stats?.perfectDays || 0),
                      totalProducts: Math.max(row.v?.stats?.totalProducts || 0, bestLocalGame?.stats?.totalProducts || 0),
                      totalWater: Math.max(row.v?.stats?.totalWater || 0, bestLocalGame?.stats?.totalWater || 0),
                      totalTrainings: Math.max(row.v?.stats?.totalTrainings || 0, bestLocalGame?.stats?.totalTrainings || 0)
                    }
                  };
                  logCritical(`üéÆ [GAME] MERGED: XP ${localTotalXP} ‚Üí ${remoteTotalXP}, achievements: ${mergedAchievements.length}`);
                }

                // –ï—Å–ª–∏ –æ–±–∞ —Ä–∞–≤–Ω—ã –Ω—É–ª—é ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø—É—Å—Ç—å remote –∑–∞–ø–∏—à–µ—Ç—Å—è
                if (remoteTotalXP === 0 && localTotalXP === 0) {
                  logCritical(`üéÆ [GAME] Both XP=0, accepting remote (may be fresh start)`);
                }
              }

              // üõ°Ô∏è –ó–ê–©–ò–¢–ê WIDGET LAYOUT: –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π layout –æ–±–ª–∞—á–Ω—ã–º —Å –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–º updatedAt
              // Widget layout ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ—Ç–µ—Ä—è = —Å–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¢–û–õ–¨–ö–û –æ—Å–Ω–æ–≤–Ω–æ–π layout, –ù–ï meta (widget_layout_meta_v1)
              if (key.includes('widget_layout_v1') && !key.includes('_meta_')) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º updatedAt –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: { widgets: [...], updatedAt: number }
                // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤ (–Ω–µ—Ç updatedAt)
                const remoteHasUpdatedAt = row.v && typeof row.v.updatedAt === 'number';
                const localHasUpdatedAt = local && typeof local.updatedAt === 'number';

                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∂–µ—Ç–æ–≤ (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
                const remoteWidgetCount = row.v?.widgets?.length || (Array.isArray(row.v) ? row.v.length : 0);
                const localWidgetCount = local?.widgets?.length || (Array.isArray(local) ? local.length : 0);

                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π layout –Ω–æ–≤–µ–µ ‚Äî –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º
                if (localHasUpdatedAt && remoteHasUpdatedAt && local.updatedAt >= row.v.updatedAt) {
                  logCritical(`üß© [WIDGET LAYOUT] KEEP LOCAL: local.updatedAt (${local.updatedAt}) >= remote.updatedAt (${row.v.updatedAt})`);
                  logCritical(`   Local: ${localWidgetCount} widgets, Remote: ${remoteWidgetCount} widgets`);
                  return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω–µ–µ
                }

                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–µ–µ—Ç updatedAt, –∞ remote ‚Äî –Ω–µ—Ç (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ –æ–±–ª–∞–∫–µ)
                if (localHasUpdatedAt && !remoteHasUpdatedAt) {
                  logCritical(`üß© [WIDGET LAYOUT] KEEP LOCAL: local has updatedAt (${local.updatedAt}), remote is legacy format`);
                  logCritical(`   Local: ${localWidgetCount} widgets, Remote: ${remoteWidgetCount} widgets`);
                  // –û—Ç–ø—Ä–∞–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç
                  const upsertObj = {
                    user_id: user.id,
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: local, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    updated_at: (new Date()).toISOString(),
                  };
                  clientUpsertQueue.push(upsertObj);
                  scheduleClientPush();
                  return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ remote
                }

                // –ï—Å–ª–∏ –æ–±–∞ –±–µ–∑ updatedAt (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –ø—É—Å—Ç—å –±—É–¥–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
                if (!localHasUpdatedAt && !remoteHasUpdatedAt && localWidgetCount > 0) {
                  logCritical(`üß© [WIDGET LAYOUT] KEEP LOCAL: both legacy format, preserving ${localWidgetCount} local widgets`);
                  return;
                }

                // üõ°Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π layout –∏–º–µ–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å updatedAt, –∞ remote –ø—É—Å—Ç–æ–π –∏–ª–∏ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö ‚Äî KEEP LOCAL!
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ç–∏—Ä–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã–º –æ—Ç–≤–µ—Ç–æ–º –∏–∑ –æ–±–ª–∞–∫–∞
                if (localHasUpdatedAt && localWidgetCount > 0 && remoteWidgetCount === 0) {
                  logCritical(`üß© [WIDGET LAYOUT] KEEP LOCAL: local has ${localWidgetCount} widgets with updatedAt, remote is EMPTY`);
                  // –û—Ç–ø—Ä–∞–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                  const upsertObj = {
                    user_id: user.id,
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: local, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    updated_at: (new Date()).toISOString(),
                  };
                  clientUpsertQueue.push(upsertObj);
                  scheduleClientPush();
                  return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ remote
                }

                logCritical(`üß© [WIDGET LAYOUT] ACCEPTING REMOTE: ${remoteWidgetCount} widgets (updatedAt: ${row.v?.updatedAt || 'none'})`);
              }
            }

            // –ó–ê–©–ò–¢–ê –ò MERGE: –£–º–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ)
            if (key.includes('_products') && !key.includes('_products_backup') && !key.includes('_hidden_products') && !key.includes('_favorite_products') && !key.includes('_deleted_products')) {
              let remoteProducts;
              // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤
              // console.log('üì¶ [PRODUCTS DEBUG] Processing products key:', key, 'raw row.k:', row.k, 'row.v length:', Array.isArray(row.v) ? row.v.length : 'not array');

              // –ß–∏—Ç–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ scoped –∫–ª—é—á—É
              let currentLocal = null;
              try {
                const rawLocal = ls.getItem(key);
                if (rawLocal) {
                  const parsed = tryParse(rawLocal);
                  // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–±–µ–∑ name)
                  currentLocal = Array.isArray(parsed)
                    ? parsed.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0)
                    : null;
                }
              } catch (e) { }

              // üÜï v5.0: Keep snapshot of previous products for downstream cascade
              // Only capture once per sync cycle.
              if (!previousProducts && Array.isArray(currentLocal) && currentLocal.length > 0) {
                previousProducts = currentLocal;
              }

              // üõ°Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –æ–±–ª–∞–∫–∞ –ü–ï–†–ï–î –ª—é–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
              remoteProducts = row.v;
              if (Array.isArray(row.v)) {
                const before = row.v.length;
                remoteProducts = row.v.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0);
                if (remoteProducts.length !== before) {
                  logCritical(`üßπ [CLOUD PRODUCTS] Pre-filtered ${before - remoteProducts.length} invalid (${before} ‚Üí ${remoteProducts.length})`);
                }
              }

              // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ù–ï –ó–ê–¢–ò–†–ê–ï–ú –Ω–µ–ø—É—Å—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
              if (Array.isArray(remoteProducts) && remoteProducts.length === 0) {
                if (Array.isArray(currentLocal) && currentLocal.length > 0) {
                  log(`‚ö†Ô∏è [PRODUCTS] BLOCKED: Refusing to overwrite ${currentLocal.length} local products with empty cloud array`);
                  // üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –æ–±–ª–∞–∫–æ —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å –º—É—Å–æ—Ä
                  logCritical(`üîÑ [CLOUD RECOVERY] Pushing ${currentLocal.length} local products to replace cloud garbage`);
                  const recoveryUpsertObj = {
                    user_id: user.id,
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: currentLocal,
                    updated_at: new Date().toISOString(),
                  };
                  clientUpsertQueue.push(recoveryUpsertObj);
                  scheduleClientPush();
                  return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                } else {
                  // –û–±–∞ –ø—É—Å—Ç—ã - –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
                  const backupKey = key.replace('_products', '_products_backup');
                  const backupRaw = ls.getItem(backupKey);
                  if (backupRaw) {
                    try {
                      const backupData = tryParse(backupRaw);
                      if (Array.isArray(backupData) && backupData.length > 0) {
                        log(`‚úÖ [RECOVERY] Restored ${backupData.length} products from backup`);
                        if (global.HEYS?.products?.setAll) {
                          global.HEYS.products.setAll(backupData, { source: 'cloud-recovery', skipNotify: true, skipCloud: true });
                          productsUpdated = true;
                          latestProducts = backupData;
                          // If we restored from backup, previousProducts may be empty; fallback to in-memory snapshot.
                          if (!previousProducts) previousProducts = currentLocal || global.HEYS?.products?.getAll?.() || null;
                        } else {
                          ls.setItem(key, JSON.stringify(backupData));
                        }
                        muteMirror = false;
                        setTimeout(() => cloud.saveClientKey(client_id, 'heys_products', backupData), 500);
                        muteMirror = true;
                        return;
                      }
                    } catch (e) { }
                  }
                }
              }

              // üîÄ MERGE: –û–±—ä–µ–¥–∏–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏ –æ–±–ª–∞—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (—É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ!)
              // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –æ–±–ª–∞–∫–æ –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
              if (Array.isArray(currentLocal) && currentLocal.length > 0 && Array.isArray(remoteProducts) && remoteProducts.length > 0) {
                let merged = mergeProductsData(currentLocal, remoteProducts);

                // üõ°Ô∏è v4.8.10: –§–∏–Ω–∞–ª—å–Ω–∞—è tombstone-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è merged —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ü–ï–†–ï–î setAll
                // mergeProductsData —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —á–µ—Ä–µ–∑ HEYS.deletedProducts, –Ω–æ —ç—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ
                // –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ localStorage. –î—É–±–ª–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ heys_deleted_ids (Store, –≤—ã–∂–∏–≤–∞–µ—Ç –≤ –æ–±–ª–∞–∫–µ).
                const _tsForMerge = (typeof global !== 'undefined' ? global : window)?.HEYS?.store?.get?.('heys_deleted_ids') || [];
                if (Array.isArray(_tsForMerge) && _tsForMerge.length > 0) {
                  const _tsIds = new Set(_tsForMerge.map(t => t.id).filter(Boolean));
                  const _tsNames = new Set(_tsForMerge.map(t => (t.name || '').trim().toLowerCase()).filter(Boolean));
                  const beforeLen = merged.length;
                  merged = merged.filter(p => {
                    if (!p) return false;
                    if (p.id && _tsIds.has(p.id)) return false;
                    if (p.name && _tsNames.has(String(p.name).trim().toLowerCase())) return false;
                    return true;
                  });
                  if (merged.length < beforeLen) {
                    logCritical(`ü™¶ [MERGE TOMBSTONE] Removed ${beforeLen - merged.length} tombstoned product(s) from merge result (${beforeLen}‚Üí${merged.length})`);
                  }
                }

                // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                // (—Ç.–∫. mergeProductsData –¥–µ–ª–∞–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –≤–Ω—É—Ç—Ä–∏, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å raw currentLocal –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
                const localUniqueCount = new Set(currentLocal.filter(p => p && p.name).map(p => String(p.name).trim().toLowerCase())).size;

                // üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ç–µ—Ä—é –£–ù–ò–ö–ê–õ–¨–ù–´–• –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–µ –¥—É–±–ª–µ–π)
                // –ï—Å–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –±–æ–ª—å—à–µ —á–µ–º merged ‚Äî –∑–Ω–∞—á–∏—Ç sync "–æ–ø–æ–∑–¥–∞–ª" –∏ –ø—ã—Ç–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
                // üîß FIX v4.8.9: –ï—Å–ª–∏ –≤—Å–µ "–ª–∏—à–Ω–∏–µ" –ª–æ–∫–∞–ª—å–Ω—ã–µ ‚Äî —ç—Ç–æ tombstoned –ø—Ä–æ–¥—É–∫—Ç—ã, —Ä–∞–∑—Ä–µ—à–∞–µ–º merge.
                // –ò–Ω–∞—á–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞–≤–µ—á–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤–æ—Å–∫—Ä–µ—Å–∞—é—Ç.
                const _tombstonesSync = (typeof global !== 'undefined' ? global : window)?.HEYS?.store?.get?.('heys_deleted_ids') || [];
                const _tombstoneIdsSync = new Set(Array.isArray(_tombstonesSync) ? _tombstonesSync.map(t => t.id).filter(Boolean) : []);
                const _tombstoneNamesSync = new Set(Array.isArray(_tombstonesSync) ? _tombstonesSync.map(t => (t.name || '').trim().toLowerCase()).filter(Boolean) : []);
                const _localWithoutTombstoned = currentLocal.filter(p => {
                  if (!p) return false;
                  if (p.id && _tombstoneIdsSync.has(p.id)) return false;
                  if (p.name && _tombstoneNamesSync.has(String(p.name).trim().toLowerCase())) return false;
                  return true;
                });
                const localEffectiveCount = new Set(_localWithoutTombstoned.filter(p => p && p.name).map(p => String(p.name).trim().toLowerCase())).size;

                if (localEffectiveCount > merged.length) {
                  logCritical(`‚ö†Ô∏è [PRODUCTS SYNC] BLOCKED: localEffective (${localEffectiveCount}, was ${localUniqueCount} before tombstone) > merged (${merged.length}). Keeping local.`);
                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏)
                  // –ò—Å–ø–æ–ª—å–∑—É–µ–º merged –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
                  const localDeduped = [];
                  const seenNames = new Set();
                  for (const p of currentLocal) {
                    if (!p || !p.name) continue;
                    const key = String(p.name).trim().toLowerCase();
                    if (!seenNames.has(key)) {
                      seenNames.add(key);
                      localDeduped.push(p);
                    }
                  }
                  const localUpsertObj = {
                    user_id: user.id,
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: localDeduped, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ!
                    updated_at: (new Date()).toISOString(),
                  };
                  clientUpsertQueue.push(localUpsertObj);
                  scheduleClientPush();
                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ
                  // üõ°Ô∏è v4.8.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –±–æ–ª—å—à–∏–π –Ω–∞–±–æ—Ä
                  const memoryNow = global.HEYS?.products?.getAll?.()?.length || 0;
                  if (localDeduped.length < memoryNow) {
                    // v4.8.2: –†–∞–∑—Ä–µ—à–∞–µ–º –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ <= 5%
                    const shrinkPct = ((memoryNow - localDeduped.length) / memoryNow) * 100;
                    if (shrinkPct > 5) {
                      log(`‚ö†Ô∏è [PRODUCTS] Skip setAll: localDeduped (${localDeduped.length}) significantly < memory (${memoryNow}), ${shrinkPct.toFixed(1)}%`);
                      return;
                    }
                    log(`üßπ [PRODUCTS] Allowing dedup shrink: ${memoryNow} ‚Üí ${localDeduped.length} (‚àí${shrinkPct.toFixed(1)}%)`);
                  }
                  if (global.HEYS?.products?.setAll) {
                    global.HEYS.products.setAll(localDeduped, { source: 'cloud-sync', skipNotify: true, skipCloud: true, allowShrink: true });
                    productsUpdated = true;
                    latestProducts = localDeduped;
                    if (!previousProducts) previousProducts = currentLocal || global.HEYS?.products?.getAll?.() || null;
                  } else {
                    ls.setItem(key, JSON.stringify(localDeduped));
                  }
                  return;
                }

                // –ï—Å–ª–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —É–±—Ä–∞–ª–∞ –¥—É–±–ª–∏ ‚Äî —ç—Ç–æ OK, —Å–æ—Ö—Ä–∞–Ω—è–µ–º merged
                if (currentLocal.length > merged.length && localUniqueCount === merged.length) {
                  log(`üßπ [PRODUCTS] Deduplication cleaned ${currentLocal.length - merged.length} duplicates`);
                }

                // –ï—Å–ª–∏ merge –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ
                if (merged.length > remoteProducts.length) {
                  logCritical(`üì¶ [PRODUCTS MERGE] ${currentLocal.length} local + ${remoteProducts.length} remote ‚Üí ${merged.length} merged`);
                  if (global.HEYS?.products?.setAll) {
                    global.HEYS.products.setAll(merged, { source: 'cloud-sync', skipNotify: true, skipCloud: true, allowShrink: true });
                    productsUpdated = true;
                    latestProducts = merged;
                    if (!previousProducts) previousProducts = currentLocal || global.HEYS?.products?.getAll?.() || null;
                  } else {
                    ls.setItem(key, JSON.stringify(merged));
                  }

                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º merged –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ
                  const mergedUpsertObj = {
                    user_id: user.id,
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: merged,
                    updated_at: (new Date()).toISOString(),
                  };
                  clientUpsertQueue.push(mergedUpsertObj);
                  scheduleClientPush();
                  return; // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ products
                }

                // –ï—Å–ª–∏ merged.length === remoteProducts.length (–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π) ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º merged
                // –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ç.–∫. merged —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
                // üõ°Ô∏è v4.8.1: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞–º—è—Ç—å ‚Äî –º–æ–≥–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è
                const memoryCount = global.HEYS?.products?.getAll?.()?.length || 0;
                if (merged.length === remoteProducts.length && merged.length === currentLocal.length && merged.length >= memoryCount) {
                  if (global.HEYS?.products?.setAll) {
                    global.HEYS.products.setAll(merged, { source: 'cloud-sync', skipNotify: true, skipCloud: true, allowShrink: true });
                    productsUpdated = true;
                    latestProducts = merged;
                    if (!previousProducts) previousProducts = currentLocal || global.HEYS?.products?.getAll?.() || null;
                  } else {
                    ls.setItem(key, JSON.stringify(merged));
                  }
                  return; // –î–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å –æ–±–ª–∞–∫–æ
                }

                // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º merged –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
                // üõ°Ô∏è v4.8.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ merged –Ω–µ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –ø–∞–º—è—Ç–∏
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –∫–æ–≥–¥–∞ –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º –∏ merge
                const currentInMemory = global.HEYS?.products?.getAll?.()?.length || 0;
                if (merged.length < currentInMemory) {
                  // v4.8.2: –†–∞–∑—Ä–µ—à–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–∏–µ –µ—Å–ª–∏ —ç—Ç–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (—Ä–∞–∑–Ω–∏—Ü–∞ <= 5%)
                  const shrinkPct = ((currentInMemory - merged.length) / currentInMemory) * 100;
                  if (shrinkPct > 5) {
                    log(`‚ö†Ô∏è [PRODUCTS] Skipping setAll: merged (${merged.length}) significantly < memory (${currentInMemory}), ${shrinkPct.toFixed(1)}%`);
                    return;
                  }
                  log(`üßπ [PRODUCTS] Allowing merge shrink: ${currentInMemory} ‚Üí ${merged.length} (‚àí${shrinkPct.toFixed(1)}%, dedup)`);
                }

                if (global.HEYS?.products?.setAll) {
                  global.HEYS.products.setAll(merged, { source: 'cloud-sync', skipNotify: true, skipCloud: true, allowShrink: true });
                  productsUpdated = true;
                  latestProducts = merged;
                  if (!previousProducts) previousProducts = currentLocal || global.HEYS?.products?.getAll?.() || null;
                } else {
                  ls.setItem(key, JSON.stringify(merged));
                }
                return;
              }
            }

            // üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–æ–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (quality/feelAfter ‚Üí mood/wellbeing/stress)
            if (key.includes('dayv2_') && row.v?.trainings?.length) {
              let migrated = false;
              row.v.trainings = row.v.trainings.map(t => {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è ‚Äî –º–∏–≥—Ä–∏—Ä—É–µ–º –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è –≤ –Ω–æ–≤—ã–µ
                if (t.quality !== undefined || t.feelAfter !== undefined) {
                  migrated = true;
                  const { quality, feelAfter, ...rest } = t;
                  return {
                    ...rest,
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º: quality ‚Üí mood, feelAfter ‚Üí wellbeing
                    // –ï—Å–ª–∏ –Ω–æ–≤—ã–µ –ø–æ–ª—è —É–∂–µ –µ—Å—Ç—å ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–º
                    mood: rest.mood ?? quality ?? 5,
                    wellbeing: rest.wellbeing ?? feelAfter ?? 5,
                    stress: rest.stress ?? 5  // –¥–µ—Ñ–æ–ª—Ç –¥–ª—è stress (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
                  };
                }
                return t;
              });
              if (migrated) {
                log(`  üîÑ Migrated training fields for ${key}`);
              }
            }

            // üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º inline –¥–∞–Ω–Ω—ã–µ –∫ —Å—Ç–∞—Ä—ã–º MealItems (–µ—Å–ª–∏ –Ω–µ—Ç kcal100)
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –∫–∞–ª–æ—Ä–∏–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª—ë–Ω –∏–∑ –±–∞–∑—ã
            if (key.includes('dayv2_') && row.v?.meals?.length) {
              // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
              let productsForMigration = null;
              try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ HEYS.store (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
                if (global.HEYS?.store?.get) {
                  productsForMigration = global.HEYS.store.get('heys_products', []);
                }
                // Fallback: —á–∏—Ç–∞–µ–º –∏–∑ localStorage –ø–æ scoped key
                if (!productsForMigration || productsForMigration.length === 0) {
                  const scopedProductsKey = key.replace(/dayv2_.*/, 'products');
                  const rawProducts = ls.getItem(scopedProductsKey);
                  if (rawProducts) productsForMigration = JSON.parse(rawProducts);
                }
              } catch (e) { productsForMigration = []; }

              if (Array.isArray(productsForMigration) && productsForMigration.length > 0) {
                // –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ ID –∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                const productsById = new Map();
                const productsByName = new Map();
                productsForMigration.forEach(p => {
                  if (p && p.id) productsById.set(String(p.id), p);
                  if (p && p.name) {
                    const name = String(p.name).trim();
                    if (name) productsByName.set(name, p);
                  }
                });

                let itemsMigrated = 0;
                row.v.meals = row.v.meals.map(meal => {
                  if (!meal || !Array.isArray(meal.items)) return meal;

                  const migratedItems = meal.items.map(item => {
                    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å inline kcal100 ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    if (item.kcal100 !== undefined) return item;

                    // –ò—â–µ–º –ø—Ä–æ–¥—É–∫—Ç —Å–Ω–∞—á–∞–ª–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –ø–æ—Ç–æ–º –ø–æ product_id
                    const itemName = String(item.name || '').trim();
                    let product = itemName ? productsByName.get(itemName) : null;
                    if (!product) {
                      const productId = String(item.product_id || item.id || '');
                      product = productId ? productsById.get(productId) : null;
                    }

                    if (product && product.kcal100 !== undefined) {
                      itemsMigrated++;
                      return {
                        ...item,
                        kcal100: product.kcal100,
                        protein100: product.protein100,
                        fat100: product.fat100,
                        simple100: product.simple100,
                        complex100: product.complex100,
                        badFat100: product.badFat100,
                        goodFat100: product.goodFat100,
                        trans100: product.trans100,
                        fiber100: product.fiber100,
                        gi: product.gi ?? product.gi100,
                        harm: product.harm ?? product.harm100
                      };
                    }
                    return item;
                  });

                  return { ...meal, items: migratedItems };
                });

                if (itemsMigrated > 0) {
                  logCritical(`  üîÑ [MIGRATION] Added inline data to ${itemsMigrated} items in ${key}`);

                  // üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ
                  const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
                  if (dateMatch) {
                    const dayKey = `heys_dayv2_${dateMatch[1]}`;
                    row.v.updatedAt = Date.now();
                    const migrationUpsertObj = {
                      client_id: client_id,
                      k: dayKey,
                      v: row.v,
                      updated_at: new Date().toISOString()
                    };
                    clientUpsertQueue.push(migrationUpsertObj);
                    scheduleClientPush();
                  }
                }
              }
            }

            // –î–ª—è products –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤—ã—à–µ)
            // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ ‚Äî –∑–Ω–∞—á–∏—Ç merge –Ω–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª (local –ø—É—Å—Ç)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º remoteProducts –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã
            let valueToSave = row.v;

            // üõ°Ô∏è v64 FIX: –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º null/undefined dayv2 –≤ localStorage
            // Cloud –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å row.v = null ‚Üí JSON.stringify(null) = "null" ‚Üí getDayData –ª–æ–º–∞–µ—Ç—Å—è
            if (key.includes('dayv2_') && (valueToSave == null || valueToSave === 'null')) {
              logCritical(`üõ°Ô∏è [BOOTSTRAP] SKIP NULL dayv2: ${key}`);
              return; // skip ‚Äî null data corrupts getDayData
            }

            if (key.includes('_products') && !key.includes('_products_backup') && !key.includes('_hidden_products') && !key.includes('_favorite_products') && !key.includes('_deleted_products')) {
              // remoteProducts —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –≤—ã—à–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
              // –ï—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π –∏ –º—ã –¥–æ—à–ª–∏ —Å—é–¥–∞ ‚Äî –∑–Ω–∞—á–∏—Ç recovery —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤—ã—à–µ
              // –ù–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–æ–≤–µ—Ä–∏–º –µ—â—ë —Ä–∞–∑
              if (typeof remoteProducts !== 'undefined') {
                valueToSave = remoteProducts;
                if (valueToSave.length === 0) {
                  // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ ‚Äî recovery —É–∂–µ –∑–∞–ø—É—â–µ–Ω
                  log(`‚ö†Ô∏è [PRODUCTS] Skipping save of 0 products (recovery should handle this)`);
                  return;
                }

                // üõ°Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ü–ï–†–ï–î –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é
                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ë–û–õ–¨–®–ï —á–µ–º remote ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:
                // 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —à—Ç–∞–º–ø–æ–≤
                // 2. –ù–æ –æ–Ω–∏ –Ω–µ —É—Å–ø–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ –æ–±–ª–∞–∫–æ (network error)
                // 3. Cloud sync –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ç–µ—Ä–µ—Ç—å –∏—Ö —Å—Ç–∞—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –æ–±–ª–∞–∫–∞
                // –†–ï–®–ï–ù–ò–ï: –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ
                let currentLocalProducts = null;
                try {
                  const rawLocal = ls.getItem(key);
                  if (rawLocal) {
                    const parsed = tryParse(rawLocal);
                    currentLocalProducts = Array.isArray(parsed)
                      ? parsed.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0)
                      : null;
                  }
                } catch (e) { }

                if (Array.isArray(currentLocalProducts) && currentLocalProducts.length > valueToSave.length) {
                  logCritical(`üõ°Ô∏è [PRODUCTS FALLBACK] BLOCKED: local (${currentLocalProducts.length}) > remote (${valueToSave.length}). Keeping local, pushing to cloud.`);
                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ
                  const pushObj = {
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: currentLocalProducts,
                    updated_at: new Date().toISOString()
                  };
                  clientUpsertQueue.push(pushObj);
                  scheduleClientPush();
                  return; // –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º localStorage
                }
              }
            }

            if (key.includes('_products') && !key.includes('_products_backup') && !key.includes('_hidden_products') && !key.includes('_favorite_products') && !key.includes('_deleted_products') && global.HEYS?.products?.setAll) {
              // ÔøΩÔ∏è –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ products —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ —ç—Ç–æ–º sync —Ü–∏–∫–ª–µ ‚Äî –ü–†–û–ü–£–°–ö–ê–ï–ú
              // –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞—è –∫–æ–≥–¥–∞ –≤ –ë–î –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —Å products (—Ä–∞–∑–Ω—ã–µ row.k)
              // –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ –º–∞–ø—è—Ç—Å—è –Ω–∞ –æ–¥–∏–Ω scoped key
              if (productsUpdated) {
                return;
              }

              // üõ°Ô∏è BACKUP GUARD: –µ—Å–ª–∏ remote —Å–ª–∏—à–∫–æ–º –º–∞–ª, –∞ backup –±–æ–ª—å—à–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º backup
              if (Array.isArray(valueToSave) && valueToSave.length <= 1) {
                const backupSnapshot = global.HEYS?.utils?.lsGet?.('heys_products_backup', null);
                const backupData = Array.isArray(backupSnapshot?.data)
                  ? backupSnapshot.data.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0)
                  : null;

                if (Array.isArray(backupData) && backupData.length > valueToSave.length) {
                  logCritical(`üõ°Ô∏è [PRODUCTS BACKUP] BLOCKED: remote (${valueToSave.length}) too small, restoring backup (${backupData.length})`);
                  global.HEYS.products.setAll(backupData, { source: 'backup-guard', skipNotify: true, skipCloud: true });
                  productsUpdated = true;
                  latestProducts = backupData;

                  const pushObj = {
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: backupData,
                    updated_at: new Date().toISOString()
                  };
                  clientUpsertQueue.push(pushObj);
                  scheduleClientPush();
                  return;
                }
              }

              // üõ°Ô∏è –î–û–ü. –ó–ê–©–ò–¢–ê: –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º, –µ—Å–ª–∏ in-memory –±–∞–∑–∞ –±–æ–ª—å—à–µ remote
              // v60 FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º –û–ë–ê –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Äî memory –ò localStorage –Ω–∞–ø—Ä—è–º—É—é!
              if (Array.isArray(valueToSave)) {
                const inMemoryProducts = global.HEYS?.products?.getAll?.() || [];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞–ø—Ä—è–º—É—é (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ–≤–µ–µ —á–µ–º memory cache)
                let localStorageProducts = [];
                try {
                  const rawLocal = ls.getItem(key);
                  if (rawLocal) {
                    const parsed = tryParse(rawLocal);
                    if (Array.isArray(parsed)) {
                      localStorageProducts = parsed.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0);
                    }
                  }
                } catch (e) { /* ignore */ }

                // –ë–µ—Ä—ë–º –ú–ê–ö–°–ò–ú–£–ú –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                const currentMax = Math.max(inMemoryProducts.length, localStorageProducts.length);

                if (currentMax > valueToSave.length) {
                  logCritical(`üõ°Ô∏è [PRODUCTS] BLOCKED: local max (${currentMax}) > remote (${valueToSave.length}). Memory: ${inMemoryProducts.length}, localStorage: ${localStorageProducts.length}`);
                  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –±–æ–ª—å—à–µ
                  const bestLocal = inMemoryProducts.length >= localStorageProducts.length ? inMemoryProducts : localStorageProducts;
                  const pushObj = {
                    client_id: client_id,
                    k: normalizeKeyForSupabase(row.k, client_id),
                    v: bestLocal,
                    updated_at: new Date().toISOString()
                  };
                  clientUpsertQueue.push(pushObj);
                  scheduleClientPush();
                  return;
                }
              }

              // v4.8.5: DEBUG - —á—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ setAll –ø–æ—Å–ª–µ merge
              const setAllIron = valueToSave.filter(p => p && p.iron && +p.iron > 0).length;
              const setAllTs = valueToSave.filter(p => p && p.updatedAt).length;
              logCritical(`üìù [SETALL DEBUG] About to call setAll with ${valueToSave.length} products: withIron=${setAllIron}, withTimestamp=${setAllTs}`);

              global.HEYS.products.setAll(valueToSave, { source: 'cloud-sync', skipNotify: true, skipCloud: true });
              productsUpdated = true;
              latestProducts = valueToSave;
            } else {
              // üõ°Ô∏è v60 FIX: –ó–ê–©–ò–¢–ê DAYV2 ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—ã–º–∏ –∏–∑ cloud
              if (key.includes('dayv2_')) {
                const incomingUpdatedAt = valueToSave?.updatedAt || 0;
                try {
                  const existingRaw = ls.getItem(key);
                  if (existingRaw) {
                    const existing = tryParse(existingRaw);
                    const existingUpdatedAt = existing?.updatedAt || 0;

                    if (existingUpdatedAt > incomingUpdatedAt) {
                      logCritical(`üõ°Ô∏è [DAYV2] BLOCKED localStorage overwrite: local (${existingUpdatedAt}) > remote (${incomingUpdatedAt}) for ${key}`);
                      // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º! –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ.
                      // Push –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ cloud —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                      const pushObj = {
                        client_id: client_id,
                        k: normalizeKeyForSupabase(row.k, client_id),
                        v: existing,
                        updated_at: new Date().toISOString()
                      };
                      clientUpsertQueue.push(pushObj);
                      scheduleClientPush();
                      return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å
                    }
                  }
                } catch (e) { /* ignore parse errors */ }
              }

              // üß∑ Backup –ø–µ—Ä–µ–¥ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é dayv2
              if (key.includes('dayv2_')) {
                backupDayV2BeforeOverwrite(key, valueToSave, 'cloud-sync');
                // üöÄ PERF: Defer dayv2 write to batch ‚Äî prevents N individual re-renders
                batchedDayV2Writes.push({ key, valueToSave });
              } else {
                ls.setItem(key, JSON.stringify(valueToSave));
                log(`  ‚úÖ Saved to localStorage: ${key}`);
              }
            }

            // ÔøΩ PERF: dayv2 event dispatch moved to batch block after forEach

            // üß© Dispatch event for widget_layout updates (–¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤)
            if (key.includes('widget_layout')) {
              if (typeof window !== 'undefined' && window.dispatchEvent) {
                // üîá PERF: –û—Ç–∫–ª—é—á–µ–Ω–æ
                // logCritical(`üß© [EVENT] heys:widget-layout-updated dispatched (cloud-sync)`);
                window.dispatchEvent(new CustomEvent('heys:widget-layout-updated', {
                  detail: { layout: valueToSave, source: 'cloud-sync' }
                }));
              }
            }

            // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞ (–±–∞—Ç—á)

            // üöÄ PERF: duplicate dayv2 event dispatch removed (consolidated in batch block)
          } catch (e) { }
        });

        // üöÄ PERF: Batch process all dayv2 writes at once ‚Äî prevents skeleton flicker
        if (batchedDayV2Writes.length > 0) {
          const updatedDates = [];
          batchedDayV2Writes.forEach(({ key, valueToSave }) => {
            ls.setItem(key, JSON.stringify(valueToSave));
            if (global.HEYS?.store?.invalidate) {
              global.HEYS.store.invalidate(key);
            }
            const dateMatch = key.match(/dayv2_(\d{4}-\d{2}-\d{2})$/);
            if (dateMatch) updatedDates.push(dateMatch[1]);
          });
          window.console.info('[HEYS.sinhron] ‚úÖ BATCH WRITE ' + batchedDayV2Writes.length + ' dayv2 records: ' + updatedDates.join(', '));
          // ÔøΩ FIX v65: –ü–æ–º–µ—á–∞–µ–º sync –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º –î–û heys:day-updated, —á—Ç–æ–±—ã cascade pre-sync guard
          // –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª recompute: –∫–æ–≥–¥–∞ renderCard –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ day-updated –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞,
          // _cascadeSyncDone=true ‚Üí cache MISS ‚Üí computeCascadeState —Å —Ä–µ–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π ‚Üí CRS ‚â† null ‚Üí bar settling
          cloud._syncCompletedAt = cloud._syncCompletedAt || Date.now();
          // ÔøΩüîî Dispatch ONE batched event instead of N individual events
          if (updatedDates.length > 0) {
            window.dispatchEvent(new CustomEvent('heys:day-updated', {
              detail: { dates: updatedDates, date: updatedDates[updatedDates.length - 1], source: 'cloud-sync', batch: true }
            }));
            log('üìÖ [EVENT] heys:day-updated BATCH dispatched for ' + updatedDates.length + ' dates (cloud-sync)');
          }
        }

        if (productsUpdated && Array.isArray(latestProducts)) {
          if (typeof window !== 'undefined' && window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('heys:products-updated', {
              detail: { products: latestProducts, previousProducts, count: latestProducts.length, source: 'cloud-sync' }
            }));
            window.dispatchEvent(new CustomEvent('heysProductsUpdated', {
              detail: { products: latestProducts, previousProducts, count: latestProducts.length, source: 'cloud-sync' }
            }));
          }
        }

        muteMirror = false;
        cloud._lastClientSync = { clientId: client_id, ts: now };

        const syncDuration = Math.round(performance.now() - syncStartTime);

        // ‚îÄ‚îÄ [HEYS.sinhron] –ò–¢–û–ì: —Å–æ—Å—Ç–æ—è–Ω–∏–µ dayv2 –≤ localStorage –ü–û–°–õ–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚îÄ‚îÄ
        {
          const postSyncDayKeys = [];
          const postSyncDateCount = {};
          const postSyncDuplicateDetails = [];
          for (let lsi = 0; lsi < ls.length; lsi++) {
            const lsk = ls.key(lsi);
            if (lsk && lsk.includes('dayv2_') && !lsk.includes('dayv2_backup_') && lsk.includes(client_id)) {
              const psdm = lsk.match(/(\d{4}-\d{2}-\d{2})/);
              if (psdm) {
                const dateStr = psdm[1];
                try {
                  const dayVal = JSON.parse(ls.getItem(lsk));
                  const meals = dayVal?.meals?.length || 0;
                  postSyncDayKeys.push(dateStr + '(' + meals + 'm)');
                  postSyncDateCount[dateStr] = (postSyncDateCount[dateStr] || 0) + 1;
                  if (postSyncDateCount[dateStr] > 1) {
                    postSyncDuplicateDetails.push(lsk + ' meals=' + meals);
                  }
                } catch (_e) {
                  postSyncDayKeys.push(dateStr + '(err)');
                }
              }
            }
          }
          postSyncDayKeys.sort();
          window.console.info('[HEYS.sinhron] üèÅ –ò–¢–û–ì: dayv2 –≤ localStorage –ü–û–°–õ–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (' + postSyncDayKeys.length + '):', postSyncDayKeys.join(', '));
          if (postSyncDuplicateDetails.length > 0) {
            window.console.warn('[HEYS.sinhron] üêõ –î–£–ë–õ–ò–ö–ê–¢–´ dayv2 –≤ localStorage (' + postSyncDuplicateDetails.length + '):', postSyncDuplicateDetails.join(' | '));
            // –¢–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ–º –í–°–ï –∫–ª—é—á–∏ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏—Å—è –¥–∞—Ç–∞–º–∏
            const dupDates = Object.entries(postSyncDateCount).filter(([, c]) => c > 1).map(([d]) => d);
            for (const dd of dupDates) {
              const allKeysForDate = [];
              for (let lsi = 0; lsi < ls.length; lsi++) {
                const lsk = ls.key(lsi);
                if (lsk && lsk.includes('dayv2_' + dd) && lsk.includes(client_id)) {
                  try {
                    const dv = JSON.parse(ls.getItem(lsk));
                    allKeysForDate.push(lsk + ' meals=' + (dv?.meals?.length || 0) + ' updatedAt=' + (dv?.updatedAt || 0));
                  } catch (_) {
                    allKeysForDate.push(lsk + ' (parse error)');
                  }
                }
              }
              window.console.warn('[HEYS.sinhron] üêõ –î–∞—Ç–∞ ' + dd + ' –∫–ª—é—á–∏:', allKeysForDate.join(' | '));
            }
          }
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö backup-–∫–ª—é—á–µ–π dayv2 (—Å—Ç–∞—Ä—à–µ 24—á)
        try {
          const backupMaxAge = 24 * 60 * 60 * 1000; // 24—á
          const backupKeysToRemove = [];
          for (let lsi = 0; lsi < ls.length; lsi++) {
            const lsk = ls.key(lsi);
            if (lsk && lsk.includes('dayv2_backup_') && lsk.includes(client_id)) {
              try {
                const bv = JSON.parse(ls.getItem(lsk));
                if (bv?.ts && (Date.now() - bv.ts) > backupMaxAge) {
                  backupKeysToRemove.push(lsk);
                }
              } catch (_) { backupKeysToRemove.push(lsk); }
            }
          }
          if (backupKeysToRemove.length > 0) {
            backupKeysToRemove.forEach(k => ls.removeItem(k));
            window.console.info('[HEYS.sinhron] üßπ –£–¥–∞–ª–µ–Ω–æ ' + backupKeysToRemove.length + ' —Å—Ç–∞—Ä—ã—Ö backup dayv2 –∫–ª—é—á–µ–π');
          }
        } catch (_) { }

        // üõ°Ô∏è v64 FIX: –û—á–∏—Å—Ç–∫–∞ "null" –∑–Ω–∞—á–µ–Ω–∏–π dayv2 –∏–∑ localStorage
        // Cloud –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç row.v = null ‚Üí JSON.stringify(null) = "null" ‚Üí getDayData –ª–æ–º–∞–µ—Ç—Å—è
        try {
          const nullKeysToRemove = [];
          for (let lsi = 0; lsi < ls.length; lsi++) {
            const lsk = ls.key(lsi);
            if (lsk && lsk.includes('dayv2_') && !lsk.includes('dayv2_backup_') && lsk.includes(client_id)) {
              const rawVal = ls.getItem(lsk);
              if (rawVal === 'null' || rawVal === 'undefined' || rawVal === '') {
                nullKeysToRemove.push(lsk);
              }
            }
          }
          if (nullKeysToRemove.length > 0) {
            nullKeysToRemove.forEach(k => ls.removeItem(k));
            window.console.info('[HEYS.sinhron] üßπ –£–¥–∞–ª–µ–Ω–æ ' + nullKeysToRemove.length + ' dayv2 –∫–ª—é—á–µ–π —Å null/undefined/empty –∑–Ω–∞—á–µ–Ω–∏–µ–º:', nullKeysToRemove.join(', '));
          }
        } catch (_) { }

        // üßπ –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–ª—é—á–µ–π –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        cleanupDuplicateKeys();

        // üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥: –ø–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        if (!initialSyncCompleted) {
          console.info(`[HEYS.sync] ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${data?.length || 0} –∫–ª—é—á–µ–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${client_id.slice(0, 8)}***`);
        }

        logCritical(`‚úÖ [SYNC DONE] client=${client_id.slice(0, 8)} keys=${data?.length || 0} ms=${syncDuration} force=${!!forceSync}`);

        // üö® –†–∞–∑—Ä–µ—à–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ sync
        initialSyncCompleted = true;
        cloud._syncCompletedAt = Date.now(); // ‚è±Ô∏è Grace period: 10 —Å–µ–∫ –±–µ–∑ re-upload products
        cloud._productsFingerprint = null; // üîÑ Delta-sync: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ
        cancelFailsafeTimer(); // –û—Ç–º–µ–Ω—è–µ–º failsafe ‚Äî sync —É—Å–ø–µ—à–µ–Ω

        // üßπ Deferred cleanup: –ø—Ä–∏ delta fast-path cleanup –±—ã–ª –ø—Ä–æ–ø—É—â–µ–Ω ‚Äî –¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ sync
        if (isDeltaFastPath) {
          setTimeout(() => {
            try { cloud.cleanupProducts(); } catch (_) { }
          }, 2000);
        }

        // üîÑ –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º memory-–∫—ç—à Store –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–π –∑–∞–ø–∏—Å–∏ –≤ localStorage
        // –ò–Ω–∞—á–µ lsGet() –≤–µ—Ä–Ω—ë—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ –ø—Ä–∏ pull-to-refresh
        if (global.HEYS?.store?.flushMemory) {
          global.HEYS.store.flushMemory();
        }

        // üßπ –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞–∫–∞ –æ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
        if (!cloud._cloudCleanupDone) {
          cloud._cloudCleanupDone = true;
          setTimeout(() => {
            cloud.cleanupCloudProducts().then(result => {
              if (result.cleaned > 0) {
                logCritical(`‚òÅÔ∏è [AUTO CLOUD CLEANUP] Cleaned ${result.cleaned} invalid products from cloud`);
              }
            }).catch(e => {
              console.error('[AUTO CLOUD CLEANUP] Error:', e);
            });
          }, 2000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫ —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å UI
        }

        // ÔøΩ v6: Shared products —Ç–µ–ø–µ—Ä—å –≥—Ä—É–∑—è—Ç—Å—è –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û —Å sync (—Å–º. –Ω–∞—á–∞–ª–æ _syncInProgress)
        // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –∂–¥—ë–º –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
        if (_sharedProductsPromise) {
          await _sharedProductsPromise;
          _sharedProductsPromise = null;
        }

        // üÜï v4.8.0: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –æ–±–ª–∞–∫–æ–º
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–≤–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ" —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if (global.HEYS?.deletedProducts?.exportForSync) {
          const deletedListKey = `heys_${client_id}_deleted_products`;
          try {
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
            const { data: cloudDeleted, error: deletedError } = await YandexAPI.from('client_kv_store')
              .select('v')
              .eq('client_id', client_id)
              .eq('k', deletedListKey);

            const deletedRow = Array.isArray(cloudDeleted) ? cloudDeleted[0] : cloudDeleted;
            if (!deletedError && deletedRow?.v) {
              // –ú–µ—Ä–∂–∏–º –æ–±–ª–∞—á–Ω—ã–µ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏
              const imported = global.HEYS.deletedProducts.importFromSync(deletedRow.v);
              if (imported > 0) {
                logCritical(`‚òÅÔ∏è [DELETED SYNC] Merged ${imported} deleted products from cloud`);
              }
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ –æ–±–ª–∞–∫–æ
            const localExport = global.HEYS.deletedProducts.exportForSync();
            if (Object.keys(localExport.entries).length > 0) {
              const upsertObj = {
                client_id: client_id,
                k: deletedListKey,
                v: localExport,
                updated_at: new Date().toISOString()
              };
              clientUpsertQueue.push(upsertObj);
              scheduleClientPush();
              logCritical(`‚òÅÔ∏è [DELETED SYNC] Queued ${Object.keys(localExport.entries).length / 2} deleted products for cloud sync`);
            }
          } catch (e) {
            console.warn('[DELETED SYNC] Error:', e);
          }
        }

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è stepsGoal –∏ —Ç.–¥.)
        // –í–°–ï–ì–î–ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ ‚Äî –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ clientId)
        // v6.0: phase:'full' ‚Äî Adaptive Render Gate –æ—Ç–ª–∏—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π sync –æ—Ç Phase A
        if (typeof window !== 'undefined' && window.dispatchEvent) {
          window.dispatchEvent(new CustomEvent('heysSyncCompleted', { detail: { clientId: client_id, phase: 'full' } }));
        }

        // üöÄ Delta Sync: —Å–æ—Ö—Ä–∞–Ω—è–µ–º timestamp –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ delta sync
        try {
          ls.setItem(`heys_${client_id}_last_sync_ts`, new Date().toISOString());
        } catch (_) { }
      } catch (e) {
        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º)
        logCritical('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', e.message || e);
        err('‚ùå [CLIENT_SYNC] Exception:', e);
        muteMirror = false;
        // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á—Ç–æ–±—ã –≤–Ω–µ—à–Ω–∏–π .catch() –º–æ–≥ –µ—ë –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
        throw e;
      } finally {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ sync in progress
        _syncInProgress = null;
      }
    })(); // end of IIFE

    return _syncInProgress;
  };

  cloud.getCurrentClientId = function () {
    try {
      const raw = global.localStorage.getItem('heys_client_current');
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      // —É–∂–µ —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ JSON
      return global.localStorage.getItem('heys_client_current');
    }
  };

  cloud.isAuthenticated = function () {
    return status === CONNECTION_STATUS.ONLINE && !!user;
  };

  cloud.fetchDays = async function (dates) {
    // YandexAPI –Ω–µ —Ç—Ä–µ–±—É–µ—Ç client/user ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ API Gateway
    if (!Array.isArray(dates) || dates.length === 0) return [];
    const clientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
    if (!clientId) return [];
    if (typeof cloud.isSyncPaused === 'function' && cloud.isSyncPaused()) return [];

    // üîß FIX: –ö–ª—é—á–∏ –≤ –±–∞–∑–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∫–∞–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ, —Ç–∞–∫ –∏ scoped (c clientId)
    const dayKeys = dates.map((d) => `heys_dayv2_${d}`);
    const scopedDayKeys = dates.map((d) => `heys_${clientId}_dayv2_${d}`);
    const keysToFetch = [...new Set([...dayKeys, ...scopedDayKeys])];
    try {
      // YandexAPI –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π timeout
      const { data, error } = await YandexAPI.from('client_kv_store')
        .select('k,v,updated_at')
        .eq('client_id', clientId)
        .in('k', keysToFetch);
      if (error) {
        err('fetchDays select', error);
        return [];
      }

      const ls = global.localStorage;
      muteMirror = true;

      // üîß v3.19.1: –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—ã –¥–ª—è batch-—Å–æ–±—ã—Ç–∏—è (–≤–º–µ—Å—Ç–æ 11 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö)
      const updatedDates = [];

      (data || []).forEach((row) => {
        try {
          const originalKey = row.k || '';
          const isDayKey = originalKey.includes('dayv2_');

          // üîß FIX: –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á –≤ —Ñ–æ—Ä–º–∞—Ç–µ scoped(k) ‚Äî heys_{clientId}_...
          // –ö–ª—é—á–∏ –∏–∑ –±–∞–∑—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ "heys_dayv2_2025-12-24" (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ, –±–µ–∑ clientId)
          // Store.get –∏—Å–ø–æ–ª—å–∑—É–µ—Ç scoped() –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç clientId: "heys_{clientId}_dayv2_..."
          let targetKey = originalKey;
          if (clientId && !originalKey.includes(clientId)) {
            if (originalKey.startsWith('heys_')) {
              targetKey = 'heys_' + clientId + '_' + originalKey.substring('heys_'.length);
            } else {
              targetKey = `heys_${clientId}_${originalKey}`;
            }
          }

          let localVal = null;
          try {
            localVal = JSON.parse(ls.getItem(targetKey));
          } catch (e2) { }

          // –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –Ω–µ–ø—É—Å—Ç—ã–µ –¥–Ω–∏ –ø—É—Å—Ç—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –ò–õ–ò –¥–∞–Ω–Ω—ã–º–∏ —Å –º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º meals
          if (isDayKey) {
            // üîç DEBUG: –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º localStorage –°–ï–ô–ß–ê–° (–Ω–µ –∏–∑ –∫—ç—à–∞ –≤—ã—à–µ!)
            // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è race condition ‚Äî localVal –º–æ–≥ —É—Å—Ç–∞—Ä–µ—Ç—å
            let freshLocalVal = null;
            try {
              freshLocalVal = JSON.parse(ls.getItem(targetKey));
            } catch (e2) { }

            const localMeaningful = isMeaningfulDayData(freshLocalVal);
            const remoteMeaningful = isMeaningfulDayData(row.v);

            // üõ°Ô∏è –ó–ê–©–ò–¢–ê 0: meaningful –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–º remote
            if (localMeaningful && !remoteMeaningful) {
              logCritical(`üõ°Ô∏è [fetchDays] KEEP LOCAL: meaningful local, empty remote for ${targetKey}`);
              return;
            }

            const remoteMealsCount = Array.isArray(row.v?.meals) ? row.v.meals.length : 0;
            const localMealsCount = Array.isArray(freshLocalVal?.meals) ? freshLocalVal.meals.length : 0;
            const remoteHasMeals = remoteMealsCount > 0;
            const localHasMeals = localMealsCount > 0;

            // ÔøΩ v4.7.1: Debug –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã

            // üõ°Ô∏è –ó–ê–©–ò–¢–ê 1: –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –Ω–µ–ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–º–∏
            if (!remoteHasMeals && localHasMeals) {
              logCritical(`üõ°Ô∏è [fetchDays] PROTECTED: Not overwriting local (${localMealsCount} meals) with empty remote`);
              return;
            }

            // üõ°Ô∏è –ó–ê–©–ò–¢–ê 2: –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –µ—Å–ª–∏ local –∏–º–µ–µ—Ç –ë–û–õ–¨–®–ï meals (race condition)
            if (localMealsCount > remoteMealsCount) {
              logCritical(`üõ°Ô∏è [fetchDays] PROTECTED: Local has MORE meals (${localMealsCount} > ${remoteMealsCount}), keeping local`);
              return;
            }

            // üõ°Ô∏è –ó–ê–©–ò–¢–ê 3: –ï—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ meals ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ timestamp
            const remoteUpdated = new Date(row.updated_at || 0).getTime();
            const localUpdated = freshLocalVal?.updatedAt || 0;
            if (localUpdated > remoteUpdated) {
              logCritical(`üõ°Ô∏è [fetchDays] PROTECTED: Local is newer (${localUpdated} > ${remoteUpdated}), keeping local`);
              return;
            }
          }

          // üîß FIX 2025-12-26: –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ cloud
          let valueToStore = row.v;
          if (typeof row.v === 'string' && row.v.startsWith('¬§Z¬§')) {
            const Store = global.HEYS?.store;
            if (Store && typeof Store.decompress === 'function') {
              valueToStore = Store.decompress(row.v);
              log(`üîß [fetchDays] Decompressed ${targetKey} from cloud`);
            }
          }

          // üß∑ Backup –ø–µ—Ä–µ–¥ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é dayv2
          if (isDayKey) {
            backupDayV2BeforeOverwrite(targetKey, valueToStore, 'fetchDays');
          }
          ls.setItem(targetKey, JSON.stringify(valueToStore));

          // üîß FIX: –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º memory –∫—ç—à Store —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π lsGet –ø—Ä–æ—á–∏—Ç–∞–ª –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          // –ë–µ–∑ —ç—Ç–æ–≥–æ Store.get –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –∫—ç—à, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—Ä—è–º—É—é –∑–∞–ø–∏—Å—å –≤ localStorage
          if (global.HEYS?.store?.invalidate) {
            global.HEYS.store.invalidate(targetKey);
          }

          // üîß v3.19.1: –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—ã –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
          if (isDayKey && row.v?.date) {
            updatedDates.push(row.v.date);
          }
        } catch (e3) {
          // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏
        }
      });

      // üîß v3.19.1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –û–î–ù–û batch-—Å–æ–±—ã—Ç–∏–µ –≤–º–µ—Å—Ç–æ N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö
      // –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç –ª–æ–≥–∏ –∏ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      if (updatedDates.length > 0) {
        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏)
        const uniqueDates = [...new Set(updatedDates)];
        log(`[fetchDays] Notifying UI about ${uniqueDates.length} updated days (from ${data?.length || 0} rows)`);
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
        uniqueDates.forEach(date => {
          global.dispatchEvent(new CustomEvent('heys:day-updated', {
            detail: { date, source: 'fetchDays', forceReload: true }
          }));
        });
      }

      muteMirror = false;
      return data || [];
    } catch (e) {
      muteMirror = false;
      err('fetchDays exception', e);
      return [];
    }
  };

  cloud.shouldSyncClient = function (client_id, maxAgeMs) {
    if (!client_id) return false;
    const rec = cloud._lastClientSync;
    if (!rec || rec.clientId !== client_id) return true;
    return (Date.now() - rec.ts) > (maxAgeMs || 4000);
  };

  // üîê –§–ª–∞–≥ _rpcOnlyMode –æ–±—ä—è–≤–ª–µ–Ω –≤—ã—à–µ –≤ —Å–µ–∫—Ü–∏–∏ PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞ ~99)
  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º (–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é)
  cloud.setRpcOnlyMode = function (enabled) {
    _rpcOnlyMode = enabled;
    if (enabled && _pinAuthClientId) {
      log('üîê RPC mode enabled for PIN auth client');
    }
  };
  cloud.isRpcOnlyMode = function () { return _rpcOnlyMode; };

  /**
   * üîê –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —ç—Ç–æ PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ (–ù–ï –∫—É—Ä–∞—Ç–æ—Ä)
   * - PIN auth: _pinAuthClientId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, user === null
   * - –ö—É—Ä–∞—Ç–æ—Ä: user !== null (–µ—Å—Ç—å cloudUser –ø–æ—Å–ª–µ signIn)
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è UI ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ dropdown
   */
  cloud.isPinAuthClient = function () {
    return _pinAuthClientId != null && user === null;
  };

  // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
  let clientUpsertQueue = loadPendingQueue(PENDING_CLIENT_QUEUE_KEY);
  let clientUpsertTimer = null;
  let _uploadInProgress = false;  // üîÑ –§–ª–∞–≥: –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (in-flight)
  let _uploadInFlightCount = 0;   // üîÑ –ö–æ–ª-–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ in-flight –∑–∞–ø—Ä–æ—Å–µ

  /**
   * üîÑ v=34: –í—ã–¥–µ–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è upload ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Å debounce, —Ç–∞–∫ –∏ immediately
   * @param {Array} batch - –º–∞—Å—Å–∏–≤ items –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
   * @returns {Promise<void>}
   */
  async function doClientUpload(batch) {
    if (!batch.length) {
      _uploadInProgress = false;
      _uploadInFlightCount = 0;
      notifySyncCompletedIfDrained();
      return;
    }

    // üöÄ PERF: Serialize uploads ‚Äî prevent concurrent network congestion & timeouts
    if (_uploadInProgress) {
      clientUpsertQueue.push(...batch);
      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();
      console.info('[HEYS.sync] ‚è≥ Upload serialized: ' + batch.length + ' items re-queued (in-flight: ' + _uploadInFlightCount + ')');
      // Schedule retry after current upload finishes
      scheduleClientPush();
      return;
    }

    // ÔøΩÔ∏è v61 FIX: –ò—Å–∫–ª—é—á–∞–µ–º heys_game –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ sync
    // Gamification –º–æ–¥—É–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ —Å–∞–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π XP
    const gamificationKeys = ['heys_game', 'heys_gamification', 'heys_sound_settings'];
    const filteredBatch = batch.filter(item => {
      const normalizedKey = item.k?.replace(/^heys_[0-9a-f-]+_/, 'heys_');
      return !gamificationKeys.includes(normalizedKey) && !gamificationKeys.includes(item.k);
    });

    // –ï—Å–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª–∏ –≤—Å—ë ‚Äî –≤—ã—Ö–æ–¥–∏–º
    if (!filteredBatch.length) {
      _uploadInProgress = false;
      _uploadInFlightCount = 0;
      notifySyncCompletedIfDrained();
      return;
    }

    // üîÑ –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ "–≤ –ø–æ–ª—ë—Ç–µ"
    _uploadInProgress = true;
    _uploadInFlightCount = filteredBatch.length;

    // üîê v=54 FIX: –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API ‚Äî –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º RPC —Ä–µ–∂–∏–º!
    // _rpcOnlyMode = true —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –í–°–ï–• (–∏ –∫–ª–∏–µ–Ω—Ç PIN, –∏ –∫—É—Ä–∞—Ç–æ—Ä)
    // Supabase SDK —É–¥–∞–ª—ë–Ω ‚Äî –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å client/user –¥–ª—è legacy branch
    const canSync = _rpcOnlyMode; // Simplified: —Ç–æ–ª—å–∫–æ RPC —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç
    // üîá v4.7.1: Debug –ª–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
    if (!canSync) {
      // –í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
      console.warn('‚ö†Ô∏è [UPLOAD] canSync=false, returning batch to queue');
      clientUpsertQueue.push(...filteredBatch);
      _uploadInProgress = false;
      _uploadInFlightCount = 0;
      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();
      notifySyncCompletedIfDrained();
      return;
    }

    // –ù–µ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ localStorage
    if (!navigator.onLine) {
      // –í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–≥–¥–∞ —Å–µ—Ç—å –ø–æ—è–≤–∏—Ç—Å—è
      clientUpsertQueue.push(...filteredBatch);
      _uploadInProgress = false;
      _uploadInFlightCount = 0;
      incrementRetry();
      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();
      // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É —Å exponential backoff
      scheduleClientPush();
      notifySyncCompletedIfDrained();
      return;
    }

    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ client_id+k, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const uniqueBatch = [];
    const seenKeys = new Set();
    for (let i = filteredBatch.length - 1; i >= 0; i--) {
      const item = filteredBatch[i];
      const key = `${item.client_id}:${item.k}`;
      if (!seenKeys.has(key)) {
        seenKeys.add(key);
        uniqueBatch.unshift(item);
      }
    }

    try {
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // üîê v=54 FIX: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º RPC —Ä–µ–∂–∏–º (Yandex API)
      // –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API ‚Äî Supabase SDK —É–¥–∞–ª—ë–Ω
      // –£—Å–ª–æ–≤–∏–µ "&& !user" —É–±—Ä–∞–Ω–æ —Ç.–∫. –∫—É—Ä–∞—Ç–æ—Ä —Ç–æ–∂–µ –∏–º–µ–µ—Ç user –Ω–æ –Ω—É–∂–µ–Ω RPC
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      if (_rpcOnlyMode) {
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ client_id
        const byClientId = {};
        uniqueBatch.forEach(item => {
          const cid = item.client_id;
          if (!byClientId[cid]) byClientId[cid] = [];
          byClientId[cid].push({ k: item.k, v: item.v, updated_at: item.updated_at });
        });

        // üîá v4.7.1: Debug –ª–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
        let totalSaved = 0;
        let anyError = null;
        let isAuthError = false; // üîß v58 FIX: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º auth –æ—à–∏–±–∫–∏
        for (const [clientId, items] of Object.entries(byClientId)) {
          const result = await cloud.saveClientViaRPC(clientId, items);
          if (result.success) {
            totalSaved += result.saved || items.length;
          } else {
            anyError = result.error;
            // üîß v58 FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º auth –æ—à–∏–±–∫—É ‚Äî –ù–ï retry –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ!
            if (anyError === 'No auth token available' || anyError === 'No session token') {
              isAuthError = true;
            }
            // –í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
            items.forEach(item => clientUpsertQueue.push({ ...item, client_id: clientId }));
          }
        }

        if (anyError) {
          incrementRetry();
          savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
          notifyPendingChange();

          // üîß v58 FIX: –ü—Ä–∏ auth –æ—à–∏–±–∫–µ –ù–ï –ø–ª–∞–Ω–∏—Ä—É–µ–º retry ‚Äî –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞!
          // –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ –∏ –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ç–æ–∫–µ–Ω (–ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞)
          if (isAuthError) {
            console.warn('‚ö†Ô∏è [UPLOAD] Auth error, NOT retrying ‚Äî waiting for login');
          } else if (retryAttempt < MAX_RETRY_ATTEMPTS) {
            scheduleClientPush();
          } else {
            console.warn('‚ö†Ô∏è [UPLOAD] Max retries reached, data saved locally');
          }
        } else {
          resetRetry();
          logCritical(`‚òÅÔ∏è [YANDEX] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ: ${totalSaved} –∑–∞–ø–∏—Å–µ–π`);
        }

        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();

        // üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        _uploadInProgress = false;
        _uploadInFlightCount = 0;
        // üöÄ PERF: Drain remaining queued items (from serialized uploads)
        if (clientUpsertQueue.length > 0) {
          scheduleClientPush();
        }
        notifySyncCompletedIfDrained();
        return;
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú: —á–µ—Ä–µ–∑ Supabase session (–∫—É—Ä–∞—Ç–æ—Ä)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // üîê –ï—Å–ª–∏ –Ω–µ—Ç user ‚Äî –Ω–µ–ª—å–∑—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
      if (!user) {
        log('‚ö†Ô∏è [SAVE] No user session, returning items to queue');
        clientUpsertQueue.push(...uniqueBatch);
        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();
        _uploadInProgress = false;
        _uploadInFlightCount = 0;
        notifySyncCompletedIfDrained();
        return;
      }

      const promises = uniqueBatch.map(item => {
        // –î–æ–±–∞–≤–ª—è–µ–º user_id –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (—Ç–∞–±–ª–∏—Ü–∞ —Ç—Ä–µ–±—É–µ—Ç NOT NULL)
        const itemWithUser = item.user_id ? item : { ...item, user_id: user.id };

        // Primary key = (client_id, k) ‚Äî –∏–∑–º–µ–Ω–µ–Ω–æ 2025-12-26 (—É–±—Ä–∞–ª–∏ user_id)
        return cloud.upsert('client_kv_store', itemWithUser, 'client_id,k')
          .then(() => ({ success: true, item: itemWithUser }))
          .catch(err => {
            console.error('[DEBUG] Upsert error:', err?.message || err, 'for key:', itemWithUser?.k);
            return { success: false, item: itemWithUser, error: err };
          });
      });

      const results = await Promise.all(promises);
      const failedItems = results.filter(r => !r.success).map(r => r.item);
      const successItems = results.filter(r => r.success).map(r => r.item);

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö
      if (failedItems.length > 0) {
        // –í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
        clientUpsertQueue.push(...failedItems);
        incrementRetry();
        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        notifyPendingChange();

        const authError = results.find(r => !r.success && isAuthError(r.error))?.error;
        if (authError) {
          handleAuthFailure(authError);
          _uploadInProgress = false;
          _uploadInFlightCount = 0;
          notifySyncCompletedIfDrained();
          return;
        }

        // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
        scheduleClientPush();
      } else {
        // –ü–æ–ª–Ω—ã–π —É—Å–ø–µ—Ö ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º retry —Å—á—ë—Ç—á–∏–∫
        resetRetry();
      }

      // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥: –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ (—Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ)
      if (successItems.length > 0) {
        const types = {};
        const otherKeys = []; // DEBUG: –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ "other"
        successItems.forEach(item => {
          const t = item.k.includes('dayv2_') ? 'day' :
            item.k.includes('products') ? 'products' :
              item.k.includes('profile') ? 'profile' : 'other';
          types[t] = (types[t] || 0) + 1;
          if (t === 'other') otherKeys.push(item.k);
        });
        const summary = Object.entries(types).map(([k, v]) => `${k}:${v}`).join(' ');
        logCritical('‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ:', summary);
        // DEBUG: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ "other"
        if (otherKeys.length > 0) {
          logCritical('  ‚îî other keys:', otherKeys.join(', '));
        }

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ UPLOAD (–ù–ï heysSyncCompleted ‚Äî —Ç–æ –¥–ª—è initial download!)
        if (typeof window !== 'undefined' && window.dispatchEvent) {
          window.dispatchEvent(new CustomEvent('heys:data-uploaded', { detail: { saved: successItems.length } }));
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—É—é –æ—á–µ—Ä–µ–¥—å (–µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏, failedItems —É–∂–µ —Ç–∞–º)
      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();
    } catch (e) {
      // –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –∏ —É–≤–µ–ª–∏—á–∏—Ç—å retry
      clientUpsertQueue.push(...uniqueBatch);
      incrementRetry();
      savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
      notifyPendingChange();
      logCritical('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ:', e.message || e);

      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ ‚Äî —Ç—Ä–µ–±—É–µ–º –≤—Ö–æ–¥
      if (isAuthError(e)) {
        handleAuthFailure(e);
        _uploadInProgress = false;
        _uploadInFlightCount = 0;
        notifySyncCompletedIfDrained();
        return;
      }

      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ—à–∏–±–∫–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º –¥–æ retry (exponential backoff)
      if (typeof window !== 'undefined' && window.dispatchEvent) {
        const retryIn = Math.min(5, Math.ceil(getRetryDelay() / 1000)); // —Å–µ–∫—É–Ω–¥ –¥–æ retry
        notifySyncError(e, retryIn);
      }

      // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
      scheduleClientPush();
    }

    // –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    syncProgressDone += uniqueBatch.length;
    if (syncProgressTotal < syncProgressDone) {
      syncProgressTotal = syncProgressDone;
    }
    notifySyncProgress(syncProgressTotal, syncProgressDone);

    // üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ "–≤ –ø–æ–ª—ë—Ç–µ" –ü–ï–†–ï–î —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    _uploadInProgress = false;
    _uploadInFlightCount = 0;

    // üöÄ PERF: Drain remaining queued items (from serialized uploads)
    if (clientUpsertQueue.length > 0) {
      scheduleClientPush();
    }

    notifySyncCompletedIfDrained();
  }

  /**
   * üîÑ v=34: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π upload –±–µ–∑ debounce ‚Äî –¥–ª—è flush –ø–µ—Ä–µ–¥ sync
   * @returns {Promise<void>}
   */
  async function doImmediateClientUpload() {
    // –û—Ç–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
    if (clientUpsertTimer) {
      clearTimeout(clientUpsertTimer);
      clientUpsertTimer = null;
    }

    // –ó–∞–±–∏—Ä–∞–µ–º –≤—Å—é –æ—á–µ—Ä–µ–¥—å
    const batch = clientUpsertQueue.splice(0, clientUpsertQueue.length);
    savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
    notifyPendingChange();

    // –í—ã–ø–æ–ª–Ω—è–µ–º upload
    await doClientUpload(batch);
  }

  /**
   * Debounced upload ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± —Å 500ms –∑–∞–¥–µ—Ä–∂–∫–æ–π
   */
  function scheduleClientPush() {
    if (clientUpsertTimer) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å –≤ localStorage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
    notifyPendingChange();

    const delay = navigator.onLine ? 500 : getRetryDelay();

    clientUpsertTimer = setTimeout(async () => {
      const batch = clientUpsertQueue.splice(0, clientUpsertQueue.length);
      clientUpsertTimer = null;
      await doClientUpload(batch);
    }, delay);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  cloud.getSyncStatus = function (key) {
    if (clientUpsertQueue.some(item => item.k === key)) {
      return 'pending'; // –í –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É
    }
    return 'synced'; // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  cloud.waitForSync = function (key, timeout = 5000) {
    return new Promise((resolve) => {
      const startTime = Date.now();
      const checkSync = () => {
        if (cloud.getSyncStatus(key) === 'synced' || (Date.now() - startTime) > timeout) {
          resolve(cloud.getSyncStatus(key));
        } else {
          setTimeout(checkSync, 100);
        }
      };
      checkSync();
    });
  };
  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—É—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É saveClientKey(k, v) ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ client_id –±–µ—Ä—ë—Ç—Å—è –∏–∑ HEYS.currentClientId.
  cloud.saveClientKey = function (...args) {
    let client_id, k, value;

    // üîÑ –ò–ó–ú–ï–ù–ï–ù–û: –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
    // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–æ–≥–¥–∞ sync –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∏–ª–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
    const waitingForSync = !initialSyncCompleted;

    if (args.length === 3) {
      client_id = args[0];
      k = args[1];
      value = args[2];
    } else if (args.length === 2) {
      k = args[0];
      value = args[1];

      // –ï—Å–ª–∏ –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç client_id –≤ —Ñ–æ—Ä–º–∞—Ç–µ heys_clientId_dayv2_... - –∏–∑–≤–ª–µ–∫–∞–µ–º –µ–≥–æ
      if (k && k.startsWith('heys_') && k.includes('_dayv2_')) {
        const parts = k.split('_');
        if (parts.length >= 3) {
          const extractedId = parts[1]; // –±–µ—Ä–µ–º client_id –∏–∑ –∫–ª—é—á–∞
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ UUID, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ "dayv2"
          if (extractedId && extractedId !== 'dayv2' && extractedId.length > 8) {
            client_id = extractedId;
          }
        }
      }

      // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–ª—é—á–µ–π (heys_profile, heys_products –∏ —Ç.–¥.) –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
      if (!client_id && window.HEYS && window.HEYS.currentClientId) {
        client_id = window.HEYS.currentClientId;
      }

      // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç client_id, –Ω–æ –µ—Å—Ç—å user - —Å–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π client_id –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (!client_id && user && user.id) {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –Ω–æ –≤–∞–ª–∏–¥–Ω—ã–π UUID –Ω–∞ –æ—Å–Ω–æ–≤–µ user.id
        // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ user.id –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—É—Ñ—Ñ–∏–∫—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ UUID
        const userIdShort = user.id.replace(/-/g, '').substring(0, 8);
        client_id = `00000000-0000-4000-8000-${userIdShort}0000`.substring(0, 36);
      }
    } else {
      return;
    }

    if (!client_id) {
      return;
    }

    // üö´ –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º backup-–∫–ª—é—á–∏ –≤ cloud
    if (String(k || '').includes('_backup')) {
      return;
    }

    // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π client_id (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–ª –∫–ª–∏–µ–Ω—Ç–∞)
    if (client_id && client_id.startsWith('00000000-')) {
      // üîß FIX: –í—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (—Ä–∞–Ω—å—à–µ —Ç–æ–ª—å–∫–æ –≤ DEV mode)
      const isProducts = k && (k.includes('products') || k === 'heys_products');
      if (isProducts) {
        console.warn(`[HEYS] üö® PRODUCTS SYNC BLOCKED: default client_id! client_id=${client_id}`);
      }
      log(`‚ö†Ô∏è [SAVE BLOCKED] Skipping save for key '${k}' - default client_id (user hasn't selected client yet)`);
      return; // –¢–∏—Ö–∏–π –ø—Ä–æ–ø—É—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ –≤—ã–±–æ—Ä–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    }

    // üîê PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ user
    const isPinAuth = _pinAuthClientId && _pinAuthClientId === client_id;
    if (!user && !isPinAuth) {
      // ÔøΩ FIX: –Ø–≤–Ω—ã–π warning –¥–ª—è products ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      const isProducts = k && (k.includes('products') || k === 'heys_products');
      if (isProducts) {
        console.warn(`[HEYS] üö® PRODUCTS SYNC BLOCKED: No auth! user=${!!user}, isPinAuth=${isPinAuth}, _pinAuthClientId=${_pinAuthClientId?.slice(0, 8)}, client_id=${client_id?.slice(0, 8)}`);
      }
      // ÔøΩüîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
      log(`üö´ [SAVE BLOCKED] No auth for key '${k}': user=${!!user}, _pinAuthClientId=${_pinAuthClientId}, client_id=${client_id}, isPinAuth=${isPinAuth}`);

      // üî• INSTANT FEEDBACK: –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      if (global.dispatchEvent) {
        global.dispatchEvent(new CustomEvent('heys:sync-error', {
          detail: {
            error: 'auth_required',
            persistent: true
          }
        }));
      }
      return;
    }

    // –î–ª—è –¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª—é–±—ã–µ —Ç–∏–ø—ã
    if (k && k.includes('dayv2_') && !k.includes('backup') && !k.includes('date')) {
      if (typeof value !== 'object' || value === null) {
        return;
      }
      // üö® –ó–ê–©–ò–¢–ê –û–¢ HMR: –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–Ω—å –±–µ–∑ updatedAt (–ø—Ä–∏–∑–Ω–∞–∫ —á—Ç–æ —ç—Ç–æ HMR-—Å–±—Ä–æ—Å, –∞ –Ω–µ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ)
      // –ï—Å–ª–∏ –µ—Å—Ç—å updatedAt ‚Äî —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–¥–∞–∂–µ –ø—É—Å—Ç–æ–≥–æ –¥–Ω—è)
      if (!value.updatedAt && !value.schemaVersion) {
        log(`üö´ [SAVE BLOCKED] Refused to save day without updatedAt (HMR protection) - key: ${k}`);
        return;
      }

      // üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ü–£–°–¢–û–ô –¥–µ–Ω—å –≤ –æ–±–ª–∞–∫–æ –ù–ò–ö–û–ì–î–ê
      // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã–º –¥–Ω—ë–º –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
      // v59 FIX: –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ–≥–¥–∞, –Ω–µ —Ç–æ–ª—å–∫–æ –¥–æ sync ‚Äî –∏–Ω–∞—á–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ç–∞—Ä–æ–π –¥–∞—Ç—ã –∑–∞—Ç–∏—Ä–∞–µ–º –æ–±–ª–∞–∫–æ
      const hasRealData = value.weightMorning ||
        value.steps > 0 ||
        value.waterMl > 0 ||
        (value.meals && value.meals.length > 0 && value.meals.some(m => m.items?.length > 0)) ||
        value.sleepStart ||
        value.sleepEnd ||
        value.dayScore ||
        (value.trainings && value.trainings.length > 0);
      if (!hasRealData) {
        log(`üö´ [SAVE BLOCKED] Empty day not saved to cloud - key: ${k}`);
        return;
      }
    }

    // üîÑ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ö–õ–Æ–ß–ê: –£–±–∏—Ä–∞–µ–º client_id –∏–∑ –∫–ª—é—á–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ Supabase
    // –í localStorage –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è scoped –∫–ª—é—á–∏ (heys_{clientId}_dayv2_...), 
    // –Ω–æ –≤ Supabase client_id —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ –∫–æ–ª–æ–Ω–∫–µ, –ø–æ—ç—Ç–æ–º—É –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å heys_dayv2_...
    let normalizedKey = k;
    if (client_id && k.includes(client_id)) {
      // –£–±–∏—Ä–∞–µ–º client_id –∏–∑ –∫–ª—é—á–∞: heys_{clientId}_dayv2_... ‚Üí heys_dayv2_...
      // –ò–ª–∏ heys_{clientId}_products ‚Üí heys_products
      normalizedKey = k.replace(`heys_${client_id}_`, 'heys_');

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥–≤–æ–π–Ω–æ–π client_id (–±–∞–≥): heys_{id}_{id}_dayv2_... ‚Üí heys_dayv2_...
      if (normalizedKey.includes(client_id)) {
        normalizedKey = normalizedKey.replace(`${client_id}_`, '');
        logCritical(`üêõ [NORMALIZE] Fixed double client_id in key: ${k} ‚Üí ${normalizedKey}`);
      }
    }

    const upsertObj = {
      user_id: user?.id || null, // üîê PIN auth: user –º–æ–∂–µ—Ç –±—ã—Ç—å null
      client_id: client_id,
      k: normalizedKey,
      v: value,
      updated_at: (new Date()).toISOString(),
    };

    // ÔøΩÔ∏è v4.8.3: –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –æ–±–ª–∞–∫–æ –î–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è initial sync
    // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ React useEffect([products]) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç stale localStorage –≤ cloud,
    // –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞—è –æ–±–æ–≥–∞—â—ë–Ω–Ω—ã–µ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏ –¥–∞–Ω–Ω—ã–µ. Sync —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é.
    if (waitingForSync && k && (k.includes('products') || k === 'heys_products')) {
      log(`üö´ [SAVE DEFERRED] Products save blocked ‚Äî waiting for initial sync to load cloud version`);
      return;
    }
    // v4.8.3: Timestamp check –¥–ª—è products ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º–∞—è –≤–µ—Ä—Å–∏—è –°–¢–ê–†–ï–ï —Ç–µ–∫—É—â–µ–π
    // React useEffect —Å debounce –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å stale state –ü–û–°–õ–ï —Ç–æ–≥–æ –∫–∞–∫ sync –∑–∞–≥—Ä—É–∑–∏–ª —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é
    if ((k === 'heys_products' || normalizedKey === 'heys_products') && Array.isArray(value) && value.length > 0) {
      // v4.8.6: –ü–ï–†–í–ò–ß–ù–ê–Ø –∑–∞—â–∏—Ç–∞ ‚Äî –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –î–û –ø–æ–ø—ã—Ç–æ–∫ —á—Ç–µ–Ω–∏—è localStorage
      const savingWithIron = value.filter(p => p && p.iron && +p.iron > 0).length;
      const savingWithTs = value.filter(p => p && p.updatedAt).length;
      logCritical(`üîç [SAVE DEBUG] Products to save: total=${value.length}, withIron=${savingWithIron}, withTimestamp=${savingWithTs}`);

      // üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –ë–ï–ó –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ ‚Äî —ç—Ç–æ stale state!
      // –í –æ–±–ª–∞–∫–µ 290+ products —Å –∂–µ–ª–µ–∑–æ–º, –∞ React –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å <50 ‚Äî –ë–õ–û–ö–ò–†–£–ï–ú
      if (savingWithIron < 50) {
        logCritical(`üö® [SAVE BLOCKED] Quality check: only ${savingWithIron} products with iron (expected 250+)`);
        logCritical(`   This is stale React state without micronutrients. Refusing to overwrite cloud.`);
        return;
      }

      try {
        const currentKey = client_id ? `heys_${client_id}_products` : 'heys_products';
        const currentRaw = localStorage.getItem(currentKey);

        if (currentRaw) {
          const current = JSON.parse(currentRaw);
          if (Array.isArray(current) && current.length > 0) {
            const currentWithIron = current.filter(p => p && p.iron && +p.iron > 0).length;
            const currentWithTs = current.filter(p => p && p.updatedAt).length;
            logCritical(`üîç [SAVE DEBUG] Current localStorage: total=${current.length}, withIron=${currentWithIron}, withTimestamp=${currentWithTs}`);

            // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π updatedAt –≤ –æ–±–µ–∏—Ö –≤–µ—Ä—Å–∏—è—Ö
            const getMaxTimestamp = (arr) => {
              let max = 0;
              for (const p of arr) {
                if (p && p.updatedAt) {
                  const ts = typeof p.updatedAt === 'number' ? p.updatedAt : new Date(p.updatedAt).getTime();
                  if (ts > max) max = ts;
                }
              }
              return max;
            };

            const savingMaxTs = getMaxTimestamp(value);
            const currentMaxTs = getMaxTimestamp(current);
            const delta = currentMaxTs - savingMaxTs;

            logCritical(`üîç [TIMESTAMP CHECK] savingMaxTs=${savingMaxTs} (${new Date(savingMaxTs).toISOString()})`);
            logCritical(`üîç [TIMESTAMP CHECK] currentMaxTs=${currentMaxTs} (${new Date(currentMaxTs).toISOString()})`);
            logCritical(`üîç [TIMESTAMP CHECK] delta=${delta}ms (${Math.round(delta / 1000)}s), threshold=30000ms`);

            // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç–∞—Ä–µ–µ —Ç–µ–∫—É—â–µ–π –Ω–∞ >30 —Å–µ–∫—É–Ω–¥ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º (—ç—Ç–æ stale state)
            if (currentMaxTs > 0 && savingMaxTs > 0 && delta > 30000) {
              logCritical(`üö® [SAVE BLOCKED] Stale products: saving timestamp ${new Date(savingMaxTs).toISOString()} vs current ${new Date(currentMaxTs).toISOString()}`);
              logCritical(`   React state outdated (delta ${Math.round(delta / 1000)}s), current localStorage is fresher`);
              logCritical(`   Refusing to overwrite ${currentWithIron} products with iron with stale version (${savingWithIron} products with iron)`);
              return;
            }

            // v4.8.5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ö–ê–ß–ï–°–¢–í–ê –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –ø—Ä–æ—à–ª–∏ –ø–µ—Ä–≤–∏—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É)
            // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º–∞—è –≤–µ—Ä—Å–∏—è –∏–º–µ–µ—Ç –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–û –º–µ–Ω—å—à–µ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º
            if (currentWithIron >= 100 && savingWithIron < currentWithIron * 0.5) {
              logCritical(`üö® [SAVE BLOCKED] Quality degradation: current has ${currentWithIron} products with iron, saving only ${savingWithIron}`);
              logCritical(`   This looks like stale React state without micronutrients. Blocking save.`);
              return;
            }
          }
        }
      } catch (e) {
        // Ignore parsing errors, allow save to proceed
      }
    }

    // ÔøΩüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ Supabase
    if (k && (k.includes('products') || k === 'heys_products') && Array.isArray(value) && value.length === 0) {
      log(`üö´ [SAVE BLOCKED] Refused to save empty products array to Supabase (key: ${normalizedKey})`);
      return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞—Ç–∏—Ä–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
    }

    // ÔøΩ v5.1: DELTA-SYNC: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º upload products –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
    // –í—ã—á–∏—Å–ª—è–µ–º –±—ã—Å—Ç—Ä—ã–π fingerprint: –¥–ª–∏–Ω–∞ + djb2-hash –∏–º—ë–Ω –∏ timestamps
    if (k === 'heys_products' && Array.isArray(value) && value.length > 0) {
      const _fpArr = value.map(p => (p?.name || '') + (p?.updatedAt || '')).join('|');
      let _fpHash = 0;
      for (let _ci = 0; _ci < _fpArr.length; _ci++) {
        _fpHash = ((_fpHash << 5) - _fpHash + _fpArr.charCodeAt(_ci)) | 0;
      }
      const _fingerprint = value.length + ':' + Math.abs(_fpHash);
      if (cloud._productsFingerprint === _fingerprint) {
        console.info('[HEYS.sync] üîÑ Delta-sync: products –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å (fingerprint=' + _fingerprint + '), upload –ø—Ä–æ–ø—É—â–µ–Ω');
        return;
      }
      cloud._productsFingerprint = _fingerprint;
      console.info('[HEYS.sync] üîÑ Delta-sync: products –∏–∑–º–µ–Ω–∏–ª–∏—Å—å (new fingerprint=' + _fingerprint + '), upload —Ä–∞–∑—Ä–µ—à—ë–Ω');
    }

    // ÔøΩüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    if (k === 'heys_products' && Array.isArray(value)) {
      const validProducts = value.filter(p => p && typeof p.name === 'string' && p.name.trim().length > 0);
      if (validProducts.length !== value.length) {
        logCritical(`üßπ [SAVE FILTER] Filtered ${value.length - validProducts.length} invalid products before save (${value.length} ‚Üí ${validProducts.length})`);
        value = validProducts;
        upsertObj.v = validProducts;
      }
      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç ‚Äî –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
      if (validProducts.length === 0) {
        log(`üö´ [SAVE BLOCKED] All products invalid, refusing to save empty array`);
        return;
      }
    }

    // üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º "–ø—É—Å—Ç–æ–π" –ø—Ä–æ—Ñ–∏–ª—å (–±–µ–∑ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π)
    // –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç HMR-–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫, –∫–æ–≥–¥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    if (k.includes('profile') && !k.includes('backup')) {
      const isValidProfile = value && typeof value === 'object' &&
        (value.age || value.weight || value.height || value.firstName);
      if (!isValidProfile) {
        log(`üö´ [SAVE BLOCKED] Refused to save empty/invalid profile to Supabase (key: ${k})`);
        return;
      }
    }

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const dataType = k === 'heys_products' ? 'üì¶ PRODUCTS' :
      k.includes('dayv2_') ? 'üìÖ DAY' :
        k.includes('_profile') ? 'üë§ PROFILE' : 'üìù OTHER';
    const itemsCount = Array.isArray(value) ? value.length : 'N/A';

    // üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ª–æ–≥–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è —Å —à–∞–≥–∞–º–∏ (—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ)
    // üîá v4.8.2: –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
    // if (k.includes('dayv2_') && value && value.steps > 0) {
    //   logCritical(`üìÖ [DAY SAVE] Saving day ${k} with steps: ${value.steps} | updatedAt: ${value.updatedAt}`);
    // }

    // –õ–æ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è sync
    if (waitingForSync) {
      log(`‚è≥ [QUEUED] Waiting for sync, queuing: ${k}`);
    }

    log(`üíæ [SAVE] ${dataType} | key: ${k} | items: ${itemsCount} | client: ${client_id.substring(0, 8)}...`);

    // üõ°Ô∏è GRACE PERIOD v3: –°—Ä–∞–∑—É –ø–æ—Å–ª–µ sync –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –õ–Æ–ë–´–ï –∫–ª—é—á–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ
    // v3: –ù–ï push –≤ –æ—á–µ—Ä–µ–¥—å –≤–æ–æ–±—â–µ ‚Äî –∏–Ω–∞—á–µ savePendingQueue –ø–µ—Ä—Å–∏—Å—Ç–∏—Ä—É–µ—Ç –∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ
    // flushPendingQueue –æ—Ç–ø—Ä–∞–≤–∏—Ç 405KB –æ–±—Ä–∞—Ç–Ω–æ (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª mirror)
    const _graceAge = cloud._syncCompletedAt ? (Date.now() - cloud._syncCompletedAt) : Infinity;
    const _inGracePeriod = _graceAge < 10000;
    if (_inGracePeriod) {
      // üîá Silent skip ‚Äî data was just downloaded from cloud, no need to re-upload
      return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –≤–º–µ—Å—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    clientUpsertQueue.push(upsertObj);

    // üî• INSTANT FEEDBACK: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º UI –æ —Ç–æ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    // –ù–µ –∂–¥–µ–º —Ç–∞–π–º–µ—Ä–∞ scheduleClientPush, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å "Syncing..." —Å—Ä–∞–∑—É
    savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
    notifyPendingChange();

    scheduleClientPush();

    // ‚ö° IMMEDIATE: –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ —Å—Ä–∞–∑—É
    // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–Ω—è/–ø—Ä–æ—Ñ–∏–ª—è/–Ω–æ—Ä–º/–ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞—Å—Ç—å –≤ –æ–±–ª–∞–∫–æ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
    const isCriticalKey = k && (
      k.includes('dayv2_') ||
      k === 'heys_profile' ||
      k === 'heys_norms' ||
      k === 'heys_hr_zones' ||
      k === 'heys_products'
    );
    if (isCriticalKey && navigator.onLine && !waitingForSync) {
      console.info('[HEYS.sync] ‚ö° Immediate upload', { key: k, client: client_id?.slice(0, 8) });
      doImmediateClientUpload().catch((e) => {
        console.warn('[HEYS.sync] ‚ö†Ô∏è Immediate upload failed', e?.message || e);
      });
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–±–æ–ª—å—à–µ –ù–ï —Å–æ–∑–¥–∞—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  // üîê –î–ª—è PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ id (–±–µ–∑ curator_id)
  cloud.ensureClient = async function (clientId) {
    if (!clientId) return false;

    // üîê PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –∫–ª–∏–µ–Ω—Ç —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω —á–µ—Ä–µ–∑ verify_client_pin
    const isPinAuth = _pinAuthClientId && _pinAuthClientId === clientId;
    if (isPinAuth) {
      return true;
    }

    // üîê Curator-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –∫—É—Ä–∞—Ç–æ—Ä —É–∂–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —Å JWT
    // clients —Ç–∞–±–ª–∏—Ü–∞ —É–±—Ä–∞–Ω–∞ –∏–∑ REST API ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –∫—ç—à –∏–ª–∏ –¥–æ–≤–µ—Ä—è–µ–º JWT
    if (user) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –Ω—ë–º
      const cachedClients = window.HEYS?.curatorClients;
      if (cachedClients && Array.isArray(cachedClients)) {
        const found = cachedClients.some(c => c.id === clientId);
        if (found) return true;
      }
      // –ö—É—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –¥–æ–≤–µ—Ä—è–µ–º —á—Ç–æ clientId –≤–∞–ª–∏–¥–µ–Ω
      // Backend —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ upsert
      return true;
    }

    // –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    return false;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ client_kv_store
  // üîê –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PIN-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–±–µ–∑ user)
  cloud.upsert = async function (tableName, obj, conflictKey) {
    const isPinAuth = _pinAuthClientId && obj.client_id === _pinAuthClientId;

    if (!user && !isPinAuth) {
      throw new Error('User not available');
    }

    try {
      // –ï—Å–ª–∏ —ç—Ç–æ client_kv_store, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç; –∏–Ω–∞—á–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
      if (tableName === 'client_kv_store' && obj.client_id) {
        const _exists = await cloud.ensureClient(obj.client_id);
        if (!_exists) {
          // –£–±—Ä–∞–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ skip upsert (client not found)
          return { skipped: true, reason: 'client_not_found' };
        }
      }

      const { error } = await YandexAPI.from(tableName)
        .upsert(obj, { onConflict: conflictKey || 'client_id,k' });

      if (error) {
        throw error;
      } else {
        return { success: true };
      }
    } catch (e) {
      throw e;
    }
  };

  // –æ—á–µ—Ä–µ–¥—å upsert'–æ–≤
  let upsertQueue = loadPendingQueue(PENDING_QUEUE_KEY);
  let upsertTimer = null;
  function schedulePush() {
    if (upsertTimer) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å –≤ localStorage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
    notifyPendingChange();

    const delay = navigator.onLine ? 300 : getRetryDelay();

    upsertTimer = setTimeout(async () => {
      const batch = upsertQueue.splice(0, upsertQueue.length);
      upsertTimer = null;
      if (!client || !user || !batch.length) {
        savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
        notifyPendingChange();
        return;
      }
      // –ù–µ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ localStorage
      if (!navigator.onLine) {
        // –í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–≥–¥–∞ —Å–µ—Ç—å –ø–æ—è–≤–∏—Ç—Å—è
        upsertQueue.push(...batch);
        incrementRetry();
        savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
        notifyPendingChange();
        // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É —Å exponential backoff
        schedulePush();
        return;
      }

      // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ user_id+k, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      const uniqueBatch = [];
      const seenKeys = new Set();
      for (let i = batch.length - 1; i >= 0; i--) {
        const item = batch[i];
        const key = `${item.user_id}:${item.k}`;
        if (!seenKeys.has(key)) {
          seenKeys.add(key);
          uniqueBatch.unshift(item);
        }
      }

      try {
        // YandexAPI –¥–ª—è curator mode upsert
        const { error } = await YandexAPI.from('kv_store').upsert(uniqueBatch, { onConflict: 'user_id,k' });
        if (error) {
          // –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
          upsertQueue.push(...uniqueBatch);
          incrementRetry();
          savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
          notifyPendingChange();
          if (isAuthError(error)) {
            handleAuthFailure(error);
            return;
          }
          notifySyncError(error, Math.min(5, Math.ceil(getRetryDelay() / 1000)));
          err('bulk upsert', error);
          schedulePush();
          return;
        }
        // –£—Å–ø–µ—Ö ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º retry —Å—á—ë—Ç—á–∏–∫
        resetRetry();
        savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
        notifyPendingChange();
      } catch (e) {
        // –ü—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
        upsertQueue.push(...uniqueBatch);
        incrementRetry();
        savePendingQueue(PENDING_QUEUE_KEY, upsertQueue);
        notifyPendingChange();
        if (isAuthError(e)) {
          handleAuthFailure(e);
          return;
        }
        notifySyncError(e, Math.min(5, Math.ceil(getRetryDelay() / 1000)));
        err('bulk upsert exception', e);
        schedulePush();
      }

      // –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
      syncProgressDone += uniqueBatch.length;
      if (syncProgressTotal < syncProgressDone) {
        syncProgressTotal = syncProgressDone;
      }
      notifySyncProgress(syncProgressTotal, syncProgressDone);
      notifySyncCompletedIfDrained();
    }, delay);
  }

  cloud.saveKey = function (k, v) {
    if (!user || !k) return;

    // üõ°Ô∏è GRACE PERIOD v3: Skip re-upload of data just downloaded from cloud
    const _skGrace = cloud._syncCompletedAt ? (Date.now() - cloud._syncCompletedAt) : Infinity;
    if (_skGrace < 10000) return;

    // –ü–æ–ª—É—á–∞–µ–º client_id –¥–ª—è client-level –¥–∞–Ω–Ω—ã—Ö (products, days)
    const clientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;

    // üîÑ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ö–õ–Æ–ß–ê: –£–±–∏—Ä–∞–µ–º client_id –∏–∑ –∫–ª—é—á–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ Supabase
    // –í localStorage –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è scoped –∫–ª—é—á–∏ (heys_{clientId}_products), 
    // –Ω–æ –≤ Supabase client_id —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ –∫–æ–ª–æ–Ω–∫–µ, –ø–æ—ç—Ç–æ–º—É –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å heys_products
    let normalizedKey = k;
    if (clientId && k.includes(clientId)) {
      normalizedKey = k.replace(`heys_${clientId}_`, 'heys_');
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥–≤–æ–π–Ω–æ–π client_id (–±–∞–≥): heys_{id}_{id}_... ‚Üí heys_...
      if (normalizedKey.includes(clientId)) {
        normalizedKey = normalizedKey.replace(`${clientId}_`, '');
      }
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å client_id ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º clientUpsertQueue (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ client_kv_store)
    if (clientId) {
      const clientUpsertObj = {
        user_id: user.id,
        client_id: clientId,
        k: normalizedKey,
        v: v,
        updated_at: (new Date()).toISOString(),
      };
      clientUpsertQueue.push(clientUpsertObj);
      scheduleClientPush();
      return;
    }

    // Fallback –Ω–∞ user-level queue (kv_store) –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ client_id
    const upsertObj = {
      user_id: user.id,
      k: normalizedKey,
      v: v,
      updated_at: (new Date()).toISOString(),
    };
    upsertQueue.push(upsertObj);
    schedulePush();
  };

  cloud.deleteKey = function (k) {
    // –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ .delete(), –∏–ª–∏ —Å—Ç–∞–≤–∏—Ç—å –ø–æ–º–µ—Ç–∫—É
  };

  cloud.clearAll = function () {
    clearNamespace();
  };

  // —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  cloud.lsGet = typeof global.HEYS !== 'undefined' && global.HEYS.lsGet
    ? global.HEYS.lsGet
    : function (k, def) { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch (e) { return def; } };

  cloud.lsSet = typeof global.HEYS !== 'undefined' && global.HEYS.lsSet
    ? global.HEYS.lsSet
    : function (k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { } };

  // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ç–µ—Å—Ç–∞–º–∏
  HEYS.SupabaseConnection = {
    connect: cloud.signIn,
    disconnect: cloud.signOut,
    isConnected: function () { return status === 'online'; },
    getStatus: function () { return status; },
    getUser: function () { return user; },
    sync: cloud.pushAll,
    client: function () { return client; }
  };

  // –ö–æ–≥–¥–∞ —Å–µ—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º retry –∏ –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  global.addEventListener('online', function () {
    addSyncLogEntry('online', { pending: cloud.getPendingCount() });
    resetRetry(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º exponential backoff

    const pendingBefore = cloud.getPendingCount();

    if (clientUpsertQueue.length > 0) {
      scheduleClientPush();
    }
    if (upsertQueue.length > 0) {
      schedulePush();
    }
    notifyPendingChange();

    // –£–≤–µ–¥–æ–º–ª—è–µ–º UI —á—Ç–æ —Å–µ—Ç—å –≤–µ—Ä–Ω—É–ª–∞—Å—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞—á–Ω—ë—Ç—Å—è
    if (pendingBefore > 0) {
      global.dispatchEvent(new CustomEvent('heys:network-restored', {
        detail: { pendingCount: pendingBefore }
      }));
    }
  });

  // –ö–æ–≥–¥–∞ —Å–µ—Ç—å –ø—Ä–æ–ø–∞–¥–∞–µ—Ç ‚Äî –ª–æ–≥–∏—Ä—É–µ–º
  global.addEventListener('offline', function () {
    addSyncLogEntry('offline', { pending: cloud.getPendingCount() });
  });

  /** –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π retry —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
  cloud.retrySync = function () {
    if (!navigator.onLine) return false;

    resetRetry(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º exponential backoff

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –æ–±–µ–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π
    if (clientUpsertQueue.length > 0) {
      if (clientUpsertTimer) clearTimeout(clientUpsertTimer);
      clientUpsertTimer = null;
      scheduleClientPush();
    }
    if (upsertQueue.length > 0) {
      if (upsertTimer) clearTimeout(upsertTimer);
      upsertTimer = null;
      schedulePush();
    }

    return true;
  };

  // –ê–ª–∏–∞—Å—ã –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
  cloud.sync = cloud.retrySync;
  cloud.pushAll = cloud.retrySync;

  /** –û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–ª—é—á–∏ (–¥–≤–æ–π–Ω–æ–π clientId, —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã) */
  function cleanupDuplicateKeys() {
    const keysToRemove = [];
    const currentClientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;

    for (let i = 0; i < global.localStorage.length; i++) {
      const key = global.localStorage.key(i);
      if (!key) continue;

      // 1. –£–¥–∞–ª—è–µ–º –∫–ª—é—á–∏ —Å –¥–≤–æ–π–Ω—ã–º clientId (bug): clientId_clientId_...
      if (key.match(/[a-f0-9-]{36}_[a-f0-9-]{36}_/)) {
        keysToRemove.push(key);
        continue;
      }

      // 2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç _heys_products (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å _products)
      if (key.includes('_heys_products')) {
        keysToRemove.push(key);
        continue;
      }

      // 3. –£–¥–∞–ª—è–µ–º products_backup –µ—Å–ª–∏ –µ—Å—Ç—å products
      if (key.includes('_products_backup') && currentClientId && key.includes(currentClientId)) {
        const normalKey = key.replace('_products_backup', '_products');
        if (global.localStorage.getItem(normalKey)) {
          keysToRemove.push(key);
        }
      }
    }

    if (keysToRemove.length > 0) {
      keysToRemove.forEach(k => global.localStorage.removeItem(k));
      log(`üßπ –û—á–∏—â–µ–Ω–æ ${keysToRemove.length} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–ª—é—á–µ–π`);
    }

    return keysToRemove.length;
  }

  /** –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ localStorage ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-10 –∫–ª—é—á–µ–π –ø–æ —Ä–∞–∑–º–µ—Ä—É */
  cloud.diagnoseStorage = function () {
    const items = [];
    let total = 0;

    for (let key in global.localStorage) {
      if (global.localStorage.hasOwnProperty(key)) {
        const value = global.localStorage.getItem(key) || '';
        const sizeKB = (value.length * 2) / 1024;
        total += sizeKB;
        items.push({ key, sizeKB: sizeKB.toFixed(2), chars: value.length });
      }
    }

    items.sort((a, b) => parseFloat(b.sizeKB) - parseFloat(a.sizeKB));

    console.log('üìä localStorage –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:');
    console.log(`–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${(total / 1024).toFixed(2)} MB`);
    console.log('–¢–æ–ø-10 –ø–æ —Ä–∞–∑–º–µ—Ä—É:');
    console.table(items.slice(0, 10));

    return { totalMB: (total / 1024).toFixed(2), items: items.slice(0, 20) };
  };

  /** –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (–∫—Ä–æ–º–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ auth) */
  cloud.clearClientData = function (keepDays = 30) {
    const clientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
    const prefix = clientId ? clientId + '_' : '';
    let cleaned = 0;

    const keysToRemove = [];
    for (let i = 0; i < global.localStorage.length; i++) {
      const key = global.localStorage.key(i);
      if (key && key.startsWith('heys_') && key.includes(prefix) && key.includes('dayv2_')) {
        const match = key.match(/dayv2_(\d{4}-\d{2}-\d{2})/);
        if (match) {
          const date = new Date(match[1]);
          const cutoff = new Date();
          cutoff.setDate(cutoff.getDate() - keepDays);
          if (date < cutoff) {
            keysToRemove.push(key);
          }
        }
      }
    }

    keysToRemove.forEach(k => {
      global.localStorage.removeItem(k);
      cleaned++;
    });

    console.log(`üßπ –û—á–∏—â–µ–Ω–æ ${cleaned} –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ ${keepDays} –¥–Ω–µ–π`);
    cloud.diagnoseStorage();
    return cleaned;
  };

  /** –û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–ª—é—á–∏ –≤—Ä—É—á–Ω—É—é */
  cloud.cleanupDuplicates = function () {
    return cleanupDuplicateKeys();
  };

  /** –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞) */
  cloud.cleanupOtherClientsProducts = function () {
    const currentClientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;
    if (!currentClientId) {
      console.log('‚ùå –ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞');
      return 0;
    }

    const keysToRemove = [];
    for (let i = 0; i < global.localStorage.length; i++) {
      const key = global.localStorage.key(i);
      if (key && key.includes('_products') && !key.includes(currentClientId)) {
        keysToRemove.push(key);
      }
    }

    keysToRemove.forEach(k => global.localStorage.removeItem(k));
    console.log(`üßπ –£–¥–∞–ª–µ–Ω–æ ${keysToRemove.length} –∫–ª—é—á–µ–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤`);
    cloud.diagnoseStorage();
    return keysToRemove.length;
  };

  /**
   * –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:
   * 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ–±–ª–∞–∫–æ
   * 2. –ñ–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   * 3. –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ localStorage
   * 4. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
   */
  cloud.switchClient = async function (newClientId) {
    if (!newClientId) {
      console.error('[HEYS.sync] ‚ùå –ù–µ —É–∫–∞–∑–∞–Ω ID –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞');
      return false;
    }

    const oldClientId = cloud.getCurrentClientId ? cloud.getCurrentClientId() : null;

    // –ï—Å–ª–∏ —Ç–æ—Ç –∂–µ –∫–ª–∏–µ–Ω—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (oldClientId === newClientId) {
      log('–ö–ª–∏–µ–Ω—Ç —É–∂–µ –≤—ã–±—Ä–∞–Ω:', newClientId);
      return true;
    }

    console.info(`[HEYS.sync] üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ${oldClientId?.substring(0, 8) || '–Ω–µ—Ç'} ‚Üí ${newClientId.substring(0, 8)}`);

    // 1. –°–Ω–∞—á–∞–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ (–µ—Å–ª–∏ –µ—Å—Ç—å pending)
    if (oldClientId && cloud.getPendingCount() > 0) {
      log('‚è≥ –û–∂–∏–¥–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å—Ç–∞—Ä–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞...');

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pending –¥–∞–Ω–Ω—ã–µ
      try {
        // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–º–∞–∫—Å 5 —Å–µ–∫—É–Ω–¥)
        await new Promise((resolve) => {
          let attempts = 0;
          const check = () => {
            if (cloud.getPendingCount() === 0 || attempts >= 10) {
              resolve();
            } else {
              attempts++;
              setTimeout(check, 500);
            }
          };
          // –¢—Ä–∏–≥–≥–µ—Ä–∏–º retry –µ—Å–ª–∏ –µ—Å—Ç—å pending
          if (cloud.retrySync) cloud.retrySync();
          check();
        });
        log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
      } catch (e) {
        logCritical('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ');
      }
    }

    // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π clientId –î–û —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–∏–Ω–∞—á–µ bootstrapClientSync –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)
    //    –ù–æ –Ω–µ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞ –Ω–µ —É–±–µ–¥–∏–º—Å—è —á—Ç–æ sync –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ.
    global.localStorage.setItem('heys_client_current', JSON.stringify(newClientId));

    // 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –æ–±–ª–∞–∫–∞
    log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞...');
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞ (—Ç–æ–∫–µ–Ω –≤ localStorage)
      // ‚ö†Ô∏è –ù–µ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `user` ‚Äî –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!
      let hasCuratorSession = false;
      try {
        const storedToken = global.localStorage.getItem('heys_supabase_auth_token');
        if (storedToken) {
          const parsed = JSON.parse(storedToken);
          hasCuratorSession = !!(parsed?.user && parsed?.access_token);
        }
      } catch (_) { }

      // üîç DEBUG: –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∫–æ–π –ø—É—Ç—å –≤—ã–±—Ä–∞–Ω
      log(`üîç [switchClient] user=${!!user}, hasCuratorSession=${hasCuratorSession}, ‚Üí ${(user || hasCuratorSession) ? 'CURATOR path' : 'PIN path'}`);
      try {
        const hasSessionToken = typeof HEYS !== 'undefined' && HEYS.auth?.getSessionToken
          ? !!HEYS.auth.getSessionToken()
          : !!localStorage.getItem('heys_session_token');
        logCritical(`üîç [switchClient] hasSessionToken=${hasSessionToken}, pinAuthClient=${!!localStorage.getItem('heys_pin_auth_client')}`);
      } catch (_) { }

      // –ï—Å–ª–∏ –µ—Å—Ç—å Supabase user (–∫—É—Ä–∞—Ç–æ—Ä) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
      // –ï—Å–ª–∏ –Ω–µ—Ç (–≤—Ö–æ–¥ –ø–æ PIN) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º RPC –∏ –≤–∫–ª—é—á–∞–µ–º RPC-—Ä–µ–∂–∏–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
      // üîê v=37 FIX: –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º RPC —Ä–µ–∂–∏–º!
      if (user || hasCuratorSession) {
        // –ö—É—Ä–∞—Ç–æ—Ä ‚Äî –µ—Å–ª–∏ user –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ç–æ–∫–µ–Ω–∞
        if (!user && hasCuratorSession) {
          try {
            const storedToken = global.localStorage.getItem('heys_supabase_auth_token');
            const parsed = JSON.parse(storedToken);
            user = parsed.user;
            status = CONNECTION_STATUS.ONLINE;
            logCritical('üîÑ [SWITCH] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω user –∏–∑ —Ç–æ–∫–µ–Ω–∞:', user.email);
          } catch (_) { }
        }
        // üîê v=37 FIX: –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex API –í–°–ï–ì–î–ê RPC —Ä–µ–∂–∏–º!
        _rpcOnlyMode = true;
        // Debug: console.log('üîê [SWITCH] RPC mode ENABLED for curator (Yandex API)');
        _pinAuthClientId = null; // –û—á–∏—â–∞–µ–º PIN auth
        log('üîê [SWITCH] CURATOR path: _pinAuthClientId = null');
        try { global.localStorage.removeItem('heys_pin_auth_client'); } catch (_) { }
        // üöÄ PERF v7.0: Use syncClient for dedup ‚Äî prevents double sync
        // when DayTabWithCloudSync also calls syncClient on client change
        await cloud.syncClient(newClientId, { force: true });
      } else {
        logCritical('üîê [SWITCH] –ù–µ—Ç Supabase —Å–µ—Å—Å–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º RPC sync');
        _rpcOnlyMode = true; // –ö–ª–∏–µ–Ω—Ç –ø–æ PIN ‚Äî RPC —Ä–µ–∂–∏–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
        _pinAuthClientId = newClientId; // üîê –°–æ—Ö—Ä–∞–Ω—è–µ–º client_id –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ saveClientKey
        log(`üîê [SWITCH] PIN path: _pinAuthClientId = "${newClientId}"`);
        // üîê –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ PIN auth –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        try { global.localStorage.setItem('heys_pin_auth_client', newClientId); } catch (_) { }
        // üöÄ v58 FIX: Use syncClient for dedup ‚Äî same pattern as curator path (L6948)
        // Previously called syncClientViaRPC directly, bypassing _syncInFlight dedup.
        // This caused double sync when cloud.init PIN restore also calls syncClient.
        const rpcResult = await cloud.syncClient(newClientId, { force: true });
        if (!rpcResult?.success) {
          throw new Error(rpcResult?.error || 'RPC sync failed');
        }
      }
      // ‚úÖ Sync –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (oldClientId && oldClientId !== newClientId) {
        const keysToRemove = [];
        for (let i = 0; i < global.localStorage.length; i++) {
          const key = global.localStorage.key(i);
          if (key && key.includes(oldClientId) && !key.includes('_auth')) {
            // –ù–µ —É–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
            if (!key.includes('heys_client_current') && !key.includes('heys_user')) {
              keysToRemove.push(key);
            }
          }
        }
        keysToRemove.forEach(k => global.localStorage.removeItem(k));
        log(`üßπ –û—á–∏—â–µ–Ω–æ ${keysToRemove.length} –∫–ª—é—á–µ–π —Å—Ç–∞—Ä–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞`);
      }

      // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
      cleanupDuplicateKeys();

      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –í–°–ï–• –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä–æ–≥–æ)
      const otherProductKeys = [];
      for (let i = 0; i < global.localStorage.length; i++) {
        const key = global.localStorage.key(i);
        if (key && key.includes('_products') && !key.includes(newClientId)) {
          otherProductKeys.push(key);
        }
      }
      otherProductKeys.forEach(k => global.localStorage.removeItem(k));
      if (otherProductKeys.length > 0) {
        log(`üßπ –£–¥–∞–ª–µ–Ω–æ ${otherProductKeys.length} –∫–ª—é—á–µ–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤`);
      }

      log('‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');

      // üöÄ FIX: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º cooldown —á—Ç–æ–±—ã sync effects useEffect –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª –¥—É–±–ª–∏—Ä—É—é—â–∏–π sync
      // v58+: switchClient –∏—Å–ø–æ–ª—å–∑—É–µ—Ç cloud.syncClient() ‚Äî _syncLastCompleted –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
      // Cooldown –Ω–∏–∂–µ ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç race —Å React useEffect –ø–æ—Å–ª–µ client switch.
      _syncLastCompleted[newClientId] = Date.now();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä storage
      const sizeMB = getStorageSize();
      log(`üìä –†–∞–∑–º–µ—Ä localStorage: ${sizeMB.toFixed(2)} MB`);

      // –°–æ–±—ã—Ç–∏–µ heysSyncCompleted —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ bootstrapClientSync/syncClientViaRPC

      // üîî –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è RationTab –∏ –¥—Ä.)
      window.dispatchEvent(new Event('heys:auth-changed'));

      return true;
    } catch (e) {
      logCritical('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:', e);
      // üîÅ v59 FIX J: Do NOT rollback client_current on sync failure.
      // PIN auth already succeeded ‚Äî client is valid. Rolling back creates
      // inconsistency: client_current ‚Üí old, but _pinAuthClientId ‚Üí new.
      // Keep new clientId active ‚Äî bootstrapClientSync will load data on retry.
      // Old behavior rolled back to oldClientId, breaking subsequent sync attempts.
      logCritical('‚ö†Ô∏è [SWITCH] Sync failed but auth valid ‚Äî keeping client_current =', newClientId?.slice(0, 8));
      return false;
    }
  };

  // –£–±—Ä–∞–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ utils lsSet wrapped

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üì∑ PHOTO STORAGE ‚Äî –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ –≤ heys_storage_photos_v1.js
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if (HEYS.StoragePhotos && typeof HEYS.StoragePhotos.attachToCloud === 'function') {
    HEYS.StoragePhotos.attachToCloud(cloud);
  } else if (HEYS.StoragePhotos) {
    cloud.uploadPhoto = HEYS.StoragePhotos.uploadPhoto || cloud.uploadPhoto;
    cloud.uploadPendingPhotos = HEYS.StoragePhotos.uploadPendingPhotos || cloud.uploadPendingPhotos;
    cloud.deletePhoto = HEYS.StoragePhotos.deletePhoto || cloud.deletePhoto;
    cloud.getPendingPhotos = HEYS.StoragePhotos.getPendingPhotos || cloud.getPendingPhotos;
  } else {
    cloud.uploadPhoto = cloud.uploadPhoto || (async function () { return null; });
    cloud.uploadPendingPhotos = cloud.uploadPendingPhotos || (async function () { });
    cloud.deletePhoto = cloud.deletePhoto || (async function () { return false; });
  }

  // üîê Beforeunload: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  if (typeof global.addEventListener === 'function') {
    global.addEventListener('beforeunload', (e) => {
      const activeClientId = global.HEYS?.currentClientId || cloud.getCurrentClientId?.();
      if (global.HEYS?._isLoggingOut || !activeClientId) {
        return;
      }
      if (clientUpsertQueue && clientUpsertQueue.length > 0) {
        logCritical(`‚ö†Ô∏è [BEFOREUNLOAD] ${clientUpsertQueue.length} unsaved items in queue!`);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —É–∂–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
        const hasCriticalData = clientUpsertQueue.some(item =>
          item.k?.includes('products') || item.k?.includes('dayv2_')
        );
        if (hasCriticalData) {
          e.preventDefault();
          e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
          return e.returnValue;
        }
      }
    });
  }

  // === Shared Products API (v3.18.0) ===

  // üîß v3.19.0: –ö—ç—à shared products –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ —É—Ç–∏–ª–∏—Ç (orphan check –∏ –¥—Ä.)
  let _sharedProductsCache = [];
  let _sharedProductsCacheTime = 0;
  const SHARED_PRODUCTS_CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
  const SHARED_PRODUCTS_LS_KEY = 'heys_shared_products_cache_v1';
  const SHARED_PRODUCTS_LS_TTL = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç –¥–ª—è localStorage

  /**
   * –ü–æ–ª—É—á–∏—Ç—å shared products –∏–∑ –∫—ç—à–∞ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
   * @returns {Array} –ú–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   */
  cloud.getCachedSharedProducts = function () {
    // üöÄ –ï—Å–ª–∏ memory cache –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ localStorage
    if ((!_sharedProductsCache || _sharedProductsCache.length === 0)) {
      try {
        const cached = global.localStorage.getItem(SHARED_PRODUCTS_LS_KEY);
        if (cached) {
          const parsed = JSON.parse(cached);
          if (parsed && parsed.ts && (Date.now() - parsed.ts) < SHARED_PRODUCTS_LS_TTL && Array.isArray(parsed.data)) {
            _sharedProductsCache = parsed.data;
            _sharedProductsCacheTime = parsed.ts;
            logCritical(`üì¶ [SHARED PRODUCTS] Restored ${parsed.data.length} products from localStorage cache`);
          }
        }
      } catch (_) { }
    }
    return _sharedProductsCache || [];
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (–¥–ª—è —Ç–∞–±–ª–∏—Ü—ã)
   * @param {Object} options - { limit, excludeBlocklist }
   * @returns {Promise<{data: Array, error: any}>}
   */
  cloud.getAllSharedProducts = async function (options = {}) {
    const { limit = 500, excludeBlocklist = true } = options;

    try {
      const normalizeSharedProduct = (p) => {
        if (!p || typeof p !== 'object') return p;
        if (HEYS.models?.normalizeExtendedProduct) {
          return HEYS.models.normalizeExtendedProduct(p);
        }
        return p;
      };

      let data = null;
      let error = null;

      if (YandexAPI?.rpc) {
        const rpcResult = await YandexAPI.rpc('get_shared_products', {
          p_search: null,
          p_limit: limit,
          p_offset: 0
        });
        data = rpcResult?.data;
        error = rpcResult?.error;
      }

      if (error || !Array.isArray(data)) {
        // üîÑ v3.21.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º shared_products (—Ç–∞–±–ª–∏—Ü–∞) –≤–º–µ—Å—Ç–æ shared_products_public (VIEW)
        // VIEW –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–∑ API ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª auth.uid() –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Yandex Cloud
        const restResult = await YandexAPI.from('shared_products')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(limit);
        data = restResult?.data;
        error = restResult?.error;
      }

      if (error) {
        err('[SHARED PRODUCTS] Get all error:', error);
        return { data: null, error };
      }

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è blocklist –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      let filtered = (data || []).map(normalizeSharedProduct);
      if (excludeBlocklist && user) {
        const blocklist = await cloud.getBlocklist();
        const blocklistSet = new Set(blocklist.map(id => id));
        filtered = filtered.filter(p => !blocklistSet.has(p.id));
      }

      const backfillSharedHarm = async (items) => {
        if (!Array.isArray(items) || !items.length) return items;
        if (!HEYS?.Harm?.calculateHarmScore) return items;

        const lsGet = global.U?.lsGet || cloud.lsGet;
        const lsSet = global.U?.lsSet || cloud.lsSet;
        const cacheKey = 'heys_shared_harm_backfill_v1';

        try {
          const alreadyDone = lsGet ? lsGet(cacheKey, false) : false;
          if (alreadyDone) return items;

          const updates = [];
          const updatedItems = items.map((p) => {
            if (!p || typeof p !== 'object') return p;
            const harmVal = Number.isFinite(p.harm) ? p.harm : null;
            const harmScoreVal = Number.isFinite(p.harmScore) ? p.harmScore : null;
            if (harmVal != null || harmScoreVal != null) return p;

            const computed = HEYS.Harm.calculateHarmScore(p);
            if (!Number.isFinite(computed)) return p;

            if (p.id) {
              updates.push({ id: p.id, harm: computed });
            }

            return { ...p, harm: computed, harmScore: computed };
          });

          if (updates.length > 0 && YandexAPI?.from) {
            const { error: upsertError } = await YandexAPI.from('shared_products')
              .upsert(updates, { onConflict: 'id' });
            if (upsertError) {
              err('[SHARED PRODUCTS] Harm backfill upsert error:', upsertError);
            } else if (lsSet) {
              lsSet(cacheKey, true);
            }
          } else if (lsSet) {
            lsSet(cacheKey, true);
          }

          return updatedItems;
        } catch (e) {
          err('[SHARED PRODUCTS] Harm backfill error:', e);
          return items;
        }
      };

      filtered = await backfillSharedHarm(filtered);

      // üîß v3.19.0: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –¥–ª—è orphan check –∏ –¥—Ä—É–≥–∏—Ö —É—Ç–∏–ª–∏—Ç
      _sharedProductsCache = filtered;
      _sharedProductsCacheTime = Date.now();
      log(`[SHARED PRODUCTS] Loaded ${filtered.length} products total, cached`);

      // üöÄ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ
      try {
        global.localStorage.setItem(SHARED_PRODUCTS_LS_KEY, JSON.stringify({
          ts: Date.now(),
          data: filtered
        }));
      } catch (_) { /* localStorage –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω */ }

      return { data: filtered, error: null };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message };
    }
  };

  /**
   * –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –æ–±—â–µ–π –±–∞–∑–µ (—á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É shared_products)
   * @param {string} query - –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @param {Object} options - { limit, excludeBlocklist }
   * @returns {Promise<{data: Array, error: any}>}
   */
  cloud.searchSharedProducts = async function (query, options = {}) {
    const { limit = 50, excludeBlocklist = true, fingerprint = null } = options;
    const normQuery = (HEYS?.models?.normalizeProductName
      ? HEYS.models.normalizeProductName(query)
      : (query || '').toLowerCase().trim().replace(/\s+/g, ' ').replace(/—ë/g, '–µ'));

    try {
      // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π helper: –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ name_norm —á–µ—Ä–µ–∑ ilike
      const fetchByName = async (nameQ) => {
        const q = (nameQ || '').toString().trim();
        if (!q) return [];
        const { data, error } = await YandexAPI.rest('shared_products', {
          select: '*',
          filters: { 'ilike.name_norm': `%${q}%` },
          order: 'created_at.desc',
          limit
        });
        if (error) throw error;
        return data || [];
      };

      // –°—Ç—Ä–æ–∏–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è YandexAPI.rest()
      const filters = {};

      // –ü–æ–∏—Å–∫ –ø–æ fingerprint (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ) –ò–õ–ò –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
      if (fingerprint) {
        filters['eq.fingerprint'] = fingerprint;
      } else if (normQuery) {
        filters['ilike.name_norm'] = `%${normQuery}%`;
      }

      // üîÑ v3.21.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º shared_products –≤–º–µ—Å—Ç–æ shared_products_public (VIEW —É–¥–∞–ª—ë–Ω)
      let data;
      let error;
      ({ data, error } = await YandexAPI.rest('shared_products', {
        select: '*',
        filters,
        order: 'created_at.desc',
        limit
      }));

      if (error) {
        err('[SHARED PRODUCTS] Search error:', error);
        return { data: null, error };
      }

      // üÜï Fallback –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –æ–ø–µ—á–∞—Ç–æ–∫ (–ø—Ä–∏–º–µ—Ä: "—Å–∞–≤–∞" ‚Üí "—Å–∞–≤–æ—è—Ä–¥–∏")
      // –ï—Å–ª–∏ —Ç–æ—á–Ω—ã–π ILIKE –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ –¥–∞–ª –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –ø—Ä–µ—Ñ–∏–∫—Å.
      // –≠—Ç–æ –¥–µ—à—ë–≤—ã–π server-side —Ö–∞–∫, —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å 1-—Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ.
      if (!fingerprint && normQuery && Array.isArray(data)) {
        const baseCount = data.length;
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º fallback —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª–æ
        if (baseCount < 3 && normQuery.length >= 4) {
          const prefix3 = normQuery.slice(0, 3);
          if (prefix3 && prefix3.length === 3 && prefix3 !== normQuery) {
            try {
              const fallbackData = await fetchByName(prefix3);
              if (fallbackData && fallbackData.length) {
                const byId = new Map();
                (data || []).forEach(p => {
                  const key = p?.id || p?.fingerprint || p?.name;
                  if (key) byId.set(key, p);
                });
                fallbackData.forEach(p => {
                  const key = p?.id || p?.fingerprint || p?.name;
                  if (key && !byId.has(key)) byId.set(key, p);
                });
                data = Array.from(byId.values()).slice(0, limit);
              }
            } catch (e) {
              // Fallback errors should not break primary search
            }
          }
        }
      }

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è blocklist –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      let filtered = data || [];
      if (excludeBlocklist && user) {
        const blocklist = await cloud.getBlocklist();
        const blocklistSet = new Set(blocklist.map(id => id));
        filtered = filtered.filter(p => !blocklistSet.has(p.id));
      }

      log(`[SHARED PRODUCTS] Found ${filtered.length} products for "${query}"`);
      return { data: filtered, error: null };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message };
    }
  };

  /**
   * –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –æ–±—â—É—é –±–∞–∑—É
   * @param {Object} product - –û–±—ä–µ–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {Promise<{data: any, error: any, status: string}>}
   */
  cloud.publishToShared = async function (product) {
    if (!user) {
      try {
        const token = localStorage.getItem('heys_curator_session');
        if (token && HEYS?.YandexAPI?.verifyCuratorToken) {
          const verifyResult = await HEYS.YandexAPI.verifyCuratorToken(token);
          if (verifyResult?.data?.valid && verifyResult.data.user) {
            user = verifyResult.data.user;
          }
        }
      } catch (e) {
        err('[SHARED PRODUCTS] JWT verify failed:', e);
      }
    }

    if (!user) {
      return { data: null, error: 'Not authenticated', status: 'error' };
    }

    try {
      // –í—ã—á–∏—Å–ª—è–µ–º fingerprint
      const fingerprint = await HEYS.models.computeProductFingerprint(product);
      const name_norm = HEYS.models.normalizeProductName(product.name);

      // üîê P3: –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º user.id –Ω–∞–ø—Ä—è–º—É—é (JWT auth)
      // –ö—É—Ä–∞—Ç–æ—Ä –ù–ï –∏–º–µ–µ—Ç session_token ‚Äî –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ JWT
      const curatorId = user?.id;

      if (!curatorId) {
        console.error('[SHARED] ‚ùå No curator ID (user.id)');
        return { data: null, error: 'Not authenticated as curator', status: 'error' };
      }

      // üîê P3: –ò—Å–ø–æ–ª—å–∑—É–µ–º RPC –≤–º–µ—Å—Ç–æ REST (REST —Ç–µ–ø–µ—Ä—å read-only)
      const productData = {
        name: product.name,
        fingerprint,
        simple100: product.simple100 || 0,
        complex100: product.complex100 || 0,
        protein100: product.protein100 || 0,
        badFat100: product.badFat100 ?? product.badfat100 ?? 0,
        goodFat100: product.goodFat100 ?? product.goodfat100 ?? 0,
        trans100: product.trans100 || 0,
        fiber100: product.fiber100 || 0,
        gi: product.gi ?? null,
        harm: product.harm ?? product.harmScore ?? null,
        category: product.category ?? null,
        portions: product.portions || null,
        description: product.description || null,
        // Extended fields (v4.4.0)
        sodium100: product.sodium100 ?? null,
        omega3_100: product.omega3_100 ?? null,
        omega6_100: product.omega6_100 ?? null,
        nova_group: product.nova_group ?? product.novaGroup ?? null,
        additives: product.additives ?? null,
        nutrient_density: product.nutrient_density ?? product.nutrientDensity ?? null,
        is_organic: product.is_organic ?? product.isOrganic ?? false,
        is_whole_grain: product.is_whole_grain ?? product.isWholeGrain ?? false,
        is_fermented: product.is_fermented ?? product.isFermented ?? false,
        is_raw: product.is_raw ?? product.isRaw ?? false,
        // Vitamins
        vitamin_a: product.vitamin_a ?? product.vitaminA ?? null,
        vitamin_c: product.vitamin_c ?? product.vitaminC ?? null,
        vitamin_d: product.vitamin_d ?? product.vitaminD ?? null,
        vitamin_e: product.vitamin_e ?? product.vitaminE ?? null,
        vitamin_k: product.vitamin_k ?? product.vitaminK ?? null,
        vitamin_b1: product.vitamin_b1 ?? product.vitaminB1 ?? null,
        vitamin_b2: product.vitamin_b2 ?? product.vitaminB2 ?? null,
        vitamin_b3: product.vitamin_b3 ?? product.vitaminB3 ?? null,
        vitamin_b6: product.vitamin_b6 ?? product.vitaminB6 ?? null,
        vitamin_b9: product.vitamin_b9 ?? product.vitaminB9 ?? null,
        vitamin_b12: product.vitamin_b12 ?? product.vitaminB12 ?? null,
        // Minerals
        calcium: product.calcium ?? null,
        iron: product.iron ?? null,
        magnesium: product.magnesium ?? null,
        phosphorus: product.phosphorus ?? null,
        potassium: product.potassium ?? null,
        zinc: product.zinc ?? null,
        selenium: product.selenium ?? null,
        iodine: product.iodine ?? null
      };
      console.info('[baza] üì§ publishToShared (supabase) vitamins:', {
        vitamin_b6: productData.vitamin_b6, vitamin_b12: productData.vitamin_b12,
        potassium: productData.potassium, calcium: productData.calcium,
        sodium100: productData.sodium100
      });

      const { data, error } = await YandexAPI.rpc('publish_shared_product_by_curator', {
        p_curator_id: curatorId,
        p_product_data: productData
      });

      if (error) {
        err('[SHARED PRODUCTS] Publish error:', error);
        return { data: null, error, status: 'error' };
      }

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç RPC
      if (data?.success === false) {
        return { data: null, error: data.error, status: 'error', message: data.message };
      }

      const status = data?.status || 'published';
      log('[SHARED PRODUCTS] Result:', status, product.name);

      // üîß v3.22.0: –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à shared products –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
      if (status === 'published') {
        _sharedProductsCacheTime = 0;

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ (—á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å re-fetch)
        const newSharedProduct = {
          ...product,
          ...productData,
          id: data?.id,
          created_at: new Date().toISOString()
        };
        _sharedProductsCache = [newSharedProduct, ..._sharedProductsCache];
      }

      return {
        data: { id: data?.id },
        error: null,
        status,
        message: data?.message
      };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message, status: 'error' };
    }
  };

  /**
   * –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã (—Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä –∏–ª–∏ –∞–≤—Ç–æ—Ä)
   * @param {string} productId - UUID –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ shared_products
   * @returns {Promise<{success: boolean, error: any}>}
   */
  cloud.deleteSharedProduct = async function (productId) {
    if (!user) {
      return { success: false, error: 'Not authenticated' };
    }

    try {
      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç (RLS –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∞: —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –∏–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä)
      const { error } = await YandexAPI.from('shared_products')
        .delete()
        .eq('id', productId);

      if (error) {
        console.error('[SHARED] ‚ùå Delete error:', error);
        return { success: false, error: error.message };
      }

      return { success: true, error: null };
    } catch (e) {
      console.error('[SHARED] ‚ùå Unexpected error:', e);
      return { success: false, error: e.message };
    }
  };

  /**
   * –°–æ–∑–¥–∞–Ω–∏–µ pending-–∑–∞—è–≤–∫–∏ –¥–ª—è PIN-–∫–ª–∏–µ–Ω—Ç–∞ (üîê P1: session-–≤–µ—Ä—Å–∏—è)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞ (ignored, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è session_token)
   * @param {Object} product - –û–±—ä–µ–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {Promise<{data: any, error: any, status: string}>}
   */
  cloud.createPendingProduct = async function (clientId, product) {
    try {
      // üîê P1: –ò—Å–ø–æ–ª—å–∑—É–µ–º session_token –≤–º–µ—Å—Ç–æ client_id
      // üîß FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º HEYS.Auth.getSessionToken() –∏–ª–∏ HEYS.utils.lsGet (–∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç JSON.parse)
      const sessionToken = (typeof HEYS !== 'undefined' && HEYS.Auth?.getSessionToken?.())
        || HEYS.utils?.lsGet?.('heys_session_token', null)
        || (() => { try { return JSON.parse(localStorage.getItem('heys_session_token')); } catch { return null; } })();
      if (!sessionToken) {
        return { data: null, error: 'No session token', status: 'error' };
      }

      const { data, error } = await YandexAPI.rpc('create_pending_product_by_session', {
        p_session_token: sessionToken,
        p_name: product.name,
        p_product_data: product
      });

      if (error) {
        err('[SHARED PRODUCTS] Pending create error:', error);
        return { data: null, error, status: 'error' };
      }

      log('[SHARED PRODUCTS] Pending created:', data);
      return {
        data,
        error: null,
        status: data.status,
        message: data.message
      };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message, status: 'error' };
    }
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å pending-–∑–∞—è–≤–∫–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @returns {Promise<{data: Array, error: any}>}
   */
  cloud.getPendingProducts = async function () {
    if (!user) {
      return { data: null, error: 'Not authenticated' };
    }

    try {
      const { data, error } = await YandexAPI.rest('shared_products_pending', {
        select: '*',
        filters: {
          'eq.curator_id': user.id,
          'eq.status': 'pending'
        },
        order: 'created_at.desc'
      });

      if (error) {
        err('[SHARED PRODUCTS] Get pending error:', error);
        return { data: null, error };
      }

      log(`[SHARED PRODUCTS] Found ${data?.length || 0} pending products`);
      return { data, error: null };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message };
    }
  };

  /**
   * –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å pending-–∑–∞—è–≤–∫—É
   * @param {string} pendingId - ID –∑–∞—è–≤–∫–∏
   * @param {Object} productData - –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –∑–∞—è–≤–∫–∏
   * @returns {Promise<{data: any, error: any, status: string}>}
   */
  cloud.approvePendingProduct = async function (pendingId, productData) {
    if (!user) {
      return { data: null, error: 'Not authenticated', status: 'error' };
    }

    try {
      // 1. –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–æ–¥—É–∫—Ç –≤ shared
      const publishResult = await cloud.publishToShared(productData);

      if (publishResult.error && publishResult.status !== 'exists') {
        return publishResult;
      }

      // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
      const { error: updateError } = await YandexAPI.rest('shared_products_pending', {
        method: 'PATCH',
        filters: { 'eq.id': pendingId },
        data: {
          status: 'approved',
          moderated_at: new Date().toISOString(),
          moderated_by: user.id
        }
      });

      if (updateError) {
        err('[SHARED PRODUCTS] Approve update error:', updateError);
        return { data: null, error: updateError, status: 'error' };
      }

      log('[SHARED PRODUCTS] Approved pending:', pendingId);
      return {
        data: publishResult.data,
        error: null,
        status: 'approved',
        existing: publishResult.status === 'exists'
      };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message, status: 'error' };
    }
  };

  /**
   * –û—Ç–∫–ª–æ–Ω–∏—Ç—å pending-–∑–∞—è–≤–∫—É
   * @param {string} pendingId - ID –∑–∞—è–≤–∫–∏
   * @param {string} reason - –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
   * @returns {Promise<{data: any, error: any}>}
   */
  cloud.rejectPendingProduct = async function (pendingId, reason = '') {
    if (!user) {
      return { data: null, error: 'Not authenticated' };
    }

    try {
      const { data, error } = await YandexAPI.rest('shared_products_pending', {
        method: 'PATCH',
        filters: { 'eq.id': pendingId },
        data: {
          status: 'rejected',
          reject_reason: reason,
          moderated_at: new Date().toISOString(),
          moderated_by: user.id
        },
        select: '*',
        limit: 1
      });

      if (error) {
        err('[SHARED PRODUCTS] Reject error:', error);
        return { data: null, error };
      }

      log('[SHARED PRODUCTS] Rejected pending:', pendingId);
      return { data, error: null };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message };
    }
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å blocklist —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä–∞—Ç–æ—Ä–∞
   * @returns {Promise<Array<string>>} - –ú–∞—Å—Å–∏–≤ ID –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   */
  cloud.getBlocklist = async function () {
    if (!user) return [];

    try {
      const { data, error } = await YandexAPI.rest('shared_products_blocklist', {
        select: 'product_id',
        filters: { 'eq.curator_id': user.id }
      });

      if (error) {
        err('[SHARED PRODUCTS] Get blocklist error:', error);
        return [];
      }

      return (data || []).map(row => row.product_id);
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return [];
    }
  };

  /**
   * –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ blocklist
   * @param {string} productId - ID –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {Promise<{data: any, error: any}>}
   */
  cloud.blockProduct = async function (productId) {
    if (!user) {
      return { data: null, error: 'Not authenticated' };
    }

    try {
      const { data, error } = await YandexAPI.rest('shared_products_blocklist', {
        method: 'POST',
        data: {
          curator_id: user.id,
          product_id: productId
        },
        select: '*',
        limit: 1
      });

      if (error) {
        err('[SHARED PRODUCTS] Block error:', error);
        return { data: null, error };
      }

      log('[SHARED PRODUCTS] Blocked product:', productId);
      return { data, error: null };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message };
    }
  };

  /**
   * –£–±—Ä–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏–∑ blocklist
   * @param {string} productId - ID –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {Promise<{data: any, error: any}>}
   */
  cloud.unblockProduct = async function (productId) {
    if (!user) {
      return { data: null, error: 'Not authenticated' };
    }

    try {
      const { error } = await YandexAPI.rest('shared_products_blocklist', {
        method: 'DELETE',
        filters: {
          'eq.curator_id': user.id,
          'eq.product_id': productId
        }
      });

      if (error) {
        err('[SHARED PRODUCTS] Unblock error:', error);
        return { data: null, error };
      }

      log('[SHARED PRODUCTS] Unblocked product:', productId);
      return { data: true, error: null };
    } catch (e) {
      err('[SHARED PRODUCTS] Unexpected error:', e);
      return { data: null, error: e.message };
    }
  };

})(window);


/* ===== heys_models_v1.js ===== */
// heys_models_v1.js ‚Äî Domain models, Product/Day/User typedefs, computations
; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const M = HEYS.models = HEYS.models || {};

  /** @typedef {Object} Product
   * @property {string|number} id
   * @property {string} name
   * 
   * === REQUIRED MACROS (–Ω–∞ 100–≥) ===
   * @property {number} simple100 - –ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –≥
   * @property {number} complex100 - –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –≥
   * @property {number} protein100 - –ë–µ–ª–æ–∫ –≥
   * @property {number} badFat100 - –ù–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã –≥
   * @property {number} goodFat100 - –ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (MUFA/PUFA) –≥
   * @property {number} trans100 - –¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã –≥
   * @property {number} fiber100 - –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≥
   * 
   * === COMPUTED (–≤—ã—á–∏—Å–ª—è–µ–º—ã–µ) ===
   * @property {number} [carbs100] - –í—Å–µ–≥–æ —É–≥–ª–µ–≤–æ–¥–æ–≤ (simple+complex)
   * @property {number} [fat100] - –í—Å–µ–≥–æ –∂–∏—Ä–æ–≤ (bad+good+trans)
   * @property {number} [kcal100] - –ö–∞–ª–æ—Ä–∏–∏ (Atwater)
   * 
   * === BASIC OPTIONAL ===
   * @property {number} [gi] - –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å 0-100
   * @property {number} [harm] - AI –æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ 0-10
   * @property {number} [harmScore] - Alias –¥–ª—è harm (DB)
   * @property {number} [sodium100] - –ù–∞—Ç—Ä–∏–π –º–≥/100–≥
   * @property {number} [omega3_100] - –û–º–µ–≥–∞-3 –≥/100–≥
   * @property {number} [omega6_100] - –û–º–µ–≥–∞-6 –≥/100–≥
   * @property {number} [nova_group] - NOVA –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è 1-4
   * @property {string[]} [additives] - E-–¥–æ–±–∞–≤–∫–∏ –º–∞—Å—Å–∏–≤
   * @property {number} [nutrient_density] - –ù—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å 0-100
   * 
   * === QUALITY FLAGS ===
   * @property {boolean} [is_organic] - –û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–¥—É–∫—Ç
   * @property {boolean} [is_whole_grain] - –¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π
   * @property {boolean} [is_fermented] - –§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
   * @property {boolean} [is_raw] - –°—ã—Ä–æ–π/–Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π
   * 
   * === VITAMINS (% –æ—Ç DV –Ω–∞ 100–≥) ===
   * @property {number} [vitamin_a] - –í–∏—Ç–∞–º–∏–Ω A % DV
   * @property {number} [vitamin_c] - –í–∏—Ç–∞–º–∏–Ω C % DV
   * @property {number} [vitamin_d] - –í–∏—Ç–∞–º–∏–Ω D % DV
   * @property {number} [vitamin_e] - –í–∏—Ç–∞–º–∏–Ω E % DV
   * @property {number} [vitamin_k] - –í–∏—Ç–∞–º–∏–Ω K % DV
   * @property {number} [vitamin_b1] - –í–∏—Ç–∞–º–∏–Ω B1 % DV
   * @property {number} [vitamin_b2] - –í–∏—Ç–∞–º–∏–Ω B2 % DV
   * @property {number} [vitamin_b3] - –í–∏—Ç–∞–º–∏–Ω B3 % DV
   * @property {number} [vitamin_b6] - –í–∏—Ç–∞–º–∏–Ω B6 % DV
   * @property {number} [vitamin_b9] - –í–∏—Ç–∞–º–∏–Ω B9/Folate % DV
   * @property {number} [vitamin_b12] - –í–∏—Ç–∞–º–∏–Ω B12 % DV
   * 
   * === MINERALS (% –æ—Ç DV –Ω–∞ 100–≥) ===
   * @property {number} [calcium] - –ö–∞–ª—å—Ü–∏–π % DV
   * @property {number} [iron] - –ñ–µ–ª–µ–∑–æ % DV
   * @property {number} [magnesium] - –ú–∞–≥–Ω–∏–π % DV
   * @property {number} [phosphorus] - –§–æ—Å—Ñ–æ—Ä % DV
   * @property {number} [potassium] - –ö–∞–ª–∏–π % DV
   * @property {number} [zinc] - –¶–∏–Ω–∫ % DV
   * @property {number} [selenium] - –°–µ–ª–µ–Ω % DV
   * @property {number} [iodine] - –ô–æ–¥ % DV
   * 
   * === METADATA ===
   * @property {{name: string, grams: number}[]} [portions] - –ü–æ—Ä—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @property {string} [category] - –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @property {string} [shared_origin_id] - ID –≤ shared_products
   */

  // ====================================================================
  // üîß HARM FIELD NORMALIZATION
  // ====================================================================
  // Canonical field: `harm` (used in UI and meal items)
  // DB field: `harmScore` (used in PostgreSQL shared_products)
  // Deprecated: `harmscore` (lowercase), `harm100` (legacy)
  // 
  // Flow: DB(harmScore) ‚Üí normalizeHarm() ‚Üí harm (working field)
  // ====================================================================

  /**
   * Normalize harm value from any field variant
   * @param {Object} obj - Product, MealItem, or any object with harm fields
   * @returns {number|undefined} - Normalized harm value (0-10) or undefined
   */
  function normalizeHarm(obj) {
    if (!obj) return undefined;

    // Priority: harm > harmScore > harmscore > harm100
    const val = obj.harm ?? obj.harmScore ?? obj.harmscore ?? obj.harm100;

    // Deprecation warnings in dev mode
    if (typeof window !== 'undefined' && window.location?.hostname === 'localhost') {
      if (obj.harmscore !== undefined && obj.harm === undefined && obj.harmScore === undefined) {
        console.warn('[HEYS] ‚ö†Ô∏è Deprecated field "harmscore" used. Migrate to "harm" or "harmScore":', obj.name || obj.id);
      }
      if (obj.harm100 !== undefined && obj.harm === undefined && obj.harmScore === undefined) {
        console.warn('[HEYS] ‚ö†Ô∏è Deprecated field "harm100" used. Migrate to "harm" or "harmScore":', obj.name || obj.id);
      }
    }

    return val !== undefined ? Number(val) : undefined;
  }

  /**
   * Normalize product/item to have both harm and harmScore fields
   * @param {Object} obj - Product or MealItem
   * @returns {Object} - Object with normalized harm fields
   */
  function normalizeHarmFields(obj) {
    if (!obj) return obj;

    const harmVal = normalizeHarm(obj);
    if (harmVal === undefined) return obj;

    return {
      ...obj,
      harm: harmVal,
      harmScore: harmVal
    };
  }

  // ====================================================================
  // üîÑ PRODUCT PRIORITY BY ORIGIN (Variant C+)
  // ====================================================================
  // –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞: local vs shared –ø—Ä–æ–¥—É–∫—Ç—ã –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –¥–∞–Ω–Ω—ã—Ö
  // 1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç ‚Üí local wins
  // 2. –ï—Å–ª–∏ shared –æ–±–Ω–æ–≤–∏–ª—Å—è –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí shared wins
  // 3. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Üí local wins
  // ====================================================================

  /**
   * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {Object} localProduct - –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç (–∏–∑ –ª–∏—á–Ω–æ–π –±–∞–∑—ã)
   * @param {Object} sharedProduct - Shared –ø—Ä–æ–¥—É–∫—Ç (–∏–∑ –æ–±—â–µ–π –±–∞–∑—ã, –º–æ–∂–µ—Ç –±—ã—Ç—å null)
   * @returns {'local'|'shared'} - –ö–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   */
  function getProductPrioritySource(localProduct, sharedProduct) {
    if (!localProduct) return 'shared';
    if (!sharedProduct) return 'local';

    // 1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª ‚Äî –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
    if (localProduct.user_modified === true) {
      return 'local';
    }

    // 2. –ï—Å–ª–∏ —ç—Ç–æ –∫–ª–æ–Ω –∏–∑ shared ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–∏–ª—Å—è –ª–∏ shared
    if (localProduct.shared_origin_id) {
      const sharedUpdatedAt = sharedProduct.updated_at
        ? new Date(sharedProduct.updated_at).getTime()
        : 0;
      const clonedAt = localProduct.cloned_at
        || localProduct.createdAt
        || 0;

      // Shared –æ–±–Ω–æ–≤–∏–ª—Å—è –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí shared wins
      if (sharedUpdatedAt > clonedAt) {
        return 'shared';
      }
    }

    // 3. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
    return 'local';
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
   * @param {Object} localProduct - –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
   * @param {Object} sharedProduct - Shared –ø—Ä–æ–¥—É–∫—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
   * @returns {Object} - –ü—Ä–æ–¥—É–∫—Ç —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   */
  function getProductWithPriority(localProduct, sharedProduct) {
    const source = getProductPrioritySource(localProduct, sharedProduct);

    if (source === 'local' || !sharedProduct) {
      return localProduct;
    }

    // Merge: –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ shared, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    return {
      ...sharedProduct,
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
      id: localProduct.id,
      shared_origin_id: localProduct.shared_origin_id,
      cloned_at: localProduct.cloned_at,
      createdAt: localProduct.createdAt,
      user_modified: false,
      // –ú–∞—Ä–∫–µ—Ä –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      _priority_source: 'shared'
    };
  }

  /** @typedef {Object} Portion
   * @property {string} name - –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ü–∏–∏ ("1 —à—Ç", "1 —á.–ª.")
   * @property {number} grams - –ì—Ä–∞–º–º—ã –≤ –ø–æ—Ä—Ü–∏–∏
   */

  // –ê–≤—Ç–æ-–ø–æ—Ä—Ü–∏–∏ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
  // –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å –ø—Ä–æ–±–µ–ª–æ–º –≤ –∫–æ–Ω—Ü–µ ‚Äî –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (—á—Ç–æ–±—ã '—Ä–∏—Å' –Ω–µ –º–∞—Ç—á–∏–ª–æ '—Ä–∏—Å–æ–≤–∞—è –∫–∞—à–∞')
  const AUTO_PORTIONS = {
    // –Ø–π—Ü–∞
    '—è–π—Ü': [{ name: 'ü•ö 1 —à—Ç', grams: 60 }, { name: 'ü•ö 2 —à—Ç', grams: 120 }, { name: 'ü•ö 3 —à—Ç', grams: 180 }],
    // –ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏
    '–º–æ–ª–æ–∫': [{ name: 'ü•õ ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 125 }, { name: 'ü•õ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    '–∫–µ—Ñ–∏—Ä': [{ name: 'ü•õ ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 125 }, { name: 'ü•õ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    '—Ä—è–∂–µ–Ω–∫': [{ name: 'ü•õ ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 125 }, { name: 'ü•õ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    '–π–æ–≥—É—Ä—Ç': [{ name: 'ü•õ 1 –±–∞–Ω–æ—á–∫–∞', grams: 125 }],
    '—Ç–≤–æ—Ä–æ–≥': [{ name: 'ü•õ 1 –ø–∞—á–∫–∞', grams: 180 }, { name: 'ü•õ ¬Ω –ø–∞—á–∫–∏', grams: 90 }],
    // –•–ª–µ–±–æ–±—É–ª–æ—á–Ω—ã–µ
    '—Ö–ª–µ–±': [{ name: 'üçû 1 –ª–æ–º—Ç–∏–∫', grams: 30 }, { name: 'üçû 2 –ª–æ–º—Ç–∏–∫–∞', grams: 60 }],
    '–±–∞—Ç–æ–Ω': [{ name: 'üçû 1 –ª–æ–º—Ç–∏–∫', grams: 25 }],
    '–±—É–ª–∫': [{ name: 'üçû 1 —à—Ç', grams: 50 }],
    // –õ–æ–∂–µ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
    '–º–∞—Å–ª': [{ name: 'ü•Ñ 1 —á.–ª.', grams: 5 }, { name: 'ü•Ñ 1 —Å—Ç.–ª.', grams: 15 }],
    '–º—ë–¥': [{ name: 'üçØ 1 —á.–ª.', grams: 8 }, { name: 'üçØ 1 —Å—Ç.–ª.', grams: 21 }],
    '–º–µ–¥ ': [{ name: 'üçØ 1 —á.–ª.', grams: 8 }, { name: 'üçØ 1 —Å—Ç.–ª.', grams: 21 }],
    '—Å–∞—Ö–∞—Ä': [{ name: 'ü•Ñ 1 —á.–ª.', grams: 5 }, { name: 'ü•Ñ 1 —Å—Ç.–ª.', grams: 15 }],
    '—Å–º–µ—Ç–∞–Ω': [{ name: 'ü•Ñ 1 —Å—Ç.–ª.', grams: 20 }, { name: 'ü•Ñ 2 —Å—Ç.–ª.', grams: 40 }],
    // –§—Ä—É–∫—Ç—ã
    '–±–∞–Ω–∞–Ω': [{ name: 'üçå 1 —à—Ç', grams: 120 }],
    '—è–±–ª–æ–∫': [{ name: 'üçé 1 —à—Ç', grams: 180 }],
    '–∞–ø–µ–ª—å—Å–∏–Ω': [{ name: 'üçä 1 —à—Ç', grams: 200 }],
    '–º–∞–Ω–¥–∞—Ä–∏–Ω': [{ name: 'üçä 1 —à—Ç', grams: 80 }],
    '–≥—Ä—É—à': [{ name: 'üçê 1 —à—Ç', grams: 150 }],
    '–∫–∏–≤–∏': [{ name: 'ü•ù 1 —à—Ç', grams: 80 }],
    '–∞–≤–æ–∫–∞–¥–æ': [{ name: 'ü•ë ¬Ω —à—Ç', grams: 75 }, { name: 'ü•ë 1 —à—Ç', grams: 150 }],
    '–ø–µ—Ä—Å–∏–∫': [{ name: 'üçë 1 —à—Ç', grams: 150 }],
    '–Ω–µ–∫—Ç–∞—Ä–∏–Ω': [{ name: 'üçë 1 —à—Ç', grams: 140 }],
    '—Å–ª–∏–≤': [{ name: 'üçë 1 —à—Ç', grams: 35 }, { name: 'üçë 3 —à—Ç', grams: 105 }],
    '–ª–∏–º–æ–Ω': [{ name: 'üçã 1 –¥–æ–ª—å–∫–∞', grams: 8 }, { name: 'üçã ¬Ω —à—Ç', grams: 30 }],
    '–≤–∏–Ω–æ–≥—Ä–∞–¥': [{ name: 'üçá 1 –≥–æ—Ä—Å—Ç—å', grams: 50 }, { name: 'üçá 100–≥', grams: 100 }],
    // –û–≤–æ—â–∏
    '–æ–≥—É—Ä–µ—Ü': [{ name: 'ü•í 1 —à—Ç', grams: 100 }],
    '–ø–æ–º–∏–¥–æ—Ä': [{ name: 'üçÖ 1 —à—Ç', grams: 120 }],
    '—Ç–æ–º–∞—Ç': [{ name: 'üçÖ 1 —à—Ç', grams: 120 }],
    '–∫–∞—Ä—Ç–æ—Ñ': [{ name: 'ü•î 1 —à—Ç', grams: 100 }],
    '–º–æ—Ä–∫–æ–≤': [{ name: 'ü•ï 1 —à—Ç', grams: 80 }],
    '–ª—É–∫ ': [{ name: 'üßÖ 1 —à—Ç', grams: 75 }],
    '–ª—É–∫–æ–≤': [{ name: 'üßÖ 1 —à—Ç', grams: 75 }],
    '—á–µ—Å–Ω–æ–∫': [{ name: 'üßÑ 1 –∑—É–±—á–∏–∫', grams: 5 }, { name: 'üßÑ 3 –∑—É–±—á–∏–∫–∞', grams: 15 }],
    '–ø–µ—Ä–µ—Ü –±–æ–ª–≥': [{ name: 'ü´ë 1 —à—Ç', grams: 150 }],
    '–∫–∞–ø—É—Å—Ç': [{ name: 'ü•¨ 100–≥', grams: 100 }, { name: 'ü•¨ –ª–∏—Å—Ç', grams: 30 }],
    '–±—Ä–æ–∫–∫–æ–ª–∏': [{ name: 'ü•¶ —Å–æ—Ü–≤–µ—Ç–∏–µ', grams: 25 }, { name: 'ü•¶ 100–≥', grams: 100 }],
    // –ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞
    '–∫—É—Ä–∏–Ω': [{ name: 'üçó 1 —Ñ–∏–ª–µ', grams: 200 }, { name: 'üçó ¬Ω —Ñ–∏–ª–µ', grams: 100 }],
    '–∫—É—Ä–∏—Ü': [{ name: 'üçó 1 —Ñ–∏–ª–µ', grams: 200 }, { name: 'üçó ¬Ω —Ñ–∏–ª–µ', grams: 100 }],
    '–∫–æ—Ç–ª–µ—Ç': [{ name: 'üçî 1 —à—Ç', grams: 80 }, { name: 'üçî 2 —à—Ç', grams: 160 }],
    '—Ç–µ—Ñ—Ç–µ–ª': [{ name: 'üçî 1 —à—Ç', grams: 50 }, { name: 'üçî 3 —à—Ç', grams: 150 }],
    // –°—ã—Ä—ã –∏ –∫–æ–ª–±–∞—Å—ã
    '—Å—ã—Ä': [{ name: 'üßÄ 1 –ª–æ–º—Ç–∏–∫', grams: 20 }],
    '–∫–æ–ª–±–∞—Å': [{ name: 'ü•ì 1 –ª–æ–º—Ç–∏–∫', grams: 20 }],
    '—Å–æ—Å–∏—Å': [{ name: 'üå≠ 1 —à—Ç', grams: 50 }],
    '—Å–∞—Ä–¥–µ–ª—å–∫': [{ name: 'üå≠ 1 —à—Ç', grams: 100 }],
    // –°–ª–∞–¥–æ—Å—Ç–∏
    '–∫–æ–Ω—Ñ–µ—Ç': [{ name: 'üç¨ 1 —à—Ç', grams: 12 }],
    '–ø–µ—á–µ–Ω—å–µ': [{ name: 'üç™ 1 —à—Ç', grams: 10 }, { name: 'üç™ 3 —à—Ç', grams: 30 }],
    '—à–æ–∫–æ–ª–∞–¥': [{ name: 'üç´ 1 –¥–æ–ª—å–∫–∞', grams: 5 }, { name: 'üç´ 1 —Ä—è–¥', grams: 20 }],
    // –í—ã–ø–µ—á–∫–∞ –∏ –±–ª–∏–Ω—ã
    '–±–ª–∏–Ω': [{ name: 'ü•û 1 —à—Ç', grams: 50 }, { name: 'ü•û 3 —à—Ç', grams: 150 }],
    '–æ–ª–∞–¥—å': [{ name: 'ü•û 1 —à—Ç', grams: 30 }, { name: 'ü•û 3 —à—Ç', grams: 90 }],
    '—Å—ã—Ä–Ω–∏–∫': [{ name: 'ü•û 1 —à—Ç', grams: 60 }, { name: 'ü•û 3 —à—Ç', grams: 180 }],
    '–∫—Ä—É–∞—Å—Å–∞–Ω': [{ name: 'ü•ê 1 —à—Ç', grams: 60 }],
    '–≤–∞—Ñ–ª': [{ name: 'üßá 1 —à—Ç', grams: 35 }, { name: 'üßá 2 —à—Ç', grams: 70 }],
    '–±—É–±–ª–∏–∫': [{ name: 'ü•Ø 1 —à—Ç', grams: 80 }],
    '–±–µ–π–≥–ª': [{ name: 'ü•Ø 1 —à—Ç', grams: 90 }],
    '–ø–æ–Ω—á–∏–∫': [{ name: 'üç© 1 —à—Ç', grams: 50 }],
    '–¥–æ–Ω–∞—Ç': [{ name: 'üç© 1 —à—Ç', grams: 60 }],
    '–±–∞–≥–µ—Ç': [{ name: 'ü•ñ 1 –∫—É—Å–æ–∫', grams: 40 }, { name: 'ü•ñ ¬Ω –±–∞–≥–µ—Ç–∞', grams: 125 }],
    '–∫–µ–∫—Å': [{ name: 'üßÅ 1 —à—Ç', grams: 40 }],
    '–º–∞—Ñ—Ñ–∏–Ω': [{ name: 'üßÅ 1 —à—Ç', grams: 60 }],
    '—ç–∫–ª–µ—Ä': [{ name: 'üç∞ 1 —à—Ç', grams: 60 }],
    '–ø–∏—Ä–æ–∂–Ω': [{ name: 'üç∞ 1 —à—Ç', grams: 80 }],
    '—Ç–æ—Ä—Ç': [{ name: 'üéÇ 1 –∫—É—Å–æ–∫', grams: 100 }],
    // –û—Ä–µ—Ö–∏
    '–æ—Ä–µ—Ö': [{ name: 'ü•ú 1 –≥–æ—Ä—Å—Ç—å', grams: 30 }],
    '–º–∏–Ω–¥–∞–ª': [{ name: 'ü•ú 1 –≥–æ—Ä—Å—Ç—å', grams: 30 }],
    '—Ñ—É–Ω–¥—É–∫': [{ name: 'ü•ú 1 –≥–æ—Ä—Å—Ç—å', grams: 30 }],
    '–∫–µ—à—å—é': [{ name: 'ü•ú 1 –≥–æ—Ä—Å—Ç—å', grams: 30 }],
    '–∞—Ä–∞—Ö–∏—Å': [{ name: 'ü•ú 1 –≥–æ—Ä—Å—Ç—å', grams: 30 }],
    '—Å–µ–º–µ—á–∫': [{ name: 'ü•ú 1 –≥–æ—Ä—Å—Ç—å', grams: 30 }],
    // –ù–∞–ø–∏—Ç–∫–∏/–ø—Ä–∏–ø—Ä–∞–≤—ã (—Å—É—Ö–∏–µ)
    '–∫–æ—Ñ–µ': [{ name: '‚òï 1 —á.–ª.', grams: 2 }],
    '—á–∞–π ': [{ name: 'üçµ 1 —á.–ª.', grams: 2 }],
    // –ì–æ—Ç–æ–≤—ã–µ –Ω–∞–ø–∏—Ç–∫–∏
    '–≤–æ–¥–∞': [{ name: 'üíß 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }, { name: 'üíß ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 125 }],
    '–∫–æ–º–ø–æ—Ç': [{ name: 'ü•§ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    '–∫–∏—Å–µ–ª—å': [{ name: 'ü•§ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    '–∫–∞–∫–∞–æ': [{ name: '‚òï 1 —á–∞—à–∫–∞', grams: 200 }],
    '–ª–∞—Ç—Ç–µ': [{ name: '‚òï 1 —á–∞—à–∫–∞', grams: 300 }],
    '–∫–∞–ø—É—á–∏–Ω–æ': [{ name: '‚òï 1 —á–∞—à–∫–∞', grams: 200 }],
    // –ì–∞–∑–∏—Ä–æ–≤–∫–∏
    'cola': [{ name: 'ü•§ 1 –±–∞–Ω–∫–∞', grams: 330 }, { name: 'ü•§ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    '–∫–æ–ª–∞': [{ name: 'ü•§ 1 –±–∞–Ω–∫–∞', grams: 330 }, { name: 'ü•§ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    'fanta': [{ name: 'ü•§ 1 –±–∞–Ω–∫–∞', grams: 330 }],
    '—Ñ–∞–Ω—Ç–∞': [{ name: 'ü•§ 1 –±–∞–Ω–∫–∞', grams: 330 }],
    'sprite': [{ name: 'ü•§ 1 –±–∞–Ω–∫–∞', grams: 330 }],
    '—Å–ø—Ä–∞–π—Ç': [{ name: 'ü•§ 1 –±–∞–Ω–∫–∞', grams: 330 }],
    '–ª–∏–º–æ–Ω–∞–¥': [{ name: 'ü•§ 1 —Å—Ç–∞–∫–∞–Ω', grams: 250 }],
    // –ö—Ä—É–ø—ã –∏ –º–∞–∫–∞—Ä–æ–Ω—ã
    '—Ä–∏—Å ': [{ name: 'üçö ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 100 }],
    '–≥—Ä–µ—á–∫': [{ name: 'üçö ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 100 }],
    '–æ–≤—Å—è–Ω–∫': [{ name: 'ü•£ ¬Ω —Å—Ç–∞–∫–∞–Ω–∞', grams: 50 }],
    '–∫–∞—à–∞': [{ name: 'ü•£ 1 –ø–æ—Ä—Ü–∏—è', grams: 200 }],
    '–º–∞–∫–∞—Ä–æ–Ω': [{ name: 'üçú 1 –ø–æ—Ä—Ü–∏—è', grams: 80 }, { name: 'üçú 2 –ø–æ—Ä—Ü–∏–∏', grams: 160 }],
    '—Å–ø–∞–≥–µ—Ç—Ç–∏': [{ name: 'üçú 1 –ø–æ—Ä—Ü–∏—è', grams: 80 }],
    '–ª–∞–ø—à': [{ name: 'üçú 1 –ø–æ—Ä—Ü–∏—è', grams: 80 }],
    '–ø–∞—Å—Ç–∞': [{ name: 'üçú 1 –ø–æ—Ä—Ü–∏—è', grams: 80 }],
    // –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã
    '–ø–µ–ª—å–º–µ–Ω': [{ name: 'ü•ü 5 —à—Ç', grams: 75 }, { name: 'ü•ü 10 —à—Ç', grams: 150 }, { name: 'ü•ü 15 —à—Ç', grams: 225 }],
    '–≤–∞—Ä–µ–Ω–∏–∫': [{ name: 'ü•ü 5 —à—Ç', grams: 100 }, { name: 'ü•ü 10 —à—Ç', grams: 200 }],
    '–º–∞–Ω—Ç—ã': [{ name: 'ü•ü 1 —à—Ç', grams: 50 }, { name: 'ü•ü 3 —à—Ç', grams: 150 }],
    '—Ö–∏–Ω–∫–∞–ª': [{ name: 'ü•ü 1 —à—Ç', grams: 60 }, { name: 'ü•ü 3 —à—Ç', grams: 180 }],
    // –î–µ—Å–µ—Ä—Ç—ã –∏ —Å–Ω–µ–∫–∏
    '–º–æ—Ä–æ–∂–µ–Ω–æ–µ': [{ name: 'üç¶ 1 —à–∞—Ä–∏–∫', grams: 50 }, { name: 'üç¶ 2 —à–∞—Ä–∏–∫–∞', grams: 100 }],
    '–ø–ª–æ–º–±–∏—Ä': [{ name: 'üç¶ 1 —à–∞—Ä–∏–∫', grams: 50 }],
    '–ø–æ–ø–∫–æ—Ä–Ω': [{ name: 'üçø 1 –≥–æ—Ä—Å—Ç—å', grams: 10 }, { name: 'üçø 1 –ø–æ—Ä—Ü–∏—è', grams: 50 }],
    '—á–∏–ø—Å': [{ name: 'üçø 1 –≥–æ—Ä—Å—Ç—å', grams: 25 }, { name: 'üçø 1 –ø–∞—á–∫–∞', grams: 90 }],
    // –ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ (–æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–≥–æ)
    '–º–∞—Å–ª–æ —Å–ª–∏–≤–æ—á': [{ name: 'üßà 1 –∫—É—Å–æ—á–µ–∫', grams: 10 }, { name: 'üßà 2 –∫—É—Å–æ—á–∫–∞', grams: 20 }],
    // –ú—è—Å–æ –∏ —Å—Ç–µ–π–∫–∏
    '—Å—Ç–µ–π–∫': [{ name: 'ü•© 1 —à—Ç', grams: 150 }, { name: 'ü•© 1 –±–æ–ª—å—à–æ–π', grams: 250 }],
    '–æ—Ç–±–∏–≤–Ω': [{ name: 'ü•© 1 —à—Ç', grams: 150 }],
    '—à–Ω–∏—Ü–µ–ª': [{ name: 'ü•© 1 —à—Ç', grams: 150 }],
    // –§–∞—Å—Ç—Ñ—É–¥
    '–ø–∏—Ü—Ü': [{ name: 'üçï 1 –∫—É—Å–æ–∫', grams: 100 }, { name: 'üçï 2 –∫—É—Å–∫–∞', grams: 200 }],
    '—à–∞—É—Ä–º': [{ name: 'üåØ 1 —à—Ç', grams: 300 }],
    '—à–∞–≤–µ—Ä–º': [{ name: 'üåØ 1 —à—Ç', grams: 300 }],
    '–±—É—Ä–∏—Ç–æ': [{ name: 'üåØ 1 —à—Ç', grams: 300 }],
    '—Ç–∞–∫–æ': [{ name: 'üåÆ 1 —à—Ç', grams: 80 }, { name: 'üåÆ 2 —à—Ç', grams: 160 }],
    '–≥–∞–º–±—É—Ä–≥–µ—Ä': [{ name: 'üçî 1 —à—Ç', grams: 200 }],
    '–±—É—Ä–≥–µ—Ä': [{ name: 'üçî 1 —à—Ç', grams: 200 }],
    '—Ö–æ—Ç-–¥–æ–≥': [{ name: 'üå≠ 1 —à—Ç', grams: 150 }],
    // –°—É—à–∏ –∏ —Ä–æ–ª–ª—ã
    '—Å—É—à': [{ name: 'üç£ 1 —à—Ç', grams: 30 }, { name: 'üç£ 6 —à—Ç', grams: 180 }],
    '—Ä–æ–ª–ª': [{ name: 'üç£ 1 —à—Ç', grams: 30 }, { name: 'üç£ 6 —à—Ç', grams: 180 }, { name: 'üç£ 8 —à—Ç', grams: 240 }],
    // –°–∞–ª–∞—Ç—ã –∏ —Å—É–ø—ã
    '—Å–∞–ª–∞—Ç': [{ name: 'ü•ó 1 –ø–æ—Ä—Ü–∏—è', grams: 150 }, { name: 'ü•ó –±–æ–ª—å—à–∞—è', grams: 250 }],
    '—Å—É–ø': [{ name: 'üç≤ 1 —Ç–∞—Ä–µ–ª–∫–∞', grams: 300 }, { name: 'üç≤ ¬Ω —Ç–∞—Ä–µ–ª–∫–∏', grams: 150 }],
    '–±–æ—Ä—â': [{ name: 'üç≤ 1 —Ç–∞—Ä–µ–ª–∫–∞', grams: 300 }],
    '—â–∏': [{ name: 'üç≤ 1 —Ç–∞—Ä–µ–ª–∫–∞', grams: 300 }],
    '—Å–æ–ª—è–Ω–∫': [{ name: 'üç≤ 1 —Ç–∞—Ä–µ–ª–∫–∞', grams: 300 }],
    '–±—É–ª—å–æ–Ω': [{ name: 'üç≤ 1 —á–∞—à–∫–∞', grams: 250 }],
  };

  // Negative patterns ‚Äî –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–∏ —Å–ª–æ–≤–∞, –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ-–ø–æ—Ä—Ü–∏–∏
  const NEGATIVE_PATTERNS = ['—Å–æ–∫', '–Ω–∞–ø–∏—Ç–æ–∫', '–∫–æ–∫—Ç–µ–π–ª—å', '—Å–º—É–∑–∏', '–ø—é—Ä–µ', '–≤–∞—Ä–µ–Ω—å–µ', '–¥–∂–µ–º', '—Å–æ—É—Å'];

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∞–≤—Ç–æ-–ø–æ—Ä—Ü–∏–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {string} productName - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {{name: string, grams: number}[]} - –ú–∞—Å—Å–∏–≤ –ø–æ—Ä—Ü–∏–π –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   */
  function getAutoPortions(productName) {
    const name = (productName || '').toLowerCase();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º negative patterns ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    for (const neg of NEGATIVE_PATTERNS) {
      if (name.includes(neg)) return [];
    }

    // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –∞–≤—Ç–æ-–ø–æ—Ä—Ü–∏—è–º–∏
    for (const [pattern, portions] of Object.entries(AUTO_PORTIONS)) {
      if (name.includes(pattern)) return portions;
    }
    return [];
  }

  // --- Portion History (–ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ—Ä—Ü–∏–∏) ---
  const PORTION_HISTORY_KEY = 'heys_portion_history';

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ—Ä—Ü–∏—é –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {string|number} productId - ID –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {number|null} - –ì—Ä–∞–º–º—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ—Ä—Ü–∏–∏ –∏–ª–∏ null
   */
  function getLastPortion(productId) {
    try {
      const history = JSON.parse(localStorage.getItem(PORTION_HISTORY_KEY) || '{}');
      return history[String(productId)] || null;
    } catch { return null; }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ—Ä—Ü–∏—é –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {string|number} productId - ID –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {number} grams - –ì—Ä–∞–º–º—ã –ø–æ—Ä—Ü–∏–∏
   */
  function saveLastPortion(productId, grams) {
    try {
      const history = JSON.parse(localStorage.getItem(PORTION_HISTORY_KEY) || '{}');
      history[String(productId)] = grams;
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ 100 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (FIFO)
      const keys = Object.keys(history);
      if (keys.length > 100) {
        delete history[keys[0]];
      }
      localStorage.setItem(PORTION_HISTORY_KEY, JSON.stringify(history));
    } catch { /* ignore */ }
  }

  /** @typedef {Object} MealItem
   * @property {string} id
   * @property {string|number} product_id
   * @property {string} [name]
   * @property {number} grams
   */

  /** @typedef {Object} Meal
   * @property {string} id
   * @property {string} name
   * @property {string} [time]
   * @property {MealItem[]} items
   */

  /** @typedef {Object} DayRecord
   * @property {string} date
   * @property {string} sleepStart
   * @property {string} sleepEnd
   * @property {string} sleepNote
   * @property {number} sleepQuality
   * @property {number} weightMorning
   * @property {number} deficitPct
   * @property {number} steps
   * @property {number} householdMin
   * @property {{z:number[]}[]} trainings
   * @property {number} dayScore
   * @property {number} moodAvg
   * @property {number} wellbeingAvg
   * @property {number} stressAvg
   * @property {string} dayComment
   * @property {number} waterMl - –í—ã–ø–∏—Ç–æ –≤–æ–¥—ã –≤ –º–ª
   * @property {Meal[]} meals
   */

  function round1(v) { return Math.round(v * 10) / 10; }
  function uuid() { return Math.random().toString(36).slice(2, 10); }
  function pad2(n) { return String(n).padStart(2, '0'); }

  // –ù–æ—á–Ω–æ–π –ø–æ—Ä–æ–≥: –¥–æ 03:00 —Å—á–∏—Ç–∞–µ—Ç—Å—è "–≤—á–µ—Ä–∞" (–¥–µ–Ω—å –µ—â—ë –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è)
  const NIGHT_HOUR_THRESHOLD = 3;
  function todayISO() {
    const d = new Date();
    const hour = d.getHours();
    // –î–æ 3:00 ‚Äî —ç—Ç–æ –µ—â—ë "–≤—á–µ—Ä–∞" (–¥–µ–Ω—å –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è)
    if (hour < NIGHT_HOUR_THRESHOLD) {
      d.setDate(d.getDate() - 1);
    }
    return d.getFullYear() + "-" + pad2(d.getMonth() + 1) + "-" + pad2(d.getDate());
  }

  function ensureDay(d, prof) {
    d = d || {};

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∑–∞–¥–∞–Ω –ª–∏ –≤–µ—Å —è–≤–Ω–æ (–Ω–µ —Ä–∞–≤–µ–Ω null/undefined –∏ –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
    const hasExplicitWeight = d.weightMorning != null && d.weightMorning !== '' && d.weightMorning !== 0;

    const base = {
      date: d.date || todayISO(),
      sleepStart: d.sleepStart || '',
      sleepEnd: d.sleepEnd || '',
      sleepNote: d.sleepNote || '',
      // –ï—Å–ª–∏ —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
      sleepQuality: (d.sleepQuality === '') ? '' : (d.sleepQuality != null ? d.sleepQuality : ''),
      // –í–µ—Å: –µ—Å–ª–∏ —è–≤–Ω–æ –∑–∞–¥–∞–Ω, –±–µ—Ä—ë–º –µ–≥–æ; –∏–Ω–∞—á–µ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)
      weightMorning: hasExplicitWeight ? d.weightMorning : (d.weightMorning || ''),
      // –¶–µ–ª–µ–≤–æ–π –¥–µ—Ñ–∏—Ü–∏—Ç: –µ—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–π –≤–µ—Å, –±–µ—Ä—ë–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      deficitPct: hasExplicitWeight ?
        (d.deficitPct != null ? d.deficitPct : (prof && prof.deficitPctTarget) || 0) :
        (d.deficitPct || ''),
      steps: +d.steps || 0,
      householdMin: +d.householdMin || 0,
      // –ú–∞—Å—Å–∏–≤ –±—ã—Ç–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
      householdActivities: Array.isArray(d.householdActivities) ? d.householdActivities : undefined,
      trainings: Array.isArray(d.trainings) ? d.trainings : [],
      // –ï—Å–ª–∏ —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
      dayScore: (d.dayScore === '') ? '' : (d.dayScore != null ? d.dayScore : ''),
      moodAvg: (d.moodAvg === '') ? '' : (d.moodAvg != null ? d.moodAvg : ''),
      wellbeingAvg: (d.wellbeingAvg === '') ? '' : (d.wellbeingAvg != null ? d.wellbeingAvg : ''),
      stressAvg: (d.stressAvg === '') ? '' : (d.stressAvg != null ? d.stressAvg : ''),
      dayComment: d.dayComment || '',
      waterMl: +d.waterMl || 0,
      lastWaterTime: d.lastWaterTime || undefined,
      meals: Array.isArray(d.meals) ? d.meals : [],
      // –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å)
      measurements: d.measurements || undefined,
      // –•–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ (cold_exposure —à–∞–≥)
      coldExposure: d.coldExposure || undefined,
      // –†–∞—Å—á—ë—Ç–Ω—ã–µ —á–∞—Å—ã —Å–Ω–∞
      sleepHours: d.sleepHours != null ? +d.sleepHours : undefined,
      // –í—Ä–µ–º—è –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (legacy)
      householdTime: d.householdTime || undefined,
      // –î–µ–Ω—å –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (null = –Ω–µ —É–∫–∞–∑–∞–Ω, 1-7 = –¥–µ–Ω—å —Ü–∏–∫–ª–∞)
      cycleDay: d.cycleDay != null ? d.cycleDay : null,
      // –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å (Refeed Day)
      isRefeedDay: d.isRefeedDay != null ? d.isRefeedDay : null,
      refeedReason: d.refeedReason || null, // 'deficit' | 'training' | 'holiday' | 'rest'
      // –£—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –∏–∑ morning_mood —à–∞–≥–∞
      moodMorning: d.moodMorning != null ? +d.moodMorning : undefined,
      wellbeingMorning: d.wellbeingMorning != null ? +d.wellbeingMorning : undefined,
      stressMorning: d.stressMorning != null ? +d.stressMorning : undefined,
      // –í–∏—Ç–∞–º–∏–Ω—ã/–¥–æ–±–∞–≤–∫–∏
      supplementsPlanned: Array.isArray(d.supplementsPlanned) ? d.supplementsPlanned : undefined,
      supplementsTaken: Array.isArray(d.supplementsTaken) ? d.supplementsTaken : undefined,
      supplementsTakenAt: d.supplementsTakenAt || undefined,
      // Per-supp metadata (—Ñ–æ—Ä–º–∞/–¥–æ–∑–∞/–≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞). –•—Ä–∞–Ω–∏–º –∫–∞–∫ –æ–±—ä–µ–∫—Ç.
      supplementsTakenMeta: (d.supplementsTakenMeta && typeof d.supplementsTakenMeta === 'object') ? d.supplementsTakenMeta : undefined,
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º metadata –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      updatedAt: d.updatedAt || undefined,
      schemaVersion: d.schemaVersion || undefined,
      _sourceId: d._sourceId || undefined
    };
    // üÜï v3.7.3: –ù–µ —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Ç–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ
    if (!Array.isArray(base.trainings)) base.trainings = [];
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ –ò –±–µ–∑ –∑–æ–Ω)
    const isValidTraining = (t) => {
      if (!t) return false;
      // –ï—Å—Ç—å –≤—Ä–µ–º—è ‚Äî –≤–∞–ª–∏–¥–Ω–∞
      if (t.time && t.time !== '') return true;
      // –ï—Å—Ç—å —Ö–æ—Ç—å –æ–¥–Ω–∞ –∑–æ–Ω–∞ > 0 ‚Äî –≤–∞–ª–∏–¥–Ω–∞  
      const zones = t.z || [];
      return zones.some(z => +z > 0);
    };
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–º–∏–≥—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π)
    base.trainings = base.trainings.filter(isValidTraining).map(t => {
      // –ú–∏–≥—Ä–∞—Ü–∏—è: quality ‚Üí mood, feelAfter ‚Üí wellbeing
      const mood = (t && t.mood !== undefined) ? +t.mood : (t && t.quality !== undefined) ? +t.quality : 5;
      const wellbeing = (t && t.wellbeing !== undefined) ? +t.wellbeing : (t && t.feelAfter !== undefined) ? +t.feelAfter : 5;
      const stress = (t && t.stress !== undefined) ? +t.stress : 5;
      return {
        z: (t && Array.isArray(t.z)) ? [+t.z[0] || 0, +t.z[1] || 0, +t.z[2] || 0, +t.z[3] || 0] : [0, 0, 0, 0],
        time: (t && t.time) || '',
        type: (t && t.type) || '',
        mood: mood,
        wellbeing: wellbeing,
        stress: stress,
        comment: (t && t.comment) || ''
      };
    });
    return base;
  }

  function computeDerivedProduct(p) {
    const carbs = (+p.carbs100) || ((+p.simple100 || 0) + (+p.complex100 || 0));
    const fat = (+p.fat100) || ((+p.badFat100 || 0) + (+p.goodFat100 || 0) + (+p.trans100 || 0));
    // NET Atwater: protein 3 kcal/g (TEF 25% built-in: 4√ó0.75=3), carbs 4 kcal/g, fat 9 kcal/g
    const kcal = 3 * (+p.protein100 || 0) + 4 * carbs + 9 * fat;

    const derived = { carbs100: round1(carbs), fat100: round1(fat), kcal100: round1(kcal) };

    // Auto-calculate harm if not provided (v2.0.0)
    // HEYS.Harm.calculateHarmScore uses scientific formula based on trans/simple/badFat/sodium vs fiber/protein/goodFat
    if (p.harm == null && p.harmScore == null && HEYS.Harm?.calculateHarmScore) {
      derived.harm = HEYS.Harm.calculateHarmScore(p);
    }

    return derived;
  }

  function buildProductIndex(ps) {
    const byId = new Map(), byName = new Map(), byFingerprint = new Map(); // üÜï v4.6.0
    (ps || []).forEach(p => {
      if (!p) return;
      const id = (p.id != null ? p.id : p.product_id);
      if (id != null) byId.set(String(id).toLowerCase(), p);
      const nm = normalizeProductName(p.name || p.title || '');
      if (nm) byName.set(nm, p);
      if (p.fingerprint) byFingerprint.set(p.fingerprint, p); // üÜï v4.6.0
    });
    return { byId, byName, byFingerprint };
  }

  function normalizeProductFields(p) {
    if (!p || typeof p !== 'object') return p;

    // Use centralized harm normalization
    const harmVal = normalizeHarm(p);
    if (harmVal != null) {
      p.harm = harmVal;      // Canonical field
    }

    // Case normalization for DB fields
    if (p.badFat100 == null && p.badfat100 != null) p.badFat100 = p.badfat100;
    if (p.goodFat100 == null && p.goodfat100 != null) p.goodFat100 = p.goodfat100;
    return p;
  }

  function getProductFromItem(it, idx, options = {}) {
    if (!it) return null;

    const { mode = 'hybrid', enrichMissing = true, sharedCache = null } = options || {};
    const allowIndex = !!idx && mode !== 'snapshot-only';
    const allowSnapshot = mode !== 'database-only';

    // –ü–æ–ª—É—á–∞–µ–º shared products cache (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ options)
    const getSharedCache = () => {
      if (sharedCache) return sharedCache;
      // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
      return HEYS.CloudShared?.getCachedSharedProducts?.() || [];
    };

    const maybeEnrich = (product) => {
      if (!product || !enrichMissing || !HEYS.Harm?.enrichProduct) return product;
      try {
        return HEYS.Harm.enrichProduct(product) || product;
      } catch {
        return product;
      }
    };

    // üÜï –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (local vs shared)
    const applyProductPriority = (localProduct) => {
      if (!localProduct || !localProduct.shared_origin_id) {
        return localProduct;
      }

      const cache = getSharedCache();
      if (!cache || cache.length === 0) {
        return localProduct;
      }

      // –ù–∞—Ö–æ–¥–∏–º shared-–æ—Ä–∏–≥–∏–Ω–∞–ª
      const sharedProduct = cache.find(s => s.id === localProduct.shared_origin_id);
      if (!sharedProduct) {
        return localProduct;
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–≥–∏–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
      return getProductWithPriority(localProduct, sharedProduct);
    };

    const applyItemFallback = (product) => {
      if (!product || !it) return product;

      const numericFields = [
        'kcal100', 'protein100', 'carbs100', 'fat100',
        'simple100', 'complex100', 'badFat100', 'goodFat100', 'trans100',
        'fiber100', 'sodium100',
        'omega3_100', 'omega6_100', 'nutrient_density',
        'vitamin_a', 'vitamin_c', 'vitamin_d', 'vitamin_e', 'vitamin_k',
        'vitamin_b1', 'vitamin_b2', 'vitamin_b3', 'vitamin_b6', 'vitamin_b9', 'vitamin_b12',
        'calcium', 'iron', 'magnesium', 'phosphorus', 'potassium', 'zinc', 'selenium', 'iodine'
      ];

      numericFields.forEach((field) => {
        if (product[field] == null && it[field] != null) {
          product[field] = it[field];
        }
      });

      const itemNova = it.nova_group ?? it.novaGroup;
      if (product.nova_group == null && itemNova != null) {
        product.nova_group = itemNova;
      }
      if (product.novaGroup == null && product.nova_group != null) {
        product.novaGroup = product.nova_group;
      }

      if (product.additives == null && Array.isArray(it.additives) && it.additives.length) {
        product.additives = it.additives;
      }

      const boolFields = ['is_organic', 'is_whole_grain', 'is_fermented', 'is_raw'];
      boolFields.forEach((field) => {
        if (product[field] == null && it[field] != null) {
          product[field] = it[field];
        }
      });

      // Use centralized harm normalization for item fallback
      if (product.harm == null) {
        const itemHarm = normalizeHarm(it);
        if (itemHarm != null) {
          product.harm = itemHarm;
          if (product.harmScore == null) product.harmScore = itemHarm;
        }
      }

      if (product.gi == null) {
        const itemGi = it.gi ?? it.gi100 ?? it.GI ?? it.giIndex;
        if (itemGi != null) product.gi = itemGi;
      }
      return product;
    };

    const getSnapshot = () => {
      // –ï—Å–ª–∏ –≤ item –µ—Å—Ç—å snapshot –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ ‚Äî –≤–µ—Ä–Ω—ë–º —Å–∞–º item
      const hasMacroSnapshot = it.kcal100 !== undefined || it.protein100 !== undefined || it.simple100 !== undefined || it.complex100 !== undefined || it.carbs100 !== undefined;
      const hasGiOrHarm = it.gi !== undefined || it.gi100 !== undefined || it.GI !== undefined || it.giIndex !== undefined || normalizeHarm(it) != null;
      if (hasMacroSnapshot || hasGiOrHarm) {
        return maybeEnrich(normalizeProductFields(it));
      }
      return null;
    };

    if (!allowIndex) {
      return allowSnapshot ? getSnapshot() : null;
    }

    // v4.8.0: –ü–†–ò–û–†–ò–¢–ï–¢ –ü–û–ò–°–ö–ê –ò–ó–ú–ï–ù–Å–ù
    // 1. product_id (–≥–ª–∞–≤–Ω—ã–π –∫–ª—é—á ‚Äî —É—Å—Ç–æ–π—á–∏–≤ –∫ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é)
    // 2. fingerprint (content-hash)
    // 3. name (fallback –¥–ª—è legacy)

    // 1Ô∏è‚É£ –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ product_id (–ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á)
    if (it.product_id != null && idx.byId) {
      const found = idx.byId.get(String(it.product_id).toLowerCase());
      if (found) {
        const prioritized = applyProductPriority(found);
        return maybeEnrich(applyItemFallback(normalizeProductFields(prioritized)));
      }
    }
    if (it.productId != null && idx.byId) {
      const found = idx.byId.get(String(it.productId).toLowerCase());
      if (found) {
        const prioritized = applyProductPriority(found);
        return maybeEnrich(applyItemFallback(normalizeProductFields(prioritized)));
      }
    }

    // 2Ô∏è‚É£ –ü–æ–∏—Å–∫ –ø–æ fingerprint (content-based –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
    if (it.fingerprint && idx.byFingerprint) {
      const found = idx.byFingerprint.get(it.fingerprint);
      if (found) {
        const prioritized = applyProductPriority(found);
        return maybeEnrich(applyItemFallback(normalizeProductFields(prioritized)));
      }
    }

    // 3Ô∏è‚É£ Fallback: –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (legacy, –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è)
    const nm = normalizeProductName(it.name || it.title || '');
    if (nm && idx.byName) {
      const found = idx.byName.get(nm);
      if (found) {
        const prioritized = applyProductPriority(found);
        return maybeEnrich(applyItemFallback(normalizeProductFields(prioritized)));
      }
    }

    if (allowSnapshot) return getSnapshot();
    return null;
  }

  function per100(p) { const d = computeDerivedProduct(p); return { kcal100: d.kcal100, carbs100: d.carbs100, prot100: +p.protein100 || 0, fat100: d.fat100, simple100: +p.simple100 || 0, complex100: +p.complex100 || 0, bad100: +p.badFat100 || 0, good100: +p.goodFat100 || 0, trans100: +p.trans100 || 0, fiber100: +p.fiber100 || 0, sodium100: +p.sodium100 || 0 }; }

  function scale(v, g) { return Math.round(((+v || 0) * (+g || 0) / 100) * 10) / 10; }

  // mealTotals —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ meal.id/hash –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
  const _mealTotalsCache = new Map();

  // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ ‚Äî –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
  function clearMealTotalsCache() {
    _mealTotalsCache.clear();
    // DEBUG (–æ—Ç–∫–ª—é—á–µ–Ω–æ): console.log('[HEYS] mealTotals cache cleared');
  }

  // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (fix: –Ω—É–ª–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
  if (typeof window !== 'undefined') {
    window.addEventListener('heysProductsUpdated', () => {
      clearMealTotalsCache();
    });
  }

  function mealSignature(meal) {
    if (!meal || !Array.isArray(meal.items)) return '';
    return meal.items.map(it => `${it.product_id || it.productId || it.name || ''}:${it.grams || 0}`).join('|');
  }
  function idxSignature(idx) {
    if (!idx || !idx.byId) return '';
    return Array.from(idx.byId.keys()).join(',');
  }
  function mealTotals(meal, idx) {
    const key = (meal.id || '') + '::' + mealSignature(meal) + '::' + idxSignature(idx);
    if (_mealTotalsCache.has(key)) return _mealTotalsCache.get(key);
    const T = { kcal: 0, carbs: 0, simple: 0, complex: 0, prot: 0, fat: 0, bad: 0, good: 0, trans: 0, fiber: 0, sodium: 0 };
    (meal.items || []).forEach(it => { const p = getProductFromItem(it, idx) || {}; const per = per100(p); const G = +it.grams || 0; T.kcal += scale(per.kcal100, G); T.carbs += scale(per.carbs100, G); T.simple += scale(per.simple100, G); T.complex += scale(per.complex100, G); T.prot += scale(per.prot100, G); T.fat += scale(per.fat100, G); T.bad += scale(per.bad100, G); T.good += scale(per.good100, G); T.trans += scale(per.trans100, G); T.fiber += scale(per.fiber100, G); T.sodium += scale(per.sodium100, G); });
    Object.keys(T).forEach(k => T[k] = round1(T[k]));
    _mealTotalsCache.set(key, T);
    return T;
  }

  // === –í–∞–ª–∏–¥–∞—Ü–∏—è ===
  function validateProduct(product) {
    if (!product || typeof product !== 'object') return false;
    if (!product.name || typeof product.name !== 'string') return false;
    if (typeof product.kcal100 !== 'number' || product.kcal100 < 0) return false;
    return true;
  }

  function validateMeal(meal) {
    if (!meal || typeof meal !== 'object') return false;
    if (!meal.name || typeof meal.name !== 'string') return false;
    if (!Array.isArray(meal.items)) return false;
    return true;
  }

  function validateDay(day) {
    if (!day || typeof day !== 'object') return false;
    if (!day.date || typeof day.date !== 'string') return false;
    if (!Array.isArray(day.meals)) return false;
    return true;
  }

  M.ensureDay = ensureDay;
  M.buildProductIndex = buildProductIndex;
  M.getProductFromItem = getProductFromItem;
  M.mealTotals = mealTotals;
  M.clearMealTotalsCache = clearMealTotalsCache;
  M.computeDerivedProduct = computeDerivedProduct;
  M.uuid = uuid;
  M.round1 = round1;
  M.todayISO = todayISO;
  M.validateProduct = validateProduct;
  M.validateMeal = validateMeal;
  M.validateDay = validateDay;
  M.getAutoPortions = getAutoPortions;
  M.AUTO_PORTIONS = AUTO_PORTIONS;
  M.getLastPortion = getLastPortion;
  M.saveLastPortion = saveLastPortion;

  // === Training Helpers (v3.3.0) ===
  // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã

  // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ —Ç–∏–ø—É (–µ—Å–ª–∏ z = [0,0,0,0])
  const DEFAULT_DURATION_BY_TYPE = {
    'cardio': 45,
    'strength': 60,
    'hobby': 30
  };

  // –õ–∏–º–∏—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
  const TRAINING_LIMITS = {
    maxDurationMin: 300,      // >5 —á–∞—Å–æ–≤ ‚Äî –Ω–µ—Ä–µ–∞–ª—å–Ω–æ
    maxTrainingsPerDay: 5,    // >5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ
    maxKcalPerTraining: 2500, // >2500 –∫–∫–∞–ª ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∫–∞
    minDurationMin: 5         // <5 –º–∏–Ω ‚Äî –Ω–µ —Å—á–∏—Ç–∞–µ–º
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö
   * @param {Object} training - –û–±—ä–µ–∫—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ {z: [0,0,0,0], time, type}
   * @returns {number} - –ú–∏–Ω—É—Ç—ã
   */
  function getTrainingDuration(training) {
    if (!training) return 0;
    const fromZones = (training.z || []).reduce((sum, v) => sum + (+v || 0), 0);
    if (fromZones > 0) return fromZones;
    // Fallback –ø–æ —Ç–∏–ø—É
    return DEFAULT_DURATION_BY_TYPE[training.type] || 45;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç 00:00)
   * @param {Object} training - –û–±—ä–µ–∫—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
   * @returns {Object|null} - {startMin, endMin, durationMin, startTime, endTime} –∏–ª–∏ null
   */
  function getTrainingInterval(training) {
    const duration = getTrainingDuration(training);
    if (!training?.time || duration === 0) return null;

    const [h, m] = training.time.split(':').map(Number);
    if (isNaN(h) || isNaN(m)) return null;

    const startMin = h * 60 + m;
    const endMin = startMin + duration;

    return {
      startMin,
      endMin,
      durationMin: duration,
      startTime: training.time,
      endTime: `${String(Math.floor(endMin / 60) % 24).padStart(2, '0')}:${String(endMin % 60).padStart(2, '0')}`
    };
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (HIIT/MODERATE/LISS)
   * @param {Object} training - –û–±—ä–µ–∫—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
   * @returns {string} - 'HIIT' | 'MODERATE' | 'LISS' | 'unknown'
   */
  function getTrainingIntensityType(training) {
    const zones = training?.z || [0, 0, 0, 0];
    const totalMin = zones.reduce((s, v) => s + (+v || 0), 0);
    if (totalMin === 0) return 'unknown';

    const highIntensityMin = (+zones[2] || 0) + (+zones[3] || 0); // Zone 3 + Zone 4
    const ratio = highIntensityMin / totalMin;

    if (ratio > 0.5) return 'HIIT';      // >50% –≤ –≤—ã—Å–æ–∫–∏—Ö –∑–æ–Ω–∞—Ö
    if (ratio > 0.3) return 'MODERATE';  // 30-50%
    return 'LISS';                        // <30% ‚Äî –Ω–∏–∑–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ –∫–∞—Ä–¥–∏–æ
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
   * @param {Object} training - –û–±—ä–µ–∫—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
   * @param {number} kcal - –ö–∞–ª–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (trainK)
   * @returns {boolean}
   */
  function isValidTraining(training, kcal) {
    const duration = getTrainingDuration(training);
    if (duration < TRAINING_LIMITS.minDurationMin) return false;
    if (duration > TRAINING_LIMITS.maxDurationMin) return false;
    if (kcal > TRAINING_LIMITS.maxKcalPerTraining) return false;
    if (!training.time) return false; // –ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –Ω–µ –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
    return true;
  }

  /**
   * –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –±–ª–∏–∑–∫–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –æ–¥–Ω—É —Å–µ—Å—Å–∏—é
   * @param {Object[]} trainings - –ú–∞—Å—Å–∏–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
   * @param {number} maxGapMin - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 –º–∏–Ω)
   * @returns {Object[]} - –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
   */
  function mergeCloseTrainingSessions(trainings, maxGapMin = 30) {
    if (!Array.isArray(trainings) || trainings.length < 2) return trainings || [];

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–µ–º
    const withTime = trainings.filter(t => t && t.time);
    if (withTime.length < 2) return trainings;

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    const sorted = [...withTime].sort((a, b) => {
      const [ah, am] = a.time.split(':').map(Number);
      const [bh, bm] = b.time.split(':').map(Number);
      return (ah * 60 + am) - (bh * 60 + bm);
    });

    const TYPE_PRIORITY = { strength: 3, cardio: 2, hobby: 1 };
    const merged = [];
    let current = sorted[0];

    for (let i = 1; i < sorted.length; i++) {
      const next = sorted[i];
      const currentInterval = getTrainingInterval(current);
      const [nh, nm] = next.time.split(':').map(Number);
      const nextStart = nh * 60 + nm;

      // Gap < maxGapMin ‚Üí merge
      if (currentInterval && nextStart - currentInterval.endMin < maxGapMin) {
        current = {
          time: current.time, // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–≤–æ–π
          type: (TYPE_PRIORITY[next.type] || 0) > (TYPE_PRIORITY[current.type] || 0) ? next.type : current.type,
          z: (current.z || [0, 0, 0, 0]).map((v, i) => (+v || 0) + (+(next.z?.[i]) || 0)), // –°—É–º–º–∏—Ä—É–µ–º –∑–æ–Ω—ã
          _merged: true
        };
      } else {
        merged.push(current);
        current = next;
      }
    }
    merged.push(current);

    return merged;
  }

  // –≠–∫—Å–ø–æ—Ä—Ç Training Helpers
  M.getTrainingDuration = getTrainingDuration;
  M.getTrainingInterval = getTrainingInterval;
  M.getTrainingIntensityType = getTrainingIntensityType;
  M.isValidTraining = isValidTraining;
  M.mergeCloseTrainingSessions = mergeCloseTrainingSessions;
  M.TRAINING_LIMITS = TRAINING_LIMITS;
  M.DEFAULT_DURATION_BY_TYPE = DEFAULT_DURATION_BY_TYPE;

  // === Shared Products Helpers (v3.18.0) ===

  /**
   * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ fingerprint –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
   * Fingerprint —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏ + –æ–∫—Ä—É–≥–ª—ë–Ω–Ω—ã—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
   * @param {Product} product - –û–±—ä–µ–∫—Ç –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {Promise<string>} - SHA-256 fingerprint (hex)
   */
  async function computeProductFingerprint(product) {
    if (!product) return '';

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏: lowercase, trim, collapse whitespace
    const namePart = (product.name || '')
      .toLowerCase()
      .trim()
      .replace(/\s+/g, ' ');

    // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –¥–æ 1 –∑–Ω–∞–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    const nutrientsPart = [
      round1(product.simple100 || 0),
      round1(product.complex100 || 0),
      round1(product.protein100 || 0),
      round1(product.badFat100 || 0),
      round1(product.goodFat100 || 0),
      round1(product.trans100 || 0),
      round1(product.fiber100 || 0),
      round1(product.gi || 0),
      round1(product.harm || 0)
    ].join('|');

    const combined = `${namePart}::${nutrientsPart}`;

    // SHA-256 —á–µ—Ä–µ–∑ Web Crypto API
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(combined);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    } catch (e) {
      // Fallback: –ø—Ä–æ—Å—Ç–æ–π –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–µ—à
      let hash = 0;
      for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(16).padStart(8, '0');
    }
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
   * @param {string} name - –ò–º—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {string} - –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è
   */
  function normalizeProductName(name) {
    if (!name) return '';
    return name
      .toLowerCase()
      .trim()
      .replace(/\s+/g, ' ')
      .replace(/—ë/g, '–µ'); // –†—É—Å—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
  }

  M.computeProductFingerprint = computeProductFingerprint;
  M.normalizeProductName = normalizeProductName;

  // Harm field normalization (v4.3.0)
  M.normalizeHarm = normalizeHarm;
  M.normalizeHarmFields = normalizeHarmFields;

  // üÜï Product Priority by Origin (v4.5.0)
  M.getProductPrioritySource = getProductPrioritySource;
  M.getProductWithPriority = getProductWithPriority;

  // ====================================================================
  // üß™ EXTENDED NUTRIENTS PARSER (v4.4.0)
  // ====================================================================
  // –ü–∞—Ä—Å–µ—Ä –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏
  // –§–æ—Ä–º–∞—Ç: "NOVA:4|Na:1200|O3:0.5|O6:2|Org:1|WG:0|Fer:0|Raw:0|vA:15|..."
  // ====================================================================

  /**
   * –°–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π —Å –∏—Ö –∫–ª—é—á–∞–º–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
   */
  const EXTENDED_NUTRIENT_KEYS = {
    // Basic
    'NOVA': 'nova_group',      // 1-4
    'Na': 'sodium100',         // mg/100g
    'Chol': 'cholesterol',     // mg/100g
    'O3': 'omega3_100',        // g/100g
    'O6': 'omega6_100',        // g/100g
    'ND': 'nutrient_density',  // 0-100

    // Quality flags (0/1)
    'Org': 'is_organic',
    'WG': 'is_whole_grain',
    'Fer': 'is_fermented',
    'Raw': 'is_raw',

    // Vitamins (% DV)
    'vA': 'vitamin_a',
    'vC': 'vitamin_c',
    'vD': 'vitamin_d',
    'vE': 'vitamin_e',
    'vK': 'vitamin_k',
    'vB1': 'vitamin_b1',
    'vB2': 'vitamin_b2',
    'vB3': 'vitamin_b3',
    'vB6': 'vitamin_b6',
    'vB9': 'vitamin_b9',
    'vB12': 'vitamin_b12',

    // Minerals (% DV)
    'Ca': 'calcium',
    'Fe': 'iron',
    'Mg': 'magnesium',
    'P': 'phosphorus',
    'K': 'potassium',
    'Zn': 'zinc',
    'Se': 'selenium',
    'I': 'iodine'
  };

  // ====================================================================
  // üß† AI PRODUCT STRING PARSER (Russian keys, full format)
  // ====================================================================

  function normalizeAIKey(rawKey) {
    return String(rawKey || '')
      .toLowerCase()
      .replace(/—ë/g, '–µ')
      .replace(/[^a-z0-9–∞-—è]/gi, '');
  }

  const AI_PRODUCT_FIELD_MAP = (() => {
    const map = new Map();
    const add = (field, keys) => {
      keys.forEach((k) => map.set(normalizeAIKey(k), field));
    };

    add('name', ['–Ω–∞–∑–≤–∞–Ω–∏–µ', '–ø—Ä–æ–¥—É–∫—Ç', 'product', 'name']);

    add('kcal100', ['–∫–∫–∞–ª', '–∫–∞–ª–æ—Ä–∏–∏', '—ç–Ω–µ—Ä–≥–∏—è']);
    add('carbs100', ['—É–≥–ª–µ–≤–æ–¥—ã', '—É–≥–ª–µ–≤–æ–¥—ã–≤—Å–µ–≥–æ', '—É–≥–ª–µ–≤–æ–¥—ã–æ–±—â–∏–µ', 'carbs']);
    add('simple100', ['–ø—Ä–æ—Å—Ç—ã–µ', '–ø—Ä–æ—Å—Ç—ã–µ—É–≥–ª–µ–≤–æ–¥—ã', '—Å–∞—Ö–∞—Ä–∞', 'simple']);
    add('complex100', ['—Å–ª–æ–∂–Ω—ã–µ', '—Å–ª–æ–∂–Ω—ã–µ—É–≥–ª–µ–≤–æ–¥—ã', 'complex']);
    add('protein100', ['–±–µ–ª–æ–∫', '–ø—Ä–æ—Ç–µ–∏–Ω', 'protein']);
    add('fat100', ['–∂–∏—Ä—ã', '–∂–∏—Ä—ã–≤—Å–µ–≥–æ', 'fat']);
    add('badfat100', ['–≤—Ä–µ–¥–Ω—ã–µ–∂–∏—Ä—ã', '–Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ', 'badfat']);
    add('goodfat100', ['–ø–æ–ª–µ–∑–Ω—ã–µ–∂–∏—Ä—ã', '–Ω–µ–Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ', 'goodfat']);
    add('trans100', ['—Ç—Ä–∞–Ω—Å–∂–∏—Ä—ã', '—Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã', 'trans']);
    add('fiber100', ['–∫–ª–µ—Ç—á–∞—Ç–∫–∞', 'fiber']);
    add('gi', ['–≥–∏', '–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π–∏–Ω–¥–µ–∫—Å', '–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å', 'gi']);
    add('harm', ['–≤—Ä–µ–¥', '–≤—Ä–µ–¥–Ω–æ—Å—Ç—å', 'harm']);

    add('sodium100', ['–Ω–∞—Ç—Ä–∏–π', 'na', '—Å–æ–ª—å']);
    add('cholesterol', ['—Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω', '—Ö–æ–ª–µ—Å—Ç–µ—Ä', 'cholesterol']);
    add('omega3_100', ['–æ–º–µ–≥–∞3', '–æ–º–µ–≥–∞-3', 'omega3', '–æ3']);
    add('omega6_100', ['–æ–º–µ–≥–∞6', '–æ–º–µ–≥–∞-6', 'omega6', '–æ6']);
    add('nova_group', ['nova', '–Ω–æ–≤–∞']);
    add('additives', ['–¥–æ–±–∞–≤–∫–∏', 'e-–¥–æ–±–∞–≤–∫–∏', 'ed–æ–±–∞–≤–∫–∏', 'additives']);
    add('nutrient_density', ['–Ω—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è–ø–ª–æ—Ç–Ω–æ—Å—Ç—å', '–ø–ª–æ—Ç–Ω–æ—Å—Ç—å–ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö–≤–µ—â–µ—Å—Ç–≤', 'nutrientdensity', 'nd']);

    add('is_organic', ['–æ—Ä–≥–∞–Ω–∏–∫', '–æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π', 'organic']);
    add('is_whole_grain', ['—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π', '—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω', 'wholegrain', '—Ü–µ–ª—å–Ω—ã–µ–∑–µ—Ä–Ω–∞']);
    add('is_fermented', ['—Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', '—Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω', 'fermented']);
    add('is_raw', ['—Å—ã—Ä–æ–π', 'raw']);

    add('vitamin_a', ['–≤–∏—Ç–∞–º–∏–Ω–∞', '–≤–∏—Ç–∞–º–∏–Ωa', 'vitamina']);
    add('vitamin_c', ['–≤–∏—Ç–∞–º–∏–Ωc', 'vitaminc']);
    add('vitamin_d', ['–≤–∏—Ç–∞–º–∏–Ωd', 'vitamind']);
    add('vitamin_e', ['–≤–∏—Ç–∞–º–∏–Ω–µ', 'vitamine']);
    add('vitamin_k', ['–≤–∏—Ç–∞–º–∏–Ωk', 'vitamink']);
    add('vitamin_b1', ['–≤–∏—Ç–∞–º–∏–Ωb1', 'vitaminb1']);
    add('vitamin_b2', ['–≤–∏—Ç–∞–º–∏–Ωb2', 'vitaminb2']);
    add('vitamin_b3', ['–≤–∏—Ç–∞–º–∏–Ωb3', 'vitaminb3']);
    add('vitamin_b6', ['–≤–∏—Ç–∞–º–∏–Ωb6', 'vitaminb6']);
    add('vitamin_b9', ['–≤–∏—Ç–∞–º–∏–Ωb9', 'vitaminb9', '—Ñ–æ–ª–∞—Ç', '—Ñ–æ–ª–∏–µ–≤–∞—è']);
    add('vitamin_b12', ['–≤–∏—Ç–∞–º–∏–Ωb12', 'vitaminb12']);

    add('calcium', ['–∫–∞–ª—å—Ü–∏–π', 'calcium']);
    add('iron', ['–∂–µ–ª–µ–∑–æ', 'iron']);
    add('magnesium', ['–º–∞–≥–Ω–∏–π', 'magnesium']);
    add('phosphorus', ['—Ñ–æ—Å—Ñ–æ—Ä', 'phosphorus']);
    add('potassium', ['–∫–∞–ª–∏–π', 'potassium']);
    add('zinc', ['—Ü–∏–Ω–∫', 'zinc']);
    add('selenium', ['—Å–µ–ª–µ–Ω', 'selenium']);
    add('iodine', ['–π–æ–¥', 'iodine']);

    return map;
  })();

  const AI_REQUIRED_FIELDS = [
    'kcal100',
    'carbs100',
    'simple100',
    'complex100',
    'protein100',
    'fat100',
    'badfat100',
    'goodfat100',
    'trans100',
    'fiber100',
    'gi',
    'harm'
  ];

  function parseAIValueNumber(rawValue) {
    if (rawValue == null) return undefined;
    const cleaned = String(rawValue)
      .replace(/,/g, '.')
      .replace(/[^0-9+\-.]/g, ' ');
    const match = cleaned.match(/[-+]?\d+(?:\.\d+)?/);
    if (!match) return undefined;
    const n = Number(match[0]);
    return Number.isFinite(n) ? n : undefined;
  }

  function parseAIValueBool(rawValue) {
    if (rawValue == null) return undefined;
    const v = String(rawValue).toLowerCase().trim();
    if (['1', 'true', '–¥–∞', 'yes', 'y', '–µ—Å—Ç—å', '‚úì'].includes(v)) return true;
    if (['0', 'false', '–Ω–µ—Ç', 'no', 'n', 'none', '‚Äî', '-'].includes(v)) return false;
    return undefined;
  }

  function parseAIValueList(rawValue) {
    if (rawValue == null) return undefined;
    const v = String(rawValue).trim();
    if (!v || ['–Ω–µ—Ç', 'no', '0', '-', '‚Äî'].includes(v.toLowerCase())) return [];
    const cleaned = v.replace(/[\[\]{}()]/g, '');
    return cleaned
      .split(/[,;|]/)
      .map((item) => item.trim())
      .filter(Boolean)
      .map((item) => item.toUpperCase());
  }

  /**
   * –ü–∞—Ä—Å–∏—Ç AI-—Å—Ç—Ä–æ–∫—É –ø—Ä–æ–¥—É–∫—Ç–∞ —Å —Ä—É—Å—Å–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏.
   * –§–æ—Ä–º–∞—Ç: "–ö–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ" –ø–æ —Å—Ç—Ä–æ–∫–∞–º (–∏–ª–∏ —á–µ—Ä–µ–∑ |/;), –∏–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
   * @param {string} text
   * @param {{ defaultName?: string }} [options]
   * @returns {{ product: Object, missingFields: string[] } | null}
   */
  function parseAIProductString(text, options = {}) {
    if (!text || typeof text !== 'string') return null;

    const raw = text.replace(/\r/g, '\n');
    const chunks = raw
      .split(/\n|\||;/)
      .map((chunk) => chunk.trim())
      .filter(Boolean);

    if (!chunks.length) return null;

    const result = {};
    let fallbackName = '';

    chunks.forEach((line) => {
      // Regex: –∫–ª—é—á –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å, –Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ ": " –∏–ª–∏ "= "
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–µ–Ω–∏–≤—ã–π –∫–≤–∞–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ lookbehind –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ "–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: 0.0"
      const match = line.match(/^(.+?)[\s]*[:=][\s]+(.+)$/);
      if (!match) {
        if (!result.name && !/\d/.test(line)) {
          fallbackName = line.trim();
        }
        return;
      }

      const rawKey = match[1].trim();
      const rawValue = match[2].trim();
      const normalizedKey = normalizeAIKey(rawKey);
      const field = AI_PRODUCT_FIELD_MAP.get(normalizedKey);
      if (!field) return;

      if (field === 'name') {
        result.name = rawValue.trim();
        return;
      }

      if (field === 'additives') {
        const list = parseAIValueList(rawValue);
        if (list !== undefined) result.additives = list;
        return;
      }

      if (['is_organic', 'is_whole_grain', 'is_fermented', 'is_raw'].includes(field)) {
        const boolVal = parseAIValueBool(rawValue);
        if (boolVal !== undefined) result[field] = boolVal;
        return;
      }

      const numVal = parseAIValueNumber(rawValue);
      if (numVal === undefined) return;

      if (field === 'nova_group') {
        const nova = Math.round(numVal);
        if (nova >= 1 && nova <= 4) result[field] = nova;
        return;
      }

      result[field] = numVal;
    });

    if (!result.name) {
      result.name = fallbackName || options.defaultName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    }

    const missingFields = AI_REQUIRED_FIELDS.filter((field) => {
      const value = result[field];
      return value === undefined || value === null || Number.isNaN(value);
    });

    if (missingFields.length) {
      return { product: result, missingFields };
    }

    const derivedCarbs = (Number.isFinite(result.carbs100) && result.carbs100 > 0)
      ? result.carbs100
      : ((result.simple100 || 0) + (result.complex100 || 0));
    const derivedFat = (Number.isFinite(result.fat100) && result.fat100 > 0)
      ? result.fat100
      : ((result.badfat100 || 0) + (result.goodfat100 || 0) + (result.trans100 || 0));

    result.carbs100 = round1(derivedCarbs);
    result.fat100 = round1(derivedFat);
    // NET Atwater: protein 3 kcal/g (TEF 25% built-in: 4√ó0.75=3), carbs 4 kcal/g, fat 9 kcal/g
    result.kcal100 = round1(3 * (result.protein100 || 0) + 4 * derivedCarbs + 9 * derivedFat);
    result.createdAt = result.createdAt || Date.now();

    // v4.8.8: Normalize field names (badfat100 ‚Üí badFat100 for app compatibility)
    normalizeProductFields(result);

    return { product: result, missingFields: [] };
  }

  /**
   * –ü–∞—Ä—Å–∏—Ç AI-—Å—Ç—Ä–æ–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
   * @param {string} extString - –°—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ "NOVA:4|Na:1200|O3:0.5|..."
   * @returns {Object} - –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
   * @example
   * parseExtendedNutrients("NOVA:4|Na:1200|vC:15|Fe:30")
   * // ‚Üí { nova_group: 4, sodium100: 1200, vitamin_c: 15, iron: 30 }
   */
  function parseExtendedNutrients(extString) {
    if (!extString || typeof extString !== 'string') return {};

    const result = {};
    const pairs = extString.split('|');

    for (const pair of pairs) {
      const [key, value] = pair.split(':');
      if (!key || value === undefined) continue;

      const fieldName = EXTENDED_NUTRIENT_KEYS[key.trim()];
      if (!fieldName) continue;

      const trimmedValue = value.trim();

      // Boolean fields (0/1)
      if (['is_organic', 'is_whole_grain', 'is_fermented', 'is_raw'].includes(fieldName)) {
        result[fieldName] = trimmedValue === '1' || trimmedValue.toLowerCase() === 'true';
      }
      // Integer fields
      else if (fieldName === 'nova_group') {
        const n = parseInt(trimmedValue, 10);
        if (n >= 1 && n <= 4) result[fieldName] = n;
      }
      // Numeric fields
      else {
        const n = parseFloat(trimmedValue);
        if (Number.isFinite(n) && n >= 0) result[fieldName] = n;
      }
    }

    return result;
  }

  /**
   * –°–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è AI
   * @param {Object} product - –ü—Ä–æ–¥—É–∫—Ç —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
   * @returns {string} - –°—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ "NOVA:4|Na:1200|..."
   */
  function serializeExtendedNutrients(product) {
    if (!product) return '';

    const parts = [];

    for (const [shortKey, fieldName] of Object.entries(EXTENDED_NUTRIENT_KEYS)) {
      const value = product[fieldName];
      if (value === undefined || value === null) continue;

      // Boolean fields ‚Üí 0/1
      if (typeof value === 'boolean') {
        parts.push(`${shortKey}:${value ? '1' : '0'}`);
      }
      // Numeric fields ‚Üí number
      else if (typeof value === 'number' && Number.isFinite(value)) {
        // Round to 1 decimal for readability
        parts.push(`${shortKey}:${round1(value)}`);
      }
    }

    return parts.join('|');
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç AI –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
   * @param {string} productName - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {string} - –ü—Ä–æ–º–ø—Ç –¥–ª—è AI
   */
  function generateExtendedNutrientPrompt(productName) {
    return `–î–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ "${productName}" –¥–∞–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
NOVA:X|Na:X|Chol:X|O3:X|O6:X|Org:0/1|WG:0/1|Fer:0/1|Raw:0/1|vA:X|vC:X|vD:X|vE:X|vK:X|vB1:X|vB2:X|vB3:X|vB6:X|vB9:X|vB12:X|Ca:X|Fe:X|Mg:X|P:X|K:X|Zn:X|Se:X|I:X

–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: NOVA (1-4), Na=–Ω–∞—Ç—Ä–∏–π –º–≥/100–≥, Chol=—Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –º–≥/100–≥, O3/O6=–æ–º–µ–≥–∞ –≥/100–≥, –≤–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–Ω–µ—Ä–∞–ª—ã –≤ % –æ—Ç —Å—É—Ç–æ—á–Ω–æ–π –Ω–æ—Ä–º—ã –Ω–∞ 100–≥.
–ü—Ä–æ–ø—É—Å—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è. –¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∞, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.`;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç AI –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (—Ä—É—Å—Å–∫–∏–µ –∫–ª—é—á–∏)
   * @param {string} productName - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {string}
   */
  function generateAIProductStringPrompt(productName) {
    return `–°–¥–µ–ª–∞–π –æ–¥–Ω—É —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ö–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ" (–∫–∞–∂–¥–æ–µ –ø–æ–ª–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏). –ù–∏–∫–∞–∫–æ–≥–æ JSON/–∫–æ–¥–∞. –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ 100–≥.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
–ù–∞–∑–≤–∞–Ω–∏–µ: ${productName}
–ö–∫–∞–ª: X
–£–≥–ª–µ–≤–æ–¥—ã: X
–ü—Ä–æ—Å—Ç—ã–µ: X
–°–ª–æ–∂–Ω—ã–µ: X
–ë–µ–ª–æ–∫: X
–ñ–∏—Ä—ã: X
–í—Ä–µ–¥–Ω—ã–µ –∂–∏—Ä—ã: X
–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã: X
–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã: X
–ö–ª–µ—Ç—á–∞—Ç–∫–∞: X
–ì–ò: X
–í—Ä–µ–¥: X

–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (–µ—Å–ª–∏ –∑–Ω–∞–µ—à—å ‚Äî –¥–æ–±–∞–≤—å):
–ù–∞—Ç—Ä–∏–π: X
–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω: X
–û–º–µ–≥–∞-3: X
–û–º–µ–≥–∞-6: X
NOVA: 1-4
–î–æ–±–∞–≤–∫–∏: E621, E330 (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî "–Ω–µ—Ç")
–ù—É—Ç—Ä–∏–µ–Ω—Ç–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: X
–û—Ä–≥–∞–Ω–∏–∫: 0/1
–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π: 0/1
–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 0/1
–°—ã—Ä–æ–π: 0/1
–í–∏—Ç–∞–º–∏–Ω A: X
–í–∏—Ç–∞–º–∏–Ω C: X
–í–∏—Ç–∞–º–∏–Ω D: X
–í–∏—Ç–∞–º–∏–Ω E: X
–í–∏—Ç–∞–º–∏–Ω K: X
–í–∏—Ç–∞–º–∏–Ω B1: X
–í–∏—Ç–∞–º–∏–Ω B2: X
–í–∏—Ç–∞–º–∏–Ω B3: X
–í–∏—Ç–∞–º–∏–Ω B6: X
–í–∏—Ç–∞–º–∏–Ω B9: X
–í–∏—Ç–∞–º–∏–Ω B12: X
–ö–∞–ª—å—Ü–∏–π: X
–ñ–µ–ª–µ–∑–æ: X
–ú–∞–≥–Ω–∏–π: X
–§–æ—Å—Ñ–æ—Ä: X
–ö–∞–ª–∏–π: X
–¶–∏–Ω–∫: X
–°–µ–ª–µ–Ω: X
–ô–æ–¥: X`;
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –ø–æ–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ DB —Ñ–æ—Ä–º–∞—Ç–∞ –≤ JS —Ñ–æ—Ä–º–∞—Ç
   * @param {Object} dbProduct - –ü—Ä–æ–¥—É–∫—Ç –∏–∑ PostgreSQL (snake_case –ø–æ–ª—è)
   * @returns {Object} - –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
   */
  function normalizeExtendedProduct(dbProduct) {
    if (!dbProduct) return dbProduct;

    // Prevent double normalization
    if (dbProduct._normalized) return dbProduct;

    const result = { ...dbProduct };

    const warnNumber = (field, value) => {
      if (value == null || !Number.isFinite(value)) return;
      const maxByField = {
        sodium100: 5000,
        omega3_100: 100,
        omega6_100: 100,
        nutrient_density: 100,
        // Vitamins (snake_case + camelCase)
        vitamin_a: 3000,      // Liver, carrots (retinol can be 2500+)
        vitaminA: 3000,
        vitamin_c: 500,       // Superfoods (acerola, rosehip)
        vitaminC: 500,
        vitamin_d: 300,
        vitaminD: 300,
        vitamin_e: 300,
        vitaminE: 300,
        vitamin_k: 300,
        vitaminK: 300,
        vitamin_b1: 300,
        vitaminB1: 300,
        vitamin_b2: 300,
        vitaminB2: 300,
        vitamin_b3: 300,
        vitaminB3: 300,
        vitamin_b6: 300,
        vitaminB6: 300,
        vitamin_b9: 300,
        vitaminB9: 300,
        vitamin_b12: 300,
        vitaminB12: 300,
        // Minerals (snake_case + camelCase)
        calcium: 1500,        // Dairy, sesame seeds
        iron: 30,             // Liver, wheat bran (KPD = 10.57)
        magnesium: 700,       // Wheat bran (KPD = 611)
        phosphorus: 1500,     // Seeds, wheat bran (sunflower = 1158, KPD = 1013)
        potassium: 1500,      // Dried fruits, wheat bran, chips (kuraga = 1162, KPD = 1182, Lay's = 1196)
        zinc: 300,
        selenium: 300,
        iodine: 300
      };
      const max = maxByField[field] ?? 1000;
      if (value < 0 || value > max) {
        console.warn('[HEYS.shared] ‚ö†Ô∏è Suspicious value', field, value, result?.id || 'unknown');
      }
    };

    const normalizeBaseNumber = (field, value) => {
      if (value == null || value === '') return 0;
      const n = Number(value);
      if (!Number.isFinite(n)) return 0;
      if (n < 0) {
        console.warn('[HEYS.shared] ‚ö†Ô∏è Negative value clamped', field, n, result?.id || 'unknown');
        return 0;
      }
      if (n > 1000) warnNumber(field, n);
      return n;
    };

    const normalizeExtendedNumber = (field, value) => {
      if (value == null || value === '') return null;
      const n = Number(value);
      if (!Number.isFinite(n)) return 0;
      if (n < 0) {
        console.warn('[HEYS.shared] ‚ö†Ô∏è Negative value clamped', field, n, result?.id || 'unknown');
        return 0;
      }
      if (n > 1000) warnNumber(field, n);
      return n;
    };

    // === 1. Case mapping: snake_case ‚Üí camelCase ===
    const baseFieldAliases = [
      { field: 'simple100' },
      { field: 'complex100' },
      { field: 'protein100' },
      { field: 'badFat100', snake: 'badfat100' },
      { field: 'goodFat100', snake: 'goodfat100' },
      { field: 'trans100' },
      { field: 'fiber100' }
    ];

    baseFieldAliases.forEach(({ field, snake }) => {
      if (snake && result[field] == null && result[snake] != null) {
        result[field] = result[snake];
      }
      if (snake && result[snake] == null && result[field] != null) {
        result[snake] = result[field];
      }
      result[field] = normalizeBaseNumber(field, result[field]);
    });

    // === 2. Harm normalization (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞) ===
    const harmVal = normalizeHarm(result);
    if (harmVal !== undefined) {
      result.harm = harmVal;
      result.harmScore = harmVal;
    }

    // === 3. GI normalization ===
    if (result.gi != null) {
      const giVal = Number(result.gi);
      result.gi = Number.isFinite(giVal) ? giVal : 0;
    }

    // === 4. Computed fields: kcal100, carbs100, fat100 ===
    // v3.9.0: Standard Atwater factors (4/4/9). TEF is separate.
    // Source of Truth: heys_core_v12.js:computeDerived()
    const protein = Number(result.protein100) || 0;
    const simple = Number(result.simple100) || 0;
    const complex = Number(result.complex100) || 0;
    const badFat = Number(result.badFat100) || 0;
    const goodFat = Number(result.goodFat100) || 0;
    const trans = Number(result.trans100) || 0;

    const carbs100 = (result.carbs100 != null && result.carbs100 > 0)
      ? Number(result.carbs100)
      : (simple + complex);
    const fat100 = (result.fat100 != null && result.fat100 > 0)
      ? Number(result.fat100)
      : (badFat + goodFat + trans);
    const kcal100 = round1(protein * 3 + carbs100 * 4 + fat100 * 9); // NET Atwater: TEF 25% built-in

    result.carbs100 = round1(carbs100);
    result.fat100 = round1(fat100);
    result.kcal100 = kcal100;

    // === 5. Extended nutrients ‚Äî ensure numbers + aliases ===
    const extendedAliases = [
      { snake: 'nutrient_density', camel: 'nutrientDensity', type: 'number' },
      { snake: 'nova_group', camel: 'novaGroup', type: 'int' },
      { snake: 'is_organic', camel: 'isOrganic', type: 'boolean' },
      { snake: 'is_whole_grain', camel: 'isWholeGrain', type: 'boolean' },
      { snake: 'is_fermented', camel: 'isFermented', type: 'boolean' },
      { snake: 'is_raw', camel: 'isRaw', type: 'boolean' },
      { snake: 'vitamin_a', camel: 'vitaminA', type: 'number' },
      { snake: 'vitamin_c', camel: 'vitaminC', type: 'number' },
      { snake: 'vitamin_d', camel: 'vitaminD', type: 'number' },
      { snake: 'vitamin_e', camel: 'vitaminE', type: 'number' },
      { snake: 'vitamin_k', camel: 'vitaminK', type: 'number' },
      { snake: 'vitamin_b1', camel: 'vitaminB1', type: 'number' },
      { snake: 'vitamin_b2', camel: 'vitaminB2', type: 'number' },
      { snake: 'vitamin_b3', camel: 'vitaminB3', type: 'number' },
      { snake: 'vitamin_b6', camel: 'vitaminB6', type: 'number' },
      { snake: 'vitamin_b9', camel: 'vitaminB9', type: 'number' },
      { snake: 'vitamin_b12', camel: 'vitaminB12', type: 'number' },
      { snake: 'calcium', camel: 'calcium', type: 'number' },
      { snake: 'iron', camel: 'iron', type: 'number' },
      { snake: 'magnesium', camel: 'magnesium', type: 'number' },
      { snake: 'phosphorus', camel: 'phosphorus', type: 'number' },
      { snake: 'potassium', camel: 'potassium', type: 'number' },
      { snake: 'zinc', camel: 'zinc', type: 'number' },
      { snake: 'selenium', camel: 'selenium', type: 'number' },
      { snake: 'iodine', camel: 'iodine', type: 'number' },
      // Phase 0: omega3/omega6 + cholesterol aliases (12.02.2026)
      { snake: 'omega3_100', camel: 'omega3', type: 'number' },
      { snake: 'omega6_100', camel: 'omega6', type: 'number' },
      { snake: 'cholesterol', camel: 'cholesterol100', type: 'number' }
    ];

    extendedAliases.forEach(({ snake, camel, type }) => {
      if (result[camel] == null && result[snake] != null) {
        result[camel] = result[snake];
      }
      if (result[snake] == null && result[camel] != null) {
        result[snake] = result[camel];
      }

      if (type === 'number') {
        result[snake] = normalizeExtendedNumber(snake, result[snake]);
        result[camel] = normalizeExtendedNumber(camel, result[camel]);
      }
      if (type === 'int') {
        const snakeVal = normalizeExtendedNumber(snake, result[snake]);
        const camelVal = normalizeExtendedNumber(camel, result[camel]);
        if (snakeVal != null) result[snake] = parseInt(snakeVal, 10);
        if (camelVal != null) result[camel] = parseInt(camelVal, 10);
      }
      if (type === 'boolean') {
        if (result[snake] != null) result[snake] = Boolean(result[snake]);
        if (result[camel] != null) result[camel] = Boolean(result[camel]);
      }
    });

    const extendedNumericFields = [
      'sodium100' // omega3_100, omega6_100 moved to extendedAliases (Phase 0, 12.02.2026)
    ];

    extendedNumericFields.forEach((field) => {
      result[field] = normalizeExtendedNumber(field, result[field]);
    });

    // Mark as normalized to prevent double processing
    result._normalized = true;

    return result;
  }

  // Export extended nutrients functions
  M.EXTENDED_NUTRIENT_KEYS = EXTENDED_NUTRIENT_KEYS;
  M.parseExtendedNutrients = parseExtendedNutrients;
  M.serializeExtendedNutrients = serializeExtendedNutrients;
  M.generateExtendedNutrientPrompt = generateExtendedNutrientPrompt;
  M.generateAIProductStringPrompt = generateAIProductStringPrompt;
  M.parseAIProductString = parseAIProductString;
  M.normalizeExtendedProduct = normalizeExtendedProduct;

  // Verbose init log removed
})(window);


/* ===== heys_storage_layer_v1.js ===== */
// heys_storage_layer_v1.js ‚Äî Centralized storage layer, cache, watchers
; (function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const Store = HEYS.store = HEYS.store || {};

  const memory = new Map();
  const watchers = new Map(); // key -> Set<fn>

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üóúÔ∏è COMPRESSION v2.0 ‚Äî –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö (~25-30% —ç–∫–æ–Ω–æ–º–∏—è)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Å–∂–∞—Ç–∏—è (—É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
  const COMPRESS_PATTERNS = {
    // –ü—Ä–æ–¥—É–∫—Ç—ã (—Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ)
    '"name":"': '¬§n¬§',
    '"kcal100":': '¬§k¬§',
    '"protein100":': '¬§p¬§',
    '"carbs100":': '¬§c¬§',
    '"fat100":': '¬§f¬§',
    '"simple100":': '¬§s¬§',
    '"complex100":': '¬§x¬§',
    '"badFat100":': '¬§b¬§',
    '"goodFat100":': '¬§g¬§',
    '"trans100":': '¬§t¬§',
    '"fiber100":': '¬§i¬§',
    '"gi":': '¬§G¬§',
    '"harm":': '¬§H¬§',
    '"harmScore":': '¬§h¬§',
    '"category":"': '¬§C¬§',
    '"portions":': '¬§P¬§',
    // –î–Ω–∏ –ø–∏—Ç–∞–Ω–∏—è
    '"meals":': '¬§M¬§',
    '"items":': '¬§I¬§',
    '"product_id":': '¬§D¬§',
    '"time":"': '¬§T¬§',
    '"date":"': '¬§d¬§',
    '"trainings":': '¬§R¬§',
    '"weightMorning":': '¬§W¬§',
    '"sleepHours":': '¬§S¬§',
    '"waterMl":': '¬§w¬§',
    '"steps":': '¬§e¬§',
    '"mood":': '¬§m¬§',
    '"wellbeing":': '¬§B¬§',
    '"stress":': '¬§E¬§',
    '"grams":': '¬§r¬§',
    // –û–±—â–∏–µ JSON –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    '":true': '¬§1¬§',
    '":false': '¬§0¬§',
    '":null': '¬§_¬§',
    '"id":': '¬§j¬§'
  };

  // –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
  const DECOMPRESS_PATTERNS = Object.fromEntries(
    Object.entries(COMPRESS_PATTERNS).map(([k, v]) => [v, k])
  );

  function compress(obj) {
    try {
      // Safe stringify with circular reference detection
      const seen = new WeakSet();
      let json = JSON.stringify(obj, (key, value) => {
        if (typeof value === 'object' && value !== null) {
          if (seen.has(value)) {
            console.warn('[compress] Circular reference detected at key:', key);
            return undefined; // Skip circular refs
          }
          seen.add(value);
        }
        return value;
      });

      // 1. –°–∂–∞—Ç–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –Ω—É–ª–∏)
      // 10.00 ‚Üí 10, 5.50 ‚Üí 5.5
      json = json.replace(/:(-?\d+)\.0+(?=[,}\]])/g, ':$1');
      json = json.replace(/:(-?\d+\.\d*?)0+(?=[,}\]])/g, ':$1');

      // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–∂–∞—Ç–∏—è
      let compressed = json;
      for (const [pattern, code] of Object.entries(COMPRESS_PATTERNS)) {
        compressed = compressed.split(pattern).join(code);
      }

      // 3. –ï—Å–ª–∏ —Å–∂–∞—Ç–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ (>8%), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (compressed.length < json.length * 0.92) {
        return '¬§Z¬§' + compressed;
      }

      return json;
    } catch (e) {
      console.error('[compress] Error:', e?.message || e);
      return JSON.stringify(obj);
    }
  }

  function decompress(str) {
    try {
      if (!str || !str.startsWith('¬§Z¬§')) {
        return JSON.parse(str);
      }

      let decompressed = str.substring(3);

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
      for (const [code, pattern] of Object.entries(DECOMPRESS_PATTERNS)) {
        decompressed = decompressed.split(code).join(pattern);
      }

      return JSON.parse(decompressed);
    } catch (e) {
      // Fallback –¥–ª—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      try { return JSON.parse(str); } catch (e2) { return null; }
    }
  }

  function rawGet(k, d) {
    try {
      const v = localStorage.getItem(k);
      return v ? decompress(v) : d;
    } catch (e) {
      return d;
    }
  }

  function rawSet(k, v) {
    try {
      const compressed = compress(v);
      localStorage.setItem(k, compressed);
      return true;
    } catch (e) {
      const errorName = e?.name || 'UnknownError';
      const errorMsg = e?.message || String(e);
      console.error('[rawSet] ERROR:', k, errorName, errorMsg);

      // QuotaExceededError ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (errorName === 'QuotaExceededError' || errorMsg.includes('quota')) {
        console.warn('[rawSet] localStorage quota exceeded, attempting cleanup...');
        try {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–Ω–∏ (>60 –¥–Ω–µ–π)
          const keysToRemove = [];
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - 60);
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.includes('_dayv2_')) {
              const match = key.match(/_dayv2_(\d{4}-\d{2}-\d{2})/);
              if (match) {
                const keyDate = new Date(match[1]);
                if (keyDate < cutoffDate) {
                  keysToRemove.push(key);
                }
              }
            }
          }
          keysToRemove.forEach(key => localStorage.removeItem(key));
          if (keysToRemove.length > 0) {
            console.log('[rawSet] Cleaned up', keysToRemove.length, 'old day records');
            // Retry
            localStorage.setItem(k, compress(v));
            return true;
          }
        } catch (cleanupErr) {
          console.error('[rawSet] Cleanup failed:', cleanupErr);
        }
      }
      return false;
    }
  }

  function ns() { return (global.HEYS && global.HEYS.currentClientId) || ''; }
  function scoped(k) {
    const cid = ns();
    if (!cid) return k;
    // üéÆ Global keys ‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º clientId (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å cloud sync)
    // heys_game —Ç–µ–ø–µ—Ä—å client-scoped (–∏–Ω–∞—á–µ XP —Å–º–µ—à–∏–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏)
    if (/^heys_(clients|client_current|sound_settings)$/i.test(k)) return k;

    // üêõ FIX: –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç clientId ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ!
    if (cid && k.includes(cid)) {
      return k; // –£–∂–µ scoped
    }

    // –ö–ª—é—á `k` –º–æ–∂–µ—Ç –±—ã—Ç—å 'dayv2_2025-01-01' –∏–ª–∏ 'heys_dayv2_date'.
    // –ú—ã –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–∏—Ç—å client_id –ø–æ—Å–ª–µ 'heys_'.
    if (k.startsWith('heys_')) {
      return 'heys_' + cid + '_' + k.substring('heys_'.length);
    }
    // –î–ª—è –∫–ª—é—á–µ–π, –Ω–µ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å 'heys_', –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å.
    return `heys_${cid}_${k}`;
  }

  Store.get = function (k, def) { const sk = scoped(k); if (memory.has(sk)) return memory.get(sk); const v = rawGet(sk, def); memory.set(sk, v); return v; };
  // If scoped key not present, try unscoped legacy key and migrate it into scoped namespace
  Store.get = (function (orig) {
    return function (k, def) {
      const sk = scoped(k);

      // ÔøΩüîß FIX: –ï—Å–ª–∏ –≤ memory –ª–µ–∂–∏—Ç null/undefined, –Ω–æ –ø–µ—Ä–µ–¥–∞–Ω def ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º def
      // –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–≥ –∫–æ–≥–¥–∞ lsGet(key, null) –∫—ç—à–∏—Ä—É–µ—Ç null, –∞ —Å–ª–µ–¥—É—é—â–∏–π
      // –≤—ã–∑–æ–≤ lsGet(key, {}) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null –≤–º–µ—Å—Ç–æ {}
      if (memory.has(sk)) {
        const cached = memory.get(sk);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ null/undefined, –∏–ª–∏ –µ—Å–ª–∏ def —Ç–æ–∂–µ null/undefined
        if (cached !== null && cached !== undefined) {
          return cached;
        }
        // –ö—ç—à null/undefined ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å def, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º def
        if (def !== undefined && def !== null) {
          return def;
        }
        return cached;
      }
      let v = rawGet(sk, undefined);
      if (v === undefined || v === null) {
        // try legacy unscoped key (with safeguards for heys_game)
        try {
          let allowLegacy = true;
          const cid = ns();
          if (cid && k === 'heys_game') {
            allowLegacy = false;
            // –†–∞–∑—Ä–µ—à–∞–µ–º legacy —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö client-scoped game –∫–ª—é—á–µ–π
            const clientPrefix = `heys_${cid}_`;
            let hasOtherGame = false;
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.endsWith('_game') && key.startsWith('heys_') && !key.startsWith(clientPrefix)) {
                hasOtherGame = true;
                break;
              }
            }
            if (!hasOtherGame) {
              allowLegacy = true;
            }
          }

          if (allowLegacy) {
            const legacy = rawGet(k, undefined);
            if (legacy !== undefined && legacy !== null) {
              // migrate to scoped key for future reads/writes
              memory.set(sk, legacy);
              rawSet(sk, legacy);
              return legacy;
            }
          }
        } catch (e) { }
        // Fallback: if products are stored under another clientId scope
        if (k === 'heys_products') {
          try {
            const keys = Object.keys(localStorage).filter((key) => /^heys_[^_]+_products$/i.test(key));
            let best = null;
            let bestLen = 0;
            for (const key of keys) {
              const candidate = rawGet(key, undefined);
              const len = Array.isArray(candidate) ? candidate.length : 0;
              if (len > bestLen) {
                bestLen = len;
                best = candidate;
              }
            }
            if (best && bestLen > 0) {
              memory.set(sk, best);
              rawSet(sk, best);
              return best;
            }
          } catch (e) { }
        }
        // return default
        v = def;
      }
      memory.set(sk, v);
      return v;
    };
  })(Store.get);
  Store.set = function (k, v) {
    const sk = scoped(k);
    memory.set(sk, v);
    rawSet(sk, v);
    if (watchers.has(sk)) watchers.get(sk).forEach(fn => { try { fn(v); } catch (e) { } });
    try {
      if (global.HEYS && typeof global.HEYS.saveClientKey === 'function') {
        const cid = ns();
        if (cid) {
          // –ü–µ—Ä–µ–¥–∞—ë–º scoped key –≤ –æ–±–ª–∞–∫–æ (—Å clientId), —á—Ç–æ–±—ã –∫–ª—é—á —Å–æ–≤–ø–∞–¥–∞–ª –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
          // sk —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç heys_<clientId>_<key>
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—é–±—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: –æ–±—ä–µ–∫—Ç—ã, –º–∞—Å—Å–∏–≤—ã, boolean, —á–∏—Å–ª–∞, —Å—Ç—Ä–æ–∫–∏
          // (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ undefined –∏ —Ñ—É–Ω–∫—Ü–∏–∏)
          if (v === undefined || typeof v === 'function') {
            return;
          }
          global.HEYS.saveClientKey(cid, sk, v);
        }
      }
    } catch (e) {
      console.error('[Store.set] Error:', e);
      // üî• INSTANT FEEDBACK: –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –æ–±–ª–∞–∫–æ, —É–≤–µ–¥–æ–º–ª—è–µ–º UI
      if (global.dispatchEvent) {
        global.dispatchEvent(new CustomEvent('heys:sync-error', {
          detail: {
            error: `Storage error: ${e.message}`,
            persistent: true
          }
        }));
      }
    }
  };

  Store.watch = function (k, fn) { const sk = scoped(k); if (!watchers.has(sk)) watchers.set(sk, new Set()); watchers.get(sk).add(fn); return () => { const set = watchers.get(sk); if (set) { set.delete(fn); if (!set.size) watchers.delete(sk); } }; };

  Store.flushMemory = function () { memory.clear(); };

  /**
   * –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (–ø—Ä–∏ –ø—Ä—è–º–æ–π –∑–∞–ø–∏—Å–∏ –≤ localStorage –∏–∑–≤–Ω–µ)
   * @param {string} k - –∫–ª—é—á –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
   */
  Store.invalidate = function (k) {
    const sk = scoped(k);
    memory.delete(sk);
    // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å raw key (–µ—Å–ª–∏ –æ–Ω —É–∂–µ scoped)
    memory.delete(k);
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚≠ê –ò–ó–ë–†–ê–ù–ù–´–ï –ü–†–û–î–£–ö–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const FAVORITES_KEY = 'heys_favorite_products';

  /**
   * –ü–æ–ª—É—á–∏—Ç—å Set id –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @returns {Set<string>}
   */
  Store.getFavorites = function () {
    const arr = Store.get(FAVORITES_KEY, []);
    return new Set(Array.isArray(arr) ? arr : []);
  };

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã–º
   * @param {string|number} productId
   * @returns {boolean}
   */
  Store.isFavorite = function (productId) {
    const favorites = Store.getFavorites();
    return favorites.has(String(productId));
  };

  /**
   * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {string|number} productId
   * @returns {boolean} –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (true = –∏–∑–±—Ä–∞–Ω–Ω—ã–π)
   */
  Store.toggleFavorite = function (productId) {
    const id = String(productId);
    const favorites = Store.getFavorites();
    let newState;
    if (favorites.has(id)) {
      favorites.delete(id);
      newState = false;
    } else {
      favorites.add(id);
      newState = true;
    }
    Store.set(FAVORITES_KEY, Array.from(favorites));
    return newState;
  };

  /**
   * –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
   * @param {string|number} productId
   */
  Store.addFavorite = function (productId) {
    const id = String(productId);
    const favorites = Store.getFavorites();
    if (!favorites.has(id)) {
      favorites.add(id);
      Store.set(FAVORITES_KEY, Array.from(favorites));
    }
  };

  /**
   * –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
   * @param {string|number} productId
   */
  Store.removeFavorite = function (productId) {
    const id = String(productId);
    const favorites = Store.getFavorites();
    if (favorites.has(id)) {
      favorites.delete(id);
      Store.set(FAVORITES_KEY, Array.from(favorites));
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üôà –°–ö–†–´–¢–´–ï –ü–†–û–î–£–ö–¢–´ (–≤ —Å–ø–∏—Å–∫–µ "–í–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã")
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const HIDDEN_PRODUCTS_KEY = 'heys_hidden_products';

  /**
   * –ü–æ–ª—É—á–∏—Ç—å Set id —Å–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @returns {Set<string>}
   */
  Store.getHiddenProducts = function () {
    const arr = Store.get(HIDDEN_PRODUCTS_KEY, []);
    return new Set(Array.isArray(arr) ? arr : []);
  };

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–∫—Ä—ã—Ç –ª–∏ –ø—Ä–æ–¥—É–∫—Ç
   * @param {string|number} productId
   * @returns {boolean}
   */
  Store.isHiddenProduct = function (productId) {
    const hidden = Store.getHiddenProducts();
    return hidden.has(String(productId));
  };

  /**
   * –°–∫—Ä—ã—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ "–í–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã"
   * @param {string|number} productId
   */
  Store.hideProduct = function (productId) {
    const id = String(productId);
    const hidden = Store.getHiddenProducts();
    if (!hidden.has(id)) {
      hidden.add(id);
      Store.set(HIDDEN_PRODUCTS_KEY, Array.from(hidden));
      Store.removeFavorite?.(id);
    }
  };

  /**
   * –í–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ —Å–ø–∏—Å–æ–∫ "–í–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã"
   * @param {string|number} productId
   */
  Store.unhideProduct = function (productId) {
    const id = String(productId);
    const hidden = Store.getHiddenProducts();
    if (hidden.has(id)) {
      hidden.delete(id);
      Store.set(HIDDEN_PRODUCTS_KEY, Array.from(hidden));
    }
  };

  /**
   * –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {string|number} productId
   * @returns {boolean} –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (true = —Å–∫—Ä—ã—Ç)
   */
  Store.toggleHiddenProduct = function (productId) {
    const id = String(productId);
    const hidden = Store.getHiddenProducts();
    let newState;
    if (hidden.has(id)) {
      hidden.delete(id);
      newState = false;
    } else {
      hidden.add(id);
      newState = true;
      Store.removeFavorite?.(id);
    }
    Store.set(HIDDEN_PRODUCTS_KEY, Array.from(hidden));
    return newState;
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîí PERSISTENT STORAGE API ‚Äî –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—á–∏—Å—Ç–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
   * –ó–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞
   * @returns {Promise<{persisted: boolean, estimate: {usage: number, quota: number}}>}
   */
  Store.requestPersistentStorage = async function () {
    const result = { persisted: false, estimate: null };

    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
      if (!navigator.storage || !navigator.storage.persist) {
        return result;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      const alreadyPersisted = await navigator.storage.persisted();
      if (alreadyPersisted) {
        result.persisted = true;
      } else {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        const granted = await navigator.storage.persist();
        result.persisted = granted;
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–≤–æ—Ç–µ
      if (navigator.storage.estimate) {
        const estimate = await navigator.storage.estimate();
        result.estimate = {
          usage: Math.round(estimate.usage / 1024 / 1024 * 100) / 100, // MB
          quota: Math.round(estimate.quota / 1024 / 1024 * 100) / 100, // MB
          usedPct: Math.round(estimate.usage / estimate.quota * 100)
        };
      }

    } catch (e) {
      console.warn('[Storage] –û—à–∏–±–∫–∞ Persistent Storage:', e);
    }

    return result;
  };

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
   * @returns {Promise<boolean>}
   */
  Store.isPersistent = async function () {
    try {
      if (navigator.storage && navigator.storage.persisted) {
        return await navigator.storage.persisted();
      }
    } catch (e) { }
    return false;
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
   * @returns {Promise<{usage: number, quota: number, usedPct: number, persisted: boolean}>}
   */
  Store.getStorageInfo = async function () {
    const info = { usage: 0, quota: 0, usedPct: 0, persisted: false };

    try {
      if (navigator.storage) {
        if (navigator.storage.estimate) {
          const est = await navigator.storage.estimate();
          info.usage = Math.round(est.usage / 1024 / 1024 * 100) / 100;
          info.quota = Math.round(est.quota / 1024 / 1024 * 100) / 100;
          info.usedPct = Math.round(est.usage / est.quota * 100);
        }
        if (navigator.storage.persisted) {
          info.persisted = await navigator.storage.persisted();
        }
      }
    } catch (e) { }

    return info;
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìä COMPRESSION STATS ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∂–∞—Ç–∏—è
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–∂–∞—Ç–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
   * @param {string} key - –∫–ª—é—á –≤ localStorage
   * @returns {{raw: number, compressed: number, saved: number, savedPct: number}}
   */
  Store.analyzeCompression = function (key) {
    try {
      const sk = scoped(key);
      const stored = localStorage.getItem(sk);
      if (!stored) return null;

      const isCompressed = stored.startsWith('¬§Z¬§');
      const data = decompress(stored);
      const rawJson = JSON.stringify(data);

      return {
        key: sk,
        isCompressed,
        raw: rawJson.length,
        stored: stored.length,
        saved: rawJson.length - stored.length,
        savedPct: Math.round((1 - stored.length / rawJson.length) * 100)
      };
    } catch (e) {
      return null;
    }
  };

  /**
   * –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º—É localStorage
   * @returns {{totalRaw: number, totalStored: number, savedPct: number, keys: number}}
   */
  Store.getCompressionStats = function () {
    let totalRaw = 0;
    let totalStored = 0;
    let compressedKeys = 0;
    let totalKeys = 0;

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!key.startsWith('heys_')) continue;

      totalKeys++;
      const stored = localStorage.getItem(key);
      totalStored += stored.length * 2; // UTF-16

      if (stored.startsWith('¬§Z¬§')) {
        compressedKeys++;
        try {
          const data = decompress(stored);
          totalRaw += JSON.stringify(data).length * 2;
        } catch (e) {
          totalRaw += stored.length * 2;
        }
      } else {
        totalRaw += stored.length * 2;
      }
    }

    return {
      totalRaw: Math.round(totalRaw / 1024), // KB
      totalStored: Math.round(totalStored / 1024), // KB
      savedKB: Math.round((totalRaw - totalStored) / 1024),
      savedPct: totalRaw > 0 ? Math.round((1 - totalStored / totalRaw) * 100) : 0,
      keys: totalKeys,
      compressedKeys
    };
  };

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å persistent storage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ (–∫–æ–≥–¥–∞ –µ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
      setTimeout(() => {
        Store.requestPersistentStorage().catch(() => { });
      }, 2000);
    });
  }

  // üîß –≠–∫—Å–ø–æ—Ä—Ç compress/decompress –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ cloud sync
  Store.decompress = decompress;
  Store.compress = compress;

})(window);


/* ===== heys_wheel_picker.js ===== */
// heys_wheel_picker.js ‚Äî iOS-style Wheel Picker –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π (–≤—Ä–µ–º—è, –≥—Ä–∞–º–º—ã, –ø–æ—Ä—Ü–∏–∏ –∏ —Ç.–¥.)

;(function(global){
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  
  // === Haptic Feedback ===
  const haptic = {
    light: () => {
      if (navigator.vibrate) navigator.vibrate(5);
    },
    medium: () => {
      if (navigator.vibrate) navigator.vibrate(10);
    },
    tick: () => {
      if (navigator.vibrate) navigator.vibrate(3);
    }
  };
  
  // === Click Sound (lazy-loaded) ===
  let tickSound = null;
  const playTick = () => {
    try {
      if (!tickSound) {
        // –°–æ–∑–¥–∞—ë–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫ —á–µ—Ä–µ–∑ Web Audio API
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        tickSound = { ctx: audioCtx };
      }
      const ctx = tickSound.ctx;
      if (ctx.state === 'suspended') ctx.resume();
      
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.value = 1200; // –í—ã—Å–æ–∫–∏–π —Ç–æ–Ω
      gain.gain.setValueAtTime(0.03, ctx.currentTime); // –¢–∏—Ö–æ
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
      
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.05);
    } catch (e) {
      // Audio API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
    }
  };

  /**
   * WheelColumn ‚Äî iOS-style wheel picker —Å –∏–Ω–µ—Ä—Ü–∏–æ–Ω–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º
   * @param {Object} props
   * @param {Array<string>} props.values - –ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞
   * @param {number} props.selected - –ò–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
   * @param {Function} props.onChange - Callback –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (–ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å)
   * @param {string} [props.label] - –ü–æ–¥–ø–∏—Å—å —Å–≤–µ—Ä—Ö—É –∫–æ–ª–æ–Ω–∫–∏
   * @param {boolean} [props.wrap=true] - –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
   */
  function WheelColumn({ values, selected, onChange, label, wrap = true }) {
    const containerRef = React.useRef(null);
    const itemHeight = 44;
    const len = values.length;
    const [offset, setOffset] = React.useState(-selected * itemHeight);
    const offsetRef = React.useRef(offset);
    
    // –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
    const wrapIndex = (i) => ((i % len) + len) % len;
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ref —Å state
    React.useEffect(() => {
      offsetRef.current = offset;
    }, [offset]);
    
    // Tracking –¥–ª—è momentum
    const touchState = React.useRef({
      startY: 0,
      startOffset: 0,
      lastY: 0,
      lastTime: 0,
      velocityY: 0,
      isTracking: false,
      animationId: null,
      lastTickIndex: selected // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è offset —Å selected –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    React.useEffect(() => {
      setOffset(-selected * itemHeight);
    }, []);
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ index –∏–∑ offset
    const getIndexFromOffset = React.useCallback((off) => {
      const idx = Math.round(-off / itemHeight);
      if (wrap) {
        return wrapIndex(idx);
      }
      return Math.max(0, Math.min(len - 1, idx));
    }, [len, wrap]);
    
    // Snap –∫ –±–ª–∏–∂–∞–π—à–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    const snapToIndex = React.useCallback((targetIndex, animated = true) => {
      let clampedIndex;
      let targetOffset;
      
      if (wrap) {
        clampedIndex = wrapIndex(targetIndex);
        // –î–ª—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞ ‚Äî –Ω–∞—Ö–æ–¥–∏–º –∫—Ä–∞—Ç—á–∞–π—à–∏–π –ø—É—Ç—å –∫ —Ü–µ–ª–µ–≤–æ–º—É –∏–Ω–¥–µ–∫—Å—É
        const currentIdx = Math.round(-offsetRef.current / itemHeight);
        const diff = clampedIndex - currentIdx;
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–Ω–∏—Ü—É –∫ –±–ª–∏–∂–∞–π—à–µ–º—É –ø—É—Ç–∏
        let adjustedDiff = diff;
        if (diff > len / 2) adjustedDiff = diff - len;
        if (diff < -len / 2) adjustedDiff = diff + len;
        targetOffset = -(currentIdx + adjustedDiff) * itemHeight;
      } else {
        clampedIndex = Math.max(0, Math.min(len - 1, targetIndex));
        targetOffset = -clampedIndex * itemHeight;
      }
      
      if (animated) {
        const startOffset = offsetRef.current;
        const startTime = Date.now();
        const duration = 300;
        
        const animateSnap = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(1, elapsed / duration);
          const eased = 1 - Math.pow(1 - progress, 3); // easeOutCubic
          const currentOffset = startOffset + (targetOffset - startOffset) * eased;
          
          setOffset(currentOffset);
          
          if (progress < 1) {
            touchState.current.animationId = requestAnimationFrame(animateSnap);
          } else {
            setOffset(targetOffset);
            if (clampedIndex !== selected) {
              haptic.medium(); // Haptic –ø—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º snap
              onChange(clampedIndex);
            }
          }
        };
        
        touchState.current.animationId = requestAnimationFrame(animateSnap);
      } else {
        setOffset(targetOffset);
        if (clampedIndex !== selected) {
          haptic.medium();
          onChange(clampedIndex);
        }
      }
    }, [len, selected, onChange, wrap]);
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è touch handlers —Å passive: false
    React.useEffect(() => {
      const el = containerRef.current;
      if (!el) return;
      
      const handleTouchStart = (e) => {
        e.preventDefault();
        if (touchState.current.animationId) {
          cancelAnimationFrame(touchState.current.animationId);
          touchState.current.animationId = null;
        }
        
        const touch = e.touches[0];
        const now = Date.now();
        touchState.current = {
          startY: touch.clientY,
          startOffset: offsetRef.current,
          lastY: touch.clientY,
          lastTime: now,
          velocityY: 0,
          isTracking: true,
          animationId: null
        };
      };
      
      const handleTouchMove = (e) => {
        e.preventDefault();
        if (!touchState.current.isTracking) return;
        
        const touch = e.touches[0];
        const now = Date.now();
        const deltaY = touch.clientY - touchState.current.lastY;
        const deltaTime = now - touchState.current.lastTime;
        
        if (deltaTime > 0) {
          touchState.current.velocityY = deltaY / deltaTime;
        }
        
        const newOffset = touchState.current.startOffset + (touch.clientY - touchState.current.startY);
        
        let clampedOffset = newOffset;
        if (wrap) {
          // –í —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º offset
          clampedOffset = newOffset;
        } else {
          // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî —Ä–µ–∑–∏–Ω–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
          const minOffset = -(len - 1) * itemHeight;
          const maxOffset = 0;
          if (newOffset > maxOffset) {
            clampedOffset = maxOffset + (newOffset - maxOffset) * 0.3;
          } else if (newOffset < minOffset) {
            clampedOffset = minOffset + (newOffset - minOffset) * 0.3;
          }
        }
        
        setOffset(clampedOffset);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã —ç–ª–µ–º–µ–Ω—Ç–∞
        const currentIndex = getIndexFromOffset(clampedOffset);
        if (currentIndex !== touchState.current.lastTickIndex) {
          touchState.current.lastTickIndex = currentIndex;
          haptic.tick();
          playTick();
        }
        
        touchState.current.lastY = touch.clientY;
        touchState.current.lastTime = now;
      };
      
      const handleTouchEnd = (e) => {
        e.preventDefault();
        if (!touchState.current.isTracking) return;
        touchState.current.isTracking = false;
        
        const velocity = touchState.current.velocityY;
        
        // –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å –º–∞–ª–µ–Ω—å–∫–∞—è ‚Äî –ø—Ä–æ—Å—Ç–æ snap
        if (Math.abs(velocity) < 0.3) {
          snapToIndex(getIndexFromOffset(offsetRef.current));
          return;
        }
        
        // Momentum animation
        let currentOffset = offsetRef.current;
        let currentVelocity = velocity * 15; // –£—Å–∏–ª–µ–Ω–∏–µ
        const friction = 0.95;
        
        const animate = () => {
          currentVelocity *= friction;
          currentOffset += currentVelocity;
          
          // –ì—Ä–∞–Ω–∏—Ü—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-—Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞)
          if (!wrap) {
            const minOffset = -(len - 1) * itemHeight;
            const maxOffset = 0;
            if (currentOffset > maxOffset) {
              currentOffset = maxOffset;
              currentVelocity = 0;
            } else if (currentOffset < minOffset) {
              currentOffset = minOffset;
              currentVelocity = 0;
            }
          }
          
          setOffset(currentOffset);
          
          // Tick –ø—Ä–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–æ –≤—Ä–µ–º—è momentum
          const currentIndex = getIndexFromOffset(currentOffset);
          if (currentIndex !== touchState.current.lastTickIndex) {
            touchState.current.lastTickIndex = currentIndex;
            haptic.tick();
            playTick();
          }
          
          if (Math.abs(currentVelocity) > 0.5) {
            touchState.current.animationId = requestAnimationFrame(animate);
          } else {
            snapToIndex(getIndexFromOffset(currentOffset));
          }
        };
        
        touchState.current.animationId = requestAnimationFrame(animate);
      };
      
      el.addEventListener('touchstart', handleTouchStart, { passive: false });
      el.addEventListener('touchmove', handleTouchMove, { passive: false });
      el.addEventListener('touchend', handleTouchEnd, { passive: false });
      
      return () => {
        el.removeEventListener('touchstart', handleTouchStart);
        el.removeEventListener('touchmove', handleTouchMove);
        el.removeEventListener('touchend', handleTouchEnd);
        if (touchState.current.animationId) {
          cancelAnimationFrame(touchState.current.animationId);
        }
      };
    }, [len, wrap, snapToIndex, getIndexFromOffset]);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏–∑ offset
    const currentCenterIndex = getIndexFromOffset(offset);
    
    return React.createElement('div', { className: 'wheel-column' },
      label && React.createElement('div', { className: 'wheel-label' }, label),
      React.createElement('div', { 
        className: 'wheel-viewport',
        ref: containerRef
      },
        React.createElement('div', { className: 'wheel-highlight' }),
        React.createElement('div', { 
          className: 'wheel-track',
          style: { transform: `translateY(${offset + itemHeight * 2}px)` }
        },
          values.map((val, i) => {
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∑–∞—Ç—É—Ö–∞–Ω–∏—è
            const distanceFromCenter = Math.abs(i - (-offset / itemHeight));
            const opacity = Math.max(0.3, 1 - distanceFromCenter * 0.3);
            
            return React.createElement('div', {
              key: i,
              className: 'wheel-item' + (i === currentCenterIndex ? ' selected' : ''),
              style: { 
                height: itemHeight,
                opacity: i === currentCenterIndex ? 1 : opacity
              },
              onClick: () => snapToIndex(i)
            }, val);
          })
        )
      )
    );
  }

  // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  WheelColumn.presets = {
    hours: Array.from({length: 24}, (_, i) => String(i).padStart(2, '0')),
    minutes: Array.from({length: 60}, (_, i) => String(i).padStart(2, '0')),
    rating: ['‚Äî', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
    grams: ['10', '25', '50', '75', '100', '125', '150', '175', '200', '250', '300', '400', '500']
  };

  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.WheelColumn = WheelColumn;

})(window);


/* ===== heys_swipeable.js ===== */
// heys_swipeable.js ‚Äî Swipeable –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–∞–π–ø–æ–º –≤–ª–µ–≤–æ
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

;(function(global){
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;

  /**
   * SwipeableRow ‚Äî –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π swipe-to-delete
   * @param {Object} props
   * @param {Function} props.onDelete - Callback –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
   * @param {ReactNode} props.children - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–æ–∫–∏
   * @param {string} [props.className] - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
   */
  function SwipeableRow({ onDelete, children, className = '' }) {
    const rowRef = React.useRef(null);
    const [translateX, setTranslateX] = React.useState(0);
    const [isDeleting, setIsDeleting] = React.useState(false);
    
    const touchState = React.useRef({
      startX: 0,
      startY: 0,
      currentX: 0,
      isTracking: false,
      isVerticalScroll: null // null = –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, true = –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
    });
    
    const DELETE_THRESHOLD = 100; // –ü–æ—Ä–æ–≥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (—É–≤–µ–ª–∏—á–µ–Ω –¥–ª—è –º–µ–Ω—å—à–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
    const DELETE_FULL_THRESHOLD = 180; // –ü–æ—Ä–æ–≥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    
    React.useEffect(() => {
      const el = rowRef.current;
      if (!el) return;
      
      const handleTouchStart = (e) => {
        if (isDeleting) return;
        const touch = e.touches[0];
        touchState.current = {
          startX: touch.clientX,
          startY: touch.clientY,
          currentX: touch.clientX,
          isTracking: true,
          isVerticalScroll: null
        };
      };
      
      const handleTouchMove = (e) => {
        if (!touchState.current.isTracking || isDeleting) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - touchState.current.startX;
        const deltaY = touch.clientY - touchState.current.startY;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ (—É–≤–µ–ª–∏—á–µ–Ω –ø–æ—Ä–æ–≥ 5‚Üí15)
        if (touchState.current.isVerticalScroll === null && (Math.abs(deltaX) > 15 || Math.abs(deltaY) > 15)) {
          touchState.current.isVerticalScroll = Math.abs(deltaY) > Math.abs(deltaX);
        }
        
        // –ï—Å–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª ‚Äî –Ω–µ –º–µ—à–∞–µ–º
        if (touchState.current.isVerticalScroll) return;
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π swipe ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        e.preventDefault();
        
        touchState.current.currentX = touch.clientX;
        
        // –¢–æ–ª—å–∫–æ –≤–ª–µ–≤–æ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
        let newX = deltaX;
        if (newX > 0) newX = 0; // –ù–µ –¥–∞—ë–º —Å–≤–∞–π–ø–∏—Ç—å –≤–ø—Ä–∞–≤–æ
        if (newX < -DELETE_FULL_THRESHOLD * 1.2) {
          newX = -DELETE_FULL_THRESHOLD * 1.2; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º
        }
        
        setTranslateX(newX);
      };
      
      const handleTouchEnd = (e) => {
        if (!touchState.current.isTracking || isDeleting) return;
        touchState.current.isTracking = false;
        
        const finalX = translateX;
        
        if (finalX < -DELETE_FULL_THRESHOLD) {
          // –ü–æ–ª–Ω—ã–π —Å–≤–∞–π–ø ‚Äî —É–¥–∞–ª—è–µ–º
          setIsDeleting(true);
          setTranslateX(-window.innerWidth);
          
          // Haptic feedback
          if (navigator.vibrate) navigator.vibrate(20);
          
          setTimeout(() => {
            onDelete();
          }, 200);
        } else if (finalX < -DELETE_THRESHOLD) {
          // –ß–∞—Å—Ç–∏—á–Ω—ã–π —Å–≤–∞–π–ø ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          setTranslateX(-DELETE_THRESHOLD);
        } else {
          // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Å–≤–∞–π–ø ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
          setTranslateX(0);
        }
      };
      
      el.addEventListener('touchstart', handleTouchStart, { passive: true });
      el.addEventListener('touchmove', handleTouchMove, { passive: false });
      el.addEventListener('touchend', handleTouchEnd, { passive: true });
      
      return () => {
        el.removeEventListener('touchstart', handleTouchStart);
        el.removeEventListener('touchmove', handleTouchMove);
        el.removeEventListener('touchend', handleTouchEnd);
      };
    }, [translateX, isDeleting, onDelete]);
    
    // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
    const handleDeleteClick = () => {
      setIsDeleting(true);
      setTranslateX(-window.innerWidth);
      if (navigator.vibrate) navigator.vibrate(20);
      setTimeout(() => {
        onDelete();
      }, 200);
    };
    
    // –ö–ª–∏–∫ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî –∑–∞–∫—Ä—ã—Ç—å –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
    const handleContentClick = () => {
      if (translateX < 0) {
        setTranslateX(0);
      }
    };
    
    return React.createElement('div', { 
      className: 'swipeable-container ' + className,
      ref: rowRef
    },
      // –§–æ–Ω —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
      React.createElement('div', { className: 'swipeable-background' },
        React.createElement('button', { 
          className: 'swipeable-delete-btn',
          onClick: handleDeleteClick
        }, '–£–¥–∞–ª–∏—Ç—å')
      ),
      // –ö–æ–Ω—Ç–µ–Ω—Ç
      React.createElement('div', { 
        className: 'swipeable-content' + (isDeleting ? ' deleting' : ''),
        style: { 
          transform: `translateX(${translateX}px)`,
          transition: touchState.current.isTracking ? 'none' : 'transform 0.2s ease-out'
        },
        onClick: handleContentClick
      }, children)
    );
  }
  
  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.SwipeableRow = SwipeableRow;
  
})(window);


/* ===== heys_pull_refresh.js ===== */
// heys_pull_refresh.js ‚Äî Pull-to-refresh component for mobile

;(function(global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;

  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (—É–≤–µ–ª–∏—á–µ–Ω—ã –ø–æ—Ä–æ–≥–∏ –¥–ª—è –º–µ–Ω—å—à–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
  const PULL_THRESHOLD = 100; // px –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
  const MAX_PULL = 140; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞

  function PullToRefresh({ onRefresh, children }) {
    const { useState, useRef, useCallback, useEffect } = React;
    
    const [pullDistance, setPullDistance] = useState(0);
    const [isRefreshing, setIsRefreshing] = useState(false);
    const containerRef = useRef(null);
    const startYRef = useRef(0);
    const isPullingRef = useRef(false);
    
    // Haptic feedback
    const vibrate = useCallback((ms) => {
      if (navigator.vibrate) navigator.vibrate(ms);
    }, []);
    
    const handleTouchStart = useCallback((e) => {
      // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∫—Ä–æ–ª–ª –≤ –Ω–∞—á–∞–ª–µ
      if (containerRef.current && containerRef.current.scrollTop === 0) {
        startYRef.current = e.touches[0].clientY;
        isPullingRef.current = true;
      }
    }, []);
    
    const handleTouchMove = useCallback((e) => {
      if (!isPullingRef.current || isRefreshing) return;
      
      const currentY = e.touches[0].clientY;
      const diff = currentY - startYRef.current;
      
      if (diff > 0) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º easing –¥–ª—è –±–æ–ª–µ–µ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –æ—â—É—â–µ–Ω–∏—è
        const easedDiff = Math.min(MAX_PULL, diff * 0.4);
        setPullDistance(easedDiff);
        
        // Haptic –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ threshold
        if (easedDiff >= PULL_THRESHOLD && pullDistance < PULL_THRESHOLD) {
          vibrate(10);
        }
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –±—Ä–∞—É–∑–µ—Ä–∞ (—É–≤–µ–ª–∏—á–µ–Ω –ø–æ—Ä–æ–≥)
        if (diff > 20) {
          e.preventDefault();
        }
      }
    }, [isRefreshing, pullDistance, vibrate]);
    
    const handleTouchEnd = useCallback(() => {
      isPullingRef.current = false;
      
      if (pullDistance >= PULL_THRESHOLD && !isRefreshing) {
        setIsRefreshing(true);
        vibrate(20);
        
        // –í—ã–∑—ã–≤–∞–µ–º onRefresh
        if (onRefresh) {
          Promise.resolve(onRefresh()).finally(() => {
            setIsRefreshing(false);
            setPullDistance(0);
          });
        } else {
          // –ë–µ–∑ onRefresh ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–µ—Å–µ—Ç
          setTimeout(() => {
            setIsRefreshing(false);
            setPullDistance(0);
          }, 1000);
        }
      } else {
        setPullDistance(0);
      }
    }, [pullDistance, isRefreshing, onRefresh, vibrate]);
    
    // Touch event listeners
    useEffect(() => {
      const container = containerRef.current;
      if (!container) return;
      
      container.addEventListener('touchstart', handleTouchStart, { passive: true });
      container.addEventListener('touchmove', handleTouchMove, { passive: false });
      container.addEventListener('touchend', handleTouchEnd, { passive: true });
      
      return () => {
        container.removeEventListener('touchstart', handleTouchStart);
        container.removeEventListener('touchmove', handleTouchMove);
        container.removeEventListener('touchend', handleTouchEnd);
      };
    }, [handleTouchStart, handleTouchMove, handleTouchEnd]);
    
    // –ü—Ä–æ–≥—Ä–µ—Å—Å (0-1)
    const progress = Math.min(1, pullDistance / PULL_THRESHOLD);
    const isReady = pullDistance >= PULL_THRESHOLD;
    
    return React.createElement('div', {
      ref: containerRef,
      className: 'pull-refresh-container',
      style: { 
        position: 'relative',
        overflow: 'auto',
        height: '100%'
      }
    },
      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä
      React.createElement('div', {
        className: 'pull-refresh-indicator',
        style: {
          position: 'absolute',
          top: 0,
          left: '50%',
          transform: `translateX(-50%) translateY(${pullDistance - 40}px)`,
          opacity: progress,
          transition: isRefreshing ? 'none' : 'opacity 0.2s',
          zIndex: 100
        }
      },
        React.createElement('div', {
          className: 'pull-refresh-spinner' + (isRefreshing ? ' spinning' : ''),
          style: {
            width: '24px',
            height: '24px',
            border: '2px solid #e0e0e0',
            borderTopColor: isReady || isRefreshing ? '#4CAF50' : '#2196F3',
            borderRadius: '50%',
            transform: `rotate(${progress * 180}deg)`,
            animation: isRefreshing ? 'spin 0.8s linear infinite' : 'none'
          }
        })
      ),
      
      // –ö–æ–Ω—Ç–µ–Ω—Ç —Å –æ—Ç—Å—Ç—É–ø–æ–º –ø—Ä–∏ pull
      React.createElement('div', {
        style: {
          transform: `translateY(${pullDistance}px)`,
          transition: isPullingRef.current ? 'none' : 'transform 0.3s ease-out'
        }
      }, children)
    );
  }

  HEYS.PullToRefresh = PullToRefresh;

})(window);


/* ===== heys_toast_v1.js ===== */
// heys_toast_v1.js ‚Äî –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
// –ó–∞–º–µ–Ω—è–µ—Ç browser alert() –Ω–∞ –∫—Ä–∞—Å–∏–≤—ã–µ toasts
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };

  // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
  const CONFIG = {
    defaultDuration: 3500,    // ms ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞
    longDuration: 5000,       // ms ‚Äî –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    shortDuration: 2000,      // ms ‚Äî –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
    maxVisible: 3,            // –ú–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö
    animationDuration: 300,   // ms ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
    toastTopOffset: 72,       // px ‚Äî –æ—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–∞ (–¥–æ —à–∞–ø–∫–∏)
    tooltipToastEnabled: true, // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ (title) –∫–∞–∫ toast –Ω–∞ –º–æ–±–∏–ª–∫–µ
    tooltipCooldown: 1200,     // ms ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
    tooltipMaxDepth: 4,        // –ú–∞–∫—Å. –≥–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ title —É —Ä–æ–¥–∏—Ç–µ–ª—è
    tooltipTitle: '‚ÑπÔ∏è –ü–æ–¥—Å–∫–∞–∑–∫–∞'
  };

  // === –¢–ò–ü–´ TOASTS ===
  const TOAST_TYPES = {
    success: {
      icon: '‚úÖ',
      gradient: 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
      shadowColor: 'rgba(16, 185, 129, 0.4)',
    },
    error: {
      icon: '‚ùå',
      gradient: 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)',
      shadowColor: 'rgba(239, 68, 68, 0.4)',
    },
    warning: {
      icon: '‚ö†Ô∏è',
      gradient: 'linear-gradient(135deg, #d97706 0%, #f59e0b 100%)',
      shadowColor: 'rgba(245, 158, 11, 0.4)',
    },
    info: {
      icon: '‚ÑπÔ∏è',
      gradient: 'linear-gradient(135deg, #2563eb 0%, #3b82f6 100%)',
      shadowColor: 'rgba(59, 130, 246, 0.4)',
    },
    tip: {
      icon: 'üí°',
      gradient: 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)',
      shadowColor: 'rgba(139, 92, 246, 0.4)',
    },
  };

  // === –°–û–°–¢–û–Ø–ù–ò–ï ===
  let toastQueue = [];
  let visibleToasts = [];
  let containerId = 'heys-toast-container';

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–ê ===
  function ensureContainer() {
    let container = document.getElementById(containerId);
    if (!container) {
      container = document.createElement('div');
      container.id = containerId;
      container.style.cssText = `
        position: fixed;
        top: calc(${CONFIG.toastTopOffset}px + env(safe-area-inset-top));
        left: 50%;
        transform: translateX(-50%);
        z-index: 10002;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        pointer-events: none;
        max-width: 90vw;
      `;
      document.body.appendChild(container);
    }
    return container;
  }

  // === –°–û–ó–î–ê–ù–ò–ï TOAST –≠–õ–ï–ú–ï–ù–¢–ê ===
  function createToastElement(options) {
    const { type = 'info', title, message, icon, duration, action } = options;
    const typeConfig = TOAST_TYPES[type] || TOAST_TYPES.info;
    const displayIcon = icon || typeConfig.icon;

    const toast = document.createElement('div');
    toast.className = 'heys-toast';
    toast.style.cssText = `
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 18px;
      background: ${typeConfig.gradient};
      border-radius: 16px;
      box-shadow: 0 4px 20px ${typeConfig.shadowColor}, 0 2px 8px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      max-width: 360px;
      min-width: 280px;
      pointer-events: auto;
      opacity: 0;
      transform: translateY(-100%) scale(0.9);
      transition: all ${CONFIG.animationDuration}ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
      cursor: pointer;
    `;

    // –ò–∫–æ–Ω–∫–∞
    const iconEl = document.createElement('span');
    iconEl.style.cssText = `
      font-size: 22px;
      flex-shrink: 0;
      line-height: 1;
    `;
    iconEl.textContent = displayIcon;
    toast.appendChild(iconEl);

    // –ö–æ–Ω—Ç–µ–Ω—Ç
    const content = document.createElement('div');
    content.style.cssText = `
      flex: 1;
      min-width: 0;
    `;

    if (title) {
      const titleEl = document.createElement('div');
      titleEl.style.cssText = `
        font-size: 14px;
        font-weight: 600;
        color: white;
        margin-bottom: ${message ? '4px' : '0'};
        line-height: 1.3;
      `;
      titleEl.textContent = title;
      content.appendChild(titleEl);
    }

    if (message) {
      const messageEl = document.createElement('div');
      messageEl.style.cssText = `
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.4;
        white-space: pre-line;
      `;
      messageEl.textContent = message;
      content.appendChild(messageEl);
    }

    toast.appendChild(content);

    // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if (action) {
      const actionBtn = document.createElement('button');
      actionBtn.style.cssText = `
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.25);
        color: white;
        font-size: 12px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        flex-shrink: 0;
        transition: background 0.15s;
      `;
      actionBtn.textContent = action.label;
      actionBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        action.onClick?.();
        hideToast(toast);
      });
      actionBtn.addEventListener('mouseenter', () => {
        actionBtn.style.background = 'rgba(255, 255, 255, 0.35)';
      });
      actionBtn.addEventListener('mouseleave', () => {
        actionBtn.style.background = 'rgba(255, 255, 255, 0.25)';
      });
      toast.appendChild(actionBtn);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É
    toast.addEventListener('click', () => hideToast(toast));

    return toast;
  }

  // === –ü–û–ö–ê–ó TOAST ===
  function showToast(options) {
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ü–∏–π
    if (typeof options === 'string') {
      options = { message: options };
    }

    const { duration = CONFIG.defaultDuration } = options;

    // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç ‚Äî —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ
    while (visibleToasts.length >= CONFIG.maxVisible) {
      const oldest = visibleToasts[0];
      hideToast(oldest);
    }

    const container = ensureContainer();
    const toast = createToastElement(options);

    container.appendChild(toast);
    visibleToasts.push(toast);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0) scale(1)';
    });

    // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ
    if (duration > 0) {
      toast._timeout = setTimeout(() => hideToast(toast), duration);
    }

    return toast;
  }

  // === –°–ö–†–´–¢–ò–ï TOAST ===
  function hideToast(toast) {
    if (!toast || toast._hiding) return;
    toast._hiding = true;

    if (toast._timeout) {
      clearTimeout(toast._timeout);
    }

    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-20px) scale(0.9)';

    setTimeout(() => {
      toast.remove();
      visibleToasts = visibleToasts.filter(t => t !== toast);
    }, CONFIG.animationDuration);
  }

  // === –£–î–û–ë–ù–´–ï –ú–ï–¢–û–î–´ ===
  const Toast = {
    show: showToast,

    success(message, options = {}) {
      return showToast({ type: 'success', message, ...options });
    },

    error(message, options = {}) {
      return showToast({ type: 'error', message, duration: CONFIG.longDuration, ...options });
    },

    warning(message, options = {}) {
      return showToast({ type: 'warning', message, ...options });
    },

    info(message, options = {}) {
      return showToast({ type: 'info', message, ...options });
    },

    tip(message, options = {}) {
      return showToast({ type: 'tip', message, duration: CONFIG.longDuration, ...options });
    },

    // –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π ‚Äî —Å –∫–Ω–æ–ø–∫–æ–π
    confirm(message, actionLabel, onAction) {
      return showToast({
        type: 'warning',
        message,
        duration: 0, // –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        action: { label: actionLabel, onClick: onAction }
      });
    },

    // –°–∫—Ä—ã—Ç—å –≤—Å–µ
    hideAll() {
      [...visibleToasts].forEach(hideToast);
    }
  };

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.Toast = Toast;

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ö–µ–ª–ø–µ—Ä –¥–ª—è –∑–∞–º–µ–Ω—ã alert()
  HEYS.toast = Toast.show;

  // === MOBILE TOOLTIP ‚Üí TOAST ===
  let lastTooltipAt = 0;
  let lastTooltipText = '';

  function isTouchLike() {
    if (typeof window === 'undefined' || !window.matchMedia) return false;
    try {
      return window.matchMedia('(hover: none)').matches || window.matchMedia('(pointer: coarse)').matches;
    } catch (e) {
      return false;
    }
  }

  function findTitleTarget(startEl) {
    let el = startEl;
    for (let i = 0; i < CONFIG.tooltipMaxDepth && el; i++) {
      if (el.getAttribute && el.getAttribute('title')) {
        if (el.getAttribute('data-toast-disabled') === 'true') return null;
        if (el.getAttribute('data-tooltip') !== 'ui') return null;
        return el;
      }
      el = el.parentElement;
    }
    return null;
  }

  function handleTooltipTap(e) {
    if (!CONFIG.tooltipToastEnabled || !isTouchLike()) return;
    const target = findTitleTarget(e.target);
    if (!target) return;
    const text = target.getAttribute('title');
    if (!text) return;

    const now = Date.now();
    if (now - lastTooltipAt < CONFIG.tooltipCooldown) return;
    if (lastTooltipText && lastTooltipText === text) return;
    lastTooltipAt = now;
    lastTooltipText = text;

    Toast.info(text, { title: CONFIG.tooltipTitle, duration: CONFIG.shortDuration });
  }

  if (typeof document !== 'undefined') {
    document.addEventListener('click', handleTooltipTap, true);
  }

  // === –ò–ù–¢–ï–†–¶–ï–ü–¢–û–† alert() (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è legacy) ===
  // –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ alert()
  // const originalAlert = window.alert;
  // window.alert = function(message) {
  //   if (HEYS.Toast) {
  //     HEYS.Toast.info(message);
  //   } else {
  //     originalAlert(message);
  //   }
  // };

  devLog('[HEYS] Toast module loaded');

})(typeof window !== 'undefined' ? window : global);
