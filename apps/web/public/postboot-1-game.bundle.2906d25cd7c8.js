
/* ===== heys_daily_missions_v1.js ===== */
// heys_daily_missions_v1.js ‚Äî Daily Missions Pool & Selection Engine
// –û—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –º–∏—Å—Å–∏–π –¥–Ω—è. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –î–û heys_gamification_v1.js
// v1.0.0
window.__heysPerfMark && window.__heysPerfMark('postboot-1-game: execute start');
(function (global) {
    'use strict';

    const HEYS = global.HEYS = global.HEYS || {};

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    /** Read profile from storage */
    function getProfile() {
        try {
            if (HEYS.store?.get) return HEYS.store.get('heys_profile', {}) || {};
            const U = HEYS.utils || {};
            if (U.lsGet) return U.lsGet('heys_profile', {}) || {};
            const raw = localStorage.getItem('heys_profile');
            return raw ? JSON.parse(raw) : {};
        } catch { return {}; }
    }

    /** Read normAbs from HEYS.Day or fallback */
    function getNormAbs() {
        try {
            // HEYS.Day exports normAbs via getFiberPercent internals ‚Äî but we need raw norms
            // Use stored norms as fallback
            if (HEYS.store?.get) {
                const n = HEYS.store.get('heys_norms', null);
                if (n) return n;
            }
            const U = HEYS.utils || {};
            if (U.lsGet) {
                const n = U.lsGet('heys_norms', null);
                if (n) return n;
            }
        } catch { /* ignore */ }
        return null;
    }

    // ‚îÄ‚îÄ‚îÄ Categories ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const CATEGORY = {
        NUTRITION: 'nutrition',
        WATER: 'water',
        QUALITY: 'quality',
        DISCIPLINE: 'discipline',
        ACTIVITY: 'activity'
    };

    const CATEGORY_META = {
        [CATEGORY.NUTRITION]: { label: '–ü–∏—Ç–∞–Ω–∏–µ', icon: 'üçΩÔ∏è' },
        [CATEGORY.WATER]: { label: '–í–æ–¥–∞', icon: 'üíß' },
        [CATEGORY.QUALITY]: { label: '–ö–∞—á–µ—Å—Ç–≤–æ', icon: '‚≠ê' },
        [CATEGORY.DISCIPLINE]: { label: '–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞', icon: '‚è∞' },
        [CATEGORY.ACTIVITY]: { label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', icon: 'üèÉ' }
    };

    // ‚îÄ‚îÄ‚îÄ Mission Pool (~31) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //
    // Fields:
    //   id        ‚Äî unique mission ID
    //   name      ‚Äî display name (RU)
    //   icon      ‚Äî emoji
    //   desc      ‚Äî short description (RU)
    //   xp        ‚Äî XP reward
    //   type      ‚Äî handler type (used in updateDailyMission switch)
    //   category  ‚Äî one of CATEGORY values
    //   target    ‚Äî completion threshold
    //   minLevel  ‚Äî minimum player level (default 1)
    //   condition ‚Äî optional (profile) => boolean ‚Äî extra filter
    //
    // condition checks:
    //   insulinWaveHours > 3 ‚Üí "–Ω–µ IF-—Ä–µ–∂–∏–º" (3+ —á–∞—Å–∞ –≤–æ–ª–Ω–∞ = 3+ –ø—Ä–∏—ë–º–∞ –≤ –¥–µ–Ω—å)
    //   insulinWaveHours <= 3 ‚Üí IF-—Ä–µ–∂–∏–º (2 –ø—Ä–∏—ë–º–∞)

    const DAILY_MISSION_POOL = [
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–ò–¢–ê–ù–ò–ï ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        {
            id: 'log_2_meals',
            name: '–î–≤–∞ –ø—Ä–∏—ë–º–∞',
            icon: 'üçΩÔ∏è',
            desc: '–ó–∞–ø–∏—à–∏ 2 –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏',
            xp: 15,
            type: 'meals',
            category: CATEGORY.NUTRITION,
            target: 2,
            minLevel: 1
        },
        {
            id: 'log_3_meals',
            name: '–¢—Ä–∏ –ø—Ä–∏—ë–º–∞',
            icon: 'üç±',
            desc: '–ó–∞–ø–∏—à–∏ 3 –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏',
            xp: 25,
            type: 'meals',
            category: CATEGORY.NUTRITION,
            target: 3,
            minLevel: 4,
            // –ù–µ –≤—ã–¥–∞–≤–∞—Ç—å IF-–∫–ª–∏–µ–Ω—Ç–∞–º (insulinWaveHours ‚â§ 3 ‚Üí –æ–±—ã—á–Ω–æ 2 –ø—Ä–∏—ë–º–∞)
            condition: (p) => (p.insulinWaveHours || 3) > 3,
            hint: '–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏',
            strategy: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∏—ë–º—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ: –∑–∞–≤—Ç—Ä–∞–∫ 8-9, –æ–±–µ–¥ 13-14, —É–∂–∏–Ω 19-20. –ü–ª–∞–Ω–∏—Ä—É–π –∑–∞—Ä–∞–Ω–µ–µ',
            examples: ['–ö–∞—à–∞ —É—Ç—Ä–æ–º', '–°—É–ø –¥–Ω—ë–º', '–û–≤–æ—â–∏ + –±–µ–ª–æ–∫ –≤–µ—á–µ—Ä–æ–º']
        },
        {
            id: 'add_5_products',
            name: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ',
            icon: 'ü•ó',
            desc: '–î–æ–±–∞–≤—å 5 —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤',
            xp: 20,
            type: 'products',
            category: CATEGORY.NUTRITION,
            target: 5,
            minLevel: 1
        },
        {
            id: 'add_8_products',
            name: '–ì—É—Ä–º–∞–Ω',
            icon: 'üç≤',
            desc: '–î–æ–±–∞–≤—å 8 —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤',
            xp: 30,
            type: 'products',
            category: CATEGORY.NUTRITION,
            target: 8,
            minLevel: 5,
            hint: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–µ–∫—Ç—Ä –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤',
            strategy: '–ü—Ä–∞–≤–∏–ª–æ —Ä–∞–¥—É–≥–∏: –ø—Ä–æ–¥—É–∫—Ç—ã —Ä–∞–∑–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤. –ö–æ–º–±–∏–Ω–∏—Ä—É–π –∫—Ä—É–ø—ã, –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –±–µ–ª–∫–∏',
            examples: ['–ì—Ä–µ—á–∫–∞ + –∫—É—Ä–∏—Ü–∞ + –æ–≥—É—Ä–µ—Ü + —Ç–æ–º–∞—Ç + —è–±–ª–æ–∫–æ + —Ç–≤–æ—Ä–æ–≥ + —Ö–ª–µ–± + –æ—Ä–µ—Ö–∏']
        },
        {
            id: 'first_meal_before_10',
            name: '–†–∞–Ω–Ω–∏–π –∑–∞–≤—Ç—Ä–∞–∫',
            icon: 'üåÖ',
            desc: '–ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –¥–æ 10:00',
            xp: 20,
            type: 'early_meal',
            category: CATEGORY.NUTRITION,
            target: 10,
            minLevel: 3,
            // –ù–µ –≤—ã–¥–∞–≤–∞—Ç—å IF-–∫–ª–∏–µ–Ω—Ç–∞–º
            condition: (p) => (p.insulinWaveHours || 3) > 3
        },
        {
            id: 'kcal_70',
            name: '70% –∫–∞–ª–æ—Ä–∏–π',
            icon: 'üî•',
            desc: '–ù–∞–±–µ—Ä–∏ 70% –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π',
            xp: 20,
            type: 'kcal',
            category: CATEGORY.NUTRITION,
            target: 70,
            minLevel: 2
        },
        {
            id: 'kcal_90',
            name: '–ü–æ—á—Ç–∏ –≤ –Ω–æ—Ä–º–µ',
            icon: 'üéØ',
            desc: '–ù–∞–±–µ—Ä–∏ 90% –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π',
            xp: 30,
            type: 'kcal',
            category: CATEGORY.NUTRITION,
            target: 90,
            minLevel: 6
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –í–û–î–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        {
            id: 'water_50',
            name: '–ü–æ–ª–ø—É—Ç–∏',
            icon: 'üíß',
            desc: '–í—ã–ø–µ–π 50% –Ω–æ—Ä–º—ã –≤–æ–¥—ã',
            xp: 15,
            type: 'water',
            category: CATEGORY.WATER,
            target: 50,
            minLevel: 1
        },
        {
            id: 'water_80',
            name: '–•–æ—Ä–æ—à–æ!',
            icon: 'üí¶',
            desc: '–í—ã–ø–µ–π 80% –Ω–æ—Ä–º—ã –≤–æ–¥—ã',
            xp: 25,
            type: 'water',
            category: CATEGORY.WATER,
            target: 80,
            minLevel: 3
        },
        {
            id: 'water_100',
            name: '–ù–æ—Ä–º–∞ –≤–æ–¥—ã',
            icon: 'üåä',
            desc: '–í—ã–ø–æ–ª–Ω–∏ –Ω–æ—Ä–º—É –≤–æ–¥—ã –Ω–∞ 100%',
            xp: 30,
            type: 'water',
            category: CATEGORY.WATER,
            target: 100,
            minLevel: 5,
            hint: '–í–æ–¥–∞ —É–ª—É—á—à–∞–µ—Ç –æ–±–º–µ–Ω –≤–µ—â–µ—Å—Ç–≤ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é',
            strategy: '–°—Ç–∞–∫–∞–Ω —É—Ç—Ä–æ–º, –ø–æ 200–º–ª –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞, –∑–∞ 30–º–∏–Ω –¥–æ –µ–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è',
            examples: ['–£—Ç—Ä–æ–º 250–º–ª', '–ö–∞–∂–¥—ã–µ 2—á –ø–æ 200–º–ª', '–ü–µ—Ä–µ–¥ –æ–±–µ–¥–æ–º 250–º–ª']
        },
        {
            id: 'water_3_times',
            name: '–†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
            icon: '‚è±Ô∏è',
            desc: '–ó–∞–ø–∏—à–∏ –≤–æ–¥—É 3 —Ä–∞–∑–∞',
            xp: 20,
            type: 'water_entries',
            category: CATEGORY.WATER,
            target: 3,
            minLevel: 1
        },
        {
            id: 'water_5_times',
            name: '–í–æ–¥–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω',
            icon: 'üöø',
            desc: '–ó–∞–ø–∏—à–∏ –≤–æ–¥—É 5 —Ä–∞–∑',
            xp: 25,
            type: 'water_entries',
            category: CATEGORY.WATER,
            target: 5,
            minLevel: 5
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–ê–ß–ï–°–¢–í–û ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        {
            id: 'protein_50',
            name: '–ë–µ–ª–∫–æ–≤—ã–π —Å—Ç–∞—Ä—Ç',
            icon: 'ü•ö',
            desc: '–ù–∞–±–µ—Ä–∏ 50% –Ω–æ—Ä–º—ã –±–µ–ª–∫–∞',
            xp: 15,
            type: 'protein',
            category: CATEGORY.QUALITY,
            target: 50,
            minLevel: 1
        },
        {
            id: 'protein_80',
            name: '–ë–µ–ª–∫–æ–≤—ã–π –¥–µ–Ω—å',
            icon: 'ü•©',
            desc: '–ù–∞–±–µ—Ä–∏ 80% –Ω–æ—Ä–º—ã –±–µ–ª–∫–∞',
            xp: 30,
            type: 'protein',
            category: CATEGORY.QUALITY,
            target: 80,
            minLevel: 4,
            hint: '–ë–µ–ª–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –º—ã—à—Ü –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
            strategy: '–í –∫–∞–∂–¥—ã–π –ø—Ä–∏—ë–º –±–µ–ª–∫–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç: —è–π—Ü–∞ —É—Ç—Ä–æ–º, –∫—É—Ä–∏—Ü–∞ –¥–Ω—ë–º, —Ä—ã–±–∞/—Ç–≤–æ—Ä–æ–≥ –≤–µ—á–µ—Ä–æ–º. –ü–æ—Ä—Ü–∏–∏ 20-30–≥',
            examples: ['–Ø–π—Ü–∞ 2—à—Ç (12–≥)', '–ö—É—Ä–∏—Ü–∞ 100–≥ (25–≥)', '–¢–≤–æ—Ä–æ–≥ 200–≥ (30–≥)']
        },
        {
            id: 'fiber_50',
            name: '–ë–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏',
            icon: 'ü•¶',
            desc: '–ù–∞–±–µ—Ä–∏ 50% –Ω–æ—Ä–º—ã –∫–ª–µ—Ç—á–∞—Ç–∫–∏',
            xp: 20,
            type: 'fiber',
            category: CATEGORY.QUALITY,
            target: 50,
            minLevel: 3,
            hint: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ —É–ª—É—á—à–∞–µ—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Å–∞',
            strategy: '–û–≤–æ—â–∏ –∫ –∫–∞–∂–¥–æ–º—É –ø—Ä–∏—ë–º—É. –¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ –∫—Ä—É–ø—ã. –§—Ä—É–∫—Ç—ã —Å –∫–æ–∂—É—Ä–æ–π. –û—Ç—Ä—É–±–∏',
            examples: ['–û–≤–æ—â–Ω–æ–π —Å–∞–ª–∞—Ç 200–≥', '–ì—Ä–µ—á–∫–∞ 150–≥', '–Ø–±–ª–æ–∫–æ —Å –∫–æ–∂—É—Ä–æ–π', '–û—Ç—Ä—É–±–∏ 2—Å—Ç.–ª.']
        },
        {
            id: 'fiber_80',
            name: 'Fiber Master',
            icon: 'ü•¨',
            desc: '–ù–∞–±–µ—Ä–∏ 80% –Ω–æ—Ä–º—ã –∫–ª–µ—Ç—á–∞—Ç–∫–∏',
            xp: 30,
            type: 'fiber',
            category: CATEGORY.QUALITY,
            target: 80,
            minLevel: 6
        },
        {
            id: 'low_harm',
            name: '–ß–∏—Å—Ç–æ–µ –ø–∏—Ç–∞–Ω–∏–µ',
            icon: '‚ú®',
            desc: 'Harm score –Ω–∏–∂–µ 30% –Ω–æ—Ä–º—ã',
            xp: 30,
            type: 'low_harm',
            category: CATEGORY.QUALITY,
            target: 30,
            minLevel: 5
        },
        {
            id: 'balance_day',
            name: '–ë–∞–ª–∞–Ω—Å –ë–ñ–£',
            icon: '‚öñÔ∏è',
            desc: '–í—Å–µ –º–∞–∫—Ä–æ—Å—ã 80-120% –Ω–æ—Ä–º—ã',
            xp: 40,
            type: 'balance',
            category: CATEGORY.QUALITY,
            target: 1,
            minLevel: 7
        },
        {
            id: 'low_gi_meal',
            name: '–ù–∏–∑–∫–∏–π –ì–ò',
            icon: 'üìâ',
            desc: '–ü—Ä–∏—ë–º –ø–∏—â–∏ —Å –ì–ò < 50',
            xp: 25,
            type: 'low_gi',
            category: CATEGORY.QUALITY,
            target: 1,
            minLevel: 6
        },
        {
            id: 'complex_carbs_60',
            name: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã',
            icon: 'üåæ',
            desc: '60%+ —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî —Å–ª–æ–∂–Ω—ã–µ',
            xp: 25,
            type: 'complex_carbs',
            category: CATEGORY.QUALITY,
            target: 60,
            minLevel: 5
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –î–ò–°–¶–ò–ü–õ–ò–ù–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        {
            id: 'streak_keep',
            name: '–î–µ—Ä–∂–∏ —Å—Ç—Ä–∏–∫',
            icon: 'üî•',
            desc: '–ó–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã 1 –ø—Ä–∏—ë–º –ø–∏—â–∏',
            xp: 10,
            type: 'streak_keep',
            category: CATEGORY.DISCIPLINE,
            target: 1,
            minLevel: 1
        },
        {
            id: 'dinner_before_20',
            name: '–£–∂–∏–Ω –¥–æ 20:00',
            icon: 'üåô',
            desc: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –¥–æ 20:00',
            xp: 20,
            type: 'dinner_time',
            category: CATEGORY.DISCIPLINE,
            target: 1,
            threshold: 20, // hour
            minLevel: 3
        },
        {
            id: 'no_late_snack',
            name: '–ë–µ–∑ –ø–æ–∑–¥–Ω–µ–≥–æ –ø–µ—Ä–µ–∫—É—Å–∞',
            icon: 'üö´',
            desc: '–ù–µ—Ç –ø—Ä–∏—ë–º–æ–≤ –ø–æ—Å–ª–µ 21:00',
            xp: 25,
            type: 'no_late_snack',
            category: CATEGORY.DISCIPLINE,
            target: 1,
            threshold: 21, // hour
            minLevel: 4
        },
        {
            id: 'eating_window_12h',
            name: '–û–∫–Ω–æ –ø–∏—Ç–∞–Ω–∏—è',
            icon: '‚è∞',
            desc: '–ï—à—å –≤ –æ–∫–Ω–µ ‚â§ 12 —á–∞—Å–æ–≤',
            xp: 25,
            type: 'eating_window',
            category: CATEGORY.DISCIPLINE,
            target: 1,
            threshold: 12, // hours
            minLevel: 5
        },
        {
            id: 'log_mood',
            name: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
            icon: 'üòä',
            desc: '–ó–∞–ø–∏—à–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ –ø—Ä–∏—ë–º–µ –ø–∏—â–∏',
            xp: 10,
            type: 'log_mood',
            category: CATEGORY.DISCIPLINE,
            target: 1,
            minLevel: 2
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ê–ö–¢–ò–í–ù–û–°–¢–¨ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        {
            id: 'log_training',
            name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è',
            icon: 'üí™',
            desc: '–ó–∞–ø–∏—à–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
            xp: 25,
            type: 'training',
            category: CATEGORY.ACTIVITY,
            target: 1,
            minLevel: 1
        },
        {
            id: 'steps_3k',
            name: '3000 —à–∞–≥–æ–≤',
            icon: 'üö∂',
            desc: '–ü—Ä–æ–π–¥–∏ 3000 —à–∞–≥–æ–≤',
            xp: 15,
            type: 'steps',
            category: CATEGORY.ACTIVITY,
            target: 3000,
            minLevel: 1
        },
        {
            id: 'steps_5k',
            name: '5000 —à–∞–≥–æ–≤',
            icon: 'üëü',
            desc: '–ü—Ä–æ–π–¥–∏ 5000 —à–∞–≥–æ–≤',
            xp: 25,
            type: 'steps',
            category: CATEGORY.ACTIVITY,
            target: 5000,
            minLevel: 3
        },
        {
            id: 'steps_goal',
            name: '–¶–µ–ª—å —à–∞–≥–æ–≤',
            icon: 'üèÜ',
            desc: '–í—ã–ø–æ–ª–Ω–∏ —Å–≤–æ—é —Ü–µ–ª—å —à–∞–≥–æ–≤',
            xp: 30,
            type: 'steps_goal',
            category: CATEGORY.ACTIVITY,
            target: 0, // resolved at selection time from profile.stepsGoal
            minLevel: 5
        },
        {
            id: 'active_day',
            name: '–ê–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å',
            icon: '‚ö°',
            desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ + 3000 —à–∞–≥–æ–≤',
            xp: 35,
            type: 'active_day',
            category: CATEGORY.ACTIVITY,
            target: 1,
            minLevel: 6
        }
    ];

    // ‚îÄ‚îÄ‚îÄ Selection Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    /**
     * Select 3 daily missions from the pool.
     * Guarantees different categories. Filters by level and profile conditions.
     * @param {number} level ‚Äî player gamification level
     * @param {Array<string>} [excludeIds] ‚Äî mission IDs to exclude (for anti-repeat)
     * @returns {Array} ‚Äî 3 mission objects with {completed:false, progress:0}
     */
    function selectDailyMissions(level, excludeIds = []) {
        const profile = getProfile();

        // üìä Calculate behavior metrics for adaptive targets
        const behaviorMetrics = (typeof HEYS !== 'undefined' && HEYS.game?.calculateBehaviorMetrics)
            ? HEYS.game.calculateBehaviorMetrics()
            : null;

        // 1. Get ALL valid candidates for this user/level (ignoring excludes first)
        const validCandidates = DAILY_MISSION_POOL.filter(m => {
            if (level < (m.minLevel || 1)) return false;
            if (m.condition && !m.condition(profile)) return false;
            return true;
        });

        // 2. Filter by exclusion list
        let available = validCandidates.filter(m => !excludeIds.includes(m.id));

        // 3. Fallback: If available < 3, add back some excluded missions to ensure 3
        if (available.length < 3 && validCandidates.length >= 3) {
            const excluded = validCandidates.filter(m => excludeIds.includes(m.id));
            const shuffledExcluded = [...excluded].sort(() => Math.random() - 0.5);
            // Add what's needed to reach 3
            const needed = 3 - available.length;
            available = [...available, ...shuffledExcluded.slice(0, needed)];
        }

        // Shuffle
        const shuffled = [...available].sort(() => Math.random() - 0.5);

        // Pick 3 with different categories
        const usedCategories = new Set();
        const missions = [];

        for (const m of shuffled) {
            if (missions.length >= 3) break;
            if (!usedCategories.has(m.category)) {
                const mission = {
                    ...m,
                    completed: false,
                    progress: 0
                };

                // üéØ Adaptive mission targets based on user behavior
                let adjustedTarget = mission.target;
                if (behaviorMetrics && behaviorMetrics.sampleDays >= 3) {
                    // Meals mission: adjust based on avgMealsPerDay
                    if (m.type === 'meals' && behaviorMetrics.avgMealsPerDay > 0) {
                        const targetMeals = Math.max(2, Math.round(behaviorMetrics.avgMealsPerDay * 0.8));
                        if (targetMeals !== mission.target) {
                            adjustedTarget = targetMeals;
                            mission.desc = `–î–æ–±–∞–≤—å ${targetMeals} –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏`;
                            mission.originalTarget = mission.target;
                        }
                    }
                    // Water mission: adjust based on avgWaterPercent
                    if (m.type === 'water' && behaviorMetrics.avgWaterPercent > 0 && behaviorMetrics.avgWaterPercent < 80) {
                        const targetWater = Math.max(50, Math.min(100, Math.round(behaviorMetrics.avgWaterPercent * 1.2)));
                        if (targetWater !== mission.target) {
                            adjustedTarget = targetWater;
                            mission.desc = `–í—ã–ø–µ–π ${targetWater}% –æ—Ç –Ω–æ—Ä–º—ã –≤–æ–¥—ã`;
                            mission.originalTarget = mission.target;
                        }
                    }
                    // Unique products mission: adjust based on avgUniqueProducts
                    if (m.type === 'products' && behaviorMetrics.avgUniqueProducts > 0) {
                        const targetProducts = Math.max(3, Math.round(behaviorMetrics.avgUniqueProducts * 0.9));
                        if (targetProducts !== mission.target) {
                            adjustedTarget = targetProducts;
                            mission.desc = `–î–æ–±–∞–≤—å ${targetProducts} —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
                            mission.originalTarget = mission.target;
                        }
                    }
                    // Fiber mission: adjust based on avgFiberPercent
                    if (m.type === 'fiber' && behaviorMetrics.avgFiberPercent > 0 && behaviorMetrics.avgFiberPercent < 70) {
                        const targetFiber = Math.max(40, Math.min(100, Math.round(behaviorMetrics.avgFiberPercent * 1.15)));
                        if (targetFiber !== mission.target) {
                            adjustedTarget = targetFiber;
                            mission.desc = `–ù–∞–±–µ—Ä–∏ ${targetFiber}% –∫–ª–µ—Ç—á–∞—Ç–∫–∏`;
                            mission.originalTarget = mission.target;
                        }
                    }
                }
                mission.target = adjustedTarget;

                // Resolve dynamic targets (steps_goal)
                if (m.type === 'steps_goal') {
                    mission.target = profile.stepsGoal || 7000;
                    mission.desc = `–ü—Ä–æ–π–¥–∏ ${mission.target.toLocaleString('ru-RU')} —à–∞–≥–æ–≤`;
                }
                // Remove runtime-only fields
                delete mission.condition;
                delete mission.minLevel;
                missions.push(mission);
                usedCategories.add(m.category);
            }
        }

        // If < 3 categories available, fill from remaining (different ids)
        if (missions.length < 3) {
            for (const m of shuffled) {
                if (missions.length >= 3) break;
                if (missions.find(s => s.id === m.id)) continue;
                const mission = { ...m, completed: false, progress: 0 };

                // Apply same adaptive logic for fallback missions
                let adjustedTarget = mission.target;
                if (behaviorMetrics && behaviorMetrics.sampleDays >= 3) {
                    if (m.type === 'meals' && behaviorMetrics.avgMealsPerDay > 0) {
                        adjustedTarget = Math.max(2, Math.round(behaviorMetrics.avgMealsPerDay * 0.8));
                        mission.desc = `–î–æ–±–∞–≤—å ${adjustedTarget} –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏`;
                        mission.originalTarget = mission.target;
                    }
                    if (m.type === 'water' && behaviorMetrics.avgWaterPercent > 0 && behaviorMetrics.avgWaterPercent < 80) {
                        adjustedTarget = Math.max(50, Math.min(100, Math.round(behaviorMetrics.avgWaterPercent * 1.2)));
                        mission.desc = `–í—ã–ø–µ–π ${adjustedTarget}% –æ—Ç –Ω–æ—Ä–º—ã –≤–æ–¥—ã`;
                        mission.originalTarget = mission.target;
                    }
                    if (m.type === 'products' && behaviorMetrics.avgUniqueProducts > 0) {
                        adjustedTarget = Math.max(3, Math.round(behaviorMetrics.avgUniqueProducts * 0.9));
                        mission.desc = `–î–æ–±–∞–≤—å ${adjustedTarget} —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`;
                        mission.originalTarget = mission.target;
                    }
                    if (m.type === 'fiber' && behaviorMetrics.avgFiberPercent > 0 && behaviorMetrics.avgFiberPercent < 70) {
                        adjustedTarget = Math.max(40, Math.min(100, Math.round(behaviorMetrics.avgFiberPercent * 1.15)));
                        mission.desc = `–ù–∞–±–µ—Ä–∏ ${adjustedTarget}% –∫–ª–µ—Ç—á–∞—Ç–∫–∏`;
                        mission.originalTarget = mission.target;
                    }
                }
                mission.target = adjustedTarget;

                if (m.type === 'steps_goal') {
                    mission.target = profile.stepsGoal || 7000;
                    mission.desc = `–ü—Ä–æ–π–¥–∏ ${mission.target.toLocaleString('ru-RU')} —à–∞–≥–æ–≤`;
                }
                delete mission.condition;
                delete mission.minLevel;
                missions.push(mission);
            }
        }

        return missions;
    }

    // ‚îÄ‚îÄ‚îÄ Exports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    HEYS.missions = {
        DAILY_MISSION_POOL,
        CATEGORY,
        CATEGORY_META,
        selectDailyMissions,
        getProfile,
        /** Utility: get total pool size for current level/profile */
        getAvailableCount(level) {
            const profile = getProfile();
            return DAILY_MISSION_POOL.filter(m => {
                if (level < (m.minLevel || 1)) return false;
                if (m.condition && !m.condition(profile)) return false;
                return true;
            }).length;
        }
    };

    console.info('[HEYS.missions] ‚úÖ Daily missions module loaded ‚Äî pool:', DAILY_MISSION_POOL.length);

})(typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : this);


/* ===== heys_gamification_v1.js ===== */
// heys_gamification_v1.js ‚Äî Gamification Core: XP, –£—Ä–æ–≤–Ω–∏, –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
// –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ–π –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ HEYS
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const U = HEYS.utils || {};

  // üÜï Heartbeat –¥–ª—è watchdog ‚Äî gamification –∑–∞–≥—Ä—É–∂–µ–Ω
  if (typeof window !== 'undefined') window.__heysLoadingHeartbeat = Date.now();

  const readStoredValue = (key, fallback) => {
    if (HEYS.store?.get) return HEYS.store.get(key, fallback);
    if (U.lsGet) return U.lsGet(key, fallback);
    try {
      const raw = localStorage.getItem(key);
      if (raw == null) return fallback;
      if (raw === 'true') return true;
      if (raw === 'false') return false;
      const first = raw[0];
      if (first === '{' || first === '[') return JSON.parse(raw);
      return raw;
    } catch (e) {
      return fallback;
    }
  };

  const setStoredValue = (key, value) => {
    if (HEYS.store?.set) {
      HEYS.store.set(key, value);
      return;
    }
    if (U.lsSet) {
      U.lsSet(key, value);
      return;
    }
    try {
      if (value && typeof value === 'object') {
        localStorage.setItem(key, JSON.stringify(value));
      } else {
        localStorage.setItem(key, String(value));
      }
    } catch (e) { }
  };

  // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========

  /**
   * –ü–æ—Ä–æ–≥–∏ —É—Ä–æ–≤–Ω–µ–π (XP –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è)
   * –£—Ä–æ–≤–µ–Ω—å 1 = 0 XP, –£—Ä–æ–≤–µ–Ω—å 2 = 100 XP, –∏ —Ç.–¥.
   */
  const LEVEL_THRESHOLDS = [
    0,      // –£—Ä–æ–≤–µ–Ω—å 1
    100,    // –£—Ä–æ–≤–µ–Ω—å 2
    300,    // –£—Ä–æ–≤–µ–Ω—å 3
    600,    // –£—Ä–æ–≤–µ–Ω—å 4
    1000,   // –£—Ä–æ–≤–µ–Ω—å 5
    1500,   // –£—Ä–æ–≤–µ–Ω—å 6
    2200,   // –£—Ä–æ–≤–µ–Ω—å 7
    3000,   // –£—Ä–æ–≤–µ–Ω—å 8
    4000,   // –£—Ä–æ–≤–µ–Ω—å 9
    5200,   // –£—Ä–æ–≤–µ–Ω—å 10
    6500,   // –£—Ä–æ–≤–µ–Ω—å 11
    8000,   // –£—Ä–æ–≤–µ–Ω—å 12
    10000,  // –£—Ä–æ–≤–µ–Ω—å 13
    12500,  // –£—Ä–æ–≤–µ–Ω—å 14
    15500,  // –£—Ä–æ–≤–µ–Ω—å 15
    19000,  // –£—Ä–æ–≤–µ–Ω—å 16
    23000,  // –£—Ä–æ–≤–µ–Ω—å 17
    27500,  // –£—Ä–æ–≤–µ–Ω—å 18
    32500,  // –£—Ä–æ–≤–µ–Ω—å 19
    38000,  // –£—Ä–æ–≤–µ–Ω—å 20
    44000,  // –£—Ä–æ–≤–µ–Ω—å 21
    51000,  // –£—Ä–æ–≤–µ–Ω—å 22
    59000,  // –£—Ä–æ–≤–µ–Ω—å 23
    68000,  // –£—Ä–æ–≤–µ–Ω—å 24
    78000   // –£—Ä–æ–≤–µ–Ω—å 25
  ];

  /**
   * –¢–∏—Ç—É–ª—ã —É—Ä–æ–≤–Ω–µ–π —Å –∏–∫–æ–Ω–∫–∞–º–∏ –∏ —Ü–≤–µ—Ç–∞–º–∏
   */
  const LEVEL_TITLES = [
    { min: 1, max: 4, title: '–ù–æ–≤–∏—á–æ–∫', icon: 'üå±', color: '#94a3b8' },
    { min: 5, max: 9, title: '–£—á–µ–Ω–∏–∫', icon: 'üìö', color: '#3b82f6' },
    { min: 10, max: 14, title: '–ü—Ä–∞–∫—Ç–∏–∫', icon: 'üí™', color: '#22c55e' },
    { min: 15, max: 19, title: '–≠–∫—Å–ø–µ—Ä—Ç', icon: '‚≠ê', color: '#eab308' },
    { min: 20, max: 25, title: '–ú–∞—Å—Ç–µ—Ä', icon: 'üëë', color: '#a855f7' }
  ];

  /**
   * XP –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è
   */
  const XP_ACTIONS = {
    checkin_complete: { xp: 10, maxPerDay: 1, label: '–£—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω' },
    meal_added: { xp: 3, maxPerDay: 4, label: '–ü—Ä–∏—ë–º –ø–∏—â–∏' },
    product_added: { xp: 3, maxPerDay: 10, label: '–ü—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω' },
    steps_updated: { xp: 3, maxPerDay: 1, label: '–®–∞–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã' },
    supplements_taken: { xp: 5, maxPerDay: 1, label: '–í–∏—Ç–∞–º–∏–Ω—ã –ø—Ä–∏–Ω—è—Ç—ã' },
    household_added: { xp: 5, maxPerDay: 2, label: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
    water_added: { xp: 2, maxPerDay: 5, label: '–í–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' },
    training_added: { xp: 15, maxPerDay: 2, label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' },
    sleep_logged: { xp: 5, maxPerDay: 1, label: '–°–æ–Ω –∑–∞–ø–æ–ª–Ω–µ–Ω' },
    weight_logged: { xp: 5, maxPerDay: 1, label: '–í–µ—Å –∑–∞–ø–∏—Å–∞–Ω' },
    day_completed: { xp: 50, maxPerDay: 1, label: '–î–µ–Ω—å –≤—ã–ø–æ–ª–Ω–µ–Ω' },
    perfect_day: { xp: 25, maxPerDay: 1, label: '–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å' },
    advice_read: { xp: 2, maxPerDay: 10, label: '–°–æ–≤–µ—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω' }
  };

  /**
   * –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (32 —à—Ç—É–∫–∏ –≤ 7 –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö)
   */
  const ACHIEVEMENTS = {
    // üî• Streak (5)
    streak_1: { id: 'streak_1', name: '–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å', desc: 'Streak ‚â• 1 –¥–µ–Ω—å', story: '–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å ‚Äî –Ω–∞—á–∞–ª–æ —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ —Ä–∏—Ç–º–∞.', xp: 100, icon: 'üî•', category: 'streak', rarity: 'common' },
    streak_2: { id: 'streak_2', name: '–î–≤–∞ –¥–Ω—è –ø–æ–¥—Ä—è–¥', desc: 'Streak ‚â• 2 –¥–Ω—è', story: '–î–≤–∞ –¥–Ω—è –ø–æ–¥—Ä—è–¥ ‚Äî —É–∂–µ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å.', xp: 200, icon: 'üî•', category: 'streak', rarity: 'rare' },
    streak_3: { id: 'streak_3', name: '–¢—Ä–∏ –¥–Ω—è –ø–æ–¥—Ä—è–¥', desc: 'Streak ‚â• 3 –¥–Ω—è', story: '–¢—Ä–∏ –¥–Ω—è –ø–æ–¥—Ä—è–¥ ‚Äî –∏–º–ø—É–ª—å—Å –∑–∞–∫—Ä–µ–ø–∏–ª—Å—è.', xp: 350, icon: 'üèÜ', category: 'streak', rarity: 'epic' },
    streak_5: { id: 'streak_5', name: '–ü—è—Ç—å –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', desc: 'Streak ‚â• 5 –¥–Ω–µ–π', story: '–ü—è—Ç—å –¥–Ω–µ–π ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —É–∂–µ –≤–∏–¥–Ω–∞.', xp: 700, icon: 'üëë', category: 'streak', rarity: 'legendary' },
    streak_7: { id: 'streak_7', name: '–°–µ–º—å –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', desc: 'Streak ‚â• 7 –¥–Ω–µ–π', story: '–°–µ–º—å –¥–Ω–µ–π ‚Äî —ç—Ç–æ —Å—É–ø–µ—Ä—Ä–µ–¥–∫–æ –∏ –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ.', xp: 1200, icon: 'üíé', category: 'streak', rarity: 'mythic' },

    // üéØ –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ (10)
    first_checkin: { id: 'first_checkin', name: '–ü–µ—Ä–≤—ã–π —á–µ–∫-–∏–Ω', desc: '–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–∏–Ω', story: '–ü–µ—Ä–≤—ã–π —á–µ–∫-–∏–Ω ‚Äî —É—Ç—Ä–æ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º.', xp: 40, icon: '‚òÄÔ∏è', category: 'onboarding', rarity: 'common' },
    first_meal: { id: 'first_meal', name: '–ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º', desc: '–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏', story: '–ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º ‚Äî —Å—Ç–∞—Ä—Ç –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏.', xp: 50, icon: 'üçΩÔ∏è', category: 'onboarding', rarity: 'common' },
    first_product: { id: 'first_product', name: '–ü–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç', desc: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –≤ –ø—Ä–∏—ë–º', story: '–ü–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç ‚Äî —Ç—ã –Ω–∞—á–∞–ª –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫.', xp: 40, icon: 'ü•ó', category: 'onboarding', rarity: 'common' },
    first_steps: { id: 'first_steps', name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', desc: '–£–∫–∞–∑–∞—Ç—å —à–∞–≥–∏ —Ö–æ—Ç—è –±—ã —Ä–∞–∑', story: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–∂–µ –≤ —Ñ–æ–∫—É—Å–µ.', xp: 20, icon: 'üëü', category: 'onboarding', rarity: 'common' },
    first_water: { id: 'first_water', name: '–í–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç', desc: '–ü–µ—Ä–≤—ã–π —Ä–∞–∑ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—É', story: '–ü–µ—Ä–≤—ã–π —Å—Ç–∞–∫–∞–Ω ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ –±–æ–ª—å—à–æ–π —ç–Ω–µ—Ä–≥–∏–∏.', xp: 20, icon: 'üíß', category: 'onboarding', rarity: 'common' },
    first_advice: { id: 'first_advice', name: '–ü–µ—Ä–≤—ã–π —Å–æ–≤–µ—Ç', desc: '–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–≤–µ—Ç', story: '–ü–µ—Ä–≤—ã–π —Å–æ–≤–µ—Ç ‚Äî –±–µ—Ä–µ–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç.', xp: 15, icon: 'üí°', category: 'onboarding', rarity: 'common' },
    first_supplements: { id: 'first_supplements', name: '–ü–µ—Ä–≤—ã–µ –≤–∏—Ç–∞–º–∏–Ω—ã', desc: '–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏—ë–º –¥–æ–±–∞–≤–æ–∫', story: '–í–∏—Ç–∞–º–∏–Ω—ã –æ—Ç–º–µ—á–µ–Ω—ã ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –Ω–∞—á–∞–ª–∞—Å—å.', xp: 20, icon: 'üíä', category: 'onboarding', rarity: 'common' },
    first_training: { id: 'first_training', name: '–ê–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ä—Ç', desc: '–ü–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', story: '–ü–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —Ç–µ–ª–æ —É—Å–ª—ã—à–∞–ª–æ —Ç–≤–æ–π —Å–∏–≥–Ω–∞–ª.', xp: 30, icon: 'üèÉ', category: 'onboarding', rarity: 'common' },
    first_household: { id: 'first_household', name: '–ü–µ—Ä–≤—ã–π –±—ã—Ç', desc: '–ü–µ—Ä–≤–∞—è –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', story: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äî –∫–ª–∞—Å—Å–Ω—ã–π —Å—Ç–∞—Ä—Ç.', xp: 20, icon: 'üè†', category: 'onboarding', rarity: 'common' },

    // üíé –ö–∞—á–µ—Å—Ç–≤–æ –¥–Ω—è (4)
    perfect_day: { id: 'perfect_day', name: '–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å', desc: '–ö–∞–ª–æ—Ä–∏–∏ 95-105% –æ—Ç –Ω–æ—Ä–º—ã', story: '–ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å ‚Äî –∫–æ–≥–¥–∞ –ø–ª–∞–Ω –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–≤–ø–∞–ª–∏.', xp: 25, icon: 'üíé', category: 'quality', rarity: 'rare' },
    perfect_week: { id: 'perfect_week', name: '–ò–¥–µ–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è', desc: '7 –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π', story: '–°–µ–º—å –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π ‚Äî —Ä–µ–¥–∫–æ–µ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ.', xp: 200, icon: 'üåü', category: 'quality', rarity: 'epic' },
    balanced_macros: { id: 'balanced_macros', name: '–ë–∞–ª–∞–Ω—Å –ë–ñ–£', desc: '–í—Å–µ –º–∞–∫—Ä–æ—Å—ã 90-110%', story: '–ë–ñ–£ –≤ –±–∞–ª–∞–Ω—Å–µ ‚Äî –ø–∏—Ç–∞–Ω–∏–µ —Å—Ç–∞–ª–æ —É–º–Ω—ã–º.', xp: 30, icon: '‚öñÔ∏è', category: 'quality', rarity: 'rare' },
    fiber_champion: { id: 'fiber_champion', name: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞-—á–µ–º–ø–∏–æ–Ω', desc: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚â•100% 7 –¥–Ω–µ–π', story: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≤ –Ω–æ—Ä–º–µ ‚Äî –º–∏–∫—Ä–æ–±–∏–æ–º —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ.', xp: 100, icon: 'ü•ó', category: 'quality', rarity: 'rare' },

    // üíß –í–æ–¥–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (4)
    water_day: { id: 'water_day', name: '–í–æ–¥–Ω—ã–π –¥–µ–Ω—å', desc: '100% –Ω–æ—Ä–º—ã –≤–æ–¥—ã', story: '–ù–æ—Ä–º–∞ –≤–æ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –º–µ—Ç–∞–±–æ–ª–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ.', xp: 15, icon: 'üíß', category: 'activity', rarity: 'common' },
    water_master: { id: 'water_master', name: '–í–æ–¥–Ω—ã–π –º–∞—Å—Ç–µ—Ä', desc: '100% –≤–æ–¥—ã 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', story: '–°–µ–º—å –¥–Ω–µ–π –≤–æ–¥—ã ‚Äî –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è —Å—Ç–∞–ª–∞ –ø—Ä–∏–≤—ã—á–∫–æ–π.', xp: 100, icon: 'üåä', category: 'activity', rarity: 'rare' },
    training_week: { id: 'training_week', name: '–°–ø–æ—Ä—Ç—Å–º–µ–Ω', desc: '5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é', story: '–ü—è—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî —Ç—ã –¥–µ—Ä–∂–∏—à—å —Ç–µ–º–ø.', xp: 150, icon: 'üí™', category: 'activity', rarity: 'epic' },
    steps_champion: { id: 'steps_champion', name: '–®–∞–≥–æ–≤–æ–π –º–∞—Ä–∞—Ñ–æ–Ω', desc: '10000+ —à–∞–≥–æ–≤ 7 –¥–Ω–µ–π', story: '10k —à–∞–≥–æ–≤ 7 –¥–Ω–µ–π ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ —Å—Ç–∞–ª–æ —Å—Ç–∏–ª–µ–º –∂–∏–∑–Ω–∏.', xp: 150, icon: 'üëü', category: 'activity', rarity: 'epic' },

    // ‚≠ê –£—Ä–æ–≤–Ω–∏ (5)
    level_5: { id: 'level_5', name: '–£—á–µ–Ω–∏–∫', desc: '–î–æ—Å—Ç–∏—á—å 5 —É—Ä–æ–≤–Ω—è', story: '–¢—ã –ø–µ—Ä–µ—à—ë–ª –≤ —É—á–µ–Ω–∏–∫–∏ ‚Äî –±–∞–∑–∞ –∑–∞–ª–æ–∂–µ–Ω–∞.', xp: 50, icon: 'üìö', category: 'levels', rarity: 'common' },
    level_10: { id: 'level_10', name: '–ü—Ä–∞–∫—Ç–∏–∫', desc: '–î–æ—Å—Ç–∏—á—å 10 —É—Ä–æ–≤–Ω—è', story: '–ü—Ä–∞–∫—Ç–∏–∫: –∑–Ω–∞–Ω–∏—è –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –¥–µ–π—Å—Ç–≤–∏—è.', xp: 100, icon: 'üí™', category: 'levels', rarity: 'rare' },
    level_15: { id: 'level_15', name: '–≠–∫—Å–ø–µ—Ä—Ç', desc: '–î–æ—Å—Ç–∏—á—å 15 —É—Ä–æ–≤–Ω—è', story: '–≠–∫—Å–ø–µ—Ä—Ç: —Ç—ã –≤–∏–¥–∏—à—å —Å–∏—Å—Ç–µ–º—É —Ü–µ–ª–∏–∫–æ–º.', xp: 150, icon: '‚≠ê', category: 'levels', rarity: 'epic' },
    level_20: { id: 'level_20', name: '–ú–∞—Å—Ç–µ—Ä', desc: '–î–æ—Å—Ç–∏—á—å 20 —É—Ä–æ–≤–Ω—è', story: '–ú–∞—Å—Ç–µ—Ä: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å.', xp: 200, icon: 'üëë', category: 'levels', rarity: 'legendary' },
    level_25: { id: 'level_25', name: '–ì—É—Ä—É', desc: '–î–æ—Å—Ç–∏—á—å 25 —É—Ä–æ–≤–Ω—è', story: '–ì—É—Ä—É: –ø—É—Ç—å –ø—Ä–æ–π–¥–µ–Ω, —Ç—ã –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—à—å.', xp: 300, icon: 'üèÜ', category: 'levels', rarity: 'mythic' },

    // üåÖ –ü—Ä–∏–≤—ã—á–∫–∏ (2)
    early_bird: { id: 'early_bird', name: '–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞', desc: '–ó–∞–≤—Ç—Ä–∞–∫ –¥–æ 9:00 7 –¥–Ω–µ–π', story: '–ó–∞–≤—Ç—Ä–∞–∫ –¥–æ 9:00 ‚Äî —Ç—ã –∑–∞–¥–∞—ë—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–Ω –¥–Ω—é.', xp: 100, icon: 'üåÖ', category: 'habits', rarity: 'rare' },
    night_owl_safe: { id: 'night_owl_safe', name: '–ë–µ–∑ –Ω–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤', desc: '–ù–µ—Ç –µ–¥—ã –ø–æ—Å–ª–µ 22:00 7 –¥–Ω–µ–π', story: '–ë–µ–∑ –µ–¥—ã –ø–æ—Å–ª–µ 22:00 ‚Äî —Å–æ–Ω –∏ –≥–æ—Ä–º–æ–Ω—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã.', xp: 100, icon: 'üåô', category: 'habits', rarity: 'rare' },

    // üí° –°–æ–≤–µ—Ç—ã (2)
    advice_reader: { id: 'advice_reader', name: '–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π', desc: '–ü—Ä–æ—á–∏—Ç–∞—Ç—å 50 —Å–æ–≤–µ—Ç–æ–≤', story: '50 —Å–æ–≤–µ—Ç–æ–≤ ‚Äî —Ç—ã —Å–ª—É—à–∞–µ—à—å –∏ –ø—Ä–∏–º–µ–Ω—è–µ—à—å.', xp: 50, icon: 'üí°', category: 'habits', rarity: 'common' },
    advice_master: { id: 'advice_master', name: '–ú—É–¥—Ä–µ—Ü', desc: '–ü—Ä–æ—á–∏—Ç–∞—Ç—å 200 —Å–æ–≤–µ—Ç–æ–≤', story: '200 —Å–æ–≤–µ—Ç–æ–≤ ‚Äî –º—É–¥—Ä–æ—Å—Ç—å –≤ –¥–µ–π—Å—Ç–≤–∏–∏.', xp: 150, icon: 'üß†', category: 'habits', rarity: 'rare' },

    // üß† –ú–µ—Ç–∞–±–æ–ª–∏–∑–º (5) ‚Äî –ù–û–í–´–ï –¥–ª—è Metabolic Intelligence
    metabolic_stable: { id: 'metabolic_stable', name: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º', desc: '–û—Ü–µ–Ω–∫–∞ ‚â•70 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', story: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º ‚Äî —Ç–≤–æ–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç.', xp: 100, icon: 'üß†', category: 'metabolic', rarity: 'rare' },
    crash_avoided: { id: 'crash_avoided', name: '–°—Ä—ã–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â—ë–Ω', desc: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∏—Å–∫–µ ‚Üí —É—Å–ø–µ—à–Ω—ã–π –¥–µ–Ω—å', story: '–†–∏—Å–∫ –±—ã–ª –≤—ã—Å–æ–∫, –Ω–æ —Ç—ã —É–¥–µ—Ä–∂–∞–ª –¥–µ–Ω—å.', xp: 50, icon: 'üõ°Ô∏è', category: 'metabolic', rarity: 'rare' },
    low_risk_master: { id: 'low_risk_master', name: '–ú–∞—Å—Ç–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—è', desc: '–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞ 14 –¥–Ω–µ–π', story: '14 –¥–Ω–µ–π –Ω–∏–∑–∫–æ–≥–æ —Ä–∏—Å–∫–∞ ‚Äî –∑—Ä–µ–ª–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.', xp: 200, icon: 'üéØ', category: 'metabolic', rarity: 'epic' },
    phenotype_discovered: { id: 'phenotype_discovered', name: '–§–µ–Ω–æ—Ç–∏–ø —Ä–∞—Å–∫—Ä—ã—Ç', desc: '–û–ø—Ä–µ–¥–µ–ª—ë–Ω –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–æ—Ç–∏–ø', story: '–§–µ–Ω–æ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ‚Äî —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å —Å–µ–±—è.', xp: 100, icon: 'üß¨', category: 'metabolic', rarity: 'epic' },
    weekly_wrap_viewed: { id: 'weekly_wrap_viewed', name: '–ê–Ω–∞–ª–∏—Ç–∏–∫', desc: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å 4 –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –æ—Ç—á—ë—Ç–∞', story: '–ß–µ—Ç—ã—Ä–µ –æ—Ç—á—ë—Ç–∞ ‚Äî —Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –∏ —Ä–∞—Å—Ç—ë—à—å.', xp: 75, icon: 'üìä', category: 'metabolic', rarity: 'rare' }
  };

  const ACHIEVEMENT_CATEGORIES = [
    { id: 'streak', name: 'üî• Streak', achievements: ['streak_1', 'streak_2', 'streak_3', 'streak_5', 'streak_7'] },
    { id: 'onboarding', name: 'üéØ –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', achievements: ['first_checkin', 'first_meal', 'first_product', 'first_steps', 'first_advice', 'first_supplements', 'first_water', 'first_training', 'first_household'] },
    { id: 'advice', name: 'üí° –°–æ–≤–µ—Ç—ã', achievements: ['advice_reader', 'advice_master'] },
    { id: 'quality', name: 'üíé –ö–∞—á–µ—Å—Ç–≤–æ –¥–Ω—è', achievements: ['perfect_day', 'perfect_week', 'balanced_macros', 'fiber_champion'] },
    { id: 'activity', name: 'üíß –í–æ–¥–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', achievements: ['water_day', 'water_master', 'training_week', 'steps_champion'] },
    { id: 'levels', name: '‚≠ê –£—Ä–æ–≤–Ω–∏', achievements: ['level_5', 'level_10', 'level_15', 'level_20', 'level_25'] },
    { id: 'habits', name: 'üåÖ –ü—Ä–∏–≤—ã—á–∫–∏', achievements: ['early_bird', 'night_owl_safe'] },
    { id: 'metabolic', name: 'üß† –ú–µ—Ç–∞–±–æ–ª–∏–∑–º', achievements: ['metabolic_stable', 'crash_avoided', 'low_risk_master', 'phenotype_discovered', 'weekly_wrap_viewed'] }
  ];

  const RARITY_COLORS = {
    common: '#94a3b8',
    rare: '#3b82f6',
    epic: '#a855f7',
    legendary: '#eab308',
    mythic: '#ef4444'
  };

  // ========== –í–ù–£–¢–†–ï–ù–ù–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï ==========

  let _data = null;
  let _debounceTimer = null;
  let _notificationQueue = [];
  let _isShowingNotification = false;
  let _cloudLoaded = false; // üõ°Ô∏è –§–ª–∞–≥ —á—Ç–æ –æ–±–ª–∞–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
  let _pendingCloudSync = false; // üîÑ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π sync –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–∞–∫–∞
  let _auditRebuildDone = false; // üßæ –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç –∏–∑ –∞—É–¥–∏—Ç-–ª–æ–≥–∞ –∑–∞ —Å–µ—Å—Å–∏—é
  let _syncInProgress = false; // üîí Mutex –¥–ª—è syncToCloud ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏
  let _isRebuilding = false; // üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞—á–∏–≤–æ–∫ –≤–æ –≤—Ä–µ–º–µ rebuild (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏ —Å—Ç—Ä–∏–∫–æ–≤)
  let _unlockingAchievements = new Set(); // üîí Mutex –¥–ª—è unlockAchievement ‚Äî Set ID –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  let _lastAddXPKey = ''; // üõ°Ô∏è Dedup guard –¥–ª—è _addXPInternal
  let _lastAddXPTime = 0; // üõ°Ô∏è Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ addXP
  let _suppressUIUpdates = false; // üîí v3.1: –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ UI-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è rebuild chain
  let _isLoadingPhase = false; // üîí v4.0: –ü–æ–¥–∞–≤–ª—è–µ—Ç –í–°–ï UI-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏/–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
  let _loadFromCloudPromise = null; // üîí v4.0: Dedup –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ loadFromCloud()
  let _dailyBonusAuditCache = { date: null, checkedAt: 0, claimed: false };
  const DEDUP_WINDOW_MS = 200; // üõ°Ô∏è –û–∫–Ω–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–º—Å)
  const DEBOUNCE_MS = 100;
  const STORAGE_KEY = 'heys_game';
  const DATA_VERSION = 2; // –í–µ—Ä—Å–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
  const MAX_DAILY_XP_DAYS = 30; // –•—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é XP –º–∞–∫—Å–∏–º—É–º 30 –¥–Ω–µ–π
  const DAILY_BONUS_AUDIT_CACHE_MS = 60000;
  let _cloudWatchBound = false;

  // ========== –•–ï–õ–ü–ï–†–´ ==========

  function safeGetStreak() {
    if (typeof U.safeGetStreak === 'function') {
      return U.safeGetStreak();
    }
    try {
      return typeof HEYS.Day?.getStreak === 'function' ? HEYS.Day.getStreak() : 0;
    } catch {
      return 0;
    }
  }

  // üõ°Ô∏è Safe wrapper for HEYS.Day metric getters
  function safeGetDayMetric(getter, fallback = 0) {
    try {
      return getter?.() ?? fallback;
    } catch (e) {
      console.warn('[HEYS.missions] Metric getter failed:', e);
      return fallback;
    }
  }

  // üìä Calculate behavior metrics from last 14 days (for adaptive missions)
  let _behaviorMetricsCache = null;
  let _behaviorMetricsCacheTime = 0;
  function calculateBehaviorMetrics() {
    const now = Date.now();
    // Cache for 1 hour
    if (_behaviorMetricsCache && (now - _behaviorMetricsCacheTime) < 3600000) {
      return _behaviorMetricsCache;
    }

    const metrics = {
      avgMealsPerDay: 0,
      avgWaterPercent: 0,
      avgUniqueProducts: 0,
      avgFiberPercent: 0,
      sampleDays: 0
    };

    try {
      const fmtDate = U.fmtDate || ((d) => d.toISOString().split('T')[0]);
      const lsGet = U.lsGet || ((k) => {
        try {
          return JSON.parse(localStorage.getItem(k));
        } catch { return null; }
      });

      const today = new Date();
      let totalMeals = 0, totalWater = 0, totalProducts = 0, totalFiber = 0, validDays = 0;

      for (let i = 1; i <= 14; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const dateStr = fmtDate(d);
        const dayData = lsGet(`heys_dayv2_${dateStr}`);

        if (dayData?.meals?.length > 0) {
          validDays++;
          totalMeals += dayData.meals.length;

          // Water percentage
          if (dayData.water?.current && dayData.water?.target) {
            totalWater += Math.min(100, (dayData.water.current / dayData.water.target) * 100);
          }

          // Unique products
          const uniqueProductIds = new Set();
          dayData.meals.forEach(m => {
            (m.items || []).forEach(it => uniqueProductIds.add(it.productId));
          });
          totalProducts += uniqueProductIds.size;

          // Fiber percentage (if dayTot exists)
          if (dayData.dayTot?.fiber && dayData.normAbs?.fiber) {
            totalFiber += Math.min(100, (dayData.dayTot.fiber / dayData.normAbs.fiber) * 100);
          }
        }
      }

      if (validDays > 0) {
        metrics.avgMealsPerDay = Math.round(totalMeals / validDays);
        metrics.avgWaterPercent = Math.round(totalWater / validDays);
        metrics.avgUniqueProducts = Math.round(totalProducts / validDays);
        metrics.avgFiberPercent = Math.round(totalFiber / validDays);
        metrics.sampleDays = validDays;
      }

      _behaviorMetricsCache = metrics;
      _behaviorMetricsCacheTime = now;
      return metrics;
    } catch (e) {
      console.warn('[HEYS.missions] calculateBehaviorMetrics failed:', e);
      return metrics;
    }
  }

  // üéµ Mission completion sound (short double ping)
  function playMissionSound(isAllComplete = false) {
    loadSoundSettings();
    if (!SOUND_SETTINGS.enabled) return;

    try {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      const volume = SOUND_SETTINGS.volume;
      const notes = isAllComplete
        ? [
          { freq: 659.25, time: 0 },
          { freq: 783.99, time: 0.08 },
          { freq: 987.77, time: 0.16 }
        ]
        : [
          { freq: 587.33, time: 0 },
          { freq: 698.46, time: 0.1 }
        ];

      notes.forEach(({ freq, time }) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(volume * 0.7, audioContext.currentTime + time);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.18);
        osc.start(audioContext.currentTime + time);
        osc.stop(audioContext.currentTime + time + 0.18);
      });
    } catch (e) {
      // Ignore audio errors
    }
  }

  function getToday() {
    return new Date().toISOString().slice(0, 10);
  }

  // ========== GAMESYNH TRACE LOGGING ==========
  const GAME_SYNC_LOG_PREFIX = '[GAMESYNH]';
  let _gameSyncTraceSeq = 0;

  function _gameSyncNow() {
    return (typeof performance !== 'undefined' && typeof performance.now === 'function')
      ? performance.now()
      : Date.now();
  }

  function startGameSyncTrace(stage, meta = {}) {
    const traceId = `gs-${Date.now().toString(36)}-${(++_gameSyncTraceSeq).toString(36)}`;
    const trace = { traceId, stage, startedAt: _gameSyncNow() };
    console.info(GAME_SYNC_LOG_PREFIX, '‚ñ∂ start', stage, {
      traceId,
      at: new Date().toISOString(),
      ...meta
    });
    return trace;
  }

  function gameSyncTraceStep(trace, step, meta = {}) {
    const elapsedMs = Math.round(_gameSyncNow() - (trace?.startedAt || _gameSyncNow()));
    console.info(GAME_SYNC_LOG_PREFIX, '‚Ä¢ step', step, {
      traceId: trace?.traceId || 'n/a',
      stage: trace?.stage || 'n/a',
      elapsedMs,
      ...meta
    });
  }

  function endGameSyncTrace(trace, status = 'ok', meta = {}) {
    const elapsedMs = Math.round(_gameSyncNow() - (trace?.startedAt || _gameSyncNow()));
    console.info(GAME_SYNC_LOG_PREFIX, '‚ñ† end', trace?.stage || 'unknown', {
      traceId: trace?.traceId || 'n/a',
      status,
      elapsedMs,
      ...meta
    });
  }

  function loadData() {
    if (_data) return _data;

    let stored = readStoredValue(STORAGE_KEY, null);

    // üõ°Ô∏è FIX v2.0: Fallback –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –∫–ª—é—á–∞ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Å—Ç–æ–π
    // FIX v2.4: typeof check ‚Äî totalXP=0 is valid (fresh data), don't treat as missing
    if (!stored || typeof stored.totalXP !== 'number') {
      let bestXP = stored?.totalXP || 0;
      let bestData = stored;

      try {
        const currentClientId = HEYS.utils?.getCurrentClientId?.() ||
          localStorage.getItem('heys_client_current') ||
          localStorage.getItem('heys_pin_auth_client');
        const normalizedClientId = currentClientId ? String(currentClientId).replace(/"/g, '') : null;
        const clientPrefix = normalizedClientId ? `heys_${normalizedClientId}_` : null;

        // 1. –ü—Ä—è–º–æ–π –∫–ª—é—á heys_game (legacy –±–µ–∑ clientId)
        // ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ clientId –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω (–∏–Ω–∞—á–µ –º–æ–∂–µ–º –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —á—É–∂–æ–π XP)
        if (!normalizedClientId) {
          const legacyRaw = localStorage.getItem('heys_game');
          if (legacyRaw) {
            const legacy = JSON.parse(legacyRaw);
            if (legacy?.totalXP > bestXP) {
              bestXP = legacy.totalXP;
              bestData = legacy;
              console.log('[üéÆ Gamification] Found legacy heys_game with XP:', bestXP);
            }
          }
        }

        // 2. –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–∞–º *_game (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (!k) continue;
          if (normalizedClientId) {
            if (!k.startsWith(clientPrefix)) continue;
            if (!k.endsWith('_game') && !k.endsWith('_gamification')) continue;
          } else {
            if (!k.endsWith('_game')) continue;
            if (k.includes('_gamification')) continue;
          }
          if (k.includes('sound')) continue;
          try {
            const raw = localStorage.getItem(k);
            if (raw) {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∂–∞—Ç–∏–µ
              const parsed = raw.startsWith('¬§Z¬§')
                ? (HEYS.store?.decompress ? HEYS.store.decompress(raw) : JSON.parse(raw.substring(3)))
                : JSON.parse(raw);
              if (parsed?.totalXP > bestXP) {
                bestXP = parsed.totalXP;
                bestData = parsed;
                console.log(`[üéÆ Gamification] Found better data in ${k}: XP=${bestXP}, level=${parsed.level}`);
              }
            }
          } catch (e) { }
        }
      } catch (e) {
        console.warn('[üéÆ Gamification] Fallback search error:', e);
      }

      if (bestData && bestData !== stored) {
        stored = bestData;
        console.log('[üéÆ Gamification] Using best found data: XP=', bestXP, 'level=', calculateLevel(bestXP));
      }
    }

    if (stored) {
      _data = validateAndMigrate(stored);
    } else {
      _data = createDefaultData();
    }
    return _data;
  }

  /**
   * –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
   * –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –≤—Å–µ –ø–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
   */
  function validateAndMigrate(data) {
    const defaults = createDefaultData();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    if (!data || typeof data !== 'object') {
      console.warn('[HEYS.game] Invalid data structure, resetting');
      return defaults;
    }

    // –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
    const migrated = {
      ...defaults,
      ...data,
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã
      totalXP: typeof data.totalXP === 'number' ? data.totalXP : 0,
      level: typeof data.level === 'number' ? data.level : 1,
      unlockedAchievements: Array.isArray(data.unlockedAchievements) ? data.unlockedAchievements : [],
      dailyXP: (data.dailyXP && typeof data.dailyXP === 'object') ? data.dailyXP : {},
      stats: { ...defaults.stats, ...(data.stats || {}) },
      dailyActions: data.dailyActions || defaults.dailyActions,
      weeklyChallenge: data.weeklyChallenge || defaults.weeklyChallenge,
      // v2: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
      achievementProgress: data.achievementProgress || {},
      // –í–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö
      version: DATA_VERSION
    };

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞ —Å–ª—É—á–∞–π –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è
    migrated.level = calculateLevel(migrated.totalXP);

    // Cleanup —Å—Ç–∞—Ä—ã—Ö dailyXP (>30 –¥–Ω–µ–π)
    migrated.dailyXP = cleanupOldDailyXP(migrated.dailyXP);

    // –õ–æ–≥–∏—Ä—É–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    if (data.version !== DATA_VERSION) {
      console.log(`[HEYS.game] Data migrated from v${data.version || 1} to v${DATA_VERSION}`);
    }

    migrateStreakAchievements(migrated);
    return migrated;
  }

  function mergeUniqueArray(a, b) {
    const arrA = Array.isArray(a) ? a : [];
    const arrB = Array.isArray(b) ? b : [];
    return Array.from(new Set([...arrA, ...arrB]));
  }

  function mergeDateStrings(a, b) {
    if (!a && !b) return null;
    if (!a) return b;
    if (!b) return a;
    return a >= b ? a : b;
  }

  function mergeStats(localStats, cloudStats) {
    const base = {
      totalProducts: 0,
      totalWater: 0,
      totalTrainings: 0,
      totalAdvicesRead: 0,
      perfectDays: 0,
      bestStreak: 0
    };
    const local = { ...base, ...(localStats || {}) };
    const cloud = { ...base, ...(cloudStats || {}) };
    return {
      totalProducts: Math.max(local.totalProducts || 0, cloud.totalProducts || 0),
      totalWater: Math.max(local.totalWater || 0, cloud.totalWater || 0),
      totalTrainings: Math.max(local.totalTrainings || 0, cloud.totalTrainings || 0),
      totalAdvicesRead: Math.max(local.totalAdvicesRead || 0, cloud.totalAdvicesRead || 0),
      perfectDays: Math.max(local.perfectDays || 0, cloud.perfectDays || 0),
      bestStreak: Math.max(local.bestStreak || 0, cloud.bestStreak || 0)
    };
  }

  function mergeAchievementProgress(localProgress, cloudProgress) {
    const merged = { ...(localProgress || {}) };
    const cloud = cloudProgress || {};

    Object.keys(cloud).forEach((achId) => {
      const localEntry = merged[achId] || {};
      const cloudEntry = cloud[achId] || {};

      const mergedDates = mergeUniqueArray(localEntry.dates, cloudEntry.dates);
      const mergedEntry = {
        ...localEntry,
        ...cloudEntry,
        current: Math.max(localEntry.current || 0, cloudEntry.current || 0),
        target: Math.max(localEntry.target || 0, cloudEntry.target || 0),
        updatedAt: Math.max(localEntry.updatedAt || 0, cloudEntry.updatedAt || 0)
      };
      if (mergedDates.length > 0) {
        mergedEntry.dates = mergedDates;
      }
      merged[achId] = mergedEntry;
    });

    return merged;
  }

  function mergeDailyXP(localXP, cloudXP) {
    const merged = { ...(localXP || {}) };
    const cloud = cloudXP || {};

    Object.keys(cloud).forEach((dateStr) => {
      const localDay = merged[dateStr] || {};
      const cloudDay = cloud[dateStr] || {};
      const mergedDay = { ...localDay };

      Object.keys(cloudDay).forEach((reason) => {
        const localCount = localDay[reason] || 0;
        const cloudCount = cloudDay[reason] || 0;
        const summed = localCount + cloudCount;
        const maxPerDay = XP_ACTIONS[reason]?.maxPerDay || summed;
        mergedDay[reason] = Math.min(summed, maxPerDay);
      });

      merged[dateStr] = mergedDay;
    });

    return merged;
  }

  /**
   * üõ°Ô∏è Smart Merge Daily Actions
   * –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–ª–∏—è–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ–≥–¥–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∑–∞ –¥–µ–Ω—å —Å–¥–µ–ª–∞–Ω–æ —Ä–∞–∑–Ω–æ–µ –∫–æ–ª-–≤–æ –¥–µ–π—Å—Ç–≤–∏–π.
   * –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (Math.max) –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –ø–æ—Ç–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
   * –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
   * 1. –ï—Å–ª–∏ –¥–∞—Ç—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç -> –±–µ—Ä–µ–º –≤–µ—Ä—Å–∏—é —Å –±–æ–ª—å—à–∏–º `updatedAt` (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ).
   * 2. –ï—Å–ª–∏ `updatedAt` –Ω–µ—Ç -> –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É –±–æ–ª—å—à–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (safe fallback).
   */
  function mergeDailyActions(localActions, cloudActions) {
    if (!localActions) return cloudActions || { date: null, count: 0, updatedAt: 0 };
    if (!cloudActions) return localActions || { date: null, count: 0, updatedAt: 0 };

    const localDate = localActions.date;
    const cloudDate = cloudActions.date;

    // 1. –ù–µ—Ç –¥–∞—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π
    if (!localDate && !cloudDate) return { date: null, count: 0, updatedAt: 0 };

    // 2. –û–¥–Ω–∞ –∏–∑ –¥–∞—Ç –ø—É—Å—Ç–∞—è
    if (!localDate) return { ...cloudActions };
    if (!cloudDate) return { ...localActions };

    // 3. –î–∞—Ç—ã —Ä–∞–∑–Ω—ã–µ ‚Äî –±–µ—Ä–µ–º –±–æ–ª–µ–µ –Ω–æ–≤—É—é (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å—Ç–∞—Ä—ã–π –¥–µ–Ω—å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è)
    if (localDate > cloudDate) return { ...localActions };
    if (cloudDate > localDate) return { ...cloudActions };

    // 4. –î–∞—Ç—ã —Ä–∞–≤–Ω—ã (–∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å)
    // –ì–õ–ê–í–ù–û–ï: –ë–µ—Ä—ë–º MAX, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è.
    // –ï—Å–ª–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ 5, –∞ –≤ –æ–±–ª–∞–∫–µ 3 ‚Äî –∑–Ω–∞—á–∏—Ç –∏—Å—Ç–∏–Ω–∞ 5.
    return {
      date: localDate,
      count: Math.max(localActions.count || 0, cloudActions.count || 0),
      updatedAt: Math.max(localActions.updatedAt || 0, cloudActions.updatedAt || 0)
    };
  }

  function mergeWeeklyChallenge(localChallenge, cloudChallenge) {
    const local = localChallenge || {};
    const cloud = cloudChallenge || {};
    const localWeek = local.weekStart || null;
    const cloudWeek = cloud.weekStart || null;

    if (!localWeek && !cloudWeek) return { ...local };
    if (!localWeek) return { ...cloud };
    if (!cloudWeek) return { ...local };

    if (cloudWeek !== localWeek) {
      return cloudWeek > localWeek ? { ...cloud } : { ...local };
    }

    return {
      ...local,
      ...cloud,
      earned: Math.max(local.earned || 0, cloud.earned || 0),
      mealsCount: Math.max(local.mealsCount || 0, cloud.mealsCount || 0),
      waterDays: Math.max(local.waterDays || 0, cloud.waterDays || 0),
      trainingsCount: Math.max(local.trainingsCount || 0, cloud.trainingsCount || 0),
      perfectDays: Math.max(local.perfectDays || 0, cloud.perfectDays || 0),
      earlyBirdDays: Math.max(local.earlyBirdDays || 0, cloud.earlyBirdDays || 0)
    };
  }

  function mergeDailyMissions(localMissions, cloudMissions) {
    const local = localMissions || null;
    const cloud = cloudMissions || null;
    if (!local && !cloud) return null;
    if (!local) return { ...cloud };
    if (!cloud) return { ...local };

    if (local.date !== cloud.date) {
      return local.date > cloud.date ? { ...local } : { ...cloud };
    }

    const localList = Array.isArray(local.missions) ? local.missions : [];
    const cloudList = Array.isArray(cloud.missions) ? cloud.missions : [];
    const mergedById = new Map();

    localList.forEach((m) => mergedById.set(m.id, { ...m }));
    cloudList.forEach((m) => {
      const existing = mergedById.get(m.id) || {};
      mergedById.set(m.id, {
        ...existing,
        ...m,
        progress: Math.max(existing.progress || 0, m.progress || 0),
        completed: Boolean(existing.completed || m.completed)
      });
    });

    const mergedMissions = Array.from(mergedById.values());
    const completedCount = mergedMissions.filter((m) => m.completed).length;

    return {
      date: local.date,
      missions: mergedMissions,
      completedCount,
      bonusClaimed: Boolean(local.bonusClaimed || cloud.bonusClaimed)
    };
  }

  function mergeGameData(localData, cloudData) {
    const local = validateAndMigrate(localData || {});
    const cloud = validateAndMigrate(cloudData || {});
    const merged = createDefaultData();

    merged.totalXP = Math.max(local.totalXP || 0, cloud.totalXP || 0);
    merged.level = calculateLevel(merged.totalXP);
    merged.unlockedAchievements = mergeUniqueArray(local.unlockedAchievements, cloud.unlockedAchievements);
    merged.achievementProgress = mergeAchievementProgress(local.achievementProgress, cloud.achievementProgress);
    merged.dailyXP = mergeDailyXP(local.dailyXP, cloud.dailyXP);
    merged.dailyBonusClaimed = mergeDateStrings(local.dailyBonusClaimed, cloud.dailyBonusClaimed);
    merged.dailyActions = mergeDailyActions(local.dailyActions, cloud.dailyActions);
    merged.weeklyChallenge = mergeWeeklyChallenge(local.weeklyChallenge, cloud.weeklyChallenge);
    merged.dailyMissions = mergeDailyMissions(local.dailyMissions, cloud.dailyMissions);
    merged.weeklyTrainings = local.weeklyTrainings || cloud.weeklyTrainings || null;
    merged.earlyBirdDays = mergeUniqueArray(local.earlyBirdDays, cloud.earlyBirdDays);
    merged.streakShieldUsed = mergeDateStrings(local.streakShieldUsed, cloud.streakShieldUsed);
    merged.stats = mergeStats(local.stats, cloud.stats);

    // üîÑ v3.1: Merge _dailyXPTotals (actual XP sums per day from audit)
    const localTotals = local._dailyXPTotals || {};
    const cloudTotals = cloud._dailyXPTotals || {};
    const mergedTotals = { ...cloudTotals };
    for (const day of Object.keys(localTotals)) {
      mergedTotals[day] = Math.max(mergedTotals[day] || 0, localTotals[day] || 0);
    }
    merged._dailyXPTotals = mergedTotals;
    merged.createdAt = Math.min(local.createdAt || Date.now(), cloud.createdAt || Date.now());
    merged.updatedAt = Math.max(local.updatedAt || 0, cloud.updatedAt || 0) || Date.now();
    merged.version = DATA_VERSION;

    return merged;
  }

  function getAuditContext() {
    const sessionToken = HEYS.cloud?.getSessionToken?.() || localStorage.getItem('heys_session_token');
    const curatorToken = localStorage.getItem('heys_curator_session');
    const clientIdRaw = HEYS.utils?.getCurrentClientId?.() ||
      localStorage.getItem('heys_client_current') ||
      localStorage.getItem('heys_pin_auth_client');

    return {
      sessionToken: sessionToken ? String(sessionToken).replace(/"/g, '') : null,
      curatorToken: curatorToken ? String(curatorToken) : null,
      clientId: clientIdRaw ? String(clientIdRaw).replace(/"/g, '') : null
    };
  }

  // üîê Audit RPC feature-flag (auto-disabled on 403, auto-reset after 30s)
  let _auditRpcBlocked = false;
  let _auditRpcBlockedAt = 0;
  const AUDIT_RPC_BLOCK_RESET_MS = 30000; // 30 —Å–µ–∫—É–Ω–¥ ‚Äî auto-reset blocked flag

  function isAuditRpcBlocked() {
    if (_auditRpcBlocked && _auditRpcBlockedAt > 0) {
      // üîÑ Auto-reset after 30 seconds
      if (Date.now() - _auditRpcBlockedAt >= AUDIT_RPC_BLOCK_RESET_MS) {
        _auditRpcBlocked = false;
        _auditRpcBlockedAt = 0;
        console.info('[HEYS.game.audit] üîì Audit RPC block auto-reset after 30s');
        return false;
      }
    }
    return _auditRpcBlocked === true;
  }

  function setAuditRpcBlocked() {
    _auditRpcBlocked = true;
    _auditRpcBlockedAt = Date.now();
  }

  async function logGamificationEvent(payload) {
    const AUDIT_LOG_PREFIX = '[HEYS.game.audit]';
    const logAuditInfo = (...args) => console.info(AUDIT_LOG_PREFIX, ...args);
    const logAuditWarn = (...args) => console.warn(AUDIT_LOG_PREFIX, ...args);
    const logAuditError = (...args) => console.error(AUDIT_LOG_PREFIX, ...args);
    const startedAt = Date.now();
    const isCuratorSession = HEYS.auth?.isCuratorSession?.() === true;

    if (!HEYS.YandexAPI?.rpc) return false;
    if (isAuditRpcBlocked()) return false;

    const { sessionToken, curatorToken, clientId } = getAuditContext();
    const body = {
      p_action: payload.action,
      p_reason: payload.reason || null,
      p_xp_before: payload.xpBefore ?? null,
      p_xp_after: payload.xpAfter ?? null,
      p_xp_delta: payload.xpDelta ?? null,
      p_level_before: payload.levelBefore ?? null,
      p_level_after: payload.levelAfter ?? null,
      p_achievements_before: payload.achievementsBefore ?? null,
      p_achievements_after: payload.achievementsAfter ?? null,
      p_metadata: payload.metadata || {}
    };

    logAuditInfo('log:request', {
      action: payload?.action,
      reason: payload?.reason || null,
      hasSession: Boolean(sessionToken),
      hasCurator: Boolean(curatorToken),
      hasClientId: Boolean(clientId)
    });

    const canUseCurator = isCuratorSession && curatorToken && clientId;
    if (canUseCurator) {
      logAuditInfo('log:mode', { mode: 'curator' });
      const result = await HEYS.YandexAPI.rpc('log_gamification_event_by_curator', {
        p_client_id: clientId,
        ...body
      });
      if (result?.error?.code === 403) {
        setAuditRpcBlocked();
        logAuditWarn('log:curator:blocked', { code: 403 });
      }
      if (result?.error) {
        logAuditError('log:curator:error', {
          code: result.error?.code,
          message: result.error?.message || result.error,
          tookMs: Date.now() - startedAt
        });
      } else {
        logAuditInfo('log:curator:success', { tookMs: Date.now() - startedAt });
      }
      return result;
    }

    if (sessionToken) {
      logAuditInfo('log:mode', { mode: 'session' });
      const result = await HEYS.YandexAPI.rpc('log_gamification_event_by_session', {
        p_session_token: sessionToken,
        ...body
      });
      if (!result?.error) {
        logAuditInfo('log:session:success', { tookMs: Date.now() - startedAt });
        return result;
      }

      if (curatorToken && clientId && (result.error?.code === 401 || result.error?.code === 403)) {
        logAuditWarn('log:session:fallback', { code: result.error?.code, reason: 'session_denied' });
        const curatorResult = await HEYS.YandexAPI.rpc('log_gamification_event_by_curator', {
          p_client_id: clientId,
          ...body
        });
        if (curatorResult?.error?.code === 403) {
          setAuditRpcBlocked();
          logAuditWarn('log:curator:blocked', { code: 403 });
        }
        if (curatorResult?.error) {
          logAuditError('log:curator:error', {
            code: curatorResult.error?.code,
            message: curatorResult.error?.message || curatorResult.error,
            tookMs: Date.now() - startedAt
          });
        } else {
          logAuditInfo('log:curator:success', { tookMs: Date.now() - startedAt });
        }
        return curatorResult;
      }

      if (result.error?.code === 403) {
        setAuditRpcBlocked();
        logAuditWarn('log:session:blocked', { code: 403 });
      }

      logAuditError('log:session:error', {
        code: result.error?.code,
        message: result.error?.message || result.error,
        tookMs: Date.now() - startedAt
      });
      return result;
    }

    if (curatorToken && clientId) {
      logAuditInfo('log:mode', { mode: 'curator-fallback' });
      const result = await HEYS.YandexAPI.rpc('log_gamification_event_by_curator', {
        p_client_id: clientId,
        ...body
      });
      if (result?.error?.code === 403) {
        setAuditRpcBlocked();
        logAuditWarn('log:curator:blocked', { code: 403 });
      }
      if (result?.error) {
        logAuditError('log:curator:error', {
          code: result.error?.code,
          message: result.error?.message || result.error,
          tookMs: Date.now() - startedAt
        });
      } else {
        logAuditInfo('log:curator:success', { tookMs: Date.now() - startedAt });
      }
      return result;
    }

    logAuditWarn('log:auth:missing', { hasSession: false, hasCurator: false });
    return false;
  }

  // üîÑ Batch audit queue ‚Äî –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—á–∫–æ–π
  const _auditQueue = [];
  let _auditFlushTimer = null;
  let _auditFlushInProgress = false;
  const AUDIT_FLUSH_DEBOUNCE_MS = 500;
  const AUDIT_MAX_RETRIES = 3;

  function queueGamificationEvent(payload) {
    try {
      console.info('[HEYS.game.audit]', 'log:queue', {
        action: payload?.action,
        reason: payload?.reason || null,
        queueSize: _auditQueue.length + 1
      });
    } catch (e) { }

    _auditQueue.push({ payload, retries: 0 });
    _scheduleAuditFlush();
  }

  function _scheduleAuditFlush() {
    if (_auditFlushTimer) clearTimeout(_auditFlushTimer);
    _auditFlushTimer = setTimeout(() => _flushAuditQueue(), AUDIT_FLUSH_DEBOUNCE_MS);
  }

  async function _flushAuditQueue() {
    if (_auditFlushInProgress || _auditQueue.length === 0) return;
    _auditFlushInProgress = true;

    try {
      // –ó–∞–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
      const batch = _auditQueue.splice(0, _auditQueue.length);

      for (const item of batch) {
        try {
          await logGamificationEvent(item.payload);
        } catch (err) {
          item.retries++;
          if (item.retries < AUDIT_MAX_RETRIES) {
            // Retry with exponential backoff ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
            _auditQueue.push(item);
            console.warn('[HEYS.game.audit] Retry', item.retries, '/', AUDIT_MAX_RETRIES, 'for', item.payload?.action);
          } else {
            console.error('[HEYS.game.audit] ‚ùå Dropped after', AUDIT_MAX_RETRIES, 'retries:', item.payload?.action);
          }
        }
      }

      // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å retry-—ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å backoff
      if (_auditQueue.length > 0) {
        const maxRetries = Math.max(..._auditQueue.map(i => i.retries));
        const backoffMs = Math.min(1000 * Math.pow(2, maxRetries - 1), 8000);
        setTimeout(() => _flushAuditQueue(), backoffMs);
      }
    } finally {
      _auditFlushInProgress = false;
    }
  }

  /** –î–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö pending audit events (–¥–ª—è rebuild) */
  async function flushAuditQueue() {
    if (_auditFlushTimer) {
      clearTimeout(_auditFlushTimer);
      _auditFlushTimer = null;
    }
    if (_auditQueue.length > 0 || _auditFlushInProgress) {
      await _flushAuditQueue();
    }
  }

  async function fetchGamificationHistory(options = {}) {
    const AUDIT_LOG_PREFIX = '[HEYS.game.audit]';
    const logAuditInfo = (...args) => console.info(AUDIT_LOG_PREFIX, ...args);
    const logAuditWarn = (...args) => console.warn(AUDIT_LOG_PREFIX, ...args);
    const logAuditError = (...args) => console.error(AUDIT_LOG_PREFIX, ...args);
    const startedAt = Date.now();
    const isCuratorSession = HEYS.auth?.isCuratorSession?.() === true;

    const unwrapPayload = (data) => {
      if (!data) return {};
      if (data.items || data.total || data.success === false || data.success === true) return data;
      const keys = Object.keys(data || {});
      if (keys.length === 1 && data[keys[0]] && typeof data[keys[0]] === 'object') {
        return data[keys[0]];
      }
      return data;
    };

    if (!HEYS.YandexAPI?.rpc) {
      logAuditError('rpc:unavailable', { reason: 'YandexAPI.rpc_missing' });
      return { items: [], error: { message: 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' } };
    }

    if (isAuditRpcBlocked()) {
      logAuditWarn('rpc:blocked', { reason: 'audit_rpc_blocked' });
      return { items: [], error: { message: '–ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞' } };
    }

    const { limit = 50, offset = 0 } = options;
    const { sessionToken, curatorToken, clientId } = getAuditContext();
    logAuditInfo('rpc:request', {
      limit,
      offset,
      hasSession: Boolean(sessionToken),
      hasCurator: Boolean(curatorToken),
      hasClientId: Boolean(clientId)
    });

    const canUseCurator = isCuratorSession && curatorToken && clientId;
    if (canUseCurator) {
      logAuditInfo('rpc:mode', { mode: 'curator' });
      const result = await HEYS.YandexAPI.rpc('get_gamification_events_by_curator', {
        p_client_id: clientId,
        p_limit: limit,
        p_offset: offset
      });
      if (result?.error) {
        if (result.error?.code === 403) {
          setAuditRpcBlocked();
          logAuditWarn('rpc:curator:blocked', { code: 403 });
        }
        logAuditError('rpc:curator:error', {
          code: result.error?.code,
          message: result.error?.message || result.error,
          tookMs: Date.now() - startedAt
        });
        return { items: [], error: result.error };
      }
      const payload = unwrapPayload(result?.data || {});
      logAuditInfo('rpc:curator:payload', { keys: Object.keys(result?.data || {}) });
      logAuditInfo('rpc:curator:success', {
        count: payload.items ? payload.items.length : 0,
        total: typeof payload.total === 'number' ? payload.total : null,
        tookMs: Date.now() - startedAt
      });
      return { items: payload.items || [], total: payload.total || 0 };
    }

    if (sessionToken) {
      logAuditInfo('rpc:mode', { mode: 'session' });
      logAuditInfo('rpc:session:start', { limit, offset });
      const result = await HEYS.YandexAPI.rpc('get_gamification_events_by_session', {
        p_session_token: sessionToken,
        p_limit: limit,
        p_offset: offset
      });
      if (!result?.error) {
        const payload = unwrapPayload(result?.data || {});
        logAuditInfo('rpc:session:payload', { keys: Object.keys(result?.data || {}) });
        logAuditInfo('rpc:session:success', {
          count: payload.items ? payload.items.length : 0,
          total: typeof payload.total === 'number' ? payload.total : null,
          tookMs: Date.now() - startedAt
        });
        return { items: payload.items || [], total: payload.total || 0 };
      }

      if (curatorToken && clientId && (result.error?.code === 401 || result.error?.code === 403)) {
        logAuditWarn('rpc:session:fallback', { code: result.error?.code, reason: 'session_denied' });
        const curatorResult = await HEYS.YandexAPI.rpc('get_gamification_events_by_curator', {
          p_client_id: clientId,
          p_limit: limit,
          p_offset: offset
        });
        if (curatorResult?.error) {
          if (curatorResult.error?.code === 403) {
            setAuditRpcBlocked();
            logAuditWarn('rpc:curator:blocked', { code: 403 });
          }
          logAuditError('rpc:curator:error', {
            code: curatorResult.error?.code,
            message: curatorResult.error?.message || curatorResult.error,
            tookMs: Date.now() - startedAt
          });
          return { items: [], error: curatorResult.error };
        }
        const payload = unwrapPayload(curatorResult?.data || {});
        logAuditInfo('rpc:curator:payload', { keys: Object.keys(curatorResult?.data || {}) });
        logAuditInfo('rpc:curator:success', {
          count: payload.items ? payload.items.length : 0,
          total: typeof payload.total === 'number' ? payload.total : null,
          tookMs: Date.now() - startedAt
        });
        return { items: payload.items || [], total: payload.total || 0 };
      }

      if (result.error?.code === 403) {
        setAuditRpcBlocked();
        logAuditWarn('rpc:session:blocked', { code: 403 });
      }

      logAuditError('rpc:session:error', {
        code: result.error?.code,
        message: result.error?.message || result.error,
        tookMs: Date.now() - startedAt
      });
      return { items: [], error: result.error };
    }

    if (curatorToken && clientId) {
      logAuditInfo('rpc:mode', { mode: 'curator-fallback' });
      logAuditInfo('rpc:curator:start', { limit, offset });
      const result = await HEYS.YandexAPI.rpc('get_gamification_events_by_curator', {
        p_client_id: clientId,
        p_limit: limit,
        p_offset: offset
      });
      if (result?.error) {
        if (result.error?.code === 403) {
          setAuditRpcBlocked();
          logAuditWarn('rpc:curator:blocked', { code: 403 });
        }
        logAuditError('rpc:curator:error', {
          code: result.error?.code,
          message: result.error?.message || result.error,
          tookMs: Date.now() - startedAt
        });
        return { items: [], error: result.error };
      }
      const payload = unwrapPayload(result?.data || {});
      logAuditInfo('rpc:curator:payload', { keys: Object.keys(result?.data || {}) });
      logAuditInfo('rpc:curator:success', {
        count: payload.items ? payload.items.length : 0,
        total: typeof payload.total === 'number' ? payload.total : null,
        tookMs: Date.now() - startedAt
      });
      return { items: payload.items || [], total: payload.total || 0 };
    }

    logAuditWarn('rpc:auth:missing', { hasSession: false, hasCurator: false });
    return { items: [], error: { message: '–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (PIN –∏–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä)' } };
  }

  /**
   * üîß FIX v2.4: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ XP –∏–∑ –∞—É–¥–∏—Ç-–ª–æ–≥–∞ (source of truth)
   *
   * –ï—Å–ª–∏ XP –≤ –∫—ç—à–µ (localStorage/cloud) —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è —Å —Å—É–º–º–æ–π xp_delta –∏–∑ –∞—É–¥–∏—Ç–∞,
   * –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç XP —Ü–µ–ª–∏–∫–æ–º –∏–∑ –∞—É–¥–∏—Ç-–∑–∞–ø–∏—Å–µ–π.
   *
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è:
   * 1. –ò–∑ loadFromCloud() –µ—Å–ª–∏ cloud XP < audit XP
   * 2. –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ HEYS.game.rebuildXPFromAudit()
   *
   * @param {Object} options
   * @param {boolean} options.force ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü—ã –Ω–µ—Ç
   * @param {boolean} options.dryRun ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å
   * @returns {Object} { rebuilt: boolean, auditXP, cachedXP, delta, events }
   */
  async function rebuildXPFromAudit(options = {}) {
    const { force = false, dryRun = false, trustAudit = false } = options;
    const LOG = '[üéÆ GAME REBUILD]';
    const syncTrace = startGameSyncTrace('rebuildXPFromAudit', {
      force: Boolean(force),
      dryRun: Boolean(dryRun),
      trustAudit: Boolean(trustAudit)
    });

    // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–∞—á—É –∞—á–∏–≤–æ–∫ –ø–æ–∫–∞ –∏–¥—ë—Ç rebuild
    _isRebuilding = true;
    try {
      // 0. –î–æ–∂–¥—ë–º—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∏ pending audit events
      await flushAuditQueue();
      gameSyncTraceStep(syncTrace, 'flush_audit_queue:done');

      // 1. –ü–æ–ª—É—á–∞–µ–º –í–°–ï –∑–∞–ø–∏—Å–∏ –∏–∑ –∞—É–¥–∏—Ç-–ª–æ–≥–∞ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ 500)
      const allEvents = [];
      let offset = 0;
      const PAGE_SIZE = 500;
      const MAX_PAGES = 20; // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç ‚Äî 10000 –∑–∞–ø–∏—Å–µ–π

      for (let page = 0; page < MAX_PAGES; page++) {
        const result = await fetchGamificationHistory({ limit: PAGE_SIZE, offset });
        const items = result?.items || [];
        if (items.length === 0) break;
        allEvents.push(...items);
        offset += items.length;
        // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ —á–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–æ ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        if (items.length < PAGE_SIZE) break;
      }
      gameSyncTraceStep(syncTrace, 'fetch_audit_pages:done', {
        pages: Math.ceil(allEvents.length / PAGE_SIZE),
        totalEvents: allEvents.length
      });

      if (allEvents.length === 0) {
        console.info(LOG, 'No audit events found ‚Äî nothing to rebuild');
        endGameSyncTrace(syncTrace, 'ok', { reason: 'no_events' });
        return { rebuilt: false, auditXP: 0, cachedXP: 0, delta: 0, events: 0, reason: 'no_events' };
      }

      // 2. –°—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–π XP –∏–∑ –∞—É–¥–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ xp_gain —Å–æ–±—ã—Ç–∏—è)
      let auditXP = 0;
      let xpGainCount = 0;
      // 2b. –°–æ–±–∏—Ä–∞–µ–º unlocked achievements –∏–∑ –∞—É–¥–∏—Ç–∞
      const auditAchievements = new Set();
      // 2c. –°–æ–±–∏—Ä–∞–µ–º stats –∏–∑ audit reasons
      const auditStats = {
        totalProducts: 0,
        totalWater: 0,
        totalTrainings: 0,
        totalAdvicesRead: 0,
        perfectDays: 0,
        bestStreak: 0
      };
      // 2d. –°–æ–±–∏—Ä–∞–µ–º first_* actions –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è onboarding –∞—á–∏–≤–æ–∫
      const seenReasons = new Set();
      // 2e. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dailyXP –∏–∑ –∞—É–¥–∏—Ç-—Å–æ–±—ã—Ç–∏–π –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ "XP –∑–∞ –Ω–µ–¥–µ–ª—é"
      const auditDailyXP = {};
      // 2f. v3.1: –¢–∞–∫–∂–µ —Ö—Ä–∞–Ω–∏–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã XP –ø–æ –¥–Ω—è–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
      const auditDailyXPTotals = {};

      for (const event of allEvents) {
        const eventDelta = event.xp_delta || event.xpDelta || 0;
        const action = event.action || event.p_action || '';
        const reason = event.reason || event.p_reason || '';

        // XP —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (xp_gain + daily_bonus, –Ω–µ level_up ‚Äî —ç—Ç–æ –¥—É–±–ª—å)
        if ((action === 'xp_gain' || action === 'daily_bonus') && typeof eventDelta === 'number' && eventDelta > 0) {
          auditXP += eventDelta;
          xpGainCount++;
          seenReasons.add(reason);

          // –ü–µ—Ä–µ—Å—á—ë—Ç stats –∏–∑ reasons
          if (reason === 'product_added') auditStats.totalProducts++;
          if (reason === 'water_added') auditStats.totalWater++;
          if (reason === 'training_added') auditStats.totalTrainings++;
          if (reason === 'advice_read') auditStats.totalAdvicesRead++;
          if (reason === 'perfect_day') auditStats.perfectDays++;

          // 2e. dailyXP: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –ø–æ –¥–∞—Ç–µ+reason
          const eventDate = event.created_at || event.createdAt;
          if (eventDate && reason) {
            const dateStr = new Date(eventDate).toISOString().slice(0, 10);
            if (!auditDailyXP[dateStr]) auditDailyXP[dateStr] = {};
            auditDailyXP[dateStr][reason] = (auditDailyXP[dateStr][reason] || 0) + 1;
            // 2f. v3.1: –°—É–º–º–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π XP –ø–æ –¥–Ω—è–º (–≤–∫–ª—é—á–∞—è daily_bonus, daily_mission –∏ —Ç.–¥.)
            auditDailyXPTotals[dateStr] = (auditDailyXPTotals[dateStr] || 0) + eventDelta;
          }
        }

        // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ audit
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π: —Å—á–∏—Ç–∞–µ–º XP —Ç–æ–ª—å–∫–æ –∑–∞ –ø–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ achievement
        if (action === 'achievement_unlocked' && reason) {
          if (!auditAchievements.has(reason)) {
            auditAchievements.add(reason);
            if (typeof eventDelta === 'number' && eventDelta > 0) {
              auditXP += eventDelta;
              // 2f. v3.1: Achievement XP —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ–º –≤ –¥–Ω–µ–≤–Ω–æ–π –∏—Ç–æ–≥
              const achEventDate = event.created_at || event.createdAt;
              if (achEventDate) {
                const achDateStr = new Date(achEventDate).toISOString().slice(0, 10);
                auditDailyXPTotals[achDateStr] = (auditDailyXPTotals[achDateStr] || 0) + eventDelta;
              }
            }
          }
        }
      }

      // 3. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π XP
      const currentData = loadData();
      const cachedXP = currentData.totalXP || 0;
      const delta = auditXP - cachedXP;
      gameSyncTraceStep(syncTrace, 'audit_math:done', {
        auditXP,
        cachedXP,
        delta
      });
      const currentAchievements = new Set(currentData.unlockedAchievements || []);
      const missingAchievements = [...auditAchievements].filter(a => !currentAchievements.has(a));

      // 3b. –û–ø—Ä–µ–¥–µ–ª—è–µ–º first_* –∞—á–∏–≤–∫–∏ –∏–∑ seenReasons
      const reasonToFirstAchievement = {
        checkin_complete: 'first_checkin',
        meal_added: 'first_meal',
        product_added: 'first_product',
        steps_updated: 'first_steps',
        advice_read: 'first_advice',
        supplements_taken: 'first_supplements',
        water_added: 'first_water',
        training_added: 'first_training',
        household_added: 'first_household'
      };
      for (const [reason, achId] of Object.entries(reasonToFirstAchievement)) {
        if (seenReasons.has(reason) && !currentAchievements.has(achId) && !auditAchievements.has(achId)) {
          missingAchievements.push(achId);
        }
      }

      // 3c. Level-based –∞—á–∏–≤–∫–∏
      const rebuiltLevel = calculateLevel(Math.max(auditXP, cachedXP));
      const levelMilestones = [5, 10, 15, 20, 25];
      for (const lvl of levelMilestones) {
        const achId = `level_${lvl}`;
        if (rebuiltLevel >= lvl && !currentAchievements.has(achId) && !auditAchievements.has(achId)) {
          missingAchievements.push(achId);
        }
      }

      console.info(LOG, `Audit: ${xpGainCount} xp_gain events, total XP=${auditXP}. Cached XP=${cachedXP}. Delta=${delta}`);
      console.info(LOG, `Achievements in audit: ${auditAchievements.size}, missing: ${missingAchievements.length}`, missingAchievements);
      console.info(LOG, `Stats from audit:`, auditStats);

      // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ rebuild
      const THRESHOLD_PERCENT = 0.2;
      const xpNeedsRebuild = force || (
        auditXP > cachedXP &&
        (cachedXP === 0 || delta / Math.max(cachedXP, 1) >= THRESHOLD_PERCENT)
      );
      const achievementsNeedRebuild = missingAchievements.length > 0;
      const statsNeedRebuild = (
        auditStats.totalProducts > (currentData.stats?.totalProducts || 0) ||
        auditStats.totalWater > (currentData.stats?.totalWater || 0) ||
        auditStats.totalTrainings > (currentData.stats?.totalTrainings || 0) ||
        auditStats.totalAdvicesRead > (currentData.stats?.totalAdvicesRead || 0) ||
        auditStats.perfectDays > (currentData.stats?.perfectDays || 0)
      );

      const needsRebuild = xpNeedsRebuild || achievementsNeedRebuild || statsNeedRebuild;

      if (!needsRebuild) {
        console.info(LOG, `Everything consistent ‚Äî no rebuild needed`);
        endGameSyncTrace(syncTrace, 'ok', { reason: 'consistent', auditXP, cachedXP, delta });
        return { rebuilt: false, auditXP, cachedXP, delta, events: xpGainCount, missingAchievements: [], reason: 'consistent' };
      }

      if (dryRun) {
        console.warn(LOG, `DRY RUN: XP ${cachedXP} ‚Üí ${auditXP}, +${missingAchievements.length} achievements, stats update`);
        endGameSyncTrace(syncTrace, 'ok', { reason: 'dry_run', auditXP, cachedXP, delta, missingAchievements: missingAchievements.length });
        return {
          rebuilt: false, auditXP, cachedXP, delta, events: xpGainCount,
          missingAchievements, auditStats, reason: 'dry_run'
        };
      }

      // 5. –ü—Ä–∏–º–µ–Ω—è–µ–º rebuild
      const oldLevel = currentData.level;
      // üîí trustAudit=true: cleanup mode ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º audit –∫–∞–∫ source of truth (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º cached XP)
      let rebuiltXP = trustAudit ? auditXP : Math.max(auditXP, cachedXP);

      // 5a. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º stats (–±–µ—Ä—ë–º max –∏–∑ audit –∏ —Ç–µ–∫—É—â–∏—Ö)
      if (!currentData.stats) currentData.stats = {};
      currentData.stats.totalProducts = Math.max(currentData.stats.totalProducts || 0, auditStats.totalProducts);
      currentData.stats.totalWater = Math.max(currentData.stats.totalWater || 0, auditStats.totalWater);
      currentData.stats.totalTrainings = Math.max(currentData.stats.totalTrainings || 0, auditStats.totalTrainings);
      currentData.stats.totalAdvicesRead = Math.max(currentData.stats.totalAdvicesRead || 0, auditStats.totalAdvicesRead);
      currentData.stats.perfectDays = Math.max(currentData.stats.perfectDays || 0, auditStats.perfectDays);

      // 5a-1. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dailyXP –∏–∑ –∞—É–¥–∏—Ç-—Å–æ–±—ã—Ç–∏–π (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ "XP –∑–∞ –Ω–µ–¥–µ–ª—é")
      if (!currentData.dailyXP) currentData.dailyXP = {};
      for (const [dateStr, reasons] of Object.entries(auditDailyXP)) {
        if (!currentData.dailyXP[dateStr]) currentData.dailyXP[dateStr] = {};
        for (const [reason, count] of Object.entries(reasons)) {
          // –ë–µ—Ä—ë–º max ‚Äî –Ω–µ —Ç–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          currentData.dailyXP[dateStr][reason] = Math.max(currentData.dailyXP[dateStr][reason] || 0, count);
        }
      }

      // 5a-1b. v3.1: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã XP –ø–æ –¥–Ω—è–º (–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞)
      if (!currentData._dailyXPTotals) currentData._dailyXPTotals = {};
      for (const [dateStr, total] of Object.entries(auditDailyXPTotals)) {
        currentData._dailyXPTotals[dateStr] = Math.max(currentData._dailyXPTotals[dateStr] || 0, total);
      }

      // 5a-2. FIX v2.6: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bestStreak –∏–∑ streak-–∞—á–∏–≤–æ–∫
      // streak_7 ‚Üí min 7, streak_5 ‚Üí min 5, streak_3 ‚Üí min 3, streak_2 ‚Üí min 2, streak_1 ‚Üí min 1
      const allAchievements = new Set([...currentData.unlockedAchievements, ...auditAchievements, ...missingAchievements]);
      const streakAchLevels = [7, 5, 3, 2, 1];
      let inferredBestStreak = 0;
      for (const lvl of streakAchLevels) {
        if (allAchievements.has(`streak_${lvl}`)) {
          inferredBestStreak = lvl;
          break;
        }
      }
      // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π streak
      const currentStreak = safeGetStreak();
      inferredBestStreak = Math.max(inferredBestStreak, currentStreak);
      currentData.stats.bestStreak = Math.max(currentData.stats.bestStreak || 0, inferredBestStreak);

      // 5b. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª—è–µ–º XP –∑–∞ –∫–∞–∂–¥—É—é –∞—á–∏–≤–∫—É)
      const restoredAchievements = [];
      for (const achId of missingAchievements) {
        if (!currentData.unlockedAchievements.includes(achId)) {
          currentData.unlockedAchievements.push(achId);
          const ach = ACHIEVEMENTS[achId];
          if (ach) {
            // XP –∑–∞ –∞—á–∏–≤–∫—É –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –∞—á–∏–≤–∫–∞ –ù–ï –∏–∑ audit
            // (audit achievement_unlocked XP —É–∂–µ –≤–∫–ª—é—á—ë–Ω –≤ auditXP)
            if (!auditAchievements.has(achId)) {
              rebuiltXP += ach.xp;
            }
            restoredAchievements.push({ id: achId, name: ach.name, xp: ach.xp });
          }
        }
      }

      // 5c. –û–±–Ω–æ–≤–ª—è–µ–º XP –∏ level
      if (rebuiltXP !== cachedXP) {
        console.warn(LOG, `‚ö†Ô∏è REBUILDING XP: ${cachedXP} ‚Üí ${rebuiltXP}`);
      }
      currentData.totalXP = rebuiltXP;
      currentData.level = calculateLevel(rebuiltXP);
      currentData.updatedAt = Date.now();

      _data = currentData;
      setStoredValue(STORAGE_KEY, _data);

      // 6. –õ–æ–≥–∏—Ä—É–µ–º rebuild –≤ –∞—É–¥–∏—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ XP –∏–ª–∏ –∞—á–∏–≤–∫–∏ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
      // (stats-only –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç audit event ‚Äî —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
      const actualDelta = rebuiltXP - cachedXP;
      const hasXPOrAchievementChanges = actualDelta !== 0 || restoredAchievements.length > 0;

      if (hasXPOrAchievementChanges) {
        queueGamificationEvent({
          action: 'xp_rebuild',
          reason: 'audit_reconciliation',
          xpBefore: cachedXP,
          xpAfter: rebuiltXP,
          xpDelta: actualDelta,
          levelBefore: oldLevel,
          levelAfter: currentData.level,
          metadata: {
            auditEvents: xpGainCount,
            totalAuditRecords: allEvents.length,
            restoredAchievements: restoredAchievements.map(a => a.id),
            statsUpdated: statsNeedRebuild,
            trigger: force ? 'manual' : 'auto'
          }
        });
      } else {
        console.info(LOG, 'Rebuild verified consistency ‚Äî no audit event needed (delta=0, no new achievements)' +
          (statsNeedRebuild ? ', stats updated locally' : ''));
      }
      gameSyncTraceStep(syncTrace, 'rebuild_apply:done', {
        rebuiltXP,
        restoredAchievements: restoredAchievements.length,
        hasXPOrAchievementChanges
      });

      // 7. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ –æ–±–ª–∞–∫–æ
      triggerImmediateSync('xp_rebuild');

      // 8. –û–±–Ω–æ–≤–ª—è–µ–º UI (–µ—Å–ª–∏ –Ω–µ –ø–æ–¥–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
      if (!_suppressUIUpdates) {
        window.dispatchEvent(new CustomEvent('heysGameUpdate', {
          detail: {
            xpGained: rebuiltXP - cachedXP,
            reason: 'xp_rebuild',
            totalXP: rebuiltXP,
            level: currentData.level,
            progress: game.getProgress(),
            restoredAchievements,
            isInitialLoad: _isLoadingPhase // üîí v4.0: React –Ω–µ –ø–æ–∫–∞–∂–µ—Ç –º–æ–¥–∞–ª–∫–∏ –µ—Å–ª–∏ –º—ã –≤ loading phase
          }
        }));
      }

      // üîí v4.0: Rebuild ‚Äî —ç—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –Ω–µ –≥–µ–π–º–ø–ª–µ–π. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–Ω–µ loading phase
      if (!_isLoadingPhase && (rebuiltXP > cachedXP || restoredAchievements.length > 0)) {
        showNotification('xp_rebuilt', {
          oldXP: cachedXP,
          newXP: rebuiltXP,
          delta: rebuiltXP - cachedXP,
          achievements: restoredAchievements.length
        });
      }

      console.info(LOG, `‚úÖ Rebuild complete: XP=${rebuiltXP}, level=${currentData.level}, +${restoredAchievements.length} achievements`);
      if (restoredAchievements.length > 0) {
        console.info(LOG, `Restored achievements:`, restoredAchievements.map(a => `${a.name} (+${a.xp} XP)`));
      }

      endGameSyncTrace(syncTrace, 'ok', {
        reason: hasXPOrAchievementChanges ? 'rebuilt' : (statsNeedRebuild ? 'stats_only' : 'verified_consistent'),
        rebuiltXP,
        level: currentData.level,
        restoredAchievements: restoredAchievements.length
      });
      return {
        rebuilt: hasXPOrAchievementChanges, auditXP, cachedXP, delta: rebuiltXP - cachedXP,
        events: xpGainCount, restoredAchievements,
        reason: hasXPOrAchievementChanges ? 'rebuilt' : (statsNeedRebuild ? 'stats_only' : 'verified_consistent')
      };

    } catch (err) {
      console.error(LOG, '‚ùå Rebuild failed:', err.message);
      endGameSyncTrace(syncTrace, 'error', { message: err.message });
      return { rebuilt: false, auditXP: 0, cachedXP: 0, delta: 0, events: 0, reason: 'error', error: err.message };
    } finally {
      _isRebuilding = false; // üîì –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–∞—á—É –∞—á–∏–≤–æ–∫
    }
  }

  /**
   * üîÑ Lightweight consistency check ‚Äî 1 RPC –≤–º–µ—Å—Ç–æ full rebuild.
   * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –û–î–ù–û –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –∞—É–¥–∏—Ç–∞, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç xp_after + total event count
   * —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. Full rebuild —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏.
   */
  let _ensureAuditLastRun = 0; // ‚è±Ô∏è v5.1: Throttle ‚Äî –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 30 —Å–µ–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç _auditRebuildDone

  // üöÄ PERF: Local-only XP cache key (not synced to cloud, survives cloud overwrites)
  function _getXPCacheKey() {
    const cid = HEYS.currentClientId ||
      HEYS.utils?.getCurrentClientId?.() ||
      localStorage.getItem('heys_client_current') ||
      localStorage.getItem('heys_pin_auth_client');
    const id = cid ? String(cid).replace(/"/g, '') : 'default';
    return 'heys_xp_cache_' + id;
  }

  function _saveXPCache(totalXP, eventCount, opts) {
    try {
      const prev = _loadXPCache() || {};
      const data = { xp: totalXP, count: eventCount, ts: Date.now() };
      // üöÄ PERF v2.5: dailyRebuilt flag persists in local-only cache (NOT synced to cloud)
      // Prevents full audit rebuild (1014 events, 3 RPC pages) on every app entry
      if (opts && opts.dailyRebuilt) data.dailyRebuilt = true;
      else if (prev.dailyRebuilt) data.dailyRebuilt = true; // preserve existing flag
      localStorage.setItem(_getXPCacheKey(), JSON.stringify(data));
    } catch (_) { /* quota exceeded ‚Äî ignore */ }
  }

  function _loadXPCache() {
    try {
      const raw = localStorage.getItem(_getXPCacheKey());
      if (raw) return JSON.parse(raw);
    } catch (_) { }
    return null;
  }

  async function ensureAuditConsistency(trigger = 'auto') {
    const syncTrace = startGameSyncTrace('ensureAuditConsistency', { trigger });
    if (_auditRebuildDone) {
      endGameSyncTrace(syncTrace, 'skipped', { reason: 'already_done' });
      return;
    }
    const _now = Date.now();
    if (_now - _ensureAuditLastRun < 30000) {
      console.info('[üéÆ Gamification] ensureAuditConsistency throttled (', Math.round((_now - _ensureAuditLastRun) / 1000), 's ago), trigger:', trigger);
      endGameSyncTrace(syncTrace, 'skipped', { reason: 'throttled' });
      return;
    }
    _ensureAuditLastRun = _now;
    _auditRebuildDone = true;

    try {
      // –î–æ–∂–¥—ë–º—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∏ pending events
      await flushAuditQueue();
      gameSyncTraceStep(syncTrace, 'flush_audit_queue:done');

      const data = loadData();
      const result = await fetchGamificationHistory({ limit: 1, offset: 0 });
      gameSyncTraceStep(syncTrace, 'fetch_last_event:done', {
        hasResult: Boolean(result),
        items: result?.items?.length || 0,
        total: result?.total || 0
      });

      if (!result || !result.items || result.items.length === 0) {
        console.info('[üéÆ GAME SYNC]', trigger, '‚Äî no audit events, skip');
        endGameSyncTrace(syncTrace, 'ok', { reason: 'no_audit_events' });
        return;
      }

      const lastEvent = result.items[0];
      const auditTotal = result.total || 0;
      const lastXPAfter = lastEvent?.xp_after ?? null;
      let cachedXP = data.totalXP || 0;
      let cachedEventCount = data._lastKnownEventCount || 0;

      // üöÄ PERF v2.4: Always prefer local XP cache if it has higher XP
      // Game state in cloud can be overwritten with stale XP (e.g. 3761) after a rebuild
      // set correct XP (e.g. 8629). XP only increases, so higher cache = correct.
      const xpCache = _loadXPCache();
      if (xpCache) {
        if (xpCache.xp > cachedXP) {
          console.info('[üéÆ GAME SYNC]', trigger, '‚Äî XP cache override: game XP=' + cachedXP + ' ‚Üí cache XP=' + xpCache.xp);
          cachedXP = xpCache.xp;
        }
        if (xpCache.count > cachedEventCount) cachedEventCount = xpCache.count;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:
      // 1. XP –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–±—ã—Ç–∏–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫—ç—à–µ–º?
      // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?
      const xpConsistent = lastXPAfter === null || lastXPAfter === cachedXP;
      const countConsistent = cachedEventCount > 0 && cachedEventCount === auditTotal;
      gameSyncTraceStep(syncTrace, 'consistency_evaluated', {
        lastXPAfter,
        cachedXP,
        cachedEventCount,
        auditTotal,
        xpConsistent,
        countConsistent
      });

      if (xpConsistent && countConsistent) {
        // üöÄ PERF v2.5: –ü—Ä–æ–≤–µ—Ä—è–µ–º dailyRebuilt —á–µ—Ä–µ–∑ XP cache (local-only, –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è cloud sync)
        // –†–∞–Ω—å—à–µ _dailyXPRebuiltV1 –≤ game data —Å—Ç–∏—Ä–∞–ª—Å—è –ø—Ä–∏ cloud sync ‚Üí rebuild 1014 events –Ω–∞ –ö–ê–ñ–î–´–ô –≤—Ö–æ–¥
        const _xpCacheDR = _loadXPCache();
        if (!(_xpCacheDR && _xpCacheDR.dailyRebuilt) && cachedXP > 0) {
          console.info('[üéÆ GAME SYNC]', trigger, '‚Äî XP consistent ‚úÖ but dailyXP not yet rebuilt, restoring from audit...');
          await rebuildXPFromAudit({ force: true });
          _saveXPCache(cachedXP, auditTotal, { dailyRebuilt: true });
          endGameSyncTrace(syncTrace, 'ok', { reason: 'consistent_daily_rebuild' });
          return;
        }
        console.info('[üéÆ GAME SYNC]', trigger, '‚Äî consistent ‚úÖ (XP=' + cachedXP + ', events=' + auditTotal + ')');
        // üöÄ PERF: Update local XP cache on consistent check
        _saveXPCache(cachedXP, auditTotal);
        endGameSyncTrace(syncTrace, 'ok', { reason: 'consistent', cachedXP, auditTotal });
        return;
      }

      // –ï—Å–ª–∏ XP —Å–æ–≤–ø–∞–¥–∞–µ—Ç –Ω–æ count –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ (xp_rebuild —Å–æ–±—ã—Ç–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç count).
      // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º cached count, rebuild –Ω–µ –Ω—É–∂–µ–Ω.
      if (xpConsistent && !countConsistent) {
        console.info('[üéÆ GAME SYNC]', trigger, '‚Äî XP consistent ‚úÖ (XP=' + cachedXP +
          '), updating event count: ' + cachedEventCount + ' ‚Üí ' + auditTotal);
        const d = loadData();
        d._lastKnownEventCount = auditTotal;
        setStoredValue(STORAGE_KEY, d);
        // üöÄ PERF: Update local XP cache
        _saveXPCache(cachedXP, auditTotal);
        // üöÄ PERF v2.5: dailyXP rebuild —á–µ—Ä–µ–∑ XP cache (local-only)
        const _xpCacheDR2 = _loadXPCache();
        if (!(_xpCacheDR2 && _xpCacheDR2.dailyRebuilt) && cachedXP > 0) {
          console.info('[üéÆ GAME SYNC]', trigger, '‚Äî dailyXP not yet rebuilt, restoring from audit...');
          await rebuildXPFromAudit({ force: true });
          _saveXPCache(cachedXP, auditTotal, { dailyRebuilt: true });
        }
        endGameSyncTrace(syncTrace, 'ok', { reason: 'xp_consistent_count_update', cachedXP, auditTotal });
        return;
      }

      // XP —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ ‚Äî –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π rebuild
      console.warn('[üéÆ GAME SYNC]', trigger, '‚Äî XP DRIFT detected! Cached XP=' + cachedXP +
        ', audit xp_after=' + lastXPAfter + ', events: cached=' + cachedEventCount + ', actual=' + auditTotal);

      // ‚ö° FAST-FORWARD: –ï—Å–ª–∏ –≤ audit –µ—Å—Ç—å actuality XP (–≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑),
      // —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º UI/–∫—ç—à, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π rebuild.
      // RC-5 fix: –±—ã–ª–æ lastXPAfter > cachedXP ‚Äî —Ç–µ–ø–µ—Ä—å !== —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å —É–º–µ–Ω—å—à–µ–Ω–∏–µ XP –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞.
      // Full rebuild –Ω–∏–∂–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç dailyXP/stats/–∞—á–∏–≤–∫–∏.
      if (typeof lastXPAfter === 'number' && lastXPAfter !== cachedXP) {
        const fastData = loadData();
        const fastLevelBefore = fastData.level || calculateLevel(cachedXP);
        fastData.totalXP = lastXPAfter;
        fastData.level = calculateLevel(lastXPAfter);
        fastData.updatedAt = Date.now();
        fastData._lastKnownEventCount = Math.max(fastData._lastKnownEventCount || 0, auditTotal);
        _data = fastData;
        setStoredValue(STORAGE_KEY, fastData);
        _saveXPCache(lastXPAfter, fastData._lastKnownEventCount);

        window.dispatchEvent(new CustomEvent('heysGameUpdate', {
          detail: {
            xpGained: lastXPAfter - cachedXP,
            reason: 'xp_fast_sync',
            totalXP: lastXPAfter,
            level: fastData.level,
            progress: game.getProgress(),
            isInitialLoad: _isLoadingPhase
          }
        }));

        console.info('[üéÆ GAME SYNC]', trigger, '‚Äî fast-forward applied: XP=' + cachedXP + ' ‚Üí ' + lastXPAfter +
          ', level=' + fastLevelBefore + ' ‚Üí ' + fastData.level);
        gameSyncTraceStep(syncTrace, 'fast_forward_applied', {
          fromXP: cachedXP,
          toXP: lastXPAfter,
          fromLevel: fastLevelBefore,
          toLevel: fastData.level
        });
      }

      const rebuildResult = await rebuildXPFromAudit({ force: true });
      gameSyncTraceStep(syncTrace, 'full_rebuild:done', {
        rebuilt: Boolean(rebuildResult?.rebuilt),
        reason: rebuildResult?.reason || null
      });

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º event count –ø–æ—Å–ª–µ rebuild
      // +1 —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ rebuild —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø–∏—Å–∞–ª audit event (XP –∏–ª–∏ –∞—á–∏–≤–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
      const updatedData = loadData();
      updatedData._lastKnownEventCount = rebuildResult?.rebuilt ? auditTotal + 1 : auditTotal;
      setStoredValue(STORAGE_KEY, updatedData);
      // üöÄ PERF: Persist to local-only XP cache to survive cloud overwrites
      _saveXPCache(updatedData.totalXP || 0, updatedData._lastKnownEventCount);
      console.info('[üéÆ GAME SYNC]', trigger, '‚Äî rebuild done, eventCount saved:', updatedData._lastKnownEventCount,
        '(rebuilt:', rebuildResult?.rebuilt, ', reason:', rebuildResult?.reason, ')');
      endGameSyncTrace(syncTrace, 'ok', {
        reason: 'xp_drift_reconciled',
        updatedEventCount: updatedData._lastKnownEventCount,
        rebuilt: Boolean(rebuildResult?.rebuilt)
      });
    } catch (err) {
      console.warn('[üéÆ GAME SYNC] Consistency check failed:', err.message, { trigger });
      endGameSyncTrace(syncTrace, 'error', { message: err.message });
    }
  }

  // üõ°Ô∏è FIX v2.3: –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∫—É—Ä—Å–∏–∏ –≤ watch callback
  let _isProcessingWatch = false;

  function bindCloudWatch() {
    if (_cloudWatchBound || !HEYS.store?.watch) return;
    _cloudWatchBound = true;

    HEYS.store.watch(STORAGE_KEY, (nextVal) => {
      // üõ°Ô∏è FIX v2.3: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–µ–∫—É—Ä—Å–∏—é ‚Äî –µ—Å–ª–∏ –º—ã —Å–∞–º–∏ –∑–∞–ø–∏—Å–∞–ª–∏, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
      if (_isProcessingWatch) return;
      if (!nextVal || typeof nextVal !== 'object') return;

      const current = _data || loadData();
      const nextXP = nextVal.totalXP || 0;
      const nextAchievements = Array.isArray(nextVal.unlockedAchievements)
        ? nextVal.unlockedAchievements.length
        : 0;
      const currentXP = current?.totalXP || 0;
      const currentAchievements = Array.isArray(current?.unlockedAchievements)
        ? current.unlockedAchievements.length
        : 0;
      const nextUpdated = nextVal.updatedAt || 0;
      const currentUpdated = current?.updatedAt || 0;

      if (
        nextUpdated && currentUpdated &&
        nextUpdated <= currentUpdated &&
        nextXP <= currentXP &&
        nextAchievements <= currentAchievements
      ) {
        return;
      }

      const merged = mergeGameData(current, nextVal);
      _data = merged;

      // üõ°Ô∏è FIX v2.3: –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏
      _isProcessingWatch = true;
      try {
        setStoredValue(STORAGE_KEY, _data);
        // v61: Sync XP cache after watch merge to prevent drift
        _saveXPCache(_data.totalXP || 0, _data._lastKnownEventCount || 0);
      } finally {
        _isProcessingWatch = false;
      }

      _cloudLoaded = true;
      if (_pendingCloudSync) {
        _pendingCloudSync = false;
        triggerImmediateSync('pending_sync');
      }

      window.dispatchEvent(new CustomEvent('heysGameUpdate', {
        detail: { ...game.getStats(), isInitialLoad: _isLoadingPhase }
      }));
    });
  }

  function migrateStreakAchievements(data) {
    if (!data || !Array.isArray(data.unlockedAchievements)) return;

    const legacyStreakIds = new Set(['streak_14', 'streak_30', 'streak_100']);
    const hasLegacy = data.unlockedAchievements.some((id) => legacyStreakIds.has(id));

    if (hasLegacy) {
      const newStreakIds = ['streak_1', 'streak_2', 'streak_3', 'streak_5', 'streak_7'];
      newStreakIds.forEach((id) => {
        if (!data.unlockedAchievements.includes(id)) {
          data.unlockedAchievements.push(id);
        }
      });
    }

    // –£–¥–∞–ª—è–µ–º legacy-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —Å–ø–∏—Å–æ–∫
    if (hasLegacy) {
      data.unlockedAchievements = data.unlockedAchievements.filter((id) => !legacyStreakIds.has(id));
    }
  }

  /**
   * –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ dailyXP —Å—Ç–∞—Ä—à–µ MAX_DAILY_XP_DAYS –¥–Ω–µ–π
   */
  function cleanupOldDailyXP(dailyXP) {
    if (!dailyXP || typeof dailyXP !== 'object') return {};

    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - MAX_DAILY_XP_DAYS);
    const cutoffStr = cutoffDate.toISOString().slice(0, 10);

    const cleaned = {};
    let removedCount = 0;

    for (const [date, xp] of Object.entries(dailyXP)) {
      if (date >= cutoffStr) {
        cleaned[date] = xp;
      } else {
        removedCount++;
      }
    }

    if (removedCount > 0) {
      console.log(`[HEYS.game] Cleaned up ${removedCount} old dailyXP entries`);
    }

    return cleaned;
  }

  function createDefaultData() {
    return {
      version: DATA_VERSION,
      totalXP: 0,
      level: 1,
      unlockedAchievements: [],
      dailyXP: {},          // { '2025-11-30': { product_added: 5, water_added: 2, ... } }
      dailyBonusClaimed: null, // '2025-11-30' ‚Äî –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ daily bonus
      // Daily Action Multiplier (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞ –¥–µ–Ω—å)
      dailyActions: {
        date: null,           // '2025-12-01'
        count: 0              // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π –∑–∞ –¥–µ–Ω—å
      },
      // Weekly challenge
      weeklyChallenge: {
        weekStart: null,      // '2025-12-01' ‚Äî –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏
        target: 500,          // —Ü–µ–ª—å XP
        earned: 0,            // –Ω–∞–±—Ä–∞–Ω–æ XP
        type: 'xp'            // —Ç–∏–ø —á–µ–ª–ª–µ–Ω–¥–∂–∞
      },
      // Mission history (anti-repeat) ‚Äî store last 7 days
      missionHistory: [],     // [{ date: '2025-12-01', ids: ['meals_3', 'water_100', ...] }]
      // Mission statistics (completion rates, favorites)
      missionStats: {
        totalAttempts: 0,     // –í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ –º–∏—Å—Å–∏–π
        totalCompleted: 0,    // –í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
        byType: {},           // { meals: { attempts: 0, completed: 0 }, ... }
        completionRate: 0,    // % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        favoriteCategories: [], // –¢–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        lastUpdated: null     // –î–∞—Ç–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
      },
      // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º (–¥–ª—è UI)
      achievementProgress: {
        // perfect_week: { current: 3, target: 7 }
        // water_master: { current: 5, target: 7, dates: ['2025-12-01', ...] }
      },
      stats: {
        totalProducts: 0,
        totalWater: 0,
        totalTrainings: 0,
        totalAdvicesRead: 0,
        perfectDays: 0,
        bestStreak: 0
      },
      _lastKnownEventCount: 0, // üîÑ –î–ª—è lightweight consistency check
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
  }

  // üîÑ Debounce –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
  let _cloudSyncTimer = null;
  const CLOUD_SYNC_DEBOUNCE_MS = 1000; // üî• –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: 1 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 3
  let _lastImmediateSync = 0;
  const IMMEDIATE_SYNC_COOLDOWN_MS = 2000; // üî• –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: 2 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 10

  function scheduleCloudSync(immediate = false) {
    if (!_cloudLoaded) {
      _pendingCloudSync = true;
      return;
    }

    if (_cloudSyncTimer) clearTimeout(_cloudSyncTimer);

    if (immediate) {
      triggerImmediateSync('auto_sync');
    } else {
      _cloudSyncTimer = setTimeout(() => {
        _cloudSyncTimer = null;
        triggerImmediateSync('auto_sync');
      }, CLOUD_SYNC_DEBOUNCE_MS);
    }
  }

  function triggerImmediateSync(reason) {
    if (!_cloudLoaded) {
      _pendingCloudSync = true;
      return;
    }
    const now = Date.now();

    // üî• –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π (level_up, achievement) –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫—É–ª–¥–∞—É–Ω
    const isCritical = ['level_up', 'achievement_unlocked', 'daily_bonus', 'daily_missions_bonus'].includes(reason);
    const cooldown = isCritical ? 0 : IMMEDIATE_SYNC_COOLDOWN_MS;

    if (now - _lastImmediateSync < cooldown) {
      // –ï—Å–ª–∏ —á–∞—Å—Ç–æ ‚Äî –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º
      if (_cloudSyncTimer) clearTimeout(_cloudSyncTimer);
      _cloudSyncTimer = setTimeout(() => triggerImmediateSync(reason), CLOUD_SYNC_DEBOUNCE_MS);
      return;
    }

    _lastImmediateSync = now;
    if (_data) {
      _data.updatedAt = Date.now();
      // üîß FIX v2.3: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¢–û–õ–¨–ö–û –≤ localStorage (setStoredValue), –ù–ï —á–µ—Ä–µ–∑ HEYS.store.set
      // HEYS.store.set –≤—ã–∑—ã–≤–∞–µ—Ç saveClientKey ‚Üí –∫–æ—Ç–æ—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –≤ doClientUpload
      // –≠—Ç–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ ‚Äî syncToCloud() —Å–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ RPC
      setStoredValue(STORAGE_KEY, _data);
    }

    // üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –æ–±–ª–∞–∫–æ–º —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π RPC (–Ω–µ —á–µ—Ä–µ–∑ saveClientKey)
    if (HEYS.game?.syncToCloud) {
      HEYS.game.syncToCloud();
    }
  }

  function saveData() {
    if (!_data) return;
    _data.updatedAt = Date.now();
    setStoredValue(STORAGE_KEY, _data);

    // üîÑ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º (debounced)
    scheduleCloudSync();
  }

  function calculateLevel(totalXP) {
    for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
      if (totalXP >= LEVEL_THRESHOLDS[i]) {
        return i + 1; // —É—Ä–æ–≤–Ω–∏ 1-indexed
      }
    }
    return 1;
  }

  function getLevelTitle(level) {
    for (const t of LEVEL_TITLES) {
      if (level >= t.min && level <= t.max) return t;
    }
    return LEVEL_TITLES[LEVEL_TITLES.length - 1];
  }

  function getXPForNextLevel(level) {
    if (level >= LEVEL_THRESHOLDS.length) return null; // max level
    return LEVEL_THRESHOLDS[level]; // –∏–Ω–¥–µ–∫—Å = —É—Ä–æ–≤–µ–Ω—å (0 = level 1)
  }

  function getXPForCurrentLevel(level) {
    if (level <= 1) return 0;
    return LEVEL_THRESHOLDS[level - 1];
  }

  // ========== RANK BADGES ==========
  const RANK_BADGES = [
    { min: 1, max: 4, rank: 'Bronze', icon: 'ü•â', color: '#cd7f32' },
    { min: 5, max: 9, rank: 'Silver', icon: 'ü•à', color: '#c0c0c0' },
    { min: 10, max: 14, rank: 'Gold', icon: 'ü•á', color: '#ffd700' },
    { min: 15, max: 19, rank: 'Platinum', icon: 'üíé', color: '#e5e4e2' },
    { min: 20, max: 25, rank: 'Diamond', icon: 'üëë', color: '#b9f2ff' }
  ];

  function getRankBadge(level) {
    for (const r of RANK_BADGES) {
      if (level >= r.min && level <= r.max) return r;
    }
    return RANK_BADGES[RANK_BADGES.length - 1];
  }

  // ========== XP MULTIPLIER ==========
  function getXPMultiplier() {
    const streak = safeGetStreak();
    if (streak >= 14) return 3;  // 3x –ø—Ä–∏ streak 14+
    if (streak >= 7) return 2.5; // 2.5x –ø—Ä–∏ streak 7+
    if (streak >= 3) return 2;   // 2x –ø—Ä–∏ streak 3+
    return 1;
  }

  // ========== DAILY BONUS ==========
  function canClaimDailyBonus() {
    const data = loadData();
    const today = getToday();
    return data.dailyBonusClaimed !== today;
  }

  async function refreshDailyBonusFromAudit(options = {}) {
    const { force = false } = options;
    const today = getToday();
    const data = loadData();

    try {
      if (!force && data.dailyBonusClaimed === today) {
        _dailyBonusAuditCache = { date: today, checkedAt: Date.now(), claimed: true };
        return true;
      }

      const now = Date.now();
      if (!force && _dailyBonusAuditCache.date === today && (now - _dailyBonusAuditCache.checkedAt) < DAILY_BONUS_AUDIT_CACHE_MS) {
        return _dailyBonusAuditCache.claimed;
      }

      const hasSession = Boolean(
        HEYS.auth?.getSessionToken?.() ||
        localStorage.getItem('heys_session_token') ||
        localStorage.getItem('heys_curator_session')
      );

      if (!HEYS.YandexAPI?.rpc || !hasSession || isAuditRpcBlocked()) {
        _dailyBonusAuditCache = { date: today, checkedAt: now, claimed: data.dailyBonusClaimed === today };
        return data.dailyBonusClaimed === today;
      }

      const PAGE_SIZE = 500;
      const MAX_PAGES = 5;
      let offset = 0;
      let found = false;
      let oldestDate = null;

      for (let page = 0; page < MAX_PAGES; page++) {
        const result = await fetchGamificationHistory({ limit: PAGE_SIZE, offset });
        const items = result?.items || [];
        if (items.length === 0) break;

        for (const event of items) {
          const action = event.action || event.p_action || '';
          if (action !== 'daily_bonus') continue;
          const eventDate = event.created_at || event.createdAt;
          if (!eventDate) continue;
          const dateStr = new Date(eventDate).toISOString().slice(0, 10);
          if (dateStr === today) {
            found = true;
            break;
          }
        }

        if (found) break;

        const lastEvent = items[items.length - 1];
        const lastEventDate = lastEvent?.created_at || lastEvent?.createdAt || null;
        oldestDate = lastEventDate ? new Date(lastEventDate).toISOString().slice(0, 10) : null;

        if (!oldestDate || oldestDate < today) break;
        offset += items.length;
      }

      _dailyBonusAuditCache = { date: today, checkedAt: now, claimed: found };

      if (found && data.dailyBonusClaimed !== today) {
        data.dailyBonusClaimed = today;
        saveData();
      }

      return found;
    } catch (e) {
      _dailyBonusAuditCache = { date: today, checkedAt: Date.now(), claimed: data.dailyBonusClaimed === today };
      return data.dailyBonusClaimed === today;
    }
  }

  async function claimDailyBonus() {
    await refreshDailyBonusFromAudit();
    const data = loadData();
    const today = getToday();
    if (data.dailyBonusClaimed === today) return false;

    data.dailyBonusClaimed = today;
    const bonusXP = 10 * getXPMultiplier();
    const oldLevel = data.level; // Store the old level before updating
    const beforeXP = data.totalXP;
    const beforeAchievements = data.unlockedAchievements.length;
    data.totalXP += bonusXP;
    data.level = calculateLevel(data.totalXP);
    const afterXP = data.totalXP;
    const afterAchievements = data.unlockedAchievements.length;
    handleRankTransition(oldLevel, data.level);
    saveData();
    triggerImmediateSync('daily_bonus');

    queueGamificationEvent({
      action: 'daily_bonus',
      reason: 'daily_bonus',
      xpBefore: beforeXP,
      xpAfter: afterXP,
      xpDelta: bonusXP,
      levelBefore: oldLevel,
      levelAfter: data.level,
      achievementsBefore: beforeAchievements,
      achievementsAfter: afterAchievements,
      metadata: { multiplier: getXPMultiplier() }
    });

    showNotification('daily_bonus', { xp: bonusXP, multiplier: getXPMultiplier() });
    window.dispatchEvent(new CustomEvent('heysGameUpdate', { detail: { xpGained: bonusXP, reason: 'daily_bonus' } }));
    return true;
  }

  // ========== PERSONAL BEST ==========
  function isNewStreakRecord() {
    const data = loadData();
    const currentStreak = safeGetStreak();
    return currentStreak > 0 && currentStreak > data.stats.bestStreak;
  }

  function getNextLevelTitle(level) {
    const nextLevel = level + 1;
    if (nextLevel > 25) return null;
    return getLevelTitle(nextLevel);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–≤–∞–Ω–∏—è —Å —É—Ä–æ–≤–Ω—è–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   */
  function getAllTitles() {
    return LEVEL_TITLES.map(t => ({
      ...t,
      // –£—Ä–æ–≤–µ–Ω—å, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —ç—Ç–æ –∑–≤–∞–Ω–∏–µ
      startLevel: t.min
    }));
  }

  // ========== DAILY ACTION MULTIPLIER ==========
  // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –∑–∞ –¥–µ–Ω—å: —á–µ–º –±–æ–ª—å—à–µ –¥–µ–π—Å—Ç–≤–∏–π ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ XP
  // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å

  const DAILY_MULTIPLIER_THRESHOLDS = [
    { actions: 0, multiplier: 1.0, label: '' },
    { actions: 3, multiplier: 1.2, label: 'üî•' },      // 3+ –¥–µ–π—Å—Ç–≤–∏—è = 1.2x
    { actions: 6, multiplier: 1.5, label: 'üî•üî•' },    // 6+ = 1.5x
    { actions: 10, multiplier: 1.8, label: 'üî•üî•üî•' }, // 10+ = 1.8x
    { actions: 15, multiplier: 2.0, label: '‚ö°' },      // 15+ = 2x
    { actions: 20, multiplier: 2.5, label: '‚ö°‚ö°' },    // 20+ = 2.5x
    { actions: 30, multiplier: 3.0, label: 'üíé' }      // 30+ = 3x (max)
  ];

  // –ü–æ—Ä–æ–≥ –Ω–æ—á–∏: –¥–æ 3:00 ‚Äî —ç—Ç–æ –µ—â—ë "–≤—á–µ—Ä–∞"
  const NIGHT_HOUR_THRESHOLD = 3;

  function getTodayDate() {
    const d = new Date();
    const hour = d.getHours();
    // –î–æ 3:00 ‚Äî —ç—Ç–æ –µ—â—ë "–≤—á–µ—Ä–∞" (–¥–µ–Ω—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)
    if (hour < NIGHT_HOUR_THRESHOLD) {
      d.setDate(d.getDate() - 1);
    }
    return d.toISOString().slice(0, 10);
  }

  function getDailyMultiplier() {
    const data = loadData();
    const today = getTodayDate();

    // –ú–∏–≥—Ä–∞—Ü–∏—è –∏–ª–∏ –Ω–æ–≤—ã–π –¥–µ–Ω—å
    if (!data.dailyActions || data.dailyActions.date !== today) {
      return { multiplier: 1, actions: 0, label: '', nextThreshold: 3 };
    }

    const actions = data.dailyActions.count;
    let current = DAILY_MULTIPLIER_THRESHOLDS[0];
    let next = DAILY_MULTIPLIER_THRESHOLDS[1];

    for (let i = DAILY_MULTIPLIER_THRESHOLDS.length - 1; i >= 0; i--) {
      if (actions >= DAILY_MULTIPLIER_THRESHOLDS[i].actions) {
        current = DAILY_MULTIPLIER_THRESHOLDS[i];
        next = DAILY_MULTIPLIER_THRESHOLDS[i + 1] || null;
        break;
      }
    }

    return {
      multiplier: current.multiplier,
      actions: actions,
      label: current.label,
      nextThreshold: next ? next.actions : null,
      nextMultiplier: next ? next.multiplier : null
    };
  }

  function incrementDailyActions() {
    const data = loadData();
    const today = getTodayDate();

    // –ú–∏–≥—Ä–∞—Ü–∏—è –∏–ª–∏ –Ω–æ–≤—ã–π –¥–µ–Ω—å ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
    if (!data.dailyActions || data.dailyActions.date !== today) {
      data.dailyActions = { date: today, count: 0 };
    }

    data.dailyActions.count += 1;
    saveData();

    const multiplierInfo = getDailyMultiplier();

    // Dispatch event –¥–ª—è UI
    window.dispatchEvent(new CustomEvent('heysDailyMultiplierUpdate', {
      detail: multiplierInfo
    }));

    return multiplierInfo;
  }

  // ========== DAILY MISSIONS ==========
  // Pool & selection engine ‚Üí heys_daily_missions_v1.js (HEYS.missions)

  function getDailyMissions() {
    const gameData = loadData();
    const today = getToday();
    const dayKey = `heys_dayv2_${today}`;

    // Load dayData directly to store missions
    let dayData = readStoredValue(dayKey, {});
    if (!dayData || typeof dayData !== 'object') dayData = {};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ –Ω–æ–≤—ã–π –¥–µ–Ω—å (–µ—Å–ª–∏ –≤ dayData –ø—É—Å—Ç–æ)
    if (!dayData.dailyMissions || dayData.dailyMissions.date !== today) {
      const selectFn = HEYS.missions?.selectDailyMissions;

      // Build excludeIds from last 7 days history
      const excludeIds = [];
      if (gameData.missionHistory) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - 7);
        gameData.missionHistory
          .filter(h => new Date(h.date) >= cutoff)
          .forEach(h => excludeIds.push(...(h.ids || [])));
      }

      dayData.dailyMissions = {
        date: today,
        missions: selectFn ? selectFn(gameData.level, excludeIds) : [],
        completedCount: 0,
        bonusClaimed: false
      };

      // üìä Update mission stats (attempts)
      gameData.missionStats = gameData.missionStats || {
        totalAttempts: 0,
        totalCompleted: 0,
        byType: {},
        completionRate: 0,
        favoriteCategories: [],
        lastUpdated: null
      };
      gameData.missionStats.totalAttempts += dayData.dailyMissions.missions.length;
      dayData.dailyMissions.missions.forEach(m => {
        if (!gameData.missionStats.byType[m.type]) {
          gameData.missionStats.byType[m.type] = { attempts: 0, completed: 0 };
        }
        gameData.missionStats.byType[m.type].attempts++;
      });

      // Store today's mission IDs in history
      gameData.missionHistory = gameData.missionHistory || [];
      gameData.missionHistory.push({
        date: today,
        ids: dayData.dailyMissions.missions.map(m => m.id)
      });
      // Keep only last 7 days
      gameData.missionHistory = gameData.missionHistory.slice(-7);

      // Save both
      setStoredValue(dayKey, dayData);

      // Update local gameData mirror for compatibility (if any legacy code reads it)
      gameData.dailyMissions = dayData.dailyMissions;
      saveData();
    }

    const dm = dayData.dailyMissions || {};
    return {
      date: dm.date,
      missions: dm.missions || [],
      completedCount: dm.completedCount || 0,
      allCompleted: (dm.completedCount || 0) >= 3,
      bonusClaimed: !!dm.bonusClaimed,
      bonusAvailable: (dm.completedCount || 0) >= 3 && !dm.bonusClaimed
    };
  }

  function updateDailyMission(type, value) {
    const gameData = loadData();
    const today = getToday();
    const dayKey = `heys_dayv2_${today}`;

    let dayData = readStoredValue(dayKey, {});
    // Fallback
    if (!dayData || typeof dayData !== 'object') dayData = {};

    if (!dayData.dailyMissions || dayData.dailyMissions.date !== today) {
      getDailyMissions(); // Will create in dayData
      dayData = readStoredValue(dayKey, {});
      if (!dayData.dailyMissions) return;
    }

    let missionCompleted = false;
    const missions = dayData.dailyMissions.missions || [];

    for (const mission of missions) {
      if (mission.completed) continue;

      let matches = false;
      let newProgress = mission.progress || 0;

      switch (mission.type) {
        case 'meals':
          if (type === 'product_added') {
            const mealsCount = HEYS.Day?.getMealsCount?.() || 0;
            newProgress = mealsCount;
            matches = true;
          }
          break;
        case 'early_meal':
          if (type === 'product_added') {
            const meals = HEYS.Day?.getMeals?.() || [];
            const firstMeal = meals[0];
            if (firstMeal?.time) {
              const hour = parseInt(firstMeal.time.split(':')[0]) || 0;
              if (hour < mission.target) {
                newProgress = 1;
                matches = true;
              }
            }
          }
          break;
        case 'products':
          if (type === 'product_added') {
            newProgress = HEYS.Day?.getUniqueProductsCount?.() || 0;
            matches = true;
          }
          break;
        case 'kcal':
          if (type === 'product_added') {
            const kcalPct = HEYS.Day?.getKcalPercent?.() || 0;
            newProgress = kcalPct;
            matches = true;
          }
          break;
        case 'water':
          if (type === 'water_added') {
            newProgress = value;
            matches = true;
          }
          break;
        case 'water_entries':
          if (type === 'water_added') {
            // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ (dailyXP –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç maxPerDay=5, —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ)
            newProgress = (mission.progress || 0) + 1;
            matches = true;
          }
          break;
        case 'training':
          if (type === 'training_added') {
            newProgress = 1;
            matches = true;
          }
          break;
        case 'steps':
          if (type === 'steps_updated') {
            newProgress = value;
            matches = true;
          }
          break;
        case 'steps_goal':
          if (type === 'steps_updated') {
            newProgress = value;
            matches = true;
          }
          break;
        case 'active_day':
          if (type === 'training_added' || type === 'steps_updated') {
            const hasTraining = type === 'training_added' || (HEYS.Day?.getTrainingsCount?.() || 0) > 0;
            const hasSteps = type === 'steps_updated' ? value >= 3000 : (HEYS.Day?.getSteps?.() || 0) >= 3000;
            if (hasTraining && hasSteps) {
              newProgress = 1;
              matches = true;
            }
          }
          break;
        case 'fiber':
          if (type === 'product_added') {
            const fiberPct = HEYS.Day?.getFiberPercent?.() || 0;
            newProgress = fiberPct;
            matches = true;
          }
          break;
        case 'protein':
          if (type === 'product_added') {
            const proteinPct = HEYS.Day?.getProteinPercent?.() || 0;
            newProgress = proteinPct;
            matches = true;
          }
          break;
        case 'complex_carbs':
          if (type === 'product_added') {
            const complexPct = HEYS.Day?.getComplexCarbsPercent?.() || 0;
            newProgress = complexPct;
            matches = true;
          }
          break;
        case 'low_harm':
          if (type === 'product_added') {
            const harmPct = HEYS.Day?.getHarmPercent?.() || 100;
            // Low harm = harm% < target (30). Progress is inverted: progress = target if harmPct <= target
            if (harmPct <= mission.target) {
              newProgress = mission.target;
              matches = true;
            } else {
              newProgress = Math.max(0, mission.target - (harmPct - mission.target));
              matches = true;
            }
          }
          break;
        case 'balance':
          if (type === 'product_added' && HEYS.Day?.getMacroBalance) {
            const balance = HEYS.Day.getMacroBalance();
            if (balance &&
              balance.protein >= 0.8 && balance.protein <= 1.2 &&
              balance.carbs >= 0.8 && balance.carbs <= 1.2 &&
              balance.fat >= 0.8 && balance.fat <= 1.2) {
              newProgress = 1;
              matches = true;
            }
          }
          break;
        case 'low_gi':
          if (type === 'product_added') {
            const lastMealGI = HEYS.Day?.getLastMealGI?.() || 100;
            if (lastMealGI < 50) {
              newProgress = 1;
              matches = true;
            }
          }
          break;
        case 'streak_keep':
          if (type === 'product_added') {
            newProgress = 1;
            matches = true;
          }
          break;
        case 'dinner_time':
          if (type === 'product_added') {
            const meals = HEYS.Day?.getMeals?.() || [];
            if (meals.length > 0) {
              const lastHour = meals.reduce((max, m) => {
                const t = (m.time || '').split(':');
                const h = parseInt(t[0]) || 0;
                return h > max ? h : max;
              }, 0);
              if (lastHour > 0 && lastHour < (mission.threshold || 20)) {
                newProgress = 1;
                matches = true;
              }
            }
          }
          break;
        case 'no_late_snack':
          if (type === 'product_added') {
            const allMeals = HEYS.Day?.getMeals?.() || [];
            const hasLate = allMeals.some(m => {
              const h = parseInt((m.time || '').split(':')[0]) || 0;
              return h >= (mission.threshold || 21);
            });
            newProgress = hasLate ? 0 : 1;
            matches = true;
          }
          break;
        case 'eating_window':
          if (type === 'product_added') {
            const ew_meals = HEYS.Day?.getMeals?.() || [];
            if (ew_meals.length >= 2) {
              const times = ew_meals.map(m => {
                const [h, min] = (m.time || '0:0').split(':').map(Number);
                return h * 60 + (min || 0);
              });
              const windowHrs = (Math.max(...times) - Math.min(...times)) / 60;
              if (windowHrs <= (mission.threshold || 12)) {
                newProgress = 1;
                matches = true;
              }
            }
          }
          break;
        case 'log_mood':
          if (type === 'product_added') {
            const moodMeals = HEYS.Day?.getMeals?.() || [];
            const hasMood = moodMeals.some(m => m.mood && m.mood > 0);
            if (hasMood) {
              newProgress = 1;
              matches = true;
            }
          }
          break;
      }

      if (matches) {
        mission.progress = newProgress;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        if (newProgress >= mission.target && !mission.completed) {
          mission.completed = true;
          dayData.dailyMissions.completedCount++;
          missionCompleted = true;

          // üìä Update mission stats (completed)
          gameData.missionStats = gameData.missionStats || {
            totalAttempts: 0,
            totalCompleted: 0,
            byType: {},
            completionRate: 0,
            favoriteCategories: [],
            lastUpdated: null
          };
          gameData.missionStats.totalCompleted++;
          if (!gameData.missionStats.byType[mission.type]) {
            gameData.missionStats.byType[mission.type] = { attempts: 0, completed: 0 };
          }
          gameData.missionStats.byType[mission.type].completed++;
          // Recalculate completion rate
          if (gameData.missionStats.totalAttempts > 0) {
            gameData.missionStats.completionRate = Math.round(
              (gameData.missionStats.totalCompleted / gameData.missionStats.totalAttempts) * 100
            );
          }
          gameData.missionStats.lastUpdated = new Date().toISOString();

          // –ù–∞—á–∏—Å–ª—è–µ–º XP –∑–∞ –º–∏—Å—Å–∏—é
          _addXPInternal(mission.xp, 'daily_mission');

          showNotification('mission_complete', {
            name: mission.name,
            xp: mission.xp
          });

          // Mission sound
          playMissionSound(false);
        }
      }
    }

    // Save dayData
    setStoredValue(dayKey, dayData);

    // Mirror to gameData for safety
    gameData.dailyMissions = dayData.dailyMissions;
    saveData();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–Ω—É—Å –∑–∞ –≤—Å–µ 3 –º–∏—Å—Å–∏–∏ ‚Äî –∞–≤—Ç–æ–∫–ª–µ–π–º
    if (dayData.dailyMissions.completedCount >= 3 && !dayData.dailyMissions.bonusClaimed) {
      dayData.dailyMissions.bonusClaimed = true;
      setStoredValue(dayKey, dayData); // Save bonus state to day

      gameData.dailyMissions = dayData.dailyMissions; // Mirror
      saveData();

      triggerImmediateSync('daily_missions_bonus');
      _addXPInternal(50, 'daily_missions_bonus');
      celebrate();
      showNotification('all_missions_complete', { bonus: 50 });
      playMissionSound(true);
    }

    // Dispatch event –¥–ª—è UI
    window.dispatchEvent(new CustomEvent('heysDailyMissionsUpdate', {
      detail: getDailyMissions()
    }));

    return missionCompleted;
  }

  function claimDailyMissionsBonus() {
    const data = loadData();
    const today = getToday();

    if (!data.dailyMissions ||
      data.dailyMissions.date !== today ||
      data.dailyMissions.completedCount < 3 ||
      data.dailyMissions.bonusClaimed) {
      return false;
    }

    data.dailyMissions.bonusClaimed = true;
    saveData();
    triggerImmediateSync('daily_missions_bonus');

    // –ë–æ–Ω—É—Å 50 XP –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏—Å—Å–∏–π
    _addXPInternal(50, 'daily_missions_bonus');
    celebrate();

    showNotification('all_missions_complete', { bonus: 50 });

    // All missions sound
    playMissionSound(true);

    return true;
  }

  // ========== RECALCULATE MISSIONS PROGRESS ==========
  /**
   * Recalculate daily missions progress from current day state
   * Called on day load, product added, water added events
   * Does NOT complete missions or award XP - only updates progress
   */
  function recalculateDailyMissionsProgress() {
    const data = loadData();
    const today = getToday();

    if (!data.dailyMissions || data.dailyMissions.date !== today) {
      return { updated: false, missions: [] };
    }

    let updated = false;

    for (const mission of data.dailyMissions.missions) {
      if (mission.completed) continue;

      let newProgress = 0;

      switch (mission.type) {
        case 'meals':
          newProgress = HEYS.Day?.getMealsCount?.() || 0;
          break;
        case 'products':
          newProgress = HEYS.Day?.getUniqueProductsCount?.() || 0;
          break;
        case 'water':
          newProgress = HEYS.Day?.getWaterPercent?.() || 0;
          break;
        case 'water_entries':
          // –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –∏–∑ updateDailyMission
          // (–≤–æ–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π, —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞—Ä–Ω—ã–π waterMl)
          newProgress = mission.progress || 0;
          break;
        case 'kcal':
          newProgress = HEYS.Day?.getKcalPercent?.() || 0;
          break;
        case 'fiber':
          newProgress = HEYS.Day?.getFiberPercent?.() || 0;
          break;
        case 'protein':
          newProgress = HEYS.Day?.getProteinPercent?.() || 0;
          break;
        case 'complex_carbs':
          newProgress = HEYS.Day?.getComplexCarbsPercent?.() || 0;
          break;
        case 'harm':
          newProgress = HEYS.Day?.getHarmPercent?.() || 0;
          break;
        case 'steps':
          newProgress = HEYS.Day?.getSteps?.() || 0;
          break;
        case 'steps_goal':
          newProgress = HEYS.Day?.getSteps?.() || 0;
          break;
        case 'training':
          newProgress = (HEYS.Day?.getTrainingsCount?.() || 0) > 0 ? 1 : 0;
          break;
        case 'active_day':
          const hasTraining = (HEYS.Day?.getTrainingsCount?.() || 0) > 0;
          const hasSteps = (HEYS.Day?.getSteps?.() || 0) >= 3000;
          newProgress = (hasTraining && hasSteps) ? 1 : 0;
          break;
        case 'early_meal':
          const meals = HEYS.Day?.getMeals?.() || [];
          const firstMeal = meals[0];
          if (firstMeal?.time) {
            const hour = parseInt(firstMeal.time.split(':')[0]) || 0;
            newProgress = (hour < mission.target) ? 1 : 0;
          }
          break;
        case 'dinner_time':
          const allMeals = HEYS.Day?.getMeals?.() || [];
          if (allMeals.length > 0) {
            const lastHour = allMeals.reduce((max, m) => {
              const t = (m.time || '').split(':');
              const h = parseInt(t[0]) || 0;
              return h > max ? h : max;
            }, 0);
            newProgress = (lastHour > 0 && lastHour < (mission.threshold || 20)) ? 1 : 0;
          }
          break;
        case 'no_late_snack':
          const mls = HEYS.Day?.getMeals?.() || [];
          const hasLate = mls.some(m => {
            const h = parseInt((m.time || '').split(':')[0]) || 0;
            return h >= (mission.threshold || 21);
          });
          newProgress = hasLate ? 0 : 1;
          break;
        case 'eating_window':
          const ewMeals = HEYS.Day?.getMeals?.() || [];
          if (ewMeals.length >= 2) {
            const times = ewMeals.map(m => {
              const [h, min] = (m.time || '0:0').split(':').map(Number);
              return h * 60 + (min || 0);
            });
            const windowHrs = (Math.max(...times) - Math.min(...times)) / 60;
            newProgress = (windowHrs <= (mission.threshold || 12)) ? 1 : 0;
          }
          break;
        case 'log_mood':
          const moodMeals = HEYS.Day?.getMeals?.() || [];
          const hasMood = moodMeals.some(m => m.mood && m.mood > 0);
          newProgress = hasMood ? 1 : 0;
          break;
      }

      if (mission.progress !== newProgress) {
        mission.progress = newProgress;
        updated = true;
      }
    }

    if (updated) {
      saveData();
      window.dispatchEvent(new CustomEvent('heysDailyMissionsUpdate', {
        detail: getDailyMissions()
      }));
    }

    return { updated, missions: data.dailyMissions.missions };
  }

  // ========== WEEKLY CHALLENGE ==========
  function getWeekStart() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
    return new Date(now.setDate(diff)).toISOString().slice(0, 10);
  }

  // –ü–æ–ª—É—á–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –Ω–æ—Ä–º—É –≤–æ–¥—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  function getWaterGoalForDay() {
    try {
      // –ü—Ä–æ–±—É–µ–º HEYS.Day.getWaterGoal (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
      if (typeof HEYS !== 'undefined' && HEYS.Day?.getWaterGoal) {
        return HEYS.Day.getWaterGoal();
      }
      // Fallback: 30–º–ª –Ω–∞ –∫–≥ –≤–µ—Å–∞
      const profileStr = readStoredValue('heys_profile', null);
      if (profileStr) {
        const prof = JSON.parse(profileStr);
        return Math.round((prof.weight || 70) * 30);
      }
    } catch (e) { /* ignore */ }
    return 2000; // Default
  }

  // ========== WEEKLY CHALLENGES ==========

  const WEEKLY_CHALLENGE_TYPES = [
    {
      type: 'xp',
      name: 'XP-–º–∞—Ä–∞—Ñ–æ–Ω',
      icon: '‚ö°',
      description: '–ù–∞–±–µ—Ä–∏ {target} XP –∑–∞ –Ω–µ–¥–µ–ª—é',
      targets: [300, 500, 750, 1000],
      reward: 100,
      check: (data, target) => data.weeklyChallenge.earned >= target
    },
    {
      type: 'meals',
      name: '–®–µ—Ñ-–ø–æ–≤–∞—Ä',
      icon: 'üçΩÔ∏è',
      description: '–î–æ–±–∞–≤—å {target} –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏',
      targets: [14, 21, 28],
      reward: 75,
      check: (data, target) => (data.weeklyChallenge.mealsCount || 0) >= target
    },
    {
      type: 'water',
      name: '–ê–∫–≤–∞–º–µ–Ω',
      icon: 'üíß',
      description: '–í—ã–ø–æ–ª–Ω–∏ –Ω–æ—Ä–º—É –≤–æ–¥—ã {target} –¥–Ω–µ–π',
      targets: [3, 5, 7],
      reward: 80,
      check: (data, target) => (data.weeklyChallenge.waterDays || 0) >= target
    },
    {
      type: 'training',
      name: '–ê—Ç–ª–µ—Ç',
      icon: 'üí™',
      description: '–ó–∞–ø–∏—à–∏ {target} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
      targets: [2, 3, 5],
      reward: 90,
      check: (data, target) => (data.weeklyChallenge.trainingsCount || 0) >= target
    },
    {
      type: 'perfect_days',
      name: '–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç',
      icon: '‚≠ê',
      description: '–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å {target} —Ä–∞–∑',
      targets: [2, 3, 5],
      reward: 120,
      check: (data, target) => (data.weeklyChallenge.perfectDays || 0) >= target
    },
    {
      type: 'streak',
      name: '–ë–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤',
      icon: 'üî•',
      description: '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π streak {target} –¥–Ω–µ–π',
      targets: [3, 5, 7],
      reward: 100,
      check: (data, target) => {
        const streak = safeGetStreak();
        return streak >= target;
      }
    },
    {
      type: 'early_bird',
      name: '–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞',
      icon: 'üåÖ',
      description: '–ó–∞–≤—Ç—Ä–∞–∫ –¥–æ 9:00 ‚Äî {target} –¥–Ω–µ–π',
      targets: [3, 5, 7],
      reward: 85,
      check: (data, target) => (data.weeklyChallenge.earlyBirdDays || 0) >= target
    }
  ];

  function selectWeeklyChallenge(level) {
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ç–∏–ø —á–µ–ª–ª–µ–Ω–¥–∂–∞
    const randomType = WEEKLY_CHALLENGE_TYPES[Math.floor(Math.random() * WEEKLY_CHALLENGE_TYPES.length)];

    // –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è: –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –ª—ë–≥–∫–∏–µ —Ç–∞—Ä–≥–µ—Ç—ã
    let targetIndex = 0;
    if (level >= 10) targetIndex = 1;
    if (level >= 20) targetIndex = 2;
    if (level >= 30) targetIndex = 3;

    // –ù–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã
    targetIndex = Math.min(targetIndex, randomType.targets.length - 1);

    return {
      type: randomType.type,
      name: randomType.name,
      icon: randomType.icon,
      description: randomType.description.replace('{target}', randomType.targets[targetIndex]),
      target: randomType.targets[targetIndex],
      reward: randomType.reward,
      earned: 0,
      // –°—á—ë—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
      mealsCount: 0,
      waterDays: 0,
      trainingsCount: 0,
      perfectDays: 0,
      earlyBirdDays: 0
    };
  }

  function getWeeklyChallenge() {
    const data = loadData();
    const currentWeek = getWeekStart();

    // –ú–∏–≥—Ä–∞—Ü–∏—è: –µ—Å–ª–∏ weeklyChallenge –Ω–µ—Ç –∏–ª–∏ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
    if (!data.weeklyChallenge || !data.weeklyChallenge.type) {
      data.weeklyChallenge = {
        weekStart: currentWeek,
        ...selectWeeklyChallenge(data.level)
      };
      saveData();
    }

    // –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è ‚Äî –Ω–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂
    if (data.weeklyChallenge.weekStart !== currentWeek) {
      data.weeklyChallenge = {
        weekStart: currentWeek,
        ...selectWeeklyChallenge(data.level)
      };
      saveData();
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    const challengeType = WEEKLY_CHALLENGE_TYPES.find(t => t.type === data.weeklyChallenge.type);
    const isCompleted = challengeType?.check(data, data.weeklyChallenge.target) || false;

    // –î–ª—è XP —Ç–∏–ø–∞ ‚Äî earned —ç—Ç–æ XP, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    let current = 0;
    let unit = '';
    switch (data.weeklyChallenge.type) {
      case 'xp':
        current = data.weeklyChallenge.earned || 0;
        unit = ' XP';
        break;
      case 'meals':
        current = data.weeklyChallenge.mealsCount || 0;
        unit = '';
        break;
      case 'water':
        current = data.weeklyChallenge.waterDays || 0;
        unit = ' –¥–Ω';
        break;
      case 'training':
        current = data.weeklyChallenge.trainingsCount || 0;
        unit = '';
        break;
      case 'perfect_days':
        current = data.weeklyChallenge.perfectDays || 0;
        unit = ' –¥–Ω';
        break;
      case 'streak':
        current = safeGetStreak();
        unit = ' –¥–Ω';
        break;
      case 'early_bird':
        current = data.weeklyChallenge.earlyBirdDays || 0;
        unit = ' –¥–Ω';
        break;
      default:
        current = data.weeklyChallenge.earned || 0;
        unit = '';
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º description —Å target
    const description = challengeType?.description?.replace('{target}', data.weeklyChallenge.target) || '';

    return {
      ...data.weeklyChallenge,
      current,
      percent: Math.min(100, Math.round((current / data.weeklyChallenge.target) * 100)),
      completed: isCompleted,
      // –î–æ–±–∞–≤–ª—è–µ–º UI –¥–∞–Ω–Ω—ã–µ
      title: challengeType?.name || '–ù–µ–¥–µ–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂',
      description: description,
      icon: challengeType?.icon || 'üéØ',
      unit: unit,
      reward: challengeType?.reward || 100
    };
  }

  function updateWeeklyProgress(reason, extraData = {}) {
    const data = loadData();
    const currentWeek = getWeekStart();

    // –ú–∏–≥—Ä–∞—Ü–∏—è
    if (!data.weeklyChallenge || !data.weeklyChallenge.type) {
      data.weeklyChallenge = {
        weekStart: currentWeek,
        ...selectWeeklyChallenge(data.level)
      };
    }

    if (data.weeklyChallenge.weekStart !== currentWeek) {
      data.weeklyChallenge = {
        weekStart: currentWeek,
        ...selectWeeklyChallenge(data.level)
      };
    }

    const wasCompleted = getWeeklyChallenge().completed;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è
    switch (reason) {
      case 'product_added':
        data.weeklyChallenge.mealsCount = (data.weeklyChallenge.mealsCount || 0) + 1;
        // Early bird check
        if (new Date().getHours() < 9) {
          const today = getToday();
          if (!data.weeklyChallenge.earlyBirdToday || data.weeklyChallenge.earlyBirdToday !== today) {
            data.weeklyChallenge.earlyBirdDays = (data.weeklyChallenge.earlyBirdDays || 0) + 1;
            data.weeklyChallenge.earlyBirdToday = today;
          }
        }
        break;
      case 'water_added':
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã –≤–æ–¥—ã
        if (extraData.waterPercent >= 100) {
          const today = getToday();
          if (!data.weeklyChallenge.waterToday || data.weeklyChallenge.waterToday !== today) {
            data.weeklyChallenge.waterDays = (data.weeklyChallenge.waterDays || 0) + 1;
            data.weeklyChallenge.waterToday = today;
          }
        }
        break;
      case 'training_added':
        data.weeklyChallenge.trainingsCount = (data.weeklyChallenge.trainingsCount || 0) + 1;
        break;
      case 'perfect_day':
        data.weeklyChallenge.perfectDays = (data.weeklyChallenge.perfectDays || 0) + 1;
        break;
    }

    saveData();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    const challenge = getWeeklyChallenge();
    if (!wasCompleted && challenge.completed) {
      showNotification('weekly_complete', {
        name: challenge.name,
        reward: challenge.reward
      });
      // –ë–æ–Ω—É—Å –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      const oldLevel = data.level;
      data.totalXP += challenge.reward;
      data.level = calculateLevel(data.totalXP);
      handleRankTransition(oldLevel, data.level);
      saveData();
      celebrate();

      window.dispatchEvent(new CustomEvent('heysWeeklyChallengeComplete', {
        detail: {
          challenge: { ...challenge },
          reward: challenge.reward
        }
      }));
    }
  }

  function addWeeklyXP(xp) {
    const data = loadData();
    const currentWeek = getWeekStart();

    // –ú–∏–≥—Ä–∞—Ü–∏—è
    if (!data.weeklyChallenge || !data.weeklyChallenge.type) {
      data.weeklyChallenge = {
        weekStart: currentWeek,
        ...selectWeeklyChallenge(data.level)
      };
    }

    if (data.weeklyChallenge.weekStart !== currentWeek) {
      data.weeklyChallenge = {
        weekStart: currentWeek,
        ...selectWeeklyChallenge(data.level)
      };
    }

    // –î–æ–±–∞–≤–ª—è–µ–º XP –¥–ª—è XP-—Ç–∏–ø–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞
    data.weeklyChallenge.earned = (data.weeklyChallenge.earned || 0) + xp;
    saveData();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è XP-—Ç–∏–ø–∞
    if (data.weeklyChallenge.type === 'xp') {
      const challenge = getWeeklyChallenge();
      if (challenge.completed && !data.weeklyChallenge.rewarded) {
        data.weeklyChallenge.rewarded = true;
        showNotification('weekly_complete', {
          name: challenge.name,
          reward: challenge.reward
        });
        const oldLevel = data.level;
        data.totalXP += challenge.reward;
        data.level = calculateLevel(data.totalXP);
        handleRankTransition(oldLevel, data.level);
        saveData();
        celebrate();

        window.dispatchEvent(new CustomEvent('heysWeeklyChallengeComplete', {
          detail: {
            challenge: { ...challenge },
            reward: challenge.reward
          }
        }));
      }
    }
  }

  // ========== XP SOUND (Web Audio API) ==========
  let audioContext = null;

  // üîä Sound settings (can be disabled in profile)
  const SOUND_SETTINGS = {
    enabled: true, // Default: sounds enabled
    volume: 0.15,  // Default volume
  };

  // Load sound settings from localStorage
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π soundEnabled –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  function loadSoundSettings() {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–æ—Ñ–∏–ª—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
      const globalSettings = readStoredValue('heys_settings', null);
      if (globalSettings) {
        const parsed = typeof globalSettings === 'string' ? JSON.parse(globalSettings) : globalSettings;
        if (parsed.soundEnabled === false) {
          SOUND_SETTINGS.enabled = false;
          return SOUND_SETTINGS;
        }
      }
      // Fallback: –ª–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏
      const saved = readStoredValue('heys_sound_settings', null);
      if (saved) {
        const parsed = typeof saved === 'string' ? JSON.parse(saved) : saved;
        SOUND_SETTINGS.enabled = parsed.enabled !== false;
        SOUND_SETTINGS.volume = typeof parsed.volume === 'number' ? parsed.volume : 0.15;
      }
    } catch (e) { /* ignore */ }
    return SOUND_SETTINGS;
  }

  // Save sound settings
  function saveSoundSettings(settings) {
    Object.assign(SOUND_SETTINGS, settings);
    setStoredValue('heys_sound_settings', SOUND_SETTINGS);
  }

  function playXPSound(isLevelUp = false) {
    // Check if sounds are enabled
    loadSoundSettings();
    if (!SOUND_SETTINGS.enabled) return;

    try {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      const volume = SOUND_SETTINGS.volume;

      if (isLevelUp) {
        // Level up ‚Äî –º–µ–ª–æ–¥–∏—è –∏–∑ 3 –Ω–æ—Ç (–≤–æ—Å—Ö–æ–¥—è—â–∞—è)
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
        gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.4);
      } else {
        // –û–±—ã—á–Ω—ã–π XP ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π "–ø–∏–Ω–≥"
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(volume * 0.7, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
      }
    } catch (e) {
      // Ignore audio errors
    }
  }

  // üéµ Achievement sound (special fanfare)
  function playAchievementSound() {
    loadSoundSettings();
    if (!SOUND_SETTINGS.enabled) return;

    try {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      const volume = SOUND_SETTINGS.volume;

      // Achievement fanfare ‚Äî ascending chord
      const notes = [
        { freq: 523.25, time: 0 },      // C5
        { freq: 659.25, time: 0.08 },   // E5
        { freq: 783.99, time: 0.16 },   // G5
        { freq: 1046.5, time: 0.24 },   // C6
      ];

      notes.forEach(({ freq, time }) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        osc.type = 'triangle';
        gain.gain.setValueAtTime(volume * 0.8, audioContext.currentTime + time);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.3);
        osc.start(audioContext.currentTime + time);
        osc.stop(audioContext.currentTime + time + 0.3);
      });
    } catch (e) {
      // Ignore audio errors
    }
  }

  // üèÜ Rank ceremony sound (longer, more epic)
  function playRankCeremonySound() {
    loadSoundSettings();
    if (!SOUND_SETTINGS.enabled) return;

    try {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      const volume = SOUND_SETTINGS.volume;
      const notes = [
        { freq: 392.0, time: 0.0 },   // G4
        { freq: 523.25, time: 0.1 },  // C5
        { freq: 659.25, time: 0.22 }, // E5
        { freq: 783.99, time: 0.36 }, // G5
        { freq: 1046.5, time: 0.5 }   // C6
      ];

      notes.forEach(({ freq, time }) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(volume * 0.9, audioContext.currentTime + time);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.45);
        osc.start(audioContext.currentTime + time);
        osc.stop(audioContext.currentTime + time + 0.45);
      });
    } catch (e) {
      // Ignore audio errors
    }
  }

  // ========== LOTTIE LOADER ==========
  let _lottieLoadPromise = null;

  function loadLottie() {
    if (window.lottie) return Promise.resolve(true);
    if (_lottieLoadPromise) return _lottieLoadPromise;

    _lottieLoadPromise = new Promise((resolve) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/lottie-web@5.12.2/build/player/lottie.min.js';
      script.async = true;
      script.onload = () => resolve(true);
      script.onerror = () => resolve(false);
      document.head.appendChild(script);
    });

    return _lottieLoadPromise;
  }

  // ========== RANK CEREMONY ==========
  let _activeRankCeremony = null;

  function showRankCeremony(payload) {
    if (!payload) return;

    const existing = document.querySelector('.rank-ceremony');
    if (existing) existing.remove();

    const ceremony = document.createElement('div');
    ceremony.className = 'rank-ceremony';
    ceremony.setAttribute('role', 'dialog');
    ceremony.setAttribute('aria-live', 'polite');

    const panel = document.createElement('div');
    panel.className = 'rank-ceremony__panel';

    const lottieWrap = document.createElement('div');
    lottieWrap.className = 'rank-ceremony__lottie';

    const title = document.createElement('div');
    title.className = 'rank-ceremony__title';
    title.textContent = '–ù–æ–≤—ã–π —Ä–∞–Ω–≥!';

    const subtitle = document.createElement('div');
    subtitle.className = 'rank-ceremony__subtitle';
    subtitle.textContent = `${payload.toTitle.icon} ${payload.toTitle.title}`;

    const rankLine = document.createElement('div');
    rankLine.className = 'rank-ceremony__rankline';
    rankLine.innerHTML = `
      <span class="rank-ceremony__rank">${payload.fromTitle.icon} ${payload.fromTitle.title}</span>
      <span class="rank-ceremony__arrow">‚Üí</span>
      <span class="rank-ceremony__rank">${payload.toTitle.icon} ${payload.toTitle.title}</span>
    `;

    const hint = document.createElement('div');
    hint.className = 'rank-ceremony__hint';
    hint.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∞–π ‚Äî —Å–ª–µ–¥—É—é—â–∏–µ —É—Ä–æ–≤–Ω–∏ —É–∂–µ –∂–¥—É—Ç.';

    const button = document.createElement('button');
    button.className = 'rank-ceremony__btn';
    button.type = 'button';
    button.textContent = '–ö—Ä—É—Ç–æ!';

    panel.appendChild(lottieWrap);
    panel.appendChild(title);
    panel.appendChild(subtitle);
    panel.appendChild(rankLine);
    panel.appendChild(hint);
    panel.appendChild(button);
    ceremony.appendChild(panel);

    const removeCeremony = () => {
      ceremony.classList.add('rank-ceremony--hide');
      setTimeout(() => ceremony.remove(), 250);
      _activeRankCeremony = null;
    };

    button.addEventListener('click', removeCeremony);
    ceremony.addEventListener('click', (e) => {
      if (e.target === ceremony) removeCeremony();
    });

    document.body.appendChild(ceremony);

    _activeRankCeremony = { el: ceremony, remove: removeCeremony };

    loadLottie().then((loaded) => {
      if (!loaded || !window.lottie || !document.body.contains(ceremony)) return;

      window.lottie.loadAnimation({
        container: lottieWrap,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: 'assets/lottie/level-up-ceremony.json'
      });
    });

    setTimeout(removeCeremony, 6000);
  }

  function handleRankTransition(oldLevel, newLevel) {
    if (newLevel <= oldLevel) return;

    // üîí v4.0: –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏/rebuild
    if (_isLoadingPhase || _isRebuilding || _suppressUIUpdates) return;

    const fromTitle = getLevelTitle(oldLevel);
    const toTitle = getLevelTitle(newLevel);

    if (fromTitle.title === toTitle.title) return;

    // üõ°Ô∏è –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ä–∞–Ω–≥ –ø—Ä–∏ –≤—Ö–æ–¥–µ/—Å–∏–Ω–∫–µ
    const lastShown = readStoredValue('heys_rank_ceremony_last', null);
    if (lastShown && lastShown.title === toTitle.title && (lastShown.level || 0) >= newLevel) {
      return;
    }
    setStoredValue('heys_rank_ceremony_last', {
      title: toTitle.title,
      level: newLevel,
      ts: Date.now()
    });

    playRankCeremonySound();
    showRankCeremony({ fromTitle, toTitle });
  }

  // ========== XP HISTORY (7 days) ==========
  function getXPHistory() {
    const data = loadData();
    const history = [];
    const today = new Date();

    for (let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().slice(0, 10);

      // v3.1: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã XP –∏–∑ –∞—É–¥–∏—Ç–∞ (_dailyXPTotals)
      // Fallback ‚Äî –ø–æ–¥—Å—á—ë—Ç —á–µ—Ä–µ–∑ XP_ACTIONS (–¥–ª—è —Ä–µ–∞–ª-—Ç–∞–π–º –¥–∞–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è)
      let totalDayXP = 0;

      if (data._dailyXPTotals && data._dailyXPTotals[dateStr]) {
        totalDayXP = data._dailyXPTotals[dateStr];
      } else {
        // Fallback: —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ XP_ACTIONS (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è)
        const dayXP = data.dailyXP[dateStr] || {};
        for (const reason of Object.keys(dayXP)) {
          const action = XP_ACTIONS[reason];
          if (action) {
            totalDayXP += dayXP[reason] * action.xp;
          }
        }
      }

      // v3.1: –î–ª—è —Å–µ–≥–æ–¥–Ω—è ‚Äî –±–µ—Ä—ë–º max –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
      // (—Ä–µ–∞–ª-—Ç–∞–π–º –¥–µ–π—Å—Ç–≤–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–æ–≤–µ–µ —á–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π rebuild)
      if (dateStr === today.toISOString().slice(0, 10) && data.dailyXP[dateStr]) {
        let realtimeXP = 0;
        const dayXP = data.dailyXP[dateStr];
        for (const reason of Object.keys(dayXP)) {
          const action = XP_ACTIONS[reason];
          if (action) {
            realtimeXP += dayXP[reason] * action.xp;
          }
        }
        totalDayXP = Math.max(totalDayXP, realtimeXP);
      }

      history.push({
        date: dateStr,
        day: d.toLocaleDateString('ru', { weekday: 'short' }),
        xp: totalDayXP
      });
    }

    return history;
  }

  // ========== FLOATING XP ==========
  function showFloatingXP(sourceEl, xpAmount, isCombo = false) {
    let x, y;
    if (sourceEl && sourceEl.getBoundingClientRect) {
      const rect = sourceEl.getBoundingClientRect();
      x = rect.left + rect.width / 2;
      y = rect.top;
    } else {
      x = window.innerWidth / 2;
      y = window.innerHeight / 2;
    }

    const float = document.createElement('div');
    float.className = `floating-xp-text ${isCombo ? 'combo' : ''}`;
    float.innerHTML = isCombo
      ? `<span class="combo-text">COMBO!</span> +${xpAmount}`
      : `+${xpAmount}`;
    float.style.cssText = `
      position: fixed;
      left: ${x}px;
      top: ${y}px;
      transform: translateX(-50%);
      font-size: ${isCombo ? '18px' : '16px'};
      font-weight: 700;
      color: ${isCombo ? '#f59e0b' : '#fbbf24'};
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
      pointer-events: none;
      z-index: 9999;
      animation: floatUp 1.2s ease-out forwards;
    `;
    document.body.appendChild(float);
    setTimeout(() => float.remove(), 1200);
  }

  // ========== FLYING ANIMATION ==========

  function flyToBar(sourceEl, xpAmount) {
    // –ù–∞—Ö–æ–¥–∏–º target ‚Äî gamification bar –≤ header
    const target = document.querySelector('.hdr-gamification .game-xp') ||
      document.querySelector('.hdr-gamification');
    if (!target) return;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º source position
    let sourceRect;
    if (sourceEl && sourceEl.getBoundingClientRect) {
      sourceRect = sourceEl.getBoundingClientRect();
    } else {
      // Fallback: —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
      sourceRect = {
        left: window.innerWidth / 2,
        top: window.innerHeight / 2,
        width: 0,
        height: 0
      };
    }

    const targetRect = target.getBoundingClientRect();

    // –°–æ–∑–¥–∞—ë–º –ª–µ—Ç—è—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
    const fly = document.createElement('div');
    fly.className = 'flying-xp';
    fly.textContent = `+${xpAmount}`;
    fly.style.cssText = `
      position: fixed;
      left: ${sourceRect.left + sourceRect.width / 2}px;
      top: ${sourceRect.top + sourceRect.height / 2}px;
      font-size: 16px;
      font-weight: 700;
      color: #fbbf24;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
      pointer-events: none;
      z-index: 1150;
      transform: translate(-50%, -50%);
    `;
    document.body.appendChild(fly);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—ë—Ç–∞
    requestAnimationFrame(() => {
      fly.style.transition = 'all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1)';
      fly.style.left = `${targetRect.left + targetRect.width / 2}px`;
      fly.style.top = `${targetRect.top + targetRect.height / 2}px`;
      fly.style.opacity = '0';
      fly.style.transform = 'translate(-50%, -50%) scale(0.5)';
    });

    // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => fly.remove(), 850);
  }

  function dispatchXpGainedEvent(xpAmount, sourceEl) {
    let x = window.innerWidth / 2;
    let y = window.innerHeight / 2;

    if (sourceEl && sourceEl.getBoundingClientRect) {
      const rect = sourceEl.getBoundingClientRect();
      x = rect.left + rect.width / 2;
      y = rect.top + rect.height / 2;
    }

    window.dispatchEvent(new CustomEvent('heysXpGained', {
      detail: { xp: xpAmount, x, y }
    }));
  }

  // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========

  function showNotification(type, data) {
    // üîí v4.0: –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    if (_isLoadingPhase) return;
    _notificationQueue.push({ type, data });
    processNotificationQueue();
  }

  function processNotificationQueue() {
    if (_isShowingNotification || _notificationQueue.length === 0) return;

    _isShowingNotification = true;
    const { type, data } = _notificationQueue.shift();

    // Dispatch event –¥–ª—è React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    window.dispatchEvent(new CustomEvent('heysGameNotification', {
      detail: { type, data }
    }));

    // Auto-hide —á–µ—Ä–µ–∑ 3-4 —Å–µ–∫—É–Ω–¥—ã
    const duration = type === 'level_up' ? 4000 : 3000;
    setTimeout(() => {
      _isShowingNotification = false;
      processNotificationQueue();
    }, duration);
  }

  // ========== CONFETTI ==========

  function celebrate(payload = null) {
    if (_isLoadingPhase) return;
    window.dispatchEvent(new CustomEvent('heysCelebrate', {
      detail: payload || undefined
    }));
  }

  // ========== STREAK SHIELD ==========
  function canUseStreakShield() {
    const data = loadData();
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    return data.streakShieldUsed !== currentMonth;
  }

  function useStreakShield() {
    const data = loadData();
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    if (data.streakShieldUsed === currentMonth) return false;

    data.streakShieldUsed = currentMonth;
    saveData();

    showNotification('streak_shield', { message: 'Streak —Å–ø–∞—Å—ë–Ω! üõ°Ô∏è' });
    return true;
  }

  function getStreakShieldStatus() {
    const data = loadData();
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    return {
      available: data.streakShieldUsed !== currentMonth,
      usedThisMonth: data.streakShieldUsed === currentMonth
    };
  }

  // ========== XP BREAKDOWN ==========
  function getXPBreakdown() {
    const data = loadData();
    const today = getToday();
    const todayXP = data.dailyXP[today] || {};

    const breakdown = [];
    for (const [reason, count] of Object.entries(todayXP)) {
      const action = XP_ACTIONS[reason];
      if (action && count > 0) {
        breakdown.push({
          reason,
          label: action.label,
          count,
          xp: count * action.xp
        });
      }
    }

    return {
      items: breakdown,
      total: breakdown.reduce((sum, b) => sum + b.xp, 0)
    };
  }

  // ========== LEVEL-UP PREVIEW ==========
  function getLevelUpPreview() {
    const data = loadData();
    const currentTitle = getLevelTitle(data.level);

    // –ù–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–µ –∑–≤–∞–Ω–∏–µ
    const nextTitleInfo = LEVEL_TITLES.find(t => t.min > data.level);
    if (!nextTitleInfo) return null;

    const levelsToNextTitle = nextTitleInfo.min - data.level;
    const xpToNextTitle = LEVEL_THRESHOLDS[nextTitleInfo.min - 1] - data.totalXP;

    return {
      currentTitle: currentTitle.title,
      nextTitle: nextTitleInfo.title,
      nextIcon: nextTitleInfo.icon,
      levelsRemaining: levelsToNextTitle,
      xpRemaining: Math.max(0, xpToNextTitle)
    };
  }

  // ========== –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ==========

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞
   */
  function updateAchievementProgress(achId, current, target, extraData = {}) {
    const data = loadData();
    if (!data.achievementProgress) data.achievementProgress = {};

    data.achievementProgress[achId] = {
      current: Math.min(current, target),
      target,
      ...extraData,
      updatedAt: Date.now()
    };
    saveData();

    return current >= target;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
   */
  function getAchievementProgress(achId) {
    const data = loadData();
    return data.achievementProgress?.[achId] || null;
  }

  /**
   * –ü–æ–¥—Å—á—ë—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π —Å —É—Å–ª–æ–≤–∏–µ–º
   * @param {Function} conditionFn - (dayData, dateStr) => boolean
   * @param {number} maxDays - –º–∞–∫—Å–∏–º—É–º –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   */
  function countConsecutiveDays(conditionFn, maxDays = 14) {
    let count = 0;
    const today = new Date();

    for (let i = 0; i < maxDays; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().slice(0, 10);

      const dayData = readStoredValue(`heys_dayv2_${dateStr}`, null);

      if (dayData && conditionFn(dayData, dateStr)) {
        count++;
      } else if (i > 0) {
        // –¶–µ–ø–æ—á–∫–∞ –ø—Ä–µ—Ä–≤–∞–ª–∞—Å—å (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–µ–≥–æ–¥–Ω—è –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)
        break;
      }
    }

    return count;
  }

  function checkAchievements(reason) {
    // üõ°Ô∏è FIX: –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—á–∏–≤–∫–∏ –ø–æ–∫–∞ –∏–¥—ë—Ç rebuild/–∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏
    if (_isRebuilding || _isLoadingPhase) return [];

    const data = loadData();
    const newAchievements = [];

    // üîç DEBUG LOGGING
    const DEBUG = readStoredValue('heys_debug_gamification', null) === 'true';
    if (DEBUG) {
      console.log('[üéÆ Gamification] checkAchievements called:', {
        reason,
        level: data.level,
        totalXP: data.totalXP,
        unlockedCount: data.unlockedAchievements?.length || 0,
        unlocked: data.unlockedAchievements
      });
    }

    // ========== STREAK ACHIEVEMENTS ==========
    const streak = safeGetStreak();

    if (DEBUG) {
      console.log('[üéÆ Gamification] Streak check:', { streak });
    }

    newAchievements.push(...checkStreakAchievements(streak, { skipUnlock: true }));

    // ========== FIRST ACTIONS ==========
    if (reason === 'checkin_complete' && !data.unlockedAchievements.includes('first_checkin')) {
      newAchievements.push('first_checkin');
    }
    if (reason === 'meal_added' && !data.unlockedAchievements.includes('first_meal')) {
      newAchievements.push('first_meal');
    }
    if (reason === 'product_added' && !data.unlockedAchievements.includes('first_product')) {
      newAchievements.push('first_product');
    }
    if (reason === 'steps_updated' && !data.unlockedAchievements.includes('first_steps')) {
      newAchievements.push('first_steps');
    }
    if (reason === 'advice_read' && !data.unlockedAchievements.includes('first_advice')) {
      newAchievements.push('first_advice');
    }
    if (reason === 'supplements_taken' && !data.unlockedAchievements.includes('first_supplements')) {
      newAchievements.push('first_supplements');
    }
    if (reason === 'water_added' && !data.unlockedAchievements.includes('first_water')) {
      newAchievements.push('first_water');
    }
    if (reason === 'training_added' && !data.unlockedAchievements.includes('first_training')) {
      newAchievements.push('first_training');
    }
    if (reason === 'household_added' && !data.unlockedAchievements.includes('first_household')) {
      newAchievements.push('first_household');
    }

    // ========== LEVEL ACHIEVEMENTS ==========
    const levelMilestones = [5, 10, 15, 20, 25];
    for (const lvl of levelMilestones) {
      const achId = `level_${lvl}`;
      if (data.level >= lvl && !data.unlockedAchievements.includes(achId)) {
        newAchievements.push(achId);
      }
      if (!data.unlockedAchievements.includes(achId)) {
        updateAchievementProgress(achId, data.level, lvl);
      }
    }

    // ========== QUALITY ACHIEVEMENTS ==========

    // Perfect day (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏–∑–≤–Ω–µ —á–µ—Ä–µ–∑ checkDayCompleted)
    if (reason === 'perfect_day' && !data.unlockedAchievements.includes('perfect_day')) {
      newAchievements.push('perfect_day');
    }

    // Perfect week ‚Äî 7 –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
    if ((reason === 'perfect_day' || reason === 'day_completed') && !data.unlockedAchievements.includes('perfect_week')) {
      const perfectDays = countConsecutiveDays((dayData, dateStr) => {
        if (!dayData.meals || dayData.meals.length === 0) return false;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º ratio –≤ dailyXP –∏–ª–∏ –≤—ã—á–∏—Å–ª—è–µ–º
        const dayXP = data.dailyXP[dateStr];
        return dayXP && dayXP.perfect_day > 0;
      }, 14);

      updateAchievementProgress('perfect_week', perfectDays, 7);
      if (perfectDays >= 7) {
        newAchievements.push('perfect_week');
      }
    }

    // Balanced macros ‚Äî –≤—Å–µ –º–∞–∫—Ä–æ—Å—ã 90-110%
    if (reason === 'product_added' && !data.unlockedAchievements.includes('balanced_macros')) {
      if (HEYS.Day && HEYS.Day.getMacroBalance) {
        const balance = HEYS.Day.getMacroBalance();
        if (balance && balance.protein >= 0.9 && balance.protein <= 1.1 &&
          balance.carbs >= 0.9 && balance.carbs <= 1.1 &&
          balance.fat >= 0.9 && balance.fat <= 1.1) {
          newAchievements.push('balanced_macros');
        }
      }
    }

    // Fiber champion ‚Äî –∫–ª–µ—Ç—á–∞—Ç–∫–∞ ‚â•100% 7 –¥–Ω–µ–π
    if ((reason === 'product_added' || reason === 'day_completed') && !data.unlockedAchievements.includes('fiber_champion')) {
      const fiberDays = countConsecutiveDays((dayData) => {
        if (!dayData.meals || dayData.meals.length === 0) return false;
        // –ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º achievementProgress –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞
        return data.achievementProgress?.fiber_champion?.dates?.includes(dayData.date);
      }, 14);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –∫–ª–µ—Ç—á–∞—Ç–∫—É
      if (HEYS.Day && HEYS.Day.getFiberPercent && HEYS.Day.getFiberPercent() >= 100) {
        const today = getToday();
        if (!data.achievementProgress) data.achievementProgress = {};
        if (!data.achievementProgress.fiber_champion) {
          data.achievementProgress.fiber_champion = { current: 0, target: 7, dates: [] };
        }
        if (!data.achievementProgress.fiber_champion.dates.includes(today)) {
          data.achievementProgress.fiber_champion.dates.push(today);
          // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
          data.achievementProgress.fiber_champion.dates =
            data.achievementProgress.fiber_champion.dates.slice(-14);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        const consecutiveFiber = countConsecutiveFiberDays(data.achievementProgress.fiber_champion.dates);
        data.achievementProgress.fiber_champion.current = consecutiveFiber;
        saveData();

        if (consecutiveFiber >= 7) {
          newAchievements.push('fiber_champion');
        }
      }
    }

    // ========== WATER & ACTIVITY ACHIEVEMENTS ==========

    // Water day ‚Äî 100% –≤–æ–¥—ã
    if (reason === 'water_added' && !data.unlockedAchievements.includes('water_day')) {
      if (HEYS.Day && HEYS.Day.getWaterPercent && HEYS.Day.getWaterPercent() >= 100) {
        newAchievements.push('water_day');
      }
    }

    // Water master ‚Äî 100% –≤–æ–¥—ã 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
    if (reason === 'water_added' && !data.unlockedAchievements.includes('water_master')) {
      const waterDays = countConsecutiveDays((dayData) => {
        if (!dayData.waterMl) return false;
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ fallback 2000–º–ª
        const waterGoal = getWaterGoalForDay() || 2000;
        return dayData.waterMl >= waterGoal * 0.9;
      }, 14);

      updateAchievementProgress('water_master', waterDays, 7);
      if (waterDays >= 7) {
        newAchievements.push('water_master');
      }
    }

    // Training week ‚Äî 5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é
    if (reason === 'training_added' && !data.unlockedAchievements.includes('training_week')) {
      if (!data.weeklyTrainings) data.weeklyTrainings = { week: null, count: 0 };
      const currentWeek = getWeekStart();
      if (data.weeklyTrainings.week !== currentWeek) {
        data.weeklyTrainings = { week: currentWeek, count: 0 };
      }
      data.weeklyTrainings.count++;
      updateAchievementProgress('training_week', data.weeklyTrainings.count, 5);
      saveData();
      if (data.weeklyTrainings.count >= 5) {
        newAchievements.push('training_week');
      }
    }

    // Steps champion ‚Äî 10000+ —à–∞–≥–æ–≤ 7 –¥–Ω–µ–π
    if (!data.unlockedAchievements.includes('steps_champion')) {
      const stepsDays = countConsecutiveDays((dayData) => {
        return dayData.steps && dayData.steps >= 10000;
      }, 14);

      updateAchievementProgress('steps_champion', stepsDays, 7);
      if (stepsDays >= 7) {
        newAchievements.push('steps_champion');
      }
    }

    // ========== HABITS ACHIEVEMENTS ==========

    // Early bird ‚Äî –∑–∞–≤—Ç—Ä–∞–∫ –¥–æ 9:00 7 –¥–Ω–µ–π
    if (reason === 'product_added' && !data.unlockedAchievements.includes('early_bird')) {
      const hour = new Date().getHours();
      if (hour < 9) {
        if (!data.earlyBirdDays) data.earlyBirdDays = [];
        const today = getToday();
        if (!data.earlyBirdDays.includes(today)) {
          data.earlyBirdDays.push(today);
          data.earlyBirdDays = data.earlyBirdDays.slice(-14);
          saveData();
        }

        const consecutiveEarly = countConsecutiveFromDates(data.earlyBirdDays);
        updateAchievementProgress('early_bird', consecutiveEarly, 7);

        if (consecutiveEarly >= 7) {
          newAchievements.push('early_bird');
        }
      }
    }

    // Night owl safe ‚Äî –Ω–µ—Ç –µ–¥—ã –ø–æ—Å–ª–µ 22:00 7 –¥–Ω–µ–π
    if ((reason === 'day_completed' || reason === 'product_added') && !data.unlockedAchievements.includes('night_owl_safe')) {
      const safeDays = countConsecutiveDays((dayData) => {
        if (!dayData.meals || dayData.meals.length === 0) return false;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –µ–¥—ã –ø–æ—Å–ª–µ 22:00
        for (const meal of dayData.meals) {
          if (meal.time) {
            const [h] = meal.time.split(':').map(Number);
            if (h >= 22 || h < 3) return false; // –ü–æ—Å–ª–µ 22 –∏–ª–∏ –¥–æ 3 –Ω–æ—á–∏
          }
        }
        return true;
      }, 14);

      updateAchievementProgress('night_owl_safe', safeDays, 7);
      if (safeDays >= 7) {
        newAchievements.push('night_owl_safe');
      }
    }

    // Advice achievements ‚Äî –∑–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏–µ —Å–æ–≤–µ—Ç–æ–≤
    if (reason === 'advice_read') {
      if (!data.stats) data.stats = {};
      if (!data.stats.totalAdvicesRead) data.stats.totalAdvicesRead = 0;
      data.stats.totalAdvicesRead++;
      saveData();

      updateAchievementProgress('advice_reader', data.stats.totalAdvicesRead, 50);
      updateAchievementProgress('advice_master', data.stats.totalAdvicesRead, 200);

      if (data.stats.totalAdvicesRead >= 50 && !data.unlockedAchievements.includes('advice_reader')) {
        newAchievements.push('advice_reader');
      }
      if (data.stats.totalAdvicesRead >= 200 && !data.unlockedAchievements.includes('advice_master')) {
        newAchievements.push('advice_master');
      }
    }

    // Unlock new achievements
    if (DEBUG && newAchievements.length > 0) {
      console.log('[üéÆ Gamification] New achievements to unlock:', newAchievements);
    }
    for (const achId of newAchievements) {
      unlockAchievement(achId);
    }

    return newAchievements;
  }

  function checkStreakAchievements(streakValue, options = {}) {
    // üõ°Ô∏è FIX: –ù–µ –≤—ã–¥–∞—ë–º –∞—á–∏–≤–∫–∏ –ø–æ–∫–∞ –∏–¥—ë—Ç rebuild/–∑–∞–≥—Ä—É–∑–∫–∞
    if (_isRebuilding || _isLoadingPhase) return [];

    const data = loadData();
    const streak = typeof streakValue === 'number' ? streakValue : safeGetStreak();
    const { skipUnlock = false } = options;

    const streakMilestones = [
      { days: 1, id: 'streak_1' },
      { days: 2, id: 'streak_2' },
      { days: 3, id: 'streak_3' },
      { days: 5, id: 'streak_5' },
      { days: 7, id: 'streak_7' }
    ];

    const newly = [];
    for (const m of streakMilestones) {
      if (streak >= m.days && !data.unlockedAchievements.includes(m.id)) {
        newly.push(m.id);
      }
      if (!data.unlockedAchievements.includes(m.id)) {
        updateAchievementProgress(m.id, streak, m.days);
      }
    }

    if (!skipUnlock) {
      newly.forEach((id) => unlockAchievement(id));
    }

    return newly;
  }

  /**
   * –ü–æ–¥—Å—á—ë—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–∞—Ç
   */
  function countConsecutiveFromDates(dates) {
    if (!dates || dates.length === 0) return 0;

    const sortedDates = [...dates].sort().reverse();
    let count = 0;
    const today = new Date();

    for (let i = 0; i < 14; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().slice(0, 10);

      if (sortedDates.includes(dateStr)) {
        count++;
      } else if (i > 0) {
        break;
      }
    }

    return count;
  }

  /**
   * –ü–æ–¥—Å—á—ë—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π –∫–ª–µ—Ç—á–∞—Ç–∫–∏
   */
  function countConsecutiveFiberDays(dates) {
    return countConsecutiveFromDates(dates);
  }

  function unlockAchievement(achievementId) {
    // üõ°Ô∏è FIX: –ù–µ –≤—ã–¥–∞—ë–º –∞—á–∏–≤–∫–∏ –ø–æ–∫–∞ –∏–¥—ë—Ç rebuild –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏
    // üîí v4.0: –í–æ –≤—Ä–µ–º—è loading phase rebuild —Å–∞–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞—á–∏–≤–∫–∏ –∏–∑ –∞—É–¥–∏—Ç–∞
    if (_isRebuilding || _isLoadingPhase) return;

    // üîí FIX v2.7: Mutex ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ–¥–Ω–æ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    if (_unlockingAchievements.has(achievementId)) {
      console.warn(`[üéÆ Gamification] Blocked duplicate unlock attempt: ${achievementId}`);
      return;
    }
    _unlockingAchievements.add(achievementId);

    try {
      const data = loadData();
      const ach = ACHIEVEMENTS[achievementId];
      if (!ach || data.unlockedAchievements.includes(achievementId)) {
        _unlockingAchievements.delete(achievementId);
        return;
      }

      const beforeXP = data.totalXP;
      const beforeLevel = data.level;
      const beforeAchievements = data.unlockedAchievements.length;

      data.unlockedAchievements.push(achievementId);

      // –ù–∞—á–∏—Å–ª—è–µ–º XP –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
      const oldLevel = data.level;
      data.totalXP += ach.xp;
      data.level = calculateLevel(data.totalXP);
      const afterXP = data.totalXP;
      const afterAchievements = data.unlockedAchievements.length;
      handleRankTransition(oldLevel, data.level);

      // üîí FIX: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–µ—à –ü–ï–†–ï–î saveData() —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å race condition —Å rebuild
      _data = data;
      saveData();
      triggerImmediateSync('achievement_unlocked');

      queueGamificationEvent({
        action: 'achievement_unlocked',
        reason: achievementId,
        xpBefore: beforeXP,
        xpAfter: afterXP,
        xpDelta: ach.xp,
        levelBefore: beforeLevel,
        levelAfter: data.level,
        achievementsBefore: beforeAchievements,
        achievementsAfter: afterAchievements,
        metadata: {
          achievementId: ach.id,
          achievementName: ach.name,
          rarity: ach.rarity,
          category: ach.category
        }
      });

      const hasCategoryUnlocked = data.unlockedAchievements
        .map((id) => ACHIEVEMENTS[id])
        .filter(Boolean)
        .some((item) => item.category === ach.category);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º notification (React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç .game-notification)
      // NOTE: showAchievementToast —É–±—Ä–∞–Ω ‚Äî –±—ã–ª –¥—É–±–ª—å —Å showNotification
      showNotification('achievement', {
        achievement: ach,
        totalXP: data.totalXP,
        level: data.level,
        firstInCategory: !hasCategoryUnlocked
      });

      // –ó–≤—É–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!
      playXPSound(true); // Level-up –º–µ–ª–æ–¥–∏—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

      // Confetti –¥–ª—è rare+ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
      if (['rare', 'epic', 'legendary', 'mythic'].includes(ach.rarity)) {
        celebrate({ type: 'achievement', rarity: ach.rarity });
      }

      // Haptic –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
      if (HEYS.haptic) {
        const hapticByRarity = {
          common: 'light',
          rare: 'medium',
          epic: 'medium',
          legendary: 'success',
          mythic: 'success'
        };
        HEYS.haptic(hapticByRarity[ach.rarity] || 'light');
      }
    } finally {
      // üîì FIX v2.7: –í—Å–µ–≥–¥–∞ –æ—á–∏—â–∞–µ–º mutex, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      _unlockingAchievements.delete(achievementId);
    }
  }

  // ========== CORE API ==========

  const game = {
    /**
     * –î–æ–±–∞–≤–∏—Ç—å XP
     * @param {number} amount - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ XP (–∏–ª–∏ 0 –¥–ª—è –∞–≤—Ç–æ –∏–∑ XP_ACTIONS)
     * @param {string} reason - –ø—Ä–∏—á–∏–Ω–∞ (–∏–∑ XP_ACTIONS)
     * @param {HTMLElement} sourceEl - —ç–ª–µ–º–µ–Ω—Ç-–∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è flying animation
     */
    addXP(amount, reason, sourceEl, extraData) {
      // Debounce
      if (_debounceTimer) clearTimeout(_debounceTimer);

      _debounceTimer = setTimeout(() => {
        _addXPInternal(amount, reason, sourceEl, extraData);
      }, DEBOUNCE_MS);
    },

    getLevel() {
      return loadData().level;
    },

    getTotalXP() {
      return loadData().totalXP;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
     * @returns {{ current: number, required: number, percent: number }}
     */
    getProgress() {
      const data = loadData();
      const currentLevelXP = getXPForCurrentLevel(data.level);
      const nextLevelXP = getXPForNextLevel(data.level);

      if (nextLevelXP === null) {
        return { current: data.totalXP, required: data.totalXP, percent: 100 };
      }

      const progressXP = data.totalXP - currentLevelXP;
      const requiredXP = nextLevelXP - currentLevelXP;
      const percent = Math.min(100, Math.round((progressXP / requiredXP) * 100));

      return { current: progressXP, required: requiredXP, percent };
    },

    getLevelTitle() {
      return getLevelTitle(loadData().level);
    },

    getStats() {
      const data = loadData();
      return {
        totalXP: data.totalXP,
        level: data.level,
        title: getLevelTitle(data.level),
        progress: this.getProgress(),
        unlockedCount: data.unlockedAchievements.length,
        totalAchievements: Object.keys(ACHIEVEMENTS).length,
        stats: data.stats
      };
    },

    /** –§–∞–∑–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî –≤—Å–µ UI-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–∞–≤–ª–µ–Ω—ã */
    get isLoadingPhase() {
      return _isLoadingPhase;
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å —Å—Ç–∞—Ç—É—Å–æ–º –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
     */
    getAchievements() {
      const data = loadData();
      return Object.values(ACHIEVEMENTS).map(ach => {
        const progress = data.achievementProgress?.[ach.id] || null;
        return {
          ...ach,
          unlocked: data.unlockedAchievements.includes(ach.id),
          progress: progress ? {
            current: progress.current || 0,
            target: progress.target || 1,
            percent: progress.target ? Math.round((progress.current / progress.target) * 100) : 0
          } : null
        };
      });
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
     */
    getAchievementProgress(achId) {
      return getAchievementProgress(achId);
    },

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ" (–Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)
     */
    getInProgressAchievements() {
      const data = loadData();
      const achievements = [];

      for (const [achId, progress] of Object.entries(data.achievementProgress || {})) {
        if (!data.unlockedAchievements.includes(achId) && progress.current > 0) {
          const achDef = ACHIEVEMENTS[achId];
          if (achDef) {
            achievements.push({
              ...achDef,
              progress: {
                current: progress.current,
                target: progress.target,
                percent: Math.round((progress.current / progress.target) * 100)
              }
            });
          }
        }
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–±–ª–∏–∂–∞–π—à–∏–µ –∫ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–µ—Ä–≤—ã–µ)
      return achievements.sort((a, b) => b.progress.percent - a.progress.percent);
    },

    getAchievementCategories() {
      return ACHIEVEMENT_CATEGORIES;
    },

    isAchievementUnlocked(id) {
      return loadData().unlockedAchievements.includes(id);
    },

    // Flying animation
    flyToBar,

    // Confetti
    celebrate,

    // Notification
    showNotification,

    // –î–µ–Ω—å –≤—ã–ø–æ–ª–Ω–µ–Ω (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ ratio 0.75-1.1)
    checkDayCompleted(ratio, dateStr) {
      if (ratio >= 0.75 && ratio <= 1.1) {
        this.addXP(0, 'day_completed');
      }
      if (ratio >= 0.95 && ratio <= 1.05) {
        this.addXP(0, 'perfect_day');
      }

      // üìä –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è A/B —Ç–µ—Å—Ç–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)
      if (dateStr && HEYS.Metabolic?.recordABResult) {
        try {
          // –ß–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ localStorage (A/B –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ)
          const stored = localStorage.getItem(`heys_predicted_risk_${dateStr}`);
          const dayRisk = stored ? JSON.parse(stored) : null;
          if (dayRisk !== null && typeof dayRisk === 'number') {
            HEYS.Metabolic.recordABResult(dateStr, dayRisk, ratio);
          }
        } catch (e) {
          // –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }
      }
    },

    /**
     * üß† –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Metabolic Intelligence –º–æ–¥—É–ª—è
     */
    checkMetabolicAchievements(data) {
      const { score, risk, phenotype, weeklyWrapViewed } = data || {};

      // metabolic_stable: –æ—Ü–µ–Ω–∫–∞ ‚â•70 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥
      if (data.stableDaysCount >= 7 && !this.isAchievementUnlocked('metabolic_stable')) {
        unlockAchievement('metabolic_stable');
      }

      // low_risk_master: –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ 14 –¥–Ω–µ–π
      if (data.lowRiskDaysCount >= 14 && !this.isAchievementUnlocked('low_risk_master')) {
        unlockAchievement('low_risk_master');
      }

      // phenotype_discovered: —Ñ–µ–Ω–æ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Å confidence ‚â•70%
      if (phenotype?.confidence >= 70 && !this.isAchievementUnlocked('phenotype_discovered')) {
        unlockAchievement('phenotype_discovered');
      }

      // weekly_wrap_viewed: 4 –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á—ë—Ç–æ–≤
      const wrapViewCount = readStoredValue('heys_weekly_wrap_view_count', 0) || 0;
      if (wrapViewCount >= 4 && !this.isAchievementUnlocked('weekly_wrap_viewed')) {
        unlockAchievement('weekly_wrap_viewed');
      }
    },

    /**
     * üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ crash_avoided ‚Äî —Ä–∏—Å–∫ –±—ã–ª –≤—ã—Å–æ–∫–∏–π, –Ω–æ –¥–µ–Ω—å —É—Å–ø–µ—à–Ω—ã–π
     */
    checkCrashAvoided(hadHighRisk, daySuccessful) {
      if (hadHighRisk && daySuccessful && !this.isAchievementUnlocked('crash_avoided')) {
        unlockAchievement('crash_avoided');
      }
    },

    /**
     * üìä –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ Weekly Wrap
     */
    incrementWeeklyWrapViews() {
      const count = (readStoredValue('heys_weekly_wrap_view_count', 0) || 0) + 1;
      setStoredValue('heys_weekly_wrap_view_count', count);
      return count;
    },

    // –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    reset() {
      _data = createDefaultData();
      saveData();
      window.dispatchEvent(new CustomEvent('heysGameUpdate', { detail: this.getStats() }));
    },

    /**
     * üîÑ –†–µ—Ç—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
     * –í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–æ–≤
     */
    async recalculateAchievements() {
      const data = loadData();
      const migrationKey = 'heys_achievements_v5_migrated'; // üî• V5: —Ñ–∏–∫—Å first_meal/first_product

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è
      if (readStoredValue(migrationKey, null) === 'true') {
        console.log('[üéÆ Gamification] Migration v5 already done, skipping');
        return [];
      }

      console.log('[üéÆ Gamification] Recalculating missed achievements...');
      console.log('[üéÆ Gamification] Current state:', {
        totalXP: data.totalXP,
        level: data.level,
        unlockedCount: data.unlockedAchievements.length,
        unlocked: data.unlockedAchievements
      });

      const missedAchievements = [];
      const today = getToday(); // üî• FIX: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º today

      // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
      const streak = safeGetStreak();
      const stats = data.stats || {};

      console.log('[üéÆ Gamification] Checking streak:', streak);

      // === STREAK ACHIEVEMENTS ===
      const streakMilestones = [
        { days: 1, id: 'streak_1' },
        { days: 2, id: 'streak_2' },
        { days: 3, id: 'streak_3' },
        { days: 5, id: 'streak_5' },
        { days: 7, id: 'streak_7' }
      ];

      for (const m of streakMilestones) {
        if (streak >= m.days && !data.unlockedAchievements.includes(m.id)) {
          data.unlockedAchievements.push(m.id);
          data.totalXP += ACHIEVEMENTS[m.id].xp;
          missedAchievements.push(m.id);
        }
      }

      // === LEVEL ACHIEVEMENTS ===
      const levelMilestones = [5, 10, 15, 20, 25];
      for (const lvl of levelMilestones) {
        const achId = `level_${lvl}`;
        if (data.level >= lvl && !data.unlockedAchievements.includes(achId)) {
          data.unlockedAchievements.push(achId);
          data.totalXP += ACHIEVEMENTS[achId].xp;
          missedAchievements.push(achId);
        }
      }

      // === ONBOARDING (check stats) ===
      const todayKey = `heys_dayv2_${today}`;
      const todayDay = readStoredValue(todayKey, null);
      const mealsCount = HEYS.Day?.getMealsCount?.() || (todayDay?.meals?.length || 0);
      const stepsValue = (todayDay?.steps || 0) || (HEYS.Day?.getDay?.()?.steps || 0);
      const advicesRead = stats.totalAdvicesRead || 0;

      // üî• V5 FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ localStorage
      let hasProducts = false;
      let hasMealsWithProducts = false;
      let daysWithMealsCount = 0;
      try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –±–∞–∑–µ (heys_products)
        const productsKey = HEYS.cloud?.scopeKey ? HEYS.cloud.scopeKey('heys_products') : 'heys_products';
        const productsData = readStoredValue(productsKey, null);
        if (Array.isArray(productsData) && productsData.length > 0) {
          hasProducts = true;
        }
        console.log('[üéÆ Gamification] Products check:', { productsKey, count: productsData?.length || 0, hasProducts });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏—ë–º —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –≤ –¥–Ω—è—Ö
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key || !key.includes('_dayv2_')) continue;
          const raw = localStorage.getItem(key);
          if (!raw) continue;
          let parsed = null;
          try {
            parsed = raw.startsWith('¬§Z¬§') && HEYS.store?.decompress
              ? HEYS.store.decompress(raw.slice(3))
              : JSON.parse(raw);
          } catch (e) {
            continue;
          }
          if (parsed?.meals) {
            for (const meal of parsed.meals) {
              if (meal.items && meal.items.length > 0) {
                hasMealsWithProducts = true;
                daysWithMealsCount++;
                break;
              }
            }
          }
          if (hasMealsWithProducts && daysWithMealsCount >= 3) break; // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        }
        console.log('[üéÆ Gamification] Meals check:', { daysWithMealsCount, hasMealsWithProducts, mealsCount });
      } catch (e) {
        console.warn('[üéÆ Gamification] Error checking products:', e);
      }
      let hasCheckin = false;
      let hasSupplements = false;
      let hasHousehold = false;

      try {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key || !key.includes('_dayv2_')) continue;
          const raw = localStorage.getItem(key);
          if (!raw) continue;
          let parsed = null;
          try {
            parsed = raw.startsWith('¬§Z¬§') && HEYS.store?.decompress
              ? HEYS.store.decompress(raw.slice(3))
              : JSON.parse(raw);
          } catch (e) {
            continue;
          }
          if (parsed) {
            if (!hasCheckin && (parsed.weightMorning != null || parsed.sleepStart || parsed.sleepEnd || parsed.morningMood != null)) {
              hasCheckin = true;
            }
            if (!hasSupplements && Array.isArray(parsed.supplementsTaken) && parsed.supplementsTaken.length > 0) {
              hasSupplements = true;
            }
            if (!hasHousehold && (parsed.householdMin > 0 || (Array.isArray(parsed.householdActivities) && parsed.householdActivities.length > 0))) {
              hasHousehold = true;
            }
          }
          if (hasCheckin && hasSupplements && hasHousehold) break;
        }
      } catch (e) { }

      if (hasCheckin && !data.unlockedAchievements.includes('first_checkin')) {
        data.unlockedAchievements.push('first_checkin');
        data.totalXP += ACHIEVEMENTS.first_checkin.xp;
        missedAchievements.push('first_checkin');
      }

      console.log('[üéÆ Gamification] Onboarding checks:', {
        hasProducts,
        hasMealsWithProducts,
        mealsCount,
        hasFirstProduct: data.unlockedAchievements.includes('first_product'),
        hasFirstMeal: data.unlockedAchievements.includes('first_meal')
      });

      // üî• V5 FIX: –∏—Å–ø–æ–ª—å–∑—É–µ–º hasMealsWithProducts –≤–º–µ—Å—Ç–æ stats.totalProducts
      if (hasMealsWithProducts && !data.unlockedAchievements.includes('first_product')) {
        console.log('[üéÆ Gamification] ‚úÖ Adding first_product achievement');
        data.unlockedAchievements.push('first_product');
        data.totalXP += ACHIEVEMENTS.first_product.xp;
        missedAchievements.push('first_product');
      }

      // üî• V5 FIX: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –∏–∑ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      if ((mealsCount > 0 || hasMealsWithProducts) && !data.unlockedAchievements.includes('first_meal')) {
        console.log('[üéÆ Gamification] ‚úÖ Adding first_meal achievement');
        data.unlockedAchievements.push('first_meal');
        data.totalXP += ACHIEVEMENTS.first_meal.xp;
        missedAchievements.push('first_meal');
      }

      if (stepsValue > 0 && !data.unlockedAchievements.includes('first_steps')) {
        data.unlockedAchievements.push('first_steps');
        data.totalXP += ACHIEVEMENTS.first_steps.xp;
        missedAchievements.push('first_steps');
      }

      if (advicesRead > 0 && !data.unlockedAchievements.includes('first_advice')) {
        data.unlockedAchievements.push('first_advice');
        data.totalXP += ACHIEVEMENTS.first_advice.xp;
        missedAchievements.push('first_advice');
      }

      if (hasSupplements && !data.unlockedAchievements.includes('first_supplements')) {
        data.unlockedAchievements.push('first_supplements');
        data.totalXP += ACHIEVEMENTS.first_supplements.xp;
        missedAchievements.push('first_supplements');
      }

      if (hasHousehold && !data.unlockedAchievements.includes('first_household')) {
        data.unlockedAchievements.push('first_household');
        data.totalXP += ACHIEVEMENTS.first_household.xp;
        missedAchievements.push('first_household');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
      if (missedAchievements.length > 0) {
        data.level = calculateLevel(data.totalXP);
        saveData();
        triggerImmediateSync('achievement_unlocked'); // üî• –°—Ä–∞–∑—É –≤ –æ–±–ª–∞–∫–æ

        console.log('[üéÆ Gamification] Found missed achievements:', missedAchievements);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        this.showMissedAchievementsNotification(missedAchievements);
      }

      // –ü–æ–º–µ—á–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
      setStoredValue(migrationKey, 'true');

      return missedAchievements;
    },

    /**
     * üéâ –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö
     */
    showMissedAchievementsNotification(achievementIds) {
      if (!achievementIds || achievementIds.length === 0) return;

      const achievements = achievementIds.map(id => ACHIEVEMENTS[id]).filter(Boolean);
      const totalXP = achievements.reduce((sum, a) => sum + a.xp, 0);

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      showNotification('missed_achievements', {
        count: achievements.length,
        achievements,
        totalXP,
        title: 'üéâ –ú—ã –Ω–∞—à–ª–∏ –≤–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!',
        message: `–ò–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –≤—ã –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ ${achievements.length} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ! +${totalXP} XP`
      });

      // Confetti –¥–ª—è –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏—è
      if (achievements.length >= 2) {
        celebrate();
      }
    },

    /**
     * üîß FIX v2.5: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä—Å–∫–æ–π
     * –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ—Ç PIN session ‚Äî cloud sync –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ storage sync layer
     */
    _isCuratorMode() {
      return HEYS.auth?.isCuratorSession?.() === true ||
        !!localStorage.getItem('heys_curator_session');
    },

    /**
     * üîß FIX v2.5: –ü–æ–ª—É—á–µ–Ω–∏–µ session token —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
     * HEYS.cloud.getSessionToken –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.auth.getSessionToken
     * –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null ‚Äî –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç storage sync layer
     */
    _getSessionTokenForCloud() {
      // Priority 1: Auth module (properly JSON-parsed)
      if (HEYS.auth?.getSessionToken) {
        const token = HEYS.auth.getSessionToken();
        if (token) return token;
      }
      // Priority 2: Parse from localStorage (lsGet does JSON.parse)
      try {
        const raw = localStorage.getItem('heys_session_token');
        if (raw) {
          try { return JSON.parse(raw); } catch { return raw; }
        }
      } catch (e) { /* ignore */ }
      return null;
    },

    /**
     * üîß FIX v2.5: Unwrap PG scalar function response
     * SELECT * FROM func() wraps JSONB result in {func_name: {actual_data}}
     */
    _unwrapKvResult(rpcResult) {
      if (!rpcResult || rpcResult.error) return null;
      const data = rpcResult.data;
      if (!data || typeof data !== 'object') return null;
      // If data already has 'success' or 'value' key ‚Äî it's already unwrapped
      if ('success' in data || 'value' in data || 'found' in data) return data;
      // Unwrap single-key column wrapper (e.g. {get_client_kv_by_session: {...}})
      const keys = Object.keys(data);
      if (keys.length === 1 && data[keys[0]] && typeof data[keys[0]] === 'object') {
        return data[keys[0]];
      }
      return data;
    },

    /**
     * ‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å –æ–±–ª–∞–∫–æ–º
     * üõ°Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ–±–ª–∞–∫–æ –µ—Å–ª–∏ —Ç–∞–º –±–æ–ª—å—à–µ XP
     * üîß FIX v2.5: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ p_ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã + unwrap –æ—Ç–≤–µ—Ç–∞ + error checking
     */
    async syncToCloud() {
      const syncTrace = startGameSyncTrace('syncToCloud');
      try {
        // ÔøΩ Mutex: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –æ–±–ª–∞–∫–æ
        if (_syncInProgress) {
          console.info('[üéÆ Gamification] syncToCloud: already in progress, skipping');
          endGameSyncTrace(syncTrace, 'skipped', { reason: 'already_in_progress' });
          return false;
        }
        _syncInProgress = true;

        try {
          // ÔøΩüîß FIX v2.6: –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ cloud sync —á–µ—Ä–µ–∑ storage sync layer
          if (this._isCuratorMode()) {
            // –ö—É—Ä–∞—Ç–æ—Ä: –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ storage sync layer (heys_storage_supabase_v1.js)
            // –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç heys_game –≤ –æ–±–ª–∞–∫–æ –ø–æ–¥ scoped –∫–ª—é—á–æ–º
            gameSyncTraceStep(syncTrace, 'curator_mode:skip_direct_rpc');
            endGameSyncTrace(syncTrace, 'ok', { mode: 'curator' });
            return true;
          }

          const sessionToken = this._getSessionTokenForCloud();

          if (!HEYS.YandexAPI || !sessionToken) {
            endGameSyncTrace(syncTrace, 'skipped', { reason: 'no_api_or_session' });
            return false;
          }

          const data = loadData();

          // üõ°Ô∏è –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ
          // FIX v2.4: typeof check ‚Äî XP=0 is valid, only skip if data is truly broken
          if (typeof data.totalXP !== 'number') {
            console.log('[üéÆ Gamification] Skip cloud sync ‚Äî no XP data');
            endGameSyncTrace(syncTrace, 'skipped', { reason: 'invalid_local_data' });
            return false;
          }

          // üõ°Ô∏è –ó–ê–©–ò–¢–ê v2.1: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–ª–∞–∫–æ ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–∞–º –Ω–æ–≤–µ–µ/–±–æ–ª—å—à–µ
          try {
            // üîß FIX v2.5: p_ prefixed params + proper response unwrap
            const cloudResult = await HEYS.YandexAPI.rpc('get_client_kv_by_session', {
              p_session_token: sessionToken,
              p_key: STORAGE_KEY
            });

            if (cloudResult?.error) {
              console.warn('[üéÆ Gamification] Cloud check RPC error:', cloudResult.error?.message || cloudResult.error);
              // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é ‚Äî –ª—É—á—à–µ –∑–∞–ø–∏—Å–∞—Ç—å —á–µ–º –Ω–∏—á–µ–≥–æ
            }

            const kvData = this._unwrapKvResult(cloudResult);
            const cloudData_ = kvData?.value || {};
            const cloudXP = cloudData_.totalXP || 0;
            const cloudUpdatedAt = cloudData_.updatedAt || 0;

            // üõ°Ô∏è v2.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ "–∫–∞—á–µ—Å—Ç–≤–∞" –¥–∞–Ω–Ω—ã—Ö ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –±–æ–≥–∞—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–¥–Ω—ã–º–∏
            const cloudAchievements = Array.isArray(cloudData_.unlockedAchievements) ? cloudData_.unlockedAchievements.length : 0;
            const localAchievements = Array.isArray(data.unlockedAchievements) ? data.unlockedAchievements.length : 0;
            const cloudStatsCount = Object.keys(cloudData_.stats || {}).filter(k => cloudData_.stats[k] > 0).length;
            const localStatsCount = Object.keys(data.stats || {}).filter(k => data.stats[k] > 0).length;
            const cloudDailyXPCount = Object.keys(cloudData_.dailyXP || {}).length;
            const localDailyXPCount = Object.keys(data.dailyXP || {}).length;

            // –û–±–ª–∞–∫–æ "–±–æ–≥–∞—á–µ" –µ—Å–ª–∏: –±–æ–ª—å—à–µ XP –ò–õ–ò (XP —Ä–∞–≤–µ–Ω –ò –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π)
            const cloudIsRicher = cloudXP > data.totalXP || (
              cloudXP === data.totalXP && (
                cloudAchievements > localAchievements ||
                cloudStatsCount > localStatsCount ||
                cloudDailyXPCount > localDailyXPCount
              )
            );

            if (cloudXP > data.totalXP) {
              console.warn(`[üéÆ Gamification] BLOCKED: cloud XP (${cloudXP}) > local (${data.totalXP}), not overwriting!`);
              // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –æ–±–ª–∞–∫–∞
              await HEYS.game.loadFromCloud();
              endGameSyncTrace(syncTrace, 'ok', { reason: 'blocked_cloud_higher_xp', cloudXP, localXP: data.totalXP });
              return false;
            }

            // üõ°Ô∏è v2.2: –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –æ–±–ª–∞–∫–æ –±–æ–≥–∞—á–µ –¥–µ—Ç–∞–ª—è–º–∏ –ø—Ä–∏ —Ä–∞–≤–Ω–æ–º XP
            if (cloudXP === data.totalXP && cloudIsRicher) {
              console.warn(`[üéÆ Gamification] BLOCKED: cloud has richer data (achievements: ${cloudAchievements} vs ${localAchievements}, stats: ${cloudStatsCount} vs ${localStatsCount})`);
              await HEYS.game.loadFromCloud();
              endGameSyncTrace(syncTrace, 'ok', { reason: 'blocked_cloud_richer' });
              return false;
            }

            if (cloudUpdatedAt && data.updatedAt && cloudUpdatedAt > data.updatedAt) {
              console.warn('[üéÆ Gamification] BLOCKED: cloud data is newer, loading instead');
              await HEYS.game.loadFromCloud();
              endGameSyncTrace(syncTrace, 'ok', { reason: 'blocked_cloud_newer' });
              return false;
            }
          } catch (checkErr) {
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (–ª—É—á—à–µ —á–µ–º –Ω–∏—á–µ–≥–æ)
            console.warn('[üéÆ Gamification] Cloud check failed, proceeding:', checkErr.message);
            gameSyncTraceStep(syncTrace, 'cloud_precheck:failed_proceed', { message: checkErr.message });
          }

          const cloudData = {
            version: DATA_VERSION,
            totalXP: data.totalXP,
            level: data.level,
            unlockedAchievements: data.unlockedAchievements,
            achievementProgress: data.achievementProgress,
            dailyXP: data.dailyXP,
            dailyBonusClaimed: data.dailyBonusClaimed,
            dailyActions: data.dailyActions,
            dailyMissions: data.dailyMissions,
            weeklyChallenge: data.weeklyChallenge,
            weeklyTrainings: data.weeklyTrainings,
            earlyBirdDays: data.earlyBirdDays,
            streakShieldUsed: data.streakShieldUsed,
            stats: data.stats,
            createdAt: data.createdAt,
            updatedAt: data.updatedAt || Date.now(),
            lastUpdated: new Date().toISOString()
          };

          // üîß FIX v2.5: p_ prefixed params + error checking
          const upsertResult = await HEYS.YandexAPI.rpc('upsert_client_kv_by_session', {
            p_session_token: sessionToken,
            p_key: STORAGE_KEY,   // 'heys_game'
            p_value: cloudData    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç, –Ω–µ JSON.stringify
          });

          if (upsertResult?.error) {
            console.error('[üéÆ Gamification] Cloud upsert FAILED:', upsertResult.error?.message || upsertResult.error);
            endGameSyncTrace(syncTrace, 'error', { reason: 'upsert_failed', message: upsertResult.error?.message || upsertResult.error });
            return false;
          }

          console.info('[üéÆ Gamification] ‚úÖ Synced to cloud: XP=' + data.totalXP + ', level=' + data.level);
          endGameSyncTrace(syncTrace, 'ok', { reason: 'upsert_success', xp: data.totalXP, level: data.level });
          return true;
        } finally {
          _syncInProgress = false;
        }
      } catch (e) {
        _syncInProgress = false;
        console.warn('[üéÆ Gamification] Cloud sync failed:', e.message);
        endGameSyncTrace(syncTrace, 'error', { message: e.message });
        return false;
      }
    },

    /**
     * ‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑ –æ–±–ª–∞–∫–∞
     * üîß FIX v2.5: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ p_ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã + unwrap –æ—Ç–≤–µ—Ç–∞ + error checking
     */
    async loadFromCloud() {
      // üîí v4.0: Promise dedup ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã
      if (_loadFromCloudPromise) {
        console.info('[üéÆ Gamification] loadFromCloud: reusing existing promise');
        return _loadFromCloudPromise;
      }
      _loadFromCloudPromise = this._loadFromCloudImpl();
      try {
        return await _loadFromCloudPromise;
      } finally {
        _loadFromCloudPromise = null;
      }
    },

    async _loadFromCloudImpl() {
      const syncTrace = startGameSyncTrace('loadFromCloud');
      try {
        // üîß FIX v2.6: –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ cloud sync —á–µ—Ä–µ–∑ storage sync layer
        if (this._isCuratorMode()) {
          // –ö—É—Ä–∞—Ç–æ—Ä: –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ storage sync layer (heys_storage_supabase_v1.js)
          // –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç game data –≤ localStorage –∫–∞–∫ heys_game
          // –î–∞–Ω–Ω—ã–µ —É–∂–µ –≤ localStorage ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ
          console.info('[üéÆ Gamification] loadFromCloud: curator mode ‚Äî using storage sync layer');
          gameSyncTraceStep(syncTrace, 'mode:curator');
          _cloudLoaded = true;
          if (_pendingCloudSync) {
            _pendingCloudSync = false;
            triggerImmediateSync('pending_sync');
          }
          // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage (storage sync –º–æ–≥ –æ–±–Ω–æ–≤–∏—Ç—å)
          _data = null; // —Å–±—Ä–æ—Å–∏–º –∫–µ—à

          // üöÄ PERF v7.0: Dispatch bar update IMMEDIATELY from localStorage,
          // defer heavy audit (3-6 RPC calls, ~2-4s) to avoid competing with DayTab sync
          _data = loadData();
          const _xpCacheQuick = _loadXPCache();
          if (_xpCacheQuick && typeof _xpCacheQuick.xp === 'number' && _xpCacheQuick.xp > (_data.totalXP || 0)) {
            _data.totalXP = _xpCacheQuick.xp;
            _data.level = calculateLevel(_xpCacheQuick.xp);
            setStoredValue(STORAGE_KEY, _data);
          }
          const immediateStats = game.getStats();
          // üîí v4.0: isInitialLoad ‚Äî React –Ω–µ –ø–æ–∫–∞–∂–µ—Ç –º–æ–¥–∞–ª–∫–∏
          // RC-2 fix: reason: 'cloud_load_complete' ‚Äî —Å–Ω–∏–º–∞–µ—Ç level guard event-driven
          window.dispatchEvent(new CustomEvent('heysGameUpdate', {
            detail: { ...immediateStats, isInitialLoad: true, reason: 'cloud_load_complete' }
          }));

          // üöÄ PERF v7.0: Defer audit ‚Äî runs AFTER DayTab sync finishes (5s)
          // ensureAuditConsistency does 3-6 sequential RPC calls (~2-4s)
          // competing with bootstrapClientSync for API bandwidth
          console.info('[üéÆ Gamification] üöÄ PERF v7.0: Audit deferred 5s (not blocking DayTab sync)');
          setTimeout(async () => {
            const auditTrace = startGameSyncTrace('deferredAudit');
            _suppressUIUpdates = true;
            try {
              await ensureAuditConsistency('curator-load');
            } catch (e) {
              console.error('[üéÆ Gamification] ‚ùå Deferred audit failed:', e);
              endGameSyncTrace(auditTrace, 'error', { error: String(e) });
              return;
            } finally {
              _suppressUIUpdates = false;
            }
            // RC fix v6.2: XP cache override after audit
            if (!_data) _data = loadData();
            const _xpCacheFinal = _loadXPCache();
            if (_xpCacheFinal && typeof _xpCacheFinal.xp === 'number' && _xpCacheFinal.xp > (_data.totalXP || 0)) {
              console.info('[üéÆ Gamification] RC v6.2: XP cache override post-audit:',
                (_data.totalXP || 0), '‚Üí', _xpCacheFinal.xp);
              _data.totalXP = _xpCacheFinal.xp;
              _data.level = calculateLevel(_xpCacheFinal.xp);
              setStoredValue(STORAGE_KEY, _data);
            }
            const auditStats = game.getStats();
            if (auditStats.totalXP !== immediateStats.totalXP || auditStats.level !== immediateStats.level) {
              console.info('[üéÆ Gamification] üîÑ Audit reconciliation: XP', immediateStats.totalXP, '‚Üí', auditStats.totalXP);
              window.dispatchEvent(new CustomEvent('heysGameUpdate', {
                detail: { ...auditStats, isInitialLoad: true, reason: 'audit_reconciliation' }
              }));
            }
            endGameSyncTrace(auditTrace, 'ok', { reason: 'deferred_audit_complete' });
          }, 5000);

          endGameSyncTrace(syncTrace, 'ok', { mode: 'curator', reason: 'storage_layer_flow' });
          return true;
        }

        const sessionToken = this._getSessionTokenForCloud();

        if (!HEYS.YandexAPI || !sessionToken) {
          console.log('[üéÆ Gamification] loadFromCloud: no API or session token');
          _cloudLoaded = true; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
          if (_pendingCloudSync) {
            _pendingCloudSync = false;
            triggerImmediateSync('pending_sync');
          }
          endGameSyncTrace(syncTrace, 'skipped', { reason: 'no_api_or_session' });
          return false;
        }

        console.log('[üéÆ Gamification] loadFromCloud: fetching from cloud...');

        // –ü—Ä–æ–±—É–µ–º –æ–±–∞ –∫–ª—é—á–∞: –Ω–æ–≤—ã–π (heys_game) –∏ —Å—Ç–∞—Ä—ã–π (heys_gamification)
        let cloudData = null;

        // 1. –ù–æ–≤—ã–π –∫–ª—é—á
        // üîß FIX v2.5: p_ prefixed params + unwrap response
        const result1 = await HEYS.YandexAPI.rpc('get_client_kv_by_session', {
          p_session_token: sessionToken,
          p_key: STORAGE_KEY // 'heys_game'
        });
        gameSyncTraceStep(syncTrace, 'rpc:get_heys_game:done', { hasError: Boolean(result1?.error) });

        if (result1?.error) {
          console.warn('[üéÆ Gamification] loadFromCloud RPC error:', result1.error?.message || result1.error);
        }

        const kv1 = this._unwrapKvResult(result1);
        if (kv1?.value) {
          cloudData = typeof kv1.value === 'string' ? JSON.parse(kv1.value) : kv1.value;
          console.log('[üéÆ Gamification] loadFromCloud: found data in heys_game, XP=' + (cloudData?.totalXP ?? 'N/A'));
        }

        // 2. –°—Ç–∞—Ä—ã–π –∫–ª—é—á (fallback)
        // FIX v2.4: typeof check ‚Äî totalXP=0 is valid cloud data, not missing
        if (!cloudData || typeof cloudData.totalXP !== 'number') {
          const result2 = await HEYS.YandexAPI.rpc('get_client_kv_by_session', {
            p_session_token: sessionToken,
            p_key: 'heys_gamification'
          });
          gameSyncTraceStep(syncTrace, 'rpc:get_heys_gamification:done', { hasError: Boolean(result2?.error) });
          const kv2 = this._unwrapKvResult(result2);
          if (kv2?.value) {
            const legacyData = typeof kv2.value === 'string' ? JSON.parse(kv2.value) : kv2.value;
            if (legacyData?.totalXP > (cloudData?.totalXP || 0)) {
              cloudData = legacyData;
              console.log('[üéÆ Gamification] Found data in legacy key heys_gamification');
            }
          }
        }

        // üõ°Ô∏è –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –æ–±–ª–∞–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
        _cloudLoaded = true;
        if (_pendingCloudSync) {
          _pendingCloudSync = false;
          triggerImmediateSync('pending_sync');
        }

        // FIX v2.4: typeof check ‚Äî allow merging even when cloud totalXP=0
        if (cloudData && typeof cloudData.totalXP === 'number') {
          const localData = loadData();
          const merged = mergeGameData(localData, cloudData);

          _data = merged;
          setStoredValue(STORAGE_KEY, _data);
          // v61: Persist merged XP to cache immediately to prevent drift in ensureAuditConsistency
          _saveXPCache(merged.totalXP || 0, merged._lastKnownEventCount || 0);
          _cloudLoaded = true;

          window.dispatchEvent(new CustomEvent('heysGameUpdate', {
            detail: { ...game.getStats(), isInitialLoad: _isLoadingPhase }
          }));

          // ÔøΩ v3.0: –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî lightweight consistency check
          // –ó–∞–º–µ–Ω—è–µ—Ç –¥–≤–æ–π–Ω–æ–π rebuild (setTimeout + ensureAuditConsistency)
          ensureAuditConsistency('cloud-merge');

          endGameSyncTrace(syncTrace, 'ok', {
            reason: 'cloud_merge',
            cloudXP: cloudData.totalXP,
            mergedXP: _data?.totalXP || 0
          });
          return true;
        }

        // FIX v2.4: –î–∞–∂–µ –µ—Å–ª–∏ cloud –ø—É—Å—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∞—É–¥–∏—Ç–∞
        console.info('[üéÆ Gamification] No cloud data, attempting audit rebuild...');
        ensureAuditConsistency('cloud-empty');

        endGameSyncTrace(syncTrace, 'ok', { reason: 'cloud_empty_audit_consistency' });
        return false;
      } catch (e) {
        _cloudLoaded = true; // –ü–æ–º–µ—á–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (_pendingCloudSync) {
          _pendingCloudSync = false;
          triggerImmediateSync('pending_sync');
        }
        console.warn('[üéÆ Gamification] Cloud load failed:', e.message);
        endGameSyncTrace(syncTrace, 'error', { message: e.message });
        return false;
      }
    },

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è UI
    ACHIEVEMENTS,
    ACHIEVEMENT_CATEGORIES,
    RARITY_COLORS,
    LEVEL_TITLES,
    XP_ACTIONS,
    RANK_BADGES,

    // üîä Sound settings API
    getSoundSettings: loadSoundSettings,
    setSoundSettings: saveSoundSettings,

    // üìä Achievement progress API
    getAchievementProgress(achId) {
      const data = loadData();
      return data.achievementProgress?.[achId] || null;
    },

    getAllAchievementProgress() {
      const data = loadData();
      return data.achievementProgress || {};
    },

    // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    getRankBadge,
    getXPMultiplier,
    canClaimDailyBonus,
    refreshDailyBonusFromAudit,
    claimDailyBonus,
    isNewStreakRecord,
    getNextLevelTitle,
    getAllTitles,

    // Daily Action Multiplier
    getDailyMultiplier,
    incrementDailyActions,

    // Weekly challenge
    getWeeklyChallenge,
    updateWeeklyProgress,
    WEEKLY_CHALLENGE_TYPES,

    // Daily Missions (pool ‚Üí HEYS.missions module)
    getDailyMissions,
    updateDailyMission,
    claimDailyMissionsBonus,
    recalculateDailyMissionsProgress,

    // üìä Get mission statistics (completion rates, favorites)
    getMissionStats() {
      const data = loadData();
      const stats = data.missionStats || {
        totalAttempts: 0,
        totalCompleted: 0,
        byType: {},
        completionRate: 0,
        favoriteCategories: [],
        lastUpdated: null
      };

      // Recalculate favorite categories based on completion rates
      const categoryStats = {};
      const CATEGORY_META = HEYS.missions?.CATEGORY_META || {};

      Object.entries(stats.byType).forEach(([type, typeStats]) => {
        const mission = (HEYS.missions?.DAILY_MISSION_POOL || []).find(m => m.type === type);
        if (mission && mission.category) {
          if (!categoryStats[mission.category]) {
            categoryStats[mission.category] = { attempts: 0, completed: 0 };
          }
          categoryStats[mission.category].attempts += typeStats.attempts;
          categoryStats[mission.category].completed += typeStats.completed;
        }
      });

      const favorites = Object.entries(categoryStats)
        .map(([cat, catStats]) => ({
          category: cat,
          label: CATEGORY_META[cat]?.label || cat,
          emoji: CATEGORY_META[cat]?.emoji || 'üìã',
          attempts: catStats.attempts,
          completed: catStats.completed,
          completionRate: catStats.attempts > 0
            ? Math.round((catStats.completed / catStats.attempts) * 100)
            : 0
        }))
        .sort((a, b) => b.completionRate - a.completionRate)
        .slice(0, 3);

      return {
        ...stats,
        favoriteCategories: favorites
      };
    },

    // üìä Calculate behavior metrics (for adaptive missions)
    calculateBehaviorMetrics,

    // Achievement Progress (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é)
    getInProgressAchievements() {
      const data = loadData();
      const achievements = [];

      for (const [achId, progress] of Object.entries(data.achievementProgress || {})) {
        if (!data.unlockedAchievements.includes(achId) && progress.current > 0) {
          const achDef = ACHIEVEMENTS[achId];
          if (achDef) {
            achievements.push({
              ...achDef,
              progress: {
                current: progress.current,
                target: progress.target,
                percent: Math.round((progress.current / progress.target) * 100)
              }
            });
          }
        }
      }

      return achievements.sort((a, b) => b.progress.percent - a.progress.percent);
    },

    // Floating XP
    showFloatingXP,

    // XP Sound
    playXPSound,

    // XP History (7 days)
    getXPHistory,

    // Audit History (cloud)
    getAuditHistory: fetchGamificationHistory,

    // üîß FIX v2.4: Rebuild XP from audit log (source of truth)
    rebuildXPFromAudit,

    // Streak Shield
    canUseStreakShield,
    useStreakShield,
    getStreakShieldStatus,

    // XP Breakdown
    getXPBreakdown,

    // Level-up Preview
    getLevelUpPreview,

    // Streak achievements
    checkStreakAchievements,

    // üîç Debug: –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è XP
    async verifyXP() {
      try {
        console.group('üîç [HEYS.game] XP Verification');
        const data = loadData();
        const cachedXP = data.totalXP || 0;
        console.log('üìä UI (localStorage):', cachedXP, 'XP');
        console.log('üìä Level:', data.level, '/', calculateLevel(cachedXP));
        console.log('üìä Achievements:', data.unlockedAchievements?.length || 0);

        // Fetch audit
        await flushAuditQueue();
        const allEvents = [];
        let offset = 0;
        const PAGE_SIZE = 500;
        for (let page = 0; page < 20; page++) {
          const result = await fetchGamificationHistory({ limit: PAGE_SIZE, offset });
          const items = result?.items || [];
          if (items.length === 0) break;
          allEvents.push(...items);
          offset += items.length;
          if (items.length < PAGE_SIZE) break;
        }

        // Calculate from audit
        let auditXP = 0;
        const seenAch = new Set();
        const breakdown = { xp_gain: 0, daily_bonus: 0, achievements: 0, rebuilds: 0 };
        allEvents.forEach(e => {
          const delta = e.xp_delta || 0;
          if (e.action === 'xp_gain' && delta > 0) {
            auditXP += delta;
            breakdown.xp_gain += delta;
          } else if (e.action === 'daily_bonus' && delta > 0) {
            auditXP += delta;
            breakdown.daily_bonus += delta;
          } else if (e.action === 'achievement_unlocked' && e.reason && delta > 0) {
            if (!seenAch.has(e.reason)) {
              seenAch.add(e.reason);
              auditXP += delta;
              breakdown.achievements += delta;
            }
          } else if (e.action === 'xp_rebuild' && delta > 0) {
            breakdown.rebuilds += delta;
          }
        });

        console.log('üìä Audit XP:', auditXP);
        console.log('   - xp_gain:', breakdown.xp_gain);
        console.log('   - daily_bonus:', breakdown.daily_bonus);
        console.log('   - achievements:', breakdown.achievements, `(${seenAch.size} unique)`);
        console.log('   - rebuilds:', breakdown.rebuilds, '(–Ω–µ –≤—Ö–æ–¥—è—Ç –≤ total)');
        console.log('üìä Drift:', cachedXP - auditXP, cachedXP > auditXP ? '(UI > audit)' : '(audit > UI)');
        console.log('üìä Total events:', allEvents.length);

        // –î—É–±–ª–∏–∫–∞—Ç—ã –∞—á–∏–≤–æ–∫
        const achDupes = {};
        allEvents.forEach(e => {
          if (e.action === 'achievement_unlocked' && e.reason) {
            achDupes[e.reason] = (achDupes[e.reason] || 0) + 1;
          }
        });
        const dupes = Object.entries(achDupes).filter(([_, count]) => count > 1);
        if (dupes.length > 0) {
          console.warn('‚ö†Ô∏è Duplicate achievements:');
          dupes.forEach(([ach, count]) => console.warn(`   - ${ach}: ${count}x`));
          console.log('üí° Cleanup: await HEYS.game.cleanupDuplicateAchievements()');
        }

        console.groupEnd();
        return { cachedXP, auditXP, drift: cachedXP - auditXP, breakdown, dupes, events: allEvents.length };
      } catch (err) {
        console.error('‚ùå verifyXP failed:', err);
        console.groupEnd();
        return { error: err.message };
      }
    },

    // üßπ Cleanup: —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏ –∞—á–∏–≤–æ–∫ –∏–∑ localStorage + audit log
    async cleanupDuplicateAchievements() {
      console.group('üßπ [HEYS.game] Cleanup Duplicate Achievements');
      try {
        const data = loadData();
        let changed = false;

        // ‚úÖ STEP 1: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è unlockedAchievements –≤ localStorage
        const beforeCount = data.unlockedAchievements.length;
        const beforeUnique = new Set(data.unlockedAchievements).size;

        if (beforeCount > beforeUnique) {
          console.warn(`Found ${beforeCount - beforeUnique} duplicates in localStorage unlockedAchievements`);
          data.unlockedAchievements = [...new Set(data.unlockedAchievements)];
          changed = true;
          console.log(`‚úÖ Deduplicated: ${beforeCount} ‚Üí ${data.unlockedAchievements.length}`);
        }

        // ‚úÖ STEP 2: Scan audit log for duplicates
        await flushAuditQueue();
        const allEvents = [];
        let offset = 0;
        for (let page = 0; page < 20; page++) {
          const result = await fetchGamificationHistory({ limit: 100, offset });
          const items = result?.items || [];
          if (items.length === 0) break;
          allEvents.push(...items);
          offset += items.length;
          if (items.length < 100) break;
        }

        const achEvents = {};
        allEvents.forEach(e => {
          if (e.action === 'achievement_unlocked' && e.reason) {
            if (!achEvents[e.reason]) achEvents[e.reason] = [];
            achEvents[e.reason].push(e);
          }
        });

        const auditDupes = [];
        for (const [achId, events] of Object.entries(achEvents)) {
          if (events.length > 1) {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–µ—Ä–≤–æ–µ ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –¥—É–±–ª–∏
            events.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            auditDupes.push(...events.slice(1));
          }
        }

        if (auditDupes.length > 0) {
          console.warn(`Found ${auditDupes.length} duplicate achievement events in audit log:`);
          const grouped = {};
          auditDupes.forEach(e => {
            grouped[e.reason] = (grouped[e.reason] || 0) + 1;
          });
          Object.entries(grouped).forEach(([ach, count]) => {
            console.warn(`  - ${ach}: ${count} duplicates`);
          });
          console.log('‚ö†Ô∏è Audit log cleanup requires RPC delete_gamification_events() - not implemented yet');
          console.table(auditDupes.slice(0, 10).map(e => ({
            id: e.id,
            reason: e.reason,
            created_at: e.created_at
          })));
        }

        // ‚úÖ STEP 3: Check XP drift (UI vs audit)
        let auditXP = 0;
        const seenAch = new Set();
        allEvents.forEach(e => {
          const delta = e.xp_delta || 0;
          if (e.action === 'xp_gain' && delta > 0) {
            auditXP += delta;
          } else if (e.action === 'daily_bonus' && delta > 0) {
            auditXP += delta;
          } else if (e.action === 'achievement_unlocked' && e.reason && delta > 0) {
            if (!seenAch.has(e.reason)) {
              seenAch.add(e.reason);
              auditXP += delta;
            }
          }
        });

        const drift = data.totalXP - auditXP;
        const needsRebuild = changed || Math.abs(drift) > 0;

        console.log(`üìä XP Check: UI=${data.totalXP}, Audit=${auditXP}, Drift=${drift}`);

        // ‚úÖ STEP 4: Rebuild XP from audit if needed
        if (needsRebuild) {
          if (drift !== 0) {
            console.warn(`‚ö†Ô∏è XP drift detected: ${drift > 0 ? '+' : ''}${drift} XP (${drift > 0 ? 'UI > audit' : 'audit > UI'})`);
          }
          console.log('üîÑ Rebuilding XP from audit (source of truth)...');

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–µ—Å–ª–∏ –±—ã–ª changed)
          if (changed) {
            saveData();
            triggerImmediateSync('achievements_cleanup');
          }

          // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º XP –∏–∑ audit (trustAudit=true ‚Äî audit –∫–∞–∫ source of truth)
          await rebuildXPFromAudit({ force: true, trustAudit: true });

          console.log('‚úÖ Cleanup complete, XP rebuilt from audit');
        } else {
          console.log('‚úÖ No duplicates or drift found ‚Äî system consistent');
        }

        console.groupEnd();
        return {
          localStorageDupes: beforeCount - beforeUnique,
          auditDupes: auditDupes.length,
          drift,
          xpRebuilt: needsRebuild
        };
      } catch (err) {
        console.error('‚ùå Cleanup failed:', err);
        console.groupEnd();
        return { error: err.message };
      }
    },

    /**
     * üîß –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ audit log
     * @returns {Promise<Array>} –í—Å–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –∞—É–¥–∏—Ç–∞
     */
    async _getAllAuditEvents() {
      await flushAuditQueue();
      const allEvents = [];
      let offset = 0;
      const PAGE_SIZE = 500;

      for (let page = 0; page < 20; page++) {
        const result = await fetchGamificationHistory({ limit: PAGE_SIZE, offset });
        const items = result?.items || [];
        if (items.length === 0) break;
        allEvents.push(...items);
        offset += items.length;
        if (items.length < PAGE_SIZE) break;
      }

      return allEvents;
    },

    /**
     * üîß –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–æ–ª—É—á–µ–Ω–∏–µ curator_id –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏
     * @returns {string|null} ID –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ null
     */
    _getCuratorId() {
      try {
        const tokenJson = localStorage.getItem('heys_supabase_auth_token');
        if (!tokenJson) return null;

        const tokenData = JSON.parse(tokenJson);
        return tokenData?.user?.id || null;
      } catch (e) {
        console.error('[HEYS.game] Failed to parse curator session:', e);
        return null;
      }
    },

    /**
     * üÜï –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑ audit log —á–µ—Ä–µ–∑ RPC (—Ç—Ä–µ–±—É–µ—Ç curator auth)
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç delete_gamification_events_by_curator –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∏–∑ –ë–î
     * 
     * @returns {Promise<{deleted: number, eventIds: string[]}>}
     */
    async deleteDuplicateAuditEvents() {
      console.log('üóëÔ∏è [HEYS.game] Delete Duplicate Audit Events');

      try {
        // STEP 1: –°–æ–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑ audit
        const allEvents = await this._getAllAuditEvents();
        const achievementEvents = allEvents.filter(e => e.action === 'achievement_unlocked');

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ reason (achievement_id)
        const grouped = {};
        achievementEvents.forEach(event => {
          const key = event.reason;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(event);
        });

        // –ù–∞—Ö–æ–¥–∏–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–º–µ—á–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ)
        const duplicateIds = [];
        Object.entries(grouped).forEach(([achievementId, events]) => {
          if (events.length > 1) {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ created_at (ASC = —Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            events.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            // –ü–µ—Ä–≤–æ–µ –æ—Å—Ç–∞–≤–ª—è–µ–º, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–¥–∞–ª—è–µ–º
            const toDelete = events.slice(1).map(e => e.id);
            duplicateIds.push(...toDelete);
          }
        });

        if (duplicateIds.length === 0) {
          console.log('‚úÖ No audit duplicates found');
          return { deleted: 0, eventIds: [] };
        }

        console.log(`üìä Found ${duplicateIds.length} duplicate events to delete`);
        console.table(duplicateIds.map(id => {
          const event = achievementEvents.find(e => e.id === id);
          return {
            id,
            reason: event?.reason || 'unknown',
            created_at: event?.created_at || 'unknown'
          };
        }));

        // STEP 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º curator auth
        const { curatorToken } = getAuditContext();
        const curatorId = this._getCuratorId();

        if (!curatorToken || !curatorId) {
          console.error('‚ùå Curator auth required (JWT token + curatorId)');
          return { error: 'curator_auth_required' };
        }

        console.log(`üîê Using curator_id: ${curatorId.slice(0, 8)}...`);

        // STEP 3: –í—ã–∑—ã–≤–∞–µ–º RPC –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        const result = await HEYS.YandexAPI.rpc('delete_gamification_events_by_curator', {
          p_curator_id: curatorId,
          p_event_ids: duplicateIds
        });

        if (result?.error) {
          console.error('‚ùå RPC delete failed:', result.error);
          return { error: result.error?.message || 'RPC failed' };
        }

        const payload = result?.data || {};
        const deletedCount = payload.deleted_count || 0;

        console.log(`‚úÖ Deleted ${deletedCount} events from audit log`);

        return {
          deleted: deletedCount,
          eventIds: payload.event_ids || duplicateIds
        };

      } catch (err) {
        console.error('‚ùå Delete audit events failed:', err);
        return { error: err.message };
      }
    }
  };

  // ========== INTERNAL ==========

  function _addXPInternal(amount, reason, sourceEl, extraData) {
    // ÔøΩ v4.0: –ù–µ –Ω–∞—á–∏—Å–ª—è–µ–º XP –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî rebuild –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é
    if (_isLoadingPhase) return;
    // ÔøΩüõ°Ô∏è Dedup guard: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (DOM event + –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤)
    const now = Date.now();
    const dedupKey = reason + '_' + (extraData?.dedupId || '');
    if (dedupKey === _lastAddXPKey && (now - _lastAddXPTime) < DEDUP_WINDOW_MS) {
      console.info('[üéÆ GAME] Dedup: skipping duplicate', reason, 'within', DEDUP_WINDOW_MS, 'ms');
      return;
    }
    _lastAddXPKey = dedupKey;
    _lastAddXPTime = now;

    const data = loadData();
    const action = XP_ACTIONS[reason];
    const today = getToday();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º daily tracking
    if (!data.dailyXP[today]) {
      data.dailyXP[today] = {};
    }

    // üéØ Update daily missions BEFORE checking XP limit
    // (–º–∏—Å—Å–∏–∏ –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ª–∏–º–∏—Ç–∞ XP)
    if (reason !== 'daily_mission' && reason !== 'daily_missions_bonus') {
      let missionValue = 0;
      if (reason === 'water_added') {
        missionValue = HEYS.Day?.getWaterPercent?.() || 0;
      }
      if (reason === 'steps_updated') {
        missionValue = extraData?.steps || 0;
      }
      updateDailyMission(reason, missionValue);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∑–∞ –¥–µ–Ω—å (–¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è XP)
    if (action) {
      const dailyCount = data.dailyXP[today][reason] || 0;
      if (dailyCount >= action.maxPerDay) {
        // –õ–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç XP, –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ–º (–Ω–æ –º–∏—Å—Å–∏—è —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤—ã—à–µ!)
        saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–∏—Å—Å–∏–∏
        return;
      }
      data.dailyXP[today][reason] = dailyCount + 1;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º XP —Å —É—á—ë—Ç–æ–º multiplier
    let xpToAdd = amount > 0 ? amount : (action ? action.xp : 0);
    if (xpToAdd <= 0) return;

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –¥–Ω–µ–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    const dailyInfo = incrementDailyActions();

    // –ü—Ä–∏–º–µ–Ω—è–µ–º multiplier –æ—Ç streak
    const streakMultiplier = getXPMultiplier();
    // –ü—Ä–∏–º–µ–Ω—è–µ–º daily multiplier (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞ –¥–µ–Ω—å)
    const totalMultiplier = streakMultiplier * dailyInfo.multiplier;
    xpToAdd = Math.round(xpToAdd * totalMultiplier);

    // Floating XP animation (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –±–æ–Ω—É—Å)
    const hasBonus = dailyInfo.multiplier > 1;
    const useReactXPFX = HEYS.game?.useReactXPFX === true;

    dispatchXpGainedEvent(xpToAdd, sourceEl);

    if (!useReactXPFX) {
      showFloatingXP(sourceEl, xpToAdd, hasBonus);
    }

    const oldLevel = data.level;
    const beforeXP = data.totalXP;
    const beforeAchievements = data.unlockedAchievements.length;
    const oldProgress = game.getProgress();
    data.totalXP += xpToAdd;
    data.level = calculateLevel(data.totalXP);
    const afterXP = data.totalXP;
    const afterAchievements = data.unlockedAchievements.length;

    // üîÑ v3.1: –û–±–Ω–æ–≤–ª—è–µ–º _dailyXPTotals –¥–ª—è realtime –≥—Ä–∞—Ñ–∏–∫–∞
    if (!data._dailyXPTotals) data._dailyXPTotals = {};
    data._dailyXPTotals[today] = (data._dailyXPTotals[today] || 0) + xpToAdd;

    // –û–±–Ω–æ–≤–ª—è–µ–º stats
    if (reason === 'product_added') data.stats.totalProducts++;
    if (reason === 'water_added') data.stats.totalWater++;
    if (reason === 'training_added') data.stats.totalTrainings++;
    if (reason === 'perfect_day') data.stats.perfectDays++;

    // Best streak
    const streak = safeGetStreak();
    if (streak > data.stats.bestStreak) {
      data.stats.bestStreak = streak;
    }

    // Weekly challenge tracking
    addWeeklyXP(xpToAdd);

    // Update weekly progress for specific actions
    if (['product_added', 'water_added', 'training_added', 'perfect_day'].includes(reason)) {
      updateWeeklyProgress(reason, { waterPercent: HEYS.Day?.getWaterPercent?.() || 0 });
    }

    saveData();
    triggerImmediateSync('xp_gain');

    queueGamificationEvent({
      action: 'xp_gain',
      reason,
      xpBefore: beforeXP,
      xpAfter: afterXP,
      xpDelta: xpToAdd,
      levelBefore: oldLevel,
      levelAfter: data.level,
      achievementsBefore: beforeAchievements,
      achievementsAfter: afterAchievements,
      metadata: {
        streakMultiplier,
        dailyMultiplier: dailyInfo.multiplier,
        dailyActions: dailyInfo.actions
      }
    });

    // Haptic
    if (HEYS.haptic) HEYS.haptic('light');

    // Flying animation
    if (!useReactXPFX) {
      flyToBar(sourceEl, xpToAdd);
    }

    // XP Sound
    playXPSound(false);

    const newProgress = game.getProgress();
    if (oldLevel === data.level) {
      const thresholds = [25, 50, 75];
      const crossed = thresholds.filter((t) => oldProgress.percent < t && newProgress.percent >= t);
      if (crossed.length > 0) {
        const milestone = crossed[crossed.length - 1];
        if (HEYS.haptic) HEYS.haptic('light');
        window.dispatchEvent(new CustomEvent('heysProgressMilestone', {
          detail: { milestone, percent: newProgress.percent }
        }));
      }
    }

    // Dispatch update event
    window.dispatchEvent(new CustomEvent('heysGameUpdate', {
      detail: {
        xpGained: xpToAdd,
        reason,
        totalXP: data.totalXP,
        level: data.level,
        progress: game.getProgress()
      }
    }));

    // Level up notification
    if (data.level > oldLevel) {
      // üî• LEVEL UP ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É!
      triggerImmediateSync('level_up');

      handleRankTransition(oldLevel, data.level);
      const title = getLevelTitle(data.level);

      queueGamificationEvent({
        action: 'level_up',
        reason,
        xpBefore: beforeXP,
        xpAfter: afterXP,
        xpDelta: xpToAdd,
        levelBefore: oldLevel,
        levelAfter: data.level,
        achievementsBefore: beforeAchievements,
        achievementsAfter: afterAchievements,
        metadata: {
          title: title.title,
          icon: title.icon
        }
      });

      // Level-up sound!
      playXPSound(true);

      showNotification('level_up', {
        newLevel: data.level,
        title: title.title,
        icon: title.icon,
        color: title.color
      });

      // Confetti –Ω–∞ —É—Ä–æ–≤–Ω—è—Ö –∫—Ä–∞—Ç–Ω—ã—Ö 5
      if (data.level % 5 === 0) {
        celebrate();
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    checkAchievements(reason);
  }

  // ========== EVENT LISTENERS ==========

  function handlePassiveEvent(reason, payload) {
    if (reason === 'steps_updated') {
      const stepsValue = payload?.steps || 0;
      updateDailyMission('steps_updated', stepsValue);
    }
    checkAchievements(reason);
  }

  // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
  window.addEventListener('heysProductAdded', (e) => {
    game.addXP(0, 'product_added', e.detail?.sourceEl);
  });

  window.addEventListener('heysMealAdded', (e) => {
    game.addXP(0, 'meal_added', e.detail?.sourceEl);
  });

  window.addEventListener('heysStepsUpdated', (e) => {
    game.addXP(0, 'steps_updated', e.detail?.sourceEl, { steps: e.detail?.steps || 0 });
  });

  window.addEventListener('heys:checkin-complete', (e) => {
    game.addXP(0, 'checkin_complete', e.detail?.sourceEl);
  });

  window.addEventListener('heysSupplementsTaken', (e) => {
    game.addXP(0, 'supplements_taken', e.detail?.sourceEl);
  });

  window.addEventListener('heysWaterAdded', (e) => {
    game.addXP(0, 'water_added', e.detail?.sourceEl);
  });

  window.addEventListener('heysTrainingAdded', (e) => {
    game.addXP(0, 'training_added', e.detail?.sourceEl);
  });

  window.addEventListener('heysHouseholdActivityAdded', (e) => {
    game.addXP(0, 'household_added', e.detail?.sourceEl);
  });

  window.addEventListener('heysSleepLogged', (e) => {
    game.addXP(0, 'sleep_logged', e.detail?.sourceEl);
  });

  window.addEventListener('heysWeightLogged', (e) => {
    game.addXP(0, 'weight_logged', e.detail?.sourceEl);
  });

  // üîÑ –ö–†–ò–¢–ò–ß–ù–û: –°–ª—É—à–∞–µ–º sync –∏–∑ –æ–±–ª–∞–∫–∞ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–µ—à —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
  let _initialSyncDone = false; // –§–ª–∞–≥ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  let _lastSyncTime = 0; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ sync (–¥–ª—è cooldown)
  const SYNC_COOLDOWN_MS = 5000; // 5 —Å–µ–∫—É–Ω–¥ cooldown –º–µ–∂–¥—É —Ä–µ–∞–∫—Ü–∏—è–º–∏ –Ω–∞ sync

  window.addEventListener('heysSyncCompleted', (e) => {
    const syncTrace = startGameSyncTrace('event:heysSyncCompleted');
    const now = Date.now();

    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–µ stats –î–û —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞
    const oldStats = _data ? game.getStats() : null;
    const oldXP = oldStats?.totalXP || 0;
    const oldLevel = oldStats?.level || 0;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º in-memory –∫–µ—à ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º loadData() –ø—Ä–æ—á–∏—Ç–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
    _data = null;

    // üîí –ü—Ä–∏ –ü–ï–†–í–û–ô —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ù–ï –¥–∏—Å–ø–∞—Ç—á–∏–º heysGameUpdate
    // GamificationBar —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ localStorage
    // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ UI –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (!_initialSyncDone) {
      _initialSyncDone = true;
      _lastSyncTime = now;

      // üîÑ FIX v2.3: –ü—Ä–∏ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –æ–±–ª–∞–∫–∞
      // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫—Ä–æ—Å—Å-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ–Ω–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
      // RC-6 fix: –±—ã–ª fire-and-forget .catch(()=>{}). –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–∏—Å–ø–∞—Ç—á–∏–º guard-release
      // —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è XP‚Ä¶' –≤–µ—á–Ω–æ –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ.
      if (HEYS.game?.loadFromCloud) {
        HEYS.game.loadFromCloud().catch(() => {
          // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî —Å–Ω–∏–º–∞–µ–º guard —Å —Ç–µ–º —á—Ç–æ –µ—Å—Ç—å –≤ localStorage
          const fallbackStats = game.getStats();
          window.dispatchEvent(new CustomEvent('heysGameUpdate', {
            detail: { ...fallbackStats, isInitialLoad: true, reason: 'cloud_load_complete' }
          }));
        });
      }
      endGameSyncTrace(syncTrace, 'ok', { reason: 'initial_sync_deferred_load' });
      return;
    }

    // üîí Cooldown: –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ sync –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ < 2 —Å–µ–∫—É–Ω–¥
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —É–º–µ–Ω—å—à–∏–ª–∏ cooldown c 5 —Å–µ–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
    if (now - _lastSyncTime < 2000) {
      endGameSyncTrace(syncTrace, 'skipped', { reason: 'cooldown' });
      return;
    }
    _lastSyncTime = now;

    // üîÑ FIX v2.3: –ü—Ä–∏ –∫–∞–∂–¥–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
    // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫—Ä–æ—Å—Å-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ–Ω–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    if (HEYS.game?.loadFromCloud) {
      HEYS.game.loadFromCloud().then(() => {
        // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ stats –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞
        const newStats = game.getStats();

        // üîí –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ù–ï –¥–∏—Å–ø–∞—Ç—á–∏–º heysGameUpdate –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        if (oldStats &&
          newStats.totalXP === oldXP &&
          newStats.level === oldLevel) {
          endGameSyncTrace(syncTrace, 'ok', { reason: 'no_ui_changes_after_load' });
          return;
        }

        // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (GamificationBar –ø–µ—Ä–µ—á–∏—Ç–∞–µ—Ç stats)
        window.dispatchEvent(new CustomEvent('heysGameUpdate', {
          detail: { ...newStats, isInitialLoad: _isLoadingPhase }
        }));
        endGameSyncTrace(syncTrace, 'ok', {
          reason: 'ui_updated_after_load',
          oldXP,
          newXP: newStats.totalXP,
          oldLevel,
          newLevel: newStats.level
        });
      }).catch(() => {
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        const newStats = game.getStats();
        if (!oldStats || newStats.totalXP !== oldXP || newStats.level !== oldLevel) {
          window.dispatchEvent(new CustomEvent('heysGameUpdate', {
            detail: { ...newStats, isInitialLoad: _isLoadingPhase }
          }));
        }
        endGameSyncTrace(syncTrace, 'error', { reason: 'load_failed_fallback_ui' });
      });
      return;
    }

    // Fallback –µ—Å–ª–∏ loadFromCloud –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    const newStats = game.getStats();
    if (!oldStats || newStats.totalXP !== oldXP || newStats.level !== oldLevel) {
      window.dispatchEvent(new CustomEvent('heysGameUpdate', {
        detail: { ...newStats, isInitialLoad: _isLoadingPhase }
      }));
    }
    endGameSyncTrace(syncTrace, 'ok', { reason: 'fallback_without_loadFromCloud' });
  });

  // ========== CLIENT SWITCH (Bug fix v3.1 ‚Üí v4.0) ==========
  // –ö—É—Ä–∞—Ç–æ—Ä –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–µ—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  window.addEventListener('heys:client-changed', (e) => {
    const newClientId = e?.detail?.clientId || 'unknown';
    console.info('[üéÆ Gamification] üîÑ Client changed ‚Üí', newClientId);

    // üîí v4.0: –ë–ª–æ–∫–∏—Ä—É–µ–º –í–°–ï UI-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    _isLoadingPhase = true;

    // 1. –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å in-memory –∫–µ—à–∞
    _data = null;
    _cloudLoaded = false;
    _auditRebuildDone = false;
    _initialSyncDone = false;
    _pendingCloudSync = false;
    _suppressUIUpdates = false;
    // RC fix v6.1: _ensureAuditLastRun –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞!
    // Throttle (30s) –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª audit –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí cloud_load_complete —Å 0 XP –∏–∑ localStorage.
    _ensureAuditLastRun = 0;
    // RC fix v6.1: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º dedup-–ø—Ä–æ–º–∏—Å ‚Äî –∏–Ω–∞—á–µ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
    // –Ω–æ–≤—ã–π heysSyncCompleted –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ä—ã–π promise —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.
    _loadFromCloudPromise = null;

    // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ localStorage (–±—É–¥—É—Ç —Å–≤–µ–∂–∏–µ —á–µ—Ä–µ–∑ storage layer)
    const freshData = loadData();

    // 3. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –¥–∏—Å–ø–∞—Ç—á–∏–º UI-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ (isInitialLoad ‚Üí React –Ω–µ –ø–æ–∫–∞–∂–µ—Ç –º–æ–¥–∞–ª–∫–∏)
    const newStats = game.getStats();
    window.dispatchEvent(new CustomEvent('heysGameUpdate', {
      detail: { ...newStats, reason: 'client_changed', isInitialLoad: true }
    }));

    // 4. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–ª–∞—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª rebuild)
    // üöÄ PERF v6.0: –£–±—Ä–∞–ª–∏ loadFromCloud –æ—Ç—Å—é–¥–∞, —Ç–∞–∫ –∫–∞–∫ heysSyncCompleted —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
    // –∏ –≤—ã–∑–æ–≤–µ—Ç loadFromCloud. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É.
    //
    // RC fix v6.3: –ù–∞ page-refresh heysSyncCompleted –ù–ï –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ—Å–ª–µ client-changed ‚Äî
    // –ø–µ—Ä–≤—ã–π heysSyncCompleted —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –î–û —Ç–æ–≥–æ –∫–∞–∫ auth –ø–µ—Ä–µ–∫–ª—é—á–∏–ª –∫–ª–∏–µ–Ω—Ç–∞.
    // –î–∏—Å–ø–∞—Ç—á–∏–º synthetic heysSyncCompleted —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —á—Ç–æ–±—ã:
    //   1. –î–∞—Ç—å React –≤—Ä–µ–º—è —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å listeners (‚âà50-100ms)
    //   2. –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–≤–æ–π–Ω–æ–π pipeline –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π —Å–º–µ–Ω–µ –∫—É—Ä–∞—Ç–æ—Ä–æ–º:
    //      —Ç–∞–º —Ä–µ–∞–ª—å–Ω—ã–π heysSyncCompleted –ø—Ä–∏–¥—ë—Ç –∑–∞ <200ms –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç _initialSyncDone=true
    //      ‚Üí –Ω–∞—à —Ç–∞–π–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç _initialSyncDone –∏ –ù–ï –¥–∏—Å–ø–∞—Ç—á–∏—Ç –¥—É–±–ª–∏–∫–∞—Ç.
    setTimeout(() => {
      if (!_initialSyncDone) {
        console.info('[üéÆ Gamification] RC v6.3: heysSyncCompleted –Ω–µ –ø—Ä–∏—à—ë–ª –ø–æ—Å–ª–µ client-changed ‚Äî –¥–∏—Å–ø–∞—Ç—á–∏–º synthetic (page-refresh case)');
        window.dispatchEvent(new CustomEvent('heysSyncCompleted', {
          detail: { synthetic: true, reason: 'client_changed_no_sync' }
        }));
      }
    }, 200);
  });

  // ========== –≠–ö–°–ü–û–†–¢ ==========

  HEYS.game = game;

  // RC fix v6.5: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ pipeline –¥–∞–∂–µ –µ—Å–ª–∏ heysSyncCompleted —Å—Ä–∞–±–æ—Ç–∞–ª –î–û —Ç–æ–≥–æ,
  // –∫–∞–∫ gamification_v1.js –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª —Å–≤–æ–π listener (–±–æ–ª—å—à–æ–π —Ñ–∞–π–ª, 6000+ —Å—Ç—Ä–æ–∫).
  // –°–∏–º–ø—Ç–æ–º: UI mount:initial-stats {gameReady: false}, –∑–∞—Ç–µ–º heysSyncCompleted –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –±–∞—Ä–æ–º
  // (–µ–≥–æ listener —Ä–∞–±–æ—Ç–∞–µ—Ç), –Ω–æ loadFromCloud() –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Äî –∏ guard –≤–∏—Å–∏—Ç 15 —Å–µ–∫—É–Ω–¥.
  // –ú–µ—Ö–∞–Ω–∏–∑–º: –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 300ms –ø–æ—Å–ª–µ HEYS.game = game _initialSyncDone –≤—Å—ë –µ—â—ë false,
  // –∑–Ω–∞—á–∏—Ç heysSyncCompleted –ª–∏–±–æ —É–∂–µ –ø—Ä–∏—à—ë–ª –¥–æ –Ω–∞—Å (–∏ –º—ã –µ–≥–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏) –ª–∏–±–æ –µ—â—ë –Ω–µ –ø—Ä–∏–¥—ë—Ç ‚Äî
  // –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –∑–∞–ø—É—Å–∫–∞–µ–º loadFromCloud() –≤—Ä—É—á–Ω—É—é.
  setTimeout(() => {
    if (!_initialSyncDone && HEYS.game) {
      console.info('[üéÆ Gamification] RC v6.5: missed heysSyncCompleted (fired before listener registered) ‚Äî triggering loadFromCloud');
      _initialSyncDone = true;
      HEYS.game.loadFromCloud().catch(() => {
        const fallbackStats = game.getStats();
        window.dispatchEvent(new CustomEvent('heysGameUpdate', {
          detail: { ...fallbackStats, isInitialLoad: true, reason: 'cloud_load_complete' }
        }));
      });
    }
  }, 300);

  // üîÑ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫: —Ä–µ—Ç—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
  // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
  setTimeout(() => {
    if (HEYS.game && typeof HEYS.game.recalculateAchievements === 'function') {
      // üîí v4.0: –ë–ª–æ–∫–∏—Ä—É–µ–º –í–°–ï UI-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
      _isLoadingPhase = true;
      bindCloudWatch();
      HEYS.game.recalculateAchievements().then(missed => {
        if (missed && missed.length > 0) {
          console.log('[üéÆ Gamification] Recovered', missed.length, 'missed achievements');
        }
      }).catch(e => {
        // Ignore errors during recalculation
      }).finally(() => {
        // üöÄ PERF v6.0: –£–±—Ä–∞–ª–∏ loadFromCloud –æ—Ç—Å—é–¥–∞, —Ç–∞–∫ –∫–∞–∫ heysSyncCompleted —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤—ã–∑–æ–≤–µ—Ç loadFromCloud.
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
        _isLoadingPhase = false;
        console.info('[üéÆ Gamification] üîì Initial loading phase ended');
      });
    }
  }, 2000); // –£–º–µ–Ω—å—à–∏–ª –¥–æ 2 —Å–µ–∫ —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –¥–æ –ø–µ—Ä–≤–æ–≥–æ sync

  // üîÑ FIX v2.3: –ö—Ä–æ—Å—Å-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
  // –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏/–≤–∫–ª–∞–¥–∫–∞–º–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–ª–∞–∫–æ
  let _lastVisibilitySync = 0;

  if (typeof document !== 'undefined') {
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        const now = Date.now();
        // üîÑ v3.0: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–ª–∞–∫–æ –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 60 —Å–µ–∫—É–Ω–¥
        if (now - _lastVisibilitySync < 60000) {
          return;
        }
        _lastVisibilitySync = now;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ—Å—Å–∏–∏
        const hasSession = HEYS.cloud?.getSessionToken?.() ||
          localStorage.getItem('heys_session_token');
        if (!hasSession) {
          return;
        }

        // üîÑ v3.0: Lightweight consistency check –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π loadFromCloud()
        console.log('[üéÆ Gamification] Tab visible, running consistency check...');
        _auditRebuildDone = false;
        ensureAuditConsistency('tab-visible').catch(() => { });
      }
    });
  }

  // Debug
  if (typeof window !== 'undefined') {
    window.debugGame = () => {
      console.log('Game State:', loadData());
      console.log('Stats:', game.getStats());
      console.log('Achievements:', game.getAchievements().filter(a => a.unlocked));
    };

    // üîß Debug: enable gamification logging
    window.enableGameDebug = () => {
      localStorage.setItem('heys_debug_gamification', 'true');
      console.log('[üéÆ Gamification] Debug mode enabled. Reload page to see logs.');
    };

    window.disableGameDebug = () => {
      localStorage.removeItem('heys_debug_gamification');
      console.log('[üéÆ Gamification] Debug mode disabled.');
    };

    // üîß FIX v2.3: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º
    window.syncGameToCloud = async () => {
      if (!HEYS.game?.syncToCloud) {
        console.error('[üéÆ Gamification] syncToCloud not available');
        return false;
      }
      console.log('[üéÆ Gamification] Manual sync to cloud...');
      const result = await HEYS.game.syncToCloud();
      console.log('[üéÆ Gamification] Sync result:', result);
      return result;
    };

    // üîß FIX v2.3: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞
    window.loadGameFromCloud = async () => {
      if (!HEYS.game?.loadFromCloud) {
        console.error('[üéÆ Gamification] loadFromCloud not available');
        return false;
      }
      console.log('[üéÆ Gamification] Manual load from cloud...');
      const result = await HEYS.game.loadFromCloud();
      console.log('[üéÆ Gamification] Load result:', result);
      return result;
    };

    // üîß FIX v2.4: –ü–µ—Ä–µ—Å—á—ë—Ç XP –∏–∑ –∞—É–¥–∏—Ç-–ª–æ–≥–∞
    window.rebuildGameXP = async (force = false) => {
      if (!HEYS.game?.rebuildXPFromAudit) {
        console.error('[üéÆ Gamification] rebuildXPFromAudit not available');
        return false;
      }
      console.log('[üéÆ Gamification] Rebuilding XP from audit...', force ? '(FORCED)' : '');
      const result = await HEYS.game.rebuildXPFromAudit({ force });
      console.log('[üéÆ Gamification] Rebuild result:', result);
      return result;
    };

    // üîß FIX v2.4: Dry-run –ø—Ä–æ–≤–µ—Ä–∫–∞ (–±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
    window.checkGameXP = async () => {
      if (!HEYS.game?.rebuildXPFromAudit) {
        console.error('[üéÆ Gamification] rebuildXPFromAudit not available');
        return false;
      }
      console.log('[üéÆ Gamification] Checking XP consistency (dry run)...');
      const result = await HEYS.game.rebuildXPFromAudit({ dryRun: true });
      console.log('[üéÆ Gamification] Check result:', result);
      return result;
    };

    // üîß V5: –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    window.recalcGameAchievements = async () => {
      console.log('[üéÆ Gamification] Resetting migration flag and recalculating...');

      // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –º–∏–≥—Ä–∞—Ü–∏–∏
      localStorage.removeItem('heys_achievements_v5_migrated');
      localStorage.removeItem('heys_achievements_v4_migrated');

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å—á—ë—Ç
      if (HEYS.game?.recalculateAchievements) {
        const missed = await HEYS.game.recalculateAchievements();
        console.log('[üéÆ Gamification] Recalculation complete:', {
          found: missed.length,
          achievements: missed
        });
        return missed;
      } else {
        console.error('[üéÆ Gamification] recalculateAchievements not available');
        return [];
      }
    };

    // üîß FIX v2.6: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ streak (–ø–æ—á–µ–º—É streak = 0?)
    window.debugStreak = () => {
      const U = HEYS.utils || {};
      const fmtDate = U.fmtDate || ((d) => d.toISOString().split('T')[0]);
      const lsGet = HEYS.dayStorage?.lsGet || U.lsGet || (() => null);
      const rz = HEYS.ratioZones;

      console.group('üî• [STREAK DEBUG]');
      console.log('HEYS.Day.getStreak:', typeof HEYS.Day?.getStreak === 'function' ? HEYS.Day.getStreak() : 'NOT AVAILABLE');
      console.log('safeGetStreak():', typeof HEYS.utils?.safeGetStreak === 'function' ? HEYS.utils.safeGetStreak() : 'N/A');

      // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π optimum
      const prof = lsGet('heys_profile', {});
      let currentOptimum = 0;
      // –ò–∑ TDEE –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
      if (HEYS.TDEE?.calculate) {
        const today = new Date();
        const dateStr = fmtDate(today);
        const todayData = lsGet('heys_dayv2_' + dateStr, {});
        const tdeeResult = HEYS.TDEE.calculate(todayData, prof, { lsGet });
        currentOptimum = tdeeResult?.optimum || 0;
        console.log('TDEE optimum (—Å–µ–≥–æ–¥–Ω—è):', currentOptimum, '| baseExpenditure:', tdeeResult?.baseExpenditure, '| tdee:', tdeeResult?.tdee);
      }

      const today = new Date();
      today.setHours(12);
      console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–Ω–µ–π (–æ—Ç –≤—á–µ—Ä–∞ –Ω–∞–∑–∞–¥):');
      const results = [];
      for (let i = 1; i <= 10; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const dateStr = fmtDate(d);
        const key = 'heys_dayv2_' + dateStr;
        const dayData = lsGet(key, null);
        const hasMeals = !!(dayData && dayData.meals && dayData.meals.length > 0);
        const mealCount = dayData?.meals?.length || 0;
        let totalKcal = 0;
        if (hasMeals) {
          (dayData.meals || []).forEach(m => {
            (m.items || []).forEach(item => {
              const g = +item.grams || 0;
              if (g <= 0) return;
              const src = item;
              if (src.kcal100 != null) totalKcal += ((+src.kcal100 || 0) * g / 100);
            });
          });
        }
        const savedOpt = dayData?.savedDisplayOptimum || dayData?.savedEatenKcal ? undefined : undefined;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º savedDisplayOptimum –¥–Ω—è –∏–ª–∏ —Ç–µ–∫—É—â–∏–π optimum
        const dayOptimum = dayData?.savedDisplayOptimum || currentOptimum || 1;
        const ratio = totalKcal / dayOptimum;
        const isRefeed = !!dayData?.isRefeedDay;
        const isStreakDay = rz?.isStreakDayWithRefeed
          ? rz.isStreakDayWithRefeed(ratio, dayData)
          : (ratio >= 0.75 && ratio <= 1.10);

        results.push({
          date: dateStr,
          kcal: Math.round(totalKcal),
          optimum: Math.round(dayOptimum),
          ratio: Math.round(ratio * 100) + '%',
          isStreak: isStreakDay ? '‚úÖ' : '‚ùå',
          refeed: isRefeed ? 'üîÑ' : '',
          meals: mealCount
        });
      }
      console.table(results);

      // –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã–∑–≤–∞—Ç—å computeCurrentStreak –Ω–∞–ø—Ä—è–º—É—é
      if (HEYS.dayCalendarMetrics?.computeCurrentStreak) {
        const pIndex = HEYS._productIndex || null;
        const directStreak = HEYS.dayCalendarMetrics.computeCurrentStreak({
          optimum: currentOptimum, pIndex, fmtDate, lsGet
        });
        console.log('computeCurrentStreak (direct call, optimum=' + currentOptimum + '):', directStreak);
        // –¢–µ—Å—Ç —Å includeToday
        const withToday = HEYS.dayCalendarMetrics.computeCurrentStreak({
          optimum: currentOptimum, pIndex, fmtDate, lsGet, includeToday: true
        });
        console.log('computeCurrentStreak (includeToday=true):', withToday);
      }

      const gameData = HEYS.game?.getStats?.();
      console.log('stats.bestStreak:', gameData?.stats?.bestStreak || 0);
      console.groupEnd();
      return results;
    };
  }

  // ========== EVENT LISTENERS FOR MISSION RESYNC ==========
  // Recalculate mission progress when day data changes
  if (typeof window !== 'undefined') {
    window.addEventListener('heysProductAdded', () => {
      if (HEYS.game?.recalculateDailyMissionsProgress) {
        HEYS.game.recalculateDailyMissionsProgress();
      }
    });

    window.addEventListener('heysWaterAdded', () => {
      if (HEYS.game?.recalculateDailyMissionsProgress) {
        HEYS.game.recalculateDailyMissionsProgress();
      }
    });

    // üîÑ –û—Ç–∫–∞—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ item –∏–ª–∏ meal
    window.addEventListener('heysItemRemoved', () => {
      if (HEYS.game?.recalculateDailyMissionsProgress) {
        HEYS.game.recalculateDailyMissionsProgress();
      }
    });

    window.addEventListener('heysMealDeleted', () => {
      if (HEYS.game?.recalculateDailyMissionsProgress) {
        HEYS.game.recalculateDailyMissionsProgress();
      }
    });

    window.addEventListener('heys:day-updated', () => {
      if (HEYS.game?.recalculateDailyMissionsProgress) {
        HEYS.game.recalculateDailyMissionsProgress();
      }
    });
  }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_advice_rules_v1.js ===== */
/**
 * HEYS Advice Rules v1
 * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–æ–¥—É–ª—è —Å–æ–≤–µ—Ç–æ–≤
 * 
 * @file heys_advice_rules_v1.js
 * @version 1.0.0
 */

(function() {
  'use strict';

  window.HEYS = window.HEYS || {};

  const MAX_ADVICES_PER_SESSION = 10;
  const ADVICE_COOLDOWN_MS = 45000; // 45 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Å–æ–≤–µ—Ç–∞–º–∏
  const SESSION_KEY = 'heys_advice_session';
  const TRACKING_KEY = 'heys_advice_stats';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üéØ PRIORITY CONSTANTS ‚Äî –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –ß–µ–º –ù–ò–ñ–ï —á–∏—Å–ª–æ ‚Äî —Ç–µ–º –í–´–®–ï –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–∫–∞–∑–∞!

  const PRIORITY = {
    // 1-9: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Å—Ä—ã–≤—ã, –∑–¥–æ—Ä–æ–≤—å–µ)
    CRITICAL: 1,        // –°—Ä—ã–≤, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –Ω–µ–¥–æ–±–æ—Ä/–ø–µ—Ä–µ–±–æ—Ä
    HEALTH_ALERT: 5,    // –ó–¥–æ—Ä–æ–≤—å–µ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π (—Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã, –Ω–µ–¥–æ—Å—ã–ø+–ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ)

    // 10-29: –í–∞–∂–Ω—ã–µ (–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)
    IMPORTANT: 10,      // –í–∞–∂–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    NUTRITION: 15,      // –ù—É—Ç—Ä–∏–µ–Ω—Ç-—Å–æ–≤–µ—Ç—ã (–±–µ–ª–æ–∫, –∫–ª–µ—Ç—á–∞—Ç–∫–∞)
    TRAINING: 18,       // –°–æ–≤–µ—Ç—ã –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º
    TIMING: 20,         // –¢–∞–π–º–∏–Ω–≥ (–∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞, —Å–æ–Ω)

    // 30-49: –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ (–º–æ—Ç–∏–≤–∞—Ü–∏—è, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
    NORMAL: 30,         // –û–±—ã—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    ACHIEVEMENT: 35,    // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (streak, perfect day)
    MOTIVATION: 40,     // –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

    // 50-79: –ù–∏–∑–∫–∏–µ (—Å–æ–≤–µ—Ç—ã –¥–Ω—è, —Å–µ–∑–æ–Ω–Ω—ã–µ)
    LOW: 50,            // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    SEASONAL: 60,       // –°–µ–∑–æ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    LIFESTYLE: 65,      // –°—Ç–∏–ª—å –∂–∏–∑–Ω–∏

    // 80-100: –§–æ–Ω–æ–≤—ã–µ (tips, gamification)
    BACKGROUND: 80,     // –§–æ–Ω–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã
    GAMIFICATION: 90    // –ò–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üöÄ ADVICE CACHE ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ generateAdvices
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const ADVICE_CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

  const MAX_ADVICES_PER_CATEGORY = 2; // –ê–Ω—Ç–∏-—Å–ø–∞–º: max —Å–æ–≤–µ—Ç–æ–≤ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // THRESHOLDS ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ (–≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const THRESHOLDS = {
    // –ë–µ–ª–æ–∫
    protein: {
      low: 0.5,        // < 50% ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ
      adequate: 0.8,   // < 80% ‚Äî –º–∞–ª–æ–≤–∞—Ç–æ
      good: 0.9,       // 90%+ ‚Äî —Ö–æ—Ä–æ—à–æ
      high: 1.2,       // 120%+ ‚Äî –º–Ω–æ–≥–æ (achievement)
      champion: 1.2    // –ë–µ–ª–∫–æ–≤—ã–π —á–µ–º–ø–∏–æ–Ω
    },
    // –ö–ª–µ—Ç—á–∞—Ç–∫–∞
    fiber: {
      low: 0.3,        // < 30% ‚Äî –º–∞–ª–æ
      adequate: 0.5,   // < 50% ‚Äî –º–∞–ª–æ–≤–∞—Ç–æ
      good: 1.0        // 100%+ ‚Äî —Ö–æ—Ä–æ—à–æ
    },
    // –ñ–∏—Ä—ã
    fat: {
      goodRatioLow: 0.4,  // < 40% —Ö–æ—Ä–æ—à–∏—Ö = –ø–ª–æ—Ö–æ
      goodRatioGood: 0.6  // 60%+ —Ö–æ—Ä–æ—à–∏—Ö = —Ö–æ—Ä–æ—à–æ
    },
    // –£–≥–ª–µ–≤–æ–¥—ã
    carbs: {
      simpleExcess: 1.3,  // > 130% –ø—Ä–æ—Å—Ç—ã—Ö
      simpleRatioMax: 0.5, // > 50% –ø—Ä–æ—Å—Ç—ã—Ö –æ—Ç –≤—Å–µ—Ö
      simpleRatioGood: 0.3 // < 30% ‚Äî –æ—Ç–ª–∏—á–Ω–æ
    },
    // –ö–∞–ª–æ—Ä–∏–∏
    kcal: {
      undereating: 0.6,   // < 60% –∫ –æ–±–µ–¥—É ‚Äî –º–∞–ª–æ
      evening: 0.7        // < 70% –∫ –≤–µ—á–µ—Ä—É ‚Äî –Ω–µ–¥–æ–µ–ª
    },
    // –¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã –∏ –≤—Ä–µ–¥
    trans: { excess: 1.0 },
    harm: { excess: 1.0 },
    // –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
    gi: {
      high: 70,
      low: 55
    },
    // –í–æ–¥–∞
    water: {
      eveningLow: 0.5,
      hoursSinceMax: 2
    },
    // –°–æ–Ω
    sleep: {
      low: 6,
      deficit: 1.5,
      deficitHigh: 2
    },
    // –°—Ç—Ä–µ—Å—Å
    stress: {
      high: 4,
      low: 2
    },
    // –ü—Ä–∏—ë–º—ã –ø–∏—â–∏
    meal: {
      tooLarge: 800,     // –∫–∫–∞–ª
      tooSmall: 150,     // –∫–∫–∞–ª
      proteinMin: 20,    // –≥ –±–µ–ª–∫–∞ –Ω–∞ –ø—Ä–∏—ë–º
      eveningCarbsMax: 50, // –≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤–µ—á–µ—Ä–æ–º
      fiberGood: 8       // –≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ ‚Äî —Ö–æ—Ä–æ—à–æ
    },
    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    training: {
      highIntensityMin: 20, // –º–∏–Ω—É—Ç –¥–ª—è hard_workout
      fatBurnMin: 30,       // –º–∏–Ω—É—Ç –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è
      greatWorkout: 45      // –º–∏–Ω—É—Ç –¥–ª—è great_workout
    },
    // –ú–∞–∫—Ä–æ—Å—ã –±–∞–ª–∞–Ω—Å
    macros: {
      balanceMin: 0.9,
      balanceMax: 1.2
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PRODUCT CATEGORIES CONFIG ‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const PRODUCT_CATEGORIES = {
    vegetables: {
      keywords: ['–æ–≥—É—Ä–µ—Ü', '–ø–æ–º–∏–¥–æ—Ä', '—Ç–æ–º–∞—Ç', '–º–æ—Ä–∫–æ–≤—å', '–∫–∞–ø—É—Å—Ç–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '—à–ø–∏–Ω–∞—Ç', '—Å–∞–ª–∞—Ç', '–ø–µ—Ä–µ—Ü', '–ª—É–∫', '—á–µ—Å–Ω–æ–∫', '–∫–∞–±–∞—á–æ–∫', '–±–∞–∫–ª–∞–∂–∞–Ω', '—Å–≤—ë–∫–ª–∞', '—Ä–µ–¥–∏—Å', '—Å–µ–ª—å–¥–µ—Ä–µ–π', '–ø–µ—Ç—Ä—É—à–∫–∞', '—É–∫—Ä–æ–ø', '—Ä—É–∫–∫–æ–ª–∞', '—Ü–≤–µ—Ç–Ω–∞—è', '—Ç—ã–∫–≤–∞', '–≥–æ—Ä–æ—Ö', '—Ñ–∞—Å–æ–ª—å –∑–µ–ª—ë–Ω–∞—è'],
      icon: 'ü•ó',
      advice: '–°–µ–≥–æ–¥–Ω—è –º–∞–ª–æ –æ–≤–æ—â–µ–π ‚Äî –¥–æ–±–∞–≤—å —Å–∞–ª–∞—Ç –∏–ª–∏ –≥–∞—Ä–Ω–∏—Ä',
      goodAdvice: '–û—Ç–ª–∏—á–Ω–æ —Å –æ–≤–æ—â–∞–º–∏ —Å–µ–≥–æ–¥–Ω—è!'
    },
    fruits: {
      keywords: ['—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–≥—Ä—É—à–∞', '–≤–∏–Ω–æ–≥—Ä–∞–¥', '–ø–µ—Ä—Å–∏–∫', '–∞–±—Ä–∏–∫–æ—Å', '—Å–ª–∏–≤–∞', '–∫–∏–≤–∏', '–º–∞–Ω–≥–æ', '–∞–Ω–∞–Ω–∞—Å', '–∞—Ä–±—É–∑', '–¥—ã–Ω—è', '–∫–ª—É–±–Ω–∏–∫–∞', '–º–∞–ª–∏–Ω–∞', '—á–µ—Ä–Ω–∏–∫–∞', '—è–≥–æ–¥', '—è–≥–æ–¥—ã', '–≥—Ä–∞–Ω–∞—Ç', '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç', '–ª–∏–º–æ–Ω'],
      icon: 'üçé',
      advice: '–§—Ä—É–∫—Ç—ã ‚Äî –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –≤–∏—Ç–∞–º–∏–Ω—ã. –î–æ–±–∞–≤—å –æ–¥–∏–Ω —Å–µ–≥–æ–¥–Ω—è',
      goodAdvice: '–§—Ä—É–∫—Ç–æ–≤—ã–π –¥–µ–Ω—å!'
    },
    dairy: {
      keywords: ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '–π–æ–≥—É—Ä—Ç', '—Ç–≤–æ—Ä–æ–≥', '—Å—ã—Ä', '—Å–º–µ—Ç–∞–Ω–∞', '—Ä—è–∂–µ–Ω–∫–∞', '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∞', '–º–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ', '—Å–ª–∏–≤–∫–∏', '–º–∞—Ü–æ–Ω–∏', '–±—Ä—ã–Ω–∑–∞', '–ø–∞—Ä–º–µ–∑–∞–Ω', '–º–æ—Ü–∞—Ä–µ–ª–ª–∞', '—Ä–∏–∫–æ—Ç—Ç–∞'],
      icon: 'ü•õ',
      advice: '–ú–æ–ª–æ—á–∫–∞ = –∫–∞–ª—å—Ü–∏–π –¥–ª—è –∫–æ—Å—Ç–µ–π. –¢–≤–æ—Ä–æ–≥ –∏–ª–∏ –π–æ–≥—É—Ä—Ç?',
      goodAdvice: '–ö–∞–ª—å—Ü–∏–π –≤ –Ω–æ—Ä–º–µ!'
    },
    fish: {
      keywords: ['—Ä—ã–±–∞', '–ª–æ—Å–æ—Å—å', '—Å—ë–º–≥–∞', '—Ñ–æ—Ä–µ–ª—å', '—Å–∫—É–º–±—Ä–∏—è', '—Ç—Ä–µ—Å–∫–∞', '—Ç—É–Ω–µ—Ü', '—Å–µ–ª—å–¥—å', '–∫–∞—Ä–ø', '–æ–∫—É–Ω—å', '—Å—É–¥–∞–∫', '–º–∏–Ω—Ç–∞–π', '–¥–æ—Ä–∞–¥–æ', '—Å–∏–±–∞—Å', '–∫—Ä–µ–≤–µ—Ç–∫', '–º–∏–¥–∏–∏', '–∫–∞–ª—å–º–∞—Ä', '–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç'],
      icon: 'üêü',
      advice: '–†—ã–±–∞ 2-3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é ‚Äî –û–º–µ–≥–∞-3 –¥–ª—è –º–æ–∑–≥–∞',
      goodAdvice: '–û–º–µ–≥–∞-3 –ø–æ–ª—É—á–∏–ª!'
    },
    meat: {
      keywords: ['–º—è—Å–æ', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '–∫—É—Ä–∏—Ü–∞', '–∫—É—Ä–∏—Ü', '–∏–Ω–¥–µ–π–∫–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '–∫—Ä–æ–ª–∏–∫', '—É—Ç–∫–∞', '–≥—É—Å—å', '—Ç–µ–ª—è—Ç–∏–Ω–∞', '—Ñ–∞—Ä—à', '—Å—Ç–µ–π–∫', '—Ñ–∏–ª–µ', '–≥—Ä—É–¥–∫–∞', '–±–µ–¥—Ä–æ', '–∫–æ—Ç–ª–µ—Ç', '—à–∞—à–ª—ã–∫'],
      icon: 'ü•©',
      advice: '–ú—è—Å–æ ‚Äî –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –±–µ–ª–∫–∞ –∏ –∂–µ–ª–µ–∑–∞',
      goodAdvice: '–ë–µ–ª–æ–∫ –ø–æ–ª—É—á–∏–ª!'
    },
    grains: {
      keywords: ['–≥—Ä–µ—á–∫–∞', '—Ä–∏—Å', '–æ–≤—Å—è–Ω–∫–∞', '–æ–≤—ë—Å', '–ø—à–µ–Ω–æ', '–ø–µ—Ä–ª–æ–≤–∫–∞', '–±—É–ª–≥—É—Ä', '–∫—É—Å–∫—É—Å', '–∫–∏–Ω–æ–∞', '–º–∞–∫–∞—Ä–æ–Ω', '–ø–∞—Å—Ç–∞', '—Å–ø–∞–≥–µ—Ç—Ç–∏', '—Ö–ª–µ–±', '–±–∞—Ç–æ–Ω', '–ª–∞–≤–∞—à', '–∫–∞—à–∞'],
      icon: 'üåæ',
      advice: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã ‚Äî —ç–Ω–µ—Ä–≥–∏—è –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å',
      goodAdvice: '–≠–Ω–µ—Ä–≥–∏—è –ø–æ–ª—É—á–µ–Ω–∞!'
    },
    nuts: {
      keywords: ['–æ—Ä–µ—Ö', '–º–∏–Ω–¥–∞–ª—å', '–≥—Ä–µ—Ü–∫', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '—Ñ–∏—Å—Ç–∞—à–∫', '–∞—Ä–∞—Ö–∏—Å', '–∫–µ–¥—Ä–æ–≤', '–º–∞–∫–∞–¥–∞–º–∏—è', '–ø–µ–∫–∞–Ω', '—Å–µ–º–µ—á–∫', '—Å–µ–º–µ–Ω–∞', '—Ç—ã–∫–≤–µ–Ω–Ω', '–ø–æ–¥—Å–æ–ª–Ω', '—á–∏–∞', '–ª—ë–Ω'],
      icon: 'ü•ú',
      advice: '–û—Ä–µ—Ö–∏ ‚Äî –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã –∏ –±–µ–ª–æ–∫. –ì–æ—Ä—Å—Ç—å –≤ –¥–µ–Ω—å',
      goodAdvice: '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã ‚úì'
    },
    eggs: {
      keywords: ['—è–π—Ü–æ', '—è–π—Ü–∞', '–æ–º–ª–µ—Ç', '—è–∏—á–Ω–∏—Ü–∞', '–≥–ª–∞–∑—É–Ω—å—è', '—Å–∫—Ä–∞–º–±–ª'],
      icon: 'ü•ö',
      advice: '–Ø–π—Ü–∞ ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –±–µ–ª–æ–∫. 2-3 –≤ –¥–µ–Ω—å –Ω–æ—Ä–º–∞',
      goodAdvice: '–ò–¥–µ–∞–ª—å–Ω—ã–π –±–µ–ª–æ–∫!'
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DEDUPLICATION_RULES ‚Äî –ì—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º 1 –∏–∑ –≥—Ä—É–ø–ø—ã)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const DEDUPLICATION_RULES = {
    // –ì—Ä—É–ø–ø–∞ "–±–µ–ª–æ–∫" ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–µ—Ç–æ–≤ –ø—Ä–æ –±–µ–ª–æ–∫ –ø–æ–¥—Ä—è–¥
    protein: ['protein_low', 'protein_sources', 'post_training_protein', 'age_protein', 'bedtime_protein', 'protein_champion', 'protein_per_meal_low'],
    // –ì—Ä—É–ø–ø–∞ "–≤–æ–¥–∞"
    water: ['water_reminder', 'water_evening_low', 'water_goal_reached', 'water_benefits', 'super_hydration'],
    // –ì—Ä—É–ø–ø–∞ "—É–≥–ª–µ–≤–æ–¥—ã"
    carbs: ['simple_carbs_warning', 'complex_carbs_tip', 'carbs_balance_perfect', 'simple_complex_ratio', 'evening_carbs_high'],
    // –ì—Ä—É–ø–ø–∞ "–∫–ª–µ—Ç—á–∞—Ç–∫–∞"
    fiber: ['fiber_low', 'fiber_good', 'fiber_sources', 'fiber_per_meal_good'],
    // –ì—Ä—É–ø–ø–∞ "–∂–∏—Ä—ã"
    fat: ['fat_quality_low', 'fat_quality_great', 'good_fat_low', 'trans_fat_warning'],
    // –ì—Ä—É–ø–ø–∞ "–∫–∞–ª–æ—Ä–∏–∏"
    kcal: ['kcal_excess_critical', 'kcal_excess_mild', 'kcal_under_critical', 'evening_undereating', 'evening_perfect'],
    // –ì—Ä—É–ø–ø–∞ "—Å–æ–Ω"
    sleep: ['sleep_low', 'bad_sleep_advice', 'great_sleep', 'sleep_hunger_correlation', 'sleep_debt_accumulating'],
    // –ì—Ä—É–ø–ø–∞ "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏"
    training: ['post_training_protein', 'hard_workout_recovery', 'cardio_carbs_balance', 'great_workout', 'training_recovery_window'],
    // –ì—Ä—É–ø–ø–∞ "–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ"
    mood: ['stress_support', 'crash_support', 'mood_improving', 'sugar_mood_crash', 'wellbeing_low_food']
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TIME_RESTRICTIONS ‚Äî –ö–æ–≥–¥–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const TIME_RESTRICTIONS = {
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–æ–≤–µ—Ç –ø—Ä–æ –∑–∞–≤—Ç—Ä–∞–∫ –ø–æ—Å–ª–µ 12:00
    'morning_breakfast': { notAfterHour: 12 },
    // –°–æ–≤–µ—Ç –ø—Ä–æ –æ–±–µ–¥ ‚Äî —Ç–æ–ª—å–∫–æ —Å 11 –¥–æ 15
    'lunch_time': { onlyBetweenHours: [11, 15] },
    // –ü–æ–ª–¥–Ω–∏–∫ ‚Äî —Å 15 –¥–æ 18
    'snack_window': { onlyBetweenHours: [15, 18] },
    // –í–µ—á–µ—Ä–Ω–∏–µ —Å–æ–≤–µ—Ç—ã ‚Äî –ø–æ—Å–ª–µ 18
    'evening_undereating': { notBeforeHour: 18 },
    'evening_perfect': { notBeforeHour: 20 },
    'evening_carbs_high': { notBeforeHour: 19 },
    'late_dinner_warning': { notBeforeHour: 21 },
    'bedtime_protein': { onlyBetweenHours: [20, 23] },
    // –ù–æ—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    'night_owl_warning': { onlyBetweenHours: [1, 5] },
    // –°–æ–≤–µ—Ç—ã –ø—Ä–æ —Å–æ–Ω —É—Ç—Ä–æ–º
    'bad_sleep_advice': { notAfterHour: 12 },
    'sleep_hunger_warning': { notAfterHour: 14 }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADVICE CHAINS ‚Äî –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const ADVICE_CHAINS = {
    // –ü–æ—Å–ª–µ —Å–æ–≤–µ—Ç–∞ A, —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–≤–µ—Ç B
    'protein_low': { next: 'protein_sources', delayMinutes: 30 },
    'fiber_low': { next: 'fiber_sources', delayMinutes: 30 },
    'water_reminder': { next: 'water_benefits', delayMinutes: 60 },
    'simple_carbs_warning': { next: 'complex_carbs_tip', delayMinutes: 20 },
    'fat_quality_low': { next: 'good_fat_sources', delayMinutes: 45 },
    'sleep_low': { next: 'sleep_tips', delayMinutes: 120 }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // STREAK MILESTONES ‚Äî –ì–µ–π–º–º–∏—Ñ–∏–∫–∞—Ü–∏—è
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const STREAK_MILESTONES = [
    { days: 3, icon: 'üî•', text: '–ï—â—ë ${remain} –¥–Ω–µ–π –¥–æ streak 3!' },
    { days: 7, icon: '‚≠ê', text: '–ï—â—ë ${remain} –¥–Ω–µ–π –¥–æ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ streak!' },
    { days: 14, icon: 'üíé', text: '–ï—â—ë ${remain} –¥–Ω–µ–π –¥–æ –¥–≤—É—Ö–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ streak!' },
    { days: 30, icon: 'üèÜ', text: '–ï—â—ë ${remain} –¥–Ω–µ–π –¥–æ –º–µ—Å—è—á–Ω–æ–≥–æ streak!' }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DISMISS TRACKING ‚Äî –£–º–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const QUICK_DISMISS_THRESHOLD_MS = 1500; // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –∑–∞ 1.5 —Å–µ–∫ ‚Äî –±—ã—Å—Ç—Ä–æ
  const DISMISS_PENALTY_FACTOR = 0.5;      // –°–Ω–∏–∂–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ 50%

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DYNAMIC TTL CONFIG
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const TTL_CONFIG = {
    minTTL: 4000,      // –ú–∏–Ω–∏–º—É–º 4 —Å–µ–∫
    maxTTL: 12000,     // –ú–∞–∫—Å–∏–º—É–º 12 —Å–µ–∫
    msPerChar: 50,     // 50–º—Å –Ω–∞ —Å–∏–º–≤–æ–ª (~20 —Å–∏–º–≤–æ–ª–æ–≤/—Å–µ–∫ = –Ω–æ—Ä–º. —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è)
    criticalBonus: 2000 // +2 —Å–µ–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADVICE RATING ‚Äî Feedback —Å–∏—Å—Ç–µ–º–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const RATING_KEY = 'heys_advice_ratings';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TIME-BASED ADVICE VARIANTS ‚Äî –†–∞–∑–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const TIME_BASED_TEXTS = {
    protein_low: {
      morning: ['–£—Ç—Ä–æ–º –±–µ–ª–æ–∫ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–µ–Ω ‚Äî –æ–º–ª–µ—Ç –∏–ª–∏ —Ç–≤–æ—Ä–æ–≥?', '–ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å –±–µ–ª–∫–∞ ‚Äî —ç–Ω–µ—Ä–≥–∏–∏ —Ö–≤–∞—Ç–∏—Ç –¥–æ –æ–±–µ–¥–∞'],
      afternoon: ['–û–±–µ–¥ –±–µ–∑ –±–µ–ª–∫–∞ ‚Äî –∫ –≤–µ—á–µ—Ä—É –±—É–¥–µ—Ç –≥–æ–ª–æ–¥', '–î–æ–±–∞–≤—å –±–µ–ª–∫–∞ –≤ –æ–±–µ–¥ ‚Äî –∫—É—Ä–∏—Ü–∞, —Ä—ã–±–∞, —Ç–≤–æ—Ä–æ–≥'],
      evening: ['–í–µ—á–µ—Ä–Ω–∏–π –±–µ–ª–æ–∫ = –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º—ã—à—Ü –Ω–æ—á—å—é', '–ù–∞ —É–∂–∏–Ω –±–µ–ª–æ–∫ ‚Äî —Ç–≤–æ—Ä–æ–≥, —Ä—ã–±–∞, —è–π—Ü–∞']
    },
    water_reminder: {
      morning: ['–°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã —Å —É—Ç—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º ‚òÄÔ∏è', '–ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å –≤–æ–¥—ã ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ'],
      afternoon: ['–°–µ—Ä–µ–¥–∏–Ω–∞ –¥–Ω—è ‚Äî –≤—Ä–µ–º—è –ø–æ–ø–æ–ª–Ω–∏—Ç—å –≤–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å üíß', '–ù–µ –∑–∞–±—ã–≤–∞–π –ø–∏—Ç—å ‚Äî –¥–æ –≤–µ—á–µ—Ä–∞ –µ—â—ë –¥–∞–ª–µ–∫–æ'],
      evening: ['–í–µ—á–µ—Ä–æ–º –ø–µ–π —É–º–µ—Ä–µ–Ω–Ω–æ, –Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞–π –æ –≤–æ–¥–µ', '–°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –ø–µ—Ä–µ–¥ —Å–Ω–æ–º ‚Äî –Ω–æ –Ω–µ –ø–æ–∑–∂–µ —á–µ–º –∑–∞ —á–∞—Å']
    },
    fiber_low: {
      morning: ['–£—Ç—Ä–µ–Ω–Ω—è—è –æ–≤—Å—è–Ω–∫–∞ = –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å', '–ó–∞–≤—Ç—Ä–∞–∫ —Å –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π ‚Äî —Å—ã—Ç–æ—Å—Ç—å –¥–æ –æ–±–µ–¥–∞'],
      afternoon: ['–î–æ–±–∞–≤—å —Å–∞–ª–∞—Ç –∫ –æ–±–µ–¥—É ‚Äî –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –Ω—É–∂–Ω–∞', '–û–±–µ–¥ –±–µ–∑ –æ–≤–æ—â–µ–π? –î–æ–±–∞–≤—å –≥–∞—Ä–Ω–∏—Ä'],
      evening: ['–û–≤–æ—â–∏ –Ω–∞ —É–∂–∏–Ω ‚Äî –ª—ë–≥–∫–æ—Å—Ç—å –∏ –∫–ª–µ—Ç—á–∞—Ç–∫–∞', '–í–µ—á–µ—Ä ‚Äî –≤—Ä–µ–º—è –¥–ª—è –ª—ë–≥–∫–æ–≥–æ —Å–∞–ª–∞—Ç–∞']
    },
    simple_carbs_warning: {
      morning: ['–°–∞—Ö–∞—Ä —É—Ç—Ä–æ–º = –∫–∞—á–µ–ª–∏ —ç–Ω–µ—Ä–≥–∏–∏ –≤–µ—Å—å –¥–µ–Ω—å', '–ó–∞–º–µ–Ω–∏ —Å–ª–∞–¥–∫–æ–µ –Ω–∞ —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã'],
      afternoon: ['–°–ª–∞–¥–∫–æ–µ –ø–æ—Å–ª–µ –æ–±–µ–¥–∞? –°–∫–æ—Ä–æ –±—É–¥–µ—Ç —Å–ø–∞–¥ —ç–Ω–µ—Ä–≥–∏–∏', '–õ—É—á—à–µ —Ñ—Ä—É–∫—Ç—ã –≤–º–µ—Å—Ç–æ –¥–µ—Å–µ—Ä—Ç–∞'],
      evening: ['–°–∞—Ö–∞—Ä –≤–µ—á–µ—Ä–æ–º = –ø–ª–æ—Ö–æ–π —Å–æ–Ω', '–í–µ—á–µ—Ä–æ–º —Å–ª–∞–¥–∫–æ–µ –æ—Å–æ–±–µ–Ω–Ω–æ –≤—Ä–µ–¥–Ω–æ']
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // COMBO ACHIEVEMENTS ‚Äî –ö–æ–º–±–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const COMBO_ACHIEVEMENTS = [
    {
      id: 'protein_fiber_combo',
      name: '–ë–µ–ª–æ–∫ + –ö–ª–µ—Ç—á–∞—Ç–∫–∞',
      conditions: { proteinPct: 0.9, fiberPct: 0.8 },
      daysRequired: 3,
      icon: 'üí™ü•ó',
      text: '3 –¥–Ω—è –ø–æ–¥—Ä—è–¥ –æ—Ç–ª–∏—á–Ω—ã–π –±–µ–ª–æ–∫ –ò –∫–ª–µ—Ç—á–∞—Ç–∫–∞! –ö–æ–º–±–æ!'
    },
    {
      id: 'balanced_macros_combo',
      name: '–ë–∞–ª–∞–Ω—Å –º–∞–∫—Ä–æ—Å–æ–≤',
      conditions: { proteinPct: 0.9, carbsPct: 0.9, fatPct: 0.9, allUnder: 1.15 },
      daysRequired: 3,
      icon: '‚öñÔ∏è',
      text: '3 –¥–Ω—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –ë–ñ–£! –ú–∞—Å—Ç–µ—Ä!'
    },
    {
      id: 'hydration_master',
      name: '–ú–∞—Å—Ç–µ—Ä –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏',
      conditions: { waterPct: 1.0 },
      daysRequired: 5,
      icon: 'üíß',
      text: '5 –¥–Ω–µ–π —Å –Ω–æ—Ä–º–æ–π –≤–æ–¥—ã! –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ!'
    },
    {
      id: 'clean_eating',
      name: '–ß–∏—Å—Ç–æ–µ –ø–∏—Ç–∞–Ω–∏–µ',
      conditions: { harmPct: 0.5, transPct: 0.3 },
      daysRequired: 3,
      icon: 'üåø',
      text: '3 –¥–Ω—è –º–∏–Ω–∏–º—É–º –≤—Ä–µ–¥–Ω–æ–≥–æ! –ß–∏—Å—Ç–æ–µ –ø–∏—Ç–∞–Ω–∏–µ!'
    },
    {
      id: 'early_bird',
      name: '–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞',
      conditions: { breakfastBefore: 9 },
      daysRequired: 5,
      icon: 'üåÖ',
      text: '5 –¥–Ω–µ–π —Å —Ä–∞–Ω–Ω–∏–º –∑–∞–≤—Ç—Ä–∞–∫–æ–º! –†–µ–∂–∏–º!'
    }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SMART RECOMMENDATIONS ‚Äî –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const RECOMMENDATION_PATTERNS_KEY = 'heys_user_patterns';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MOOD-ADAPTIVE MESSAGES ‚Äî –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const MOOD_TONES = {
    low: {  // mood 1-2
      prefix: ['–ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, ', '–í—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ, ', '–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, '],
      suffix: [' üíô', ' –¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!', ''],
      avoid: ['warning', 'critical'] // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∂—ë—Å—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã
    },
    neutral: { // mood 3
      prefix: ['', '', ''],
      suffix: ['', '', ''],
      avoid: []
    },
    high: { // mood 4-5
      prefix: ['–û—Ç–ª–∏—á–Ω–æ! ', '–°—É–ø–µ—Ä! ', '–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! '],
      suffix: [' üéâ', ' üí™', ''],
      avoid: []
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADVICE CATEGORIES SETTINGS ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const ADVICE_SETTINGS_KEY = 'heys_advice_settings';

  const DEFAULT_ADVICE_SETTINGS = {
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–≤–µ—Ç–æ–≤ (–≤–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    categories: {
      nutrition: true,      // –ü–∏—Ç–∞–Ω–∏–µ (–ë–ñ–£, –∫–∞–ª–æ—Ä–∏–∏)
      hydration: true,      // –í–æ–¥–∞
      lifestyle: true,      // –û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏
      training: true,       // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      sleep: true,          // –°–æ–Ω
      emotional: true,      // –≠–º–æ—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
      achievement: true,    // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
      timing: true,         // –¢–∞–π–º–∏–Ω–≥ –ø—Ä–∏—ë–º–æ–≤
      correlation: true,    // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
      health: true          // üíä –ó–¥–æ—Ä–æ–≤—å–µ (–≤–∏—Ç–∞–º–∏–Ω—ã, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è) ‚Äî –ù–ï–õ–¨–ó–Ø –æ—Ç–∫–ª—é—á–∏—Ç—å
    },
    // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    toastsEnabled: true,    // –ê–≤—Ç–æ–ø–æ–∫–∞–∑ —Ç–æ—Å—Ç–æ–≤ (FAB –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    soundEnabled: true,     // –ó–≤—É–∫ –ø—Ä–∏ —Å–æ–≤–µ—Ç–∞—Ö
    hapticEnabled: true,    // –í–∏–±—Ä–∞—Ü–∏—è
    showDetails: true,      // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏
    maxPerDay: 20,          // –ú–∞–∫—Å —Å–æ–≤–µ—Ç–æ–≤ –≤ –¥–µ–Ω—å
    quietHoursStart: 23,    // –¢–∏—Ö–∏–µ —á–∞—Å—ã –Ω–∞—á–∞–ª–æ
    quietHoursEnd: 7        // –¢–∏—Ö–∏–µ —á–∞—Å—ã –∫–æ–Ω–µ—Ü
  };

  const CATEGORY_LABELS = {
    nutrition: { name: '–ü–∏—Ç–∞–Ω–∏–µ', icon: 'ü•ó', desc: '–ë–ñ–£, –∫–∞–ª–æ—Ä–∏–∏, –º–∞–∫—Ä–æ—Å—ã' },
    hydration: { name: '–í–æ–¥–∞', icon: 'üíß', desc: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è' },
    lifestyle: { name: '–û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏', icon: 'üåÖ', desc: '–†–µ–∂–∏–º, –ø—Ä–∏–≤—ã—á–∫–∏' },
    training: { name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', icon: 'üí™', desc: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Ä—Ç' },
    health: { name: '–ó–¥–æ—Ä–æ–≤—å–µ', icon: 'üíä', desc: '–í–∏—Ç–∞–º–∏–Ω—ã, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è', isReminder: true },
    sleep: { name: '–°–æ–Ω', icon: 'üò¥', desc: '–ö–∞—á–µ—Å—Ç–≤–æ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–Ω–∞' },
    emotional: { name: '–≠–º–æ—Ü–∏–∏', icon: 'üíô', desc: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å—Ç—Ä–µ—Å—Å' },
    achievement: { name: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', icon: 'üèÜ', desc: 'Streak, —Ä–µ–∫–æ—Ä–¥—ã' },
    timing: { name: '–¢–∞–π–º–∏–Ω–≥', icon: '‚è∞', desc: '–í—Ä–µ–º—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏' },
    correlation: { name: '–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏', icon: 'üîó', desc: '–°–≤—è–∑–∏ –º–µ–∂–¥—É –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏' }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PERSONAL BEST TRACKING ‚Äî –õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const PERSONAL_BESTS_KEY = 'heys_personal_bests';

  const TRACKABLE_METRICS = {
    proteinPct: { name: '–ë–µ–ª–æ–∫', icon: 'ü•©', unit: '%', higher: true },
    fiberPct: { name: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞', icon: 'ü•¨', unit: '%', higher: true },
    waterPct: { name: '–í–æ–¥–∞', icon: 'üíß', unit: '%', higher: true },
    goodFatRatio: { name: '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã', icon: 'ü•ë', unit: '%', higher: true },
    streak: { name: '–°–µ—Ä–∏—è –¥–Ω–µ–π', icon: 'üî•', unit: '–¥–Ω', higher: true },
    lowGIday: { name: '–ù–∏–∑–∫–∏–π –ì–ò', icon: 'üìä', unit: '–ì–ò', higher: false },
    lowHarmDay: { name: '–ß–∏—Å—Ç—ã–π –¥–µ–Ω—å', icon: 'üåø', unit: '%', higher: false }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // GOAL-SPECIFIC ADVICE ‚Äî –°–æ–≤–µ—Ç—ã –ø–æ —Ü–µ–ª—è–º
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const GOAL_MODES = {
    deficit: {
      name: '–ü–æ—Ö—É–¥–µ–Ω–∏–µ',
      icon: 'üìâ',
      priorities: ['protein', 'fiber', 'water', 'satiety'],
      avoidCategories: [],
      bonusAdvices: [
        { id: 'deficit_protein_priority', text: '–ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –±–µ–ª–æ–∫ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1', priority: 25 },
        { id: 'deficit_water_hunger', text: '–ß–∞—Å—Ç–æ –∂–∞–∂–¥—É –ø—É—Ç–∞—é—Ç —Å –≥–æ–ª–æ–¥–æ–º ‚Äî –≤—ã–ø–µ–π –≤–æ–¥—ã', priority: 27 }
      ]
    },
    bulk: {
      name: '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
      icon: 'üìà',
      priorities: ['protein', 'carbs', 'calories', 'training'],
      avoidCategories: [],
      bonusAdvices: [
        { id: 'bulk_protein_timing', text: '–ë–µ–ª–æ–∫ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –æ–∫–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π', priority: 25 },
        { id: 'bulk_carbs_energy', text: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã = —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è —Ä–æ—Å—Ç–∞', priority: 26 },
        { id: 'bulk_sleep_growth', text: '–ú—ã—à—Ü—ã —Ä–∞—Å—Ç—É—Ç –≤–æ —Å–Ω–µ ‚Äî –º–∏–Ω–∏–º—É–º 7-8 —á–∞—Å–æ–≤', priority: 27 }
      ]
    },
    maintenance: {
      name: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ',
      icon: '‚öñÔ∏è',
      priorities: ['balance', 'variety', 'consistency'],
      avoidCategories: [],
      bonusAdvices: [
        { id: 'maintenance_balance', text: '–ë–∞–ª–∞–Ω—Å –≤–∞–∂–Ω–µ–µ –∏–¥–µ–∞–ª–∞ ‚Äî –¥–µ—Ä–∂–∏ —Å—Ä–µ–¥–Ω—é—é', priority: 25 },
        { id: 'maintenance_variety', text: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏', priority: 26 }
      ]
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADVICE SCHEDULING ‚Äî –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const SCHEDULED_KEY = 'heys_scheduled_advices';
  const SNOOZE_OPTIONS = [
    { label: '30 –º–∏–Ω', minutes: 30 },
    { label: '1 —á–∞—Å', minutes: 60 },
    { label: '2 —á–∞—Å–∞', minutes: 120 }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MICRO-ANIMATIONS CONFIG
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const ADVICE_ANIMATIONS = {
    achievement: 'bounce',
    warning: 'shake',
    tip: 'fadeSlide',
    success: 'pulse',
    streak: 'glow'
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SMART PRIORITIZATION ‚Äî ML-like scoring
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const CTR_WEIGHT = 0.4;        // –í–µ—Å CTR –≤ scoring
  const RECENCY_WEIGHT = 0.3;   // –í–µ—Å –¥–∞–≤–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞
  const RELEVANCE_WEIGHT = 0.3; // –í–µ—Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SEASONAL CONFIG ‚Äî –°–µ–∑–æ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const SEASONAL_TIPS = [
    {
      id: 'winter_vitamin_d',
      months: [10, 11, 0, 1, 2], // –Ω–æ—è–±—Ä—å-–º–∞—Ä—Ç
      icon: '‚ùÑÔ∏è',
      texts: [
        '–ó–∏–º–æ–π –≤–∞–∂–µ–Ω –≤–∏—Ç–∞–º–∏–Ω D ‚Äî —Ä—ã–±–∞, —è–π—Ü–∞, –≥—Ä–∏–±—ã',
        '–ú–∞–ª–æ —Å–æ–ª–Ω—Ü–∞? –î–æ–±–∞–≤—å –∂–∏—Ä–Ω—É—é —Ä—ã–±—É –∏ —è–π—Ü–∞',
        '–í–∏—Ç–∞–º–∏–Ω D –∑–∏–º–æ–π ‚Äî —á–µ—Ä–µ–∑ –µ–¥—É: —Å—ë–º–≥–∞, —Å–∫—É–º–±—Ä–∏—è, –∂–µ–ª—Ç–æ–∫'
      ],
      category: 'lifestyle',
      priority: 60
    },
    {
      id: 'spring_detox',
      months: [2, 3, 4], // –º–∞—Ä—Ç-–º–∞–π
      icon: 'üå±',
      texts: [
        '–í–µ—Å–Ω–∞ ‚Äî –≤—Ä–µ–º—è –∑–µ–ª–µ–Ω–∏! –î–æ–±–∞–≤—å —à–ø–∏–Ω–∞—Ç, —Ä—É–∫–∫–æ–ª—É',
        '–í–µ—Å–µ–Ω–Ω–∏–π –¥–µ—Ç–æ–∫—Å ‚Äî –±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π –∏ –≤–æ–¥—ã',
        '–ü–æ—Ä–∞ –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è ‚Äî –∑–µ–ª—ë–Ω—ã–µ —Å–º—É–∑–∏ –≤ –ø–æ–º–æ—â—å'
      ],
      category: 'lifestyle',
      priority: 60
    },
    {
      id: 'summer_hydration',
      months: [5, 6, 7], // –∏—é–Ω—å-–∞–≤–≥—É—Å—Ç
      icon: '‚òÄÔ∏è',
      texts: [
        '–ñ–∞—Ä–∞ ‚Äî –ø–µ–π –±–æ–ª—å—à–µ –≤–æ–¥—ã, +500–º–ª –∫ –Ω–æ—Ä–º–µ',
        '–õ–µ—Ç–æ–º –≤–∞–∂–Ω–∞ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è ‚Äî –∞—Ä–±—É–∑, –æ–≥—É—Ä—Ü—ã, –≤–æ–¥–∞',
        '–í –∂–∞—Ä—É —Ç–µ—Ä—è–µ—à—å –≤–æ–¥—É ‚Äî –≤–æ—Å–ø–æ–ª–Ω—è–π —Ä–µ–≥—É–ª—è—Ä–Ω–æ'
      ],
      category: 'hydration',
      priority: 55
    },
    {
      id: 'autumn_immunity',
      months: [8, 9, 10], // —Å–µ–Ω—Ç—è–±—Ä—å-–Ω–æ—è–±—Ä—å
      icon: 'üçÇ',
      texts: [
        '–û—Å–µ–Ω—å ‚Äî —É–∫—Ä–µ–ø–ª—è–π –∏–º–º—É–Ω–∏—Ç–µ—Ç: –∏–º–±–∏—Ä—å, –ª–∏–º–æ–Ω, –º—ë–¥',
        '–°–µ–∑–æ–Ω –ø—Ä–æ—Å—Ç—É–¥ ‚Äî –≤–∏—Ç–∞–º–∏–Ω C –∏–∑ —Ü–∏—Ç—Ä—É—Å–æ–≤ –∏ –∫–∏–≤–∏',
        '–ü–æ–¥–¥–µ—Ä–∂–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç ‚Äî —á–µ—Å–Ω–æ–∫, –∏–º–±–∏—Ä—å, –∫—É—Ä–∫—É–º–∞'
      ],
      category: 'lifestyle',
      priority: 60
    }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ADVICE CHAINS ‚Äî –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã (storage)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const CHAIN_STORAGE_KEY = 'heys_advice_chains';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PHASE 0: MEAL & MILESTONE HELPERS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const MEAL_ADVICE_THROTTLE_MS = 3000;

  window.HEYS.adviceRules = {
    MAX_ADVICES_PER_SESSION,
    ADVICE_COOLDOWN_MS,
    SESSION_KEY,
    TRACKING_KEY,
    PRIORITY,
    ADVICE_CACHE_TTL,
    MAX_ADVICES_PER_CATEGORY,
    THRESHOLDS,
    PRODUCT_CATEGORIES,
    DEDUPLICATION_RULES,
    TIME_RESTRICTIONS,
    ADVICE_CHAINS,
    STREAK_MILESTONES,
    QUICK_DISMISS_THRESHOLD_MS,
    DISMISS_PENALTY_FACTOR,
    TTL_CONFIG,
    RATING_KEY,
    TIME_BASED_TEXTS,
    COMBO_ACHIEVEMENTS,
    RECOMMENDATION_PATTERNS_KEY,
    MOOD_TONES,
    ADVICE_SETTINGS_KEY,
    DEFAULT_ADVICE_SETTINGS,
    CATEGORY_LABELS,
    PERSONAL_BESTS_KEY,
    TRACKABLE_METRICS,
    GOAL_MODES,
    SCHEDULED_KEY,
    SNOOZE_OPTIONS,
    ADVICE_ANIMATIONS,
    CTR_WEIGHT,
    RECENCY_WEIGHT,
    RELEVANCE_WEIGHT,
    SEASONAL_TIPS,
    CHAIN_STORAGE_KEY,
    MEAL_ADVICE_THROTTLE_MS
  };
})();


/* ===== heys_advice_bundle_v1.js ===== */
// heys_advice_bundle_v1.js ‚Äî bundled advice modules (core + categories)
// ‚ö†Ô∏è Auto-generated by scripts/bundle-advice.cjs. Do not edit manually.

// ===== Begin advice/_core.js =====
;/**
 * HEYS Advice Module v1 (Core)
 * –ú–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–º–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ (core)
 * 
 * @file advice/_core.js
 * @version 1.2.0
 * @description Core-—É—Ç–∏–ª–∏—Ç—ã –∏ –¥–≤–∏–∂–æ–∫ —Å–æ–≤–µ—Ç–æ–≤ (–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
 */

(function () {
    'use strict';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HELPER: Get product for item (by name first, then by id)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getProductForItem(item, pIndex) {
        if (!item || !pIndex) return null;
        // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        const nameKey = (item.name || '').trim().toLowerCase();
        if (nameKey && pIndex.byName) {
            const found = pIndex.byName.get(nameKey);
            if (found) return found;
        }
        // Fallback –Ω–∞ product_id –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        if (item.product_id != null && pIndex.byId) {
            const found = pIndex.byId.get(String(item.product_id).toLowerCase());
            if (found) return found;
        }
        // –ï—Å–ª–∏ –µ—Å—Ç—å inline –¥–∞–Ω–Ω—ã–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∞–º item
        if (item.kcal100 !== undefined || item.protein100 !== undefined) {
            return item;
        }
        return null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const AdviceRules = window.HEYS && window.HEYS.adviceRules;
    if (!AdviceRules) {
        throw new Error('HEYS.adviceRules required');
    }

    const {
        MAX_ADVICES_PER_SESSION,
        ADVICE_COOLDOWN_MS,
        SESSION_KEY,
        TRACKING_KEY,
        PRIORITY,
        ADVICE_CACHE_TTL,
        MAX_ADVICES_PER_CATEGORY,
        THRESHOLDS,
        PRODUCT_CATEGORIES,
        DEDUPLICATION_RULES,
        TIME_RESTRICTIONS,
        ADVICE_CHAINS,
        STREAK_MILESTONES,
        QUICK_DISMISS_THRESHOLD_MS,
        DISMISS_PENALTY_FACTOR,
        TTL_CONFIG,
        RATING_KEY,
        TIME_BASED_TEXTS,
        COMBO_ACHIEVEMENTS,
        RECOMMENDATION_PATTERNS_KEY,
        MOOD_TONES,
        ADVICE_SETTINGS_KEY,
        DEFAULT_ADVICE_SETTINGS,
        CATEGORY_LABELS,
        PERSONAL_BESTS_KEY,
        TRACKABLE_METRICS,
        GOAL_MODES,
        SCHEDULED_KEY,
        SNOOZE_OPTIONS,
        ADVICE_ANIMATIONS,
        CTR_WEIGHT,
        RECENCY_WEIGHT,
        RELEVANCE_WEIGHT,
        SEASONAL_TIPS,
        CHAIN_STORAGE_KEY,
        MEAL_ADVICE_THROTTLE_MS
    } = AdviceRules;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üöÄ ADVICE CACHE ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ generateAdvices
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let adviceCache = {
        key: null,
        result: null,
        timestamp: 0
    };

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –∫—ç—à–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
     * @param {Object} ctx
     * @returns {string}
     */
    function generateCacheKey(ctx) {
        const day = ctx?.day || {};
        const dayTot = ctx?.dayTot || {};
        const normAbs = ctx?.normAbs || {};
        const goalMode = ctx?.goal?.mode || '';

        return [
            day.date || '',
            ctx?.hour ?? '',
            ctx?.mealCount ?? '',
            ctx?.kcalPct ?? '',
            goalMode,
            day.isRefeedDay ? '1' : '0',
            dayTot.kcal || 0,
            dayTot.prot || 0,
            dayTot.carbs || 0,
            dayTot.fat || 0,
            dayTot.simple || 0,
            dayTot.fiber || 0,
            dayTot.harm || 0,
            normAbs.kcal || 0,
            normAbs.prot || 0,
            normAbs.carbs || 0,
            normAbs.fat || 0,
            normAbs.simple || 0,
            normAbs.fiber || 0,
            normAbs.harm || 0
        ].join('|');
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫—ç—à–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
     * @param {Object} ctx
     * @returns {boolean}
     */
    function isCacheValid(ctx) {
        if (!adviceCache.result) return false;
        if (Date.now() - adviceCache.timestamp > ADVICE_CACHE_TTL) return false;
        return adviceCache.key === generateCacheKey(ctx);
    }

    /**
     * –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞)
     */
    function invalidateAdviceCache() {
        adviceCache = { key: null, result: null, timestamp: 0 };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PERSONALIZED TEXT TEMPLATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ó–∞–º–µ–Ω—è–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –≤ —Ç–µ–∫—Å—Ç–µ
     * @param {string} text - –¢–µ–∫—Å—Ç —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏
     * @param {Object} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
     * @returns {string}
     */
    function personalizeText(text, ctx) {
        const firstName = ctx.prof?.firstName || '';
        const result = text
            .replace(/\$\{firstName\}/g, firstName)
            .replace(/\$\{firstName\}, /g, firstName ? firstName + ', ' : '')
            .replace(/\$\{firstName\}!/g, firstName ? firstName + '!' : '')
            .replace(/\, \$\{firstName\}/g, firstName ? ', ' + firstName : '');
        return result.trim();
    }

    /**
     * –í—ã–±–∏—Ä–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç —Ç–µ–∫—Å—Ç–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ (—Å—Ç–∞–±–∏–ª—å–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏)
     * –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É + id –¥–ª—è seed, —á—Ç–æ–±—ã –≤—ã–±–æ—Ä –±—ã–ª —Å—Ç–∞–±–∏–ª—å–Ω—ã–º –Ω–æ –º–µ–Ω—è–ª—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
     * @param {string|string[]} textOrArray
     * @param {string} [seed] - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π seed –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ (id —Å–æ–≤–µ—Ç–∞)
     * @returns {string}
     */
    // –ö—ç—à –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏
    const _textChoiceCache = new Map();

    function pickRandomText(textOrArray, seed = '') {
        if (!Array.isArray(textOrArray)) {
            return textOrArray;
        }
        if (textOrArray.length === 1) {
            return textOrArray[0];
        }

        // –°–æ–∑–¥–∞—ë–º –∫–ª—é—á –∫—ç—à–∞ –∏–∑ seed + —Ç–µ–∫—Å—Ç–æ–≤
        const cacheKey = seed + '|' + textOrArray.join('|');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if (_textChoiceCache.has(cacheKey)) {
            return _textChoiceCache.get(cacheKey);
        }

        // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã + seed
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        const seedStr = today + seed;

        // Simple hash function
        let hash = 0;
        for (let i = 0; i < seedStr.length; i++) {
            const char = seedStr.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }

        const index = Math.abs(hash) % textOrArray.length;
        const result = textOrArray[index];

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        _textChoiceCache.set(cacheKey, result);

        return result;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADVICE RATING ‚Äî –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ —Å–æ–≤–µ—Ç–æ–≤
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫—É —Å–æ–≤–µ—Ç–∞ (üëç/üëé)
     * @param {string} adviceId
     * @param {boolean} isPositive - true = üëç, false = üëé
     */
    function rateAdvice(adviceId, isPositive) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RATING_KEY, null)
                : (U.lsGet ? U.lsGet(RATING_KEY, null) : JSON.parse(localStorage.getItem(RATING_KEY) || 'null'));
            const ratings = stored || {};
            if (!ratings[adviceId]) {
                ratings[adviceId] = { positive: 0, negative: 0 };
            }
            if (isPositive) {
                ratings[adviceId].positive++;
            } else {
                ratings[adviceId].negative++;
            }
            ratings[adviceId].lastRated = Date.now();
            if (HEYS.store?.set) {
                HEYS.store.set(RATING_KEY, ratings);
            } else if (U.lsSet) {
                U.lsSet(RATING_KEY, ratings);
            } else {
                localStorage.setItem(RATING_KEY, JSON.stringify(ratings));
            }
        } catch (e) { }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ–≤–µ—Ç–∞
     * @param {string} adviceId
     * @returns {Object} { positive, negative, score }
     */
    function getAdviceRating(adviceId) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RATING_KEY, null)
                : (U.lsGet ? U.lsGet(RATING_KEY, null) : JSON.parse(localStorage.getItem(RATING_KEY) || 'null'));
            const ratings = stored || {};
            const r = ratings[adviceId] || { positive: 0, negative: 0 };
            const total = r.positive + r.negative;
            const score = total > 0 ? (r.positive - r.negative) / total : 0;
            return { ...r, score, total };
        } catch (e) {
            return { positive: 0, negative: 0, score: 0, total: 0 };
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ (—Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–∞—Ä—ã—Ö >60 –¥–Ω–µ–π)
     * @returns {Object}
     */
    function getAllRatings() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const parsed = HEYS.store?.get
                ? (HEYS.store.get(RATING_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(RATING_KEY, null) || {}) : JSON.parse(localStorage.getItem(RATING_KEY) || 'null') || {});

            // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 60 –¥–Ω–µ–π
            const now = Date.now();
            const SIXTY_DAYS = 60 * 24 * 60 * 60 * 1000;
            let needsSave = false;
            Object.keys(parsed).forEach(key => {
                if (parsed[key].lastRated && (now - parsed[key].lastRated) > SIXTY_DAYS) {
                    delete parsed[key];
                    needsSave = true;
                }
            });
            if (needsSave) {
                if (HEYS.store?.set) {
                    HEYS.store.set(RATING_KEY, parsed);
                } else if (U.lsSet) {
                    U.lsSet(RATING_KEY, parsed);
                } else {
                    localStorage.setItem(RATING_KEY, JSON.stringify(parsed));
                }
            }
            return parsed;
        } catch (e) {
            return {};
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TIME-BASED TEXT SELECTION ‚Äî –í—ã–±–æ—Ä —Ç–µ–∫—Å—Ç–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –¥–Ω—è
     * @param {number} hour
     * @returns {'morning'|'afternoon'|'evening'}
     */
    function getTimePeriod(hour) {
        if (hour >= 5 && hour < 12) return 'morning';
        if (hour >= 12 && hour < 18) return 'afternoon';
        return 'evening';
    }

    /**
     * –í—ã–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–≤–µ—Ç–∞ —Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
     * @param {string} adviceId
     * @param {number} hour
     * @param {string} defaultText
     * @returns {string}
     */
    function getTimeBasedText(adviceId, hour, defaultText) {
        const variants = TIME_BASED_TEXTS[adviceId];
        if (!variants) return defaultText;

        const period = getTimePeriod(hour);
        const texts = variants[period];

        if (texts && texts.length > 0) {
            return pickRandomText(texts);
        }
        return defaultText;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMBO ACHIEVEMENTS ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–±–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç combo –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
     * @param {Object} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
     * @returns {Object|null} –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ–µ –∫–æ–º–±–æ –∏–ª–∏ null
     */
    function checkComboAchievements(ctx) {
        try {
            const lsGet = (window.HEYS?.utils?.lsGet) || ((k, d) => {
                try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
            });

            const today = new Date();

            for (const combo of COMBO_ACHIEVEMENTS) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ –∫–æ–º–±–æ
                const shownKey = 'heys_combo_' + combo.id;
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                const lastShown = HEYS.store?.get
                    ? HEYS.store.get(shownKey, null)
                    : (U.lsGet ? U.lsGet(shownKey, null) : localStorage.getItem(shownKey));
                if (lastShown) {
                    const daysSince = (Date.now() - parseInt(lastShown, 10)) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) continue; // –ù–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é
                }

                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
                let successDays = 0;

                for (let i = 0; i < combo.daysRequired + 2; i++) { // +2 –¥–ª—è –±—É—Ñ–µ—Ä–∞
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const iso = d.toISOString().slice(0, 10);
                    const dayData = lsGet('heys_dayv2_' + iso, null);

                    if (!dayData?.meals?.length) continue;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è
                    let meetsConditions = true;
                    const cond = combo.conditions;

                    if (cond.proteinPct !== undefined) {
                        const pct = (dayData.dayTot?.prot || 0) / (ctx.normAbs?.prot || 100);
                        if (pct < cond.proteinPct) meetsConditions = false;
                    }
                    if (cond.fiberPct !== undefined) {
                        const pct = (dayData.dayTot?.fiber || 0) / (ctx.normAbs?.fiber || 25);
                        if (pct < cond.fiberPct) meetsConditions = false;
                    }
                    if (cond.waterPct !== undefined) {
                        const pct = (dayData.waterMl || 0) / (ctx.waterGoal || 2000);
                        if (pct < cond.waterPct) meetsConditions = false;
                    }
                    if (cond.harmPct !== undefined) {
                        const pct = (dayData.dayTot?.harm || 0) / 100;
                        if (pct > cond.harmPct) meetsConditions = false;
                    }
                    if (cond.breakfastBefore !== undefined) {
                        const firstMeal = (dayData.meals || []).find(m => m.items?.length > 0);
                        if (firstMeal?.time) {
                            const [h] = firstMeal.time.split(':').map(Number);
                            if (h >= cond.breakfastBefore) meetsConditions = false;
                        } else {
                            meetsConditions = false;
                        }
                    }

                    if (meetsConditions) successDays++;
                    if (successDays >= combo.daysRequired) {
                        return combo;
                    }
                }
            }

            return null;
        } catch (e) {
            return null;
        }
    }

    /**
     * –û—Ç–º–µ—á–∞–µ—Ç –ø–æ–∫–∞–∑ –∫–æ–º–±–æ
     * @param {string} comboId
     */
    function markComboShown(comboId) {
        try {
            const key = 'heys_combo_' + comboId;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(key, String(Date.now()));
            } else if (U.lsSet) {
                U.lsSet(key, String(Date.now()));
            } else {
                localStorage.setItem(key, String(Date.now()));
            }
        } catch (e) { }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SMART RECOMMENDATIONS ‚Äî –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
     * @param {string} productName
     * @param {number} hour
     */
    function trackProductPattern(productName, hour) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RECOMMENDATION_PATTERNS_KEY, null)
                : (U.lsGet ? U.lsGet(RECOMMENDATION_PATTERNS_KEY, null) : JSON.parse(localStorage.getItem(RECOMMENDATION_PATTERNS_KEY) || 'null'));
            const patterns = stored || {};
            const key = productName.toLowerCase().slice(0, 20); // –ü–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤

            if (!patterns[key]) {
                patterns[key] = { hours: [], count: 0 };
            }

            patterns[key].hours.push(hour);
            patterns[key].count++;
            patterns[key].lastAdded = Date.now();

            // –î–µ—Ä–∂–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π –≤—Ä–µ–º–µ–Ω–∏
            if (patterns[key].hours.length > 10) {
                patterns[key].hours = patterns[key].hours.slice(-10);
            }

            if (HEYS.store?.set) {
                HEYS.store.set(RECOMMENDATION_PATTERNS_KEY, patterns);
            } else if (U.lsSet) {
                U.lsSet(RECOMMENDATION_PATTERNS_KEY, patterns);
            } else {
                localStorage.setItem(RECOMMENDATION_PATTERNS_KEY, JSON.stringify(patterns));
            }
        } catch (e) { }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
     * @param {number} currentHour
     * @returns {Object|null} { productName, avgHour, message }
     */
    function getSmartRecommendation(currentHour) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RECOMMENDATION_PATTERNS_KEY, null)
                : (U.lsGet ? U.lsGet(RECOMMENDATION_PATTERNS_KEY, null) : JSON.parse(localStorage.getItem(RECOMMENDATION_PATTERNS_KEY) || 'null'));
            const patterns = stored || {};

            let bestMatch = null;
            let bestScore = 0;

            for (const [product, data] of Object.entries(patterns)) {
                if (data.count < 3) continue; // –ú–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–∞ –¥–æ–±–∞–≤–ª—è–ª

                // –°—Ä–µ–¥–Ω–∏–π —á–∞—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                const avgHour = Math.round(data.hours.reduce((a, b) => a + b, 0) / data.hours.length);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±–ª–∏–∑–∫–æ –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫ –æ–±—ã—á–Ω–æ–º—É
                const hourDiff = Math.abs(currentHour - avgHour);
                if (hourDiff <= 1) { // –í –ø—Ä–µ–¥–µ–ª–∞—Ö —á–∞—Å–∞
                    const score = data.count / (hourDiff + 1);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = {
                            productName: product,
                            avgHour,
                            count: data.count,
                            message: `–û–±—ã—á–Ω–æ –≤ —ç—Ç–æ –≤—Ä–µ–º—è —Ç—ã –¥–æ–±–∞–≤–ª—è–µ—à—å ${product}`
                        };
                    }
                }
            }

            return bestMatch;
        } catch (e) {
            return null;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MOOD-ADAPTIVE MESSAGES ‚Äî –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–æ–Ω–∞ –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–≤–µ—Ç–∞ –ø–æ–¥ —Ç–µ–∫—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
     * @param {string} text - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
     * @param {number} mood - –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (1-5)
     * @param {string} adviceType - –¢–∏–ø —Å–æ–≤–µ—Ç–∞
     * @returns {string}
     */
    function adaptTextToMood(text, mood, adviceType) {
        if (!mood || mood === 0) return text;

        let toneKey = 'neutral';
        if (mood <= 2) toneKey = 'low';
        else if (mood >= 4) toneKey = 'high';

        const tone = MOOD_TONES[toneKey];
        if (!tone) return text;

        // –ü—Ä–∏ –Ω–∏–∑–∫–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –∏–∑–±–µ–≥–∞–µ–º –∂—ë—Å—Ç–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
        if (tone.avoid.includes(adviceType)) {
            return null; // –°–∏–≥–Ω–∞–ª –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
        }

        // –î–æ–±–∞–≤–ª—è–µ–º prefix/suffix —Å–ª—É—á–∞–π–Ω–æ
        const prefix = pickRandomText(tone.prefix);
        const suffix = pickRandomText(tone.suffix);

        return prefix + text + suffix;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
     * @param {Object} day
     * @returns {number} 0-5
     */
    function getAverageMoodToday(day) {
        const meals = (day?.meals || []).filter(m => m.mood > 0);
        if (meals.length === 0) return 0;
        return meals.reduce((sum, m) => sum + m.mood, 0) / meals.length;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SMART PRIORITIZATION ‚Äî ML-like scoring –Ω–∞ –æ—Å–Ω–æ–≤–µ CTR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç smart score –¥–ª—è —Å–æ–≤–µ—Ç–∞ (–±–µ–∑ –∫—ç—à–∞ - –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)
     * @param {Object} advice
     * @param {Object} ctx
     * @returns {number} Score (–≤—ã—à–µ = –ª—É—á—à–µ)
     */
    function calculateSmartScore(advice, ctx) {
        return calculateSmartScoreCached(advice, ctx, getTrackingStats(), getAllRatings());
    }

    /**
     * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ smart score
     * @param {Array} advices
     * @param {Object} ctx
     * @returns {Array}
     */
    function sortBySmartScore(advices, ctx) {
        // üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫—ç—à–∏—Ä—É–µ–º stats –∏ ratings –¥–ª—è –≤—Å–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const cachedStats = getTrackingStats();
        const cachedRatings = getAllRatings();

        return advices
            .map(a => ({ ...a, smartScore: calculateSmartScoreCached(a, ctx, cachedStats, cachedRatings) }))
            .sort((a, b) => b.smartScore - a.smartScore);
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç smart score —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
     * @param {Object} advice
     * @param {Object} ctx
     * @param {Object} stats - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ stats
     * @param {Object} ratings - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ratings
     * @returns {number}
     */
    function calculateSmartScoreCached(advice, ctx, stats, ratings) {
        let score = 100 - advice.priority;

        // 1. CTR factor
        const adviceStats = stats[advice.id];
        if (adviceStats && adviceStats.shown >= 3) {
            const ctr = adviceStats.clicked / adviceStats.shown;
            score += ctr * 50 * CTR_WEIGHT;
        }

        // 2. Rating factor
        const r = ratings[advice.id] || { positive: 0, negative: 0 };
        const total = r.positive + r.negative;
        if (total >= 2) {
            const ratingScore = (r.positive - r.negative) / total;
            score += ratingScore * 30 * CTR_WEIGHT;
        }

        // 3. Recency factor
        if (adviceStats?.lastShown) {
            const hoursSince = (Date.now() - adviceStats.lastShown) / (1000 * 60 * 60);
            if (hoursSince > 24) {
                score += Math.min(hoursSince / 24, 5) * 10 * RECENCY_WEIGHT;
            }
        } else {
            score += 10 * RECENCY_WEIGHT;
        }

        // 4. Relevance
        if (advice.category === 'nutrition' && advice.nutrient) {
            const pct = (ctx.dayTot?.[advice.nutrient] || 0) / (ctx.normAbs?.[advice.nutrient] || 100);
            if (pct < 0.5) score += 20 * RELEVANCE_WEIGHT;
        }

        // 5. üÜï Crash Risk boost ‚Äî –ø–æ–≤—ã—à–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ–≤–µ—Ç–æ–≤ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —Ä–∏—Å–∫–µ —Å—Ä—ã–≤–∞
        if (ctx.crashRisk && ctx.crashRisk.level === 'high') {
            // –°–æ–≤–µ—Ç—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ–º —Å—Ä—ã–≤–∞, –ø–æ–ª—É—á–∞—é—Ç –±–æ–Ω—É—Å
            const crashPreventionCategories = ['emotional', 'nutrition', 'recovery'];
            const crashPreventionIds = [
                'crash_support', 'stress_support', 'sleep_hunger_correlation',
                'undereating_warning', 'evening_undereating', 'chronic_undereating_pattern'
            ];

            if (crashPreventionCategories.includes(advice.category) ||
                crashPreventionIds.includes(advice.id)) {
                score += 30; // –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —Ä–∏—Å–∫–µ
            }
        } else if (ctx.crashRisk && ctx.crashRisk.level === 'medium') {
            // –£–º–µ—Ä–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –ø—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º —Ä–∏—Å–∫–µ
            if (advice.category === 'emotional' || advice.id?.includes('stress')) {
                score += 15;
            }
        }

        return score;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADVICE SETTINGS ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤
     * üîß FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º U.lsGet –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
     * @returns {Object}
     */
    function getAdviceSettings() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(ADVICE_SETTINGS_KEY, null)
                : (U.lsGet ? U.lsGet(ADVICE_SETTINGS_KEY, null) : JSON.parse(localStorage.getItem(ADVICE_SETTINGS_KEY) || 'null'));
            if (stored) {
                return { ...DEFAULT_ADVICE_SETTINGS, ...stored };
            }
        } catch (e) { }
        return { ...DEFAULT_ADVICE_SETTINGS };
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–µ—Ç–æ–≤
     * üîß FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º U.lsSet –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
     * @param {Object} settings
     */
    function setAdviceSettings(settings) {
        try {
            const current = getAdviceSettings();
            const merged = { ...current, ...settings };
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(ADVICE_SETTINGS_KEY, merged);
            } else if (U.lsSet) {
                U.lsSet(ADVICE_SETTINGS_KEY, merged);
            } else {
                localStorage.setItem(ADVICE_SETTINGS_KEY, JSON.stringify(merged));
            }
            // Emit event –¥–ª—è UI
            window.dispatchEvent(new CustomEvent('heysAdviceSettingsChanged', { detail: merged }));
        } catch (e) { }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–≤–µ—Ç–æ–≤
     * @param {string} category
     * @returns {boolean}
     */
    function isCategoryEnabled(category) {
        const settings = getAdviceSettings();
        return settings.categories?.[category] !== false;
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é
     * @param {string} category
     * @param {boolean} enabled
     */
    function toggleCategory(category, enabled) {
        const settings = getAdviceSettings();
        settings.categories = settings.categories || {};
        settings.categories[category] = enabled;
        setAdviceSettings(settings);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PERSONAL BEST TRACKING ‚Äî –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ª–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã
     * @returns {Object}
     */
    function getPersonalBests() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(PERSONAL_BESTS_KEY, null)
                : (U.lsGet ? U.lsGet(PERSONAL_BESTS_KEY, null) : JSON.parse(localStorage.getItem(PERSONAL_BESTS_KEY) || 'null'));
            return stored || {};
        } catch (e) {
            return {};
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥
     * @param {string} metric - –ö–ª—é—á –º–µ—Ç—Ä–∏–∫–∏
     * @param {number} value - –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
     * @param {string} date - –î–∞—Ç–∞ –≤ ISO —Ñ–æ—Ä–º–∞—Ç–µ
     * @returns {Object|null} { isNewRecord, previousValue, improvement }
     */
    function checkAndUpdatePersonalBest(metric, value, date) {
        const config = TRACKABLE_METRICS[metric];
        if (!config) return null;

        const bests = getPersonalBests();
        const current = bests[metric];

        let isNewRecord = false;
        let previousValue = null;

        if (!current) {
            isNewRecord = true;
        } else {
            previousValue = current.value;
            if (config.higher) {
                isNewRecord = value > current.value;
            } else {
                isNewRecord = value < current.value;
            }
        }

        if (isNewRecord && value > 0) {
            bests[metric] = { value, date, previous: previousValue };
            try {
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                if (HEYS.store?.set) {
                    HEYS.store.set(PERSONAL_BESTS_KEY, bests);
                } else if (U.lsSet) {
                    U.lsSet(PERSONAL_BESTS_KEY, bests);
                } else {
                    localStorage.setItem(PERSONAL_BESTS_KEY, JSON.stringify(bests));
                }
            } catch (e) { }

            return {
                isNewRecord: true,
                previousValue,
                improvement: previousValue ? Math.abs(value - previousValue) : null,
                metric: config
            };
        }

        return { isNewRecord: false, currentBest: current?.value };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–≤–µ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–æ—Ä–¥–∞
     * @param {string} metric
     * @param {Object} recordInfo
     * @returns {Object|null} Advice object
     */
    function createPersonalBestAdvice(metric, recordInfo) {
        if (!recordInfo?.isNewRecord) return null;

        const config = TRACKABLE_METRICS[metric];
        if (!config) return null;

        const value = recordInfo.improvement
            ? `+${recordInfo.improvement.toFixed(1)}${config.unit} –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ!`
            : `${config.unit}`;

        return {
            id: 'personal_best_' + metric,
            icon: 'üèÜ',
            text: `–ù–æ–≤—ã–π –ª–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥: ${config.name}! ${value}`,
            type: 'achievement',
            priority: 3,
            category: 'achievement',
            triggers: ['tab_open'],
            ttl: 6000,
            showConfetti: true,
            animation: 'bounce'
        };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADVICE CHAINS ‚Äî –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –û—Ç–º–µ—á–∞–µ—Ç –Ω–∞—á–∞–ª–æ —Ü–µ–ø–æ—á–∫–∏ —Å–æ–≤–µ—Ç–æ–≤
     * @param {string} chainId - ID –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞
     */
    function markChainStart(chainId) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const chains = HEYS.store?.get
                ? (HEYS.store.get(CHAIN_STORAGE_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(CHAIN_STORAGE_KEY, null) || {}) : JSON.parse(localStorage.getItem(CHAIN_STORAGE_KEY) || 'null') || {});
            chains[chainId] = Date.now();
            if (HEYS.store?.set) {
                HEYS.store.set(CHAIN_STORAGE_KEY, chains);
            } else if (U.lsSet) {
                U.lsSet(CHAIN_STORAGE_KEY, chains);
            } else {
                localStorage.setItem(CHAIN_STORAGE_KEY, JSON.stringify(chains));
            }
        } catch (e) { }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ—Ä–∞ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Å–æ–≤–µ—Ç –≤ —Ü–µ–ø–æ—á–∫–µ
     * @param {string} chainId
     * @returns {Object|null} Next advice in chain –∏–ª–∏ null
     */
    function checkChainContinuation(chainId) {
        const chainConfig = ADVICE_CHAINS[chainId];
        if (!chainConfig) return null;

        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const chains = HEYS.store?.get
                ? (HEYS.store.get(CHAIN_STORAGE_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(CHAIN_STORAGE_KEY, null) || {}) : JSON.parse(localStorage.getItem(CHAIN_STORAGE_KEY) || 'null') || {});
            const startTime = chains[chainId];
            if (!startTime) return null;

            const minutesPassed = (Date.now() - startTime) / (1000 * 60);
            if (minutesPassed >= chainConfig.delayMinutes) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ chains, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å —Å–Ω–æ–≤–∞
                delete chains[chainId];
                if (HEYS.store?.set) {
                    HEYS.store.set(CHAIN_STORAGE_KEY, chains);
                } else if (U.lsSet) {
                    U.lsSet(CHAIN_STORAGE_KEY, chains);
                } else {
                    localStorage.setItem(CHAIN_STORAGE_KEY, JSON.stringify(chains));
                }

                return chainConfig.next;
            }
        } catch (e) { }

        return null;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç follow-up —Å–æ–≤–µ—Ç—ã –¥–ª—è —Ü–µ–ø–æ—á–µ–∫
     * @returns {Array} –ú–∞—Å—Å–∏–≤ follow-up —Å–æ–≤–µ—Ç–æ–≤
     */
    function generateChainAdvices() {
        const advices = [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏
        for (const chainId of Object.keys(ADVICE_CHAINS)) {
            const nextId = checkChainContinuation(chainId);
            if (nextId) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º follow-up —Å–æ–≤–µ—Ç
                if (nextId === 'water_benefits') {
                    advices.push({
                        id: 'water_benefits',
                        icon: 'üíß',
                        text: '–í–æ–¥–∞ —É—Å–∫–æ—Ä—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ 30% –Ω–∞ —á–∞—Å –ø–æ—Å–ª–µ —Å—Ç–∞–∫–∞–Ω–∞',
                        type: 'tip',
                        priority: 45,
                        category: 'hydration',
                        triggers: ['tab_open'],
                        ttl: 5000
                    });
                }
            }
        }

        return advices;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADVICE SCHEDULING ‚Äî –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Å–æ–≤–µ—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
     * @param {Object} advice - –°–æ–≤–µ—Ç
     * @param {number} minutes - –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø–æ–∫–∞–∑–∞—Ç—å
     */
    function scheduleAdvice(advice, minutes) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const scheduled = HEYS.store?.get
                ? (HEYS.store.get(SCHEDULED_KEY, null) || [])
                : (U.lsGet ? (U.lsGet(SCHEDULED_KEY, null) || []) : JSON.parse(localStorage.getItem(SCHEDULED_KEY) || 'null') || []);
            scheduled.push({
                advice,
                showAt: Date.now() + minutes * 60 * 1000
            });
            if (HEYS.store?.set) {
                HEYS.store.set(SCHEDULED_KEY, scheduled);
            } else if (U.lsSet) {
                U.lsSet(SCHEDULED_KEY, scheduled);
            } else {
                localStorage.setItem(SCHEDULED_KEY, JSON.stringify(scheduled));
            }

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–ª–æ–∂–∫–µ
            window.dispatchEvent(new CustomEvent('heysAdviceScheduled', {
                detail: { advice, minutes }
            }));
        } catch (e) { }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–≤–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä–∞ –ø–æ–∫–∞–∑–∞—Ç—å
     * @returns {Array}
     */
    function getScheduledAdvices() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const scheduled = HEYS.store?.get
                ? (HEYS.store.get(SCHEDULED_KEY, null) || [])
                : (U.lsGet ? (U.lsGet(SCHEDULED_KEY, null) || []) : JSON.parse(localStorage.getItem(SCHEDULED_KEY) || 'null') || []);
            if (scheduled.length === 0) return []; // –ù–∏—á–µ–≥–æ –Ω–µ—Ç ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º storage

            const now = Date.now();

            const ready = scheduled.filter(s => s.showAt <= now);
            const remaining = scheduled.filter(s => s.showAt > now);

            // –û–±–Ω–æ–≤–ª—è–µ–º storage –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å)
            if (ready.length > 0) {
                if (HEYS.store?.set) {
                    HEYS.store.set(SCHEDULED_KEY, remaining);
                } else if (U.lsSet) {
                    U.lsSet(SCHEDULED_KEY, remaining);
                } else {
                    localStorage.setItem(SCHEDULED_KEY, JSON.stringify(remaining));
                }
            }

            return ready.map(s => ({
                ...s.advice,
                id: s.advice.id + '_scheduled',
                isScheduled: true,
                text: '‚è∞ ' + s.advice.text,
                triggers: ['scheduled', 'tab_open', 'product_added'], // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –ª—é–±–æ–º —Ç—Ä–∏–≥–≥–µ—Ä–µ
                priority: 100 // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –æ—Ç–ª–æ–∂–∏–ª
            }));
        } catch (e) {
            return [];
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤
     * @returns {number}
     */
    function getScheduledCount() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const scheduled = HEYS.store?.get
                ? (HEYS.store.get(SCHEDULED_KEY, null) || [])
                : (U.lsGet ? (U.lsGet(SCHEDULED_KEY, null) || []) : JSON.parse(localStorage.getItem(SCHEDULED_KEY) || 'null') || []);
            return scheduled.length;
        } catch (e) {
            return 0;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GOAL-SPECIFIC ADVICE ‚Äî –°–æ–≤–µ—Ç—ã –ø–æ —Ü–µ–ª—è–º
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ü–µ–ª–∏
     * @param {string} goalMode
     * @returns {Array}
     */
    function getGoalSpecificAdvices(goalMode) {
        const config = GOAL_MODES[goalMode];
        if (!config || !config.bonusAdvices) return [];

        return config.bonusAdvices.map(a => ({
            ...a,
            type: 'tip',
            category: 'lifestyle',
            triggers: ['tab_open'],
            ttl: 5000,
            goalSpecific: true
        }));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MICRO-ANIMATIONS ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–≤–µ—Ç–∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å–æ–≤–µ—Ç–∞
     * @param {Object} advice
     * @returns {string} CSS class name
     */
    function getAdviceAnimation(advice) {
        // –Ø–≤–Ω–æ –∑–∞–¥–∞–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        if (advice.animation) return advice.animation;

        // –ü–æ —Ç–∏–ø—É
        return ADVICE_ANIMATIONS[advice.type] || 'fadeSlide';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SMART PRODUCT CATEGORIES ‚Äî –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –¥–Ω—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã
     * @param {Object} day - –î–∞–Ω–Ω—ã–µ –¥–Ω—è
     * @param {Object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     * @returns {Object} { present: Set<string>, missing: string[], counts: Map }
     */
    function analyzeProductCategories(day, pIndex) {
        const present = new Set();
        const counts = new Map();

        const allItems = (day?.meals || []).flatMap(m => m.items || []);

        for (const item of allItems) {
            let productName = item.name || '';
            if (!productName) {
                const product = getProductForItem(item, pIndex);
                if (product) productName = product.name || '';
            }

            const nameLower = productName.toLowerCase();

            for (const [category, config] of Object.entries(PRODUCT_CATEGORIES)) {
                if (config.keywords.some(kw => nameLower.includes(kw))) {
                    present.add(category);
                    counts.set(category, (counts.get(category) || 0) + 1);
                }
            }
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –≤–∞–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const importantCategories = ['vegetables', 'fruits', 'dairy', 'fish'];
        const missing = importantCategories.filter(c => !present.has(c));

        return { present, missing, counts };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DAY FORECAST ‚Äî –ü—Ä–æ–≥–Ω–æ–∑ –∫–∞–ª–æ—Ä–∏–π –∫ –∫–æ–Ω—Ü—É –¥–Ω—è
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π % –∫–∞–ª–æ—Ä–∏–π –∫ –∫–æ–Ω—Ü—É –¥–Ω—è
     * @param {number} currentKcalPct - –¢–µ–∫—É—â–∏–π % –æ—Ç –Ω–æ—Ä–º—ã
     * @param {number} hour - –¢–µ–∫—É—â–∏–π —á–∞—Å
     * @param {number} mealCount - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
     * @returns {Object} { forecastPct, trend: 'under'|'on_track'|'over', message }
     */
    function getDayForecast(currentKcalPct, hour, mealCount) {
        if (hour < 10 || mealCount === 0) return null;

        // –¢–∏–ø–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –∫ 12:00 ~25%, –∫ 15:00 ~50%, –∫ 18:00 ~75%, –∫ 21:00 ~95%
        const expectedByHour = {
            10: 0.15, 11: 0.20, 12: 0.30, 13: 0.40, 14: 0.50,
            15: 0.55, 16: 0.60, 17: 0.65, 18: 0.75, 19: 0.80,
            20: 0.85, 21: 0.92, 22: 0.97, 23: 1.0
        };

        const expectedNow = expectedByHour[hour] || (hour < 10 ? 0.1 : 1.0);
        const pace = currentKcalPct / expectedNow;

        // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è
        const forecastPct = Math.round(pace * 100);

        let trend = 'on_track';
        let message = '';

        if (pace < 0.85) {
            trend = 'under';
            message = `–ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ –±—É–¥–µ—Ç ~${forecastPct}% –∫ –≤–µ—á–µ—Ä—É`;
        } else if (pace > 1.15) {
            trend = 'over';
            message = `–ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ –±—É–¥–µ—Ç ~${forecastPct}% –∫ –≤–µ—á–µ—Ä—É`;
        } else {
            trend = 'on_track';
            message = `–¢–µ–º–ø —Ö–æ—Ä–æ—à–∏–π ‚Äî –±—É–¥–µ—Ç ~${forecastPct}% –∫ –≤–µ—á–µ—Ä—É`;
        }

        return { forecastPct, trend, message, pace };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WEEKLY COMPARISON ‚Äî –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ —Å –ø—Ä–æ—à–ª–æ–π
     * @returns {Object|null} { kcalDiff, simpleDiff, protDiff, message }
     */
    function getWeeklyComparison() {
        try {
            const lsGet = (window.HEYS?.utils?.lsGet) || ((k, d) => {
                try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
            });

            const today = new Date();
            const dayOfWeek = today.getDay() || 7; // 1-7 (–ø–Ω-–≤—Å)

            // –ï—Å–ª–∏ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏–ª–∏ –≤—Ç–æ—Ä–Ω–∏–∫ ‚Äî –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö
            if (dayOfWeek <= 2) return null;

            let thisWeek = { kcal: 0, simple: 0, prot: 0, days: 0 };
            let lastWeek = { kcal: 0, simple: 0, prot: 0, days: 0 };

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            for (let i = 0; i < dayOfWeek; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().slice(0, 10);
                const dayData = lsGet('heys_dayv2_' + iso, null);
                if (dayData?.meals?.length > 0) {
                    thisWeek.kcal += dayData.dayTot?.kcal || 0;
                    thisWeek.simple += dayData.dayTot?.simple || 0;
                    thisWeek.prot += dayData.dayTot?.prot || 0;
                    thisWeek.days++;
                }
            }

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–∏ (—Ç–µ –∂–µ –¥–Ω–∏)
            for (let i = 7; i < 7 + dayOfWeek; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().slice(0, 10);
                const dayData = lsGet('heys_dayv2_' + iso, null);
                if (dayData?.meals?.length > 0) {
                    lastWeek.kcal += dayData.dayTot?.kcal || 0;
                    lastWeek.simple += dayData.dayTot?.simple || 0;
                    lastWeek.prot += dayData.dayTot?.prot || 0;
                    lastWeek.days++;
                }
            }

            if (thisWeek.days < 2 || lastWeek.days < 2) return null;

            // –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const avgThis = {
                kcal: thisWeek.kcal / thisWeek.days,
                simple: thisWeek.simple / thisWeek.days,
                prot: thisWeek.prot / thisWeek.days
            };
            const avgLast = {
                kcal: lastWeek.kcal / lastWeek.days,
                simple: lastWeek.simple / lastWeek.days,
                prot: lastWeek.prot / lastWeek.days
            };

            // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const kcalDiff = avgLast.kcal > 0 ? Math.round((avgThis.kcal - avgLast.kcal) / avgLast.kcal * 100) : 0;
            const simpleDiff = avgLast.simple > 0 ? Math.round((avgThis.simple - avgLast.simple) / avgLast.simple * 100) : 0;
            const protDiff = avgLast.prot > 0 ? Math.round((avgThis.prot - avgLast.prot) / avgLast.prot * 100) : 0;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–∞–º–æ–≥–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            let message = null;
            const absDiffs = [
                { type: 'simple', diff: simpleDiff, positive: simpleDiff < 0 },
                { type: 'prot', diff: protDiff, positive: protDiff > 0 },
                { type: 'kcal', diff: kcalDiff, positive: Math.abs(kcalDiff) < 10 }
            ];

            // –ò—â–µ–º —Ö–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
            const goodNews = absDiffs.filter(d => d.positive && Math.abs(d.diff) >= 10);
            if (goodNews.length > 0) {
                const best = goodNews.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff))[0];
                if (best.type === 'simple' && best.diff < -10) {
                    message = `–ù–∞ ${Math.abs(best.diff)}% –º–µ–Ω—å—à–µ —Å–∞—Ö–∞—Ä–∞ —á–µ–º –Ω–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ! üéâ`;
                } else if (best.type === 'prot' && best.diff > 10) {
                    message = `–ù–∞ ${best.diff}% –±–æ–ª—å—à–µ –±–µ–ª–∫–∞ —á–µ–º –Ω–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ! üí™`;
                }
            }

            return { kcalDiff, simpleDiff, protDiff, message, thisWeek, lastWeek };
        } catch (e) {
            return null;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SMART DISMISS ‚Äî –£–º–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–≤–µ—Ç–æ–≤
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–≤–µ—Ç–∞
     * @param {string} adviceId
     * @param {number} visibleMs - –°–∫–æ–ª—å–∫–æ –º—Å –±—ã–ª –≤–∏–¥–µ–Ω
     */
    function trackDismiss(adviceId, visibleMs) {
        try {
            if (visibleMs < QUICK_DISMISS_THRESHOLD_MS) {
                const key = 'heys_dismiss_' + adviceId;
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                const stored = HEYS.store?.get
                    ? HEYS.store.get(key, null)
                    : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
                const count = parseInt(stored || '0', 10);
                const nextValue = String(count + 1);
                if (HEYS.store?.set) {
                    HEYS.store.set(key, nextValue);
                } else if (U.lsSet) {
                    U.lsSet(key, nextValue);
                } else {
                    localStorage.setItem(key, nextValue);
                }
            }
        } catch (e) { }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π
     * @param {string} adviceId
     * @returns {number} 1.0 = –Ω–æ—Ä–º–∞, <1 = —Å–Ω–∏–∂–µ–Ω
     */
    function getDismissPenalty(adviceId) {
        try {
            const key = 'heys_dismiss_' + adviceId;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            const count = parseInt(stored || '0', 10);
            if (count >= 3) return 0.3;  // 3+ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π = —Å–∏–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ–º
            if (count >= 2) return 0.5;  // 2 = —É–º–µ—Ä–µ–Ω–Ω–æ
            if (count >= 1) return 0.7;  // 1 = —Å–ª–µ–≥–∫–∞
            return 1.0;
        } catch (e) {
            return 1.0;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DYNAMIC TTL ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π TTL –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
     * @param {string} text
     * @param {boolean} isCritical
     * @returns {number} TTL –≤ –º—Å
     */
    function calculateDynamicTTL(text, isCritical = false) {
        const baseTime = text.length * TTL_CONFIG.msPerChar;
        let ttl = Math.max(TTL_CONFIG.minTTL, Math.min(TTL_CONFIG.maxTTL, baseTime));
        if (isCritical) ttl += TTL_CONFIG.criticalBonus;
        return ttl;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADVICE CHAINS ‚Äî –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ follow-up —Å–æ–≤–µ—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞
     * @param {string} prevAdviceId
     * @returns {Object|null} { nextAdviceId, ready: boolean }
     */
    function checkAdviceChain(prevAdviceId) {
        const chain = ADVICE_CHAINS[prevAdviceId];
        if (!chain) return null;

        try {
            const key = 'heys_chain_' + prevAdviceId;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const shownAt = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            if (!shownAt) return null;

            const elapsed = Date.now() - parseInt(shownAt, 10);
            const ready = elapsed >= chain.delayMinutes * 60 * 1000;

            return { nextAdviceId: chain.next, ready };
        } catch (e) {
            return null;
        }
    }

    /**
     * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–∫–∞–∑ —Å–æ–≤–µ—Ç–∞ –¥–ª—è chain
     * @param {string} adviceId
     */
    function markChainStartForAdvice(adviceId) {
        if (ADVICE_CHAINS[adviceId]) {
            try {
                const key = 'heys_chain_' + adviceId;
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                const value = String(Date.now());
                if (HEYS.store?.set) {
                    HEYS.store.set(key, value);
                } else if (U.lsSet) {
                    U.lsSet(key, value);
                } else {
                    localStorage.setItem(key, value);
                }
            } catch (e) { }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STREAK GAMIFICATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –±–ª–∏–∂–∞–π—à–∏–π milestone streak –∏ —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å
     * @param {number} currentStreak
     * @returns {Object|null} { milestone, remain, icon, text }
     */
    function getNextStreakMilestone(currentStreak) {
        for (const m of STREAK_MILESTONES) {
            if (currentStreak < m.days) {
                const remain = m.days - currentStreak;
                const text = m.text.replace('${remain}', String(remain));
                return { milestone: m.days, remain, icon: m.icon, text };
            }
        }
        return null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WEEKLY SUMMARY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏ (–¥–ª—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è –≤–µ—á–µ—Ä–æ–º)
     * @returns {Object|null} { avgKcal, avgProt, avgSimple, bestDay, worstDay, message }
     */
    function getWeeklySummary() {
        try {
            const lsGet = (window.HEYS?.utils?.lsGet) || ((k, d) => {
                try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
            });

            const today = new Date();
            if (today.getDay() !== 0) return null; // –¢–æ–ª—å–∫–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ

            const weekDays = [];

            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().slice(0, 10);
                const dayData = lsGet('heys_dayv2_' + iso, null);
                if (dayData?.meals?.length > 0) {
                    weekDays.push({
                        date: iso,
                        kcal: dayData.dayTot?.kcal || 0,
                        prot: dayData.dayTot?.prot || 0,
                        simple: dayData.dayTot?.simple || 0,
                        score: dayData.dayScore || 0
                    });
                }
            }

            if (weekDays.length < 3) return null;

            const avgKcal = Math.round(weekDays.reduce((s, d) => s + d.kcal, 0) / weekDays.length);
            const avgProt = Math.round(weekDays.reduce((s, d) => s + d.prot, 0) / weekDays.length);
            const avgSimple = Math.round(weekDays.reduce((s, d) => s + d.simple, 0) / weekDays.length);

            const bestDay = weekDays.reduce((best, d) => d.score > best.score ? d : best, weekDays[0]);
            const worstDay = weekDays.reduce((worst, d) => d.score < worst.score && d.score > 0 ? d : worst, weekDays[0]);

            const message = `–ù–µ–¥–µ–ª—è: ${weekDays.length} –¥–Ω–µ–π, ~${avgKcal} –∫–∫–∞–ª/–¥–µ–Ω—å, ~${avgProt}–≥ –±–µ–ª–∫–∞`;

            return { avgKcal, avgProt, avgSimple, bestDay, worstDay, message, daysTracked: weekDays.length };
        } catch (e) {
            return null;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HELPER FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
     * @param {number} hour - –¢–µ–∫—É—â–∏–π —á–∞—Å (0-23)
     * @returns {'gentle'|'active'|'calm'}
     */
    function getToneForHour(hour) {
        // –£–±—Ä–∞–Ω silent —Ä–µ–∂–∏–º ‚Äî —Å–æ–≤–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç 24/7
        if (hour >= 6 && hour < 10) return 'gentle';   // –£—Ç—Ä–æ ‚Äî –º—è–≥–∫–æ
        if (hour >= 10 && hour < 18) return 'active';  // –î–µ–Ω—å ‚Äî –∞–∫—Ç–∏–≤–Ω–æ
        return 'calm'; // –í–µ—á–µ—Ä/–Ω–æ—á—å ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π HEYS.ratioZones –¥–ª—è –ø–æ—Ä–æ–≥–æ–≤
     * @param {Object} params
     * @returns {'normal'|'stressed'|'crashed'|'success'|'returning'}
     */
    function getEmotionalState(params) {
        const { day, currentStreak, mealCount, kcalPct, totalDaysTracked, goal } = params;
        const hour = new Date().getHours();
        const HEYS = window.HEYS || {};
        const U = HEYS.utils || {};

        // –ï—Å–ª–∏ –µ—Å—Ç—å goal ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º goal-aware –ª–æ–≥–∏–∫—É
        if (goal) {
            // –í–µ—Ä–Ω—É–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä—ã–≤–∞
            let lastVisitDaysAgo = 0;
            try {
                const lastVisit = HEYS.store?.get
                    ? HEYS.store.get('heys_last_visit', null)
                    : (U.lsGet ? U.lsGet('heys_last_visit', null) : localStorage.getItem('heys_last_visit'));
                if (lastVisit) {
                    const last = new Date(lastVisit);
                    const now = new Date();
                    lastVisitDaysAgo = Math.floor((now - last) / (1000 * 60 * 60 * 24));
                }
            } catch (e) { }
            if (lastVisitDaysAgo > 3) return 'returning';

            // üîí –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω–æ–≥–æ "—Å—Ä—ã–≤–∞":
            // - –ù–µ —Å—É–¥–∏–º –æ –Ω–µ–¥–æ–±–æ—Ä–µ —É—Ç—Ä–æ–º (–¥–æ 12:00) –∏–ª–∏ –µ—Å–ª–∏ –º–∞–ª–æ –ø—Ä–∏—ë–º–æ–≤
            // - –ù–µ —Å—É–¥–∏–º –æ —Å—Ä—ã–≤–µ –µ—Å–ª–∏ kcalPct –±–ª–∏–∑–æ–∫ –∫ —Ü–µ–ª–µ–≤–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É
            const isEarlyForUnder = hour < 12 || mealCount < 2;
            const isEarlyForOver = hour < 10 || mealCount < 1;

            // –°—Ä—ã–≤ ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏–ª—Å—è –∏–∑ —Ü–µ–ª–∏ (–Ω–æ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Ä–∞–Ω–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
            const criticallyOver = isCriticallyOver(kcalPct, goal);
            const criticallyUnder = isCriticallyUnder(kcalPct, goal);

            // –ü–µ—Ä–µ–±–æ—Ä ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É (–µ—Å–ª–∏ —Å—ä–µ–ª >115%)
            if (criticallyOver && !isEarlyForOver) return 'crashed';

            // –ù–µ–¥–æ–±–æ—Ä ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—á–µ—Ä–æ–º (–ø–æ—Å–ª–µ 18:00) –∏ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏—ë–º—ã
            if (criticallyUnder && hour >= 18 && mealCount >= 1) return 'crashed';

            // –°—Ç—Ä–µ—Å—Å ‚Äî –Ω–∏–∑–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
            const avgMood = calculateAverageMood(day);
            if (avgMood > 0 && avgMood < 3) return 'stressed';

            // –£—Å–ø–µ—Ö ‚Äî –≤ —Ü–µ–ª–µ–≤–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –∏–ª–∏ streak
            if (currentStreak >= 3 || isInTargetRange(kcalPct, goal)) return 'success';

            return 'normal';
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π ratioZones (legacy fallback)
        const rz = HEYS.ratioZones;
        if (rz) {
            return rz.getEmotionalCategory(kcalPct, currentStreak);
        }

        // Fallback –µ—Å–ª–∏ ratioZones –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        // –í—ã—á–∏—Å–ª—è–µ–º lastVisitDaysAgo –∏–∑ localStorage
        let lastVisitDaysAgo = 0;
        try {
            const lastVisit = HEYS.store?.get
                ? HEYS.store.get('heys_last_visit', null)
                : (U.lsGet ? U.lsGet('heys_last_visit', null) : localStorage.getItem('heys_last_visit'));
            if (lastVisit) {
                const last = new Date(lastVisit);
                const now = new Date();
                lastVisitDaysAgo = Math.floor((now - last) / (1000 * 60 * 60 * 24));
            }
        } catch (e) { }

        // –í–µ—Ä–Ω—É–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä—ã–≤–∞
        if (lastVisitDaysAgo > 3) return 'returning';

        // –°—Ä—ã–≤ ‚Äî —Å–∏–ª—å–Ω–æ –ø–µ—Ä–µ–µ–ª –∏–ª–∏ –Ω–µ–¥–æ–µ–ª
        // ‚ö†Ô∏è –ó–∞—â–∏—Ç–∞: –Ω–µ —Å—É–¥–∏–º –æ –Ω–µ–¥–æ–±–æ—Ä–µ —É—Ç—Ä–æ–º –∏–ª–∏ –µ—Å–ª–∏ –º–∞–ª–æ –ø—Ä–∏—ë–º–æ–≤
        const isEarlyForUnder = hour < 12 || mealCount < 2;
        if (kcalPct > 1.3) return 'crashed';
        if (kcalPct < 0.5 && hour >= 18 && mealCount >= 1) return 'crashed';

        // –°—Ç—Ä–µ—Å—Å ‚Äî –Ω–∏–∑–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        const avgMood = calculateAverageMood(day);
        if (avgMood > 0 && avgMood < 3) return 'stressed';

        // –£—Å–ø–µ—Ö ‚Äî streak –∏–ª–∏ —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å (0.75-1.1)
        if (currentStreak >= 3 || (kcalPct >= 0.75 && kcalPct <= 1.1)) return 'success';

        return 'normal';
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
     * @param {Object} day
     * @returns {number} 0 –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∏–Ω–∞—á–µ 1-5
     */
    function calculateAverageMood(day) {
        const meals = day?.meals || [];
        const moods = meals.map(m => m.mood).filter(m => m > 0);
        if (moods.length === 0) return 0;
        return moods.reduce((a, b) => a + b, 0) / moods.length;
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ —Å—Ç—Ä–µ—Å—Å –∑–∞ –¥–µ–Ω—å
     * @param {Object} day
     * @returns {number} 0 –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∏–Ω–∞—á–µ 1-5
     */
    function calculateAverageStress(day) {
        const meals = day?.meals || [];
        const stresses = meals.map(m => m.stress).filter(s => s > 0);
        if (stresses.length === 0) return 0;
        return stresses.reduce((a, b) => a + b, 0) / stresses.length;
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –∑–∞ –¥–µ–Ω—å
     * @param {Object} day
     * @returns {number} 0 –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∏–Ω–∞—á–µ 1-5
     */
    function calculateAverageWellbeing(day) {
        const meals = day?.meals || [];
        const values = meals.map(m => m.wellbeing).filter(w => w > 0);
        if (values.length === 0) return 0;
        return values.reduce((a, b) => a + b, 0) / values.length;
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—Å–æ–±—ã–π –¥–µ–Ω—å (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –ø—è—Ç–Ω–∏—Ü–∞ –∏ —Ç.–¥.)
     * @param {Date} date
     * @returns {string|null}
     */
    function getSpecialDay(date) {
        const day = date.getDay();
        const month = date.getMonth();
        const dateNum = date.getDate();
        const hour = date.getHours();

        // –ù–æ–≤—ã–π –≥–æ–¥
        if (month === 0 && dateNum === 1) return 'new_year';

        // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —É—Ç—Ä–æ
        if (day === 1 && hour < 12) return 'monday_morning';

        // –ü—è—Ç–Ω–∏—Ü–∞ –≤–µ—á–µ—Ä
        if (day === 5 && hour >= 17) return 'friday_evening';

        // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤–µ—á–µ—Ä
        if (day === 0 && hour >= 18) return 'sunday_evening';

        // –ö–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞
        if (dateNum >= 28) return 'month_end';

        return null;
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
     * @param {Array} advices
     * @param {string} emotionalState
     * @returns {Array}
     */
    function filterByEmotionalState(advices, emotionalState) {
        // –ü—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ –∏–ª–∏ —Å—Ä—ã–≤–µ ‚Äî —É–±–∏—Ä–∞–µ–º warnings
        if (emotionalState === 'stressed' || emotionalState === 'crashed') {
            return advices.filter(a => a.type !== 'warning');
        }
        return advices;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–Ω—è—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ –∏ —Ç.–¥.)
     * @param {Object} uiState
     * @returns {boolean}
     */
    function isUserBusy(uiState) {
        if (!uiState) return false;
        return !!(
            uiState.modalOpen ||
            uiState.searchOpen ||
            uiState.showTimePicker ||
            uiState.showGramsPicker ||
            uiState.showWeightPicker ||
            uiState.showDeficitPicker ||
            uiState.showZonePicker ||
            uiState.showSleepQualityPicker ||
            uiState.showDayScorePicker ||
            uiState.showHouseholdPicker ||
            uiState.showTrainingPicker
        );
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SESSION MANAGEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
     * @returns {Object}
     */
    function getSessionData() {
        try {
            const data = sessionStorage.getItem(SESSION_KEY);
            return data ? JSON.parse(data) : { shown: [], count: 0, lastShown: 0 };
        } catch (e) {
            return { shown: [], count: 0, lastShown: 0 };
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
     * @param {Object} data
     */
    function saveSessionData(data) {
        try {
            sessionStorage.setItem(SESSION_KEY, JSON.stringify(data));
        } catch (e) {
            // Ignore storage errors
        }
    }

    /**
     * –û—Ç–º–µ—á–∞–µ—Ç —Å–æ–≤–µ—Ç –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–π
     * @param {string} adviceId
     */
    function markAdviceShown(adviceId) {
        const data = getSessionData();
        if (!data.shown.includes(adviceId)) {
            data.shown.push(adviceId);
        }
        data.count++;
        data.lastShown = Date.now();
        saveSessionData(data);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–≤–µ—Ç
     * @param {string} adviceId
     * @param {Object} options - { canSkipCooldown?: boolean }
     * @returns {boolean}
     */
    function canShowAdvice(adviceId, options = {}) {
        const data = getSessionData();

        // –õ–∏–º–∏—Ç —Å–æ–≤–µ—Ç–æ–≤ –∑–∞ —Å–µ—Å—Å–∏—é
        if (data.count >= MAX_ADVICES_PER_SESSION) return false;

        // Cooldown –º–µ–∂–¥—É —Å–æ–≤–µ—Ç–∞–º–∏ (–µ—Å–ª–∏ –Ω–µ canSkipCooldown)
        if (!options.canSkipCooldown && Date.now() - data.lastShown < ADVICE_COOLDOWN_MS) return false;

        // –£–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ —ç—Ç–æ—Ç —Å–æ–≤–µ—Ç
        if (data.shown.includes(adviceId)) return false;

        return true;
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ —Å–∏—Å—Ç–µ–º–µ excludes
     * –ï—Å–ª–∏ —Å–æ–≤–µ—Ç A.excludes —Å–æ–¥–µ—Ä–∂–∏—Ç B.id, –∏ –æ–±–∞ –∞–∫—Ç–∏–≤–Ω—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ A (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
     * @param {Array} advices - –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É —Å–æ–≤–µ—Ç—ã
     * @returns {Array}
     */
    function filterByExcludes(advices) {
        const excludedIds = new Set();
        const result = [];

        for (const advice of advices) {
            // –ï—Å–ª–∏ —ç—Ç–æ—Ç —Å–æ–≤–µ—Ç —É–∂–µ –∏—Å–∫–ª—é—á—ë–Ω –¥—Ä—É–≥–∏–º ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (excludedIds.has(advice.id)) continue;

            result.push(advice);

            // –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ excludes –≤ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ
            if (advice.excludes && Array.isArray(advice.excludes)) {
                for (const exId of advice.excludes) {
                    excludedIds.add(exId);
                }
            }
        }

        return result;
    }

    /**
     * –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚Äî –∏–∑ –≥—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω
     * @param {Array} advices - –°–æ–≤–µ—Ç—ã (—É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
     * @returns {Array}
     */
    function deduplicateAdvices(advices) {
        const shownGroups = new Set();
        const result = [];

        for (const advice of advices) {
            // –ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Å–æ–≤–µ—Ç
            let adviceGroup = null;
            for (const [group, ids] of Object.entries(DEDUPLICATION_RULES)) {
                if (ids.includes(advice.id)) {
                    adviceGroup = group;
                    break;
                }
            }

            // –ï—Å–ª–∏ —Å–æ–≤–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≥—Ä—É–ø–ø–µ –∏ –≥—Ä—É–ø–ø–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (adviceGroup && shownGroups.has(adviceGroup)) {
                continue;
            }

            result.push(advice);
            if (adviceGroup) {
                shownGroups.add(adviceGroup);
            }
        }

        return result;
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º
     * @param {Array} advices
     * @returns {Array}
     */
    function filterByTimeRestrictions(advices) {
        const hour = new Date().getHours();

        return advices.filter(advice => {
            const restriction = TIME_RESTRICTIONS[advice.id];
            if (!restriction) return true; // –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

            // notAfterHour: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ N —á–∞—Å–æ–≤
            if (restriction.notAfterHour !== undefined && hour >= restriction.notAfterHour) {
                return false;
            }

            // notBeforeHour: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ N —á–∞—Å–æ–≤
            if (restriction.notBeforeHour !== undefined && hour < restriction.notBeforeHour) {
                return false;
            }

            // onlyBetweenHours: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [from, to]
            if (restriction.onlyBetweenHours) {
                const [from, to] = restriction.onlyBetweenHours;
                if (hour < from || hour >= to) {
                    return false;
                }
            }

            return true;
        });
    }

    /**
     * –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–∞–Ω—Ç–∏—Å–ø–∞–º)
     * –ù–µ –±–æ–ª–µ–µ MAX_ADVICES_PER_CATEGORY —Å–æ–≤–µ—Ç–æ–≤ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
     * @param {Array} advices
     * @returns {Array}
     */
    function limitByCategory(advices) {
        const categoryCount = {};
        const result = [];

        for (const advice of advices) {
            const cat = advice.category || 'other';
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;

            if (categoryCount[cat] <= MAX_ADVICES_PER_CATEGORY) {
                result.push(advice);
            }
        }

        return result;
    }

    /**
     * –ü—Ä–∏–º–µ–Ω—è–µ—Ç boost –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –¥–ª—è goal-specific —Å–æ–≤–µ—Ç–æ–≤
     * @param {Array} advices
     * @param {Object} goal - —Ç–µ–∫—É—â–∏–π goal —Ä–µ–∂–∏–º
     * @returns {Array}
     */
    function applyGoalBoost(advices, goal) {
        if (!goal) return advices;

        const goalPrefix = goal.mode + '_'; // 'bulk_', 'deficit_', 'maintenance_'

        return advices.map(advice => {
            // –°–æ–≤–µ—Ç—ã –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å —Ç–µ–∫—É—â–µ–≥–æ goal —Ä–µ–∂–∏–º–∞ –ø–æ–ª—É—á–∞—é—Ç boost
            if (advice.id.startsWith(goalPrefix)) {
                return { ...advice, priority: advice.priority - 10 }; // –ú–µ–Ω—å—à–µ = –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            }
            return advice;
        });
    }

    /**
     * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å–µ—Å—Å–∏–∏ (–ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è)
     */
    function resetSessionAdvices() {
        saveSessionData({ shown: [], count: 0, lastShown: 0 });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRACKING ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ–≤–µ—Ç–æ–≤
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–≤–µ—Ç–æ–≤
     * @returns {Object} { [adviceId]: { shown: number, clicked: number, lastShown: timestamp } }
     */
    function getTrackingStats() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const parsed = HEYS.store?.get
                ? (HEYS.store.get(TRACKING_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(TRACKING_KEY, null) || {}) : JSON.parse(localStorage.getItem(TRACKING_KEY) || 'null') || {});

            let stats = parsed;
            if (typeof stats === 'string') {
                try {
                    stats = JSON.parse(stats);
                } catch (e) {
                    stats = {};
                }
            }
            if (!stats || typeof stats !== 'object' || Array.isArray(stats)) {
                stats = {};
            }

            // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
            let needsSave = false;
            Object.keys(stats).forEach(key => {
                if (stats[key].lastShown && (now - stats[key].lastShown) > THIRTY_DAYS) {
                    delete stats[key];
                    needsSave = true;
                }
            });
            if (needsSave) {
                if (HEYS.store?.set) {
                    HEYS.store.set(TRACKING_KEY, stats);
                } else if (U.lsSet) {
                    U.lsSet(TRACKING_KEY, stats);
                } else {
                    localStorage.setItem(TRACKING_KEY, JSON.stringify(stats));
                }
            }
            return stats;
        } catch (e) {
            return {};
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
     * @param {Object} stats
     */
    function saveTrackingStats(stats) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(TRACKING_KEY, stats);
            } else if (U.lsSet) {
                U.lsSet(TRACKING_KEY, stats);
            } else {
                localStorage.setItem(TRACKING_KEY, JSON.stringify(stats));
            }
        } catch (e) {
            // Ignore storage errors
        }
    }

    /**
     * –¢—Ä–µ–∫–∞–µ—Ç –ø–æ–∫–∞–∑ —Å–æ–≤–µ—Ç–∞
     * @param {string} adviceId
     */
    function trackAdviceShown(adviceId) {
        const stats = getTrackingStats();
        if (!stats[adviceId]) {
            stats[adviceId] = { shown: 0, clicked: 0, lastShown: 0 };
        }
        stats[adviceId].shown++;
        stats[adviceId].lastShown = Date.now();
        saveTrackingStats(stats);
    }

    /**
     * –¢—Ä–µ–∫–∞–µ—Ç –∫–ª–∏–∫/–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —Å–æ–≤–µ—Ç—É
     * @param {string} adviceId
     */
    function trackAdviceClicked(adviceId) {
        const stats = getTrackingStats();
        if (!stats[adviceId]) {
            stats[adviceId] = { shown: 0, clicked: 0, lastShown: 0 };
        }
        stats[adviceId].clicked++;
        saveTrackingStats(stats);
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç CTR (click-through rate) —Å–æ–≤–µ—Ç–∞
     * @param {string} adviceId
     * @returns {number} 0-1
     */
    function getAdviceCTR(adviceId) {
        const stats = getTrackingStats();
        const s = stats[adviceId];
        if (!s || s.shown === 0) return 0;
        return s.clicked / s.shown;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –ø–æ–∫–∞–∑–∞–º
     * @param {number} n - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
     * @returns {Array<{id: string, shown: number, clicked: number, ctr: number}>}
     */
    function getTopAdvices(n = 10) {
        const stats = getTrackingStats();
        return Object.entries(stats)
            .map(([id, s]) => ({ id, ...s, ctr: s.shown > 0 ? s.clicked / s.shown : 0 }))
            .sort((a, b) => b.shown - a.shown)
            .slice(0, n);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GOAL-AWARE HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param {number} deficitPct - –ü—Ä–æ—Ü–µ–Ω—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = –¥–µ—Ñ–∏—Ü–∏—Ç, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ = –Ω–∞–±–æ—Ä)
     * @returns {{mode: 'deficit'|'maintenance'|'bulk', label: string, emoji: string, targetRange: {min: number, max: number}}}
     */
    function getGoalMode(deficitPct) {
        const pct = deficitPct || 0;

        if (pct <= -10) {
            // –ê–∫—Ç–∏–≤–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç (-10% –∏ –Ω–∏–∂–µ)
            return {
                mode: 'deficit',
                label: '–ü–æ—Ö—É–¥–µ–Ω–∏–µ',
                emoji: 'üî•',
                // –£—Å–ø–µ—Ö: 90-105% –æ—Ç optimum (–Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å –Ω–∞ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
                targetRange: { min: 0.90, max: 1.05 },
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä: >115% (—É–∂–µ —Å–∏–ª—å–Ω–æ –≤—ã–±–∏–ª—Å—è –∏–∑ –ø–ª–∞–Ω–∞)
                criticalOver: 1.15,
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –Ω–µ–¥–æ–±–æ—Ä: <80%
                criticalUnder: 0.80
            };
        } else if (pct <= -5) {
            // –õ—ë–≥–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç (-5% –¥–æ -9%)
            return {
                mode: 'deficit',
                label: '–õ—ë–≥–∫–æ–µ –ø–æ—Ö—É–¥–µ–Ω–∏–µ',
                emoji: 'üéØ',
                targetRange: { min: 0.92, max: 1.08 },
                criticalOver: 1.20,
                criticalUnder: 0.75
            };
        } else if (pct >= 10) {
            // –ê–∫—Ç–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä (+10% –∏ –≤—ã—à–µ)
            return {
                mode: 'bulk',
                label: '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
                emoji: 'üí™',
                // –£—Å–ø–µ—Ö: 95-110% –æ—Ç optimum
                targetRange: { min: 0.95, max: 1.10 },
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä: >125% (—Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ)
                criticalOver: 1.25,
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –Ω–µ–¥–æ–±–æ—Ä: <85% (–Ω–µ –¥–æ–±–∏—Ä–∞–µ—à—å –¥–ª—è —Ä–æ—Å—Ç–∞)
                criticalUnder: 0.85
            };
        } else if (pct >= 5) {
            // –õ—ë–≥–∫–∏–π –Ω–∞–±–æ—Ä (+5% –¥–æ +9%)
            return {
                mode: 'bulk',
                label: '–õ—ë–≥–∫–∏–π –Ω–∞–±–æ—Ä',
                emoji: 'üí™',
                targetRange: { min: 0.93, max: 1.12 },
                criticalOver: 1.20,
                criticalUnder: 0.80
            };
        } else {
            // –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ (-4% –¥–æ +4%)
            return {
                mode: 'maintenance',
                label: '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ',
                emoji: '‚öñÔ∏è',
                targetRange: { min: 0.90, max: 1.10 },
                criticalOver: 1.25,
                criticalUnder: 0.70
            };
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤ —Ü–µ–ª–µ–≤–æ–º –ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –∫–∞–ª–æ—Ä–∏–∏
     * @param {number} kcalPct - –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç optimum
     * @param {Object} goal - –û–±—ä–µ–∫—Ç –æ—Ç getGoalMode()
     * @returns {boolean}
     */
    function isInTargetRange(kcalPct, goal) {
        return kcalPct >= goal.targetRange.min && kcalPct <= goal.targetRange.max;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä (—Å —É—á—ë—Ç–æ–º —Ü–µ–ª–∏)
     * @param {number} kcalPct
     * @param {Object} goal
     * @returns {boolean}
     */
    function isCriticallyOver(kcalPct, goal) {
        return kcalPct > goal.criticalOver;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –Ω–µ–¥–æ–±–æ—Ä (—Å —É—á—ë—Ç–æ–º —Ü–µ–ª–∏)
     * @param {number} kcalPct
     * @param {Object} goal
     * @returns {boolean}
     */
    function isCriticallyUnder(kcalPct, goal) {
        return kcalPct < goal.criticalUnder;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADVICE GENERATION (Core)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function buildDerivedContext(ctx) {
        const dayTot = ctx?.dayTot || {};
        const normAbs = ctx?.normAbs || {};
        const day = ctx?.day || {};

        const proteinPct = (dayTot?.prot || 0) / (normAbs?.prot || 1);
        const fatPct = (dayTot?.fat || 0) / (normAbs?.fat || 1);
        const carbsPct = (dayTot?.carbs || 0) / (normAbs?.carbs || 1);
        const fiberPct = (dayTot?.fiber || 0) / (normAbs?.fiber || 1);
        const simplePct = (dayTot?.simple || 0) / (normAbs?.simple || 1);
        const transPct = (dayTot?.trans || 0) / (normAbs?.trans || 1);
        const harmPct = (dayTot?.harm || 0) / (normAbs?.harm || 1);
        const goodFatPct = (dayTot?.good || 0) / (normAbs?.good || 1);

        const isRefeedDay = day?.isRefeedDay || false;
        const kcalPct = ctx?.kcalPct || (dayTot?.kcal || 0) / (ctx?.optimum || 2000);
        const isRefeedExcessOk = isRefeedDay && kcalPct > 1.0 && kcalPct <= 1.35;
        const isDayEmpty = (dayTot?.kcal || 0) < 10 && (ctx?.mealCount || 0) === 0;
        const waterPct = (day?.waterMl || 0) / (ctx?.waterGoal || 2000);

        return {
            proteinPct,
            fatPct,
            carbsPct,
            fiberPct,
            simplePct,
            transPct,
            harmPct,
            goodFatPct,
            isRefeedDay,
            kcalPct,
            isRefeedExcessOk,
            isDayEmpty,
            waterPct
        };
    }

    function evaluateRules(rules, ctx, helpers) {
        const advices = [];
        for (const rule of rules) {
            if (typeof rule.condition === 'function' && !rule.condition(ctx, helpers)) continue;
            const advice = typeof rule.build === 'function' ? rule.build(ctx, helpers) : { ...rule };
            if (!advice) continue;
            advices.push(advice);
        }
        return advices;
    }

    function collectModuleAdvices(ctx) {
        const advices = [];
        const modules = window.HEYS?.adviceModules || {};
        const helpers = window.HEYS?.adviceCoreHelpers || {};
        const order = ['nutrition', 'timing', 'training', 'emotional', 'hydration', 'other'];

        for (const key of order) {
            const mod = modules[key];
            if (!mod) continue;
            try {
                if (typeof mod === 'function') {
                    const list = mod(ctx, helpers) || [];
                    if (Array.isArray(list)) advices.push(...list);
                    continue;
                }
                if (Array.isArray(mod)) {
                    advices.push(...evaluateRules(mod, ctx, helpers));
                }
            } catch (e) {
                console.error('[HEYS.advice] ‚ùå Module "' + key + '" error:', e?.message, e?.stack?.split('\n')[1]);
            }
        }

        return advices;
    }

    /**
     * –°–æ–∑–¥–∞—ë—Ç —Å–æ–≤–µ—Ç —Å–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
     * @param {Object} advice - –û–±—ä–µ–∫—Ç —Å–æ–≤–µ—Ç–∞ —Å id, text (string|array), –∏ –¥—Ä.
     * @param {Object} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è personalizeText
     * @returns {Object} –°–æ–≤–µ—Ç —Å–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
     */
    function createAdvice(advice, ctx) {
        // –ï—Å–ª–∏ text ‚Äî –º–∞—Å—Å–∏–≤, –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø–æ id
        const rawText = Array.isArray(advice.text)
            ? pickRandomText(advice.text, advice.id)
            : advice.text;

        // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        const text = ctx ? personalizeText(rawText, ctx) : rawText;

        return { ...advice, text };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
     * @param {Object} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–Ω—è
     * @returns {Array} –ú–∞—Å—Å–∏–≤ —Å–æ–≤–µ—Ç–æ–≤
     */
    function generateAdvices(ctx) {
        // üöÄ Early exit: –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–ø–æ–ª–Ω—ã–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        if (!ctx || !ctx.normAbs) {
            return [];
        }

        // üöÄ CACHE CHECK: –ï—Å–ª–∏ –∫—ç—à –≤–∞–ª–∏–¥–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑ –∫—ç—à–∞
        if (isCacheValid(ctx)) {
            return adviceCache.result;
        }

        const derived = buildDerivedContext(ctx);
        const fullCtx = { ...ctx, ...derived };

        const advices = collectModuleAdvices(fullCtx);

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üéØ APPLY DISMISS PENALTY & DYNAMIC TTL (NEW!)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // –ü—Ä–∏–º–µ–Ω—è–µ–º penalty –∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π
        for (const advice of advices) {
            const penalty = getDismissPenalty(advice.id);
            if (penalty < 1) {
                advice.priority = Math.round(advice.priority / penalty); // –í—ã—à–µ priority = –Ω–∏–∂–µ –≤ —Å–ø–∏—Å–∫–µ
            }

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º TTL –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
            if (!advice.ttl || advice.ttl === 5000) { // –¢–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ TTL
                const isCritical = advice.type === 'critical' || advice.canSkipCooldown;
                advice.ttl = calculateDynamicTTL(advice.text, isCritical);
            }
        }

        // üöÄ CACHE RESULT: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º
        adviceCache = {
            key: generateCacheKey(fullCtx),
            result: advices,
            timestamp: Date.now()
        };

        return advices;
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —á–∞—Å—ã —Å–Ω–∞
     * @param {Object} day
     * @returns {number}
     */
    function calculateSleepHours(day) {
        if (!day?.sleepStart || !day?.sleepEnd) return 0;

        const [startH, startM] = day.sleepStart.split(':').map(Number);
        const [endH, endM] = day.sleepEnd.split(':').map(Number);

        let hours = endH - startH;
        let mins = endM - startM;

        // –ï—Å–ª–∏ –ª–µ–≥–ª–∏ –≤—á–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 23:00 ‚Üí 07:00)
        if (hours < 0) hours += 24;

        return hours + mins / 60;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∞—Å—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –≤–æ–¥—ã
     * @param {Object} day
     * @returns {number}
     */
    function getHoursSinceWater(day) {
        const lastWater = day?.lastWaterTime ? new Date(day.lastWaterTime) : null;
        if (!lastWater || Number.isNaN(lastWater.getTime())) return 99;
        return (Date.now() - lastWater.getTime()) / (1000 * 60 * 60);
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç N –¥–Ω–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ localStorage
     * @param {number} n - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –Ω–∞–∑–∞–¥
     * @returns {Array<{date: string, [key: string]: any}>} –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏
     */
    function getRecentDays(n) {
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: HEYS.utils (—Å namespace) ‚Üí HEYS.dayUtils ‚Üí fallback
        const lsGet = (window.HEYS?.utils?.lsGet) || (window.HEYS?.dayUtils?.lsGet) || ((k, d) => {
            try {
                const v = localStorage.getItem(k);
                return v ? JSON.parse(v) : d;
            } catch { return d; }
        });

        const days = [];
        const today = new Date();

        for (let i = 1; i <= n; i++) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const iso = d.toISOString().slice(0, 10);
            const dayData = lsGet('heys_dayv2_' + iso, null);

            if (dayData && dayData.date) {
                days.push({ date: iso, ...dayData });
            }
        }

        return days;
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ (sleepStart –∏–∑ —á–µ–∫-–∏–Ω–∞)
     * @param {number} [daysBack=14] - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
     * @returns {{hour: number, minute: number, formatted: string, count: number}|null}
     */
    function getAverageBedtime(daysBack = 14) {
        const recentDays = getRecentDays(daysBack);

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ sleepStart (–≤—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è)
        const bedtimes = recentDays
            .map(d => d.sleepStart)
            .filter(t => t && typeof t === 'string' && t.includes(':'));

        if (bedtimes.length < 3) return null; // –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –¥–Ω—è –¥–∞–Ω–Ω—ã—Ö

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏ (—Å —É—á—ë—Ç–æ–º —á—Ç–æ 23:00 > 00:30)
        const minutesFromMidnight = bedtimes.map(t => {
            const [h, m] = t.split(':').map(Number);
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Ä–∞–Ω—å—à–µ 12:00 ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ (–¥–æ–±–∞–≤–ª—è–µ–º 24—á)
            // –ù–∞–ø—Ä–∏–º–µ—Ä: 01:00 ‚Üí 25*60=1500 –º–∏–Ω, 23:00 ‚Üí 23*60=1380 –º–∏–Ω
            return h < 12 ? (h + 24) * 60 + m : h * 60 + m;
        });

        // –°—Ä–µ–¥–Ω–µ–µ
        const avgMinutes = Math.round(minutesFromMidnight.reduce((a, b) => a + b, 0) / minutesFromMidnight.length);

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ —á–∞—Å—ã:–º–∏–Ω—É—Ç—ã
        let hour = Math.floor(avgMinutes / 60);
        const minute = avgMinutes % 60;

        // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 24 ‚Äî –≤—ã—á–∏—Ç–∞–µ–º (00:30 ‚Üí 0.5)
        if (hour >= 24) hour -= 24;

        const formatted = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

        return { hour, minute, formatted, count: bedtimes.length };
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –æ–±—ã—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞
     * @param {number} currentHour - –¢–µ–∫—É—â–∏–π —á–∞—Å
     * @param {Object} [prof] - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (fallback –Ω–∞ sleepHours)
     * @returns {{hoursUntilBed: number, bedtimeFormatted: string, source: 'history'|'calculated'}}
     */
    function getHoursUntilBedtime(currentHour, prof) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        const avgBedtime = getAverageBedtime(14);

        if (avgBedtime) {
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É
            let bedHour = avgBedtime.hour;
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏, –¥–æ–±–∞–≤–ª—è–µ–º 24 –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
            if (bedHour < 12) bedHour += 24;

            let hoursUntilBed = bedHour - currentHour;
            if (hoursUntilBed < 0) hoursUntilBed += 24;
            if (hoursUntilBed > 12) hoursUntilBed = 0; // –£–∂–µ –¥–æ–ª–∂–µ–Ω —Å–ø–∞—Ç—å

            return {
                hoursUntilBed,
                bedtimeFormatted: avgBedtime.formatted,
                source: 'history'
            };
        }

        // Fallback: –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –≤—Å—Ç–∞—ë—Ç –≤ 7)
        const sleepNormHours = prof?.sleepHours || 8;
        const expectedBedtime = 24 - sleepNormHours + 7; // –ü—Ä–∏–º–µ—Ä–Ω–æ –∫–æ–≥–¥–∞ –ª–æ–∂–∏—Ç—Å—è
        const hoursUntilBed = expectedBedtime - currentHour;

        return {
            hoursUntilBed: hoursUntilBed > 0 ? hoursUntilBed : 0,
            bedtimeFormatted: `~${expectedBedtime}:00`,
            source: 'calculated'
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∫–æ—Ñ–µ-—Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∞—Å–∞
     * @param {Array} meals - –ú–∞—Å—Å–∏–≤ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ (day.meals)
     * @param {number} afterHour - –ü–æ—Å–ª–µ –∫–∞–∫–æ–≥–æ —á–∞—Å–∞ –∏—Å–∫–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä 16)
     * @param {Object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ { byId: Map, byName: Map }
     * @returns {boolean} true –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∫–æ—Ñ–µ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∞—Å–∞
     */
    function hasCoffeeAfterHour(meals, afterHour, pIndex) {
        if (!meals || !Array.isArray(meals)) return false;

        const coffeeKeywords = ['–∫–æ—Ñ–µ', 'coffee', '–∫–∞–ø—É—á–∏–Ω–æ', '–ª–∞—Ç—Ç–µ', '–ª–∞—Ç–µ', '—Ä–∞—Ñ', '–∞–º–µ—Ä–∏–∫–∞–Ω–æ', '—ç—Å–ø—Ä–µ—Å—Å–æ', '—Ñ–ª—ç—Ç', '–º–æ–∫–∫–æ', '–º–∞–∫–∏–∞—Ç–æ'];

        for (const meal of meals) {
            // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞
            if (!meal.time) continue;
            const [h] = meal.time.split(':').map(Number);
            if (h < afterHour) continue;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –ø—Ä–∏—ë–º–µ
            for (const item of (meal.items || [])) {
                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
                let name = item.name || '';
                if (!name) {
                    const product = getProductForItem(item, pIndex);
                    if (product) name = product.name || '';
                }

                // –ò—â–µ–º –∫–æ—Ñ–µ-–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                const nameLower = name.toLowerCase();
                if (coffeeKeywords.some(kw => nameLower.includes(kw))) {
                    return true;
                }
            }
        }

        return false;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PHASE 0: MEAL & MILESTONE HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—É–º–º—ã –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
     * @param {Object} meal - –ü—Ä–∏—ë–º –ø–∏—â–∏ (meal object)
     * @param {Object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ { byId: Map, byName: Map }
     * @returns {Object|null} { kcal, prot, carbs, simple, complex, fat, good, bad, trans, fiber } –∏–ª–∏ null
     */
    function getMealTotals(meal, pIndex) {
        if (!meal || !meal.items || meal.items.length === 0) return null;

        // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HEYS.models.mealTotals –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if (window.HEYS?.models?.mealTotals) {
            return window.HEYS.models.mealTotals(meal, pIndex);
        }

        // Fallback: –≤—ã—á–∏—Å–ª—è–µ–º —Å–∞–º–∏
        const tot = { kcal: 0, prot: 0, carbs: 0, simple: 0, complex: 0, fat: 0, good: 0, bad: 0, trans: 0, fiber: 0 };

        for (const item of meal.items) {
            const grams = item.grams || 0;
            if (grams <= 0) continue;

            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, fallback –Ω–∞ id)
            const product = getProductForItem(item, pIndex);
            if (!product) continue;

            const ratio = grams / 100;
            tot.kcal += (product.kcal100 || 0) * ratio;
            tot.prot += (product.protein100 || 0) * ratio;
            tot.simple += (product.simple100 || 0) * ratio;
            tot.complex += (product.complex100 || 0) * ratio;
            tot.carbs += ((product.simple100 || 0) + (product.complex100 || 0)) * ratio;
            tot.good += (product.goodFat100 || 0) * ratio;
            tot.bad += (product.badFat100 || 0) * ratio;
            tot.trans += (product.trans100 || 0) * ratio;
            tot.fat += ((product.goodFat100 || 0) + (product.badFat100 || 0) + (product.trans100 || 0)) * ratio;
            tot.fiber += (product.fiber100 || 0) * ratio;
        }

        return tot;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
     * @param {Object} day - –î–∞–Ω–Ω—ã–µ –¥–Ω—è
     * @returns {Object|null} meal –æ–±—ä–µ–∫—Ç –∏–ª–∏ null
     */
    function getLastMealWithItems(day) {
        const meals = (day?.meals || []).filter(m => m.items?.length > 0);
        return meals.length > 0 ? meals[meals.length - 1] : null;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
     * @param {Object} day - –î–∞–Ω–Ω—ã–µ –¥–Ω—è
     * @returns {Object|null} meal –æ–±—ä–µ–∫—Ç –∏–ª–∏ null
     */
    function getFirstMealWithItems(day) {
        const meals = (day?.meals || []).filter(m => m.items?.length > 0);
        return meals.length > 0 ? meals[0] : null;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª –ª–∏ –ø–æ–∫–∞–∑–∞–Ω milestone (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ)
     * @param {string} id - ID milestone (–Ω–∞–ø—Ä–∏–º–µ—Ä '30_days')
     * @returns {boolean}
     */
    function isMilestoneShown(id) {
        try {
            const key = 'heys_milestone_' + id;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            return stored === '1' || stored === 1 || stored === true;
        } catch (e) {
            return false;
        }
    }

    /**
     * –û—Ç–º–µ—á–∞–µ—Ç milestone –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–π
     * @param {string} id - ID milestone
     */
    function markMilestoneShown(id) {
        try {
            const key = 'heys_milestone_' + id;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(key, '1');
            } else if (U.lsSet) {
                U.lsSet(key, '1');
            } else {
                localStorage.setItem(key, '1');
            }
        } catch (e) {
            // Ignore storage errors
        }
    }

    /**
     * –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∑–∞ –¥–µ–Ω—å
     * @param {Object} day - –î–∞–Ω–Ω—ã–µ –¥–Ω—è
     * @returns {number}
     */
    function countUniqueProducts(day) {
        const names = new Set();
        (day?.meals || []).forEach(meal => {
            (meal.items || []).forEach(item => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
                const name = String(item.name || '').trim().toLowerCase();
                if (name) names.add(name);
            });
        });
        return names.size;
    }

    /**
     * –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ localStorage
     * –£—á–∏—Ç—ã–≤–∞–µ—Ç clientId –¥–ª—è multi-client —Ä–µ–∂–∏–º–∞
     * @returns {number}
     */
    function getTotalDaysTracked() {
        try {
            const U = HEYS.utils || {};
            const clientId = U.getCurrentClientId ? U.getCurrentClientId() : '';
            let count = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('heys_dayv2_')) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å clientId, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –Ω–µ–≥–æ
                    // –§–æ—Ä–º–∞—Ç: {clientId}_heys_dayv2_{date} –∏–ª–∏ heys_dayv2_{date}
                    if (!clientId || key.startsWith(clientId + '_') || !key.includes('_heys_dayv2_')) {
                        count++;
                    }
                }
            }
            return count;
        } catch (e) {
            return 0;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ª—É—á—à–∏–π streak –∏–∑ localStorage
     * @returns {number}
     */
    function getPersonalBestStreak() {
        try {
            const key = 'heys_best_streak';
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            return parseInt(stored || '0', 10);
        } catch (e) {
            return 0;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ª—É—á—à–∏–π streak –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –±–æ–ª—å—à–µ
     * @param {number} currentStreak - –¢–µ–∫—É—â–∏–π streak
     * @returns {boolean} true –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥
     */
    function updatePersonalBestStreak(currentStreak) {
        const best = getPersonalBestStreak();
        if (currentStreak > best) {
            // üîß v4.7.1 FIX: –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å –≤ localStorage —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å
            // setState –≤–æ –≤—Ä–µ–º—è render —Ñ–∞–∑—ã React (Cannot update component while rendering)
            setTimeout(() => {
                try {
                    const key = 'heys_best_streak';
                    const HEYS = window.HEYS || {};
                    const U = HEYS.utils || {};
                    if (HEYS.store?.set) {
                        HEYS.store.set(key, String(currentStreak));
                    } else if (U.lsSet) {
                        U.lsSet(key, String(currentStreak));
                    } else {
                        localStorage.setItem(key, String(currentStreak));
                    }
                } catch (e) {
                    // Ignore storage errors
                }
            }, 0);
            return true; // –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!
        }
        return false;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å meal-level —Å–æ–≤–µ—Ç
     * @returns {boolean}
     */
    function canShowMealAdvice() {
        try {
            const last = sessionStorage.getItem('heys_last_meal_advice');
            return !last || (Date.now() - parseInt(last, 10)) > MEAL_ADVICE_THROTTLE_MS;
        } catch (e) {
            return true;
        }
    }

    /**
     * –û—Ç–º–µ—á–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ meal-level —Å–æ–≤–µ—Ç–∞
     */
    function markMealAdviceShown() {
        try {
            sessionStorage.setItem('heys_last_meal_advice', String(Date.now()));
        } catch (e) {
            // Ignore storage errors
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REACT HOOK
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * React hook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≤–µ—Ç–æ–≤
     * @param {Object} params
     * @param {Object} params.dayTot - –°—É–º–º—ã –∑–∞ –¥–µ–Ω—å
     * @param {Object} params.normAbs - –ù–æ—Ä–º—ã –≤ –≥—Ä–∞–º–º–∞—Ö
     * @param {number} params.optimum - –¶–µ–ª–µ–≤–æ–π –∫–∞–ª–æ—Ä–∞–∂
     * @param {Object} params.day - –î–∞–Ω–Ω—ã–µ –¥–Ω—è
     * @param {Map} params.pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
     * @param {number} params.currentStreak - –¢–µ–∫—É—â–∏–π streak (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ DayTab, –ù–ï –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ!)
     * @param {string} params.trigger - –ß—Ç–æ –≤—ã–∑–≤–∞–ª–æ –ø–æ–∫–∞–∑ ('tab_open'|'product_added')
     * @param {Object} params.uiState - –°–æ—Å—Ç–æ—è–Ω–∏–µ UI –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
     * @param {Object} params.prof - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (sex, age, weight, sleepHours, insulinWaveHours, deficitPctTarget –∏ –¥—Ä.)
     * @param {number} params.waterGoal - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞ –≤–æ–¥—ã (–∏–∑ waterGoalBreakdown)
     * @param {Object} params.caloricDebt - –î–∞–Ω–Ω—ã–µ –æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ–º –¥–æ–ª–≥–µ (totalDebt, dailyBoost, hasDebt –∏ –¥—Ä.)
     * @param {number} params.displayOptimum - –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–æ—Ä–º–∞ —Å —É—á—ë—Ç–æ–º –¥–æ–ª–≥–∞
     * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Å–æ–≤–µ—Ç–∞–º–∏ –∏ –º–µ—Ç–æ–¥–∞–º–∏
     */
    function useAdviceEngine(params) {
        // ‚ö†Ô∏è –í–ê–ñ–ù–û: currentStreak –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä, –ù–ï –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è!
        const { dayTot, normAbs, optimum, displayOptimum, caloricDebt, day, pIndex, currentStreak, trigger, uiState, prof, waterGoal } = params;
        const React = window.React;

        // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const ctx = (() => {
            try {
            const now = new Date();
            const hour = now.getHours();
            const meals = Array.isArray(day?.meals) ? day.meals : [];
            const mealCount = meals.filter(m => m?.items?.length > 0).length;
            const trainings = Array.isArray(day?.trainings) ? day.trainings : [];
            const hasTraining = trainings.some(t => t?.z && Array.isArray(t.z) && t.z.some(m => m > 0));

            // üß† –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            const kcalPct = (dayTot?.kcal || 0) / (optimum || 2000);
            const tone = getToneForHour(hour);
            const specialDay = getSpecialDay(now);

            // üéØ Goal-aware: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø–æ —Ü–µ–ª–∏ (–¥–µ—Ñ–∏—Ü–∏—Ç/–Ω–∞–±–æ—Ä/–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ)
            const dayDeficit = day?.deficitPct;
            const profileDeficit = prof?.deficitPctTarget;
            const effectiveDeficit = dayDeficit ?? profileDeficit ?? 0;
            const goal = getGoalMode(effectiveDeficit);

            const emotionalState = getEmotionalState({
                day,
                currentStreak: currentStreak || 0,
                mealCount,
                kcalPct,
                goal, // –ü–µ—Ä–µ–¥–∞—ë–º goal –¥–ª—è goal-aware –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                totalDaysTracked: 30 // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ
            });

            // üÜï –ü–æ–ª—É—á–∞–µ–º crashRisk –∏–∑ Metabolic Intelligence
            let crashRisk = null;
            if (window.HEYS?.Metabolic?.calculateCrashRisk24h) {
                try {
                    crashRisk = window.HEYS.Metabolic.calculateCrashRisk24h();
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ crashRisk
                }
            }

            return {
                dayTot: dayTot || {},
                normAbs: normAbs || {},
                optimum: optimum || 2000,
                displayOptimum: displayOptimum || optimum || 2000, // –° —É—á—ë—Ç–æ–º –¥–æ–ª–≥–∞ (fallback –Ω–∞ optimum)
                caloricDebt: caloricDebt || null,                   // –î–∞–Ω–Ω—ã–µ –æ –¥–æ–ª–≥–µ
                day: day || {},
                pIndex: pIndex || { byId: new Map(), byName: new Map() },
                currentStreak: currentStreak || 0,
                hour,
                mealCount,
                hasTraining,
                kcalPct,
                tone,
                specialDay,
                emotionalState,
                prof: prof || {},           // –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                waterGoal: waterGoal || 2000, // –ù–æ—Ä–º–∞ –≤–æ–¥—ã
                goal,                        // üéØ Goal —Ä–µ–∂–∏–º (deficit/bulk/maintenance)
                crashRisk                    // üÜï –†–∏—Å–∫ —Å—Ä—ã–≤–∞ –∏–∑ Metabolic Intelligence
            };
            } catch (e) {
                console.error('[HEYS.advice] ‚ùå ctx useMemo crash:', e?.message);
                return {
                    dayTot: {}, normAbs: {}, optimum: 2000, displayOptimum: 2000,
                    caloricDebt: null, day: {}, pIndex: { byId: new Map(), byName: new Map() },
                    currentStreak: 0, hour: new Date().getHours(), mealCount: 0,
                    hasTraining: false, kcalPct: 0, tone: 'neutral', specialDay: null,
                    emotionalState: 'normal', prof: {}, waterGoal: 2000,
                    goal: 'maintenance', crashRisk: null
                };
            }
        })();

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–≤–µ—Ç—ã
        const allAdvices = (() => {
            try {
                if (!ctx) return [];
                const baseAdvices = generateAdvices(ctx);

                // üîó –î–æ–±–∞–≤–ª—è–µ–º chain follow-ups
                const chainAdvices = generateChainAdvices();

                // ‚è∞ –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
                const scheduledAdvices = getScheduledAdvices();

                // üéØ –î–æ–±–∞–≤–ª—è–µ–º goal-specific —Å–æ–≤–µ—Ç—ã
                const goalAdvices = getGoalSpecificAdvices(ctx.goal);

                // üèÜ –ü—Ä–æ–≤–µ—Ä—è–µ–º personal bests
                const personalBestAdvices = [];
                const todayISO = new Date().toISOString().slice(0, 10);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∫–æ—Ä–¥—ã –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º
                const proteinPct = (ctx.dayTot?.prot || 0) / (ctx.normAbs?.prot || 100);
                const proteinRecord = checkAndUpdatePersonalBest('proteinPct', proteinPct * 100, todayISO);
                if (proteinRecord?.isNewRecord) {
                    const advice = createPersonalBestAdvice('proteinPct', proteinRecord);
                    if (advice) personalBestAdvices.push(advice);
                }

                const fiberPct = (ctx.dayTot?.fiber || 0) / (ctx.normAbs?.fiber || 25);
                const fiberRecord = checkAndUpdatePersonalBest('fiberPct', fiberPct * 100, todayISO);
                if (fiberRecord?.isNewRecord) {
                    const advice = createPersonalBestAdvice('fiberPct', fiberRecord);
                    if (advice) personalBestAdvices.push(advice);
                }

                // Streak record
                if (ctx.currentStreak > 0) {
                    const streakRecord = checkAndUpdatePersonalBest('streak', ctx.currentStreak, todayISO);
                    if (streakRecord?.isNewRecord) {
                        const advice = createPersonalBestAdvice('streak', streakRecord);
                        if (advice) personalBestAdvices.push(advice);
                    }
                }

                return [
                    ...(Array.isArray(baseAdvices) ? baseAdvices : []),
                    ...(Array.isArray(chainAdvices) ? chainAdvices : []),
                    ...(Array.isArray(scheduledAdvices) ? scheduledAdvices : []),
                    ...(Array.isArray(goalAdvices) ? goalAdvices : []),
                    ...personalBestAdvices
                ];
            } catch (e) {
                console.error('[HEYS.advice] ‚ùå allAdvices useMemo crash:', e?.message);
                return [];
            }
        })();

        // üîß –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤–∫–ª—é—á—ë–Ω–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        // üíä –°–æ–≤–µ—Ç—ã —Å isReminder: true (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è) –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –í–°–ï–ì–î–ê
        const categoryFilteredAdvices = (() => {
            return allAdvices.filter(a => {
                // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–≤–∏—Ç–∞–º–∏–Ω—ã –∏ —Ç.–¥.) –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ–≥–¥–∞
                if (a.isReminder === true) return true;
                // –ö–∞—Ç–µ–≥–æ—Ä–∏—è health ‚Äî —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                if (a.category === 'health') return true;
                if (!a.category) return true;
                return isCategoryEnabled(a.category);
            });
        })();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º boost –¥–ª—è goal-specific —Å–æ–≤–µ—Ç–æ–≤
        const boostedAdvices = (() => {
            return applyGoalBoost(categoryFilteredAdvices, ctx.goal);
        })();

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
        const filteredAdvices = (() => {
            return filterByEmotionalState(boostedAdvices, ctx.emotionalState);
        })();

        // üé≠ –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç—ã –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        const moodAdaptedAdvices = (() => {
            const avgMood = getAverageMoodToday(ctx.day);
            if (!avgMood || avgMood === 0) return filteredAdvices;

            return filteredAdvices.map(advice => {
                const adaptedText = adaptTextToMood(advice.text, avgMood, advice.type);
                if (adaptedText === null) return null; // –§–∏–ª—å—Ç—Ä—É–µ–º –∂—ë—Å—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø—Ä–∏ –ø–ª–æ—Ö–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏
                return { ...advice, text: adaptedText };
            }).filter(Boolean);
        })();

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É (–¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–º –≤–∏–¥–µ ‚Äî –±–µ–∑ canShowAdvice)
        // –°–ø–µ—Ü—Ç—Ä–∏–≥–≥–µ—Ä 'manual' ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–≤–µ—Ç—ã –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É
        const allForTrigger = (() => {
            if (!trigger) return [];
            if (isUserBusy(uiState)) return [];

            let advices = moodAdaptedAdvices;

            // Manual trigger ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–≤–µ—Ç—ã
            if (trigger !== 'manual') {
                advices = advices.filter(a => a.triggers.includes(trigger));
            }

            // üß† Smart Prioritization ‚Äî ML-like scoring
            advices = sortBySmartScore(advices, ctx);

            // ‚è∞ –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
            advices = filterByTimeRestrictions(advices);

            // üîÑ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚Äî –∏–∑ –≥—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω
            advices = deduplicateAdvices(advices);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∏—Å—Ç–µ–º—É excludes
            advices = filterByExcludes(advices);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–∞–Ω—Ç–∏—Å–ø–∞–º)
            advices = limitByCategory(advices);

            return advices;
        })();

        // –°–æ–≤–µ—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π cooldown)
        const relevantAdvices = (() => {
            return allForTrigger.filter(a => canShowAdvice(a.id, { canSkipCooldown: a.canSkipCooldown }));
        })();

        // –û—Å–Ω–æ–≤–Ω–æ–π —Å–æ–≤–µ—Ç (–ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π)
        const primary = relevantAdvices[0] || null;

        // –î–æ–±–∞–≤–ª—è–µ–º animation –∫–ª–∞—Å—Å
        const primaryWithAnimation = primary ? {
            ...primary,
            animationClass: getAdviceAnimation(primary)
        } : null;

        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è badge ‚Äî –í–°–ï —Å–æ–≤–µ—Ç—ã –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–±–µ–∑ canShowAdvice)
        const adviceCount = allForTrigger.length;

        // üî¢ Badge advices ‚Äî —Å–æ–≤–µ—Ç—ã –¥–ª—è FAB badge (–∫–∞–∫ trigger='manual', –Ω–æ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç trigger)
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –í–°–ï —Ñ–∏–ª—å—Ç—Ä—ã
        const badgeAdvices = (() => {
            if (isUserBusy(uiState)) return [];

            let advices = moodAdaptedAdvices;

            // üß† Smart Prioritization
            advices = sortBySmartScore(advices, ctx);

            // ‚è∞ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
            advices = filterByTimeRestrictions(advices);

            // üîÑ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
            advices = deduplicateAdvices(advices);

            // Excludes
            advices = filterByExcludes(advices);

            // –õ–∏–º–∏—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            advices = limitByCategory(advices);

            return advices;
        })();

        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö
        const scheduledCount = getScheduledCount();

        return {
            primary: primaryWithAnimation,
            relevant: allForTrigger, // –í—Å–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
            adviceCount,
            badgeAdvices, // –î–ª—è FAB badge ‚Äî –º–∞—Å—Å–∏–≤ —Å–æ–≤–µ—Ç–æ–≤ —Å –ø–æ–ª–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
            scheduledCount,
            allAdvices,
            ctx,
            crashRisk: ctx?.crashRisk, // üÜï –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º crashRisk –¥–ª—è UI
            // –ú–µ—Ç–æ–¥—ã
            markShown: (id) => {
                markAdviceShown(id);
                trackAdviceShown(id); // üìä Tracking
            },
            trackClick: trackAdviceClicked, // üìä Tracking –∫–ª–∏–∫–∞
            rateAdvice, // üëç/üëé Rating
            scheduleAdvice, // ‚è∞ –û—Ç–ª–æ–∂–∏—Ç—å —Å–æ–≤–µ—Ç
            canShow: canShowAdvice,
            resetSession: resetSessionAdvices
        };
    }

    /**
     * üÜï –ü–æ–ª—É—á–µ–Ω–∏–µ crashRisk –∏–∑ Metabolic Intelligence
     * Helper –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–≤–µ—Ç–æ–≤
     * @returns {Object|null} { risk: 0-100, level: 'low'|'medium'|'high', factors: [] }
     */
    function getCrashRiskForContext() {
        if (!window.HEYS?.Metabolic?.calculateCrashRisk24h) {
            return null;
        }

        try {
            return window.HEYS.Metabolic.calculateCrashRisk24h();
        } catch (e) {
            return null;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Helpers registry (shared for category modules)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceCoreHelpers = {
        rules: AdviceRules,
        getProductForItem,
        personalizeText,
        pickRandomText,
        getTimeBasedText,
        getTimePeriod,
        adaptTextToMood,
        getAverageMoodToday,
        calculateAverageMood,
        calculateAverageStress,
        calculateAverageWellbeing,
        getToneForHour,
        getEmotionalState,
        getSpecialDay,
        filterByEmotionalState,
        isUserBusy,
        analyzeProductCategories,
        getDayForecast,
        getWeeklyComparison,
        getWeeklySummary,
        getNextStreakMilestone,
        trackDismiss,
        getDismissPenalty,
        calculateDynamicTTL,
        checkAdviceChain,
        markChainStart: markChainStartForAdvice,
        checkComboAchievements,
        markComboShown,
        trackProductPattern,
        getSmartRecommendation,
        calculateSleepHours,
        getMealTotals,
        getLastMealWithItems,
        getFirstMealWithItems,
        isMilestoneShown,
        markMilestoneShown,
        countUniqueProducts,
        getTotalDaysTracked,
        getPersonalBestStreak,
        updatePersonalBestStreak,
        canShowMealAdvice,
        markMealAdviceShown,
        getRecentDays,
        getAverageBedtime,
        getHoursUntilBedtime,
        getHoursSinceWater,
        hasCoffeeAfterHour,
        getGoalMode,
        isInTargetRange,
        isCriticallyOver,
        isCriticallyUnder
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EXPORTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const adviceRules = AdviceRules;

    const adviceEngine = {
        generateAdvices,
        useAdviceEngine,
        invalidateAdviceCache
    };

    window.HEYS.adviceRules = adviceRules;
    window.HEYS.adviceEngine = adviceEngine;
    window.HEYS.advice = {
        rules: adviceRules,
        engine: adviceEngine,
        useAdviceEngine,
        generateAdvices,
        markShown: markAdviceShown,
        canShow: canShowAdvice,
        resetSessionAdvices,
        // üéØ Goal-aware helpers
        getGoalMode,
        isInTargetRange,
        isCriticallyOver,
        isCriticallyUnder,
        // üîß Filtering & processing
        filterByExcludes,
        limitByCategory,
        applyGoalBoost,
        sortBySmartScore,
        // üìä Tracking & Analytics
        trackAdviceShown,
        trackAdviceClicked,
        getAdviceCTR,
        getTopAdvices,
        getTrackingStats,
        // üëçüëé Rating system
        rateAdvice,
        getAdviceRating,
        getAllRatings,
        // üé® Text helpers
        personalizeText,
        pickRandomText,
        getTimeBasedText,
        getTimePeriod,
        adaptTextToMood,
        getAverageMoodToday,
        // üìã Config ‚Äî –í—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
        THRESHOLDS,
        SEASONAL_TIPS,
        MAX_ADVICES_PER_CATEGORY,
        PRODUCT_CATEGORIES,
        ADVICE_CHAINS,
        DEDUPLICATION_RULES,    // üÜï –ì—Ä—É–ø–ø—ã –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
        TIME_RESTRICTIONS,      // üÜï –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        STREAK_MILESTONES,
        TTL_CONFIG,
        TIME_BASED_TEXTS,
        COMBO_ACHIEVEMENTS,
        MOOD_TONES,
        // üîß Filtering functions
        deduplicateAdvices,       // üÜï –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
        filterByTimeRestrictions, // üÜï –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        // Helper functions –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        getToneForHour,
        getEmotionalState,
        getSpecialDay,
        filterByEmotionalState,
        isUserBusy,
        calculateAverageMood,
        calculateAverageStress,
        calculateAverageWellbeing,
        // Phase 0 helpers (Phase 2 —Å–æ–≤–µ—Ç—ã)
        getMealTotals,
        getLastMealWithItems,
        getFirstMealWithItems,
        isMilestoneShown,
        markMilestoneShown,
        countUniqueProducts,
        getTotalDaysTracked,
        getPersonalBestStreak,
        updatePersonalBestStreak,
        canShowMealAdvice,
        markMealAdviceShown,
        getRecentDays,
        getAverageBedtime,      // üÜï –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–Ω–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        getHoursUntilBedtime,   // üÜï –ß–∞—Å–æ–≤ –¥–æ —Å–Ω–∞ (–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ —Ä–∞—Å—á—ë—Ç–∞)
        // üÜï Phase 3 helpers
        analyzeProductCategories,
        getDayForecast,
        getWeeklyComparison,
        getWeeklySummary,
        getNextStreakMilestone,
        trackDismiss,
        getDismissPenalty,
        calculateDynamicTTL,
        checkAdviceChain,
        markChainStart: markChainStartForAdvice,
        // üÜï Phase 4 helpers
        checkComboAchievements,
        markComboShown,
        trackProductPattern,
        getSmartRecommendation,
        calculateSmartScore,
        // üÜï Phase 5 helpers
        // Settings
        getAdviceSettings,
        setAdviceSettings,
        isCategoryEnabled,
        toggleCategory,
        CATEGORY_LABELS,
        DEFAULT_ADVICE_SETTINGS,
        // Personal Bests
        getPersonalBests,
        checkAndUpdatePersonalBest,
        createPersonalBestAdvice,
        TRACKABLE_METRICS,
        // Chains
        checkChainContinuation,
        generateChainAdvices,
        // Scheduling
        scheduleAdvice,
        getScheduledAdvices,
        getScheduledCount,
        SNOOZE_OPTIONS,
        // Goal-specific
        getGoalSpecificAdvices,
        GOAL_MODES,
        // Animations
        getAdviceAnimation,
        ADVICE_ANIMATIONS,
        // üöÄ Cache management
        invalidateAdviceCache,      // üÜï –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ (–≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ product_added)
        // üéØ Priority constants
        PRIORITY                    // üÜï –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
    };

})();
// ===== End advice/_core.js =====

// ===== Begin advice/_nutrition.js =====
;/**
 * HEYS Advice Module v1 ‚Äî Nutrition
 * @file advice/_nutrition.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.nutrition = function buildNutritionAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const {
            THRESHOLDS,
            PRIORITY,
            PRODUCT_CATEGORIES
        } = rules;

        const {
            dayTot,
            normAbs,
            optimum,
            displayOptimum,
            caloricDebt,
            day,
            pIndex,
            hour,
            mealCount,
            kcalPct,
            prof,
            waterGoal,
            goal,
            proteinPct,
            fatPct,
            carbsPct,
            fiberPct,
            simplePct,
            transPct,
            harmPct,
            goodFatPct,
            isRefeedDay,
            isRefeedExcessOk
        } = ctx;

        const {
            getTimeBasedText,
            pickRandomText,
            personalizeText,
            markChainStart,
            getMealTotals,
            getLastMealWithItems,
            getFirstMealWithItems,
            canShowMealAdvice,
            markMealAdviceShown,
            analyzeProductCategories,
            getDayForecast,
            getWeeklyComparison,
            getRecentDays,
            getProductForItem,
            getHoursUntilBedtime,
            hasCoffeeAfterHour
        } = helpers;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚ö†Ô∏è WARNINGS (priority: 11-30) ‚Äî Goal-aware + Refeed-aware
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (goal && helpers.isCriticallyOver(kcalPct, goal) && !isRefeedExcessOk) {
            const overPct = Math.round((kcalPct - 1) * 100);
            const goalText = goal.mode === 'bulk'
                ? '–î–∞–∂–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ —ç—Ç–æ –º–Ω–æ–≥–æ–≤–∞—Ç–æ'
                : goal.mode === 'deficit'
                    ? '–ü–ª–∞–Ω –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –Ω–∞—Ä—É—à–µ–Ω'
                    : '–°–∏–ª—å–Ω–æ –±–æ–ª—å—à–µ –Ω–æ—Ä–º—ã';
            advices.push({
                id: 'kcal_excess_critical',
                icon: 'üî¥',
                text: `+${overPct}% –æ—Ç –ø–ª–∞–Ω–∞. ${goalText}`,
                details: goal.mode === 'bulk'
                    ? '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞, –Ω–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –∏–∑–±—ã—Ç–æ–∫ —É—Ö–æ–¥–∏—Ç –≤ –∂–∏—Ä. –ó–∞–≤—Ç—Ä–∞ –≤–µ—Ä–Ω–∏—Å—å –≤ –ø–ª–∞–Ω +10-15%.'
                    : '–ù–µ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å! –û–¥–∏–Ω –¥–µ–Ω—å –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ó–∞–≤—Ç—Ä–∞ —Å–¥–µ–ª–∞–π –ª—ë–≥–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏ –≤—Å—ë –≤—ã—Ä–æ–≤–Ω—è–µ—Ç—Å—è.',
                type: 'warning',
                priority: 11,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 6000
            });
        } else if (goal && kcalPct > goal.targetRange.max && !helpers.isCriticallyOver(kcalPct, goal) && !isRefeedExcessOk) {
            const overPct = Math.round((kcalPct - 1) * 100);
            advices.push({
                id: 'kcal_excess_mild',
                icon: '‚ö†Ô∏è',
                text: goal.mode === 'bulk'
                    ? `+${overPct}% ‚Äî —á—É—Ç—å –≤—ã—à–µ –ø–ª–∞–Ω–∞ –Ω–∞–±–æ—Ä–∞`
                    : `+${overPct}% –æ—Ç –ø–ª–∞–Ω–∞ ‚Äî –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ`,
                details: 'üìä –ù–µ–±–æ–ª—å—à–æ–π –ø–µ—Ä–µ–±–æ—Ä –Ω–µ —Å—Ç—Ä–∞—à–µ–Ω. –í–∞–∂–µ–Ω —Ç—Ä–µ–Ω–¥ –∑–∞ –Ω–µ–¥–µ–ª—é, –∞ –Ω–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∏–¥–µ–∞–ª—å–Ω–æ.',
                type: 'tip',
                priority: 15,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        if (goal && helpers.isCriticallyUnder(kcalPct, goal) && hour >= 14) {
            advices.push({
                id: 'kcal_under_critical',
                icon: goal.mode === 'bulk' ? '‚ö†Ô∏è' : 'üåô',
                text: goal.mode === 'bulk'
                    ? `–¢–æ–ª—å–∫–æ ${Math.round(kcalPct * 100)}% ‚Äî –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞–ª–æ!`
                    : goal.mode === 'deficit'
                        ? `${Math.round(kcalPct * 100)}% ‚Äî —Å–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç`
                        : '–°—ä–µ–¥–µ–Ω–æ –º–∞–ª–æ ‚Äî –¥–æ–±–∞–≤—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏—ë–º',
                details: goal.mode === 'bulk'
                    ? '–î–ª—è —Ä–æ—Å—Ç–∞ –º—ã—à—Ü –Ω—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π. –î–æ–±–∞–≤—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –∏ –±–µ–ª–æ–∫.'
                    : '–°–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∑–∞–º–µ–¥–ª—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Å—Ä—ã–≤–∞–º. –õ—É—á—à–µ —É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç 10-15%.',
                type: goal.mode === 'bulk' ? 'warning' : 'tip',
                priority: 16,
                category: 'nutrition',
                triggers: ['tab_open', 'product_added'],
                ttl: 5000
            });
        }

        if (transPct > 1.0) {
            advices.push({
                id: 'trans_fat_warning',
                icon: '‚ö†Ô∏è',
                text: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã –ø—Ä–µ–≤—ã—à–µ–Ω—ã ‚Äî –∏–∑–±–µ–≥–∞–π —Ñ–∞—Å—Ç—Ñ—É–¥–∞',
                details: '–¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã ‚Äî —Å–∞–º—ã–µ –≤—Ä–µ–¥–Ω—ã–µ. –û–Ω–∏ –ø–æ–≤—ã—à–∞—é—Ç "–ø–ª–æ—Ö–æ–π" —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –∏ —Å–Ω–∏–∂–∞—é—Ç "—Ö–æ—Ä–æ—à–∏–π". –ò–∑–±–µ–≥–∞–π: –º–∞—Ä–≥–∞—Ä–∏–Ω, —Ñ–∞—Å—Ç-—Ñ—É–¥, —á–∏–ø—Å—ã, –≤—ã–ø–µ—á–∫–∞ —Å –¥–ª–∏—Ç–µ–ª—å–Ω—ã–º —Å—Ä–æ–∫–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏—è.',
                type: 'warning',
                priority: 12,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        if (simplePct > 1.3) {
            const carbsText = getTimeBasedText('simple_carbs_warning', hour, '–ú–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –æ–≥—Ä–∞–Ω–∏—á—å —Å–ª–∞–¥–∫–æ–µ');
            advices.push({
                id: 'simple_carbs_warning',
                icon: 'üç¨',
                text: carbsText,
                details: '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –±—ã—Å—Ç—Ä–æ –ø–æ–≤—ã—à–∞—é—Ç —Å–∞—Ö–∞—Ä –≤ –∫—Ä–æ–≤–∏, –≤—ã–∑—ã–≤–∞—è –≤—Å–ø–ª–µ—Å–∫ –∏–Ω—Å—É–ª–∏–Ω–∞ –∏ –ø–æ—Ç–æ–º —É–ø–∞–¥–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: —Ñ—Ä—É–∫—Ç—ã, —Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥ 70%+, –æ—Ä–µ—Ö–∏.',
                type: 'warning',
                priority: 14,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        if (harmPct > 1.0) {
            advices.push({
                id: 'harm_warning',
                icon: 'üíî',
                text: '–ú–Ω–æ–≥–æ –≤—Ä–µ–¥–Ω–æ–≥–æ ‚Äî –∑–∞–≤—Ç—Ä–∞ –Ω–∞—á–Ω—ë–º —Å–Ω–∞—á–∞–ª–∞',
                details: '–í—Ä–µ–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏–Ω–æ–≥–¥–∞. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –ó–∞–≤—Ç—Ä–∞ —Å–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –æ–≤–æ—â–∞—Ö, –±–µ–ª–∫–µ –∏ –≤–æ–¥–µ.',
                type: 'warning',
                priority: 13,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üí° TIPS (priority: 31-50) ‚Äî –±–∞–ª–∞–Ω—Å
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (proteinPct < THRESHOLDS.protein.low && hour >= 12) {
            const proteinText = getTimeBasedText('protein_low', hour,
                personalizeText(pickRandomText([
                    '–î–æ–±–∞–≤—å –±–µ–ª–∫–∞ ‚Äî –º—è—Å–æ, —Ä—ã–±–∞, —Ç–≤–æ—Ä–æ–≥',
                    '${firstName}, –±–µ–ª–∫–∞ –º–∞–ª–æ–≤–∞—Ç–æ ‚Äî –¥–æ–±–∞–≤—å!',
                    '–ë–µ–ª–æ–∫ –Ω—É–∂–µ–Ω –º—ã—à—Ü–∞–º ‚Äî –∫—É—Ä–∏—Ü–∞, —è–π—Ü–∞, —Ç–≤–æ—Ä–æ–≥'
                ]), ctx)
            );
            advices.push({
                id: 'protein_low',
                icon: 'ü•©',
                text: proteinText,
                details: '–ë–µ–ª–æ–∫ –≤–∞–∂–µ–Ω –¥–ª—è –º—ã—à—Ü, –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ –∏ —Å—ã—Ç–æ—Å—Ç–∏. –ù–æ—Ä–º–∞: 1.5-2–≥ –Ω–∞ –∫–≥ –≤–µ—Å–∞. –õ—É—á—à–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: –∫—É—Ä–∏—Ü–∞, –∏–Ω–¥–µ–π–∫–∞, —Ä—ã–±–∞, —è–π—Ü–∞, —Ç–≤–æ—Ä–æ–≥, –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç, –±–æ–±–æ–≤—ã–µ.',
                type: 'tip',
                priority: 31,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                excludes: ['post_training_protein', 'deficit_protein_save_muscle', 'bulk_protein_critical'],
                ttl: 5000,
                onShow: () => { markChainStart('protein_low'); }
            });
        }

        if (fiberPct < THRESHOLDS.fiber.low && mealCount >= 2) {
            const fiberDefault = personalizeText(pickRandomText([
                '–ú–∞–ª–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ ‚Äî –¥–æ–±–∞–≤—å –æ–≤–æ—â–µ–π –∏–ª–∏ –∑–ª–∞–∫–æ–≤',
                '–ö–∏—à–µ—á–Ω–∏–∫—É –Ω—É–∂–Ω–∞ –∫–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Äî –æ–≤–æ—â–∏, –∑–µ–ª–µ–Ω—å',
                '${firstName}, –¥–æ–±–∞–≤—å –æ–≤–æ—â–µ–π –¥–ª—è –∫–ª–µ—Ç—á–∞—Ç–∫–∏'
            ]), ctx);
            const fiberText = getTimeBasedText('fiber_low', hour, fiberDefault);
            advices.push({
                id: 'fiber_low',
                icon: 'ü•¨',
                text: fiberText,
                details: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≤–∞–∂–Ω–∞ –¥–ª—è –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è –∏ —Å—ã—Ç–æ—Å—Ç–∏. –ù–æ—Ä–º–∞: 25-35–≥ –≤ –¥–µ–Ω—å. –õ–∏–¥–µ—Ä—ã: –∞–≤–æ–∫–∞–¥–æ, –±—Ä–æ–∫–∫–æ–ª–∏, –æ–≤—Å—è–Ω–∫–∞, —á–µ—á–µ–≤–∏—Ü–∞, –≥—Ä—É—à–∏, –º–∞–ª–∏–Ω–∞, —Å–µ–º–µ–Ω–∞ —á–∏–∞.',
                type: 'tip',
                priority: 32,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                excludes: ['deficit_fiber_satiety'],
                ttl: 5000,
                onShow: () => { markChainStart('fiber_low'); }
            });
        }

        if (fiberPct >= THRESHOLDS.fiber.good) {
            advices.push({
                id: 'fiber_good',
                icon: 'ü•ó',
                text: personalizeText(pickRandomText([
                    '–û—Ç–ª–∏—á–Ω–æ —Å –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π! –ö–∏—à–µ—á–Ω–∏–∫ —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ',
                    '${firstName}, –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –≤ –Ω–æ—Ä–º–µ! üëç',
                    '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ ‚Äî –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ'
                ]), ctx),
                details: 'üå± –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∫–æ—Ä–º–∏—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –±–∞–∫—Ç–µ—Ä–∏–∏ –∫–∏—à–µ—á–Ω–∏–∫–∞, —É–ª—É—á—à–∞–µ—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç –∏ –¥–∞—ë—Ç –¥–æ–ª–≥—É—é —Å—ã—Ç–æ—Å—Ç—å.',
                type: 'achievement',
                priority: 35,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000
            });
        }

        if (goodFatPct < THRESHOLDS.fat.goodRatioLow && hour >= 14) {
            advices.push({
                id: 'good_fat_low',
                icon: 'ü•ë',
                text: personalizeText(pickRandomText([
                    '–î–æ–±–∞–≤—å –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤ ‚Äî –∞–≤–æ–∫–∞–¥–æ, –æ—Ä–µ—Ö–∏, –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ',
                    '–û–º–µ–≥–∞-3 –≤–∞–∂–Ω—ã ‚Äî —Ä—ã–±–∞, –æ—Ä–µ—Ö–∏, –ª—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ',
                    '${firstName}, –Ω–µ –∑–∞–±—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã!'
                ]), ctx),
                details: '–û–º–µ–≥–∞-3 –∏ –º–æ–Ω–æ–Ω–µ–Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã –≤–∞–∂–Ω—ã –¥–ª—è –º–æ–∑–≥–∞, —Å–µ—Ä–¥—Ü–∞ –∏ –≥–æ—Ä–º–æ–Ω–æ–≤. –õ—É—á—à–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: –∂–∏—Ä–Ω–∞—è —Ä—ã–±–∞ (—Å—ë–º–≥–∞, —Å–∫—É–º–±—Ä–∏—è), –∞–≤–æ–∫–∞–¥–æ, –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ, –æ—Ä–µ—Ö–∏ (–≥—Ä–µ—Ü–∫–∏–µ, –º–∏–Ω–¥–∞–ª—å), —Å–µ–º–µ–Ω–∞ –ª—å–Ω–∞ –∏ —á–∏–∞.',
                type: 'tip',
                priority: 33,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                excludes: ['fat_quality_low'],
                ttl: 5000
            });
        }

        if (hour >= 20 && goal && helpers.isCriticallyUnder(kcalPct, goal)) {
            advices.push({
                id: 'evening_undereating',
                icon: goal.mode === 'bulk' ? '‚ö†Ô∏è' : 'üåô',
                text: goal.mode === 'bulk'
                    ? `–¢–æ–ª—å–∫–æ ${Math.round(kcalPct * 100)}% ‚Äî –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞–ª–æ! –î–æ–±–∞–≤—å –≤–µ—á–µ—Ä–Ω–∏–π –ø—Ä–∏—ë–º`
                    : goal.mode === 'deficit'
                        ? '–°–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç ‚Äî –ª—É—á—à–µ –¥–æ–±–∞–≤—å –ª—ë–≥–∫–∏–π —É–∂–∏–Ω'
                        : '–ï—â—ë –º–æ–∂–Ω–æ –ø–æ–µ—Å—Ç—å ‚Äî –Ω–µ –≥–æ–ª–æ–¥–∞–π –ø–µ—Ä–µ–¥ —Å–Ω–æ–º',
                details: goal.mode === 'bulk'
                    ? '–î–ª—è —Ä–æ—Å—Ç–∞ –º—ã—à—Ü –Ω—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏—Ü–∏—Ç. –í–µ—á–µ—Ä–Ω–∏–π –ø—Ä–∏—ë–º: —Ç–≤–æ—Ä–æ–≥ + –æ—Ä–µ—Ö–∏, –∏–ª–∏ –ø—Ä–æ—Ç–µ–∏–Ω + –±–∞–Ω–∞–Ω.'
                    : `üî¨ –î–µ—Ñ–∏—Ü–∏—Ç >500 –∫–∫–∞–ª —Ö—É–∂–µ –ø–æ–∑–¥–Ω–µ–≥–æ —É–∂–∏–Ω–∞!\n\n` +
                    `‚Ä¢ –ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è\n` +
                    `‚Ä¢ –†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –º—ã—à—Ü –∏ –≤—ã–ø–∞–¥–µ–Ω–∏—è –≤–æ–ª–æ—Å\n` +
                    `‚Ä¢ –ü–ª–æ—Ö–æ–π —Å–æ–Ω –æ—Ç –≥–æ–ª–æ–¥–∞ = –µ—â—ë –±–æ–ª—å—à–µ –∞–ø–ø–µ—Ç–∏—Ç–∞ –∑–∞–≤—Ç—Ä–∞\n\n` +
                    `üí° –¢–≤–æ—Ä–æ–≥, —è–π—Ü–∞, –æ—Ä–µ—Ö–∏ ‚Äî –Ω–∞—Å—ã—Ç—è—Ç –±–µ–∑ —Å–∫–∞—á–∫–∞ –∏–Ω—Å—É–ª–∏–Ω–∞`,
                type: goal.mode === 'bulk' ? 'warning' : 'tip',
                priority: 36,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (mealCount >= 2 &&
            proteinPct >= THRESHOLDS.macros.balanceMin && fatPct >= THRESHOLDS.macros.balanceMin && carbsPct >= THRESHOLDS.macros.balanceMin &&
            proteinPct <= THRESHOLDS.macros.balanceMax && fatPct <= THRESHOLDS.macros.balanceMax && carbsPct <= THRESHOLDS.macros.balanceMax) {
            advices.push({
                id: 'balanced_macros',
                icon: '‚öñÔ∏è',
                text: '–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –ë–ñ–£!',
                details: 'üéØ –ë–µ–ª–∫–∏, –∂–∏—Ä—ã –∏ —É–≥–ª–µ–≤–æ–¥—ã –≤ –±–∞–ª–∞–Ω—Å–µ ‚Äî —ç—Ç–æ —Ä–µ–¥–∫–æ—Å—Ç—å! –¢–∞–∫–æ–π –¥–µ–Ω—å –¥–∞—ë—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –∏ —Ö–æ—Ä–æ—à–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ.',
                type: 'achievement',
                priority: 38,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üéØ GOAL-SPECIFIC
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (goal?.mode === 'bulk') {
            if (proteinPct < 0.8 && mealCount >= 1) {
                advices.push({
                    id: 'bulk_protein_critical',
                    icon: 'ü•©',
                    text: '–î–ª—è –Ω–∞–±–æ—Ä–∞ –Ω—É–∂–µ–Ω –±–µ–ª–æ–∫! –î–æ–±–∞–≤—å –º—è—Å–æ, —Ä—ã–±—É –∏–ª–∏ —Ç–≤–æ—Ä–æ–≥',
                    details: '–ü—Ä–∏ –Ω–∞–±–æ—Ä–µ –º–∞—Å—Å—ã –±–µ–ª–æ–∫ ‚Äî –≥–ª–∞–≤–Ω—ã–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª. –ú–∏–Ω–∏–º—É–º 1.8-2.2–≥ –Ω–∞ –∫–≥ –≤–µ—Å–∞. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –ø—Ä–∏—ë–º–∞–º –ø–∏—â–∏.',
                    type: 'tip',
                    priority: 39,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000
                });
            }

            if (carbsPct < 0.7 && mealCount >= 2) {
                advices.push({
                    id: 'bulk_carbs_low',
                    icon: 'üçö',
                    text: '–î–æ–±–∞–≤—å —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî –æ–Ω–∏ –¥–∞—é—Ç —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è —Ä–æ—Å—Ç–∞',
                    details: '–£–≥–ª–µ–≤–æ–¥—ã ‚Äî —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –•–æ—Ä–æ—à–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: —Ä–∏—Å, –≥—Ä–µ—á–∫–∞, –æ–≤—Å—è–Ω–∫–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–∞–∫–∞—Ä–æ–Ω—ã.',
                    type: 'tip',
                    priority: 41,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            if (hour >= 16 && kcalPct < 0.6) {
                advices.push({
                    id: 'bulk_kcal_behind',
                    icon: '‚ö†Ô∏è',
                    text: `–¢–æ–ª—å–∫–æ ${Math.round(kcalPct * 100)}% –æ—Ç –ø–ª–∞–Ω–∞ –Ω–∞–±–æ—Ä–∞ ‚Äî –¥–æ–±–∞–≤—å –∫–∞–ª–æ—Ä–∏–π!`,
                    details: 'üçö –î–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã –Ω—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏—Ü–∏—Ç 10-15%. –î–æ–±–∞–≤—å —É–≥–ª–µ–≤–æ–¥—ã (—Ä–∏—Å, –≥—Ä–µ—á–∫–∞) –∏ –±–µ–ª–æ–∫ (–º—è—Å–æ, —Ç–≤–æ—Ä–æ–≥). –ë–µ–∑ –ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞ –º—ã—à—Ü—ã –Ω–µ —Ä–∞—Å—Ç—É—Ç!',
                    type: 'warning',
                    priority: 40,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        if (goal?.mode === 'deficit') {
            if (proteinPct < 0.9 && mealCount >= 2) {
                advices.push({
                    id: 'deficit_protein_save_muscle',
                    icon: 'üí™',
                    text: '–ù–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –±–µ–ª–æ–∫ –∫—Ä–∏—Ç–∏—á–µ–Ω ‚Äî –æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º—ã—à—Ü—ã',
                    details: '–ü—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–º –º–æ–∂–µ—Ç —Ä–∞–∑—Ä—É—à–∞—Ç—å –º—ã—à—Ü—ã. –ë–µ–ª–æ–∫ 1.6-2–≥ –Ω–∞ –∫–≥ –∑–∞—â–∏—â–∞–µ—Ç –º—ã—à–µ—á–Ω—É—é –º–∞—Å—Å—É. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–µ–∂–∏—Ä–Ω–æ–µ –º—è—Å–æ, —Ä—ã–±–∞, —è–π—Ü–∞.',
                    type: 'tip',
                    priority: 42,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000
                });
            }

            if (fiberPct < 0.5 && mealCount >= 2) {
                advices.push({
                    id: 'deficit_fiber_satiety',
                    icon: 'ü•ó',
                    text: '–î–æ–±–∞–≤—å –æ–≤–æ—â–µ–π ‚Äî –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –¥–∞—ë—Ç —Å—ã—Ç–æ—Å—Ç—å –±–µ–∑ –∫–∞–ª–æ—Ä–∏–π',
                    details: '–ù–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –≤–∞–∂–Ω–æ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å—ã—Ç–æ—Å—Ç—å. –û–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å ‚Äî –æ–±—ä—ë–º –±–µ–∑ –∫–∞–ª–æ—Ä–∏–π. –û–≥—É—Ä—Ü—ã, –ø–æ–º–∏–¥–æ—Ä—ã, –∫–∞–ø—É—Å—Ç–∞, —Å–∞–ª–∞—Ç ‚Äî –µ—à—å —Å–∫–æ–ª—å–∫–æ —Ö–æ—á–µ—à—å.',
                    type: 'tip',
                    priority: 43,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            if (hour >= 18 && kcalPct < 0.7 && kcalPct > 0) {
                advices.push({
                    id: 'deficit_too_harsh',
                    icon: '‚ö†Ô∏è',
                    text: '–°–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç –∑–∞–º–µ–¥–ª—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
                    details: '–†–µ–∑–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Å—Ä—ã–≤–∞–º –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏—é –æ–±–º–µ–Ω–∞ –≤–µ—â–µ—Å—Ç–≤. –õ—É—á—à–µ —É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç 10-15% –Ω–∞ –¥–æ–ª–≥–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏.',
                    type: 'warning',
                    priority: 44,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            const waterPctForCombo = (day?.waterMl || 0) / (waterGoal || 2000);
            if (hour >= 16 && kcalPct < 0.6 && waterPctForCombo < 0.5 && mealCount >= 1) {
                advices.push({
                    id: 'undereating_dehydration_combo',
                    icon: 'üö®',
                    text: '–ú–∞–ª–æ –∫–∞–ª–æ—Ä–∏–π –ò –º–∞–ª–æ –≤–æ–¥—ã ‚Äî –¥–≤–æ–π–Ω–æ–π —Å—Ç—Ä–µ—Å—Å –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞!',
                    details: `üî¨ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∏ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏—è –æ—Å–æ–±–µ–Ω–Ω–æ –æ–ø–∞—Å–Ω–∞:\n\n` +
                        `‚Ä¢ –ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è –µ—â—ë —Å–∏–ª—å–Ω–µ–µ\n` +
                        `‚Ä¢ –ì–æ–ª–æ–¥ —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è (–∂–∞–∂–¥—É –ø—É—Ç–∞—é—Ç —Å –≥–æ–ª–æ–¥–æ–º)\n` +
                        `‚Ä¢ –ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, —Å–ª–∞–±–æ—Å—Ç—å, —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\n` +
                        `‚Ä¢ –ü–æ—á–∫–∏ –∏ –ø–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –∏–∑–Ω–æ—Å\n\n` +
                        `üí° –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–µ–π –≤–æ–¥—ã! –ß–∞—Å—Ç–æ "–≥–æ–ª–æ–¥" = –∂–∞–∂–¥–∞. –ü–æ—Ç–æ–º –ø–æ–µ—à—å.`,
                    type: 'warning',
                    priority: 6,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 7000
                });
            }

            if (helpers.isInTargetRange(kcalPct, goal) && mealCount >= 2) {
                advices.push({
                    id: 'deficit_on_track_motivation',
                    icon: 'üî•',
                    text: '–î–µ—Ñ–∏—Ü–∏—Ç –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!',
                    details: 'üéØ –ü—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ 10-15% —Ç—ã —Ç–µ—Ä—è–µ—à—å ~0.5-1 –∫–≥ –≤ –Ω–µ–¥–µ–ª—é –±–µ–∑ –≤—Ä–µ–¥–∞ –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞. –≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ç–µ–º–ø!',
                    type: 'achievement',
                    priority: 45,
                    category: 'motivation',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        if (goal?.mode === 'maintenance') {
            if (helpers.isInTargetRange(kcalPct, goal) && mealCount >= 2) {
                advices.push({
                    id: 'maintenance_stable',
                    icon: '‚öñÔ∏è',
                    text: '–ö–∞–ª–æ—Ä–∏–∏ –≤ –±–∞–ª–∞–Ω—Å–µ ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å!',
                    details: '‚öñÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –¢—ã –Ω–∞—à—ë–ª —Å–≤–æ–π –±–∞–ª–∞–Ω—Å ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.',
                    type: 'achievement',
                    priority: 46,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üí∞ CALORIC DEBT TIPS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (caloricDebt && caloricDebt.hasDebt) {
            const debtKcal = Math.abs(caloricDebt.totalDebt);
            const dailyBoost = caloricDebt.dailyBoost || 0;
            const daysWithDeficit = caloricDebt.daysWithDeficit || 0;

            if (dailyBoost > 0 && hour >= 10 && !sessionStorage.getItem('heys_debt_info')) {
                advices.push({
                    id: 'caloric_debt_info',
                    icon: 'üí∞',
                    text: `+${dailyBoost} –∫–∫–∞–ª –±–æ–Ω—É—Å –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç!`,
                    details: `üìä –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è –Ω–∞–∫–æ–ø–∏–ª—Å—è –¥–µ—Ñ–∏—Ü–∏—Ç ${debtKcal} –∫–∫–∞–ª. –ù–æ—Ä–º–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–æ ${displayOptimum || optimum} –∫–∫–∞–ª ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–∏.`,
                    type: 'tip',
                    priority: 30,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_debt_info', '1'); } catch (e) { } }
                });
            }

            if (debtKcal >= 500 && daysWithDeficit >= 2) {
                advices.push({
                    id: 'caloric_debt_high',
                    icon: '‚ö†Ô∏è',
                    text: '–ù–∞–∫–æ–ø–∏–ª—Å—è –¥–µ—Ñ–∏—Ü–∏—Ç ‚Äî –º–µ—Ç–∞–±–æ–ª–∏–∑–º –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è',
                    details: `üî¨ ${daysWithDeficit} –¥–Ω—è –ø–æ–¥—Ä—è–¥ –Ω–µ–¥–æ–µ–¥–∞–Ω–∏–µ (‚àí${debtKcal} –∫–∫–∞–ª). –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç —Å–Ω–∏–∂–∞–µ—Ç –ª–µ–ø—Ç–∏–Ω –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–±–º–µ–Ω –≤–µ—â–µ—Å—Ç–≤. –†–∞—Å—Å–º–æ—Ç—Ä–∏ —Ä–µ—Ñ–∏–¥ –∏–ª–∏ —É–≤–µ–ª–∏—á—å –∫–∞–ª–æ—Ä–∏–∏ —Å–µ–≥–æ–¥–Ω—è.`,
                    type: 'warning',
                    priority: 25,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 7000
                });
            }

            const eatenPctOfBoost = dailyBoost > 0 ? (dayTot?.kcal || 0) / displayOptimum : 0;
            if (dailyBoost > 0 && eatenPctOfBoost >= 0.9 && eatenPctOfBoost <= 1.1 && hour >= 18) {
                advices.push({
                    id: 'caloric_debt_repaid',
                    icon: '‚úÖ',
                    text: '–î–æ–ª–≥ –ø–æ–≥–∞—à–∞–µ—Ç—Å—è ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è!',
                    details: 'üéØ –¢—ã —Å—ä–µ–ª —Å —É—á—ë—Ç–æ–º –±–æ–Ω—É—Å–Ω–æ–π –∑–æ–Ω—ã, –Ω–æ –Ω–µ –ø–µ—Ä–µ–µ–ª. –≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –≤–æ—Å–ø–æ–ª–Ω–∏—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç –±–µ–∑ —Å–∫–∞—á–∫–∞ –≤–µ—Å–∞.',
                    type: 'achievement',
                    priority: 10,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            const hasExcess = caloricDebt?.hasExcess;
            const dailyReduction = caloricDebt?.dailyReduction || 0;

            if (dailyReduction > 50 && !hasExcess && hour < 14) {
                advices.push({
                    id: 'excess_soft_correction',
                    icon: 'üéØ',
                    text: `–ù–æ—Ä–º–∞ —á—É—Ç—å —Å–Ω–∏–∂–µ–Ω–∞ (‚àí${dailyReduction} –∫–∫–∞–ª) ‚Äî –º—è–≥–∫–∏–π –∞–∫—Ü–µ–Ω—Ç`,
                    details: 'üìä –≠—Ç–æ –Ω–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ! –ö–æ—Ä—Ä–µ–∫—Ü–∏—è 5-10% –ø–æ–º–æ–≥–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π.',
                    type: 'tip',
                    priority: 35,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            const proteinDebt = caloricDebt?.proteinDebt;
            if (proteinDebt?.hasDebt && proteinDebt.severity !== 'none') {
                const protSeverity = proteinDebt.severity;

                if (protSeverity === 'critical') {
                    advices.push({
                        id: 'protein_debt_critical',
                        icon: 'üö®',
                        text: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –Ω–µ–¥–æ–±–æ—Ä –±–µ–ª–∫–∞ –∑–∞ 3 –¥–Ω—è!',
                        details: `üí™ –°—Ä–µ–¥–Ω–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–µ–ª–∫–∞ ${Math.round(proteinDebt.avgProteinPct * 100)}% –æ—Ç –Ω–æ—Ä–º—ã. –ü—Ä–∏ <18% –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç–µ—Ä—è—Ç—å –º—ã—à—Ü—ã! –°—Ä–æ—á–Ω–æ –¥–æ–±–∞–≤—å –±–µ–ª–∫–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.`,
                        type: 'warning',
                        priority: 12,
                        category: 'nutrition',
                        triggers: ['tab_open'],
                        ttl: 8000
                    });
                } else if (protSeverity === 'moderate') {
                    advices.push({
                        id: 'protein_debt_moderate',
                        icon: 'ü•©',
                        text: '–ú–∞–ª–æ–≤–∞—Ç–æ –±–µ–ª–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏',
                        details: `üçó –°—Ä–µ–¥–Ω–µ–µ ${Math.round(proteinDebt.avgProteinPct * 100)}% –æ—Ç –Ω–æ—Ä–º—ã. –î–æ–±–∞–≤—å —Ç–≤–æ—Ä–æ–≥, —è–π—Ü–∞, –∫—É—Ä–∏—Ü—É –∏–ª–∏ —Ä—ã–±—É ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—à—å –º—ã—à—Ü—ã!`,
                        type: 'tip',
                        priority: 28,
                        category: 'nutrition',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                } else if (protSeverity === 'mild' && hour >= 14) {
                    advices.push({
                        id: 'protein_debt_mild',
                        icon: 'üí™',
                        text: '–ë–µ–ª–æ–∫ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ —Å–µ–≥–æ–¥–Ω—è',
                        details: 'ü•ö –ù–µ–±–æ–ª—å—à–æ–π –Ω–µ–¥–æ–±–æ—Ä –±–µ–ª–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏. –°–µ–≥–æ–¥–Ω—è –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –¥–æ–±—Ä–∞—Ç—å –Ω–æ—Ä–º—É ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –∏ –º—ã—à—Ü.',
                        type: 'tip',
                        priority: 45,
                        category: 'nutrition',
                        triggers: ['tab_open'],
                        ttl: 5000
                    });
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üåà VARIETY
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const allItems = (day?.meals || []).flatMap(m => m.items || []);
        const productNames = allItems.map(it => {
            const product = getProductForItem(it, pIndex);
            return (product?.name || it.name || '').toLowerCase().trim();
        }).filter(Boolean);
        const uniqueProducts = new Set(productNames).size;

        if (productNames.length >= 5 && uniqueProducts < 3) {
            advices.push({
                id: 'variety_low',
                icon: 'üåà',
                text: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Ä–∞—Ü–∏–æ–Ω ‚Äî –¥–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã',
                details: 'ü•ó –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ = –ø–æ–ª–Ω—ã–π —Å–ø–µ–∫—Ç—Ä –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤. –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –µ–¥—ã = —Ä–∞–∑–Ω—ã–µ –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã. –°—Ç–∞—Ä–∞–π—Å—è 10+ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –¥–µ–Ω—å.',
                type: 'tip',
                priority: 45,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üçΩÔ∏è MEAL-LEVEL
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const lastMealWithItems = getLastMealWithItems(day);
        const firstMealWithItems = getFirstMealWithItems(day);
        const lastMealTotals = lastMealWithItems ? getMealTotals(lastMealWithItems, pIndex) : null;

        if (lastMealTotals && lastMealTotals.kcal > THRESHOLDS.meal.tooLarge && canShowMealAdvice()) {
            advices.push({
                id: 'meal_too_large',
                icon: 'üçΩÔ∏è',
                text: personalizeText(`–ë–æ–ª—å—à–æ–π –ø—Ä–∏—ë–º (${Math.round(lastMealTotals.kcal)} –∫–∫–∞–ª)! –°–ª–µ–¥—É—é—â–∏–π —Å–¥–µ–ª–∞–π –ø–æ–ª–µ–≥—á–µ`, ctx),
                details: 'üçΩÔ∏è –ë–æ–ª—å—à–∏–µ –ø—Ä–∏—ë–º—ã –≤—ã–∑—ã–≤–∞—é—Ç —Ä–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫ –∏–Ω—Å—É–ª–∏–Ω–∞ –∏ —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å. –õ—É—á—à–µ 4-5 —Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–æ 300-500 –∫–∫–∞–ª.',
                type: 'tip',
                priority: 71,
                category: 'nutrition',
                triggers: ['product_added'],
                excludes: ['meal_too_small'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealTotals && lastMealTotals.kcal < THRESHOLDS.meal.tooSmall && lastMealTotals.kcal > 0 && mealCount >= 2 && canShowMealAdvice()) {
            advices.push({
                id: 'meal_too_small',
                icon: 'ü•Ñ',
                text: personalizeText(pickRandomText(['–ú–∞–ª–æ–≤–∞—Ç–æ ‚Äî –¥–æ–±–∞–≤—å –µ—â—ë —á—Ç–æ-–Ω–∏–±—É–¥—å', '${firstName}, –º–∞–ª–æ–≤–∞—Ç–æ ‚Äî –¥–æ–±–∞–≤—å –µ—â—ë']), ctx),
                details: 'ü•Ñ –°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–∏—ë–º—ã –Ω–µ –Ω–∞—Å—ã—â–∞—é—Ç –∏ –≤–µ–¥—É—Ç –∫ –ø–µ—Ä–µ–∫—É—Å–∞–º. –ú–∏–Ω–∏–º—É–º 150-200 –∫–∫–∞–ª –Ω–∞ –ø—Ä–∏—ë–º –¥–ª—è —Å—ã—Ç–æ—Å—Ç–∏.',
                type: 'tip',
                priority: 72,
                category: 'nutrition',
                triggers: ['product_added'],
                excludes: ['meal_too_large'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealTotals && lastMealTotals.prot < THRESHOLDS.meal.proteinMin && lastMealTotals.kcal > 200 && canShowMealAdvice()) {
            advices.push({
                id: 'protein_per_meal_low',
                icon: 'ü•ö',
                text: '–ú–∞–ª–æ –±–µ–ª–∫–∞ –≤ –ø—Ä–∏—ë–º–µ ‚Äî –¥–æ–±–∞–≤—å —è–π—Ü–æ –∏–ª–∏ —Ç–≤–æ—Ä–æ–≥',
                details: 'üí™ 20-30–≥ –±–µ–ª–∫–∞ –Ω–∞ –ø—Ä–∏—ë–º ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à—Ü. –Ø–π—Ü–æ = 6–≥, 100–≥ —Ç–≤–æ—Ä–æ–≥–∞ = 18–≥, –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ = 31–≥.',
                type: 'tip',
                priority: 73,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (hour >= 20 && lastMealTotals && lastMealTotals.carbs > 50 && canShowMealAdvice()) {
            advices.push({
                id: 'evening_carbs_high',
                icon: 'üåô',
                text: `${Math.round(lastMealTotals.carbs)}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –Ω–∞ –Ω–æ—á—å ‚Äî —É—Ç—Ä–æ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–æ–ª–æ–¥–Ω–æ`,
                details: 'üåú –£–≥–ª–µ–≤–æ–¥—ã –≤–µ—á–µ—Ä–æ–º –≤—ã–∑—ã–≤–∞—é—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –≤—Å–ø–ª–µ—Å–∫ –∏ –ø–∞–¥–µ–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞ –Ω–æ—á—å—é. –õ—É—á—à–µ –±–µ–ª–æ–∫ + –æ–≤–æ—â–∏ –Ω–∞ —É–∂–∏–Ω.',
                type: 'tip',
                priority: 74,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealTotals && lastMealTotals.fiber > 8 && canShowMealAdvice()) {
            advices.push({
                id: 'fiber_per_meal_good',
                icon: 'ü•ó',
                text: '–û—Ç–ª–∏—á–Ω–æ —Å –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π! –ù–∞–¥–æ–ª–≥–æ –Ω–∞—Å—ã—Ç–∏—Ç',
                details: 'ü•¶ 8+ –≥—Ä–∞–º–º –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –≤ –ø—Ä–∏—ë–º–µ ‚Äî —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–æ! –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ –¥–æ–ª—å—à–µ –¥–µ—Ä–∂–∏—Ç —Å—ã—Ç—ã–º.',
                type: 'achievement',
                priority: 75,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealWithItems && lastMealWithItems.items?.length >= 4 && canShowMealAdvice()) {
            advices.push({
                id: 'variety_meal_good',
                icon: 'üåà',
                text: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –ø—Ä–∏—ë–º ‚Äî —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!',
                details: 'üåü –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ = –±–æ–ª—å—à–µ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤. –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –µ–¥—ã = —Ä–∞–∑–Ω—ã–µ –≤–∏—Ç–∞–º–∏–Ω—ã –∏ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã.',
                type: 'achievement',
                priority: 76,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000,
                onShow: () => markMealAdviceShown()
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üéØ MEAL QUALITY SCORE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (lastMealWithItems && window.HEYS?.getMealQualityScore && canShowMealAdvice()) {
            const mealTypeInfo = window.HEYS.getMealType?.(lastMealWithItems) || { type: 'snack' };
            const quality = window.HEYS.getMealQualityScore(lastMealWithItems, mealTypeInfo.type, optimum || 2000, pIndex);

            if (quality?.score !== undefined) {
                if (quality.score >= 85) {
                    advices.push({
                        id: 'meal_quality_excellent',
                        icon: '‚≠ê',
                        text: `–û—Ç–ª–∏—á–Ω—ã–π –ø—Ä–∏—ë–º! –ö–∞—á–µ—Å—Ç–≤–æ ${quality.score}/100`,
                        details: 'üèÜ Score 85+ –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–∞–∫—Ä–æ—Å–æ–≤, —Ö–æ—Ä–æ—à–∏–π –ì–ò –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–ª–∫–∞. –¢–∞–∫ –∏ –Ω–∞–¥–æ!',
                        type: 'achievement',
                        priority: PRIORITY.ACHIEVEMENT,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 4000,
                        onShow: () => markMealAdviceShown()
                    });
                } else if (quality.score >= 70) {
                    advices.push({
                        id: 'meal_quality_good',
                        icon: '‚úì',
                        text: `–ù–µ–ø–ª–æ—Ö–æ–π –ø—Ä–∏—ë–º (${quality.score}/100)`,
                        details: 'üëç Score 70-84 ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–æ! –ú–µ–ª–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è: –±–æ–ª—å—à–µ –±–µ–ª–∫–∞ –∏–ª–∏ –º–µ–Ω—å—à–µ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤.',
                        type: 'tip',
                        priority: PRIORITY.NORMAL + 8,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 4000,
                        onShow: () => markMealAdviceShown()
                    });
                } else if (quality.score < 50) {
                    const issues = [];
                    if (quality.badges?.some(b => b.type === '–ë')) issues.push('–¥–æ–±–∞–≤—å –±–µ–ª–∫–∞');
                    if (quality.badges?.some(b => b.type === '–¢–ñ')) issues.push('–º–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å-–∂–∏—Ä–æ–≤');
                    if (quality.badges?.some(b => b.type === '–ì–ò')) issues.push('–≤—ã—Å–æ–∫–∏–π –ì–ò');
                    if (quality.badges?.some(b => b.type === 'üåô')) issues.push('–ø–æ–∑–¥–Ω–æ–≤–∞—Ç–æ');

                    const issueText = issues.length > 0 ? ` ‚Äî ${issues.slice(0, 2).join(', ')}` : '';

                    advices.push({
                        id: 'meal_quality_poor',
                        icon: '‚ö†Ô∏è',
                        text: `–ü—Ä–∏—ë–º –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å (${quality.score}/100)${issueText}`,
                        details: 'üí° Score < 50 ‚Äî –µ—Å—Ç—å –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å. –°–æ–≤–µ—Ç: –¥–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫ –±–µ–ª–∫–∞ (—è–π—Ü–æ, —Ç–≤–æ—Ä–æ–≥) –∏–ª–∏ –∑–∞–º–µ–Ω–∏ –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –Ω–∞ —Å–ª–æ–∂–Ω—ã–µ.',
                        type: 'warning',
                        priority: PRIORITY.NUTRITION,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 5000,
                        onShow: () => markMealAdviceShown()
                    });
                }

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yKey = `heys_dayv2_${yesterday.toISOString().slice(0, 10)}`;
                const yesterdayDay = window.HEYS?.utils?.lsGet?.(yKey);

                if (yesterdayDay?.meals?.length > 0) {
                    let yScoreSum = 0, yCount = 0;
                    let tScoreSum = 0, tCount = 0;

                    for (const m of yesterdayDay.meals) {
                        if (m.items?.length > 0) {
                            const mt = window.HEYS.getMealType?.(m) || { type: 'snack' };
                            const qs = window.HEYS.getMealQualityScore(m, mt.type, optimum || 2000, pIndex);
                            if (qs?.score) { yScoreSum += qs.score; yCount++; }
                        }
                    }

                    for (const m of (day?.meals || [])) {
                        if (m.items?.length > 0) {
                            const mt = window.HEYS.getMealType?.(m) || { type: 'snack' };
                            const qs = window.HEYS.getMealQualityScore(m, mt.type, optimum || 2000, pIndex);
                            if (qs?.score) { tScoreSum += qs.score; tCount++; }
                        }
                    }

                    if (yCount >= 2 && tCount >= 2) {
                        const yAvg = yScoreSum / yCount;
                        const tAvg = tScoreSum / tCount;
                        const diff = tAvg - yAvg;

                        if (diff >= 10) {
                            advices.push({
                                id: 'meal_quality_improving',
                                icon: 'üìà',
                                text: `–ö–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã —É–ª—É—á—à–∞–µ—Ç—Å—è! +${Math.round(diff)} –∑–∞ –¥–µ–Ω—å`,
                                details: 'üöÄ –°—Ä–µ–¥–Ω–∏–π score –ø—Ä–∏—ë–º–æ–≤ —Å–µ–≥–æ–¥–Ω—è –≤—ã—à–µ —á–µ–º –≤—á–µ—Ä–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!',
                                type: 'achievement',
                                priority: PRIORITY.ACHIEVEMENT,
                                category: 'nutrition',
                                triggers: ['tab_open'],
                                ttl: 5000
                            });
                        }
                    }
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìä DAY-QUALITY
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if ((dayTot?.trans || 0) === 0 && mealCount >= 2) {
            advices.push({
                id: 'trans_free_day',
                icon: 'üéâ',
                text: '–î–µ–Ω—å –±–µ–∑ —Ç—Ä–∞–Ω—Å-–∂–∏—Ä–æ–≤!',
                details: 'üíö –¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã ‚Äî —Å–∞–º—ã–µ –≤—Ä–µ–¥–Ω—ã–µ –¥–ª—è —Å–µ—Ä–¥—Ü–∞. –û—Ç–ª–∏—á–Ω–æ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –±–µ–∑ –Ω–∏—Ö!',
                type: 'achievement',
                priority: 81,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if ((dayTot?.simple || 0) < 25 && (dayTot?.simple || 0) > 0 && mealCount >= 2) {
            advices.push({
                id: 'sugar_low_day',
                icon: 'üç¨',
                text: '–ü–æ—á—Ç–∏ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞ ‚Äî –æ—Ç–ª–∏—á–Ω–æ! üö´',
                details: 'üèÜ –ú–µ–Ω–µ–µ 25–≥ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî —ç—Ç–æ –∫—Ä—É—Ç–æ! –ù–æ—Ä–º–∞ –í–û–ó: –º–∞–∫—Å 50–≥ —Å–∞—Ö–∞—Ä–∞ –≤ –¥–µ–Ω—å, –∏–¥–µ–∞–ª ‚Äî –¥–æ 25–≥.',
                type: 'achievement',
                priority: 82,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const uniqueProductCount = helpers.countUniqueProducts(day);
        if (uniqueProductCount >= 10) {
            advices.push({
                id: 'variety_day_good',
                icon: 'üåà',
                text: `${uniqueProductCount} —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ!`,
                details: 'ü•ó 10+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ = –ø–æ–ª–Ω—ã–π —Å–ø–µ–∫—Ç—Ä –≤–∏—Ç–∞–º–∏–Ω–æ–≤, –º–∏–Ω–µ—Ä–∞–ª–æ–≤ –∏ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–æ–≤. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!',
                type: 'achievement',
                priority: 84,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (helpers.isInTargetRange(kcalPct, goal) && hour >= 12 && mealCount >= 2) {
            advices.push({
                id: 'goal_on_track',
                icon: goal.emoji,
                text: goal.mode === 'bulk'
                    ? '–ù–∞–±–æ—Ä –∏–¥—ë—Ç –ø–æ –ø–ª–∞–Ω—É! üí™'
                    : goal.mode === 'deficit'
                        ? '–î–µ—Ñ–∏—Ü–∏—Ç –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è! üî•'
                        : '–ö–∞–ª–æ—Ä–∏–∏ –≤ –Ω–æ—Ä–º–µ! ‚öñÔ∏è',
                details: 'üèÜ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –∫–ª—é—á –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–ª–∞–Ω–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ —Ü–µ–ª–∏!',
                type: 'achievement',
                priority: 85,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ü•ú AFTER SWEET
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const lastMeal = (day?.meals || []).slice(-1)[0];
        if (lastMeal && lastMeal.items?.length > 0) {
            let lastMealSimple = 0, lastMealCarbs = 0, lastMealKcal = 0;
            for (const item of lastMeal.items) {
                const product = getProductForItem(item, pIndex);
                if (!product) continue;
                const grams = item.grams || 100;
                lastMealSimple += (product.simple100 || 0) * grams / 100;
                lastMealCarbs += ((product.simple100 || 0) + (product.complex100 || 0)) * grams / 100;
                lastMealKcal += (product.kcal100 || 0) * grams / 100;
            }
            const lastMealSimplePct = lastMealCarbs > 0 ? (lastMealSimple / lastMealCarbs) : 0;

            if (lastMealSimplePct > 0.6 && lastMealKcal > 100) {
                advices.push({
                    id: 'after_sweet_protein',
                    icon: 'ü•ú',
                    text: '–ü–æ—Å–ª–µ —Å–ª–∞–¥–∫–æ–≥–æ –¥–æ–±–∞–≤—å –±–µ–ª–æ–∫ ‚Äî –æ—Ä–µ—Ö–∏ –∏–ª–∏ —Ç–≤–æ—Ä–æ–≥',
                    details: '‚öñÔ∏è –ë–µ–ª–æ–∫ –∑–∞–º–µ–¥–ª—è–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞ –∏ —Å–º—è–≥—á–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π —Å–∫–∞—á–æ–∫. –ì–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤ –∏–ª–∏ –ª–æ–∂–∫–∞ —Ç–≤–æ—Ä–æ–≥–∞ —Å–ø–∞—Å—É—Ç —Å–∏—Ç—É–∞—Ü–∏—é.',
                    type: 'tip',
                    priority: 55,
                    category: 'nutrition',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìä NUTRITION QUALITY
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const avgGI = dayTot?.gi || 0;

        if (window.HEYS?.InsulinWave) {
            try {
                const iwData = window.HEYS.InsulinWave.calculate({
                    meals: day?.meals || [],
                    pIndex: window.HEYS?.day?.productIndex,
                    getProductFromItem: (item, idx) => {
                        if (!idx?.byId) return null;
                        return idx.byId.get(item.product_id) || idx.byId.get(String(item.product_id));
                    },
                    baseWaveHours: prof?.insulinWaveHours || 3
                });

                if (iwData && iwData.status !== 'ready' && iwData.avgGI > 65) {
                    const remainingText = iwData.remaining > 60
                        ? Math.round(iwData.remaining / 60) + '—á'
                        : Math.round(iwData.remaining) + ' –º–∏–Ω';

                    advices.push({
                        id: 'high_gi_during_wave',
                        icon: '‚ö°',
                        text: `–ì–ò ${iwData.avgGI} –≤–æ –≤—Ä–µ–º—è –≤–æ–ª–Ω—ã (${remainingText}) ‚Äî —Å–∞—Ö–∞—Ä –≤ –∫—Ä–æ–≤–∏ –ø–æ–¥—Å–∫–æ—á–∏—Ç`,
                        type: 'warning',
                        priority: 8,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 6000
                    });
                }

                if (iwData && iwData.status !== 'ready' && iwData.avgGI <= 40) {
                    advices.push({
                        id: 'low_gi_during_wave',
                        icon: 'üëç',
                        text: `–ì–ò ${iwData.avgGI} ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–æ–ª–Ω—ã!`,
                        type: 'achievement',
                        priority: 35,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 4000
                    });
                }
            } catch (e) {
                // ignore
            }
        }

        if (avgGI > 70 && mealCount >= 2) {
            advices.push({
                id: 'high_gi_warning',
                icon: 'üìà',
                text: `–°—Ä–µ–¥–Ω–∏–π –ì–ò ${Math.round(avgGI)} ‚Äî –¥–æ–±–∞–≤—å –±–µ–ª–æ–∫ –∏ –∫–ª–µ—Ç—á–∞—Ç–∫—É`,
                details: 'üìâ –í—ã—Å–æ–∫–∏–π –ì–ò = —Å–∫–∞—á–∫–∏ —Å–∞—Ö–∞—Ä–∞ –∏ –≥–æ–ª–æ–¥. –ë–µ–ª–æ–∫ –∏ –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –∑–∞–º–µ–¥–ª—è—é—Ç —É—Å–≤–æ–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤.',
                type: 'tip',
                priority: 33,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        if (avgGI > 0 && avgGI <= 55 && mealCount >= 2) {
            advices.push({
                id: 'low_gi_great',
                icon: 'üíö',
                text: `–ì–ò ${Math.round(avgGI)} ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –≤–µ—Å—å –¥–µ–Ω—å`,
                details: 'üåø –ù–∏–∑–∫–∏–π –ì–ò = —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –±–µ–∑ —Å–∫–∞—á–∫–æ–≤. –¢—ã –Ω–µ —á—É–≤—Å—Ç–≤—É–µ—à—å –≥–æ–ª–æ–¥–∞ –∏ —É–ø–∞–¥–∫–∞ —Å–∏–ª.',
                type: 'achievement',
                priority: 36,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        const simpleCarbs = dayTot?.simple || 0;
        const complexCarbs = dayTot?.complex || 0;
        const totalCarbs = simpleCarbs + complexCarbs;

        if (totalCarbs > 50) {
            const simpleRatio = simpleCarbs / totalCarbs;

            if (simpleRatio > 0.5) {
                advices.push({
                    id: 'simple_complex_ratio',
                    icon: '‚öñÔ∏è',
                    text: `${Math.round(simpleRatio * 100)}% –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî –¥–æ–±–∞–≤—å –∫–∞—à–∏, —Ö–ª–µ–±`,
                    details: 'üåæ –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 70% —Å–ª–æ–∂–Ω—ã—Ö (–∫–∞—à–∏, —Ö–ª–µ–±, –º–∞–∫–∞—Ä–æ–Ω—ã) / 30% –ø—Ä–æ—Å—Ç—ã—Ö (—Ñ—Ä—É–∫—Ç—ã, –º—ë–¥). –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ 3-4 —á–∞—Å–∞ –±–µ–∑ —Å–∫–∞—á–∫–æ–≤ —Å–∞—Ö–∞—Ä–∞.',
                    type: 'tip',
                    priority: 34,
                    category: 'nutrition',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }

            if (simpleRatio <= 0.3 && mealCount >= 2) {
                advices.push({
                    id: 'carbs_balance_perfect',
                    icon: 'üåæ',
                    text: '–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å —É–≥–ª–µ–≤–æ–¥–æ–≤!',
                    details: 'üåæ 70% —Å–ª–æ–∂–Ω—ã—Ö / 30% –ø—Ä–æ—Å—Ç—ã—Ö ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏.',
                    type: 'achievement',
                    priority: 37,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        const goodFat = dayTot?.good || 0;
        const badFat = dayTot?.bad || 0;
        const transFat = dayTot?.trans || 0;
        const totalFat = goodFat + badFat + transFat;

        if (totalFat > 20) {
            const goodRatio = goodFat / totalFat;

            if (goodRatio < 0.4) {
                advices.push({
                    id: 'fat_quality_low',
                    icon: 'üêü',
                    text: '–î–æ–±–∞–≤—å –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤ ‚Äî —Ä—ã–±–∞, –æ—Ä–µ—Ö–∏, –∞–≤–æ–∫–∞–¥–æ',
                    details: 'üß† –ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã (–æ–º–µ–≥–∞-3) –Ω—É–∂–Ω—ã –¥–ª—è –º–æ–∑–≥–∞, —Å–µ—Ä–¥—Ü–∞ –∏ –≥–æ—Ä–º–æ–Ω–æ–≤. –°—ë–º–≥–∞, –≥—Ä–µ—Ü–∫–∏–µ –æ—Ä–µ—Ö–∏, –∞–≤–æ–∫–∞–¥–æ.',
                    type: 'tip',
                    priority: 32,
                    category: 'nutrition',
                    triggers: ['product_added', 'tab_open'],
                    ttl: 5000
                });
            }

            if (goodRatio >= 0.6) {
                advices.push({
                    id: 'fat_quality_great',
                    icon: 'üíö',
                    text: `${Math.round(goodRatio * 100)}% –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤ ‚Äî —Å—É–ø–µ—Ä!`,
                    details: '‚ù§Ô∏è –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∂–∏—Ä–æ–≤! –¢–≤–æ—ë —Å–µ—Ä–¥—Ü–µ –∏ –º–æ–∑–≥ —Å–∫–∞–∂—É—Ç —Å–ø–∞—Å–∏–±–æ.',
                    type: 'achievement',
                    priority: 38,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚òï Caffeine timing (nutrition category)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const coffeeCheck = (() => {
            const bedInfo = getHoursUntilBedtime(hour, prof);
            const hoursToSleep = bedInfo.hoursUntilBed;

            const caffeineUnsafeHour = bedInfo.source === 'history'
                ? Math.max(12, 24 - 6 + parseInt(bedInfo.bedtimeFormatted.split(':')[0]) - 24)
                : 16;

            return {
                hasCoffee: hasCoffeeAfterHour(day?.meals, Math.min(caffeineUnsafeHour, 16), pIndex),
                bedtime: bedInfo.bedtimeFormatted,
                hoursToSleep,
                source: bedInfo.source
            };
        })();

        if (coffeeCheck.hasCoffee && !sessionStorage.getItem('heys_caffeine_tip')) {
            const coffeeDetail = coffeeCheck.source === 'history'
                ? `‚è∞ –¢—ã –æ–±—ã—á–Ω–æ –∑–∞—Å—ã–ø–∞–µ—à—å –≤ ${coffeeCheck.bedtime}. –ö–æ—Ñ–µ–∏–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç 6-8 —á–∞—Å–æ–≤ ‚Äî –º–æ–∂–µ—Ç –ø–æ–º–µ—à–∞—Ç—å –∑–∞—Å–Ω—É—Ç—å!`
                : '‚è∞ –ö–æ—Ñ–µ–∏–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç 6-8 —á–∞—Å–æ–≤. –ö–æ—Ñ–µ –≤ 16:00 = –∫–æ—Ñ–µ–∏–Ω –≤ –∫—Ä–æ–≤–∏ –¥–æ –ø–æ–ª—É–Ω–æ—á–∏.';

            advices.push({
                id: 'caffeine_evening',
                icon: '‚òï',
                text: coffeeCheck.hoursToSleep <= 6
                    ? `–î–æ —Å–Ω–∞ ${Math.round(coffeeCheck.hoursToSleep)}—á ‚Äî –∫–æ—Ñ–µ–∏–Ω –µ—â—ë –≤ –∫—Ä–æ–≤–∏!`
                    : '–ö–æ—Ñ–µ –≤–µ—á–µ—Ä–æ–º –º–æ–∂–µ—Ç —É—Ö—É–¥—à–∏—Ç—å —Å–æ–Ω',
                details: coffeeDetail + '\n\nüí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –¥–µ–∫–∞—Ñ, –∑–µ–ª—ë–Ω—ã–π —á–∞–π, —Ü–∏–∫–æ—Ä–∏–π.',
                type: coffeeCheck.hoursToSleep <= 4 ? 'warning' : 'tip',
                priority: coffeeCheck.hoursToSleep <= 4 ? 25 : 42,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_caffeine_tip', '1'); } catch (e) { } }
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ü•ó SMART PRODUCT CATEGORIES
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (mealCount >= 2) {
            const categories = analyzeProductCategories(day, pIndex);

            if (categories.missing.includes('vegetables') && !sessionStorage.getItem('heys_veggies_tip')) {
                const config = PRODUCT_CATEGORIES.vegetables;
                advices.push({
                    id: 'missing_vegetables',
                    icon: config.icon,
                    text: config.advice,
                    details: 'ü•ó –û–≤–æ—â–∏ = –∫–ª–µ—Ç—á–∞—Ç–∫–∞ + –≤–∏—Ç–∞–º–∏–Ω—ã + —Å—ã—Ç–æ—Å—Ç—å –ø—Ä–∏ –º–∏–Ω–∏–º—É–º–µ –∫–∞–ª–æ—Ä–∏–π. –î–æ–±–∞–≤—å —Å–∞–ª–∞—Ç –∏–ª–∏ –æ–≤–æ—â–∏ –≤ –±–ª—é–¥–æ.',
                    type: 'tip',
                    priority: 52,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_veggies_tip', '1'); } catch (e) { } }
                });
            }

            if (categories.missing.includes('dairy') && !sessionStorage.getItem('heys_dairy_tip')) {
                const config = PRODUCT_CATEGORIES.dairy;
                advices.push({
                    id: 'missing_dairy',
                    icon: config.icon,
                    text: config.advice,
                    details: 'üßÄ –ú–æ–ª–æ—á–∫–∞ = –∫–∞–ª—å—Ü–∏–π + –±–µ–ª–æ–∫ + –ø—Ä–æ–±–∏–æ—Ç–∏–∫–∏ (–π–æ–≥—É—Ä—Ç). –î–ª—è –∫–æ—Å—Ç–µ–π –∏ –º—ã—à—Ü.',
                    type: 'tip',
                    priority: 53,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_dairy_tip', '1'); } catch (e) { } }
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìä DAY FORECAST
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (hour >= 11 && hour <= 18 && mealCount >= 1 && !sessionStorage.getItem('heys_forecast_shown')) {
            const forecast = getDayForecast(kcalPct, hour, mealCount);

            if (forecast && forecast.trend !== 'on_track') {
                advices.push({
                    id: 'day_forecast',
                    icon: forecast.trend === 'under' ? 'üìâ' : 'üìà',
                    text: forecast.message,
                    details: 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ–º–ø–∞. –ú–æ–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è.',
                    type: 'insight',
                    priority: 42,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_forecast_shown', '1'); } catch (e) { } }
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_nutrition.js =====

// ===== Begin advice/_timing.js =====
;/**
 * HEYS Advice Module v1 ‚Äî Timing
 * @file advice/_timing.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.timing = function buildTimingAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { PRIORITY, THRESHOLDS } = rules;

        const { day, hour, mealCount, prof, kcalPct, optimum } = ctx;

        const toMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + (m || 0);
        };

        const mealsWithItems = (day?.meals || []).filter(m => m.items?.length > 0 && m.time);
        const mealTimes = mealsWithItems.map(m => toMinutes(m.time)).sort((a, b) => a - b);

        const lastMealWithItems = helpers.getLastMealWithItems(day);
        const firstMealWithItems = helpers.getFirstMealWithItems(day);

        // late_first_meal ‚Äî –ø–æ–∑–¥–Ω–∏–π –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º
        if (firstMealWithItems && hour >= 13) {
            const fmHour = toMinutes(firstMealWithItems.time) / 60;
            if (fmHour >= 12) {
                advices.push({
                    id: 'late_first_meal',
                    icon: '‚è∞',
                    text: '–ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–æ–∑–¥–Ω–æ–≤–∞—Ç–æ ‚Äî –∑–∞–≤—Ç—Ä–∞ –ø–æ–ø—Ä–æ–±—É–π —Ä–∞–Ω—å—à–µ',
                    details: '‚òï –ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –¥–æ 12:00 –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –¥–∞—ë—Ç —ç–Ω–µ—Ä–≥–∏—é. –ü–æ–∑–¥–Ω–∏–π –∑–∞–≤—Ç—Ä–∞–∫ = –ø–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω.',
                    type: 'tip',
                    priority: 77,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // fasting_window_good ‚Äî 14+ —á–∞—Å–æ–≤ –±–µ–∑ –µ–¥—ã (—É–∂–∏–Ω‚Üí–∑–∞–≤—Ç—Ä–∞–∫)
        if (firstMealWithItems && hour >= 10) {
            const yesterdayDays = helpers.getRecentDays(1);
            const yesterdayDay = yesterdayDays[0];
            const yesterdayLastMeal = helpers.getLastMealWithItems(yesterdayDay);

            if (yesterdayLastMeal) {
                const lastH = Math.floor(toMinutes(yesterdayLastMeal.time) / 60);
                const firstH = Math.floor(toMinutes(firstMealWithItems.time) / 60);
                const fastingWindow = (24 - lastH) + firstH;

                if (fastingWindow >= 14 && !sessionStorage.getItem('heys_fasting_good')) {
                    advices.push({
                        id: 'fasting_window_good',
                        icon: 'üïê',
                        text: `${fastingWindow}+ —á–∞—Å–æ–≤ –±–µ–∑ –µ–¥—ã ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ –æ–∫–Ω–æ!`,
                        details: '‚è∞ 14+ —á–∞—Å–æ–≤ –Ω–æ—á–Ω–æ–≥–æ –≥–æ–ª–æ–¥–∞–Ω–∏—è = –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ. –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –∞—É—Ç–æ—Ñ–∞–≥–∏—é –∏ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ.',
                        type: 'achievement',
                        priority: 91,
                        category: 'timing',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_fasting_good', '1'); } catch (e) { } }
                    });
                }
            }
        }

        // lipolysis_going_strong / long_fast_warning
        if (mealTimes.length >= 1 && hour >= 10 && hour <= 18) {
            const lastMealMinutes = mealTimes[mealTimes.length - 1];
            const nowMinutes = hour * 60 + new Date().getMinutes();
            const gapHours = (nowMinutes - lastMealMinutes) / 60;

            if (gapHours > 5 && gapHours <= 7) {
                advices.push({
                    id: 'lipolysis_going_strong',
                    icon: 'üî•',
                    text: `${Math.round(gapHours)}—á –±–µ–∑ –µ–¥—ã ‚Äî –ª–∏–ø–æ–ª–∏–∑ –≤ —Ä–∞–∑–≥–∞—Ä–µ! –î–µ—Ä–∂–∏—Å—å!`,
                    details: 'üî• –ü–æ—Å–ª–µ 4-5 —á–∞—Å–æ–≤ –±–µ–∑ –µ–¥—ã –∏–Ω—Å—É–ª–∏–Ω –ø–∞–¥–∞–µ—Ç –∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ. –¢—ã —Å–µ–π—á–∞—Å –≤ —Ä–µ–∂–∏–º–µ –ª–∏–ø–æ–ª–∏–∑–∞!',
                    type: 'achievement',
                    priority: 92,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            } else if (gapHours > 7) {
                advices.push({
                    id: 'long_fast_warning',
                    icon: '‚ö†Ô∏è',
                    text: `${Math.round(gapHours)}—á –±–µ–∑ –µ–¥—ã ‚Äî –∫–æ–≥–¥–∞ –ø–æ–µ—à—å, –≤—ã–±–∏—Ä–∞–π –Ω–∏–∑–∫–∏–π –ì–ò!`,
                    details: 'ü•ó –ü–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ –æ—Ä–≥–∞–Ω–∏–∑–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ —É–≥–ª–µ–≤–æ–¥–∞–º. –ù–∞—á–Ω–∏ —Å –±–µ–ª–∫–∞ + –æ–≤–æ—â–∏, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤—å —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã.',
                    type: 'tip',
                    priority: 92,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // meal_spacing_perfect / frequent_eating_no_lipolysis
        if (mealTimes.length >= 3) {
            const gaps = [];
            for (let i = 1; i < mealTimes.length; i++) {
                gaps.push((mealTimes[i] - mealTimes[i - 1]) / 60);
            }
            const allGapsGood = gaps.every(g => g >= 3 && g <= 5);

            if (allGapsGood && !sessionStorage.getItem('heys_spacing_perfect')) {
                advices.push({
                    id: 'meal_spacing_perfect',
                    icon: 'üî•',
                    text: '–ò–¥–µ–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã! –ú–∞–∫—Å–∏–º—É–º –≤—Ä–µ–º–µ–Ω–∏ –≤ –ª–∏–ø–æ–ª–∏–∑–µ',
                    details: '‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã 3-5 —á–∞—Å–æ–≤ = –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Ä–µ–∂–∏–º–µ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏. –ò–Ω—Å—É–ª–∏–Ω —É—Å–ø–µ–≤–∞–µ—Ç —Å–Ω–∏–∑–∏—Ç—å—Å—è, –∏ –æ—Ä–≥–∞–Ω–∏–∑–º –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞.',
                    type: 'achievement',
                    priority: 93,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_spacing_perfect', '1'); } catch (e) { } }
                });
            }

            const shortGaps = gaps.filter(g => g < 2);
            if (shortGaps.length >= 2) {
                advices.push({
                    id: 'frequent_eating_no_lipolysis',
                    icon: 'üìà',
                    text: '–ß–∞—Å—Ç—ã–µ –ø—Ä–∏—ë–º—ã ‚Äî –∏–Ω—Å—É–ª–∏–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤—ã—Å–æ–∫–∏–π, –ª–∏–ø–æ–ª–∏–∑–∞ –Ω–µ—Ç',
                    details: 'üìä –ü–µ—Ä–µ—Ä—ã–≤—ã < 2 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –µ–¥–æ–π = –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤—ã—Å–æ–∫–∏–π –∏–Ω—Å—É–ª–∏–Ω. –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è. –î–µ–ª–∞–π –ø–∞—É–∑—ã 3-5 —á–∞—Å–æ–≤.',
                    type: 'warning',
                    priority: 45,
                    category: 'timing',
                    triggers: ['meal_added'],
                    ttl: 6000
                });
            }
        }

        // insulin_too_fast / insulin_perfect / insulin_countdown
        if (mealsWithItems.length >= 2) {
            const insulinWave = prof?.insulinWaveHours || 4;

            for (let i = 1; i < mealTimes.length; i++) {
                const gap = mealTimes[i] - mealTimes[i - 1];
                if (gap < insulinWave * 60 * 0.5) {
                    const gapHours = (gap / 60).toFixed(1).replace('.0', '');
                    advices.push({
                        id: 'insulin_too_fast',
                        icon: '‚è±Ô∏è',
                        text: `–ú–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ ${gapHours}—á ‚Äî –¥–∞–π –∏–Ω—Å—É–ª–∏–Ω—É –æ—Ç–¥–æ—Ö–Ω—É—Ç—å`,
                        details: 'üîñ –ò–Ω—Å—É–ª–∏–Ω –≤—ã—Å–æ–∫–∏–π = –∂–∏—Ä –Ω–µ –≥–æ—Ä–∏—Ç. –ò–¥–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ 3-4 —á–∞—Å–∞ –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏.',
                        type: 'tip',
                        priority: 38,
                        category: 'timing',
                        triggers: ['product_added'],
                        ttl: 5000
                    });
                    break;
                }
            }

            const avgGap = (mealTimes[mealTimes.length - 1] - mealTimes[0]) / (mealTimes.length - 1);
            if (avgGap >= insulinWave * 60 * 0.9 && mealsWithItems.length >= 3) {
                advices.push({
                    id: 'insulin_perfect',
                    icon: '‚è∞',
                    text: '–û—Ç–ª–∏—á–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏!',
                    details: 'üéØ –ò–Ω—Å—É–ª–∏–Ω —É—Å–ø–µ–≤–∞–µ—Ç —Å–Ω–∏–∑–∏—Ç—å—Å—è ‚Üí –ª–∏–ø–æ–ª–∏–∑ –≤–∫–ª—é—á–∞–µ—Ç—Å—è. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!',
                    type: 'achievement',
                    priority: 39,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }

            const lastMealTimeMinutes = mealTimes[mealTimes.length - 1];
            const nowMinutes = hour * 60 + new Date().getMinutes();
            const insulinEndMinutes = lastMealTimeMinutes + insulinWave * 60;
            const minutesUntilEnd = insulinEndMinutes - nowMinutes;

            if (minutesUntilEnd > 0 && minutesUntilEnd < 60 && !sessionStorage.getItem('heys_insulin_countdown')) {
                advices.push({
                    id: 'insulin_countdown',
                    icon: '‚è±Ô∏è',
                    text: `–ß–µ—Ä–µ–∑ ${minutesUntilEnd} –º–∏–Ω –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è ‚Äî –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å`,
                    details: 'üî• –ö–æ–≥–¥–∞ –∏–Ω—Å—É–ª–∏–Ω —Å–Ω–∏–∑–∏—Ç—Å—è, –Ω–∞—á–Ω—ë—Ç—Å—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ. –ü–æ–¥–æ–∂–¥–∏ –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ!',
                    type: 'info',
                    priority: 40,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_insulin_countdown', '1'); } catch (e) { } }
                });
            }
        }

        // bedtime_protein / bedtime_undereating
        const bedtimeInfo = helpers.getHoursUntilBedtime(hour, prof);
        const hoursUntilBed = bedtimeInfo.hoursUntilBed;
        const bedtimeText = bedtimeInfo.source === 'history'
            ? `(–æ–±—ã—á–Ω–æ –≤ ${bedtimeInfo.bedtimeFormatted})`
            : '';

        if (hour >= 20 && hour <= 23 && ctx.proteinPct < 0.8 && hoursUntilBed > 0 && hoursUntilBed <= 4) {
            advices.push({
                id: 'bedtime_protein',
                icon: 'ü•õ',
                text: `–î–æ —Å–Ω–∞ ~${Math.round(hoursUntilBed)}—á ${bedtimeText} ‚Äî –¥–æ–±–µ—Ä–∏ –±–µ–ª–æ–∫!`,
                details: 'üåô –ö–∞–∑–µ–∏–Ω (—Ç–≤–æ—Ä–æ–≥, –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç) ‚Äî –∏–¥–µ–∞–ª–µ–Ω –Ω–∞ –Ω–æ—á—å. –ú–µ–¥–ª–µ–Ω–Ω–æ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∏ –ø–∏—Ç–∞–µ—Ç –º—ã—à—Ü—ã –≤–æ —Å–Ω–µ.',
                type: 'tip',
                priority: 35,
                category: 'timing',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hoursUntilBed > 0 && hoursUntilBed <= 2 && kcalPct < 0.7) {
            const kcalMissing = Math.round((1 - kcalPct) * (optimum || 2000));
            advices.push({
                id: 'bedtime_undereating',
                icon: '‚è∞',
                text: `–î–æ —Å–Ω–∞ ~${Math.round(hoursUntilBed)}—á, –∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${kcalMissing} –∫–∫–∞–ª!`,
                details: `üî¨ –í—Ä–µ–º–µ–Ω–∏ –º–∞–ª–æ, –Ω–æ –ª—É—á—à–µ –ø–æ–µ—Å—Ç—å:\n\n` +
                    `‚Ä¢ –¢–≤–æ—Ä–æ–≥ 200–≥ = 220 –∫–∫–∞–ª, 36–≥ –±–µ–ª–∫–∞ ‚Äî –ø–µ—Ä–µ–≤–∞—Ä–∏—Ç—Å—è –∑–∞ 1.5-2—á\n` +
                    `‚Ä¢ –ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å = 120-200 –∫–∫–∞–ª –∑–∞ 30 –º–∏–Ω\n` +
                    `‚Ä¢ –û—Ä–µ—Ö–∏ 50–≥ = 300 –∫–∫–∞–ª ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —Å—ã—Ç–Ω–æ\n\n` +
                    `üí° –ì–æ–ª–æ–¥–Ω—ã–π —Å–æ–Ω = –ø–ª–æ—Ö–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ + –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞`,
                type: 'warning',
                priority: 8,
                category: 'timing',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        // late_dinner_warning / late_heavy_meal / good_dinner_time
        const lastMealTime = (() => {
            const mealsList = (day?.meals || []).filter(m => m.items?.length > 0);
            if (mealsList.length === 0) return null;
            const timesList = mealsList.map(m => m.time || '12:00').sort();
            return timesList[timesList.length - 1];
        })();

        if (lastMealTime) {
            const lastH = Math.floor(toMinutes(lastMealTime) / 60);

            if (lastH >= 22) {
                advices.push({
                    id: 'late_dinner_warning',
                    icon: 'üåô',
                    text: '–ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω ‚Äî —Å–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å —Ö—É–∂–µ',
                    details: 'üí§ –ï–¥–∞ –∑–∞ 2-3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞ —É—Å–ø–µ–µ—Ç –ø–µ—Ä–µ–≤–∞—Ä–∏—Ç—å—Å—è. –ü–æ–∑–¥–Ω—ã–π —É–∂–∏–Ω –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏–∑–∂–æ–≥—É –∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π —Å–æ–Ω.',
                    type: 'tip',
                    priority: 41,
                    category: 'timing',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }

            if (lastH >= 21 && lastH < 22 && !sessionStorage.getItem('heys_late_heavy_shown')) {
                const lastMealByTime = (day?.meals || []).find(m => m.time === lastMealTime);
                if (lastMealByTime) {
                    let lateMealKcal = 0;
                    for (const item of (lastMealByTime.items || [])) {
                        const product = helpers.getProductForItem(item, ctx.pIndex);
                        if (product) lateMealKcal += (product.kcal100 || 0) * (item.grams || 100) / 100;
                    }

                    if (lateMealKcal > 500) {
                        advices.push({
                            id: 'late_heavy_meal',
                            icon: 'üåô',
                            text: `–ü–ª–æ—Ç–Ω—ã–π —É–∂–∏–Ω (${Math.round(lateMealKcal)} –∫–∫–∞–ª) –ø–æ—Å–ª–µ 21:00 ‚Äî —Å–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å —Ö—É–∂–µ`,
                            details: 'üí§ –ü–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ –º–µ—à–∞–µ—Ç –≥–ª—É–±–æ–∫–æ–º—É —Å–Ω—É. –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ—É–∂–∏–Ω–∞–π –ª–µ–≥—á–µ –∏–ª–∏ —Ä–∞–Ω—å—à–µ.',
                            type: 'tip',
                            priority: 40,
                            category: 'timing',
                            triggers: ['product_added'],
                            ttl: 5000,
                            onShow: () => { try { sessionStorage.setItem('heys_late_heavy_shown', '1'); } catch (e) { } }
                        });
                    }
                }
            }

            if (lastH >= 18 && lastH <= 20 && hour >= 21) {
                advices.push({
                    id: 'good_dinner_time',
                    icon: 'üåô',
                    text: '–£–∂–∏–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî —Å–æ–Ω –±—É–¥–µ—Ç –ª—É—á—à–µ!',
                    details: 'üåô –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —É–∂–∏–Ω ‚Äî –∑–∞ 2-3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞. –¢—ã –≤—Å—ë —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ!',
                    type: 'achievement',
                    priority: 42,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_timing.js =====

// ===== Begin advice/_training.js =====
;/**
 * HEYS Advice Module v1 ‚Äî Training
 * @file advice/_training.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.training = function buildTrainingAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { THRESHOLDS } = rules;

        const {
            day,
            dayTot,
            normAbs,
            hour,
            mealCount,
            hasTraining,
            kcalPct,
            optimum,
            pIndex,
            proteinPct,
            carbsPct,
            caloricDebt
        } = ctx;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üèãÔ∏è Post-training nutrition
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (hasTraining && proteinPct < THRESHOLDS.protein.adequate) {
            advices.push({
                id: 'post_training_protein',
                icon: 'üí™',
                text: helpers.personalizeText(helpers.pickRandomText([
                    '–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–∞–∂–µ–Ω –±–µ–ª–æ–∫ ‚Äî –¥–æ–±–∞–≤—å 20-30–≥',
                    '${firstName}, –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω—É–∂–µ–Ω –±–µ–ª–æ–∫!',
                    '–ú—ã—à—Ü—ã –∂–¥—É—Ç –±–µ–ª–æ–∫ ‚Äî —Ç–≤–æ—Ä–æ–≥, –∫—É—Ä–∏—Ü–∞, —è–π—Ü–∞'
                ]), ctx),
                details: '–ë–µ–ª–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º—ã—à—Ü. –ò–¥–µ–∞–ª—å–Ω–æ: –ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å, —Ç–≤–æ—Ä–æ–≥ —Å –±–∞–Ω–∞–Ω–æ–º, –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å —Ä–∏—Å–æ–º, –∏–ª–∏ –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç —Å –æ—Ä–µ—Ö–∞–º–∏.',
                type: 'tip',
                priority: 34,
                category: 'training',
                triggers: ['product_added', 'tab_open'],
                excludes: ['protein_low', 'hard_workout_recovery', 'training_recovery_window'],
                canSkipCooldown: true,
                ttl: 5000
            });
        }

        if (hasTraining && kcalPct < 0.7 && hour >= 18) {
            const kcalMissing = Math.round((1 - kcalPct) * (optimum || 2000));
            advices.push({
                id: 'post_training_undereating_critical',
                icon: 'üö®',
                text: `–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${kcalMissing} –∫–∫–∞–ª ‚Äî –º—ã—à—Ü–∞–º –Ω—É–∂–µ–Ω –±–µ–ª–æ–∫!`,
                details: `üî¨ –ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç: –ø–µ—Ä–≤—ã–µ 2-3 —á–∞—Å–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî "–∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ".\n\n` +
                    `‚Ä¢ –ë–µ–∑ –µ–¥—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ = –∫–∞—Ç–∞–±–æ–ª–∏–∑–º (—Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ –º—ã—à—Ü)\n` +
                    `‚Ä¢ –ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω –ª—É—á—à–µ —á–µ–º –≥–æ–ª–æ–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–∫–∏\n` +
                    `‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ: 25-40–≥ –±–µ–ª–∫–∞ + —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã\n\n` +
                    `üí° –í–∞—Ä–∏–∞–Ω—Ç—ã: —Ç–≤–æ—Ä–æ–≥ 200–≥, —è–π—Ü–∞ 3—à—Ç + —Ö–ª–µ–±, –∫—É—Ä–∏—Ü–∞ + —Ä–∏—Å, –ø—Ä–æ—Ç–µ–∏–Ω + –±–∞–Ω–∞–Ω`,
                type: 'warning',
                priority: 5,
                category: 'training',
                triggers: ['tab_open'],
                ttl: 8000,
                canSkipCooldown: true
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üèãÔ∏è Training day context (caloric debt)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const trainingCtx = caloricDebt?.trainingDayContext;
        if (trainingCtx?.isTrainingDay && trainingCtx.nutritionPriority === 'high') {
            const trainType = trainingCtx.trainingType;

            if (caloricDebt?.hasDebt && trainType === 'strength') {
                advices.push({
                    id: 'training_strength_undereating',
                    icon: 'üèãÔ∏è',
                    text: '–°–∏–ª–æ–≤–∞—è + –Ω–µ–¥–æ–µ–¥–∞–Ω–∏–µ = –ø–æ—Ç–µ—Ä—è –º—ã—à—Ü!',
                    details: 'üí™ –ü–æ—Å–ª–µ —Å–∏–ª–æ–≤–æ–π –º—ã—à—Ü–∞–º –Ω—É–∂–µ–Ω –±–µ–ª–æ–∫ –∏ —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–µ–¥–æ–±–æ—Ä —Å–µ–π—á–∞—Å = –ø–æ—Ç–µ—Ä—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –∑–∞–ª–µ!',
                    type: 'warning',
                    priority: 14,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 7000
                });
            } else if (caloricDebt?.hasDebt && trainType === 'cardio') {
                advices.push({
                    id: 'training_cardio_undereating',
                    icon: 'üèÉ',
                    text: '–ö–∞—Ä–¥–∏–æ + –¥–µ—Ñ–∏—Ü–∏—Ç ‚Äî –≤–æ—Å–ø–æ–ª–Ω–∏ –≥–ª–∏–∫–æ–≥–µ–Ω',
                    details: '‚ö° –ü–æ—Å–ª–µ –∫–∞—Ä–¥–∏–æ –≥–ª–∏–∫–æ–≥–µ–Ω –∏—Å—Ç–æ—â—ë–Ω. –£–≥–ª–µ–≤–æ–¥—ã —Å–µ–π—á–∞—Å –ø–æ–π–¥—É—Ç –ø—Ä—è–º–æ –≤ –º—ã—à—Ü—ã, –∞ –Ω–µ –≤ –∂–∏—Ä! –ù–µ –±–æ–π—Å—è –ø–æ–µ—Å—Ç—å.',
                    type: 'tip',
                    priority: 23,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 6000
                });
            }

            if (trainingCtx.trainingIntensity === 'high' || trainingCtx.trainingIntensity === 'extreme') {
                advices.push({
                    id: 'training_high_intensity_nutrition',
                    icon: 'üî•',
                    text: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî –ø–∏—Ç–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ!',
                    details: 'üí• –í—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å = –≤—ã—Å–æ–∫–∏–π —Ä–∞—Å—Ö–æ–¥. –°–µ–≥–æ–¥–Ω—è –ø–∏—Ç–∞–Ω–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–æ—Ä–º–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞!',
                    type: 'info',
                    priority: 26,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚è±Ô∏è Recovery window (30-60 –º–∏–Ω –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const trainingsP3 = day?.trainings || [];
        const todayTrainingP3 = trainingsP3.find(t => t.z && t.z.some(m => m > 0));
        if (todayTrainingP3 && todayTrainingP3.time) {
            const [trainH, trainM] = todayTrainingP3.time.split(':').map(Number);
            const trainMinutes = trainH * 60 + trainM;
            const nowMinutes = hour * 60 + new Date().getMinutes();
            const minutesSince = nowMinutes - trainMinutes;

            if (minutesSince >= 30 && minutesSince <= 60 && proteinPct < 0.8) {
                advices.push({
                    id: 'training_recovery_window',
                    icon: 'üèãÔ∏è',
                    text: '–û–∫–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –±–µ–ª–æ–∫ —Å–µ–π—á–∞—Å —É—Å–≤–æ–∏—Ç—Å—è –ª—É—á—à–µ!',
                    details: 'üí™ 30-60 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ. –ë–µ–ª–æ–∫ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 25% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ. –ò–¥–µ–∞–ª—å–Ω–æ: 20-30–≥ –±–µ–ª–∫–∞.',
                    type: 'tip',
                    priority: 94,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üèãÔ∏è Training tips (–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å, —Ç–∏–ø)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const trainings = day?.trainings || [];
        const todayTraining = trainings.find(t => t.z && t.z.some(m => m > 0));

        if (todayTraining) {
            const totalMinutes = todayTraining.z.reduce((a, b) => a + b, 0);
            const highIntensityMinutes = (todayTraining.z[2] || 0) + (todayTraining.z[3] || 0);
            const isHardWorkout = highIntensityMinutes > 20;
            const proteinPctLocal = (dayTot?.prot || 0) / ((normAbs?.prot || 100) || 1);

            if (isHardWorkout && proteinPctLocal < 1.0) {
                advices.push({
                    id: 'hard_workout_recovery',
                    icon: 'üî•',
                    text: `${highIntensityMinutes} –º–∏–Ω –≤ –≤—ã—Å–æ–∫–∏—Ö –∑–æ–Ω–∞—Ö ‚Äî –¥–æ–±–∞–≤—å –±–µ–ª–∫–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è`,
                    details: 'üèãÔ∏è –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ–∑–¥–∞—ë—Ç –º–∏–∫—Ä–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –º—ã—à—Ü. –ë–µ–ª–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ 2—á —É—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.',
                    type: 'tip',
                    priority: 30,
                    category: 'training',
                    triggers: ['product_added', 'tab_open'],
                    ttl: 5000
                });
            }

            const fatBurnMinutes = todayTraining.z[1] || 0;
            const carbsPctLocal = (dayTot?.carbs || 0) / ((normAbs?.carbs || 200) || 1);
            if (fatBurnMinutes > 30 && carbsPctLocal > 1.2) {
                advices.push({
                    id: 'cardio_carbs_balance',
                    icon: 'üèÉ',
                    text: '–ü–æ—Å–ª–µ –∫–∞—Ä–¥–∏–æ –ª—É—á—à–µ –±–µ–ª–æ–∫ –∏ –æ–≤–æ—â–∏, —á–µ–º —É–≥–ª–µ–≤–æ–¥—ã',
                    details: 'üî• –ü–æ—Å–ª–µ –∫–∞—Ä–¥–∏–æ –æ—Ä–≥–∞–Ω–∏–∑–º –≤ —Ä–µ–∂–∏–º–µ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è. –£–≥–ª–µ–≤–æ–¥—ã –≤—ã–∫–ª—é—á–∞—Ç —ç—Ç–æ—Ç —Ä–µ–∂–∏–º.',
                    type: 'tip',
                    priority: 35,
                    category: 'training',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }

            if (totalMinutes >= 45) {
                advices.push({
                    id: 'great_workout',
                    icon: 'üí™',
                    text: `${totalMinutes} –º–∏–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî —Å—É–ø–µ—Ä!`,
                    details: 'üéØ 45+ –º–∏–Ω—É—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ = —Å–µ—Ä—å—ë–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞! –ù–µ –∑–∞–±—É–¥—å –ø—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —Å–æ–Ω.',
                    type: 'achievement',
                    priority: 7,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }

            if (todayTraining.type === 'strength' && proteinPctLocal < 1.0) {
                advices.push({
                    id: 'training_type_strength',
                    icon: 'üèãÔ∏è',
                    text: '–ü–æ—Å–ª–µ —Å–∏–ª–æ–≤–æ–π –≤–∞–∂–µ–Ω –±–µ–ª–æ–∫ ‚Äî 20-30–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤',
                    details: 'üí™ –°–∏–ª–æ–≤–∞—è —Å–æ–∑–¥–∞—ë—Ç –º–∏–∫—Ä–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –º—ã—à—Ü, –±–µ–ª–æ–∫ –∏—Ö –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç. –ë–µ–∑ –±–µ–ª–∫–∞ ‚Äî —Ä–æ—Å—Ç–∞ –Ω–µ –±—É–¥–µ—Ç.',
                    type: 'tip',
                    priority: 31,
                    category: 'training',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000
                });
            }

            if (todayTraining.type === 'hobby' && !sessionStorage.getItem('heys_hobby_tip')) {
                advices.push({
                    id: 'training_type_hobby',
                    icon: 'üßò',
                    text: '–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ö–æ–±–±–∏ –∏–¥–µ–∞–ª–µ–Ω –ª—ë–≥–∫–∏–π –ø—Ä–∏—ë–º ‚Äî –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã',
                    details: 'üåø –ô–æ–≥–∞, –ø—Ä–æ–≥—É–ª–∫–∏, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã —Ä–∞—Å—Å–ª–∞–±–ª—è—é—Ç –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.',
                    type: 'tip',
                    priority: 49,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_hobby_tip', '1'); } catch (e) { } }
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_training.js =====

// ===== Begin advice/_emotional.js =====
;/**
 * HEYS Advice Module v1 ‚Äî Emotional & Correlation
 * @file advice/_emotional.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.emotional = function buildEmotionalAdvices(ctx, helpers) {
        const advices = [];

        const {
            day,
            dayTot,
            normAbs,
            optimum,
            hour,
            mealCount,
            kcalPct,
            emotionalState,
            goal,
            proteinPct,
            waterGoal,
            caloricDebt
        } = ctx;

        const {
            calculateAverageStress,
            calculateAverageWellbeing,
            calculateSleepHours,
            getProductForItem
        } = helpers;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üòä EMOTIONAL STATE TIPS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (emotionalState === 'crashed') {
            const isUnderEating = kcalPct < 0.7;
            const kcalDeficit = Math.round((1 - kcalPct) * (optimum || 2000));
            const currentPct = Math.round(kcalPct * 100);

            if (isUnderEating && hour >= 18) {
                advices.push({
                    id: 'undereating_warning',
                    icon: '‚ö†Ô∏è',
                    text: `–°—ä–µ–¥–µ–Ω–æ ${currentPct}% ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ~${kcalDeficit} –∫–∫–∞–ª`,
                    details: `üî¨ –ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç: –∂—ë—Å—Ç–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç (>500 –∫–∫–∞–ª) —Ö—É–∂–µ –ø–æ–∑–¥–Ω–µ–≥–æ —É–∂–∏–Ω–∞!\n\n` +
                        `‚Ä¢ –ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è –Ω–∞ 10-15%\n` +
                        `‚Ä¢ –ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –±–µ–ª–æ–∫\n` +
                        `‚Ä¢ –†–∏—Å–∫: –ø–æ—Ç–µ—Ä—è –º—ã—à—Ü, –≤—ã–ø–∞–¥–µ–Ω–∏–µ –≤–æ–ª–æ—Å, –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Å–±–æ–π\n\n` +
                        `üí° –õ—É—á—à–µ –ø–æ–µ—Å—Ç—å –¥–∞–∂–µ –≤ 23:00: —Ç–≤–æ—Ä–æ–≥ 200–≥ (~220 –∫–∫–∞–ª, 36–≥ –±–µ–ª–∫–∞), —è–π—Ü–∞ 3—à—Ç (~240 –∫–∫–∞–ª), –æ—Ä–µ—Ö–∏ 50–≥ (~300 –∫–∫–∞–ª)`,
                    type: 'warning',
                    priority: 1,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 8000
                });
            } else {
                advices.push({
                    id: 'crash_support',
                    icon: 'üíô',
                    text: '–ë—ã–≤–∞–µ—Ç! –ó–∞–≤—Ç—Ä–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å. –¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!',
                    details: 'üß° –û–¥–∏–Ω –ø–ª–æ—Ö–æ–π –¥–µ–Ω—å –Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –î–∞–∂–µ —É –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤ –±—ã–≤–∞—é—Ç —Å—Ä—ã–≤—ã. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–ª–∞–Ω—É –∑–∞–≤—Ç—Ä–∞.',
                    type: 'achievement',
                    priority: 1,
                    category: 'emotional',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 6000
                });
            }
        }

        if (emotionalState === 'stressed') {
            advices.push({
                id: 'stress_support',
                icon: 'ü§ó',
                text: '–¢—ã –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—à—å. –≠—Ç–æ —É–∂–µ —É—Å–ø–µ—Ö!',
                details: 'üí™ –°–∞–º —Ñ–∞–∫—Ç –≤–µ–¥–µ–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —à–∞–Ω—Å—ã –Ω–∞ —É—Å–ø–µ—Ö –≤ 2 —Ä–∞–∑–∞. –î–∞–∂–µ –≤ —Å—Ç—Ä–µ—Å—Å–µ —Ç—ã –¥–µ–ª–∞–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —à–∞–≥–∏.',
                type: 'achievement',
                priority: 2,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üò∞ EMOTIONAL RISK ‚Äî —Å—Ç—Ä–µ—Å—Å + –¥–æ–ª–≥
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const avgStress = day?.stressAvg || 0;
        const isHighStress = avgStress >= 6;
        const hasDebt = caloricDebt?.hasDebt;
        const emotionalRiskLevel = (isHighStress && hasDebt) ? 'high'
            : (isHighStress || hasDebt) ? 'medium'
                : 'low';

        if (emotionalRiskLevel === 'high' && hour >= 16) {
            advices.push({
                id: 'emotional_risk_high',
                icon: 'üßò',
                text: '–°—Ç—Ä–µ—Å—Å + –Ω–µ–¥–æ–µ–¥–∞–Ω–∏–µ ‚Äî —Ä–∏—Å–∫ —Å—Ä—ã–≤–∞! –ú—è–≥—á–µ –∫ —Å–µ–±–µ',
                details: 'üî¨ –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–º –∫–æ—Ä—Ç–∏–∑–æ–ª–µ –º–æ–∑–≥ —Ç—Ä–µ–±—É–µ—Ç –±—ã—Å—Ç—Ä–æ–π —ç–Ω–µ—Ä–≥–∏–∏. –≠—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å ‚Äî –±–∏–æ—Ö–∏–º–∏—è! –õ—É—á—à–µ —Å—ä–µ—à—å —á—Ç–æ-—Ç–æ —Å–µ–π—á–∞—Å, —á–µ–º —Å–æ—Ä–≤—ë—à—å—Å—è –≤–µ—á–µ—Ä–æ–º.',
                type: 'warning',
                priority: 18,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 7000
            });
        } else if (isHighStress && hour >= 18 && kcalPct < 0.8) {
            advices.push({
                id: 'stress_undereating_warning',
                icon: '‚ö†Ô∏è',
                text: '–°—Ç—Ä–µ—Å—Å —Å–µ–≥–æ–¥–Ω—è –≤—ã—Å–æ–∫–∏–π ‚Äî –Ω–µ –≥–æ–ª–æ–¥–∞–π',
                details: 'üò∞ –ü—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ –ª–µ–ø—Ç–∏–Ω –ø–∞–¥–∞–µ—Ç, –≥—Ä–µ–ª–∏–Ω —Ä–∞—Å—Ç—ë—Ç. –ù–µ–¥–æ–µ–¥–∞–Ω–∏–µ + —Å—Ç—Ä–µ—Å—Å = 90% —à–∞–Ω—Å —Å—Ä—ã–≤–∞ –Ω–æ—á—å—é. –õ—É—á—à–µ –ø–æ–µ—Å—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å–µ–π—á–∞—Å.',
                type: 'warning',
                priority: 22,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üß† CORRELATION INSIGHTS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const sleepHours = calculateSleepHours(day);
        const sleepNorm = ctx.prof?.sleepHours || 8;
        const sleepDeficit = sleepNorm - sleepHours;

        if (sleepDeficit > 2 && kcalPct > 1.15) {
            advices.push({
                id: 'sleep_hunger_correlation',
                icon: 'üß†',
                text: `–ù–µ–¥–æ—Å—ã–ø ${sleepDeficit.toFixed(1)}—á –ø–æ–≤—ã—à–∞–µ—Ç –∞–ø–ø–µ—Ç–∏—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ`,
                details: 'üìä –ö–∞–∂–¥—ã–π —á–∞—Å –Ω–µ–¥–æ—Å—ã–ø–∞ = +45 –∫–∫–∞–ª –∞–ø–ø–µ—Ç–∏—Ç–∞. –≠—Ç–æ –≥–æ—Ä–º–æ–Ω—ã, –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å –≤–æ–ª–∏.',
                type: 'insight',
                priority: 20,
                category: 'correlation',
                triggers: ['product_added', 'tab_open'],
                ttl: 6000
            });
        }

        if (sleepDeficit > 1.5 && hour < 12 && kcalPct < 0.3) {
            advices.push({
                id: 'sleep_hunger_warning',
                icon: '‚ö°',
                text: '–ü–æ—Å–ª–µ –Ω–µ–¥–æ—Å—ã–ø–∞ –∞–ø–ø–µ—Ç–∏—Ç –≤—ã—à–µ ‚Äî –ø–ª–∞–Ω–∏—Ä—É–π —Å—ã—Ç–Ω—ã–π –æ–±–µ–¥',
                details: '‚òï –ü–æ—Å–ª–µ –Ω–µ–¥–æ—Å—ã–ø–∞ —Ç—è–Ω–µ—Ç –Ω–∞ —Å–ª–∞–¥–∫–æ–µ. –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π –±–µ–ª–∫–æ–≤—ã–π –æ–±–µ–¥ –∑–∞—Ä–∞–Ω–µ–µ.',
                type: 'tip',
                priority: 25,
                category: 'correlation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const avgStressForPattern = calculateAverageStress(day);
        const simplePctCorr = (dayTot?.simple || 0) / ((normAbs?.simple || 50) || 1);

        if (avgStressForPattern >= 4 && simplePctCorr > 1.2) {
            advices.push({
                id: 'stress_sweet_pattern',
                icon: 'üí°',
                text: '–°—Ç—Ä–µ—Å—Å ‚Üí —Å–ª–∞–¥–∫–æ–µ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –æ—Ä–µ—Ö–∏ –∏–ª–∏ —Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥',
                details: 'üç´ –°—Ç—Ä–µ—Å—Å ‚Üí –∫–æ—Ä—Ç–∏–∑–æ–ª ‚Üí —Ç—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥ 70%+, –æ—Ä–µ—Ö–∏, –±–∞–Ω–∞–Ω.',
                type: 'insight',
                priority: 22,
                category: 'correlation',
                triggers: ['product_added'],
                ttl: 6000
            });
        }

        if (avgStressForPattern > 0 && avgStressForPattern <= 2 && kcalPct >= 0.9 && kcalPct <= 1.1) {
            advices.push({
                id: 'low_stress_balance',
                icon: '‚òÆÔ∏è',
                text: '–°–ø–æ–∫–æ–π–Ω—ã–π –¥–µ–Ω—å = –ª–µ–≥—á–µ –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å. –ó–∞–º–µ—á–∞–µ—à—å?',
                details: 'üßò –ù–∏–∑–∫–∏–π —Å—Ç—Ä–µ—Å—Å = –Ω–∏–∑–∫–∏–π –∫–æ—Ä—Ç–∏–∑–æ–ª = –º–µ–Ω—å—à–µ —Ç—è–≥–∏ –∫ –µ–¥–µ. –ó–∞–ø–æ–º–Ω–∏ —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ!',
                type: 'insight',
                priority: 40,
                category: 'correlation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (avgStressForPattern >= 4 && kcalPct > 1.15) {
            advices.push({
                id: 'stress_eating_detected',
                icon: 'üö∂',
                text: '–°—Ç—Ä–µ—Å—Å ‚Üí –ø–µ—Ä–µ–∫—É—Å? –ü–æ–ø—Ä–æ–±—É–π –ø—Ä–æ–≥—É–ª–∫—É –≤–º–µ—Å—Ç–æ –µ–¥—ã',
                details: 'üß† –°—Ç—Ä–µ—Å—Å–æ–≤–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–æ—Ä—Ç–∏–∑–æ–ª. 10-–º–∏–Ω—É—Ç–Ω–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç –µ–≥–æ –ª—É—á—à–µ, —á–µ–º –µ–¥–∞.',
                type: 'tip',
                priority: 96,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üé≠ EMOTIONAL INTELLIGENCE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const mealsWithMood = (day?.meals || []).filter(m => m.mood > 0 && m.items?.length > 0);
        if (mealsWithMood.length >= 2) {
            const moodDropMeal = mealsWithMood.find((m, i) => {
                if (i === 0) return false;
                return m.mood < mealsWithMood[i - 1].mood - 1;
            });

            if (moodDropMeal) {
                const prevMealIdx = mealsWithMood.indexOf(moodDropMeal) - 1;
                const prevMeal = mealsWithMood[prevMealIdx];

                let prevSimple = 0;
                for (const item of prevMeal.items || []) {
                    const product = getProductForItem(item, ctx.pIndex);
                    if (product) prevSimple += (product.simple100 || 0) * (item.grams || 100) / 100;
                }

                if (prevSimple > 30) {
                    advices.push({
                        id: 'sugar_mood_crash',
                        icon: 'üé¢',
                        text: '–ó–∞–º–µ—Ç–∏–ª? –ü–æ—Å–ª–µ —Å–ª–∞–¥–∫–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å',
                        details: 'üìâ –≠—Ç–æ "—Å–∞—Ö–∞—Ä–Ω—ã–µ –≥–æ—Ä–∫–∏": –±—ã—Å—Ç—Ä—ã–π —Å–∫–∞—á–æ–∫ –≥–ª—é–∫–æ–∑—ã ‚Üí –∏–Ω—Å—É–ª–∏–Ω ‚Üí –ø–∞–¥–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏. –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é.',
                        type: 'insight',
                        priority: 24,
                        category: 'emotional',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                }
            }
        }

        const avgWellbeing = calculateAverageWellbeing(day);

        if (avgWellbeing > 0 && avgWellbeing < 3 && kcalPct < 0.4 && hour >= 12) {
            advices.push({
                id: 'wellbeing_low_food',
                icon: 'üçΩÔ∏è',
                text: '–í–æ–∑–º–æ–∂–Ω–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ —É–ª—É—á—à–∏—Ç—Å—è –ø–æ—Å–ª–µ –µ–¥—ã',
                details: 'üß† –ú–æ–∑–≥—É –Ω—É–∂–Ω–∞ –≥–ª—é–∫–æ–∑–∞! –ù–∏–∑–∫–∏–π —Å–∞—Ö–∞—Ä –≤ –∫—Ä–æ–≤–∏ = —É—Å—Ç–∞–ª–æ—Å—Ç—å, —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–ª–∞–±–æ—Å—Ç—å. –ü–æ–µ—à—å ‚Äî —Å—Ç–∞–Ω–µ—Ç –ª–µ–≥—á–µ.',
                type: 'tip',
                priority: 29,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (avgWellbeing >= 4 && kcalPct >= 0.8 && kcalPct <= 1.1) {
            advices.push({
                id: 'wellbeing_nutrition_link',
                icon: '‚ú®',
                text: '–•–æ—Ä–æ—à–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ + –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî –∑–∞–ø–æ–º–Ω–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å!',
                details: 'üìù –ó–∞–ø–∏—à–∏, —á—Ç–æ –µ–ª —Å–µ–≥–æ–¥–Ω—è! –ö–æ–≥–¥–∞ –Ω–∞–π–¥—ë—à—å —Å–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω ‚Äî –ø–æ–≤—Ç–æ—Ä—è–π –µ–≥–æ.',
                type: 'insight',
                priority: 45,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const dayScore = day?.dayScore ? +day.dayScore : 0;
        if (dayScore > 0 && dayScore < 5 && hour >= 20) {
            advices.push({
                id: 'day_score_low',
                icon: 'üíô',
                text: '–ù–µ –ª—É—á—à–∏–π –¥–µ–Ω—å? –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ!',
                details: 'üß° –ü–ª–æ—Ö–∏–µ –¥–Ω–∏ –±—ã–≤–∞—é—Ç —É –≤—Å–µ—Ö. –í–∞–∂–Ω–æ –Ω–µ —Å–¥–∞–≤–∞—Ç—å—Å—è. –•–æ—Ä–æ—à–∏–π —Å–æ–Ω —Å–µ–≥–æ–¥–Ω—è ‚Äî –∏ –∑–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ.',
                type: 'tip',
                priority: 27,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (dayScore >= 8 && hour >= 20) {
            advices.push({
                id: 'day_score_high',
                icon: '‚≠ê',
                text: '–û—Ç–ª–∏—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–Ω—è! –ó–∞–ø–æ–º–Ω–∏ —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ',
                details: 'üèÜ –î–Ω–∏ —Å –≤—ã—Å–æ–∫–æ–π –æ—Ü–µ–Ω–∫–æ–π ‚Äî —ç—Ç–∞–ª–æ–Ω –¥–ª—è –ø–æ–¥—Ä–∞–∂–∞–Ω–∏—è. –ß—Ç–æ –¥–µ–ª–∞–ª —Å–µ–≥–æ–¥–Ω—è? –ü–æ–≤—Ç–æ—Ä–∏ –∑–∞–≤—Ç—Ä–∞!',
                type: 'achievement',
                priority: 8,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const mealsWithMoodData = (day?.meals || []).filter(m => m.mood > 0 && m.items?.length > 0);
        if (mealsWithMoodData.length >= 2 && !sessionStorage.getItem('heys_mood_improving')) {
            const prevMealMood = mealsWithMoodData[mealsWithMoodData.length - 2]?.mood || 0;
            const currentMealMood = mealsWithMoodData[mealsWithMoodData.length - 1]?.mood || 0;

            if (prevMealMood > 0 && currentMealMood > prevMealMood) {
                advices.push({
                    id: 'mood_improving',
                    icon: 'üìà',
                    text: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É–ª—É—á—à–∏–ª–æ—Å—å –ø–æ—Å–ª–µ –µ–¥—ã ‚Äî –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω!',
                    details: 'üß† –ï–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω –∏ –¥–æ—Ñ–∞–º–∏–Ω. –ó–∞–ø–æ–º–∏–Ω–∞–π —É–¥–∞—á–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è!',
                    type: 'insight',
                    priority: 45,
                    category: 'correlation',
                    triggers: ['product_added'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_mood_improving', '1'); } catch (e) { } }
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_emotional.js =====

// ===== Begin advice/_hydration.js =====
;/**
 * HEYS Advice Module v1 ‚Äî Hydration
 * @file advice/_hydration.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.hydration = function buildHydrationAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { THRESHOLDS } = rules;

        const { day, waterGoal, hour } = ctx;
        const waterMl = day?.waterMl || 0;
        const waterPct = waterGoal > 0 ? waterMl / waterGoal : 0;

        const hoursSinceWater = helpers.getHoursSinceWater(day);

        if (hour >= 18 && waterPct < 0.5 && waterGoal > 0) {
            advices.push({
                id: 'water_evening_low',
                icon: 'üíß',
                text: '–í–æ–¥–∞ –æ—Ç—Å—Ç–∞—ë—Ç ‚Äî –≤—ã–ø–µ–π —Å—Ç–∞–∫–∞–Ω –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å',
                details: 'üíß –í–µ—á–µ—Ä–æ–º –Ω–µ—Ö–≤–∞—Ç–∫–∞ –≤–æ–¥—ã —á–∞—Å—Ç–æ –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≥–æ–ª–æ–¥. 1-2 —Å—Ç–∞–∫–∞–Ω–∞ –≤–æ–¥—ã —É–ª—É—á—à–∞—Ç —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ —Å–æ–Ω.',
                type: 'tip',
                priority: 36,
                category: 'hydration',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hoursSinceWater >= 2 && hour >= 10 && hour <= 21) {
            advices.push({
                id: 'water_reminder',
                icon: 'üö∞',
                text: '–ü–æ—Ä–∞ –ø–∏—Ç—å –≤–æ–¥—É ‚Äî –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 2 —á–∞—Å–æ–≤',
                details: 'üíß –†–µ–≥—É–ª—è—Ä–Ω–∞—è –≤–æ–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é, —Å–Ω–∏–∂–∞–µ—Ç –∞–ø–ø–µ—Ç–∏—Ç –∏ —É–ª—É—á—à–∞–µ—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–ø–∏—Ç—å 1 —Å—Ç–∞–∫–∞–Ω.',
                type: 'tip',
                priority: 34,
                category: 'hydration',
                triggers: ['tab_open', 'product_added'],
                ttl: 4000
            });
        }

        if (waterPct >= 1.0 && waterGoal > 0) {
            advices.push({
                id: 'water_goal_reached',
                icon: 'üíß',
                text: '–ù–æ—Ä–º–∞ –≤–æ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –û—Ç–ª–∏—á–Ω–æ üíô',
                details: '‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è —É–ª—É—á—à–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é, –∫–æ–∂—É –∏ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ.',
                type: 'achievement',
                priority: 36,
                category: 'hydration',
                triggers: ['tab_open', 'product_added'],
                ttl: 4000
            });
        }

        if (waterMl >= 2500) {
            advices.push({
                id: 'super_hydration',
                icon: 'üåä',
                text: '–°—É–ø–µ—Ä-–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è ‚Äî –±–æ–ª—å—à–µ 2.5–ª!',
                details: 'üåä –û—Ç–ª–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã. –û—Ä–≥–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–∞–∫—Å–∏–º—É–º!',
                type: 'achievement',
                priority: 39,
                category: 'hydration',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        return advices;
    };

})();
// ===== End advice/_hydration.js =====

// ===== Begin advice/_other.js =====
;/**
 * HEYS Advice Module v1 ‚Äî Other (motivation, lifestyle, achievements, supplements, patterns)
 * @file advice/_other.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.other = function buildOtherAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { SEASONAL_TIPS } = rules;

        const {
            dayTot,
            normAbs,
            optimum,
            displayOptimum,
            caloricDebt,
            day,
            pIndex,
            currentStreak,
            hour,
            mealCount,
            hasTraining,
            kcalPct,
            specialDay,
            prof,
            waterGoal,
            goal,
            proteinPct
        } = ctx;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üíä Morning supplements reminder
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const supplementsAdviceShown = sessionStorage.getItem('heys_morning_supplements_advice_shown');
        const plannedSupplements = day?.supplementsPlanned || prof?.plannedSupplements || [];
        const takenSupplements = day?.supplementsTaken || [];
        const hasPendingSupplements = plannedSupplements.length > 0 &&
            plannedSupplements.some(id => !takenSupplements.includes(id));

        if (hour >= 6 && hour <= 12 && hasPendingSupplements && !supplementsAdviceShown) {
            if (window.HEYS?.Supplements?.generateMorningSupplementAdvice) {
                const supplementAdvice = window.HEYS.Supplements.generateMorningSupplementAdvice(
                    plannedSupplements.filter(id => !takenSupplements.includes(id)),
                    { mealCount, hasEaten: mealCount > 0, profile: prof }
                );

                if (supplementAdvice) {
                    advices.push({
                        ...supplementAdvice,
                        priority: 0,
                        category: 'health',
                        isReminder: true,
                        onShow: () => {
                            try { sessionStorage.setItem('heys_morning_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            } else {
                const pendingSupps = plannedSupplements.filter(id => !takenSupplements.includes(id));
                const suppNames = pendingSupps
                    .map(id => window.HEYS?.Supplements?.CATALOG?.[id]?.name || id)
                    .slice(0, 3)
                    .join(', ');

                advices.push({
                    id: 'morning_supplements_reminder',
                    icon: 'üíä',
                    text: `–í—Ä–µ–º—è –≤–∏—Ç–∞–º–∏–Ω–æ–≤: ${suppNames}${pendingSupps.length > 3 ? ` –∏ –µ—â—ë ${pendingSupps.length - 3}` : ''}`,
                    details: '–£—Ç—Ä–µ–Ω–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã –ª—É—á—à–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å –∑–∞–≤—Ç—Ä–∞–∫–æ–º –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Å–≤–æ–µ–Ω–∏—è. –û—Ç–º–µ—Ç—å –∏—Ö –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≤–∏—Ç–∞–º–∏–Ω–æ–≤!',
                    type: 'health',
                    priority: 0,
                    category: 'health',
                    isReminder: true,
                    triggers: ['tab_open', 'checkin_complete'],
                    ttl: 8000,
                    onShow: () => {
                        try { sessionStorage.setItem('heys_morning_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                    }
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üåô Evening supplements reminder
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const eveningSupplementsAdviceShown = sessionStorage.getItem('heys_evening_supplements_advice_shown');
        const eveningTimings = ['evening', 'beforeBed'];
        const eveningSupps = plannedSupplements.filter(id => {
            if (takenSupplements.includes(id)) return false;
            const info = window.HEYS?.Supplements?.SCIENCE?.MORNING_SUPPLEMENT_SCIENCE?.[id];
            return info && eveningTimings.includes(info.timing);
        });

        if (hour >= 18 && hour <= 23 && eveningSupps.length > 0 && !eveningSupplementsAdviceShown) {
            if (window.HEYS?.Supplements?.generateEveningSupplementAdvice) {
                const eveningAdvice = window.HEYS.Supplements.generateEveningSupplementAdvice(
                    plannedSupplements.filter(id => !takenSupplements.includes(id)),
                    { mealCount, hasEaten: mealCount > 0, profile: prof }
                );

                if (eveningAdvice) {
                    advices.push({
                        ...eveningAdvice,
                        priority: 0,
                        category: 'health',
                        isReminder: true,
                        onShow: () => {
                            try { sessionStorage.setItem('heys_evening_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            } else {
                const suppNames = eveningSupps
                    .map(id => window.HEYS?.Supplements?.CATALOG?.[id]?.name || id)
                    .slice(0, 3)
                    .join(', ');

                advices.push({
                    id: 'evening_supplements_reminder',
                    icon: 'üåô',
                    text: `–í–µ—á–µ—Ä–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã: ${suppNames}${eveningSupps.length > 3 ? ` –∏ –µ—â—ë ${eveningSupps.length - 3}` : ''}`,
                    details: '–ù–µ –∑–∞–±—É–¥—å –ø—Ä–∏–Ω—è—Ç—å –≤–µ—á–µ—Ä–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã! –ú–∞–≥–Ω–∏–π –∏ –º–µ–ª–∞—Ç–æ–Ω–∏–Ω –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–µ—Ä–µ–¥ —Å–Ω–æ–º. –û—Ç–º–µ—Ç—å –∏—Ö –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≤–∏—Ç–∞–º–∏–Ω–æ–≤!',
                    type: 'health',
                    priority: 0,
                    category: 'health',
                    isReminder: true,
                    triggers: ['product_added'],
                    ttl: 8000,
                    onShow: () => {
                        try { sessionStorage.setItem('heys_evening_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                    }
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üéØ Special day tips
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (specialDay === 'monday_morning') {
            advices.push({
                id: 'monday_motivation',
                icon: 'üí™',
                text: helpers.personalizeText(helpers.pickRandomText([
                    '–ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è ‚Äî –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!',
                    '${firstName}, –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è ‚Äî –Ω–æ–≤—ã–π —Å—Ç–∞—Ä—Ç!',
                    '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ü–µ–ª–µ–π!'
                ]), ctx),
                details: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞–Ω–∏—Ä—É—é—Ç –ø–∏—Ç–∞–Ω–∏–µ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –Ω–∞ 30% —É—Å–ø–µ—à–Ω–µ–µ –¥–æ—Å—Ç–∏–≥–∞—é—Ç —Ü–µ–ª–µ–π. –ó–∞–ø–∏—à–∏ –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é!',
                type: 'tip',
                priority: 5,
                category: 'motivation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (specialDay === 'friday_evening') {
            advices.push({
                id: 'friday_reminder',
                icon: 'üéØ',
                text: '–í—ã—Ö–æ–¥–Ω—ã–µ –±–ª–∏–∑–∫–æ ‚Äî –ø–æ–º–Ω–∏ –æ —Å–≤–æ–∏—Ö —Ü–µ–ª—è—Ö!',
                details: '–í –≤—ã—Ö–æ–¥–Ω—ã–µ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–µ—Å—Ç—å –Ω–∞ 500-1000 –∫–∫–∞–ª. –°–æ–≤–µ—Ç: –ø–æ–∑–≤–æ–ª—å —Å–µ–±–µ 1 "—Å–≤–æ–±–æ–¥–Ω—ã–π" –ø—Ä–∏—ë–º, –Ω–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–µ—Ä–∂–∏ –≤ –Ω–æ—Ä–º–µ.',
                type: 'tip',
                priority: 10,
                category: 'motivation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (specialDay === 'sunday_evening') {
            advices.push({
                id: 'sunday_planning',
                icon: 'üìã',
                text: '–°–ø–ª–∞–Ω–∏—Ä—É–π –ø–∏—Ç–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é',
                details: 'Meal prep –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ —ç–∫–æ–Ω–æ–º–∏—Ç 3-5 —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é. –ü—Ä–∏–≥–æ—Ç–æ–≤—å –±–∞–∑—É: –∫—Ä—É–ø—ã, –º—è—Å–æ, –æ–≤–æ—â–∏ ‚Äî –∫–æ–º–±–∏–Ω–∏—Ä—É–π –≤ —Ä–∞–∑–Ω—ã–µ –±–ª—é–¥–∞.',
                type: 'tip',
                priority: 10,
                category: 'motivation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const today = new Date();
        const dayOfMonth = today.getDate();
        const monthOfYear = today.getMonth();
        const postHolidayDates = [
            [1, 0], [2, 0],
            [24, 1],
            [9, 2],
            [10, 4],
            [13, 5]
        ];
        const isPostHoliday = postHolidayDates.some(([d, m]) => d === dayOfMonth && m === monthOfYear);

        if (isPostHoliday && !sessionStorage.getItem('heys_post_holiday')) {
            advices.push({
                id: 'post_holiday_detox',
                icon: 'üåø',
                text: '–ü–æ—Å–ª–µ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ ‚Äî –ª—ë–≥–∫–∏–π –¥–µ–Ω—å: –æ–≤–æ—â–∏, –≤–æ–¥–∞, –±–µ–ª–æ–∫',
                details: '–ù–µ –Ω—É–∂–Ω–æ –≥–æ–ª–æ–¥–∞—Ç—å! –ü—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏ –ª—ë–≥–∫—É—é –µ–¥—É: —Å–∞–ª–∞—Ç—ã, —Ä—ã–±–∞ –Ω–∞ –ø–∞—Ä—É, –º–Ω–æ–≥–æ –≤–æ–¥—ã. –û—Ä–≥–∞–Ω–∏–∑–º —Å–∞–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –±–∞–ª–∞–Ω—Å –∑–∞ 1-2 –¥–Ω—è.',
                type: 'tip',
                priority: 15,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 6000,
                onShow: () => { try { sessionStorage.setItem('heys_post_holiday', '1'); } catch (e) { } }
            });
        }

        // Best day recall
        const lastBestDayCheck = localStorage.getItem('heys_best_day_last_check');
        const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

        if (!lastBestDayCheck || +lastBestDayCheck < weekAgo) {
            const recentDays = helpers.getRecentDays(7);

            if (recentDays.length >= 3) {
                let bestDay = null;
                let bestDiff = Infinity;

                for (const d of recentDays) {
                    const dayMeals = d.meals || [];
                    let dayKcal = 0;
                    for (const meal of dayMeals) {
                        for (const item of (meal.items || [])) {
                            const product = helpers.getProductForItem(item, pIndex);
                            if (product) dayKcal += (product.kcal100 || 0) * (item.grams || 100) / 100;
                        }
                    }

                    const ratio = dayKcal / (optimum || 2000);
                    const diff = Math.abs(ratio - 1.0);

                    if (diff < bestDiff && ratio > 0.5) {
                        bestDiff = diff;
                        bestDay = { ...d, ratio };
                    }
                }

                if (bestDay && bestDiff < 0.15) {
                    const dayDate = new Date(bestDay.date);
                    const dayNames = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
                    const dayName = dayNames[dayDate.getDay()];
                    const pct = Math.round(bestDay.ratio * 100);

                    advices.push({
                        id: 'best_day_recall',
                        icon: '‚≠ê',
                        text: `–¢–≤–æ–π –ª—É—á—à–∏–π –¥–µ–Ω—å –±—ã–ª ${dayName} ‚Äî ${pct}% –Ω–æ—Ä–º—ã. –ü–æ–≤—Ç–æ—Ä–∏!`,
                        details: 'üí° –í—Å–ø–æ–º–Ω–∏, —á—Ç–æ —Ç—ã –µ–ª –≤ —Ç–æ—Ç –¥–µ–Ω—å. –•–æ—Ä–æ—à–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å—Ç–æ–∏—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å!',
                        type: 'motivation',
                        priority: 44,
                        category: 'motivation',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => {
                            try { localStorage.setItem('heys_best_day_last_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üèÜ Achievements & streaks
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (currentStreak >= 7 && !sessionStorage.getItem('heys_streak7')) {
            advices.push({
                id: 'streak_7',
                icon: 'üèÜ',
                text: helpers.personalizeText(helpers.pickRandomText([
                    `–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! ${currentStreak} –¥–Ω–µ–π –≤ –Ω–æ—Ä–º–µ!`,
                    '${firstName}, —Ç—ã –ª–µ–≥–µ–Ω–¥–∞! ' + currentStreak + ' –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥!',
                    `üî• ${currentStreak} –¥–Ω–µ–π streak! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!`
                ]), ctx),
                details: 'üåü –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ç—ã —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª –ø—Ä–∏–≤—ã—á–∫—É! –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: 21 –¥–µ–Ω—å ‚Äî –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ —Å—Ç–∞–Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º.',
                type: 'achievement',
                priority: 1,
                category: 'achievement',
                score: 1.0,
                triggers: ['tab_open'],
                ttl: 7000,
                showConfetti: true,
                canSkipCooldown: true,
                excludes: ['streak_3'],
                onShow: () => { try { sessionStorage.setItem('heys_streak7', '1'); } catch (e) { } }
            });
        }

        if (currentStreak >= 3 && currentStreak < 7 && !sessionStorage.getItem('heys_streak3')) {
            advices.push({
                id: 'streak_3',
                icon: 'üî•',
                text: `${currentStreak} –¥–Ω—è –ø–æ–¥—Ä—è–¥ –≤ –Ω–æ—Ä–º–µ! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!`,
                details: 'üí™ –¢—ã –Ω–∞ –ø—É—Ç–∏ –∫ –ø—Ä–∏–≤—ã—á–∫–µ! –ï—â—ë 4 –¥–Ω—è ‚Äî –∏ –±—É–¥–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π streak. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –Ω–æ—Ä–º–µ ‚Äî —ç—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –∑–¥–æ—Ä–æ–≤—å–µ.',
                type: 'achievement',
                priority: 2,
                category: 'achievement',
                score: 0.9,
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_streak3', '1'); } catch (e) { } }
            });
        }

        if (hour >= 18 && helpers.isInTargetRange(kcalPct, goal) &&
            proteinPct >= 0.9 && ctx.fatPct >= 0.9 && ctx.carbsPct >= 0.9) {
            advices.push({
                id: 'perfect_day',
                icon: '‚≠ê',
                text: goal.mode === 'bulk'
                    ? '–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –Ω–∞–±–æ—Ä–∞! üí™üéâ'
                    : goal.mode === 'deficit'
                        ? '–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç —Å –±–∞–ª–∞–Ω—Å–æ–º –ë–ñ–£! üî•üéâ'
                        : '–ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ üéâ',
                details: 'üåü –ö–∞–ª–æ—Ä–∏–∏, –±–µ–ª–∫–∏, –∂–∏—Ä—ã –∏ —É–≥–ª–µ–≤–æ–¥—ã ‚Äî –≤—Å—ë –≤ –Ω–æ—Ä–º–µ. –¢–∞–∫–∏–µ –¥–Ω–∏ –ø—Ä–∏–±–ª–∏–∂–∞—é—Ç —Ç–µ–±—è –∫ —Ü–µ–ª–∏. –ó–∞–ø–æ–º–Ω–∏, —á—Ç–æ –µ–ª —Å–µ–≥–æ–¥–Ω—è!',
                type: 'achievement',
                priority: 5,
                category: 'achievement',
                score: 1.0,
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (mealCount === 1 && !localStorage.getItem('heys_first_meal_tip')) {
            advices.push({
                id: 'first_day',
                icon: 'üëã',
                text: '–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ! –ó–∞–ø–∏—Å—ã–≤–∞–π –≤—Å—ë ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É',
                details: 'üìä –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –µ–¥—É, —Ö—É–¥–µ—é—Ç –≤ 2 —Ä–∞–∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ. –ó–∞–ø–∏—Å—ã–≤–∞–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –µ–¥—ã ‚Äî —Ç–∞–∫ —Ç–æ—á–Ω–µ–µ.',
                type: 'achievement',
                priority: 3,
                category: 'achievement',
                score: 1.0,
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => { try { localStorage.setItem('heys_first_meal_tip', '1'); } catch (e) { } }
            });
        }

        if (proteinPct >= rules.THRESHOLDS.protein.champion && !sessionStorage.getItem('heys_protein_champion')) {
            advices.push({
                id: 'protein_champion',
                icon: 'üèÜ',
                text: helpers.personalizeText(helpers.pickRandomText([
                    '–ë–µ–ª–∫–æ–≤—ã–π —á–µ–º–ø–∏–æ–Ω! –ú—ã—à—Ü—ã —Ç–µ–±—è –±–ª–∞–≥–æ–¥–∞—Ä—è—Ç',
                    '${firstName}, —Ç—ã –±–µ–ª–∫–æ–≤—ã–π —á–µ–º–ø–∏–æ–Ω! üèÜ',
                    '–ë–µ–ª–∫–∞ –±–æ–ª—å—à–µ –Ω–æ—Ä–º—ã ‚Äî –º—ã—à—Ü—ã —Ä–∞–¥—ã!'
                ]), ctx),
                details: 'üí™ –ë–µ–ª–æ–∫ 1.5-2–≥/–∫–≥ ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–æ—Å—Ç–∞ –º—ã—à—Ü –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ü–µ—Ä–µ–∏–∑–±—ã—Ç–æ–∫ –±–µ–ª–∫–∞ –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥–µ–π.',
                type: 'achievement',
                priority: 10,
                category: 'achievement',
                triggers: ['tab_open', 'product_added'],
                ttl: 5000,
                excludes: ['protein_low', 'post_training_protein'],
                onShow: () => { try { sessionStorage.setItem('heys_protein_champion', '1'); } catch (e) { } }
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üåû Lifestyle tips
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const sleepHours = helpers.calculateSleepHours(day);
        if (sleepHours > 0 && sleepHours < 6) {
            advices.push({
                id: 'sleep_low',
                icon: 'üò¥',
                text: '–ú–∞–ª–æ —Å–Ω–∞ ‚Äî –∞–ø–ø–µ—Ç–∏—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—ã—à–µ–Ω',
                details: 'üí§ –ù–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –≥—Ä–µ–ª–∏–Ω (–≥–æ—Ä–º–æ–Ω –≥–æ–ª–æ–¥–∞) –∏ —Å–Ω–∏–∂–∞–µ—Ç –ª–µ–ø—Ç–∏–Ω (—Å—ã—Ç–æ—Å—Ç—å). –°–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç —Ö–æ—Ç–µ—Ç—å—Å—è –µ—Å—Ç—å –±–æ–ª—å—à–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.',
                type: 'tip',
                priority: 51,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hour >= 7 && hour < 10 && mealCount === 0) {
            advices.push({
                id: 'morning_breakfast',
                icon: '‚òÄÔ∏è',
                text: '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–µ –∑–∞–±—É–¥—å –ø–æ–∑–∞–≤—Ç—Ä–∞–∫–∞—Ç—å',
                details: 'üç≥ –ó–∞–≤—Ç—Ä–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –¥–∞—ë—Ç —ç–Ω–µ—Ä–≥–∏—é. –ò–¥–µ–∞–ª—å–Ω–æ: –±–µ–ª–æ–∫ + —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (—è–π—Ü–∞ + –æ–≤—Å—è–Ω–∫–∞, —Ç–≤–æ—Ä–æ–≥ + —Ñ—Ä—É–∫—Ç—ã).',
                type: 'tip',
                priority: 52,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hour >= 10 && hour < 12 && mealCount === 0 && !sessionStorage.getItem('heys_morning_breakfast_shown')) {
            advices.push({
                id: 'empty_stomach_late',
                icon: 'üç≥',
                text: `–£–∂–µ ${hour}:00, –∞ –∑–∞–≤—Ç—Ä–∞–∫–∞ –Ω–µ—Ç ‚Äî –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∂–¥—ë—Ç —Ç–æ–ø–ª–∏–≤–∞`,
                details: '‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≤—Ç—Ä–∞–∫–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—é –≤–µ—á–µ—Ä–æ–º. –ï—Å–ª–∏ –Ω–µ –≥–æ–ª–æ–¥–µ–Ω ‚Äî —Ö–æ—Ç—è –±—ã –ª—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å.',
                type: 'tip',
                priority: 53,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_morning_breakfast_shown', '1'); } catch (e) { } }
            });
        }

        if (hour === 13 && mealCount === 1) {
            advices.push({
                id: 'lunch_time',
                icon: 'üçΩÔ∏è',
                text: '–ß–∞—Å –¥–Ω—è ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –æ–±–µ–¥–∞!',
                details: 'üåû –û–±–µ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∞–º—ã–º –ø–ª–æ—Ç–Ω—ã–º –ø—Ä–∏—ë–º–æ–º –¥–Ω—è (35-40% –∫–∞–ª–æ—Ä–∏–π). –ò–¥–µ–∞–ª—å–Ω–æ: –±–µ–ª–æ–∫ + —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + –æ–≤–æ—â–∏.',
                type: 'tip',
                priority: 52,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hour === 16 && kcalPct < 0.6) {
            const remaining = Math.round((optimum || 2000) * (1 - kcalPct));
            advices.push({
                id: 'snack_window',
                icon: 'ü•™',
                text: `16:00 ‚Äî –≤—Ä–µ–º—è –ø–æ–ª–¥–Ω–∏–∫–∞. –û—Å—Ç–∞–ª–æ—Å—å ~${remaining} –∫–∫–∞–ª`,
                details: 'üçè –ü–æ–ª–¥–Ω–∏–∫ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–µ –ø–µ—Ä–µ–µ—Å—Ç—å –∑–∞ —É–∂–∏–Ω–æ–º. –ò–¥–µ–∏: –æ—Ä–µ—Ö–∏, —è–±–ª–æ–∫–æ, –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç, —Ç–≤–æ—Ä–æ–≥.',
                type: 'tip',
                priority: 51,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const steps = day?.steps || 0;
        if (steps >= 10000) {
            advices.push({
                id: 'steps_goal',
                icon: 'üö∂',
                text: `${steps.toLocaleString()} —à–∞–≥–æ–≤! –û—Ç–ª–∏—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å`,
                details: 'üéØ 10 000 —à–∞–≥–æ–≤ —Å–∂–∏–≥–∞—é—Ç ~400-500 –∫–∫–∞–ª –∏ —É–ª—É—á—à–∞—é—Ç —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É. –≠—Ç–æ —Ç–≤–æ–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å!',
                type: 'achievement',
                priority: 53,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const isWeekend = [0, 6].includes(new Date().getDay());
        if (isWeekend && kcalPct > goal.targetRange.max && !helpers.isCriticallyOver(kcalPct, goal) && goal.mode !== 'bulk') {
            advices.push({
                id: 'weekend_relax',
                icon: 'üõãÔ∏è',
                text: '–í—ã—Ö–æ–¥–Ω–æ–π —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—à—å—Å—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ',
                details: 'üéâ –õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ ‚Äî —ç—Ç–æ –û–ö! –ì–ª–∞–≤–Ω–æ–µ ‚Äî —Å—Ä–µ–¥–Ω—è—è –∑–∞ –Ω–µ–¥–µ–ª—é. –ù–∞—Å–ª–∞–∂–¥–∞–π—Å—è –±–µ–∑ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã.',
                type: 'tip',
                priority: 86,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚ùÑÔ∏è Seasonal tips
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const month = new Date().getMonth();
        for (const seasonal of SEASONAL_TIPS) {
            if (seasonal.months.includes(month) && !sessionStorage.getItem('heys_seasonal_' + seasonal.id)) {
                advices.push({
                    id: seasonal.id,
                    icon: seasonal.icon,
                    text: helpers.personalizeText(helpers.pickRandomText(seasonal.texts), ctx),
                    type: 'tip',
                    priority: seasonal.priority,
                    category: seasonal.category,
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_seasonal_' + seasonal.id, '1'); } catch (e) { } }
                });
                break;
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìà Caloric excess & circadian context
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const hasExcess = caloricDebt?.hasExcess;
        const cardioRec = caloricDebt?.cardioRecommendation;
        const activityCompensation = caloricDebt?.activityCompensation || 0;
        const dailyReduction = caloricDebt?.dailyReduction || 0;

        if (hasExcess && cardioRec && !cardioRec.compensatedBySteps && hour >= 14) {
            advices.push({
                id: 'excess_activity_recommended',
                icon: '‚ú®',
                text: `–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–±: ${cardioRec.text}`,
                details: `üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π! ${cardioRec.minutes} –º–∏–Ω ${cardioRec.activityIcon} –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç ~${activityCompensation} –∫–∫–∞–ª (70% –ø—Ä–æ—Ñ–∏—Ü–∏—Ç–∞). –≠—Ç–æ –∑–¥–æ—Ä–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞.`,
                type: 'tip',
                priority: 26,
                category: 'activity',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        if (hasExcess && cardioRec?.compensatedBySteps) {
            advices.push({
                id: 'excess_compensated_by_steps',
                icon: 'üëü',
                text: `–®–∞–≥–∏ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—Ç –ø–µ—Ä–µ–±–æ—Ä –Ω–∞ ${cardioRec.stepsCompensation}%!`,
                details: `üéâ –¢–≤–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–∂–µ —Å–¥–µ–ª–∞–ª–∞ —Ä–∞–±–æ—Ç—É! ${day?.steps || 0} —à–∞–≥–æ–≤ —á–∞—Å—Ç–∏—á–Ω–æ –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–æ—Ñ–∏—Ü–∏—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.`,
                type: 'achievement',
                priority: 12,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (dailyReduction > 50 && !caloricDebt?.hasDebt && hour < 14) {
            advices.push({
                id: 'excess_soft_correction',
                icon: 'üéØ',
                text: `–ù–æ—Ä–º–∞ —á—É—Ç—å —Å–Ω–∏–∂–µ–Ω–∞ (‚àí${dailyReduction} –∫–∫–∞–ª) ‚Äî –º—è–≥–∫–∏–π –∞–∫—Ü–µ–Ω—Ç`,
                details: 'üìä –≠—Ç–æ –Ω–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ! –ö–æ—Ä—Ä–µ–∫—Ü–∏—è 5-10% –ø–æ–º–æ–≥–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π.',
                type: 'tip',
                priority: 35,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const rawDebt = caloricDebt?.rawDebt || caloricDebt?.debt || 0;
        if (caloricDebt?.hasDebt && hour < 12 && rawDebt < 600) {
            advices.push({
                id: 'circadian_morning_calm',
                icon: 'üåÖ',
                text: '–£—Ç—Ä–æ ‚Äî –µ—â—ë —Ä–∞–Ω–æ –ø–æ–¥–≤–æ–¥–∏—Ç—å –∏—Ç–æ–≥–∏',
                details: '‚è∞ –ù–µ–¥–æ–±–æ—Ä —Å–µ–π—á–∞—Å ‚Äî –Ω–æ—Ä–º–∞. –î–µ–Ω—å –≤–ø–µ—Ä–µ–¥–∏! –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –∑–∞–≤—Ç—Ä–∞–∫–µ —Å –±–µ–ª–∫–æ–º, –∞ –Ω–µ –Ω–∞ —Ü–∏—Ñ—Ä–∞—Ö.',
                type: 'tip',
                priority: 50,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        if (caloricDebt?.hasDebt && hour >= 20 && rawDebt > 500) {
            advices.push({
                id: 'circadian_evening_urgent',
                icon: 'üåô',
                text: '–í–µ—á–µ—Ä ‚Äî –Ω—É–∂–Ω–æ –ø–æ–µ—Å—Ç—å –¥–æ —Å–Ω–∞',
                details: '‚ö†Ô∏è –ë–æ–ª—å—à–æ–π –Ω–µ–¥–æ–±–æ—Ä –ø–µ—Ä–µ–¥ —Å–Ω–æ–º —É—Ö—É–¥—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –∏ –ø–æ–≤—ã—Å–∏—Ç –≥—Ä–µ–ª–∏–Ω –∑–∞–≤—Ç—Ä–∞. –°—ä–µ—à—å —Ö–æ—Ç—è –±—ã 200-300 –∫–∫–∞–ª –±–µ–ª–∫–æ–≤–æ–≥–æ –ø–µ—Ä–µ–∫—É—Å–∞.',
                type: 'warning',
                priority: 19,
                category: 'timing',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        const bmiCtx = caloricDebt?.bmiContext;
        if (bmiCtx && caloricDebt?.hasDebt && bmiCtx.category === 'underweight') {
            advices.push({
                id: 'bmi_underweight_warning',
                icon: '‚ö†Ô∏è',
                text: '–í–µ—Å –Ω–∏–∂–µ –Ω–æ—Ä–º—ã ‚Äî –Ω–µ–¥–æ–µ–¥–∞–Ω–∏–µ –æ–ø–∞—Å–Ω–æ!',
                details: 'ü©∫ –ü—Ä–∏ BMI < 18.5 –Ω–µ–¥–æ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π –æ—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–µ–Ω. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–∫–æ—Ä–µ–Ω–æ –Ω–∞ 30%. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–∞–±—Ä–∞—Ç—å –Ω–æ—Ä–º—É!',
                type: 'warning',
                priority: 13,
                category: 'health',
                triggers: ['tab_open'],
                ttl: 8000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üîÑ Refeed day tips
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (window.HEYS?.Refeed?.getRefeedAdvices) {
            const refeedAdvices = window.HEYS.Refeed.getRefeedAdvices({
                isRefeedDay: day?.isRefeedDay,
                refeedReason: day?.refeedReason,
                caloricDebt: caloricDebt,
                eatenKcal: dayTot?.kcal || 0,
                optimum: optimum,
                hour: hour
            });
            advices.push(...refeedAdvices);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìä Weight trends & forecast
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const recentDaysForWeight = helpers.getRecentDays(7);
        const weightsForTrend = recentDaysForWeight.map(d => d.weightMorning).filter(w => w > 0);

        if (weightsForTrend.length >= 3) {
            const firstAvg = weightsForTrend.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
            const lastAvg = weightsForTrend.slice(-3).reduce((a, b) => a + b, 0) / 3;
            const trendPerWeek = ((lastAvg - firstAvg) / weightsForTrend.length) * 7;

            if (trendPerWeek < -0.3 && !sessionStorage.getItem('heys_weight_trend_down')) {
                advices.push({
                    id: 'weight_trend_down',
                    icon: 'üìâ',
                    text: '–í–µ—Å —É—Ö–æ–¥–∏—Ç! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å',
                    details: 'üèÜ –¢—Ä–µ–Ω–¥ –≤–Ω–∏–∑ = –¥–µ—Ñ–∏—Ü–∏—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! 0.5-1 –∫–≥/–Ω–µ–¥–µ–ª—è ‚Äî –∑–¥–æ—Ä–æ–≤—ã–π —Ç–µ–º–ø –ø–æ—Ö—É–¥–µ–Ω–∏—è.',
                    type: 'achievement',
                    priority: 6,
                    category: 'weight',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_weight_trend_down', '1'); } catch (e) { } }
                });
            }

            if (trendPerWeek > 0.5 && !sessionStorage.getItem('heys_weight_trend_up')) {
                advices.push({
                    id: 'weight_trend_up',
                    icon: 'üìà',
                    text: '–í–µ—Å —Ä–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–æ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –∫–∞–ª–æ—Ä–∏–∏',
                    details: '‚ö†Ô∏è >0.5 –∫–≥/–Ω–µ–¥–µ–ª—è = —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä—ã–π –Ω–∞–±–æ—Ä. –ü—Ä–æ–≤–µ—Ä—å –∫–∞–ª–æ—Ä–∞–∂ –∏ —Å–∫—Ä—ã—Ç—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã.',
                    type: 'warning',
                    priority: 7,
                    category: 'weight',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_weight_trend_up', '1'); } catch (e) { } }
                });
            }

            const weightGoal = prof?.weightGoal;
            const currentWeight = day?.weightMorning || weightsForTrend[weightsForTrend.length - 1];

            if (weightGoal && currentWeight && Math.abs(currentWeight - weightGoal) > 0.5) {
                const deficitPct = Math.abs(prof?.deficitPctTarget || day?.deficitPct || 10);
                const rateKgPerWeek = (deficitPct / 100) * currentWeight * 0.8;
                const weightDiff = currentWeight - weightGoal;
                const actualRatePerWeek = (trendPerWeek !== 0) ? Math.abs(trendPerWeek) : rateKgPerWeek;
                const isGoingRight = (weightDiff > 0 && trendPerWeek < 0) || (weightDiff < 0 && trendPerWeek > 0);

                if (isGoingRight && actualRatePerWeek > 0.1) {
                    const weeksToGoal = Math.ceil(Math.abs(weightDiff) / actualRatePerWeek);

                    if (weeksToGoal <= 52) {
                        const goalDate = new Date();
                        goalDate.setDate(goalDate.getDate() + weeksToGoal * 7);
                        const goalDateStr = goalDate.toLocaleDateString('ru-RU', { month: 'long', day: 'numeric' });

                        advices.push({
                            id: 'weight_forecast_on_track',
                            icon: 'üéØ',
                            text: `–ü–æ –ø—Ä–æ–≥–Ω–æ–∑—É ${weightGoal}–∫–≥ ‚Äî –∫ ${goalDateStr}`,
                            details: `üìä –ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ (${actualRatePerWeek.toFixed(1)} –∫–≥/–Ω–µ–¥) —Ü–µ–ª—å –≤ ${weightGoal}–∫–≥ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ —á–µ—Ä–µ–∑ ~${weeksToGoal} –Ω–µ–¥. –ü—Ä–æ–¥–æ–ª–∂–∞–π!`,
                            type: 'achievement',
                            priority: rules.PRIORITY.ACHIEVEMENT,
                            category: 'weight',
                            triggers: ['tab_open'],
                            ttl: 6000
                        });
                    } else {
                        advices.push({
                            id: 'weight_forecast_slow',
                            icon: 'üê¢',
                            text: `–¢–µ–º–ø –º–µ–¥–ª–µ–Ω–Ω—ã–π ‚Äî —Ü–µ–ª—å –¥–∞–ª–µ–∫–æ (>${Math.round(weeksToGoal / 4)} –º–µ—Å)`,
                            details: `‚è∞ –ü—Ä–∏ ${actualRatePerWeek.toFixed(1)} –∫–≥/–Ω–µ–¥ –¥–æ ${weightGoal}–∫–≥ ‚Äî –±–æ–ª–µ–µ ${Math.round(weeksToGoal / 4)} –º–µ—Å—è—Ü–µ–≤. –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.`,
                            type: 'tip',
                            priority: rules.PRIORITY.LOW,
                            category: 'weight',
                            triggers: ['tab_open'],
                            ttl: 6000
                        });
                    }
                }

                if (!isGoingRight && Math.abs(trendPerWeek) > 0.2) {
                    advices.push({
                        id: 'weight_forecast_wrong_direction',
                        icon: '‚ö†Ô∏è',
                        text: '–í–µ—Å –∏–¥—ë—Ç –æ—Ç —Ü–µ–ª–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–ª–∞–Ω',
                        details: `üîÑ –¶–µ–ª—å ${weightGoal}–∫–≥, –Ω–æ —Ç—Ä–µ–Ω–¥ ${trendPerWeek > 0 ? '+' : ''}${trendPerWeek.toFixed(1)} –∫–≥/–Ω–µ–¥. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏ –∫–∞–ª–æ—Ä–∏–∏ –∏–ª–∏ –¥–æ–±–∞–≤—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.`,
                        type: 'warning',
                        priority: rules.PRIORITY.IMPORTANT,
                        category: 'weight',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                }

                if (Math.abs(weightDiff) < 2) {
                    advices.push({
                        id: 'weight_almost_there',
                        icon: 'üèÅ',
                        text: `–î–æ —Ü–µ–ª–∏ ${Math.abs(weightDiff).toFixed(1)}–∫–≥ ‚Äî —Ñ–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è!`,
                        details: `üéØ –û—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 2–∫–≥ –¥–æ ${weightGoal}–∫–≥! –§–∏–Ω–∏—à –±–ª–∏–∑–∫–æ ‚Äî –Ω–µ —Å–±–∞–≤–ª—è–π —Ç–µ–º–ø!`,
                        type: 'achievement',
                        priority: rules.PRIORITY.ACHIEVEMENT - 1,
                        category: 'weight',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìè Measurements insights
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const getMeasurementsHistory = window.HEYS?.Steps?.getMeasurementsHistory;
        if (typeof getMeasurementsHistory === 'function') {
            const measurementsHistory = getMeasurementsHistory(30);

            if (measurementsHistory && measurementsHistory.length >= 2) {
                const latest = measurementsHistory[0];
                const oldest = measurementsHistory[measurementsHistory.length - 1];

                const waistChange = (latest.waist && oldest.waist) ? latest.waist - oldest.waist : null;
                const bicepsChange = (latest.biceps && oldest.biceps) ? latest.biceps - oldest.biceps : null;

                if (waistChange !== null && waistChange < -1 && !sessionStorage.getItem('heys_waist_down')) {
                    advices.push({
                        id: 'waist_down_progress',
                        icon: 'üìè',
                        text: `–¢–∞–ª–∏—è -${Math.abs(waistChange).toFixed(1)} —Å–º –∑–∞ –º–µ—Å—è—Ü! –ü—Ä–æ–≥—Ä–µ—Å—Å`,
                        details: 'üèÜ –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–∞–ª–∏–∏ = —É—Ö–æ–¥ –≤–∏—Å—Ü–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∂–∏—Ä–∞. –≠—Ç–æ –≤–∞–∂–Ω–µ–µ —Ü–∏—Ñ—Ä—ã –Ω–∞ –≤–µ—Å–∞—Ö!',
                        type: 'achievement',
                        priority: 5,
                        category: 'measurements',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        showConfetti: true,
                        onShow: () => { try { sessionStorage.setItem('heys_waist_down', '1'); } catch (e) { } }
                    });
                }

                if (bicepsChange !== null && bicepsChange > 0.5 && !sessionStorage.getItem('heys_biceps_up')) {
                    advices.push({
                        id: 'biceps_growing',
                        icon: 'üí™',
                        text: `–ë–∏—Ü–µ–ø—Å +${bicepsChange.toFixed(1)} —Å–º! –ú—ã—à—Ü—ã —Ä–∞—Å—Ç—É—Ç`,
                        details: 'üí™ –†–æ—Å—Ç –º—ã—à—Ü = –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ + –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–ª–∫–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π!',
                        type: 'achievement',
                        priority: 6,
                        category: 'measurements',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_biceps_up', '1'); } catch (e) { } }
                    });
                }

                const weightGoal = prof?.weightGoal || 0;
                const currentWeight = day?.weightMorning || prof?.weight || 0;

                if (weightGoal > 0 && currentWeight > 0 && waistChange !== null) {
                    const weightDiff = currentWeight - weightGoal;
                    if (weightDiff > 0 && waistChange < -0.5 && !sessionStorage.getItem('heys_weight_waist_corr')) {
                        advices.push({
                            id: 'weight_waist_correlation',
                            icon: 'üìä',
                            text: `–¢–∞–ª–∏—è -${Math.abs(waistChange).toFixed(1)} —Å–º = –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏`,
                            details: `üéØ –î–æ —Ü–µ–ª–∏ ${weightDiff.toFixed(1)} –∫–≥. –¢–∞–ª–∏—è —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è ‚Äî –∑–Ω–∞—á–∏—Ç –∂–∏—Ä —É—Ö–æ–¥–∏—Ç!`,
                            type: 'insight',
                            priority: 8,
                            category: 'correlation',
                            triggers: ['tab_open'],
                            ttl: 6000,
                            onShow: () => { try { sessionStorage.setItem('heys_weight_waist_corr', '1'); } catch (e) { } }
                        });
                    }

                    if (weightDiff < -2 && bicepsChange !== null && bicepsChange > 0.3 && !sessionStorage.getItem('heys_bulk_corr')) {
                        advices.push({
                            id: 'bulk_muscle_correlation',
                            icon: 'üèãÔ∏è',
                            text: '–í–µ—Å –≤—ã—à–µ —Ü–µ–ª–∏, –Ω–æ –º—ã—à—Ü—ã —Ä–∞—Å—Ç—É—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ',
                            details: 'üí° –ù–∞–±–æ—Ä –º—ã—à—Ü = –Ω–∞–±–æ—Ä –≤–µ—Å–∞. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –∑–∞–º–µ—Ä—ã, –Ω–µ —Ç–æ–ª—å–∫–æ –≤–µ—Å—ã.',
                            type: 'insight',
                            priority: 9,
                            category: 'correlation',
                            triggers: ['tab_open'],
                            ttl: 5000,
                            onShow: () => { try { sessionStorage.setItem('heys_bulk_corr', '1'); } catch (e) { } }
                        });
                    }
                }

                const lastMeasuredDate = latest?.measuredAt;
                if (lastMeasuredDate) {
                    const daysSinceMeasured = Math.floor((Date.now() - new Date(lastMeasuredDate).getTime()) / (1000 * 60 * 60 * 24));
                    if (daysSinceMeasured >= 14 && !sessionStorage.getItem('heys_measure_reminder')) {
                        advices.push({
                            id: 'measure_reminder',
                            icon: 'üìê',
                            text: `${daysSinceMeasured} –¥–Ω–µ–π –±–µ–∑ –∑–∞–º–µ—Ä–æ–≤ ‚Äî –ø–æ—Ä–∞ –∏–∑–º–µ—Ä–∏—Ç—å—Å—è`,
                            details: 'üìè –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ä—ã –ø–æ–º–æ–≥–∞—é—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –≤–µ—Å.',
                            type: 'tip',
                            priority: 15,
                            category: 'measurements',
                            triggers: ['tab_open'],
                            ttl: 5000,
                            onShow: () => { try { sessionStorage.setItem('heys_measure_reminder', '1'); } catch (e) { } }
                        });
                    }
                }
            }

            if (measurementsHistory && measurementsHistory.length === 1 && !helpers.isMilestoneShown('first_measurement')) {
                advices.push({
                    id: 'first_measurement',
                    icon: 'üìè',
                    text: '–ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä —Å–¥–µ–ª–∞–Ω! –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å',
                    details: 'üéØ –ó–∞–º–µ—Ä—ã —Ç–µ–ª–∞ —Ç–æ—á–Ω–µ–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á–µ–º –≤–µ—Å—ã. –ò–∑–º–µ—Ä—è–π—Å—è —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.',
                    type: 'achievement',
                    priority: 4,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    showConfetti: true,
                    onShow: () => helpers.markMilestoneShown('first_measurement')
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìä Behavioral patterns
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const recentForTraining = helpers.getRecentDays(3); // 3 –¥–Ω—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        const todayHasTraining = (day?.trainings || []).some(t => t.z?.some(m => m > 0));
        if (todayHasTraining && recentForTraining.length >= 3 && !sessionStorage.getItem('heys_workout_consistent')) {
            const allThreeHaveTraining = recentForTraining.every(d =>
                (d.trainings || []).some(t => t.z?.some(m => m > 0))
            );

            if (allThreeHaveTraining) {
                advices.push({
                    id: 'workout_consistent',
                    icon: 'üî•',
                    text: '3 –¥–Ω—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–¥—Ä—è–¥! –¢—ã –º–∞—à–∏–Ω–∞ üí™',
                    details: 'üéØ –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏. 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥ = –ø—Ä–∏–≤—ã—á–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è!',
                    type: 'achievement',
                    priority: 7,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_workout_consistent', '1'); } catch (e) { } }
                });
            }
        }

        const lastEvensCheck = localStorage.getItem('heys_evening_snacker_check');
        const weekAgoPattern = Date.now() - 7 * 24 * 60 * 60 * 1000;

        if (!lastEvensCheck || +lastEvensCheck < weekAgoPattern) {
            const recentForPattern = helpers.getRecentDays(3);

            if (recentForPattern.length >= 3) {
                const allLateEaters = recentForPattern.every(d => {
                    const dayMeals = (d.meals || []).filter(m => m.items?.length > 0);
                    if (dayMeals.length === 0) return false;
                    const times = dayMeals.map(m => m.time || '12:00').sort();
                    const lastTime = times[times.length - 1];
                    const [h] = lastTime.split(':').map(Number);
                    return h >= 22;
                });

                if (allLateEaters) {
                    advices.push({
                        id: 'evening_snacker',
                        icon: 'üåô',
                        text: '–ó–∞–º–µ—Ç–∏–ª —Ç—Ä–µ–Ω–¥ ‚Äî —Ç—ã —á–∞—Å—Ç–æ —É–∂–∏–Ω–∞–µ—à—å –ø–æ–∑–¥–Ω–æ. –ú–æ–∂–µ—Ç, –ø–µ—Ä–µ–∫—É—Å —Ä–∞–Ω—å—à–µ?',
                        details: 'üí° –ü–æ–∑–¥–Ω–∏–µ —É–∂–∏–Ω—ã —É—Ö—É–¥—à–∞—é—Ç —Å–æ–Ω –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º. –ü–æ–ø—Ä–æ–±—É–π —É–∂–∏–Ω–∞—Ç—å –¥–æ 20:00.',
                        type: 'insight',
                        priority: 38,
                        category: 'correlation',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => {
                            try { localStorage.setItem('heys_evening_snacker_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        const lastSkipCheck = localStorage.getItem('heys_morning_skipper_check');
        if (!lastSkipCheck || +lastSkipCheck < weekAgoPattern) {
            const recentForSkip = helpers.getRecentDays(3);

            if (recentForSkip.length >= 3) {
                const allSkipBreakfast = recentForSkip.every(d => {
                    const dayMeals = (d.meals || []).filter(m => m.items?.length > 0);
                    if (dayMeals.length === 0) return true;
                    const times = dayMeals.map(m => m.time || '12:00').sort();
                    const firstTime = times[0];
                    const [h] = firstTime.split(':').map(Number);
                    return h >= 11;
                });

                if (allSkipBreakfast) {
                    advices.push({
                        id: 'morning_skipper',
                        icon: 'ü§î',
                        text: '–£–∂–µ 3 –¥–Ω—è –±–µ–∑ —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–≤—Ç—Ä–∞–∫–∞ ‚Äî —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–µ—à—å —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–º –≥–æ–ª–æ–¥–∞–Ω–∏–µ–º?',
                        details: 'ü•ê –ï—Å–ª–∏ 16/8 ‚Äî –æ—Ç–ª–∏—á–Ω–æ! –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∑–∞–≤—Ç—Ä–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º.',
                        type: 'insight',
                        priority: 39,
                        category: 'correlation',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => {
                            try { localStorage.setItem('heys_morning_skipper_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        const lastUnderCheck = localStorage.getItem('heys_chronic_undereating_check');
        if (!lastUnderCheck || +lastUnderCheck < weekAgoPattern) {
            const recentForUnder = helpers.getRecentDays(3);

            if (recentForUnder.length >= 3) {
                const underEatingDays = recentForUnder.filter(d => {
                    const dayMeals = (d.meals || []).filter(m => m.items?.length > 0);
                    if (dayMeals.length === 0) return false;

                    let dayKcal = 0;
                    for (const meal of dayMeals) {
                        for (const item of meal.items || []) {
                            const product = helpers.getProductForItem(item, pIndex);
                            if (product) {
                                const grams = item.grams || 100;
                                dayKcal += (product.kcal100 || 0) * grams / 100;
                            }
                        }
                    }

                    const dayRatio = dayKcal / (optimum || 2000);
                    return dayRatio < 0.75;
                });

                if (underEatingDays.length >= 3) {
                    advices.push({
                        id: 'chronic_undereating_pattern',
                        icon: 'üö®',
                        text: '–£–∂–µ 3+ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Å–∏–ª—å–Ω—ã–π –Ω–µ–¥–æ–±–æ—Ä ‚Äî —ç—Ç–æ –æ–ø–∞—Å–Ω–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è',
                        details: `üî¨ –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç (>25% –æ—Ç –Ω–æ—Ä–º—ã) –≤—ã–∑—ã–≤–∞–µ—Ç:\n\n` +
                            `‚Ä¢ –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫—É—é –∞–¥–∞–ø—Ç–∞—Ü–∏—è ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–±–º–µ–Ω –≤–µ—â–µ—Å—Ç–≤\n` +
                            `‚Ä¢ –ü–æ—Ç–µ—Ä—é –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã (—Ç–µ–ª–æ —Ä–∞—Å—â–µ–ø–ª—è–µ—Ç –º—ã—à—Ü—ã –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏)\n` +
                            `‚Ä¢ –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (—â–∏—Ç–æ–≤–∏–¥–∫–∞, –∫–æ—Ä—Ç–∏–∑–æ–ª, –ø–æ–ª–æ–≤—ã–µ –≥–æ—Ä–º–æ–Ω—ã)\n` +
                            `‚Ä¢ –í—ã–ø–∞–¥–µ–Ω–∏–µ –≤–æ–ª–æ—Å (—Ç–µ–ª–æ–≥–µ–Ω–æ–≤–∞—è –∞–ª–æ–ø–µ—Ü–∏—è)\n\n` +
                            `üí° –°–æ–≤–µ—Ç: –ª–∏–±–æ —É–≤–µ–ª–∏—á—å –ø–æ—Ä—Ü–∏–∏, –ª–∏–±–æ –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ –Ω–æ—Ä–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.`,
                        type: 'warning',
                        priority: 3,
                        category: 'correlation',
                        triggers: ['tab_open'],
                        ttl: 10000,
                        onShow: () => {
                            try { localStorage.setItem('heys_chronic_undereating_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üë§ Personalized tips (gender/age/cycle)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const isFemale = prof?.gender === '–ñ–µ–Ω—Å–∫–∏–π';
        if (isFemale && mealCount >= 2) {
            const ironRichKeywords = ['–º—è—Å–æ', '–ø–µ—á–µ–Ω—å', '–≥–æ–≤—è–¥–∏–Ω–∞', '–≥—Ä–µ—á–∫–∞', '—à–ø–∏–Ω–∞—Ç', '—á–µ—á–µ–≤–∏—Ü–∞'];
            const allItemsP = (day?.meals || []).flatMap(m => m.items || []);
            const hasIronRichFood = allItemsP.some(item => {
                const product = helpers.getProductForItem(item, pIndex);
                const name = (product?.name || item.name || '').toLowerCase();
                return ironRichKeywords.some(kw => name.includes(kw));
            });

            if (!hasIronRichFood && !sessionStorage.getItem('heys_iron_tip_today')) {
                advices.push({
                    id: 'iron_reminder',
                    icon: 'ü©∏',
                    text: '–ù–µ –∑–∞–±—ã–≤–∞–π –æ –∂–µ–ª–µ–∑–µ ‚Äî –º—è—Å–æ, –ø–µ—á–µ–Ω—å, –≥—Ä–µ—á–∫–∞',
                    details: 'ü¶∏‚Äç‚ôÄÔ∏è –ñ–µ–Ω—â–∏–Ω–∞–º –Ω—É–∂–Ω–æ 18–º–≥ –∂–µ–ª–µ–∑–∞/–¥–µ–Ω—å (–º—É–∂—á–∏–Ω–∞–º 8–º–≥). –õ–∏–¥–µ—Ä—ã: –ø–µ—á–µ–Ω—å, –∫—Ä–∞—Å–Ω–æ–µ –º—è—Å–æ, —á–µ—á–µ–≤–∏—Ü–∞, —à–ø–∏–Ω–∞—Ç.',
                    type: 'tip',
                    priority: 55,
                    category: 'personalized',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_iron_tip_today', '1'); } catch (e) { } }
                });
            }
        }

        const cycleDay = day?.cycleDay || null;
        const cyclePhase = window.HEYS?.Cycle?.getCyclePhase?.(cycleDay);
        const allItemsCycle = (day?.meals || []).flatMap(m => m.items || []);

        if (cyclePhase?.id === 'menstrual' && ctx.simplePct > 1.0) {
            advices.push({
                id: 'cycle_sweet_craving',
                icon: 'üå∏',
                text: '–¢—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É ‚Äî –Ω–æ—Ä–º–∞ –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥',
                details: 'üß¨ –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–∑—ã–≤–∞—é—Ç —Ç—è–≥—É –∫ —É–≥–ª–µ–≤–æ–¥–∞–º. –õ—É—á—à–µ –≤—ã–±–µ—Ä–∏ —Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥ –∏–ª–∏ —Ñ—Ä—É–∫—Ç—ã.',
                type: 'tip',
                priority: 58,
                category: 'personalized',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        if (cyclePhase?.id === 'menstrual') {
            const ironKeywords = ['–ø–µ—á–µ–Ω—å', '–≥–æ–≤—è–¥–∏–Ω', '–≥—Ä–∞–Ω–∞—Ç', '–≥—Ä–µ—á–∫', '—á–µ—á–µ–≤–∏—Ü', '—à–ø–∏–Ω–∞—Ç', '–∏–Ω–¥–µ–π–∫'];
            const hasIron = allItemsCycle.some(item => {
                const product = helpers.getProductForItem(item, pIndex);
                const name = (product?.name || item.name || '').toLowerCase();
                return ironKeywords.some(kw => name.includes(kw));
            });

            if (!hasIron && mealCount >= 2) {
                advices.push({
                    id: 'cycle_iron_important',
                    icon: 'ü©∏',
                    text: '–°–µ–π—á–∞—Å –∂–µ–ª–µ–∑–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ',
                    details: 'üí™ –í –ø–µ—Ä–∏–æ–¥ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏ –ø–æ—Ç–µ—Ä–∏ –∂–µ–ª–µ–∑–∞ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è. –î–æ–±–∞–≤—å –ø–µ—á–µ–Ω—å, –≥—Ä–µ—á–∫—É –∏–ª–∏ –≥—Ä–∞–Ω–∞—Ç.',
                    type: 'tip',
                    priority: 57,
                    category: 'personalized',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        if (cyclePhase?.id === 'menstrual' && cycleDay <= 2 && !day.trainings?.length) {
            advices.push({
                id: 'cycle_rest_ok',
                icon: 'üßò',
                text: '–û—Ç–¥—ã—Ö —Å–µ–≥–æ–¥–Ω—è ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä',
                details: '‚ú® –í –ø–µ—Ä–≤—ã–µ –¥–Ω–∏ —Ü–∏–∫–ª–∞ —ç–Ω–µ—Ä–≥–∏—è —Å–Ω–∏–∂–µ–Ω–∞. –õ—ë–≥–∫–∞—è –π–æ–≥–∞ –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞ –ª—É—á—à–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.',
                type: 'support',
                priority: 56,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (cyclePhase?.id === 'menstrual' && ctx.waterPct < 0.7) {
            advices.push({
                id: 'cycle_hydration',
                icon: 'üíß',
                text: '–°–µ–π—á–∞—Å –≤–æ–¥–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –Ω—É–∂–Ω–∞',
                details: 'üåä –û—Ä–≥–∞–Ω–∏–∑–º —Ç–µ—Ä—è–µ—Ç –∂–∏–¥–∫–æ—Å—Ç—å. –í–æ–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º –∏ —É–º–µ–Ω—å—à–∞–µ—Ç –æ—Ç—ë–∫–∏.',
                type: 'tip',
                priority: 56,
                category: 'hydration',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (cyclePhase?.id === 'follicular' && !sessionStorage.getItem('heys_cycle_energy_today')) {
            advices.push({
                id: 'cycle_energy_up',
                icon: 'üå±',
                text: '–≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è ‚Äî —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
                details: 'üéØ –§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∞–∑–∞ ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∏ –Ω–æ–≤—ã—Ö —Ü–µ–ª–µ–π.',
                type: 'motivation',
                priority: 55,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_cycle_energy_today', '1'); } catch (e) { } }
            });
        }

        if (cyclePhase?.id === 'ovulation' && !sessionStorage.getItem('heys_cycle_peak_today')) {
            advices.push({
                id: 'cycle_peak_performance',
                icon: '‚≠ê',
                text: '–ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏! –ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–µ–∫–æ—Ä–¥–æ–≤',
                details: 'üèÜ –î–Ω–∏ –æ–≤—É–ª—è—Ü–∏–∏ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∏–ª–∞ –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ!',
                type: 'motivation',
                priority: 58,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_cycle_peak_today', '1'); } catch (e) { } }
            });
        }

        if (cyclePhase && !sessionStorage.getItem('heys_cycle_thanks_shown')) {
            advices.push({
                id: 'cycle_tracking_thanks',
                icon: 'üå∏',
                text: '–£—á–∏—Ç—ã–≤–∞–µ–º –æ—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥ –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö',
                details: 'üíú –ù–æ—Ä–º—ã –≤–æ–¥—ã –∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ —Ç–≤–æ–π —Ü–∏–∫–ª.',
                type: 'info',
                priority: 50,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 4000,
                onShow: () => { try { sessionStorage.setItem('heys_cycle_thanks_shown', '1'); } catch (e) { } }
            });
        }

        const age = prof?.age || 30;
        const proteinPctAge = (dayTot?.prot || 0) / ((normAbs?.prot || 100) || 1);
        if (age >= 40 && proteinPctAge < 0.9) {
            advices.push({
                id: 'age_protein',
                icon: 'üí™',
                text: '–ü–æ—Å–ª–µ 40 –≤–∞–∂–Ω–æ –±–æ–ª—å—à–µ –±–µ–ª–∫–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º—ã—à—Ü—ã',
                details: 'üìä –ü–æ—Å–ª–µ 40 –º—ã—à–µ—á–Ω–∞—è –º–∞—Å—Å–∞ —Ç–µ—Ä—è–µ—Ç—Å—è –Ω–∞ 3-5% –∑–∞ –¥–µ—Å—è—Ç–∏–ª–µ—Ç–∏–µ. –ë–µ–ª–æ–∫ 1.5-2–≥/–∫–≥ + —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ = —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã.',
                type: 'tip',
                priority: 54,
                category: 'personalized',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üè† Activity tips
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const household = day?.householdMin || 0;
        if (household >= 60) {
            const extraKcal = Math.round(household * 3);
            advices.push({
                id: 'household_bonus',
                icon: 'üè†',
                text: `${household} –º–∏–Ω –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚âà +${extraKcal} –∫–∫–∞–ª —Å–æ–∂–∂–µ–Ω–æ`,
                details: 'üßπ –î–æ–º–∞—à–Ω–∏–µ –¥–µ–ª–∞ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å! –£–±–æ—Ä–∫–∞ 60 –º–∏–Ω = ~180 –∫–∫–∞–ª.',
                type: 'info',
                priority: 50,
                category: 'activity',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const stepsDay = day?.steps || 0;
        if (household === 0 && stepsDay < 3000 && !hasTraining && hour >= 18) {
            advices.push({
                id: 'sedentary_day',
                icon: 'üö∂',
                text: '–ú–∞–ª–æ–ø–æ–¥–≤–∏–∂–Ω—ã–π –¥–µ–Ω—å ‚Äî –ø—Ä–æ–≥—É–ª—è–π—Å—è 15 –º–∏–Ω—É—Ç',
                details: 'üéØ 15 –º–∏–Ω—É—Ç —Ö–æ–¥—å–±—ã = ~50-70 –∫–∫–∞–ª + —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–Ω–∞. –î–∞–∂–µ –∫–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ –ª—É—á—à–µ, —á–µ–º –Ω–∏—á–µ–≥–æ!',
                type: 'tip',
                priority: 48,
                category: 'activity',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üí§ Sleep quality
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const sleepQuality = day?.sleepQuality || 0;
        if (sleepQuality > 0 && sleepQuality <= 2 && hour < 12) {
            advices.push({
                id: 'bad_sleep_advice',
                icon: 'üò¥',
                text: '–ü–æ—Å–ª–µ –ø–ª–æ—Ö–æ–≥–æ —Å–Ω–∞ ‚Äî –º–µ–Ω—å—à–µ –∫–æ—Ñ–µ, –±–æ–ª—å—à–µ –±–µ–ª–∫–∞',
                details: 'üí° –ü–æ—Å–ª–µ –Ω–µ–¥–æ—Å—ã–ø–∞ –æ—Ä–≥–∞–Ω–∏–∑–º —Ö–æ—á–µ—Ç –±—ã—Å—Ç—Ä—É—é —ç–Ω–µ—Ä–≥–∏—é (—Å–∞—Ö–∞—Ä, –∫–æ—Ñ–µ). –õ—É—á—à–µ: –±–µ–ª–æ–∫ + —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏.',
                type: 'tip',
                priority: 26,
                category: 'sleep',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const sleepHoursQ = helpers.calculateSleepHours(day);
        if (sleepQuality >= 4 && sleepHoursQ >= 7) {
            advices.push({
                id: 'great_sleep',
                icon: 'üòä',
                text: '–•–æ—Ä–æ—à–æ –≤—ã—Å–ø–∞–ª—Å—è ‚Äî –¥–µ–Ω—å –±—É–¥–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º!',
                details: 'üåü –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω = –Ω–∏–∑–∫–∏–π –∫–æ—Ä—Ç–∏–∑–æ–ª –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–ø–ø–µ—Ç–∏—Ç. –°–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –ª–µ–≥—á–µ –¥–µ—Ä–∂–∞—Ç—å –ø–ª–∞–Ω!',
                type: 'achievement',
                priority: 46,
                category: 'sleep',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        const recentDaysForSleep = helpers.getRecentDays(3);
        const sleepHoursRecent = recentDaysForSleep.map(d => helpers.calculateSleepHours(d)).filter(h => h > 0);
        if (sleepHoursRecent.length >= 3) {
            const allUnder6 = sleepHoursRecent.every(h => h < 6);
            if (allUnder6 && !sessionStorage.getItem('heys_sleep_debt')) {
                advices.push({
                    id: 'sleep_debt_accumulating',
                    icon: 'üò¥',
                    text: '–ù–∞–∫–æ–ø–∏–ª—Å—è –Ω–µ–¥–æ—Å—ã–ø ‚Äî —Å–µ–≥–æ–¥–Ω—è –ª—è–≥ –ø–æ—Ä–∞–Ω—å—à–µ!',
                    details: '‚ö†Ô∏è 3+ –¥–Ω—è –Ω–µ–¥–æ—Å—ã–ø–∞ = –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–æ—Ä–º–æ–Ω–æ–≤. –ì—Ä–µ–ª–∏–Ω (–≥–æ–ª–æ–¥) —Ä–∞—Å—Ç—ë—Ç, –ª–µ–ø—Ç–∏–Ω (—Å—ã—Ç–æ—Å—Ç—å) –ø–∞–¥–∞–µ—Ç.',
                    type: 'warning',
                    priority: 95,
                    category: 'lifestyle',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_sleep_debt', '1'); } catch (e) { } }
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ü•á Milestones
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const totalDays = helpers.getTotalDaysTracked();
        if (totalDays === 7 && !helpers.isMilestoneShown('7_days')) {
            advices.push({
                id: 'milestone_7_days',
                icon: 'üìÖ',
                text: '–ù–µ–¥–µ–ª—è —Å HEYS! –ü—Ä–∏–≤—ã—á–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è',
                details: 'üí° 7 –¥–Ω–µ–π ‚Äî –ø–µ—Ä–≤—ã–π —Ä—É–±–µ–∂! –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: 21 –¥–µ–Ω—å ‚Äî –ø—Ä–∏–≤—ã—á–∫–∞, 66 –¥–Ω–µ–π ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–º.',
                type: 'achievement',
                priority: 2,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 8000,
                showConfetti: true,
                onShow: () => helpers.markMilestoneShown('7_days')
            });
        }

        if (totalDays === 30 && !helpers.isMilestoneShown('30_days')) {
            const firstName = prof?.firstName || '';
            advices.push({
                id: 'milestone_30_days',
                icon: 'üéâ',
                text: firstName ? `–ú–µ—Å—è—Ü —Å HEYS, ${firstName}! –¢—ã –º–æ–ª–æ–¥–µ—Ü` : '–ú–µ—Å—è—Ü —Å HEYS! –¢—ã –º–æ–ª–æ–¥–µ—Ü',
                details: 'üèÜ 30 –¥–Ω–µ–π = –ø—Ä–∏–≤—ã—á–∫–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞! –¢—Ä–µ–∫–∏–Ω–≥ –ø–∏—Ç–∞–Ω–∏—è —Å—Ç–∞–ª —á–∞—Å—Ç—å—é —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏.',
                type: 'achievement',
                priority: 1,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 10000,
                showConfetti: true,
                onShow: () => helpers.markMilestoneShown('30_days')
            });
        }

        if (totalDays === 100 && !helpers.isMilestoneShown('100_days')) {
            advices.push({
                id: 'milestone_100_days',
                icon: 'üèÜ',
                text: '100 –¥–Ω–µ–π! –¢—ã –ª–µ–≥–µ–Ω–¥–∞',
                details: 'üåü 100 –¥–Ω–µ–π —Ç—Ä–µ–∫–∏–Ω–≥–∞ ‚Äî —ç—Ç–æ —É—Ä–æ–≤–µ–Ω—å –º–∞—Å—Ç–µ—Ä–∞! –¢—ã –≤ —Ç–æ–ø-1% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.',
                type: 'achievement',
                priority: 1,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 12000,
                showConfetti: true,
                onShow: () => helpers.markMilestoneShown('100_days')
            });
        }

        if (currentStreak > 0) {
            const isNewRecord = helpers.updatePersonalBestStreak(currentStreak);
            if (isNewRecord && currentStreak >= 3 && !sessionStorage.getItem('heys_new_record')) {
                advices.push({
                    id: 'new_record_streak',
                    icon: 'üî•',
                    text: `–†–µ–∫–æ—Ä–¥–Ω—ã–π streak ‚Äî ${currentStreak} –¥–Ω–µ–π! üî•üî•üî•`,
                    details: 'üèÖ –ù–æ–≤—ã–π –ª–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥! –ö–∞–∂–¥—ã–π –¥–µ–Ω—å streak —É–∫—Ä–µ–ø–ª—è–µ—Ç –ø—Ä–∏–≤—ã—á–∫—É. –ù–µ —Å–ª–æ–º–∞–π —Å–µ—Ä–∏—é!',
                    type: 'achievement',
                    priority: 2,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    showConfetti: true,
                    onShow: () => { try { sessionStorage.setItem('heys_new_record', '1'); } catch (e) { } }
                });
            }
        }

        if (hasTraining && !helpers.isMilestoneShown('first_training')) {
            const historyDays = helpers.getRecentDays(30);
            const hasHistoryTraining = historyDays.some(d =>
                d.trainings?.some(t => t.z && t.z.some(m => m > 0))
            );

            if (!hasHistoryTraining) {
                advices.push({
                    id: 'first_training_ever',
                    icon: 'üèÉ',
                    text: '–ü–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ HEYS! –ù–∞—á–∞–ª–æ –ø–æ–ª–æ–∂–µ–Ω–æ',
                    details: 'üéØ –ü–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —Å–∞–º–∞—è —Ç—è–∂—ë–ª–∞—è! –¢–µ–ø–µ—Ä—å HEYS –±—É–¥–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å —Ç–≤–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö.',
                    type: 'achievement',
                    priority: 3,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    showConfetti: true,
                    onShow: () => helpers.markMilestoneShown('first_training')
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìÖ Weekly comparison / summary / streak hint / combo
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (!sessionStorage.getItem('heys_weekly_comparison')) {
            const weekComp = helpers.getWeeklyComparison();
            if (weekComp?.message) {
                advices.push({
                    id: 'weekly_comparison',
                    icon: 'üìä',
                    text: weekComp.message,
                    details: 'üìÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π –ø–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ç—Ä–µ–Ω–¥—ã.',
                    type: 'achievement',
                    priority: 15,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_weekly_comparison', '1'); } catch (e) { } }
                });
            }
        }

        if (hour >= 18 && !sessionStorage.getItem('heys_weekly_summary')) {
            const summary = helpers.getWeeklySummary();
            if (summary) {
                advices.push({
                    id: 'weekly_summary',
                    icon: 'üìã',
                    text: summary.message,
                    details: 'üìà –ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–µ–ª–∏ –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω.',
                    type: 'insight',
                    priority: 10,
                    category: 'lifestyle',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    onShow: () => { try { sessionStorage.setItem('heys_weekly_summary', '1'); } catch (e) { } }
                });
            }
        }

        if (currentStreak > 0 && currentStreak < 30 && !sessionStorage.getItem('heys_streak_hint')) {
            const milestone = helpers.getNextStreakMilestone(currentStreak);
            if (milestone && milestone.remain <= 3) {
                advices.push({
                    id: 'streak_hint',
                    icon: milestone.icon,
                    text: milestone.text,
                    details: 'üî• –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –Ω–æ—Ä–º–µ —É–∫—Ä–µ–ø–ª—è–µ—Ç –ø—Ä–∏–≤—ã—á–∫—É. –ù–µ —Å–¥–∞–≤–∞–π—Å—è!',
                    type: 'motivation',
                    priority: 20,
                    category: 'gamification',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_streak_hint', '1'); } catch (e) { } }
                });
            }
        }

        if (!sessionStorage.getItem('heys_combo_checked')) {
            const combo = helpers.checkComboAchievements(ctx);
            if (combo) {
                advices.push({
                    id: 'combo_' + combo.id,
                    icon: combo.icon,
                    text: combo.text,
                    type: 'achievement',
                    priority: 5,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    onShow: () => {
                        helpers.markComboShown(combo.id);
                        try { sessionStorage.setItem('heys_combo_checked', '1'); } catch (e) { }
                    }
                });
            }
            try { sessionStorage.setItem('heys_combo_checked', '1'); } catch (e) { }
        }

        if (!sessionStorage.getItem('heys_smart_rec_shown')) {
            const recommendation = helpers.getSmartRecommendation(hour);
            if (recommendation) {
                advices.push({
                    id: 'smart_recommendation',
                    icon: 'üí°',
                    text: recommendation.message,
                    details: 'üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.',
                    type: 'tip',
                    priority: 35,
                    category: 'personalized',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_smart_rec_shown', '1'); } catch (e) { } }
                });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üíä Supplements advices (catalog-based)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        if (window.HEYS?.Supplements) {
            const Supps = window.HEYS.Supplements;
            const dateKey = day?.date || new Date().toISOString().slice(0, 10);
            const planned = Supps.getPlanned?.() || [];
            const taken = Supps.getTaken?.(dateKey) || [];
            const notTaken = planned.filter(id => !taken.includes(id));

            if (hour >= 7 && hour <= 10 && !sessionStorage.getItem('heys_supp_morning')) {
                const morningSupps = notTaken.filter(id => {
                    const s = Supps.CATALOG?.[id];
                    return s && (s.timing === 'morning' || s.timing === 'empty');
                });

                if (morningSupps.length > 0) {
                    const names = morningSupps.slice(0, 3).map(id => Supps.CATALOG[id]?.name).join(', ');
                    advices.push({
                        id: 'supplements_morning_reminder',
                        icon: 'üíä',
                        text: `–£—Ç—Ä–µ–Ω–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω—ã: ${names}`,
                        details: 'üåÖ –ù–∞—Ç–æ—â–∞–∫ –ª—É—á—à–µ —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è: B12, –∂–µ–ª–µ–∑–æ. D3 –º–æ–∂–Ω–æ —Å –∑–∞–≤—Ç—Ä–∞–∫–æ–º.',
                        type: 'tip',
                        priority: 22,
                        category: 'supplements',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_morning', '1'); } catch (e) { } }
                    });
                }
            }

            if (hour >= 21 && hour <= 23 && !sessionStorage.getItem('heys_supp_evening')) {
                const eveningSupps = notTaken.filter(id => {
                    const s = Supps.CATALOG?.[id];
                    return s && (s.timing === 'evening' || s.timing === 'beforeBed');
                });

                if (eveningSupps.length > 0) {
                    const names = eveningSupps.slice(0, 3).map(id => Supps.CATALOG[id]?.name).join(', ');
                    advices.push({
                        id: 'supplements_evening_reminder',
                        icon: 'üåô',
                        text: `–í–µ—á–µ—Ä–Ω–∏–µ: ${names}`,
                        details: 'üò¥ –ú–∞–≥–Ω–∏–π –∏ –º–µ–ª–∞—Ç–æ–Ω–∏–Ω –ø–æ–º–æ–≥–∞—é—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.',
                        type: 'tip',
                        priority: 25,
                        category: 'supplements',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_evening', '1'); } catch (e) { } }
                    });
                }
            }

            const lastMeal = (day?.meals || []).slice(-1)[0];
            if (lastMeal && lastMeal.items?.length > 0 && !sessionStorage.getItem('heys_supp_fat_synergy')) {
                let mealFat = 0;
                for (const item of lastMeal.items) {
                    const p = helpers.getProductForItem(item, pIndex);
                    if (p) mealFat += (p.fat100 || 0) * (item.grams || 100) / 100;
                }

                if (mealFat >= 10) {
                    const fatSoluble = notTaken.filter(id =>
                        Supps.CATALOG?.[id]?.timing === 'withFat'
                    );

                    if (fatSoluble.length > 0) {
                        const names = fatSoluble.map(id => Supps.CATALOG[id]?.name).join(', ');
                        advices.push({
                            id: 'supplements_fat_meal_synergy',
                            icon: 'ü•ë',
                            text: `–ñ–∏—Ä–Ω—ã–π –ø—Ä–∏—ë–º! –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è: ${names}`,
                            details: 'üß¨ –ñ–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ –≤–∏—Ç–∞–º–∏–Ω—ã (D, E, K, A) —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è –≤ 3-4 —Ä–∞–∑–∞ –ª—É—á—à–µ —Å –∂–∏—Ä–∞–º–∏.',
                            type: 'tip',
                            priority: 18,
                            category: 'supplements',
                            triggers: ['product_added'],
                            ttl: 6000,
                            onShow: () => { try { sessionStorage.setItem('heys_supp_fat_synergy', '1'); } catch (e) { } }
                        });
                    }
                }
            }

            if (lastMeal && lastMeal.items?.length > 0 && !sessionStorage.getItem('heys_supp_dairy_iron')) {
                const dairyFoods = ['—Ç–≤–æ—Ä–æ–≥', '–º–æ–ª–æ–∫–æ', '—Å—ã—Ä', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '—Å–º–µ—Ç–∞–Ω–∞'];
                const hasDairy = lastMeal.items.some(item =>
                    dairyFoods.some(f => (item.name || '').toLowerCase().includes(f))
                );

                if (hasDairy && notTaken.includes('iron')) {
                    advices.push({
                        id: 'supplements_dairy_iron_conflict',
                        icon: '‚ö†Ô∏è',
                        text: '–ú–æ–ª–æ—á–∫–∞ + –∂–µ–ª–µ–∑–æ = –ø–ª–æ—Ö–æ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è',
                        details: 'üßÄ –ö–∞–ª—å—Ü–∏–π –∏–∑ –º–æ–ª–æ—á–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞. –†–∞–∑–¥–µ–ª–∏ –ø—Ä–∏—ë–º –Ω–∞ 2-3 —á–∞—Å–∞.',
                        type: 'warning',
                        priority: 20,
                        category: 'supplements',
                        triggers: ['product_added'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_dairy_iron', '1'); } catch (e) { } }
                    });
                }
            }

            if (lastMeal && !sessionStorage.getItem('heys_supp_coffee_minerals')) {
                const hasCoffee = (lastMeal.items || []).some(item =>
                    (item.name || '').toLowerCase().includes('–∫–æ—Ñ–µ')
                );
                const mineralSupps = notTaken.filter(id =>
                    ['iron', 'calcium', 'zinc', 'magnesium'].includes(id)
                );

                if (hasCoffee && mineralSupps.length > 0) {
                    const names = mineralSupps.map(id => Supps.CATALOG[id]?.name).join(', ');
                    advices.push({
                        id: 'supplements_coffee_minerals',
                        icon: '‚òï',
                        text: `–ö–æ—Ñ–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç: ${names}`,
                        details: '‚òï –¢–∞–Ω–∏–Ω—ã –∏ –∫–æ—Ñ–µ–∏–Ω —Å–Ω–∏–∂–∞—é—Ç —É—Å–≤–æ–µ–Ω–∏–µ –º–∏–Ω–µ—Ä–∞–ª–æ–≤ –Ω–∞ 40-60%. –ü–æ–¥–æ–∂–¥–∏ 1-2 —á–∞—Å–∞.',
                        type: 'warning',
                        priority: 23,
                        category: 'supplements',
                        triggers: ['product_added'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_coffee_minerals', '1'); } catch (e) { } }
                    });
                }
            }

            if (lastMeal && !sessionStorage.getItem('heys_supp_iron_vitc')) {
                const ironRichFoods = ['–ø–µ—á–µ–Ω—å', '–≥–æ–≤—è–¥–∏–Ω–∞', '–≥—Ä–µ—á–∫–∞', '—á–µ—á–µ–≤–∏—Ü–∞', '—à–ø–∏–Ω–∞—Ç', '—Ñ–∞—Å–æ–ª—å'];
                const hasIronFood = (lastMeal.items || []).some(item =>
                    ironRichFoods.some(f => (item.name || '').toLowerCase().includes(f))
                );

                if (hasIronFood && notTaken.includes('vitC')) {
                    advices.push({
                        id: 'supplements_iron_vitc_synergy',
                        icon: 'üçä',
                        text: '–ï–¥–∞ —Å –∂–µ–ª–µ–∑–æ–º! –í–∏—Ç–∞–º–∏–Ω C —É—Å–∏–ª–∏—Ç —É—Å–≤–æ–µ–Ω–∏–µ √ó3',
                        details: 'üß¨ –í–∏—Ç–∞–º–∏–Ω C –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–≥–µ–º–æ–≤–æ–µ –∂–µ–ª–µ–∑–æ –≤ –ª–µ–≥–∫–æ—É—Å–≤–∞–∏–≤–∞–µ–º—É—é —Ñ–æ—Ä–º—É.',
                        type: 'tip',
                        priority: 17,
                        category: 'supplements',
                        triggers: ['product_added'],
                        ttl: 6000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_iron_vitc', '1'); } catch (e) { } }
                    });
                }
            }

            const compliance = Supps.getComplianceStats?.();
            if (compliance?.currentStreak >= 5 && !sessionStorage.getItem('heys_supp_streak')) {
                advices.push({
                    id: 'supplements_streak',
                    icon: 'üî•',
                    text: `${compliance.currentStreak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤—Å–µ –≤–∏—Ç–∞–º–∏–Ω—ã!`,
                    details: 'üí™ –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –¥–æ–∑–∏—Ä–æ–≤–∫–∏. –ü—Ä–æ–¥–æ–ª–∂–∞–π!',
                    type: 'achievement',
                    priority: 45,
                    category: 'supplements',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_supp_streak', '1'); } catch (e) { } }
                });
            }

            if (planned.length > 0 && notTaken.length === 0 && !sessionStorage.getItem('heys_supp_all_done')) {
                advices.push({
                    id: 'supplements_all_taken',
                    icon: '‚úÖ',
                    text: '–í—Å–µ –≤–∏—Ç–∞–º–∏–Ω—ã –ø—Ä–∏–Ω—è—Ç—ã! –ú–æ–ª–æ–¥–µ—Ü!',
                    details: 'üíä –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –∫–ª—é—á –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.',
                    type: 'achievement',
                    priority: 55,
                    category: 'supplements',
                    triggers: ['tab_open'],
                    ttl: 4000,
                    onShow: () => { try { sessionStorage.setItem('heys_supp_all_done', '1'); } catch (e) { } }
                });
            }

            if (!sessionStorage.getItem('heys_supp_personal_rec')) {
                const recs = Supps.getSmartRecommendations?.(prof, day) || [];
                if (recs.length > 0) {
                    const rec = recs[0];
                    advices.push({
                        id: 'supplements_personal_rec',
                        icon: 'üí°',
                        text: rec.reason,
                        details: `–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å ${Supps.CATALOG?.[rec.id]?.name || rec.id} –≤ –ø–ª–∞–Ω.`,
                        type: 'tip',
                        priority: 50,
                        category: 'supplements',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_personal_rec', '1'); } catch (e) { } }
                    });
                }
            }
        }

        return advices;
    };

})();
// ===== End advice/_other.js =====


/* ===== heys_meal_optimizer_v1.js ===== */
// heys_meal_optimizer_v1.js ‚Äî –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
// v1.0.0 | 2025-12-10
// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å 50+ –Ω–∞—É—á–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏

(function (global) {
  'use strict';
  const HEYS = global.HEYS = global.HEYS || {};
  const U = HEYS.utils || {};

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // NUTRIENT_KEYWORDS ‚Äî –î–µ—Ç–µ–∫—Ü–∏—è –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const NUTRIENT_KEYWORDS = {
    iron: {
      keywords: ['–ø–µ—á–µ–Ω—å', '–ø–µ—á—ë–Ω–∫–∞', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Ç–µ–ª—è—Ç–∏–Ω–∞', '–≥—Ä–µ—á–∫–∞', '—á–µ—á–µ–≤–∏—Ü–∞', '—à–ø–∏–Ω–∞—Ç', '—Ñ–∞—Å–æ–ª—å', '–≥–æ—Ä–æ—Ö', '—Ç–æ—Ñ—É', '–∫—É–Ω–∂—É—Ç', '–∫–∞–∫–∞–æ', '–∫—Ä–æ–≤—è–Ω–∫–∞'],
      icon: 'ü©∏',
      name: '–ñ–µ–ª–µ–∑–æ'
    },
    vitaminC: {
      keywords: ['–ª–∏–º–æ–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç', '–∫–∏–≤–∏', '–ø–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π', '–ø–µ—Ä–µ—Ü —Å–ª–∞–¥–∫–∏–π', '—à–∏–ø–æ–≤–Ω–∏–∫', '—Å–º–æ—Ä–æ–¥–∏–Ω–∞', '–∫–ª—É–±–Ω–∏–∫–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '–∫–∞–ø—É—Å—Ç–∞', '–ø–µ—Ç—Ä—É—à–∫–∞', '—É–∫—Ä–æ–ø'],
      icon: 'üçã',
      name: '–í–∏—Ç–∞–º–∏–Ω C'
    },
    omega3: {
      keywords: ['–ª–æ—Å–æ—Å—å', '—Å—ë–º–≥–∞', '—Å–∫—É–º–±—Ä–∏—è', '—Å–µ–ª—å–¥—å', '—Ñ–æ—Ä–µ–ª—å', '—Å–∞—Ä–¥–∏–Ω–∞', '–∞–Ω—á–æ—É—Å', '—Ç—É–Ω–µ—Ü', '–ª—å–Ω—è–Ω–æ–µ', '—á–∏–∞', '–≥—Ä–µ—Ü–∫', '—Ä—ã–±–∏–π –∂–∏—Ä'],
      icon: 'üêü',
      name: '–û–º–µ–≥–∞-3'
    },
    calcium: {
      keywords: ['–º–æ–ª–æ–∫–æ', '—Ç–≤–æ—Ä–æ–≥', '—Å—ã—Ä', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '–±—Ä—ã–Ω–∑–∞', '–ø–∞—Ä–º–µ–∑–∞–Ω', '—Å–º–µ—Ç–∞–Ω–∞', '—Å–ª–∏–≤–∫–∏', '–∫—É–Ω–∂—É—Ç', '–º–∏–Ω–¥–∞–ª—å', '—Å–∞—Ä–¥–∏–Ω–∞'],
      icon: 'ü¶¥',
      name: '–ö–∞–ª—å—Ü–∏–π'
    },
    vitaminD: {
      keywords: ['–ª–æ—Å–æ—Å—å', '—Å—ë–º–≥–∞', '—Å–∫—É–º–±—Ä–∏—è', '—Å–µ–ª—å–¥—å', '—è–π—Ü–æ', '—è–∏—á–Ω—ã–π –∂–µ–ª—Ç–æ–∫', '–ø–µ—á–µ–Ω—å —Ç—Ä–µ—Å–∫–∏', '—Ä—ã–±–∏–π –∂–∏—Ä', '–≥—Ä–∏–±—ã'],
      icon: '‚òÄÔ∏è',
      name: '–í–∏—Ç–∞–º–∏–Ω D'
    },
    magnesium: {
      keywords: ['–º–∏–Ω–¥–∞–ª—å', '–∫–µ—à—å—é', '–∞—Ä–∞—Ö–∏—Å', '—à–ø–∏–Ω–∞—Ç', '–∞–≤–æ–∫–∞–¥–æ', '–±–∞–Ω–∞–Ω', '–≥—Ä–µ—á–∫–∞', '–æ–≤—Å—è–Ω–∫–∞', '—Ç—ë–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥', '–∫–∞–∫–∞–æ', '—Ç—ã–∫–≤–µ–Ω–Ω', '—Å–µ–º–µ—á–∫'],
      icon: 'üí™',
      name: '–ú–∞–≥–Ω–∏–π'
    },
    zinc: {
      keywords: ['–≥–æ–≤—è–¥–∏–Ω–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '—É—Å—Ç—Ä–∏—Ü', '–∫—Ä–∞–±', '–∫—É—Ä–∏—Ü–∞', '–∏–Ω–¥–µ–π–∫–∞', '—Ç—ã–∫–≤–µ–Ω–Ω', '–∫—É–Ω–∂—É—Ç', '—á–µ—á–µ–≤–∏—Ü–∞', '–Ω—É—Ç'],
      icon: 'üõ°Ô∏è',
      name: '–¶–∏–Ω–∫'
    },
    potassium: {
      keywords: ['–±–∞–Ω–∞–Ω', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–±–∞—Ç–∞—Ç', '–∞–≤–æ–∫–∞–¥–æ', '—à–ø–∏–Ω–∞—Ç', '—Ñ–∞—Å–æ–ª—å', '—á–µ—á–µ–≤–∏—Ü–∞', '–∫—É—Ä–∞–≥–∞', '–∏–∑—é–º', '–∞–ø–µ–ª—å—Å–∏–Ω'],
      icon: '‚ö°',
      name: '–ö–∞–ª–∏–π'
    },
    fiber: {
      keywords: ['–æ—Ç—Ä—É–±–∏', '—á–µ—á–µ–≤–∏—Ü–∞', '—Ñ–∞—Å–æ–ª—å', '–≥–æ—Ä–æ—Ö', '–Ω—É—Ç', '–æ–≤—Å—è–Ω–∫–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '–º–∞–ª–∏–Ω–∞', '–≥—Ä—É—à–∞', '—è–±–ª–æ–∫–æ', '–∞–≤–æ–∫–∞–¥–æ', '–∞—Ä—Ç–∏—à–æ–∫'],
      icon: 'üåæ',
      name: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞'
    },
    vitaminB12: {
      keywords: ['–ø–µ—á–µ–Ω—å', '–≥–æ–≤—è–¥–∏–Ω–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '–ª–æ—Å–æ—Å—å', '—Ñ–æ—Ä–µ–ª—å', '—Ç—É–Ω–µ—Ü', '—Å–∞—Ä–¥–∏–Ω–∞', '—è–π—Ü–æ', '–º–æ–ª–æ–∫–æ', '—Å—ã—Ä'],
      icon: 'üî¥',
      name: '–í–∏—Ç–∞–º–∏–Ω B12'
    },
    vitaminA: {
      keywords: ['–ø–µ—á–µ–Ω—å', '–º–æ—Ä–∫–æ–≤—å', '–±–∞—Ç–∞—Ç', '—Ç—ã–∫–≤–∞', '—à–ø–∏–Ω–∞—Ç', '–∫–∞–ø—É—Å—Ç–∞', '–º–∞–Ω–≥–æ', '–∞–±—Ä–∏–∫–æ—Å', '–¥—ã–Ω—è', '—è–π—Ü–æ'],
      icon: 'ü•ï',
      name: '–í–∏—Ç–∞–º–∏–Ω A'
    },
    folate: {
      keywords: ['—à–ø–∏–Ω–∞—Ç', '—Å–ø–∞—Ä–∂–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '–∞–≤–æ–∫–∞–¥–æ', '—á–µ—á–µ–≤–∏—Ü–∞', '—Ñ–∞—Å–æ–ª—å', '–Ω—É—Ç', '—Å–≤—ë–∫–ª–∞', '–∞–ø–µ–ª—å—Å–∏–Ω', '–ø–µ—á–µ–Ω—å'],
      icon: 'üåø',
      name: '–§–æ–ª–∞—Ç'
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RECOMMENDED_PORTIONS ‚Äî –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const RECOMMENDED_PORTIONS = {
    // –ë–µ–ª–∫–æ–≤—ã–µ ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø–æ—Ä—Ü–∏—è
    protein: { grams: 150, label: '150–≥ ‚Äî –ø–æ—Ä—Ü–∏—è' },
    // –ú–æ–ª–æ—á–Ω—ã–µ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ—Ä—Ü–∏—è
    dairy: { grams: 200, label: '200–≥ ‚Äî —Å—Ç–∞–∫–∞–Ω' },
    // –û–≤–æ—â–∏ ‚Äî —â–µ–¥—Ä–∞—è –ø–æ—Ä—Ü–∏—è
    vegetables: { grams: 150, label: '150–≥ ‚Äî –≥–∞—Ä–Ω–∏—Ä' },
    // –§—Ä—É–∫—Ç—ã ‚Äî 1 —Å—Ä–µ–¥–Ω–∏–π
    fruits: { grams: 150, label: '150–≥ ‚Äî 1 —à—Ç' },
    // –ó–µ—Ä–Ω–æ–≤—ã–µ ‚Äî –ø–æ—Ä—Ü–∏—è –≥–∞—Ä–Ω–∏—Ä–∞
    grains: { grams: 100, label: '100–≥ ‚Äî –ø–æ—Ä—Ü–∏—è' },
    // –û—Ä–µ—Ö–∏ ‚Äî –≥–æ—Ä—Å—Ç—å
    nuts: { grams: 30, label: '30–≥ ‚Äî –≥–æ—Ä—Å—Ç—å' },
    // –ú–∞—Å–ª–æ ‚Äî —Å—Ç–æ–ª–æ–≤–∞—è –ª–æ–∂–∫–∞
    oil: { grams: 15, label: '15–≥ ‚Äî 1 —Å—Ç.–ª.' },
    // –ó–µ–ª–µ–Ω—å ‚Äî –ø—É—á–æ–∫
    greens: { grams: 30, label: '30–≥ ‚Äî –ø—É—á–æ–∫' },
    // –Ø–π—Ü–∞ ‚Äî 2 —à—Ç—É–∫–∏
    eggs: { grams: 120, label: '2 —è–π—Ü–∞' },
    // –°—ã—Ä ‚Äî –ª–æ–º—Ç–∏–∫
    cheese: { grams: 30, label: '30–≥ ‚Äî –ª–æ–º—Ç–∏–∫' },
    // –°–æ—É—Å ‚Äî –ø–æ—Ä—Ü–∏—è
    sauce: { grams: 30, label: '30–≥ ‚Äî –ø–æ—Ä—Ü–∏—è' },
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    default: { grams: 100, label: '100–≥' }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SYNERGY_RULES ‚Äî 50+ –Ω–∞—É—á–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª —Å–∏–Ω–µ—Ä–≥–∏–π
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const SYNERGY_RULES = [
    // === IRON + VITAMIN C (—É—Å–≤–æ–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞) ===
    {
      id: 'iron_vitc',
      trigger: { has: 'iron', missing: 'vitaminC' },
      priority: 95,
      icon: 'üçã',
      title: '–î–æ–±–∞–≤—å –≤–∏—Ç–∞–º–∏–Ω C –∫ –∂–µ–ª–µ–∑—É',
      reason: '–£—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –≤ 6 —Ä–∞–∑ –ª—É—á—à–µ',
      science: '–ê—Å–∫–æ—Ä–±–∏–Ω–æ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Fe¬≥‚Å∫ ‚Üí Fe¬≤‚Å∫',
      recommend: { categories: ['vitaminC'], keywords: ['–ª–∏–º–æ–Ω', '–ø–µ—Ä–µ—Ü', '–∞–ø–µ–ª—å—Å–∏–Ω'] }
    },

    // === CALCIUM + VITAMIN D (—É—Å–≤–æ–µ–Ω–∏–µ –∫–∞–ª—å—Ü–∏—è) ===
    {
      id: 'calcium_vitd',
      trigger: { has: 'calcium', missing: 'vitaminD' },
      priority: 90,
      icon: '‚òÄÔ∏è',
      title: '–í–∏—Ç–∞–º–∏–Ω D –¥–ª—è –∫–∞–ª—å—Ü–∏—è',
      reason: '–ö–∞–ª—å—Ü–∏–π –ª—É—á—à–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º D',
      science: '–í–∏—Ç–∞–º–∏–Ω D —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç Ca¬≤‚Å∫ –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ',
      recommend: { categories: ['vitaminD'], keywords: ['—è–π—Ü–æ', '–ª–æ—Å–æ—Å—å', '–≥—Ä–∏–±—ã'] }
    },

    // === FAT + FAT-SOLUBLE VITAMINS (A, D, E, K) ===
    {
      id: 'fat_vitamins',
      trigger: { hasCategory: 'vegetables', missingMacro: 'fat', minGrams: 100 },
      priority: 85,
      icon: 'ü´í',
      title: '–î–æ–±–∞–≤—å –º–∞—Å–ª–æ –∫ –æ–≤–æ—â–∞–º',
      reason: '–ö–∞—Ä–æ—Ç–∏–Ω—ã —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –∂–∏—Ä–∞–º–∏',
      science: '–í–∏—Ç–∞–º–∏–Ω—ã A, D, E, K ‚Äî –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ',
      recommend: { keywords: ['–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ', '–º–∞—Å–ª–æ', '–∞–≤–æ–∫–∞–¥–æ', '–æ—Ä–µ—Ö'] }
    },

    // === PROTEIN COMPLETENESS (—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π –±–µ–ª–æ–∫) ===
    {
      id: 'plant_protein',
      trigger: { hasCategory: 'grains', missingCategory: 'legumes', mealProtLow: true },
      priority: 80,
      icon: 'ü´ò',
      title: '–î–æ–±–∞–≤—å –±–æ–±–æ–≤—ã–µ –∫ –∫—Ä—É–ø–µ',
      reason: '–ü–æ–ª–Ω—ã–π –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å',
      science: '–ó–ª–∞–∫–∏ + –±–æ–±–æ–≤—ã–µ = –≤—Å–µ –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–µ –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã',
      recommend: { keywords: ['—Ñ–∞—Å–æ–ª—å', '—á–µ—á–µ–≤–∏—Ü–∞', '–Ω—É—Ç', '–≥–æ—Ä–æ—Ö'] }
    },

    // === TURMERIC + BLACK PEPPER (–∫—É—Ä–∫—É–º–∏–Ω) ===
    {
      id: 'turmeric_pepper',
      trigger: { hasKeyword: ['–∫—É—Ä–∫—É–º'], missingKeyword: ['–ø–µ—Ä–µ—Ü —á—ë—Ä–Ω'] },
      priority: 75,
      icon: 'üå∂Ô∏è',
      title: '–ß—ë—Ä–Ω—ã–π –ø–µ—Ä–µ—Ü –∫ –∫—É—Ä–∫—É–º–µ',
      reason: '–£—Å–≤–æ–µ–Ω–∏–µ –∫—É—Ä–∫—É–º–∏–Ω–∞ +2000%',
      science: '–ü–∏–ø–µ—Ä–∏–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∫—É—Ä–∫—É–º–∏–Ω–∞ –≤ –ø–µ—á–µ–Ω–∏',
      recommend: { keywords: ['–ø–µ—Ä–µ—Ü —á—ë—Ä–Ω—ã–π'] }
    },

    // === TOMATO + FAT (–ª–∏–∫–æ–ø–∏–Ω) ===
    {
      id: 'tomato_fat',
      trigger: { hasKeyword: ['–ø–æ–º–∏–¥–æ—Ä', '—Ç–æ–º–∞—Ç'], missingMacro: 'fat' },
      priority: 70,
      icon: 'üçÖ',
      title: '–ú–∞—Å–ª–æ –∫ —Ç–æ–º–∞—Ç–∞–º',
      reason: '–õ–∏–∫–æ–ø–∏–Ω —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –≤ 4 —Ä–∞–∑–∞ –ª—É—á—à–µ',
      science: '–õ–∏–∫–æ–ø–∏–Ω ‚Äî –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π –∫–∞—Ä–æ—Ç–∏–Ω–æ–∏–¥',
      recommend: { keywords: ['–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ', '–º–∞—Å–ª–æ', '–∞–≤–æ–∫–∞–¥–æ'] }
    },

    // === TEA + MILK BLOCKS ANTIOXIDANTS ===
    {
      id: 'tea_no_milk',
      trigger: { hasKeyword: ['—á–∞–π –∑–µ–ª—ë–Ω—ã–π', '—á–∞–π —á—ë—Ä–Ω—ã–π'], hasKeyword2: ['–º–æ–ª–æ–∫–æ'] },
      priority: 65,
      icon: '‚ö†Ô∏è',
      title: '–ú–æ–ª–æ–∫–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã —á–∞—è',
      reason: '–ö–∞–∑–µ–∏–Ω —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–∞—Ç–µ—Ö–∏–Ω—ã',
      science: '–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ European Heart Journal 2007',
      isWarning: true
    },

    // === COFFEE BLOCKS IRON ===
    {
      id: 'coffee_iron',
      trigger: { hasKeyword: ['–∫–æ—Ñ–µ'], has: 'iron' },
      priority: 85,
      icon: '‚ö†Ô∏è',
      title: '–ö–æ—Ñ–µ —Å–Ω–∏–∂–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞ –Ω–∞ 80%',
      reason: '–ü–µ–π –∫–æ—Ñ–µ —á–µ—Ä–µ–∑ 1-2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã',
      science: '–¢–∞–Ω–∏–Ω—ã —Å–≤—è–∑—ã–≤–∞—é—Ç –∂–µ–ª–µ–∑–æ –≤ –Ω–µ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
      isWarning: true
    },

    // === FIBER + MINERALS ===
    {
      id: 'fiber_minerals',
      trigger: { highFiber: true, has: 'zinc' },
      priority: 60,
      icon: 'üí°',
      title: '–ú–Ω–æ–≥–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ —Å–Ω–∏–∂–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ —Ü–∏–Ω–∫–∞',
      reason: '–§–∏—Ç–∞—Ç—ã —Å–≤—è–∑—ã–≤–∞—é—Ç –º–∏–Ω–µ—Ä–∞–ª—ã',
      science: '–ê–∫—Ç—É–∞–ª—å–Ω–æ –ø—Ä–∏ >35–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏/–¥–µ–Ω—å',
      isWarning: true,
      mild: true
    },

    // === PROTEIN + LEUCINE TRIGGER ===
    {
      id: 'protein_leucine',
      trigger: { mealProtein: { min: 20, max: 25 } },
      priority: 70,
      icon: 'üí™',
      title: '–î–æ–±–∞–≤—å –µ—â—ë –±–µ–ª–∫–∞ –¥–æ 30–≥',
      reason: '–õ–µ–π—Ü–∏–Ω–æ–≤—ã–π –ø–æ—Ä–æ–≥ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –º—ã—à—Ü',
      science: '~3–≥ –ª–µ–π—Ü–∏–Ω–∞ = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç',
      recommend: { categories: ['protein'], keywords: ['—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥', '–∫—É—Ä–∏—Ü–∞'] }
    },

    // === LOW GI + HIGH GI BALANCING ===
    {
      id: 'gi_balance',
      trigger: { mealGI: { min: 70 } },
      priority: 75,
      icon: 'üìâ',
      title: '–î–æ–±–∞–≤—å –∫–ª–µ—Ç—á–∞—Ç–∫—É –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –ì–ò',
      reason: '–°–≥–ª–∞–¥–∏—Ç —Å–∫–∞—á–æ–∫ —Å–∞—Ö–∞—Ä–∞',
      science: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ –≥–ª—é–∫–æ–∑—ã',
      recommend: { categories: ['fiber'], keywords: ['–æ–≤–æ—â–∏', '—Å–∞–ª–∞—Ç', '–æ–≥—É—Ä–µ—Ü'] }
    },

    // === EVENING PROTEIN ===
    {
      id: 'evening_protein',
      trigger: { time: { after: '20:00' }, mealProtLow: true },
      priority: 80,
      icon: 'üåô',
      title: '–î–æ–±–∞–≤—å –∫–∞–∑–µ–∏–Ω –Ω–∞ –Ω–æ—á—å',
      reason: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫ = –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ —Å–Ω–µ',
      science: '–ö–∞–∑–µ–∏–Ω –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è 6-8 —á–∞—Å–æ–≤',
      recommend: { keywords: ['—Ç–≤–æ—Ä–æ–≥', '–∫–∞–∑–µ–∏–Ω', '—Å—ã—Ä'] }
    },

    // === PRE-WORKOUT CARBS ===
    {
      id: 'preworkout_carbs',
      trigger: { hasTrainingAfterMeal: true, mealCarbsLow: true },
      priority: 75,
      icon: '‚ö°',
      title: '–£–≥–ª–µ–≤–æ–¥—ã –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π',
      reason: '–≠–Ω–µ—Ä–≥–∏—è –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã',
      science: '–ì–ª–∏–∫–æ–≥–µ–Ω = —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è –º—ã—à—Ü',
      recommend: { categories: ['grains'], keywords: ['–±–∞–Ω–∞–Ω', '–æ–≤—Å—è–Ω–∫–∞', '—Ä–∏—Å'] }
    },

    // === POST-WORKOUT PROTEIN ===
    {
      id: 'postworkout_protein',
      trigger: { hadTrainingRecently: true, mealProtLow: true },
      priority: 90,
      icon: 'üèãÔ∏è',
      title: '–ë–µ–ª–æ–∫ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      reason: '–û–∫–Ω–æ –∞–Ω–∞–±–æ–ª–∏–∑–º–∞ ‚Äî 2 —á–∞—Å–∞',
      science: '–°–∏–Ω—Ç–µ–∑ –º—ã—à–µ—á–Ω–æ–≥–æ –±–µ–ª–∫–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–∫–∏',
      recommend: { categories: ['protein'], keywords: ['–∫—É—Ä–∏—Ü–∞', '—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥', '–ø—Ä–æ—Ç–µ–∏–Ω'] }
    },

    // === CARBS + PROTEIN COMBO ===
    {
      id: 'carbs_protein_combo',
      trigger: { hasOnlyCarbs: true, mealKcal: { min: 300 } },
      priority: 70,
      icon: 'ü•ó',
      title: '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫ –∫ —É–≥–ª–µ–≤–æ–¥–∞–º',
      reason: '–î–æ–ª—å—à–µ –Ω–∞—Å—ã—â–∞–µ—Ç + —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–∞—Ö–∞—Ä',
      science: '–ë–µ–ª–æ–∫ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞',
      recommend: { categories: ['protein'], keywords: ['—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥', '–∫—É—Ä–∏—Ü–∞', '—Ä—ã–±–∞'] }
    },

    // === SIMPLE CARBS WARNING ===
    {
      id: 'simple_carbs_high',
      trigger: { mealSimpleCarbs: { min: 30 } },
      priority: 65,
      icon: 'üç¨',
      title: '–ú–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤',
      reason: '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫ –∏–ª–∏ –∫–ª–µ—Ç—á–∞—Ç–∫—É',
      science: '–ó–∞–º–µ–¥–ª–∏—Ç —Å–∫–∞—á–æ–∫ –∏–Ω—Å—É–ª–∏–Ω–∞',
      recommend: { categories: ['protein', 'fiber'], keywords: ['–æ—Ä–µ—Ö', '—Ç–≤–æ—Ä–æ–≥', '–æ–≤–æ—â–∏'] }
    },

    // === BREAKFAST PROTEIN ===
    {
      id: 'breakfast_protein',
      trigger: { time: { before: '10:00' }, mealProtLow: true, mealKcal: { min: 200 } },
      priority: 80,
      icon: 'üç≥',
      title: '–ë–µ–ª–æ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫',
      reason: '–°—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –¥–æ –æ–±–µ–¥–∞',
      science: '–ë–µ–ª–æ–∫ –ø–æ–≤—ã—à–∞–µ—Ç PYY –∏ —Å–Ω–∏–∂–∞–µ—Ç –≥—Ä–µ–ª–∏–Ω',
      recommend: { keywords: ['—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥', '–π–æ–≥—É—Ä—Ç –≥—Ä–µ—á–µ—Å–∫–∏–π', '—Å—ã—Ä'] }
    },

    // === OMEGA-3 + WORKOUT ===
    {
      id: 'omega3_recovery',
      trigger: { hasTrainingToday: true, missing: 'omega3' },
      priority: 65,
      icon: 'üêü',
      title: '–û–º–µ–≥–∞-3 –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
      reason: '–°–Ω–∏–∂–∞–µ—Ç –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      science: 'EPA/DHA ‚Äî –ø—Ä–æ—Ç–∏–≤–æ–≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ–¥–∏–∞—Ç–æ—Ä—ã',
      recommend: { categories: ['omega3'], keywords: ['–ª–æ—Å–æ—Å—å', '—Å–∫—É–º–±—Ä–∏—è', '–ª—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ'] }
    },

    // === MAGNESIUM + STRESS ===
    {
      id: 'magnesium_stress',
      trigger: { dayStressHigh: true, missing: 'magnesium' },
      priority: 70,
      icon: 'üòå',
      title: '–ú–∞–≥–Ω–∏–π –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ',
      reason: '–°–Ω–∏–∂–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª, —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç',
      science: 'Mg¬≤‚Å∫ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç HPA –æ—Å—å',
      recommend: { categories: ['magnesium'], keywords: ['–º–∏–Ω–¥–∞–ª—å', '–∞–≤–æ–∫–∞–¥–æ', '—à–æ–∫–æ–ª–∞–¥ —Ç—ë–º–Ω—ã–π', '–±–∞–Ω–∞–Ω'] }
    },

    // === VITAMIN K + FAT ===
    {
      id: 'leafy_greens_fat',
      trigger: { hasKeyword: ['—à–ø–∏–Ω–∞—Ç', '–∫–∞–ø—É—Å—Ç–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '—Å–∞–ª–∞—Ç'], missingMacro: 'fat' },
      priority: 70,
      icon: 'ü•¨',
      title: '–î–æ–±–∞–≤—å –∂–∏—Ä—ã –∫ –∑–µ–ª–µ–Ω–∏',
      reason: '–í–∏—Ç–∞–º–∏–Ω K ‚Äî –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π',
      science: '–î–ª—è —Å–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∫—Ä–æ–≤–∏ –∏ –∫–æ—Å—Ç–µ–π',
      recommend: { keywords: ['–º–∞—Å–ª–æ', '–æ—Ä–µ—Ö', '–∞–≤–æ–∫–∞–¥–æ', '—Å—ã—Ä'] }
    },

    // === ALCOHOL WARNING ===
    {
      id: 'alcohol_nutrients',
      trigger: { hasKeyword: ['–≤–∏–Ω–æ', '–ø–∏–≤–æ', '–≤–æ–¥–∫–∞', '–≤–∏—Å–∫–∏', '–∫–æ–Ω—å—è–∫', '–∞–ª–∫–æ–≥–æ–ª—å'] },
      priority: 90,
      icon: '‚ö†Ô∏è',
      title: '–ê–ª–∫–æ–≥–æ–ª—å —Å–Ω–∏–∂–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ B-–≤–∏—Ç–∞–º–∏–Ω–æ–≤',
      reason: 'B1, B6, B12, —Ñ–æ–ª–∞—Ç ‚Äî –ø–æ–¥ —É–¥–∞—Ä–æ–º',
      science: '–≠—Ç–∞–Ω–æ–ª –Ω–∞—Ä—É—à–∞–µ—Ç –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
      isWarning: true
    },

    // === CITRUS + MEDICATION (general awareness) ===
    {
      id: 'grapefruit_caution',
      trigger: { hasKeyword: ['–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç', '–ø–æ–º–µ–ª–æ'] },
      priority: 50,
      icon: 'üíä',
      title: '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞–º–∏',
      reason: '–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤',
      science: '–ò–Ω–≥–∏–±–∏—Ä—É–µ—Ç CYP3A4 –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ',
      isWarning: true,
      mild: true
    },

    // === PROTEIN VARIETY ===
    {
      id: 'protein_variety',
      trigger: { sameProteinSource3Days: true },
      priority: 60,
      icon: 'üîÑ',
      title: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–ª–∫–∞',
      reason: '–†–∞–∑–Ω—ã–µ –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏',
      science: '–ö—É—Ä–∏—Ü–∞, —Ä—ã–±–∞, —è–π—Ü–∞, –º–æ–ª–æ—á–∫–∞ ‚Äî —á–µ—Ä–µ–¥—É–π',
      recommend: { categories: ['protein'] }
    },

    // === HYDRATION WITH FIBER ===
    {
      id: 'fiber_water',
      trigger: { highFiber: true, dayWaterLow: true },
      priority: 75,
      icon: 'üíß',
      title: '–ü–µ–π –≤–æ–¥—É —Å –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π!',
      reason: '–ë–µ–∑ –≤–æ–¥—ã –∫–ª–µ—Ç—á–∞—Ç–∫–∞ = –∑–∞–ø–æ—Ä—ã',
      science: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –≤–ø–∏—Ç—ã–≤–∞–µ—Ç –≤–æ–¥—É –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è',
      isWarning: true
    },

    // === RESISTANT STARCH ===
    {
      id: 'resistant_starch',
      trigger: { hasKeyword: ['–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å', '—Ä–∏—Å', '–º–∞–∫–∞—Ä–æ–Ω'], isCookedCold: true },
      priority: 60,
      icon: '‚ùÑÔ∏è',
      title: '–û—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª ‚Äî —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π',
      reason: '–ì–ò –Ω–∏–∂–µ, –ø–∏—Ç–∞–µ—Ç –º–∏–∫—Ä–æ–±–∏–æ—Ç—É',
      science: '–†–µ—Ç—Ä–æ–≥—Ä–∞–¥–∞—Ü–∏—è –∫—Ä–∞—Ö–º–∞–ª–∞ –ø—Ä–∏ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–∏',
      isInfo: true
    },

    // === PROBIOTICS + PREBIOTICS ===
    {
      id: 'probiotics_prebiotics',
      trigger: { hasKeyword: ['–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '–∫–≤–∞—à–µ–Ω', '–∫–∏–º—á–∏'], missingKeyword: ['–ª—É–∫', '—á–µ—Å–Ω–æ–∫', '–±–∞–Ω–∞–Ω', '–æ–≤—ë—Å'] },
      priority: 65,
      icon: 'ü¶†',
      title: '–î–æ–±–∞–≤—å –ø—Ä–µ–±–∏–æ—Ç–∏–∫–∏ –∫ –ø—Ä–æ–±–∏–æ—Ç–∏–∫–∞–º',
      reason: '–ü–∏—Ç–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–∑–Ω—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π',
      science: '–ò–Ω—É–ª–∏–Ω, FOS ‚Äî —Å—É–±—Å—Ç—Ä–∞—Ç –¥–ª—è –º–∏–∫—Ä–æ–±–∏–æ—Ç—ã',
      recommend: { keywords: ['–ª—É–∫', '—á–µ—Å–Ω–æ–∫', '–±–∞–Ω–∞–Ω', '–æ–≤—Å—è–Ω–∫–∞'] }
    },

    // === COLLAGEN + VITAMIN C ===
    {
      id: 'collagen_vitc',
      trigger: { hasKeyword: ['–∫–æ–ª–ª–∞–≥–µ–Ω', '–∂–µ–ª–∞—Ç–∏–Ω', '—Ö–æ–ª–æ–¥–µ—Ü', '–∑–∞–ª–∏–≤–Ω–æ–µ'], missing: 'vitaminC' },
      priority: 80,
      icon: '‚ú®',
      title: '–í–∏—Ç–∞–º–∏–Ω C –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –∫–æ–ª–ª–∞–≥–µ–Ω–∞',
      reason: '–ë–µ–∑ –Ω–µ–≥–æ –∫–æ–ª–ª–∞–≥–µ–Ω –Ω–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è',
      science: '–ê—Å–∫–æ—Ä–±–∞—Ç ‚Äî –∫–æ—Ñ–∞–∫—Ç–æ—Ä –ø—Ä–æ–ª–∏–ª-–≥–∏–¥—Ä–æ–∫—Å–∏–ª–∞–∑—ã',
      recommend: { categories: ['vitaminC'], keywords: ['–ª–∏–º–æ–Ω', '–∫–∏–≤–∏', '–ø–µ—Ä–µ—Ü'] }
    },

    // === BETA-CAROTENE + FAT ===
    {
      id: 'beta_carotene',
      trigger: { hasKeyword: ['–º–æ—Ä–∫–æ–≤—å', '—Ç—ã–∫–≤–∞', '–±–∞—Ç–∞—Ç', '–º–∞–Ω–≥–æ', '–∞–±—Ä–∏–∫–æ—Å'], missingMacro: 'fat' },
      priority: 70,
      icon: 'ü•ï',
      title: '–î–æ–±–∞–≤—å –∂–∏—Ä—ã –∫ –º–æ—Ä–∫–æ–≤–∏/—Ç—ã–∫–≤–µ',
      reason: '–ë–µ—Ç–∞-–∫–∞—Ä–æ—Ç–∏–Ω ‚Äî –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π',
      science: '–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –≤–∏—Ç–∞–º–∏–Ω A',
      recommend: { keywords: ['–º–∞—Å–ª–æ', '—Å–º–µ—Ç–∞–Ω–∞', '–æ—Ä–µ—Ö'] }
    },

    // === QUERCETIN + FAT ===
    {
      id: 'quercetin_fat',
      trigger: { hasKeyword: ['–ª—É–∫', '—è–±–ª–æ–∫–æ', '–±—Ä–æ–∫–∫–æ–ª–∏', '—á–∞–π'], missingMacro: 'fat' },
      priority: 55,
      icon: 'üßÖ',
      title: '–ö–≤–µ—Ä—Ü–µ—Ç–∏–Ω –ª—É—á—à–µ —Å –∂–∏—Ä–∞–º–∏',
      reason: '–ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç –¥–ª—è —Å–æ—Å—É–¥–æ–≤',
      science: '–ë–∏–æ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å √ó5 —Å –ª–∏–ø–∏–¥–∞–º–∏',
      recommend: { keywords: ['–º–∞—Å–ª–æ', '–æ—Ä–µ—Ö'] }
    },

    // === CRUCIFEROUS + IODINE ===
    {
      id: 'cruciferous_iodine',
      trigger: { hasKeyword: ['–∫–∞–ø—É—Å—Ç–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '—Ü–≤–µ—Ç–Ω–∞—è', '–±—Ä—é—Å—Å–µ–ª—å—Å–∫–∞—è', '—Ä–µ–¥–∏—Å', '—Ä–µ–¥—å–∫–∞'] },
      priority: 45,
      icon: 'üßÇ',
      title: '–ö—Ä–µ—Å—Ç–æ—Ü–≤–µ—Ç–Ω—ã–µ + –π–æ–¥',
      reason: '–ì–æ–π—Ç—Ä–æ–≥–µ–Ω—ã –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ —â–∏—Ç–æ–≤–∏–¥–∫—É',
      science: '–ü—Ä–∏ –≥–æ—Ç–æ–≤–∫–µ –≥–æ–π—Ç—Ä–æ–≥–µ–Ω—ã —Ä–∞–∑—Ä—É—à–∞—é—Ç—Å—è',
      isInfo: true,
      mild: true
    },

    // === PHYTATES IN LEGUMES ===
    {
      id: 'legumes_soaking',
      trigger: { hasKeyword: ['—Ñ–∞—Å–æ–ª—å', '—á–µ—á–µ–≤–∏—Ü–∞', '–Ω—É—Ç', '–≥–æ—Ä–æ—Ö'] },
      priority: 40,
      icon: 'üí°',
      title: '–ó–∞–º–∞—á–∏–≤–∞–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç —Ñ–∏—Ç–∞—Ç—ã',
      reason: '–õ—É—á—à–µ —É—Å–≤–æ—è—Ç—Å—è –º–∏–Ω–µ—Ä–∞–ª—ã',
      science: '8-12—á –∑–∞–º–∞—á–∏–≤–∞–Ω–∏—è ‚Äî –æ–ø—Ç–∏–º—É–º',
      isInfo: true,
      mild: true
    },

    // === SULFORAPHANE ACTIVATION ===
    {
      id: 'sulforaphane',
      trigger: { hasKeyword: ['–±—Ä–æ–∫–∫–æ–ª–∏'] },
      priority: 50,
      icon: 'ü•¶',
      title: '–ù–∞—Ä–µ–∂—å –±—Ä–æ–∫–∫–æ–ª–∏ –∏ –ø–æ–¥–æ–∂–¥–∏ 40–º–∏–Ω',
      reason: '–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Å—É–ª—å—Ñ–æ—Ä–∞—Ñ–∞–Ω',
      science: '–ú–∏—Ä–æ–∑–∏–Ω–∞–∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≥–ª—é–∫–æ—Ä–∞—Ñ–∞–Ω–∏–Ω',
      isInfo: true
    },

    // === LYCOPENE COOKING ===
    {
      id: 'lycopene_cooking',
      trigger: { hasKeyword: ['–ø–æ–º–∏–¥–æ—Ä', '—Ç–æ–º–∞—Ç'], isCookedOrProcessed: false },
      priority: 45,
      icon: 'üçÖ',
      title: '–ì–æ—Ç–æ–≤—å —Ç–æ–º–∞—Ç—ã ‚Äî –±–æ–ª—å—à–µ –ª–∏–∫–æ–ø–∏–Ω–∞',
      reason: '–¢–µ—Ä–º–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—ã—à–∞–µ—Ç –±–∏–æ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å',
      science: '+2.5x –ø–æ—Å–ª–µ 30–º–∏–Ω –ø—Ä–∏ 100¬∞C',
      isInfo: true
    },

    // === PROTEIN TIMING (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ) ===
    {
      id: 'protein_distribution',
      trigger: { dayProteinUneven: true },
      priority: 65,
      icon: '‚è∞',
      title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –±–µ–ª–æ–∫ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ',
      reason: '20-40–≥ –∑–∞ –ø—Ä–∏—ë–º ‚Äî –æ–ø—Ç–∏–º—É–º',
      science: 'Muscle full effect –ø—Ä–∏ –∏–∑–±—ã—Ç–∫–µ –∑–∞ —Ä–∞–∑',
      isInfo: true
    },

    // === ANTI-NUTRIENTS GENERAL ===
    {
      id: 'antinutrients_cooking',
      trigger: { hasCategory: 'legumes' },
      priority: 35,
      icon: 'üî•',
      title: '–ì–æ—Ç–æ–≤–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç –∞–Ω—Ç–∏–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã',
      reason: '–õ–µ–∫—Ç–∏–Ω—ã, –æ–∫—Å–∞–ª–∞—Ç—ã —Ä–∞–∑—Ä—É—à–∞—é—Ç—Å—è',
      science: '–í–∞—Ä–∫–∞ 15+ –º–∏–Ω –Ω–µ–π—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–µ–∫—Ç–∏–Ω—ã',
      isInfo: true,
      mild: true
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ù–û–í–´–ï –ù–ê–£–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê (2025-12-10)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // === VITAMIN D + FAT (–∂–∏—Ä–Ω–∞—è –µ–¥–∞ = –≤—Ä–µ–º—è D3) ===
    {
      id: 'fat_meal_vitd',
      trigger: { mealFat: { min: 15 } },
      priority: 78,
      icon: '‚òÄÔ∏è',
      title: '–í—ã–ø–µ–π –≤–∏—Ç–∞–º–∏–Ω D —Å —ç—Ç–∏–º –ø—Ä–∏—ë–º–æ–º',
      reason: '–ñ–∏—Ä—ã –ø–æ–≤—ã—à–∞—é—Ç —É—Å–≤–æ–µ–Ω–∏–µ D3 –Ω–∞ 32%',
      science: 'Dawson-Hughes 2015: D3 —Å –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 32% –ª—É—á—à–µ',
      isSupplement: true,
      supplementType: 'vitaminD'
    },

    // === EVENING MAGNESIUM ===
    {
      id: 'evening_magnesium',
      trigger: { time: { after: '19:00' } },
      priority: 75,
      icon: 'üíä',
      title: '–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –º–∞–≥–Ω–∏—è',
      reason: '–†–∞—Å—Å–ª–∞–±–ª—è–µ—Ç –º—ã—à—Ü—ã, —É–ª—É—á—à–∞–µ—Ç —Å–æ–Ω',
      science: 'Mg¬≤‚Å∫ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ì–ê–ú–ö-—Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã, —Å–Ω–∏–∂–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª',
      isSupplement: true,
      supplementType: 'magnesium'
    },

    // === CALCIUM vs IRON CONFLICT ===
    {
      id: 'calcium_iron_conflict',
      trigger: { has: 'calcium', has2: 'iron' },
      priority: 88,
      icon: '‚ö†Ô∏è',
      title: '–ö–∞–ª—å—Ü–∏–π –∏ –∂–µ–ª–µ–∑–æ ‚Äî –Ω–µ –≤–º–µ—Å—Ç–µ!',
      reason: '–ö–∞–ª—å—Ü–∏–π —Å–Ω–∏–∂–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞ –Ω–∞ 50%',
      science: 'Hallberg 1991: Ca¬≤‚Å∫ –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç —Å Fe¬≤‚Å∫ –∑–∞ DMT1 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ë—Ä',
      isWarning: true
    },

    // === COFFEE vs CALCIUM ===
    {
      id: 'coffee_calcium_timing',
      trigger: { hasKeyword: ['–∫–æ—Ñ–µ', '—ç—Å–ø—Ä–µ—Å—Å–æ'], has: 'calcium' },
      priority: 82,
      icon: '‚òï',
      title: '–ö–æ—Ñ–µ + –º–æ–ª–æ—á–∫–∞ ‚Äî –ø–æ–¥–æ–∂–¥–∏ 2 —á–∞—Å–∞',
      reason: '–ö–æ—Ñ–µ–∏–Ω –≤—ã–º—ã–≤–∞–µ—Ç –∫–∞–ª—å—Ü–∏–π',
      science: 'Massey 1993: 6–º–≥ Ca —Ç–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–µ 100–º–≥ –∫–æ—Ñ–µ–∏–Ω–∞',
      isWarning: true
    },

    // === MAGNESIUM + B6 SYNERGY ===
    {
      id: 'magnesium_b6',
      trigger: { has: 'magnesium' },
      priority: 65,
      icon: 'üîó',
      title: '–ú–∞–≥–Ω–∏–π –ª—É—á—à–µ —Å B6',
      reason: 'B6 –ø–æ–≤—ã—à–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ Mg –Ω–∞ 20%',
      science: 'Pouteau 2018: –ø–∏—Ä–∏–¥–æ–∫—Å–∏–Ω —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–ª–µ—Ç–æ—á–Ω—ã–π –∑–∞—Ö–≤–∞—Ç Mg¬≤‚Å∫',
      recommend: { keywords: ['–∫—É—Ä–∏—Ü–∞', '—Ä—ã–±–∞', '–±–∞–Ω–∞–Ω', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å'] }
    },

    // === ZINC + EMPTY STOMACH ===
    {
      id: 'zinc_empty_stomach',
      trigger: { has: 'zinc', mealKcal: { max: 150 } },
      priority: 70,
      icon: 'üí°',
      title: '–¶–∏–Ω–∫ –Ω–∞—Ç–æ—â–∞–∫ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ç–æ—à–Ω–æ—Ç—É',
      reason: '–õ—É—á—à–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –ø–æ—Ä—Ü–∏–µ–π –µ–¥—ã',
      science: 'Zn¬≤‚Å∫ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç —Å–ª–∏–∑–∏—Å—Ç—É—é –∂–µ–ª—É–¥–∫–∞',
      isWarning: true,
      mild: true
    },

    // === FISH OIL + FATTY MEAL ===
    {
      id: 'omega3_with_fat',
      trigger: { mealFat: { min: 10 }, missing: 'omega3' },
      priority: 72,
      icon: 'üêü',
      title: '–û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –û–º–µ–≥–∞-3',
      reason: '–° –∂–∏—Ä–Ω–æ–π –µ–¥–æ–π —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –≤ 3 —Ä–∞–∑–∞ –ª—É—á—à–µ',
      science: 'Lawson 1988: EPA/DHA –∞–±—Å–æ—Ä–±—Ü–∏—è √ó3 —Å –∂–∏—Ä–∞–º–∏',
      isSupplement: true,
      supplementType: 'omega3'
    },

    // === IRON + MORNING ===
    {
      id: 'iron_morning_best',
      trigger: { has: 'iron', time: { before: '11:00' } },
      priority: 60,
      icon: 'üåÖ',
      title: '–£—Ç—Ä–æ ‚Äî –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∂–µ–ª–µ–∑–∞',
      reason: '–£—Å–≤–æ–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞—Ç–æ—â–∞–∫/—Å –ª—ë–≥–∫–æ–π –µ–¥–æ–π',
      science: '–ì–µ–ø—Å–∏–¥–∏–Ω (–±–ª–æ–∫–∞—Ç–æ—Ä Fe) –º–∏–Ω–∏–º–∞–ª–µ–Ω —É—Ç—Ä–æ–º',
      isInfo: true
    },

    // === LATE NIGHT PROTEIN vs FAT ===
    {
      id: 'late_night_fat',
      trigger: { time: { after: '22:00' }, mealFat: { min: 20 } },
      priority: 68,
      icon: 'üåô',
      title: '–ú–Ω–æ–≥–æ –∂–∏—Ä–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º',
      reason: '–ó–∞–º–µ–¥–ª–∏—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ, —É—Ö—É–¥—à–∏—Ç —Å–æ–Ω',
      science: '–ñ–∏—Ä—ã –∑–∞–º–µ–¥–ª—è—é—Ç –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞ –Ω–∞ 2-4—á',
      isWarning: true
    },

    // === VITAMIN C + TIMING ===
    {
      id: 'vitc_with_meal',
      trigger: { has: 'vitaminC', mealKcal: { max: 100 } },
      priority: 55,
      icon: 'üçã',
      title: '–í–∏—Ç–∞–º–∏–Ω C –ª—É—á—à–µ —Å –µ–¥–æ–π',
      reason: '–°–Ω–∏–∂–∞–µ—Ç —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞',
      science: '–ê—Å–∫–æ—Ä–±–∏–Ω–æ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞ = –∫–∏—Å–ª–æ—Ç–∞ ‚Üí –ª—É—á—à–µ —Å –±—É—Ñ–µ—Ä–æ–º',
      isInfo: true,
      mild: true
    },

    // === PROTEIN + CREATINE ===
    {
      id: 'protein_creatine_timing',
      trigger: { mealProtein: { min: 25 }, hasTrainingToday: true },
      priority: 65,
      icon: 'üí™',
      title: '–ë–µ–ª–æ–∫ + –∏–Ω—Å—É–ª–∏–Ω = –ª—É—á—à–µ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–Ω–∞',
      reason: '–ï—Å–ª–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—à—å –∫—Ä–µ–∞—Ç–∏–Ω ‚Äî —Å–µ–π—á–∞—Å!',
      science: 'Green 1996: –∏–Ω—Å—É–ª–∏–Ω —É—Å–∏–ª–∏–≤–∞–µ—Ç –∑–∞—Ö–≤–∞—Ç –∫—Ä–µ–∞—Ç–∏–Ω–∞ –º—ã—à—Ü–∞–º–∏ –Ω–∞ 60%',
      isSupplement: true,
      supplementType: 'creatine'
    },

    // === TRYPTOPHAN + CARBS (–¥–ª—è —Å–Ω–∞) ===
    {
      id: 'tryptophan_carbs',
      trigger: { hasKeyword: ['–∏–Ω–¥–µ–π–∫–∞', '–∫—É—Ä–∏—Ü–∞', '–º–æ–ª–æ–∫–æ', '—Ç–≤–æ—Ä–æ–≥', '—Å—ã—Ä'], time: { after: '19:00' }, mealCarbs: { min: 30 } },
      priority: 62,
      icon: 'üò¥',
      title: '–¢—Ä–∏–ø—Ç–æ—Ñ–∞–Ω + —É–≥–ª–µ–≤–æ–¥—ã = –º–µ–ª–∞—Ç–æ–Ω–∏–Ω',
      reason: '–•–æ—Ä–æ—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å–Ω–∞',
      science: '–£–≥–ª–µ–≤–æ–¥—ã ‚Üí –∏–Ω—Å—É–ª–∏–Ω ‚Üí LNAA –∏–∑ –∫—Ä–æ–≤–∏ ‚Üí —Ç—Ä–∏–ø—Ç–æ—Ñ–∞–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç –ì–≠–ë',
      isInfo: true
    },

    // === COLLAGEN + GLYCINE TIMING ===
    {
      id: 'collagen_sleep',
      trigger: { hasKeyword: ['–∫–æ–ª–ª–∞–≥–µ–Ω', '–∂–µ–ª–∞—Ç–∏–Ω'], time: { after: '20:00' } },
      priority: 58,
      icon: '‚ú®',
      title: '–ö–æ–ª–ª–∞–≥–µ–Ω –≤–µ—á–µ—Ä–æ–º ‚Äî –æ—Ç–ª–∏—á–Ω–æ!',
      reason: '–ì–ª–∏—Ü–∏–Ω —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞',
      science: 'Bannai 2012: 3–≥ –≥–ª–∏—Ü–∏–Ω–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º —É–ª—É—á—à–∞–µ—Ç —Å–æ–Ω',
      isInfo: true
    },

    // === PROBIOTICS + PREBIOTICS ===
    {
      id: 'probiotic_empty',
      trigger: { hasKeyword: ['–ø—Ä–æ–±–∏–æ—Ç–∏–∫', '–±–∏—Ñ–∏–¥–æ', '–ª–∞–∫—Ç–æ'], mealKcal: { min: 200 } },
      priority: 60,
      icon: 'ü¶†',
      title: '–ü—Ä–æ–±–∏–æ—Ç–∏–∫–∏ –ª—É—á—à–µ –Ω–∞—Ç–æ—â–∞–∫',
      reason: '–ò–ª–∏ —á–µ—Ä–µ–∑ 2—á –ø–æ—Å–ª–µ –µ–¥—ã',
      science: '–ñ–µ–ª—É–¥–æ—á–Ω—ã–π —Å–æ–∫ —É–±–∏–≤–∞–µ—Ç –±–∞–∫—Ç–µ—Ä–∏–∏, –Ω–∞—Ç–æ—â–∞–∫ pH –≤—ã—à–µ',
      isInfo: true,
      mild: true
    },

    // === GREEN TEA + IRON BLOCK ===
    {
      id: 'green_tea_iron',
      trigger: { hasKeyword: ['—á–∞–π –∑–µ–ª—ë–Ω—ã–π', '–∑–µ–ª—ë–Ω—ã–π —á–∞–π', '–º–∞—Ç—á–∞'], has: 'iron' },
      priority: 80,
      icon: 'üçµ',
      title: '–ó–µ–ª—ë–Ω—ã–π —á–∞–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–µ–ª–µ–∑–æ',
      reason: '–¢–∞–Ω–∏–Ω—ã —Å–≤—è–∑—ã–≤–∞—é—Ç Fe ‚Äî –ø–µ–π —á–µ—Ä–µ–∑ 1—á',
      science: 'Hurrell 1999: —Ç–∞–Ω–∏–Ω—ã —Å–Ω–∏–∂–∞—é—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é Fe –Ω–∞ 70%',
      isWarning: true
    },

    // === EGGS + CHOLINE FOR BRAIN ===
    {
      id: 'eggs_morning_brain',
      trigger: { hasKeyword: ['—è–π—Ü–æ', '—è–∏—á–Ω', '–æ–º–ª–µ—Ç'], time: { before: '12:00' } },
      priority: 55,
      icon: 'üß†',
      title: '–•–æ–ª–∏–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫ ‚Äî –¥–ª—è –º–æ–∑–≥–∞',
      reason: '–Ø–π—Ü–∞ = –ª—É—á—à–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Ö–æ–ª–∏–Ω–∞',
      science: '–•–æ–ª–∏–Ω ‚Üí –∞—Ü–µ—Ç–∏–ª—Ö–æ–ª–∏–Ω ‚Üí –ø–∞–º—è—Ç—å –∏ —Ñ–æ–∫—É—Å',
      isInfo: true
    },

    // === SPINACH + LEMON ===
    {
      id: 'spinach_lemon',
      trigger: { hasKeyword: ['—à–ø–∏–Ω–∞—Ç'], missingKeyword: ['–ª–∏–º–æ–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–ø–µ—Ä–µ—Ü'] },
      priority: 75,
      icon: 'ü•¨',
      title: '–î–æ–±–∞–≤—å –ª–∏–º–æ–Ω –∫ —à–ø–∏–Ω–∞—Ç—É',
      reason: '–û–∫—Å–∞–ª–∞—Ç—ã —Å–≤—è–∑—ã–≤–∞—é—Ç –∂–µ–ª–µ–∑–æ ‚Äî –≤–∏—Ç C –ø–æ–º–æ–∂–µ—Ç',
      science: '–í–∏—Ç–∞–º–∏–Ω C –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Fe¬≥‚Å∫ ‚Üí Fe¬≤‚Å∫ –¥–ª—è —É—Å–≤–æ–µ–Ω–∏—è',
      recommend: { keywords: ['–ª–∏–º–æ–Ω', '–ø–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π'] }
    },

    // === BERRIES + CREAM ===
    {
      id: 'berries_fat',
      trigger: { hasKeyword: ['—è–≥–æ–¥', '–º–∞–ª–∏–Ω', '—á–µ—Ä–Ω–∏–∫', '–∫–ª—É–±–Ω–∏–∫', '–≥–æ–ª—É–±–∏–∫', '—Å–º–æ—Ä–æ–¥–∏–Ω'], missingMacro: 'fat' },
      priority: 65,
      icon: 'ü´ê',
      title: '–Ø–≥–æ–¥—ã –ª—É—á—à–µ —Å –∂–∏—Ä–∞–º–∏',
      reason: '–ê–Ω—Ç–æ—Ü–∏–∞–Ω—ã = –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ',
      science: 'Lipophilic polyphenols –ª—É—á—à–µ —Å –ª–∏–ø–∏–¥–∞–º–∏',
      recommend: { keywords: ['—Å–ª–∏–≤–∫–∏', '—Å–º–µ—Ç–∞–Ω–∞', '–π–æ–≥—É—Ä—Ç', '–æ—Ä–µ—Ö'] }
    },

    // === LIVER + AVOID EXCESS ===
    {
      id: 'liver_vita_excess',
      trigger: { hasKeyword: ['–ø–µ—á–µ–Ω—å', '–ø–µ—á—ë–Ω–∫–∞'] },
      priority: 70,
      icon: '‚ö†Ô∏è',
      title: '–ü–µ—á–µ–Ω—å 1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é',
      reason: '–ò–∑–±—ã—Ç–æ–∫ –≤–∏—Ç–∞–º–∏–Ω–∞ A —Ç–æ–∫—Å–∏—á–µ–Ω',
      science: '–ì–∏–ø–µ—Ä–≤–∏—Ç–∞–º–∏–Ω–æ–∑ A –ø—Ä–∏ >10000 IU/–¥–µ–Ω—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ',
      isWarning: true,
      mild: true
    },

    // === AVOCADO + SALAD ===
    {
      id: 'avocado_salad',
      trigger: { hasKeyword: ['–∞–≤–æ–∫–∞–¥–æ'], hasCategory: 'vegetables' },
      priority: 68,
      icon: 'ü•ë',
      title: '–ò–¥–µ–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è!',
      reason: '–ê–≤–æ–∫–∞–¥–æ √ó4 —É—Å–≤–æ–µ–Ω–∏–µ –∫–∞—Ä–æ—Ç–∏–Ω–æ–∏–¥–æ–≤ –∏–∑ —Å–∞–ª–∞—Ç–∞',
      science: 'Unlu 2005: –∂–∏—Ä—ã –∞–≤–æ–∫–∞–¥–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –∞–±—Å–æ—Ä–±—Ü–∏—é –∫–∞—Ä–æ—Ç–∏–Ω–æ–∏–¥–æ–≤',
      isInfo: true
    },

    // === BREAKFAST CORTISOL SPIKE ===
    {
      id: 'morning_cortisol',
      trigger: { time: { before: '09:00' }, mealSimpleCarbs: { min: 25 } },
      priority: 72,
      icon: '‚ö°',
      title: '–£—Ç—Ä–æ–º –∫–æ—Ä—Ç–∏–∑–æ–ª –≤—ã—Å–æ–∫–∏–π ‚Äî –º–µ–Ω—å—à–µ —Å–∞—Ö–∞—Ä–∞',
      reason: '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã —É—Å–∏–ª—è—Ç —Å—Ç—Ä–µ—Å—Å-–æ—Ç–≤–µ—Ç',
      science: 'Cortisol awakening response + —Å–∞—Ö–∞—Ä = –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –∫–∞—á–µ–ª–∏',
      isWarning: true
    },

    // === NUTS + PHYTATES ===
    {
      id: 'nuts_soaking',
      trigger: { hasKeyword: ['–º–∏–Ω–¥–∞–ª—å', '–≥—Ä–µ—Ü–∫', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '–æ—Ä–µ—Ö'] },
      priority: 40,
      icon: 'üí°',
      title: '–ó–∞–º–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ä–µ—Ö–æ–≤ = –ª—É—á—à–µ —É—Å–≤–æ–µ–Ω–∏–µ',
      reason: '–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ñ–µ—Ä–º–µ–Ω—Ç—ã, —Å–Ω–∏–∂–∞–µ—Ç —Ñ–∏—Ç–∞—Ç—ã',
      science: '8-12—á –≤ –≤–æ–¥–µ ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ',
      isInfo: true,
      mild: true
    }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BALANCE_RULES ‚Äî –ü—Ä–∞–≤–∏–ª–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const BALANCE_RULES = [
    {
      id: 'need_protein',
      trigger: { mealProtPct: { max: 15 }, mealKcal: { min: 300 } },
      priority: 85,
      icon: 'ü•©',
      title: '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫',
      reason: '–¢–æ–ª—å–∫–æ ' + '{protPct}%' + ' –∫–∞–ª–æ—Ä–∏–π –∏–∑ –±–µ–ª–∫–∞',
      recommend: { categories: ['protein'], keywords: ['–∫—É—Ä–∏—Ü–∞', '—Ä—ã–±–∞', '—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥'] }
    },
    {
      id: 'need_fiber',
      trigger: { mealFiber: { max: 3 }, mealKcal: { min: 300 } },
      priority: 75,
      icon: 'ü•ó',
      title: '–î–æ–±–∞–≤—å –∫–ª–µ—Ç—á–∞—Ç–∫—É',
      reason: '–í—Å–µ–≥–æ {fiber}–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –≤ –ø—Ä–∏—ë–º–µ',
      recommend: { categories: ['vegetables', 'fiber'], keywords: ['—Å–∞–ª–∞—Ç', '–æ–≥—É—Ä–µ—Ü', '–∫–∞–ø—É—Å—Ç–∞', '–±—Ä–æ–∫–∫–æ–ª–∏'] }
    },
    {
      id: 'need_healthy_fat',
      trigger: { mealGoodFatPct: { max: 30 }, mealFat: { min: 10 } },
      priority: 65,
      icon: 'ü•ë',
      title: '–£–ª—É—á—à–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤',
      reason: '–ú–∞–ª–æ –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤',
      recommend: { keywords: ['–∞–≤–æ–∫–∞–¥–æ', '–æ–ª–∏–≤–∫–æ–≤–æ–µ', '–æ—Ä–µ—Ö', '–ª–æ—Å–æ—Å—å'] }
    },
    {
      id: 'too_much_simple',
      trigger: { mealSimplePct: { min: 50 }, mealCarbs: { min: 30 } },
      priority: 80,
      icon: '‚ö†Ô∏è',
      title: '–ú–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤',
      reason: '{simplePct}% —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç—ã–µ',
      recommend: { categories: ['protein', 'fiber'], keywords: ['–æ—Ä–µ—Ö', '–±–µ–ª–æ–∫', '–æ–≤–æ—â–∏'] },
      isWarning: true
    }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TIMING_RULES ‚Äî –ü—Ä–∞–≤–∏–ª–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const TIMING_RULES = [
    {
      id: 'late_carbs',
      trigger: { time: { after: '21:00' }, mealCarbsPct: { min: 50 } },
      priority: 70,
      icon: 'üåô',
      title: '–ü–æ–∑–¥–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥—ã',
      reason: '–í–µ—á–µ—Ä–æ–º –ª—É—á—à–µ –±–µ–ª–æ–∫ + –∂–∏—Ä—ã',
      science: '–ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–µ–Ω–∞',
      isWarning: true
    },
    {
      id: 'morning_fat',
      trigger: { time: { before: '09:00' }, mealFatPct: { max: 15 }, mealKcal: { min: 200 } },
      priority: 60,
      icon: 'üåÖ',
      title: '–î–æ–±–∞–≤—å –∂–∏—Ä—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫',
      reason: '–°—ã—Ç–æ—Å—Ç—å + —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è',
      recommend: { keywords: ['–∞–≤–æ–∫–∞–¥–æ', '–æ—Ä–µ—Ö', '–º–∞—Å–ª–æ', '—Å—ã—Ä'] }
    },
    {
      id: 'afternoon_slump',
      trigger: { time: { after: '14:00', before: '16:00' }, mealGI: { min: 70 } },
      priority: 65,
      icon: 'üò¥',
      title: '–í—ã—Å–æ–∫–∏–π –ì–ò –ø–æ—Å–ª–µ –æ–±–µ–¥–∞',
      reason: '–†–∏—Å–∫ —Å–æ–Ω–ª–∏–≤–æ—Å—Ç–∏',
      recommend: { keywords: ['–æ—Ä–µ—Ö', '–±–µ–ª–æ–∫', '—Å–∞–ª–∞—Ç'] }
    }
  ];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // HELPER FUNCTIONS ‚Äî –£—Ç–∏–ª–∏—Ç—ã
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞
   */
  function detectNutrients(productName) {
    if (!productName) return [];
    const name = productName.toLowerCase();
    const found = [];

    for (const [nutrientId, config] of Object.entries(NUTRIENT_KEYWORDS)) {
      for (const keyword of config.keywords) {
        if (name.includes(keyword.toLowerCase())) {
          found.push(nutrientId);
          break;
        }
      }
    }

    return found;
  }

  /**
   * –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º –ø—Ä–æ–¥—É–∫—Ç–∞
   */
  function detectCategories(product, existingCategories) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ heys_advice –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    const adviceCategories = HEYS.advice?.PRODUCT_CATEGORIES || existingCategories || {};

    if (!product?.name) return [];
    const name = product.name.toLowerCase();
    const found = [];

    for (const [catId, config] of Object.entries(adviceCategories)) {
      if (!config.keywords) continue;
      for (const keyword of config.keywords) {
        if (name.includes(keyword.toLowerCase())) {
          found.push(catId);
          break;
        }
      }
    }

    return found;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ª–æ–≤–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞
   */
  function normalizeTextForKeywordMatch(s) {
    return String(s || '')
      .toLowerCase()
      .replace(/—ë/g, '–µ')
      // –ë—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞ + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞). –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –ø—Ä–æ–±–µ–ª.
      .replace(/[^a-z0-9–∞-—è–µ]+/gi, ' ')
      .trim()
      .replace(/\s+/g, ' ');
  }

  function tokenizeNormalizedText(sNorm) {
    return sNorm ? sNorm.split(' ') : [];
  }

  /**
   * –ù–∞–¥—ë–∂–Ω—ã–π –º–∞—Ç—á –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç—É –ø—Ä–∏—ë–º–∞.
   *
   * –í–∞–∂–Ω–æ: –º–Ω–æ–≥–∏–µ keywords –∑–∞–¥–∞–Ω—ã –∫–∞–∫ "–∫–æ—Ä–µ–Ω—å" (–Ω–∞–ø—Ä. "–∫—É—Ä–∫—É–º"), –ø–æ—ç—Ç–æ–º—É
   * –∏—Å–ø–æ–ª—å–∑—É–µ–º startsWith –ø–æ —Ç–æ–∫–µ–Ω–∞–º. –≠—Ç–æ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
   * —Ç–∏–ø–∞ "–≤–∏–Ω–æ" –≤–Ω—É—Ç—Ä–∏ "—Å–≤–∏–Ω–æ".
   */
  function textHasKeyword(mealTokens, mealNorm, keyword) {
    const kwNorm = normalizeTextForKeywordMatch(keyword);
    if (!kwNorm) return false;
    const kwTokens = kwNorm.split(' ');
    if (kwTokens.length === 1) {
      const needle = kwTokens[0];
      return mealTokens.some((t) => t.startsWith(needle));
    }

    // Multi-word: –∏—â–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤ (–∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω startsWith –∫–æ—Ä–Ω—è)
    for (let i = 0; i <= mealTokens.length - kwTokens.length; i++) {
      let ok = true;
      for (let j = 0; j < kwTokens.length; j++) {
        if (!mealTokens[i + j].startsWith(kwTokens[j])) {
          ok = false;
          break;
        }
      }
      if (ok) return true;
    }

    // Fallback: –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏
    return mealNorm.includes(kwNorm);
  }

  function checkTrigger(trigger, context) {
    const { meal, mealTotals, dayData, profile, products, time } = context;

    // –¢–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö
    const mealTextRaw = (meal?.items || []).map((it) => (it.name || '')).join(' ');
    const mealTextNorm = normalizeTextForKeywordMatch(mealTextRaw);
    const mealTokens = tokenizeNormalizedText(mealTextNorm);

    // has: nutrient
    if (trigger.has) {
      const allNutrients = (context.mealNutrients || []);
      if (!allNutrients.includes(trigger.has)) return false;
    }

    // has2: second nutrient (–¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
    if (trigger.has2) {
      const allNutrients = (context.mealNutrients || []);
      if (!allNutrients.includes(trigger.has2)) return false;
    }

    // missing: nutrient
    if (trigger.missing) {
      const allNutrients = (context.mealNutrients || []);
      if (allNutrients.includes(trigger.missing)) return false;
    }

    // hasCategory
    if (trigger.hasCategory) {
      const cats = context.mealCategories || [];
      if (!cats.includes(trigger.hasCategory)) return false;
    }

    // missingCategory
    if (trigger.missingCategory) {
      const cats = context.mealCategories || [];
      if (cats.includes(trigger.missingCategory)) return false;
    }

    // hasKeyword
    if (trigger.hasKeyword) {
      const keywords = Array.isArray(trigger.hasKeyword) ? trigger.hasKeyword : [trigger.hasKeyword];
      const hasAny = keywords.some((kw) => textHasKeyword(mealTokens, mealTextNorm, kw));
      if (!hasAny) return false;
    }

    // missingKeyword
    if (trigger.missingKeyword) {
      const keywords = Array.isArray(trigger.missingKeyword) ? trigger.missingKeyword : [trigger.missingKeyword];
      const hasAny = keywords.some((kw) => textHasKeyword(mealTokens, mealTextNorm, kw));
      if (hasAny) return false;
    }

    // hasKeyword2 ‚Äî –≤—Ç–æ—Ä–æ–π –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
    if (trigger.hasKeyword2) {
      const keywords = Array.isArray(trigger.hasKeyword2) ? trigger.hasKeyword2 : [trigger.hasKeyword2];
      const hasAny = keywords.some((kw) => textHasKeyword(mealTokens, mealTextNorm, kw));
      if (!hasAny) return false;
    }

    // missingMacro: 'fat' | 'protein' | 'carbs'
    if (trigger.missingMacro) {
      const t = mealTotals || {};
      if (trigger.missingMacro === 'fat' && t.fat > 5) return false;
      if (trigger.missingMacro === 'protein' && t.prot > 10) return false;
      if (trigger.missingMacro === 'carbs' && t.carbs > 10) return false;
    }

    // minGrams
    if (trigger.minGrams && (mealTotals?.grams || 0) < trigger.minGrams) return false;

    // mealProtLow
    if (trigger.mealProtLow && (mealTotals?.prot || 0) >= 15) return false;

    // mealCarbsLow
    if (trigger.mealCarbsLow && (mealTotals?.carbs || 0) >= 30) return false;

    // mealProtein: { min, max }
    if (trigger.mealProtein) {
      const prot = mealTotals?.prot || 0;
      if (trigger.mealProtein.min !== undefined && prot < trigger.mealProtein.min) return false;
      if (trigger.mealProtein.max !== undefined && prot > trigger.mealProtein.max) return false;
    }

    // mealKcal: { min, max }
    if (trigger.mealKcal) {
      const kcal = mealTotals?.kcal || 0;
      if (trigger.mealKcal.min !== undefined && kcal < trigger.mealKcal.min) return false;
      if (trigger.mealKcal.max !== undefined && kcal > trigger.mealKcal.max) return false;
    }

    // mealGI: { min, max }
    if (trigger.mealGI) {
      const gi = context.avgGI || 50;
      if (trigger.mealGI.min !== undefined && gi < trigger.mealGI.min) return false;
      if (trigger.mealGI.max !== undefined && gi > trigger.mealGI.max) return false;
    }

    // mealSimpleCarbs: { min }
    if (trigger.mealSimpleCarbs) {
      const simple = mealTotals?.simple || 0;
      if (trigger.mealSimpleCarbs.min !== undefined && simple < trigger.mealSimpleCarbs.min) return false;
    }

    // mealProtPct: { max }
    if (trigger.mealProtPct) {
      const kcal = mealTotals?.kcal || 0;
      const prot = mealTotals?.prot || 0;
      const protPct = kcal > 0 ? (prot * 3 / kcal * 100) : 0;
      if (trigger.mealProtPct.max !== undefined && protPct > trigger.mealProtPct.max) return false;
    }

    // mealFiber: { max }
    if (trigger.mealFiber) {
      const fiber = mealTotals?.fiber || 0;
      if (trigger.mealFiber.max !== undefined && fiber > trigger.mealFiber.max) return false;
    }

    // mealGoodFatPct: { max }
    if (trigger.mealGoodFatPct) {
      const fat = mealTotals?.fat || 0;
      const good = mealTotals?.good || 0;
      const goodPct = fat > 0 ? (good / fat * 100) : 0;
      if (trigger.mealGoodFatPct.max !== undefined && goodPct > trigger.mealGoodFatPct.max) return false;
    }

    // mealSimplePct: { min }
    if (trigger.mealSimplePct) {
      const carbs = mealTotals?.carbs || 0;
      const simple = mealTotals?.simple || 0;
      const simplePct = carbs > 0 ? (simple / carbs * 100) : 0;
      if (trigger.mealSimplePct.min !== undefined && simplePct < trigger.mealSimplePct.min) return false;
    }

    // mealCarbs: { min }
    if (trigger.mealCarbs) {
      const carbs = mealTotals?.carbs || 0;
      if (trigger.mealCarbs.min !== undefined && carbs < trigger.mealCarbs.min) return false;
    }

    // mealFat: { min }
    if (trigger.mealFat) {
      const fat = mealTotals?.fat || 0;
      if (trigger.mealFat.min !== undefined && fat < trigger.mealFat.min) return false;
    }

    // mealCarbsPct: { min }
    if (trigger.mealCarbsPct) {
      const kcal = mealTotals?.kcal || 0;
      const carbs = mealTotals?.carbs || 0;
      const carbsPct = kcal > 0 ? (carbs * 4 / kcal * 100) : 0;
      if (trigger.mealCarbsPct.min !== undefined && carbsPct < trigger.mealCarbsPct.min) return false;
    }

    // mealFatPct: { max }
    if (trigger.mealFatPct) {
      const kcal = mealTotals?.kcal || 0;
      const fat = mealTotals?.fat || 0;
      const fatPct = kcal > 0 ? (fat * 9 / kcal * 100) : 0;
      if (trigger.mealFatPct.max !== undefined && fatPct > trigger.mealFatPct.max) return false;
    }

    // time: { before, after }
    if (trigger.time) {
      const mealTime = time || meal?.time || '12:00';
      const [h, m] = mealTime.split(':').map(Number);
      const mealMinutes = h * 60 + m;

      if (trigger.time.before) {
        const [bh, bm] = trigger.time.before.split(':').map(Number);
        if (mealMinutes >= bh * 60 + bm) return false;
      }
      if (trigger.time.after) {
        const [ah, am] = trigger.time.after.split(':').map(Number);
        if (mealMinutes < ah * 60 + am) return false;
      }
    }

    // hasTrainingToday ‚Äî –µ—Å—Ç—å –ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è/–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è
    if (trigger.hasTrainingToday) {
      const trainings = dayData?.trainings || [];
      if (trainings.length === 0) return false;
    }

    // hadTrainingRecently ‚Äî –±—ã–ª–∞ –ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
    if (trigger.hadTrainingRecently) {
      const trainings = dayData?.trainings || [];
      if (trainings.length === 0) return false;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
      const mealTime = time || meal?.time || '12:00';
      const [mealH, mealM] = mealTime.split(':').map(Number);
      const mealMinutes = mealH * 60 + mealM;

      let hasRecentTraining = false;
      for (const tr of trainings) {
        if (!tr.time) continue;
        const [trH, trM] = tr.time.split(':').map(Number);
        const trMinutes = trH * 60 + trM;
        // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –î–û –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –∏ –Ω–µ –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
        const diffMinutes = mealMinutes - trMinutes;
        if (diffMinutes >= 0 && diffMinutes <= 120) {
          hasRecentTraining = true;
          break;
        }
      }
      if (!hasRecentTraining) return false;
    }

    // hasTrainingAfterMeal ‚Äî —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –ü–û–°–õ–ï —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞ (1-4 —á–∞—Å–∞)
    if (trigger.hasTrainingAfterMeal) {
      const trainings = dayData?.trainings || [];
      if (trainings.length === 0) return false;

      const mealTime = time || meal?.time || '12:00';
      const [mealH, mealM] = mealTime.split(':').map(Number);
      const mealMinutes = mealH * 60 + mealM;

      let hasUpcomingTraining = false;
      for (const tr of trainings) {
        if (!tr.time) continue;
        const [trH, trM] = tr.time.split(':').map(Number);
        const trMinutes = trH * 60 + trM;
        // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ü–û–°–õ–ï –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (—á–µ—Ä–µ–∑ 1-4 —á–∞—Å–∞)
        const diffMinutes = trMinutes - mealMinutes;
        if (diffMinutes >= 60 && diffMinutes <= 240) {
          hasUpcomingTraining = true;
          break;
        }
      }
      if (!hasUpcomingTraining) return false;
    }

    // highFiber (–¥–Ω–µ–≤–Ω–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
    if (trigger.highFiber) {
      const dayFiber = dayData?.dayTot?.fiber || 0;
      if (dayFiber < 25) return false;
    }

    // dayWaterLow
    if (trigger.dayWaterLow) {
      const waterMl = dayData?.waterMl || 0;
      const waterGoal = dayData?.waterGoal || 2000;
      if (waterMl >= waterGoal * 0.5) return false;
    }

    // dayStressHigh
    if (trigger.dayStressHigh) {
      const stress = dayData?.stressAvg || 0;
      if (stress < 6) return false;
    }

    // hasOnlyCarbs
    if (trigger.hasOnlyCarbs) {
      const t = mealTotals || {};
      if (t.prot > 5 || t.fat > 5) return false;
      if (t.carbs < 20) return false;
    }

    return true;
  }

  /**
   * –ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   */
  function findRecommendedProducts(recommend, products, currentItems, limit = 3) {
    if (!recommend || !products || products.length === 0) return [];

    const currentIds = new Set((currentItems || []).map(it => it.product_id || it.id));
    const candidates = [];

    // –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    if (recommend.keywords) {
      for (const product of products) {
        if (currentIds.has(product.id)) continue;
        const name = (product.name || '').toLowerCase();
        for (const keyword of recommend.keywords) {
          if (name.includes(keyword.toLowerCase())) {
            candidates.push({ product, score: 10 });
            break;
          }
        }
      }
    }

    // –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º PRODUCT_CATEGORIES)
    if (recommend.categories) {
      const adviceCategories = HEYS.advice?.PRODUCT_CATEGORIES || {};
      for (const product of products) {
        if (currentIds.has(product.id)) continue;
        const name = (product.name || '').toLowerCase();

        for (const catId of recommend.categories) {
          const cat = adviceCategories[catId] || NUTRIENT_KEYWORDS[catId];
          if (!cat?.keywords) continue;

          for (const keyword of cat.keywords) {
            if (name.includes(keyword.toLowerCase())) {
              candidates.push({ product, score: 5 });
              break;
            }
          }
        }
      }
    }

    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ score
    const seen = new Set();
    const unique = candidates.filter(c => {
      if (seen.has(c.product.id)) return false;
      seen.add(c.product.id);
      return true;
    });

    unique.sort((a, b) => b.score - a.score);
    return unique.slice(0, limit).map(c => c.product);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø–æ—Ä—Ü–∏—é –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞
   */
  function getSmartPortion(product) {
    if (!product) return RECOMMENDED_PORTIONS.default;

    const name = (product.name || '').toLowerCase();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    if (/—è–π—Ü|–æ–º–ª–µ—Ç|—è–∏—á–Ω/.test(name)) return RECOMMENDED_PORTIONS.eggs;
    if (/—Å—ã—Ä|–ø–∞—Ä–º–µ–∑–∞–Ω|–º–æ—Ü–∞—Ä–µ–ª–ª–∞|–±—Ä—ã–Ω–∑–∞/.test(name)) return RECOMMENDED_PORTIONS.cheese;
    if (/–º–∞—Å–ª–æ/.test(name)) return RECOMMENDED_PORTIONS.oil;
    if (/–º–æ–ª–æ–∫–æ|–∫–µ—Ñ–∏—Ä|–π–æ–≥—É—Ä—Ç|—Ä—è–∂–µ–Ω–∫–∞/.test(name)) return RECOMMENDED_PORTIONS.dairy;
    if (/–∫—É—Ä–∏—Ü–∞|–≥–æ–≤—è–¥–∏–Ω–∞|—Å–≤–∏–Ω–∏–Ω–∞|–∏–Ω–¥–µ–π–∫–∞|—Ä—ã–±–∞|–ª–æ—Å–æ—Å—å|—Ç—É–Ω–µ—Ü|–º–∏–Ω—Ç–∞–π/.test(name)) return RECOMMENDED_PORTIONS.protein;
    if (/–æ—Ä–µ—Ö|–º–∏–Ω–¥–∞–ª—å|–∫–µ—à—å—é|—Ñ—É–Ω–¥—É–∫|–≥—Ä–µ—Ü–∫/.test(name)) return RECOMMENDED_PORTIONS.nuts;
    if (/–≥—Ä–µ—á–∫–∞|—Ä–∏—Å|–æ–≤—Å—è–Ω–∫–∞|–º–∞–∫–∞—Ä–æ–Ω|–ø–∞—Å—Ç–∞/.test(name)) return RECOMMENDED_PORTIONS.grains;
    if (/–±–∞–Ω–∞–Ω|—è–±–ª–æ–∫–æ|–∞–ø–µ–ª—å—Å–∏–Ω|–≥—Ä—É—à–∞|–ø–µ—Ä—Å–∏–∫/.test(name)) return RECOMMENDED_PORTIONS.fruits;
    if (/—Å–∞–ª–∞—Ç|–æ–≥—É—Ä–µ—Ü|–ø–æ–º–∏–¥–æ—Ä|–∫–∞–ø—É—Å—Ç–∞|–±—Ä–æ–∫–∫–æ–ª–∏|—à–ø–∏–Ω–∞—Ç/.test(name)) return RECOMMENDED_PORTIONS.vegetables;
    if (/—É–∫—Ä–æ–ø|–ø–µ—Ç—Ä—É—à–∫–∞|–±–∞–∑–∏–ª–∏–∫|–∫–∏–Ω–∑–∞|–∑–µ–ª–µ–Ω—å/.test(name)) return RECOMMENDED_PORTIONS.greens;
    if (/—Å–æ—É—Å|–∫–µ—Ç—á—É–ø|–º–∞–π–æ–Ω–µ–∑/.test(name)) return RECOMMENDED_PORTIONS.sauce;

    return RECOMMENDED_PORTIONS.default;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CONTEXTUAL RECOMMENDATIONS ‚Äî –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –°–¥–µ–ª–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π ‚Äî —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   */
  function makeContextualRecommendation(rule, context, recommendedProducts) {
    const { meal, mealTotals, mealNutrients } = context;
    const items = meal?.items || [];

    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –ø—Ä–∏—ë–º–µ (–ø–µ—Ä–≤—ã–µ 2 –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
    const productNames = items.slice(0, 2).map(it => {
      const name = it.name || '';
      // –°–æ–∫—Ä–∞—â–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
      return name.length > 20 ? name.substring(0, 18) + '...' : name;
    });
    const mainProduct = productNames[0] || '–ø—Ä–∏—ë–º';
    const hasMultiple = items.length > 1;

    // –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
    const recProduct = recommendedProducts[0]?.name || '';
    const recShort = recProduct.length > 15 ? recProduct.substring(0, 13) + '...' : recProduct;

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
    const contextTemplates = {
      // SYNERGY
      'iron_vitc': {
        title: `–ö ${mainProduct} –¥–æ–±–∞–≤—å –≤–∏—Ç–∞–º–∏–Ω C`,
        reason: `${recShort || '–õ–∏–º–æ–Ω/–ø–µ—Ä–µ—Ü'} ‚Äî –∂–µ–ª–µ–∑–æ —É—Å–≤–æ–∏—Ç—Å—è –≤ 6 —Ä–∞–∑ –ª—É—á—à–µ`
      },
      'calcium_vitd': {
        title: `–í–∏—Ç–∞–º–∏–Ω D –∫ ${mainProduct}`,
        reason: `${recShort || '–Ø–π—Ü–æ/—Ä—ã–±–∞'} —É—Å–∏–ª–∏—Ç —É—Å–≤–æ–µ–Ω–∏–µ –∫–∞–ª—å—Ü–∏—è`
      },
      'fat_vitamins': {
        title: `–ú–∞—Å–ª–æ –∫ ${mainProduct}`,
        reason: `–ö–∞—Ä–æ—Ç–∏–Ω—ã –∏–∑ –æ–≤–æ—â–µ–π —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –∂–∏—Ä–∞–º–∏`
      },
      'plant_protein': {
        title: `–ë–æ–±–æ–≤—ã–µ –∫ ${mainProduct}`,
        reason: `${recShort || '–§–∞—Å–æ–ª—å/—á–µ—á–µ–≤–∏—Ü–∞'} ‚Äî –ø–æ–ª–Ω—ã–π –±–µ–ª–æ–∫ –≤–º–µ—Å—Ç–µ —Å –∫—Ä—É–ø–æ–π`
      },
      'turmeric_pepper': {
        title: `–ß—ë—Ä–Ω—ã–π –ø–µ—Ä–µ—Ü –∫ –∫—É—Ä–∫—É–º–µ`,
        reason: `–£—Å–≤–æ–µ–Ω–∏–µ –∫—É—Ä–∫—É–º–∏–Ω–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç –≤ 20 —Ä–∞–∑`
      },
      'tomato_fat': {
        title: `–ú–∞—Å–ª–æ –∫ —Ç–æ–º–∞—Ç–∞–º`,
        reason: `–õ–∏–∫–æ–ø–∏–Ω —É—Å–≤–æ–∏—Ç—Å—è –≤ 4 —Ä–∞–∑–∞ –ª—É—á—à–µ —Å –∂–∏—Ä–∞–º–∏`
      },
      'tea_no_milk': {
        title: `–ú–æ–ª–æ–∫–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç —á–∞–π`,
        reason: `–ö–∞–∑–µ–∏–Ω —Å–≤—è–∑—ã–≤–∞–µ—Ç –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã ‚Äî –ø–µ–π –æ—Ç–¥–µ–ª—å–Ω–æ`
      },
      'coffee_iron': {
        title: `–ö–æ—Ñ–µ —Å–Ω–∏–∂–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞`,
        reason: `–ü–æ–¥–æ–∂–¥–∏ 1-2 —á–∞—Å–∞ –ø–æ—Å–ª–µ ${mainProduct}`
      },
      'fiber_minerals': {
        title: `–ú–Ω–æ–≥–æ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ = –º–µ–Ω—å—à–µ —Ü–∏–Ω–∫–∞`,
        reason: `–§–∏—Ç–∞—Ç—ã —Å–≤—è–∑—ã–≤–∞—é—Ç –º–∏–Ω–µ—Ä–∞–ª—ã`
      },

      // BALANCE
      'need_protein': {
        title: `–ú–∞–ª–æ –±–µ–ª–∫–∞ –≤ ${mainProduct}`,
        reason: `–¢–æ–ª—å–∫–æ ${Math.round((mealTotals?.prot || 0) * 4 / (mealTotals?.kcal || 1) * 100)}% –∫–∞–ª–æ—Ä–∏–π –∏–∑ –±–µ–ª–∫–∞ ‚Äî –¥–æ–±–∞–≤—å ${recShort || '—è–π—Ü–æ/—Ç–≤–æ—Ä–æ–≥'}`
      },
      'need_fiber': {
        title: `–î–æ–±–∞–≤—å –∫–ª–µ—Ç—á–∞—Ç–∫—É –∫ ${mainProduct}`,
        reason: `–í—Å–µ–≥–æ ${Math.round(mealTotals?.fiber || 0)}–≥ ‚Äî –Ω—É–∂–Ω–æ ${recShort || '–æ–≤–æ—â–∏/—Å–∞–ª–∞—Ç'}`
      },
      'need_healthy_fat': {
        title: `–£–ª—É—á—à–∏ –∂–∏—Ä—ã –≤ ${mainProduct}`,
        reason: `–ó–∞–º–µ–Ω–∏ –Ω–∞ ${recShort || '–∞–≤–æ–∫–∞–¥–æ/–æ—Ä–µ—Ö–∏/–æ–ª–∏–≤–∫–æ–≤–æ–µ'}`
      },
      'too_much_simple': {
        title: `${Math.round((mealTotals?.simple || 0) / (mealTotals?.carbs || 1) * 100)}% ‚Äî –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã`,
        reason: `–î–æ–±–∞–≤—å ${recShort || '–±–µ–ª–æ–∫/–∫–ª–µ—Ç—á–∞—Ç–∫—É'} ‚Äî —Å–≥–ª–∞–¥–∏—Ç —Å–∫–∞—á–æ–∫ —Å–∞—Ö–∞—Ä–∞`
      },

      // TIMING
      'protein_leucine': {
        title: `–ï—â—ë ${30 - Math.round(mealTotals?.prot || 0)}–≥ –±–µ–ª–∫–∞ –¥–æ –æ–ø—Ç–∏–º—É–º–∞`,
        reason: `${recShort || '–Ø–π—Ü–æ/—Ç–≤–æ—Ä–æ–≥'} ‚Äî –¥–æ—Å—Ç–∏–≥–Ω–µ—à—å –ª–µ–π—Ü–∏–Ω–æ–≤–æ–≥–æ –ø–æ—Ä–æ–≥–∞`
      },
      'gi_balance': {
        title: `–í—ã—Å–æ–∫–∏–π –ì–ò (${Math.round(context.avgGI || 0)}) –≤ ${mainProduct}`,
        reason: `${recShort || '–û–≤–æ—â–∏/—Å–∞–ª–∞—Ç'} —Å–Ω–∏–∑—è—Ç —Å–∫–∞—á–æ–∫ —Å–∞—Ö–∞—Ä–∞`
      },
      'evening_protein': {
        title: `–î–æ–±–∞–≤—å –∫–∞–∑–µ–∏–Ω –Ω–∞ –Ω–æ—á—å`,
        reason: `${recShort || '–¢–≤–æ—Ä–æ–≥'} ‚Äî –º–µ–¥–ª–µ–Ω–Ω—ã–π –±–µ–ª–æ–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è`
      },
      'preworkout_carbs': {
        title: `–£–≥–ª–µ–≤–æ–¥—ã –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π`,
        reason: `${recShort || '–ë–∞–Ω–∞–Ω/–æ–≤—Å—è–Ω–∫–∞'} ‚Äî —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è –º—ã—à—Ü`
      },
      'postworkout_protein': {
        title: `–ë–µ–ª–æ–∫ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–∞–∂–µ–Ω`,
        reason: `${recShort || '–ö—É—Ä–∏—Ü–∞/—è–π—Ü–æ'} ‚Äî –æ–∫–Ω–æ –∞–Ω–∞–±–æ–ª–∏–∑–º–∞ 2 —á–∞—Å–∞`
      },
      'carbs_protein_combo': {
        title: `–ö ${mainProduct} –¥–æ–±–∞–≤—å –±–µ–ª–æ–∫`,
        reason: `${recShort || '–Ø–π—Ü–æ/—Ç–≤–æ—Ä–æ–≥'} ‚Äî –¥–æ–ª—å—à–µ –Ω–∞—Å—ã—Ç–∏—Ç`
      },
      'simple_carbs_high': {
        title: `–ú–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ (${Math.round(mealTotals?.simple || 0)}–≥)`,
        reason: `${recShort || '–û—Ä–µ—Ö–∏/–±–µ–ª–æ–∫'} –∑–∞–º–µ–¥–ª—è—Ç –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ`
      },
      'breakfast_protein': {
        title: `–ë–µ–ª–æ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫`,
        reason: `${recShort || '–Ø–π—Ü–æ/—Ç–≤–æ—Ä–æ–≥'} ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –¥–æ –æ–±–µ–¥–∞`
      },
      'omega3_recovery': {
        title: `–û–º–µ–≥–∞-3 –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è`,
        reason: `${recShort || '–õ–æ—Å–æ—Å—å/–ª—å–Ω—è–Ω–æ–µ'} ‚Äî —Å–Ω–∏–∑–∏—Ç –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏`
      },
      'magnesium_stress': {
        title: `–ú–∞–≥–Ω–∏–π –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ`,
        reason: `${recShort || '–ú–∏–Ω–¥–∞–ª—å/–∞–≤–æ–∫–∞–¥–æ'} ‚Äî —Å–Ω–∏–∑–∏—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª`
      },
      'late_carbs': {
        title: `–ü–æ–∑–¥–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥—ã (${Math.round(mealTotals?.carbs || 0)}–≥)`,
        reason: `–í–µ—á–µ—Ä–æ–º –ª—É—á—à–µ –±–µ–ª–æ–∫ + –∂–∏—Ä—ã ‚Äî –∏–Ω—Å—É–ª–∏–Ω —Å–Ω–∏–∂–µ–Ω`
      },
      'morning_fat': {
        title: `–î–æ–±–∞–≤—å –∂–∏—Ä—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫`,
        reason: `${recShort || '–ê–≤–æ–∫–∞–¥–æ/–æ—Ä–µ—Ö–∏'} ‚Äî —Å—ã—Ç–æ—Å—Ç—å –¥–æ –æ–±–µ–¥–∞`
      },
      'afternoon_slump': {
        title: `–í—ã—Å–æ–∫–∏–π –ì–ò –ø–æ—Å–ª–µ –æ–±–µ–¥–∞`,
        reason: `${recShort || '–û—Ä–µ—Ö–∏/–±–µ–ª–æ–∫'} ‚Äî –∏–∑–±–µ–∂–∏—à—å —Å–æ–Ω–ª–∏–≤–æ—Å—Ç–∏`
      },

      // –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ë–ï–õ–ö–ê
      'protein_distribution': {
        title: `–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –±–µ–ª–æ–∫ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ`,
        reason: `${Math.round(mealTotals?.prot || 0)}–≥ ‚Äî –º–Ω–æ–≥–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞, –æ–ø—Ç–∏–º—É–º 20-40–≥`
      },
      'protein_variety': {
        title: `–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–ª–∫–∞`,
        reason: `${recShort || '–†—ã–±–∞/—è–π—Ü–∞/–º–æ–ª–æ—á–∫–∞'} ‚Äî —Ä–∞–∑–Ω—ã–µ –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã`
      },

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –ù–û–í–´–ï –ù–ê–£–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê (2025-12-10)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // –î–û–ë–ê–í–ö–ò –ò –í–ò–¢–ê–ú–ò–ù–´
      'fat_meal_vitd': {
        title: `–í—ã–ø–µ–π –≤–∏—Ç–∞–º–∏–Ω D —Å —ç—Ç–∏–º –ø—Ä–∏—ë–º–æ–º`,
        reason: `${Math.round(mealTotals?.fat || 0)}–≥ –∂–∏—Ä–æ–≤ ‚Äî D3 —É—Å–≤–æ–∏—Ç—Å—è –Ω–∞ 32% –ª—É—á—à–µ`
      },
      'evening_magnesium': {
        title: `–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –º–∞–≥–Ω–∏—è`,
        reason: `–í–µ—á–µ—Ä ‚Äî Mg —Ä–∞—Å—Å–ª–∞–±–∏—Ç –º—ã—à—Ü—ã –∏ —É–ª—É—á—à–∏—Ç —Å–æ–Ω`
      },
      'omega3_with_fat': {
        title: `–û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –û–º–µ–≥–∞-3`,
        reason: `–° ${Math.round(mealTotals?.fat || 0)}–≥ –∂–∏—Ä–æ–≤ —É—Å–≤–æ–∏—Ç—Å—è –≤ 3√ó –ª—É—á—à–µ`
      },
      'protein_creatine_timing': {
        title: `–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∫—Ä–µ–∞—Ç–∏–Ω–∞`,
        reason: `${Math.round(mealTotals?.prot || 0)}–≥ –±–µ–ª–∫–∞ + —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Å–≤–æ–µ–Ω–∏–µ +60%`
      },

      // –ö–û–ù–§–õ–ò–ö–¢–´
      'calcium_iron_conflict': {
        title: `‚ö†Ô∏è –ö–∞–ª—å—Ü–∏–π + –∂–µ–ª–µ–∑–æ ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç!`,
        reason: `–í ${mainProduct} –æ–±–∞ –º–∏–Ω–µ—Ä–∞–ª–∞ ‚Äî –∫–∞–ª—å—Ü–∏–π —Å–Ω–∏–∑–∏—Ç —É—Å–≤–æ–µ–Ω–∏–µ Fe –Ω–∞ 50%`
      },
      'coffee_calcium_timing': {
        title: `–ö–æ—Ñ–µ + –º–æ–ª–æ—á–∫–∞ ‚Äî –ø–æ–¥–æ–∂–¥–∏ 2 —á–∞—Å–∞`,
        reason: `–ö–æ—Ñ–µ–∏–Ω –≤—ã–º—ã–≤–∞–µ—Ç –∫–∞–ª—å—Ü–∏–π ‚Äî 6–º–≥ Ca –Ω–∞ 100–º–≥ –∫–æ—Ñ–µ–∏–Ω–∞`
      },
      'green_tea_iron': {
        title: `–ó–µ–ª—ë–Ω—ã–π —á–∞–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–µ–ª–µ–∑–æ`,
        reason: `–¢–∞–Ω–∏–Ω—ã —Å–Ω–∏–∂–∞—é—Ç Fe –Ω–∞ 70% ‚Äî –ø–µ–π —á–µ—Ä–µ–∑ 1—á –ø–æ—Å–ª–µ ${mainProduct}`
      },

      // –í–†–ï–ú–Ø –°–£–¢–û–ö
      'iron_morning_best': {
        title: `–£—Ç—Ä–æ ‚Äî –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∂–µ–ª–µ–∑–∞`,
        reason: `–ì–µ–ø—Å–∏–¥–∏–Ω –º–∏–Ω–∏–º–∞–ª–µ–Ω ‚Äî Fe –∏–∑ ${mainProduct} —É—Å–≤–æ–∏—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ`
      },
      'late_night_fat': {
        title: `–ú–Ω–æ–≥–æ –∂–∏—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º`,
        reason: `${Math.round(mealTotals?.fat || 0)}–≥ ‚Äî –∑–∞–º–µ–¥–ª–∏—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ –Ω–∞ 2-4—á`
      },
      'morning_cortisol': {
        title: `–£—Ç—Ä–æ–º –º–µ–Ω—å—à–µ —Å–∞—Ö–∞—Ä–∞`,
        reason: `${Math.round(mealTotals?.simple || 0)}–≥ –ø—Ä–æ—Å—Ç—ã—Ö + –∫–æ—Ä—Ç–∏–∑–æ–ª = –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–µ –∫–∞—á–µ–ª–∏`
      },

      // –°–ò–ù–ï–†–ì–ò–ò –ú–ò–ö–†–û–ù–£–¢–†–ò–ï–ù–¢–û–í
      'magnesium_b6': {
        title: `–ú–∞–≥–Ω–∏–π + B6 ‚Äî —Å–∏–Ω–µ—Ä–≥–∏—è`,
        reason: `${recShort || '–ö—É—Ä–∏—Ü–∞/–±–∞–Ω–∞–Ω'} ‚Äî B6 —É—Å–∏–ª–∏—Ç —É—Å–≤–æ–µ–Ω–∏–µ Mg –Ω–∞ 20%`
      },
      'spinach_lemon': {
        title: `–î–æ–±–∞–≤—å –ª–∏–º–æ–Ω –∫ —à–ø–∏–Ω–∞—Ç—É`,
        reason: `–í–∏—Ç–∞–º–∏–Ω C –Ω–µ–π—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –æ–∫—Å–∞–ª–∞—Ç—ã ‚Äî –∂–µ–ª–µ–∑–æ —É—Å–≤–æ–∏—Ç—Å—è`
      },
      'berries_fat': {
        title: `–ö —è–≥–æ–¥–∞–º ‚Äî –∂–∏—Ä—ã`,
        reason: `${recShort || '–°–ª–∏–≤–∫–∏/—Å–º–µ—Ç–∞–Ω–∞'} ‚Äî –∞–Ω—Ç–æ—Ü–∏–∞–Ω—ã —É—Å–≤–æ—è—Ç—Å—è –ª—É—á—à–µ`
      },

      // –°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –ü–†–û–î–£–ö–¢–´
      'tryptophan_carbs': {
        title: `–¢—Ä–∏–ø—Ç–æ—Ñ–∞–Ω + —É–≥–ª–µ–≤–æ–¥—ã = –º–µ–ª–∞—Ç–æ–Ω–∏–Ω`,
        reason: `${mainProduct} + ${Math.round(mealTotals?.carbs || 0)}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–Ω–∞`
      },
      'collagen_sleep': {
        title: `–ö–æ–ª–ª–∞–≥–µ–Ω –≤–µ—á–µ—Ä–æ–º ‚Äî –æ—Ç–ª–∏—á–Ω–æ!`,
        reason: `–ì–ª–∏—Ü–∏–Ω –≤ –∫–æ–ª–ª–∞–≥–µ–Ω–µ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞`
      },
      'eggs_morning_brain': {
        title: `–•–æ–ª–∏–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫ ‚Äî –¥–ª—è –º–æ–∑–≥–∞`,
        reason: `–Ø–π—Ü–∞ ‚Üí –∞—Ü–µ—Ç–∏–ª—Ö–æ–ª–∏–Ω ‚Üí –ø–∞–º—è—Ç—å –∏ —Ñ–æ–∫—É—Å –≤–µ—Å—å –¥–µ–Ω—å`
      },
      'avocado_salad': {
        title: `–ò–¥–µ–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è!`,
        reason: `–ñ–∏—Ä—ã –∞–≤–æ–∫–∞–¥–æ √ó4 —É—Å–≤–æ–µ–Ω–∏–µ –∫–∞—Ä–æ—Ç–∏–Ω–æ–∏–¥–æ–≤ –∏–∑ –æ–≤–æ—â–µ–π`
      },

      // –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø
      'zinc_empty_stomach': {
        title: `–¶–∏–Ω–∫ —Å –µ–¥–æ–π, –Ω–µ –Ω–∞—Ç–æ—â–∞–∫`,
        reason: `${Math.round(mealTotals?.kcal || 0)} –∫–∫–∞–ª ‚Äî –º–∞–ª–æ–≤–∞—Ç–æ, Zn –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ç–æ—à–Ω–æ—Ç—É`
      },
      'liver_vita_excess': {
        title: `–ü–µ—á–µ–Ω—å 1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é`,
        reason: `–ò–∑–±—ã—Ç–æ–∫ –≤–∏—Ç–∞–º–∏–Ω–∞ A —Ç–æ–∫—Å–∏—á–µ–Ω –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏`
      },

      // INFO
      'nuts_soaking': {
        title: `–ó–∞–º–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ä–µ—Ö–æ–≤ —É–ª—É—á—à–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ`,
        reason: `8-12—á –≤ –≤–æ–¥–µ ‚Äî —Ñ–∏—Ç–∞—Ç—ã —Å–Ω–∏–∂–∞—é—Ç—Å—è, –º–∏–Ω–µ—Ä–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω–µ–µ`
      },
      'probiotic_empty': {
        title: `–ü—Ä–æ–±–∏–æ—Ç–∏–∫–∏ –ª—É—á—à–µ –Ω–∞—Ç–æ—â–∞–∫`,
        reason: `–ò–ª–∏ —á–µ—Ä–µ–∑ 2—á –ø–æ—Å–ª–µ –µ–¥—ã ‚Äî –∂–µ–ª—É–¥–æ—á–Ω—ã–π —Å–æ–∫ —É–±–∏–≤–∞–µ—Ç –±–∞–∫—Ç–µ—Ä–∏–∏`
      },
      'vitc_with_meal': {
        title: `–í–∏—Ç–∞–º–∏–Ω C –ª—É—á—à–µ —Å –µ–¥–æ–π`,
        reason: `–ê—Å–∫–æ—Ä–±–∏–Ω–æ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞ ‚Äî —Å–Ω–∏–∑–∏—Ç—Å—è —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞`
      }
    };

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    const template = contextTemplates[rule.id];

    if (template) {
      return {
        title: template.title,
        reason: template.reason
      };
    }

    // Fallback ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    let title = rule.title || '';
    let reason = rule.reason || '';

    // –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    reason = reason.replace('{protPct}', Math.round((mealTotals?.prot || 0) * 4 / (mealTotals?.kcal || 1) * 100));
    reason = reason.replace('{fiber}', Math.round(mealTotals?.fiber || 0));
    reason = reason.replace('{simplePct}', Math.round((mealTotals?.simple || 0) / (mealTotals?.carbs || 1) * 100));

    return { title, reason };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MAIN API ‚Äî getMealOptimization
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏
   * @param {Object} params
   * @param {Object} params.meal - –ü—Ä–∏—ë–º –ø–∏—â–∏ { items: [...], time: 'HH:MM' }
   * @param {Object} params.mealTotals - –°—É–º–º—ã –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ { kcal, prot, carbs, ... }
   * @param {Object} params.dayData - –î–∞–Ω–Ω—ã–µ –¥–Ω—è { dayTot, trainings, waterMl, ... }
   * @param {Object} params.profile - –ü—Ä–æ—Ñ–∏–ª—å { age, gender, ... }
   * @param {Array} params.products - –ú–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –±–∞–∑—ã
   * @param {Object} params.pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @returns {Array} –ú–∞—Å—Å–∏–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
   */
  function getMealOptimization(params) {
    const { meal, mealTotals, dayData, profile, products, pIndex, avgGI } = params;

    if (!meal?.items || meal.items.length === 0) return [];

    // –°–æ–±–∏—Ä–∞–µ–º –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –ø—Ä–∏—ë–º–µ
    const mealNutrients = new Set();
    const mealCategories = new Set();

    for (const item of meal.items) {
      const name = item.name || '';

      // –ù—É—Ç—Ä–∏–µ–Ω—Ç—ã
      const nutrients = detectNutrients(name);
      nutrients.forEach(n => mealNutrients.add(n));

      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
      const cats = detectCategories({ name });
      cats.forEach(c => mealCategories.add(c));
    }

    const context = {
      meal,
      mealTotals: mealTotals || {},
      mealNutrients: Array.from(mealNutrients),
      mealCategories: Array.from(mealCategories),
      dayData: dayData || {},
      profile: profile || {},
      products: products || [],
      pIndex,
      avgGI: avgGI || 50,
      time: meal.time
    };

    const recommendations = [];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞
    const allRules = [...SYNERGY_RULES, ...BALANCE_RULES, ...TIMING_RULES];

    for (const rule of allRules) {
      if (checkTrigger(rule.trigger, context)) {
        // –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        let recProducts = [];
        if (rule.recommend && products && products.length > 0) {
          recProducts = findRecommendedProducts(
            rule.recommend,
            products,
            meal.items,
            3
          );

          // –î–æ–±–∞–≤–ª—è–µ–º smart portion –∫ –∫–∞–∂–¥–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É
          recProducts = recProducts.map(p => ({
            ...p,
            smartPortion: getSmartPortion(p)
          }));
        }

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
        const contextual = makeContextualRecommendation(rule, context, recProducts);

        const rec = {
          id: rule.id,
          priority: rule.priority || 50,
          icon: rule.icon,
          title: contextual.title,
          reason: contextual.reason,
          science: rule.science,
          isWarning: rule.isWarning || false,
          isInfo: rule.isInfo || false,
          mild: rule.mild || false,
          products: recProducts
        };

        recommendations.push(rec);
      }
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—ã—à–µ = –≤–∞–∂–Ω–µ–µ)
    recommendations.sort((a, b) => b.priority - a.priority);

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (max 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π)
    return recommendations.slice(0, 5);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // USER ACTIONS TRACKING ‚Äî –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const ACTIONS_KEY = 'heys_meal_optimizer_actions';
  const MAX_ACTIONS = 1000; // –õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π
  const MAX_AGE_DAYS = 30; // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π

  /**
   * –ó–∞–ø–∏—Å–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  function trackUserAction(action) {
    try {
      let actions = U.lsGet ? U.lsGet(ACTIONS_KEY, []) : JSON.parse(localStorage.getItem(ACTIONS_KEY) || '[]');

      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
      const cutoff = Date.now() - (MAX_AGE_DAYS * 24 * 60 * 60 * 1000);
      actions = actions.filter(a => (a.timestamp || 0) > cutoff);

      actions.push({
        ...action,
        timestamp: Date.now()
      });

      // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ MAX_ACTIONS –¥–µ–π—Å—Ç–≤–∏–π
      const trimmed = actions.slice(-MAX_ACTIONS);

      if (U.lsSet) {
        U.lsSet(ACTIONS_KEY, trimmed);
      } else {
        localStorage.setItem(ACTIONS_KEY, JSON.stringify(trimmed));
      }
    } catch (e) {
      console.warn('[MealOptimizer] Failed to track action:', e);
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
   */
  function getActionStats() {
    try {
      const actions = U.lsGet ? U.lsGet(ACTIONS_KEY, []) : JSON.parse(localStorage.getItem(ACTIONS_KEY) || '[]');

      const stats = {
        acceptedRules: {},
        dismissedRules: {},
        addedProducts: {},
        totalAccepted: 0,
        totalDismissed: 0
      };

      for (const action of actions) {
        if (action.type === 'accept') {
          stats.acceptedRules[action.ruleId] = (stats.acceptedRules[action.ruleId] || 0) + 1;
          stats.totalAccepted++;
          if (action.productId) {
            stats.addedProducts[action.productId] = (stats.addedProducts[action.productId] || 0) + 1;
          }
        } else if (action.type === 'dismiss') {
          stats.dismissedRules[action.ruleId] = (stats.dismissedRules[action.ruleId] || 0) + 1;
          stats.totalDismissed++;
        }
      }

      return stats;
    } catch (e) {
      return { acceptedRules: {}, dismissedRules: {}, addedProducts: {}, totalAccepted: 0, totalDismissed: 0 };
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ —Å–∫—Ä—ã—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (—Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è)
   */
  function shouldHideRecommendation(ruleId) {
    const stats = getActionStats();
    const dismissed = stats.dismissedRules[ruleId] || 0;
    const accepted = stats.acceptedRules[ruleId] || 0;

    // –ï—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ 5+ —Ä–∞–∑ –∏ –ø—Ä–∏–Ω—è—Ç–æ –º–µ–Ω—å—à–µ 20% ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º
    if (dismissed >= 5 && accepted / (dismissed + accepted) < 0.2) {
      return true;
    }

    return false;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // EXPORT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  HEYS.MealOptimizer = {
    // Main API
    getMealOptimization,

    // Helpers
    detectNutrients,
    detectCategories,
    getSmartPortion,
    findRecommendedProducts,

    // Tracking
    trackUserAction,
    getActionStats,
    shouldHideRecommendation,

    // Constants (for debugging/extension)
    NUTRIENT_KEYWORDS,
    RECOMMENDED_PORTIONS,
    SYNERGY_RULES,
    BALANCE_RULES,
    TIMING_RULES,

    // Version
    VERSION: '1.0.0'
  };

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_sounds_v1.js ===== */
/**
 * HEYS Sounds Module v1
 * –°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–≤—É–∫–∏ —á–µ—Ä–µ–∑ Web Audio API
 * 
 * @file heys_sounds_v1.js
 * @version 1.0.0
 */
(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  
  // Lazy AudioContext (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–≤—É–∫–µ)
  let audioCtx = null;
  
  // –§–ª–∞–≥: –±—ã–ª –ª–∏ user gesture
  let userGestureReceived = false;
  
  // –°–ª—É—à–∞–µ–º –ø–µ—Ä–≤—ã–π user gesture –¥–ª—è AudioContext
  function initOnUserGesture() {
    if (userGestureReceived) return;
    userGestureReceived = true;
    // –°–æ–∑–¥–∞—ë–º AudioContext —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ user gesture
    if (!audioCtx) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) {
        audioCtx = new AudioContext();
      }
    }
    // –£–¥–∞–ª—è–µ–º listeners –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ gesture
    document.removeEventListener('click', initOnUserGesture);
    document.removeEventListener('touchstart', initOnUserGesture);
    document.removeEventListener('keydown', initOnUserGesture);
  }
  
  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º listeners –¥–ª—è user gesture
  document.addEventListener('click', initOnUserGesture, { once: true, passive: true });
  document.addEventListener('touchstart', initOnUserGesture, { once: true, passive: true });
  document.addEventListener('keydown', initOnUserGesture, { once: true, passive: true });
  
  function getAudioContext() {
    // –ï—Å–ª–∏ user gesture –Ω–µ –±—ã–ª–æ ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º AudioContext
    if (!userGestureReceived) return null;
    
    if (!audioCtx) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return null;
      audioCtx = new AudioContext();
    }
    // Resume –µ—Å–ª–∏ suspended (iOS requirement)
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().catch(() => {});
    }
    return audioCtx;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  // üîß FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º U.lsGet –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞–∫–æ–º
  function isSoundEnabled() {
    try {
      const U = window.HEYS?.utils || {};
      const settings = U.lsGet ? U.lsGet('heys_advice_settings', {}) : JSON.parse(localStorage.getItem('heys_advice_settings') || '{}');
      return settings.soundEnabled !== false; // true –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    } catch { return true; }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤ (23:00 - 07:00)
  function isQuietHours() {
    const hour = new Date().getHours();
    return hour >= 23 || hour < 7;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ prefers-reduced-motion
  function prefersReducedMotion() {
    return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  }
  
  /**
   * –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫
   * @param {string} type - 'pop' | 'ding' | 'success' | 'warning' | 'whoosh'
   */
  function play(type) {
    if (!isSoundEnabled() || isQuietHours() || prefersReducedMotion()) return;
    
    const ctx = getAudioContext();
    if (!ctx) return;
    
    try {
      switch (type) {
        case 'pop':
          playPop(ctx);
          break;
        case 'ding':
          playDing(ctx);
          break;
        case 'success':
        case 'achievement':
          playSuccess(ctx);
          break;
        case 'warning':
          playWarning(ctx);
          break;
        case 'whoosh':
          playWhoosh(ctx);
          break;
        default:
          playPop(ctx);
      }
    } catch (e) {
      // –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–≤—É–∫–∞
    }
  }
  
  // === –ó–≤—É–∫–∏ ===
  
  // Pop - –º—è–≥–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Ç–æ—Å—Ç–∞
  function playPop(ctx) {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    osc.frequency.setValueAtTime(600, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.1);
    osc.type = 'sine';
    
    gain.gain.setValueAtTime(0.08, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
    
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.1);
  }
  
  // Ding - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ (—Å–≤–∞–π–ø –≤–ª–µ–≤–æ)
  function playDing(ctx) {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    osc.frequency.setValueAtTime(659.25, ctx.currentTime); // E5
    osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.08); // G5
    osc.type = 'sine';
    
    gain.gain.setValueAtTime(0.06, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
    
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.15);
  }
  
  // Success/Achievement - –º–∞–∂–æ—Ä–Ω—ã–π –∞–∫–∫–æ—Ä–¥ C-E-G
  function playSuccess(ctx) {
    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5 (C major)
    const duration = 0.35;
    
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      osc.type = 'sine';
      
      const startTime = ctx.currentTime + i * 0.05;
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(0.07, startTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
      
      osc.start(startTime);
      osc.stop(startTime + duration);
    });
  }
  
  // Warning - –Ω–∏–∑–∫–∏–π —Ç–æ–Ω A3 ‚Üí G3
  function playWarning(ctx) {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    osc.frequency.setValueAtTime(220, ctx.currentTime); // A3
    osc.frequency.setValueAtTime(196, ctx.currentTime + 0.1); // G3
    osc.type = 'triangle';
    
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
    
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.2);
  }
  
  // Whoosh - —Å–≤–∞–π–ø (—Å–∫—Ä—ã—Ç—å)
  function playWhoosh(ctx) {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const filter = ctx.createBiquadFilter();
    
    osc.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.15);
    
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(2000, ctx.currentTime);
    filter.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.15);
    
    gain.gain.setValueAtTime(0.05, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
    
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.15);
  }
  
  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.sounds = {
    play,
    isEnabled: isSoundEnabled,
    // –ê–ª–∏–∞—Å—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    pop: () => play('pop'),
    ding: () => play('ding'),
    success: () => play('success'),
    warning: () => play('warning'),
    whoosh: () => play('whoosh')
  };
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_expandable_card_v1.js ===== */
// heys_expandable_card_v1.js ‚Äî –ú–æ–¥—É–ª—å–Ω—ã–π expandable card –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2025-12-04
// –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –∫–∞—Ä—Ç–æ—á–µ–∫
(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  
  // === –¶–≤–µ—Ç–∞ –∏ —Å—Ç–∏–ª–∏ ===
  const COLORS = {
    primary: '#3b82f6',
    success: '#22c55e',
    warning: '#eab308',
    error: '#ef4444',
    info: '#0ea5e9',
    muted: '#64748b',
    border: '#e5e7eb',
    bgLight: '#f8fafc',
    bgDark: '#1e293b'
  };
  
  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const utils = {
    // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID
    generateId: (prefix = 'card') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    formatDuration: (minutes) => {
      if (minutes < 60) return `${Math.round(minutes)} –º–∏–Ω`;
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      return m > 0 ? `${h}—á ${m}–º` : `${h}—á`;
    },
    
    // Haptic feedback
    haptic: (type = 'light') => {
      try {
        if (HEYS.dayUtils?.haptic) {
          HEYS.dayUtils.haptic(type);
        } else if (navigator.vibrate) {
          const patterns = { light: 10, medium: 20, success: [10, 50, 10], warning: [20, 30, 20] };
          navigator.vibrate(patterns[type] || 10);
        }
      } catch (e) {}
    }
  };
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Section ‚Äî –±–ª–æ–∫ –≤–Ω—É—Ç—Ä–∏ expanded ===
  const Section = ({ title, icon, children, style, className = '' }) => {
    return React.createElement('div', {
      className: `expandable-section ${className}`,
      style: {
        marginTop: '8px',
        padding: '8px',
        background: 'rgba(255,255,255,0.5)',
        borderRadius: '8px',
        ...style
      }
    },
      title && React.createElement('div', {
        style: {
          fontWeight: '600',
          fontSize: '12px',
          color: COLORS.primary,
          marginBottom: '4px',
          display: 'flex',
          alignItems: 'center',
          gap: '4px'
        }
      }, icon && React.createElement('span', null, icon), title),
      children
    );
  };
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç InfoRow ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å label: value ===
  const InfoRow = ({ label, value, icon, color, bold = false }) => {
    return React.createElement('div', {
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '2px 0',
        fontSize: '12px',
        color: COLORS.muted
      }
    },
      React.createElement('span', null, 
        icon && React.createElement('span', { style: { marginRight: '4px' } }, icon),
        label
      ),
      React.createElement('span', {
        style: {
          fontWeight: bold ? '600' : '500',
          color: color || 'inherit'
        }
      }, value)
    );
  };
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Badge ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π –ª–µ–π–±–ª ===
  const Badge = ({ text, color = COLORS.primary, bg, size = 'sm' }) => {
    const bgColor = bg || (color + '20');
    const fontSize = size === 'sm' ? '10px' : size === 'md' ? '12px' : '14px';
    const padding = size === 'sm' ? '2px 6px' : size === 'md' ? '4px 8px' : '6px 12px';
    
    return React.createElement('span', {
      style: {
        background: bgColor,
        color: color,
        padding,
        borderRadius: '4px',
        fontSize,
        fontWeight: '600',
        whiteSpace: 'nowrap'
      }
    }, text);
  };
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç ProgressBar ===
  const ProgressBar = ({ 
    progress, 
    color = COLORS.primary, 
    bgColor = '#e5e7eb',
    height = 8,
    showLabel = false,
    labelPosition = 'inside', // 'inside' | 'right' | 'above'
    animated = true,
    gradient = null // { from, to }
  }) => {
    const pct = Math.min(100, Math.max(0, progress));
    const fillColor = gradient 
      ? `linear-gradient(90deg, ${gradient.from}, ${gradient.to})`
      : color;
    
    return React.createElement('div', {
      style: {
        position: 'relative',
        width: '100%',
        height: `${height}px`,
        background: bgColor,
        borderRadius: `${height / 2}px`,
        overflow: 'hidden'
      }
    },
      // Fill
      React.createElement('div', {
        style: {
          position: 'absolute',
          left: 0,
          top: 0,
          height: '100%',
          width: `${pct}%`,
          background: fillColor,
          borderRadius: `${height / 2}px`,
          transition: animated ? 'width 0.5s ease-out' : 'none'
        }
      }),
      // Label inside
      showLabel && labelPosition === 'inside' && pct > 15 && React.createElement('div', {
        style: {
          position: 'absolute',
          left: '50%',
          top: '50%',
          transform: 'translate(-50%, -50%)',
          fontSize: height > 12 ? '10px' : '8px',
          fontWeight: '700',
          color: pct > 50 ? '#fff' : COLORS.muted,
          textShadow: pct > 50 ? '0 1px 2px rgba(0,0,0,0.3)' : 'none'
        }
      }, `${Math.round(pct)}%`)
    );
  };
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Alert ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ/–∏–Ω—Ñ–æ ===
  const Alert = ({ type = 'info', title, children, icon }) => {
    const colors = {
      info: { bg: 'rgba(59,130,246,0.1)', border: '#93c5fd', text: '#3b82f6' },
      success: { bg: 'rgba(34,197,94,0.1)', border: '#86efac', text: '#22c55e' },
      warning: { bg: 'rgba(234,179,8,0.15)', border: '#fcd34d', text: '#d97706' },
      error: { bg: 'rgba(239,68,68,0.15)', border: '#fca5a5', text: '#dc2626' }
    };
    const c = colors[type] || colors.info;
    const defaultIcons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: 'üö®' };
    
    return React.createElement('div', {
      style: {
        marginTop: '8px',
        padding: '8px',
        background: c.bg,
        border: `1px solid ${c.border}`,
        borderRadius: '8px',
        fontSize: '12px'
      }
    },
      title && React.createElement('div', {
        style: { fontWeight: '600', color: c.text, marginBottom: children ? '4px' : 0 }
      }, icon || defaultIcons[type], ' ', title),
      children && React.createElement('div', {
        style: { color: COLORS.muted }
      }, children)
    );
  };
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç StatusBadge ‚Äî —Å—Ç–∞—Ç—É—Å —Å —Ü–≤–µ—Ç–æ–º –∏ –ø—É–ª—å—Å–∞—Ü–∏–µ–π ===
  const StatusBadge = ({ status, text, color, pulse = false }) => {
    return React.createElement('div', {
      style: {
        display: 'flex',
        alignItems: 'center',
        gap: '6px'
      }
    },
      React.createElement('span', {
        style: {
          width: '10px',
          height: '10px',
          borderRadius: '50%',
          background: color,
          animation: pulse ? 'pulse 1.5s ease-in-out infinite' : 'none'
        }
      }),
      React.createElement('span', {
        style: { fontWeight: '600', color }
      }, text)
    );
  };
  
  // === –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ExpandableCard ===
  const ExpandableCard = ({ 
    // –û—Å–Ω–æ–≤–Ω—ã–µ props
    id,
    expanded = false,
    onToggle,
    disabled = false,
    
    // Header
    icon,
    title,
    subtitle,
    status, // { text, color, pulse }
    badge, // { text, color }
    rightContent, // custom content –Ω–∞ –º–µ—Å—Ç–µ —Ç–∞–π–º–µ—Ä–∞
    
    // Progress
    progress, // 0-100
    progressColor,
    progressGradient,
    
    // Meta info –ø–æ–¥ progress
    leftMeta,
    centerMeta,
    rightMeta,
    
    // Hint/suggestion
    hint,
    
    // Expanded content
    children, // expanded content
    expandedSections = [], // –º–∞—Å—Å–∏–≤ { title, icon, content }
    
    // Style
    className = '',
    style = {},
    variant = 'default', // 'default' | 'compact' | 'prominent'
    shake = false
  }) => {
    const handleClick = (e) => {
      if (disabled) return;
      utils.haptic('light');
      if (onToggle) onToggle(!expanded);
    };
    
    const handleExpandedClick = (e) => {
      e.stopPropagation();
    };
    
    const cardClass = [
      'expandable-card',
      `expandable-card--${variant}`,
      expanded && 'expandable-card--expanded',
      disabled && 'expandable-card--disabled',
      shake && 'shake',
      className
    ].filter(Boolean).join(' ');
    
    return React.createElement('div', {
      className: cardClass,
      style: {
        margin: '8px 0',
        padding: '12px',
        background: 'var(--card, #fff)',
        borderRadius: '12px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
        cursor: disabled ? 'default' : 'pointer',
        transition: 'all 0.2s ease',
        ...style
      },
      onClick: handleClick
    },
      // Header row
      React.createElement('div', {
        style: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: (progress !== undefined || leftMeta || hint) ? '8px' : 0
        }
      },
        // Left: icon + title
        React.createElement('div', {
          style: { display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }
        },
          icon && React.createElement('span', { style: { fontSize: '18px' } }, icon),
          React.createElement('div', null,
            React.createElement('div', {
              style: { fontWeight: '600', fontSize: '14px', color: 'var(--text, #1e293b)' }
            }, 
              title,
              // Expand indicator
              !disabled && React.createElement('span', {
                style: { fontSize: '10px', color: '#94a3b8', marginLeft: '4px' }
              }, expanded ? '‚ñ≤' : '‚ñº')
            ),
            subtitle && React.createElement('div', {
              style: { fontSize: '11px', color: COLORS.muted }
            }, subtitle)
          )
        ),
        
        // Right: badge, status or custom
        rightContent || (
          status ? React.createElement('div', {
            style: { color: status.color, fontWeight: '600', fontSize: '16px' }
          }, 
            status.pulse 
              ? React.createElement('span', { className: 'ready-pulse' }, '‚óè')
              : status.text
          ) : badge ? Badge({ text: badge.text, color: badge.color }) : null
        )
      ),
      
      // Progress bar
      progress !== undefined && ProgressBar({
        progress,
        color: progressColor,
        gradient: progressGradient,
        height: 10,
        showLabel: true,
        animated: true
      }),
      
      // Meta row
      (leftMeta || centerMeta || rightMeta) && React.createElement('div', {
        style: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginTop: '6px',
          fontSize: '11px',
          color: COLORS.muted
        }
      },
        React.createElement('span', null, leftMeta),
        centerMeta && Badge({ text: centerMeta.text, color: centerMeta.color }),
        React.createElement('span', null, rightMeta)
      ),
      
      // Hint
      hint && React.createElement('div', {
        style: {
          marginTop: '6px',
          fontSize: '12px',
          color: COLORS.muted,
          background: 'rgba(0,0,0,0.03)',
          padding: '6px 10px',
          borderRadius: '6px'
        }
      }, hint),
      
      // Expanded content
      expanded && React.createElement('div', {
        className: 'expandable-card__content',
        style: {
          marginTop: '12px',
          paddingTop: '12px',
          borderTop: `1px solid ${COLORS.border}`,
          animation: 'slideDown 0.2s ease-out'
        },
        onClick: handleExpandedClick
      },
        // Sections from array
        expandedSections.map((section, i) => 
          Section({
            key: section.id || i,
            title: section.title,
            icon: section.icon,
            style: section.style,
            children: section.content
          })
        ),
        // Custom children
        children
      )
    );
  };
  
  // === Hook useExpandable ‚Äî –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º ===
  const useExpandable = (initialState = false) => {
    const [expanded, setExpanded] = React.useState(initialState);
    const toggle = React.useCallback(() => setExpanded(prev => !prev), []);
    const open = React.useCallback(() => setExpanded(true), []);
    const close = React.useCallback(() => setExpanded(false), []);
    
    return { expanded, setExpanded, toggle, open, close };
  };
  
  // === –≠–∫—Å–ø–æ—Ä—Ç ===
  HEYS.ExpandableCard = {
    // –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    Card: ExpandableCard,
    
    // Sub-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ expanded
    Section,
    InfoRow,
    Badge,
    ProgressBar,
    Alert,
    StatusBadge,
    
    // Hook
    useExpandable,
    
    // –£—Ç–∏–ª–∏—Ç—ã
    utils,
    
    // –¶–≤–µ—Ç–∞
    COLORS,
    
    // –í–µ—Ä—Å–∏—è
    VERSION: '1.0.0'
  };
  
  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ‚Äî –∞–ª–∏–∞—Å
  HEYS.EC = HEYS.ExpandableCard;
  
  // Verbose init log removed
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_shim.js ===== */
// heys_iw_shim.js ‚Äî Insulin Wave Module Shim
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-11
//
// –¶–ï–õ–¨: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ namespace –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ InsulinWave
// 
// –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
// 1. –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ ‚Äî —Ç–æ–ª—å–∫–æ __internals
// 2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
// 3. –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π HEYS.InsulinWave –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –º–æ–Ω–æ–ª–∏—Ç
//
// –°–¢–†–£–ö–¢–£–†–ê:
// HEYS.InsulinWave = {
//   __internals: {
//     _loaded: { shim: true, constants: false, utils: false, ... },
//     _stubs: {} // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
//   }
// }

(function(global) {
  'use strict';
  
  // –°–æ–∑–¥–∞—ë–º HEYS namespace –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  const HEYS = global.HEYS = global.HEYS || {};
  
  // –°–æ–∑–¥–∞—ë–º/–ø–æ–ª—É—á–∞–µ–º InsulinWave namespace
  // –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º –µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –º–æ–Ω–æ–ª–∏—Ç)
  const IW = HEYS.InsulinWave = HEYS.InsulinWave || {};
  
  // –°–æ–∑–¥–∞—ë–º alias IW (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
  if (!HEYS.IW) {
    HEYS.IW = IW;
  }
  
  // === –¢–û–õ–¨–ö–û __internals ‚Äî –ë–ï–ó –ü–£–ë–õ–ò–ß–ù–´–• –ö–õ–Æ–ß–ï–ô ===
  
  // –°–æ–∑–¥–∞—ë–º __internals –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  IW.__internals = IW.__internals || {};
  
  // –§–ª–∞–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
  IW.__internals._loaded = IW.__internals._loaded || {};
  
  // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ, –Ω–µ –ø—É–±–ª–∏—á–Ω—ã–µ)
  IW.__internals._stubs = IW.__internals._stubs || {};
  
  // –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ shim –∑–∞–≥—Ä—É–∂–µ–Ω
  IW.__internals._loaded.shim = true;
  
  // Verbose init log removed (as per plan requirements)
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_patterns.js ===== */
// heys_iw_patterns.js ‚Äî Insulin Wave regex patterns (string-based)
// Version: 1.0.0 | Date: 2026-01-16

(function (global) {
    'use strict';

    const IW = global.HEYS?.InsulinWave;
    const I = IW?.__internals;

    if (!I) {
        console.error('[IW patterns] Shim required');
        return;
    }

    if (!I._loaded?.shim) {
        console.error('[IW patterns] Shim must be loaded first');
        return;
    }

    I._configPatterns = {
        PROTEIN_BONUS_V2: {
            patterns: {
                animal: [
                    '/–≥–æ–≤—è–¥–∏–Ω–∞/i', '/—Å–≤–∏–Ω–∏–Ω–∞/i', '/–±–∞—Ä–∞–Ω–∏–Ω–∞/i', '/—Ç–µ–ª—è—Ç–∏–Ω–∞/i', '/–∫–æ–∑–ª—è—Ç–∏–Ω–∞/i',
                    '/—Å—Ç–µ–π–∫/i', '/—Ñ–∏–ª–µ/i', '/–≤—ã—Ä–µ–∑–∫–∞/i', '/–∞–Ω—Ç—Ä–µ–∫–æ—Ç/i', '/—Ä–µ–±—Ä–æ/i', '/–∫–∞—Ä–±–æ–Ω–∞–¥/i',
                    '/—Ñ–∞—Ä—à/i', '/–∫–æ—Ç–ª–µ—Ç[–∞—ã]/i', '/—à–∞—à–ª—ã–∫/i', '/–±–µ—Ñ—Å—Ç—Ä–æ–≥–∞–Ω/i',
                    '/beef/i', '/pork/i', '/lamb/i', '/meat/i', '/steak/i',
                    '/–∫—É—Ä–∏—Ü–∞/i', '/–∫—É—Ä–∏–Ω/i', '/–∫—É—Ä–∏—Ü/i', '/–∏–Ω–¥–µ–π–∫–∞/i', '/–∏–Ω–¥—é—à/i', '/—É—Ç–∫–∞/i', '/–≥—É—Å—å/i',
                    '/–≥—Ä—É–¥–∫–∞/i', '/–±–µ–¥—Ä–æ/i', '/–∫—Ä—ã–ª–æ/i', '/–≥–æ–ª–µ–Ω—å/i', '/–æ–∫–æ—Ä–æ—á–æ–∫/i',
                    '/chicken/i', '/turkey/i', '/duck/i', '/poultry/i',
                    '/—Ä—ã–±–∞/i', '/–ª–æ—Å–æ—Å—å/i', '/—Å—ë–º–≥–∞/i', '/—Ñ–æ—Ä–µ–ª—å/i', '/—Ç—É–Ω–µ—Ü/i', '/—Å–∫—É–º–±—Ä–∏—è/i',
                    '/—Ç—Ä–µ—Å–∫–∞/i', '/–º–∏–Ω—Ç–∞–π/i', '/–∫–∞–º–±–∞–ª–∞/i', '/–æ–∫—É–Ω—å/i', '/—Å—É–¥–∞–∫/i', '/—â—É–∫–∞/i',
                    '/–∫–∞—Ä–ø/i', '/—Å–æ–º/i', '/—Å–µ–ª—å–¥—å/i', '/—Å–µ–ª—ë–¥–∫–∞/i', '/–∫–∏–ª—å–∫–∞/i', '/—à–ø—Ä–æ—Ç—ã/i',
                    '/–∫—Ä–µ–≤–µ—Ç–∫–∏/i', '/–∫—Ä–∞–±—ã/i', '/–º–∏–¥–∏–∏/i', '/–∫–∞–ª—å–º–∞—Ä/i', '/–æ—Å—å–º–∏–Ω–æ–≥/i', '/—É—Å—Ç—Ä–∏—Ü—ã/i',
                    '/fish/i', '/salmon/i', '/tuna/i', '/shrimp/i', '/seafood/i',
                    '/—è–π—Ü–æ/i', '/—è–π—Ü–∞/i', '/—è–∏—á–Ω/i', '/–æ–º–ª–µ—Ç/i', '/–≥–ª–∞–∑—É–Ω—å—è/i', '/–ø–∞—à–æ—Ç/i',
                    '/egg/i', '/omelet/i',
                    '/—Ç–≤–æ—Ä–æ–≥/i', '/—Å—ã—Ä/i', '/–±—Ä—ã–Ω–∑–∞/i', '/cheese/i', '/cottage/i',
                    '/–∫–∞–∑–µ–∏–Ω/i', '/casein/i',
                    '/–ø–µ—á–µ–Ω—å/i', '/—Å–µ—Ä–¥—Ü–µ/i', '/—è–∑—ã–∫/i', '/–ø–æ—á–∫–∏/i', '/liver/i'
                ],
                whey: [
                    '/whey/i', '/—Å—ã–≤–æ—Ä–æ—Ç–æ—á–Ω/i', '/–∏–∑–æ–ª—è—Ç/i', '/isolate/i',
                    '/–ø—Ä–æ—Ç–µ–∏–Ω.*–∫–æ–∫—Ç–µ–π–ª—å/i', '/protein.*shake/i', '/protein.*powder/i',
                    '/\\bWPC\\b/i', '/\\bWPI\\b/i', '/\\bWPH\\b/i',
                    '/–≥–µ–π–Ω–µ—Ä/i', '/gainer/i'
                ],
                plant: [
                    '/–≥–æ—Ä–æ—Ö/i', '/–Ω—É—Ç/i', '/—á–µ—á–µ–≤–∏—Ü–∞/i', '/—Ñ–∞—Å–æ–ª—å/i', '/–±–æ–±—ã/i', '/—ç–¥–∞–º–∞–º–µ/i',
                    '/pea/i', '/chickpea/i', '/lentil/i', '/bean/i', '/legume/i',
                    '/—Å–æ—è/i', '/—Å–æ–µ–≤/i', '/—Ç–æ—Ñ—É/i', '/—Ç–µ–º–ø–µ/i', '/–Ω–∞—Ç—Ç–æ/i', '/–º–∏—Å–æ/i',
                    '/soy/i', '/tofu/i', '/tempeh/i', '/edamame/i',
                    '/–∫–∏–Ω–æ–∞/i', '/quinoa/i', '/–∞–º–∞—Ä–∞–Ω—Ç/i', '/amaranth/i',
                    '/–º–∏–Ω–¥–∞–ª—å/i', '/–∞—Ä–∞—Ö–∏—Å/i', '/—Ñ–∏—Å—Ç–∞—à–∫/i', '/–∫–µ—à—å—é/i', '/–≥—Ä–µ—Ü–∫.*–æ—Ä–µ—Ö/i',
                    '/—Å–µ–º–µ–Ω–∞.*—á–∏–∞/i', '/—Å–µ–º–µ–Ω–∞.*–∫–æ–Ω–æ–ø–ª/i', '/—Å–µ–º–µ–Ω–∞.*–ø–æ–¥—Å–æ–ª–Ω/i', '/—Å–µ–º–µ–Ω–∞.*—Ç—ã–∫–≤/i',
                    '/almond/i', '/peanut/i', '/cashew/i', '/chia/i', '/hemp/i',
                    '/–≥–æ—Ä–æ—Ö–æ–≤—ã–π.*–ø—Ä–æ—Ç–µ–∏–Ω/i', '/—Å–æ–µ–≤—ã–π.*–ø—Ä–æ—Ç–µ–∏–Ω/i', '/—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π.*–ø—Ä–æ—Ç–µ–∏–Ω/i',
                    '/pea.*protein/i', '/soy.*protein/i', '/plant.*protein/i', '/vegan.*protein/i',
                    '/—Å–µ–π—Ç–∞–Ω/i', '/seitan/i', '/–≥–ª—é—Ç–µ–Ω/i', '/gluten/i'
                ]
            }
        },
        LIQUID_FOOD: {
            patterns: [
                '/—Å–æ–∫\\b/i', '/\\b—Å–æ–∫–∞\\b/i', '/\\b—Å–æ–∫–∏\\b/i',
                '/—Å–º—É–∑–∏/i', '/–∫–æ–∫—Ç–µ–π–ª—å/i', '/shake/i',
                '/–º–æ–ª–æ–∫–æ/i', '/–∫–µ—Ñ–∏—Ä/i', '/—Ä—è–∂–µ–Ω–∫–∞/i', '/–∞–π—Ä–∞–Ω/i', '/—Ç–∞–Ω\\b/i',
                '/–π–æ–≥—É—Ä—Ç.*–ø–∏—Ç—å–µ–≤–æ–π/i', '/–ø–∏—Ç—å–µ–≤–æ–π.*–π–æ–≥—É—Ä—Ç/i',
                '/–∫–∞–∫–∞–æ/i', '/–≥–æ—Ä—è—á–∏–π —à–æ–∫–æ–ª–∞–¥/i',
                '/–±—É–ª—å–æ–Ω/i', '/—Å—É–ø.*–ø—é—Ä–µ/i', '/–∫—Ä–µ–º.*—Å—É–ø/i',
                '/–∫–æ–ª–∞/i', '/–ø–µ–ø—Å–∏/i', '/—Ñ–∞–Ω—Ç–∞/i', '/—Å–ø—Ä–∞–π—Ç/i', '/–ª–∏–º–æ–Ω–∞–¥/i', '/–≥–∞–∑–∏—Ä–æ–≤–∫–∞/i',
                '/—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫/i', '/energy/i',
                '/–ø—Ä–æ—Ç–µ–∏–Ω.*–∫–æ–∫—Ç–µ–π–ª—å/i', '/protein.*shake/i'
            ]
        },
        INSULINOGENIC_BONUS: {
            liquidDairy: {
                patterns: ['/–º–æ–ª–æ–∫–æ/i', '/–∫–µ—Ñ–∏—Ä/i', '/—Ä—è–∂–µ–Ω–∫–∞/i', '/–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∞/i', '/–∞–π—Ä–∞–Ω/i']
            },
            softDairy: {
                patterns: ['/–π–æ–≥—É—Ä—Ç/i', '/—Å–º–µ—Ç–∞–Ω–∞/i', '/—Å–ª–∏–≤–∫–∏/i', '/—Ç–≤–æ—Ä–æ–≥/i', '/—Ç–≤–æ—Ä–æ–∂–æ–∫/i']
            },
            hardDairy: {
                patterns: ['/—Å—ã—Ä/i', '/cheese/i', '/–ø–∞—Ä–º–µ–∑–∞–Ω/i', '/–º–æ—Ü–∞—Ä–µ–ª–ª–∞/i', '/—á–µ–¥–¥–µ—Ä/i']
            },
            protein: {
                patterns: [
                    '/–≥–æ–≤—è–¥–∏–Ω–∞/i', '/—Å–≤–∏–Ω–∏–Ω–∞/i', '/–∫—É—Ä–∏—Ü–∞/i', '/–∏–Ω–¥–µ–π–∫–∞/i', '/—Ä—ã–±–∞/i', '/–ª–æ—Å–æ—Å—å/i', '/—Ç—É–Ω–µ—Ü/i',
                    '/—Ç—Ä–µ—Å–∫–∞/i', '/–∫—Ä–µ–≤–µ—Ç–∫–∏/i', '/–º—è—Å–æ/i', '/—Å—Ç–µ–π–∫/i', '/—Ñ–∏–ª–µ/i', '/–≥—Ä—É–¥–∫–∞/i', '/—Ñ–∞—Ä—à/i'
                ]
            }
        },
        SPICY_FOOD: {
            patterns: [
                '/–ø–µ—Ä–µ—Ü.*—á–∏–ª–∏/i', '/—á–∏–ª–∏/i', '/—Ö–∞–ª–∞–ø–µ–Ω—å–æ/i', '/jalapeno/i',
                '/—Ç–∞–±–∞—Å–∫–æ/i', '/sriracha/i', '/—à—Ä–∏—Ä–∞—á–∞/i',
                '/–∫–∞—Ä—Ä–∏/i', '/curry/i', '/–≤–∞—Å–∞–±–∏/i', '/wasabi/i',
                '/–≥–æ—Ä—á–∏—Ü–∞.*–æ—Å—Ç—Ä–∞—è/i', '/—Ö—Ä–µ–Ω/i',
                '/–æ—Å—Ç—Ä—ã–π.*—Å–æ—É—Å/i', '/hot.*sauce/i',
                '/–∫–∏–º—á–∏/i', '/kimchi/i', '/–∞–¥–∂–∏–∫–∞/i',
                '/—Ö–∞—Ä–∏—Å—Å–∞/i', '/harissa/i'
            ]
        },
        ALCOHOL_BONUS: {
            patterns: [
                '/–≤–æ–¥–∫–∞/i', '/–≤–∏—Å–∫–∏/i', '/whisky/i', '/whiskey/i', '/–∫–æ–Ω—å—è–∫/i', '/cognac/i',
                '/—Ä–æ–º/i', '/rum/i', '/—Ç–µ–∫–∏–ª–∞/i', '/tequila/i', '/–¥–∂–∏–Ω/i', '/gin/i',
                '/–≤–∏–Ω–æ/i', '/wine/i', '/—à–∞–º–ø–∞–Ω—Å–∫–æ–µ/i', '/champagne/i', '/–ø—Ä–æ—Å–µ–∫–∫–æ/i',
                '/–ø–∏–≤–æ/i', '/beer/i', '/—ç–ª—å/i', '/ale/i', '/–ª–∞–≥–µ—Ä/i', '/lager/i',
                '/—Å–∏–¥—Ä/i', '/cider/i', '/–ª–∏–∫—ë—Ä/i', '/liqueur/i',
                '/–º–∞—Ä—Ç–∏–Ω–∏/i', '/–≤–µ—Ä–º—É—Ç/i', '/vermouth/i',
                '/–∫–æ–∫—Ç–µ–π–ª—å.*–∞–ª–∫–æ–≥–æ–ª/i', '/–∞–ª–∫–æ–≥–æ–ª.*–∫–æ–∫—Ç–µ–π–ª—å/i'
            ],
            strong: ['/–≤–æ–¥–∫–∞/i', '/–≤–∏—Å–∫–∏/i', '/–∫–æ–Ω—å—è–∫/i', '/—Ä–æ–º/i', '/—Ç–µ–∫–∏–ª–∞/i', '/–¥–∂–∏–Ω/i'],
            medium: ['/–≤–∏–Ω–æ/i', '/—à–∞–º–ø–∞–Ω—Å–∫–æ–µ/i', '/–ø—Ä–æ—Å–µ–∫–∫–æ/i', '/–º–∞—Ä—Ç–∏–Ω–∏/i', '/–≤–µ—Ä–º—É—Ç/i'],
            weak: ['/–ø–∏–≤–æ/i', '/—Å–∏–¥—Ä/i', '/—ç–ª—å/i']
        },
        CAFFEINE_BONUS: {
            patterns: [
                '/–∫–æ—Ñ–µ/i', '/coffee/i', '/—ç—Å–ø—Ä–µ—Å—Å–æ/i', '/espresso/i',
                '/–∫–∞–ø—É—á–∏–Ω–æ/i', '/cappuccino/i', '/–ª–∞—Ç—Ç–µ/i', '/latte/i',
                '/–∞–º–µ—Ä–∏–∫–∞–Ω–æ/i', '/americano/i', '/–º–æ–∫–∫–æ/i', '/mocha/i',
                '/—á–∞–π.*—á—ë—Ä–Ω—ã–π/i', '/—á—ë—Ä–Ω—ã–π.*—á–∞–π/i', '/black.*tea/i',
                '/—á–∞–π.*–∑–µ–ª—ë–Ω—ã–π/i', '/–∑–µ–ª—ë–Ω—ã–π.*—á–∞–π/i', '/green.*tea/i',
                '/–º–∞—Ç—á–∞/i', '/matcha/i', '/–ø—É—ç—Ä/i',
                '/—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫/i', '/energy.*drink/i', '/red.*bull/i', '/monster/i',
                '/–∫–æ–ª–∞/i', '/cola/i', '/–ø–µ–ø—Å–∏/i', '/pepsi/i'
            ]
        },
        FOOD_FORM_BONUS: {
            liquidPatterns: ['/—Å–æ–∫\\b/i', '/—Å–º—É–∑–∏/i', '/–∫–æ–∫—Ç–µ–π–ª—å/i', '/–Ω–∞–ø–∏—Ç–æ–∫/i'],
            processedPatterns: ['/—Ö–ª–æ–ø—å—è/i', '/–º—é—Å–ª–∏.*–≥–æ—Ç–æ–≤/i', '/–±—ã—Å—Ç—Ä.*–∫–∞—à–∞/i', '/–ø—é—Ä–µ.*–ø–∞–∫–µ—Ç/i'],
            wholePatterns: ['/—Å—ã—Ä–æ–π/i', '/—Å–≤–µ–∂–∏–π/i', '/—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω/i', '/–æ—Ä–µ—Ö/i', '/—Å–µ–º–µ–Ω–∞/i']
        },
        RESISTANT_STARCH_BONUS: {
            patterns: [
                '/—Ö–æ–ª–æ–¥–Ω.*—Ä–∏—Å/i', '/—Ä–∏—Å.*—Ö–æ–ª–æ–¥–Ω/i',
                '/—Ö–æ–ª–æ–¥–Ω.*–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å/i', '/–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å.*—Ö–æ–ª–æ–¥–Ω/i',
                '/–æ–∫—Ä–æ—à–∫–∞/i', '/—Å–∞–ª–∞—Ç.*–∫–∞—Ä—Ç–æ—Ñ–µ–ª/i', '/–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π.*—Å–∞–ª–∞—Ç/i',
                '/—Å—É—à–∏/i', '/—Ä–æ–ª–ª/i'
            ]
        },
        FOOD_TEMPERATURE_BONUS: {
            hot: {
                patterns: ['/—Å—É–ø/i', '/–±–æ—Ä—â/i', '/–≥–æ—Ä—è—á/i', '/–∫–∞—à–∞/i', '/–ø—é—Ä–µ(?!.*–ø–∞–∫–µ—Ç)/i', '/—Ä–∞–≥—É/i', '/–∂–∞—Ä–∫/i', '/–≤–∞—Ä–µ–Ω/i', '/—Ç—É—à–µ–Ω/i', '/–∑–∞–ø–µ—á–µ–Ω/i', '/–ø–µ—á–µ–Ω/i', '/–∂–∞—Ä–µ–Ω/i', '/–≥—Ä–∏–ª—å/i']
            },
            cold: {
                patterns: ['/—Ö–æ–ª–æ–¥–Ω/i', '/–º–æ—Ä–æ–∂–µ–Ω–æ–µ/i', '/ice.*cream/i', '/—Å–º—É–∑–∏/i', '/—Å–∞–ª–∞—Ç/i', '/–æ–∫—Ä–æ—à–∫–∞/i', '/–≥–∞—Å–ø–∞—á–æ/i', '/–æ—Ö–ª–∞–∂–¥/i']
            }
        }
    };

    I._loaded.patterns = true;
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_config_loader.js ===== */
// heys_iw_config_loader.js ‚Äî Insulin Wave config loader
// Version: 1.1.0 | Date: 2026-01-16
// v1.1.0: Inline JSON removed ‚Üí async fetch from /heys-iw-config.json + localStorage cache

(function (global) {
    'use strict';

    const IW = global.HEYS?.InsulinWave;
    const I = IW?.__internals;

    if (!I) {
        console.error('[IW config] Shim required');
        return;
    }

    if (!I._loaded?.shim) {
        console.error('[IW config] Shim must be loaded first');
        return;
    }

    const reviveInfinity = (value) => {
        if (value === 'Infinity') return Infinity;
        if (Array.isArray(value)) return value.map(reviveInfinity);
        if (value && typeof value === 'object') {
            const out = {};
            Object.entries(value).forEach(([k, v]) => {
                out[k] = reviveInfinity(v);
            });
            return out;
        }
        return value;
    };

    const compileRegex = (patternString) => {
        if (patternString instanceof RegExp) return patternString;
        if (typeof patternString !== 'string') return null;
        const match = patternString.match(/^\/(.*)\/([a-z]*)$/i);
        if (match) {
            try {
                return new RegExp(match[1], match[2] || 'i');
            } catch (e) {
                return null;
            }
        }
        try {
            return new RegExp(patternString, 'i');
        } catch (e) {
            return null;
        }
    };

    const compileRegexList = (list) => {
        if (!Array.isArray(list)) return [];
        return list.map(compileRegex).filter(Boolean);
    };

    const mergePatterns = (cfg) => {
        const patterns = I._configPatterns || {};

        if (patterns.PROTEIN_BONUS_V2?.patterns) {
            cfg.PROTEIN_BONUS_V2 = cfg.PROTEIN_BONUS_V2 || {};
            cfg.PROTEIN_BONUS_V2.patterns = {
                animal: compileRegexList(patterns.PROTEIN_BONUS_V2.patterns.animal),
                whey: compileRegexList(patterns.PROTEIN_BONUS_V2.patterns.whey),
                plant: compileRegexList(patterns.PROTEIN_BONUS_V2.patterns.plant)
            };
        }

        if (patterns.LIQUID_FOOD?.patterns) {
            cfg.LIQUID_FOOD = cfg.LIQUID_FOOD || {};
            cfg.LIQUID_FOOD.patterns = compileRegexList(patterns.LIQUID_FOOD.patterns);
        }

        if (patterns.INSULINOGENIC_BONUS) {
            cfg.INSULINOGENIC_BONUS = cfg.INSULINOGENIC_BONUS || {};
            Object.entries(patterns.INSULINOGENIC_BONUS).forEach(([key, value]) => {
                cfg.INSULINOGENIC_BONUS[key] = cfg.INSULINOGENIC_BONUS[key] || {};
                cfg.INSULINOGENIC_BONUS[key].patterns = compileRegexList(value.patterns || []);
            });
        }

        if (patterns.SPICY_FOOD?.patterns) {
            cfg.SPICY_FOOD = cfg.SPICY_FOOD || {};
            cfg.SPICY_FOOD.patterns = compileRegexList(patterns.SPICY_FOOD.patterns);
        }

        if (patterns.ALCOHOL_BONUS) {
            cfg.ALCOHOL_BONUS = cfg.ALCOHOL_BONUS || {};
            cfg.ALCOHOL_BONUS.patterns = compileRegexList(patterns.ALCOHOL_BONUS.patterns || []);
            cfg.ALCOHOL_BONUS.strong = compileRegexList(patterns.ALCOHOL_BONUS.strong || []);
            cfg.ALCOHOL_BONUS.medium = compileRegexList(patterns.ALCOHOL_BONUS.medium || []);
            cfg.ALCOHOL_BONUS.weak = compileRegexList(patterns.ALCOHOL_BONUS.weak || []);
        }

        if (patterns.CAFFEINE_BONUS?.patterns) {
            cfg.CAFFEINE_BONUS = cfg.CAFFEINE_BONUS || {};
            cfg.CAFFEINE_BONUS.patterns = compileRegexList(patterns.CAFFEINE_BONUS.patterns);
        }

        if (patterns.FOOD_FORM_BONUS) {
            cfg.FOOD_FORM_BONUS = cfg.FOOD_FORM_BONUS || {};
            cfg.FOOD_FORM_BONUS.liquidPatterns = compileRegexList(patterns.FOOD_FORM_BONUS.liquidPatterns || []);
            cfg.FOOD_FORM_BONUS.processedPatterns = compileRegexList(patterns.FOOD_FORM_BONUS.processedPatterns || []);
            cfg.FOOD_FORM_BONUS.wholePatterns = compileRegexList(patterns.FOOD_FORM_BONUS.wholePatterns || []);
        }

        if (patterns.RESISTANT_STARCH_BONUS?.patterns) {
            cfg.RESISTANT_STARCH_BONUS = cfg.RESISTANT_STARCH_BONUS || {};
            cfg.RESISTANT_STARCH_BONUS.patterns = compileRegexList(patterns.RESISTANT_STARCH_BONUS.patterns);
        }

        if (patterns.FOOD_TEMPERATURE_BONUS) {
            cfg.FOOD_TEMPERATURE_BONUS = cfg.FOOD_TEMPERATURE_BONUS || {};
            cfg.FOOD_TEMPERATURE_BONUS.hot = cfg.FOOD_TEMPERATURE_BONUS.hot || {};
            cfg.FOOD_TEMPERATURE_BONUS.cold = cfg.FOOD_TEMPERATURE_BONUS.cold || {};
            cfg.FOOD_TEMPERATURE_BONUS.hot.patterns = compileRegexList(patterns.FOOD_TEMPERATURE_BONUS.hot?.patterns || []);
            cfg.FOOD_TEMPERATURE_BONUS.cold.patterns = compileRegexList(patterns.FOOD_TEMPERATURE_BONUS.cold?.patterns || []);
        }

        return cfg;
    };

    const CONFIG_CACHE_KEY = 'heys_iw_config_cache_v1';
    const CONFIG_CACHE_META_KEY = 'heys_iw_config_cache_meta_v1';
    const CONFIG_CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24h
    const CONFIG_JSON_URL = '/heys-iw-config.json';

    const loadConfigFromCache = () => {
        try {
            const cached = localStorage.getItem(CONFIG_CACHE_KEY);
            const metaRaw = localStorage.getItem(CONFIG_CACHE_META_KEY);
            if (!cached || !metaRaw) return null;
            const meta = JSON.parse(metaRaw);
            if (!meta || !meta.ts || !meta.version) return null;
            if (Date.now() - meta.ts > CONFIG_CACHE_TTL_MS) return null;
            const parsed = JSON.parse(cached);
            if (!parsed || parsed.version !== meta.version) return null;
            return parsed;
        } catch (e) {
            return null;
        }
    };

    const saveConfigToCache = (rawConfig) => {
        try {
            localStorage.setItem(CONFIG_CACHE_KEY, JSON.stringify(rawConfig));
            const meta = { ts: Date.now(), version: rawConfig?.version || 'unknown' };
            localStorage.setItem(CONFIG_CACHE_META_KEY, JSON.stringify(meta));
        } catch (e) {
            // ignore cache write errors
        }
    };

    const applyConfig = (rawConfig, source) => {
        let config = reviveInfinity(rawConfig);
        config = mergePatterns(config);

        I._configSource = config;
        I._loaded.config = true;
        I._loaded.configError = false;
        I._loaded.configFallback = false;
        saveConfigToCache(rawConfig);
        console.info('[HEYS.IW] ‚úÖ Config loaded:', { source, version: rawConfig?.version });

        // Notify modules waiting for async config
        if (typeof CustomEvent !== 'undefined') {
            document.dispatchEvent(new CustomEvent('heys-iw-config-ready', {
                detail: { source, version: rawConfig?.version }
            }));
        }
    };

    const fetchConfigFromNetwork = () => {
        fetch(CONFIG_JSON_URL)
            .then(function (res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(function (data) {
                if (!data || typeof data !== 'object') throw new Error('Invalid JSON');
                applyConfig(data, 'network');
            })
            .catch(function (err) {
                console.warn('[HEYS.IW] ‚ö†Ô∏è Config fetch failed:', err.message);
                I._loaded.config = false;
                I._loaded.configError = true;
                I._loaded.configFallback = true;
                I._configSource = null;
            });
    };

    // Priority: global override ‚Üí localStorage cache ‚Üí async fetch
    const cachedConfig = loadConfigFromCache();
    const rawConfig = (global.__IW_CONFIG__ && typeof global.__IW_CONFIG__ === 'object')
        ? global.__IW_CONFIG__
        : cachedConfig;

    I._loaded.configVersionMismatch = false;

    if (rawConfig) {
        applyConfig(rawConfig, global.__IW_CONFIG__ ? 'global' : 'cache');
    } else {
        // No cached config ‚Äî fetch async from network
        I._loaded.config = false;
        I._loaded.configError = false;
        I._loaded.configFallback = true;
        I._configSource = null;
        console.info('[HEYS.IW] ‚úÖ No cached config, fetching from network...');
        fetchConfigFromNetwork();
    }
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_constants.js ===== */
// heys_iw_constants.js ‚Äî Insulin Wave Constants Module
// Version: 1.0.0 | Date: 2026-01-11
//
// PURPOSE: All configuration constants and their helper functions

(function (global) {
  'use strict';

  const IW = global.HEYS?.InsulinWave;
  const I = IW?.__internals;

  if (!I) {
    console.error('[IW constants] Shim required');
    return;
  }

  if (!I._loaded.shim) {
    console.error('[IW constants] Shim must be loaded first');
    return;
  }

  const C = I._configSource;

  // === CONSTANTS AND HELPER FUNCTIONS ===

  I.GI_CATEGORIES = C?.GI_CATEGORIES || {
    low: { min: 0, max: 35, multiplier: 0.85, color: '#22c55e', text: '–ù–∏–∑–∫–∏–π –ì–ò', desc: '–∫–æ—Ä–æ—Ç–∫–∞—è –≤–æ–ª–Ω–∞' },
    medium: { min: 36, max: 55, multiplier: 1.0, color: '#eab308', text: '–°—Ä–µ–¥–Ω–∏–π –ì–ò', desc: '–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è' },
    high: { min: 56, max: 70, multiplier: 1.1, color: '#f97316', text: '–í—ã—Å–æ–∫–∏–π –ì–ò', desc: '–¥–ª–∏–Ω–Ω–µ–µ' },
    veryHigh: { min: 71, max: 999, multiplier: 1.2, color: '#ef4444', text: '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π', desc: '–¥–æ–ª–≥–∞—è –≤–æ–ª–Ω–∞' }
  };

  I.STATUS_CONFIG = C?.STATUS_CONFIG || {
    // –õ–∏–ø–æ–ª–∏–∑ ‚Äî –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ! –ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –±–µ–∑ –µ–¥—ã = —Å–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞
    lipolysis: { emoji: 'üî•', color: '#22c55e', label: '–õ–∏–ø–æ–ª–∏–∑!' },
    // –ü–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤–æ–ª–Ω–∞ ‚Äî —Å–∫–æ—Ä–æ –ª–∏–ø–æ–ª–∏–∑
    almost: { emoji: '‚è≥', color: '#f97316', label: null },
    // –°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è
    soon: { emoji: 'üåä', color: '#eab308', label: null },
    // –í–æ–ª–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –∏–Ω—Å—É–ª–∏–Ω –≤—ã—Å–æ–∫–∏–π, –∂–∏—Ä –∑–∞–ø–∞—Å–∞–µ—Ç—Å—è
    active: { emoji: 'üìà', color: '#3b82f6', label: null }
  };

  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // –ë–µ–ª–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç (Nuttall et al. 1984, Floyd 1966)
  // –ù–æ –û–°–ù–û–í–ù–ê–Ø –ø—Ä–∏—á–∏–Ω–∞ –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã ‚Äî —É–≥–ª–µ–≤–æ–¥—ã. –ë–µ–ª–æ–∫ ‚Äî –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä.
  // üî¨ v3.7.5: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ ‚Äî —Å–Ω–∏–∂–µ–Ω—ã –±–æ–Ω—É—Å—ã (—Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç ~5-10%, –Ω–µ 15-25%)
  I.PROTEIN_BONUS = C?.PROTEIN_BONUS || {
    veryHigh: { threshold: 50, bonus: 0.12 },  // 50+ –≥ –±–µ–ª–∫–∞ ‚Üí +12% –∫ –≤–æ–ª–Ω–µ (–±—ã–ª–æ +25%)
    high: { threshold: 35, bonus: 0.08 },      // 35-50 –≥ ‚Üí +8% (–±—ã–ª–æ +15%)
    medium: { threshold: 20, bonus: 0.05 }     // 20-35 –≥ ‚Üí +5% (–±—ã–ª–æ +8%)
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï PROTEIN_BONUS_V2 ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ animal/plant (v4.0.0)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
  // - Animal protein: –≤—ã—Å–æ–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ BCAA ‚Üí —Å–∏–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç √ó1.8
  //   (Layman 2003, Nilsson 2004, van Loon 2000)
  // - Plant protein: –º–µ–Ω—å—à–µ leucine, –±–æ–ª—å—à–µ arginine ‚Üí √ó1.3 —ç—Ñ—Ñ–µ–∫—Ç–∞
  //   (Mariotti 2017, Tang 2009)
  // - Whey protein (—Å—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π) ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç √ó2.0
  //   (Nilsson 2004, Pal & Ellis 2010)
  I.PROTEIN_BONUS_V2 = C?.PROTEIN_BONUS_V2 || {
    // –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–æ —Ç–∏–ø—É –±–µ–ª–∫–∞
    animal: {
      multiplier: 1.8,    // √ó1.8 –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
      label: 'ü•© –ñ–∏–≤–æ—Ç–Ω—ã–π –±–µ–ª–æ–∫',
      desc: '–í—ã—Å–æ–∫–∏–π BCAA ‚Üí —Å–∏–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç'
    },
    plant: {
      multiplier: 1.3,    // √ó1.3 –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
      label: 'üå± –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π –±–µ–ª–æ–∫',
      desc: '–ù–∏–∑–∫–∏–π leucine ‚Üí —É–º–µ—Ä–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç'
    },
    whey: {
      multiplier: 2.0,    // √ó2.0 ‚Äî —Å—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω—ã–π
      label: 'ü•õ –°—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π –±–µ–ª–æ–∫',
      desc: '–ë—ã—Å—Ç—Ä–æ–µ —É—Å–≤–æ–µ–Ω–∏–µ ‚Üí –ø–∏–∫–æ–≤—ã–π –∏–Ω—Å—É–ª–∏–Ω'
    },
    mixed: {
      multiplier: 1.5,    // –°—Ä–µ–¥–Ω–µ–µ –¥–ª—è —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
      label: 'üçΩÔ∏è –°–º–µ—à–∞–Ω–Ω—ã–π –±–µ–ª–æ–∫',
      desc: '–ö–æ–º–±–∏–Ω–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤'
    },

    // –ë–∞–∑–æ–≤—ã–µ –ø–æ—Ä–æ–≥–∏ (–≥—Ä–∞–º–º—ã –±–µ–ª–∫–∞) ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
    thresholds: {
      veryHigh: 50,   // 50+ –≥
      high: 35,       // 35-50 –≥
      medium: 20      // 20-35 –≥
    },

    // –ë–∞–∑–æ–≤—ã–µ –±–æ–Ω—É—Å—ã (–¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è —Ç–∏–ø–∞)
    baseBonuses: {
      veryHigh: 0.07,   // base +7% ‚Üí animal +12.6%, plant +9.1%, whey +14%
      high: 0.05,       // base +5% ‚Üí animal +9%, plant +6.5%, whey +10%
      medium: 0.03      // base +3% ‚Üí animal +5.4%, plant +3.9%, whey +6%
    },

    // üîç –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –±–µ–ª–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞
    patterns: {
      // –ñ–∏–≤–æ—Ç–Ω—ã–π –±–µ–ª–æ–∫ (–º—è—Å–æ, —Ä—ã–±–∞, —è–π—Ü–∞, –º–æ–ª–æ—á–Ω—ã–µ)
      animal: [
        // –ú—è—Å–æ
        /–≥–æ–≤—è–¥–∏–Ω–∞/i, /—Å–≤–∏–Ω–∏–Ω–∞/i, /–±–∞—Ä–∞–Ω–∏–Ω–∞/i, /—Ç–µ–ª—è—Ç–∏–Ω–∞/i, /–∫–æ–∑–ª—è—Ç–∏–Ω–∞/i,
        /—Å—Ç–µ–π–∫/i, /—Ñ–∏–ª–µ/i, /–≤—ã—Ä–µ–∑–∫–∞/i, /–∞–Ω—Ç—Ä–µ–∫–æ—Ç/i, /—Ä–µ–±—Ä–æ/i, /–∫–∞—Ä–±–æ–Ω–∞–¥/i,
        /—Ñ–∞—Ä—à/i, /–∫–æ—Ç–ª–µ—Ç[–∞—ã]/i, /—à–∞—à–ª—ã–∫/i, /–±–µ—Ñ—Å—Ç—Ä–æ–≥–∞–Ω/i,
        /beef/i, /pork/i, /lamb/i, /meat/i, /steak/i,
        // –ü—Ç–∏—Ü–∞
        /–∫—É—Ä–∏—Ü–∞/i, /–∫—É—Ä–∏–Ω/i, /–∫—É—Ä–∏—Ü/i, /–∏–Ω–¥–µ–π–∫–∞/i, /–∏–Ω–¥—é—à/i, /—É—Ç–∫–∞/i, /–≥—É—Å—å/i,
        /–≥—Ä—É–¥–∫–∞/i, /–±–µ–¥—Ä–æ/i, /–∫—Ä—ã–ª–æ/i, /–≥–æ–ª–µ–Ω—å/i, /–æ–∫–æ—Ä–æ—á–æ–∫/i,
        /chicken/i, /turkey/i, /duck/i, /poultry/i,
        // –†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã  
        /—Ä—ã–±–∞/i, /–ª–æ—Å–æ—Å—å/i, /—Å—ë–º–≥–∞/i, /—Ñ–æ—Ä–µ–ª—å/i, /—Ç—É–Ω–µ—Ü/i, /—Å–∫—É–º–±—Ä–∏—è/i,
        /—Ç—Ä–µ—Å–∫–∞/i, /–º–∏–Ω—Ç–∞–π/i, /–∫–∞–º–±–∞–ª–∞/i, /–æ–∫—É–Ω—å/i, /—Å—É–¥–∞–∫/i, /—â—É–∫–∞/i,
        /–∫–∞—Ä–ø/i, /—Å–æ–º/i, /—Å–µ–ª—å–¥—å/i, /—Å–µ–ª—ë–¥–∫–∞/i, /–∫–∏–ª—å–∫–∞/i, /—à–ø—Ä–æ—Ç—ã/i,
        /–∫—Ä–µ–≤–µ—Ç–∫–∏/i, /–∫—Ä–∞–±—ã/i, /–º–∏–¥–∏–∏/i, /–∫–∞–ª—å–º–∞—Ä/i, /–æ—Å—å–º–∏–Ω–æ–≥/i, /—É—Å—Ç—Ä–∏—Ü—ã/i,
        /fish/i, /salmon/i, /tuna/i, /shrimp/i, /seafood/i,
        // –Ø–π—Ü–∞
        /—è–π—Ü–æ/i, /—è–π—Ü–∞/i, /—è–∏—á–Ω/i, /–æ–º–ª–µ—Ç/i, /–≥–ª–∞–∑—É–Ω—å—è/i, /–ø–∞—à–æ—Ç/i,
        /egg/i, /omelet/i,
        // –ú–æ–ª–æ—á–Ω—ã–µ (–±–µ–ª–æ–∫ –∏–∑ –º–æ–ª–æ—á–Ω—ã—Ö)
        /—Ç–≤–æ—Ä–æ–≥/i, /—Å—ã—Ä/i, /–±—Ä—ã–Ω–∑–∞/i, /cheese/i, /cottage/i,
        /–∫–∞–∑–µ–∏–Ω/i, /casein/i,
        // –°—É–±–ø—Ä–æ–¥—É–∫—Ç—ã
        /–ø–µ—á–µ–Ω—å/i, /—Å–µ—Ä–¥—Ü–µ/i, /—è–∑—ã–∫/i, /–ø–æ—á–∫–∏/i, /liver/i
      ],

      // –°—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π –±–µ–ª–æ–∫ (whey) ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
      whey: [
        /whey/i, /—Å—ã–≤–æ—Ä–æ—Ç–æ—á–Ω/i, /–∏–∑–æ–ª—è—Ç/i, /isolate/i,
        /–ø—Ä–æ—Ç–µ–∏–Ω.*–∫–æ–∫—Ç–µ–π–ª—å/i, /protein.*shake/i, /protein.*powder/i,
        /\bWPC\b/i, /\bWPI\b/i, /\bWPH\b/i,
        /–≥–µ–π–Ω–µ—Ä/i, /gainer/i
      ],

      // –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π –±–µ–ª–æ–∫
      plant: [
        // –ë–æ–±–æ–≤—ã–µ
        /–≥–æ—Ä–æ—Ö/i, /–Ω—É—Ç/i, /—á–µ—á–µ–≤–∏—Ü–∞/i, /—Ñ–∞—Å–æ–ª—å/i, /–±–æ–±—ã/i, /—ç–¥–∞–º–∞–º–µ/i,
        /pea/i, /chickpea/i, /lentil/i, /bean/i, /legume/i,
        // –°–æ–µ–≤—ã–µ
        /—Å–æ—è/i, /—Å–æ–µ–≤/i, /—Ç–æ—Ñ—É/i, /—Ç–µ–º–ø–µ/i, /–Ω–∞—Ç—Ç–æ/i, /–º–∏—Å–æ/i,
        /soy/i, /tofu/i, /tempeh/i, /edamame/i,
        // –ó–ª–∞–∫–∏ —Å –≤—ã—Å–æ–∫–∏–º –±–µ–ª–∫–æ–º
        /–∫–∏–Ω–æ–∞/i, /quinoa/i, /–∞–º–∞—Ä–∞–Ω—Ç/i, /amaranth/i,
        // –û—Ä–µ—Ö–∏ –∏ —Å–µ–º–µ–Ω–∞
        /–º–∏–Ω–¥–∞–ª—å/i, /–∞—Ä–∞—Ö–∏—Å/i, /—Ñ–∏—Å—Ç–∞—à–∫/i, /–∫–µ—à—å—é/i, /–≥—Ä–µ—Ü–∫.*–æ—Ä–µ—Ö/i,
        /—Å–µ–º–µ–Ω–∞.*—á–∏–∞/i, /—Å–µ–º–µ–Ω–∞.*–∫–æ–Ω–æ–ø–ª/i, /—Å–µ–º–µ–Ω–∞.*–ø–æ–¥—Å–æ–ª–Ω/i, /—Å–µ–º–µ–Ω–∞.*—Ç—ã–∫–≤/i,
        /almond/i, /peanut/i, /cashew/i, /chia/i, /hemp/i,
        // –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ç–µ–∏–Ω—ã
        /–≥–æ—Ä–æ—Ö–æ–≤—ã–π.*–ø—Ä–æ—Ç–µ–∏–Ω/i, /—Å–æ–µ–≤—ã–π.*–ø—Ä–æ—Ç–µ–∏–Ω/i, /—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π.*–ø—Ä–æ—Ç–µ–∏–Ω/i,
        /pea.*protein/i, /soy.*protein/i, /plant.*protein/i, /vegan.*protein/i,
        // –°–µ–π—Ç–∞–Ω (–ø—à–µ–Ω–∏—á–Ω—ã–π –≥–ª—é—Ç–µ–Ω)
        /—Å–µ–π—Ç–∞–Ω/i, /seitan/i, /–≥–ª—é—Ç–µ–Ω/i, /gluten/i
      ]
    },

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
    categories: {
      animal: ['–ú—è—Å–æ', '–†—ã–±–∞', '–ü—Ç–∏—Ü–∞', '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã', '–Ø–π—Ü–∞', 'Meat', 'Fish', 'Poultry', 'Seafood', 'Eggs'],
      plant: ['–ë–æ–±–æ–≤—ã–µ', '–û—Ä–µ—Ö–∏', '–°–µ–º–µ–Ω–∞', 'Legumes', 'Nuts', 'Seeds'],
      // –ú–æ–ª–æ—á–Ω—ã–µ ‚Äî –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π (–∫–∞–∑–µ–∏–Ω = animal, –Ω–æ –Ω–µ whey)
      dairy: ['–ú–æ–ª–æ—á–Ω—ã–µ', 'Dairy']
    }
  };

  /**
   * üÜï –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –±–µ–ª–∫–∞ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ (v4.0.0)
   * @param {Object} product - –ø—Ä–æ–¥—É–∫—Ç {name, category}
   * @returns {string} 'animal' | 'plant' | 'whey' | 'mixed'
   */
  I.detectProteinType = (product) => {
    if (!product) return 'mixed';

    const name = (product.name || '').toLowerCase();
    const category = product.category || '';

    // 1. Whey –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–ø–æ—Ä—Ç–ø–∏—Ç)
    for (const pattern of I.PROTEIN_BONUS_V2.patterns.whey) {
      if (pattern.test(name)) return 'whey';
    }

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π (–¥–æ animal, —Ç.–∫. "—Å–æ–µ–≤–æ–µ –º—è—Å–æ" = plant)
    for (const pattern of I.PROTEIN_BONUS_V2.patterns.plant) {
      if (pattern.test(name)) return 'plant';
    }

    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–∏–≤–æ—Ç–Ω—ã–π
    for (const pattern of I.PROTEIN_BONUS_V2.patterns.animal) {
      if (pattern.test(name)) return 'animal';
    }

    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (I.PROTEIN_BONUS_V2.categories.animal.includes(category)) return 'animal';
    if (I.PROTEIN_BONUS_V2.categories.plant.includes(category)) return 'plant';
    if (I.PROTEIN_BONUS_V2.categories.dairy.includes(category)) return 'animal'; // –∫–∞–∑–µ–∏–Ω

    // 5. –ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ ‚Äî mixed
    return 'mixed';
  };

  /**
   * üÜï –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å –±–µ–ª–∫–∞ —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞ (v4.0.0)
   * @param {number} proteinGrams - –≥—Ä–∞–º–º—ã –±–µ–ª–∫–∞
   * @param {string} proteinType - 'animal' | 'plant' | 'whey' | 'mixed'
   * @returns {Object} { bonus, baseBonus, multiplier, type, tier }
   */
  I.calculateProteinBonusV2 = (proteinGrams, proteinType = 'mixed') => {
    const cfg = I.PROTEIN_BONUS_V2;
    const thresholds = cfg.thresholds;
    const baseBonuses = cfg.baseBonuses;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º tier
    let tier = null;
    let baseBonus = 0;

    if (proteinGrams >= thresholds.veryHigh) {
      tier = 'veryHigh';
      baseBonus = baseBonuses.veryHigh;
    } else if (proteinGrams >= thresholds.high) {
      tier = 'high';
      baseBonus = baseBonuses.high;
    } else if (proteinGrams >= thresholds.medium) {
      tier = 'medium';
      baseBonus = baseBonuses.medium;
    } else {
      // –ú–µ–Ω—å—à–µ 20–≥ ‚Äî –Ω–µ—Ç –±–æ–Ω—É—Å–∞
      return { bonus: 0, baseBonus: 0, multiplier: 1, type: proteinType, tier: null };
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ç–∏–ø–∞
    const typeConfig = cfg[proteinType] || cfg.mixed;
    const multiplier = typeConfig.multiplier;
    const bonus = baseBonus * multiplier;

    return {
      bonus,        // –ò—Ç–æ–≥–æ–≤—ã–π –±–æ–Ω—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.126 = +12.6%)
      baseBonus,    // –ë–∞–∑–æ–≤—ã–π –¥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è
      multiplier,   // –ú–Ω–æ–∂–∏—Ç–µ–ª—å —Ç–∏–ø–∞ (1.8 –¥–ª—è animal)
      type: proteinType,
      tier,
      label: typeConfig.label,
      desc: typeConfig.desc
    };
  };

  // ============================================================================
  // üÜï WAVE_SHAPE_V2 ‚Äî Multi-component Gaussian Wave Model (v4.0.0)
  // ============================================================================
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Caumo et al. 2000 (PMID: 10780864)
  // –ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç = —Å—É–º–º–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å —Ä–∞–∑–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–æ–π:
  // - Fast (–ë—ã—Å—Ç—Ä—ã–π): –ø–µ—Ä–≤–∏—á–Ω—ã–π –≤—ã–±—Ä–æ—Å, –ø–∏–∫ ~15-30 –º–∏–Ω
  // - Slow (–ú–µ–¥–ª–µ–Ω–Ω—ã–π): –≤—Ç–æ—Ä–∏—á–Ω–∞—è —Å–µ–∫—Ä–µ—Ü–∏—è, –ø–∏–∫ ~60-90 –º–∏–Ω
  // - Hepatic (–ü–µ—á—ë–Ω–æ—á–Ω—ã–π): –∫–ª–∏—Ä–µ–Ω—Å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, –±–æ–ª–µ–µ –ø–ª–æ—Å–∫–∞—è –∫—Ä–∏–≤–∞—è
  // ============================================================================
  I.WAVE_SHAPE_V2 = C?.WAVE_SHAPE_V2 || {
    // –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Gaussian
    components: {
      fast: {
        // –ë—ã—Å—Ç—Ä—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî –ø–µ—Ä–≤–∞—è —Ñ–∞–∑–∞ —Å–µ–∫—Ä–µ—Ü–∏–∏
        peakOffset: 0.15,    // –ü–∏–∫ –Ω–∞ 15% –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã
        sigma: 0.12,         // –®–∏—Ä–∏–Ω–∞ –ø–∏–∫–∞ (œÉ)
        baseAmplitude: 0.6,  // –ë–∞–∑–æ–≤–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ (–≤–∫–ª–∞–¥ 60%)
        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
        giMultiplier: 1.3,   // –í—ã—Å–æ–∫–∏–π –ì–ò ‚Üí —É—Å–∏–ª–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        liquidBoost: 1.5,    // –ñ–∏–¥–∫–∞—è –ø–∏—â–∞ ‚Üí –µ—â—ë –±—ã—Å—Ç—Ä–µ–µ
        fiberDamping: 0.7    // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üí –∑–∞–º–µ–¥–ª—è–µ—Ç
      },
      slow: {
        // –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî –≤—Ç–æ—Ä–∏—á–Ω–∞—è —Å–µ–∫—Ä–µ—Ü–∏—è
        peakOffset: 0.45,    // –ü–∏–∫ –Ω–∞ 45% –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã
        sigma: 0.25,         // –ë–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –ø–∏–∫
        baseAmplitude: 0.35, // –í–∫–ª–∞–¥ 35%
        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
        proteinBoost: 1.4,   // –ë–µ–ª–æ–∫ —É—Å–∏–ª–∏–≤–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        fatBoost: 1.3,       // –ñ–∏—Ä—ã —Ç–æ–∂–µ
        complexCarbBoost: 1.2 // –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã
      },
      hepatic: {
        // –ü–µ—á—ë–Ω–æ—á–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî –±–∞–∑–∞–ª—å–Ω–∞—è —Å–µ–∫—Ä–µ—Ü–∏—è –∏ –∫–ª–∏—Ä–µ–Ω—Å
        peakOffset: 0.70,    // –ü–æ–∑–∂–µ –≤ –≤–æ–ª–Ω–µ
        sigma: 0.35,         // –°–∞–º—ã–π —à–∏—Ä–æ–∫–∏–π
        baseAmplitude: 0.05, // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ 5%
        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
        insulinResistanceBoost: 1.5, // IR —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        alcoholBoost: 1.3    // –ê–ª–∫–æ–≥–æ–ª—å –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–µ—á—ë–Ω–æ—á–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º
      }
    },

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
    composition: {
      baselineLevel: 0.05,   // –ë–∞–∑–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (5% –æ—Ç –ø–∏–∫–∞)
      normalizeToOne: true,  // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∏–∫ –∫ 1.0
      samplePoints: 100      // –¢–æ—á–µ–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫—Ä–∏–≤–æ–π
    },

    // –ü–æ—Ä–æ–≥–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã –≤–æ–ª–Ω—ã
    shapeCategories: {
      spike: { fastRatio: 0.7, desc: '–†–µ–∑–∫–∏–π –ø–∏–∫ (–±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã)' },
      balanced: { fastRatio: 0.5, desc: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–æ–ª–Ω–∞' },
      prolonged: { fastRatio: 0.3, desc: '–†–∞—Å—Ç—è–Ω—É—Ç–∞—è –≤–æ–ª–Ω–∞ (–º–Ω–æ–≥–æ –±–µ–ª–∫–∞/–∂–∏—Ä–æ–≤)' }
    }
  };

  /**
   * üÜï –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Gaussian –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–æ–ª–Ω—ã
   * @param {number} t - –≤—Ä–µ–º—è (0-1, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ)
   * @param {number} peak - –ø–æ–∑–∏—Ü–∏—è –ø–∏–∫–∞ (0-1)
   * @param {number} sigma - —à–∏—Ä–∏–Ω–∞ (œÉ)
   * @param {number} amplitude - –∞–º–ø–ª–∏—Ç—É–¥–∞
   * @returns {number} –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ç–æ—á–∫–µ t
   */
  I.gaussianComponent = (t, peak, sigma, amplitude) => {
    return amplitude * Math.exp(-Math.pow(t - peak, 2) / (2 * sigma * sigma));
  };

  /**
   * üÜï –†–∞—Å—á—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–∏—ë–º–∞
   * @param {Object} nutrients - { carbs, simple, complex, protein, fat, fiber, gi }
   * @param {Object} context - { isLiquid, irScore, hasAlcohol }
   * @returns {Object} –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   */
  I.calculateComponentParams = (nutrients, context = {}) => {
    const cfg = I.WAVE_SHAPE_V2.components;
    const { carbs = 0, simple = 0, complex = 0, protein = 0, fat = 0, fiber = 0, gi = 50 } = nutrients;
    const { isLiquid = false, irScore = 0, hasAlcohol = false } = context;

    // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
    const simpleRatio = carbs > 0 ? simple / carbs : 0;
    const totalMacros = carbs + protein + fat;
    const proteinRatio = totalMacros > 0 ? protein / totalMacros : 0;
    const fatRatio = totalMacros > 0 ? fat / totalMacros : 0;

    // === Fast –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ===
    let fastAmplitude = cfg.fast.baseAmplitude;
    let fastSigma = cfg.fast.sigma;
    let fastPeak = cfg.fast.peakOffset;

    // –í—ã—Å–æ–∫–∏–π –ì–ò ‚Üí –±–æ–ª—å—à–µ –±—ã—Å—Ç—Ä—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    if (gi > 70) fastAmplitude *= cfg.fast.giMultiplier;
    // –ú–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Üí –µ—â—ë –≤—ã—à–µ
    if (simpleRatio > 0.5) fastAmplitude *= 1 + (simpleRatio - 0.5);
    // –ñ–∏–¥–∫–∞—è –ø–∏—â–∞ ‚Üí –±—ã—Å—Ç—Ä–µ–µ –∏ –æ—Å—Ç—Ä–µ–µ
    if (isLiquid) {
      fastAmplitude *= cfg.fast.liquidBoost;
      fastSigma *= 0.8; // –£–∂–µ –ø–∏–∫
      fastPeak *= 0.8;  // –†–∞–Ω—å—à–µ –ø–∏–∫
    }
    // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ ‚Üí –¥–µ–º–ø—Ñ–∏—Ä—É–µ—Ç
    if (fiber >= 5) {
      fastAmplitude *= cfg.fast.fiberDamping;
      fastSigma *= 1.2; // –®–∏—Ä–µ –ø–∏–∫
    }

    // === Slow –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ===
    let slowAmplitude = cfg.slow.baseAmplitude;
    let slowSigma = cfg.slow.sigma;
    let slowPeak = cfg.slow.peakOffset;

    // –ë–µ–ª–æ–∫ —É—Å–∏–ª–∏–≤–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    if (protein >= 20) slowAmplitude *= cfg.slow.proteinBoost;
    // –ñ–∏—Ä—ã —Ç–æ–∂–µ
    if (fat >= 15) slowAmplitude *= cfg.slow.fatBoost;
    // –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã
    if (complex > simple) slowAmplitude *= cfg.slow.complexCarbBoost;

    // === Hepatic –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ===
    let hepaticAmplitude = cfg.hepatic.baseAmplitude;
    let hepaticSigma = cfg.hepatic.sigma;
    let hepaticPeak = cfg.hepatic.peakOffset;

    // –ò–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    if (irScore > 0.3) hepaticAmplitude *= cfg.hepatic.insulinResistanceBoost * (1 + irScore);
    // –ê–ª–∫–æ–≥–æ–ª—å –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–µ—á—ë–Ω–æ—á–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º
    if (hasAlcohol) hepaticAmplitude *= cfg.hepatic.alcoholBoost;

    return {
      fast: { amplitude: fastAmplitude, sigma: fastSigma, peak: fastPeak },
      slow: { amplitude: slowAmplitude, sigma: slowSigma, peak: slowPeak },
      hepatic: { amplitude: hepaticAmplitude, sigma: hepaticSigma, peak: hepaticPeak }
    };
  };

  /**
   * üÜï –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π –∫—Ä–∏–≤–æ–π –≤–æ–ª–Ω—ã (Multi-component Gaussian)
   * @param {number} waveMinutes - –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
   * @param {Object} nutrients - —Å–æ—Å—Ç–∞–≤ –ø—Ä–∏—ë–º–∞
   * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç (IR, –∂–∏–¥–∫–æ—Å—Ç—å –∏ —Ç.–¥.)
   * @returns {Object} { curve, peak, auc, shape, components }
   */
  I.generateWaveCurve = (waveMinutes, nutrients, context = {}) => {
    const cfg = I.WAVE_SHAPE_V2;
    const params = I.calculateComponentParams(nutrients, context);
    const points = cfg.composition.samplePoints;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∏–≤—É—é
    const curve = [];
    let maxValue = 0;
    let sumValue = 0;
    let peakTime = 0;

    for (let i = 0; i <= points; i++) {
      const t = i / points; // 0 to 1

      // –°—É–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      const fastValue = I.gaussianComponent(t, params.fast.peak, params.fast.sigma, params.fast.amplitude);
      const slowValue = I.gaussianComponent(t, params.slow.peak, params.slow.sigma, params.slow.amplitude);
      const hepaticValue = I.gaussianComponent(t, params.hepatic.peak, params.hepatic.sigma, params.hepatic.amplitude);

      const totalValue = cfg.composition.baselineLevel + fastValue + slowValue + hepaticValue;

      curve.push({
        t,
        minutes: Math.round(t * waveMinutes),
        value: totalValue,
        components: { fast: fastValue, slow: slowValue, hepatic: hepaticValue }
      });

      sumValue += totalValue;
      if (totalValue > maxValue) {
        maxValue = totalValue;
        peakTime = t;
      }
    }

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 1.0 –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
    if (cfg.composition.normalizeToOne && maxValue > 0) {
      curve.forEach(point => {
        point.value /= maxValue;
        point.components.fast /= maxValue;
        point.components.slow /= maxValue;
        point.components.hepatic /= maxValue;
      });
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É –≤–æ–ª–Ω—ã
    const fastContribution = params.fast.amplitude / (params.fast.amplitude + params.slow.amplitude + params.hepatic.amplitude);
    let shape = 'balanced';
    if (fastContribution >= cfg.shapeCategories.spike.fastRatio) shape = 'spike';
    else if (fastContribution <= cfg.shapeCategories.prolonged.fastRatio) shape = 'prolonged';

    // AUC (–ø–ª–æ—â–∞–¥—å –ø–æ–¥ –∫—Ä–∏–≤–æ–π, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è)
    const auc = sumValue / (points + 1);

    return {
      curve,                              // –ú–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ –∫—Ä–∏–≤–æ–π
      peakTime,                           // –í—Ä–µ–º—è –ø–∏–∫–∞ (0-1)
      peakMinutes: Math.round(peakTime * waveMinutes), // –í—Ä–µ–º—è –ø–∏–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
      auc,                                // –ü–ª–æ—â–∞–¥—å –ø–æ–¥ –∫—Ä–∏–≤–æ–π
      shape,                              // 'spike' | 'balanced' | 'prolonged'
      shapeDesc: cfg.shapeCategories[shape]?.desc || '',
      components: params,                 // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      fastContribution,                   // –í–∫–ª–∞–¥ –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (0-1)
      waveMinutes                         // –î–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
    };
  };

  // ============================================================================
  // üÜï AUC_CALCULATION_V2 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø–ª–æ—â–∞–¥–∏ –ø–æ–¥ –∫—Ä–∏–≤–æ–π (v4.0.0)
  // ============================================================================
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Brouns et al. 2005 (PMID: 16034360)
  // AUC = –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
  // –ü–æ–ª–µ–∑–Ω–µ–µ —á–µ–º –ø—Ä–æ—Å—Ç–æ "–ø–∏–∫" –∏–ª–∏ "–¥–ª–∏–Ω–∞" –≤–æ–ª–Ω—ã
  // ============================================================================
  I.AUC_CONFIG = C?.AUC_CONFIG || {
    // –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á—ë—Ç–∞
    methods: {
      trapezoidal: true,     // –ú–µ—Ç–æ–¥ —Ç—Ä–∞–ø–µ—Ü–∏–π (–æ—Å–Ω–æ–≤–Ω–æ–π)
      simpson: false,        // –ú–µ—Ç–æ–¥ –°–∏–º–ø—Å–æ–Ω–∞ (—Ç–æ—á–Ω–µ–µ –¥–ª—è –≥–ª–∞–¥–∫–∏—Ö –∫—Ä–∏–≤—ã—Ö)
      incremental: true      // iAUC ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥ –±–∞–∑–æ–π
    },
    // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ AUC
    segments: {
      early: { start: 0, end: 0.25, label: '–†–∞–Ω–Ω–∏–π (0-25%)' },
      peak: { start: 0.15, end: 0.50, label: '–ü–∏–∫–æ–≤—ã–π (15-50%)' },
      late: { start: 0.50, end: 1.0, label: '–ü–æ–∑–¥–Ω–∏–π (50-100%)' }
    },
    // –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    reference: {
      glucose50g: 1.0,       // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: 50–≥ –≥–ª—é–∫–æ–∑—ã = 1.0
      whiteRice200g: 0.85,   // –ë–µ–ª—ã–π —Ä–∏—Å 200–≥ = 0.85 –æ—Ç –≥–ª—é–∫–æ–∑—ã
      oatmeal100g: 0.45      // –û–≤—Å—è–Ω–∫–∞ 100–≥ = 0.45 –æ—Ç –≥–ª—é–∫–æ–∑—ã
    }
  };

  /**
   * üÜï –†–∞—Å—á—ë—Ç AUC –º–µ—Ç–æ–¥–æ–º —Ç—Ä–∞–ø–µ—Ü–∏–π
   * @param {Array} curve - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ { t, value }
   * @param {number} startT - –Ω–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (0-1)
   * @param {number} endT - –∫–æ–Ω–µ—Ü –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (0-1)
   * @returns {number} –ø–ª–æ—â–∞–¥—å –ø–æ–¥ –∫—Ä–∏–≤–æ–π
   */
  I.calculateTrapezoidalAUC = (curve, startT = 0, endT = 1) => {
    if (!curve || curve.length < 2) return 0;

    let auc = 0;
    for (let i = 1; i < curve.length; i++) {
      const prev = curve[i - 1];
      const curr = curve[i];

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ—á–∫–∏ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
      if (prev.t < startT || curr.t > endT) continue;
      if (curr.t <= startT || prev.t >= endT) continue;

      // –û–±—Ä–µ–∑–∞–µ–º –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
      const t1 = Math.max(prev.t, startT);
      const t2 = Math.min(curr.t, endT);

      // –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö
      const ratio1 = prev.t === curr.t ? 0 : (t1 - prev.t) / (curr.t - prev.t);
      const ratio2 = prev.t === curr.t ? 1 : (t2 - prev.t) / (curr.t - prev.t);
      const v1 = prev.value + ratio1 * (curr.value - prev.value);
      const v2 = prev.value + ratio2 * (curr.value - prev.value);

      // –ü–ª–æ—â–∞–¥—å —Ç—Ä–∞–ø–µ—Ü–∏–∏
      auc += (v1 + v2) * (t2 - t1) / 2;
    }

    return auc;
  };

  /**
   * üÜï –†–∞—Å—á—ë—Ç iAUC (incremental AUC) ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥ –±–∞–∑–æ–π
   * @param {Array} curve - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ { t, value }
   * @param {number} baseline - –±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
   * @returns {number} incremental AUC
   */
  I.calculateIncrementalAUC = (curve, baseline = 0) => {
    if (!curve || curve.length < 2) return 0;

    // –°–æ–∑–¥–∞—ë–º –∫—Ä–∏–≤—É—é —Å –≤—ã—á—Ç–µ–Ω–Ω—ã–º baseline
    const adjustedCurve = curve.map(p => ({
      t: p.t,
      value: Math.max(0, p.value - baseline) // –¢–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
    }));

    return I.calculateTrapezoidalAUC(adjustedCurve);
  };

  /**
   * üÜï –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á—ë—Ç AUC —Å —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–µ–π
   * @param {Array} curve - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ –∫—Ä–∏–≤–æ–π
   * @param {Object} options - { baseline, normalize }
   * @returns {Object} { total, incremental, segments, ratio }
   */
  I.calculateFullAUC = (curve, options = {}) => {
    const { baseline = I.WAVE_SHAPE_V2.composition.baselineLevel, normalize = true } = options;
    const cfg = I.AUC_CONFIG;

    // –ü–æ–ª–Ω—ã–π AUC
    const totalAUC = I.calculateTrapezoidalAUC(curve);

    // Incremental AUC (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥ –±–∞–∑–æ–π)
    const iAUC = I.calculateIncrementalAUC(curve, baseline);

    // AUC –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º
    const segments = {};
    Object.entries(cfg.segments).forEach(([key, seg]) => {
      segments[key] = {
        auc: I.calculateTrapezoidalAUC(curve, seg.start, seg.end),
        label: seg.label,
        start: seg.start,
        end: seg.end
      };
    });

    // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∞–Ω–Ω–µ–≥–æ –∫ –ø–æ–∑–¥–Ω–µ–º—É (–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å "—Å–∫–æ—Ä–æ—Å—Ç–∏" –æ—Ç–≤–µ—Ç–∞)
    const earlyLateRatio = segments.late.auc > 0
      ? segments.early.auc / segments.late.auc
      : 0;

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ñ–æ—Ä–º–µ AUC
    let aucShape = 'normal';
    if (earlyLateRatio > 1.5) aucShape = 'front-loaded'; // –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç
    else if (earlyLateRatio < 0.5) aucShape = 'prolonged'; // –ó–∞—Ç—è–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç

    return {
      total: totalAUC,
      incremental: iAUC,
      segments,
      earlyLateRatio,
      aucShape,
      // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞)
      normalized: normalize ? {
        vsGlucose: totalAUC / cfg.reference.glucose50g,
        vsRice: totalAUC / cfg.reference.whiteRice200g,
        vsOatmeal: totalAUC / cfg.reference.oatmeal100g
      } : null
    };
  };

  // ============================================================================
  // üÜï INSULIN_PREDICTOR_V2 ‚Äî –ü—Ä–æ–≥–Ω–æ–∑ —É—Ä–æ–≤–Ω—è –∏–Ω—Å—É–ª–∏–Ω–∞ (v4.0.0)
  // ============================================================================
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Dalla Man et al. 2007 (PMID: 17513708)
  // –ú–æ–¥–µ–ª—å UVA/Padova ‚Äî –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å –≥–ª—é–∫–æ–∑–æ-–∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –¥–∏–Ω–∞–º–∏–∫–∏
  // ============================================================================
  I.INSULIN_PREDICTOR_CONFIG = C?.INSULIN_PREDICTOR_CONFIG || {
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ (–º–∏–Ω—É—Ç—ã)
    timePoints: [15, 30, 60, 90, 120],

    // –£—Ä–æ–≤–Ω–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–∏–∫–∞)
    levels: {
      peak: { min: 0.9, max: 1.0, label: '–ü–∏–∫–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å' },
      high: { min: 0.6, max: 0.9, label: '–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å' },
      moderate: { min: 0.3, max: 0.6, label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å' },
      low: { min: 0.1, max: 0.3, label: '–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å' },
      baseline: { min: 0, max: 0.1, label: '–ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å' }
    },

    // –ü–æ—Ä–æ–≥–∏ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    thresholds: {
      safeToEat: 0.3,        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –µ—Å—Ç—å —Å–Ω–æ–≤–∞ (‚â§30% –æ—Ç –ø–∏–∫–∞)
      fatBurning: 0.15,      // –ù–∞—á–∞–ª–æ –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è (‚â§15% –æ—Ç –ø–∏–∫–∞)
      optimalWindow: 0.25    // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏—ë–º–∞
    }
  };

  /**
   * üÜï –ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏–Ω—Å—É–ª–∏–Ω–∞ –Ω–∞ –∫—Ä–∏–≤–æ–π –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
   * @param {Array} curve - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ { t, minutes, value }
   * @param {number} minutes - –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö
   * @returns {Object} { value, level, label }
   */
  I.getInsulinLevelAtTime = (curve, minutes) => {
    if (!curve || curve.length === 0) {
      return { value: 0, level: 'baseline', label: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' };
    }

    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é —Ç–æ—á–∫—É –∏–ª–∏ –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º
    const waveMinutes = curve[curve.length - 1].minutes;
    const t = Math.min(minutes / waveMinutes, 1);

    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
    let prev = curve[0];
    let next = curve[curve.length - 1];

    for (let i = 0; i < curve.length - 1; i++) {
      if (curve[i].t <= t && curve[i + 1].t >= t) {
        prev = curve[i];
        next = curve[i + 1];
        break;
      }
    }

    // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
    const ratio = next.t === prev.t ? 0 : (t - prev.t) / (next.t - prev.t);
    const value = prev.value + ratio * (next.value - prev.value);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    const cfg = I.INSULIN_PREDICTOR_CONFIG.levels;
    let level = 'baseline';
    let label = cfg.baseline.label;

    if (value >= cfg.peak.min) { level = 'peak'; label = cfg.peak.label; }
    else if (value >= cfg.high.min) { level = 'high'; label = cfg.high.label; }
    else if (value >= cfg.moderate.min) { level = 'moderate'; label = cfg.moderate.label; }
    else if (value >= cfg.low.min) { level = 'low'; label = cfg.low.label; }

    return { value, level, label, minutes, t };
  };

  /**
   * üÜï –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –∏–Ω—Å—É–ª–∏–Ω–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
   * @param {Array} curve - –∫—Ä–∏–≤–∞—è –≤–æ–ª–Ω—ã
   * @param {number} waveMinutes - –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
   * @returns {Object} { predictions, recommendations, safeToEatAt, fatBurningAt }
   */
  I.predictInsulinResponse = (curve, waveMinutes) => {
    const cfg = I.INSULIN_PREDICTOR_CONFIG;

    // –ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
    const predictions = cfg.timePoints.map(minutes => {
      const result = I.getInsulinLevelAtTime(curve, minutes);
      return {
        minutes,
        ...result,
        formatted: `${minutes} –º–∏–Ω: ${(result.value * 100).toFixed(0)}% ‚Äî ${result.label}`
      };
    });

    // –ù–∞—Ö–æ–¥–∏–º –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
    let safeToEatAt = null;
    let fatBurningAt = null;
    let optimalWindowAt = null;

    for (const point of curve) {
      const minutes = point.minutes;
      const value = point.value;

      if (safeToEatAt === null && value <= cfg.thresholds.safeToEat) {
        safeToEatAt = minutes;
      }
      if (fatBurningAt === null && value <= cfg.thresholds.fatBurning) {
        fatBurningAt = minutes;
      }
      if (optimalWindowAt === null && value <= cfg.thresholds.optimalWindow) {
        optimalWindowAt = minutes;
      }
    }

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const recommendations = [];

    if (safeToEatAt) {
      recommendations.push({
        type: 'safe_to_eat',
        minutes: safeToEatAt,
        text: `–ë–µ–∑–æ–ø–∞—Å–Ω–æ –µ—Å—Ç—å —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ ${safeToEatAt} –º–∏–Ω`,
        icon: 'üçΩÔ∏è'
      });
    }

    if (fatBurningAt) {
      recommendations.push({
        type: 'fat_burning',
        minutes: fatBurningAt,
        text: `–ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑ ${fatBurningAt} –º–∏–Ω`,
        icon: 'üî•'
      });
    }

    if (optimalWindowAt) {
      recommendations.push({
        type: 'optimal_window',
        minutes: optimalWindowAt,
        text: `–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –µ–¥—ã: –ø–æ—Å–ª–µ ${optimalWindowAt} –º–∏–Ω`,
        icon: '‚≠ê'
      });
    }

    return {
      predictions,
      recommendations,
      safeToEatAt,
      fatBurningAt,
      optimalWindowAt,
      waveMinutes,
      summary: I.generatePredictionSummary(predictions, safeToEatAt, fatBurningAt)
    };
  };

  /**
   * üÜï –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–∞–º–º–∞—Ä–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞
   */
  I.generatePredictionSummary = (predictions, safeToEatAt, fatBurningAt) => {
    const p30 = predictions.find(p => p.minutes === 30);
    const p60 = predictions.find(p => p.minutes === 60);
    const p120 = predictions.find(p => p.minutes === 120);

    let summary = '';

    if (p30) {
      summary += `–ß–µ—Ä–µ–∑ 30 –º–∏–Ω: ${p30.label.toLowerCase()}. `;
    }
    if (p60) {
      summary += `–ß–µ—Ä–µ–∑ 1 —á–∞—Å: ${p60.label.toLowerCase()}. `;
    }
    if (fatBurningAt) {
      summary += `–ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ: —Å ${fatBurningAt} –º–∏–Ω.`;
    }

    return summary.trim();
  };

  // ============================================================================
  // üÜï WAVE_SCORING_V2 ‚Äî –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–ª–Ω—ã (v4.0.0)
  // ============================================================================
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
  // –£—á–∏—Ç—ã–≤–∞–µ—Ç: –ø–∏–∫, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ñ–æ—Ä–º—É, AUC, –∫–æ–Ω—Ç–µ–∫—Å—Ç
  // ============================================================================
  I.WAVE_SCORING_V2 = C?.WAVE_SCORING_V2 || {
    // –í–µ—Å–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏ (—Å—É–º–º–∞ = 1.0)
    weights: {
      peakHeight: 0.25,      // –í—ã—Å–æ—Ç–∞ –ø–∏–∫–∞ (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
      duration: 0.20,        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–ø—Ç–∏–º—É–º = —Ü–µ–ª–µ–≤–∞—è)
      shape: 0.20,           // –§–æ—Ä–º–∞ –≤–æ–ª–Ω—ã (prolonged –ª—É—á—à–µ spike)
      auc: 0.20,             // –ü–ª–æ—â–∞–¥—å –ø–æ–¥ –∫—Ä–∏–≤–æ–π
      context: 0.15          // –ö–æ–Ω—Ç–µ–∫—Å—Ç (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –≤—Ä–µ–º—è —Å—É—Ç–æ–∫)
    },

    // –ü–æ—Ä–æ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    thresholds: {
      peakHeight: {
        excellent: 0.6,     // –ü–∏–∫ ‚â§60% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞ = –æ—Ç–ª–∏—á–Ω–æ
        good: 0.75,         // –ü–∏–∫ ‚â§75% = —Ö–æ—Ä–æ—à–æ
        fair: 0.9,          // –ü–∏–∫ ‚â§90% = –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        poor: 1.0           // –ü–∏–∫ >90% = –ø–ª–æ—Ö–æ
      },
      duration: {
        target: 180,        // –¶–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã (–º–∏–Ω—É—Ç—ã)
        tolerance: 30,      // –î–æ–ø—É—Å—Ç–∏–º–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ¬±30 –º–∏–Ω
        maxPenalty: 60      // –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è ‚Äî –º–∞–∫—Å —à—Ç—Ä–∞—Ñ
      },
      auc: {
        excellent: 0.5,     // iAUC ‚â§50% –æ—Ç —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞ = –æ—Ç–ª–∏—á–Ω–æ
        good: 0.75,
        fair: 1.0,
        poor: 1.5
      }
    },

    // –ò—Ç–æ–≥–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ –æ—Ü–µ–Ω–∫–∏
    levels: {
      excellent: { min: 85, label: '–û—Ç–ª–∏—á–Ω–æ', icon: 'üåü', color: '#22c55e' },
      good: { min: 70, label: '–•–æ—Ä–æ—à–æ', icon: '‚úÖ', color: '#84cc16' },
      fair: { min: 50, label: '–ù–æ—Ä–º–∞–ª—å–Ω–æ', icon: '‚ûñ', color: '#eab308' },
      poor: { min: 0, label: '–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è', icon: '‚ö†Ô∏è', color: '#ef4444' }
    }
  };

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "–≤—ã—Å–æ—Ç–∞ –ø–∏–∫–∞"
   * @param {number} peakValue - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∏–∫–∞ (0-1)
   * @returns {number} –æ—Ü–µ–Ω–∫–∞ 0-100
   */
  I.scorePeakHeight = (peakValue) => {
    const th = I.WAVE_SCORING_V2.thresholds.peakHeight;

    if (peakValue <= th.excellent) return 100;
    if (peakValue <= th.good) {
      return 100 - (peakValue - th.excellent) / (th.good - th.excellent) * 20;
    }
    if (peakValue <= th.fair) {
      return 80 - (peakValue - th.good) / (th.fair - th.good) * 30;
    }
    return Math.max(0, 50 - (peakValue - th.fair) / (th.poor - th.fair) * 50);
  };

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
   * @param {number} minutes - –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
   * @returns {number} –æ—Ü–µ–Ω–∫–∞ 0-100
   */
  I.scoreDuration = (minutes) => {
    const th = I.WAVE_SCORING_V2.thresholds.duration;
    const deviation = Math.abs(minutes - th.target);

    if (deviation <= th.tolerance) {
      return 100 - (deviation / th.tolerance) * 15; // –î–æ 85 –ø—Ä–∏ –º–∞–∫—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤ –Ω–æ—Ä–º–µ
    }

    const extraDeviation = deviation - th.tolerance;
    const penaltyRange = th.maxPenalty - th.tolerance;
    const penalty = Math.min(1, extraDeviation / penaltyRange);

    return Math.max(0, 85 - penalty * 85);
  };

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "—Ñ–æ—Ä–º–∞ –≤–æ–ª–Ω—ã"
   * @param {string} shape - —Ç–∏–ø —Ñ–æ—Ä–º—ã (spike/balanced/prolonged)
   * @param {number} fastContribution - –≤–∫–ª–∞–¥ –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   * @returns {number} –æ—Ü–µ–Ω–∫–∞ 0-100
   */
  I.scoreWaveShape = (shape, fastContribution = 0.5) => {
    // Prolonged –ª—É—á—à–µ (–º–µ–Ω—å—à–µ —Å—Ç—Ä–µ—Å—Å –¥–ª—è –ø–æ–¥–∂–µ–ª—É–¥–æ—á–Ω–æ–π)
    switch (shape) {
      case 'prolonged': return 95;
      case 'balanced': return 80;
      case 'spike': return 50;
      default:
        // –ü–ª–∞–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ fastContribution
        // –ú–µ–Ω—å—à–µ fast = –ª—É—á—à–µ
        return Math.round(100 - fastContribution * 60);
    }
  };

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "AUC"
   * @param {number} normalizedAUC - AUC –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞
   * @returns {number} –æ—Ü–µ–Ω–∫–∞ 0-100
   */
  I.scoreAUC = (normalizedAUC) => {
    const th = I.WAVE_SCORING_V2.thresholds.auc;

    if (normalizedAUC <= th.excellent) return 100;
    if (normalizedAUC <= th.good) {
      return 100 - (normalizedAUC - th.excellent) / (th.good - th.excellent) * 20;
    }
    if (normalizedAUC <= th.fair) {
      return 80 - (normalizedAUC - th.good) / (th.fair - th.good) * 30;
    }
    if (normalizedAUC <= th.poor) {
      return 50 - (normalizedAUC - th.fair) / (th.poor - th.fair) * 50;
    }
    return 0;
  };

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "–∫–æ–Ω—Ç–µ–∫—Å—Ç"
   * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏—ë–º–∞ { hasTraining, isPostWorkout, circadianPeriod }
   * @returns {number} –æ—Ü–µ–Ω–∫–∞ 0-100
   */
  I.scoreContext = (context = {}) => {
    let score = 70; // –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å

    // –ë–æ–Ω—É—Å –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
    if (context.hasTraining || context.isPostWorkout) {
      score += 15; // –ò–Ω—Å—É–ª–∏–Ω –∏–¥—ë—Ç –≤ –º—ã—à—Ü—ã
    }

    // –ë–æ–Ω—É—Å –∑–∞ —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
    const period = context.circadianPeriod;
    if (period === 'morning' || period === 'day') {
      score += 10; // –õ—É—á—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É —É—Ç—Ä–æ–º
    } else if (period === 'night') {
      score -= 10; // –•—É–¥—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–æ—á—å—é
    }

    // –ë–æ–Ω—É—Å –∑–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏
    if (context.mealGapMinutes && context.mealGapMinutes >= 180) {
      score += 5;
    }

    return Math.min(100, Math.max(0, score));
  };

  /**
   * üÜï –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á—ë—Ç –æ—Ü–µ–Ω–∫–∏ –≤–æ–ª–Ω—ã
   * @param {Object} waveData - –¥–∞–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã –∏–∑ calculateWaveForMeal
   * @param {Object} context - –∫–æ–Ω—Ç–µ–∫—Å—Ç
   * @returns {Object} { score, level, components, recommendations }
   */
  I.calculateWaveScore = (waveData, context = {}) => {
    const cfg = I.WAVE_SCORING_V2;
    const weights = cfg.weights;

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Ü–µ–Ω–∫–∏
    const components = {
      peakHeight: {
        value: waveData.peakValue || 1,
        score: I.scorePeakHeight(waveData.peakValue || 1),
        weight: weights.peakHeight
      },
      duration: {
        value: waveData.waveMinutes || 180,
        score: I.scoreDuration(waveData.waveMinutes || 180),
        weight: weights.duration
      },
      shape: {
        value: waveData.shape || 'balanced',
        score: I.scoreWaveShape(waveData.shape, waveData.fastContribution),
        weight: weights.shape
      },
      auc: {
        value: waveData.auc?.normalized?.vsGlucose || 1,
        score: I.scoreAUC(waveData.auc?.normalized?.vsGlucose || 1),
        weight: weights.auc
      },
      context: {
        value: context,
        score: I.scoreContext(context),
        weight: weights.context
      }
    };

    // –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞
    const totalScore = Object.values(components).reduce((sum, comp) => {
      return sum + comp.score * comp.weight;
    }, 0);

    const score = Math.round(totalScore);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    let level = cfg.levels.poor;
    for (const [key, lvl] of Object.entries(cfg.levels)) {
      if (score >= lvl.min) {
        level = { ...lvl, key };
      }
    }

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
    const recommendations = [];

    if (components.peakHeight.score < 70) {
      recommendations.push({
        type: 'peak',
        text: '–î–æ–±–∞–≤—å—Ç–µ –∫–ª–µ—Ç—á–∞—Ç–∫—É –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –ø–∏–∫–∞',
        icon: 'ü•¨'
      });
    }

    if (components.shape.score < 70) {
      recommendations.push({
        type: 'shape',
        text: '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–∞–¥—É—Ç –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—É—é –≤–æ–ª–Ω—É',
        icon: 'üçû'
      });
    }

    if (components.context.score < 70 && !context.hasTraining) {
      recommendations.push({
        type: 'activity',
        text: '–õ—ë–≥–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –µ–¥—ã —É–ª—É—á—à–∏—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏—é',
        icon: 'üö∂'
      });
    }

    return {
      score,
      level,
      components,
      recommendations,
      summary: `${level.icon} ${level.label} (${score}/100)`
    };
  };

  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –°–ù–ò–ñ–ê–ï–¢ –ø–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞ –∏ –æ–±—â—É—é AUC –Ω–∞ 20-30% (Wolever 1991, Jenkins 1978)
  // '–ü–∏–∫ –Ω–∏–∂–µ, –≤–æ–ª–Ω–∞ —Å–≥–ª–∞–∂–µ–Ω–∞' ‚Äî –£–ú–ï–ù–¨–®–ï–ù–ò–ï –≤–æ–ª–Ω—ã, –Ω–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ!
  // –ú–µ—Ö–∞–Ω–∏–∑–º: –∑–∞–º–µ–¥–ª—è–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥–æ–≤, —Å–Ω–∏–∂–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç
  I.FIBER_BONUS = C?.FIBER_BONUS || {
    veryHigh: { threshold: 15, bonus: -0.20 }, // 15+ –≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ ‚Üí -20% –≤–æ–ª–Ω–∞
    high: { threshold: 10, bonus: -0.15 },     // 10-15 –≥ ‚Üí -15%
    medium: { threshold: 5, bonus: -0.08 }     // 5-10 –≥ ‚Üí -8%
  };

  // üßà FAT SLOWDOWN ‚Äî –∂–∏—Ä—ã –∑–∞–º–µ–¥–ª—è—é—Ç –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞ (gastric emptying)
  // –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: Liddle et al., 1991 ‚Äî –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è
  // –ù–û: —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –ò–ù–°–£–õ–ò–ù –º–µ–Ω—å—à–µ —á–µ–º –Ω–∞ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ!
  // üî¨ v3.7.5: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ ‚Äî —Å–Ω–∏–∂–µ–Ω—ã –±–æ–Ω—É—Å—ã (—Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç ~10-15%, –Ω–µ 25%)
  // –ñ–∏—Ä—ã –°–ì–õ–ê–ñ–ò–í–ê–Æ–¢ –ø–∏–∫, –Ω–æ –Ω–µ —Ç–∞–∫ —Å–∏–ª—å–Ω–æ —É–¥–ª–∏–Ω—è—é—Ç –≤–æ–ª–Ω—É
  I.FAT_BONUS = C?.FAT_BONUS || {
    high: { threshold: 25, bonus: 0.15 },    // 25+ –≥ –∂–∏—Ä–∞ ‚Üí +15% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã (–±—ã–ª–æ +25%)
    medium: { threshold: 15, bonus: 0.10 },  // 15+ –≥ –∂–∏—Ä–∞ ‚Üí +10% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã (–±—ã–ª–æ +15%)
    low: { threshold: 8, bonus: 0.05 }       // 8+ –≥ –∂–∏—Ä–∞ ‚Üí +5% (–±—ã–ª–æ +8%)
  };

  // ü•§ LIQUID FOOD ‚Äî –∂–∏–¥–∫–∞—è –ø–∏—â–∞ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ë–´–°–¢–†–ï–ï
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–ñ–∏–¥–∫–∏–µ –∫–∞–ª–æ—Ä–∏–∏ (—Å–æ–∫, —Å–º—É–∑–∏) –¥–∞—é—Ç –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π –∏ –í–´–°–û–ö–ò–ô –ø–∏–∫ (+30-50%)'
  // –ù–æ –æ–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–ª–Ω—ã –ö–û–†–û–ß–ï (–Ω–µ—Ç –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏—è)
  // Peak higher but duration shorter = –∫–æ–º–ø—Ä–æ–º–∏—Å—Å
  I.LIQUID_FOOD = C?.LIQUID_FOOD || {
    waveMultiplier: 0.75,   // –í–æ–ª–Ω–∞ –Ω–∞ 25% –∫–æ—Ä–æ—á–µ (–±—ã–ª–æ 18%)
    peakMultiplier: 1.35,   // üÜï –ü–∏–∫ –Ω–∞ 35% –≤—ã—à–µ (–Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä)
    // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∂–∏–¥–∫–æ–π –ø–∏—â–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    patterns: [
      /—Å–æ–∫\b/i, /\b—Å–æ–∫–∞\b/i, /\b—Å–æ–∫–∏\b/i,
      /—Å–º—É–∑–∏/i, /–∫–æ–∫—Ç–µ–π–ª—å/i, /shake/i,
      /–º–æ–ª–æ–∫–æ/i, /–∫–µ—Ñ–∏—Ä/i, /—Ä—è–∂–µ–Ω–∫–∞/i, /–∞–π—Ä–∞–Ω/i, /—Ç–∞–Ω\b/i,
      /–π–æ–≥—É—Ä—Ç.*–ø–∏—Ç—å–µ–≤–æ–π/i, /–ø–∏—Ç—å–µ–≤–æ–π.*–π–æ–≥—É—Ä—Ç/i,
      /–∫–∞–∫–∞–æ/i, /–≥–æ—Ä—è—á–∏–π —à–æ–∫–æ–ª–∞–¥/i,
      /–±—É–ª—å–æ–Ω/i, /—Å—É–ø.*–ø—é—Ä–µ/i, /–∫—Ä–µ–º.*—Å—É–ø/i,
      /–∫–æ–ª–∞/i, /–ø–µ–ø—Å–∏/i, /—Ñ–∞–Ω—Ç–∞/i, /—Å–ø—Ä–∞–π—Ç/i, /–ª–∏–º–æ–Ω–∞–¥/i, /–≥–∞–∑–∏—Ä–æ–≤–∫–∞/i,
      /—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫/i, /energy/i,
      /–ø—Ä–æ—Ç–µ–∏–Ω.*–∫–æ–∫—Ç–µ–π–ª—å/i, /protein.*shake/i
    ],
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –∂–∏–¥–∫–∏–º–∏
    categories: ['–ù–∞–ø–∏—Ç–∫–∏', '–°–æ–∫–∏', '–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏']
  };

  // ü•õ INSULINOGENIC CATEGORIES ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã–∑—ã–≤–∞—é—Ç —Å–∏–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
  // –¥–∞–∂–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –ì–ò (–º–æ–ª–æ–∫–æ –ì–ò=30, –Ω–æ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å=90!)
  // Holt et al. (1997) ‚Äî "An insulin index of foods"
  I.INSULINOGENIC_BONUS = C?.INSULINOGENIC_BONUS || {
    // –ñ–∏–¥–∫–∏–µ –º–æ–ª–æ—á–Ω—ã–µ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç (—Å—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π –±–µ–ª–æ–∫)
    liquidDairy: {
      bonus: 0.15,  // +15% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã
      patterns: [/–º–æ–ª–æ–∫–æ/i, /–∫–µ—Ñ–∏—Ä/i, /—Ä—è–∂–µ–Ω–∫–∞/i, /–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∞/i, /–∞–π—Ä–∞–Ω/i],
      categories: ['–ú–æ–ª–æ—á–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏']
    },
    // –ü–æ–ª—É–∂–∏–¥–∫–∏–µ/–º—è–≥–∫–∏–µ –º–æ–ª–æ—á–Ω—ã–µ ‚Äî —Å—Ä–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç
    softDairy: {
      bonus: 0.10,  // +10% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã
      patterns: [/–π–æ–≥—É—Ä—Ç/i, /—Å–º–µ—Ç–∞–Ω–∞/i, /—Å–ª–∏–≤–∫–∏/i, /—Ç–≤–æ—Ä–æ–≥/i, /—Ç–≤–æ—Ä–æ–∂–æ–∫/i],
      categories: []
    },
    // –¢–≤—ë—Ä–¥—ã–µ –º–æ–ª–æ—á–Ω—ã–µ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    hardDairy: {
      bonus: 0.05,  // +5% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã
      patterns: [/—Å—ã—Ä/i, /cheese/i, /–ø–∞—Ä–º–µ–∑–∞–Ω/i, /–º–æ—Ü–∞—Ä–µ–ª–ª–∞/i, /—á–µ–¥–¥–µ—Ä/i],
      categories: []
    },
    // –ë–µ–ª–∫–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã ‚Äî –≤—ã–∑—ã–≤–∞—é—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –¥–∞–∂–µ –±–µ–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤
    protein: {
      bonus: 0.08,  // +8% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã
      patterns: [/–≥–æ–≤—è–¥–∏–Ω–∞/i, /—Å–≤–∏–Ω–∏–Ω–∞/i, /–∫—É—Ä–∏—Ü–∞/i, /–∏–Ω–¥–µ–π–∫–∞/i, /—Ä—ã–±–∞/i, /–ª–æ—Å–æ—Å—å/i, /—Ç—É–Ω–µ—Ü/i, /—Ç—Ä–µ—Å–∫–∞/i, /–∫—Ä–µ–≤–µ—Ç–∫–∏/i, /–º—è—Å–æ/i, /—Å—Ç–µ–π–∫/i, /—Ñ–∏–ª–µ/i, /–≥—Ä—É–¥–∫–∞/i, /—Ñ–∞—Ä—à/i],
      categories: ['–ú—è—Å–æ', '–†—ã–±–∞', '–ü—Ç–∏—Ü–∞', '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã', 'Meat', 'Fish']
    }
  };

  // üìä GLYCEMIC LOAD SCALING ‚Äî GL —Ç–æ—á–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç —á–µ–º –ø—Ä–æ—Å—Ç–æ GI
  // GL = GI √ó —É–≥–ª–µ–≤–æ–¥—ã / 100 (Brand-Miller et al., 2003)
  // –ü—Ä–∏–º–µ—Ä: –∞—Ä–±—É–∑ GI=72 –≤—ã—Å–æ–∫–∏–π, –Ω–æ 100–≥ –∞—Ä–±—É–∑–∞ = 6–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Üí GL=4.3 (–Ω–∏–∑–∫–∞—è!)
  // –ü—Ä–∏–º–µ—Ä: –±–µ–ª—ã–π —Ä–∏—Å GI=73, 150–≥ = 45–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Üí GL=33 (–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è!)
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä–æ–≥–∏: –Ω–∏–∑–∫–∞—è <10, —Å—Ä–µ–¥–Ω—è—è 10-20, –≤—ã—Å–æ–∫–∞—è >20
  // 
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-09 v2:
  // –ü—Ä–∏ GL < 10 –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –ú–ò–ù–ò–ú–ê–õ–ï–ù ‚Äî –≤–æ–ª–Ω–∞ –∫–æ—Ä–æ—Ç–∫–∞—è (1-2—á –º–∞–∫—Å–∏–º—É–º)
  // Mayer (1995): –ø—Ä–∏ <10–≥ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏–Ω—Å—É–ª–∏–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –±–∞–∑–æ–≤–æ–º—É –∑–∞ 1-2—á
  // Brand-Miller (2003): GL ‚Äî –ª—É—á—à–∏–π –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä –ø–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω–æ–π –≥–ª–∏–∫–µ–º–∏–∏
  // 
  // –ö–õ–Æ–ß–ï–í–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø: –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —Å–Ω–∏–∂–µ–Ω—ã –¥–ª—è GL < 10
  // –ü—Ä–∏–º–µ—Ä: 35–≥ –±–ª–∏–Ω–∞ (GL=7) ‚Üí –≤–æ–ª–Ω–∞ ~1.5—á, –ù–ï 2.3—á
  I.GL_CATEGORIES = C?.GL_CATEGORIES || {
    micro: { max: 2, multiplier: 0.25, desc: '–º–∏–∫—Ä–æ-–∏–Ω—Å—É–ª–∏–Ω' },             // GL<2 = ~25% –≤–æ–ª–Ω—ã (45 –º–∏–Ω), –∫–æ—Ñ–µ+–º–æ–ª–æ–∫–æ
    veryLow: { max: 5, multiplier: 0.40, desc: '–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω' },     // ~40% –≤–æ–ª–Ω—ã (72 –º–∏–Ω), –ø–æ—á—Ç–∏ –∫–µ—Ç–æ-–µ–¥–∞
    low: { max: 10, multiplier: 0.55, desc: '—Å–ª–∞–±—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç' },   // ~55% –≤–æ–ª–Ω—ã (99 –º–∏–Ω ‚âà 1.5—á)
    medium: { max: 20, multiplier: 1.0, desc: '–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω' },       // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≤–æ–ª–Ω–∞
    high: { max: 30, multiplier: 1.15, desc: '—Å–∏–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç' }, // +15% –≤–æ–ª–Ω—ã
    veryHigh: { max: Infinity, multiplier: 1.25, desc: '–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω' } // +25%
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï –ù–û–í–´–ï –ö–û–ù–¶–ï–ü–¶–ò–ò v3.0.0
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // üìà –ù–ï–ü–†–ï–†–´–í–ù–ê–Ø –§–û–†–ú–£–õ–ê GL ‚Äî –ø–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è –≤–º–µ—Å—Ç–æ —Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Brand-Miller 2003 ‚Äî GL –ª—É—á—à–∏–π –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
  // –§–æ—Ä–º—É–ª–∞: —Å—Ç–µ–ø–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –ø–ª–∞–≤–Ω—ã–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º
  I.GL_CONTINUOUS = C?.GL_CONTINUOUS || {
    minGL: 0,           // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è GL
    maxGL: 40,          // –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
    minMultiplier: 0.15, // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–∏ GL=0 (15% –≤–æ–ª–Ω—ã ‚âà 27 –º–∏–Ω)
    maxMultiplier: 1.30, // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–∏ GL‚â•40 (130% –≤–æ–ª–Ω—ã ‚âà 3—á 54–º–∏–Ω)
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–µ–ø–µ–Ω–Ω–æ–π –∫—Ä–∏–≤–æ–π
    // –ü—Ä–∏ GL=7 (–±–ª–∏–Ω—á–∏–∫) –æ–∂–∏–¥–∞–µ–º ~0.45 (1—á 21–º–∏–Ω)
    // –ü—Ä–∏ GL=15 –æ–∂–∏–¥–∞–µ–º ~0.75 (2—á 15–º–∏–Ω)
    // –ü—Ä–∏ GL=25 –æ–∂–∏–¥–∞–µ–º ~1.0 (3—á)
    exponent: 0.6  // –°—Ç–µ–ø–µ–Ω—å –∫—Ä–∏–≤–æ–π (–º–µ–Ω—å—à–µ = –±–æ–ª–µ–µ –ø–æ–ª–æ–≥–∏–π —Ä–æ—Å—Ç –≤ –Ω–∞—á–∞–ª–µ)
  };

  // üë§ –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ë–ê–ó–û–í–´–ô –ü–ï–†–ò–û–î ‚Äî —É—á—ë—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
  // - DeFronzo 1979: –≤–æ–∑—Ä–∞—Å—Ç —Å–Ω–∏–∂–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  // - Kahn & Flier 2000: BMI –≤–ª–∏—è–µ—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // - Nuutila 1995: –∂–µ–Ω—â–∏–Ω—ã –∏–º–µ—é—Ç –ª—É—á—à—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É
  // üÜï v3.0.1: –£–º–µ–Ω—å—à–µ–Ω—ã –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã ‚Äî –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL —ç—Ñ—Ñ–µ–∫—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–∫–∞–ª–∏—Ä—É–µ—Ç—Å—è
  I.PERSONAL_BASELINE = C?.PERSONAL_BASELINE || {
    defaultWaveHours: 3.0,  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥
    minWaveHours: 1.5,      // –ú–∏–Ω–∏–º—É–º (–æ—á–µ–Ω—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∫ –∏–Ω—Å—É–ª–∏–Ω—É)
    maxWaveHours: 4.5,      // üÜï –£–º–µ–Ω—å—à–µ–Ω–æ —Å 5.0 (—Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–µ –≤–æ–ª–Ω—ã –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã)
    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è ‚Äî üÜï –£–ú–ï–ù–¨–®–ï–ù–´ –≤–¥–≤–æ–µ (–±—ã–ª–∏ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã)
    ageEffect: {
      startAge: 30,         // –í–æ–∑—Ä–∞—Å—Ç –Ω–∞—á–∞–ª–∞ –≤–ª–∏—è–Ω–∏—è
      bonusPerYear: 0.004   // üÜï +0.4% –∑–∞ –≥–æ–¥ (–±—ã–ª–æ +0.8%) ‚Äî –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ
    },
    bmiEffect: {
      startBMI: 25,         // üÜï BMI 25+ (–±—ã–ª–æ 23) ‚Äî –Ω–∞—á–∞–ª–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ –≤–µ—Å–∞
      bonusPerUnit: 0.015   // üÜï +1.5% –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (–±—ã–ª–æ +2.5%)
    },
    genderEffect: {
      female: -0.05,        // üÜï –ñ–µ–Ω—â–∏–Ω—ã -5% (–±—ã–ª–æ -8%)
      male: 0.03,           // üÜï –ú—É–∂—á–∏–Ω—ã +3% (–±—ã–ª–æ +5%)
      other: 0              // –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ
    }
  };

  // üîó –ö–£–ú–£–õ–Ø–¢–ò–í–ù–´–ô –≠–§–§–ï–ö–¢ (Meal Stacking) ‚Äî –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç –≤–æ–ª–Ω
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –∫–æ–≥–¥–∞ –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ "–∞–∫—Ç–∏–≤–Ω—É—é" –≤–æ–ª–Ω—É,
  // üî¨ –ù–ê–£–ß–ù–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø v3.7.4: "Second Meal Effect" —Ä–∞–±–æ—Ç–∞–µ—Ç –í –û–ë–†–ê–¢–ù–£–Æ –°–¢–û–†–û–ù–£!
  // Wolever 2006: –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º —Å –Ω–∏–∑–∫–∏–º –ì–ò –£–õ–£–ß–®–ê–ï–¢ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤—Ç–æ—Ä–æ–π
  // –ò–Ω—Å—É–ª–∏–Ω —É–∂–µ –≤ –∫—Ä–æ–≤–∏ ‚Üí –º–µ–Ω—å—à–µ –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—É–ª–∏–Ω–∞ –Ω—É–∂–Ω–æ ‚Üí –≤–æ–ª–Ω–∞ –ö–û–†–û–ß–ï
  // 
  // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø): –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç —É–¥–ª–∏–Ω—è–ª –≤–æ–ª–Ω—É (+40%)
  // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø): –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç —É–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤–æ–ª–Ω—É (-10...-15%)
  I.MEAL_STACKING = C?.MEAL_STACKING || {
    enabled: true,
    // üÜï v3.7.4: –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô –±–æ–Ω—É—Å ‚Äî –≤–æ–ª–Ω–∞ –ö–û–†–û–ß–ï –ø—Ä–∏ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–µ
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –∏–Ω—Å—É–ª–∏–Ω —É–∂–µ —Å–µ–∫—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω ‚Üí –º–µ–Ω—å—à–µ –Ω—É–∂–Ω–æ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏—ë–º–∞
    maxStackBonus: -0.15, // –î–æ -15% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã (—É–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç!)
    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è
    decayRate: 0.5
  };

  // üìä –§–ê–ó–´ –í–û–õ–ù–´ ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—É—é —Ñ–æ—Ä–º—É:
  // 1. Rise (–ø–æ–¥—ä—ë–º): 15-30 –º–∏–Ω ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç –∏–Ω—Å—É–ª–∏–Ω–∞
  // 2. Plateau (–ø–ª–∞—Ç–æ): 30-90 –º–∏–Ω ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
  // 3. Decline (—Å–ø–∞–¥): 60-120 –º–∏–Ω ‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ
  // 4. Lipolysis (–ª–∏–ø–æ–ª–∏–∑): –ø–æ—Å–ª–µ —Å–ø–∞–¥–∞ ‚Äî –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
  I.WAVE_PHASES = C?.WAVE_PHASES || {
    rise: {
      baseMinutes: 20,        // –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –ø–æ–¥—ä—ë–º–∞
      fiberBonus: 3,          // +3 –º–∏–Ω –∑–∞ –∫–∞–∂–¥—ã–µ 5–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏
      liquidPenalty: 0.6      // –ñ–∏–¥–∫–æ–µ ‚Äî –Ω–∞ 40% –±—ã—Å—Ç—Ä–µ–µ –ø–æ–¥—ä—ë–º
    },
    plateau: {
      basePct: 0.35,          // 35% –æ—Ç –æ–±—â–µ–π –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã
      proteinBonus: 0.05,     // +5% –∫ –ø–ª–∞—Ç–æ –∑–∞ –∫–∞–∂–¥—ã–µ 20–≥ –±–µ–ª–∫–∞
      fatBonus: 0.08          // +8% –∫ –ø–ª–∞—Ç–æ –∑–∞ –∫–∞–∂–¥—ã–µ 15–≥ –∂–∏—Ä–æ–≤
    },
    decline: {
      basePct: 0.45,          // 45% –æ—Ç –æ–±—â–µ–π –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã
      activityBonus: -0.15    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—Å–∫–æ—Ä—è–µ—Ç —Å–ø–∞–¥ –Ω–∞ 15%
    },
    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–∑
    colors: {
      rise: '#f97316',        // –û—Ä–∞–Ω–∂–µ–≤—ã–π
      plateau: '#ef4444',     // –ö—Ä–∞—Å–Ω—ã–π (–º–∞–∫—Å –∏–Ω—Å—É–ª–∏–Ω)
      decline: '#eab308',     // –ñ—ë–ª—Ç—ã–π
      lipolysis: '#22c55e'    // –ó–µ–ª—ë–Ω—ã–π (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ)
    }
  };

  // ü•õ –ò–ù–°–£–õ–ò–ù–û–í–´–ô –ò–ù–î–ï–ö–° (II) ‚Äî —Ç–æ—á–Ω–µ–µ —á–µ–º –ø—Ä–æ—Å—Ç–æ –ì–ò –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Holt 1997 ‚Äî "An insulin index of foods"
  // 
  // üî¨ v3.8.0: –ù–ê–£–ß–ù–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø ‚Äî –º–æ–ª–æ—á–∫–∞ –¥–∞—ë—Ç –í–´–°–û–ö–ò–ô –ø–∏–∫, –Ω–æ –ö–û–†–û–¢–ö–£–Æ –≤–æ–ª–Ω—É!
  // Holt 1997: "Milk has high II (98) despite low GI (46)"
  // –ù–û: –≤—ã—Å–æ–∫–∏–π II = –±—ã—Å—Ç—Ä—ã–π –≤—ã–±—Ä–æ—Å –∏–Ω—Å—É–ª–∏–Ω–∞ = –±—ã—Å—Ç—Ä–µ–µ –≤–æ–∑–≤—Ä–∞—Ç –∫ –±–∞–∑–æ–≤–æ–º—É
  // –ñ–∏–¥–∫–∏–µ –º–æ–ª–æ—á–Ω—ã–µ: –ø–∏–∫ √ó1.35, –≤–æ–ª–Ω–∞ √ó0.85 (–±—ã—Å—Ç—Ä–µ–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è)
  // 
  // –ò—Å—Ö–æ–¥–Ω–∞—è –º–æ–¥–µ–ª—å (v3.2.2) –±—ã–ª–∞ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ô:
  // - –£–≤–µ–ª–∏—á–∏–≤–∞–ª–∞ GL ‚Üí —É–¥–ª–∏–Ω—è–ª–∞ –≤–æ–ª–Ω—É
  // - –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Ñ–∏–∑–∏–æ–ª–æ–≥–∏–∏: –±—ã—Å—Ç—Ä—ã–π –ø–∏–∫ = –±—ã—Å—Ç—Ä—ã–π —Å–ø–∞–¥
  // 
  // –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å (v3.8.0):
  // - peakMultiplier: —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ü–ò–ö–û–í–´–ô –∏–Ω—Å—É–ª–∏–Ω (–¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
  // - waveMultiplier: —É–º–µ–Ω—å—à–∞–µ—Ç –î–õ–ò–ù–£ –≤–æ–ª–Ω—ã (–±—ã—Å—Ç—Ä–µ–µ —Å–ø–∞–¥)
  // - glBoost: —É–º–µ—Ä–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ effectiveGL (–¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞)
  I.INSULIN_INDEX_FACTORS = C?.INSULIN_INDEX_FACTORS || {
    // –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    liquidDairy: {
      glBoost: 1.5,          // GL √ó1.5 (–Ω–µ √ó3.0 ‚Äî —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
      peakMultiplier: 1.35,  // –ü–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞ +35%
      waveMultiplier: 0.85,  // –í–æ–ª–Ω–∞ -15% (–±—ã—Å—Ç—Ä–µ–µ —Å–ø–∞–¥)
      desc: '–ú–æ–ª–æ–∫–æ, –∫–µ—Ñ–∏—Ä ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–∏–∫, –∫–æ—Ä–æ—Ç–∫–∞—è –≤–æ–ª–Ω–∞'
    },
    softDairy: {
      glBoost: 1.3,          // GL √ó1.3
      peakMultiplier: 1.25,  // –ü–∏–∫ +25%
      waveMultiplier: 0.90,  // –í–æ–ª–Ω–∞ -10%
      desc: '–ô–æ–≥—É—Ä—Ç, —Ç–≤–æ—Ä–æ–≥'
    },
    hardDairy: {
      glBoost: 1.1,          // GL √ó1.1
      peakMultiplier: 1.10,  // –ü–∏–∫ +10%
      waveMultiplier: 0.95,  // –í–æ–ª–Ω–∞ -5%
      desc: '–°—ã—Ä ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è'
    },
    pureProtein: {
      glBoost: 1.2,          // GL √ó1.2 (–±–µ–ª–æ–∫ –¥–∞—ë—Ç –∏–Ω—Å—É–ª–∏–Ω –±–µ–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤)
      peakMultiplier: 1.15,  // –ü–∏–∫ +15%
      waveMultiplier: 0.92,  // –í–æ–ª–Ω–∞ -8%
      desc: '–ú—è—Å–æ, —Ä—ã–±–∞ ‚Äî —É–º–µ—Ä–µ–Ω–Ω—ã–π II'
    },
    highFiber: {
      glBoost: 0.8,          // GL √ó0.8 (—Å–Ω–∏–∂–∞–µ—Ç GL!)
      peakMultiplier: 0.85,  // –ü–∏–∫ -15%
      waveMultiplier: 1.10,  // –í–æ–ª–Ω–∞ +10% (–¥–æ–ª—å—à–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è)
      desc: '–í—ã—Å–æ–∫–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞ —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç'
    },
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±—É—Å—Ç –∫ GL (–∑–∞—â–∏—Ç–∞ –æ—Ç —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
    maxGLBoost: 2.0
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // üèÉ WORKOUT ACCELERATION ‚Äî —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—Å–∫–æ—Ä—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º
  I.WORKOUT_BONUS = C?.WORKOUT_BONUS || {
    // –ú–∏–Ω—É—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí –±–æ–Ω—É—Å –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ–ª–Ω—ã (—É–º–µ–Ω—å—à–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
    high: { threshold: 45, bonus: -0.15 },   // 45+ –º–∏–Ω ‚Üí –≤–æ–ª–Ω–∞ –Ω–∞ 15% –∫–æ—Ä–æ—á–µ
    medium: { threshold: 20, bonus: -0.08 }, // 20+ –º–∏–Ω ‚Üí –≤–æ–ª–Ω–∞ –Ω–∞ 8% –∫–æ—Ä–æ—á–µ
    // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –∑–æ–Ω—ã (z3, z4) –¥–∞—é—Ç –±–æ–ª—å—à–∏–π –±–æ–Ω—É—Å
    intensityMultiplier: 1.5 // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –º–∏–Ω—É—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è x1.5
  };

  // üèÉ‚Äç‚ôÇÔ∏è POSTPRANDIAL EXERCISE ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ü–û–°–õ–ï –µ–¥—ã
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –º—ã—à–µ—á–Ω—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç GLUT4 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ—Ä—ã,
  // —É—Å–∫–æ—Ä—è—è –∫–ª–∏—Ä–µ–Ω—Å –≥–ª—é–∫–æ–∑—ã –∏–∑ –∫—Ä–æ–≤–∏ –Ω–∞ 20-50% (Colberg et al. 2010, Erickson et al. 2017)
  // 
  // üÜï v3.5.1: –£–°–ò–õ–ï–ù–´ –ë–û–ù–£–°–´ ‚Äî –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –µ–¥—ã
  // –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–¢ –≤–æ–ª–Ω—É (GLUT4 —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Å—É–ª–∏–Ω–∞)
  I.POSTPRANDIAL_EXERCISE = C?.POSTPRANDIAL_EXERCISE || {
    // –û–∫–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∞: 0-2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
    maxWindow: 120,  // 2 —á–∞—Å–∞ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
    // üÜï v3.5.1: –£–°–ò–õ–ï–ù–ù–´–ï –±–æ–Ω—É—Å—ã –ø–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ (–ü–û–°–õ–ï –µ–¥—ã)
    // –ß–µ–º —Ä–∞–Ω—å—à–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ –µ–¥—ã ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç
    highIntensity: { threshold: 30, bonus: -0.50 },  // 30+ –º–∏–Ω –≤—ã—Å–æ–∫–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ ‚Üí -50% (–±—ã–ª–æ -25%)
    moderate: { threshold: 20, bonus: -0.35 },       // 20+ –º–∏–Ω —É–º–µ—Ä–µ–Ω–Ω–æ–π ‚Üí -35% (–±—ã–ª–æ -18%)
    light: { threshold: 15, bonus: -0.20 },          // 15+ –º–∏–Ω –ª—ë–≥–∫–æ–π ‚Üí -20% (–±—ã–ª–æ -10%)
    // –¢–∏–ø—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî –∫–∞—Ä–¥–∏–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –¥–ª—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–ª—é–∫–æ–∑—ã
    typeMultipliers: {
      cardio: 1.3,    // –ö–∞—Ä–¥–∏–æ +30% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–±—ã–ª–æ 1.2)
      strength: 1.0,  // –°–∏–ª–æ–≤–∞—è ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç
      hobby: 0.8      // –•–æ–±–±–∏ (–ø—Ä–æ–≥—É–ª–∫–∞, –π–æ–≥–∞) ‚Äî 80%
    },
    // üÜï v3.5.1: –ë–æ–Ω—É—Å –∑–∞ –±–ª–∏–∑–æ—Å—Ç—å –∫ –µ–¥–µ (—á–µ–º —Ä–∞–Ω—å—à–µ ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ)
    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 10 –º–∏–Ω –ø–æ—Å–ª–µ –µ–¥—ã = +50% –∫ –±–æ–Ω—É—Å—É
    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 60 –º–∏–Ω = —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–æ–Ω—É—Å
    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 120 –º–∏–Ω = -50% –∫ –±–æ–Ω—É—Å—É
    proximityBoost: {
      immediate: { maxGap: 15, boost: 1.5 },   // 0-15 –º–∏–Ω ‚Üí –±–æ–Ω—É—Å √ó1.5
      soon: { maxGap: 30, boost: 1.3 },        // 15-30 –º–∏–Ω ‚Üí –±–æ–Ω—É—Å √ó1.3
      medium: { maxGap: 60, boost: 1.0 },      // 30-60 –º–∏–Ω ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç
      late: { maxGap: 120, boost: 0.7 }        // 60-120 –º–∏–Ω ‚Üí –±–æ–Ω—É—Å √ó0.7
    }
  };

  // üè° NEAT (Non-Exercise Activity Thermogenesis) ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Hamilton et al. 2007, Levine et al. 2002
  // –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –Ω–∏–∑–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–ª—É—á—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É
  I.NEAT_BONUS = C?.NEAT_BONUS || {
    high: { threshold: 60, bonus: -0.10 },    // 60+ –º–∏–Ω ‚Üí –≤–æ–ª–Ω–∞ –Ω–∞ 10% –∫–æ—Ä–æ—á–µ
    medium: { threshold: 30, bonus: -0.05 },  // 30+ –º–∏–Ω ‚Üí –≤–æ–ª–Ω–∞ –Ω–∞ 5% –∫–æ—Ä–æ—á–µ
    low: { threshold: 15, bonus: -0.02 }      // 15+ –º–∏–Ω ‚Üí –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
  };

  // üö∂ STEPS ‚Äî —à–∞–≥–∏ —Ç–æ–∂–µ –≤–ª–∏—è—é—Ç –Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º –≥–ª—é–∫–æ–∑—ã
  I.STEPS_BONUS = C?.STEPS_BONUS || {
    high: { threshold: 8000, bonus: -0.08 },   // 8000+ —à–∞–≥–æ–≤ ‚Üí -8%
    medium: { threshold: 5000, bonus: -0.04 }, // 5000+ —à–∞–≥–æ–≤ ‚Üí -4%
    low: { threshold: 2000, bonus: -0.02 }     // 2000+ —à–∞–≥–æ–≤ ‚Üí -2%
  };

  // üåÖ CIRCADIAN RHYTHM ‚Äî –º–µ—Ç–∞–±–æ–ª–∏–∑–º –º–µ–Ω—è–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è
  // üî¨ v3.8.0: –ü–õ–ê–í–ù–ê–Ø —Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è –∫—Ä–∏–≤–∞—è –≤–º–µ—Å—Ç–æ —Å—Ç—É–ø–µ–Ω–µ–π (Van Cauter 1997)
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
  // - –ü–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 7-9 —É—Ç—Ä–∞ (√ó0.85)
  // - –ú–∏–Ω–∏–º—É–º: 22-02 –Ω–æ—á–∏ (√ó1.20)
  // - –ü–µ—Ä–µ—Ö–æ–¥ –ø–ª–∞–≤–Ω—ã–π, –ø—Ä–∏–≤—è–∑–∞–Ω –∫ 24-—á–∞—Å–æ–≤–æ–º—É —Ä–∏—Ç–º—É –∫–æ—Ä—Ç–∏–∑–æ–ª–∞
  I.CIRCADIAN_CONFIG = C?.CIRCADIAN_CONFIG || {
    // –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ —Å—É—Ç–æ—á–Ω–æ–≥–æ —Ä–∏—Ç–º–∞ (–¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏)
    peakHour: 8,           // –ß–∞—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (08:00)
    nadirHour: 20,         // ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–æ–ª–µ (–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º—É–ª–µ). –†–µ–∞–ª—å–Ω—ã–π –Ω–∞–¥–∏—Ä = peakHour + 12 = 20:00
    minMultiplier: 0.85,   // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤ –ø–∏–∫–µ (—É—Ç—Ä–æ) ‚Äî –≤–æ–ª–Ω–∞ –∫–æ—Ä–æ—á–µ
    maxMultiplier: 1.20,   // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤ –Ω–∞–¥–∏—Ä–µ (–Ω–æ—á—å) ‚Äî –≤–æ–ª–Ω–∞ –¥–ª–∏–Ω–Ω–µ–µ
    // –û–ø–∏—Å–∞–Ω–∏—è –¥–ª—è UI (legacy-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    descriptions: {
      earlyMorning: { from: 5, to: 7, desc: '–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ üåÖ' },
      peakMorning: { from: 7, to: 10, desc: '–ü–∏–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üåû' },
      midday: { from: 10, to: 14, desc: '–û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ‚òÄÔ∏è' },
      afternoon: { from: 14, to: 18, desc: '–î–Ω–µ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å üå§Ô∏è' },
      evening: { from: 18, to: 21, desc: '–í–µ—á–µ—Ä–Ω–∏–π —Å–ø–∞–¥ üåÜ' },
      lateEvening: { from: 21, to: 24, desc: '–ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä üåô' },
      night: { from: 0, to: 5, desc: '–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º üåë' }
    }
  };

  // Legacy –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  I.CIRCADIAN_MULTIPLIERS = C?.CIRCADIAN_MULTIPLIERS || {
    morning: { from: 6, to: 10, multiplier: 0.9, desc: '–£—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º üåÖ' },
    midday: { from: 10, to: 14, multiplier: 0.95, desc: '–û–±–µ–¥–µ–Ω–Ω—ã–π –ø–∏–∫ üåû' },
    afternoon: { from: 14, to: 18, multiplier: 1.0, desc: '–î–Ω–µ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å ‚òÄÔ∏è' },
    evening: { from: 18, to: 22, multiplier: 1.1, desc: '–í–µ—á–µ—Ä–Ω–∏–π —Å–ø–∞–¥ üåÜ' },
    night: { from: 22, to: 6, multiplier: 1.2, desc: '–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º üåô' }
  };

  // üçΩÔ∏è FASTING ‚Äî –≥–æ–ª–æ–¥–∞–Ω–∏–µ –ü–û–í–´–®–ê–ï–¢ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É (Sutton et al., 2018)
  // –ü–æ—Å–ª–µ 12+ —á–∞—Å–æ–≤ –±–µ–∑ –µ–¥—ã –æ—Ä–≥–∞–Ω–∏–∑–º –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –∏–Ω—Å—É–ª–∏–Ω—É
  // –ò–Ω—Å—É–ª–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ ‚Üí –±—ã—Å—Ç—Ä–µ–µ –æ—á–∏—â–∞–µ—Ç –≥–ª—é–∫–æ–∑—É ‚Üí –≤–æ–ª–Ω–∞ –ö–û–†–û–ß–ï
  // –ù–û: –ø—Ä–∏ –æ—á–µ–Ω—å –¥–æ–ª–≥–æ–º –≥–æ–ª–æ–¥–∞–Ω–∏–∏ (24—á+) –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
  I.FASTING_BONUS = C?.FASTING_BONUS || {
    // –ß–∞—Å—ã –≥–æ–ª–æ–¥–∞–Ω–∏—è ‚Üí –±–æ–Ω—É—Å –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –∫–æ—Ä–æ—á–µ)
    long: { threshold: 16, bonus: -0.15 },   // 16+ —á–∞—Å–æ–≤ = ‚àí15% –≤–æ–ª–Ω–∞ (–±—ã—Å—Ç—Ä–µ–µ —É—Å–≤–æ–µ–Ω–∏–µ)
    medium: { threshold: 12, bonus: -0.10 }, // 12+ —á–∞—Å–æ–≤ = ‚àí10%
    short: { threshold: 8, bonus: -0.05 }    // 8+ —á–∞—Å–æ–≤ = ‚àí5% (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
  };

  // üå∂Ô∏è SPICY FOOD ‚Äî –æ—Å—Ç—Ä–∞—è –ø–∏—â–∞ —É—Å–∫–æ—Ä—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑
  // –ö–∞–ø—Å–∞–∏—Ü–∏–Ω —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç —É–º–µ—Ä–µ–Ω–Ω—ã–π (Ludy & Mattes, 2011)
  // –†–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç ~3-5%, –Ω–µ 8%
  I.SPICY_FOOD = C?.SPICY_FOOD || {
    multiplier: 0.96,  // –ù–∞ 4% –±—ã—Å—Ç—Ä–µ–µ
    patterns: [
      /–ø–µ—Ä–µ—Ü.*—á–∏–ª–∏/i, /—á–∏–ª–∏/i, /—Ö–∞–ª–∞–ø–µ–Ω—å–æ/i, /jalapeno/i,
      /—Ç–∞–±–∞—Å–∫–æ/i, /sriracha/i, /—à—Ä–∏—Ä–∞—á–∞/i,
      /–∫–∞—Ä—Ä–∏/i, /curry/i, /–≤–∞—Å–∞–±–∏/i, /wasabi/i,
      /–≥–æ—Ä—á–∏—Ü–∞.*–æ—Å—Ç—Ä–∞—è/i, /—Ö—Ä–µ–Ω/i,
      /–æ—Å—Ç—Ä—ã–π.*—Å–æ—É—Å/i, /hot.*sauce/i,
      /–∫–∏–º—á–∏/i, /kimchi/i, /–∞–¥–∂–∏–∫–∞/i,
      /—Ö–∞—Ä–∏—Å—Å–∞/i, /harissa/i
    ]
  };

  // üç∑ ALCOHOL ‚Äî –∞–ª–∫–æ–≥–æ–ª—å –∑–∞–º–µ–¥–ª—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–∏–ø–æ–ª–∏–∑
  // –ü–µ—á–µ–Ω—å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –∞–ª–∫–æ–≥–æ–ª—è, –∏–Ω—Å—É–ª–∏–Ω –¥–æ–ª—å—à–µ –≤ –∫—Ä–æ–≤–∏
  I.ALCOHOL_BONUS = C?.ALCOHOL_BONUS || {
    high: { bonus: 0.25 },    // –ö—Ä–µ–ø–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏, –º–Ω–æ–≥–æ
    medium: { bonus: 0.18 },  // –í–∏–Ω–æ, –ø–∏–≤–æ
    low: { bonus: 0.10 },     // –°–ª–∞–±–æ–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ
    patterns: [
      /–≤–æ–¥–∫–∞/i, /–≤–∏—Å–∫–∏/i, /whisky/i, /whiskey/i, /–∫–æ–Ω—å—è–∫/i, /cognac/i,
      /—Ä–æ–º/i, /rum/i, /—Ç–µ–∫–∏–ª–∞/i, /tequila/i, /–¥–∂–∏–Ω/i, /gin/i,
      /–≤–∏–Ω–æ/i, /wine/i, /—à–∞–º–ø–∞–Ω—Å–∫–æ–µ/i, /champagne/i, /–ø—Ä–æ—Å–µ–∫–∫–æ/i,
      /–ø–∏–≤–æ/i, /beer/i, /—ç–ª—å/i, /ale/i, /–ª–∞–≥–µ—Ä/i, /lager/i,
      /—Å–∏–¥—Ä/i, /cider/i, /–ª–∏–∫—ë—Ä/i, /liqueur/i,
      /–º–∞—Ä—Ç–∏–Ω–∏/i, /–≤–µ—Ä–º—É—Ç/i, /vermouth/i,
      /–∫–æ–∫—Ç–µ–π–ª—å.*–∞–ª–∫–æ–≥–æ–ª/i, /–∞–ª–∫–æ–≥–æ–ª.*–∫–æ–∫—Ç–µ–π–ª—å/i
    ],
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫—Ä–µ–ø–æ—Å—Ç–∏
    strong: [/–≤–æ–¥–∫–∞/i, /–≤–∏—Å–∫–∏/i, /–∫–æ–Ω—å—è–∫/i, /—Ä–æ–º/i, /—Ç–µ–∫–∏–ª–∞/i, /–¥–∂–∏–Ω/i],
    medium: [/–≤–∏–Ω–æ/i, /—à–∞–º–ø–∞–Ω—Å–∫–æ–µ/i, /–ø—Ä–æ—Å–µ–∫–∫–æ/i, /–º–∞—Ä—Ç–∏–Ω–∏/i, /–≤–µ—Ä–º—É—Ç/i],
    weak: [/–ø–∏–≤–æ/i, /—Å–∏–¥—Ä/i, /—ç–ª—å/i]
  };

  // ‚ö†Ô∏è –í–∞–∂–Ω–æ: RegExp –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü —Å–ª–æ–≤–∞ –¥–∞—ë—Ç –ª–æ–∂–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
  // –ü—Ä–∏–º–µ—Ä: "—Å–≤–∏–Ω–æ-–≥–æ–≤—è–¥–∏–Ω–∞" —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Å—Ç—Ä–æ–∫—É "–≤–∏–Ω–æ".
  // –ü–æ—ç—Ç–æ–º—É –¥–ª—è –∞–ª–∫–æ–≥–æ–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω—ã (—Å–ª–æ–≤–∞) + exact/prefix –º–∞—Ç—á–∏.
  I.ALCOHOL_MATCH = C?.ALCOHOL_MATCH || {
    strongExact: ['–≤–æ–¥–∫–∞', '–≤–∏—Å–∫–∏', 'whisky', 'whiskey', '–∫–æ–Ω—å—è–∫', 'cognac', '—Ç–µ–∫–∏–ª–∞', 'tequila', '–¥–∂–∏–Ω', 'gin', '—Ä–æ–º', 'rum'],
    mediumExact: ['–≤–∏–Ω–æ', 'wine', '—à–∞–º–ø–∞–Ω—Å–∫–æ–µ', 'champagne', '–ø—Ä–æ—Å–µ–∫–∫–æ', '–º–∞—Ä—Ç–∏–Ω–∏', 'martini', '–≤–µ—Ä–º—É—Ç', 'vermouth'],
    weakExact: ['–ø–∏–≤–æ', 'beer', '—Å–∏–¥—Ä', 'cider', '—ç–ª—å', 'ale', '–ª–∞–≥–µ—Ä', 'lager', '–ª–∏–∫–µ—Ä', 'liqueur'],
    // Prefix ‚Äî –¥–ª—è —Å–ª–æ–≤–æ—Ñ–æ—Ä–º/—Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —Å–ª–æ–≤ (–Ω–æ –∏–∑–±–µ–≥–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫–æ—Ä–Ω–µ–π —Ç–∏–ø–∞ "—Ä–æ–º")
    strongPrefix: ['–∞–ª–∫–æ–≥–æ–ª', 'alcohol'],
    mediumPrefix: [],
    weakPrefix: ['–ª–∞–≥–µ—Ä'],
    // –ö–æ–º–±–æ-—Ñ—Ä–∞–∑—ã: –∫–æ–∫—Ç–µ–π–ª—å + –∞–ª–∫–æ–≥–æ–ª—å (–ª—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫)
    comboAll: ['–∫–æ–∫—Ç–µ–π–ª', 'cocktail'],
  };

  function normalizeTextForTokenMatch(s) {
    return String(s || '')
      .toLowerCase()
      .replace(/—ë/g, '–µ')
      // –í—Å—ë –∫—Ä–æ–º–µ –±—É–∫–≤/—Ü–∏—Ñ—Ä ‚Üí –ø—Ä–æ–±–µ–ª
      .replace(/[^a-z0-9–∞-—è–µ]+/gi, ' ')
      .trim()
      .replace(/\s+/g, ' ');
  }

  function tokenizeText(sNorm) {
    return sNorm ? sNorm.split(' ') : [];
  }

  function tokensHasExact(tokens, exactList) {
    if (!tokens.length || !exactList?.length) return false;
    const set = new Set(exactList);
    return tokens.some((t) => set.has(t));
  }

  function tokensHasPrefix(tokens, prefixList) {
    if (!tokens.length || !prefixList?.length) return false;
    return tokens.some((t) => prefixList.some((p) => t.startsWith(p)));
  }

  function tokensHasAll(tokens, words) {
    if (!tokens.length || !words?.length) return false;
    return words.every((w) => tokens.some((t) => t.startsWith(w)));
  }

  function testPatterns(patterns, text) {
    if (!Array.isArray(patterns)) return false;
    return patterns.some((p) => p && typeof p.test === 'function' && p.test(text));
  }

  // ‚òï CAFFEINE ‚Äî –∫–æ—Ñ–µ–∏–Ω –∏–º–µ–µ—Ç –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω
  // –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã: –æ—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç ~5-10%, –Ω–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ –Ω–µ–π—Ç—Ä–∞–ª–µ–Ω (Lane, 2011)
  I.CAFFEINE_BONUS = C?.CAFFEINE_BONUS || {
    bonus: 0.06,  // +6% –∫ –≤–æ–ª–Ω–µ (–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
    patterns: [
      /–∫–æ—Ñ–µ/i, /coffee/i, /—ç—Å–ø—Ä–µ—Å—Å–æ/i, /espresso/i,
      /–∫–∞–ø—É—á–∏–Ω–æ/i, /cappuccino/i, /–ª–∞—Ç—Ç–µ/i, /latte/i,
      /–∞–º–µ—Ä–∏–∫–∞–Ω–æ/i, /americano/i, /–º–æ–∫–∫–æ/i, /mocha/i,
      /—á–∞–π.*—á—ë—Ä–Ω—ã–π/i, /—á—ë—Ä–Ω—ã–π.*—á–∞–π/i, /black.*tea/i,
      /—á–∞–π.*–∑–µ–ª—ë–Ω—ã–π/i, /–∑–µ–ª—ë–Ω—ã–π.*—á–∞–π/i, /green.*tea/i,
      /–º–∞—Ç—á–∞/i, /matcha/i, /–ø—É—ç—Ä/i,
      /—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫/i, /energy.*drink/i, /red.*bull/i, /monster/i,
      /–∫–æ–ª–∞/i, /cola/i, /–ø–µ–ø—Å–∏/i, /pepsi/i
    ]
  };

  // üò∞ STRESS ‚Äî –∫–æ—Ä—Ç–∏–∑–æ–ª –ø–æ–≤—ã—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω –∏ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // –í—ã—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å—Å = –¥–æ–ª—å—à–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞
  // ‚ö†Ô∏è –®–∫–∞–ª–∞ —Å—Ç—Ä–µ—Å—Å–∞ –≤ HEYS: 1-10 (–Ω–µ 1-5!)
  I.STRESS_BONUS = C?.STRESS_BONUS || {
    high: { threshold: 7, bonus: 0.15 },    // –°—Ç—Ä–µ—Å—Å 7-10 ‚Üí +15%
    medium: { threshold: 5, bonus: 0.08 },  // –°—Ç—Ä–µ—Å—Å 5-6 ‚Üí +8%
    low: { threshold: 3, bonus: 0.00 }      // –°—Ç—Ä–µ—Å—Å 1-4 ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üò¥ SLEEP DEPRIVATION ‚Äî –Ω–µ–¥–æ—Å—ã–ø –ø–æ–≤—ã—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // –î–∞–∂–µ –æ–¥–Ω–∞ –Ω–æ—á—å –ø–ª–æ—Ö–æ–≥–æ —Å–Ω–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ 20-30%
  I.SLEEP_BONUS = C?.SLEEP_BONUS || {
    severe: { maxHours: 4, bonus: 0.20 },   // <4—á —Å–Ω–∞ ‚Üí +20%
    moderate: { maxHours: 5, bonus: 0.15 }, // 4-5—á ‚Üí +15%
    mild: { maxHours: 6, bonus: 0.08 },     // 5-6—á ‚Üí +8%
    normal: { maxHours: 24, bonus: 0.00 }   // 6+ —á–∞—Å–æ–≤ ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üåü SLEEP QUALITY ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –≤–ª–∏—è–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  // –ü–ª–æ—Ö–æ–π —Å–æ–Ω (—á–∞—Å—Ç—ã–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è, –Ω–µ–≥–ª—É–±–æ–∫–∏–π) —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // Tasali et al. (2008): —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–æ–Ω = +23% –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  // üî¨ v3.7.4: –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚Äî +23% —ç—Ç–æ –¥–ª—è –ö–õ–ò–ù–ò–ß–ï–°–ö–ò –ø–ª–æ—Ö–æ–≥–æ —Å–Ω–∞ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏
  // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—ã—Ç–æ–≤–æ–≥–æ –ø–ª–æ—Ö–æ–≥–æ —Å–Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç ~8%
  // ‚ö†Ô∏è –®–∫–∞–ª–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ HEYS: 1-10
  I.SLEEP_QUALITY_BONUS = C?.SLEEP_QUALITY_BONUS || {
    poor: { maxQuality: 4, bonus: 0.08 },      // –ö–∞—á–µ—Å—Ç–≤–æ 1-4 ‚Üí +8% (–±—ã–ª–æ +12%)
    mediocre: { maxQuality: 6, bonus: 0.04 },  // –ö–∞—á–µ—Å—Ç–≤–æ 5-6 ‚Üí +4% (–±—ã–ª–æ +6%)
    good: { maxQuality: 10, bonus: 0.00 }      // –ö–∞—á–µ—Å—Ç–≤–æ 7-10 ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üíß HYDRATION ‚Äî –¥–µ–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è —É—Ö—É–¥—à–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –≥–ª—é–∫–æ–∑—ã
  // Carroll et al. (2016): –¥–µ–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –ø–æ–≤—ã—à–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª –∏ –≥–ª—é–∫–æ–∑—É
  // üî¨ v3.7.4: –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –¥–µ–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω ~5-8%, –Ω–µ 12%
  // –ù–æ—Ä–º–∞: ~30 –º–ª/–∫–≥ —á–∏—Å—Ç–æ–π –≤–æ–¥—ã –≤ –¥–µ–Ω—å (–¥–ª—è 70–∫–≥ ‚âà 2100–º–ª)
  // IOM 2004: 30 –º–ª/–∫–≥ ‚Äî –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –Ω–æ—Ä–º–∞ –¥–ª—è —á–∏—Å—Ç–æ–π –≤–æ–¥—ã (–±–µ–∑ —É—á—ë—Ç–∞ –≤–æ–¥—ã –∏–∑ –ø–∏—â–∏)
  I.HYDRATION_BONUS = C?.HYDRATION_BONUS || {
    // –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –Ω–æ—Ä–º—ã ‚Üí –±–æ–Ω—É—Å
    severe: { maxPct: 30, bonus: 0.08 },    // <30% –Ω–æ—Ä–º—ã ‚Üí +8% (–±—ã–ª–æ +12%)
    moderate: { maxPct: 50, bonus: 0.05 },  // 30-50% ‚Üí +5% (–±—ã–ª–æ +8%)
    mild: { maxPct: 70, bonus: 0.03 },      // 50-70% ‚Üí +3% (–±—ã–ª–æ +4%)
    normal: { maxPct: 100, bonus: 0.00 }    // 70%+ ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üë¥ AGE ‚Äî —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–û —Å–Ω–∏–∂–∞–µ—Ç—Å—è
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–£ 70-–ª–µ—Ç–Ω–∏—Ö AUC –∏–Ω—Å—É–ª–∏–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ ~1.5 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ (+50%)'
  // DeFronzo (1979): –∫–∞–∂–¥—ã–µ 10 –ª–µ—Ç = -7-8% —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  // Chen (1985): —É –ø–æ–∂–∏–ª—ã—Ö –ø–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞ –≤—ã—à–µ, –∫–ª–∏—Ä–µ–Ω—Å –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  I.AGE_BONUS = C?.AGE_BONUS || {
    senior: { minAge: 70, bonus: 0.40 },    // 70+ –ª–µ—Ç ‚Üí +40% (–ø–æ—á—Ç–∏ √ó1.5)
    elderly: { minAge: 60, bonus: 0.25 },   // 60-69 ‚Üí +25%
    middle: { minAge: 45, bonus: 0.12 },    // 45-59 ‚Üí +12%
    adult: { minAge: 30, bonus: 0.06 },     // 30-44 ‚Üí +6%
    young: { minAge: 0, bonus: 0.00 }       // <30 ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üèãÔ∏è BMI ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å —Å–Ω–∏–∂–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  // Kahn & Flier (2000): –∫–∞–∂–¥—ã–µ +5 –µ–¥–∏–Ω–∏—Ü BMI = -30% —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  I.BMI_BONUS = C?.BMI_BONUS || {
    obese: { minBMI: 30, bonus: 0.20 },     // –û–∂–∏—Ä–µ–Ω–∏–µ (BMI 30+) ‚Üí +20%
    overweight: { minBMI: 25, bonus: 0.10 }, // –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å (25-30) ‚Üí +10%
    normal: { minBMI: 0, bonus: 0.00 }      // –ù–æ—Ä–º–∞ (<25) ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üö∫üöπ GENDER ‚Äî –∂–µ–Ω—â–∏–Ω—ã –∏–º–µ—é—Ç –ª—É—á—à—É—é –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  // Nuutila et al. (1995): –∂–µ–Ω—â–∏–Ω—ã ~15% —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–µ–µ –º—É–∂—á–∏–Ω
  I.GENDER_BONUS = C?.GENDER_BONUS || {
    male: 0.05,    // –ú—É–∂—á–∏–Ω—ã ‚Üí +5% –∫ –≤–æ–ª–Ω–µ
    female: -0.05, // –ñ–µ–Ω—â–∏–Ω—ã ‚Üí -5% –∫ –≤–æ–ª–Ω–µ
    other: 0.00    // –î—Ä—É–≥–æ–µ ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // üçü TRANS FATS ‚Äî —Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã —É—Ö—É–¥—à–∞—é—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  // Salmer√≥n et al. (2001): —Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã = +39% —Ä–∏—Å–∫–∞ –¥–∏–∞–±–µ—Ç–∞
  I.TRANS_FAT_BONUS = C?.TRANS_FAT_BONUS || {
    high: { threshold: 2, bonus: 0.15 },    // 2+ –≥ —Ç—Ä–∞–Ω—Å-–∂–∏—Ä–æ–≤ ‚Üí +15%
    medium: { threshold: 1, bonus: 0.08 },  // 1-2 –≥ ‚Üí +8%
    low: { threshold: 0.5, bonus: 0.04 },   // 0.5-1 –≥ ‚Üí +4%
    none: { threshold: 0, bonus: 0.00 }     // <0.5 –≥ ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï –ù–û–í–´–ï –§–ê–ö–¢–û–†–´ v3.1.0 (2025-12-10) ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—É—á–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ChatGPT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // üçΩÔ∏è MEAL ORDER ‚Äî –ø–æ—Ä—è–¥–æ–∫ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∏—â–∏ –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–û –≤–ª–∏—è–µ—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–£–≥–ª–µ–≤–æ–¥—ã –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –¥–∞–ª–∏ ‚Üì –≥–ª—é–∫–æ–∑—ã –Ω–∞ 30-37% —á–µ—Ä–µ–∑ 30-60 –º–∏–Ω –∏ ‚Üì –∏–Ω—Å—É–ª–∏–Ω–∞ –Ω–∞ ~20-40%'
  // Shukla et al. 2015, Alpana et al. 2017: vegetables ‚Üí protein ‚Üí carbs = optimal
  // –ú–µ—Ö–∞–Ω–∏–∑–º: –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –∏ –±–µ–ª–æ–∫ –∑–∞–º–µ–¥–ª—è—é—Ç –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∂–µ–ª—É–¥–∫–∞ –ø–µ—Ä–µ–¥ —É–≥–ª–µ–≤–æ–¥–∞–º–∏
  I.MEAL_ORDER_BONUS = C?.MEAL_ORDER_BONUS || {
    carbsLast: -0.25,       // –£–≥–ª–µ–≤–æ–¥—ã –≤ –∫–æ–Ω—Ü–µ ‚Üí -25% –≤–æ–ª–Ω–∞
    carbsFirst: 0.10,       // –£–≥–ª–µ–≤–æ–¥—ã —Å–Ω–∞—á–∞–ª–∞ ‚Üí +10% –≤–æ–ª–Ω–∞  
    mixed: 0.00             // –°–º–µ—à–∞–Ω–Ω–æ ‚Üí –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
    // TODO: –î–µ—Ç–µ–∫—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ timestamps –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏—ë–º–∞
  };

  // üçé FOOD FORM ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –ø–∏—â–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —É—Å–≤–æ–µ–Ω–∏—è
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–ñ–∏–¥–∫–∏–µ –∫–∞–ª–æ—Ä–∏–∏ = +30-50% –ø–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞, —Ü–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã = –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–π –æ—Ç–≤–µ—Ç'
  // '–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (refined) = –±—ã—Å—Ç—Ä–µ–µ —É—Å–≤–æ–µ–Ω–∏–µ'
  // Flood-Obbagy & Rolls 2009: apple vs apple sauce vs apple juice
  I.FOOD_FORM_BONUS = C?.FOOD_FORM_BONUS || {
    liquid: { multiplier: 1.30, desc: '–ñ–∏–¥–∫–æ–µ ‚Üí +30% –ø–∏–∫' },
    processed: { multiplier: 1.15, desc: '–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ ‚Üí +15%' },
    whole: { multiplier: 0.85, desc: '–¶–µ–ª—å–Ω–æ–µ ‚Üí -15%' },
    mixed: { multiplier: 1.0, desc: '–°–º–µ—à–∞–Ω–Ω–æ–µ ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è' },
    // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
    liquidPatterns: [/—Å–æ–∫\b/i, /—Å–º—É–∑–∏/i, /–∫–æ–∫—Ç–µ–π–ª—å/i, /–Ω–∞–ø–∏—Ç–æ–∫/i],
    processedPatterns: [/—Ö–ª–æ–ø—å—è/i, /–º—é—Å–ª–∏.*–≥–æ—Ç–æ–≤/i, /–±—ã—Å—Ç—Ä.*–∫–∞—à–∞/i, /–ø—é—Ä–µ.*–ø–∞–∫–µ—Ç/i],
    wholePatterns: [/—Å—ã—Ä–æ–π/i, /—Å–≤–µ–∂–∏–π/i, /—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω/i, /–æ—Ä–µ—Ö/i, /—Å–µ–º–µ–Ω–∞/i]
  };

  // ü•î RESISTANT STARCH ‚Äî –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–µ –∫—Ä–∞—Ö–º–∞–ª—ã —á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–û—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–π —Ä–∏—Å/–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å: -15-20% –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç'
  // Robertson et al. 2005: resistant starch improves insulin sensitivity
  // –ú–µ—Ö–∞–Ω–∏–∑–º: —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–∞—Ü–∏—è –∫—Ä–∞—Ö–º–∞–ª–∞ –ø—Ä–∏ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–∏ ‚Üí RS3
  I.RESISTANT_STARCH_BONUS = C?.RESISTANT_STARCH_BONUS || {
    cooled: -0.15,  // –û—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–µ –∫—Ä–∞—Ö–º–∞–ª—ã ‚Üí -15% –≤–æ–ª–Ω–∞
    patterns: [
      /—Ö–æ–ª–æ–¥–Ω.*—Ä–∏—Å/i, /—Ä–∏—Å.*—Ö–æ–ª–æ–¥–Ω/i,
      /—Ö–æ–ª–æ–¥–Ω.*–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å/i, /–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å.*—Ö–æ–ª–æ–¥–Ω/i,
      /–æ–∫—Ä–æ—à–∫–∞/i, /—Å–∞–ª–∞—Ç.*–∫–∞—Ä—Ç–æ—Ñ–µ–ª/i, /–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π.*—Å–∞–ª–∞—Ç/i,
      /—Å—É—à–∏/i, /—Ä–æ–ª–ª/i  // –†–∏—Å –≤ —Å—É—à–∏ –æ–±—ã—á–Ω–æ –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–π
    ]
  };

  // üå°Ô∏è FOOD TEMPERATURE ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–∏—â–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —É—Å–≤–æ–µ–Ω–∏—è (v3.8.0)
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Vald√©s-Ramos 2019, Sun et al. 1988
  // "Hot meals accelerate gastric emptying by 15-25% compared to cold"
  // –ú–µ—Ö–∞–Ω–∏–∑–º: —Ç—ë–ø–ª–∞—è –ø–∏—â–∞ –±—ã—Å—Ç—Ä–µ–µ –ø–æ–∫–∏–¥–∞–µ—Ç –∂–µ–ª—É–¥–æ–∫ ‚Üí –±—ã—Å—Ç—Ä–µ–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
  // –ù–û: –±—ã—Å—Ç—Ä–µ–µ –ø–∏–∫ = –±—ã—Å—Ç—Ä–µ–µ —Å–ø–∞–¥? –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–∞–≤–∞
  // –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å: –≥–æ—Ä—è—á–µ–µ +8% –≤–æ–ª–Ω–∞ (–±–æ–ª–µ–µ —Ä–µ–∑–∫–∏–π, –Ω–æ —Ç–∞–∫–æ–π –∂–µ –ø–æ –¥–ª–∏–Ω–µ)
  I.FOOD_TEMPERATURE_BONUS = C?.FOOD_TEMPERATURE_BONUS || {
    hot: {
      bonus: 0.08,        // +8% –∫ –≤–æ–ª–Ω–µ (–±—ã—Å—Ç—Ä–µ–µ –ø–∏–∫, –Ω–æ —á—É—Ç—å –¥–æ–ª—å—à–µ –≤–æ–∑–≤—Ä–∞—Ç)
      peakBoost: 1.15,    // –ü–∏–∫ +15% (–±–æ–ª–µ–µ —Ä–µ–∑–∫–∏–π)
      patterns: [/—Å—É–ø/i, /–±–æ—Ä—â/i, /–≥–æ—Ä—è—á/i, /–∫–∞—à–∞/i, /–ø—é—Ä–µ(?!.*–ø–∞–∫–µ—Ç)/i, /—Ä–∞–≥—É/i, /–∂–∞—Ä–∫/i, /–≤–∞—Ä–µ–Ω/i, /—Ç—É—à–µ–Ω/i, /–∑–∞–ø–µ—á–µ–Ω/i, /–ø–µ—á–µ–Ω/i, /–∂–∞—Ä–µ–Ω/i, /–≥—Ä–∏–ª—å/i],
      desc: 'üî• –ì–æ—Ä—è—á–µ–µ ‚Üí –±—ã—Å—Ç—Ä–µ–µ –ø–∏–∫'
    },
    cold: {
      bonus: -0.05,       // -5% –∫ –≤–æ–ª–Ω–µ (–º–µ–¥–ª–µ–Ω–Ω–µ–µ —É—Å–≤–æ–µ–Ω–∏–µ)
      peakBoost: 0.90,    // –ü–∏–∫ -10% (–±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–π)
      patterns: [/—Ö–æ–ª–æ–¥–Ω/i, /–º–æ—Ä–æ–∂–µ–Ω–æ–µ/i, /ice.*cream/i, /—Å–º—É–∑–∏/i, /—Å–∞–ª–∞—Ç/i, /–æ–∫—Ä–æ—à–∫–∞/i, /–≥–∞—Å–ø–∞—á–æ/i, /–æ—Ö–ª–∞–∂–¥/i],
      desc: '‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–æ–µ ‚Üí –ø–ª–∞–≤–Ω–µ–µ –≤–æ–ª–Ω–∞'
    },
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∫–æ–º–Ω–∞—Ç–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –Ω–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
    room: { bonus: 0, peakBoost: 1.0, desc: '–ö–æ–º–Ω–∞—Ç–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞' }
  };

  // üçΩÔ∏è LARGE PORTIONS ‚Äî –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –ø–æ—Ä—Ü–∏—è—Ö (v3.8.0)
  // üî¨ –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Collins et al. 1991, Hunt & Stubbs 1975
  // "Meals >1000 kcal slow gastric emptying by 30-50%"
  // "Gastric distension activates vagal inhibition of emptying"
  // –ú–µ—Ö–∞–Ω–∏–∑–º: –±–æ–ª—å—à–∞—è –ø–æ—Ä—Ü–∏—è ‚Üí –∂–µ–ª—É–¥–æ–∫ —Ä–∞—Å—Ç—è–Ω—É—Ç ‚Üí –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ
  // –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–æ–ª—å—à–µ –≤–æ–ª–Ω–∞, –Ω–æ –Ω–∏–∂–µ –ø–∏–∫ (—Ä–∞—Å—Ç—è–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç)
  I.LARGE_PORTION_BONUS = C?.LARGE_PORTION_BONUS || {
    thresholds: [
      { minKcal: 1200, bonus: 0.25, peakReduction: 0.80, desc: '>1200 –∫–∫–∞–ª ‚Üí +25% –≤–æ–ª–Ω–∞, -20% –ø–∏–∫' },
      { minKcal: 1000, bonus: 0.18, peakReduction: 0.85, desc: '>1000 –∫–∫–∞–ª ‚Üí +18% –≤–æ–ª–Ω–∞' },
      { minKcal: 800, bonus: 0.10, peakReduction: 0.90, desc: '>800 –∫–∫–∞–ª ‚Üí +10% –≤–æ–ª–Ω–∞' },
      { minKcal: 600, bonus: 0.05, peakReduction: 0.95, desc: '>600 –∫–∫–∞–ª ‚Üí +5% –≤–æ–ª–Ω–∞' }
    ],
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å (–∑–∞—â–∏—Ç–∞ –æ—Ç —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
    maxBonus: 0.30
  };

  // üß™ –ü–û–†–û–ì –õ–ò–ü–û–õ–ò–ó–ê ‚Äî –ø—Ä–∏ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –∏–Ω—Å—É–ª–∏–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–ü—Ä–∏ –∏–Ω—Å—É–ª–∏–Ω–µ ~15-20 ¬µ–ï–¥/–º–ª = ~50% —É–≥–Ω–µ—Ç–µ–Ω–∏–µ –ª–∏–ø–æ–ª–∏–∑–∞'
  // '–ü—Ä–∏ ~50-100 ¬µ–ï–¥/–º–ª = –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª–Ω–æ–µ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ'
  // Campbell et al. 1992, Jensen et al. 1989
  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ UI
  I.LIPOLYSIS_THRESHOLDS = C?.LIPOLYSIS_THRESHOLDS || {
    full: { insulinUIml: 5, lipolysisPct: 100, desc: '–ü–æ–ª–Ω—ã–π –ª–∏–ø–æ–ª–∏–∑' },        // <5 ¬µ–ï–¥/–º–ª
    partial: { insulinUIml: 15, lipolysisPct: 50, desc: '~50% –ª–∏–ø–æ–ª–∏–∑–∞' },      // 15 ¬µ–ï–¥/–º–ª
    suppressed: { insulinUIml: 50, lipolysisPct: 10, desc: '–õ–∏–ø–æ–ª–∏–∑ –ø–æ–¥–∞–≤–ª–µ–Ω' }, // 50 ¬µ–ï–¥/–º–ª
    blocked: { insulinUIml: 100, lipolysisPct: 0, desc: '–õ–∏–ø–æ–ª–∏–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' } // 100+ ¬µ–ï–¥/–º–ª
  };

  // ‚ö° REACTIVE HYPOGLYCEMIA ‚Äî —Ä–∏—Å–∫ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≥–∏–ø–æ–≥–ª–∏–∫–µ–º–∏–∏
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10 (ChatGPT Research):
  // '–ß–µ—Ä–µ–∑ 2-4 —á–∞—Å–∞ –ø–æ—Å–ª–µ –≤—ã—Å–æ–∫–æ-GI –µ–¥—ã –≤–æ–∑–º–æ–∂–µ–Ω "–ø—Ä–æ–≤–∞–ª" –≥–ª—é–∫–æ–∑—ã'
  // '–û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏: –≤—ã—Å–æ–∫–∏–π GI + –Ω–∏–∑–∫–∏–π –±–µ–ª–æ–∫/–∂–∏—Ä + –Ω–∞—Ç–æ—â–∞–∫'
  // Brun et al. 1995: reactive hypoglycemia patterns
  // 
  // üÜï v3.8.0: –î–æ–±–∞–≤–ª–µ–Ω UI –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
  I.REACTIVE_HYPOGLYCEMIA = C?.REACTIVE_HYPOGLYCEMIA || {
    riskWindow: { start: 120, end: 240 },  // 2-4 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã (–≤ –º–∏–Ω—É—Ç–∞—Ö)
    riskFactors: {
      highGI: { threshold: 70, weight: 0.4 },     // GI > 70
      lowProtein: { threshold: 10, weight: 0.3 }, // < 10–≥ –±–µ–ª–∫–∞
      lowFat: { threshold: 5, weight: 0.2 },      // < 5–≥ –∂–∏—Ä–∞
      fasted: { weight: 0.1 }                     // –ù–∞—Ç–æ—â–∞–∫
    },
    // –ï—Å–ª–∏ —Å—É–º–º–∞ weights > 0.6 ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    warningThreshold: 0.6,
    // üÜï v3.8.0: UI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ui: {
      warningEmoji: '‚ö°',
      warningColor: '#f97316',  // –û—Ä–∞–Ω–∂–µ–≤—ã–π
      warningTitle: '–†–∏—Å–∫ –≥–æ–ª–æ–¥–∞ —á–µ—Ä–µ–∑ 2-4 —á–∞—Å–∞',
      warningDesc: '–í—ã—Å–æ–∫–∏–π –ì–ò –±–µ–∑ –±–µ–ª–∫–∞/–∂–∏—Ä–∞ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ä–µ–∑–∫–∏–π –≥–æ–ª–æ–¥',
      advice: [
        '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫ (—è–π—Ü–æ, —Ç–≤–æ—Ä–æ–≥, –æ—Ä–µ—Ö–∏) ‚Äî –∑–∞–º–µ–¥–ª–∏—Ç —É—Å–≤–æ–µ–Ω–∏–µ',
        '–î–æ–±–∞–≤—å –∂–∏—Ä—ã (–∞–≤–æ–∫–∞–¥–æ, –º–∞—Å–ª–æ) ‚Äî —Å–≥–ª–∞–¥–∏—Ç –ø–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞',
        '–ü–ª–∞–Ω–∏—Ä—É–π –ø–µ—Ä–µ–∫—É—Å —á–µ—Ä–µ–∑ 2-3 —á–∞—Å–∞'
      ],
      // –°–∏–º–ø—Ç–æ–º—ã –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      symptoms: ['–†–µ–∑–∫–∏–π –≥–æ–ª–æ–¥', '–°–ª–∞–±–æ—Å—Ç—å', '–†–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ü–æ—Ç–ª–∏–≤–æ—Å—Ç—å', '–¢—Ä–µ–º–æ—Ä']
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ÔøΩ NEXT-DAY TRAINING EFFECT (NDTE) ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –≤—á–µ—Ä–∞—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  // –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2025-12-11
  //
  // –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞:
  // - Magkos et al., Clinical Science, 2008: >900 –∫–∫–∞–ª ‚Üí HOMA-IR -32%
  // - Mikines et al., Am J Physiol, 1988: 600-800 –∫–∫–∞–ª ‚Üí +48—á —ç—Ñ—Ñ–µ–∫—Ç
  // - Jamurtas et al., Eur J Appl Physiol, 2004: REE +5-15% –Ω–∞ 10-48—á
  // - Cartee 2011, Bird 2017: 12-48—á –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  //
  // –≠—Ñ—Ñ–µ–∫—Ç—ã:
  // 1. TDEE –±—É—Å—Ç: +4% –¥–æ +15% –∫ –±–∞–∑–æ–≤–æ–º—É –º–µ—Ç–∞–±–æ–ª–∏–∑–º—É
  // 2. –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞: -8% –¥–æ -35% –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  // 3. –ü–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞: -10% –¥–æ -40% –∞–º–ø–ª–∏—Ç—É–¥–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  I.NDTE = C?.NDTE || {
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ (—á–∞—Å—ã)
    maxWindowHours: 48,

    // –ü–æ—Ä–æ–≥–∏ —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –±–æ–Ω—É—Å—ã
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Magkos 2008 ‚Äî –ø–æ—Ä–æ–≥ ~900 –∫–∫–∞–ª –¥–ª—è –∑–Ω–∞—á–∏–º–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
    kcalTiers: [
      {
        minKcal: 900,
        tdeeBoost: 0.10,      // +10% –∫ REE (Jamurtas 2004)
        waveReduction: 0.25,  // -25% –≤–æ–ª–Ω–∞ (Mikines 1988: 23% –º–µ–Ω—å—à–µ –∏–Ω—Å—É–ª–∏–Ω–∞)
        peakReduction: 0.30,  // -30% –ø–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞
        label: 'üî• –ú–æ—â–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'
      },
      {
        minKcal: 500,
        tdeeBoost: 0.07,      // +7% –∫ REE
        waveReduction: 0.15,  // -15% –≤–æ–ª–Ω–∞
        peakReduction: 0.20,  // -20% –ø–∏–∫
        label: 'üí™ –•–æ—Ä–æ—à–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞'
      },
      {
        minKcal: 300,
        tdeeBoost: 0.04,      // +4% –∫ REE
        waveReduction: 0.08,  // -8% –≤–æ–ª–Ω–∞
        peakReduction: 0.10,  // -10% –ø–∏–∫
        label: '‚ö° –õ—ë–≥–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
      }
    ],

    // BMI –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä ‚Äî –ª—é–¥–∏ —Å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –≤–µ—Å–æ–º –ø–æ–ª—É—á–∞—é—Ç –ë–û–õ–¨–®–ï –ø–æ–ª—å–∑—ã
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: —É –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç 50-80% (vs 20-50% —É –∑–¥–æ—Ä–æ–≤—ã—Ö)
    bmiMultiplier: {
      obese: { minBMI: 30, multiplier: 1.8 },     // BMI 30+ ‚Üí √ó1.8 (–±—ã–ª–æ +80%)
      overweight: { minBMI: 25, multiplier: 1.4 }, // BMI 25-30 ‚Üí √ó1.4 (+40%)
      normal: { minBMI: 18.5, multiplier: 1.0 },   // BMI –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Üí √ó1.0
      underweight: { minBMI: 0, multiplier: 0.8 }  // –ù–µ–¥–æ–≤–µ—Å ‚Üí √ó0.8 (–º–µ–Ω—å—à–µ –∑–∞–ø–∞—Å–æ–≤)
    },

    // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ (decay) —ç—Ñ—Ñ–µ–∫—Ç–∞
    // Mikines 1988: —ç—Ñ—Ñ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 48—á, –Ω–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –æ—Å–ª–∞–±–µ–≤–∞–µ—Ç
    decay: {
      halfLifeHours: 16.6,  // –ü–æ–ª–æ–≤–∏–Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç–µ—Ä—è–µ—Ç—Å—è –∑–∞ ~17—á (exp decay)
      // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
      tiers: [
        { maxHours: 12, multiplier: 1.0 },   // 0-12—á: –ø–æ–ª–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
        { maxHours: 24, multiplier: 0.8 },   // 12-24—á: 80%
        { maxHours: 36, multiplier: 0.5 },   // 24-36—á: 50%
        { maxHours: 48, multiplier: 0.25 }   // 36-48—á: 25%
      ]
    },

    // –£—á—ë—Ç —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    // Jamurtas 2004: —Å–∏–ª–æ–≤–∞—è –¥–∞—ë—Ç –±–æ–ª–µ–µ –¥–æ–ª–≥–∏–π EPOC, –∫–∞—Ä–¥–∏–æ ‚Äî –±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç –≤ –ø–µ—Ä–≤—ã–µ —á–∞—Å—ã
    typeMultiplier: {
      strength: { tdee: 1.2, wave: 0.9 },  // –°–∏–ª–æ–≤–∞—è: +20% –∫ TDEE –±—É—Å—Ç—É, -10% –∫ –≤–æ–ª–Ω–µ
      cardio: { tdee: 1.0, wave: 1.1 },    // –ö–∞—Ä–¥–∏–æ: —Å—Ç–∞–Ω–¥–∞—Ä—Ç TDEE, +10% –∫ –≤–æ–ª–Ω–µ
      hobby: { tdee: 0.8, wave: 0.8 }      // –•–æ–±–±–∏: –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    },

    // –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    // –ï—Å–ª–∏ –≤—á–µ—Ä–∞ –±—ã–ª–æ 2+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è (—Å diminishing returns)
    cumulative: {
      enabled: true,
      maxMultiplier: 1.5  // –ú–∞–∫—Å–∏–º—É–º √ó1.5 –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
    },

    // UI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    badge: 'üî• –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
    badgeColor: '#10b981'  // –ó–µ–ª—ë–Ω—ã–π (–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ÔøΩüèãÔ∏è TRAINING CONTEXT ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
  // –í–µ—Ä—Å–∏—è: 3.3.0 | –î–∞—Ç–∞: 2025-12-11
  // 
  // 10 –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:
  // 1. PERI-WORKOUT: –ï–¥–∞ –í–û –í–†–ï–ú–Ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí –≤–æ–ª–Ω–∞ –¥–æ -60%, harm √ó0.5
  // 2. POST-WORKOUT: –ï–¥–∞ –ü–û–°–õ–ï ‚Üí –≤–æ–ª–Ω–∞ –¥–æ -40%, –Ω–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
  // 3. PRE-WORKOUT: –ï–¥–∞ –î–û ‚Üí –≤–æ–ª–Ω–∞ -10...-20%
  // 4. STEPS: >10k —à–∞–≥–æ–≤ + —É–∂–∏–Ω ‚Üí -10%
  // 5. MORNING: –£—Ç—Ä–µ–Ω–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Üí –≤–µ—Å—å –¥–µ–Ω—å -5%
  // 6. DOUBLE DAY: 2+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Üí –≤–µ—Å—å –¥–µ–Ω—å -10%
  // 7. FASTED: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—Ç–æ—â–∞–∫ ‚Üí POST √ó1.3
  // 8. STRENGTH+PROTEIN: –ë–µ–ª–æ–∫ ‚â•30–≥ –ø–æ—Å–ª–µ —Å–∏–ª–æ–≤–æ–π ‚Üí harm √ó0.8
  // 9. CARDIO+SIMPLE: –ü—Ä–æ—Å—Ç—ã–µ –ø–æ—Å–ª–µ –∫–∞—Ä–¥–∏–æ ‚Üí —à—Ç—Ä–∞—Ñ √ó0.5
  // 10. NIGHT OVERRIDE: POST-WORKOUT –æ—Ç–º–µ–Ω—è–µ—Ç –Ω–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ
  //
  // –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞: Ivy & Kuo 1998, Colberg 2010, Erickson 2017
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  I.TRAINING_CONTEXT = C?.TRAINING_CONTEXT || {
    // === 1. PERI-WORKOUT: –ï–¥–∞ –í–û –í–†–ï–ú–Ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
    // –ú—ã—à—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ –ø–æ—Ç—Ä–µ–±–ª—è—é—Ç –≥–ª—é–∫–æ–∑—É —á–µ—Ä–µ–∑ GLUT4 (non-insulin-dependent)
    // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞ ‚Äî –≥–ª—é–∫–æ–∑–∞ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ç–æ–ø–ª–∏–≤–æ
    periWorkout: {
      maxBonus: -0.60,           // –î–æ -60% –∫ –≤–æ–ª–Ω–µ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏)
      harmMultiplier: 0.5,       // –í—Ä–µ–¥ √ó0.5 (—Å–∞—Ö–∞—Ä = —Ç–æ–ø–ª–∏–≤–æ, –Ω–µ –≤—Ä–µ–¥)
      badge: 'üèãÔ∏è –¢–æ–ø–ª–∏–≤–æ',
      desc: '–ï–¥–∞ –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí —ç–Ω–µ—Ä–≥–∏—è –Ω–∞–ø—Ä—è–º—É—é –≤ –º—ã—à—Ü—ã',
      // –ë–æ–Ω—É—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      intensityScaling: {
        'HIIT': 1.0,           // –ü–æ–ª–Ω—ã–π –±–æ–Ω—É—Å
        'MODERATE': 0.75,      // 75% –±–æ–Ω—É—Å–∞
        'LISS': 0.5            // 50% –±–æ–Ω—É—Å–∞
      }
    },

    // === 2. POST-WORKOUT: –ï–¥–∞ –ü–û–°–õ–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
    // "–ì–ª–∏–∫–æ–≥–µ–Ω–æ–≤–æ–µ –æ–∫–Ω–æ" ‚Äî –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É
    // Ivy & Kuo 1998: –ø–µ—Ä–≤—ã–µ 2—á –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ = √ó3-4 —Å–∫–æ—Ä–æ—Å—Ç—å —Å–∏–Ω—Ç–µ–∑–∞ –≥–ª–∏–∫–æ–≥–µ–Ω–∞
    postWorkout: {
      // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –æ–∫–Ω–æ: —á–µ–º –±–æ–ª—å—à–µ –ø–æ—Ç—Ä–∞—Ç–∏–ª, —Ç–µ–º –¥–æ–ª—å—à–µ –æ–∫–Ω–æ
      baseGap: 120,              // –ë–∞–∑–æ–≤–æ–µ –æ–∫–Ω–æ 2—á
      kcalScaling: 60,           // +60 –º–∏–Ω –∑–∞ –∫–∞–∂–¥—ã–µ 500 –∫–∫–∞–ª (–¥–æ 360)
      maxGap: 360,               // –ú–∞–∫—Å–∏–º—É–º 6—á –¥–ª—è –æ—á–µ–Ω—å —Ç—è–∂—ë–ª—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫

      // –ë–æ–Ω—É—Å—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      tiers: [
        { maxMin: 30, waveBonus: -0.40, label: 'üî• –ê–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ' },  // 0-30 –º–∏–Ω
        { maxMin: 60, waveBonus: -0.35, label: 'üîÑ Recovery' },             // 30-60 –º–∏–Ω
        { maxMin: 120, waveBonus: -0.25, label: '‚è≥ –ì–ª–∏–∫–æ–≥–µ–Ω–æ–≤–æ–µ –æ–∫–Ω–æ' },   // 1-2—á
        { maxMin: 240, waveBonus: -0.15, label: 'üìâ –ü–æ–∑–¥–Ω–µ–µ –æ–∫–Ω–æ' },        // 2-4—á
        { maxMin: 360, waveBonus: -0.08, label: 'üí® –û—Å—Ç–∞—Ç–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç' }    // 4-6—á
      ],

      // –ö–†–ò–¢–ò–ß–ù–û: –ù–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!
      nightPenaltyOverride: true,

      // –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ —Ç–∏–ø—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è WAVE BONUS (—É–∫–æ—Ä–æ—á–µ–Ω–∏–µ –≤–æ–ª–Ω—ã)
      // –ù–∞—É—á–Ω–æ–µ: –∫–∞—Ä–¥–∏–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç GLUT4, —Å–∏–ª–æ–≤–∞—è –¥–∞—ë—Ç –∞–Ω–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç
      typeMultipliers: {
        'cardio': 1.15,         // –ö–∞—Ä–¥–∏–æ +15% –∫ —É–∫–æ—Ä–æ—á–µ–Ω–∏—é –≤–æ–ª–Ω—ã (GLUT4 –∞–∫—Ç–∏–≤–∞—Ü–∏—è)
        'strength': 1.0,        // –°–∏–ª–æ–≤–∞—è ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç
        'hobby': 0.8            // –•–æ–±–±–∏ ‚Äî 80%
      },

      badge: 'üîÑ Recovery',
      desc: '–ì–ª–∏–∫–æ–≥–µ–Ω–æ–≤–æ–µ –æ–∫–Ω–æ ‚Äî –µ–¥–∞ –∏–¥—ë—Ç –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ'
    },

    // === 3. PRE-WORKOUT: –ï–¥–∞ –ü–ï–†–ï–î —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π ===
    // –¢–æ–ø–ª–∏–≤–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –∏–Ω—Å—É–ª–∏–Ω –±—É–¥–µ—Ç "—Å–∂–∏–≥–∞—Ç—å—Å—è" –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    // üÜï v3.5.4: –î–æ–±–∞–≤–ª–µ–Ω harmMultiplier ‚Äî –µ–¥–∞ –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π –º–µ–Ω–µ–µ "–≤—Ä–µ–¥–Ω–∞"
    preWorkout: [
      { maxGap: 45, waveBonus: -0.20, harmMultiplier: 0.6, label: '‚ö° –¢–æ–ø–ª–∏–≤–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏' },  // 0-45 –º–∏–Ω –¥–æ
      { maxGap: 90, waveBonus: -0.10, harmMultiplier: 0.8, label: 'üîã Pre-workout' }              // 45-90 –º–∏–Ω –¥–æ
    ],

    // === 4. STEPS: –®–∞–≥–∏ –∫–∞–∫ NEAT ===
    // –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —à–∞–≥–∏ —É–ª—É—á—à–∞—é—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    // üÜï v3.5.5: –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏, —Ä–∞–±–æ—Ç–∞—é—Ç –≤–µ—Å—å –¥–µ–Ω—å (–Ω–µ —Ç–æ–ª—å–∫–æ –≤–µ—á–µ—Ä–æ–º)
    stepsBonus: {
      tiers: [
        { threshold: 12000, waveBonus: -0.12, harmMultiplier: 0.92, badge: 'üö∂ 12k —à–∞–≥–æ–≤' },
        { threshold: 10000, waveBonus: -0.10, harmMultiplier: 0.95, badge: 'üö∂ –ê–∫—Ç–∏–≤–Ω—ã–π' },
        { threshold: 7500, waveBonus: -0.06, harmMultiplier: 0.97, badge: 'üö∂ 7.5k —à–∞–≥–æ–≤' },
        { threshold: 5000, waveBonus: -0.04, harmMultiplier: 0.98, badge: 'üö∂ 5k —à–∞–≥–æ–≤' }
      ],
      // –î–ª—è –≤–µ—á–µ—Ä–Ω–∏—Ö –ø—Ä–∏—ë–º–æ–≤ (18:00+) –±–æ–Ω—É—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è (—à–∞–≥–∏ —É–∂–µ –Ω–∞–∫–æ–ø–∏–ª–∏—Å—å)
      eveningBoost: { afterHour: 18, multiplier: 1.3 }
    },

    // === 4.1. HOUSEHOLD: –ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ===
    // üÜï v3.5.5: NEAT (–±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –±–µ–π–¥–∂–µ–º
    householdBonus: {
      tiers: [
        { threshold: 90, waveBonus: -0.12, harmMultiplier: 0.90, badge: 'üè† –û—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π' },
        { threshold: 60, waveBonus: -0.10, harmMultiplier: 0.93, badge: 'üè† –ê–∫—Ç–∏–≤–Ω—ã–π –±—ã—Ç' },
        { threshold: 30, waveBonus: -0.05, harmMultiplier: 0.96, badge: 'üè† –£–º–µ—Ä–µ–Ω–Ω—ã–π –±—ã—Ç' }
      ]
    },

    // === 5. MORNING TRAINING: –£—Ç—Ä–µ–Ω–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ===
    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ 12:00 —É–ª—É—á—à–∞–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å (EPOC)
    morningTraining: {
      beforeHour: 12,            // –î–æ –ø–æ–ª—É–¥–Ω—è
      dayWaveBonus: -0.05,       // -5% –∫–æ –í–°–ï–ú –≤–æ–ª–Ω–∞–º –∑–∞ –¥–µ–Ω—å
      badge: 'üåÖ Morning boost',
      desc: '–£—Ç—Ä–µ–Ω–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Üí –º–µ—Ç–∞–±–æ–ª–∏–∑–º —É—Å–∫–æ—Ä–µ–Ω –≤–µ—Å—å –¥–µ–Ω—å'
    },

    // === 6. DOUBLE TRAINING: 2+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –¥–µ–Ω—å ===
    // –°–µ—Ä—å—ë–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ = —Å–µ—Ä—å—ë–∑–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    doubleTraining: {
      minTrainings: 2,           // 2 –∏–ª–∏ –±–æ–ª–µ–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
      dayWaveBonus: -0.10,       // -10% –∫–æ –í–°–ï–ú –≤–æ–ª–Ω–∞–º
      badge: 'üí™ Double Day',
      desc: '2+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Üí –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É'
    },

    // === 7. FASTED TRAINING: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—Ç–æ—â–∞–∫ ===
    // –ü–æ—Å–ª–µ –≥–æ–ª–æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–†–ò–¢–ò–ß–ù–û –≤–∞–∂–Ω–æ
    // Burke et al. 2010: fasted training enhances post-workout uptake
    fastedTraining: {
      minFastHours: 8,           // –ú–∏–Ω–∏–º—É–º 8—á –±–µ–∑ –µ–¥—ã –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π
      postWorkoutMultiplier: 1.3, // POST-WORKOUT –±–æ–Ω—É—Å √ó1.3
      badge: '‚ö° Fasted boost',
      desc: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—Ç–æ—â–∞–∫ ‚Üí —É—Å–∏–ª–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ'
    },

    // === 8. STRENGTH + PROTEIN: –°–∏–ª–æ–≤–∞—è + –±–µ–ª–æ–∫ ===
    // –ë–µ–ª–æ–∫ –ø–æ—Å–ª–µ —Å–∏–ª–æ–≤–æ–π = —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –º—ã—à—Ü, –Ω–µ –≤—Ä–µ–¥
    strengthProtein: {
      minProtein: 30,            // –ú–∏–Ω–∏–º—É–º 30–≥ –±–µ–ª–∫–∞
      harmMultiplier: 0.8,       // –í—Ä–µ–¥ √ó0.8 (–±–µ–ª–æ–∫ = –ø–æ–ª—å–∑–∞)
      badge: 'üí™ Muscle fuel',
      desc: '–ë–µ–ª–æ–∫ –ø–æ—Å–ª–µ —Å–∏–ª–æ–≤–æ–π ‚Üí –∞–Ω–∞–±–æ–ª–∏–∑–º'
    },

    // === 9. CARDIO + SIMPLE CARBS: –ö–∞—Ä–¥–∏–æ + –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã ===
    // –ë—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –ø–æ—Å–ª–µ –∫–∞—Ä–¥–∏–æ = –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–ª–∏–∫–æ–≥–µ–Ω–∞, –Ω–µ –≤—Ä–µ–¥
    cardioSimple: {
      harmMultiplier: 0.5,       // –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç—ã–µ √ó0.5
      glMultiplier: 0.7,         // GL √ó0.7 (–±—ã—Å—Ç—Ä–æ–µ —É—Å–≤–æ–µ–Ω–∏–µ = —Ö–æ—Ä–æ—à–æ)
      badge: 'üèÉ Glycogen refuel',
      desc: '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –ø–æ—Å–ª–µ –∫–∞—Ä–¥–∏–æ ‚Üí –≥–ª–∏–∫–æ–≥–µ–Ω'
    },

    // === 10. NIGHT OVERRIDE: –ù–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è ===
    // –ï—Å–ª–∏ –±—ã–ª POST-WORKOUT –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
    nightOverride: {
      // –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å postWorkout –∫–æ–Ω—Ç–µ–∫—Å—Ç
      enabled: true,
      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è (—á–∞—Å—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)
      maxHoursAfterTraining: 4
    },

    // === –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ (–¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ) ===
    // –ü—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –≤—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
    priority: {
      peri: 100,     // PERI-WORKOUT ‚Äî –Ω–∞–∏–≤—ã—Å—à–∏–π (–µ–¥–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)
      post: 80,      // POST-WORKOUT ‚Äî –≤—ã—Å–æ–∫–∏–π
      pre: 60,       // PRE-WORKOUT ‚Äî —Å—Ä–µ–¥–Ω–∏–π
      steps: 20,     // STEPS ‚Äî –Ω–∏–∑–∫–∏–π (—Ñ–æ–Ω–æ–≤—ã–π)
      household: 15, // HOUSEHOLD ‚Äî –º–µ–∂–¥—É steps –∏ morning
      morning: 10,   // MORNING ‚Äî –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π (–≤–µ—Å—å –¥–µ–Ω—å)
      double: 10     // DOUBLE ‚Äî –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π (–≤–µ—Å—å –¥–µ–Ω—å)
    },

    // === –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–∫–µ–π–ª–∏–Ω–≥–∞ ===
    // HIIT —Å–æ–∑–¥–∞—ë—Ç EPOC –¥–æ 24—á, LISS ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
    intensityMultiplier: {
      'HIIT': 2.0,           // –û–∫–Ω–æ √ó2 (–¥–æ 8 —á–∞—Å–æ–≤)
      'MODERATE': 1.5,       // –û–∫–Ω–æ √ó1.5
      'LISS': 1.0            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫–Ω–æ
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìä IR_SCORE_CONFIG ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (v2.0)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 
  // IR Score = MULTIPLICATIVE –∫–æ–º–±–∏–Ω–∞—Ü–∏—è 4 —Ñ–∞–∫—Ç–æ—Ä–æ–≤:
  // - BMI: <25=1.0, <30=1.1, <35=1.25, else=1.4
  // - Sleep: ‚â•7h=1.0, ‚â•6h=1.05, else=1.15
  // - Stress: ‚â§3=1.0, ‚â§6=1.08, else=1.15
  // - Age: <30=1.0, <45=1.06, <60=1.12, else=1.25
  // 
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
  // - DeFronzo 1979 (PMID: 510806): –≤–æ–∑—Ä–∞—Å—Ç —Å–Ω–∏–∂–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 10-15% –∑–∞ –¥–µ–∫–∞–¥—É
  // - Kahn & Flier 2000 (PMID: 10953022): BMI>30 = +20-40% —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // - Spiegel 1999 (PMID: 10543671): –Ω–µ–¥–æ—Å—ã–ø <6—á = +20-30% —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // - Chrousos 2000: –∫–æ—Ä—Ç–∏–∑–æ–ª (—Å—Ç—Ä–µ—Å—Å) = +10-20% —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  I.IR_SCORE_CONFIG = C?.IR_SCORE_CONFIG || {
    // BMI thresholds (ascending) ‚Äî —á–µ–º –≤—ã—à–µ BMI, —Ç–µ–º –±–æ–ª—å—à–µ —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    bmi: {
      thresholds: [25, 30, 35],      // <25, 25-30, 30-35, ‚â•35
      factors: [1.0, 1.1, 1.25, 1.4], // Normal, Overweight, Obese I, Obese II+
      labels: ['Normal', 'Overweight', 'Obese I', 'Obese II+']
    },
    // Sleep thresholds (DESCENDING!) ‚Äî –º–µ–Ω—å—à–µ —Å–Ω–∞ = –±–æ–ª—å—à–µ —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    sleep: {
      thresholds: [7, 6],            // ‚â•7h, 6-7h, <6h
      factors: [1.0, 1.05, 1.15],    // Optimal, Moderate, Severe deficit
      labels: ['Optimal', 'Moderate deficit', 'Severe deficit']
    },
    // Stress thresholds (ascending) ‚Äî –≤—ã—à–µ —Å—Ç—Ä–µ—Å—Å = –±–æ–ª—å—à–µ —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    stress: {
      thresholds: [3, 6],            // ‚â§3, 4-6, >6
      factors: [1.0, 1.08, 1.15],    // Low, Medium, High
      labels: ['Low', 'Medium', 'High']
    },
    // Age thresholds (ascending) ‚Äî —Å—Ç–∞—Ä—à–µ = –±–æ–ª—å—à–µ —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    age: {
      thresholds: [30, 45, 60],      // <30, 30-45, 45-60, ‚â•60
      factors: [1.0, 1.06, 1.12, 1.25], // Young, Adult, Middle-age, Senior
      labels: ['Young', 'Adult', 'Middle-age', 'Senior']
    },
    // –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ IR Score –¥–ª—è UI
    colorRanges: [
      { max: 1.1, color: '#22c55e', label: 'üü¢ Optimal' },      // –ó–µ–ª—ë–Ω—ã–π
      { max: 1.25, color: '#eab308', label: 'üü° Moderate' },    // –ñ—ë–ª—Ç—ã–π
      { max: 1.5, color: '#f97316', label: 'üü† Elevated' },     // –û—Ä–∞–Ω–∂–µ–≤—ã–π
      { max: Infinity, color: '#ef4444', label: 'üî¥ High' }     // –ö—Ä–∞—Å–Ω—ã–π
    ]
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìä calculateIRScore ‚Äî —Ä–∞—Å—á—ë—Ç –∏–Ω–¥–µ–∫—Å–∞ –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  /**
   * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç IR Score ‚Äî –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.
   * 
   * IR Score = bmiFactor √ó sleepFactor √ó stressFactor √ó ageFactor
   * 
   * –ó–Ω–∞—á–µ–Ω–∏–µ ‚âà1.0 = –æ—Ç–ª–∏—á–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, ‚â•1.5 = –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.
   * 
   * @param {Object} profile - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {number} profile.weight - –≤–µ—Å (–∫–≥)
   * @param {number} profile.height - —Ä–æ—Å—Ç (—Å–º)
   * @param {number} profile.age - –≤–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)
   * @param {Object} dayData - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @param {number} [dayData.sleepHours] - —á–∞—Å—ã —Å–Ω–∞
   * @param {number} [dayData.stressAvg] - —Å—Ä–µ–¥–Ω–∏–π —Å—Ç—Ä–µ—Å—Å (1-10)
   * @returns {Object} { score, factors, color, label, breakdown }
   */
  I.calculateIRScore = (profile = {}, dayData = {}) => {
    const { weight = 70, height = 170, age = 30 } = profile;
    const { sleepHours = 7, stressAvg = 3 } = dayData;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º BMI
    const heightM = height / 100;
    const bmi = heightM > 0 ? weight / (heightM * heightM) : 25;

    // –•–µ–ª–ø–µ—Ä: –Ω–∞–π—Ç–∏ —Ñ–∞–∫—Ç–æ—Ä –ø–æ –ø–æ—Ä–æ–≥–∞–º (ascending)
    const getFactorAscending = (value, cfg) => {
      for (let i = 0; i < cfg.thresholds.length; i++) {
        if (value < cfg.thresholds[i]) {
          return { factor: cfg.factors[i], label: cfg.labels[i], tier: i };
        }
      }
      return { factor: cfg.factors[cfg.factors.length - 1], label: cfg.labels[cfg.labels.length - 1], tier: cfg.thresholds.length };
    };

    // –•–µ–ª–ø–µ—Ä: –Ω–∞–π—Ç–∏ —Ñ–∞–∫—Ç–æ—Ä –ø–æ –ø–æ—Ä–æ–≥–∞–º (descending ‚Äî –¥–ª—è sleep)
    const getFactorDescending = (value, cfg) => {
      for (let i = 0; i < cfg.thresholds.length; i++) {
        if (value >= cfg.thresholds[i]) {
          return { factor: cfg.factors[i], label: cfg.labels[i], tier: i };
        }
      }
      return { factor: cfg.factors[cfg.factors.length - 1], label: cfg.labels[cfg.labels.length - 1], tier: cfg.thresholds.length };
    };

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä
    const bmiFactor = getFactorAscending(bmi, I.IR_SCORE_CONFIG.bmi);
    const sleepFactor = getFactorDescending(sleepHours, I.IR_SCORE_CONFIG.sleep);
    const stressFactor = getFactorAscending(stressAvg, I.IR_SCORE_CONFIG.stress);
    const ageFactor = getFactorAscending(age, I.IR_SCORE_CONFIG.age);

    // –ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–π score
    const score = bmiFactor.factor * sleepFactor.factor * stressFactor.factor * ageFactor.factor;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ –ª–µ–π–±–ª
    let color = '#ef4444';
    let label = 'üî¥ High';
    for (const range of I.IR_SCORE_CONFIG.colorRanges) {
      if (score <= range.max) {
        color = range.color;
        label = range.label;
        break;
      }
    }

    return {
      score: Math.round(score * 1000) / 1000, // 3 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
      factors: {
        bmi: bmiFactor.factor,
        sleep: sleepFactor.factor,
        stress: stressFactor.factor,
        age: ageFactor.factor
      },
      color,
      label,
      breakdown: {
        bmi: { value: Math.round(bmi * 10) / 10, factor: bmiFactor.factor, label: bmiFactor.label },
        sleep: { value: sleepHours, factor: sleepFactor.factor, label: sleepFactor.label },
        stress: { value: stressAvg, factor: stressFactor.factor, label: stressFactor.label },
        age: { value: age, factor: ageFactor.factor, label: ageFactor.label }
      },
      // –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∫ –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤–æ–ª–Ω—ã
      waveMultiplier: score
    };
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üèãÔ∏è calculateActivityContext ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∏—ë–º–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * üèãÔ∏è –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (v3.5.5)
   * 
   * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª—É—á—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
   * –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (peri > post > pre > steps > household > morning/double).
   * 
   * üÜï v3.5.5: –î–æ–±–∞–≤–ª–µ–Ω—ã:
   * - –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ —à–∞–≥–æ–≤ (5k/7.5k/10k/12k) —Å –≤–µ—á–µ—Ä–Ω–∏–º boost
   * - –ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (household) –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –±–µ–π–¥–∂–µ–º
   * - harmMultiplier –¥–ª—è —à–∞–≥–æ–≤ –∏ –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   * 
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @param {number} params.mealTimeMin - –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏
   * @param {Array} params.trainings - –º–∞—Å—Å–∏–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–Ω—è [{z:[...], time:'HH:MM', type}]
   * @param {number} params.steps - —à–∞–≥–∏ –∑–∞ –¥–µ–Ω—å
   * @param {number} [params.householdMin=0] - –º–∏–Ω—É—Ç—ã –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (NEAT)
   * @param {number} params.weight - –≤–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–≥)
   * @param {Array} [params.allMeals] - –≤—Å–µ –ø—Ä–∏—ë–º—ã –¥–Ω—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ fasted)
   * @param {Object} [params.mealNutrients] - –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞ {prot, carbs, simple}
   * @param {number} [params.mealKcal] - –∫–∞–ª–æ—Ä–∏–∏ –ø—Ä–∏—ë–º–∞
   * @returns {Object|null} - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ null
   */

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ "—Ä–µ–∞–ª—å–Ω–æ–π" (–Ω–µ –ø—É—Å—Ç–æ–π/–¥–µ—Ñ–æ–ª—Ç–Ω–æ–π)
   * –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤–∞–ª–∏–¥–Ω–∞ –µ—Å–ª–∏: –µ—Å—Ç—å –≤—Ä–µ–º—è –ò–õ–ò —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∑–æ–Ω–∞ –ø—É–ª—å—Å–∞ > 0
   */
  I.isValidTraining = (t) => {
    if (!t) return false;
    // –ï—Å—Ç—å –≤—Ä–µ–º—è ‚Äî –≤–∞–ª–∏–¥–Ω–∞
    if (t.time && t.time !== '') return true;
    // –ï—Å—Ç—å —Ö–æ—Ç—å –æ–¥–Ω–∞ –∑–æ–Ω–∞ > 0 ‚Äî –≤–∞–ª–∏–¥–Ω–∞
    const zones = t.z || [];
    return zones.some(z => +z > 0);
  };

  I.calculateActivityContext = (params) => {
    const { mealTimeMin, trainings: rawTrainings = [], steps = 0, householdMin = 0, weight = 70, allMeals = [], mealNutrients = {}, mealKcal = 0 } = params;

    // üÜï v3.7.3: –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ/–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    const trainings = rawTrainings.filter(I.isValidTraining);

    if (!mealTimeMin && mealTimeMin !== 0) return null;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º helpers –∏–∑ HEYS.models –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    const M = (typeof HEYS !== 'undefined' && HEYS.models) ? HEYS.models : {};
    const getTrainingInterval = M.getTrainingInterval || ((t) => {
      // Fallback –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      const [h, m] = (t.time || '12:00').split(':').map(Number);
      const startMin = h * 60 + m;
      const dur = (t.z || []).reduce((a, b) => a + b, 0) || 30;
      return { startMin, endMin: startMin + dur, durationMin: dur };
    });
    const getTrainingIntensityType = M.getTrainingIntensityType || ((t) => {
      const z = t.z || [];
      const highZones = (z[2] || 0) + (z[3] || 0);
      const total = z.reduce((a, b) => a + b, 0) || 1;
      if (highZones / total >= 0.5) return 'HIIT';
      if (highZones / total >= 0.2) return 'MODERATE';
      return 'LISS';
    });

    // Export to I for use in other functions
    I.getTrainingInterval = getTrainingInterval;
    I.getTrainingIntensityType = getTrainingIntensityType;

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
    const foundContexts = [];

    // === –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ===
    for (const training of trainings) {
      if (!training || !training.time) continue;

      const interval = I.getTrainingInterval(training);
      const intensity = I.getTrainingIntensityType(training);
      const intensityMult = I.TRAINING_CONTEXT.intensityMultiplier[intensity] || 1.0;
      const { startMin, endMin, durationMin } = interval;

      // --- PERI-WORKOUT: –µ–¥–∞ –í–û –í–†–ï–ú–Ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ---
      if (mealTimeMin >= startMin && mealTimeMin <= endMin) {
        const cfg = I.TRAINING_CONTEXT.periWorkout;
        const progressPct = durationMin > 0 ? (mealTimeMin - startMin) / durationMin : 0.5;

        // üÜï v3.5.0: Intensity-scaled PERI bonus
        // –ß–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–µ–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, —Ç–µ–º –±–æ–ª—å—à–µ GLUT4 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
        const intensityWaveBonus = cfg.maxBonus * intensityMult; // -0.70 √ó 1.5 = -1.05 ‚Üí cap -0.95
        const cappedWaveBonus = Math.max(-0.95, intensityWaveBonus);

        // harmMultiplier —Ç–æ–∂–µ —É–ª—É—á—à–∞–µ—Ç—Å—è —Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é
        const intensityHarmMult = Math.max(0.2, cfg.harmMultiplier / intensityMult);

        foundContexts.push({
          type: 'peri',
          priority: I.TRAINING_CONTEXT.priority.peri,
          waveBonus: cappedWaveBonus,
          harmMultiplier: intensityHarmMult,
          badge: cfg.badge,
          desc: `${cfg.badge} –ï–¥–∞ –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí —Ç–æ–ø–ª–∏–≤–æ!`,
          trainingRef: { time: training.time, type: training.type, intensity },
          details: { progressPct, intensityMult, baseBonus: cfg.maxBonus, scaledBonus: cappedWaveBonus }
        });
        continue; // peri ‚Äî –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –¥–ª—è —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      }

      // --- POST-WORKOUT: –µ–¥–∞ –ü–û–°–õ–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ---
      if (mealTimeMin > endMin) {
        const gapMin = mealTimeMin - endMin;
        const cfg = I.TRAINING_CONTEXT.postWorkout;

        // üÜï v3.7.7: –†–ï–ê–õ–¨–ù–´–ï –ö–ö–ê–õ —á–µ—Ä–µ–∑ MET-—Ñ–æ—Ä–º—É–ª—É (–Ω–µ –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞!)
        // –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞: durationMin * intensityMult * 5 * (weight / 70) ‚Äî –¥–∞–≤–∞–ª–∞ ~300 –¥–ª—è 60 –º–∏–Ω
        // –ù–æ–≤–∞—è: —á–µ—Ä–µ–∑ I.utils.calculateTrainingKcal(training, weight) ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ ~700 –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π –∫–∞—Ä–¥–∏–æ
        const trainingKcal = I.utils.calculateTrainingKcal(training, weight);

        // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –æ–∫–Ω–æ: base + kcal/60
        const windowMin = Math.min(cfg.baseGap + trainingKcal / cfg.kcalScaling, cfg.maxGap * intensityMult);

        if (gapMin <= windowMin) {
          // –ù–∞—Ö–æ–¥–∏–º tier
          let tier = cfg.tiers[cfg.tiers.length - 1];
          for (const t of cfg.tiers) {
            // Fix: use maxMin if maxGap is missing (inconsistency in config)
            const threshold = t.maxGap || t.maxMin;
            if (gapMin <= threshold) {
              tier = t;
              break;
            }
          }

          // üÜï v3.7.6: KCAL-BASED WAVE REDUCTION (MULTIPLICATIVE MODEL)
          // 
          // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Ivy & Kuo 1998, Colberg 2010, Burke 2017
          // –ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–∞–µ—Ç—Å—è √ó2-3,
          // –Ω–æ –≤–æ–ª–Ω–∞ –ù–ï –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî —Ç–æ–ª—å–∫–æ —É–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 30-50%
          //
          // v3.7.6 FIX: –°—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å (tier + kcal) –¥–∞–≤–∞–ª–∞ –¥–æ -85% ‚Äî –Ω–∞—É—á–Ω–æ –ù–ï –æ–±–æ—Å–Ω–æ–≤–∞–Ω–æ
          // –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å: –ú–£–õ–¨–¢–ò–ü–õ–ò–ö–ê–¢–ò–í–ù–ê–Ø ‚Äî kcal —É—Å–∏–ª–∏–≤–∞–µ—Ç tier-—ç—Ñ—Ñ–µ–∫—Ç, –Ω–æ –Ω–µ —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è
          //
          // | –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∫–∫–∞–ª | –ú–Ω–æ–∂–∏—Ç–µ–ª—å tier | –ü—Ä–∏–º–µ—Ä: tier=-35% |
          // |----------------|----------------|-------------------|
          // | <200           | √ó1.0           | -35% ‚Üí -35%       |
          // | 200-400        | √ó1.15          | -35% ‚Üí -40%       |
          // | 400-700        | √ó1.25          | -35% ‚Üí -44%       |
          // | 700-1000       | √ó1.35          | -35% ‚Üí -47%       |
          // | 1000+          | √ó1.50          | -35% ‚Üí -52%       |
          let kcalMultiplier = 1.0;
          if (trainingKcal >= 1000) {
            kcalMultiplier = 1.50; // –û—á–µ–Ω—å —Ç—è–∂—ë–ª–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Å–∏–ª–µ–Ω–∏–µ √ó1.5
          } else if (trainingKcal >= 700) {
            kcalMultiplier = 1.35; // –¢—è–∂—ë–ª–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Å–∏–ª–µ–Ω–∏–µ √ó1.35
          } else if (trainingKcal >= 400) {
            kcalMultiplier = 1.25; // –°—Ä–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Å–∏–ª–µ–Ω–∏–µ √ó1.25
          } else if (trainingKcal >= 200) {
            kcalMultiplier = 1.15; // –õ—ë–≥–∫–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Å–∏–ª–µ–Ω–∏–µ √ó1.15
          }

          // üÜï v3.7.6: –£—á—ë—Ç —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è wave bonus
          // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –∫–∞—Ä–¥–∏–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç GLUT4 –¥–ª—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –≥–ª—é–∫–æ–∑—ã
          // Jamurtas 2004: –∫–∞—Ä–¥–∏–æ –¥–∞—ë—Ç –±–û–ª—å—à–∏–π –æ—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
          const typeBonus = cfg.typeMultipliers?.[training.type] || 1.0;
          // cardio=1.0, strength=1.1 (—Å–∏–ª—å–Ω–µ–µ), hobby=0.8 (—Å–ª–∞–±–µ–µ)

          // –§–∏–Ω–∞–ª—å–Ω—ã–π waveBonus = tier √ó kcalMultiplier √ó typeBonus (–Ω–µ –Ω–∏–∂–µ -0.60)
          // –ù–∞—É—á–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –¥–∞–∂–µ –ø–æ—Å–ª–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞ –≤–æ–ª–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ä–æ—á–µ 40% –æ—Ç –Ω–æ—Ä–º—ã
          const combinedWaveBonus = Math.max(-0.60, tier.waveBonus * kcalMultiplier * typeBonus);

          // harmMultiplier —Ç–æ–∂–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∫–∞–ª (–±–æ–ª—å—à–µ –ø–æ—Ç—Ä–∞—Ç–∏–ª = –º–µ–Ω—å—à–µ "–≤—Ä–µ–¥")
          const kcalHarmReduction = Math.min(0.5, trainingKcal / 2000); // max 50% reduction at 1000 –∫–∫–∞–ª
          const combinedHarmMultiplier = Math.max(0.3, (tier.harmMultiplier || 0.7) - kcalHarmReduction);

          foundContexts.push({
            type: 'post',
            priority: I.TRAINING_CONTEXT.priority.post,
            waveBonus: combinedWaveBonus,
            harmMultiplier: combinedHarmMultiplier,
            badge: tier.label || tier.badge,
            desc: `${tier.label} ${gapMin} –º–∏–Ω –ø–æ—Å–ª–µ ${Math.round(trainingKcal)} –∫–∫–∞–ª ${training.type || '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏'}`,
            nightPenaltyOverride: cfg.nightPenaltyOverride,
            trainingRef: { time: training.time, type: training.type, intensity },
            details: {
              gapMin,
              windowMin,
              tier: tier.label,
              trainingKcal: Math.round(trainingKcal),
              tierBonus: tier.waveBonus,
              kcalMultiplier,  // üÜï v3.7.6: –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä –ø–æ –∫–∫–∞–ª
              typeBonus,       // üÜï v3.7.6: –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä –ø–æ —Ç–∏–ø—É (cardio=1.15)
              combinedWaveBonus,
              combinedHarmMultiplier
            }
          });
        }
      }

      // --- PRE-WORKOUT: –µ–¥–∞ –î–û —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ---
      if (mealTimeMin < startMin) {
        const gapMin = startMin - mealTimeMin;

        for (const tier of I.TRAINING_CONTEXT.preWorkout) {
          if (gapMin <= tier.maxGap) {
            foundContexts.push({
              type: 'pre',
              priority: I.TRAINING_CONTEXT.priority.pre,
              waveBonus: tier.waveBonus,
              harmMultiplier: tier.harmMultiplier || 1.0, // üÜï v3.5.4: pre —Ç–æ–∂–µ —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–¥
              badge: tier.label,
              desc: `–ï–¥–∞ –∑–∞ ${gapMin} –º–∏–Ω –¥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí —Å–≥–æ—Ä–∏—Ç –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ`,
              trainingRef: { time: training.time, type: training.type, intensity },
              details: { gapMin }
            });
            break;
          }
        }
      }
    }

    // === STEPS: –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ —à–∞–≥–æ–≤ ===
    // üÜï v3.5.5: –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ—Å—å –¥–µ–Ω—å, –Ω–µ —Ç–æ–ª—å–∫–æ –≤–µ—á–µ—Ä–æ–º. –í–µ—á–µ—Ä–æ–º –±–æ–Ω—É—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è.
    const cfg_steps = I.TRAINING_CONTEXT.stepsBonus;
    for (const tier of cfg_steps.tiers) {
      if (steps >= tier.threshold) {
        // –í–µ—á–µ—Ä–Ω–∏–π –±–æ–Ω—É—Å: –ø–æ—Å–ª–µ 18:00 —à–∞–≥–∏ —É–∂–µ –Ω–∞–∫–æ–ø–∏–ª–∏—Å—å ‚Üí —É—Å–∏–ª–∏–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç
        const isEvening = mealTimeMin >= cfg_steps.eveningBoost.afterHour * 60;
        const eveningMult = isEvening ? cfg_steps.eveningBoost.multiplier : 1.0;
        const effectiveWaveBonus = tier.waveBonus * eveningMult;

        foundContexts.push({
          type: 'steps',
          priority: I.TRAINING_CONTEXT.priority.steps,
          waveBonus: effectiveWaveBonus,
          harmMultiplier: tier.harmMultiplier,
          badge: tier.badge,
          desc: `${tier.badge} (${Math.round(steps / 1000)}k)${isEvening ? ' üåÜ –≤–µ—á–µ—Ä' : ''}`,
          trainingRef: null,
          details: { steps, tier: tier.threshold, isEvening, eveningMult }
        });
        break; // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–π (–ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π)
      }
    }

    // === HOUSEHOLD: –ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ===
    // üÜï v3.5.5: NEAT –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π Activity Context —Å –±–µ–π–¥–∂–µ–º –∏ harmMultiplier
    const cfg_household = I.TRAINING_CONTEXT.householdBonus;
    // householdMin —É–∂–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ params –≤ –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã—à–µ
    if (cfg_household && householdMin > 0) {
      for (const tier of cfg_household.tiers) {
        if (householdMin >= tier.threshold) {
          foundContexts.push({
            type: 'household',
            priority: I.TRAINING_CONTEXT.priority.household || 15, // –ú–µ–∂–¥—É steps –∏ morning
            waveBonus: tier.waveBonus,
            harmMultiplier: tier.harmMultiplier,
            badge: tier.badge,
            desc: `${tier.badge} ${householdMin} –º–∏–Ω`,
            trainingRef: null,
            details: { householdMin, tier: tier.threshold }
          });
          break;
        }
      }
    }

    // === MORNING: —É—Ç—Ä–µ–Ω–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–¥–æ 12:00) ===
    const cfg_morning = I.TRAINING_CONTEXT.morningTraining;
    const hasMorningTraining = trainings.some(t => {
      const [h] = (t.time || '12:00').split(':').map(Number);
      return h < cfg_morning.beforeHour;
    });
    if (hasMorningTraining) {
      foundContexts.push({
        type: 'morning',
        priority: I.TRAINING_CONTEXT.priority.morning,
        waveBonus: cfg_morning.dayWaveBonus,
        harmMultiplier: 1.0,
        badge: 'üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–π',
        desc: 'üåÖ –£—Ç—Ä–µ–Ω–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Üí –≤–µ—Å—å –¥–µ–Ω—å –±–æ–Ω—É—Å',
        trainingRef: null,
        details: {}
      });
    }

    // === DOUBLE: 2+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ –¥–µ–Ω—å ===
    const cfg_double = I.TRAINING_CONTEXT.doubleTraining;
    if (trainings.length >= cfg_double.minTrainings) {
      foundContexts.push({
        type: 'double',
        priority: I.TRAINING_CONTEXT.priority.double,
        waveBonus: cfg_double.dayWaveBonus,
        harmMultiplier: 1.0,
        badge: 'üí™ –î–≤–æ–π–Ω–∞—è',
        desc: `üí™ ${trainings.length} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí —É—Å–∏–ª–µ–Ω–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º`,
        trainingRef: null,
        details: { count: trainings.length }
      });
    }

    // === STRENGTH+PROTEIN: —Å–∏–ª–æ–≤–∞—è + –±–µ–ª–æ–∫ ‚â•30–≥ ===
    const prot = mealNutrients.prot || 0;
    if (prot >= I.TRAINING_CONTEXT.strengthProtein.minProtein) {
      const hasStrength = trainings.some(t => t.type === 'strength');
      if (hasStrength) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º POST –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–∏–ª–æ–≤–æ–π
        const strengthPost = foundContexts.find(c => c.type === 'post' && c.trainingRef?.type === 'strength');
        if (strengthPost) {
          // –£–ª—É—á—à–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π post –∫–æ–Ω—Ç–µ–∫—Å—Ç
          strengthPost.harmMultiplier = Math.min(strengthPost.harmMultiplier, I.TRAINING_CONTEXT.strengthProtein.harmMultiplier);
          strengthPost.badge = 'üí™ü•õ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
          strengthPost.desc += ` | +${Math.round(prot)}–≥ –±–µ–ª–∫–∞ ‚Üí harm √ó${I.TRAINING_CONTEXT.strengthProtein.harmMultiplier}`;
          strengthPost.details.protein = prot;
        }
      }
    }

    // === CARDIO+SIMPLE: –∫–∞—Ä–¥–∏–æ + –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã ===
    const simple = mealNutrients.simple || 0;
    if (simple > 0) {
      const hasCardio = trainings.some(t => t.type === 'cardio');
      if (hasCardio) {
        const cardioPeri = foundContexts.find(c => c.type === 'peri' && c.trainingRef?.type === 'cardio');
        const cardioPost = foundContexts.find(c => c.type === 'post' && c.trainingRef?.type === 'cardio');
        const target = cardioPeri || cardioPost;
        if (target) {
          // –£–º–µ–Ω—å—à–∞–µ–º —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã
          target.simpleMultiplier = I.TRAINING_CONTEXT.cardioSimple.glMultiplier;
          target.desc += ` | –ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã ‚Üí GL √ó${I.TRAINING_CONTEXT.cardioSimple.glMultiplier}`;
          target.details.simple = simple;
        }
      }
    }

    // === NIGHT OVERRIDE: –Ω–æ—á–Ω–∞—è –µ–¥–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ===
    const cfg_night = I.TRAINING_CONTEXT.nightOverride;
    if (cfg_night.enabled && mealTimeMin >= 22 * 60) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤
      const recentTraining = trainings.find(t => {
        if (!t || !t.time) return false;
        const interval = I.getTrainingInterval(t);
        if (!interval || interval.endMin == null) return false;
        const hoursAgo = (mealTimeMin - interval.endMin) / 60;
        return hoursAgo >= 0 && hoursAgo <= cfg_night.maxHoursAfterTraining;
      });
      if (recentTraining) {
        const postContext = foundContexts.find(c => c.type === 'post' && c.trainingRef?.time === recentTraining.time);
        if (postContext) {
          postContext.nightPenaltyOverride = true;
          postContext.desc += ' | üåô –ù–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –æ—Ç–º–µ–Ω—ë–Ω';
        }
      }
    }

    // === –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É ===
    if (foundContexts.length === 0) return null;

    foundContexts.sort((a, b) => b.priority - a.priority);
    const best = foundContexts[0];

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    best.allContexts = foundContexts.map(c => ({ type: c.type, priority: c.priority }));

    return best;
  };

  /**
   * üß™ –û—Ü–µ–Ω–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏–Ω—Å—É–ª–∏–Ω–∞ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É –≤–æ–ª–Ω—ã (v3.2.0)
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Campbell 1992, Jensen 1989
   * @param {number} progress - 0-100 (–ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–æ–ª–Ω—ã)
   * @returns {{ level: number, zone: string, lipolysisPct: number, desc: string, color: string }}
   */
  I.estimateInsulinLevel = (progress) => {
    // –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –æ—Ç –ø–∏–∫–∞ (~80) –¥–æ –±–∞–∑–æ–≤–æ–≥–æ (~5)
    // –§–æ—Ä–º—É–ª–∞: level = 5 + 75 √ó e^(-progress/25)
    const level = Math.round(5 + 75 * Math.exp(-progress / 25));

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—É –ø–æ –ø–æ—Ä–æ–≥–∞–º
    if (level <= I.LIPOLYSIS_THRESHOLDS.full.insulinUIml) {
      return { level, zone: 'full', lipolysisPct: 100, desc: I.LIPOLYSIS_THRESHOLDS.full.desc, color: '#22c55e' };
    }
    if (level <= I.LIPOLYSIS_THRESHOLDS.partial.insulinUIml) {
      return { level, zone: 'partial', lipolysisPct: 50, desc: I.LIPOLYSIS_THRESHOLDS.partial.desc, color: '#eab308' };
    }
    if (level <= I.LIPOLYSIS_THRESHOLDS.suppressed.insulinUIml) {
      return { level, zone: 'suppressed', lipolysisPct: 10, desc: I.LIPOLYSIS_THRESHOLDS.suppressed.desc, color: '#f97316' };
    }
    return { level, zone: 'blocked', lipolysisPct: 0, desc: I.LIPOLYSIS_THRESHOLDS.blocked.desc, color: '#ef4444' };
  };

  /**
   * ‚ö° –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∏—Å–∫ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≥–∏–ø–æ–≥–ª–∏–∫–µ–º–∏–∏ –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (v3.2.0)
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Brun et al. 1995
   * @param {Object} meal - –ø—Ä–∏—ë–º –ø–∏—â–∏
   * @param {Object} pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @param {Function} getProductFromItem - —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @returns {{ score: number, hasRisk: boolean, riskWindow: Object, details: Object }}
   */
  I.calculateHypoglycemiaRisk = (meal, pIndex, getProductFromItem) => {
    let riskScore = 0;
    const { riskFactors, riskWindow, warningThreshold } = I.REACTIVE_HYPOGLYCEMIA;

    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π GI –∏ –º–∞–∫—Ä–æ—Å—ã
    let totalGrams = 0, weightedGI = 0, totalProtein = 0, totalFat = 0;
    for (const item of (meal.items || [])) {
      const prod = getProductFromItem(item, pIndex);
      const g = item.grams || 100;
      totalGrams += g;
      weightedGI += (prod?.gi || 50) * g;
      totalProtein += (prod?.protein100 || 0) * g / 100;
      totalFat += ((prod?.fat100 || 0) + (prod?.badFat100 || 0) + (prod?.goodFat100 || 0)) * g / 100;
    }
    const avgGI = totalGrams > 0 ? weightedGI / totalGrams : 50;

    // –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞
    if (avgGI >= riskFactors.highGI.threshold) riskScore += riskFactors.highGI.weight;
    if (totalProtein < riskFactors.lowProtein.threshold) riskScore += riskFactors.lowProtein.weight;
    if (totalFat < riskFactors.lowFat.threshold) riskScore += riskFactors.lowFat.weight;

    return {
      score: riskScore,
      hasRisk: riskScore >= warningThreshold,
      riskWindow,
      details: { avgGI, totalProtein, totalFat }
    };
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï –ù–û–í–´–ï –§–ê–ö–¢–û–†–´ v3.2.0 (2025-12-10) ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // üß™ SUPPLEMENTS ‚Äî –¥–æ–±–∞–≤–∫–∏ —Å–Ω–∏–∂–∞—é—â–∏–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10:
  // Vinegar: Liljeberg & Bj√∂rck 1998, Johnston et al. 2004 ‚Äî -20-35% –≥–ª–∏–∫–µ–º–∏—è
  // Cinnamon: Khan et al. 2003 ‚Äî -10-15% –∏–Ω—Å—É–ª–∏–Ω —É –¥–∏–∞–±–µ—Ç–∏–∫–æ–≤
  // Berberine: Yin et al. 2008 ‚Äî —Å—Ä–∞–≤–Ω–∏–º —Å –º–µ—Ç—Ñ–æ—Ä–º–∏–Ω–æ–º, –∏–Ω–≥–∏–±–∏—Ä—É–µ—Ç DPP-4
  I.SUPPLEMENTS_BONUS = C?.SUPPLEMENTS_BONUS || {
    // üî¨ v4.2.5: vinegar —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω -0.20 ‚Üí -0.12
    // Liljeberg 1998, Johnston 2004: —É–∫—Å—É—Å —Å–Ω–∏–∂–∞–µ—Ç –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ 20-35%,
    // –Ω–æ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –≤–æ–ª–Ω—ã –º–µ–Ω—å—à–µ —á–µ–º –Ω–∞ –ø–∏–∫ (~10-15%)
    vinegar: { bonus: -0.12, desc: '–£–∫—Å—É—Å ‚Üí -12% –≤–æ–ª–Ω–∞' },     // –Ø–±–ª–æ—á–Ω—ã–π/–≤–∏–Ω–Ω—ã–π —É–∫—Å—É—Å
    cinnamon: { bonus: -0.10, desc: '–ö–æ—Ä–∏—Ü–∞ ‚Üí -10% –≤–æ–ª–Ω–∞' },   // 1-6–≥ –∫–æ—Ä–∏—Ü—ã
    berberine: { bonus: -0.15, desc: '–ë–µ—Ä–±–µ—Ä–∏–Ω ‚Üí -15% –≤–æ–ª–Ω–∞' } // 500-1500–º–≥ –±–µ—Ä–±–µ—Ä–∏–Ω–∞
  };

  // üßä COLD EXPOSURE ‚Äî —Ö–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –±—É—Ä—ã–π –∂–∏—Ä
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10:
  // Van Marken Lichtenbelt 2009: —Ö–æ–ª–æ–¥ +43% —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É
  // Hanssen 2015: 10 –¥–Ω–µ–π —Ö–æ–ª–æ–¥–∞ (15¬∞C) —É–ª—É—á—à–∞–µ—Ç GLUT4
  // –ú–µ—Ö–∞–Ω–∏–∑–º: –∞–∫—Ç–∏–≤–∞—Ü–∏—è BAT ‚Üí –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –∫–ª–∏—Ä–µ–Ω—Å –≥–ª—é–∫–æ–∑—ã
  I.COLD_EXPOSURE_BONUS = C?.COLD_EXPOSURE_BONUS || {
    coldShower: { bonus: -0.05, minutes: 3, desc: 'üßä –•–æ–ª–æ–¥–Ω—ã–π –¥—É—à ‚Üí -5%' },
    coldBath: { bonus: -0.10, minutes: 10, desc: 'üßä –õ–µ–¥—è–Ω–∞—è –≤–∞–Ω–Ω–∞ ‚Üí -10%' },
    coldSwim: { bonus: -0.12, minutes: 5, desc: 'üßä –ú–æ—Ä–∂–µ–≤–∞–Ω–∏–µ ‚Üí -12%' },
    // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞: ~4-6 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏
    effectDurationHours: 5
  };

  // üîÑ AUTOPHAGY ‚Äî –∞—É—Ç–æ—Ñ–∞–≥–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≥–æ–ª–æ–¥–∞–Ω–∏—è
  // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-10:
  // Alirezaei et al. 2010: –∞—É—Ç–æ—Ñ–∞–≥–∏—è –≤ –º–æ–∑–≥–µ –º—ã—à–µ–π —á–µ—Ä–µ–∑ 24-48—á
  // –£ –ª—é–¥–µ–π: Jamshed et al. 2019 ‚Äî –º–∞—Ä–∫–µ—Ä—ã —á–µ—Ä–µ–∑ 16-18—á
  // mTOR –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí AMPK –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è ‚Üí ULK1 ‚Üí –∞—É—Ç–æ—Ñ–∞–≥–∏—è
  I.AUTOPHAGY_TIMER = C?.AUTOPHAGY_TIMER || {
    // –§–∞–∑—ã –∞—É—Ç–æ—Ñ–∞–≥–∏–∏
    phases: {
      none: { minHours: 0, maxHours: 12, label: '–ü–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ', color: '#94a3b8', icon: 'üçΩÔ∏è' },
      early: { minHours: 12, maxHours: 16, label: '–ü–µ—Ä–µ—Ö–æ–¥ –∫ –≥–æ–ª–æ–¥–∞–Ω–∏—é', color: '#eab308', icon: '‚è≥' },
      active: { minHours: 16, maxHours: 24, label: '–ê—É—Ç–æ—Ñ–∞–≥–∏—è –∞–∫—Ç–∏–≤–Ω–∞', color: '#22c55e', icon: 'üîÑ' },
      deep: { minHours: 24, maxHours: 48, label: '–ì–ª—É–±–æ–∫–∞—è –∞—É—Ç–æ—Ñ–∞–≥–∏—è', color: '#10b981', icon: '‚ú®' },
      extended: { minHours: 48, maxHours: Infinity, label: '–ü—Ä–æ–¥–ª—ë–Ω–Ω—ã–π –ø–æ—Å—Ç', color: '#3b82f6', icon: 'üåü' }
    },
    // –ú–∏–Ω–∏–º—É–º –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–∞–π–º–µ—Ä–∞
    minHoursToShow: 12,
    // –ë–æ–Ω—É—Å—ã –∫ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç –∞—É—Ç–æ—Ñ–∞–≥–∏–∏
    sensitivityBonus: {
      early: 0.05,    // +5% —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      active: 0.10,   // +10%
      deep: 0.15,     // +15%
      extended: 0.18  // +18%
    }
  };

  /**
   * üîÑ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–∑—É –∞—É—Ç–æ—Ñ–∞–≥–∏–∏ –ø–æ —á–∞—Å–∞–º –≥–æ–ª–æ–¥–∞–Ω–∏—è
   * @param {number} fastingHours - —á–∞—Å—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –µ–¥—ã
   * @returns {{ phase: string, label: string, color: string, icon: string, progress: number, bonus: number }}
   */
  I.getAutophagyPhase = (fastingHours) => {
    const { phases, sensitivityBonus } = I.AUTOPHAGY_TIMER;

    for (const [key, phase] of Object.entries(phases)) {
      if (fastingHours >= phase.minHours && fastingHours < phase.maxHours) {
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–∑—ã (0-100%)
        const phaseLength = phase.maxHours - phase.minHours;
        const progress = phaseLength < Infinity
          ? Math.min(100, ((fastingHours - phase.minHours) / phaseLength) * 100)
          : Math.min(100, (fastingHours - phase.minHours) / 24 * 100); // –î–ª—è extended

        return {
          phase: key,
          label: phase.label,
          color: phase.color,
          icon: phase.icon,
          progress: Math.round(progress),
          bonus: sensitivityBonus[key] || 0,
          hoursInPhase: fastingHours - phase.minHours,
          nextPhaseIn: phase.maxHours < Infinity ? phase.maxHours - fastingHours : null
        };
      }
    }

    return { phase: 'none', label: '–ü–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ', color: '#94a3b8', icon: 'üçΩÔ∏è', progress: 0, bonus: 0 };
  };

  /**
   * üßä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ö–æ–ª–æ–¥–æ–≤–æ–≥–æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è —Å–µ–≥–æ–¥–Ω—è
   * @param {Object} day - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @returns {{ hasCold: boolean, type: string, bonus: number, desc: string }}
   */
  I.getColdExposureBonus = (day) => {
    if (!day?.coldExposure) return { hasCold: false, type: null, bonus: 0, desc: null };

    const { coldExposure } = day;
    const exposureType = coldExposure.type || 'coldShower';
    const config = I.COLD_EXPOSURE_BONUS[exposureType] || I.COLD_EXPOSURE_BONUS.coldShower;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –¥–ª–∏—Ç—Å—è ~5 —á–∞—Å–æ–≤
    if (coldExposure.time) {
      const now = new Date();
      const [h, m] = coldExposure.time.split(':').map(Number);
      const exposureTime = new Date(now);
      exposureTime.setHours(h, m, 0, 0);

      const hoursSince = (now - exposureTime) / (1000 * 60 * 60);
      if (hoursSince > I.COLD_EXPOSURE_BONUS.effectDurationHours) {
        return { hasCold: false, type: exposureType, bonus: 0, desc: '–≠—Ñ—Ñ–µ–∫—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è' };
      }
    }

    return {
      hasCold: true,
      type: exposureType,
      bonus: config.bonus,
      desc: config.desc
    };
  };

  /**
   * üß™ –ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å –æ—Ç –¥–æ–±–∞–≤–æ–∫
   * @param {Object} meal - –ø—Ä–∏—ë–º –ø–∏—â–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å supplements)
   * @returns {{ hasSupplements: boolean, bonus: number, supplements: string[] }}
   */
  I.getSupplementsBonus = (meal) => {
    if (!meal?.supplements || !Array.isArray(meal.supplements)) {
      return { hasSupplements: false, bonus: 0, supplements: [] };
    }

    let totalBonus = 0;
    const activeSupplements = [];

    for (const supp of meal.supplements) {
      const config = I.SUPPLEMENTS_BONUS[supp];
      if (config) {
        totalBonus += config.bonus;
        activeSupplements.push(supp);
      }
    }

    return {
      hasSupplements: activeSupplements.length > 0,
      bonus: totalBonus,
      supplements: activeSupplements
    };
  };

  I.GAP_HISTORY_KEY = C?.GAP_HISTORY_KEY || 'heys_meal_gaps_history';
  I.GAP_HISTORY_DAYS = C?.GAP_HISTORY_DAYS || 14;

  // üèÜ LIPOLYSIS RECORDS & STREAKS
  I.LIPOLYSIS_RECORD_KEY = C?.LIPOLYSIS_RECORD_KEY || 'heys_lipolysis_record';
  I.LIPOLYSIS_STREAK_KEY = C?.LIPOLYSIS_STREAK_KEY || 'heys_lipolysis_streak';
  I.LIPOLYSIS_HISTORY_KEY = C?.LIPOLYSIS_HISTORY_KEY || 'heys_lipolysis_history';
  I.MIN_LIPOLYSIS_FOR_STREAK = C?.MIN_LIPOLYSIS_FOR_STREAK || 4 * 60; // 4 —á–∞—Å–∞ –º–∏–Ω–∏–º—É–º –¥–ª—è streak
  I.KCAL_PER_MIN_BASE = C?.KCAL_PER_MIN_BASE || 1.0; // ~1 –∫–∫–∞–ª/–º–∏–Ω –±–∞–∑–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –≤ –ø–æ–∫–æ–µ

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß PR-24 FIX: –î–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (27 —à—Ç)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // === –£–¢–ò–õ–ò–¢–´ ===

  I.utils = {
    // –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã —Å –ø–æ–ª—É–Ω–æ—á–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 24:xx, 25:xx —Ñ–æ—Ä–º–∞—Ç)
    timeToMinutes: (timeStr) => {
      if (!timeStr) return 0;
      const [h, m] = timeStr.split(':').map(Number);
      return (h || 0) * 60 + (m || 0);
    },

    // üÜï v3.7.7: –†–∞—Å—á—ë—Ç –∫–∫–∞–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ MET-–∑–Ω–∞—á–µ–Ω–∏—è –∑–æ–Ω –ø—É–ª—å—Å–∞
    calculateTrainingKcal: (training, weight = 70) => {
      if (!training || !training.z) return 0;
      const zones = training.z || [0, 0, 0, 0];
      const totalMinutes = zones.reduce((a, b) => a + (+b || 0), 0);
      if (totalMinutes === 0) return 0;

      let mets = [2.5, 6, 8, 10];
      try {
        const hrZones = (typeof lsGet === 'function') ? lsGet('heys_hr_zones', []) : [];
        if (hrZones.length >= 4) {
          mets = [2.5, 6, 8, 10].map((def, i) => +hrZones[i]?.MET || def);
        }
      } catch (e) { /* fallback to defaults */ }

      const kcalPerMin = (met, w) => (met * 3.5 * w / 200);
      const kcal = zones.reduce((sum, min, i) => sum + (+min || 0) * kcalPerMin(mets[i], weight), 0);
      return Math.round(kcal);
    },

    // –ú–∏–Ω—É—Ç—ã –≤ HH:MM (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç 24+ —á–∞—Å–æ–≤)
    minutesToTime: (minutes) => {
      const h = Math.floor(minutes / 60) % 24;
      const m = minutes % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    },

    normalizeTimeForDisplay: (timeStr) => {
      if (!timeStr) return '';
      const [h, m] = timeStr.split(':').map(Number);
      if (isNaN(h)) return timeStr;
      const normalH = h % 24;
      return String(normalH).padStart(2, '0') + ':' + String(m || 0).padStart(2, '0');
    },

    formatDuration: (minutes) => {
      if (minutes <= 0) return '0 –º–∏–Ω';
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      if (h === 0) return `${m} –º–∏–Ω`;
      if (m === 0) return `${h}—á`;
      return `${h}—á ${m}–º`;
    },

    getGICategory: (gi) => {
      if (gi <= 35) return I.GI_CATEGORIES.low;
      if (gi <= 55) return I.GI_CATEGORIES.medium;
      if (gi <= 70) return I.GI_CATEGORIES.high;
      return I.GI_CATEGORIES.veryHigh;
    },

    isNightTime: (hour) => hour >= 22 || hour < 6,

    getDateKey: (date = new Date()) => date.toISOString().slice(0, 10),

    getNextMealSuggestion: (hour) => {
      if (hour >= 22 || hour < 6) return null;
      if (hour < 10) return { type: 'breakfast', icon: 'üç≥', name: '–ó–∞–≤—Ç—Ä–∞–∫' };
      if (hour < 12) return { type: 'snack', icon: 'üçé', name: '–ü–µ—Ä–µ–∫—É—Å' };
      if (hour < 14) return { type: 'lunch', icon: 'üç≤', name: '–û–±–µ–¥' };
      if (hour < 17) return { type: 'snack', icon: 'ü•ú', name: '–ü–µ—Ä–µ–∫—É—Å' };
      if (hour < 20) return { type: 'dinner', icon: 'üçΩÔ∏è', name: '–£–∂–∏–Ω' };
      return { type: 'light', icon: 'ü•õ', name: '–õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å' };
    },

    normalizeToHeysDay: (timeMin) => {
      const HEYS_DAY_START = 3 * 60;
      const totalMinutes = timeMin % (24 * 60);
      if (totalMinutes >= HEYS_DAY_START) {
        return totalMinutes - HEYS_DAY_START;
      }
      return totalMinutes + (24 * 60 - HEYS_DAY_START);
    }
  };

  // === –î–ï–¢–ï–ö–¢–û–†–´ –ü–ò–©–ò ===

  I.isLiquidFood = (name = '') => {
    if (typeof name !== 'string') return false;
    const n = name.toLowerCase();
    if (testPatterns(I.LIQUID_FOOD?.patterns, n)) return true;
    return /–º–æ–ª–æ–∫–æ|–∫–µ—Ñ–∏—Ä|–π–æ–≥—É—Ä—Ç|—Ä—è–∂–µ–Ω–∫–∞|—Å–º—É–∑–∏|—Å–æ–∫|–∫–æ–∫—Ç–µ–π–ª—å|–±—É–ª—å–æ–Ω|—Å—É–ø-–ø—é—Ä–µ|–ø—Ä–æ—Ç–µ–∏–Ω|shake|milk/i.test(n);
  };

  I.isSpicyFood = (name = '') => {
    if (typeof name !== 'string') return false;
    const n = name.toLowerCase();
    if (testPatterns(I.SPICY_FOOD?.patterns, n)) return true;
    return /–ø–µ—Ä–µ—Ü|—á–∏–ª–∏|–æ—Å—Ç—Ä—ã–π|–∫–∞—Ä—Ä–∏|—Ç–∞–±–∞—Å–∫–æ|—Ö–∞–ª–∞–ø–µ–Ω—å–æ|wasabi|–≤–∞—Å–∞–±–∏|sriracha|—Å–∞–ª—å—Å–∞|–≥–æ—Ä—á–∏—Ü|—Ö—Ä–µ–Ω|pepper|spicy/i.test(n);
  };

  I.hasResistantStarch = (name = '') => {
    if (typeof name !== 'string') return false;
    const n = name.toLowerCase();
    if (testPatterns(I.RESISTANT_STARCH_BONUS?.patterns, n)) return true;
    return /–æ—Ö–ª–∞–∂–¥|—Ö–æ–ª–æ–¥–Ω.*–∫–∞—Ä—Ç–æ|—Ö–æ–ª–æ–¥–Ω.*—Ä–∏—Å|—Å–∞–ª–∞—Ç.*–∫–∞—Ä—Ç–æ|–±–∞–Ω–∞–Ω.*–∑–µ–ª—ë–Ω|cold.*potato|cold.*rice/i.test(n);
  };

  I.hasCaffeine = (name = '') => {
    if (typeof name !== 'string') return false;
    const n = name.toLowerCase();
    if (testPatterns(I.CAFFEINE_BONUS?.patterns, n)) return true;
    return /–∫–æ—Ñ–µ|—ç—Å–ø—Ä–µ—Å—Å–æ|–∫–∞–ø—É—á–∏–Ω–æ|–ª–∞—Ç—Ç–µ|–∞–º–µ—Ä–∏–∫–∞–Ω–æ|—á–∞–π|–º–∞—Ç—á–∞|—ç–Ω–µ—Ä–≥–µ—Ç|coffee|espresso|tea|energy/i.test(n);
  };

  // === –ë–û–ù–£–°–´ –ò –ú–ù–û–ñ–ò–¢–ï–õ–ò ===

  I.getInsulinogenicBonus = (name = '') => {
    if (typeof name !== 'string') return { bonus: 0, type: null };
    const n = name.toLowerCase();

    const cfg = I.INSULINOGENIC_BONUS;
    const hasPatterns = !!(
      cfg?.liquidDairy?.patterns?.length ||
      cfg?.softDairy?.patterns?.length ||
      cfg?.hardDairy?.patterns?.length ||
      cfg?.protein?.patterns?.length
    );

    if (hasPatterns) {
      if (testPatterns(cfg.liquidDairy?.patterns, n)) {
        return { bonus: cfg.liquidDairy.bonus, type: 'liquid_dairy' };
      }
      if (testPatterns(cfg.softDairy?.patterns, n)) {
        return { bonus: cfg.softDairy.bonus, type: 'soft_dairy' };
      }
      if (testPatterns(cfg.hardDairy?.patterns, n)) {
        return { bonus: cfg.hardDairy.bonus, type: 'hard_dairy' };
      }
      if (testPatterns(cfg.protein?.patterns, n)) {
        return { bonus: cfg.protein.bonus, type: 'pure_protein' };
      }
      return { bonus: 0, type: null };
    }

    // –ñ–∏–¥–∫–∏–µ –º–æ–ª–æ—á–Ω—ã–µ: +15% (Holt 1997 II –º–æ–ª–æ–∫–∞ ‚âà 98)
    if (/–º–æ–ª–æ–∫–æ|–∫–µ—Ñ–∏—Ä|—Ä—è–∂–µ–Ω–∫–∞|–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à|–∞–π—Ä–∞–Ω|milk/i.test(n)) {
      return { bonus: 0.15, type: 'liquid_dairy' };
    }
    // –ú—è–≥–∫–∏–µ –º–æ–ª–æ—á–Ω—ã–µ: +10%
    if (/—Ç–≤–æ—Ä–æ–≥|–π–æ–≥—É—Ä—Ç|—Å–º–µ—Ç–∞–Ω|cottage|yogurt/i.test(n)) {
      return { bonus: 0.10, type: 'soft_dairy' };
    }
    // –¢–≤—ë—Ä–¥—ã–µ –º–æ–ª–æ—á–Ω—ã–µ: +5%
    if (/—Å—ã—Ä|cheese/i.test(n)) {
      return { bonus: 0.05, type: 'hard_dairy' };
    }
    // –ß–∏—Å—Ç—ã–π –±–µ–ª–æ–∫: +8%
    if (/–ø—Ä–æ—Ç–µ–∏–Ω|whey|isolate|–∫–∞–∑–µ–∏–Ω|casein/i.test(n)) {
      return { bonus: 0.08, type: 'pure_protein' };
    }

    return { bonus: 0, type: null };
  };

  I.getFoodForm = (items = [], getProductFromItem) => {
    if (!items || !Array.isArray(items) || items.length === 0) {
      return { form: 'solid', multiplier: 1.0, desc: null };
    }

    let liquidGrams = 0;
    let totalGrams = 0;

    for (const item of items) {
      const prod = getProductFromItem ? getProductFromItem(item) : item;
      const name = prod?.name || item?.name || '';
      const grams = item.grams || 100;
      totalGrams += grams;

      if (I.isLiquidFood(name)) {
        liquidGrams += grams;
      }
    }

    const liquidRatio = totalGrams > 0 ? liquidGrams / totalGrams : 0;

    if (liquidRatio > 0.7) {
      return { form: 'liquid', multiplier: I.FOOD_FORM_BONUS.liquid.multiplier, desc: 'üíß –ñ–∏–¥–∫–∞—è –ø–∏—â–∞' };
    }
    if (liquidRatio > 0.3) {
      return { form: 'mixed', multiplier: I.FOOD_FORM_BONUS.mixed.multiplier, desc: 'ü•£ –°–º–µ—à–∞–Ω–Ω–∞—è' };
    }
    return { form: 'solid', multiplier: 1.0, desc: null };
  };

  I.getAlcoholBonus = (name = '') => {
    if (typeof name !== 'string') return { bonus: 0, type: null };
    const n = name.toLowerCase();

    if (I.ALCOHOL_MATCH) {
      const normalized = normalizeTextForTokenMatch(name);
      const tokens = tokenizeText(normalized);

      if (tokensHasExact(tokens, I.ALCOHOL_MATCH.strongExact) || tokensHasPrefix(tokens, I.ALCOHOL_MATCH.strongPrefix)) {
        return { bonus: I.ALCOHOL_BONUS.high.bonus, type: 'high' };
      }
      if (tokensHasExact(tokens, I.ALCOHOL_MATCH.mediumExact) || tokensHasPrefix(tokens, I.ALCOHOL_MATCH.mediumPrefix)) {
        return { bonus: I.ALCOHOL_BONUS.medium.bonus, type: 'medium' };
      }
      if (tokensHasExact(tokens, I.ALCOHOL_MATCH.weakExact) || tokensHasPrefix(tokens, I.ALCOHOL_MATCH.weakPrefix)) {
        return { bonus: I.ALCOHOL_BONUS.low.bonus, type: 'low' };
      }
    }

    if (testPatterns(I.ALCOHOL_BONUS?.strong, n)) {
      return { bonus: I.ALCOHOL_BONUS.high.bonus, type: 'high' };
    }
    if (testPatterns(I.ALCOHOL_BONUS?.medium, n)) {
      return { bonus: I.ALCOHOL_BONUS.medium.bonus, type: 'medium' };
    }
    if (testPatterns(I.ALCOHOL_BONUS?.weak, n)) {
      return { bonus: I.ALCOHOL_BONUS.low.bonus, type: 'low' };
    }

    if (/–≤–æ–¥–∫–∞|–≤–∏—Å–∫–∏|–∫–æ–Ω—å—è–∫|—Ä–æ–º|–¥–∂–∏–Ω|—Ç–µ–∫–∏–ª–∞|—Å–∞–º–æ–≥–æ–Ω|—Å–ø–∏—Ä—Ç|whisky|vodka|rum|gin/i.test(n)) {
      return { bonus: I.ALCOHOL_BONUS.high.bonus, type: 'high' };
    }
    if (/–≤–∏–Ω–æ|—à–∞–º–ø–∞–Ω—Å–∫|–ø—Ä–æ—Å–µ–∫–∫–æ|wine|champagne/i.test(n)) {
      return { bonus: I.ALCOHOL_BONUS.medium.bonus, type: 'medium' };
    }
    if (/–ø–∏–≤–æ|—Å–∏–¥—Ä|beer|cider/i.test(n)) {
      return { bonus: I.ALCOHOL_BONUS.low.bonus, type: 'low' };
    }

    return { bonus: 0, type: null };
  };

  // === –§–ê–ö–¢–û–†–´ –î–ù–Ø ===

  I.calculateStressBonus = (stressLevel = 0) => {
    if (!stressLevel || stressLevel <= 0) return 0;
    if (stressLevel >= 7) return I.STRESS_BONUS.high.bonus;
    if (stressLevel >= 5) return I.STRESS_BONUS.medium.bonus;
    return 0;
  };

  I.calculateSleepBonus = (sleepHours) => {
    if (!sleepHours || sleepHours <= 0) return 0;
    if (sleepHours < 4) return I.SLEEP_BONUS.severe.bonus;
    if (sleepHours < 5) return I.SLEEP_BONUS.moderate.bonus;
    if (sleepHours < 6) return I.SLEEP_BONUS.mild.bonus;
    return 0;
  };

  // üÜï v4.2.5: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –∫–æ–Ω—Ñ–∏–≥–æ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º maxQuality –∏–∑ SLEEP_QUALITY_BONUS
  // Tasali 2008: quality 1-4 = poor (–±—ã—Ç–æ–≤–æ–π –ø–ª–æ—Ö–æ–π —Å–æ–Ω ~8% IR), 5-6 = mediocre (~4%)
  I.calculateSleepQualityBonus = (quality = 0) => {
    if (!quality || quality <= 0) return 0;
    if (quality <= I.SLEEP_QUALITY_BONUS.poor.maxQuality) return I.SLEEP_QUALITY_BONUS.poor.bonus;
    if (quality <= I.SLEEP_QUALITY_BONUS.mediocre.maxQuality) return I.SLEEP_QUALITY_BONUS.mediocre.bonus;
    return 0;
  };

  I.calculateHydrationBonus = (waterMl = 0, weight = 70) => {
    const goal = weight * 30;
    const pct = goal > 0 ? (waterMl / goal) : 1;

    if (pct < 0.3) return I.HYDRATION_BONUS.severe.bonus;
    if (pct < 0.5) return I.HYDRATION_BONUS.moderate.bonus;
    if (pct < 0.7) return I.HYDRATION_BONUS.mild.bonus;
    return 0;
  };

  I.calculateAgeBonus = (age = 0) => {
    if (!age || age <= 0) return 0;
    if (age >= 70) return I.AGE_BONUS.senior.bonus;
    if (age >= 60) return I.AGE_BONUS.elderly.bonus;
    if (age >= 45) return I.AGE_BONUS.middle.bonus;
    if (age >= 30) return I.AGE_BONUS.adult.bonus;
    return 0;
  };

  I.calculateBMIBonus = (weight = 0, height = 0) => {
    if (!weight || !height || weight <= 0 || height <= 0) return 0;
    const bmi = I.calculateBMI(weight, height);
    if (bmi >= 30) return I.BMI_BONUS.obese.bonus;
    if (bmi >= 25) return I.BMI_BONUS.overweight.bonus;
    return 0;
  };

  I.getGenderBonus = (gender = '') => {
    if (typeof gender !== 'string') return 0;
    const g = gender.toLowerCase();
    if (g === '–º—É–∂—Å–∫–æ–π' || g === 'male' || g === '–º' || g === 'm') {
      return I.GENDER_BONUS.male;
    }
    if (g === '–∂–µ–Ω—Å–∫–∏–π' || g === 'female' || g === '–∂' || g === 'f') {
      return I.GENDER_BONUS.female;
    }
    return 0;
  };

  I.calculateTransFatBonus = (transGrams = 0) => {
    if (!transGrams || transGrams <= 0) return 0;
    if (transGrams >= 2) return I.TRANS_FAT_BONUS.high.bonus;
    if (transGrams >= 1) return I.TRANS_FAT_BONUS.medium.bonus;
    if (transGrams >= 0.5) return I.TRANS_FAT_BONUS.low.bonus;
    return 0;
  };

  I.calculateFastingBonus = (hoursSinceMeal = 0) => {
    if (!hoursSinceMeal || hoursSinceMeal <= 0) return 0;
    if (hoursSinceMeal >= 16) return I.FASTING_BONUS.long.bonus;
    if (hoursSinceMeal >= 12) return I.FASTING_BONUS.medium.bonus;
    if (hoursSinceMeal >= 8) return I.FASTING_BONUS.short.bonus;
    return 0;
  };

  // === –¢–†–ï–ù–ò–†–û–í–ö–ò ===

  I.getPreviousDayTrainings = (todayDate, lsGet) => {
    if (!lsGet) return { trainings: [], totalKcal: 0, hoursSince: Infinity, dominantType: null };

    const yesterday = new Date(todayDate);
    yesterday.setDate(yesterday.getDate() - 1);
    const yKey = yesterday.toISOString().slice(0, 10);

    const dayData = lsGet(`heys_dayv2_${yKey}`, null);
    if (!dayData || !dayData.trainings || dayData.trainings.length === 0) {
      return { trainings: [], totalKcal: 0, hoursSince: Infinity, dominantType: null };
    }

    const trainings = dayData.trainings;
    let totalKcal = 0;
    let lastTrainingTime = null;

    for (const t of trainings) {
      totalKcal += I.utils.calculateTrainingKcal(t, 70);
      if (t.time) lastTrainingTime = t.time;
    }

    let hoursSince = 24;
    if (lastTrainingTime) {
      const [h, m] = lastTrainingTime.split(':').map(Number);
      const trainingMinutes = (h || 0) * 60 + (m || 0);
      const now = new Date();
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      hoursSince = (24 * 60 - trainingMinutes + nowMinutes) / 60;
    }

    const dominantType = trainings.length > 0 ? (trainings[0].type || 'cardio') : null;

    return { trainings, totalKcal, hoursSince, dominantType };
  };

  // === NDTE (Next-Day Training Effect) ===

  I.calculateNDTEBMIMultiplier = (bmi) => {
    if (!bmi || bmi <= 0) return 1.0;
    for (const [, tier] of Object.entries(I.NDTE.bmiMultiplier)) {
      if (bmi >= tier.minBMI) return tier.multiplier;
    }
    return 1.0;
  };

  I.calculateNDTEDecay = (hoursSince) => {
    if (!hoursSince || hoursSince <= 0) return 1.0;
    if (hoursSince >= I.NDTE.maxWindowHours) return 0;
    for (const tier of I.NDTE.decay.tiers) {
      if (hoursSince <= tier.maxHours) return tier.multiplier;
    }
    return 0;
  };

  I.calculateNDTE = (params) => {
    const { trainingKcal = 0, hoursSince = Infinity, bmi = 22, trainingType = 'cardio', trainingsCount = 1 } = params;

    if (hoursSince >= I.NDTE.maxWindowHours || trainingKcal < 200) {
      return { active: false, tdeeBoost: 0, waveReduction: 0, peakReduction: 0, label: null, badge: null };
    }

    let baseTier = null;
    for (const tier of I.NDTE.kcalTiers) {
      if (trainingKcal >= tier.minKcal) {
        baseTier = tier;
        break;
      }
    }

    if (!baseTier) {
      const ratio = trainingKcal / 300;
      const minTier = I.NDTE.kcalTiers[I.NDTE.kcalTiers.length - 1];
      baseTier = {
        tdeeBoost: minTier.tdeeBoost * ratio,
        waveReduction: minTier.waveReduction * ratio,
        peakReduction: minTier.peakReduction * ratio,
        label: '‚ö° –õ—ë–≥–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
      };
    }

    const bmiMult = I.calculateNDTEBMIMultiplier(bmi);
    const decayMult = I.calculateNDTEDecay(hoursSince);
    const typeMult = I.NDTE.typeMultiplier[trainingType] || { tdee: 1.0, wave: 1.0 };

    let cumulativeMult = 1.0;
    if (I.NDTE.cumulative.enabled && trainingsCount > 1) {
      cumulativeMult = Math.min(I.NDTE.cumulative.maxMultiplier, 1 + (trainingsCount - 1) * 0.2);
    }

    const tdeeBoost = baseTier.tdeeBoost * bmiMult * decayMult * typeMult.tdee * cumulativeMult;
    const waveReduction = baseTier.waveReduction * bmiMult * decayMult * typeMult.wave * cumulativeMult;
    const peakReduction = baseTier.peakReduction * bmiMult * decayMult * cumulativeMult;

    return {
      active: true,
      tdeeBoost: Math.min(0.20, Math.round(tdeeBoost * 1000) / 1000),
      waveReduction: Math.min(0.45, Math.round(waveReduction * 1000) / 1000),
      peakReduction: Math.min(0.50, Math.round(peakReduction * 1000) / 1000),
      label: baseTier.label,
      badge: I.NDTE.badge,
      badgeColor: I.NDTE.badgeColor,
      trainingKcal,
      hoursSince: Math.round(hoursSince),
      bmiMultiplier: bmiMult,
      decayMultiplier: decayMult,
      typeMultiplier: typeMult,
      trainingsCount
    };
  };

  // === BMI ===

  I.calculateBMI = (weight, height) => {
    if (!weight || !height || weight <= 0 || height <= 0) return 22;
    const heightM = height / 100;
    return Math.round((weight / (heightM * heightM)) * 10) / 10;
  };

  I.getBMICategory = (bmi) => {
    if (bmi < 18.5) return { category: 'underweight', color: '#eab308', desc: '–ù–µ–¥–æ–≤–µ—Å' };
    if (bmi < 25) return { category: 'normal', color: '#22c55e', desc: '–ù–æ—Ä–º–∞' };
    if (bmi < 30) return { category: 'overweight', color: '#f97316', desc: '–ò–∑–±—ã—Ç–æ–∫' };
    return { category: 'obese', color: '#ef4444', desc: '–û–∂–∏—Ä–µ–Ω–∏–µ' };
  };

  // === –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê –ò –ü–û–†–¶–ò–ò ===

  I.detectFoodTemperature = (items = [], getProductFromItem) => {
    if (!items || items.length === 0) {
      return { temperature: 'room', ...I.FOOD_TEMPERATURE_BONUS.room };
    }

    let hotCount = 0;
    let coldCount = 0;

    for (const item of items) {
      const prod = getProductFromItem ? getProductFromItem(item) : item;
      const name = (prod?.name || item?.name || '').toLowerCase();

      if (I.FOOD_TEMPERATURE_BONUS.hot.patterns.some(p => p.test(name))) hotCount++;
      if (I.FOOD_TEMPERATURE_BONUS.cold.patterns.some(p => p.test(name))) coldCount++;
    }

    if (hotCount > 0 && coldCount > 0) return { temperature: 'room', ...I.FOOD_TEMPERATURE_BONUS.room };
    if (hotCount > 0) return { temperature: 'hot', ...I.FOOD_TEMPERATURE_BONUS.hot };
    if (coldCount > 0) return { temperature: 'cold', ...I.FOOD_TEMPERATURE_BONUS.cold };
    return { temperature: 'room', ...I.FOOD_TEMPERATURE_BONUS.room };
  };

  I.calculateLargePortionBonus = (mealKcal = 0) => {
    if (!mealKcal || mealKcal <= 0) {
      return { bonus: 0, peakReduction: 1.0, desc: null };
    }

    for (const tier of I.LARGE_PORTION_BONUS.thresholds) {
      if (mealKcal >= tier.minKcal) {
        return {
          bonus: Math.min(tier.bonus, I.LARGE_PORTION_BONUS.maxBonus),
          peakReduction: tier.peakReduction,
          desc: tier.desc
        };
      }
    }
    return { bonus: 0, peakReduction: 1.0, desc: null };
  };

  // === –ì–ò–ü–û–ì–õ–ò–ö–ï–ú–ò–Ø –ò INSULIN INDEX ===

  I.getHypoglycemiaWarning = (params = {}) => {
    const { gi = 0, protein = 0, fat = 0, isFasted = false } = params;
    const rf = I.REACTIVE_HYPOGLYCEMIA.riskFactors;
    let score = 0;
    const details = [];

    if (gi > rf.highGI.threshold) {
      score += rf.highGI.weight;
      details.push({ factor: 'highGI', value: gi, threshold: rf.highGI.threshold });
    }
    if (protein < rf.lowProtein.threshold) {
      score += rf.lowProtein.weight;
      details.push({ factor: 'lowProtein', value: protein, threshold: rf.lowProtein.threshold });
    }
    if (fat < rf.lowFat.threshold) {
      score += rf.lowFat.weight;
      details.push({ factor: 'lowFat', value: fat, threshold: rf.lowFat.threshold });
    }
    if (isFasted) {
      score += rf.fasted.weight;
      details.push({ factor: 'fasted', value: true });
    }

    const hasRisk = score >= I.REACTIVE_HYPOGLYCEMIA.warningThreshold;

    return {
      hasRisk,
      score,
      riskWindow: I.REACTIVE_HYPOGLYCEMIA.riskWindow,
      details,
      ui: hasRisk ? {
        emoji: I.REACTIVE_HYPOGLYCEMIA.ui.warningEmoji,
        color: I.REACTIVE_HYPOGLYCEMIA.ui.warningColor,
        title: I.REACTIVE_HYPOGLYCEMIA.ui.warningTitle,
        desc: I.REACTIVE_HYPOGLYCEMIA.ui.warningDesc,
        advice: I.REACTIVE_HYPOGLYCEMIA.ui.advice,
        symptoms: I.REACTIVE_HYPOGLYCEMIA.ui.symptoms
      } : null
    };
  };

  I.getInsulinIndexWaveModifier = (insulinogenicType) => {
    if (!insulinogenicType || !I.INSULIN_INDEX_FACTORS[insulinogenicType]) {
      return { waveMultiplier: 1.0, peakMultiplier: 1.0, glBoost: 1.0, desc: null };
    }

    const factor = I.INSULIN_INDEX_FACTORS[insulinogenicType];
    return {
      waveMultiplier: factor.waveMultiplier,
      peakMultiplier: factor.peakMultiplier,
      glBoost: factor.glBoost,
      desc: factor.desc
    };
  };

  // Mark constants as loaded
  I._loaded.constants = true;

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_utils.js ===== */
// heys_iw_utils.js ‚Äî Insulin Wave Utils Module
// Version: 1.0.0 | Date: 2026-01-11
//
// PURPOSE: Utility functions for time, formatting, and calculations

(function(global) {
  'use strict';
  
  const IW = global.HEYS?.InsulinWave;
  const I = IW?.__internals;
  
  if (!I) {
    console.error('[IW utils] Shim required');
    return;
  }
  
  if (!I._loaded.shim) {
    console.error('[IW utils] Shim must be loaded first');
    return;
  }
  
  // Guard: constants needed for GI_CATEGORIES reference
  if (!I._loaded.constants) {
    console.error('[IW utils] Constants module required');
    return;
  }
  
  // Get constants we need
  const GI_CATEGORIES = I.GI_CATEGORIES;
  
  // === UTILS OBJECT ===
  // Build the utils object and store in I._utils
  // This will be exported to public API by finalize module
  
  I._utils = {
    // –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã —Å –ø–æ–ª—É–Ω–æ—á–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 24:xx, 25:xx —Ñ–æ—Ä–º–∞—Ç)
    timeToMinutes: (timeStr) => {
      if (!timeStr) return 0;
      const [h, m] = timeStr.split(':').map(Number);
      // 24:20 ‚Üí 0*60 + 20 = 20, –Ω–æ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
      return (h || 0) * 60 + (m || 0);
    },
    
    // üÜï v3.7.7: –†–∞—Å—á—ë—Ç –∫–∫–∞–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ MET-–∑–Ω–∞—á–µ–Ω–∏—è –∑–æ–Ω –ø—É–ª—å—Å–∞
    // –ù–∞—É—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: MET √ó 3.5 √ó –≤–µ—Å / 200 = –∫–∫–∞–ª/–º–∏–Ω
    // –ò—Å—Ç–æ—á–Ω–∏–∫: Ainsworth 2011, Compendium of Physical Activities
    calculateTrainingKcal: (training, weight = 70) => {
      if (!training || !training.z) return 0;
      const zones = training.z || [0, 0, 0, 0];
      const totalMinutes = zones.reduce((a, b) => a + (+b || 0), 0);
      if (totalMinutes === 0) return 0;
      
      // MET –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∑–æ–Ω–∞–º (–∏–∑ heys_hr_zones –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
      // Zone 1: 2.5 MET (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, 50-60% HRmax)
      // Zone 2: 6 MET (–∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ, 60-70% HRmax)
      // Zone 3: 8 MET (–∞—ç—Ä–æ–±–Ω–∞—è, 70-80% HRmax)
      // Zone 4: 10 MET (–∞–Ω–∞—ç—Ä–æ–±–Ω–∞—è, 80-90% HRmax)
      let mets = [2.5, 6, 8, 10];
      try {
        const lsGet = global.HEYS?.utils?.lsGet;
        const hrZones = (typeof lsGet === 'function') ? lsGet('heys_hr_zones', []) : [];
        if (hrZones.length >= 4) {
          mets = [2.5, 6, 8, 10].map((def, i) => +hrZones[i]?.MET || def);
        }
      } catch (e) { /* fallback to defaults */ }
      
      // –∫–∫–∞–ª/–º–∏–Ω = MET √ó 3.5 √ó –≤–µ—Å(–∫–≥) / 200
      const kcalPerMin = (met, w) => (met * 3.5 * w / 200);
      
      const kcal = zones.reduce((sum, min, i) => sum + (+min || 0) * kcalPerMin(mets[i], weight), 0);
      return Math.round(kcal);
    },
    
    // –ú–∏–Ω—É—Ç—ã –≤ HH:MM (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç 24+ —á–∞—Å–æ–≤)
    minutesToTime: (minutes) => {
      const h = Math.floor(minutes / 60) % 24;
      const m = minutes % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    },
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (24:20 ‚Üí 00:20)
    normalizeTimeForDisplay: (timeStr) => {
      if (!timeStr) return '';
      const [h, m] = timeStr.split(':').map(Number);
      if (isNaN(h)) return timeStr;
      const normalH = h % 24;
      return String(normalH).padStart(2, '0') + ':' + String(m || 0).padStart(2, '0');
    },
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    formatDuration: (minutes) => {
      if (minutes <= 0) return '0 –º–∏–Ω';
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      if (h === 0) return `${m} –º–∏–Ω`;
      if (m === 0) return `${h}—á`;
      return `${h}—á ${m}–º`;
    },
    
    // –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ì–ò
    getGICategory: (gi) => {
      if (gi <= 35) return GI_CATEGORIES.low;
      if (gi <= 55) return GI_CATEGORIES.medium;
      if (gi <= 70) return GI_CATEGORIES.high;
      return GI_CATEGORIES.veryHigh;
    },
    
    // –ù–æ—á–Ω–æ–µ –≤—Ä–µ–º—è?
    isNightTime: (hour) => hour >= 22 || hour < 6,
    
    // –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
    getDateKey: (date = new Date()) => date.toISOString().slice(0, 10),
    
    // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—Ä–∏—ë–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    getNextMealSuggestion: (hour) => {
      if (hour >= 22 || hour < 6) return null;
      if (hour < 10) return { type: 'breakfast', icon: 'üç≥', name: '–ó–∞–≤—Ç—Ä–∞–∫' };
      if (hour < 12) return { type: 'snack', icon: 'üçé', name: '–ü–µ—Ä–µ–∫—É—Å' };
      if (hour < 14) return { type: 'lunch', icon: 'üç≤', name: '–û–±–µ–¥' };
      if (hour < 17) return { type: 'snack', icon: 'ü•ú', name: '–ü–µ—Ä–µ–∫—É—Å' };
      if (hour < 20) return { type: 'dinner', icon: 'üçΩÔ∏è', name: '–£–∂–∏–Ω' };
      return { type: 'light', icon: 'ü•õ', name: '–õ—ë–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å' };
    },
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∫ —Å—É—Ç–∫–∞–º HEYS (–¥–µ–Ω—å = 03:00 ‚Üí 03:00)
    normalizeToHeysDay: (timeMin) => {
      const HEYS_DAY_START = 3 * 60; // 03:00 = 180 –º–∏–Ω—É—Ç
      const totalMinutes = timeMin % (24 * 60);
      if (totalMinutes >= HEYS_DAY_START) {
        return totalMinutes - HEYS_DAY_START; // 03:00 ‚Üí 0, 04:00 ‚Üí 60
      }
      return totalMinutes + (24 * 60 - HEYS_DAY_START); // 00:00 ‚Üí 1260, 02:59 ‚Üí 1439
    }
  };
  
  // === EXPORT TO PUBLIC API ===
  const IW_NS = global.HEYS.InsulinWave;
  IW_NS.utils = I._utils;
  
  // Mark utils as loaded
  I._loaded.utils = true;
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_lipolysis.js ===== */
// heys_iw_lipolysis.js ‚Äî Lipolysis Records & Streak Module
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞–º–∏ –ª–∏–ø–æ–ª–∏–∑–∞, –∏—Å—Ç–æ—Ä–∏–µ–π –∏ streak'–∞–º–∏.
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.
//
// –§–£–ù–ö–¶–ò–ò:
// - getLipolysisRecord() ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ª–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥
// - updateLipolysisRecord() ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥ –µ—Å–ª–∏ –ø–æ–±–∏—Ç
// - getLipolysisHistory() ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞ 30 –¥–Ω–µ–π
// - saveDayLipolysis() ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–ø–æ–ª–∏–∑ –∑–∞ –¥–µ–Ω—å
// - calculateLipolysisStreak() ‚Äî —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∏ –ª—É—á—à–∏–π streak
// - calculateLipolysisKcal() ‚Äî –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –∫–∫–∞–ª –∑–∞ –≤—Ä–µ–º—è –ª–∏–ø–æ–ª–∏–∑–∞

(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  
  // === –ò–ú–ü–û–†–¢ –ö–û–ù–°–¢–ê–ù–¢ ===
  const I = HEYS.InsulinWave?.__internals;
  const LIPOLYSIS_RECORD_KEY = I?.LIPOLYSIS_RECORD_KEY;
  const LIPOLYSIS_HISTORY_KEY = I?.LIPOLYSIS_HISTORY_KEY;
  const MIN_LIPOLYSIS_FOR_STREAK = I?.MIN_LIPOLYSIS_FOR_STREAK;
  const KCAL_PER_MIN_BASE = I?.KCAL_PER_MIN_BASE;
  
  // === –ò–ú–ü–û–†–¢ –£–¢–ò–õ–ò–¢ ===
  const utils = HEYS.InsulinWave?.utils;
  
  // === –†–ï–ö–û–†–î–´ –ò STREAK –õ–ò–ü–û–õ–ò–ó–ê ===
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ—Ä–¥ –ª–∏–ø–æ–ª–∏–∑–∞
   */
  const getLipolysisRecord = () => {
    try {
      const record = localStorage.getItem(LIPOLYSIS_RECORD_KEY);
      return record ? JSON.parse(record) : { minutes: 0, date: null };
    } catch (e) {
      return { minutes: 0, date: null };
    }
  };
  
  /**
   * –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥ –ª–∏–ø–æ–ª–∏–∑–∞ (–µ—Å–ª–∏ –ø–æ–±–∏—Ç)
   * @returns {boolean} true –µ—Å–ª–∏ —Ä–µ–∫–æ—Ä–¥ –ø–æ–±–∏—Ç
   */
  const updateLipolysisRecord = (minutes) => {
    const current = getLipolysisRecord();
    if (minutes > current.minutes) {
      const newRecord = { 
        minutes, 
        date: utils.getDateKey(),
        previousRecord: current.minutes > 0 ? current.minutes : null
      };
      try {
        localStorage.setItem(LIPOLYSIS_RECORD_KEY, JSON.stringify(newRecord));
      } catch (e) {}
      return true;
    }
    return false;
  };
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ª–∏–ø–æ–ª–∏–∑–∞ –ø–æ –¥–Ω—è–º
   */
  const getLipolysisHistory = () => {
    try {
      const history = localStorage.getItem(LIPOLYSIS_HISTORY_KEY);
      return history ? JSON.parse(history) : [];
    } catch (e) {
      return [];
    }
  };
  
  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–ø–æ–ª–∏–∑ –∑–∞ –¥–µ–Ω—å (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–Ω—è –∏–ª–∏ –≤ –ø–æ–ª–Ω–æ—á—å)
   */
  const saveDayLipolysis = (date, minutes) => {
    const history = getLipolysisHistory();
    const existing = history.findIndex(h => h.date === date);
    
    if (existing >= 0) {
      history[existing].minutes = Math.max(history[existing].minutes, minutes);
    } else {
      history.push({ date, minutes });
    }
    
    // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    const sorted = history.sort((a, b) => b.date.localeCompare(a.date)).slice(0, 30);
    
    try {
      localStorage.setItem(LIPOLYSIS_HISTORY_KEY, JSON.stringify(sorted));
    } catch (e) {}
    
    return sorted;
  };
  
  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å streak –ª–∏–ø–æ–ª–∏–∑–∞ (–¥–Ω–∏ –ø–æ–¥—Ä—è–¥ —Å 4+ —á–∞—Å–∞–º–∏)
   */
  const calculateLipolysisStreak = () => {
    const history = getLipolysisHistory();
    if (history.length === 0) return { current: 0, best: 0 };
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
    const sorted = [...history].sort((a, b) => b.date.localeCompare(a.date));
    
    let currentStreak = 0;
    let bestStreak = 0;
    let tempStreak = 0;
    
    const today = utils.getDateKey();
    const yesterday = utils.getDateKey(new Date(Date.now() - 86400000));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å
    for (let i = 0; i < sorted.length; i++) {
      const entry = sorted[i];
      const prevEntry = sorted[i - 1];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –ª–∏–ø–æ–ª–∏–∑–∞
      if (entry.minutes >= MIN_LIPOLYSIS_FOR_STREAK) {
        if (i === 0) {
          // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å (—Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ –≤—á–µ—Ä–∞)
          if (entry.date === today || entry.date === yesterday) {
            tempStreak = 1;
            currentStreak = 1;
          } else {
            tempStreak = 1;
          }
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–Ω–µ–π
          const prevDate = new Date(prevEntry.date);
          const currDate = new Date(entry.date);
          const diffDays = Math.round((prevDate - currDate) / 86400000);
          
          if (diffDays === 1) {
            tempStreak++;
            if (sorted[0].date === today || sorted[0].date === yesterday) {
              currentStreak = tempStreak;
            }
          } else {
            bestStreak = Math.max(bestStreak, tempStreak);
            tempStreak = 1;
          }
        }
      } else {
        bestStreak = Math.max(bestStreak, tempStreak);
        tempStreak = 0;
        if (i === 0) currentStreak = 0;
      }
    }
    
    bestStreak = Math.max(bestStreak, tempStreak);
    
    return { current: currentStreak, best: bestStreak };
  };
  
  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–æ–∂–∂—ë–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –∑–∞ –≤—Ä–µ–º—è –ª–∏–ø–æ–ª–∏–∑–∞
   * @param {number} minutes - –º–∏–Ω—É—Ç—ã –ª–∏–ø–æ–ª–∏–∑–∞
   * @param {number} weight - –≤–µ—Å –≤ –∫–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   */
  const calculateLipolysisKcal = (minutes, weight = 70) => {
    // –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –≤ –ø–æ–∫–æ–µ ‚âà 1 –∫–∫–∞–ª/–º–∏–Ω –¥–ª—è 70–∫–≥ —á–µ–ª–æ–≤–µ–∫–∞
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Å—É: weight/70
    // –õ–∏–ø–æ–ª–∏–∑ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 10-15%
    const baseRate = KCAL_PER_MIN_BASE * (weight / 70);
    const lipolysisBonus = 1.12; // +12% –ø—Ä–∏ –ª–∏–ø–æ–ª–∏–∑–µ
    
    return Math.round(minutes * baseRate * lipolysisBonus);
  };
  
  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.Lipolysis = {
    getLipolysisRecord,
    updateLipolysisRecord,
    getLipolysisHistory,
    saveDayLipolysis,
    calculateLipolysisStreak,
    calculateLipolysisKcal
  };
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_v30.js ===== */
// heys_iw_v30.js ‚Äî InsulinWave v3.0 Features Module
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Ñ–∏—á–µ–π v3.0: –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ GL, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥,
// meal stacking, –∏ —Ñ–∞–∑—ã –≤–æ–ª–Ω—ã (rise ‚Üí plateau ‚Üí decline).
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.
//
// –ö–û–ù–¶–ï–ü–¶–ò–ò v3.0:
// 1. –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ GL (–±–µ–∑ —Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π) ‚Äî –ø–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è
// 2. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –≤–æ–ª–Ω—ã (—É—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞, BMI, –ø–æ–ª–∞)
// 3. –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏—ë–º–æ–≤ (Meal Stacking) ‚Äî –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç –≤–æ–ª–Ω
// 4. –§–∞–∑—ã –≤–æ–ª–Ω—ã (rise ‚Üí plateau ‚Üí decline ‚Üí lipolysis)
// 5. –ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å (II) –¥–ª—è –º–æ–ª–æ—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
//
// –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞: Brand-Miller 2003, Wolever 2006, Van Cauter 1997

(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  
  // === –ò–ú–ü–û–†–¢ –ö–û–ù–°–¢–ê–ù–¢ ===
  const I = HEYS.InsulinWave?.__internals;
  const GL_CONTINUOUS = I?.GL_CONTINUOUS;
  const PERSONAL_BASELINE = I?.PERSONAL_BASELINE;
  const MEAL_STACKING = I?.MEAL_STACKING;
  const WAVE_PHASES = I?.WAVE_PHASES;
  const INSULIN_INDEX_FACTORS = I?.INSULIN_INDEX_FACTORS;
  
  // === –ò–ú–ü–û–†–¢ –£–¢–ò–õ–ò–¢ ===
  const utils = HEYS.InsulinWave?.utils;
  
  // === v3.0 –§–£–ù–ö–¶–ò–ò ===
  
  /**
   * üìà –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç GL –º–Ω–æ–∂–∏—Ç–µ–ª—è (–±–µ–∑ —Å—Ç—É–ø–µ–Ω–µ–∫)
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–µ–ø–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
   * 
   * @param {number} gl - –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
   * @returns {number} –º–Ω–æ–∂–∏—Ç–µ–ª—å 0.15-1.30
   * 
   * –ü—Ä–∏–º–µ—Ä—ã:
   * - GL=0: 0.15 (–≤–æ–ª–Ω–∞ 27 –º–∏–Ω)
   * - GL=5: 0.35 (–≤–æ–ª–Ω–∞ 63 –º–∏–Ω)
   * - GL=7: 0.43 (–≤–æ–ª–Ω–∞ 77 –º–∏–Ω ‚âà 1—á 17–º–∏–Ω)
   * - GL=10: 0.52 (–≤–æ–ª–Ω–∞ 94 –º–∏–Ω ‚âà 1—á 34–º–∏–Ω)
   * - GL=15: 0.68 (–≤–æ–ª–Ω–∞ 122 –º–∏–Ω ‚âà 2—á)
   * - GL=20: 0.82 (–≤–æ–ª–Ω–∞ 148 –º–∏–Ω ‚âà 2—á 28–º–∏–Ω)
   * - GL=30: 1.05 (–≤–æ–ª–Ω–∞ 189 –º–∏–Ω ‚âà 3—á 9–º–∏–Ω)
   * - GL=40+: 1.30 (–≤–æ–ª–Ω–∞ 234 –º–∏–Ω ‚âà 3—á 54–º–∏–Ω)
   */
  const calculateContinuousGLMultiplier = (gl) => {
    if (gl === null || gl === undefined || isNaN(gl)) return 1.0;
    if (gl <= 0) return GL_CONTINUOUS.minMultiplier;
    if (gl >= GL_CONTINUOUS.maxGL) return GL_CONTINUOUS.maxMultiplier;
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º GL –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0-1
    const normalized = gl / GL_CONTINUOUS.maxGL;
    
    // –°—Ç–µ–ø–µ–Ω–Ω–∞—è –∫—Ä–∏–≤–∞—è: –±—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç –≤ –Ω–∞—á–∞–ª–µ, –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ü—É
    const curved = Math.pow(normalized, GL_CONTINUOUS.exponent);
    
    // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É min –∏ max
    const range = GL_CONTINUOUS.maxMultiplier - GL_CONTINUOUS.minMultiplier;
    const result = GL_CONTINUOUS.minMultiplier + range * curved;
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç NaN
    return isNaN(result) ? 1.0 : result;
  };

  /**
   * üë§ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –≤–æ–ª–Ω—ã
   * –£—á–∏—Ç—ã–≤–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç, BMI –∏ –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * 
   * @param {Object} profile - –ø—Ä–æ—Ñ–∏–ª—å { age, weight, height, gender }
   * @returns {Object} { baseHours, factors, formula }
   */
  const calculatePersonalBaselineWave = (profile = {}) => {
    let baseHours = PERSONAL_BASELINE.defaultWaveHours;
    const factors = [];
    
    // üë¥ –í–æ–∑—Ä–∞—Å—Ç
    const age = profile.age || 0;
    let ageFactor = 0;
    if (age > PERSONAL_BASELINE.ageEffect.startAge) {
      const yearsOver = age - PERSONAL_BASELINE.ageEffect.startAge;
      ageFactor = yearsOver * PERSONAL_BASELINE.ageEffect.bonusPerYear;
      factors.push({ 
        type: 'age', 
        value: ageFactor, 
        desc: `–í–æ–∑—Ä–∞—Å—Ç ${age} ‚Üí +${Math.round(ageFactor * 100)}%` 
      });
    }
    
    // üèãÔ∏è BMI
    const weight = profile.weight || 0;
    const height = profile.height || 0;
    let bmiFactor = 0;
    if (weight > 0 && height > 0) {
      const bmi = weight / Math.pow(height / 100, 2);
      if (bmi > PERSONAL_BASELINE.bmiEffect.startBMI) {
        const unitsOver = bmi - PERSONAL_BASELINE.bmiEffect.startBMI;
        bmiFactor = unitsOver * PERSONAL_BASELINE.bmiEffect.bonusPerUnit;
        factors.push({ 
          type: 'bmi', 
          value: bmiFactor, 
          desc: `BMI ${bmi.toFixed(1)} ‚Üí +${Math.round(bmiFactor * 100)}%` 
        });
      } else if (bmi < PERSONAL_BASELINE.bmiEffect.startBMI) {
        // –ù–∏–∑–∫–∏–π BMI = –±–æ–Ω—É—Å (–ª—É—á—à–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
        const unitsUnder = PERSONAL_BASELINE.bmiEffect.startBMI - bmi;
        bmiFactor = -unitsUnder * PERSONAL_BASELINE.bmiEffect.bonusPerUnit * 0.5; // –ü–æ–ª–æ–≤–∏–Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞
        if (bmiFactor < -0.10) bmiFactor = -0.10; // –ú–∞–∫—Å–∏–º—É–º -10%
        factors.push({ 
          type: 'bmi', 
          value: bmiFactor, 
          desc: `BMI ${bmi.toFixed(1)} ‚Üí ${Math.round(bmiFactor * 100)}%` 
        });
      }
    }
    
    // üö∫üöπ –ü–æ–ª
    const gender = (profile.gender || '').toLowerCase();
    let genderFactor = 0;
    if (gender === '–∂–µ–Ω—Å–∫–∏–π' || gender === 'female') {
      genderFactor = PERSONAL_BASELINE.genderEffect.female;
      factors.push({ type: 'gender', value: genderFactor, desc: '–ñ–µ–Ω—Å–∫–∏–π –ø–æ–ª ‚Üí -8%' });
    } else if (gender === '–º—É–∂—Å–∫–æ–π' || gender === 'male') {
      genderFactor = PERSONAL_BASELINE.genderEffect.male;
      factors.push({ type: 'gender', value: genderFactor, desc: '–ú—É–∂—Å–∫–æ–π –ø–æ–ª ‚Üí +5%' });
    }
    
    // –°—É–º–º–∞—Ä–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
    const totalFactor = 1 + ageFactor + bmiFactor + genderFactor;
    baseHours = PERSONAL_BASELINE.defaultWaveHours * totalFactor;
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
    baseHours = Math.max(PERSONAL_BASELINE.minWaveHours, 
                         Math.min(PERSONAL_BASELINE.maxWaveHours, baseHours));
    
    // üÜï v3.0.1: –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∞–∑—É –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –Ω–∞–¥–±–∞–≤–∫—É
    // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è GL-—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL –Ω–∞–¥–±–∞–≤–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ
    const standardBase = PERSONAL_BASELINE.defaultWaveHours;
    const personalDelta = baseHours - standardBase; // –ú–æ–∂–µ—Ç –±—ã—Ç—å + –∏–ª–∏ -
    
    return {
      baseHours: Math.round(baseHours * 100) / 100,
      standardBase,  // üÜï –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ 3—á
      personalDelta: Math.round(personalDelta * 100) / 100, // üÜï –ù–∞–¥–±–∞–≤–∫–∞ (+0.29—á –∏–ª–∏ -0.24—á)
      factors,
      totalFactor: Math.round(totalFactor * 100) / 100,
      formula: `${PERSONAL_BASELINE.defaultWaveHours}—á √ó ${totalFactor.toFixed(2)} = ${baseHours.toFixed(1)}—á`
    };
  };

  /**
   * üîó –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ –≤–æ–ª–Ω (Meal Stacking)
   * –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–æ–ø–∞–¥–∞–µ—Ç –≤ "–∞–∫—Ç–∏–≤–Ω—É—é" –≤–æ–ª–Ω—É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ,
   * üî¨ v3.7.4: –ù–ê–£–ß–ù–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø ‚Äî "Second Meal Effect" (Wolever 2006)
   * –ï—Å–ª–∏ –∏–Ω—Å—É–ª–∏–Ω —É–∂–µ –≤ –∫—Ä–æ–≤–∏ (–æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞), –Ω—É–∂–Ω–æ –ú–ï–ù–¨–®–ï –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—É–ª–∏–Ω–∞
   * –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–æ–ª–Ω–∞ –ö–û–†–û–ß–ï, –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ!
   * 
   * @param {number} prevWaveEndMinutes - –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–æ–ª–Ω—ã (–æ—Ç –ø–æ–ª—É–Ω–æ—á–∏)
   * @param {number} newMealMinutes - –≤—Ä–µ–º—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∏—ë–º–∞ (–æ—Ç –ø–æ–ª—É–Ω–æ—á–∏)
   * @param {number} prevGL - GL –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞
   * @returns {Object} { stackBonus, overlapMinutes, desc, hasStacking }
   */
  const calculateMealStackingBonus = (prevWaveEndMinutes, newMealMinutes, prevGL = 15) => {
    if (!MEAL_STACKING.enabled) {
      return { stackBonus: 0, overlapMinutes: 0, desc: null, hasStacking: false };
    }
    
    // –°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –Ω–æ–≤—ã–π –ø—Ä–∏—ë–º "–≤–Ω—É—Ç—Ä–∏" –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–æ–ª–Ω—ã
    let overlapMinutes = prevWaveEndMinutes - newMealMinutes;
    
    // –£—á—ë—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å
    if (overlapMinutes < -12 * 60) {
      overlapMinutes += 24 * 60;
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ (–Ω–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ –≤–æ–ª–Ω—ã)
    if (overlapMinutes <= 0) {
      return { stackBonus: 0, overlapMinutes: 0, desc: null, hasStacking: false };
    }
    
    // üî¨ v3.7.4: Second Meal Effect ‚Äî –±–æ–Ω—É—Å –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô (—É–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤–æ–ª–Ω—É)
    // –ß–µ–º –±–æ–ª—å—à–µ –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç ‚Üí —Ç–µ–º –±–æ–ª—å—à–µ –∏–Ω—Å—É–ª–∏–Ω–∞ —É–∂–µ –≤ –∫—Ä–æ–≤–∏ ‚Üí –º–µ–Ω—å—à–µ –Ω—É–∂–Ω–æ –Ω–æ–≤–æ–≥–æ
    // overlapMinutes=60 ‚Üí ~50% —ç—Ñ—Ñ–µ–∫—Ç–∞, overlapMinutes=120 ‚Üí ~100% —ç—Ñ—Ñ–µ–∫—Ç–∞
    const decayFactor = Math.min(1, overlapMinutes / 90 * MEAL_STACKING.decayRate);
    
    // GL –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞: –≤—ã—Å–æ–∫–∞—è GL = –±–æ–ª—å—à–µ –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∏–Ω—Å—É–ª–∏–Ω–∞ = —Å–∏–ª—å–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç
    // –ù–æ –¥–µ–ª–∏–º –Ω–∞ 30 –≤–º–µ—Å—Ç–æ 20 ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω—ã–º
    const glFactor = Math.min(1.2, prevGL / 30);
    
    // –ò—Ç–æ–≥–æ–≤—ã–π –±–æ–Ω—É—Å (–û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô ‚Äî –≤–æ–ª–Ω–∞ –∫–æ—Ä–æ—á–µ!)
    let stackBonus = decayFactor * glFactor * MEAL_STACKING.maxStackBonus;
    // maxStackBonus = -0.15, –∑–Ω–∞—á–∏—Ç stackBonus –±—É–¥–µ—Ç –æ—Ç 0 –¥–æ -0.15
    stackBonus = Math.max(MEAL_STACKING.maxStackBonus, stackBonus);
    
    // –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è UI
    const desc = stackBonus < -0.03
      ? `üîó Second meal effect ‚Üí –≤–æ–ª–Ω–∞ ${Math.round(Math.abs(stackBonus) * 100)}% –∫–æ—Ä–æ—á–µ`
      : null;
    
    return {
      stackBonus: Math.round(stackBonus * 100) / 100,
      overlapMinutes,
      desc,
      hasStacking: stackBonus < -0.03
    };
  };

  /**
   * üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ñ–∞–∑—ã –≤–æ–ª–Ω—ã (rise ‚Üí plateau ‚Üí decline)
   * 
   * @param {number} totalWaveMinutes - –æ–±—â–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ –º–∏–Ω—É—Ç–∞—Ö
   * @param {Object} nutrients - { fiber, protein, fat, hasLiquid }
   * @param {boolean} hasActivity - –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –µ–¥—ã
   * @returns {Object} { rise, plateau, decline, lipolysisStart, phases[] }
   */
  const calculateWavePhases = (totalWaveMinutes, nutrients = {}, hasActivity = false) => {
    // Rise (–ø–æ–¥—ä—ë–º)
    let riseMinutes = WAVE_PHASES.rise.baseMinutes;
    
    // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç –ø–æ–¥—ä—ë–º
    const fiber = nutrients.fiber || 0;
    riseMinutes += Math.floor(fiber / 5) * WAVE_PHASES.rise.fiberBonus;
    
    // –ñ–∏–¥–∫–æ–µ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–¥—ä—ë–º
    if (nutrients.hasLiquid) {
      riseMinutes = Math.round(riseMinutes * WAVE_PHASES.rise.liquidPenalty);
    }
    
    riseMinutes = Math.max(10, Math.min(45, riseMinutes));
    
    // Plateau (–ø–ª–∞—Ç–æ) ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
    const remainingAfterRise = totalWaveMinutes - riseMinutes;
    let plateauPct = WAVE_PHASES.plateau.basePct;
    
    // –ë–µ–ª–æ–∫ —É–¥–ª–∏–Ω—è–µ—Ç –ø–ª–∞—Ç–æ
    const protein = nutrients.protein || 0;
    plateauPct += Math.floor(protein / 20) * WAVE_PHASES.plateau.proteinBonus;
    
    // –ñ–∏—Ä—ã —É–¥–ª–∏–Ω—è—é—Ç –ø–ª–∞—Ç–æ
    const fat = nutrients.fat || 0;
    plateauPct += Math.floor(fat / 15) * WAVE_PHASES.plateau.fatBonus;
    
    plateauPct = Math.min(0.55, plateauPct); // –ú–∞–∫—Å–∏–º—É–º 55%
    
    const plateauMinutes = Math.round(remainingAfterRise * plateauPct);
    
    // Decline (—Å–ø–∞–¥)
    let declineMinutes = remainingAfterRise - plateauMinutes;
    
    // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Å–∫–æ—Ä—è–µ—Ç —Å–ø–∞–¥
    if (hasActivity) {
      declineMinutes = Math.round(declineMinutes * (1 + WAVE_PHASES.decline.activityBonus));
    }
    
    declineMinutes = Math.max(20, declineMinutes);
    
    // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ª–∏–ø–æ–ª–∏–∑–∞
    const lipolysisStart = riseMinutes + plateauMinutes + declineMinutes;
    
    return {
      rise: { duration: riseMinutes, label: '–ü–æ–¥—ä—ë–º', color: WAVE_PHASES.colors.rise },
      plateau: { duration: plateauMinutes, label: '–ü–ª–∞—Ç–æ', color: WAVE_PHASES.colors.plateau },
      decline: { duration: declineMinutes, label: '–°–ø–∞–¥', color: WAVE_PHASES.colors.decline },
      lipolysisStart,
      totalCalculated: riseMinutes + plateauMinutes + declineMinutes,
      phases: [
        { name: 'rise', label: '–ü–æ–¥—ä—ë–º', minutes: riseMinutes, color: WAVE_PHASES.colors.rise },
        { name: 'plateau', label: '–ü–ª–∞—Ç–æ', minutes: plateauMinutes, color: WAVE_PHASES.colors.plateau },
        { name: 'decline', label: '–°–ø–∞–¥', minutes: declineMinutes, color: WAVE_PHASES.colors.decline }
      ]
    };
  };

  /**
   * ü•õ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–∞
   * –î–ª—è –º–æ–ª–æ—á–Ω—ã—Ö –∏ –±–µ–ª–∫–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ II –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–µ GI
   * 
   * @param {Object} product - –ø—Ä–æ–¥—É–∫—Ç
   * @param {string} insulinogenicType - —Ç–∏–ø –∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç–∏ –∏–∑ getInsulinogenicBonus
   * @param {number} baseGL - –±–∞–∑–æ–≤–∞—è –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
   * @returns {Object} { effectiveGL, iiFactor, desc }
   */
  const calculateInsulinIndex = (insulinogenicType, baseGL) => {
    if (!insulinogenicType || !baseGL) {
      return { effectiveGL: baseGL || 0, iiFactor: 1.0, desc: null };
    }
    
    let iiFactor = 1.0;
    let desc = null;
    
    switch (insulinogenicType) {
      case 'liquidDairy':
        iiFactor = INSULIN_INDEX_FACTORS.liquidDairy;
        desc = 'ü•õ –ú–æ–ª–æ—á–Ω—ã–µ: II √ó 3';
        break;
      case 'softDairy':
        iiFactor = INSULIN_INDEX_FACTORS.softDairy;
        desc = 'ü•õ –ô–æ–≥—É—Ä—Ç/—Ç–≤–æ—Ä–æ–≥: II √ó 2.5';
        break;
      case 'hardDairy':
        iiFactor = INSULIN_INDEX_FACTORS.hardDairy;
        desc = 'üßÄ –°—ã—Ä: II √ó 1.5';
        break;
      case 'protein':
        iiFactor = INSULIN_INDEX_FACTORS.pureProtein;
        desc = 'ü•© –ë–µ–ª–æ–∫: II √ó 1.8';
        break;
      default:
        iiFactor = 1.0;
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
    const maxIncrease = baseGL * INSULIN_INDEX_FACTORS.maxBoost;
    const boostedGL = Math.min(baseGL * iiFactor, baseGL + maxIncrease);
    
    // –î–ª—è –æ—á–µ–Ω—å –Ω–∏–∑–∫–æ–π GL –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞ —Å–∏–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å
    // –ü—Ä–∏ GL=2 –¥–∞–∂–µ √ó3 –¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ GL=6 ‚Äî –≤–æ–ª–Ω–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –∫–æ—Ä–æ—Ç–∫–∞—è
    const effectiveGL = baseGL < 3 ? baseGL * Math.min(iiFactor, 1.5) : boostedGL;
    
    return {
      effectiveGL: Math.round(effectiveGL * 10) / 10,
      iiFactor,
      desc: iiFactor > 1 ? desc : null
    };
  };

  /**
   * üî¨ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   * @param {Object} params - –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞
   * @returns {Object} –¥–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
   */
  const getWaveCalculationDebug = (params) => {
    const { 
      gl, profile, prevMealEnd, mealTime, nutrients, 
      insulinogenicType, hasActivity 
    } = params;
    
    // 1. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥
    const personalBase = calculatePersonalBaselineWave(profile);
    
    // 2. GL –º–Ω–æ–∂–∏—Ç–µ–ª—å (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π)
    const glMult = calculateContinuousGLMultiplier(gl);
    
    // 3. –ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
    const iiResult = calculateInsulinIndex(insulinogenicType, gl);
    
    // 4. Meal stacking
    const stacking = prevMealEnd && mealTime 
      ? calculateMealStackingBonus(prevMealEnd, mealTime, gl)
      : { stackBonus: 0 };
    
    // 5. –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤–æ–ª–Ω–∞ –¥–æ —Ñ–∞–∑
    const approxWaveMinutes = personalBase.baseHours * 60 * glMult * (1 + stacking.stackBonus);
    
    // 6. –§–∞–∑—ã
    const phases = calculateWavePhases(approxWaveMinutes, nutrients, hasActivity);
    
    return {
      personalBase,
      glMultiplier: glMult,
      effectiveGL: iiResult.effectiveGL,
      insulinIndex: iiResult,
      mealStacking: stacking,
      approxWaveMinutes,
      phases,
      formula: `${personalBase.baseHours}—á √ó ${glMult.toFixed(2)} √ó (1 + ${stacking.stackBonus}) = ${utils.formatDuration(approxWaveMinutes)}`
    };
  };
  
  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.V30 = {
    calculateContinuousGLMultiplier,
    calculatePersonalBaselineWave,
    calculateMealStackingBonus,
    calculateWavePhases,
    calculateInsulinIndex,
    getWaveCalculationDebug
  };
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_v41.js ===== */
// heys_iw_v41.js ‚Äî InsulinWave v4.1 Features Module
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Ñ–∏—á–µ–π v4.1: –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å, –º–æ–¥–µ–ª—å —Å—ã—Ç–æ—Å—Ç–∏, 
// –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç.
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.
//
// –§–ò–ß–ò v4.1:
// 1. Metabolic Flexibility Index ‚Äî —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –∂–∏—Ä–∞–º–∏ –∏ —É–≥–ª–µ–≤–æ–¥–∞–º–∏
// 2. Satiety Model ‚Äî —Ä–∞—Å—á—ë—Ç –Ω–∞—Å—ã—â–µ–Ω–∏—è –æ—Ç –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (Holt Index)
// 3. Adaptive Deficit Optimizer ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Å —É—á—ë—Ç–æ–º –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
//
// –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞: Kelley & Mandarino 2000, Holt 1995, Trexler 2014

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // ========================================================================
  // üß¨ METABOLIC FLEXIBILITY INDEX ‚Äî v4.1.0
  // ========================================================================
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Kelley & Mandarino 2000 (PMID: 10783862)
  // –ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å ‚Äî —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –æ–∫–∏—Å–ª–µ–Ω–∏–µ–º
  // –∂–∏—Ä–æ–≤ –∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—É–±—Å—Ç—Ä–∞—Ç–æ–≤
  // ========================================================================

  const METABOLIC_FLEXIBILITY_CONFIG = {
    // –§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å
    factors: {
      // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É–ª—É—á—à–∞—é—Ç –≥–∏–±–∫–æ—Å—Ç—å (Goodpaster 2003)
      trainingFrequency: {
        weight: 0.25,
        tiers: [
          { min: 5, value: 1.0, label: '–û—Ç–ª–∏—á–Ω–∞—è –±–∞–∑–∞' },     // 5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫/–Ω–µ–¥–µ–ª—é
          { min: 3, value: 0.75, label: '–•–æ—Ä–æ—à–∞—è –±–∞–∑–∞' },     // 3-4/–Ω–µ–¥–µ–ª—é
          { min: 1, value: 0.5, label: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–∞–∑–∞' },  // 1-2/–Ω–µ–¥–µ–ª—é
          { min: 0, value: 0.25, label: '–ù–∏–∑–∫–∞—è –±–∞–∑–∞' }       // –ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        ]
      },
      // –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º (Spiegel 2005)
      sleepQuality: {
        weight: 0.20,
        tiers: [
          { min: 4, value: 1.0 },    // –û—Ç–ª–∏—á–Ω—ã–π —Å–æ–Ω (4-5)
          { min: 3, value: 0.7 },    // –•–æ—Ä–æ—à–∏–π (3)
          { min: 2, value: 0.4 },    // –ü–ª–æ—Ö–æ–π (2)
          { min: 0, value: 0.2 }     // –û—á–µ–Ω—å –ø–ª–æ—Ö–æ–π (1)
        ]
      },
      // –°—Ç—Ä–µ—Å—Å —Å–Ω–∏–∂–∞–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å (Kuo 2015)
      stressLevel: {
        weight: 0.15,
        inverted: true, // –ú–µ–Ω—å—à–µ —Å—Ç—Ä–µ—Å—Å = –ª—É—á—à–µ
        tiers: [
          { max: 3, value: 1.0 },    // –ù–∏–∑–∫–∏–π —Å—Ç—Ä–µ—Å—Å
          { max: 5, value: 0.7 },    // –£–º–µ—Ä–µ–Ω–Ω—ã–π
          { max: 7, value: 0.4 },    // –í—ã—Å–æ–∫–∏–π
          { max: 10, value: 0.2 }    // –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π
        ]
      },
      // BMI –≤–ª–∏—è–µ—Ç –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      bmiScore: {
        weight: 0.20,
        tiers: [
          { range: [18.5, 24.9], value: 1.0 },   // –ù–æ—Ä–º–∞
          { range: [25, 29.9], value: 0.65 },    // –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å
          { range: [30, 34.9], value: 0.4 },     // –û–∂–∏—Ä–µ–Ω–∏–µ I
          { range: [0, 18.5], value: 0.7 },      // –ù–µ–¥–æ–≤–µ—Å
          { range: [35, 100], value: 0.25 }      // –û–∂–∏—Ä–µ–Ω–∏–µ II+
        ]
      },
      // –í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∏—Ç–∞–Ω–∏—è
      dietVariety: {
        weight: 0.20,
        description: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –º–∞–∫—Ä–æ—Å–æ–≤ –∑–∞ 7 –¥–Ω–µ–π'
      }
    },
    // –†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–µ —É—Ä–æ–≤–Ω–∏
    levels: [
      { min: 0.8, id: 'excellent', name: '–û—Ç–ª–∏—á–Ω–∞—è', icon: 'üåü', color: '#10b981' },
      { min: 0.6, id: 'good', name: '–•–æ—Ä–æ—à–∞—è', icon: '‚úÖ', color: '#22c55e' },
      { min: 0.4, id: 'moderate', name: '–£–º–µ—Ä–µ–Ω–Ω–∞—è', icon: '‚ûñ', color: '#eab308' },
      { min: 0.2, id: 'low', name: '–ù–∏–∑–∫–∞—è', icon: '‚ö†Ô∏è', color: '#f97316' },
      { min: 0, id: 'poor', name: '–ü–ª–æ—Ö–∞—è', icon: '‚ùå', color: '#ef4444' }
    ]
  };

  /**
   * –†–∞—Å—á—ë—Ç –∏–Ω–¥–µ–∫—Å–∞ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–π –≥–∏–±–∫–æ—Å—Ç–∏
   * @param {Object} options - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @returns {Object} { score, level, factors, recommendations }
   */
  const calculateMetabolicFlexibility = ({
    recentDays = [],
    profile = {},
    trainings7d = []
  }) => {
    const factorScores = {};
    const cfg = METABOLIC_FLEXIBILITY_CONFIG.factors;

    // 1. Training frequency (–∑–∞ 7 –¥–Ω–µ–π)
    const trainingCount = trainings7d.length || recentDays.filter(d => d.trainings?.length > 0).length;
    const trainingTier = cfg.trainingFrequency.tiers.find(t => trainingCount >= t.min)
      || cfg.trainingFrequency.tiers[cfg.trainingFrequency.tiers.length - 1];
    factorScores.training = {
      value: trainingTier.value,
      weight: cfg.trainingFrequency.weight,
      count: trainingCount,
      label: trainingTier.label
    };

    // 2. Sleep quality (—Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –ø–µ—Ä–∏–æ–¥)
    const sleepScores = recentDays.filter(d => d.sleepQuality > 0).map(d => d.sleepQuality);
    const avgSleep = sleepScores.length > 0
      ? sleepScores.reduce((a, b) => a + b, 0) / sleepScores.length
      : 3;
    const sleepTier = cfg.sleepQuality.tiers.find(t => avgSleep >= t.min);
    factorScores.sleep = {
      value: sleepTier?.value || 0.5,
      weight: cfg.sleepQuality.weight,
      avg: avgSleep
    };

    // 3. Stress level (—Å—Ä–µ–¥–Ω–µ–µ)
    const stressScores = recentDays.filter(d => d.stressAvg > 0).map(d => d.stressAvg);
    const avgStress = stressScores.length > 0
      ? stressScores.reduce((a, b) => a + b, 0) / stressScores.length
      : 5;
    const stressTier = cfg.stressLevel.tiers.find(t => avgStress <= t.max);
    factorScores.stress = {
      value: stressTier?.value || 0.5,
      weight: cfg.stressLevel.weight,
      avg: avgStress
    };

    // 4. BMI score
    const bmi = profile.weight && profile.height
      ? profile.weight / Math.pow(profile.height / 100, 2)
      : 22;
    const bmiTier = cfg.bmiScore.tiers.find(t => bmi >= t.range[0] && bmi < t.range[1]);
    factorScores.bmi = {
      value: bmiTier?.value || 0.5,
      weight: cfg.bmiScore.weight,
      bmi: Math.round(bmi * 10) / 10
    };

    // 5. Diet variety (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –º–∞–∫—Ä–æ—Å–æ–≤)
    // –í—ã—Å–æ–∫–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å = –ª—É—á—à–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
    let varietyScore = 0.5;
    if (recentDays.length >= 3) {
      const carbPcts = recentDays.map(d => {
        const tot = (d.dayTot?.carbs || 0) + (d.dayTot?.prot || 0) + (d.dayTot?.fat || 0);
        return tot > 0 ? (d.dayTot?.carbs || 0) / tot : 0.5;
      });
      const mean = carbPcts.reduce((a, b) => a + b, 0) / carbPcts.length;
      const variance = carbPcts.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / carbPcts.length;
      const std = Math.sqrt(variance);
      // –£–º–µ—Ä–µ–Ω–Ω–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (std 0.05-0.15) = —Ö–æ—Ä–æ—à–æ
      varietyScore = std < 0.05 ? 0.4 : std < 0.1 ? 0.8 : std < 0.15 ? 1.0 : 0.6;
    }
    factorScores.variety = {
      value: varietyScore,
      weight: cfg.dietVariety.weight
    };

    // –ò—Ç–æ–≥–æ–≤—ã–π score (–≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ)
    const totalWeight = Object.values(factorScores).reduce((sum, f) => sum + f.weight, 0);
    const score = Object.values(factorScores).reduce((sum, f) => sum + f.value * f.weight, 0) / totalWeight;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    const level = METABOLIC_FLEXIBILITY_CONFIG.levels.find(l => score >= l.min)
      || METABOLIC_FLEXIBILITY_CONFIG.levels[METABOLIC_FLEXIBILITY_CONFIG.levels.length - 1];

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const recommendations = [];
    if (factorScores.training.value < 0.6) {
      recommendations.push({ icon: 'üèÉ', text: '–î–æ–±–∞–≤—å 1-2 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≥–∏–±–∫–æ—Å—Ç–∏' });
    }
    if (factorScores.sleep.value < 0.6) {
      recommendations.push({ icon: 'üò¥', text: '–£–ª—É—á—à–∏ –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞' });
    }
    if (factorScores.stress.value < 0.6) {
      recommendations.push({ icon: 'üßò', text: '–°–Ω–∏–∑—å —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞ ‚Äî –∫–æ—Ä—Ç–∏–∑–æ–ª –±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å' });
    }
    if (factorScores.variety.value < 0.6) {
      recommendations.push({ icon: 'ü•ó', text: '–î–æ–±–∞–≤—å –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –ø–∏—Ç–∞–Ω–∏–µ (—Ä–∞–∑–Ω—ã–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –ë–ñ–£)' });
    }

    return {
      score: Math.round(score * 100) / 100,
      level,
      factors: factorScores,
      recommendations,
      // –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é –≤–æ–ª–Ω—É
      waveMultiplier: 0.85 + (1 - score) * 0.3, // 0.85-1.15
      description: `–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å: ${level.name}`
    };
  };

  // ========================================================================
  // üçΩÔ∏è SATIETY MODEL ‚Äî v4.1.0  
  // ========================================================================
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: 
  // - Holt Satiety Index 1995 (PMID: 7498104)
  // - Rolls Volumetrics 2000
  // - Blundell appetite cascade 1987
  // ========================================================================

  const SATIETY_MODEL_CONFIG = {
    // –ë–∞–∑–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–∞—Å—ã—â–µ–Ω–∏—è (–Ω–∞ 100 –∫–∫–∞–ª)
    macroFactors: {
      protein: 1.5,    // –ë–µ–ª–æ–∫ —Å–∞–º—ã–π —Å—ã—Ç–Ω—ã–π (—Ç–µ—Ä–º–æ–≥–µ–Ω–µ–∑ + –≥–ª—é–∫–∞–≥–æ–Ω)
      fiber: 1.4,      // –ö–ª–µ—Ç—á–∞—Ç–∫–∞ (–æ–±—ä—ë–º + –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ)
      complexCarbs: 0.8, // –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã
      simpleCarbs: 0.3,  // –ü—Ä–æ—Å—Ç—ã–µ ‚Äî –±—ã—Å—Ç—Ä—ã–π –≥–æ–ª–æ–¥
      fat: 0.7,        // –ñ–∏—Ä—ã ‚Äî –º–µ–¥–ª–µ–Ω–Ω–æ–µ –Ω–∞—Å—ã—â–µ–Ω–∏–µ
      water: 0.2       // –í–æ–¥–∞ –≤ –µ–¥–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—ä—ë–º
    },
    // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ñ–æ—Ä–º—ã –ø–∏—â–∏
    foodFormFactors: {
      liquid: 0.5,     // –ñ–∏–¥–∫–æ–µ –Ω–∞—Å—ã—â–∞–µ—Ç –º–µ–Ω—å—à–µ
      soft: 0.8,       // –ú—è–≥–∫–æ–µ
      solid: 1.0,      // –¢–≤—ë—Ä–¥–æ–µ ‚Äî –º–∞–∫—Å–∏–º—É–º
      fibrous: 1.2     // –í–æ–ª–æ–∫–Ω–∏—Å—Ç–æ–µ ‚Äî —Ç—Ä–µ–±—É–µ—Ç –∂–µ–≤–∞–Ω–∏—è
    },
    // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–∏—è (—á–∞—Å—ã ‚Üí –º–Ω–æ–∂–∏—Ç–µ–ª—å)
    decayCurve: {
      baseHours: 4,    // –ë–∞–∑–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å—ã—â–µ–Ω–∏—è
      halfLife: 2      // –ü–µ—Ä–∏–æ–¥ –ø–æ–ª—É—Ä–∞—Å–ø–∞–¥–∞
    },
    // –£—Ä–æ–≤–Ω–∏ –Ω–∞—Å—ã—â–µ–Ω–∏—è
    levels: [
      { min: 0.8, id: 'full', name: '–°—ã—Ç–æ—Å—Ç—å', icon: 'üòä', color: '#22c55e' },
      { min: 0.5, id: 'satisfied', name: '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω', icon: 'üôÇ', color: '#84cc16' },
      { min: 0.3, id: 'neutral', name: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ', icon: 'üòê', color: '#eab308' },
      { min: 0.1, id: 'hungry', name: '–ì–æ–ª–æ–¥–µ–Ω', icon: 'üòï', color: '#f97316' },
      { min: 0, id: 'starving', name: '–û—á–µ–Ω—å –≥–æ–ª–æ–¥–µ–Ω', icon: 'üò´', color: '#ef4444' }
    ]
  };

  /**
   * –†–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω—è –Ω–∞—Å—ã—â–µ–Ω–∏—è
   * @param {Object} mealData - –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—ë–º–∞ { kcal, prot, carbs, simple, fat, fiber }
   * @param {number} hoursSinceMeal - —á–∞—Å–æ–≤ —Å –ø—Ä–∏—ë–º–∞
   * @param {Object} options - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @returns {Object} { score, level, duration, nextHungerTime }
   */
  const calculateSatietyScore = (mealData, hoursSinceMeal = 0, options = {}) => {
    const cfg = SATIETY_MODEL_CONFIG;
    const { kcal = 0, prot = 0, carbs = 0, simple = 0, fat = 0, fiber = 0 } = mealData;

    if (kcal <= 0) {
      return {
        score: 0,
        level: cfg.levels[cfg.levels.length - 1],
        duration: 0,
        nextHungerTime: '—Å–µ–π—á–∞—Å'
      };
    }

    // 1. –ë–∞–∑–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞—Å—ã—â–µ–Ω–∏—è (–Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞–∫—Ä–æ—Å–æ–≤)
    const complexCarbs = Math.max(0, carbs - simple);
    const proteinContribution = (prot * 3 / kcal) * cfg.macroFactors.protein;
    const fiberContribution = (fiber * 2 / kcal) * cfg.macroFactors.fiber;
    const complexCarbsContribution = (complexCarbs * 4 / kcal) * cfg.macroFactors.complexCarbs;
    const simpleCarbsContribution = (simple * 4 / kcal) * cfg.macroFactors.simpleCarbs;
    const fatContribution = (fat * 9 / kcal) * cfg.macroFactors.fat;

    // –°—ã—Ä–æ–π –∏–Ω–¥–µ–∫—Å (0-2+)
    const rawSatietyIndex = proteinContribution + fiberContribution +
      complexCarbsContribution + simpleCarbsContribution + fatContribution;

    // 2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä—ë–º–∞ (–±–æ–ª—å—à–µ –∫–∫–∞–ª = –¥–æ–ª—å—à–µ —Å—ã—Ç–æ—Å—Ç—å, –Ω–æ —Å diminishing returns)
    const volumeMultiplier = Math.min(1.5, 0.5 + Math.log10(kcal / 100 + 1) * 0.5);

    // 3. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–æ—Ä–º—ã –ø–∏—â–∏
    const formMultiplier = options.foodForm
      ? (cfg.foodFormFactors[options.foodForm] || 1.0)
      : 1.0;

    // 4. –†–∞—Å—á—ë—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—ã—â–µ–Ω–∏—è (—á–∞—Å—ã)
    const baseDuration = cfg.decayCurve.baseHours * rawSatietyIndex * volumeMultiplier * formMultiplier;
    const durationHours = Math.min(8, Math.max(1, baseDuration));

    // 5. –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏
    const decayFactor = Math.exp(-hoursSinceMeal / cfg.decayCurve.halfLife);
    const currentScore = Math.min(1, rawSatietyIndex * volumeMultiplier * formMultiplier * decayFactor);

    // 6. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    const level = cfg.levels.find(l => currentScore >= l.min) || cfg.levels[cfg.levels.length - 1];

    // 7. –í—Ä–µ–º—è –¥–æ –≥–æ–ª–æ–¥–∞
    const hoursUntilHungry = Math.max(0, durationHours - hoursSinceMeal);
    const nextHungerTime = hoursUntilHungry > 0
      ? `—á–µ—Ä–µ–∑ ${Math.round(hoursUntilHungry * 60)} –º–∏–Ω`
      : '—Å–∫–æ—Ä–æ';

    return {
      score: Math.round(currentScore * 100) / 100,
      rawIndex: Math.round(rawSatietyIndex * 100) / 100,
      level,
      duration: Math.round(durationHours * 10) / 10,
      hoursRemaining: Math.round(hoursUntilHungry * 10) / 10,
      nextHungerTime,
      breakdown: {
        protein: Math.round(proteinContribution * 100),
        fiber: Math.round(fiberContribution * 100),
        complexCarbs: Math.round(complexCarbsContribution * 100),
        simpleCarbs: Math.round(simpleCarbsContribution * 100),
        fat: Math.round(fatContribution * 100)
      }
    };
  };

  // ========================================================================
  // üìâ ADAPTIVE DEFICIT OPTIMIZER ‚Äî v4.1.0
  // ========================================================================
  // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
  // - Trexler 2014: Diet breaks improve adherence (PMID: 24864135)
  // - Byrne 2018: Intermittent energy restriction (PMID: 28925405)
  // - Dulloo 2015: Adaptive thermogenesis (PMID: 22535969)
  // ========================================================================

  const ADAPTIVE_DEFICIT_CONFIG = {
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–∞–ª–æ—Ä–∞–∂ (–∑–∞—â–∏—Ç–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞)
    minimumKcal: {
      female: 1200,
      male: 1500
    },
    // –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–µ—Ñ–∏—Ü–∏—Ç–∞
    deficitTiers: [
      { pct: 10, label: '–õ—ë–≥–∫–∏–π', sustainable: true, weeklyLoss: '0.25-0.5 –∫–≥' },
      { pct: 20, label: '–£–º–µ—Ä–µ–Ω–Ω—ã–π', sustainable: true, weeklyLoss: '0.5-0.75 –∫–≥' },
      { pct: 25, label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π', sustainable: false, weeklyLoss: '0.75-1 –∫–≥', maxWeeks: 4 },
      { pct: 30, label: '–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π', sustainable: false, weeklyLoss: '1+ –∫–≥', maxWeeks: 2 }
    ],
    // Diet break (–ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ)
    dietBreak: {
      afterWeeks: 4,        // –ü–æ—Å–ª–µ —Å–∫–æ–ª—å–∫–∏—Ö –Ω–µ–¥–µ–ª—å –¥–µ—Ñ–∏—Ü–∏—Ç–∞
      durationDays: 7,      // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ä—ã–≤–∞
      kcalBoost: 0.15       // +15% –∫ –Ω–æ—Ä–º–µ
    },
    // Refeed day (—É–≥–ª–µ–≤–æ–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
    refeedDay: {
      frequency: 7,         // –ö–∞–∂–¥—ã–µ N –¥–Ω–µ–π –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ
      carbBoost: 0.5,       // +50% —É–≥–ª–µ–≤–æ–¥–æ–≤
      kcalBoost: 0.2        // +20% –∫–∞–ª–æ—Ä–∏–π
    },
    // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞)
    adaptiveMultiplier: {
      perWeekInDeficit: 0.02,  // -2% –≤ –Ω–µ–¥–µ–ª—é
      maxReduction: 0.15       // –ú–∞–∫—Å–∏–º—É–º -15%
    }
  };

  /**
   * –†–∞—Å—á—ë—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞
   * @param {Object} options - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @returns {Object} { recommendedDeficit, adaptiveKcal, needsDietBreak, recommendations }
   */
  const calculateAdaptiveDeficit = ({
    tdee,
    targetDeficitPct = 15,
    weeksInDeficit = 0,
    gender = 'male',
    recentRatios = [],   // ratio –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
    hasRefeedThisWeek = false
  }) => {
    const cfg = ADAPTIVE_DEFICIT_CONFIG;

    // 1. –ë–∞–∑–æ–≤—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç
    const targetKcal = tdee * (1 - targetDeficitPct / 100);

    // 2. –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
    const adaptiveReduction = Math.min(
      cfg.adaptiveMultiplier.maxReduction,
      weeksInDeficit * cfg.adaptiveMultiplier.perWeekInDeficit
    );
    const adaptedTdee = tdee * (1 - adaptiveReduction);

    // 3. –ü–µ—Ä–µ—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Å —É—á—ë—Ç–æ–º –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
    const effectiveDeficitPct = targetDeficitPct * (1 - adaptiveReduction);
    const adaptiveKcal = adaptedTdee * (1 - effectiveDeficitPct / 100);

    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞
    const minKcal = cfg.minimumKcal[gender] || cfg.minimumKcal.male;
    const safeKcal = Math.max(minKcal, adaptiveKcal);

    // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ diet break
    const needsDietBreak = weeksInDeficit >= cfg.dietBreak.afterWeeks;
    const dietBreakKcal = needsDietBreak ? tdee * (1 + cfg.dietBreak.kcalBoost) : null;

    // 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ refeed
    const avgRatio = recentRatios.length > 0
      ? recentRatios.reduce((a, b) => a + b, 0) / recentRatios.length
      : 1;
    const needsRefeed = !hasRefeedThisWeek &&
      recentRatios.length >= 5 &&
      avgRatio < 0.9 &&
      weeksInDeficit >= 1;

    // 7. Tier —Ç–µ–∫—É—â–µ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞
    const actualDeficitPct = Math.round((1 - safeKcal / tdee) * 100);
    const tier = cfg.deficitTiers.find(t => actualDeficitPct <= t.pct) || cfg.deficitTiers[cfg.deficitTiers.length - 1];

    // 8. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const recommendations = [];

    if (needsDietBreak) {
      recommendations.push({
        priority: 'high',
        icon: 'üõë',
        text: `Diet break —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω! ${cfg.dietBreak.durationDays} –¥–Ω–µ–π –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏ (${Math.round(dietBreakKcal)} –∫–∫–∞–ª)`
      });
    }

    if (needsRefeed) {
      recommendations.push({
        priority: 'medium',
        icon: 'üçù',
        text: 'Refeed day –ø–æ–º–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–µ–ø—Ç–∏–Ω –∏ –≥–ª–∏–∫–æ–≥–µ–Ω'
      });
    }

    if (adaptiveReduction > 0.05) {
      recommendations.push({
        priority: 'info',
        icon: 'üìâ',
        text: `–ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ ${Math.round(adaptiveReduction * 100)}%`
      });
    }

    if (!tier.sustainable) {
      recommendations.push({
        priority: 'warning',
        icon: '‚ö†Ô∏è',
        text: `${tier.label} –¥–µ—Ñ–∏—Ü–∏—Ç ‚Äî –Ω–µ –±–æ–ª–µ–µ ${tier.maxWeeks} –Ω–µ–¥–µ–ª—å!`
      });
    }

    return {
      originalTdee: tdee,
      adaptedTdee: Math.round(adaptedTdee),
      recommendedKcal: Math.round(safeKcal),
      originalDeficitPct: targetDeficitPct,
      effectiveDeficitPct: Math.round(effectiveDeficitPct),
      actualDeficitPct,
      tier,
      adaptiveReduction: Math.round(adaptiveReduction * 100),
      weeksInDeficit,
      needsDietBreak,
      dietBreakKcal: dietBreakKcal ? Math.round(dietBreakKcal) : null,
      needsRefeed,
      minKcal,
      recommendations
    };
  };

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.V41 = {
    // Config
    METABOLIC_FLEXIBILITY_CONFIG,
    SATIETY_MODEL_CONFIG,
    ADAPTIVE_DEFICIT_CONFIG,
    // Functions
    calculateMetabolicFlexibility,
    calculateSatietyScore,
    calculateAdaptiveDeficit
  };

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_calc.js ===== */
// heys_iw_calc.js ‚Äî InsulinWave Calculations Module
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã: –Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã, –º–Ω–æ–∂–∏—Ç–µ–ª–∏, workout –±–æ–Ω—É—Å—ã.
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // === MODULE VERSION ===
  const MODULE_VERSION = '1.0.0';
  const MODULE_NAME = 'InsulinWave.Calc';

  // === –ò–ú–ü–û–†–¢ –ö–û–ù–°–¢–ê–ù–¢ ===
  const I = HEYS.InsulinWave?.__internals;
  const utils = HEYS.InsulinWave?.utils;
  const V30 = HEYS.InsulinWave?.V30;
  const calculateContinuousGLMultiplier = V30?.calculateContinuousGLMultiplier;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ __internals
  const GL_CATEGORIES = I?.GL_CATEGORIES;
  const FAT_BONUS = I?.FAT_BONUS;
  const PROTEIN_BONUS = I?.PROTEIN_BONUS;
  const FIBER_BONUS = I?.FIBER_BONUS;
  const WORKOUT_BONUS = I?.WORKOUT_BONUS;
  const POSTPRANDIAL_EXERCISE = I?.POSTPRANDIAL_EXERCISE;
  const NEAT_BONUS = I?.NEAT_BONUS;
  const STEPS_BONUS = I?.STEPS_BONUS;
  const CIRCADIAN_CONFIG = I?.CIRCADIAN_CONFIG;

  // –§—É–Ω–∫—Ü–∏–∏ –∏–∑ __internals
  const isSpicyFood = I?.isSpicyFood;
  const detectProteinType = I?.detectProteinType;
  const calculateProteinBonusV2 = I?.calculateProteinBonusV2;
  const isValidTraining = I?.isValidTraining;
  const isLiquidFood = I?.isLiquidFood;
  const getInsulinogenicBonus = I?.getInsulinogenicBonus;
  const getAlcoholBonus = I?.getAlcoholBonus;
  const getGenderBonus = I?.getGenderBonus;
  const calculateStressBonus = I?.calculateStressBonus;
  const calculateSleepBonus = I?.calculateSleepBonus;
  const calculateSleepQualityBonus = I?.calculateSleepQualityBonus;
  const calculateHydrationBonus = I?.calculateHydrationBonus;
  const calculateAgeBonus = I?.calculateAgeBonus;
  const calculateBMIBonus = I?.calculateBMIBonus;
  const hasCaffeine = I?.hasCaffeine;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è Insulin Index
  const INSULIN_INDEX_FACTORS = I?.INSULIN_INDEX_FACTORS;

  const calculateMealNutrients = (meal, pIndex, getProductFromItem) => {
    let totalGrams = 0;
    let weightedGI = 0;  // üî¨ v3.0.1: –¢–µ–ø–µ—Ä—å –≤–∑–≤–µ—à–∏–≤–∞–µ–º –ø–æ —É–≥–ª–µ–≤–æ–¥–∞–º, –Ω–µ –ø–æ –≥—Ä–∞–º–º–∞–º!
    let totalCarbsForGI = 0;  // üÜï –°—É–º–º–∞ —É–≥–ª–µ–≤–æ–¥–æ–≤ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–≥–æ –ì–ò
    let totalProtein = 0;
    let totalFiber = 0;
    let totalCarbs = 0;
    let totalSimple = 0;
    let totalFat = 0;
    let totalTrans = 0;  // üÜï v2.0: –û—Ç–¥–µ–ª—å–Ω—ã–π —É—á—ë—Ç —Ç—Ä–∞–Ω—Å-–∂–∏—Ä–æ–≤
    const proteinTypeTotals = { animal: 0, plant: 0, whey: 0, mixed: 0 };

    // –ù–æ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
    let liquidGrams = 0;  // –°–∫–æ–ª—å–∫–æ –≥—Ä–∞–º–º –∂–∏–¥–∫–æ–π –ø–∏—â–∏
    let maxInsulinogenicBonus = 0;
    let insulinogenicType = null;

    // üÜï v3.2.2: –°—É–º–º–∞—Ä–Ω—ã–π –≤–∫–ª–∞–¥ –æ—Ç Insulin Index
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Holt 1997 ‚Äî –º–æ–ª–æ—á–∫–∞ –∏–º–µ–µ—Ç II >> GI
    // –í–º–µ—Å—Ç–æ –±–æ–Ω—É—Å–∞ +15% ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é GL
    let insulinIndexAdjustedGL = 0;  // –°—É–º–º–∞ GL —Å —É—á—ë—Ç–æ–º II

    // üÜï v1.4: –û—Å—Ç—Ä–∞—è –ø–∏—â–∞, –∞–ª–∫–æ–≥–æ–ª—å, –∫–æ—Ñ–µ–∏–Ω
    let hasSpicy = false;
    let maxAlcoholBonus = 0;
    let alcoholType = null;
    let caffeineDetected = false;

    const items = meal?.items || [];

    for (const item of items) {
      const grams = item.grams || 100;
      const prod = getProductFromItem(item, pIndex);

      // üîß FIX v3.8.2: –¢—Ä–æ–π–Ω–æ–π fallback –¥–ª—è –í–°–ï–• –ø–æ–ª–µ–π ‚Äî prod ‚Üí item snapshot ‚Üí default
      const gi = prod?.gi ?? prod?.gi100 ?? prod?.GI ?? item.gi ?? 50;
      totalGrams += grams;

      const protein100 = prod?.protein100 ?? item.protein100 ?? 0;
      const fiber100 = prod?.fiber100 ?? item.fiber100 ?? 0;
      const proteinFromItem = protein100 * grams / 100;
      totalProtein += proteinFromItem;
      if (proteinFromItem > 0) {
        const detectedProteinType = detectProteinType?.(prod) || 'mixed';
        proteinTypeTotals[detectedProteinType] = (proteinTypeTotals[detectedProteinType] || 0) + proteinFromItem;
      }
      totalFiber += fiber100 * grams / 100;

      // –£–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–∏–ª—ã –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —Ä–µ–∞–∫—Ü–∏–∏
      // üîß FIX v3.8.2: –¢—Ä–æ–π–Ω–æ–π fallback ‚Äî prod ‚Üí item snapshot ‚Üí 0
      // –ö–æ–≥–¥–∞ pIndex –Ω–µ –≥–æ—Ç–æ–≤, prod=null, –Ω–æ item –º–æ–∂–µ—Ç –∏–º–µ—Ç—å snapshot –¥–∞–Ω–Ω—ã–µ
      const simple = prod?.simple100 ?? item.simple100 ?? 0;
      const complex = prod?.complex100 ?? item.complex100 ?? 0;
      const carbsFromBreakdown = simple + complex;
      // Fallback –Ω–∞ carbs100 –µ—Å–ª–∏ simple/complex –Ω–µ –∑–∞–¥–∞–Ω—ã
      const carbsPer100 = carbsFromBreakdown > 0 ? carbsFromBreakdown : (prod?.carbs100 ?? item.carbs100 ?? 0);
      const itemCarbs = carbsPer100 * grams / 100;
      totalSimple += simple * grams / 100;
      totalCarbs += itemCarbs;

      // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è GL (–æ—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤)
      // const dataSource = prod ? 'pIndex' : (item.simple100 !== undefined ? 'snapshot' : 'default');
      // const debugItemGL = gi * itemCarbs / 100;
      // console.log('[InsulinWave DEBUG] Item:', {
      //   name: item.name, grams, dataSource,
      //   simple100: simple, complex100: complex, carbsPer100, itemCarbs, gi,
      //   calculatedGL: debugItemGL
      // });

      // üî¨ v3.0.1: –í–∑–≤–µ—à–∏–≤–∞–µ–º –ì–ò –ø–æ –£–ì–õ–ï–í–û–î–ê–ú, –Ω–µ –ø–æ –≥—Ä–∞–º–º–∞–º!
      // –°—ã—Ä –±–µ–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–ª–∏—è—Ç—å –Ω–∞ —Å—Ä–µ–¥–Ω–∏–π –ì–ò
      // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –ì–ò –ø—Ä–∏–º–µ–Ω–∏–º —Ç–æ–ª—å–∫–æ –∫ —É–≥–ª–µ–≤–æ–¥–∞–º (Brand-Miller 2003)
      weightedGI += gi * itemCarbs;
      totalCarbsForGI += itemCarbs;

      // üÜï v3.2.2: GL –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ + –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Insulin Index
      // GL –ø—Ä–æ–¥—É–∫—Ç–∞ = GI √ó —É–≥–ª–µ–≤–æ–¥—ã / 100
      const itemGL = gi * itemCarbs / 100;

      // –ñ–∏—Ä—ã ‚Äî –∑–∞–º–µ–¥–ª—è—é—Ç –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ (gastric emptying)
      // üîß FIX v3.8.2: –¢—Ä–æ–π–Ω–æ–π fallback –¥–ª—è –∂–∏—Ä–æ–≤
      const badFat = prod?.badFat100 ?? item.badFat100 ?? 0;
      const goodFat = prod?.goodFat100 ?? item.goodFat100 ?? 0;
      const transFat = prod?.trans100 ?? item.trans100 ?? 0;
      totalFat += (badFat + goodFat + transFat) * grams / 100;
      totalTrans += transFat * grams / 100;  // üÜï v2.0: –û—Ç–¥–µ–ª—å–Ω—ã–π —É—á—ë—Ç —Ç—Ä–∞–Ω—Å-–∂–∏—Ä–æ–≤

      // ü•§ –ñ–∏–¥–∫–∞—è –ø–∏—â–∞ ‚Äî —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ
      if (isLiquidFood(prod)) {
        liquidGrams += grams;
      }

      // ü•õ –ò–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –º–æ–ª–æ—á–∫–∞ –∏ –±–µ–ª–æ–∫ —Å—Ç–∏–º—É–ª–∏—Ä—É—é—Ç –∏–Ω—Å—É–ª–∏–Ω
      const insBonus = getInsulinogenicBonus(prod);
      if (insBonus.bonus > maxInsulinogenicBonus) {
        maxInsulinogenicBonus = insBonus.bonus;
        insulinogenicType = insBonus.type;
      }

      // üÜï v3.2.2: –ü—Ä–∏–º–µ–Ω—è–µ–º Insulin Index –∫ GL –ø—Ä–æ–¥—É–∫—Ç–∞
      // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Holt 1997 ‚Äî –º–æ–ª–æ—á–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
      // –≤ 2-3 —Ä–∞–∑–∞ –≤—ã—à–µ —á–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –µ—ë GI
      // üîß FIX v3.8.3: INSULIN_INDEX_FACTORS —Ç–µ–ø–µ—Ä—å –æ–±—ä–µ–∫—Ç—ã —Å .glBoost!
      let iiFactor = 1.0;
      if (insBonus.type === 'liquidDairy') iiFactor = INSULIN_INDEX_FACTORS.liquidDairy?.glBoost || 1.5;
      else if (insBonus.type === 'softDairy') iiFactor = INSULIN_INDEX_FACTORS.softDairy?.glBoost || 1.3;
      else if (insBonus.type === 'hardDairy') iiFactor = INSULIN_INDEX_FACTORS.hardDairy?.glBoost || 1.1;
      else if (insBonus.type === 'protein') iiFactor = INSULIN_INDEX_FACTORS.pureProtein?.glBoost || 1.2;

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (–Ω–µ –±–æ–ª–µ–µ maxGLBoost –æ—Ç –±–∞–∑–æ–≤–æ–π GL)
      // üîß FIX v3.8.3: maxBoost ‚Üí maxGLBoost
      const maxBoost = itemGL * (INSULIN_INDEX_FACTORS.maxGLBoost || 2.0);
      const boostedItemGL = Math.min(itemGL * iiFactor, itemGL + maxBoost);

      insulinIndexAdjustedGL += boostedItemGL;

      // üîç DEBUG v2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è GL (–æ—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–≥–æ–≤)
      // console.log('[InsulinWave DEBUG v2] GL accumulation:', {
      //   name: item.name,
      //   itemGL,
      //   iiFactor,
      //   maxBoost,
      //   boostedItemGL,
      //   insulinIndexAdjustedGL_afterAdd: insulinIndexAdjustedGL
      // });

      // üå∂Ô∏è –û—Å—Ç—Ä–∞—è –ø–∏—â–∞ ‚Äî —É—Å–∫–æ—Ä—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º
      if (isSpicyFood(prod)) {
        hasSpicy = true;
      }

      // üç∑ –ê–ª–∫–æ–≥–æ–ª—å ‚Äî –∑–∞–º–µ–¥–ª—è–µ—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º
      const alcBonus = getAlcoholBonus(prod);
      if (alcBonus.bonus > maxAlcoholBonus) {
        maxAlcoholBonus = alcBonus.bonus;
        alcoholType = alcBonus.type;
      }

      // ‚òï –ö–æ—Ñ–µ–∏–Ω ‚Äî —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –∏–Ω—Å—É–ª–∏–Ω
      if (hasCaffeine(prod)) {
        caffeineDetected = true;
      }
    }

    // üî¨ v3.0.1: –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–π –ì–ò –ø–æ –£–ì–õ–ï–í–û–î–ê–ú (–ø—Ä–∞–≤–∏–ª—å–Ω–æ), –Ω–µ –ø–æ –≥—Ä–∞–º–º–∞–º!
    // –ï—Å–ª–∏ –Ω–µ—Ç —É–≥–ª–µ–≤–æ–¥–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –ì–ò=50
    const avgGI = totalCarbsForGI > 0 ? Math.round(weightedGI / totalCarbsForGI) : 50;

    // üÜï v3.2.2: –ò—Å–ø–æ–ª—å–∑—É–µ–º insulinIndexAdjustedGL –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
    // –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞: GL = GI √ó —É–≥–ª–µ–≤–æ–¥—ã / 100 (–Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç Insulin Index!)
    // –ù–æ–≤–∞—è: —Å—É–º–º–∞ GL –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —Å —É—á—ë—Ç–æ–º II (–º–æ–ª–æ—á–∫–∞ √ó3, –±–µ–ª–æ–∫ √ó1.8, –∏ —Ç.–¥.)
    // –≠—Ç–æ –ë–û–õ–ï–ï –¢–û–ß–ù–û –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç (Holt 1997)
    const baseGlycemicLoad = Math.round(avgGI * totalCarbs / 100 * 10) / 10;
    const glycemicLoad = Math.round(insulinIndexAdjustedGL * 10) / 10;

    // –î–æ–ª—è –∂–∏–¥–∫–æ–π –ø–∏—â–∏ (–µ—Å–ª–∏ >50% ‚Äî –ø—Ä–∏—ë–º —Å—á–∏—Ç–∞–µ—Ç—Å—è –∂–∏–¥–∫–∏–º)
    const liquidRatio = totalGrams > 0 ? liquidGrams / totalGrams : 0;
    const hasLiquid = liquidRatio > 0.5;

    // üÜï v3.8.5: Simple Ratio ‚Äî –¥–æ–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ (—Å–∞—Ö–∞—Ä–∞)
    // –í–ª–∏—è–µ—Ç –Ω–∞ —Ñ–æ—Ä–º—É –≤–æ–ª–Ω—ã: –±–æ–ª—å—à–µ —Å–∞—Ö–∞—Ä–∞ = –±—ã—Å—Ç—Ä–µ–µ –ø–∏–∫, –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞
    const simpleRatio = totalCarbs > 0 ? totalSimple / totalCarbs : 0;
    const dominantProteinType = Object.entries(proteinTypeTotals)
      .sort((a, b) => b[1] - a[1])[0]?.[0] || 'mixed';

    return {
      avgGI,
      totalProtein: Math.round(totalProtein),
      totalFiber: Math.round(totalFiber),
      totalGrams,
      totalCarbs: Math.round(totalCarbs * 10) / 10,
      totalSimple: Math.round(totalSimple * 10) / 10,
      totalFat: Math.round(totalFat * 10) / 10,
      totalTrans: Math.round(totalTrans * 10) / 10,  // üÜï v2.0: –¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã
      glycemicLoad,
      baseGlycemicLoad,  // üÜï v3.2.2: –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚Äî GL –±–µ–∑ II
      simpleRatio: Math.round(simpleRatio * 100) / 100,  // üÜï v3.8.5: 0-1 (–¥–æ–ª—è —Å–∞—Ö–∞—Ä–∞)
      // –§–∞–∫—Ç–æ—Ä—ã v1.3
      hasLiquid,
      liquidRatio: Math.round(liquidRatio * 100),
      dominantProteinType,
      insulinogenicType,
      insulinogenicBonus: maxInsulinogenicBonus,
      // üÜï –§–∞–∫—Ç–æ—Ä—ã v1.4
      hasSpicy,
      hasAlcohol: maxAlcoholBonus > 0,
      alcoholBonus: maxAlcoholBonus,
      alcoholType,
      hasCaffeine: caffeineDetected
    };
  };

  // === CARBS SCALING ‚Äî –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–≥–ª–µ–≤–æ–¥–æ–≤ ===
  // –ú–µ–Ω—å—à–µ —É–≥–ª–µ–≤–æ–¥–æ–≤ = –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞ (–∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–∫–ª–∏–∫ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª–µ–Ω —É–≥–ª–µ–≤–æ–¥–∞–º)
  const CARBS_SCALING = {
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ ‚Äî –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —Ä–µ–∞–∫—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞
    minThreshold: 5,     // < 5–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ = –ø–æ—á—Ç–∏ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏
    // –ü–æ—Ä–æ–≥ –¥–ª—è –ø–æ–ª–Ω–æ–π –≤–æ–ª–Ω—ã
    fullWaveThreshold: 30, // >= 30–≥ = –ø–æ–ª–Ω–∞—è –≤–æ–ª–Ω–∞ (100%)
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤–æ–ª–Ω—ã –ø—Ä–∏ –º–∞–ª—ã—Ö —É–≥–ª–µ–≤–æ–¥–∞—Ö
    minMultiplier: 0.25   // 25% –æ—Ç –±–∞–∑–æ–≤–æ–π –≤–æ–ª–Ω—ã –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤
  };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–≥–ª–µ–≤–æ–¥–æ–≤
   * @param {number} carbs - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ –≥—Ä–∞–º–º–∞—Ö
   * @returns {number} –º–Ω–æ–∂–∏—Ç–µ–ª—å 0.25-1.0
   */
  const calculateCarbsMultiplier = (carbs) => {
    if (carbs < CARBS_SCALING.minThreshold) {
      return CARBS_SCALING.minMultiplier;
    }
    if (carbs >= CARBS_SCALING.fullWaveThreshold) {
      return 1.0;
    }
    // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É minThreshold –∏ fullWaveThreshold
    const range = CARBS_SCALING.fullWaveThreshold - CARBS_SCALING.minThreshold;
    const carbsAboveMin = carbs - CARBS_SCALING.minThreshold;
    const ratio = carbsAboveMin / range;
    return CARBS_SCALING.minMultiplier + ratio * (1 - CARBS_SCALING.minMultiplier);
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
   * @param {number} gl - –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
   * @returns {Object} { multiplier, desc, category }
   */
  const getGLCategory = (gl) => {
    if (gl < GL_CATEGORIES.micro.max) return { ...GL_CATEGORIES.micro, id: 'micro' };
    if (gl < GL_CATEGORIES.veryLow.max) return { ...GL_CATEGORIES.veryLow, id: 'veryLow' };
    if (gl < GL_CATEGORIES.low.max) return { ...GL_CATEGORIES.low, id: 'low' };
    if (gl < GL_CATEGORIES.medium.max) return { ...GL_CATEGORIES.medium, id: 'medium' };
    if (gl < GL_CATEGORIES.high.max) return { ...GL_CATEGORIES.high, id: 'high' };
    return { ...GL_CATEGORIES.veryHigh, id: 'veryHigh' };
  };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å –æ—Ç –∂–∏—Ä–æ–≤ (–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è)
   * @param {number} fat - –∂–∏—Ä—ã –≤ –≥—Ä–∞–º–º–∞—Ö
   * @returns {number} –±–æ–Ω—É—Å (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = —É–¥–ª–∏–Ω—è–µ—Ç –≤–æ–ª–Ω—É)
   */
  const calculateFatBonus = (fat) => {
    if (fat >= FAT_BONUS.high.threshold) return FAT_BONUS.high.bonus;
    if (fat >= FAT_BONUS.medium.threshold) return FAT_BONUS.medium.bonus;
    if (fat >= FAT_BONUS.low.threshold) return FAT_BONUS.low.bonus;
    return 0;
  };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã
   * 
   * üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-09:
   * –§–æ—Ä–º—É–ª–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∏–∑–∫–æ—É–≥–ª–µ–≤–æ–¥–Ω–æ–π –µ–¥—ã.
   * 
   * –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´:
   * 1. GL (–≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞) ‚Äî –≥–ª–∞–≤–Ω—ã–π –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
   * 2. –ü—Ä–∏ –Ω–∏–∑–∫–æ–π GL (< 10) –≤—Å–µ –±–æ–Ω—É—Å—ã –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
   * 3. GI –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —É–≥–ª–µ–≤–æ–¥–æ–≤ (GL ‚â• 10)
   * 4. –ë–µ–ª–æ–∫/–∂–∏—Ä—ã/–∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –≤—Ç–æ—Ä–∏—á–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL
   * 
   * @param {number} gi - –ì–ò
   * @param {number} protein - –±–µ–ª–æ–∫ –≤ –≥—Ä–∞–º–º–∞—Ö
   * @param {number} fiber - –∫–ª–µ—Ç—á–∞—Ç–∫–∞ –≤ –≥—Ä–∞–º–º–∞—Ö
   * @param {number} carbs - —É–≥–ª–µ–≤–æ–¥—ã –≤ –≥—Ä–∞–º–º–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @param {number} fat - –∂–∏—Ä—ã –≤ –≥—Ä–∞–º–º–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @param {number} gl - –≥–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @param {boolean} hasLiquid - —Å–æ–¥–µ—Ä–∂–∏—Ç –∂–∏–¥–∫—É—é –ø–∏—â—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @param {number} insulinogenicBonus - –±–æ–Ω—É—Å –æ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @param {string} foodForm - —Ñ–æ—Ä–º–∞ –ø–∏—â–∏: 'liquid'|'processed'|'whole'|null (v3.2.0)
   * @returns {Object} { total, gi, protein, fiber, carbs, fat, gl, glCategory, liquid, insulinogenic, foodForm }
   */

  const calculateMultiplier = (gi, protein, fiber, carbs = null, fat = null, gl = null, hasLiquid = false, insulinogenicBonus = 0, foodForm = null, proteinType = 'mixed') => {
    const giCat = utils.getGICategory(gi);

    // üìä –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî v3.0.0: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞–≤–Ω—É—é —Ñ–æ—Ä–º—É–ª—É
    // –°—Ç—É–ø–µ–Ω—á–∞—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ continuous curve –¥–ª—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
    const glCategory = gl !== null ? getGLCategory(gl) : null; // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    // üÜï v3.0.0: Continuous GL multiplier –≤–º–µ—Å—Ç–æ —Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–≥–æ
    const glMultiplier = gl !== null ? calculateContinuousGLMultiplier(gl) : 1.0;

    // üî¨ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: GL-–∑–∞–≤–∏—Å–∏–º–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    // –ü—Ä–∏ GL < 10 —Ñ–∞–∫—Ç–æ—Ä—ã (–±–µ–ª–æ–∫, –∂–∏—Ä—ã, –∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å) –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ
    // –≠—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç –Ω–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç: –±–µ–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–æ–π
    // 
    // glScaleFactor:
    // - GL >= 20: 1.0 (–ø–æ–ª–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤)
    // - GL = 10: 0.6 (60% –æ—Ç —Ñ–∞–∫—Ç–æ—Ä–æ–≤)
    // - GL = 5: 0.4 (40% –æ—Ç —Ñ–∞–∫—Ç–æ—Ä–æ–≤) 
    // - GL = 0: 0.25 (25% ‚Äî –º–∏–Ω–∏–º—É–º, —Ç.–∫. –±–µ–ª–æ–∫ –≤—Å—ë –∂–µ –¥–∞—ë—Ç –Ω–µ–±–æ–ª—å—à–æ–π –∏–Ω—Å—É–ª–∏–Ω)
    let glScaleFactor = 1.0;
    if (gl !== null && gl < 20) {
      // –§–æ—Ä–º—É–ª–∞: 0.25 + (GL/20) * 0.75
      // GL=0 ‚Üí 0.25, GL=10 ‚Üí 0.625, GL=20 ‚Üí 1.0
      glScaleFactor = Math.max(0.25, 0.25 + (gl / 20) * 0.75);
    }

    // GI –º–Ω–æ–∂–∏—Ç–µ–ª—å ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ GL
    // üî¨ v3.8.0: GI –ù–ï –í–õ–ò–Ø–ï–¢ –ø—Ä–∏ GL<7 (Mayer 1995)
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –ø—Ä–∏ <7–≥ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –º–∏–Ω–∏–º–∞–ª–µ–Ω
    // Mayer 1995: "glycemic index is not important when GL<7"
    // Brand-Miller 2003: GL —è–≤–ª—è–µ—Ç—Å—è –±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã–º –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä–æ–º —á–µ–º GI
    let giMult = 1.0;
    if (gl === null || gl >= 20) {
      // –ü–æ–ª–Ω—ã–π GI —Ç–æ–ª—å–∫–æ –ø—Ä–∏ GL‚â•20 (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —É–≥–ª–µ–≤–æ–¥–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
      giMult = giCat.multiplier;
    } else if (gl >= 7) {
      // üÜï v3.8.0: –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –æ—Ç GL‚â•7 (–Ω–µ –æ—Ç GL‚â•5)
      // GL=7‚Üí0%, GL=13.5‚Üí50%, GL=20‚Üí100%
      const giWeight = (gl - 7) / 13;
      giMult = 1.0 + (giCat.multiplier - 1.0) * giWeight;
    }
    // –ü—Ä–∏ GL<7: giMult –æ—Å—Ç–∞—ë—Ç—Å—è 1.0 (GI –Ω–µ –≤–ª–∏—è–µ—Ç ‚Äî Mayer 1995)

    // –ë–æ–Ω—É—Å—ã –æ—Ç –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –ø–æ glScaleFactor
    // üÜï v4.0.0: –ë–µ–ª–æ–∫ v2 ‚Äî animal/plant –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞—Ü–∏—è
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: 
    // - Nuttall & Gannon 1991: –∂–∏–≤–æ—Ç–Ω—ã–π –±–µ–ª–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    // - Van Loon 2000: whey protein ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å
    // - Raben 1994: plant protein ‚Äî –º–µ–Ω—å—à–∏–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    let proteinBonus = 0;
    let proteinMeta = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –±–µ–ª–∫–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ

    if (protein > 0 && typeof calculateProteinBonusV2 === 'function') {
      // üÜï v4.0.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º v2 —Å–∏—Å—Ç–µ–º—É —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π –±–µ–ª–∫–∞
      const proteinV2 = calculateProteinBonusV2(protein, proteinType || 'mixed');
      proteinBonus = proteinV2.bonus;
      proteinMeta = {
        type: proteinV2.type,
        tier: proteinV2.tier,
        multiplier: proteinV2.multiplier,
        label: proteinV2.label,
        desc: proteinV2.desc
      };
    } else {
      // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É (backward compatibility)
      if (protein >= PROTEIN_BONUS.high.threshold) proteinBonus = PROTEIN_BONUS.high.bonus;
      else if (protein >= PROTEIN_BONUS.medium.threshold) proteinBonus = PROTEIN_BONUS.medium.bonus;
    }
    proteinBonus *= glScaleFactor;

    let fiberBonus = 0;
    // üÜï v4.2.5: –î–æ–±–∞–≤–ª–µ–Ω veryHigh tier (15–≥+ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ ‚Üí ‚àí20%)
    // Jenkins 1978, Weickert 2008: 15-25–≥ –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –∑–∞ –ø—Ä–∏—ë–º = ‚àí25-30% AUC –∏–Ω—Å—É–ª–∏–Ω–∞
    if (FIBER_BONUS.veryHigh && fiber >= FIBER_BONUS.veryHigh.threshold) fiberBonus = FIBER_BONUS.veryHigh.bonus;
    else if (fiber >= FIBER_BONUS.high.threshold) fiberBonus = FIBER_BONUS.high.bonus;
    else if (fiber >= FIBER_BONUS.medium.threshold) fiberBonus = FIBER_BONUS.medium.bonus;
    fiberBonus *= glScaleFactor;

    // üßà –ñ–∏—Ä—ã ‚Äî –∑–∞–º–µ–¥–ª—è—é—Ç —É—Å–≤–æ–µ–Ω–∏–µ –£–ì–õ–ï–í–û–î–û–í, –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL —ç—Ñ—Ñ–µ–∫—Ç –º–∏–Ω–∏–º–∞–ª–µ–Ω
    const rawFatBonus = fat !== null ? calculateFatBonus(fat) : 0;
    const fatBonus = rawFatBonus * glScaleFactor;

    // ü•õ –ò–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å ‚Äî v3.2.2: –¢–ï–ü–ï–†–¨ –£–ß–¢–ï–ù–ê –í GL!
    // –†–∞–Ω—å—à–µ: –¥–æ–±–∞–≤–ª—è–ª–∏ +15% –±–æ–Ω—É—Å –∫ –º–Ω–æ–∂–∏—Ç–µ–ª—é (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
    // –¢–µ–ø–µ—Ä—å: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º GL –ø—Ä–æ–¥—É–∫—Ç–∞ —á–µ—Ä–µ–∑ Insulin Index (–º–æ–ª–æ–∫–æ √ó3, –±–µ–ª–æ–∫ √ó1.8)
    // –≠—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ calculateMealNutrients() ‚Üí insulinIndexAdjustedGL
    // –ü–û–≠–¢–û–ú–£ insBonus = 0 (–∏–Ω–∞—á–µ –¥–≤–æ–π–Ω–æ–π —É—á—ë—Ç!)
    const insBonus = 0;

    // ü•§ –ñ–∏–¥–∫–∞—è –ø–∏—â–∞ ‚Äî —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ (–≤–æ–ª–Ω–∞ –∫–æ—Ä–æ—á–µ, –Ω–æ –ø–∏–∫ –≤—ã—à–µ)
    const liquidMult = hasLiquid ? LIQUID_FOOD.waveMultiplier : 1.0;

    // üçé –§–æ—Ä–º–∞ –ø–∏—â–∏ (v3.2.0) ‚Äî –∂–∏–¥–∫–æ–µ/–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ/—Ü–µ–ª—å–Ω–æ–µ
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Flood-Obbagy & Rolls 2009
    const foodFormMult = foodForm && FOOD_FORM_BONUS[foodForm]
      ? FOOD_FORM_BONUS[foodForm].multiplier
      : 1.0;

    // –ë–∞–∑–æ–≤—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: GI + –≤—Å–µ –±–æ–Ω—É—Å—ã (—É–∂–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
    const baseMult = giMult + proteinBonus + fiberBonus + fatBonus + insBonus;

    // GL –º–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –±–∞–∑–µ
    // –ü—Ä–∏ GL < 5: glMultiplier = 0.5 ‚Üí –≤–æ–ª–Ω–∞ –≤ 2 —Ä–∞–∑–∞ –∫–æ—Ä–æ—á–µ
    const carbsMult = glMultiplier;

    return {
      total: baseMult * carbsMult * liquidMult * foodFormMult,
      gi: giMult,
      protein: proteinBonus,
      proteinMeta, // üÜï v4.0.0: –¢–∏–ø –±–µ–ª–∫–∞ (animal/plant/whey/mixed)
      fiber: fiberBonus,
      fat: fatBonus,
      carbs: carbsMult,
      liquid: liquidMult,
      foodForm: foodFormMult,  // üÜï v3.2.0
      insulinogenic: insBonus,
      glCategory,
      glScaleFactor, // üÜï –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
      category: giCat
    };
  };

  const calculateWorkoutBonus = (rawTrainings) => {
    // üÜï v3.7.3: –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    const trainings = (rawTrainings || []).filter(isValidTraining);
    if (trainings.length === 0) {
      return { bonus: 0, totalMinutes: 0, intensityMinutes: 0, desc: null };
    }

    let totalMinutes = 0;
    let intensityMinutes = 0;

    for (const t of trainings) {
      const zones = t.z || [0, 0, 0, 0];
      // z[0], z[1] ‚Äî –Ω–∏–∑–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å, z[2], z[3] ‚Äî –≤—ã—Å–æ–∫–∞—è
      const lowIntensity = (zones[0] || 0) + (zones[1] || 0);
      const highIntensity = (zones[2] || 0) + (zones[3] || 0);

      totalMinutes += lowIntensity + highIntensity;
      // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –º–∏–Ω—É—Ç—ã —Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º
      intensityMinutes += lowIntensity + highIntensity * WORKOUT_BONUS.intensityMultiplier;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–æ–Ω—É—Å
    let bonus = 0;
    let desc = null;

    if (intensityMinutes >= WORKOUT_BONUS.high.threshold) {
      bonus = WORKOUT_BONUS.high.bonus;
      desc = `üèÉ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ${Math.round(totalMinutes)} –º–∏–Ω ‚Üí –≤–æ–ª–Ω–∞ ${Math.abs(Math.round(bonus * 100))}% –∫–æ—Ä–æ—á–µ`;
    } else if (intensityMinutes >= WORKOUT_BONUS.medium.threshold) {
      bonus = WORKOUT_BONUS.medium.bonus;
      desc = `üèÉ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ${Math.round(totalMinutes)} –º–∏–Ω ‚Üí —É—Å–∫–æ—Ä–µ–Ω–∏–µ`;
    }

    return { bonus, totalMinutes: Math.round(totalMinutes), intensityMinutes: Math.round(intensityMinutes), desc };
  };

  /**
   * üèÉ‚Äç‚ôÇÔ∏è –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å –æ—Ç –ø–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–ü–û–°–õ–ï –µ–¥—ã)
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –∞–∫—Ç–∏–≤–∞—Ü–∏—è GLUT4 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ—Ä–æ–≤ –º—ã—à—Ü–∞–º–∏
   * —É—Å–∫–æ—Ä—è–µ—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –≥–ª—é–∫–æ–∑—ã –Ω–∞ 20-30% (Colberg et al. 2010)
   * 
   * @param {Array} rawTrainings - –º–∞—Å—Å–∏–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–Ω—è
   * @param {number} mealTimeMinutes - –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏
   * @returns {Object} { bonus, matchedTraining, desc, gapMinutes }
   */
  const calculatePostprandialExerciseBonus = (rawTrainings, mealTimeMinutes) => {
    // üÜï v3.7.3: –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    const trainings = (rawTrainings || []).filter(isValidTraining);
    if (trainings.length === 0 || !mealTimeMinutes) {
      return { bonus: 0, matchedTraining: null, desc: null, gapMinutes: null };
    }

    // –ò—â–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ü–û–°–õ–ï –µ–¥—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 2 —á–∞—Å–æ–≤
    let bestMatch = null;
    let bestBonus = 0;
    let bestGap = null;
    let bestDetails = null;

    for (const t of trainings) {
      if (!t.time) continue;

      const trainingMinutes = utils.timeToMinutes(t.time);
      let gapMinutes = trainingMinutes - mealTimeMinutes;

      // –ï—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å (–µ–¥–∞ 23:00, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ 01:00)
      if (gapMinutes < 0 && Math.abs(gapMinutes) > 12 * 60) {
        gapMinutes += 24 * 60;
      }

      // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ü–û–°–õ–ï –µ–¥—ã –∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞
      if (gapMinutes > 0 && gapMinutes <= POSTPRANDIAL_EXERCISE.maxWindow) {
        const zones = t.z || [0, 0, 0, 0];
        const lowIntensity = (zones[0] || 0) + (zones[1] || 0);
        const highIntensity = (zones[2] || 0) + (zones[3] || 0);
        const totalMinutes = lowIntensity + highIntensity;

        // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ —Ç–∏–ø—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        const typeMult = POSTPRANDIAL_EXERCISE.typeMultipliers[t.type] || 1.0;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–æ–Ω—É—Å –ø–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
        let rawBonus = 0;
        let intensityLevel = 'none';
        if (highIntensity >= POSTPRANDIAL_EXERCISE.highIntensity.threshold) {
          rawBonus = POSTPRANDIAL_EXERCISE.highIntensity.bonus;
          intensityLevel = 'high';
        } else if (totalMinutes >= POSTPRANDIAL_EXERCISE.moderate.threshold) {
          rawBonus = POSTPRANDIAL_EXERCISE.moderate.bonus;
          intensityLevel = 'moderate';
        } else if (totalMinutes >= POSTPRANDIAL_EXERCISE.light.threshold) {
          rawBonus = POSTPRANDIAL_EXERCISE.light.bonus;
          intensityLevel = 'light';
        }

        // üÜï v3.5.1: proximityBoost ‚Äî —á–µ–º —Ä–∞–Ω—å—à–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ –µ–¥—ã, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ
        let proximityBoost = 0.7; // default: late
        if (gapMinutes <= POSTPRANDIAL_EXERCISE.proximityBoost.immediate.maxGap) {
          proximityBoost = POSTPRANDIAL_EXERCISE.proximityBoost.immediate.boost; // 1.5
        } else if (gapMinutes <= POSTPRANDIAL_EXERCISE.proximityBoost.soon.maxGap) {
          proximityBoost = POSTPRANDIAL_EXERCISE.proximityBoost.soon.boost; // 1.3
        } else if (gapMinutes <= POSTPRANDIAL_EXERCISE.proximityBoost.medium.maxGap) {
          proximityBoost = POSTPRANDIAL_EXERCISE.proximityBoost.medium.boost; // 1.0
        }

        // üÜï v3.5.1: kcalBonus ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∑–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ POST-WORKOUT: –±–æ–ª—å—à–µ –∫–∫–∞–ª = —Å–∏–ª—å–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç
        const weight = 70; // default
        const trainingKcal = totalMinutes * 5 * (weight / 70) * (highIntensity > lowIntensity ? 1.5 : 1.0);
        let kcalBoost = 1.0;
        if (trainingKcal >= 500) {
          kcalBoost = 1.5; // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Üí +50% –∫ –±–æ–Ω—É—Å—É
        } else if (trainingKcal >= 300) {
          kcalBoost = 1.25;
        }

        // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å = base √ó type √ó proximity √ó kcal
        const finalBonus = Math.max(-0.85, rawBonus * typeMult * proximityBoost * kcalBoost);

        if (finalBonus < bestBonus) { // –ò—â–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (—Å–∞–º—ã–π –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –ª—É—á—à–∏–π)
          bestBonus = finalBonus;
          bestMatch = t;
          bestGap = gapMinutes;
          bestDetails = { intensityLevel, typeMult, proximityBoost, kcalBoost, trainingKcal, rawBonus };
        }
      }
    }

    if (!bestMatch) {
      return { bonus: 0, matchedTraining: null, desc: null, gapMinutes: null };
    }

    const pctShorter = Math.abs(Math.round(bestBonus * 100));
    const typeEmoji = bestMatch.type === 'cardio' ? 'üèÉ' : bestMatch.type === 'strength' ? 'üèãÔ∏è' : '‚öΩ';

    return {
      bonus: bestBonus,
      matchedTraining: bestMatch,
      gapMinutes: bestGap,
      details: bestDetails,
      desc: `${typeEmoji} –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${bestGap} –º–∏–Ω –ø–æ—Å–ª–µ –µ–¥—ã ‚Üí –≤–æ–ª–Ω–∞ ${pctShorter}% –∫–æ—Ä–æ—á–µ`
    };
  };

  /**
   * üè° –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å –æ—Ç –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (NEAT)
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Hamilton et al. 2007 ‚Äî NEAT —É–ª—É—á—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   * 
   * @param {number} householdMin - –º–∏–Ω—É—Ç—ã –±—ã—Ç–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   * @returns {Object} { bonus, desc }
   */
  const calculateNEATBonus = (householdMin) => {
    if (!householdMin || householdMin <= 0) {
      return { bonus: 0, desc: null };
    }

    let bonus = 0;
    let desc = null;

    if (householdMin >= NEAT_BONUS.high.threshold) {
      bonus = NEAT_BONUS.high.bonus;
      desc = `üè° –ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ${householdMin} –º–∏–Ω ‚Üí –≤–æ–ª–Ω–∞ ${Math.abs(Math.round(bonus * 100))}% –∫–æ—Ä–æ—á–µ`;
    } else if (householdMin >= NEAT_BONUS.medium.threshold) {
      bonus = NEAT_BONUS.medium.bonus;
      desc = `üè° –ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ${householdMin} –º–∏–Ω ‚Üí —É—Å–∫–æ—Ä–µ–Ω–∏–µ`;
    } else if (householdMin >= NEAT_BONUS.low.threshold) {
      bonus = NEAT_BONUS.low.bonus;
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º desc –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
    }

    return { bonus, desc };
  };

  /**
   * üö∂ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å –æ—Ç —à–∞–≥–æ–≤
   * 
   * @param {number} steps - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤
   * @returns {Object} { bonus, desc }
   */
  const calculateStepsBonus = (steps) => {
    if (!steps || steps <= 0) {
      return { bonus: 0, desc: null };
    }

    let bonus = 0;
    let desc = null;

    if (steps >= STEPS_BONUS.high.threshold) {
      bonus = STEPS_BONUS.high.bonus;
      desc = `üö∂ ${Math.round(steps / 1000)}k —à–∞–≥–æ–≤ ‚Üí –≤–æ–ª–Ω–∞ ${Math.abs(Math.round(bonus * 100))}% –∫–æ—Ä–æ—á–µ`;
    } else if (steps >= STEPS_BONUS.medium.threshold) {
      bonus = STEPS_BONUS.medium.bonus;
      desc = `üö∂ ${Math.round(steps / 1000)}k —à–∞–≥–æ–≤ ‚Üí —É—Å–∫–æ—Ä–µ–Ω–∏–µ`;
    } else if (steps >= STEPS_BONUS.low.threshold) {
      bonus = STEPS_BONUS.low.bonus;
    }

    return { bonus, desc };
  };

  /**
   * üåÖ v3.8.0: –ü–ª–∞–≤–Ω—ã–π —Ü–∏—Ä–∫–∞–¥–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (—Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è –∫—Ä–∏–≤–∞—è)
   * –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–µ 5 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –Ω–∞ smooth continuous curve
   * 
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Van Cauter 1997
   * - –ü–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 7-9 —É—Ç—Ä–∞ (multiplier ~0.85)
   * - –ú–∏–Ω–∏–º—É–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 22-02 –Ω–æ—á–∏ (multiplier ~1.20)
   * - –ü–µ—Ä–µ—Ö–æ–¥ –ø–ª–∞–≤–Ω—ã–π, –ø—Ä–∏–≤—è–∑–∞–Ω –∫ 24-—á–∞—Å–æ–≤–æ–º—É —Ä–∏—Ç–º—É –∫–æ—Ä—Ç–∏–∑–æ–ª–∞
   * 
   * –§–æ—Ä–º—É–ª–∞: –∫–æ—Å–∏–Ω—É—Å–Ω–∞—è –≤–æ–ª–Ω–∞ —Å –ø–µ—Ä–∏–æ–¥–æ–º 24 —á–∞—Å–∞
   * center = (min + max) / 2 = 1.025
   * amplitude = (max - min) / 2 = 0.175
   * phase = (hour - peakHour) / 24 * 2œÄ
   * multiplier = center - amplitude * cos(phase)

  
  /**
   * üåÖ v3.8.0: –ü–ª–∞–≤–Ω—ã–π —Ü–∏—Ä–∫–∞–¥–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (—Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è –∫—Ä–∏–≤–∞—è)
   * –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–µ 5 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –Ω–∞ smooth continuous curve
   * 
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Van Cauter 1997
   * - –ü–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 7-9 —É—Ç—Ä–∞ (multiplier ~0.85)
   * - –ú–∏–Ω–∏–º—É–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 22-02 –Ω–æ—á–∏ (multiplier ~1.20)
   * - –ü–µ—Ä–µ—Ö–æ–¥ –ø–ª–∞–≤–Ω—ã–π, –ø—Ä–∏–≤—è–∑–∞–Ω –∫ 24-—á–∞—Å–æ–≤–æ–º—É —Ä–∏—Ç–º—É –∫–æ—Ä—Ç–∏–∑–æ–ª–∞
   * 
   * –§–æ—Ä–º—É–ª–∞: –∫–æ—Å–∏–Ω—É—Å–Ω–∞—è –≤–æ–ª–Ω–∞ —Å –ø–µ—Ä–∏–æ–¥–æ–º 24 —á–∞—Å–∞
   * center = (min + max) / 2 = 1.025
   * amplitude = (max - min) / 2 = 0.175
   * phase = (hour - peakHour) / 24 * 2œÄ
   * multiplier = center - amplitude * cos(phase)
   * 
   * @param {number} hour - —Ç–µ–∫—É—â–∏–π —á–∞—Å (0-23.99)
   * @returns {Object} { multiplier, period, desc, isSmooth }
   */
  const calculateCircadianMultiplier = (hour) => {
    const { peakHour, minMultiplier, maxMultiplier, descriptions } = CIRCADIAN_CONFIG;

    // –¶–µ–Ω—Ç—Ä –∏ –∞–º–ø–ª–∏—Ç—É–¥–∞ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–π –≤–æ–ª–Ω—ã
    const center = (minMultiplier + maxMultiplier) / 2;  // 1.025
    const amplitude = (maxMultiplier - minMultiplier) / 2;  // 0.175

    // –§–∞–∑–∞: 0 –≤ –º–æ–º–µ–Ω—Ç peakHour (8:00), 2œÄ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
    // –ö–æ—Å–∏–Ω—É—Å –≤ 0 = 1, –ø–æ—ç—Ç–æ–º—É –≤ peakHour –ø–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (–º–∞–∫—Å. —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
    const phase = ((hour - peakHour) / 24) * 2 * Math.PI;

    // –ü–ª–∞–≤–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
    const smoothMultiplier = center - amplitude * Math.cos(phase);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
    let period = 'afternoon';
    let desc = descriptions.afternoon?.desc || '–î–Ω–µ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å ‚òÄÔ∏è';

    if (hour >= 22 || hour < 5) {
      period = 'night';
      desc = descriptions.night?.desc || '–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º üåô';
    } else if (hour >= 5 && hour < 7) {
      period = 'earlyMorning';
      desc = descriptions.earlyMorning?.desc || '–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ üåÖ';
    } else if (hour >= 7 && hour < 10) {
      period = 'peakMorning';
      desc = descriptions.peakMorning?.desc || '–ü–∏–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üåû';
    } else if (hour >= 10 && hour < 14) {
      period = 'midday';
      desc = descriptions.midday?.desc || '–û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ‚òÄÔ∏è';
    } else if (hour >= 14 && hour < 18) {
      period = 'afternoon';
      desc = descriptions.afternoon?.desc || '–î–Ω–µ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å üå§Ô∏è';
    } else if (hour >= 18 && hour < 21) {
      period = 'evening';
      desc = descriptions.evening?.desc || '–í–µ—á–µ—Ä–Ω–∏–π —Å–ø–∞–¥ üåÜ';
    } else if (hour >= 21 && hour < 22) {
      period = 'lateEvening';
      desc = descriptions.lateEvening?.desc || '–ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä üåô';
    }

    return {
      multiplier: smoothMultiplier,
      period,
      desc,
      isSmooth: true  // –§–ª–∞–≥ –¥–ª—è –æ—Ç–ª–∏—á–∏—è –æ—Ç legacy
    };
  };


  // === –°–û–°–¢–ê–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–†–ò–Å–ú–û–í –ü–ò–©–ò ===

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ñ–∞–∫—Ç–æ—Ä—ã –¥–Ω—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
   * @param {Object} dayData - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @param {number} mealHour - —á–∞—Å –ø—Ä–∏—ë–º–∞ (0-23)
   * @returns {Object} { totalBonus, circadianMultiplier, details }
   */
  const calculateDayFactorsForMeal = (dayData = {}, mealHour = 12) => {
    const I = HEYS.InsulinWave?.__internals;
    const calculateSleepBonus = I?.calculateSleepBonus || (() => 0);
    const calculateSleepQualityBonus = I?.calculateSleepQualityBonus || (() => 0);
    const calculateHydrationBonus = I?.calculateHydrationBonus || (() => 0);
    const calculateAgeBonus = I?.calculateAgeBonus || (() => 0);
    const calculateBMIBonus = I?.calculateBMIBonus || (() => 0);
    const getGenderBonus = I?.getGenderBonus || (() => 0);
    const calculateStressBonus = I?.calculateStressBonus || (() => 0);

    // üåÖ Circadian —Ä–∏—Ç–º
    const circadian = calculateCircadianMultiplier(mealHour);

    // üò¥ –ù–µ–¥–æ—Å—ã–ø
    const sleepHours = dayData.sleepHours;
    const sleepBonus = calculateSleepBonus(sleepHours);

    // üåü –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞
    const sleepQuality = dayData.sleepQuality || 0;
    const sleepQualityBonus = calculateSleepQualityBonus(sleepQuality);

    // üíß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è
    const waterMl = dayData.waterMl || 0;
    const userWeight = dayData.profile?.weight || 70;
    const hydrationBonus = calculateHydrationBonus(waterMl, userWeight);

    // üë¥ –í–æ–∑—Ä–∞—Å—Ç
    const age = dayData.profile?.age || 0;
    const ageBonus = calculateAgeBonus(age);

    // üèãÔ∏è BMI
    const weight = dayData.profile?.weight || 0;
    const height = dayData.profile?.height || 0;
    const bmiBonus = calculateBMIBonus(weight, height);

    // üö∫üöπ –ü–æ–ª
    const gender = dayData.profile?.gender || '';
    const genderBonus = getGenderBonus(gender);

    // üò∞ –°—Ç—Ä–µ—Å—Å
    const stressLevel = dayData.stressAvg || 0;
    const stressBonus = calculateStressBonus(stressLevel);

    // üå∏ –ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª
    const cycleDay = dayData.cycleDay || null;
    const cycleMultiplier = HEYS.Cycle?.getInsulinWaveMultiplier?.(cycleDay) || 1;
    const cycleBonusValue = cycleMultiplier > 1 ? (cycleMultiplier - 1) : 0;

    // –°—É–º–º–∏—Ä—É–µ–º –±–æ–Ω—É—Å—ã
    // ‚ö†Ô∏è v3.0.0: age, bmi, gender –ò–°–ö–õ–Æ–ß–ï–ù–´ ‚Äî –æ–Ω–∏ —É–∂–µ –≤ effectiveBaseWaveHours (Personal Baseline)
    const personalBonuses = sleepBonus + sleepQualityBonus + hydrationBonus + stressBonus + cycleBonusValue;

    return {
      totalBonus: personalBonuses,
      circadianMultiplier: circadian.multiplier,
      details: {
        circadian,
        sleepBonus,
        sleepQualityBonus,
        hydrationBonus,
        ageBonus,
        bmiBonus,
        genderBonus,
        stressBonus,
        cycleBonusValue
      }
    };
  };

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ñ–∞–∫—Ç–æ—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
   * @param {Array} trainings - —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–Ω—è
   * @param {number} mealMinutes - –º–∏–Ω—É—Ç—ã –ø—Ä–∏—ë–º–∞ (–æ—Ç 00:00)
   * @param {number} householdMin - –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
   * @param {number} steps - —à–∞–≥–∏
   * @returns {Object} { totalBonus, details }
   */
  const calculateActivityFactorsForMeal = (trainings = [], mealMinutes = 0, householdMin = 0, steps = 0) => {
    // üèÉ Workout (–æ–±—â–∏–π –∑–∞ –¥–µ–Ω—å)
    const workoutBonus = calculateWorkoutBonus(trainings);

    // üèÉ‚Äç‚ôÇÔ∏è –ü–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
    const postprandialBonus = calculatePostprandialExerciseBonus(trainings, mealMinutes);

    // üè° NEAT
    const neatBonus = calculateNEATBonus(householdMin);

    // üëü –®–∞–≥–∏
    const stepsBonus = calculateStepsBonus(steps);

    const totalBonus = workoutBonus.bonus + postprandialBonus.bonus + neatBonus.bonus + stepsBonus.bonus;

    return {
      totalBonus,
      details: {
        workoutBonus,
        postprandialBonus,
        neatBonus,
        stepsBonus
      }
    };
  };

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.Calc = {
    calculateMealNutrients,
    calculateCarbsMultiplier,
    calculateMultiplier,
    calculateWorkoutBonus,
    calculatePostprandialExerciseBonus,
    calculateNEATBonus,
    calculateStepsBonus,
    calculateCircadianMultiplier,
    calculateDayFactorsForMeal,
    calculateActivityFactorsForMeal,
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª—è
    __version: MODULE_VERSION,
    __name: MODULE_NAME
  };

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_orchestrator.js ===== */
// heys_iw_orchestrator.js ‚Äî InsulinWave Orchestration Helper Functions
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ calculateInsulinWaveData.
// –í—ã–¥–µ–ª–µ–Ω—ã –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
//
// –§–£–ù–ö–¶–ò–ò:
// - prepareWaveData() - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
// - calculateWaveForMeal() - —Ä–∞—Å—á—ë—Ç –≤–æ–ª–Ω—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
// - buildWaveHistory() - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤–æ–ª–Ω –∑–∞ –¥–µ–Ω—å
// - determineWaveStatus() - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–ª–Ω—ã

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // === MODULE VERSION ===
  const MODULE_VERSION = '1.0.0';
  const MODULE_NAME = 'InsulinWave.Orchestrator';

  // === –ò–ú–ü–û–†–¢ –ò–ó –î–†–£–ì–ò–• –ú–û–î–£–õ–ï–ô ===
  const I = HEYS.InsulinWave?.__internals;
  const utils = HEYS.InsulinWave?.utils;
  const Calc = HEYS.InsulinWave?.Calc;
  const V30 = HEYS.InsulinWave?.V30;
  const STATUS_CONFIG = I?.STATUS_CONFIG;

  /**
   * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤–æ–ª–Ω—ã
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @returns {Object} –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  const prepareWaveData = ({ meals, profile, dayData, baseWaveHours }) => {
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∏—ë–º—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º
    const mealsWithTime = meals.filter(m => m.time);

    // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–æ–≤–∞—è –≤–æ–ª–Ω–∞
    const personalBaseline = V30?.calculatePersonalBaselineWave(profile);
    let effectiveBaseWaveHours = baseWaveHours;
    if (profile.age && personalBaseline?.baseHours && !isNaN(personalBaseline.baseHours)) {
      effectiveBaseWaveHours = personalBaseline.baseHours;
    }
    if (!effectiveBaseWaveHours || isNaN(effectiveBaseWaveHours)) {
      effectiveBaseWaveHours = 3;
    }

    // IR Score
    const irScore = I?.calculateIRScore(profile, dayData);
    const irScoreMultiplier = irScore?.waveMultiplier || 1.0;

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–≤—ã–π)
    const sorted = [...mealsWithTime].sort((a, b) => {
      const timeA = (a.time || '').replace(':', '');
      const timeB = (b.time || '').replace(':', '');
      return timeB.localeCompare(timeA);
    });

    return {
      mealsWithTime,
      sorted,
      effectiveBaseWaveHours,
      irScoreMultiplier,
      personalBaseline
    };
  };

  /**
   * –†–∞—Å—á—ë—Ç –≤–æ–ª–Ω—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞
   * @returns {Object} –¥–∞–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã –¥–ª—è –ø—Ä–∏—ë–º–∞
   */
  const calculateWaveForMeal = ({
    meal,
    pIndex,
    getProductFromItem,
    effectiveBaseWaveHours,
    irScoreMultiplier,
    prevMeal,
    trainings,
    dayData,
    now
  }) => {
    // Meal Stacking
    let mealStackingResult = { bonus: 0, desc: null, hasStacking: false };
    if (prevMeal) {
      const prevNutrients = Calc?.calculateMealNutrients(prevMeal, pIndex, getProductFromItem);
      const prevWaveEnd = utils.timeToMinutes(prevMeal.time) + (effectiveBaseWaveHours * 60);
      const currentMealTime = utils.timeToMinutes(meal.time);
      mealStackingResult = V30?.calculateMealStackingBonus(prevWaveEnd, currentMealTime, prevNutrients?.glycemicLoad);
    }

    // –†–∞—Å—á—ë—Ç –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
    const nutrients = Calc?.calculateMealNutrients(meal, pIndex, getProductFromItem);

    // –§–æ—Ä–º–∞ –ø–∏—â–∏
    const getFoodForm = I?.getFoodForm;
    const hasResistantStarch = I?.hasResistantStarch;
    let mealFoodForm = null;
    let hasResistantStarchInMeal = false;
    for (const item of (meal.items || [])) {
      const prod = getProductFromItem(item, pIndex);
      const itemForm = getFoodForm(prod);
      if (itemForm === 'liquid') mealFoodForm = 'liquid';
      else if (itemForm === 'processed' && mealFoodForm !== 'liquid') mealFoodForm = 'processed';
      else if (itemForm === 'whole' && !mealFoodForm) mealFoodForm = 'whole';
      if (hasResistantStarch(prod)) hasResistantStarchInMeal = true;
    }

    // Multipliers
    const multipliers = Calc?.calculateMultiplier(
      nutrients.avgGI,
      nutrients.totalProtein,
      nutrients.totalFiber,
      nutrients.totalCarbs,
      nutrients.totalFat,
      nutrients.glycemicLoad,
      nutrients.hasLiquid,
      nutrients.insulinogenicBonus,
      mealFoodForm,
      nutrients.dominantProteinType || 'mixed'
    );

    // Workout bonus
    const workoutBonus = Calc?.calculateWorkoutBonus(trainings);

    // Activity context
    const calculateActivityContext = I?.calculateActivityContext;
    const activityContext = calculateActivityContext ?
      calculateActivityContext({
        trainings,
        mealTime: meal.time,
        dayData,
        waveMinutes: effectiveBaseWaveHours * 60
      }) : { type: 'none', waveBonus: 0 };

    // Circadian multiplier
    const mealHour = parseFloat(meal.time.split(':')[0]) + parseFloat(meal.time.split(':')[1]) / 60;
    const circadianData = Calc?.calculateCircadianMultiplier(mealHour);

    // Wave phases
    const approxWaveMinutes = effectiveBaseWaveHours * 60 * multipliers.total * circadianData.multiplier;
    const wavePhases = V30?.calculateWavePhases(approxWaveMinutes, nutrients, activityContext.type !== 'none');

    return {
      nutrients,
      multipliers,
      mealStackingResult,
      mealFoodForm,
      hasResistantStarchInMeal,
      workoutBonus,
      activityContext,
      circadianData,
      wavePhases,
      mealHour
    };
  };

  /**
   * –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤–æ–ª–Ω –∑–∞ –¥–µ–Ω—å
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @returns {Array} –º–∞—Å—Å–∏–≤ –≤–æ–ª–Ω
   */
  const buildWaveHistory = ({ sorted, waveData, pIndex, getProductFromItem, effectiveBaseWaveHours }) => {
    const waveHistory = [];

    for (const meal of sorted) {
      const nutrients = Calc?.calculateMealNutrients(meal, pIndex, getProductFromItem);
      const mealHour = parseFloat(meal.time.split(':')[0]) + parseFloat(meal.time.split(':')[1]) / 60;
      const circadian = Calc?.calculateCircadianMultiplier(mealHour);
      const mult = Calc?.calculateMultiplier(
        nutrients.avgGI,
        nutrients.totalProtein,
        nutrients.totalFiber,
        nutrients.totalCarbs,
        nutrients.totalFat,
        nutrients.glycemicLoad,
        nutrients.hasLiquid,
        nutrients.insulinogenicBonus,
        null,
        nutrients.dominantProteinType || 'mixed'
      );

      const duration = Math.round(effectiveBaseWaveHours * 60 * mult.total * circadian.multiplier);
      const startMin = utils.timeToMinutes(meal.time);
      const endMin = startMin + duration;

      waveHistory.push({
        time: meal.time,
        startMin,
        endMin,
        duration,
        gl: nutrients.glycemicLoad,
        gi: nutrients.avgGI,
        mealName: meal.name || '–ü—Ä–∏—ë–º –ø–∏—â–∏'
      });
    }

    return waveHistory.reverse();
  };

  /**
   * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–ª–Ω—ã
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   * @returns {Object} —Å—Ç–∞—Ç—É—Å –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
   */
  const determineWaveStatus = ({ remaining, insulinWaveHours }) => {
    const minutesRemaining = Math.round(remaining);
    const totalMinutes = Math.round(insulinWaveHours * 60);
    const elapsed = totalMinutes - minutesRemaining;
    const progress = elapsed / totalMinutes;

    let status = 'active';
    let statusLabel = STATUS_CONFIG?.active?.label || '–ê–∫—Ç–∏–≤–Ω–∞—è –≤–æ–ª–Ω–∞';
    let statusColor = STATUS_CONFIG?.active?.color || '#3b82f6';

    if (progress < 0.25) {
      status = 'rise';
      statusLabel = STATUS_CONFIG?.rise?.label || '–ü–æ–¥—ä—ë–º';
      statusColor = STATUS_CONFIG?.rise?.color || '#f97316';
    } else if (progress < 0.65) {
      status = 'plateau';
      statusLabel = STATUS_CONFIG?.plateau?.label || '–ü–ª–∞—Ç–æ';
      statusColor = STATUS_CONFIG?.plateau?.color || '#eab308';
    } else if (minutesRemaining > 0) {
      status = 'decline';
      statusLabel = STATUS_CONFIG?.decline?.label || '–°–ø–∞–¥';
      statusColor = STATUS_CONFIG?.decline?.color || '#22c55e';
    } else {
      status = 'lipolysis';
      statusLabel = STATUS_CONFIG?.lipolysis?.label || '–õ–∏–ø–æ–ª–∏–∑';
      statusColor = STATUS_CONFIG?.lipolysis?.color || '#10b981';
    }

    return { status, statusLabel, statusColor, progress };
  };

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.Orchestrator = {
    prepareWaveData,
    calculateWaveForMeal,
    buildWaveHistory,
    determineWaveStatus,
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª—è
    __version: MODULE_VERSION,
    __name: MODULE_NAME
  };

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_graph.js ===== */
// heys_iw_graph.js ‚Äî InsulinWave Graph Module  
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å SVG-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã —Å 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–π Gaussian –º–æ–¥–µ–ª—å—é.
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.
//
// –§–£–ù–ö–¶–ò–ò:
// - renderWaveChart() ‚Äî —Ä–µ–Ω–¥–µ—Ä SVG –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–µ–π
// - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 3-peak –º–æ–¥–µ–ª–∏ (fast, slow, hepatic –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
// - Fallback –Ω–∞ –æ–¥–Ω–æ–ø–∏–∫–æ–≤—É—é –º–æ–¥–µ–ª—å –¥–ª—è backward compatibility
//
// –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞: Multi-component Gaussian insulin response model

(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  
  // === SVG –ì–†–ê–§–ò–ö –í–û–õ–ù–´ (–≤—ã–Ω–æ—Å–∏–º –Ω–∞—Ä—É–∂—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ) ===
  const renderWaveChart = (data) => {
    if (!data || data.remaining <= 0) return null; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –≤–æ–ª–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    // üÜï v3.0.0: –ó–∞—â–∏—Ç–∞ –æ—Ç undefined insulinWaveHours
    if (!data.insulinWaveHours || data.insulinWaveHours <= 0) return null;
    
    const width = 280;
    const height = 80;
    const padding = { left: 25, right: 10, top: 10, bottom: 20 };
    const chartW = width - padding.left - padding.right;
    const chartH = height - padding.top - padding.bottom;
    
    // –î–∞–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã
    const totalMinutes = data.insulinWaveHours * 60;
    const elapsedMinutes = totalMinutes - data.remaining;
    const progress = Math.min(1, elapsedMinutes / totalMinutes); // 0-1
    
    // üÜï v4.1.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—É—á–Ω—É—é 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—É—é Gaussian –∫—Ä–∏–≤—É—é –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
    const generateWavePath = () => {
      const points = [];
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å curve –∏–∑ calculateInsulinWaveData ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë (3-peak Gaussian)
      if (data.curve && Array.isArray(data.curve) && data.curve.length > 0) {
        // data.curve: –º–∞—Å—Å–∏–≤ {t, y, components: {fast, slow, hepatic}} 
        // t —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω 0-1 –≤ generateWaveCurve()
        const curveData = data.curve;
        const maxY = Math.max(...curveData.map(p => p.y || p.value || 0), 0.01);
        
        curveData.forEach(point => {
          const tNorm = point.t || 0; // t —É–∂–µ 0-1, –ù–ï –¥–µ–ª–∏–º –Ω–∞ totalMinutes!
          const yNorm = (point.y || point.value || 0) / maxY; // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
          const x = padding.left + tNorm * chartW;
          const yPx = padding.top + chartH * (1 - yNorm);
          
          // üÜï v4.1.0: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è 3-peak –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
          const components = point.components || {};
          const fastNorm = (components.fast || 0) / maxY;
          const slowNorm = (components.slow || 0) / maxY;
          const hepaticNorm = (components.hepatic || 0) / maxY;
          
          points.push({ 
            x, y: yPx, t: tNorm, value: yNorm,
            // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö Y
            fastY: padding.top + chartH * (1 - fastNorm),
            slowY: padding.top + chartH * (1 - slowNorm),
            hepaticY: padding.top + chartH * (1 - hepaticNorm)
          });
        });
        
        return points;
      }
      
      // Fallback: —Å—Ç–∞—Ä–∞—è –æ–¥–Ω–æ–ø–∏–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å (–¥–ª—è backwards compatibility)
      const gi = data.avgGI || 50;
      const peakPosition = gi >= 70 ? 0.15 : gi <= 40 ? 0.35 : 0.25;
      const peakHeight = gi >= 70 ? 0.95 : gi <= 40 ? 0.7 : 0.85;
      const steps = 50;
      
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        let y;
        if (t <= peakPosition) {
          const tNorm = t / peakPosition;
          y = peakHeight * Math.pow(tNorm, 1.5);
        } else {
          const tNorm = (t - peakPosition) / (1 - peakPosition);
          y = peakHeight * Math.exp(-2.5 * tNorm);
        }
        const x = padding.left + t * chartW;
        const yPx = padding.top + chartH * (1 - y);
        points.push({ x, y: yPx, t, value: y });
      }
      return points;
    };
    
    const wavePoints = generateWavePath();
    // üÜï v3.0.0: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ —Ç–æ—á–µ–∫
    if (!wavePoints || wavePoints.length === 0) return null;
    
    const pathD = wavePoints.map((p, i) => 
      `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`
    ).join(' ');
    const fillPathD = `${pathD} L ${padding.left + chartW} ${padding.top + chartH} L ${padding.left} ${padding.top + chartH} Z`;
    
    // üÜï v4.1.0: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–µ–π –¥–ª—è 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    const hasComponents = wavePoints[0]?.fastY !== undefined;
    let fastPathD = '', slowPathD = '', hepaticPathD = '';
    
    if (hasComponents) {
      fastPathD = wavePoints.map((p, i) => 
        `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.fastY.toFixed(1)}`
      ).join(' ');
      
      slowPathD = wavePoints.map((p, i) => 
        `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.slowY.toFixed(1)}`
      ).join(' ');
      
      hepaticPathD = wavePoints.map((p, i) => 
        `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.hepaticY.toFixed(1)}`
      ).join(' ');
    }
    
    const currentIdx = Math.round(progress * (wavePoints.length - 1));
    const currentPoint = wavePoints[Math.min(currentIdx, wavePoints.length - 1)];
    // üÜï v3.0.0: –ó–∞—â–∏—Ç–∞ –æ—Ç undefined currentPoint
    if (!currentPoint) return null;
    
    // üÜï v4.1.2: –ü–æ–∑–∏—Ü–∏–∏ –ø–∏–∫–æ–≤ –¥–ª—è 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ (—Å–Ω–æ—Å–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ)
    let fastPeak = null, slowPeak = null, hepaticPeak = null;
    if (hasComponents && wavePoints.length > 5) {
      let fastMinY = Infinity, slowMinY = Infinity, hepaticMinY = Infinity;
      wavePoints.forEach((p) => {
        // Fast peak: t ‚âà 0.15-0.25 (–±—ã—Å—Ç—Ä—ã–µ —É–≥–ª–µ–≤–æ–¥—ã)
        if (p.t >= 0.10 && p.t <= 0.35 && p.fastY < fastMinY) { 
          fastMinY = p.fastY; fastPeak = { x: p.x, y: p.y, t: p.t }; 
        }
        // Slow/Main peak: t ‚âà 0.40-0.50 (–æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç)
        if (p.t >= 0.30 && p.t <= 0.60 && p.slowY < slowMinY) { 
          slowMinY = p.slowY; slowPeak = { x: p.x, y: p.y, t: p.t }; 
        }
        // Hepatic peak: t ‚âà 0.65-0.75 (–ø–µ—á—ë–Ω–æ—á–Ω—ã–π —Ö–≤–æ—Å—Ç)
        if (p.t >= 0.55 && p.t <= 0.85 && p.hepaticY < hepaticMinY) { 
          hepaticMinY = p.hepaticY; hepaticPeak = { x: p.x, y: p.y, t: p.t }; 
        }
      });
    }
    
    // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –≤–æ–ª–Ω—ã
    const startTime = data.lastMealTimeDisplay || data.lastMealTime || '';
    const endTime = data.endTimeDisplay || data.endTime || '';
    
    return React.createElement('div', {
      style: {
        background: 'rgba(255,255,255,0.15)',
        borderRadius: '12px',
        padding: '8px',
        marginTop: '12px'
      }
    },
      React.createElement('svg', {
        width: '100%',
        height: height,
        viewBox: `0 0 ${width} ${height}`,
        style: { display: 'block' }
      },
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã
        React.createElement('defs', null,
          React.createElement('linearGradient', { id: 'waveGradientMain', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#fff', stopOpacity: 0.4 }),
            React.createElement('stop', { offset: '100%', stopColor: '#fff', stopOpacity: 0.1 })
          ),
          // üÜï v4.1.0: –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
          React.createElement('linearGradient', { id: 'waveGradientFast', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#f97316', stopOpacity: 0.5 }),
            React.createElement('stop', { offset: '100%', stopColor: '#f97316', stopOpacity: 0.1 })
          ),
          React.createElement('linearGradient', { id: 'waveGradientSlow', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#22c55e', stopOpacity: 0.5 }),
            React.createElement('stop', { offset: '100%', stopColor: '#22c55e', stopOpacity: 0.1 })
          ),
          React.createElement('linearGradient', { id: 'waveGradientHepatic', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#8b5cf6', stopOpacity: 0.5 }),
            React.createElement('stop', { offset: '100%', stopColor: '#8b5cf6', stopOpacity: 0.1 })
          )
        ),
        // –ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è
        React.createElement('line', {
          x1: padding.left, y1: padding.top + chartH,
          x2: padding.left + chartW, y2: padding.top + chartH,
          stroke: 'rgba(255,255,255,0.3)', strokeWidth: 1
        }),
        
        // === –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è –ù–ê–ß–ê–õ–ê (–≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏) ===
        React.createElement('line', {
          x1: padding.left, y1: padding.top - 5,
          x2: padding.left, y2: padding.top + chartH + 5,
          stroke: 'rgba(255,255,255,0.5)', strokeWidth: 1, strokeDasharray: '3,2'
        }),
        // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
        React.createElement('text', {
          x: padding.left, y: height - 2,
          fontSize: 9, fill: 'rgba(255,255,255,0.9)', textAnchor: 'middle', fontWeight: 500
        }, 'üçΩÔ∏è ' + startTime),
        
        // === –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è –ö–û–ù–¶–ê (–≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ–ª–Ω—ã) ===
        React.createElement('line', {
          x1: padding.left + chartW, y1: padding.top - 5,
          x2: padding.left + chartW, y2: padding.top + chartH + 5,
          stroke: 'rgba(255,255,255,0.5)', strokeWidth: 1, strokeDasharray: '3,2'
        }),
        // –í—Ä–µ–º—è –∫–æ–Ω—Ü–∞
        React.createElement('text', {
          x: padding.left + chartW, y: height - 2,
          fontSize: 9, fill: 'rgba(255,255,255,0.9)', textAnchor: 'middle', fontWeight: 500
        }, 'üî• ' + endTime),
        
        // –ó–∞–ª–∏–≤–∫–∞ –ø–æ–¥ –∫—Ä–∏–≤–æ–π (—Å—É–º–º–∞—Ä–Ω–∞—è)
        React.createElement('path', { d: fillPathD, fill: 'url(#waveGradientMain)' }),
        
        // === –û–î–ù–ê —Å—É–º–º–∞—Ä–Ω–∞—è –ª–∏–Ω–∏—è –≤–æ–ª–Ω—ã —Å 3 –ø–∏–∫–∞–º–∏ ===
        // (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ —Å—É–º–º–∞—Ä–Ω—É—é –∫—Ä–∏–≤—É—é ‚Äî 3 –ø–∏–∫–∞ –≤–∏–¥–Ω—ã –∫–∞–∫ "—Ö–æ–ª–º–∏–∫–∏")
        React.createElement('path', {
          d: pathD, fill: 'none', stroke: 'rgba(255,255,255,0.95)',
          strokeWidth: 2.5, strokeLinecap: 'round', strokeLinejoin: 'round'
        }),
        
        // üÜï v4.1.3: –ú–∞—Ä–∫–µ—Ä—ã –ø–∏–∫–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏)
        fastPeak && React.createElement('g', { key: 'fastPeak' },
          React.createElement('circle', {
            cx: fastPeak.x, cy: fastPeak.y, r: 6,
            fill: '#f97316', stroke: '#fff', strokeWidth: 1.5
          }),
          React.createElement('text', {
            x: fastPeak.x, y: fastPeak.y - 10,
            fontSize: 11, fill: '#f97316', textAnchor: 'middle', fontWeight: 700
          }, '‚ö°')
        ),
        slowPeak && React.createElement('g', { key: 'slowPeak' },
          React.createElement('circle', {
            cx: slowPeak.x, cy: slowPeak.y, r: 6,
            fill: '#22c55e', stroke: '#fff', strokeWidth: 1.5
          }),
          React.createElement('text', {
            x: slowPeak.x, y: slowPeak.y - 10,
            fontSize: 11, fill: '#22c55e', textAnchor: 'middle', fontWeight: 700
          }, 'üåø')
        ),
        hepaticPeak && React.createElement('g', { key: 'hepaticPeak' },
          React.createElement('circle', {
            cx: hepaticPeak.x, cy: hepaticPeak.y, r: 6,
            fill: '#8b5cf6', stroke: '#fff', strokeWidth: 1.5
          }),
          React.createElement('text', {
            x: hepaticPeak.x, y: hepaticPeak.y - 10,
            fontSize: 11, fill: '#8b5cf6', textAnchor: 'middle', fontWeight: 700
          }, 'ü´Ä')
        ),
        
        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
        React.createElement('line', {
          x1: currentPoint.x, y1: padding.top,
          x2: currentPoint.x, y2: padding.top + chartH,
          stroke: '#fff', strokeWidth: 1.5, strokeDasharray: '3,3'
        }),
        // –¢–æ—á–∫–∞ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
        React.createElement('circle', {
          cx: currentPoint.x, cy: currentPoint.y, r: 5,
          fill: '#fff', stroke: 'rgba(0,0,0,0.2)', strokeWidth: 1.5
        }),
        // –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫—Ä—É–≥
        React.createElement('circle', {
          cx: currentPoint.x, cy: currentPoint.y, r: 9,
          fill: 'none', stroke: '#fff', strokeWidth: 1, opacity: 0.5,
          style: { animation: 'pulse 2s ease-in-out infinite' }
        }),
        // –ü–æ–¥–ø–∏—Å—å "—Å–µ–π—á–∞—Å"
        React.createElement('text', {
          x: currentPoint.x, y: padding.top - 2,
          fontSize: 9, fill: '#fff', textAnchor: 'middle', fontWeight: 600
        }, '—Å–µ–π—á–∞—Å')
      )
    );
  };

  
  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.Graph = {
    renderWaveChart
  };
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_ndte.js ===== */
// heys_iw_ndte.js ‚Äî NDTE Badge UI Module
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å UI –¥–ª—è NDTE (Next-Day Training Effect) badge —Å countdown –∏ –∞–Ω–∏–º–∞—Ü–∏–µ–π.
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.
//
// –§–£–ù–ö–¶–ò–ò:
// - renderNDTEBadge() ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π badge —Å –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
// - Countdown —Ç–∞–π–º–µ—Ä –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞
// - Expandable —Å–µ–∫—Ü–∏—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
//
// –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞: EPOC (Excess Post-exercise Oxygen Consumption), 48-hour metabolic boost

(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  
  // === üî• NDTE BADGE ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π badge —Å countdown (v3.7.0) ===
  /**
   * –†–µ–Ω–¥–µ—Ä–∏—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π NDTE badge —Å –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π –∏ expand-—Å–µ–∫—Ü–∏–µ–π
   * @param {Object} ndteData - –¥–∞–Ω–Ω—ã–µ –∏–∑ calculateNDTE()
   * @param {number} ndteBoostKcal - –±–æ–Ω—É—Å –≤ –∫–∫–∞–ª
   * @param {boolean} expanded - —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –ª–∏ badge
   * @param {Function} onToggle - callback –ø—Ä–∏ –∫–ª–∏–∫–µ
   */
  const renderNDTEBadge = (ndteData, ndteBoostKcal, expanded, onToggle) => {
    if (!ndteData || !ndteData.active) return null;
    
    const boostPct = Math.round(ndteData.tdeeBoost * 100);
    const waveReductionPct = Math.round(ndteData.waveReduction * 100);
    const peakReductionPct = Math.round((ndteData.peakReduction || 0) * 100);
    
    // –†–∞—Å—á—ë—Ç –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞
    const hoursRemaining = Math.max(0, 48 - ndteData.hoursSince);
    const decayPct = ndteData.decayMultiplier ? Math.round(ndteData.decayMultiplier * 100) : 100;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    const formatTimeRemaining = (hours) => {
      if (hours <= 0) return '–∑–∞–≤–µ—Ä—à—ë–Ω';
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      if (h === 0) return `${m} –º–∏–Ω`;
      if (m === 0) return `${h}—á`;
      return `${h}—á ${m}–º`;
    };
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏
    const typeIcons = {
      cardio: 'üèÉ',
      strength: 'üèãÔ∏è',
      hobby: '‚öΩ'
    };
    const typeIcon = typeIcons[ndteData.trainingType] || 'üî•';
    
    return React.createElement('div', {
      style: { display: 'inline-block', marginLeft: '6px' }
    },
      // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π badge
      React.createElement('span', {
        className: 'ndte-badge ndte-badge--active',
        onClick: (e) => {
          e.stopPropagation();
          if (onToggle) onToggle();
        },
        style: {
          display: 'inline-flex',
          alignItems: 'center',
          gap: '4px'
        }
      },
        React.createElement('span', null, 'üî•'),
        React.createElement('span', null, `+${boostPct}%`),
        React.createElement('span', {
          style: {
            marginLeft: '2px',
            fontSize: '10px',
            opacity: 0.7,
            transition: 'transform 0.2s',
            transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)'
          }
        }, '‚ñº')
      ),
      
      // Expand —Å–µ–∫—Ü–∏—è
      expanded && React.createElement('div', { className: 'ndte-expand' },
        // Header
        React.createElement('div', { className: 'ndte-expand__header' },
          React.createElement('span', { className: 'ndte-expand__icon' }, 'üî•'),
          React.createElement('div', null,
            React.createElement('div', { className: 'ndte-expand__title' }, 'Next-Day Training Effect'),
            React.createElement('div', { className: 'ndte-expand__subtitle' }, 
              `${typeIcon} ${ndteData.trainingKcal} –∫–∫–∞–ª ‚Ä¢ ${ndteData.hoursSince} —á –Ω–∞–∑–∞–¥`
            )
          )
        ),
        
        // Stats grid
        React.createElement('div', { className: 'ndte-expand__stats' },
          // TDEE boost
          React.createElement('div', { className: 'ndte-expand__stat' },
            React.createElement('span', { className: 'ndte-expand__stat-icon' }, '‚ö°'),
            React.createElement('div', { className: 'ndte-expand__stat-content' },
              React.createElement('span', { className: 'ndte-expand__stat-value' }, `+${ndteBoostKcal} –∫–∫–∞–ª`),
              React.createElement('span', { className: 'ndte-expand__stat-label' }, '–∫ TDEE')
            )
          ),
          // Wave reduction
          React.createElement('div', { className: 'ndte-expand__stat' },
            React.createElement('span', { className: 'ndte-expand__stat-icon' }, 'üìâ'),
            React.createElement('div', { className: 'ndte-expand__stat-content' },
              React.createElement('span', { className: 'ndte-expand__stat-value' }, `-${waveReductionPct}%`),
              React.createElement('span', { className: 'ndte-expand__stat-label' }, '–≤–æ–ª–Ω–∞ –∫–æ—Ä–æ—á–µ')
            )
          ),
          // Peak reduction (–µ—Å–ª–∏ –µ—Å—Ç—å)
          peakReductionPct > 0 && React.createElement('div', { className: 'ndte-expand__stat' },
            React.createElement('span', { className: 'ndte-expand__stat-icon' }, 'üéØ'),
            React.createElement('div', { className: 'ndte-expand__stat-content' },
              React.createElement('span', { className: 'ndte-expand__stat-value' }, `-${peakReductionPct}%`),
              React.createElement('span', { className: 'ndte-expand__stat-label' }, '–ø–∏–∫ –∏–Ω—Å—É–ª–∏–Ω–∞')
            )
          ),
          // BMI multiplier (–µ—Å–ª–∏ –µ—Å—Ç—å)
          ndteData.bmiMultiplier && ndteData.bmiMultiplier !== 1 && React.createElement('div', { className: 'ndte-expand__stat' },
            React.createElement('span', { className: 'ndte-expand__stat-icon' }, 'üìä'),
            React.createElement('div', { className: 'ndte-expand__stat-content' },
              React.createElement('span', { className: 'ndte-expand__stat-value' }, `√ó${ndteData.bmiMultiplier.toFixed(1)}`),
              React.createElement('span', { className: 'ndte-expand__stat-label' }, 'BMI boost')
            )
          )
        ),
        
        // Decay progress bar
        React.createElement('div', { className: 'ndte-expand__decay' },
          React.createElement('div', { className: 'ndte-expand__decay-header' },
            React.createElement('span', { className: 'ndte-expand__decay-label' }, '–≠—Ñ—Ñ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω'),
            React.createElement('span', { className: 'ndte-expand__decay-time' }, 
              `‚è±Ô∏è –æ—Å—Ç–∞–ª–æ—Å—å ${formatTimeRemaining(hoursRemaining)}`
            )
          ),
          React.createElement('div', { className: 'ndte-expand__decay-bar' },
            React.createElement('div', { 
              className: 'ndte-expand__decay-fill',
              style: { width: `${decayPct}%` }
            })
          )
        )
      )
    );
  };
  
  
  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.NDTE = {
    renderNDTEBadge
  };
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_ui.js ===== */
// heys_iw_ui.js ‚Äî InsulinWave UI Components Module
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –ú–æ–¥—É–ª—å React UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã.
// –í—ã–¥–µ–ª–µ–Ω –∏–∑ heys_insulin_wave_v1.js –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏.
//
// –ö–û–ú–ü–û–ù–ï–ù–¢–´:
// - formatLipolysisTime() ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ª–∏–ø–æ–ª–∏–∑–∞
// - renderActivityContextBadge() ‚Äî –ø–ª–∞—à–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
// - MealWaveExpandSection ‚Äî —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞—è —Å–µ–∫—Ü–∏—è –≤–æ–ª–Ω—ã –ø—Ä–∏—ë–º–∞
// - ProgressBarComponent ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–π–º–µ—Ä–∞ —Å —Å–µ–∫—É–Ω–¥–∞–º–∏
// - renderProgressBar() ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –≤–æ–ª–Ω—ã
// - renderWaveHistory() ‚Äî –∏—Å—Ç–æ—Ä–∏—è –≤–æ–ª–Ω –∑–∞ –¥–µ–Ω—å
// - renderExpandedSection() ‚Äî expandable —Å–µ–∫—Ü–∏—è

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;

  // === –ò–ú–ü–û–†–¢ –£–¢–ò–õ–ò–¢ ===
  const utils = HEYS.InsulinWave?.utils;

  // === –ò–ú–ü–û–†–¢ –î–†–£–ì–ò–• –ú–û–î–£–õ–ï–ô ===
  const Graph = HEYS.InsulinWave?.Graph;
  const renderWaveChart = Graph?.renderWaveChart;
  const NDTE = HEYS.InsulinWave?.NDTE;
  const renderNDTEBadge = NDTE?.renderNDTEBadge;

  const formatLipolysisTime = (minutes) => {
    if (minutes < 60) return `${minutes} –º–∏–Ω`;
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    if (m === 0) return `${h}—á`;
    return `${h}—á ${m}–º`;
  };


  // === üèãÔ∏è HELPER: –ü–õ–ê–®–ö–ê ACTIVITY CONTEXT (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö) ===
  const renderActivityContextBadge = (activityContext, options = {}) => {
    if (!activityContext || activityContext.type === 'none') return null;

    const { compact = false } = options;

    // –¶–≤–µ—Ç–∞ –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≤—Å–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ ‚Äî –∑–µ–ª—ë–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏)
    const colors = {
      peri: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: 'üî•' },
      post: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: 'üí™' },
      pre: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: '‚ö°' },
      steps: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: 'üö∂' },
      morning: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: 'üåÖ' },
      double: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: 'üèÜ' },
      fasted: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: '‚ö°' },
      default: { bg: '#22c55e22', border: '#22c55e44', text: '#16a34a', icon: 'üèãÔ∏è' }
    };
    const c = colors[activityContext.type] || colors.default;

    // –ß–µ–ª–æ–≤–µ–∫–æ–ø–æ–Ω—è—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ —Ç–∏–ø—É
    const titles = {
      peri: '–ï–¥–∞ –í–û –í–†–ï–ú–Ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      post: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—Å–∫–æ—Ä–∏–ª–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º',
      pre: '–¢–æ–ø–ª–∏–≤–æ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      steps: '–ê–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å (10k+ —à–∞–≥–æ–≤)',
      morning: '–£—Ç—Ä–µ–Ω–Ω–∏–π –±—É—Å—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞',
      double: '–î–≤–æ–π–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
      fasted: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—Ç–æ—â–∞–∫'
    };
    const title = titles[activityContext.type] || '–≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏';

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –±–æ–Ω—É—Å –≤–æ–ª–Ω—ã
    const waveBonusPct = activityContext.waveBonus
      ? Math.abs(activityContext.waveBonus * 100).toFixed(0) + '% –±—ã—Å—Ç—Ä–µ–µ'
      : null;

    // –î–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const details = activityContext.details || {};
    let subtitle = '';

    if (activityContext.type === 'post' && details.trainingKcal) {
      // –ù–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ—Å–ª–µ 1331 –∫–∫–∞–ª ‚Ä¢ –≤–æ–ª–Ω–∞ ‚àí68%"
      subtitle = `–ü–æ—Å–ª–µ ${details.trainingKcal} –∫–∫–∞–ª`;
      if (details.gapMin) {
        subtitle += ` ‚Ä¢ ${details.gapMin} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      }
    } else if (activityContext.type === 'peri') {
      subtitle = '–ì–ª—é–∫–æ–∑–∞ ‚Üí —Å—Ä–∞–∑—É –≤ –º—ã—à—Ü—ã';
    } else if (activityContext.type === 'pre' && details.gapMin) {
      subtitle = `${details.gapMin} –º–∏–Ω –¥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏`;
    }

    return React.createElement('div', {
      className: 'activity-context-badge',
      style: {
        display: 'flex',
        alignItems: 'flex-start',
        gap: compact ? '8px' : '10px',
        padding: compact ? '8px 12px' : '10px 14px',
        marginBottom: '10px',
        borderRadius: '12px',
        background: c.bg,
        border: `1px solid ${c.border}`
      }
    },
      // –ò–∫–æ–Ω–∫–∞
      React.createElement('span', {
        style: {
          fontSize: compact ? '20px' : '24px',
          lineHeight: 1,
          marginTop: '2px'
        }
      }, c.icon),

      // –¢–µ–∫—Å—Ç
      React.createElement('div', { style: { flex: 1, minWidth: 0 } },
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        React.createElement('div', {
          style: {
            fontSize: compact ? '13px' : '14px',
            fontWeight: '600',
            color: c.text
          }
        }, title),
        // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
        subtitle && React.createElement('div', {
          style: {
            fontSize: '12px',
            color: '#64748b',
            marginTop: '2px'
          }
        }, subtitle)
      ),

      // –ë–µ–π–¥–∂–∏ —Å–ø—Ä–∞–≤–∞ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)
      React.createElement('div', {
        style: {
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'flex-end',
          gap: '4px',
          flexShrink: 0
        }
      },
        // –ë–æ–Ω—É—Å –≤–æ–ª–Ω—ã
        waveBonusPct && React.createElement('div', {
          style: {
            fontSize: '12px',
            fontWeight: '700',
            color: '#22c55e',
            background: '#22c55e22',
            padding: '4px 8px',
            borderRadius: '6px'
          }
        }, waveBonusPct),
        // –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–¥–∞
        activityContext.harmMultiplier && activityContext.harmMultiplier < 1 && React.createElement('div', {
          style: {
            fontSize: '11px',
            fontWeight: '600',
            color: '#3b82f6',
            background: '#3b82f622',
            padding: '4px 8px',
            borderRadius: '6px'
          }
        }, 'üõ°Ô∏è ‚àí' + Math.round((1 - activityContext.harmMultiplier) * 100) + '% –≤—Ä–µ–¥')
      )
    );
  };


  // === Meal Wave Expand (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏—ë–º–∞) ===
  function cardChipStyle(color) {
    return {
      background: color + '1A',
      color: '#0f172a',
      padding: '6px 8px',
      borderRadius: '8px',
      fontWeight: 600
    };
  }

  const MealWaveExpandSection = ({ waveData, prevWave, nextWave }) => {
    if (!waveData) return null;
    const normalize = utils.normalizeToHeysDay;

    // üÜï v3.7.1: State –¥–ª—è popup –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ª–Ω—ã
    const [showWaveDetails, setShowWaveDetails] = React.useState(false);

    // üÜï v3.4.0: Activity Context badge
    const activityContext = waveData.activityContext;

    // === –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–ª–Ω ===
    const waves = [];

    // –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º
    const currentStart = normalize(waveData.startMin);
    let currentEnd = normalize(waveData.endMin);
    if (currentEnd <= currentStart) currentEnd += 24 * 60;
    const currentGI = waveData.gi || 50;
    const currentDuration = waveData.duration || 180;

    waves.push({
      id: 'current',
      label: waveData.mealName || '–¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º',
      color: '#3b82f6',
      start: currentStart,
      end: currentEnd,
      gi: currentGI,
      duration: currentDuration,
      timeLabel: waveData.timeDisplay || waveData.time,
      endLabel: waveData.endTimeDisplay
    });

    // –ü—Ä–µ–¥—ã–¥—É—â–∏–π
    if (prevWave) {
      const s = normalize(prevWave.startMin);
      let e = normalize(prevWave.endMin);
      if (e <= s) e += 24 * 60;
      waves.push({
        id: 'prev',
        label: prevWave.mealName || '–ü—Ä–µ–¥—ã–¥—É—â–∏–π',
        color: '#3b82f6',
        start: s,
        end: e,
        gi: prevWave.gi || 50,
        duration: prevWave.duration || 180,
        timeLabel: prevWave.timeDisplay || prevWave.time,
        endLabel: prevWave.endTimeDisplay
      });
    }

    // –°–ª–µ–¥—É—é—â–∏–π
    if (nextWave) {
      const s = normalize(nextWave.startMin);
      let e = normalize(nextWave.endMin);
      if (e <= s) e += 24 * 60;
      waves.push({
        id: 'next',
        label: nextWave.mealName || '–°–ª–µ–¥—É—é—â–∏–π',
        color: '#f97316',
        start: s,
        end: e,
        gi: nextWave.gi || 50,
        duration: nextWave.duration || 180,
        timeLabel: nextWave.timeDisplay || nextWave.time,
        endLabel: nextWave.endTimeDisplay
      });
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
    waves.sort((a, b) => a.start - b.start);

    // === Overlaps ===
    const nextOverlap = nextWave && waveData.endMin > nextWave.startMin
      ? waveData.endMin - nextWave.startMin : 0;
    const prevOverlap = prevWave && prevWave.endMin > waveData.startMin
      ? prevWave.endMin - waveData.startMin : 0;
    const hasOverlap = (nextOverlap > 0) || (prevOverlap > 0);
    const lipolysisGap = nextWave ? Math.max(0, nextWave.startMin - waveData.endMin) : 0;

    // === SVG —Ä–∞–∑–º–µ—Ä—ã ===
    const width = 320;
    const height = 120;
    const padding = { left: 20, right: 20, top: 18, bottom: 28 };
    const chartW = width - padding.left - padding.right;
    const chartH = height - padding.top - padding.bottom;

    // –ú–∞—Å—à—Ç–∞–± –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    const startMin = Math.min(...waves.map(w => w.start));
    const endMax = Math.max(...waves.map(w => w.end));
    const range = Math.max(1, endMax - startMin);
    const scaleX = (v) => padding.left + (v - startMin) / range * chartW;

    // === –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–æ—Ä–º—ã –≤–æ–ª–Ω—ã ‚Äî 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è Gaussian –º–æ–¥–µ–ª—å (v4.1.2) ===
    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Fast (–ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª), Slow (–æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç), Hepatic (–ø–µ—á—ë–Ω–æ—á–Ω—ã–π —Ö–≤–æ—Å—Ç)
    const generateWavePath = (wave, baseY) => {
      const waveWidth = (wave.end - wave.start) / range * chartW;
      const waveStartX = scaleX(wave.start);
      const gi = wave.gi || 50;

      // === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ GI (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è calculateComponentParams) ===
      // Base values from WAVE_SHAPE_V2
      const baseFast = { peak: 0.20, sigma: 0.12, amplitude: 0.60 };
      const baseSlow = { peak: 0.45, sigma: 0.25, amplitude: 0.35 };
      const baseHepatic = { peak: 0.70, sigma: 0.35, amplitude: 0.05 };

      // GI-based modifiers (gi > 70 = faster peak, gi < 40 = slower response)
      const giHighMod = gi >= 70 ? 1.3 : 1.0;  // High GI ‚Üí stronger fast component
      const giLowMod = gi <= 40 ? 1.4 : 1.0;   // Low GI ‚Üí stronger slow component

      const fastAmp = baseFast.amplitude * giHighMod;
      const slowAmp = baseSlow.amplitude * giLowMod;
      const hepaticAmp = baseHepatic.amplitude;

      // Gaussian component function
      const gaussian = (t, peak, sigma, amplitude) => {
        return amplitude * Math.exp(-Math.pow(t - peak, 2) / (2 * sigma * sigma));
      };

      // Height scaling based on duration
      const peakHeight = Math.min(1, 0.5 + (wave.duration / 300) * 0.4);

      const points = [];
      const steps = 50; // More points for smoother curve

      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        // Sum of 3 Gaussian components
        const fast = gaussian(t, baseFast.peak, baseFast.sigma, fastAmp);
        const slow = gaussian(t, baseSlow.peak, baseSlow.sigma, slowAmp);
        const hepatic = gaussian(t, baseHepatic.peak, baseHepatic.sigma, hepaticAmp);

        // Normalize sum (max ~1.0) and apply height
        const rawSum = fast + slow + hepatic;
        const normalizedSum = rawSum / (fastAmp + slowAmp + hepaticAmp); // Normalize to 0-1
        const y = normalizedSum * peakHeight;

        const x = waveStartX + t * waveWidth;
        const yPx = baseY - y * (chartH * 0.8);
        points.push({ x, y: yPx, t, value: y });
      }
      return points;
    };

    // –ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞)
    const baseY = padding.top + chartH;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –≤–æ–ª–Ω
    const wavePaths = waves.map(wave => {
      const points = generateWavePath(wave, baseY);
      const pathD = points.map((p, i) =>
        `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`
      ).join(' ');
      const fillPathD = `${pathD} L ${scaleX(wave.end)} ${baseY} L ${scaleX(wave.start)} ${baseY} Z`;
      return { wave, points, pathD, fillPathD };
    });

    // === –ó–æ–Ω—ã –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ (overlap) ‚Äî –∫—Ä–∞—Å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ ===
    const overlapZones = [];
    for (let i = 0; i < waves.length - 1; i++) {
      const w1 = waves[i];
      const w2 = waves[i + 1];
      if (w1.end > w2.start) {
        // –ï—Å—Ç—å –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç
        overlapZones.push({
          start: w2.start,
          end: Math.min(w1.end, w2.end),
          minutes: Math.round(w1.end - w2.start)
        });
      }
    }

    // === –ó–æ–Ω–∞ –ª–∏–ø–æ–ª–∏–∑–∞ (–∑–µ–ª—ë–Ω–∞—è) ===
    const lipolysisZones = [];
    for (let i = 0; i < waves.length - 1; i++) {
      const w1 = waves[i];
      const w2 = waves[i + 1];
      if (w1.end < w2.start) {
        lipolysisZones.push({
          start: w1.end,
          end: w2.start,
          minutes: Math.round(w2.start - w1.end)
        });
      }
    }

    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ñ–æ–Ω–∞
    const bgGradient = hasOverlap
      ? 'linear-gradient(135deg, rgba(254,226,226,0.5) 0%, rgba(254,202,202,0.3) 100%)'
      : 'linear-gradient(135deg, rgba(236,253,245,0.5) 0%, rgba(209,250,229,0.3) 100%)';

    return React.createElement('div', {
      className: 'meal-wave-content',
      style: {
        padding: '0 12px 12px 12px'
      }
    },
      // üÜï v3.5.3: Activity Context badge (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π helper)
      activityContext && renderActivityContextBadge(activityContext, { compact: false }),
      // === SVG –ì–†–ê–§–ò–ö ===
      React.createElement('svg', {
        width: '100%',
        height,
        viewBox: `0 0 ${width} ${height}`,
        style: { display: 'block' }
      },
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã
        React.createElement('defs', null,
          // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–æ–ª–Ω—ã
          React.createElement('linearGradient', { id: 'waveGradCurrent', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#3b82f6', stopOpacity: 0.7 }),
            React.createElement('stop', { offset: '100%', stopColor: '#3b82f6', stopOpacity: 0.1 })
          ),
          // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–æ–ª–Ω—ã
          React.createElement('linearGradient', { id: 'waveGradPrev', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#3b82f6', stopOpacity: 0.5 }),
            React.createElement('stop', { offset: '100%', stopColor: '#3b82f6', stopOpacity: 0.05 })
          ),
          // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –≤–æ–ª–Ω—ã
          React.createElement('linearGradient', { id: 'waveGradNext', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#f97316', stopOpacity: 0.6 }),
            React.createElement('stop', { offset: '100%', stopColor: '#f97316', stopOpacity: 0.1 })
          ),
          // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è overlap
          React.createElement('linearGradient', { id: 'overlapGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#ef4444', stopOpacity: 0.5 }),
            React.createElement('stop', { offset: '100%', stopColor: '#ef4444', stopOpacity: 0.2 })
          ),
          // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ª–∏–ø–æ–ª–∏–∑–∞
          React.createElement('linearGradient', { id: 'lipolysisGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#22c55e', stopOpacity: 0.4 }),
            React.createElement('stop', { offset: '100%', stopColor: '#22c55e', stopOpacity: 0.1 })
          )
        ),

        // –ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è
        React.createElement('line', {
          x1: padding.left,
          y1: baseY,
          x2: padding.left + chartW,
          y2: baseY,
          stroke: '#cbd5e1',
          strokeWidth: 1.5
        }),

        // === –ó–æ–Ω—ã –ª–∏–ø–æ–ª–∏–∑–∞ (–∑–µ–ª—ë–Ω—ã–µ) ===
        lipolysisZones.map((zone, i) => React.createElement('g', { key: 'lipo-' + i },
          React.createElement('rect', {
            x: scaleX(zone.start),
            y: padding.top,
            width: Math.max(4, (zone.end - zone.start) / range * chartW),
            height: chartH,
            fill: 'url(#lipolysisGrad)'
          }),
          // –ò–∫–æ–Ω–∫–∞ –æ–≥–Ω—è –≤ —Ü–µ–Ω—Ç—Ä–µ
          React.createElement('text', {
            x: scaleX(zone.start) + (zone.end - zone.start) / range * chartW / 2,
            y: padding.top + chartH / 2 + 4,
            fontSize: 14,
            textAnchor: 'middle',
            fill: '#22c55e'
          }, 'üî•')
        )),

        // === –ó–æ–Ω—ã –ø–µ—Ä–µ—Ö–ª—ë—Å—Ç–∞ (–∫—Ä–∞—Å–Ω—ã–µ) ===
        overlapZones.map((zone, i) => React.createElement('g', { key: 'ovl-' + i },
          React.createElement('rect', {
            x: scaleX(zone.start),
            y: padding.top,
            width: Math.max(4, (zone.end - zone.start) / range * chartW),
            height: chartH,
            fill: 'url(#overlapGrad)'
          }),
          // –®—Ç—Ä–∏—Ö–æ–≤–∫–∞
          React.createElement('pattern', {
            id: 'hatch-' + i,
            patternUnits: 'userSpaceOnUse',
            width: 6,
            height: 6,
            patternTransform: 'rotate(45)'
          },
            React.createElement('line', { x1: 0, y1: 0, x2: 0, y2: 6, stroke: '#ef4444', strokeWidth: 1.5, strokeOpacity: 0.3 })
          ),
          React.createElement('rect', {
            x: scaleX(zone.start),
            y: padding.top,
            width: Math.max(4, (zone.end - zone.start) / range * chartW),
            height: chartH,
            fill: 'url(#hatch-' + i + ')'
          }),
          // –ò–∫–æ–Ω–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
          React.createElement('text', {
            x: scaleX(zone.start) + (zone.end - zone.start) / range * chartW / 2,
            y: padding.top + chartH / 2 + 4,
            fontSize: 14,
            textAnchor: 'middle',
            fill: '#ef4444'
          }, '‚ö†Ô∏è')
        )),

        // === –í–æ–ª–Ω—ã (–∫—Ä–∏–≤—ã–µ) ===
        wavePaths.map(({ wave, pathD, fillPathD }, idx) => {
          const gradId = wave.id === 'current' ? 'waveGradCurrent' :
            wave.id === 'prev' ? 'waveGradPrev' : 'waveGradNext';
          const zIndex = wave.id === 'current' ? 3 : wave.id === 'next' ? 2 : 1;
          return React.createElement('g', { key: 'wave-' + wave.id, style: { zIndex } },
            // –ó–∞–ª–∏–≤–∫–∞
            React.createElement('path', {
              d: fillPathD,
              fill: 'url(#' + gradId + ')'
            }),
            // –õ–∏–Ω–∏—è –∫—Ä–∏–≤–æ–π
            React.createElement('path', {
              d: pathD,
              fill: 'none',
              stroke: wave.color,
              strokeWidth: wave.id === 'current' ? 2.5 : 1.5,
              strokeLinecap: 'round',
              strokeLinejoin: 'round',
              opacity: wave.id === 'current' ? 1 : 0.7
            })
          );
        }),

        // === –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ –≤—Ä–µ–º—ë–Ω –ø—Ä–∏—ë–º–æ–≤ ===
        waves.map(wave => React.createElement('line', {
          key: 'vline-' + wave.id,
          x1: scaleX(wave.start),
          y1: padding.top - 4,
          x2: scaleX(wave.start),
          y2: baseY + 4,
          stroke: wave.color,
          strokeWidth: 1,
          strokeDasharray: '3,2',
          opacity: 0.6
        })),

        // === –ú–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∏–∑—É (—Å –¥–µ—Ç–µ–∫—Ü–∏–µ–π –∫–æ–ª–ª–∏–∑–∏–π) ===
        (() => {
          // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –º–µ—Ç–∫–∏: –Ω–∞—á–∞–ª–∞ –≤–æ–ª–Ω + –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π
          const currentWave = waves.find(w => w.id === 'current');
          const allLabels = [];

          // –ú–µ—Ç–∫–∏ –Ω–∞—á–∞–ª–∞ –≤–æ–ª–Ω
          waves.forEach((wave) => {
            allLabels.push({
              id: 'start-' + wave.id,
              x: scaleX(wave.start),
              time: wave.start,
              text: (wave.id === 'current' ? 'üçΩÔ∏è' : 'üçΩÔ∏è') + wave.timeLabel,
              color: wave.color,
              weight: wave.id === 'current' ? 600 : 500
            });
          });

          // –ú–µ—Ç–∫–∞ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–π –≤–æ–ª–Ω—ã
          allLabels.push({
            id: 'end-current',
            x: scaleX(currentWave.end),
            time: currentWave.end,
            text: (lipolysisGap > 0 ? 'üî•' : '‚ö†Ô∏è') + (waveData.endTimeDisplay || ''),
            color: lipolysisGap > 0 ? '#22c55e' : '#ef4444',
            weight: 600
          });

          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
          allLabels.sort((a, b) => a.time - b.time);

          // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∫–∞–∂–¥–æ–π –º–µ—Ç–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ 7px –Ω–∞ —Å–∏–º–≤–æ–ª)
          const charWidth = 6;
          allLabels.forEach(label => {
            label.width = label.text.length * charWidth;
          });

          // –†–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ ‚Äî —Å–¥–≤–∏–≥–∞–µ–º –º–µ—Ç–∫–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
          const minGap = 4; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –º–µ—Ç–∫–∞–º–∏
          const adjustedX = allLabels.map(l => l.x);

          for (let i = 1; i < allLabels.length; i++) {
            const prevRight = adjustedX[i - 1] + allLabels[i - 1].width / 2;
            const currLeft = adjustedX[i] - allLabels[i].width / 2;
            const overlap = prevRight + minGap - currLeft;

            if (overlap > 0) {
              // –°–¥–≤–∏–≥–∞–µ–º –æ–±–µ –º–µ—Ç–∫–∏ –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
              adjustedX[i - 1] -= overlap / 2;
              adjustedX[i] += overlap / 2;
            }
          }

          // –†–µ–Ω–¥–µ—Ä–∏–º –º–µ—Ç–∫–∏
          return allLabels.map((label, i) =>
            React.createElement('text', {
              key: label.id,
              x: adjustedX[i],
              y: height - 6,
              fontSize: 10,
              fill: label.color,
              textAnchor: 'middle',
              fontWeight: label.weight
            }, label.text)
          );
        })(),

        // === –õ–µ–≥–µ–Ω–¥–∞ (–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ª–Ω) ===
        waves.length > 1 && React.createElement('g', null,
          waves.map((wave, idx) => {
            const legendX = padding.left + idx * 90;
            const legendY = padding.top - 8;
            return React.createElement('g', { key: 'leg-' + wave.id },
              React.createElement('circle', { cx: legendX, cy: legendY, r: 4, fill: wave.color }),
              React.createElement('text', {
                x: legendX + 8,
                y: legendY + 3,
                fontSize: 9,
                fill: '#64748b'
              }, wave.label)
            );
          })
        )
      ),

      // üÜï v3.7.1: Popup –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ª–Ω—ã
      showWaveDetails && React.createElement('div', {
        className: 'wave-details-overlay',
        onClick: (e) => { if (e.target === e.currentTarget) setShowWaveDetails(false); },
        style: {
          position: 'fixed',
          top: 0, left: 0, right: 0, bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          zIndex: 9999,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px'
        }
      },
        React.createElement('div', {
          className: 'wave-details-popup',
          style: {
            background: 'var(--card, #fff)',
            borderRadius: '16px',
            padding: '20px',
            maxWidth: '360px',
            width: '100%',
            maxHeight: '80vh',
            overflowY: 'auto',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }
        },
          // –ó–∞–≥–æ–ª–æ–≤–æ–∫
          React.createElement('div', {
            style: {
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '16px'
            }
          },
            React.createElement('h3', {
              style: { margin: 0, fontSize: '16px', fontWeight: 600, color: 'var(--text, #1f2937)' }
            }, 'üìä –†–∞—Å—á—ë—Ç –≤–æ–ª–Ω—ã'),
            React.createElement('button', {
              onClick: () => setShowWaveDetails(false),
              style: {
                background: 'none', border: 'none', fontSize: '20px',
                cursor: 'pointer', color: '#9ca3af', padding: '4px'
              }
            }, '√ó')
          ),

          // –ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã
          React.createElement('div', {
            style: {
              background: 'linear-gradient(135deg, #3b82f6, #3b82f6)',
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '16px',
              textAlign: 'center',
              color: '#fff'
            }
          },
            React.createElement('div', { style: { fontSize: '12px', opacity: 0.9, marginBottom: '4px' } },
              '–î–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã'
            ),
            React.createElement('div', { style: { fontSize: '28px', fontWeight: 700 } },
              (waveData.waveHours || waveData.duration / 60).toFixed(1) + '—á'
            ),
            React.createElement('div', { style: { fontSize: '11px', opacity: 0.8, marginTop: '4px' } },
              waveData.timeDisplay + ' ‚Üí ' + waveData.endTimeDisplay
            )
          ),

          // –§–æ—Ä–º—É–ª–∞
          React.createElement('div', {
            style: {
              background: 'var(--bg-secondary, #f8fafc)',
              borderRadius: '10px',
              padding: '12px',
              marginBottom: '16px',
              fontSize: '11px',
              fontFamily: 'monospace',
              color: '#64748b',
              textAlign: 'center'
            }
          }, '–ë–∞–∑–∞ √ó –ú–Ω–æ–∂–∏—Ç–µ–ª—å = ' + (waveData.baseWaveHours || 3).toFixed(1) + '—á √ó ' +
          (waveData.finalMultiplier || 1).toFixed(2) + ' = ' +
          (waveData.waveHours || waveData.duration / 60).toFixed(1) + '—á'
          ),

          // üÜï v4.1.0: –õ–µ–≥–µ–Ω–¥–∞ 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–π Gaussian –º–æ–¥–µ–ª–∏
          React.createElement('div', {
            style: {
              background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
              borderRadius: '10px',
              padding: '12px',
              marginBottom: '16px'
            }
          },
            React.createElement('div', {
              style: { fontSize: '12px', fontWeight: 600, color: '#92400e', marginBottom: '8px' }
            }, 'üß¨ –ù–∞—É—á–Ω–∞—è –º–æ–¥–µ–ª—å –≤–æ–ª–Ω—ã'),
            React.createElement('div', {
              style: { fontSize: '11px', color: '#78350f', lineHeight: '1.5' }
            },
              '–§–æ—Ä–º–∞ –∫—Ä–∏–≤–æ–π = —Å—É–º–º–∞ 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:'
            ),
            React.createElement('div', { style: { marginTop: '8px', display: 'flex', flexDirection: 'column', gap: '6px' } },
              // Fast component
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                React.createElement('span', { style: { fontSize: '14px' } }, '‚ö°'),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '11px', fontWeight: 600, color: '#f97316' } },
                    '–ë—ã—Å—Ç—Ä—ã–π –ø–∏–∫ (15-25 –º–∏–Ω)'
                  ),
                  React.createElement('div', { style: { fontSize: '10px', color: '#78350f' } },
                    '–ü—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã, –ì–ò>70'
                  )
                )
              ),
              // Slow component
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                React.createElement('span', { style: { fontSize: '14px' } }, 'üåø'),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '11px', fontWeight: 600, color: '#22c55e' } },
                    '–û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç (45-60 –º–∏–Ω)'
                  ),
                  React.createElement('div', { style: { fontSize: '10px', color: '#78350f' } },
                    '–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã, –±–µ–ª–æ–∫, –∂–∏—Ä—ã'
                  )
                )
              ),
              // Hepatic component
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                React.createElement('span', { style: { fontSize: '14px' } }, 'ü´Ä'),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '11px', fontWeight: 600, color: '#8b5cf6' } },
                    '–ü–µ—á—ë–Ω–æ—á–Ω—ã–π —Ö–≤–æ—Å—Ç (90-120 –º–∏–Ω)'
                  ),
                  React.createElement('div', { style: { fontSize: '10px', color: '#78350f' } },
                    '–ö–ª–µ—Ç—á–∞—Ç–∫–∞, –º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—ã—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ'
                  )
                )
              )
            ),
            // –ù–∞—É—á–Ω–∞—è —Å—Å—ã–ª–∫–∞
            React.createElement('div', {
              style: {
                marginTop: '10px',
                paddingTop: '8px',
                borderTop: '1px solid rgba(146, 64, 14, 0.2)',
                fontSize: '10px',
                color: '#92400e'
              }
            }, 'üìö Brand-Miller 2003, Holt 1997')
          ),

          // –§–∞–∫—Ç–æ—Ä—ã –µ–¥—ã
          React.createElement('div', { style: { marginBottom: '12px' } },
            React.createElement('div', {
              style: { fontSize: '12px', fontWeight: 600, color: 'var(--text, #1f2937)', marginBottom: '8px' }
            }, 'üçΩÔ∏è –§–∞–∫—Ç–æ—Ä—ã –µ–¥—ã'),

            // GI
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–ì–ò'),
              React.createElement('span', { style: { fontWeight: 500 } }, Math.round(waveData.gi || 0))
            ),
            // GL
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, 'GL (–Ω–∞–≥—Ä—É–∑–∫–∞)'),
              React.createElement('span', { style: { fontWeight: 500, color: waveData.gl < 10 ? '#22c55e' : waveData.gl > 20 ? '#ef4444' : '#1f2937' } },
                (waveData.gl || 0).toFixed(1) + (waveData.glCategory?.desc ? ' (' + waveData.glCategory.desc + ')' : '')
              )
            ),
            // –ë–µ–ª–æ–∫
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–ë–µ–ª–æ–∫'),
              React.createElement('span', { style: { fontWeight: 500 } }, Math.round(waveData.protein || 0) + '–≥')
            ),
            // –ö–ª–µ—Ç—á–∞—Ç–∫–∞
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–ö–ª–µ—Ç—á–∞—Ç–∫–∞'),
              React.createElement('span', { style: { fontWeight: 500, color: waveData.fiber >= 5 ? '#22c55e' : '#1f2937' } },
                Math.round(waveData.fiber || 0) + '–≥'
              )
            ),
            // –ñ–∏—Ä—ã
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–ñ–∏—Ä—ã'),
              React.createElement('span', { style: { fontWeight: 500 } }, Math.round(waveData.fat || 0) + '–≥')
            ),
            // –£–≥–ª–µ–≤–æ–¥—ã
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–£–≥–ª–µ–≤–æ–¥—ã'),
              React.createElement('span', { style: { fontWeight: 500 } }, Math.round(waveData.carbs || 0) + '–≥')
            ),
            // –ñ–∏–¥–∫–∞—è –µ–¥–∞
            waveData.hasLiquid && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#f97316' } }, 'ü•§ –ñ–∏–¥–∫–∞—è –µ–¥–∞'),
              React.createElement('span', { style: { fontWeight: 500, color: '#f97316' } }, '√ó' + (waveData.liquidMultiplier || 0.75).toFixed(2))
            ),
            // –ò–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å
            waveData.insulinogenicType && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, 'ü•õ –ò–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å'),
              React.createElement('span', { style: { fontWeight: 500 } }, waveData.insulinogenicType)
            )
          ),

          // –î–Ω–µ–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
          React.createElement('div', { style: { marginBottom: '12px' } },
            React.createElement('div', {
              style: { fontSize: '12px', fontWeight: 600, color: 'var(--text, #1f2937)', marginBottom: '8px' }
            }, '‚è∞ –î–Ω–µ–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã'),

            // –¶–∏—Ä–∫–∞–¥–Ω—ã–π —Ä–∏—Ç–º
            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–í—Ä–µ–º—è —Å—É—Ç–æ–∫'),
              React.createElement('span', { style: { fontWeight: 500, color: waveData.circadianMultiplier > 1.05 ? '#f97316' : '#1f2937' } },
                '√ó' + (waveData.circadianMultiplier || 1).toFixed(2)
              )
            ),
            // –î–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã
            waveData.dayFactorsBonus && Math.abs(waveData.dayFactorsBonus) >= 0.005 && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#64748b' } }, '–°–æ–Ω/—Å—Ç—Ä–µ—Å—Å/–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è'),
              React.createElement('span', { style: { fontWeight: 500, color: waveData.dayFactorsBonus > 0 ? '#ef4444' : '#22c55e' } },
                (waveData.dayFactorsBonus > 0 ? '+' : '') + (waveData.dayFactorsBonus * 100).toFixed(0) + '%'
              )
            ),
            // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            waveData.activityBonus && Math.abs(waveData.activityBonus) >= 0.005 && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#22c55e' } }, 'üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'),
              React.createElement('span', { style: { fontWeight: 500, color: '#22c55e' } },
                (waveData.activityBonus * 100).toFixed(0) + '%'
              )
            ),
            // üÜï v3.7.1: NDTE (Next-Day Training Effect)
            waveData.ndteData && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0', borderBottom: '1px solid #f1f5f9' } },
              React.createElement('span', { style: { color: '#10b981' } }, 'üî• –í—á–µ—Ä–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'),
              React.createElement('span', { style: { fontWeight: 500, color: '#10b981' } },
                '-' + Math.round(waveData.ndteData.waveReduction * 100) + '%'
              )
            )
          ),

          // Activity Context (–µ—Å–ª–∏ –µ—Å—Ç—å)
          activityContext && activityContext.type !== 'none' && React.createElement('div', {
            style: {
              marginBottom: '12px',
              background: 'rgba(16, 185, 129, 0.1)',
              borderRadius: '10px',
              padding: '12px'
            }
          },
            React.createElement('div', {
              style: { fontSize: '12px', fontWeight: 600, color: '#10b981', marginBottom: '6px' }
            }, activityContext.badge),
            React.createElement('div', {
              style: { fontSize: '11px', color: '#64748b' }
            }, activityContext.desc),
            activityContext.waveBonus && React.createElement('div', {
              style: { fontSize: '11px', color: '#10b981', marginTop: '4px', fontWeight: 500 }
            }, '–í–æ–ª–Ω–∞: ' + (activityContext.waveBonus * 100).toFixed(0) + '%')
          ),

          // GL Scale info
          waveData.dayFactorsScale && waveData.dayFactorsScale < 1 && React.createElement('div', {
            style: {
              background: '#f0fdf4',
              borderRadius: '8px',
              padding: '10px',
              fontSize: '11px',
              color: '#166534',
              marginBottom: '12px'
            }
          },
            'üí° –ü—Ä–∏ –Ω–∏–∑–∫–æ–π GL (' + (waveData.gl || 0).toFixed(1) + ') –¥–Ω–µ–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ ' +
            Math.round((waveData.dayFactorsScale || 1) * 100) + '%'
          ),

          // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
          React.createElement('button', {
            onClick: () => setShowWaveDetails(false),
            style: {
              width: '100%',
              background: '#3b82f6',
              color: '#fff',
              border: 'none',
              borderRadius: '10px',
              padding: '12px',
              fontSize: '14px',
              fontWeight: 600,
              cursor: 'pointer',
              marginTop: '8px'
            }
          }, '–ó–∞–∫—Ä—ã—Ç—å')
        )
      )
    );
  };

  /**
   * –†–µ–Ω–¥–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤–æ–ª–Ω—ã
   * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–π–º–µ—Ä–∞ —Å —Å–µ–∫—É–Ω–¥–∞–º–∏
   */
  const ProgressBarComponent = ({ data }) => {
    const isLipolysis = data.status === 'lipolysis';
    const lipolysisMinutes = data.lipolysisMinutes || 0;
    const remainingMinutes = data.remaining || 0;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–µ–∫—É–Ω–¥ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
    const [seconds, setSeconds] = React.useState(() => {
      const now = new Date();
      return 60 - now.getSeconds();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∫—É–Ω–¥ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    React.useEffect(() => {
      if (isLipolysis) return; // –ü—Ä–∏ –ª–∏–ø–æ–ª–∏–∑–µ –Ω–µ –Ω—É–∂–µ–Ω countdown

      const interval = setInterval(() => {
        const now = new Date();
        setSeconds(60 - now.getSeconds());
      }, 1000);

      return () => clearInterval(interval);
    }, [isLipolysis]);

    // –ü—Ä–∏ –ª–∏–ø–æ–ª–∏–∑–µ ‚Äî –∑–µ–ª—ë–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
    const lipolysisGradient = 'linear-gradient(135deg, #22c55e 0%, #10b981 50%, #059669 100%)';

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
    const formatCountdown = (mins, secs) => {
      if (mins <= 0) return { h: '00', m: '00', s: '00' };
      const totalSecs = Math.max(0, Math.floor(mins * 60) - (60 - secs));
      const h = Math.floor(totalSecs / 3600);
      const m = Math.floor((totalSecs % 3600) / 60);
      const s = totalSecs % 60;
      return {
        h: String(h).padStart(2, '0'),
        m: String(m).padStart(2, '0'),
        s: String(s).padStart(2, '0')
      };
    };

    const countdown = formatCountdown(remainingMinutes, seconds);

    // –ü—Ä–∏ –ª–∏–ø–æ–ª–∏–∑–µ: –±–æ–ª—å—à–æ–π –∑–µ–ª—ë–Ω—ã–π –±–ª–æ–∫ —Å —Ç–∞–π–º–µ—Ä–æ–º –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è
    if (isLipolysis) {
      return React.createElement('div', {
        style: {
          background: lipolysisGradient,
          borderRadius: '16px',
          padding: '20px',
          textAlign: 'center',
          marginTop: '8px',
          boxShadow: '0 4px 12px rgba(34, 197, 94, 0.3)'
        }
      },
        React.createElement('div', {
          style: { fontSize: '13px', color: 'rgba(255,255,255,0.9)', marginBottom: '8px', fontWeight: '500' }
        }, 'üî• –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ'),
        React.createElement('div', {
          style: {
            fontSize: '36px',
            fontWeight: '800',
            color: '#fff',
            fontVariantNumeric: 'tabular-nums',
            letterSpacing: '2px',
            textShadow: '0 2px 8px rgba(0,0,0,0.2)'
          }
        }, formatLipolysisTime(lipolysisMinutes)),
        // –ü–ª–∞—à–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É—Å–∫–æ—Ä–∏–ª –≤—ã—Ö–æ–¥ –≤ –ª–∏–ø–æ–ª–∏–∑)
        data.activityContext && React.createElement('div', { style: { marginTop: '12px' } },
          renderActivityContextBadge(data.activityContext, { compact: true, showDesc: false })
        )
      );
    }

    // –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–æ–ª–Ω–µ: –±–æ–ª—å—à–æ–π —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
    return React.createElement(React.Fragment, null,
      // –ü–ª–∞—à–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –ü–û–î —Ç–∞–π–º–µ—Ä–æ–º
      data.activityContext && data.activityContext.type !== 'none' && renderActivityContextBadge(data.activityContext, { compact: false, showDesc: true }),
      // –°–∏–Ω–∏–π –±–ª–æ–∫ —Å —Ç–∞–π–º–µ—Ä–æ–º
      React.createElement('div', {
        style: {
          background: 'linear-gradient(135deg, #3b82f6 0%, #3b82f6 50%, #3b82f6 100%)',
          borderRadius: '16px',
          padding: '20px',
          textAlign: 'center',
          marginTop: '8px',
          boxShadow: '0 4px 12px rgba(59, 130, 246, 0.3)'
        }
      },
        React.createElement('div', {
          style: { fontSize: '13px', color: 'rgba(255,255,255,0.9)', marginBottom: '8px', fontWeight: '500' }
        }, '‚è± –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑'),
        // –ë–æ–ª—å—à–∏–µ —Ü–∏—Ñ—Ä—ã —Ç–∞–π–º–µ—Ä–∞
        React.createElement('div', {
          style: {
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'baseline',
            gap: '4px',
            fontVariantNumeric: 'tabular-nums'
          }
        },
          // –ß–∞—Å—ã
          React.createElement('span', {
            style: { fontSize: '42px', fontWeight: '800', color: '#fff', textShadow: '0 2px 8px rgba(0,0,0,0.2)' }
          }, countdown.h),
          React.createElement('span', {
            style: { fontSize: '24px', fontWeight: '600', color: 'rgba(255,255,255,0.7)', marginRight: '8px' }
          }, ':'),
          // –ú–∏–Ω—É—Ç—ã
          React.createElement('span', {
            style: { fontSize: '42px', fontWeight: '800', color: '#fff', textShadow: '0 2px 8px rgba(0,0,0,0.2)' }
          }, countdown.m),
          React.createElement('span', {
            style: { fontSize: '24px', fontWeight: '600', color: 'rgba(255,255,255,0.7)', marginRight: '8px' }
          }, ':'),
          // –°–µ–∫—É–Ω–¥—ã
          React.createElement('span', {
            style: { fontSize: '42px', fontWeight: '800', color: '#fff', textShadow: '0 2px 8px rgba(0,0,0,0.2)' }
          }, countdown.s)
        ),
        // –ü–æ–¥–ø–∏—Å–∏
        React.createElement('div', {
          style: {
            display: 'flex',
            justifyContent: 'center',
            gap: '24px',
            marginTop: '4px',
            fontSize: '11px',
            color: 'rgba(255,255,255,0.7)',
            fontWeight: '500'
          }
        },
          React.createElement('span', null, '—á–∞—Å–æ–≤'),
          React.createElement('span', null, '–º–∏–Ω—É—Ç'),
          React.createElement('span', null, '—Å–µ–∫—É–Ω–¥')
        ),
        // –ì—Ä–∞—Ñ–∏–∫ –≤–æ–ª–Ω—ã
        renderWaveChart(data)
      )
    );
  };


  const renderProgressBar = (data) => {
    return React.createElement(ProgressBarComponent, { data, key: 'progress-bar' });
  };

  /**
   * –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –≤–æ–ª–Ω (–º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫)
   */
  const renderWaveHistory = (data) => {
    const history = data.waveHistory || [];
    if (history.length === 0) return null;

    const firstMealMin = Math.min(...history.map(w => w.startMin));
    const lastMealEnd = Math.max(...history.map(w => w.endMin));
    const now = new Date();
    const nowMin = now.getHours() * 60 + now.getMinutes();

    const rangeStart = firstMealMin - 15;
    const rangeEnd = Math.max(nowMin, lastMealEnd) + 15;
    const totalRange = rangeEnd - rangeStart;

    const w = 320;
    const h = 60;
    const padding = 4;
    const barY = 20;
    const barH = 18;

    const minToX = (min) => padding + ((min - rangeStart) / totalRange) * (w - 2 * padding);

    return React.createElement('div', {
      className: 'insulin-history',
      style: { marginTop: '12px', margin: '12px -8px 0 -8px' }
    },
      React.createElement('div', {
        style: { fontSize: '11px', color: '#64748b', marginBottom: '8px', fontWeight: '600', paddingLeft: '8px' }
      }, 'üìä –í–æ–ª–Ω—ã —Å–µ–≥–æ–¥–Ω—è'),

      React.createElement('svg', {
        width: '100%', height: h, viewBox: `0 0 ${w} ${h}`, style: { display: 'block' }
      },
        React.createElement('defs', null,
          React.createElement('linearGradient', { id: 'activeWaveGrad2', x1: '0%', y1: '0%', x2: '100%', y2: '0%' },
            React.createElement('stop', { offset: '0%', stopColor: '#3b82f6' }),
            React.createElement('stop', { offset: '100%', stopColor: '#3b82f6' })
          )
        ),

        // –§–æ–Ω–æ–≤–∞—è –ª–∏–Ω–∏—è
        React.createElement('line', {
          x1: padding, y1: barY + barH / 2, x2: w - padding, y2: barY + barH / 2,
          stroke: '#e5e7eb', strokeWidth: 2, strokeLinecap: 'round'
        }),

        // –í–æ–ª–Ω—ã
        history.map((wave, i) => {
          const x1 = minToX(wave.startMin);
          const x2 = minToX(wave.endMin);
          const barW = Math.max(8, x2 - x1);
          const giColor = wave.gi <= 35 ? '#22c55e' : wave.gi <= 55 ? '#eab308' : wave.gi <= 70 ? '#f97316' : '#ef4444';

          return React.createElement('g', { key: 'wave-' + i },
            React.createElement('rect', {
              x: x1, y: barY, width: barW, height: barH,
              fill: wave.isActive ? 'url(#activeWaveGrad2)' : giColor,
              opacity: wave.isActive ? 1 : 0.6,
              rx: 4
            }),
            wave.isActive && React.createElement('rect', {
              x: x1, y: barY, width: barW, height: barH,
              fill: 'none', stroke: '#3b82f6', strokeWidth: 2, rx: 4,
              className: 'wave-active-pulse'
            })
          );
        }),

        // –¢–æ—á–∫–∏ –ø—Ä–∏—ë–º–æ–≤
        history.map((wave, i) => {
          const x = minToX(wave.startMin);
          return React.createElement('g', { key: 'meal-' + i },
            React.createElement('circle', { cx: x, cy: barY + barH / 2, r: 6, fill: '#fff', stroke: '#3b82f6', strokeWidth: 2 }),
            React.createElement('text', { x, y: barY + barH / 2 + 1, fontSize: 8, textAnchor: 'middle', dominantBaseline: 'middle' }, 'üçΩ'),
            React.createElement('text', { x, y: h - 2, fontSize: 8, fill: '#64748b', textAnchor: 'middle', fontWeight: '500' },
              utils.minutesToTime(wave.startMin))
          );
        }),

        // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        (() => {
          const x = minToX(nowMin);
          if (x < padding || x > w - padding) return null;
          return React.createElement('g', null,
            React.createElement('line', { x1: x, y1: barY - 5, x2: x, y2: barY + barH + 5, stroke: '#ef4444', strokeWidth: 2, strokeLinecap: 'round' }),
            React.createElement('polygon', { points: `${x - 4},${barY - 5} ${x + 4},${barY - 5} ${x},${barY}`, fill: '#ef4444' }),
            React.createElement('text', { x, y: barY - 8, fontSize: 8, fill: '#ef4444', textAnchor: 'middle', fontWeight: '600' }, '–°–µ–π—á–∞—Å')
          );
        })()
      ),

      // –õ–µ–≥–µ–Ω–¥–∞
      React.createElement('div', {
        className: 'insulin-history-legend',
        style: { display: 'flex', flexWrap: 'wrap', gap: '8px', marginTop: '8px', fontSize: '10px', color: '#64748b', paddingLeft: '8px' }
      },
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '3px' } },
          React.createElement('span', { style: { width: '10px', height: '10px', borderRadius: '50%', border: '2px solid #3b82f6', background: '#fff' } }),
          '–ü—Ä–∏—ë–º'
        ),
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '3px' } },
          React.createElement('span', { style: { width: '16px', height: '8px', borderRadius: '2px', background: 'linear-gradient(90deg, #3b82f6, #3b82f6)' } }),
          '–ê–∫—Ç–∏–≤–Ω–∞—è'
        ),
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '3px' } },
          React.createElement('span', { style: { width: '8px', height: '8px', borderRadius: '2px', background: '#22c55e' } }),
          '–ù–∏–∑–∫–∏–π –ì–ò'
        ),
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '3px' } },
          React.createElement('span', { style: { width: '8px', height: '8px', borderRadius: '2px', background: '#eab308' } }),
          '–°—Ä–µ–¥–Ω–∏–π'
        ),
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '3px' } },
          React.createElement('span', { style: { width: '12px', height: '2px', background: '#ef4444' } }),
          '–°–µ–π—á–∞—Å'
        )
      )
    );
  };

  /**
   * –†–µ–Ω–¥–µ—Ä expanded —Å–µ–∫—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   */

  // === –ú–ò–ù–ò–ú–ê–õ–ò–°–¢–ò–ß–ù–´–ô EXPANDED v2 (React Component) ===
  const ExpandedSectionComponent = ({ data }) => {
    const [expandedMetric, setExpandedMetric] = React.useState('wave'); // 'wave' | 'gi' | 'gl' | null ‚Äî –≤–æ–ª–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const giCat = data.giCategory;

    // –°—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫-–∫–∞—Ä—Ç–æ—á–µ–∫
    const metricCardStyle = (isActive) => ({
      flex: '1 1 0',
      minWidth: '80px',
      padding: '12px 8px',
      background: isActive ? 'rgba(59, 130, 246, 0.1)' : 'rgba(248, 250, 252, 0.8)',
      borderRadius: '12px',
      textAlign: 'center',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      border: isActive ? '2px solid #3b82f6' : '2px solid transparent'
    });

    const metricValueStyle = {
      fontSize: '20px',
      fontWeight: '700',
      color: 'var(--text, #1e293b)',
      lineHeight: 1.2
    };

    const metricLabelStyle = {
      fontSize: '11px',
      color: '#64748b',
      marginTop: '4px'
    };

    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
    const getModifiers = () => {
      const mods = [];
      if (data.fatBonus > 0) mods.push({ icon: 'üßà', name: '–ñ–∏—Ä—ã', value: `+${Math.round(data.fatBonus * 100)}%`, desc: `${data.totalFat}–≥ –∑–∞–º–µ–¥–ª—è—é—Ç —É—Å–≤–æ–µ–Ω–∏–µ` });
      if (data.proteinBonus > 0) mods.push({ icon: 'ü•©', name: '–ë–µ–ª–æ–∫', value: `+${Math.round(data.proteinBonus * 100)}%`, desc: `${data.totalProtein}–≥ –ø—Ä–æ–¥–ª–µ–≤–∞—é—Ç –≤–æ–ª–Ω—É` });
      if (data.fiberBonus > 0) mods.push({ icon: 'üåæ', name: '–ö–ª–µ—Ç—á–∞—Ç–∫–∞', value: `+${Math.round(data.fiberBonus * 100)}%`, desc: `${data.totalFiber}–≥ –∑–∞–º–µ–¥–ª—è—é—Ç` });
      // üî¨ v3.0.1: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π label –∏ –∏–∫–æ–Ω–∫—É –¥–ª—è insulinogenic
      if (data.insulinogenicBonus > 0) {
        const isProtein = data.insulinogenicType === 'protein';
        mods.push({
          icon: isProtein ? 'üçñ' : 'ü•õ',
          name: isProtein ? '–ú—è—Å–æ/–±–µ–ª–æ–∫' : '–ú–æ–ª–æ—á–∫–∞',
          value: `+${Math.round(data.insulinogenicBonus * 100)}%`,
          desc: '–ø–æ–≤—ã—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω'
        });
      }
      if (data.hasLiquid) mods.push({ icon: 'ü•§', name: '–ñ–∏–¥–∫–æ–µ', value: `√ó${data.liquidMultiplier}`, desc: '–±—ã—Å—Ç—Ä–µ–µ —É—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è' });
      if (data.hasWorkoutBonus) mods.push({ icon: 'üèÉ', name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', value: `-${Math.abs(Math.round(data.workoutBonus * 100))}%`, desc: `${data.workoutMinutes} –º–∏–Ω —É—Å–∫–æ—Ä—è—é—Ç` });
      // üÜï v1.5: –ü–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      if (data.hasPostprandialBonus) {
        const gapHours = Math.round(data.postprandialGapMinutes / 60 * 10) / 10;
        mods.push({
          icon: 'üèÉ‚Äç‚ôÇÔ∏è',
          name: '–ü–æ—Å–ª–µ –µ–¥—ã',
          value: `-${Math.abs(Math.round(data.postprandialBonus * 100))}%`,
          desc: `—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ ${gapHours}—á —É—Å–∫–æ—Ä—è–µ—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –≥–ª—é–∫–æ–∑—ã`
        });
      }
      // üÜï v1.5: NEAT (–±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
      if (data.hasNeatBonus) {
        mods.push({
          icon: 'üè°',
          name: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
          value: `-${Math.abs(Math.round(data.neatBonus * 100))}%`,
          desc: `${data.householdMin} –º–∏–Ω —É–ª—É—á—à–∞—é—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É`
        });
      }
      // üÜï v1.5: –®–∞–≥–∏
      if (data.hasStepsBonus) {
        mods.push({
          icon: 'üö∂',
          name: '–®–∞–≥–∏',
          value: `-${Math.abs(Math.round(data.stepsBonus * 100))}%`,
          desc: `${Math.round(data.steps / 1000)}k —à–∞–≥–æ–≤ —É—Å–∫–æ—Ä—è—é—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º`
        });
      }
      if (data.circadianMultiplier && data.circadianMultiplier !== 1.0) {
        mods.push({
          icon: data.circadianMultiplier < 1 ? '‚òÄÔ∏è' : 'üåô',
          name: '–í—Ä–µ–º—è —Å—É—Ç–æ–∫',
          value: `√ó${data.circadianMultiplier}`,
          desc: data.circadianMultiplier < 1 ? '–¥–Ω—ë–º –±—ã—Å—Ç—Ä–µ–µ' : '–Ω–æ—á—å—é –º–µ–¥–ª–µ–Ω–Ω–µ–µ'
        });
      }
      if (data.hasCaffeineBonus) mods.push({ icon: '‚òï', name: '–ö–æ—Ñ–µ–∏–Ω', value: `+${Math.round(data.caffeineBonus * 100)}%`, desc: '–ø–æ–≤—ã—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω' });
      if (data.hasStressBonus) mods.push({ icon: 'üò∞', name: '–°—Ç—Ä–µ—Å—Å', value: `+${Math.round(data.stressBonus * 100)}%`, desc: '–∫–æ—Ä—Ç–∏–∑–æ–ª –≤–ª–∏—è–µ—Ç' });
      if (data.hasSleepBonus) mods.push({ icon: 'üò¥', name: '–ù–µ–¥–æ—Å—ã–ø', value: `+${Math.round(data.sleepDeprivationBonus * 100)}%`, desc: '–∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å' });
      // üÜï v3.7.0: NDTE ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –≤—á–µ—Ä–∞—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      if (data.hasNDTE && data.ndteWaveReduction > 0) {
        const ndte = data.ndte || {};
        mods.push({
          icon: 'üî•',
          name: '–í—á–µ—Ä–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
          value: `-${Math.round(data.ndteWaveReduction * 100)}%`,
          desc: `${ndte.trainingKcal || '?'} –∫–∫–∞–ª ‚Üí –∏–Ω—Å—É–ª–∏–Ω.—á—É–≤—Å—Ç–≤. –≤—ã—à–µ ${Math.round(ndte.hoursSince || 0)}—á`
        });
      }
      return mods;
    };

    const modifiers = getModifiers();

    // –î–µ—Ç–∞–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
    const getMetricDetails = (metric) => {
      switch (metric) {
        case 'wave': {
          // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—É —Ä–∞—Å—á—ë—Ç–∞
          const baseHrs = data.baseWaveHours || 3; // Fallback –Ω–∞ 3—á –µ—Å–ª–∏ NaN
          const parts = [`${baseHrs}—á (–±–∞–∑–∞)`];
          if (data.giMultiplier && data.giMultiplier !== 1) parts.push(`√ó${data.giMultiplier} –ì–ò`);
          if (data.fatBonus > 0) parts.push(`+${Math.round(data.fatBonus * 100)}% –∂–∏—Ä—ã`);
          if (data.proteinBonus > 0) parts.push(`+${Math.round(data.proteinBonus * 100)}% –±–µ–ª–æ–∫`);
          if (data.fiberBonus > 0) parts.push(`+${Math.round(data.fiberBonus * 100)}% –∫–ª–µ—Ç—á–∞—Ç–∫–∞`);
          // üî¨ v3.0.1: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π label (–º–æ–ª–æ—á–∫–∞/–º—è—Å–æ) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
          if (data.insulinogenicBonus > 0) {
            const insLabel = data.insulinogenicType === 'protein' ? '–º—è—Å–æ' : '–º–æ–ª–æ—á–∫–∞';
            parts.push(`+${Math.round(data.insulinogenicBonus * 100)}% ${insLabel}`);
          }
          if (data.hasLiquid) parts.push(`√ó${data.liquidMultiplier} –∂–∏–¥–∫–æ–µ`);
          if (data.hasWorkoutBonus) parts.push(`-${Math.abs(Math.round(data.workoutBonus * 100))}% —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞`);
          // üÜï v1.5: –ù–æ–≤—ã–µ –±–æ–Ω—É—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          if (data.hasPostprandialBonus) parts.push(`-${Math.abs(Math.round(data.postprandialBonus * 100))}% –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –µ–¥—ã`);
          if (data.hasNeatBonus) parts.push(`-${Math.abs(Math.round(data.neatBonus * 100))}% –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å`);
          if (data.hasStepsBonus) parts.push(`-${Math.abs(Math.round(data.stepsBonus * 100))}% —à–∞–≥–∏`);
          if (data.circadianMultiplier && data.circadianMultiplier !== 1.0) parts.push(`√ó${data.circadianMultiplier} ${data.circadianMultiplier < 1 ? '–¥–µ–Ω—å' : '–Ω–æ—á—å'}`);
          if (data.hasCaffeineBonus) parts.push(`+${Math.round(data.caffeineBonus * 100)}% –∫–æ—Ñ–µ–∏–Ω`);
          if (data.hasStressBonus) parts.push(`+${Math.round(data.stressBonus * 100)}% —Å—Ç—Ä–µ—Å—Å`);
          if (data.hasSleepBonus) parts.push(`+${Math.round(data.sleepDeprivationBonus * 100)}% –Ω–µ–¥–æ—Å—ã–ø`);
          // üÜï v3.7.0: NDTE ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –≤—á–µ—Ä–∞—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
          if (data.hasNDTE && data.ndteWaveReduction > 0) parts.push(`-${Math.round(data.ndteWaveReduction * 100)}% NDTE`);

          const formula = parts.join(' ');

          // –ó–∞—â–∏—Ç–∞ –æ—Ç NaN
          const waveHours = data.insulinWaveHours && !isNaN(data.insulinWaveHours)
            ? Math.round(data.insulinWaveHours * 10) / 10
            : '?';

          return {
            title: 'üìä –†–∞—Å—á—ë—Ç –≤–æ–ª–Ω—ã',
            formula: formula,
            result: `= ${waveHours}—á`,
            items: modifiers.map(m => ({ label: `${m.icon} ${m.name}`, value: m.value, desc: m.desc })),
            desc: '–í—Ä–µ–º—è, –ø–æ–∫–∞ –∏–Ω—Å—É–ª–∏–Ω –≤—ã—Å–æ–∫–∏–π –∏ –∂–∏—Ä –Ω–µ —Å–∂–∏–≥–∞–µ—Ç—Å—è'
          };
        }
        case 'gi':
          return {
            title: 'üç¨ –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å',
            items: [
              { label: '–°—Ä–µ–¥–Ω–∏–π –ì–ò', value: data.avgGI || '‚Äî' },
              { label: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', value: giCat.text },
              { label: '–£—Å–≤–æ–µ–Ω–∏–µ', value: giCat.desc }
            ],
            desc: giCat.id === 'low' ? '–ù–∏–∑–∫–∏–π –ì–ò = –º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–¥—ä—ë–º —Å–∞—Ö–∞—Ä–∞' :
              giCat.id === 'high' ? '–í—ã—Å–æ–∫–∏–π –ì–ò = –±—ã—Å—Ç—Ä—ã–π —Å–∫–∞—á–æ–∫ —Å–∞—Ö–∞—Ä–∞' :
                '–°—Ä–µ–¥–Ω–∏–π –ì–ò = —É–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–¥—ä—ë–º —Å–∞—Ö–∞—Ä–∞'
          };
        case 'gl':
          return {
            title: 'üìà –ì–ª–∏–∫–µ–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
            items: [
              { label: 'GL', value: data.glycemicLoad || '‚Äî' },
              { label: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', value: data.glCategory?.text || '–°—Ä–µ–¥–Ω—è—è' },
              { label: '–£–≥–ª–µ–≤–æ–¥—ã', value: `${data.totalCarbs || 0}–≥` }
            ],
            desc: 'GL = –ì–ò √ó —É–≥–ª–µ–≤–æ–¥—ã / 100. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ø–æ–¥–∂–µ–ª—É–¥–æ—á–Ω—É—é'
          };
        default:
          return null;
      }
    };

    const toggleMetric = (metric) => {
      setExpandedMetric(expandedMetric === metric ? null : metric);
    };

    const details = expandedMetric ? getMetricDetails(expandedMetric) : null;

    return React.createElement('div', {
      className: 'insulin-wave-expanded',
      onClick: (e) => e.stopPropagation()
    },

      // === –ë–õ–û–ö 1: –ú–µ—Ç—Ä–∏–∫–∏ (3 –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏) ===
      React.createElement('div', {
        style: { display: 'flex', gap: '8px', marginBottom: details ? '12px' : '16px' }
      },
        // –ö–∞—Ä—Ç–æ—á–∫–∞: –í–æ–ª–Ω–∞
        React.createElement('div', {
          style: metricCardStyle(expandedMetric === 'wave'),
          onClick: () => toggleMetric('wave')
        },
          React.createElement('div', { style: metricValueStyle },
            `${Math.round(data.insulinWaveHours * 10) / 10}—á`
          ),
          React.createElement('div', { style: metricLabelStyle }, '–≤–æ–ª–Ω–∞ ‚ìò')
        ),
        // –ö–∞—Ä—Ç–æ—á–∫–∞: –ì–ò
        React.createElement('div', {
          style: { ...metricCardStyle(expandedMetric === 'gi'), background: expandedMetric === 'gi' ? `${giCat.color}20` : `${giCat.color}15` },
          onClick: () => toggleMetric('gi')
        },
          React.createElement('div', { style: { ...metricValueStyle, color: giCat.color } },
            data.avgGI || '‚Äî'
          ),
          React.createElement('div', { style: metricLabelStyle }, '–ì–ò ‚ìò')
        ),
        // –ö–∞—Ä—Ç–æ—á–∫–∞: GL
        React.createElement('div', {
          style: metricCardStyle(expandedMetric === 'gl'),
          onClick: () => toggleMetric('gl')
        },
          React.createElement('div', { style: metricValueStyle },
            data.glycemicLoad > 0 ? data.glycemicLoad : '‚Äî'
          ),
          React.createElement('div', { style: metricLabelStyle }, 'GL ‚ìò')
        )
      ),

      // === –î–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç—Ä–∏–∫–∏ (–≤—ã–ø–∞–¥–∞—é—â–∏–π –±–ª–æ–∫) ===
      details && React.createElement('div', {
        style: {
          padding: '12px 16px',
          background: 'var(--bg-secondary, #f8fafc)',
          borderRadius: '12px',
          marginBottom: '16px',
          animation: 'fadeIn 0.2s ease'
        }
      },
        React.createElement('div', {
          style: { fontSize: '14px', fontWeight: '600', color: 'var(--text, #1e293b)', marginBottom: '10px' }
        }, details.title),

        // –î–ª—è –≤–æ–ª–Ω—ã ‚Äî —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞
        details.formula && React.createElement('div', {
          style: {
            padding: '10px 12px',
            background: 'rgba(0,0,0,0.03)',
            borderRadius: '8px',
            marginBottom: '12px',
            fontFamily: 'system-ui, -apple-system, sans-serif'
          }
        },
          // –§–æ—Ä–º—É–ª–∞
          React.createElement('div', {
            style: { fontSize: '12px', color: '#64748b', lineHeight: 1.6, wordBreak: 'break-word' }
          }, details.formula),
          // –†–µ–∑—É–ª—å—Ç–∞—Ç
          React.createElement('div', {
            style: {
              fontSize: '18px',
              fontWeight: '700',
              color: 'var(--text, #1e293b)',
              marginTop: '6px',
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }
          },
            React.createElement('span', null, details.result),
            React.createElement('span', {
              style: { fontSize: '12px', color: '#64748b', fontWeight: '400' }
            }, '–∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è –≤–æ–ª–Ω–∞')
          )
        ),

        // –°–ø–∏—Å–æ–∫ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (–¥–ª—è –≤–æ–ª–Ω—ã) –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–π (–¥–ª—è –¥—Ä—É–≥–∏—Ö)
        details.items?.length > 0 && React.createElement('div', {
          style: { display: 'flex', flexDirection: 'column', gap: '6px' }
        },
          details.items.map((item, i) =>
            React.createElement('div', {
              key: i,
              style: { display: 'flex', justifyContent: 'space-between', fontSize: '13px' }
            },
              React.createElement('span', { style: { color: '#64748b' } }, item.label),
              React.createElement('span', {
                style: {
                  fontWeight: '600',
                  color: item.value?.startsWith?.('-') ? '#16a34a' :
                    item.value?.startsWith?.('+') ? '#f59e0b' : '#1e293b'
                }
              }, item.value)
            )
          )
        ),

        // –û–ø–∏—Å–∞–Ω–∏–µ
        React.createElement('div', {
          style: { marginTop: '10px', fontSize: '12px', color: '#64748b', fontStyle: 'italic' }
        }, details.desc)
      ),

      // === –ë–õ–û–ö 2: –ü–∞—Ç—Ç–µ—Ä–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ) ===
      data.personalAvgGap > 0 && React.createElement('div', {
        style: {
          padding: '12px 16px',
          background: 'rgba(248, 250, 252, 0.8)',
          borderRadius: '12px',
          marginBottom: '16px'
        }
      },
        React.createElement('div', {
          style: {
            fontSize: '13px',
            fontWeight: '600',
            color: '#475569',
            marginBottom: '8px'
          }
        }, 'üéØ –ü–∞—Ç—Ç–µ—Ä–Ω—ã'),
        React.createElement('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            fontSize: '14px'
          }
        },
          React.createElement('span', { style: { color: '#64748b' } }, '–°—Ä–µ–¥–Ω–∏–π gap'),
          React.createElement('span', { style: { fontWeight: '600', color: 'var(--text, #1e293b)' } },
            utils.formatDuration(data.personalAvgGap)
          )
        ),
        // –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
        React.createElement('div', {
          style: {
            marginTop: '10px',
            padding: '8px 12px',
            borderRadius: '8px',
            fontSize: '13px',
            fontWeight: '500',
            textAlign: 'center',
            background: data.gapQuality === 'excellent' ? '#dcfce7' :
              data.gapQuality === 'good' ? '#fef9c3' :
                data.gapQuality === 'moderate' ? '#fed7aa' : '#fecaca',
            color: data.gapQuality === 'excellent' ? '#166534' :
              data.gapQuality === 'good' ? '#854d0e' :
                data.gapQuality === 'moderate' ? '#c2410c' : '#dc2626'
          }
        },
          data.gapQuality === 'excellent' ? '‚úì –û—Ç–ª–∏—á–Ω–æ!' :
            data.gapQuality === 'good' ? 'üëç –•–æ—Ä–æ—à–æ' :
              data.gapQuality === 'moderate' ? '‚Üí –ú–æ–∂–Ω–æ –ª—É—á—à–µ' : '‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ'
        )
      ),

      // === –ë–õ–û–ö 3: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
      React.createElement('div', {
        style: {
          padding: '12px 16px',
          background: data.status === 'lipolysis'
            ? 'linear-gradient(135deg, rgba(34,197,94,0.12), rgba(16,185,129,0.12))'
            : 'rgba(248, 250, 252, 0.8)',
          borderRadius: '12px',
          marginBottom: modifiers.length > 0 || data.hasOverlaps ? '12px' : '0'
        }
      },
        React.createElement('div', {
          style: {
            fontSize: '13px',
            fontWeight: '600',
            color: data.status === 'lipolysis' ? '#16a34a' : '#475569',
            marginBottom: '6px'
          }
        }, data.status === 'lipolysis' ? 'üî• –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ' : 'üí° –°–µ–π—á–∞—Å'),
        React.createElement('div', {
          style: {
            fontSize: '14px',
            color: '#334155',
            lineHeight: 1.5
          }
        },
          data.status === 'lipolysis'
            ? '–ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –±–µ–∑ –µ–¥—ã = —Å–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞'
            : '–ò–Ω—Å—É–ª–∏–Ω –≤—ã—Å–æ–∫–∏–π ‚Üí –∂–∏—Ä –∑–∞–ø–∞—Å–∞–µ—Ç—Å—è'
        ),
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞
        React.createElement('div', {
          style: {
            marginTop: '8px',
            fontSize: '13px',
            color: '#64748b',
            display: 'flex',
            gap: '12px',
            flexWrap: 'wrap'
          }
        },
          React.createElement('span', null, 'üíß –í–æ–¥–∞ –æ–∫'),
          data.status !== 'lipolysis' && React.createElement('span', null, 'üö´ –ï–¥–∞ –ø—Ä–æ–¥–ª–∏—Ç –≤–æ–ª–Ω—É')
        )
      ),

      // === –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–∏ ===
      data.hasOverlaps && React.createElement('div', {
        style: {
          padding: '12px 16px',
          background: 'rgba(239,68,68,0.08)',
          borderRadius: '12px',
          marginBottom: '12px',
          border: '1px solid rgba(239,68,68,0.2)'
        }
      },
        React.createElement('div', {
          style: { fontSize: '13px', fontWeight: '600', color: '#dc2626' }
        }, '‚ö†Ô∏è –í–æ–ª–Ω—ã –ø–µ—Ä–µ—Å–µ–∫–ª–∏—Å—å'),
        React.createElement('div', {
          style: { fontSize: '13px', color: '#64748b', marginTop: '4px' }
        }, `–°–æ–≤–µ—Ç: –ø–æ–¥–æ–∂–¥–∏ ${Math.round(data.baseWaveHours * 60)} –º–∏–Ω –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏`)
      ),

      // –ë–ª–æ–∫ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —É–±—Ä–∞–Ω ‚Äî —Ñ–æ—Ä–º—É–ª–∞ —Ç–µ–ø–µ—Ä—å –≤ –¥–µ—Ç–∞–ª—è—Ö –≤–æ–ª–Ω—ã

      // === –ò—Å—Ç–æ—Ä–∏—è –≤–æ–ª–Ω ===
      renderWaveHistory(data)
    );
  };

  // Wrapper –¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–∏ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç React element)
  const renderExpandedSection = (data) => {
    return React.createElement(ExpandedSectionComponent, { data, key: 'expanded-section' });
  };

  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.UI = {
    formatLipolysisTime,
    renderActivityContextBadge,
    MealWaveExpandSection,
    ProgressBarComponent,
    renderProgressBar,
    renderWaveHistory,
    renderExpandedSection
  };

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_insulin_wave_v1.js ===== */
// heys_insulin_wave_v1.js ‚Äî –ú–æ–¥—É–ª—å –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã (Orchestrator)
// –í–µ—Ä—Å–∏—è: 4.2.2 | –î–∞—Ç–∞: 2026-01-12
//
// –†–ï–§–ê–ö–¢–û–†–ò–ù–ì v4.2.1:
// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–º –º–æ–¥—É–ª–µ–º:
// - heys_iw_orchestrator.js (241 —Å—Ç—Ä–æ–∫–∞) - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
// - –î–æ–±–∞–≤–ª–µ–Ω–∞ JSDoc –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
// - –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
//
// –ö–æ–¥ —Ä–∞–∑–±–∏—Ç –Ω–∞ 8 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π:
// - heys_iw_constants.js (3144 —Å—Ç—Ä–æ–∫) - –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
// - heys_iw_calc.js (703 —Å—Ç—Ä–æ–∫–∏) - —Ä–∞—Å—á—ë—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
// - heys_iw_v30.js (387 —Å—Ç—Ä–æ–∫) - v3.0 —Ñ–∏—á–∏ (Continuous GL, Personal Baseline)
// - heys_iw_v41.js (474 —Å—Ç—Ä–æ–∫–∏) - v4.1 —Ñ–∏—á–∏ (Metabolic Flexibility, Satiety)
// - heys_iw_ui.js (1617 —Å—Ç—Ä–æ–∫) - React UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
// - heys_iw_graph.js (292 —Å—Ç—Ä–æ–∫–∏) - SVG –≥—Ä–∞—Ñ–∏–∫ –≤–æ–ª–Ω—ã
// - heys_iw_lipolysis.js (186 —Å—Ç—Ä–æ–∫) - —Ä–µ–∫–æ—Ä–¥—ã –ª–∏–ø–æ–ª–∏–∑–∞
// - heys_iw_ndte.js (162 —Å—Ç—Ä–æ–∫–∏) - NDTE Badge UI
//
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—É—é –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É.
// –ù–∞—É—á–Ω–∞—è –±–∞–∑–∞: Brand-Miller 2003, Holt 1997, Van Cauter 1997, Colberg 2010

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;

  // === –ò–ú–ü–û–†–¢ –ò–ó –ú–û–î–£–õ–ï–ô ===

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–∏–∑ heys_iw_constants.js)
  const I = HEYS.InsulinWave?.__internals;
  const GI_CATEGORIES = I?.GI_CATEGORIES;
  const STATUS_CONFIG = I?.STATUS_CONFIG;
  const calculateActivityContext = I?.calculateActivityContext;

  // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–∞ –±–æ–Ω—É—Å–æ–≤ (–∏–∑ heys_iw_constants.js ‚Üí __internals)
  const calculateFastingBonus = I?.calculateFastingBonus;
  const calculateStressBonus = I?.calculateStressBonus;
  const calculateSleepBonus = I?.calculateSleepBonus;
  const calculateSleepQualityBonus = I?.calculateSleepQualityBonus;
  const calculateHydrationBonus = I?.calculateHydrationBonus;
  const calculateAgeBonus = I?.calculateAgeBonus;
  const calculateBMIBonus = I?.calculateBMIBonus;
  const getGenderBonus = I?.getGenderBonus;
  const calculateTransFatBonus = I?.calculateTransFatBonus;
  const calculateLargePortionBonus = I?.calculateLargePortionBonus;
  const calculateIRScore = I?.calculateIRScore;
  const calculateNDTE = I?.calculateNDTE;
  const getPreviousDayTrainings = I?.getPreviousDayTrainings;
  const detectFoodTemperature = I?.detectFoodTemperature;
  const getHypoglycemiaWarning = I?.getHypoglycemiaWarning;
  const getInsulinIndexWaveModifier = I?.getInsulinIndexWaveModifier;

  // Helper-—Ñ—É–Ω–∫—Ü–∏–∏ (–∏–∑ heys_iw_constants.js ‚Üí __internals)
  const getFoodForm = I?.getFoodForm;
  const hasResistantStarch = I?.hasResistantStarch;
  const getAlcoholBonus = I?.getAlcoholBonus;
  const getInsulinogenicBonus = I?.getInsulinogenicBonus;
  const getAutophagyPhase = I?.getAutophagyPhase;
  const getSupplementsBonus = I?.getSupplementsBonus;
  const getColdExposureBonus = I?.getColdExposureBonus;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã-–æ–±—ä–µ–∫—Ç—ã (–∏–∑ heys_iw_constants.js ‚Üí __internals)
  const SPICY_FOOD = I?.SPICY_FOOD;
  const CAFFEINE_BONUS = I?.CAFFEINE_BONUS;
  const PERSONAL_BASELINE = I?.PERSONAL_BASELINE;
  const GAP_HISTORY_KEY = I?.GAP_HISTORY_KEY;
  const GAP_HISTORY_DAYS = I?.GAP_HISTORY_DAYS;

  // –£—Ç–∏–ª–∏—Ç—ã (–∏–∑ heys_iw_utils.js)
  const utils = HEYS.InsulinWave?.utils;

  // –†–∞—Å—á—ë—Ç—ã (–∏–∑ heys_iw_calc.js)
  const Calc = HEYS.InsulinWave?.Calc;
  const calculateMealNutrients = Calc?.calculateMealNutrients;
  const calculateMultiplier = Calc?.calculateMultiplier;
  const calculateWorkoutBonus = Calc?.calculateWorkoutBonus;
  const calculatePostprandialExerciseBonus = Calc?.calculatePostprandialExerciseBonus;
  const calculateNEATBonus = Calc?.calculateNEATBonus;
  const calculateStepsBonus = Calc?.calculateStepsBonus;
  const calculateCircadianMultiplier = Calc?.calculateCircadianMultiplier;
  const calculateDayFactorsForMeal = Calc?.calculateDayFactorsForMeal;
  const calculateActivityFactorsForMeal = Calc?.calculateActivityFactorsForMeal;

  // v3.0 —Ñ–∏—á–∏ (–∏–∑ heys_iw_v30.js)
  const V30 = HEYS.InsulinWave?.V30;
  const calculateContinuousGLMultiplier = V30?.calculateContinuousGLMultiplier;
  const calculatePersonalBaselineWave = V30?.calculatePersonalBaselineWave;
  const calculateMealStackingBonus = V30?.calculateMealStackingBonus;
  const calculateWavePhases = V30?.calculateWavePhases;
  const calculateInsulinIndex = V30?.calculateInsulinIndex;

  // v4.1 —Ñ–∏—á–∏ (–∏–∑ heys_iw_v41.js)
  const V41 = HEYS.InsulinWave?.V41;

  // Lipolysis (–∏–∑ heys_iw_lipolysis.js)
  const Lipolysis = HEYS.InsulinWave?.Lipolysis;
  const updateLipolysisRecord = Lipolysis?.updateLipolysisRecord;
  const getLipolysisRecord = Lipolysis?.getLipolysisRecord;
  const calculateLipolysisStreak = Lipolysis?.calculateLipolysisStreak;
  const calculateLipolysisKcal = Lipolysis?.calculateLipolysisKcal;

  // Graph (generateWaveCurve)
  const generateWaveCurve = I?.generateWaveCurve;

  // UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∏–∑ heys_iw_ui.js, heys_iw_graph.js, heys_iw_ndte.js)
  const UI = HEYS.InsulinWave?.UI;
  const Graph = HEYS.InsulinWave?.Graph;
  const NDTE_UI = HEYS.InsulinWave?.NDTE;

  /**
   * –†–∞—Å—á—ë—Ç –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
   * 
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞
   * @param {Array} params.meals - –º–∞—Å—Å–∏–≤ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
   * @param {Object} params.pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @param {Function} params.getProductFromItem - —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –∞–π—Ç–µ–º–∞
   * @param {number} [params.baseWaveHours=3] - –±–∞–∑–æ–≤–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã –≤ —á–∞—Å–∞—Ö
   * @param {Array} [params.trainings=[]] - –º–∞—Å—Å–∏–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–Ω—è
   * @param {Object} [params.dayData={}] - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è (–ø—Ä–æ—Ñ–∏–ª—å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Å–æ–Ω –∏ —Ç.–¥.)
   * @param {Date} [params.now=new Date()] - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
   * @returns {Object|null} –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
   */
  const calculateInsulinWaveData = ({
    meals,
    pIndex,
    getProductFromItem,
    baseWaveHours = 3,
    trainings = [],
    dayData = {},
    now = new Date()
  }) => {
    if (!meals || meals.length === 0) return null;

    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∏—ë–º—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º
    const mealsWithTime = meals.filter(m => m.time);
    if (mealsWithTime.length === 0) return null;

    // üÜï v3.0.0: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–æ–≤–∞—è –≤–æ–ª–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è
    // –í–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö 3 —á–∞—Å–æ–≤ ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç, BMI, –ø–æ–ª
    const profile = dayData.profile || {};
    const personalBaseline = calculatePersonalBaselineWave(profile);
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –±–∞–∑—É, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –µ—Å—Ç—å –ò baseHours –≤–∞–ª–∏–¥–Ω—ã–π, –∏–Ω–∞—á–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π baseWaveHours
    let effectiveBaseWaveHours = baseWaveHours;
    if (profile.age && personalBaseline.baseHours && !isNaN(personalBaseline.baseHours)) {
      effectiveBaseWaveHours = personalBaseline.baseHours;
    }
    // Fallback –Ω–∞ 3 —á–∞—Å–∞ –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë undefined/NaN
    if (!effectiveBaseWaveHours || isNaN(effectiveBaseWaveHours)) {
      effectiveBaseWaveHours = 3;
    }

    // üÜï v4.0.0: IR Score ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç BMI, —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –≤–æ–∑—Ä–∞—Å—Ç –≤ –µ–¥–∏–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä
    const irScore = I?.calculateIRScore(profile, dayData);
    const irScoreMultiplier = irScore?.waveMultiplier || 1.0;

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–≤—ã–π)
    const sorted = [...mealsWithTime].sort((a, b) => {
      const timeA = (a.time || '').replace(':', '');
      const timeB = (b.time || '').replace(':', '');
      return timeB.localeCompare(timeA);
    });

    const lastMeal = sorted[0];
    const lastMealTime = lastMeal?.time;
    if (!lastMealTime) return null;

    // üÜï v3.0.0: Meal Stacking ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–∏—ë–º, —Å—á–∏—Ç–∞–µ–º –±–æ–Ω—É—Å –∑–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ
    let mealStackingResult = { bonus: 0, desc: null, hasStacking: false };
    if (sorted.length >= 2) {
      const prevMeal = sorted[1];
      const prevNutrients = calculateMealNutrients(prevMeal, pIndex, getProductFromItem);
      const prevWaveEnd = utils.timeToMinutes(prevMeal.time) + (effectiveBaseWaveHours * 60); // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞
      const currentMealTime = utils.timeToMinutes(lastMealTime);
      mealStackingResult = calculateMealStackingBonus(prevWaveEnd, currentMealTime, prevNutrients.glycemicLoad);
    }

    // –†–∞—Å—á—ë—Ç –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
    const nutrients = calculateMealNutrients(lastMeal, pIndex, getProductFromItem);

    // üçé v3.2.0: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É –ø–∏—â–∏ (liquid/processed/whole)
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: liquid > processed > whole (–±–µ—Ä—ë–º "—Ö—É–¥—à–µ–µ" –¥–ª—è –≤–æ–ª–Ω—ã)
    let mealFoodForm = null;
    let hasResistantStarchInMeal = false;
    for (const item of (lastMeal.items || [])) {
      const prod = getProductFromItem(item, pIndex);
      const itemForm = getFoodForm(prod);
      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: liquid (1.30) > processed (1.15) > whole (0.85)
      if (itemForm === 'liquid') mealFoodForm = 'liquid';
      else if (itemForm === 'processed' && mealFoodForm !== 'liquid') mealFoodForm = 'processed';
      else if (itemForm === 'whole' && !mealFoodForm) mealFoodForm = 'whole';

      // ü•î Resistant starch
      if (hasResistantStarch(prod)) hasResistantStarchInMeal = true;
    }

    const multipliers = calculateMultiplier(
      nutrients.avgGI,
      nutrients.totalProtein,
      nutrients.totalFiber,
      nutrients.totalCarbs,
      nutrients.totalFat,
      nutrients.glycemicLoad,
      nutrients.hasLiquid,
      nutrients.insulinogenicBonus,
      mealFoodForm,  // üÜï v3.2.0
      nutrients.dominantProteinType || 'mixed' // üÜï v4.2.3: —Ä–µ–∞–ª—å–Ω—ã–π —Ç–∏–ø –±–µ–ª–∫–∞
    );

    // üèÉ Workout –±–æ–Ω—É—Å (–æ–±—â–∏–π –∑–∞ –¥–µ–Ω—å)
    const workoutBonus = calculateWorkoutBonus(trainings);

    // üåÖ Circadian —Ä–∏—Ç–º (–ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏)
    const mealHour = parseInt(lastMealTime.split(':')[0]) || 12;
    const circadian = calculateCircadianMultiplier(mealHour);

    // üÜï v1.5: –ü–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–ü–û–°–õ–ï –µ–¥—ã) ‚Äî –Ω–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥
    const mealMinutesForPostprandial = utils.timeToMinutes(lastMealTime);
    const postprandialBonus = calculatePostprandialExerciseBonus(trainings, mealMinutesForPostprandial);

    // üÜï v3.4.0: Activity Context ‚Äî –ó–ê–ú–ï–ù–Ø–ï–¢ —Å—Ç–∞—Ä—ã–µ workout/postprandial –±–æ–Ω—É—Å—ã
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞
    const activityContext = calculateActivityContext({
      mealTimeMin: mealMinutesForPostprandial,
      trainings,
      steps: dayData.steps || 0,
      householdMin: dayData.householdMin || 0, // üÜï v3.5.5: –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      weight: dayData.profile?.weight || 70,
      allMeals: sorted,
      mealNutrients: {
        prot: nutrients.totalProtein,
        carbs: nutrients.totalCarbs,
        simple: nutrients.totalSimple || 0
      },
      mealKcal: nutrients.totalKcal || 0
    });

    // üÜï v1.5: NEAT ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    const householdMinutes = dayData.householdMin || 0;
    const neatBonus = calculateNEATBonus(householdMinutes);

    // üÜï v1.5: –®–∞–≥–∏
    const steps = dayData.steps || 0;
    const stepsBonus = calculateStepsBonus(steps);

    // üÜï v1.4: –ù–æ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã

    // üçΩÔ∏è –ì–æ–ª–æ–¥–∞–Ω–∏–µ ‚Äî —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
    let fastingHours = 0;
    let fastingBonus = 0;
    if (sorted.length >= 2) {
      // –ï—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–∏—ë–º ‚Äî —Å—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É
      const prevMeal = sorted[1];
      const prevMealMinutes = utils.timeToMinutes(prevMeal.time);
      const lastMealMinutes = utils.timeToMinutes(lastMealTime);
      let gapMinutes = lastMealMinutes - prevMealMinutes;
      // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å
      if (gapMinutes < 0) gapMinutes += 24 * 60;
      fastingHours = gapMinutes / 60;
    } else {
      // –ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –∑–∞ –¥–µ–Ω—å ‚Äî —Å—á–∏—Ç–∞–µ–º –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –≤—á–µ—Ä–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ 12—á)
      // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –¥–æ –ø–æ–ª—É–¥–Ω—è, –≤–µ—Ä–æ—è—Ç–Ω–æ –≥–æ–ª–æ–¥–∞–Ω–∏–µ –±—ã–ª–æ –Ω–æ—á—å—é ~8-12—á
      if (mealHour <= 12) {
        fastingHours = mealHour + 8; // –ü—Ä–∏–º–µ—Ä–Ω–æ —Å 22:00-00:00 –≤—á–µ—Ä–∞
      }
    }
    fastingBonus = calculateFastingBonus(fastingHours);

    // üå∂Ô∏è –û—Å—Ç—Ä–∞—è –ø–∏—â–∞
    const spicyMultiplier = nutrients.hasSpicy ? SPICY_FOOD.multiplier : 1.0;

    // üç∑ –ê–ª–∫–æ–≥–æ–ª—å
    const alcoholBonus = nutrients.alcoholBonus || 0;

    // ‚òï –ö–æ—Ñ–µ–∏–Ω
    const caffeineBonus = nutrients.hasCaffeine ? CAFFEINE_BONUS.bonus : 0;

    // üò∞ –°—Ç—Ä–µ—Å—Å (–∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è)
    const stressLevel = dayData.stressAvg || 0;
    const stressBonus = calculateStressBonus(stressLevel);

    // üò¥ –ù–µ–¥–æ—Å—ã–ø (–∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è)
    const sleepHours = dayData.sleepHours;
    const sleepBonus = calculateSleepBonus(sleepHours);

    // üÜï v2.0: –ù–æ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—É—á–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞

    // üåü –ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ (Tasali 2008)
    const sleepQuality = dayData.sleepQuality || 0;
    const sleepQualityBonus = calculateSleepQualityBonus(sleepQuality);

    // üíß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è (Carroll 2016) ‚Äî –Ω—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –≤–µ—Å–∞
    const waterMl = dayData.waterMl || 0;
    const userWeight = dayData.profile?.weight || 70;
    const hydrationBonus = calculateHydrationBonus(waterMl, userWeight);

    // üë¥ –í–æ–∑—Ä–∞—Å—Ç (DeFronzo 1979)
    const age = dayData.profile?.age || 0;
    const ageBonus = calculateAgeBonus(age);

    // üèãÔ∏è BMI (Kahn & Flier 2000)
    const weight = dayData.profile?.weight || 0;
    const height = dayData.profile?.height || 0;
    const bmiBonus = calculateBMIBonus(weight, height);

    // üö∫üöπ –ü–æ–ª (Nuutila 1995)
    const gender = dayData.profile?.gender || '';
    const genderBonus = getGenderBonus(gender);

    // üçü –¢—Ä–∞–Ω—Å-–∂–∏—Ä—ã (Salmer√≥n 2001)
    const transFat = nutrients.totalTrans || 0;
    const transFatBonus = calculateTransFatBonus(transFat);

    // üå∏ –ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª (Davidsen 2007)
    // –ò–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è –≤ –ª—é—Ç–µ–∏–Ω–æ–≤—É—é —Ñ–∞–∑—É –∏ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é
    const cycleDay = dayData.cycleDay || null;
    const cycleBonus = HEYS.Cycle?.getInsulinWaveMultiplier?.(cycleDay) || 1;
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤ –±–æ–Ω—É—Å (1.12 ‚Üí +0.12)
    const cycleBonusValue = cycleBonus > 1 ? (cycleBonus - 1) : 0;

    // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-09 v2: GL-—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–Ω–µ–≤–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    // –ü—Ä–∏ –Ω–∏–∑–∫–æ–π GL –¥–Ω–µ–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ
    // –ö–õ–Æ–ß–ï–í–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø: —É—Å–∏–ª–µ–Ω–æ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è –ø—Ä–∏ GL < 10
    // üîß FIX v3.8.3: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN + isFinite
    const gl = nutrients.glycemicLoad;
    let dayFactorsScale = 1.0;
    let circadianScale = 1.0;

    // GL-—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL (< 20) —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ
    // NaN –∏–ª–∏ undefined ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã)
    if (gl != null && isFinite(gl) && gl < 20) {
      // –§–æ—Ä–º—É–ª–∞: 0.3 + (GL/20) * 0.7 
      // GL=0 ‚Üí 0.3, GL=10 ‚Üí 0.65, GL=20 ‚Üí 1.0
      dayFactorsScale = Math.max(0.3, 0.3 + (gl / 20) * 0.7);

      // –¶–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã ‚Äî –ë–û–õ–ï–ï –ê–ì–†–ï–°–°–ò–í–ù–û–ï –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL
      // –ü—Ä–∏ GL=7 –Ω–æ—á–Ω–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å √ó1.2 –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–∏–ª—å–Ω–æ –≤–ª–∏—è—Ç—å
      // –§–æ—Ä–º—É–ª–∞: 0.2 + (GL/20) * 0.8 ‚Üí GL=7: 0.48, GL=10: 0.6, GL=20: 1.0
      circadianScale = Math.max(0.2, 0.2 + (gl / 20) * 0.8);

    }

    // üÜï v4.2.3: –£–±–∏—Ä–∞–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π double-count low-GL
    // GL —É–∂–µ —Å–∏–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç —á–µ—Ä–µ–∑ continuous glMultiplier –≤ calculateMultiplier().
    // –ó–¥–µ—Å—å —Å–∫–∞–ª–∏—Ä—É–µ–º –±–∞–∑—É —Ç–æ–ª—å–∫–æ –≤ micro/very-low –∑–æ–Ω–µ (GL < 10) –∏ –º—è–≥–∫–æ.
    if (gl != null && isFinite(gl) && gl < 10) {
      const baseScaleFactor = Math.max(0.85, 0.85 + (gl / 10) * 0.15);
      effectiveBaseWaveHours = effectiveBaseWaveHours * baseScaleFactor;
    }

    // üÜï v3.8.5: Simple Ratio Modifier ‚Äî —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã—Ö/—Å–ª–æ–∂–Ω—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (—Å–∞—Ö–∞—Ä) –¥–∞—é—Ç –±—ã—Å—Ç—Ä—ã–π –ø–∏–∫ –∏ –∫–æ—Ä–æ—Ç–∫—É—é –≤–æ–ª–Ω—É
    // –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–∫—Ä–∞—Ö–º–∞–ª) ‚Äî –º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–∏–∫, –¥–ª–∏–Ω–Ω–∞—è –≤–æ–ª–Ω–∞
    // –ü—Ä–∏ >70% —Å–∞—Ö–∞—Ä–∞ –≤–æ–ª–Ω–∞ —É–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 5-10%
    const simpleRatio = nutrients.simpleRatio || 0;
    let simpleRatioMultiplier = 1.0;
    if (simpleRatio > 0.7) {
      // >70% –ø—Ä–æ—Å—Ç—ã—Ö = –±—ã—Å—Ç—Ä–æ–µ –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ = –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞ (‚àí10%)
      simpleRatioMultiplier = 0.90;
    } else if (simpleRatio > 0.5) {
      // 50-70% –ø—Ä–æ—Å—Ç—ã—Ö = —É–º–µ—Ä–µ–Ω–Ω–æ –∫–æ—Ä–æ—á–µ (‚àí5%)
      simpleRatioMultiplier = 0.95;
    } else if (simpleRatio < 0.2 && nutrients.totalCarbs > 20) {
      // <20% –ø—Ä–æ—Å—Ç—ã—Ö + –º–Ω–æ–≥–æ —É–≥–ª–µ–≤–æ–¥–æ–≤ = –º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ = –¥–ª–∏–Ω–Ω–µ–µ –≤–æ–ª–Ω–∞ (+5%)
      simpleRatioMultiplier = 1.05;
    }

    // –§–∏–Ω–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: –≤—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã
    // multipliers.total —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç GI + protein + fiber + fat + liquid + insulinogenic (—Å–æ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤–Ω—É—Ç—Ä–∏)
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –±–æ–Ω—É—Å—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ = —É–∫–æ—Ä–∞—á–∏–≤–∞—é—Ç –≤–æ–ª–Ω—É):
    // - üÜï v3.4.0: activityContext –∑–∞–º–µ–Ω—è–µ—Ç workout + postprandial (–∫–æ–≥–¥–∞ –µ—Å—Ç—å)
    // - fasting, alcohol, caffeine, stress, sleep ‚Äî –¥—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã
    // - üÜï v2.0: sleepQuality, hydration, age, bmi, gender, transFat, cycle
    // - üÜï v3.0.0: meal stacking bonus
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: age, bmi, gender —É–∂–µ —É—á—Ç–µ–Ω—ã –≤ effectiveBaseWaveHours (v3.0.0 Personal Baseline)
    // –ü–æ—ç—Ç–æ–º—É –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ personalBonuses!

    // üÜï v3.4.0: –ï—Å–ª–∏ –µ—Å—Ç—å activityContext ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä—ã—Ö –±–æ–Ω—É—Å–æ–≤
    // ActivityContext –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç: peri-workout, post-workout, pre-workout, steps, morning, double
    let activityBonuses;
    if (activityContext && activityContext.waveBonus) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)
      // NEAT –∏ steps –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–æ–Ω–æ–≤—ã–µ –±–æ–Ω—É—Å—ã (–æ–Ω–∏ stack–∞—é—Ç—Å—è)
      activityBonuses = (activityContext.waveBonus + neatBonus.bonus) * dayFactorsScale;
    } else {
      // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (–µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
      activityBonuses = (workoutBonus.bonus + postprandialBonus.bonus + neatBonus.bonus + stepsBonus.bonus) * dayFactorsScale;
    }

    const metabolicBonuses = (fastingBonus + alcoholBonus + caffeineBonus + stressBonus + sleepBonus) * dayFactorsScale;
    // üÜï v3.0.0: –£–±—Ä–∞–Ω—ã ageBonus, bmiBonus, genderBonus ‚Äî –æ–Ω–∏ —É–∂–µ –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –±–∞–∑–µ
    const personalBonuses = (sleepQualityBonus + hydrationBonus + transFatBonus + cycleBonusValue) * dayFactorsScale;
    // üÜï v3.0.0: Meal Stacking ‚Äî –µ—Å–ª–∏ –ø—Ä–∏—ë–º –±—ã–ª —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É, –≤–æ–ª–Ω—ã "–Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è"
    const mealStackingBonus = (mealStackingResult.stackBonus || 0) * dayFactorsScale;

    // ü•î v3.2.0: Resistant starch ‚Äî –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–µ –∫—Ä–∞—Ö–º–∞–ª—ã —É–∫–æ—Ä–∞—á–∏–≤–∞—é—Ç –≤–æ–ª–Ω—É
    const resistantStarchBonus = hasResistantStarchInMeal ? RESISTANT_STARCH_BONUS.cooled : 0;

    // üå°Ô∏è v3.8.0: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–∏—â–∏ ‚Äî –≥–æ—Ä—è—á–µ–µ/—Ö–æ–ª–æ–¥–Ω–æ–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —É—Å–≤–æ–µ–Ω–∏—è
    const foodTemperature = detectFoodTemperature(lastMeal.items || [], (item) => getProductFromItem(item, pIndex));
    const temperatureBonus = foodTemperature.bonus || 0;

    // üçΩÔ∏è v3.8.0: –ë–æ–ª—å—à–∏–µ –ø–æ—Ä—Ü–∏–∏ ‚Äî –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è
    const mealKcal = nutrients.totalKcal || 0;
    const largePortionBonus = calculateLargePortionBonus(mealKcal);

    // ‚ö° v3.8.0: –†–∏—Å–∫ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≥–∏–ø–æ–≥–ª–∏–∫–µ–º–∏–∏ ‚Äî –¥–ª—è UI –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    const hypoglycemiaRisk = getHypoglycemiaWarning({
      gi: nutrients.avgGI,
      protein: nutrients.totalProtein,
      fat: nutrients.totalFat,
      isFasted: sorted.length <= 1  // –ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –∑–∞ –¥–µ–Ω—å = –Ω–∞—Ç–æ—â–∞–∫
    });

    // ü•õ v3.8.0: Insulin Index Wave Modifier ‚Äî –º–æ–ª–æ—á–∫–∞ = –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞
    const insulinIndexModifier = getInsulinIndexWaveModifier(nutrients.insulinogenicType);

    // üßä v3.2.0: –•–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —É–ª—É—á—à–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    const coldExposureResult = getColdExposureBonus(dayData);
    const coldExposureBonus = coldExposureResult.bonus || 0;

    // üß™ v3.2.0: –î–æ–±–∞–≤–∫–∏ (—É–∫—Å—É—Å, –∫–æ—Ä–∏—Ü–∞, –±–µ—Ä–±–µ—Ä–∏–Ω) ‚Äî —Å–Ω–∏–∂–∞—é—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    const supplementsResult = getSupplementsBonus(lastMeal);
    const supplementsBonusValue = supplementsResult.bonus || 0;

    // üîÑ v3.2.0: –ê—É—Ç–æ—Ñ–∞–≥–∏—è ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ —É–ª—É—á—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    const autophagyResult = getAutophagyPhase(fastingHours);
    const autophagyBonus = -(autophagyResult.bonus || 0); // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞

    // üÜï v3.4.0: Harm multiplier –æ—Ç activityContext (–¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ)
    const activityHarmMultiplier = activityContext?.harmMultiplier || 1.0;

    // üÜï v3.6.0: Next-Day Training Effect (NDTE) ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –≤—á–µ—Ä–∞—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Mikines 1988, Magkos 2008 ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 12-48—á
    let ndteResult = { active: false, waveReduction: 0, peakReduction: 0 };
    if (dayData.date && dayData.lsGet) {
      const prevTrainings = getPreviousDayTrainings(dayData.date, dayData.lsGet);
      if (prevTrainings.totalKcal >= 200) {
        const heightM = (+profile.height || 170) / 100;
        const userBmi = (profile.weight && heightM) ? profile.weight / (heightM * heightM) : 22;
        ndteResult = calculateNDTE({
          trainingKcal: prevTrainings.totalKcal,
          hoursSince: prevTrainings.hoursSince,
          bmi: userBmi,
          trainingType: prevTrainings.dominantType || 'cardio',
          trainingsCount: prevTrainings.trainings.length
        });
      }
    }
    // NDTE –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (1 - waveReduction)
    const ndteMultiplier = ndteResult.active ? (1 - ndteResult.waveReduction) : 1.0;

    const allBonuses = activityBonuses + metabolicBonuses + personalBonuses + mealStackingBonus + resistantStarchBonus + coldExposureBonus + supplementsBonusValue + autophagyBonus + temperatureBonus + largePortionBonus.bonus;

    // –¶–∏—Ä–∫–∞–¥–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: –ø—Ä–∏–±–ª–∏–∂–∞–µ–º –∫ 1.0 –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL
    // üÜï v3.4.0: –ï—Å–ª–∏ activityContext —Å nightPenaltyOverride ‚Äî –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ
    let scaledCircadian = 1.0 + (circadian.multiplier - 1.0) * circadianScale;
    if (activityContext?.nightPenaltyOverride && circadian.multiplier > 1.0) {
      // –ù–æ—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Üí –Ω–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –æ—Ç–º–µ–Ω—ë–Ω
      scaledCircadian = 1.0;
    }

    // üÜï v3.5.2: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ‚Äî activityBonuses –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∫ –ú–ù–û–ñ–ò–¢–ï–õ–¨, –Ω–µ —Å—É–º–º–∞!
    // 
    // –ü–†–û–ë–õ–ï–ú–ê v3.5.1: activityBonuses = -0.70 —Å–∫–ª–∞–¥—ã–≤–∞–ª—Å—è —Å multipliersTotal = 1.35
    // –†–µ–∑—É–ª—å—Ç–∞—Ç: 1.35 + (-0.70) = 0.65 ‚Üí –≤–æ–ª–Ω–∞ —Å–æ–∫—Ä–∞—â–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ 35%
    // 
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–∫—Ä–∞—â–∞—Ç—å –≤–æ–ª–Ω—É –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç —Å–æ—Å—Ç–∞–≤–∞ –µ–¥—ã!
    // –ñ–∏—Ä—ã/–±–µ–ª–æ–∫ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –≤–æ–ª–Ω—É (–µ–¥–∞ –¥–æ–ª—å—à–µ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è)
    // –ù–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ù–ê–ü–†–Ø–ú–£–Æ —É—Å–∫–æ—Ä—è–µ—Ç —É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –≥–ª—é–∫–æ–∑—ã —á–µ—Ä–µ–∑ GLUT4
    // 
    // –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞:
    // 1) foodMultiplier = multipliers.total + otherBonuses (–µ–¥–∞ + –º–µ—Ç–∞–±–æ–ª–∏–∑–º)
    // 2) activityMultiplier = 1 + activityBonuses (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å)
    // 3) finalMultiplier = foodMultiplier √ó activityMultiplier √ó circadian

    // –†–∞–∑–¥–µ–ª—è–µ–º –±–æ–Ω—É—Å—ã: –µ–¥–∞/–º–µ—Ç–∞–±–æ–ª–∏–∑–º vs –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    // üÜï v3.8.0: –î–æ–±–∞–≤–ª–µ–Ω—ã temperatureBonus –∏ largePortionBonus
    const otherBonuses = metabolicBonuses + personalBonuses + mealStackingBonus + resistantStarchBonus + coldExposureBonus + supplementsBonusValue + autophagyBonus + temperatureBonus + largePortionBonus.bonus;
    const foodMultiplier = multipliers.total + otherBonuses;
    // üÜï v3.8.0: Insulin Index Wave Modifier ‚Äî –º–æ–ª–æ—á–∫–∞ —É–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤–æ–ª–Ω—É
    const insulinIndexWaveMult = insulinIndexModifier.waveMultiplier || 1.0;
    // üÜï v4.2.3: –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è liquid + liquidDairy (–∏–∑–±–µ–≥–∞–µ–º –¥–≤–æ–π–Ω–æ–≥–æ —à—Ç—Ä–∞—Ñ–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
    const liquidDairyCompensation = (nutrients.hasLiquid && nutrients.insulinogenicType === 'liquidDairy') ? 1.08 : 1.0;
    const activityMultiplier = Math.max(0.1, 1.0 + activityBonuses); // min 10% –æ—Ç –≤–æ–ª–Ω—ã

    // üÜï v3.6.0: NDTE –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–∞–≤–∞ –µ–¥—ã)
    // üÜï v3.8.0: Insulin Index Wave Mult ‚Äî –º–æ–ª–æ—á–∫–∞ –¥–µ–ª–∞–µ—Ç –≤–æ–ª–Ω—É –ö–û–†–û–ß–ï (Holt 1997)
    // üÜï v3.8.5: Simple Ratio Mult ‚Äî —Å–∞—Ö–∞—Ä = –±—ã—Å—Ç—Ä–µ–µ –ø–∏–∫, –∫–æ—Ä–æ—á–µ –≤–æ–ª–Ω–∞
    // üÜï v4.0.0: IR Score ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    let finalMultiplier = foodMultiplier * activityMultiplier * ndteMultiplier * scaledCircadian * spicyMultiplier * insulinIndexWaveMult * simpleRatioMultiplier * irScoreMultiplier * liquidDairyCompensation;

    // üî¨ v3.7.5: –§–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç ‚Äî –≤–æ–ª–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ √ó1.5 –æ—Ç –±–∞–∑—ã
    // –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ –¥–∞–∂–µ –ø—Ä–∏
    // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö –≤–æ–ª–Ω–∞ —Ä–µ–¥–∫–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 4-4.5 —á–∞—Å–∞ (√ó1.5 –æ—Ç –±–∞–∑—ã 3—á)
    // Brand-Miller 2003: High-GL meal ‚âà 3-4 —á–∞—Å–∞ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    const MAX_MULTIPLIER = 1.50;
    if (finalMultiplier > MAX_MULTIPLIER) {
      finalMultiplier = MAX_MULTIPLIER;
    }

    // üÜï v3.0.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –±–∞–∑—É –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö 3 —á–∞—Å–æ–≤
    // –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã
    let adjustedWaveHours = effectiveBaseWaveHours * finalMultiplier;
    // –ó–∞—â–∏—Ç–∞ –æ—Ç NaN
    if (isNaN(adjustedWaveHours) || adjustedWaveHours <= 0) {
      adjustedWaveHours = effectiveBaseWaveHours || 3;
    }
    let waveMinutes = adjustedWaveHours * 60;

    // üÜï v3.0.0: –§–∞–∑—ã –≤–æ–ª–Ω—ã (–ø–æ–¥—ä—ë–º, –ø–ª–∞—Ç–æ, —Å–ø–∞–¥)
    const hasRecentActivity = activityBonuses < -0.05; // –ë—ã–ª–∞ –∫–∞–∫–∞—è-—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    const wavePhases = calculateWavePhases(waveMinutes, nutrients, hasRecentActivity);

    // –í—Ä–µ–º—è
    // mealMinutes –º–æ–∂–µ—Ç –±—ã—Ç—å 24:xx (1440+) –¥–ª—è –Ω–æ—á–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ "—Å–µ–≥–æ–¥–Ω—è –¥–æ 3 –Ω–æ—á–∏"
    const mealMinutes = utils.timeToMinutes(lastMealTime);
    let nowMinutes = now.getHours() * 60 + now.getMinutes();

    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å:
    // –ï—Å–ª–∏ –ø—Ä–∏—ë–º –±—ã–ª –≤ 24:xx —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–æ—á–Ω–æ–π) –∏ —Å–µ–π—á–∞—Å 00:xx-02:xx ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º 24—á –∫ now
    if (mealMinutes >= 24 * 60 && nowMinutes < 3 * 60) {
      nowMinutes += 24 * 60;
    }

    let diffMinutes = nowMinutes - mealMinutes;

    // üîß FIX v3.9.2: –ï—Å–ª–∏ diffMinutes < 0, –∑–Ω–∞—á–∏—Ç –ø–µ—Ä–µ—à–ª–∏ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å
    // –ü—Ä–∏–º–µ—Ä: –ø—Ä–∏—ë–º 16:45 (1005 –º–∏–Ω), —Å–µ–π—á–∞—Å 02:00 (120 –º–∏–Ω) ‚Üí diff = -885
    // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 24 —á–∞—Å–∞ (1440 –º–∏–Ω) –∫ now: 120 + 1440 - 1005 = 555 –º–∏–Ω (~9.25—á) ‚úÖ
    if (diffMinutes < 0) {
      diffMinutes += 24 * 60; // –î–æ–±–∞–≤–ª—è–µ–º 24 —á–∞—Å–∞
    }

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–Ω–µ –¥–æ–ª–∂–Ω–æ —Å–ª—É—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞)
    if (diffMinutes < 0) diffMinutes = 0;

    // üÜï v3.7.4: –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≥–æ–ª–æ–¥–∞–Ω–∏—è (—Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –¥–æ —Å–µ–π—á–∞—Å)
    // –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç fastingHours (–≤—Ä–µ–º—è –î–û –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞, –¥–ª—è –±–æ–Ω—É—Å–∞)
    const currentFastingHours = diffMinutes / 60;

    let remainingMinutes = Math.max(0, waveMinutes - diffMinutes);
    const progressPct = Math.min(100, (diffMinutes / waveMinutes) * 100);

    // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
    const endMinutes = mealMinutes + Math.round(waveMinutes);
    const endTime = utils.minutesToTime(endMinutes);

    // === –ò—Å—Ç–æ—Ä–∏—è –≤–æ–ª–Ω –∑–∞ –¥–µ–Ω—å ===
    // –ü–æ–ª—É—á–∞–µ–º MEAL_TYPES –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏—ë–º–æ–≤
    const MEAL_TYPES = (HEYS.dayUtils && HEYS.dayUtils.MEAL_TYPES) || {};
    const getMealTypeName = (meal) => {
      const type = meal.mealType || meal.name;
      if (type && MEAL_TYPES[type]) {
        return MEAL_TYPES[type].icon + ' ' + MEAL_TYPES[type].name;
      }
      // Fallback –ø–æ –∏–º–µ–Ω–∏
      if (meal.name) return meal.name;
      // –ü–æ –≤—Ä–µ–º–µ–Ω–∏
      const h = parseInt((meal.time || '').split(':')[0]) || 12;
      if (h < 10) return 'üç≥ –ó–∞–≤—Ç—Ä–∞–∫';
      if (h < 12) return 'üçé –ü–µ—Ä–µ–∫—É—Å';
      if (h < 15) return 'üç≤ –û–±–µ–¥';
      if (h < 17) return 'ü•ú –ü–µ—Ä–µ–∫—É—Å';
      if (h < 20) return 'üçΩÔ∏è –£–∂–∏–Ω';
      return 'üåô –ù–æ—á–Ω–æ–π';
    };

    const waveHistory = sorted.map((meal, idx) => {
      const t = meal.time;
      if (!t) return null;

      const startMin = utils.timeToMinutes(t);
      const mealHour = parseInt(t.split(':')[0]) || 12;
      const mealNutrients = calculateMealNutrients(meal, pIndex, getProductFromItem);

      // üçé v3.2.0: –§–æ—Ä–º–∞ –ø–∏—â–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
      let historyFoodForm = null;
      for (const item of (meal.items || [])) {
        const prod = getProductFromItem(item, pIndex);
        const itemForm = getFoodForm(prod);
        if (itemForm === 'liquid') historyFoodForm = 'liquid';
        else if (itemForm === 'processed' && historyFoodForm !== 'liquid') historyFoodForm = 'processed';
        else if (itemForm === 'whole' && !historyFoodForm) historyFoodForm = 'whole';
      }

      const mealMult = calculateMultiplier(
        mealNutrients.avgGI,
        mealNutrients.totalProtein,
        mealNutrients.totalFiber,
        mealNutrients.totalCarbs,
        mealNutrients.totalFat,
        mealNutrients.glycemicLoad,
        mealNutrients.hasLiquid,
        mealNutrients.insulinogenicBonus,
        historyFoodForm,  // üÜï v3.2.0
        mealNutrients.dominantProteinType || 'mixed' // üÜï v4.2.3
      );

      // üÜï v4.2.3: Activity Context –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –∑–∞—Ä–∞–Ω–µ–µ,
      // —á—Ç–æ–±—ã activityBonus –∏ –±–µ–π–¥–∂ –æ–ø–∏—Ä–∞–ª–∏—Å—å –Ω–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∏—Å—Ç–æ—á–Ω–∏–∫.
      const mealActivityContext = calculateActivityContext({
        mealTimeMin: startMin,
        trainings,
        steps: dayData.steps || 0,
        householdMin: dayData.householdMin || 0,
        weight: dayData.profile?.weight || 70,
        allMeals: sorted,
        mealNutrients: {
          prot: mealNutrients.totalProtein,
          carbs: mealNutrients.totalCarbs,
          simple: mealNutrients.totalSimple || 0
        },
        mealKcal: mealNutrients.totalKcal || 0
      });

      // üÜï –ü—Ä–∏–º–µ–Ω—è–µ–º –í–°–ï –¥–Ω–µ–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –µ–¥–∞)
      const dayFactors = calculateDayFactorsForMeal(dayData, mealHour);
      const activityFactors = calculateActivityFactorsForMeal(
        trainings,
        startMin,
        dayData.householdMin || 0,
        dayData.steps || 0
      );

      // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-09 v2: GL-—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω–µ–≤–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
      // –ü—Ä–∏ –Ω–∏–∑–∫–æ–π GL –¥–Ω–µ–≤–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã (—Å—Ç—Ä–µ—Å—Å, –Ω–µ–¥–æ—Å—ã–ø, —Ü–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã) 
      // –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ, —Ç.–∫. –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –ò–ù–°–£–õ–ò–ù–û–†–ï–ó–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨,
      // –Ω–æ –µ—Å–ª–∏ –∏–Ω—Å—É–ª–∏–Ω–∞ –º–∞–ª–æ ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –º–∏–Ω–∏–º–∞–ª–µ–Ω
      // –ö–õ–Æ–ß–ï–í–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø: —É—Å–∏–ª–µ–Ω–æ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ü–∏—Ä–∫–∞–¥–Ω–æ–≥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è –ø—Ä–∏ GL < 10
      const gl = mealNutrients.glycemicLoad;
      let dayFactorsScale = 1.0;
      let circadianScale = 1.0;
      if (gl !== null && gl < 20) {
        // –§–æ—Ä–º—É–ª–∞: 0.3 + (GL/20) * 0.7 
        // GL=0 ‚Üí 0.3, GL=10 ‚Üí 0.65, GL=20 ‚Üí 1.0
        dayFactorsScale = Math.max(0.3, 0.3 + (gl / 20) * 0.7);
        // –¶–∏—Ä–∫–∞–¥–Ω—ã–µ —Ä–∏—Ç–º—ã ‚Äî –ë–û–õ–ï–ï –ê–ì–†–ï–°–°–ò–í–ù–û–ï –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL
        // –§–æ—Ä–º—É–ª–∞: 0.2 + (GL/20) * 0.8 ‚Üí GL=7: 0.48, GL=10: 0.6, GL=20: 1.0
        circadianScale = Math.max(0.2, 0.2 + (gl / 20) * 0.8);
      }

      // üÜï v3.0.1: –°–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –±–∞–∑—ã –ø–æ GL –¥–ª—è waveHistory
      let scaledBaseWaveHours = effectiveBaseWaveHours;
      if (gl !== null && isFinite(gl) && gl < 10) {
        const baseScaleFactor = Math.max(0.85, 0.85 + (gl / 10) * 0.15);
        scaledBaseWaveHours = scaledBaseWaveHours * baseScaleFactor;
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
      const scaledDayBonus = dayFactors.totalBonus * dayFactorsScale;
      const selectedActivityBonus = mealActivityContext?.waveBonus ?? activityFactors.totalBonus;
      const scaledActivityBonus = selectedActivityBonus * dayFactorsScale;
      // –¶–∏—Ä–∫–∞–¥–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: –ø—Ä–∏–±–ª–∏–∂–∞–µ–º –∫ 1.0 –ø—Ä–∏ –Ω–∏–∑–∫–æ–π GL
      // –ï—Å–ª–∏ circadian = 1.2 (–Ω–æ—á—å) –∏ circadianScale = 0.5, —Ç–æ: 1.0 + (1.2-1.0)*0.5 = 1.1
      const scaledCircadian = 1.0 + (dayFactors.circadianMultiplier - 1.0) * circadianScale;

      // –ï–¥–∞-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –±–æ–Ω—É—Å—ã
      const spicyMultiplier = mealNutrients.hasSpicy ? SPICY_FOOD.multiplier : 1.0;
      const alcoholBonus = mealNutrients.alcoholBonus || 0;
      const caffeineBonus = mealNutrients.hasCaffeine ? CAFFEINE_BONUS.bonus : 0;
      const transFatBonus = calculateTransFatBonus(mealNutrients.totalTrans || 0);

      // üÜï v3.2.2: –î–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–∞—Å—á—ë—Ç–µ
      // - resistant starch (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ meal items)
      let hasResistantStarchInMeal = false;
      for (const item of (meal.items || [])) {
        const prod = getProductFromItem(item, pIndex);
        if (hasResistantStarch(prod)) {
          hasResistantStarchInMeal = true;
          break;
        }
      }
      const resistantStarchBonus = hasResistantStarchInMeal ? RESISTANT_STARCH_BONUS.cooled : 0;

      // - cold exposure, supplements, autophagy (–∏–∑ dayData)
      const coldExposureResult = getColdExposureBonus(dayData);
      const coldExposureBonus = coldExposureResult.bonus || 0;

      const supplementsResult = getSupplementsBonus(meal);
      const supplementsBonusValue = supplementsResult.bonus || 0;

      // Fasting hours –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∏—ë–º–∞
      const mealsBeforeThis = sorted.slice(idx + 1); // sorted –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω DESC, –ø–æ—ç—Ç–æ–º—É idx+1 = –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏–µ
      let fastingHoursForMeal = 0;
      if (mealsBeforeThis.length > 0) {
        const prevMealTime = mealsBeforeThis[0].time;
        if (prevMealTime) {
          const prevMin = utils.timeToMinutes(prevMealTime);
          fastingHoursForMeal = (startMin - prevMin) / 60;
        }
      } else {
        // –ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –¥–Ω—è ‚Äî —Å—á–∏—Ç–∞–µ–º –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏ –∏–ª–∏ –æ—Ç —Å–Ω–∞
        fastingHoursForMeal = startMin / 60;
      }
      const autophagyResult = getAutophagyPhase(fastingHoursForMeal);
      const autophagyBonus = -(autophagyResult.bonus || 0);

      // üî¨ –ù–ê–£–ß–ù–´–ô –ê–£–î–ò–¢ 2025-12-09: –ï–¥–∞-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –±–æ–Ω—É—Å—ã —Ç–æ–∂–µ —Å–∫–∞–ª–∏—Ä—É—é—Ç—Å—è –ø–æ GL
      // –ü—Ä–∏ GL < 5 –∫–æ—Ñ–µ–∏–Ω/–∞–ª–∫–æ–≥–æ–ª—å/—Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã –∏–º–µ—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
      // (–±–µ–∑ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–≥–æ –≤—Å–ø–ª–µ—Å–∫–∞ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤–æ–ª–Ω—É –º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
      const mealSpecificBonuses = (alcoholBonus + caffeineBonus + transFatBonus) * dayFactorsScale;

      // üÜï v3.7.2: –£–ù–ò–§–ò–ö–ê–¶–ò–Ø —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞—Å—á—ë—Ç–æ–º
      // –†–∞–∑–¥–µ–ª—è–µ–º –±–æ–Ω—É—Å—ã: –µ–¥–∞/–º–µ—Ç–∞–±–æ–ª–∏–∑–º vs –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∫ –ú–ù–û–ñ–ò–¢–ï–õ–¨, –Ω–µ —Å—É–º–º–∞!
      const otherBonuses = scaledDayBonus + mealSpecificBonuses +
        resistantStarchBonus + coldExposureBonus + supplementsBonusValue + autophagyBonus;
      const foodMultiplier = mealMult.total + otherBonuses;
      const activityMultiplier = Math.max(0.1, 1.0 + scaledActivityBonus); // min 10% –æ—Ç –≤–æ–ª–Ω—ã

      // üÜï v4.2.4: –¥–æ–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É–ª—É –¥–æ –ø–æ–ª–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É
      // –†–∞–Ω–µ–µ waveHistory –ø—Ä–æ–ø—É—Å–∫–∞–ª 3 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –º–Ω–æ–∂–∏—Ç–µ–ª—è, —á—Ç–æ –¥–∞–≤–∞–ª–æ –Ω–µ–≤–µ—Ä–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –≤–æ–ª–Ω—ã.
      const mealInsIndexModifier = getInsulinIndexWaveModifier(mealNutrients.insulinogenicType);
      const mealInsIndexWaveMult = mealInsIndexModifier.waveMultiplier || 1.0;

      const mealSimpleRatio = mealNutrients.simpleRatio || 0;
      let mealSimpleRatioMult = 1.0;
      if (mealSimpleRatio > 0.7) mealSimpleRatioMult = 0.90;
      else if (mealSimpleRatio > 0.5) mealSimpleRatioMult = 0.95;
      else if (mealSimpleRatio < 0.2 && mealNutrients.totalCarbs > 20) mealSimpleRatioMult = 1.05;

      // irScoreMultiplier –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –≤–Ω–µ—à–Ω–µ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ (–≤—ã—á–∏—Å–ª–µ–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—Å–µ–≥–æ –¥–Ω—è)
      // liquidDairyCompensation: –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ liquidMult (–∏–∑ mealMult.total) –∏ mealInsIndexWaveMult
      const liquidDairyCompensation = (mealNutrients.hasLiquid && mealNutrients.insulinogenicType === 'liquidDairy') ? 1.08 : 1.0;

      // –ï–¥–∏–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ ‚Äî –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É (v4.2.4)
      let finalMultiplier = foodMultiplier * activityMultiplier * ndteMultiplier * scaledCircadian * spicyMultiplier * mealInsIndexWaveMult * mealSimpleRatioMult * irScoreMultiplier * liquidDairyCompensation;

      // üÜï v4.2.5: MAX_MULTIPLIER cap –¥–ª—è waveHistory (—Ä–∞–Ω–µ–µ –ø—Ä–∏–º–µ–Ω—è–ª—Å—è —Ç–æ–ª—å–∫–æ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É)
      if (finalMultiplier > 1.50) finalMultiplier = 1.50;

      // üî¨ DEBUG v3.2.2: –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ (–æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è production)
      // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
      // if (idx === sorted.length - 1) {
      //   console.log('[waveHistory v3.2.2 DETAILS]', { mealMult: mealMult.total, allBonuses, scaledCircadian, finalMultiplier });
      // }

      // üÜï v3.0.1: –ò—Å–ø–æ–ª—å–∑—É–µ–º scaledBaseWaveHours (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–∞, —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ GL)
      const duration = Math.round(scaledBaseWaveHours * finalMultiplier * 60);
      const endMin = startMin + duration;

      return {
        time: t,
        timeDisplay: utils.normalizeTimeForDisplay(t),
        startMin,
        endMin,
        endTimeDisplay: utils.minutesToTime(endMin),
        duration,
        waveHours: duration / 60, // üÜï –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Å–∞—Ö
        baseWaveHours: scaledBaseWaveHours, // üÜï v3.0.1: –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–∞, —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ GL
        finalMultiplier, // üÜï –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        // üÜï v3.7.1: NDTE –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ popup
        ndteMultiplier,
        ndteData: ndteResult.active ? {
          waveReduction: ndteResult.waveReduction,
          trainingKcal: ndteResult.trainingKcal,
          hoursSince: ndteResult.hoursSince
        } : null,
        mealName: getMealTypeName(meal),
        mealType: meal.mealType || null,
        gi: mealNutrients.avgGI,
        gl: mealNutrients.glycemicLoad,
        protein: mealNutrients.totalProtein,
        fiber: mealNutrients.totalFiber,
        carbs: mealNutrients.totalCarbs,
        fat: mealNutrients.totalFat,
        carbsMultiplier: mealMult.carbs,
        fatBonus: mealMult.fat,
        glCategory: mealMult.glCategory,
        hasLiquid: mealNutrients.hasLiquid,
        liquidMultiplier: mealMult.liquid,
        insulinogenicType: mealNutrients.insulinogenicType,
        insulinogenicBonus: mealMult.insulinogenic,
        // üÜï –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
        dayFactorsBonus: scaledDayBonus,
        activityBonus: scaledActivityBonus,
        circadianMultiplier: scaledCircadian,
        dayFactorsScale, // üÜï –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        // üÜï v3.4.0: Activity Context
        activityContext: mealActivityContext ? {
          type: mealActivityContext.type,
          badge: mealActivityContext.badge,
          desc: mealActivityContext.desc,
          waveBonus: mealActivityContext.waveBonus,
          harmMultiplier: mealActivityContext.harmMultiplier || 1.0,
          nightPenaltyOverride: mealActivityContext.nightPenaltyOverride || false,
          details: mealActivityContext.details || null,
          trainingRef: mealActivityContext.trainingRef || null
        } : null,
        isActive: idx === 0 && remainingMinutes > 0
      };
    }).filter(Boolean).reverse();

    // üÜï v3.2.2: –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º adjustedWaveHours –∏–∑ waveHistory!
    // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Å—á—ë—Ç (adjustedWaveHours) —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (v3.2.x).
    // waveHistory –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∏—Å—Ç–æ—Ä–∏–∏.
    // UI –≤–æ–ª–Ω—ã –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞.
    const lastMealWave = waveHistory.length > 0 ? waveHistory[waveHistory.length - 1] : null;
    // üî¨ v3.2.2: –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ–º waveHistory –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç
    if (lastMealWave) {
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º waveHistory —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞—Å—á—ë—Ç–æ–º (–∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç!)
      lastMealWave.waveHours = adjustedWaveHours;
      lastMealWave.duration = Math.round(adjustedWaveHours * 60);
      lastMealWave.endMin = lastMealWave.startMin + lastMealWave.duration;
      lastMealWave.endTimeDisplay = utils.minutesToTime(lastMealWave.endMin);
      lastMealWave.finalMultiplier = finalMultiplier; // üÜï –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è
      lastMealWave.baseWaveHours = effectiveBaseWaveHours; // üÜï –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
    }
    // waveMinutes —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–ª–æ–∫–µ
    // remainingMinutes —Ç–æ–∂–µ

    // === –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –≤–æ–ª–Ω ===
    const overlaps = [];
    for (let i = 0; i < waveHistory.length - 1; i++) {
      const current = waveHistory[i];
      const next = waveHistory[i + 1];
      if (current.endMin > next.startMin) {
        const overlapMin = current.endMin - next.startMin;
        overlaps.push({
          from: current.time,
          fromDisplay: current.timeDisplay,
          to: next.time,
          toDisplay: next.timeDisplay,
          overlapMinutes: overlapMin,
          severity: overlapMin > 60 ? 'high' : overlapMin > 30 ? 'medium' : 'low'
        });
      }
    }

    // === –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
    const gaps = [];
    for (let i = 0; i < waveHistory.length - 1; i++) {
      gaps.push(waveHistory[i + 1].startMin - waveHistory[i].startMin);
    }
    const avgGapToday = gaps.length > 0
      ? Math.round(gaps.reduce((a, b) => a + b, 0) / gaps.length)
      : 0;

    // –ò—Å—Ç–æ—Ä–∏—è gaps
    let gapHistory = [];
    try {
      gapHistory = JSON.parse(localStorage.getItem(GAP_HISTORY_KEY) || '[]');
    } catch (e) { }

    const today = now.toISOString().slice(0, 10);
    const todayEntry = gapHistory.find(g => g.date === today);
    if (avgGapToday > 0) {
      const oldAvg = todayEntry?.avgGap;
      const oldCount = todayEntry?.count;

      if (todayEntry) {
        todayEntry.avgGap = avgGapToday;
        todayEntry.count = gaps.length;
      } else {
        gapHistory.push({ date: today, avgGap: avgGapToday, count: gaps.length });
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å sync)
      const needsSave = !todayEntry || oldAvg !== avgGapToday || oldCount !== gaps.length;
      if (needsSave) {
        gapHistory = gapHistory.slice(-GAP_HISTORY_DAYS);
        try {
          localStorage.setItem(GAP_HISTORY_KEY, JSON.stringify(gapHistory));
        } catch (e) { }
      }
    }

    const personalAvgGap = gapHistory.length > 0
      ? Math.round(gapHistory.reduce((sum, g) => sum + g.avgGap, 0) / gapHistory.length)
      : 0;

    const recommendedGap = Math.round(baseWaveHours * 60);

    let gapQuality = 'unknown';
    if (personalAvgGap > 0) {
      if (personalAvgGap >= recommendedGap * 0.9) gapQuality = 'excellent';
      else if (personalAvgGap >= recommendedGap * 0.75) gapQuality = 'good';
      else if (personalAvgGap >= recommendedGap * 0.5) gapQuality = 'moderate';
      else gapQuality = 'needs-work';
    }

    // === –°—Ç–∞—Ç—É—Å ===
    const currentHour = now.getHours();
    const isNight = utils.isNightTime(currentHour);

    let status, emoji, text, color, subtext;

    if (remainingMinutes <= 0) {
      status = 'lipolysis';
      emoji = STATUS_CONFIG.lipolysis.emoji;
      text = STATUS_CONFIG.lipolysis.label;
      color = STATUS_CONFIG.lipolysis.color;

      // –õ–∏–ø–æ–ª–∏–∑ –∞–∫—Ç–∏–≤–µ–Ω! –ü–æ–æ—â—Ä—è–µ–º –ø—Ä–æ–¥–ª–∏—Ç—å —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      if (isNight) {
        subtext = 'üåô –ò–¥–µ–∞–ª—å–Ω–æ! –ù–æ—á–Ω–æ–π –ª–∏–ø–æ–ª–∏–∑ –¥–æ —É—Ç—Ä–∞';
      } else {
        subtext = 'üí™ –ñ–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏–µ –∏–¥—ë—Ç! –ü—Ä–æ–¥–µ—Ä–∂–∏—Å—å –ø–æ–¥–æ–ª—å—à–µ';
      }
    } else if (remainingMinutes <= 15) {
      status = 'almost';
      emoji = STATUS_CONFIG.almost.emoji;
      text = `${Math.ceil(remainingMinutes)} –º–∏–Ω`;
      color = STATUS_CONFIG.almost.color;
      subtext = '‚è≥ –°–∫–æ—Ä–æ –Ω–∞—á–Ω—ë—Ç—Å—è –ª–∏–ø–æ–ª–∏–∑!';
    } else if (remainingMinutes <= 30) {
      status = 'soon';
      emoji = STATUS_CONFIG.soon.emoji;
      text = `${Math.ceil(remainingMinutes)} –º–∏–Ω`;
      color = STATUS_CONFIG.soon.color;
      subtext = 'üçµ –í–æ–¥–∞ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ª–∏–ø–æ–ª–∏–∑';
    } else {
      status = 'active';
      emoji = STATUS_CONFIG.active.emoji;
      text = utils.formatDuration(remainingMinutes);
      color = STATUS_CONFIG.active.color;
      subtext = 'üìà –ò–Ω—Å—É–ª–∏–Ω –≤—ã—Å–æ–∫–∏–π, –∂–∏—Ä –∑–∞–ø–∞—Å–∞–µ—Ç—Å—è';
    }

    // üî• –í—Ä–µ–º—è –ª–∏–ø–æ–ª–∏–∑–∞ (—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ —Å –∫–æ–Ω—Ü–∞ –≤–æ–ª–Ω—ã)
    // diffMinutes - –≤—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞
    // waveMinutes - –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã (—É–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å waveHistory)
    // lipolysisMinutes = diffMinutes - waveMinutes (–≤—Ä–µ–º—è –ü–û–°–õ–ï –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ–ª–Ω—ã)
    const lipolysisMinutes = diffMinutes > waveMinutes ? Math.round(diffMinutes - waveMinutes) : 0;

    // üÜï v4.0.0: 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è Gaussian –∫—Ä–∏–≤–∞—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∏–≤—É—é —Å 3 –ø–∏–∫–∞–º–∏: fast (–±—ã—Å—Ç—Ä—ã–µ —É–≥–ª.), slow (—Å–ª–æ–∂–Ω—ã–µ —É–≥–ª.), hepatic (–ø–µ—á—ë–Ω–æ—á–Ω—ã–π)
    const waveCurve = generateWaveCurve(waveMinutes, nutrients, {
      hasTraining: !!activityContext?.type,
      trainingType: activityContext?.type,
      isNightTime: isNight
    });

    return {
      // –°—Ç–∞—Ç—É—Å
      status, emoji, text, color, subtext,

      // –ü—Ä–æ–≥—Ä–µ—Å—Å
      progress: progressPct,
      remaining: remainingMinutes,
      lipolysisMinutes,

      // –í—Ä–µ–º—è (–¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ö—Ä–∞–Ω–∏–º –∫–∞–∫ –µ—Å—Ç—å, –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º)
      lastMealTime,
      lastMealTimeDisplay: utils.normalizeTimeForDisplay(lastMealTime),
      endTime,
      endTimeDisplay: utils.normalizeTimeForDisplay(endTime),

      // –í–æ–ª–Ω–∞
      insulinWaveHours: adjustedWaveHours,
      waveHours: adjustedWaveHours, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      duration: Math.round(adjustedWaveHours * 60), // üÜï –í –º–∏–Ω—É—Ç–∞—Ö –¥–ª—è UI
      finalMultiplier, // üÜï –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ popup "–ë–∞–∑–∞ √ó –ú–Ω–æ–∂–∏—Ç–µ–ª—å"
      baseWaveHours: effectiveBaseWaveHours, // üÜï v3.0.0: —Ç–µ–ø–µ—Ä—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–∞

      // üÜï v4.0.0: 3-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è Gaussian –∫—Ä–∏–≤–∞—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
      curve: waveCurve.curve,                    // –ú–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ {t, y} –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
      gaussian: waveCurve,                       // –ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
      waveShape: waveCurve.shape,                // 'spike' | 'balanced' | 'prolonged'
      waveShapeDesc: waveCurve.shapeDesc,        // –†—É—Å—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã
      curveComponents: waveCurve.components,     // {fast, slow, hepatic} ‚Äî 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
      curvePeakMinutes: waveCurve.peakMinutes,   // –ú–∏–Ω—É—Ç–∞ –ø–∏–∫–∞ –¥–ª—è UI
      curveAUC: waveCurve.auc,                   // –ü–ª–æ—â–∞–¥—å –ø–æ–¥ –∫—Ä–∏–≤–æ–π

      // üÜï v3.0.0: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –≤–æ–ª–Ω—ã
      personalBaseline,

      // üÜï v4.0.0: IR Score ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∏–Ω—Å—É–ª–∏–Ω–æ—Ä–µ–∑–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
      irScore,

      // üÜï v3.0.0: –§–∞–∑—ã –≤–æ–ª–Ω—ã (–ø–æ–¥—ä—ë–º, –ø–ª–∞—Ç–æ, —Å–ø–∞–¥)
      wavePhases,
      currentPhase: (() => {
        if (remainingMinutes <= 0) return 'lipolysis';
        if (!wavePhases) return 'active'; // Fallback –µ—Å–ª–∏ —Ñ–∞–∑—ã –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã
        const elapsed = waveMinutes - remainingMinutes;
        const riseDur = wavePhases.rise?.duration || 20;
        const plateauDur = wavePhases.plateau?.duration || 60;
        if (elapsed <= riseDur) return 'rise';
        if (elapsed <= riseDur + plateauDur) return 'plateau';
        return 'decline';
      })(),

      // üÜï v3.0.0: Meal Stacking (–Ω–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–ª–Ω)
      mealStacking: mealStackingResult,
      hasMealStacking: mealStackingResult.hasStacking,

      // –§–ª–∞–≥–∏
      isNightTime: isNight,

      // –ì–ò –¥–∞–Ω–Ω—ã–µ
      avgGI: nutrients.avgGI,
      gi: nutrients.avgGI, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      giCategory: multipliers.category,
      giMultiplier: multipliers.gi,

      // –ù—É—Ç—Ä–∏–µ–Ω—Ç—ã
      totalProtein: nutrients.totalProtein,
      protein: nutrients.totalProtein, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      totalFiber: nutrients.totalFiber,
      fiber: nutrients.totalFiber, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      totalCarbs: nutrients.totalCarbs,
      carbs: nutrients.totalCarbs, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      totalSimple: nutrients.totalSimple,
      totalFat: nutrients.totalFat,
      fat: nutrients.totalFat, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      glycemicLoad: nutrients.glycemicLoad,
      gl: nutrients.glycemicLoad, // üÜï –ê–ª–∏–∞—Å –¥–ª—è UI popup
      proteinBonus: multipliers.protein,
      fiberBonus: multipliers.fiber,
      fatBonus: multipliers.fat,
      carbsMultiplier: multipliers.carbs,
      glCategory: multipliers.glCategory,

      // ü•§ –ñ–∏–¥–∫–∞—è –ø–∏—â–∞
      hasLiquid: nutrients.hasLiquid,
      liquidRatio: nutrients.liquidRatio,
      liquidMultiplier: multipliers.liquid,

      // ü•õ –ò–Ω—Å—É–ª–∏–Ω–æ–≥–µ–Ω–Ω–æ—Å—Ç—å (–º–æ–ª–æ—á–∫–∞, –±–µ–ª–æ–∫)
      insulinogenicType: nutrients.insulinogenicType,
      insulinogenicBonus: multipliers.insulinogenic,

      // üèÉ Workout –¥–∞–Ω–Ω—ã–µ
      workoutBonus: workoutBonus.bonus,
      workoutMinutes: workoutBonus.totalMinutes,
      workoutDesc: workoutBonus.desc,
      hasWorkoutBonus: workoutBonus.bonus < 0,

      // üåÖ Circadian –¥–∞–Ω–Ω—ã–µ
      circadianMultiplier: circadian.multiplier,
      circadianPeriod: circadian.period,
      circadianDesc: circadian.desc,

      // üÜï v1.4: –ù–æ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã

      // üçΩÔ∏è –ì–æ–ª–æ–¥–∞–Ω–∏–µ (fasting)
      fastingHours: Math.round(fastingHours * 10) / 10,
      fastingBonus,
      hasFastingBonus: fastingBonus > 0,

      // üå∂Ô∏è –û—Å—Ç—Ä–∞—è –ø–∏—â–∞
      hasSpicy: nutrients.hasSpicy,
      spicyMultiplier,
      hasSpicyBonus: nutrients.hasSpicy,

      // üç∑ –ê–ª–∫–æ–≥–æ–ª—å
      hasAlcohol: nutrients.hasAlcohol,
      alcoholBonus,
      alcoholType: nutrients.alcoholType,
      hasAlcoholBonus: alcoholBonus > 0,

      // ‚òï –ö–æ—Ñ–µ–∏–Ω
      hasCaffeine: nutrients.hasCaffeine,
      caffeineBonus,
      hasCaffeineBonus: caffeineBonus > 0,

      // üò∞ –°—Ç—Ä–µ—Å—Å
      stressLevel,
      stressBonus,
      hasStressBonus: stressBonus > 0,

      // üò¥ –ù–µ–¥–æ—Å—ã–ø (sleepBonus)
      sleepHoursTracked: sleepHours,
      sleepDeprivationBonus: sleepBonus,
      hasSleepBonus: sleepBonus > 0,

      // üÜï v1.5: –§–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ü–û–°–õ–ï –µ–¥—ã

      // üèÉ‚Äç‚ôÇÔ∏è –ü–æ—Å—Ç–ø—Ä–∞–Ω–¥–∏–∞–ª—å–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
      postprandialBonus: postprandialBonus.bonus,
      postprandialDesc: postprandialBonus.desc,
      postprandialGapMinutes: postprandialBonus.gapMinutes,
      hasPostprandialBonus: postprandialBonus.bonus < 0,
      postprandialTraining: postprandialBonus.matchedTraining,

      // üè° NEAT ‚Äî –±—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      householdMin: householdMinutes,
      neatBonus: neatBonus.bonus,
      neatDesc: neatBonus.desc,
      hasNeatBonus: neatBonus.bonus < 0,

      // üö∂ –®–∞–≥–∏
      steps,
      stepsBonus: stepsBonus.bonus,
      stepsDesc: stepsBonus.desc,
      hasStepsBonus: stepsBonus.bonus < 0,

      // üÜï v3.4.0: Activity Context ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      activityContext: activityContext ? {
        type: activityContext.type,
        badge: activityContext.badge,
        desc: activityContext.desc,
        waveBonus: activityContext.waveBonus,
        harmMultiplier: activityContext.harmMultiplier || 1.0,
        nightPenaltyOverride: activityContext.nightPenaltyOverride || false,
        trainingRef: activityContext.trainingRef,
        details: activityContext.details,
        allContexts: activityContext.allContexts
      } : null,
      hasActivityContext: !!activityContext,
      activityContextType: activityContext?.type || null,
      activityContextBadge: activityContext?.badge || null,

      // üìä –°—É–º–º–∞—Ä–Ω—ã–π –±–æ–Ω—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–¥–ª—è UI)
      activityBonusTotal: activityBonuses,
      hasAnyActivityBonus: activityBonuses < 0,
      activityBonusPct: Math.abs(Math.round(activityBonuses * 100)),
      // üÜï v3.4.0: Harm multiplier –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
      activityHarmMultiplier,

      // üÜï v3.6.0: Next-Day Training Effect (NDTE) ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –≤—á–µ—Ä–∞—à–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      ndte: ndteResult,
      hasNDTE: ndteResult.active,
      ndteWaveReduction: ndteResult.waveReduction,
      ndteTdeeBoost: ndteResult.tdeeBoost,
      ndteMultiplier: ndteMultiplier,
      ndteBadge: ndteResult.badge,
      ndteLabel: ndteResult.label,

      // –ò—Å—Ç–æ—Ä–∏—è
      waveHistory,

      // –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏—è
      overlaps,
      hasOverlaps: overlaps.length > 0,
      worstOverlap: overlaps.reduce((max, o) =>
        o.overlapMinutes > (max?.overlapMinutes || 0) ? o : max, null),

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      avgGapToday,
      personalAvgGap,
      recommendedGap,
      gapQuality,
      gapHistory: gapHistory.slice(-7),

      // === –ù–û–í–´–ï –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –î–ê–ù–ù–´–ï ===

      // üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –µ–¥–µ (–µ—Å–ª–∏ –≤–æ–ª–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞)
      foodAdvice: remainingMinutes > 0 ? {
        good: ['–≤–æ–¥–∞', '—á–∞–π –±–µ–∑ —Å–∞—Ö–∞—Ä–∞', '–∫–æ—Ñ–µ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞'],
        avoid: ['—Å–ª–∞–¥–∫–æ–µ', '–±–µ–ª—ã–π —Ö–ª–µ–±', '—Å–æ–∫', '—Ñ—Ä—É–∫—Ç—ã', '–ª—é–±–∞—è –µ–¥–∞'],
        reason: '–õ—é–±–∞—è –µ–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏ –ø—Ä–æ–¥–ª–∏—Ç –≤–æ–ª–Ω—É'
      } : null,

      // ‚è∞ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏—ë–º–∞
      nextMealTime: (() => {
        const endMin = utils.timeToMinutes(lastMealTime) + Math.round(waveMinutes);
        // –ï—Å–ª–∏ –Ω–æ—á—å ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —É—Ç—Ä–æ
        if (isNight || endMin >= 22 * 60) {
          return { time: '08:00', isNextDay: true, label: '–∑–∞–≤—Ç—Ä–∞ –≤ 8:00' };
        }
        const time = utils.minutesToTime(endMin);
        return { time, isNextDay: false, label: `–≤ ${time}` };
      })(),

      // üíß Hydration —Å–æ–≤–µ—Ç
      hydrationAdvice: remainingMinutes > 15
        ? 'üíß –í–æ–¥–∞ —É—Å–∫–æ—Ä—è–µ—Ç –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ ‚Äî –≤—ã–ø–µ–π —Å—Ç–∞–∫–∞–Ω'
        : null,

      // üò¥ Sleep impact (–ø–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω)
      sleepImpact: (() => {
        const hour = parseInt(lastMealTime.split(':')[0]) || 0;
        if (hour >= 21) {
          return {
            warning: true,
            text: 'üò¥ –ü–æ–∑–¥–Ω–∏–π —É–∂–∏–Ω –∑–∞–º–µ–¥–ª—è–µ—Ç –≤–æ–ª–Ω—É –Ω–∞ ~20%',
            penalty: 0.2
          };
        }
        if (hour >= 20) {
          return {
            warning: false,
            text: 'üåô –í–µ—á–µ—Ä–Ω–∏–π –ø—Ä–∏—ë–º ‚Äî –≤–æ–ª–Ω–∞ —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ',
            penalty: 0.1
          };
        }
        return null;
      })(),

      // üéØ –ö—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
      quickTip: (() => {
        if (remainingMinutes <= 0) return 'üî• –õ–∏–ø–æ–ª–∏–∑! –î–µ—Ä–∂–∏—Å—å!';
        if (remainingMinutes <= 15) return '‚è≥ –°–∫–æ—Ä–æ –ª–∏–ø–æ–ª–∏–∑!';
        if (nutrients.avgGI > 70) return '‚ö†Ô∏è –ë—ã–ª –≤—ã—Å–æ–∫–∏–π –ì–ò ‚Äî –ª—É—á—à–µ –ø–æ–¥–æ–∂–¥–∞—Ç—å';
        if (remainingMinutes > 60) return 'üçµ –í—ã–ø–µ–π –≤–æ–¥—ã –∏–ª–∏ —á–∞—è';
        return '‚è≥ –î–∞–π –æ—Ä–≥–∞–Ω–∏–∑–º—É –ø–µ—Ä–µ–≤–∞—Ä–∏—Ç—å';
      })(),

      // üÜï v3.2.0: –•–æ–ª–æ–¥–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ
      coldExposure: coldExposureResult,
      hasColdExposure: coldExposureResult.hasCold,
      coldExposureBonus,

      // üÜï v3.2.0: –î–æ–±–∞–≤–∫–∏ (—É–∫—Å—É—Å, –∫–æ—Ä–∏—Ü–∞, –±–µ—Ä–±–µ—Ä–∏–Ω)
      supplements: supplementsResult,
      hasSupplements: supplementsResult.hasSupplements,
      supplementsBonus: supplementsBonusValue,

      // üÜï v3.2.0: –ê—É—Ç–æ—Ñ–∞–≥–∏—è (—Ä–∞—Å—á—ë—Ç –±–æ–Ω—É—Å–∞ –¥–ª—è –≤–æ–ª–Ω—ã ‚Äî –ø–æ fastingHours –î–û –ø—Ä–∏—ë–º–∞)
      autophagyBonus,
      // üÜï v3.7.4: –¢–µ–∫—É—â–∞—è –∞—É—Ç–æ—Ñ–∞–≥–∏—è (–¥–ª—è UI ‚Äî –ø–æ currentFastingHours, –≤—Ä–µ–º—è –ü–û–°–õ–ï –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞)
      autophagy: getAutophagyPhase(currentFastingHours),
      currentFastingHours: Math.round(currentFastingHours * 10) / 10,
      isAutophagyActive: (() => {
        const currentPhase = getAutophagyPhase(currentFastingHours);
        return currentPhase.phase === 'active' || currentPhase.phase === 'deep' || currentPhase.phase === 'extended';
      })(),

      // üèÜ –†–µ–∫–æ—Ä–¥ –ª–∏–ø–æ–ª–∏–∑–∞
      lipolysisRecord: getLipolysisRecord(),

      // üî• Streak –ª–∏–ø–æ–ª–∏–∑–∞
      lipolysisStreak: calculateLipolysisStreak(),

      // üí™ –ü—Ä–∏–º–µ—Ä–Ω–æ —Å–æ–∂–∂—ë–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ (–µ—Å–ª–∏ –ª–∏–ø–æ–ª–∏–∑ –∞–∫—Ç–∏–≤–µ–Ω)
      lipolysisKcal: lipolysisMinutes > 0 ? calculateLipolysisKcal(lipolysisMinutes) : 0,

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥
      isNewRecord: lipolysisMinutes > 0 && lipolysisMinutes > getLipolysisRecord().minutes,

      // üÜï v3.8.0: –ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
      // –†–∏—Å–∫ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≥–∏–ø–æ–≥–ª–∏–∫–µ–º–∏–∏
      hypoglycemiaRisk,
      hasHypoglycemiaRisk: hypoglycemiaRisk?.hasRisk || false,

      // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–∏—â–∏ (–≥–æ—Ä—è—á–∞—è/—Ö–æ–ª–æ–¥–Ω–∞—è)
      foodTemperature,
      temperatureBonus,
      hasTemperatureEffect: Math.abs(temperatureBonus) > 0.02,

      // –ë–æ–ª—å—à–∏–µ –ø–æ—Ä—Ü–∏–∏ (–Ω–µ–ª–∏–Ω–µ–π–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ)
      largePortionBonus,
      hasLargePortionEffect: largePortionBonus?.bonus > 0,

      // Insulin Index –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–æ–ª–Ω—ã
      insulinIndexModifier,
      insulinIndexWaveMult,

      // Smooth circadian multiplier (v3.8.0)
      circadianSmooth: scaledCircadian
    };
  };


  /**
   * React Hook –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
   * 
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã hook
   * @param {Array} params.meals - –º–∞—Å—Å–∏–≤ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
   * @param {Object} params.pIndex - –∏–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @param {Function} params.getProductFromItem - —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   * @param {number} [params.baseWaveHours=3] - –±–∞–∑–æ–≤–∞—è –¥–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã
   * @param {Array} [params.trainings=[]] - –º–∞—Å—Å–∏–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
   * @param {Object} [params.dayData={}] - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @returns {Object} –¥–∞–Ω–Ω—ã–µ –≤–æ–ª–Ω—ã —Å —Ö—É–∫–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   */
  const useInsulinWave = ({ meals, pIndex, getProductFromItem, baseWaveHours = 3, trainings = [], dayData = {} }) => {
    const [expanded, setExpanded] = React.useState(false);
    const [isShaking, setIsShaking] = React.useState(false);

    // –¢–µ–∫—É—â–∞—è –º–∏–Ω—É—Ç–∞ –¥–ª—è –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const [currentMinute, setCurrentMinute] = React.useState(() => {
      const now = new Date();
      return now.getHours() * 60 + now.getMinutes();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    React.useEffect(() => {
      const interval = setInterval(() => {
        const now = new Date();
        setCurrentMinute(now.getHours() * 60 + now.getMinutes());
      }, 60000);
      return () => clearInterval(interval);
    }, []);

    // –†–∞—Å—á—ë—Ç –¥–∞–Ω–Ω—ã—Ö
    const data = React.useMemo(() => {
      return calculateInsulinWaveData({
        meals,
        pIndex,
        getProductFromItem,
        baseWaveHours,
        trainings,
        dayData
      });
    }, [meals, pIndex, baseWaveHours, trainings, dayData, currentMinute]);

    // Shake –ø—Ä–∏ almost
    React.useEffect(() => {
      if (data?.status === 'almost' && !isShaking) {
        setIsShaking(true);
        setTimeout(() => setIsShaking(false), 500);
      }
    }, [data?.status]);

    const toggle = React.useCallback(() => setExpanded(prev => !prev), []);

    return {
      data,
      expanded,
      setExpanded,
      toggle,
      isShaking,
      renderProgressBar: () => data ? renderProgressBar(data) : null,
      renderWaveHistory: () => data ? renderWaveHistory(data) : null,
      renderExpandedSection: () => data ? renderExpandedSection(data) : null
    };
  };


  // === –≠–ö–°–ü–û–†–¢ ===
  // üîÑ REFACTOR v4.2.1: –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ Object.assign

  HEYS.InsulinWave = HEYS.InsulinWave || {};

  // –ì–ª–∞–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ)
  Object.assign(HEYS.InsulinWave, {
    calculate: calculateInsulinWaveData,
    useInsulinWave,
    VERSION: '4.2.5'
  });

  // === –î–ï–õ–ï–ì–ò–†–û–í–ê–ù–ò–ï –ö –ú–û–î–£–õ–Ø–ú ===

  // UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  if (UI) Object.assign(HEYS.InsulinWave, {
    renderProgressBar: UI.renderProgressBar,
    renderWaveHistory: UI.renderWaveHistory,
    renderExpandedSection: UI.renderExpandedSection,
    MealWaveExpandSection: UI.MealWaveExpandSection,
    renderActivityContextBadge: UI.renderActivityContextBadge
  });

  if (Graph) HEYS.InsulinWave.renderWaveChart = Graph.renderWaveChart;
  if (NDTE_UI) HEYS.InsulinWave.renderNDTEBadge = NDTE_UI.renderNDTEBadge;

  // –†–∞—Å—á—ë—Ç—ã
  if (Calc) Object.assign(HEYS.InsulinWave, {
    utils,
    calculateMealNutrients: Calc.calculateMealNutrients,
    calculateMultiplier: Calc.calculateMultiplier,
    calculateWorkoutBonus: Calc.calculateWorkoutBonus,
    calculateCircadianMultiplier: Calc.calculateCircadianMultiplier,
    calculatePostprandialExerciseBonus: Calc.calculatePostprandialExerciseBonus,
    calculateNEATBonus: Calc.calculateNEATBonus,
    calculateStepsBonus: Calc.calculateStepsBonus
  });

  // v3.0 —Ñ–∏—á–∏
  if (V30) Object.assign(HEYS.InsulinWave, {
    calculateContinuousGLMultiplier: V30.calculateContinuousGLMultiplier,
    calculatePersonalBaselineWave: V30.calculatePersonalBaselineWave,
    calculateMealStackingBonus: V30.calculateMealStackingBonus,
    calculateWavePhases: V30.calculateWavePhases,
    calculateInsulinIndex: V30.calculateInsulinIndex,
    getWaveCalculationDebug: V30.getWaveCalculationDebug
  });

  // v4.1 —Ñ–∏—á–∏
  if (V41) Object.assign(HEYS.InsulinWave, {
    calculateMetabolicFlexibility: V41.calculateMetabolicFlexibility,
    calculateSatietyScore: V41.calculateSatietyScore,
    calculateAdaptiveDeficit: V41.calculateAdaptiveDeficit,
    METABOLIC_FLEXIBILITY_CONFIG: V41.METABOLIC_FLEXIBILITY_CONFIG,
    SATIETY_MODEL_CONFIG: V41.SATIETY_MODEL_CONFIG,
    ADAPTIVE_DEFICIT_CONFIG: V41.ADAPTIVE_DEFICIT_CONFIG
  });

  // Lipolysis
  if (Lipolysis) Object.assign(HEYS.InsulinWave, {
    getLipolysisRecord: Lipolysis.getLipolysisRecord,
    updateLipolysisRecord: Lipolysis.updateLipolysisRecord,
    saveDayLipolysis: Lipolysis.saveDayLipolysis,
    calculateLipolysisStreak: Lipolysis.calculateLipolysisStreak,
    calculateLipolysisKcal: Lipolysis.calculateLipolysisKcal
  });

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ __internals (–º–∞—Å—Å–æ–≤–æ–µ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  if (I) Object.assign(HEYS.InsulinWave, {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    GI_CATEGORIES, STATUS_CONFIG,
    PROTEIN_BONUS: I.PROTEIN_BONUS, FIBER_BONUS: I.FIBER_BONUS,
    FAT_BONUS: I.FAT_BONUS, LIQUID_FOOD: I.LIQUID_FOOD,
    INSULINOGENIC_BONUS: I.INSULINOGENIC_BONUS,
    GL_CATEGORIES: I.GL_CATEGORIES, GL_CONTINUOUS: I.GL_CONTINUOUS,
    PERSONAL_BASELINE: I.PERSONAL_BASELINE, MEAL_STACKING: I.MEAL_STACKING,
    WAVE_PHASES: I.WAVE_PHASES, INSULIN_INDEX_FACTORS: I.INSULIN_INDEX_FACTORS,
    WORKOUT_BONUS: I.WORKOUT_BONUS, POSTPRANDIAL_EXERCISE: I.POSTPRANDIAL_EXERCISE,
    NEAT_BONUS: I.NEAT_BONUS, STEPS_BONUS: I.STEPS_BONUS,
    CIRCADIAN_MULTIPLIERS: I.CIRCADIAN_MULTIPLIERS, CIRCADIAN_CONFIG: I.CIRCADIAN_CONFIG,
    FASTING_BONUS: I.FASTING_BONUS, SPICY_FOOD: I.SPICY_FOOD,
    ALCOHOL_BONUS: I.ALCOHOL_BONUS, CAFFEINE_BONUS: I.CAFFEINE_BONUS,
    STRESS_BONUS: I.STRESS_BONUS, SLEEP_BONUS: I.SLEEP_BONUS,
    SLEEP_QUALITY_BONUS: I.SLEEP_QUALITY_BONUS, HYDRATION_BONUS: I.HYDRATION_BONUS,
    AGE_BONUS: I.AGE_BONUS, BMI_BONUS: I.BMI_BONUS, GENDER_BONUS: I.GENDER_BONUS,
    TRANS_FAT_BONUS: I.TRANS_FAT_BONUS, FOOD_FORM_BONUS: I.FOOD_FORM_BONUS,
    RESISTANT_STARCH_BONUS: I.RESISTANT_STARCH_BONUS,
    LIPOLYSIS_THRESHOLDS: I.LIPOLYSIS_THRESHOLDS,
    REACTIVE_HYPOGLYCEMIA: I.REACTIVE_HYPOGLYCEMIA,
    FOOD_TEMPERATURE_BONUS: I.FOOD_TEMPERATURE_BONUS,
    LARGE_PORTION_BONUS: I.LARGE_PORTION_BONUS,
    MIN_LIPOLYSIS_FOR_STREAK: I.MIN_LIPOLYSIS_FOR_STREAK,
    TRAINING_CONTEXT: I.TRAINING_CONTEXT, NDTE: I.NDTE,
    IR_SCORE_CONFIG: I.IR_SCORE_CONFIG, PROTEIN_BONUS_V2: I.PROTEIN_BONUS_V2,
    AUC_CONFIG: I.AUC_CONFIG, INSULIN_PREDICTOR_CONFIG: I.INSULIN_PREDICTOR_CONFIG,
    WAVE_SCORING_V2: I.WAVE_SCORING_V2, SUPPLEMENTS_BONUS: I.SUPPLEMENTS_BONUS,
    COLD_EXPOSURE_BONUS: I.COLD_EXPOSURE_BONUS, AUTOPHAGY_TIMER: I.AUTOPHAGY_TIMER,
    // –§—É–Ω–∫—Ü–∏–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞)
    isLiquidFood: I.isLiquidFood, getInsulinogenicBonus: I.getInsulinogenicBonus,
    isSpicyFood: I.isSpicyFood, getAlcoholBonus: I.getAlcoholBonus,
    hasCaffeine: I.hasCaffeine, calculateStressBonus: I.calculateStressBonus,
    calculateSleepBonus: I.calculateSleepBonus, calculateFastingBonus: I.calculateFastingBonus,
    calculateSleepQualityBonus: I.calculateSleepQualityBonus,
    calculateHydrationBonus: I.calculateHydrationBonus,
    calculateAgeBonus: I.calculateAgeBonus, calculateBMIBonus: I.calculateBMIBonus,
    getGenderBonus: I.getGenderBonus, calculateTransFatBonus: I.calculateTransFatBonus,
    getFoodForm: I.getFoodForm, hasResistantStarch: I.hasResistantStarch,
    estimateInsulinLevel: I.estimateInsulinLevel,
    calculateHypoglycemiaRisk: I.calculateHypoglycemiaRisk,
    getHypoglycemiaWarning: I.getHypoglycemiaWarning,
    detectFoodTemperature: I.detectFoodTemperature,
    calculateLargePortionBonus: I.calculateLargePortionBonus,
    getInsulinIndexWaveModifier: I.getInsulinIndexWaveModifier,
    calculateActivityContext: I.calculateActivityContext, calculateIRScore: I.calculateIRScore,
    detectProteinType: I.detectProteinType, calculateProteinBonusV2: I.calculateProteinBonusV2,
    calculateBMI: I.calculateBMI, getBMICategory: I.getBMICategory,
    isValidTraining: I.isValidTraining, calculateNDTE: I.calculateNDTE,
    calculateNDTEBMIMultiplier: I.calculateNDTEBMIMultiplier,
    calculateNDTEDecay: I.calculateNDTEDecay,
    getPreviousDayTrainings: I.getPreviousDayTrainings,
    getSupplementsBonus: I.getSupplementsBonus, getColdExposureBonus: I.getColdExposureBonus,
    getAutophagyPhase: I.getAutophagyPhase, generateWaveCurve: I.generateWaveCurve,
    calculateTrapezoidalAUC: I.calculateTrapezoidalAUC,
    calculateIncrementalAUC: I.calculateIncrementalAUC, calculateFullAUC: I.calculateFullAUC,
    getInsulinLevelAtTime: I.getInsulinLevelAtTime,
    predictInsulinResponse: I.predictInsulinResponse,
    generatePredictionSummary: I.generatePredictionSummary,
    calculateWaveScore: I.calculateWaveScore, scorePeakHeight: I.scorePeakHeight,
    scoreDuration: I.scoreDuration, scoreWaveShape: I.scoreWaveShape,
    scoreAUC: I.scoreAUC, scoreContext: I.scoreContext
  });

  // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —á—Ç–æ InsulinWave –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å—á—ë—Ç–∞–º
  try {
    document.dispatchEvent(new CustomEvent('heys-insulinwave-ready'));
    console.info('[HEYS.InsulinWave] ‚úÖ heys-insulinwave-ready dispatched (v' + HEYS.InsulinWave.VERSION + ')');
  } catch (_) { }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_iw_version_info.js ===== */
// heys_iw_version_info.js ‚Äî InsulinWave Module Version Information
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2026-01-12
//
// –û–ü–ò–°–ê–ù–ò–ï:
// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏—è—Ö –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π InsulinWave.
// –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π.

(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö InsulinWave
   * @returns {Object} –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª—è—Ö
   */
  const getModulesInfo = () => {
    const IW = HEYS.InsulinWave || {};
    
    const modules = {
      main: {
        name: 'Main Orchestrator',
        version: IW.VERSION || 'unknown',
        loaded: !!IW.calculate && !!IW.useInsulinWave,
        file: 'heys_insulin_wave_v1.js'
      },
      calc: {
        name: IW.Calc?.__name || 'Calc',
        version: IW.Calc?.__version || 'unknown',
        loaded: !!IW.Calc?.calculateMealNutrients,
        file: 'heys_iw_calc.js'
      },
      orchestrator: {
        name: IW.Orchestrator?.__name || 'Orchestrator',
        version: IW.Orchestrator?.__version || 'unknown',
        loaded: !!IW.Orchestrator?.prepareWaveData,
        file: 'heys_iw_orchestrator.js'
      },
      v30: {
        name: 'v3.0 Features',
        version: IW.V30?.__version || '3.0.0',
        loaded: !!IW.V30?.calculateContinuousGLMultiplier,
        file: 'heys_iw_v30.js'
      },
      v41: {
        name: 'v4.1 Features',
        version: IW.V41?.__version || '4.1.0',
        loaded: !!IW.V41?.calculateMetabolicFlexibility,
        file: 'heys_iw_v41.js'
      },
      ui: {
        name: 'UI Components',
        version: IW.UI?.__version || '1.0.0',
        loaded: !!IW.UI?.MealWaveExpandSection,
        file: 'heys_iw_ui.js'
      },
      graph: {
        name: 'Graph',
        version: IW.Graph?.__version || '1.0.0',
        loaded: !!IW.Graph?.renderWaveChart,
        file: 'heys_iw_graph.js'
      },
      ndte: {
        name: 'NDTE',
        version: IW.NDTE?.__version || '1.0.0',
        loaded: !!IW.NDTE?.renderNDTEBadge,
        file: 'heys_iw_ndte.js'
      },
      lipolysis: {
        name: 'Lipolysis',
        version: IW.Lipolysis?.__version || '1.0.0',
        loaded: !!IW.Lipolysis?.getLipolysisRecord,
        file: 'heys_iw_lipolysis.js'
      },
      utils: {
        name: 'Utils',
        version: IW.utils?.__version || '1.0.0',
        loaded: !!IW.utils?.timeToMinutes,
        file: 'heys_iw_utils.js'
      },
      constants: {
        name: 'Constants',
        version: IW.__internals?.__version || '1.0.0',
        loaded: !!IW.__internals?.GI_CATEGORIES,
        file: 'heys_iw_constants.js'
      }
    };
    
    const summary = {
      totalModules: Object.keys(modules).length,
      loadedModules: Object.values(modules).filter(m => m.loaded).length,
      failedModules: Object.values(modules).filter(m => !m.loaded).length
    };
    
    return { modules, summary };
  };
  
  /**
   * –í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª—è—Ö –≤ –∫–æ–Ω—Å–æ–ª—å (–∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
   */
  const printModulesInfo = () => {
    const info = getModulesInfo();
    
    console.log('%c InsulinWave Modules Info ', 'background: #3b82f6; color: white; font-weight: bold; padding: 4px 8px; border-radius: 4px;');
    console.log('');
    
    console.table(
      Object.entries(info.modules).map(([key, mod]) => ({
        Module: mod.name,
        Version: mod.version,
        Status: mod.loaded ? '‚úÖ Loaded' : '‚ùå Not loaded',
        File: mod.file
      }))
    );
    
    console.log('');
    console.log(`%c Summary: ${info.summary.loadedModules}/${info.summary.totalModules} modules loaded `, 
      info.summary.failedModules === 0 
        ? 'background: #22c55e; color: white; padding: 2px 6px; border-radius: 3px;'
        : 'background: #ef4444; color: white; padding: 2px 6px; border-radius: 3px;'
    );
    
    if (info.summary.failedModules > 0) {
      console.warn('‚ö†Ô∏è Some modules failed to load. Check the network tab for errors.');
    }
    
    return info;
  };
  
  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—Å–µ –ª–∏ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
   * @returns {boolean} true –µ—Å–ª–∏ –≤—Å–µ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
   */
  const checkAllModulesLoaded = () => {
    const info = getModulesInfo();
    return info.summary.failedModules === 0;
  };
  
  // === –≠–ö–°–ü–û–†–¢ ===
  HEYS.InsulinWave = HEYS.InsulinWave || {};
  HEYS.InsulinWave.VersionInfo = {
    getModulesInfo,
    printModulesInfo,
    checkAllModulesLoaded,
    __version: '1.0.0',
    __name: 'InsulinWave.VersionInfo'
  };
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ dev —Ä–µ–∂–∏–º–µ
  if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => printModulesInfo(), 500);
      });
    }
  }
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_cycle_v1.js ===== */
// heys_cycle_v1.js ‚Äî –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (–æ—Å–æ–±–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞)
// –í–µ—Ä—Å–∏—è: 1.0.0 | –î–∞—Ç–∞: 2025-12-08
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const U = HEYS.utils || {};

  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const readStoredValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      const raw = localStorage.getItem(key);
      if (raw !== null && raw !== undefined) return tryParseStoredValue(raw, fallback);
      return fallback;
    } catch {
      return fallback;
    }
  };

  const writeStoredValue = (key, value) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(key, value);
        return;
      }
      const serialized = typeof value === 'string' ? value : JSON.stringify(value);
      localStorage.setItem(key, serialized);
    } catch { }
  };

  // ============================================================
  // –ö–û–ù–°–¢–ê–ù–¢–´ –§–ê–ó –¶–ò–ö–õ–ê
  // ============================================================

  /**
   * –§–∞–∑—ã –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è–º–∏
   * 
   * –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
   * - Barr et al. 2020 "Menstrual cycle phase and metabolic rate"
   * - McNulty et al. 2020 "The Effects of Menstrual Cycle Phase"
   * - Davidsen et al. 2007 "Insulin Sensitivity and Menstrual Cycle"
   */
  const CYCLE_PHASES = {
    // –î–Ω–∏ 1-5: –ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞
    menstrual: {
      name: '–ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–∞—è',
      shortName: '–û—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥',
      days: [1, 2, 3, 4, 5],
      icon: 'üå∏',
      color: '#ec4899', // pink-500
      // –ü–æ–≤—ã—à–µ–Ω–Ω—ã–µ —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç—ã (—Å–ø–∞–∑–º—ã, —Ç–µ—Ä–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è)
      kcalMultiplier: 1.05,     // +5% –∫ –Ω–æ—Ä–º–µ (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–∞)
      waterMultiplier: 1.1,     // +10% –∫ –Ω–æ—Ä–º–µ –≤–æ–¥—ã (–ø–æ—Ç–µ—Ä—è –∂–∏–¥–∫–æ—Å—Ç–∏)
      insulinWaveMultiplier: 1.12, // +12% –∫ –¥–ª–∏–Ω–µ –≤–æ–ª–Ω—ã (—Å–Ω–∏–∂–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
      advice: {
        sweet: true,   // –¢—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É ‚Äî –Ω–æ—Ä–º–∞
        iron: true,    // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∂–µ–ª–µ–∑–µ
        rest: true     // –õ–µ–≥—á–µ —Å –Ω–∞–≥—Ä—É–∑–∫–∞–º–∏
      }
    },

    // –î–Ω–∏ 6-12: –§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∞–∑–∞
    follicular: {
      name: '–§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è',
      shortName: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
      days: [6, 7, 8, 9, 10, 11, 12],
      icon: 'üå±',
      color: '#22c55e', // green-500
      // –≠–Ω–µ—Ä–≥–∏—è —Ä–∞—Å—Ç—ë—Ç, —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
      kcalMultiplier: 1.0,
      waterMultiplier: 1.0,
      insulinWaveMultiplier: 0.95, // -5% (—É–ª—É—á—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
      advice: {
        training: true, // –•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        energy: true    // –≠–Ω–µ—Ä–≥–∏—è –Ω–∞ –ø–æ–¥—ä—ë–º–µ
      }
    },

    // –î–Ω–∏ 13-14: –û–≤—É–ª—è—Ü–∏—è
    ovulation: {
      name: '–û–≤—É–ª—è—Ü–∏—è',
      shortName: '–ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏',
      days: [13, 14],
      icon: '‚≠ê',
      color: '#eab308', // yellow-500
      // –ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–∏–ª—ã
      kcalMultiplier: 1.05,     // +5% (–ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º)
      waterMultiplier: 1.0,
      insulinWaveMultiplier: 0.92, // -8% (–ª—É—á—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
      advice: {
        peakPerformance: true // –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–µ–∫–æ—Ä–¥–æ–≤
      }
    }

    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –õ—é—Ç–µ–∏–Ω–æ–≤–∞—è —Ñ–∞–∑–∞ (–¥–Ω–∏ 15-28) –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è,
    // —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–Ω–∏ "–æ—Å–æ–±–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞"
  };

  // ============================================================
  // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
  // ============================================================

  /**
   * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∞–∑—É —Ü–∏–∫–ª–∞ –ø–æ –¥–Ω—é
   * @param {number|null} cycleDay - –î–µ–Ω—å —Ü–∏–∫–ª–∞ (1-14 –∏–ª–∏ null)
   * @returns {Object|null} –§–∞–∑–∞ —Å –µ—ë –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–ª–∏ null
   */
  function getCyclePhase(cycleDay) {
    if (!cycleDay || typeof cycleDay !== 'number' || cycleDay < 1) {
      return null;
    }

    for (const [key, phase] of Object.entries(CYCLE_PHASES)) {
      if (phase.days.includes(cycleDay)) {
        return {
          id: key,
          day: cycleDay,
          ...phase
        };
      }
    }

    // –î–µ–Ω—å –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —Ç—Ä–µ–∫–∏–Ω–≥–∞ (>14)
    return null;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ü–∏—é –∫–∞–ª–æ—Ä–∏–π –¥–ª—è –¥–Ω—è
   * @param {number|null} cycleDay 
   * @returns {number} –ú–Ω–æ–∂–∏—Ç–µ–ª—å (1.0 = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   */
  function getKcalMultiplier(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    return phase ? phase.kcalMultiplier : 1.0;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ü–∏—é –Ω–æ—Ä–º—ã –≤–æ–¥—ã
   * @param {number|null} cycleDay 
   * @returns {number} –ú–Ω–æ–∂–∏—Ç–µ–ª—å (1.0 = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   */
  function getWaterMultiplier(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    return phase ? phase.waterMultiplier : 1.0;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ü–∏—é –∏–Ω—Å—É–ª–∏–Ω–æ–≤–æ–π –≤–æ–ª–Ω—ã
   * @param {number|null} cycleDay 
   * @returns {number} –ú–Ω–æ–∂–∏—Ç–µ–ª—å (1.0 = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   */
  function getInsulinWaveMultiplier(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    return phase ? phase.insulinWaveMultiplier : 1.0;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –æ—Å–æ–±—ã–π –ø–µ—Ä–∏–æ–¥ (–º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞)
   * @param {number|null} cycleDay 
   * @returns {boolean}
   */
  function isInMenstrualPhase(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    return phase ? phase.id === 'menstrual' : false;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏–∫–æ–Ω–∫—É –∏ —Ü–≤–µ—Ç –¥–ª—è –¥–Ω—è —Ü–∏–∫–ª–∞ (–¥–ª—è UI)
   * @param {number|null} cycleDay 
   * @returns {Object} { icon, color, shortName }
   */
  function getCycleDisplay(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    if (!phase) {
      return { icon: null, color: null, shortName: null };
    }
    return {
      icon: phase.icon,
      color: phase.color,
      shortName: phase.shortName,
      day: cycleDay
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å advice-—Ñ–ª–∞–≥–∏ –¥–ª—è –¥–Ω—è —Ü–∏–∫–ª–∞
   * @param {number|null} cycleDay 
   * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ñ–ª–∞–≥–∞–º–∏ –¥–ª—è advice –º–æ–¥—É–ª—è
   */
  function getCycleAdviceFlags(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    return phase ? (phase.advice || {}) : {};
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–∑—ã –¥–ª—è UI
   * @param {number|null} cycleDay 
   * @returns {string|null}
   */
  function getCycleDescription(cycleDay) {
    const phase = getCyclePhase(cycleDay);
    if (!phase) return null;

    if (phase.id === 'menstrual') {
      return `–î–µ–Ω—å ${cycleDay}: ${phase.shortName}`;
    }
    return `–î–µ–Ω—å ${cycleDay}: ${phase.name}`;
  }

  // ============================================================
  // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–†–û–°–¢–ê–í–õ–ï–ù–ò–ï –î–ù–ï–ô
  // ============================================================

  /**
   * –í—ã—á–∏—Å–ª–∏—Ç—å –¥–∞—Ç—É + N –¥–Ω–µ–π
   * @param {string} dateStr - YYYY-MM-DD
   * @param {number} days - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
   * @returns {string} YYYY-MM-DD
   */
  function addDays(dateStr, days) {
    const d = new Date(dateStr + 'T12:00:00');
    d.setDate(d.getDate() + days);
    return d.toISOString().slice(0, 10);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á localStorage —Å —É—á—ë—Ç–æ–º clientId
   * @param {string} dateStr - YYYY-MM-DD
   * @returns {string} –ü–æ–ª–Ω—ã–π –∫–ª—é—á
   */
  function getDayKey(dateStr) {
    const clientId = (window.HEYS && window.HEYS.currentClientId) || '';
    if (clientId) {
      return 'heys_' + clientId + '_dayv2_' + dateStr;
    }
    return 'heys_dayv2_' + dateStr;
  }

  function readDayData(dateStr, lsGet) {
    const baseKey = 'heys_dayv2_' + dateStr;
    const scopedKey = getDayKey(dateStr);

    if (HEYS.store?.get) {
      return readStoredValue(scopedKey, null);
    }

    if (lsGet) {
      try {
        const v = lsGet(baseKey, null);
        if (v !== null && v !== undefined) return v;
      } catch (e) { }
    }

    return readStoredValue(scopedKey, null);
  }

  function writeDayData(dateStr, value, lsSet) {
    const baseKey = 'heys_dayv2_' + dateStr;
    const scopedKey = getDayKey(dateStr);

    if (HEYS.store?.set) {
      writeStoredValue(scopedKey, value);
      return;
    }

    if (lsSet) {
      try {
        lsSet(baseKey, value);
        return;
      } catch (e) { }
    }

    writeStoredValue(scopedKey, value);
  }

  /**
   * –ü—Ä–æ—Å—Ç–∞–≤–∏—Ç—å –¥–Ω–∏ —Ü–∏–∫–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   * –ü—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ –¥–Ω—è X –Ω–∞ –¥–∞—Ç–µ D:
   * - –î–Ω–∏ 1 –¥–æ X-1 –ø—Ä–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ –ø—Ä–æ—à–ª–æ–µ
   * - –î–Ω–∏ X+1 –¥–æ 7 –ø—Ä–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ –±—É–¥—É—â–µ–µ
   * 
   * @param {string} startDate - YYYY-MM-DD (–¥–∞—Ç–∞ –≥–¥–µ —É–∫–∞–∑–∞–Ω –¥–µ–Ω—å)
   * @param {number} dayNumber - –ö–∞–∫–æ–π –¥–µ–Ω—å —É–∫–∞–∑–∞–Ω (1-7)
   * @param {function} lsGet - –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è –∏–∑ localStorage (IGNORED, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è getDayKey)
   * @param {function} lsSet - –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≤ localStorage (IGNORED, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è getDayKey)
   * @returns {Object} { updated: number, dates: string[] }
   */
  function setCycleDaysAuto(startDate, dayNumber, lsGet, lsSet) {
    if (!startDate || !dayNumber || dayNumber < 1 || dayNumber > 7) {
      return { updated: 0, dates: [] };
    }

    const updatedDates = [];

    // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º 7 –¥–Ω–µ–π
    for (let d = 1; d <= 7; d++) {
      const offset = d - dayNumber; // –°–º–µ—â–µ–Ω–∏–µ –æ—Ç startDate
      const targetDate = addDays(startDate, offset);

      try {
        // –ß–∏—Ç–∞–µ–º store-first —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
        let dayData = readDayData(targetDate, lsGet) || {};

        // –û–±–Ω–æ–≤–ª—è–µ–º cycleDay
        const updated = {
          ...dayData,
          date: targetDate,
          cycleDay: d,
          updatedAt: Date.now()
        };

        // –ü–∏—à–µ–º store-first —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
        writeDayData(targetDate, updated, lsSet);
        updatedDates.push(targetDate);

        // console.log('[Cycle] Set cycleDay=' + d + ' for ' + targetDate + ' (key: ' + key + ')');
      } catch (e) {
        console.warn('[Cycle] Failed to set day', targetDate, e);
      }
    }

    // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ
    if (typeof window !== 'undefined' && window.dispatchEvent) {
      // –û—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã ‚Äî —á—Ç–æ–±—ã DatePicker –æ–±–Ω–æ–≤–∏–ª—Å—è
      updatedDates.forEach(date => {
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { date, field: 'cycleDay', source: 'cycle-auto' }
        }));
        // –¢—Ä–∏–≥–≥–µ—Ä –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        window.dispatchEvent(new CustomEvent('heys:data-saved', {
          detail: { key: `day:${date}`, type: 'cycle' }
        }));
      });
      // –û–±—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è batch-–æ–ø–µ—Ä–∞—Ü–∏–π
      window.dispatchEvent(new CustomEvent('heys:cycle-updated', {
        detail: { dates: updatedDates, startDate, dayNumber }
      }));
    }

    return { updated: updatedDates.length, dates: updatedDates };
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –¥–Ω–∏ —Ü–∏–∫–ª–∞ (—Å–±—Ä–æ—Å–∏—Ç—å)
   * –£–±–∏—Ä–∞–µ—Ç cycleDay —É –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π
   * 
   * @param {string} anyDateInCycle - –õ—é–±–∞—è –¥–∞—Ç–∞ –≤ —Ü–∏–∫–ª–µ
   * @param {function} lsGet - –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è –∏–∑ localStorage (IGNORED, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è getDayKey)
   * @param {function} lsSet - –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≤ localStorage (IGNORED, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è getDayKey)
   * @returns {Object} { cleared: number, dates: string[] }
   */
  function clearCycleDays(anyDateInCycle, lsGet, lsSet) {
    try {
      // –ß–∏—Ç–∞–µ–º store-first
      const dayData = readDayData(anyDateInCycle, lsGet);

      if (!dayData || !dayData.cycleDay) {
        return { cleared: 0, dates: [] };
      }

      const currentDay = dayData.cycleDay;
      const clearedDates = [];

      // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –∏ –æ—á–∏—â–∞–µ–º
      for (let d = 1; d <= 7; d++) {
        const offset = d - currentDay;
        const targetDate = addDays(anyDateInCycle, offset);

        const targetData = readDayData(targetDate, lsGet);

        if (targetData && targetData.cycleDay) {
          const updated = { ...targetData, cycleDay: null, updatedAt: Date.now() };
          writeDayData(targetDate, updated, lsSet);
          clearedDates.push(targetDate);
          // console.log('[Cycle] Cleared cycleDay for ' + targetDate);
        }
      }

      // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ
      if (typeof window !== 'undefined' && window.dispatchEvent) {
        // –û—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã ‚Äî —á—Ç–æ–±—ã DatePicker –æ–±–Ω–æ–≤–∏–ª—Å—è
        clearedDates.forEach(date => {
          window.dispatchEvent(new CustomEvent('heys:day-updated', {
            detail: { date, field: 'cycleDay', value: null, source: 'cycle-clear' }
          }));
          // –¢—Ä–∏–≥–≥–µ—Ä –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          window.dispatchEvent(new CustomEvent('heys:data-saved', {
            detail: { key: `day:${date}`, type: 'cycle' }
          }));
        });
        // –û–±—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è batch-–æ–ø–µ—Ä–∞—Ü–∏–π
        window.dispatchEvent(new CustomEvent('heys:cycle-updated', {
          detail: { dates: clearedDates, cleared: true }
        }));
      }

      return { cleared: clearedDates.length, dates: clearedDates };
    } catch (e) {
      console.warn('[Cycle] Failed to clear cycle', e);
      return { cleared: 0, dates: [] };
    }
  }

  // ============================================================
  // –ó–ê–î–ï–†–ñ–ö–ê –í–û–î–´ –ò –í–ï–°
  // ============================================================

  /**
   * –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–µ—Ä–∂–∫–µ –≤–æ–¥—ã –ø–æ —Ñ–∞–∑–µ —Ü–∏–∫–ª–∞
   * 
   * –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   * - Stachenfeld et al. 2008: "Estrogen influences body water regulation"
   * - White et al. 2011: "Menstrual cycle phase and fluid retention"
   * - –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–≥–µ—Å—Ç–µ—Ä–æ–Ω–∞ –≤ –ª—é—Ç–µ–∏–Ω–æ–≤–æ–π —Ñ–∞–∑–µ ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ Na+ –∏ –≤–æ–¥—ã
   * - –ü–∏–∫ –∑–∞–¥–µ—Ä–∂–∫–∏: 1-3 –¥–Ω—è –¥–æ –∏ 1-3 –¥–Ω—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏
   * - –¢–∏–ø–∏—á–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 0.5-3 –∫–≥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π)
   * 
   * @param {number|null} cycleDay 
   * @returns {Object} { hasRetention, severity, kgEstimate, advice }
   */
  function getWaterRetentionInfo(cycleDay) {
    if (!cycleDay || typeof cycleDay !== 'number' || cycleDay < 1) {
      return {
        hasRetention: false,
        severity: 'none',
        kgEstimate: 0,
        advice: null,
        excludeFromTrend: false
      };
    }

    // –î–Ω–∏ 1-5: –ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    if (cycleDay >= 1 && cycleDay <= 5) {
      return {
        hasRetention: true,
        severity: cycleDay <= 3 ? 'high' : 'medium', // –ü–∏–∫ –≤ –ø–µ—Ä–≤—ã–µ 3 –¥–Ω—è
        kgEstimate: cycleDay <= 3 ? 2.0 : 1.0, // –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
        advice: '–í–µ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—à–µ –Ω–∞ 1-3 –∫–≥ –∏–∑-–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤–æ–¥—ã. –≠—Ç–æ –ù–ï –∂–∏—Ä!',
        excludeFromTrend: true,
        phaseColor: '#ec4899' // pink
      };
    }

    // –î–Ω–∏ 6-7: –ü–µ—Ä–µ—Ö–æ–¥–Ω–∞—è —Ñ–∞–∑–∞ ‚Äî –æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    if (cycleDay >= 6 && cycleDay <= 7) {
      return {
        hasRetention: true,
        severity: 'low',
        kgEstimate: 0.5,
        advice: '–í–æ–¥–∞ —É—Ö–æ–¥–∏—Ç, –≤–µ—Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è',
        excludeFromTrend: true, // –í—Å—ë –µ—â—ë –ª—É—á—à–µ –∏—Å–∫–ª—é—á–∏—Ç—å
        phaseColor: '#f9a8d4' // pink-300 (—Å–≤–µ—Ç–ª–µ–µ)
      };
    }

    // –î–Ω–∏ 8-14: –§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è/–û–≤—É–ª—è—Ü–∏—è ‚Äî –Ω–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏
    return {
      hasRetention: false,
      severity: 'none',
      kgEstimate: 0,
      advice: null,
      excludeFromTrend: false
    };
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–∫–ª—é—á–∞—Ç—å –¥–µ–Ω—å –∏–∑ —Ç—Ä–µ–Ω–¥–∞ –≤–µ—Å–∞
   * @param {number|null} cycleDay 
   * @returns {boolean}
   */
  function shouldExcludeFromWeightTrend(cycleDay) {
    const info = getWaterRetentionInfo(cycleDay);
    return info.excludeFromTrend;
  }

  /**
   * –ù–∞–π—Ç–∏ –¥–∞—Ç—É "–î–µ–Ω—å 1" —Ü–∏–∫–ª–∞ –ø–æ –ª—é–±–æ–π –¥–∞—Ç–µ –≤ —Ü–∏–∫–ª–µ
   * @param {string} dateStr - YYYY-MM-DD
   * @param {function} lsGet - –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è (IGNORED, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è getDayKey)
   * @returns {string|null} –î–∞—Ç–∞ –¥–Ω—è 1 –∏–ª–∏ null
   */
  function findCycleStartDate(dateStr, lsGet) {
    try {
      const dayData = readDayData(dateStr, lsGet);

      if (!dayData || !dayData.cycleDay) return null;

      const offset = 1 - dayData.cycleDay;
      return addDays(dateStr, offset);
    } catch (e) {
      return null;
    }
  }

  // ============================================================
  // –ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –¶–ò–ö–õ–û–í
  // ============================================================

  /**
   * –ù–∞–π—Ç–∏ –≤—Å–µ —Ü–∏–∫–ª—ã –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
   * @param {number} monthsBack - –°–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥ –∏—Å–∫–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 6)
   * @param {function} lsGet - –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è –∏–∑ localStorage
   * @returns {Array} –ú–∞—Å—Å–∏–≤ —Ü–∏–∫–ª–æ–≤ [{ startDate, endDate, days: [...] }]
   */
  function findAllCycles(monthsBack = 6, lsGet) {
    const cycles = [];
    const today = new Date();
    const startDate = new Date(today);
    startDate.setMonth(startDate.getMonth() - monthsBack);

    let currentCycle = null;

    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–Ω—è–º
    for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().slice(0, 10);

      try {
        const dayData = readDayData(dateStr, lsGet);

        if (dayData && dayData.cycleDay) {
          // –ù–∞—à–ª–∏ –¥–µ–Ω—å —Ü–∏–∫–ª–∞
          if (dayData.cycleDay === 1) {
            // –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            if (currentCycle) {
              cycles.push(currentCycle);
            }
            currentCycle = {
              startDate: dateStr,
              endDate: dateStr,
              days: [{
                date: dateStr,
                cycleDay: dayData.cycleDay,
                weight: dayData.weightMorning || null
              }]
            };
          } else if (currentCycle) {
            // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–∞
            currentCycle.endDate = dateStr;
            currentCycle.days.push({
              date: dateStr,
              cycleDay: dayData.cycleDay,
              weight: dayData.weightMorning || null
            });
          }
        }
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ü–∏–∫–ª
    if (currentCycle) {
      cycles.push(currentCycle);
    }

    return cycles;
  }

  /**
   * –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤–æ–¥—ã –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º
   * @param {number} monthsBack - –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –≤ –º–µ—Å—è—Ü–∞—Ö
   * @param {function} lsGet - –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è
   * @returns {Object} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–∏–∫–ª–∞–º
   */
  function analyzeWaterRetentionHistory(monthsBack = 6, lsGet) {
    const cycles = findAllCycles(monthsBack, lsGet);

    if (cycles.length === 0) {
      return {
        hasSufficientData: false,
        cyclesAnalyzed: 0,
        message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'
      };
    }

    const retentionData = [];

    for (const cycle of cycles) {
      // –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–µ–Ω –≤–µ—Å –≤ –¥–Ω–∏ 1-5 –∏ "–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π" –≤–µ—Å –ø–æ—Å–ª–µ (–¥–Ω–∏ 8-14)
      const retentionDays = cycle.days.filter(d => d.cycleDay >= 1 && d.cycleDay <= 5 && d.weight > 0);
      const normalDays = cycle.days.filter(d => d.cycleDay >= 8 && d.weight > 0);

      if (retentionDays.length >= 2 && normalDays.length >= 1) {
        const avgRetentionWeight = retentionDays.reduce((s, d) => s + d.weight, 0) / retentionDays.length;
        const avgNormalWeight = normalDays.reduce((s, d) => s + d.weight, 0) / normalDays.length;
        const retention = avgRetentionWeight - avgNormalWeight;

        if (retention > 0) {
          retentionData.push({
            cycleStart: cycle.startDate,
            retentionKg: retention,
            peakDay: retentionDays.reduce((max, d) => d.weight > (max?.weight || 0) ? d : max, null)?.cycleDay || 2,
            avgRetentionWeight,
            avgNormalWeight,
            daysTracked: cycle.days.length
          });
        }
      }
    }

    if (retentionData.length === 0) {
      return {
        hasSufficientData: false,
        cyclesAnalyzed: cycles.length,
        message: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤–æ–¥—ã'
      };
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const avgRetention = retentionData.reduce((s, d) => s + d.retentionKg, 0) / retentionData.length;
    const maxRetention = Math.max(...retentionData.map(d => d.retentionKg));
    const minRetention = Math.min(...retentionData.map(d => d.retentionKg));
    const lastCycle = retentionData[retentionData.length - 1];
    const prevCycle = retentionData.length >= 2 ? retentionData[retentionData.length - 2] : null;

    // –¢—Ä–µ–Ω–¥ (—É–ª—É—á—à–∞–µ—Ç—Å—è/—É—Ö—É–¥—à–∞–µ—Ç—Å—è)
    let trend = 'stable';
    if (retentionData.length >= 3) {
      const firstHalf = retentionData.slice(0, Math.floor(retentionData.length / 2));
      const secondHalf = retentionData.slice(Math.floor(retentionData.length / 2));
      const avgFirst = firstHalf.reduce((s, d) => s + d.retentionKg, 0) / firstHalf.length;
      const avgSecond = secondHalf.reduce((s, d) => s + d.retentionKg, 0) / secondHalf.length;

      if (avgSecond < avgFirst - 0.3) trend = 'improving';
      else if (avgSecond > avgFirst + 0.3) trend = 'worsening';
    }

    return {
      hasSufficientData: true,
      cyclesAnalyzed: retentionData.length,
      totalCyclesFound: cycles.length,

      // –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      avgRetentionKg: Math.round(avgRetention * 10) / 10,
      maxRetentionKg: Math.round(maxRetention * 10) / 10,
      minRetentionKg: Math.round(minRetention * 10) / 10,

      // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ü–∏–∫–ª
      lastCycle: lastCycle ? {
        date: lastCycle.cycleStart,
        retentionKg: Math.round(lastCycle.retentionKg * 10) / 10,
        peakDay: lastCycle.peakDay
      } : null,

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
      comparison: prevCycle ? {
        diff: Math.round((lastCycle.retentionKg - prevCycle.retentionKg) * 10) / 10,
        improved: lastCycle.retentionKg < prevCycle.retentionKg
      } : null,

      // –¢—Ä–µ–Ω–¥
      trend,
      trendText: trend === 'improving' ? '–ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è! üéâ' :
        trend === 'worsening' ? '–ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è' :
          '–°—Ç–∞–±–∏–ª—å–Ω–æ',

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å–∞–π—Ç
      insight: generateRetentionInsight(avgRetention, lastCycle, prevCycle, trend)
    };
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Å–∞–π—Ç–∞
   */
  function generateRetentionInsight(avgRetention, lastCycle, prevCycle, trend) {
    const insights = [];

    // –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞
    if (avgRetention <= 1.0) {
      insights.push('–£ —Ç–µ–±—è –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã (~' + avgRetention.toFixed(1) + ' –∫–≥), —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–æ!');
    } else if (avgRetention <= 2.0) {
      insights.push('–¢–≤–æ—è —Ç–∏–ø–∏—á–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã: ~' + avgRetention.toFixed(1) + ' –∫–≥ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞.');
    } else {
      insights.push('–ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (~' + avgRetention.toFixed(1) + ' –∫–≥). –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–∏–∑–∏—Ç—å —Å–æ–ª—å –≤ —ç—Ç–∏ –¥–Ω–∏.');
    }

    // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º —Ü–∏–∫–ª–æ–º
    if (prevCycle && lastCycle) {
      const diff = lastCycle.retentionKg - prevCycle.retentionKg;
      if (Math.abs(diff) >= 0.5) {
        if (diff < 0) {
          insights.push('–í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –∑–∞–¥–µ—Ä–∂–∫–∞ –±—ã–ª–∞ –º–µ–Ω—å—à–µ –Ω–∞ ' + Math.abs(diff).toFixed(1) + ' –∫–≥! üí™');
        } else {
          insights.push('–í —ç—Ç–æ—Ç —Ä–∞–∑ –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ ' + diff.toFixed(1) + ' –∫–≥ –±–æ–ª—å—à–µ ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑-–∑–∞ –ø–∏—Ç–∞–Ω–∏—è.');
        }
      }
    }

    // –¢—Ä–µ–Ω–¥
    if (trend === 'improving') {
      insights.push('–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏–∫–ª—ã –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞!');
    }

    return insights.length > 0 ? insights[0] : '–í–µ—Å –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –Ω–æ—Ä–º–µ.';
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–µ—Å–∞
   * @param {number} currentCycleDay - –¢–µ–∫—É—â–∏–π –¥–µ–Ω—å —Ü–∏–∫–ª–∞
   * @returns {Object} { daysUntilNormal, message }
   */
  function getWeightNormalizationForecast(currentCycleDay) {
    if (!currentCycleDay || currentCycleDay < 1) {
      return { daysUntilNormal: null, message: null };
    }

    // –í–µ—Å –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ –∫ –¥–Ω—é 8
    const targetDay = 8;
    const daysUntilNormal = Math.max(0, targetDay - currentCycleDay);

    if (currentCycleDay >= 8) {
      return {
        daysUntilNormal: 0,
        message: '–í–µ—Å —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –Ω–æ—Ä–º–µ'
      };
    }

    if (daysUntilNormal === 0) {
      return {
        daysUntilNormal: 0,
        message: '–í–µ—Å –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è —É–∂–µ –∑–∞–≤—Ç—Ä–∞!'
      };
    }

    if (daysUntilNormal === 1) {
      return {
        daysUntilNormal: 1,
        message: '–ï—â—ë ~1 –¥–µ–Ω—å –¥–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–µ—Å–∞'
      };
    }

    return {
      daysUntilNormal,
      message: '–í–µ—Å –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ ' + daysUntilNormal + ' –¥–Ω–µ–π'
    };
  }

  // ============================================================
  // DEBUG: –ü–æ–∫–∞–∑–∞—Ç—å –¥–Ω–∏ —Å cycleDay –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
  // ============================================================

  /**
   * –í—ã–≤–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –≤—Å–µ –¥–Ω–∏ —Å cycleDay –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
   * –í—ã–∑–æ–≤: HEYS.Cycle.debugCycleDays(14)
   * @param {number} daysBack - –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –ø—Ä–æ–≤–µ—Ä—è—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 14)
   */
  function debugCycleDays(daysBack = 14) {
    const today = new Date();
    const results = [];

    console.group('üå∏ Cycle Days Debug (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ' + daysBack + ' –¥–Ω–µ–π)');
    console.log('ClientId:', (window.HEYS && window.HEYS.currentClientId) || '(none)');

    for (let i = daysBack - 1; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().slice(0, 10);
      const dayNum = d.getDate();

      const key = getDayKey(dateStr);

      const dayData = readStoredValue(key, null);

      const cycleDay = dayData?.cycleDay || null;
      const weight = dayData?.weightMorning || null;
      const retentionInfo = getWaterRetentionInfo(cycleDay);

      results.push({
        date: dateStr,
        dayNum,
        cycleDay,
        hasRetention: retentionInfo.hasRetention,
        severity: retentionInfo.severity,
        weight,
        key // –¥–ª—è –¥–µ–±–∞–≥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª—é—á
      });

      // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–Ω–∏ —Å cycleDay –∏–ª–∏ –≤–µ—Å–æ–º
      if (cycleDay || weight) {
        const icon = retentionInfo.hasRetention ? 'üî¥' : '‚ö™';
        console.log(
          `${icon} ${dateStr} (${dayNum}): cycleDay=${cycleDay || 'null'}, weight=${weight || '-'}, retention=${retentionInfo.hasRetention ? retentionInfo.severity : 'none'}`
        );
      }
    }

    console.groupEnd();
    console.table(results.filter(r => r.cycleDay || r.weight));

    return results;
  }

  // ============================================================
  // –≠–ö–°–ü–û–†–¢
  // ============================================================

  HEYS.Cycle = {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    PHASES: CYCLE_PHASES,

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    getCyclePhase,
    getKcalMultiplier,
    getWaterMultiplier,
    getInsulinWaveMultiplier,

    // –ü—Ä–æ–≤–µ—Ä–∫–∏
    isInMenstrualPhase,

    // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤–æ–¥—ã –∏ –≤–µ—Å
    getWaterRetentionInfo,
    shouldExcludeFromWeightTrend,

    // –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    findAllCycles,
    analyzeWaterRetentionHistory,
    getWeightNormalizationForecast,

    // UI helpers
    getCycleDisplay,
    getCycleDescription,
    getCycleAdviceFlags,

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
    setCycleDaysAuto,
    clearCycleDays,
    findCycleStartDate,
    addDays,
    getDayKey, // –¥–ª—è –¥–µ–±–∞–≥–∞ –∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

    // Debug
    debugCycleDays
  };

  // console.log('[HEYS] Cycle module loaded v1.4.0 (fixed clientId in keys)');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_refeed_v1.js ===== */
// heys_refeed_v1.js ‚Äî –ú–æ–¥—É–ª—å Refeed Day (–∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å)
// –û—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
// v1.0.0 | 2025-12-12
(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;

  // === –ö–û–ù–°–¢–ê–ù–¢–´ ===
  const REFEED_BOOST_PCT = 0.35; // +35% –∫ –Ω–æ—Ä–º–µ
  const REFEED_THRESHOLD = 1000; // –ü–æ—Ä–æ–≥ –¥–æ–ª–≥–∞ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∫–∫–∞–ª)
  const REFEED_CONSECUTIVE = 5;  // –î–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  const REFEED_OK_RATIO = 1.35;  // –î–æ–ø—É—Å—Ç–∏–º—ã–π –ø–µ—Ä–µ–±–æ—Ä –≤ refeed –¥–µ–Ω—å

  // –ü—Ä–∏—á–∏–Ω—ã refeed –¥–Ω—è (–¥–ª—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)
  const REFEED_REASONS = [
    { id: 'deficit', icon: 'üí∞', label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–µ—Ñ–∏—Ü–∏—Ç–∞', desc: '–ù–∞–∫–æ–ø–∏–ª—Å—è –¥–æ–ª–≥ –∫–∞–ª–æ—Ä–∏–π' },
    { id: 'training', icon: 'üí™', label: '–ü–æ—Å–ª–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', desc: '–ù—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–∏–∫–æ–≥–µ–Ω' },
    { id: 'holiday', icon: 'üéâ', label: '–ü—Ä–∞–∑–¥–Ω–∏–∫ / –æ—Å–æ–±—ã–π –¥–µ–Ω—å', desc: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ' },
    { id: 'rest', icon: 'üßò', label: '–ú–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö –æ—Ç –¥–∏–µ—Ç—ã', desc: '–°–Ω—è—Ç–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è' }
  ];

  // –ó–æ–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è refeed –¥–Ω—è
  const REFEED_ZONES = {
    ok: { id: 'refeed_ok', name: '–ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å –≤—ã–ø–æ–ª–Ω–µ–Ω', color: '#22c55e', textColor: '#fff', icon: '‚úÖ' },
    over: { id: 'refeed_over', name: '–ü–µ—Ä–µ–±–æ—Ä –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ –¥–Ω—è', color: '#f59e0b', textColor: '#fff', icon: '‚ö†Ô∏è' },
    under: { id: 'refeed_under', name: '–ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω', color: '#eab308', textColor: '#000', icon: 'üìâ' },
    binge: { id: 'refeed_binge', name: '–°–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä', color: '#ef4444', textColor: '#fff', icon: 'üö®' }
  };

  // === –£–¢–ò–õ–ò–¢–´ ===

  const tryParseStoredValue = (raw, fallback) => {
    if (raw === null || raw === undefined) return fallback;
    if (typeof raw === 'string') {
      let str = raw;
      if (str.startsWith('¬§Z¬§') && HEYS.store?.decompress) {
        try { str = HEYS.store.decompress(str); } catch (_) { }
      }
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    return raw;
  };

  const readStoredValue = (key, fallback) => {
    try {
      if (HEYS.store?.get) {
        const stored = HEYS.store.get(key, null);
        if (stored !== null && stored !== undefined) {
          return tryParseStoredValue(stored, fallback);
        }
      }
      if (HEYS.utils?.lsGet) {
        const legacy = HEYS.utils.lsGet(key, fallback);
        if (legacy !== null && legacy !== undefined) return legacy;
      }
      const raw = localStorage.getItem(key);
      return tryParseStoredValue(raw, fallback);
    } catch (_) {
      return fallback;
    }
  };

  const writeStoredValue = (key, value) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(key, value);
        return;
      }
      if (HEYS.utils?.lsSet) {
        HEYS.utils.lsSet(key, value);
        return;
      }
      const serialized = typeof value === 'string' ? value : JSON.stringify(value);
      localStorage.setItem(key, serialized);
    } catch (_) { }
  };

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∑–æ–Ω—É refeed –¥–Ω—è –ø–æ ratio
   * @param {number} ratio - eaten/optimum
   * @param {boolean} isRefeedDay - –æ—Ç–º–µ—á–µ–Ω –ª–∏ –¥–µ–Ω—å –∫–∞–∫ refeed
   * @returns {Object} –∑–æ–Ω–∞
   */
  function getRefeedZone(ratio, isRefeedDay) {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç null/undefined ‚Äî –≤–µ—Ä–Ω—É—Ç—å under –∑–æ–Ω—É (–µ—â—ë –Ω–µ –ø–æ–µ–ª)
    if (!isRefeedDay) return null;
    if (ratio == null || ratio <= 0) return REFEED_ZONES.under;

    if (ratio < 0.9) return REFEED_ZONES.under;
    if (ratio >= 0.9 && ratio <= REFEED_OK_RATIO) return REFEED_ZONES.ok;
    if (ratio > REFEED_OK_RATIO && ratio <= 1.5) return REFEED_ZONES.over;
    return REFEED_ZONES.binge;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–Ω–∞ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è refeed
   * @param {Object} caloricDebt - –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–ª–≥–µ –∏–∑ heys_day_v12
   * @returns {boolean}
   */
  function shouldRecommendRefeed(caloricDebt) {
    if (!caloricDebt) return false;
    return caloricDebt.needsRefeed === true;
  }

  /**
   * –í—ã—á–∏—Å–ª–∏—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–æ—Ä–º—É –¥–ª—è refeed –¥–Ω—è
   * @param {number} optimum - –±–∞–∑–æ–≤–∞—è –Ω–æ—Ä–º–∞
   * @param {boolean} isRefeedDay - –æ—Ç–º–µ—á–µ–Ω –ª–∏ –¥–µ–Ω—å
   * @returns {number}
   */
  function getRefeedOptimum(optimum, isRefeedDay) {
    if (!isRefeedDay) return optimum;
    return Math.round(optimum * (1 + REFEED_BOOST_PCT));
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É refeed –ø–æ ID
   * @param {string} reasonId
   * @returns {Object|null}
   */
  function getReasonById(reasonId) {
    return REFEED_REASONS.find(r => r.id === reasonId) || null;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ª–∂–µ–Ω –ª–∏ –¥–µ–Ω—å –∏—Å–∫–ª—é—á–∞—Ç—å—Å—è –∏–∑ weight trend
   * @param {Object} dayData - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è
   * @returns {boolean}
   */
  function shouldExcludeFromWeightTrend(dayData) {
    return dayData?.isRefeedDay === true;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —à–∞–≥ refeed –≤ —á–µ–∫-–∏–Ω–µ
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ sleepQuality ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–∞–º —Ä–µ—à–∞–µ—Ç
   * @returns {boolean}
   */
  function shouldShowRefeedStep() {
    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥ ‚Äî –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ –≤—ã–±—Ä–∞—Ç—å refeed
    // –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å caloric debt
    return true;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–∏ streak –≤ refeed –¥–µ–Ω—å
   * @param {number} ratio - eaten/optimum
   * @param {boolean} isRefeedDay
   * @returns {boolean}
   */
  function isStreakPreserved(ratio, isRefeedDay) {
    if (!isRefeedDay) return false;
    // Streak —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ ratio 0.70-1.35 –≤ refeed –¥–µ–Ω—å
    return ratio >= 0.70 && ratio <= REFEED_OK_RATIO;
  }

  /**
   * üÜï –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É refeed –¥–Ω–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
   * @param {number} days - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (default: 30)
   * @returns {Object} —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ { count, avgExcessPct, lastRefeedDate, reasons }
   */
  function getHistoryStats(days = 30) {
    const stats = {
      count: 0,
      avgExcessPct: 0,
      lastRefeedDate: null,
      lastRefeedDaysAgo: null,
      reasons: {},  // { manual: 3, caloric_debt: 2, ... }
      totalExcessKcal: 0,
      daysAnalyzed: days
    };

    const today = new Date();
    const excessList = [];

    for (let i = 0; i < days; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateKey = d.toISOString().slice(0, 10);
      const day = readStoredValue(`heys_dayv2_${dateKey}`, null);

      if (day?.isRefeedDay === true) {
        stats.count++;

        // –ü–æ—Å–ª–µ–¥–Ω–∏–π refeed
        if (!stats.lastRefeedDate) {
          stats.lastRefeedDate = dateKey;
          stats.lastRefeedDaysAgo = i;
        }

        // –ü—Ä–∏—á–∏–Ω–∞
        const reason = day.refeedReason || 'manual';
        stats.reasons[reason] = (stats.reasons[reason] || 0) + 1;

        // –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫–∞–ª–æ—Ä–∏—è—Ö)
        if (day.meals && Array.isArray(day.meals)) {
          // –°—É–º–º–∞ –∫–∞–ª–æ—Ä–∏–π
          const profile = readStoredValue('heys_profile', {});
          const optimum = profile.optimum || 2000;
          const refeedOptimum = getRefeedOptimum(optimum, true);

          const eatenKcal = day.meals.reduce((sum, meal) => {
            if (!meal.items) return sum;
            return sum + meal.items.reduce((s, item) => s + (item.kcal || 0), 0);
          }, 0);

          if (eatenKcal > 0) {
            const excessPct = ((eatenKcal / refeedOptimum) - 1) * 100;
            excessList.push(excessPct);
            stats.totalExcessKcal += Math.max(0, eatenKcal - optimum);
          }
        }
      }
    }

    // –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
    if (excessList.length > 0) {
      stats.avgExcessPct = Math.round(excessList.reduce((a, b) => a + b, 0) / excessList.length);
    }

    return stats;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å label –ø—Ä–∏—á–∏–Ω—ã —Å guardrail fallback
   * @param {string} reasonId - ID –ø—Ä–∏—á–∏–Ω—ã
   * @returns {Object} { id, icon, label, desc }
   */
  function getReasonLabel(reasonId) {
    if (!reasonId) return { id: 'none', icon: 'üçï', label: '–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã', desc: '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' };
    const found = REFEED_REASONS.find(r => r.id === reasonId);
    if (found) return found;
    // Fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω (legacy –¥–∞–Ω–Ω—ã–µ)
    return { id: 'other', icon: '‚ùì', label: '–î—Ä—É–≥–æ–µ', desc: reasonId };
  }

  /**
   * üÜï –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã –æ refeed –¥–Ω–µ ‚Äî –≤—Å–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–µ—Ä—É—Ç –æ—Ç—Å—é–¥–∞
   * @param {Object} dayData - –¥–∞–Ω–Ω—ã–µ –¥–Ω—è { isRefeedDay, refeedReason, ... }
   * @param {number} ratio - kcal/optimum (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   * @returns {Object} –ø–æ–ª–Ω–∞—è –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ refeed
   */
  function getDayMeta(dayData, ratio = null) {
    const isRefeedDay = dayData?.isRefeedDay === true;
    const reasonId = dayData?.refeedReason || null;
    const reason = isRefeedDay ? getReasonLabel(reasonId) : null;

    // –ó–æ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å ratio)
    const zone = ratio !== null && isRefeedDay ? getRefeedZone(ratio, true) : null;
    const isStreakDay = ratio !== null && isRefeedDay ? isStreakPreserved(ratio, true) : null;

    // Heatmap —Å—Ç–∞—Ç—É—Å
    let heatmapStatus = null;
    if (ratio !== null && isRefeedDay) {
      if (zone?.id === 'refeed_ok') heatmapStatus = 'green';
      else if (zone?.id === 'refeed_under' || zone?.id === 'refeed_over') heatmapStatus = 'yellow';
      else if (zone?.id === 'refeed_binge') heatmapStatus = 'red';
    }

    // Tooltip —Ç–µ–∫—Å—Ç
    const tooltip = isRefeedDay
      ? `üçï –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å\n${reason?.icon || ''} ${reason?.label || ''}\n${ratio !== null ? '\n–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ' + Math.round(ratio * 100) + '%' : ''}\n\n‚úÖ –≠—Ç–æ –ù–ï —Å—Ä—ã–≤ ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n‚úÖ –ù–æ—Ä–º–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–æ 135%${isStreakDay === true ? '\n‚úÖ Streak —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è' : (isStreakDay === false ? '\n‚ö†Ô∏è –î–ª—è streak –Ω—É–∂–Ω–æ 70-135%' : '')}`
      : null;

    return {
      isRefeedDay,
      reasonId,
      reason,
      zone,
      isStreakDay,
      heatmapStatus,
      tooltip,
      color: isRefeedDay ? '#f97316' : null,  // orange-500
      badge: isRefeedDay ? 'üçï' : null,
      cssClass: isRefeedDay ? 'refeed-day' : null
    };
  }

  // === REACT –ö–û–ú–ü–û–ù–ï–ù–¢–´ ===

  /**
   * –®–∞–≥ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞ ‚Äî Refeed Day
   */
  function RefeedDayStepComponent({ data, onChange }) {
    const { useState, useCallback, useMemo, useEffect } = React;

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å (isRefeedDay = false)
    const [isRefeedDay, setIsRefeedDay] = useState(data?.isRefeedDay ?? false);
    const [refeedReason, setRefeedReason] = useState(data?.refeedReason ?? null);

    // –°–æ–æ–±—â–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—é –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    useEffect(() => {
      if (data?.isRefeedDay === undefined || data?.isRefeedDay === null) {
        onChange({ isRefeedDay: false, refeedReason: null });
      }
    }, []);

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ–º –¥–æ–ª–≥–µ
    const caloricDebt = useMemo(() => {
      return HEYS.caloricDebt || null;
    }, []);

    const needsRefeed = shouldRecommendRefeed(caloricDebt);
    const debt = caloricDebt?.debt || 0;
    const refeedBoost = caloricDebt?.refeedBoost || 0;
    const adjustedOptimum = caloricDebt?.adjustedOptimum || 0;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –î–∞/–ù–µ—Ç
    const handleSelect = useCallback((value) => {
      setIsRefeedDay(value);
      if (value === false) {
        setRefeedReason(null);
      }
      onChange({ isRefeedDay: value, refeedReason: value ? refeedReason : null });
      try { navigator.vibrate?.(10); } catch (e) { }
    }, [onChange, refeedReason]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—á–∏–Ω—ã
    const handleReasonSelect = useCallback((reasonId) => {
      setRefeedReason(reasonId);
      onChange({ isRefeedDay: true, refeedReason: reasonId });
      try { navigator.vibrate?.(15); } catch (e) { }
    }, [onChange]);

    return React.createElement('div', { className: 'refeed-step' },
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      React.createElement('div', { className: 'refeed-header' },
        React.createElement('span', { className: 'refeed-icon' }, 'üìÖ'),
        React.createElement('h3', { className: 'refeed-title' }, '–¢–∏–ø –¥–Ω—è')
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç —Å–∏—Å—Ç–µ–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)
      needsRefeed && React.createElement('div', { className: 'refeed-hint refeed-hint--system' },
        React.createElement('div', { className: 'refeed-hint-icon' }, 'üí°'),
        React.createElement('div', { className: 'refeed-hint-content' },
          React.createElement('div', { className: 'refeed-hint-title' }, '–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É'),
          React.createElement('div', { className: 'refeed-hint-details' },
            '–ù–∞–∫–æ–ø–∏–ª—Å—è –¥–æ–ª–≥: ' + debt + ' –∫–∫–∞–ª. –ù–æ—Ä–º–∞ —Å–µ–≥–æ–¥–Ω—è +' + refeedBoost + ' –∫–∫–∞–ª'
          )
        )
      ),

      // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞: –û–±—ã—á–Ω—ã–π –¥–µ–Ω—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) / –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π
      React.createElement('div', { className: 'refeed-options' },
        // –û–±—ã—á–Ω—ã–π –¥–µ–Ω—å ‚Äî –ø–µ—Ä–≤—ã–π, –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        React.createElement('button', {
          type: 'button',
          className: 'refeed-option refeed-option--no' + (isRefeedDay === false ? ' active' : ''),
          onClick: () => handleSelect(false)
        },
          React.createElement('span', { className: 'refeed-option-icon' }, 'üìä'),
          React.createElement('span', { className: 'refeed-option-label' }, '–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å')
        ),
        // –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å ‚Äî –≤—Ç–æ—Ä–æ–π
        React.createElement('button', {
          type: 'button',
          className: 'refeed-option refeed-option--yes' + (isRefeedDay === true ? ' active' : ''),
          onClick: () => handleSelect(true)
        },
          React.createElement('span', { className: 'refeed-option-icon' }, 'üçï'),
          React.createElement('span', { className: 'refeed-option-label' }, '–ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π')
        )
      ),

      // –í—ã–±–æ—Ä –ø—Ä–∏—á–∏–Ω—ã (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞)
      isRefeedDay === true && React.createElement('div', { className: 'refeed-reasons' },
        React.createElement('div', { className: 'refeed-reasons-label' }, '–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏:'),
        React.createElement('div', { className: 'refeed-reasons-grid' },
          REFEED_REASONS.map(reason =>
            React.createElement('button', {
              key: reason.id,
              type: 'button',
              className: 'refeed-reason' + (refeedReason === reason.id ? ' active' : ''),
              onClick: () => handleReasonSelect(reason.id),
              title: reason.desc
            },
              React.createElement('span', { className: 'refeed-reason-icon' }, reason.icon),
              React.createElement('span', { className: 'refeed-reason-label' }, reason.label)
            )
          )
        )
      ),

      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–º–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω refeed)
      isRefeedDay === true && adjustedOptimum > 0 && React.createElement('div', { className: 'refeed-info' },
        React.createElement('div', { className: 'refeed-info-icon' }, 'üéØ'),
        React.createElement('div', { className: 'refeed-info-content' },
          React.createElement('div', { className: 'refeed-info-title' }, '–°–µ–≥–æ–¥–Ω—è –Ω–æ—Ä–º–∞'),
          React.createElement('div', { className: 'refeed-info-value' },
            adjustedOptimum + ' –∫–∫–∞–ª',
            React.createElement('span', { className: 'refeed-info-boost' }, ' (+35%)')
          )
        )
      ),

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –¥–Ω—è
      isRefeedDay === false && React.createElement('div', { className: 'refeed-regular-hint' },
        'üìä –ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –æ–±—ã—á–Ω–æ–π –Ω–æ—Ä–º—ã –∫–∞–ª–æ—Ä–∏–π'
      )
    );
  }

  /**
   * –ö–∞—Ä—Ç–æ—á–∫–∞ Refeed Day –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
   * @param {Object} props
   */
  function RefeedCard({ day, optimum, eatenKcal, caloricDebt }) {
    if (day?.isRefeedDay !== true) return null;

    const adjustedOptimum = getRefeedOptimum(optimum, true);
    const ratio = eatenKcal / adjustedOptimum;
    const zone = getRefeedZone(ratio, true);
    const reason = getReasonById(day.refeedReason);
    const diff = eatenKcal - adjustedOptimum;

    return React.createElement('div', {
      className: 'refeed-card compact-card',
      key: 'refeed-card'
    },
      React.createElement('div', { className: 'refeed-card__header' },
        React.createElement('span', { className: 'refeed-card__icon' }, 'üçï'),
        React.createElement('span', { className: 'refeed-card__title' }, '–ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å'),
        React.createElement('span', {
          className: 'refeed-card__status refeed-card__status--' + zone.id,
          style: { background: zone.color + '20', color: zone.color }
        },
          zone.icon,
          ' ',
          eatenKcal + '/' + adjustedOptimum,
          diff > 0 && ' +' + Math.round(diff)
        )
      ),
      React.createElement('div', { className: 'refeed-card__info' },
        reason && React.createElement('span', { className: 'refeed-card__badge' },
          reason.icon + ' ' + reason.label
        ),
        caloricDebt?.debt > 0 && React.createElement('span', { className: 'refeed-card__badge refeed-card__badge--debt' },
          'üí∞ –î–æ–ª–≥ ‚àí' + caloricDebt.debt + ' –∫–∫–∞–ª'
        )
      ),
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ streak
      React.createElement('div', { className: 'refeed-card__hint' },
        isStreakPreserved(ratio, true)
          ? '‚úÖ Streak —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (ratio ' + Math.round(ratio * 100) + '%)'
          : '‚ö†Ô∏è –î–ª—è streak –Ω—É–∂–µ–Ω ratio 70-135%'
      ),
      // –ú–∏–Ω–∏-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ refeed –∑–∞ –º–µ—Å—è—Ü
      renderRefeedStats()
    );
  }

  /**
   * –ú–∏–Ω–∏-–±–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ refeed –∑–∞ 30 –¥–Ω–µ–π
   */
  function renderRefeedStats() {
    const stats = getHistoryStats(30);
    if (!stats || stats.count === 0) return null;

    return React.createElement('div', {
      className: 'refeed-card__stats',
      title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö –¥–Ω–µ–π –∑–∞ 30 –¥–Ω–µ–π'
    },
      React.createElement('span', { className: 'refeed-card__stats-item' },
        'üìä ', stats.count, ' refeed –∑–∞ –º–µ—Å—è—Ü'
      ),
      stats.avgExcessPct > 0 && React.createElement('span', { className: 'refeed-card__stats-item' },
        '‚ÜóÔ∏è +', stats.avgExcessPct, '% –≤ —Å—Ä–µ–¥–Ω–µ–º'
      ),
      stats.lastRefeedDaysAgo > 0 && React.createElement('span', { className: 'refeed-card__stats-item' },
        'üìÖ ', stats.lastRefeedDaysAgo, ' –¥–Ω. –Ω–∞–∑–∞–¥'
      )
    );
  }

  /**
   * –ë–µ–π–¥–∂ Refeed Day –¥–ª—è goal progress header
   * @param {Object} props
   */
  function RefeedBadge({ isRefeedDay, needsRefeed, caloricDebt, onClick }) {
    if (!isRefeedDay && !needsRefeed) return null;

    const isActive = isRefeedDay === true;
    const debt = caloricDebt?.debt || 0;
    const consecutiveDays = caloricDebt?.consecutiveDeficitDays || 0;

    const tooltip = isActive
      ? 'üçï –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ—Ä–º–∞ +35%\n\n–≠—Ç–æ –ù–ï —Å—Ä—ã–≤! –¶–µ–ª—å: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º.'
      : 'üí° –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É\n\n–î–æ–ª–≥: ' + debt + ' –∫–∫–∞–ª\n' + consecutiveDays + ' –¥–Ω–µ–π –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ';

    return React.createElement('span', {
      className: 'refeed-badge' + (isActive ? ' refeed-badge--active' : ' refeed-badge--recommended'),
      title: tooltip,
      onClick: onClick,
      style: { cursor: onClick ? 'pointer' : 'help' }
    },
      isActive ? 'üçï REFEED' : 'üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è refeed'
    );
  }

  /**
   * Toggle –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–ª–æ—Ä–∏–π
   */
  function RefeedToggle({ isRefeedDay, onToggle, needsRefeed }) {
    const label = isRefeedDay ? '–ó–∞–≥—Ä—É–∑–∫–∞ ‚úì' : (needsRefeed ? '+ –ó–∞–≥—Ä—É–∑–∫–∞ üí°' : '+ –ó–∞–≥—Ä—É–∑–∫–∞');

    return React.createElement('button', {
      type: 'button',
      className: 'refeed-toggle' + (isRefeedDay ? ' refeed-toggle--active' : '') + (needsRefeed ? ' refeed-toggle--recommended' : ''),
      onClick: onToggle,
      title: isRefeedDay ? '–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å' : '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å (+35% –∫ –Ω–æ—Ä–º–µ)'
    },
      React.createElement('span', { className: 'refeed-toggle-icon' }, 'üçï'),
      React.createElement('span', { className: 'refeed-toggle-label' }, label)
    );
  }

  // === –°–û–í–ï–¢–´ ===

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –¥–ª—è Refeed Day
   * @param {Object} params - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ heys_advice_v1
   * @returns {Array} –º–∞—Å—Å–∏–≤ —Å–æ–≤–µ—Ç–æ–≤
   */
  function getRefeedAdvices(params) {
    const { day, caloricDebt, hour, dayTot, optimum, displayOptimum } = params;
    const advices = [];

    const isRefeedDay = day?.isRefeedDay === true;
    const needsRefeed = caloricDebt?.needsRefeed === true;
    const debt = caloricDebt?.debt || 0;
    const refeedBoost = caloricDebt?.refeedBoost || 0;
    const consecutiveDays = caloricDebt?.consecutiveDeficitDays || 0;

    const eatenKcal = dayTot?.kcal || 0;
    const refeedOptimum = isRefeedDay ? getRefeedOptimum(optimum, true) : displayOptimum;
    const eatenPct = eatenKcal / refeedOptimum;

    // 1. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è refeed (—É—Ç—Ä–æ, –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –Ω–æ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ)
    if (needsRefeed && !isRefeedDay && hour >= 7 && hour <= 12) {
      advices.push({
        id: 'refeed_recommended',
        icon: 'üîÑ',
        text: '–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å',
        details: `üí∞ –ù–∞–∫–æ–ø–∏–ª—Å—è –¥–æ–ª–≥ ${debt} –∫–∫–∞–ª –∏–ª–∏ ${consecutiveDays} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ.\n\n‚úÖ –≠—Ç–æ –ù–ï —Å—Ä—ã–≤ ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏!\n‚úÖ +35% –∫ –Ω–æ—Ä–º–µ –ø–æ–º–æ–≥–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º\n‚úÖ –û—Ç–º–µ—Ç—å –≤ —É—Ç—Ä–µ–Ω–Ω–µ–º —á–µ–∫-–∏–Ω–µ –∏–ª–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É üçï`,
        type: 'tip',
        priority: 28,
        category: 'nutrition',
        triggers: ['tab_open'],
        ttl: 8000
      });
    }

    // 2. Refeed –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (–¥–µ–Ω—å, –º–æ—Ç–∏–≤–∞—Ü–∏—è —Å—ä–µ—Å—Ç—å –Ω–æ—Ä–º—É)
    if (isRefeedDay && eatenPct >= 0.3 && eatenPct < 0.85 && hour >= 12 && hour <= 20) {
      advices.push({
        id: 'refeed_in_progress',
        icon: 'üçΩÔ∏è',
        text: 'Refeed –∏–¥—ë—Ç! –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è',
        details: `üí™ –¢—ã —Å—ä–µ–ª ${Math.round(eatenPct * 100)}% –æ—Ç refeed –Ω–æ—Ä–º—ã.\n\n–¶–µ–ª—å —Å–µ–≥–æ–¥–Ω—è: ${refeedOptimum} –∫–∫–∞–ª.\n–≠—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–ª—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.`,
        type: 'tip',
        priority: 22,
        category: 'nutrition',
        triggers: ['tab_open'],
        ttl: 6000
      });
    }

    // 3. Refeed –≤—ã–ø–æ–ª–Ω–µ–Ω (–≤–µ—á–µ—Ä, –∞—á–∏–≤–∫–∞)
    if (isRefeedDay && eatenPct >= 0.9 && eatenPct <= REFEED_OK_RATIO && hour >= 19) {
      advices.push({
        id: 'refeed_completed',
        icon: '‚úÖ',
        text: 'Refeed –≤—ã–ø–æ–ª–Ω–µ–Ω! –ú–µ—Ç–∞–±–æ–ª–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è',
        details: `üéØ –¢—ã —Å—ä–µ–ª ${Math.round(eatenKcal)} –∫–∫–∞–ª ‚Äî –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö refeed –Ω–æ—Ä–º—ã.\n\n‚úÖ –õ–µ–ø—Ç–∏–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–µ—Ä–Ω—ë—Ç—Å—è –∫ –Ω–æ—Ä–º–µ\n‚úÖ –ú–µ—Ç–∞–±–æ–ª–∏–∑–º —É—Å–∫–æ—Ä–∏—Ç—Å—è\n‚úÖ –ó–∞–≤—Ç—Ä–∞ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—ã—á–Ω–æ–º—É –ø–ª–∞–Ω—É`,
        type: 'achievement',
        priority: 12,
        category: 'achievement',
        triggers: ['tab_open'],
        ttl: 7000
      });
    }

    // 4. Refeed –ø–µ—Ä–µ–±–æ—Ä (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
    if (isRefeedDay && eatenPct > REFEED_OK_RATIO && eatenPct <= 1.5) {
      advices.push({
        id: 'refeed_over',
        icon: '‚ö†Ô∏è',
        text: 'Refeed –≤—ã—à–µ –Ω–æ—Ä–º—ã ‚Äî –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ —Å–ª–µ–¥–∏',
        details: `üìä –°—ä–µ–¥–µ–Ω–æ ${Math.round(eatenKcal)} –∏–∑ ${refeedOptimum} –∫–∫–∞–ª (+${Math.round((eatenPct - 1) * 100)}%).\n\n–≠—Ç–æ –µ—â—ë –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ, –Ω–æ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –¥–∞–ª—å—à–µ.`,
        type: 'warning',
        priority: 18,
        category: 'nutrition',
        triggers: ['tab_open', 'product_added'],
        ttl: 5000
      });
    }

    // 5. Refeed –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (–≤–µ—á–µ—Ä, –µ—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª–∏ –Ω–æ –Ω–µ –æ—Ç–º–µ—Ç–∏–ª–∏)
    if (needsRefeed && !isRefeedDay && hour >= 20 && eatenPct < 0.8) {
      advices.push({
        id: 'refeed_missed',
        icon: 'üìâ',
        text: '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π refeed –ø—Ä–æ–ø—É—â–µ–Ω',
        details: `üí∞ –î–æ–ª–≥ ${debt} –∫–∫–∞–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è.\n\n–ï—Å–ª–∏ –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É, —Ç–µ–ª–æ –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º. –†–∞—Å—Å–º–æ—Ç—Ä–∏ refeed –∑–∞–≤—Ç—Ä–∞.`,
        type: 'tip',
        priority: 25,
        category: 'nutrition',
        triggers: ['tab_open'],
        ttl: 6000
      });
    }

    return advices;
  }

  // === STEP REGISTRATION ===

  /**
   * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ –≤ —Å–∏—Å—Ç–µ–º–µ —á–µ–∫-–∏–Ω–æ–≤
   */
  let _registerRetries = 0;
  let _registerEventBound = false;
  let _refeedStepRegistered = false;
  function registerRefeedStep() {
    if (_refeedStepRegistered) return; // guard –æ—Ç –¥–≤–æ–π–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    // registerStep –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ HEYS.StepModal, –Ω–µ –≤ HEYS.Steps!
    if (!HEYS.StepModal?.registerStep) {
      // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ ‚Äî –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ: StepModal –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ–∑–∂–µ
      // (postboot-1-game –≥—Ä—É–∑–∏—Ç—Å—è —Ä–∞–Ω—å—à–µ postboot-3-ui, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç StepModal)
      if (!_registerEventBound) {
        _registerEventBound = true;
        document.addEventListener('heys-stepmodal-ready', function _onStepModalReady() {
          document.removeEventListener('heys-stepmodal-ready', _onStepModalReady);
          console.info('[Refeed] ‚úÖ StepModal ready via event, registering step');
          registerRefeedStep();
        }, { once: true });
        console.info('[Refeed] ‚è≥ StepModal not ready, waiting for heys-stepmodal-ready event...');
      }
      // Polling –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –±—ã–ª–æ –¥–æ subscribe
      if (_registerRetries < 60) { // Max 30 seconds fallback
        _registerRetries++;
        setTimeout(registerRefeedStep, 500);
      } else {
        console.warn('[Refeed] ‚ö†Ô∏è HEYS.StepModal not found after 30s, giving up');
      }
      return;
    }

    _refeedStepRegistered = true;
    console.info('[Refeed] ‚úÖ Registering refeedDay step in StepModal');
    HEYS.StepModal.registerStep('refeedDay', {
      title: '–ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å',
      hint: '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ',
      icon: 'üîÑ',
      component: RefeedDayStepComponent,
      canSkip: true,

      shouldShow: () => {
        try {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
          const hasRecommendation = HEYS.caloricDebt?.needsRefeed || false;
          // –ò–õ–ò –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—Ä—É—á–Ω—É—é –≤—ã–±–∏—Ä–∞—Ç—å
          const profile = readStoredValue('heys_profile', {});
          const allowManual = profile.allowManualRefeed === true;
          return hasRecommendation || allowManual;
        } catch {
          return false;
        }
      },

      getInitialData: (ctx) => {
        const dateKey = ctx?.dateKey || new Date().toISOString().slice(0, 10);
        const day = readStoredValue(`heys_dayv2_${dateKey}`, {}) || {};
        return {
          isRefeedDay: day.isRefeedDay ?? null,
          refeedReason: day.refeedReason ?? null
        };
      },

      save: (data) => {
        const dateKey = new Date().toISOString().slice(0, 10);
        const day = readStoredValue(`heys_dayv2_${dateKey}`, { date: dateKey }) || { date: dateKey };
        day.isRefeedDay = data.isRefeedDay;
        day.refeedReason = data.refeedReason || null;
        day.updatedAt = Date.now();
        writeStoredValue(`heys_dayv2_${dateKey}`, day);

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { date: dateKey, field: 'isRefeedDay', value: data.isRefeedDay, source: 'refeed-step' }
        }));
      },

      xpAction: 'refeed_marked'
    });
  }

  // === RENDER HELPERS ===

  /**
   * Render Refeed Toggle –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–ª–æ—Ä–∏–π
   * @param {Object} props - { isRefeedDay, refeedReason, caloricDebt, optimum, onToggle }
   * @returns {React.Element|null}
   */
  function renderRefeedToggle(props) {
    const { isRefeedDay, refeedReason, caloricDebt, optimum, onToggle } = props || {};

    const needsRefeed = caloricDebt?.needsRefeed === true;
    const hasDebt = caloricDebt?.debt > 500;

    // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –≤–∫–ª—é—á–∏—Ç—å refeed
    // –ù–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –Ω–µ –≤–∫–ª—é—á—ë–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –±–µ–π–¥–∂–∞
    const reason = isRefeedDay && refeedReason ? getReasonById(refeedReason) : null;

    // Wrapper –¥–ª—è onToggle
    const handleToggle = () => {
      if (isRefeedDay) {
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
        onToggle?.(false, null);
      } else {
        // –í–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º popup –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—á–∏–Ω—ã –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ —Å—Ç–∞–≤–∏–º 'deficit' –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥, –∏–Ω–∞—á–µ 'rest'
        const defaultReason = caloricDebt?.debt > 500 ? 'deficit' : 'rest';
        onToggle?.(true, defaultReason);
      }
    };

    const label = isRefeedDay
      ? 'üçï –ó–∞–≥—Ä—É–∑–∫–∞'
      : (needsRefeed ? 'üí°' : (hasDebt ? 'üçï' : 'üçï'));

    const title = isRefeedDay
      ? `–ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å: ${reason?.label || '–∞–∫—Ç–∏–≤–µ–Ω'}\n–ö–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å`
      : `–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –¥–µ–Ω—å (+35% –∫ –Ω–æ—Ä–º–µ)`;

    return React.createElement('button', {
      type: 'button',
      className: 'refeed-toggle' +
        (isRefeedDay ? ' refeed-toggle--active' : '') +
        (needsRefeed && !isRefeedDay ? ' refeed-toggle--recommended' : '') +
        (!isRefeedDay && !needsRefeed && !hasDebt ? ' refeed-toggle--minimal' : ''),
      onClick: handleToggle,
      title: title
    },
      React.createElement('span', { className: 'refeed-toggle-label' }, label)
    );
  }

  /**
   * –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è RefeedCard ‚Äî –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç props –∏–∑ day_v12
   * @param {Object} props - { isRefeedDay, refeedReason, caloricDebt, eatenKcal, optimum }
   */
  function renderRefeedCard(props) {
    const { isRefeedDay, refeedReason, caloricDebt, eatenKcal, optimum } = props || {};

    if (!isRefeedDay) return null;

    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º props –∫ —Ñ–æ—Ä–º–∞—Ç—É RefeedCard
    const dayData = {
      isRefeedDay: isRefeedDay,
      refeedReason: refeedReason
    };

    return React.createElement(RefeedCard, {
      day: dayData,
      optimum: optimum,
      eatenKcal: eatenKcal,
      caloricDebt: caloricDebt
    });
  }

  // === –≠–ö–°–ü–û–†–¢ –ú–û–î–£–õ–Ø ===

  HEYS.Refeed = {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    REFEED_BOOST_PCT,
    REFEED_THRESHOLD,
    REFEED_CONSECUTIVE,
    REFEED_OK_RATIO,
    REFEED_REASONS,
    REFEED_ZONES,

    // –£—Ç–∏–ª–∏—Ç—ã
    getRefeedZone,
    shouldRecommendRefeed,
    getRefeedOptimum,
    getReasonById,
    getReasonLabel,      // üÜï —Å guardrail fallback
    getDayMeta,          // üÜï –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã
    getHistoryStats,     // üÜï —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 30 –¥–Ω–µ–π
    shouldExcludeFromWeightTrend,
    shouldShowRefeedStep,
    isStreakPreserved,

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    RefeedDayStepComponent,
    RefeedCard,
    RefeedBadge,
    RefeedToggle,

    // –°–æ–≤–µ—Ç—ã
    getRefeedAdvices,

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    registerStep: registerRefeedStep,

    // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è UI
    renderRefeedToggle,  // üÜï v1.3.1 ‚Äî toggle –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–ª–æ—Ä–∏–π
    renderRefeedCard,    // üÜï v1.3.3 ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ refeed –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    renderRefeedStats,

    // –í–µ—Ä—Å–∏—è
    version: '1.3.3'  // v1.3.3 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω renderRefeedCard
  };

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', registerRefeedStep);
  } else {
    setTimeout(registerRefeedStep, 100);
  }

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_yesterday_verify_v1.js ===== */
// heys_yesterday_verify_v1.js ‚Äî –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—á–µ—Ä–∞—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —É—Ç—Ä–µ–Ω–Ω–µ–º —á–µ–∫-–∏–Ω–µ –µ—Å–ª–∏ –≤—á–µ—Ä–∞ –±—ã–ª–æ <50% –∫–∞–ª–æ—Ä–∏–π –æ—Ç –Ω–æ—Ä–º—ã
// –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç: —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ –∏–ª–∏ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏?
//
// –í–µ—Ä—Å–∏—è: 1.1.1
// 
(function (global) {
  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };
  const devWarn = typeof DEV.warn === 'function' ? DEV.warn.bind(DEV) : function () { };

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const storeGet = (k, d) => {
    try {
      if (HEYS.store?.get) return HEYS.store.get(k, d);
      if (HEYS.utils?.lsGet) return HEYS.utils.lsGet(k, d);
      const v = localStorage.getItem(k);
      return v ? JSON.parse(v) : d;
    } catch {
      return d;
    }
  };

  const storeSet = (k, v) => {
    try {
      if (HEYS.store?.set) {
        HEYS.store.set(k, v);
        return;
      }
      if (HEYS.utils?.lsSet) {
        HEYS.utils.lsSet(k, v);
        return;
      }
      localStorage.setItem(k, JSON.stringify(v));
    } catch { }
  };

  const lsGet = (k, d) => storeGet(k, d);
  const lsSet = (k, v) => storeSet(k, v);

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è
   * @returns {string} YYYY-MM-DD
   */
  function getYesterdayKey() {
    // –£—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ—á–Ω–æ–π –ø–æ—Ä–æ–≥: –¥–æ 03:00 "–≤—á–µ—Ä–∞" = –ø–æ–∑–∞–≤—á–µ—Ä–∞
    const dayUtils = HEYS.dayUtils || {};
    if (typeof dayUtils.todayISO === 'function') {
      // todayISO —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä–æ–≥ 03:00, –æ—Ç–Ω–∏–º–∞–µ–º 1 –¥–µ–Ω—å
      const today = new Date(dayUtils.todayISO());
      today.setDate(today.getDate() - 1);
      return today.toISOString().slice(0, 10);
    }

    // Fallback
    const now = new Date();
    if (now.getHours() < 3) {
      now.setDate(now.getDate() - 2); // –î–æ 3 —É—Ç—Ä–∞ ‚Äî –ø–æ–∑–∞–≤—á–µ—Ä–∞
    } else {
      now.setDate(now.getDate() - 1); // –ü–æ—Å–ª–µ 3 —É—Ç—Ä–∞ ‚Äî –≤—á–µ—Ä–∞
    }
    return now.toISOString().slice(0, 10);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   * @returns {Object|null} { date, kcal, target, ratio, meals, isFastingDay, isIncomplete }
   */
  function getYesterdayData() {
    const yesterdayKey = getYesterdayKey();
    const dayData = lsGet(`heys_dayv2_${yesterdayKey}`, null);

    if (!dayData) {
      return null;
    }

    // –°—É–º–º–∏—Ä—É–µ–º –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
    const meals = dayData.meals || [];
    let totalKcal = 0;
    let totalProt = 0;
    let totalCarbs = 0;
    let totalFat = 0;
    let totalSimple = 0;

    const toNumber = (val) => {
      if (val === null || val === undefined) return 0;
      if (typeof val === 'string') {
        const cleaned = val.replace(',', '.').trim();
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : 0;
      }
      const num = Number(val);
      return Number.isFinite(num) ? num : 0;
    };

    const computeKcalFromMacros = (obj) => {
      if (!obj) return 0;
      const prot = toNumber(obj.protein100) || toNumber(obj.prot100);
      const carbs = toNumber(obj.carbs100) || (toNumber(obj.simple100) + toNumber(obj.complex100));
      const fat = toNumber(obj.fat100) || (toNumber(obj.badFat100) + toNumber(obj.goodFat100) + toNumber(obj.trans100));

      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –±–µ–ª–æ–∫ (–º—è—Å–æ –±–µ–∑ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö), –æ—Ü–µ–Ω–∏—Ç—å –∂–∏—Ä—ã –∫–∞–∫ 30% –æ—Ç –±–µ–ª–∫–∞
      // –¢–∏–ø–∏—á–Ω–æ –¥–ª—è –∏–Ω–¥–µ–π–∫–∏/–∫—É—Ä–∏—Ü—ã: 25–≥ –±–µ–ª–∫–∞ ‚Üí ~8–≥ –∂–∏—Ä–∞
      const estimatedFat = (prot > 0 && fat === 0 && carbs === 0) ? prot * 0.3 : fat;

      const kcal = (prot * 3) + (carbs * 4) + (estimatedFat * 9); // NET Atwater
      return Number.isFinite(kcal) ? kcal : 0;
    };

    let productsAvailable = false;
    let productsList = [];
    try {
      const storedProducts = lsGet('heys_products', []) || [];
      if (Array.isArray(storedProducts) && storedProducts.length > 0) {
        productsAvailable = true;
        productsList = storedProducts;
      }
    } catch (e) { }
    if (!productsAvailable && HEYS.products?.getAll) {
      const list = HEYS.products.getAll();
      if (Array.isArray(list) && list.length > 0) {
        productsAvailable = true;
        productsList = list;
      }
    }

    const productIndex = (HEYS.models?.buildProductIndex && productsAvailable)
      ? HEYS.models.buildProductIndex(productsList)
      : null;
    const useMealTotals = !!(HEYS.models?.mealTotals && productIndex);

    let itemsCount = 0;
    const sampleItems = [];

    for (const meal of meals) {
      const items = meal.items || [];
      itemsCount += items.length;

      if (useMealTotals) {
        const totals = HEYS.models.mealTotals(meal, productIndex) || {};
        totalKcal += toNumber(totals.kcal);
        totalProt += toNumber(totals.prot);
        totalCarbs += toNumber(totals.carbs);
        totalFat += toNumber(totals.fat);
        totalSimple += toNumber(totals.simple);
      } else {
        for (const item of items) {
          const grams = toNumber(item.grams);
          if (!grams) continue;

          // üîß FIX v1.2.0: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç item snapshot, –∑–∞—Ç–µ–º product
          // Item —Ö—Ä–∞–Ω–∏—Ç snapshot –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
          const product = getProductById(item.product_id);

          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ kcal100 (>0)
          const getValidKcal = (...sources) => {
            for (const src of sources) {
              const val = toNumber(src);
              if (val > 0) return val;
            }
            return 0;
          };

          // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: item.kcal100 ‚Üí product.kcal100 ‚Üí –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑ –º–∞–∫—Ä–æ—Å–æ–≤ item ‚Üí –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑ –º–∞–∫—Ä–æ—Å–æ–≤ product
          const kcal100 = getValidKcal(
            item.kcal100,
            product?.kcal100,
            computeKcalFromMacros(item),
            computeKcalFromMacros(product)
          );
          // –î–ª—è items –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–∑—è—Ç—å –∏–∑ product –≤ –±–∞–∑–µ
          const productProt = toNumber(product?.protein100);
          const productCarbs = toNumber(product?.carbs100);
          const productFat = toNumber(product?.fat100);

          const prot100 = getValidKcal(item.protein100, productProt);
          const carbs100 = getValidKcal(item.carbs100, productCarbs);
          const fat100 = getValidKcal(item.fat100, productFat);
          const simple100 = getValidKcal(item.simple100, product?.simple100);
          const lineKcal = (kcal100 * grams) / 100;

          // –§–ª–∞–≥ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          const isIncompleteItem = kcal100 === 0 || (item.kcal100 === undefined && !product?.kcal100);

          totalKcal += lineKcal;
          totalProt += prot100 * grams / 100;
          totalCarbs += carbs100 * grams / 100;
          totalFat += fat100 * grams / 100;
          totalSimple += simple100 * grams / 100;

          if (sampleItems.length < 5) {  // –£–≤–µ–ª–∏—á–∏–ª –¥–æ 5 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            sampleItems.push({
              id: item.id || null,
              name: item.name || null,
              product_id: item.product_id || null,
              grams,
              kcal100: item.kcal100 ?? null,
              kcal100Resolved: kcal100,
              lineKcal: Number.isFinite(lineKcal) ? Math.round(lineKcal * 10) / 10 : null,
              protein100: item.protein100 ?? null,
              carbs100: item.carbs100 ?? null,
              fat100: item.fat100 ?? null,
              simple100: item.simple100 ?? null,
              complex100: item.complex100 ?? null,
              hasProduct: !!product,
              productKcal100: product?.kcal100 ?? null,
              productProtein100: product?.protein100 ?? null,
              isIncomplete: isIncompleteItem,
            });
          }
        }
      }

      if (useMealTotals && sampleItems.length < 5) {
        for (const item of items) {
          if (sampleItems.length >= 5) break;
          const grams = toNumber(item.grams);
          if (!grams) continue;

          const productFromItem = HEYS.models?.getProductFromItem
            ? HEYS.models.getProductFromItem(item, productIndex)
            : getProductById(item.product_id);
          const derived = HEYS.models?.computeDerivedProduct
            ? HEYS.models.computeDerivedProduct(productFromItem || {})
            : { kcal100: 0 };
          const resolvedKcal100 = toNumber(productFromItem?.kcal100) || toNumber(derived.kcal100);
          const lineKcal = (resolvedKcal100 * grams) / 100;
          const isIncompleteItem = resolvedKcal100 === 0;

          sampleItems.push({
            id: item.id || null,
            name: item.name || null,
            product_id: item.product_id || null,
            grams,
            kcal100: item.kcal100 ?? null,
            kcal100Resolved: resolvedKcal100,
            lineKcal: Number.isFinite(lineKcal) ? Math.round(lineKcal * 10) / 10 : null,
            protein100: item.protein100 ?? null,
            carbs100: item.carbs100 ?? null,
            fat100: item.fat100 ?? null,
            simple100: item.simple100 ?? null,
            complex100: item.complex100 ?? null,
            hasProduct: !!productFromItem,
            productKcal100: productFromItem?.kcal100 ?? null,
            productProtein100: productFromItem?.protein100 ?? null,
            isIncomplete: isIncompleteItem,
          });
        }
      }
    }

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ—Ä–º—É –¥–ª—è –≤—á–µ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ deficitPct)
    const profile = lsGet('heys_profile', {});
    const norms = lsGet('heys_norms', {});
    const target = calculateDayTarget(dayData, profile, norms);

    const ratio = target > 0 ? totalKcal / target : 0;

    const roundedKcal = Math.round(totalKcal);
    if (roundedKcal === 0 && meals.length > 0) {
      const debugKey = `heys_debug_yesterday_zero_${yesterdayKey}`;
      let alreadyLogged = false;
      try {
        alreadyLogged = sessionStorage.getItem(debugKey) === '1';
      } catch (e) { }
      try {
        if (!alreadyLogged) {
          const payload = {
            date: yesterdayKey,
            mealCount: meals.length,
            itemsCount,
            productsAvailable,
            hasMeals: meals.length > 0,
            hasItems: itemsCount > 0,
            sampleItems,
          };
          try {
            localStorage.setItem('heys_debug_yesterday_zero_payload', JSON.stringify(payload));
          } catch (e) { }
        }
        if (!alreadyLogged && HEYS.analytics?.trackDataOperation) {
          HEYS.analytics.trackDataOperation('yesterday_kcal_zero', 1, {
            date: yesterdayKey,
            mealCount: meals.length,
            itemsCount,
            productsAvailable,
            hasMeals: meals.length > 0,
            hasItems: itemsCount > 0,
            sampleItems,
          });
          try { sessionStorage.setItem(debugKey, '1'); } catch (e) { }
        }
      } catch (e) { }
    }

    return {
      date: yesterdayKey,
      kcal: roundedKcal,
      target: Math.round(target),
      ratio,
      meals,
      mealCount: meals.length,
      itemsCount,
      sampleItems,
      totalKcalRaw: Number.isFinite(totalKcal) ? Math.round(totalKcal * 10) / 10 : null,
      totalKcalIsFinite: Number.isFinite(totalKcal),
      productsAvailable,
      macros: {
        prot: Math.round(totalProt * 10) / 10,
        carbs: Math.round(totalCarbs * 10) / 10,
        fat: Math.round(totalFat * 10) / 10,
        simple: Math.round(totalSimple * 10) / 10
      },
      isFastingDay: dayData.isFastingDay || false,
      isIncomplete: dayData.isIncomplete || false,
      hasBeenVerified: dayData.isFastingDay !== undefined || dayData.isIncomplete !== undefined
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç –ø–æ ID (–∏–∑ –∏–Ω–¥–µ–∫—Å–∞ –∏–ª–∏ –±–∞–∑—ã)
   */
  function getProductById(productId) {
    if (!productId) return null;

    // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ HEYS.products
    if (HEYS.products?.getById) {
      return HEYS.products.getById(productId);
    }

    // Fallback: –∏—â–µ–º –≤ localStorage
    const products = lsGet('heys_products', []);
    return products.find(p => p.id === productId || p.id === String(productId));
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ—Ä–º—É –∫–∞–ª–æ—Ä–∏–π –¥–ª—è –¥–Ω—è
   * üî¨ TDEE v1.2.0: –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å HEYS.TDEE
   */
  function calculateDayTarget(dayData, profile, norms) {
    // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å TDEE ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ (—Ç–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç)
    if (HEYS.TDEE?.calculate) {
      const result = HEYS.TDEE.calculate(dayData, profile, { lsGet });
      return result.optimum || 2000; // optimum = baseExpenditure * (1 + deficitPct/100)
    }

    // Fallback: —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç (legacy, –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω)
    const weight = profile.weight || 70;
    const height = profile.height || 170;
    const age = profile.age || 30;
    const gender = profile.gender || '–ú—É–∂—Å–∫–æ–π';

    // Mifflin-St Jeor formula
    const isMale = gender !== '–ñ–µ–Ω—Å–∫–∏–π';
    const bmr = 10 * weight + 6.25 * height - 5 * age + (isMale ? 5 : -161);

    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (fallback ‚Äî –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏/—à–∞–≥–∏)
    const activityMultiplier = {
      'sedentary': 1.2,
      'light': 1.375,
      'moderate': 1.55,
      'active': 1.725,
      'very_active': 1.9
    }[profile.activityLevel || 'moderate'] || 1.55;

    const tdee = bmr * activityMultiplier;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ—Ñ–∏—Ü–∏—Ç/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç
    const deficitPct = dayData.deficitPct ?? profile.deficitPctTarget ?? 0;
    const target = tdee * (1 + deficitPct / 100);

    return target;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —à–∞–≥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
   * @returns {boolean}
   */
  function shouldShowYesterdayVerify() {
    const data = getYesterdayData();

    if (!data) {
      return false;
    }

    // –£–∂–µ –±—ã–ª–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
    if (data.hasBeenVerified) {
      return false;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –≤—á–µ—Ä–∞ –±—ã–ª–æ <50% –∫–∞–ª–æ—Ä–∏–π –ò —Ö–æ—Ç—è –±—ã 1 –ø—Ä–∏—ë–º –ø–∏—â–∏
    // (–µ—Å–ª–∏ 0 –ø—Ä–∏—ë–º–æ–≤ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—É—Å—Ç–æ–π –¥–µ–Ω—å, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–æ–ø—Ä–æ—Å–∞)
    return data.ratio < 0.5 && data.mealCount > 0;
  }

  // === –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ ===
  const VERIFY_OPTIONS = [
    {
      id: 'fasting',
      icon: 'üçÉ',
      title: '–†–µ–∞–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ',
      desc: '–î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã ‚Äî —è —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –µ–ª –º–µ–Ω—å—à–µ',
      color: '#22c55e' // –∑–µ–ª—ë–Ω—ã–π
    },
    {
      id: 'incomplete',
      icon: 'üìù',
      title: '–ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
      desc: '–ó–∞–±—ã–ª –≤–Ω–µ—Å—Ç–∏ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ ‚Äî –¥–µ–Ω—å –Ω–µ–ø–æ–ª–Ω—ã–π',
      color: '#f97316' // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    }
  ];

  // === –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===
  const INCOMPLETE_ACTIONS = [
    {
      id: 'fill_later',
      icon: '‚úèÔ∏è',
      title: '–î–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∑–∂–µ',
      desc: '–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ –ø–∞–º—è—Ç–∏'
    },
    {
      id: 'clear_day',
      icon: 'üóëÔ∏è',
      title: '–û—á–∏—Å—Ç–∏—Ç—å –¥–µ–Ω—å',
      desc: '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–∏—ë–º—ã (0 –∫–∫–∞–ª ‚Äî –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ)'
    }
  ];

  // === React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —à–∞–≥–∞ ===
  function YesterdayVerifyStepComponent({ data, onChange, context }) {
    const [step, setStep] = React.useState('choice'); // 'choice' | 'incomplete_action'
    const [yesterdayInfo, setYesterdayInfo] = React.useState(null);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—á–µ—Ä–∞
    React.useEffect(() => {
      const info = getYesterdayData();
      setYesterdayInfo(info);
      try {
        if (info) {
          localStorage.setItem('heys_debug_yesterday_info', JSON.stringify(info));
        } else {
          localStorage.setItem('heys_debug_yesterday_info', JSON.stringify({ empty: true }));
        }
      } catch (e) { }

      if (info && info.kcal === 0 && info.mealCount > 0 && !info.productsAvailable) {
        let attempts = 0;
        const maxAttempts = 12;
        const intervalMs = 250;
        const timer = setInterval(() => {
          attempts += 1;
          const refreshed = getYesterdayData();
          if (refreshed && (refreshed.productsAvailable || refreshed.kcal > 0)) {
            setYesterdayInfo(refreshed);
            clearInterval(timer);
            return;
          }
          if (attempts >= maxAttempts) {
            clearInterval(timer);
          }
        }, intervalMs);
        return () => clearInterval(timer);
      }
    }, []);

    // –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
    const selectedOption = data.verifyOption || null;
    const selectedAction = data.incompleteAction || null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    const handleOptionSelect = (optionId) => {
      onChange({ ...data, verifyOption: optionId });

      if (optionId === 'incomplete') {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –¥–µ–π—Å—Ç–≤–∏—è
        setStep('incomplete_action');
      }
      // –ï—Å–ª–∏ fasting ‚Äî –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥. —à–∞–≥—É
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    const handleActionSelect = (actionId) => {
      onChange({ ...data, incompleteAction: actionId });
    };

    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    const handleBack = () => {
      setStep('choice');
      onChange({ ...data, incompleteAction: null });
    };

    if (!yesterdayInfo) {
      return React.createElement('div', { className: 'yv-loading' }, '–ó–∞–≥—Ä—É–∑–∫–∞...');
    }

    // === –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä —Ç–∏–ø–∞ (–≥–æ–ª–æ–¥–∞–Ω–∏–µ / –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ) ===
    if (step === 'choice') {
      return React.createElement('div', { className: 'yv-step' },
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—á–µ—Ä–∞
        React.createElement('div', { className: 'yv-info' },
          React.createElement('div', { className: 'yv-info-icon' }, 'üìä'),
          React.createElement('div', { className: 'yv-info-text' },
            React.createElement('div', { className: 'yv-info-date' },
              '–í—á–µ—Ä–∞, ' + formatDateRu(yesterdayInfo.date)
            ),
            React.createElement('div', { className: 'yv-info-stats' },
              React.createElement('span', { className: 'yv-info-kcal' },
                yesterdayInfo.kcal + ' –∫–∫–∞–ª'
              ),
              ' –∏–∑ ',
              React.createElement('span', { className: 'yv-info-target' },
                yesterdayInfo.target + ' –∫–∫–∞–ª'
              ),
              React.createElement('span', { className: 'yv-info-percent' },
                ' (' + Math.round(yesterdayInfo.ratio * 100) + '%)'
              )
            )
          )
        ),

        // –í–æ–ø—Ä–æ—Å
        React.createElement('div', { className: 'yv-question' },
          '–ß—Ç–æ —ç—Ç–æ –±—ã–ª–æ?'
        ),

        // –í–∞—Ä–∏–∞–Ω—Ç—ã
        React.createElement('div', { className: 'yv-options' },
          VERIFY_OPTIONS.map(opt =>
            React.createElement('button', {
              key: opt.id,
              type: 'button',
              className: 'yv-option' + (selectedOption === opt.id ? ' yv-option--selected' : ''),
              onClick: () => handleOptionSelect(opt.id),
              style: selectedOption === opt.id ? { borderColor: opt.color } : {}
            },
              React.createElement('span', { className: 'yv-option-icon' }, opt.icon),
              React.createElement('div', { className: 'yv-option-content' },
                React.createElement('div', { className: 'yv-option-title' }, opt.title),
                React.createElement('div', { className: 'yv-option-desc' }, opt.desc)
              ),
              selectedOption === opt.id && React.createElement('span', {
                className: 'yv-option-check',
                style: { color: opt.color }
              }, '‚úì')
            )
          )
        ),

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞
        React.createElement('div', { className: 'yv-hint' },
          'üí° –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ç–æ—á–Ω–µ–µ —Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã'
        )
      );
    }

    // === –≠–∫—Ä–∞–Ω 2: –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ===
    if (step === 'incomplete_action') {
      return React.createElement('div', { className: 'yv-step' },
        // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        React.createElement('button', {
          type: 'button',
          className: 'yv-back',
          onClick: handleBack
        }, '‚Üê –ù–∞–∑–∞–¥'),

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        React.createElement('div', { className: 'yv-subtitle' },
          'üìù –ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'
        ),

        // –í–æ–ø—Ä–æ—Å
        React.createElement('div', { className: 'yv-question' },
          '–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º –¥–Ω—ë–º?'
        ),

        // –î–µ–π—Å—Ç–≤–∏—è
        React.createElement('div', { className: 'yv-options' },
          INCOMPLETE_ACTIONS.map(act =>
            React.createElement('button', {
              key: act.id,
              type: 'button',
              className: 'yv-option' + (selectedAction === act.id ? ' yv-option--selected' : ''),
              onClick: () => handleActionSelect(act.id)
            },
              React.createElement('span', { className: 'yv-option-icon' }, act.icon),
              React.createElement('div', { className: 'yv-option-content' },
                React.createElement('div', { className: 'yv-option-title' }, act.title),
                React.createElement('div', { className: 'yv-option-desc' }, act.desc)
              ),
              selectedAction === act.id && React.createElement('span', {
                className: 'yv-option-check'
              }, '‚úì')
            )
          )
        ),

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        selectedAction === 'clear_day' && React.createElement('div', { className: 'yv-warning' },
          '‚ö†Ô∏è –í—Å–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ –≤—á–µ—Ä–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.'
        ),

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –¥–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        selectedAction === 'fill_later' && React.createElement('div', { className: 'yv-hint' },
          'üìÖ –î–µ–Ω—å –±—É–¥–µ—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ–ø–æ–ª–Ω—ã–π. –¢—ã –º–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –µ–≥–æ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.'
        )
      );
    }

    return null;
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É –ø–æ-—Ä—É—Å—Å–∫–∏
   */
  function formatDateRu(dateStr) {
    if (!dateStr) return '';
    const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
      '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
    const d = new Date(dateStr);
    return d.getDate() + ' ' + months[d.getMonth()];
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–∞
   */
  function saveYesterdayVerify(data) {
    const yesterdayKey = getYesterdayKey();
    const dayData = lsGet(`heys_dayv2_${yesterdayKey}`, { date: yesterdayKey }) || { date: yesterdayKey };

    if (data.verifyOption === 'fasting') {
      // –†–µ–∞–ª—å–Ω–æ–µ –≥–æ–ª–æ–¥–∞–Ω–∏–µ ‚Äî –ø–æ–º–µ—á–∞–µ–º –¥–µ–Ω—å
      dayData.isFastingDay = true;
      dayData.isIncomplete = false;
      dayData.updatedAt = Date.now();
      lsSet(`heys_dayv2_${yesterdayKey}`, dayData);

      devLog('[YesterdayVerify] ‚úÖ Marked as fasting day:', yesterdayKey);

    } else if (data.verifyOption === 'incomplete') {
      // –ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      dayData.isFastingDay = false;

      if (data.incompleteAction === 'clear_day') {
        // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏
        dayData.meals = [];
        dayData.isIncomplete = false; // –î–µ–Ω—å "–ø—É—Å—Ç–æ–π", –Ω–µ –Ω–µ–ø–æ–ª–Ω—ã–π
        dayData.updatedAt = Date.now();
        lsSet(`heys_dayv2_${yesterdayKey}`, dayData);

        devLog('[YesterdayVerify] üóëÔ∏è Cleared all meals for:', yesterdayKey);

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        window.dispatchEvent(new CustomEvent('heys:day-updated', {
          detail: { date: yesterdayKey, field: 'meals', value: [], source: 'yesterday-verify-clear' }
        }));

      } else if (data.incompleteAction === 'fill_later') {
        // –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ–ø–æ–ª–Ω—ã–π –¥–ª—è –¥–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        dayData.isIncomplete = true;
        dayData.updatedAt = Date.now();
        lsSet(`heys_dayv2_${yesterdayKey}`, dayData);

        devLog('[YesterdayVerify] üìù Marked as incomplete:', yesterdayKey);

        // TODO: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ notifications
      }
    }

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    window.dispatchEvent(new CustomEvent('heys:day-updated', {
      detail: { date: yesterdayKey, source: 'yesterday-verify' }
    }));
  }

  // === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∞–≥–∞ ===
  let _registerRetries = 0;
  function registerYesterdayVerifyStep() {
    if (!HEYS.StepModal?.registerStep) {
      if (_registerRetries < 20) {
        _registerRetries++;
        setTimeout(registerYesterdayVerifyStep, 500);
      } else {
        devWarn('[YesterdayVerify] HEYS.StepModal not found after 10s');
      }
      return;
    }

    HEYS.StepModal.registerStep('yesterdayVerify', {
      title: '–î–∞–Ω–Ω—ã–µ –∑–∞ –≤—á–µ—Ä–∞',
      hint: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–ª–æ—Ä–∏–π',
      icon: 'üìä',
      component: YesterdayVerifyStepComponent,
      canSkip: false, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –µ—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

      shouldShow: () => {
        return shouldShowYesterdayVerify();
      },

      getInitialData: () => {
        return {
          verifyOption: null,
          incompleteAction: null
        };
      },

      // –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
      validate: (data) => {
        if (!data.verifyOption) {
          return { valid: false, error: '–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤' };
        }
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ incomplete ‚Äî –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
        if (data.verifyOption === 'incomplete' && !data.incompleteAction) {
          return { valid: false, error: '–í—ã–±–µ—Ä–∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –¥–Ω—ë–º' };
        }
        return { valid: true };
      },

      save: saveYesterdayVerify,

      xpAction: 'yesterday_verify'
    });

    devLog('[YesterdayVerify] ‚úÖ Step registered');
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
  registerYesterdayVerifyStep();

  // === –≠–∫—Å–ø–æ—Ä—Ç API ===
  HEYS.YesterdayVerify = {
    getYesterdayKey,
    getYesterdayData,
    shouldShow: shouldShowYesterdayVerify,
    VERIFY_OPTIONS,
    INCOMPLETE_ACTIONS
  };

  devLog('[HEYS] YesterdayVerify v1.1.1 loaded');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_sms_v1.js ===== */
// heys_sms_v1.js ‚Äî –ú–æ–¥—É–ª—å –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS –¥–ª—è –ü–≠–ü (SMS.ru)
// –í–µ—Ä—Å–∏—è: 1.0
// –î–∞—Ç–∞: 2025-12-20

(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  
  // =====================================================
  // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
  // =====================================================
  
  const SMS_CONFIG = {
    // API SMS.ru
    apiUrl: 'https://sms.ru/sms/send',
    
    // API –∫–ª—é—á (—Ö—Ä–∞–Ω–∏—Ç—å –≤ env, –Ω–µ –≤ –∫–æ–¥–µ!)
    // –í –ø—Ä–æ–¥–µ: process.env.SMSRU_API_KEY –∏–ª–∏ Supabase secrets
    apiKey: null, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ init()
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏)
    sender: 'HEYS',
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–¥–∞
    codeLength: 4,
    codeExpireMinutes: 10,
    
    // –õ–∏–º–∏—Ç—ã
    maxAttemptsPerHour: 3,
    resendDelaySeconds: 60
  };
  
  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–¥–æ–≤ (–≤ –ø—Ä–æ–¥–µ ‚Äî Redis/Supabase)
  const pendingCodes = new Map(); // phone -> { code, expires, attempts }
  
  // =====================================================
  // –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê
  // =====================================================
  
  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –∫–æ–¥
   */
  function generateCode(length = 4) {
    const digits = '0123456789';
    let code = '';
    for (let i = 0; i < length; i++) {
      code += digits[Math.floor(Math.random() * digits.length)];
    }
    return code;
  }
  
  // =====================================================
  // –û–¢–ü–†–ê–í–ö–ê SMS
  // =====================================================
  
  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS —á–µ—Ä–µ–∑ YandexAPI (Cloud Function)
   * @param {string} phone - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (79XXXXXXXXX)
   * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  async function sendSms(phone, message) {
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä
    const normalizedPhone = normalizePhone(phone);
    if (!normalizedPhone) {
      return { success: false, error: 'Invalid phone number' };
    }
    
    // Dev —Ä–µ–∂–∏–º ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ SMS
    if (SMS_CONFIG.devMode) {
      console.log('[SMS] DEV MODE ‚Äî –∫–æ–¥ –±—É–¥–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏');
      return { success: true, devMode: true };
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS —á–µ—Ä–µ–∑ Cloud Function
    if (window.HEYS?.YandexAPI?.sendSMS) {
      console.log('[SMS] –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ YandexAPI...');
      return await window.HEYS.YandexAPI.sendSMS(normalizedPhone, message);
    }
    
    // Fallback: –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API (–µ—Å–ª–∏ YandexAPI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω)
    try {
      console.log('[SMS] Fallback: –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ api.heyslab.ru...');
      const response = await fetch('https://api.heyslab.ru/sms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: normalizedPhone, msg: message })
      });
      
      const result = await response.json();
      
      if (!response.ok || result.status_code !== 100) {
        const errorMsg = result.status_text || result.error || `SMS error: ${result.status_code}`;
        console.error('[SMS] Error:', errorMsg);
        return { success: false, error: errorMsg };
      }
      
      return { success: true };
    } catch (error) {
      console.error('[SMS] Network error:', error);
      return { success: false, error: 'Network error' };
    }
  }
  
  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ —Ñ–æ—Ä–º–∞—Ç—É 79XXXXXXXXX
   */
  function normalizePhone(phone) {
    if (!phone) return null;
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
    let digits = phone.replace(/\D/g, '');
    
    // 8 ‚Üí 7
    if (digits.startsWith('8') && digits.length === 11) {
      digits = '7' + digits.slice(1);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º 7 –µ—Å–ª–∏ –Ω–µ—Ç
    if (digits.length === 10) {
      digits = '7' + digits;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
    if (digits.length !== 11 || !digits.startsWith('7')) {
      return null;
    }
    
    return digits;
  }
  
  // =====================================================
  // –ü–≠–ü ‚Äî –û–¢–ü–†–ê–í–ö–ê –ò –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê
  // =====================================================
  
  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –ü–≠–ü
   * @param {string} phone - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   * @returns {Promise<{success: boolean, error?: string, resendAfter?: number}>}
   */
  async function sendVerificationCode(phone) {
    const normalizedPhone = normalizePhone(phone);
    if (!normalizedPhone) {
      return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' };
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
    const existing = pendingCodes.get(normalizedPhone);
    if (existing) {
      const now = Date.now();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown
      if (existing.sentAt && (now - existing.sentAt) < SMS_CONFIG.resendDelaySeconds * 1000) {
        const resendAfter = Math.ceil((SMS_CONFIG.resendDelaySeconds * 1000 - (now - existing.sentAt)) / 1000);
        return { 
          success: false, 
          error: `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${resendAfter} —Å–µ–∫`,
          resendAfter 
        };
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª-–≤–æ –ø–æ–ø—ã—Ç–æ–∫
      if (existing.attempts >= SMS_CONFIG.maxAttemptsPerHour) {
        return { 
          success: false, 
          error: '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Å' 
        };
      }
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
    const code = generateCode(SMS_CONFIG.codeLength);
    const message = `HEYS: –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ${code}. –ù–∏–∫–æ–º—É –Ω–µ —Å–æ–æ–±—â–∞–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥.`;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SMS
    const result = await sendSms(normalizedPhone, message);
    
    if (result.success) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥
      pendingCodes.set(normalizedPhone, {
        code,
        expires: Date.now() + SMS_CONFIG.codeExpireMinutes * 60 * 1000,
        sentAt: Date.now(),
        attempts: (existing?.attempts || 0) + 1
      });
      
      return { success: true };
    }
    
    return result;
  }
  
  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   * @param {string} phone - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   * @param {string} code - –í–≤–µ–¥—ë–Ω–Ω—ã–π –∫–æ–¥
   * @returns {{valid: boolean, error?: string}}
   */
  function verifyCode(phone, code) {
    const normalizedPhone = normalizePhone(phone);
    if (!normalizedPhone) {
      return { valid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' };
    }
    
    const pending = pendingCodes.get(normalizedPhone);
    
    if (!pending) {
      return { valid: false, error: '–ö–æ–¥ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª—Å—è' };
    }
    
    if (Date.now() > pending.expires) {
      pendingCodes.delete(normalizedPhone);
      return { valid: false, error: '–ö–æ–¥ –∏—Å—Ç—ë–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π' };
    }
    
    if (pending.code !== code) {
      return { valid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥' };
    }
    
    // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π ‚Äî —É–¥–∞–ª—è–µ–º
    pendingCodes.delete(normalizedPhone);
    
    return { valid: true };
  }
  
  // =====================================================
  // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  // =====================================================
  
  /**
   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–æ–¥—É–ª—å SMS
   * @param {Object} config - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   * @param {string} config.apiKey - API –∫–ª—é—á SMS.ru
   * @param {string} [config.sender] - –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
   */
  function init(config) {
    if (config.apiKey) {
      SMS_CONFIG.apiKey = config.apiKey;
    }
    if (config.sender) {
      SMS_CONFIG.sender = config.sender;
    }
  }
  
  // =====================================================
  // DEV MODE ‚Äî –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö SMS
  // =====================================================
  
  let devMode = false;
  const devCodes = new Map();
  
  /**
   * –í–∫–ª—é—á–∞–µ—Ç dev-—Ä–µ–∂–∏–º (–∫–æ–¥—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –≤–º–µ—Å—Ç–æ SMS)
   */
  function enableDevMode() {
    devMode = true;
  }
  
  /**
   * Dev-–≤–µ—Ä—Å–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
   */
  async function sendVerificationCodeDev(phone) {
    const normalizedPhone = normalizePhone(phone);
    if (!normalizedPhone) {
      return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' };
    }
    
    const code = generateCode(SMS_CONFIG.codeLength);
    
    console.log(`[SMS DEV] Code for ${normalizedPhone}: ${code}`);
    
    devCodes.set(normalizedPhone, {
      code,
      expires: Date.now() + SMS_CONFIG.codeExpireMinutes * 60 * 1000
    });
    
    return { success: true };
  }
  
  /**
   * Dev-–≤–µ—Ä—Å–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
   */
  function verifyCodeDev(phone, code) {
    const normalizedPhone = normalizePhone(phone);
    const pending = devCodes.get(normalizedPhone);
    
    if (!pending) {
      return { valid: false, error: '–ö–æ–¥ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª—Å—è' };
    }
    
    if (Date.now() > pending.expires) {
      devCodes.delete(normalizedPhone);
      return { valid: false, error: '–ö–æ–¥ –∏—Å—Ç—ë–∫' };
    }
    
    if (pending.code !== code) {
      return { valid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥' };
    }
    
    devCodes.delete(normalizedPhone);
    return { valid: true };
  }
  
  // =====================================================
  // –≠–ö–°–ü–û–†–¢
  // =====================================================
  
  HEYS.sms = {
    init,
    enableDevMode,
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    sendCode: (phone) => devMode ? sendVerificationCodeDev(phone) : sendVerificationCode(phone),
    verifyCode: (phone, code) => devMode ? verifyCodeDev(phone, code) : verifyCode(phone, code),
    
    // –£—Ç–∏–ª–∏—Ç—ã
    normalizePhone,
    
    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    _config: SMS_CONFIG,
    _pendingCodes: pendingCodes,
    _devMode: () => devMode
  };
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  // –ù–∞ localhost ‚Äî dev mode (–∫–æ–¥—ã –≤ –∫–æ–Ω—Å–æ–ª—å)
  // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî –Ω—É–∂–µ–Ω API –∫–ª—é—á —á–µ—Ä–µ–∑ init()
  if (typeof window !== 'undefined') {
    const isLocalhost = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' ||
                        window.location.hostname.endsWith('.local');
    
    if (isLocalhost) {
      enableDevMode();
    }
  }
  
  // Verbose init log removed
  
})(typeof window !== 'undefined' ? window : global);


/* ===== heys_consents_v1.js ===== */
// heys_consents_v1.js ‚Äî –ú–æ–¥—É–ª—å —Å–æ–≥–ª–∞—Å–∏–π –∏ –ü–≠–ü (–ø—Ä–æ—Å—Ç–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å)
// –í–µ—Ä—Å–∏—è: 1.0
// 152-–§–ó compliant consent management

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const React = global.React;
  const { useState, useEffect, useCallback, useRef } = React || {};

  // =====================================================
  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  // =====================================================

  const CONSENT_TYPES = {
    USER_AGREEMENT: 'user_agreement',
    PERSONAL_DATA: 'personal_data',
    HEALTH_DATA: 'health_data',
    MARKETING: 'marketing'
  };

  const CURRENT_VERSIONS = {
    user_agreement: '1.2',
    personal_data: '1.2',
    health_data: '1.0',  // –û—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –æ –∑–¥–æ—Ä–æ–≤—å–µ
    marketing: '1.2'
  };

  const REQUIRED_CONSENTS = [
    CONSENT_TYPES.USER_AGREEMENT,
    CONSENT_TYPES.PERSONAL_DATA,
    CONSENT_TYPES.HEALTH_DATA
  ];

  // =====================================================
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
  // =====================================================

  // SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —á–µ–∫–±–æ–∫—Å—ã + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  // –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫–æ–Ω–Ω–æ –ø–æ 152-–§–ó —Å—Ç.9 (—Å–æ–≥–ª–∞—Å–∏–µ –≤ –ª—é–±–æ–π —Ñ–æ—Ä–º–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è)
  // SMS –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–∫–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ SMS.ru
  const SMS_VERIFICATION_ENABLED = false;

  // =====================================================
  // –¢–µ–∫—Å—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  // =====================================================

  const CONSENT_TEXTS = {
    // –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    checkboxes: {
      user_agreement: {
        label: '–ü—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è (–û—Ñ–µ—Ä—Ç—ã)',
        link: '/legal/user-agreement',
        required: true
      },
      personal_data: {
        label: '–î–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏',
        link: '/legal/privacy-policy',
        required: true
      },
      health_data: {
        label: '–î–∞—é —è–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ (–ø–∏—Ç–∞–Ω–∏–µ, –≤–µ—Å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å) –≤ —Ü–µ–ª—è—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ –°–µ—Ä–≤–∏—Å–∞',
        link: '/legal/health-data-consent',  // –û—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ 152-–§–ó —Å—Ç.10
        required: true
      },
      marketing: {
        label: '–°–æ–≥–ª–∞—Å–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–µ—Ä–≤–∏—Å–∞',
        link: null,
        required: false
      }
    },

    // –î—Ä—É–∂–µ–ª—é–±–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    friendlySummaries: {
      user_agreement: {
        emoji: 'ü§ù',
        title: '–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏?',
        color: '#dbeafe', // blue-100
        borderColor: '#3b82f6', // blue-500
        textColor: '#1e40af', // blue-800
        points: [
          'üì± –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é HEYS –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ –ø–∏—Ç–∞–Ω–∏—è',
          'üë®‚Äçüíº –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞—Ä–∏—Ñ–∞ Pro/Pro+ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∫—É—Ä–∞—Ç–æ—Ä–∞',
          '‚ö†Ô∏è –≠—Ç–æ –ù–ï –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —É—Å–ª—É–≥–∞ ‚Äî –∫—É—Ä–∞—Ç–æ—Ä –ø–æ–º–æ–≥–∞–µ—Ç —Å –ø–∏—Ç–∞–Ω–∏–µ–º, –Ω–æ –Ω–µ —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã',
          'üí∞ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø–æ—Ç–æ–º ‚Äî –ø–æ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞',
          'üö™ –ú–æ–∂–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –∑–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–Ω–∏'
        ]
      },
      personal_data: {
        emoji: 'üîí',
        title: '–ß—Ç–æ –º—ã –¥–µ–ª–∞–µ–º —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?',
        color: '#dcfce7', // green-100
        borderColor: '#22c55e', // green-500
        textColor: '#166534', // green-800
        points: [
          'üìù –•—Ä–∞–Ω–∏–º –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç',
          'üá∑üá∫ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –†–æ—Å—Å–∏–∏ (–Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–æ)',
          'üîê –ù–∏–∫–æ–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –∏ –Ω–µ –ø—Ä–æ–¥–∞—ë–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ',
          'üóëÔ∏è –ú–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç',
          'üìß –†–∞—Å—Å—ã–ª–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è'
        ]
      },
      health_data: {
        emoji: '‚ù§Ô∏è',
        title: '–ó–∞—á–µ–º –Ω–∞–º –¥–∞–Ω–Ω—ã–µ –æ –∑–¥–æ—Ä–æ–≤—å–µ?',
        color: '#fce7f3', // pink-100
        borderColor: '#ec4899', // pink-500
        textColor: '#9d174d', // pink-800
        points: [
          'üçé –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —á—Ç–æ –∏ —Å–∫–æ–ª—å–∫–æ –≤—ã –µ–¥–∏—Ç–µ',
          '‚öñÔ∏è –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤–µ—Å–∞',
          'üèÉ –£—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
          'üìä –ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é',
          'üõ°Ô∏è –≠—Ç–æ ¬´–æ—Å–æ–±—ã–µ –¥–∞–Ω–Ω—ã–µ¬ª –ø–æ –∑–∞–∫–æ–Ω—É ‚Äî —Ö—Ä–∞–Ω–∏–º –∏—Ö —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∑–∞—â–∏—Ç–æ–π'
        ]
      },
      marketing: {
        emoji: 'üì¨',
        title: '–ß—Ç–æ –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å?',
        color: '#fef3c7', // amber-100
        borderColor: '#f59e0b', // amber-500
        textColor: '#92400e', // amber-800
        points: [
          'üí° –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏',
          'üéÅ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö –∏ –∞–∫—Ü–∏—è—Ö',
          'üìä –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã –æ –≤–∞—à–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–µ',
          'üîï –ú–æ–∂–Ω–æ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö',
          '‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ —á–∞—â–µ 1-2 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é'
        ]
      }
    },

    // –î–∏—Å–∫–ª–µ–π–º–µ—Ä
    disclaimer: {
      short: 'HEYS ‚Äî —Å–µ—Ä–≤–∏—Å —É—á—ë—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è. –ù–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —É—Å–ª—É–≥–æ–π.',
      full: 'HEYS –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –ø–æ —É—á—ë—Ç—É –ø–∏—Ç–∞–Ω–∏—è –∏ –∫–æ—É—á–∏–Ω–≥–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ. ' +
        '–°–µ—Ä–≤–∏—Å –ù–ï —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π, –Ω–µ –æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —É—Å–ª—É–≥–∏, ' +
        '–Ω–µ —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –ª–µ—á–µ–Ω–∏–µ. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.'
    },

    // –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—Å–∏—è (–∫—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∞)
    consentSummary: `
–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ:
‚Ä¢ –û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ —Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º (–û—Ñ–µ—Ä—Ç–æ–π)
‚Ä¢ –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö  
‚Ä¢ –Ø–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ

–°–æ–≥–ª–∞—Å–∏–µ –¥–∞—ë—Ç—Å—è –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω–æ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è.
    `.trim()
  };

  // =====================================================
  // API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–≥–ª–∞—Å–∏—è–º–∏
  // =====================================================

  const consentsAPI = {
    /**
     * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π —á–µ—Ä–µ–∑ YandexAPI
     */
    async logConsents(clientId, consents) {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI
        if (HEYS.YandexAPI) {
          const result = await HEYS.YandexAPI.logConsents(clientId, consents, navigator.userAgent);
          if (result.error) throw new Error(result.error?.message || result.error);
          console.log('[Consents] ‚úÖ Logged:', result);
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî YandexAPI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { data: { log_consents: { success, logged_count } }, error: null }
          return { success: result.data?.log_consents?.success ?? !result.error, data: result.data };
        }

        console.warn('[Consents] YandexAPI not available');
        return { success: false, error: 'No API client' };
      } catch (err) {
        console.error('[Consents] ‚ùå Error logging:', err);
        return { success: false, error: err.message };
      }
    },

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–∏–π
     */
    async checkRequired(clientId) {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI
        if (HEYS.YandexAPI) {
          const result = await HEYS.YandexAPI.checkRequiredConsents(clientId);
          if (result.error) throw new Error(result.error?.message || result.error);
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî YandexAPI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { data: { check_required_consents: { valid, missing } }, error: null }
          const data = result.data?.check_required_consents || result.data;
          return {
            valid: data?.valid ?? false,
            missing: data?.missing || REQUIRED_CONSENTS
          };
        }

        return { valid: false, missing: REQUIRED_CONSENTS };
      } catch (err) {
        console.error('[Consents] ‚ùå Error checking:', err);
        return { valid: false, missing: REQUIRED_CONSENTS, error: err.message };
      }
    },

    /**
     * –û—Ç–∑—ã–≤ —Å–æ–≥–ª–∞—Å–∏—è
     */
    async revoke(clientId, consentType) {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI
        if (HEYS.YandexAPI) {
          const result = await HEYS.YandexAPI.revokeConsent(clientId, consentType);
          if (result.error) throw new Error(result.error?.message || result.error);
          console.log('[Consents] ‚úÖ Revoked:', consentType);
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          return { success: result.data?.revoke_consent?.success ?? !result.error };
        }

        return { success: false, error: 'No API client' };
      } catch (err) {
        console.error('[Consents] ‚ùå Error revoking:', err);
        return { success: false, error: err.message };
      }
    },

    /**
     * –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∏–∑ localStorage)
     */
    hasLocalConsent(clientId) {
      const key = `heys_consents_${clientId}`;
      const stored = localStorage.getItem(key);
      if (!stored) return false;

      try {
        const data = JSON.parse(stored);
        return REQUIRED_CONSENTS.every(type => data[type] === true);
      } catch {
        return false;
      }
    },

    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
     */
    saveLocal(clientId, consents) {
      const key = `heys_consents_${clientId}`;
      const data = {};
      consents.forEach(c => {
        data[c.type] = c.granted !== false;
      });
      data.timestamp = Date.now();
      data.version = CURRENT_VERSIONS;
      localStorage.setItem(key, JSON.stringify(data));
    }
  };

  // =====================================================
  // React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  // =====================================================

  /**
   * –≠–∫—Ä–∞–Ω —Å–æ–≥–ª–∞—Å–∏–π (–ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π, –±–ª–æ–∫–∏—Ä—É—é—â–∏–π)
   * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞
   * @param {string} phone - –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)
   * @param {function} onComplete - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø—Ä–∏–Ω—è—Ç–∏–∏ —Å–æ–≥–ª–∞—Å–∏–π
   * @param {function} onCancel - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ (–≤—ã—Ö–æ–¥ –±–µ–∑ –ø—Ä–∏–Ω—è—Ç–∏—è)
   * @param {function} onError - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
   */
  function ConsentScreen({ clientId, phone, onComplete, onCancel, onError }) {
    // –®–∞–≥–∏: 'consents' ‚Üí 'verify_code' ‚Üí done
    // –í–ê–ñ–ù–û: –µ—Å–ª–∏ SMS –≤—ã–∫–ª—é—á–µ–Ω ‚Äî verify_code –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!
    const [step, setStep] = useState('consents');
    const [consents, setConsents] = useState({
      user_agreement: false,
      personal_data: false,
      health_data: false,
      marketing: false
    });
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [showFullText, setShowFullText] = useState(null);

    // SMS verification state
    const [code, setCode] = useState('');
    const [codeSent, setCodeSent] = useState(false);
    const [resendTimer, setResendTimer] = useState(0);
    const codeInputRef = useRef(null);

    const allRequiredAccepted = REQUIRED_CONSENTS.every(type => consents[type]);

    // =====================================================
    // –ê–í–ê–†–ò–ô–ù–´–ô –í–´–ö–õ–Æ–ß–ê–¢–ï–õ–¨: –µ—Å–ª–∏ SMS –≤—ã–∫–ª—é—á–µ–Ω ‚Äî verify_code –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω
    // =====================================================
    useEffect(() => {
      if (!SMS_VERIFICATION_ENABLED && step === 'verify_code') {
        console.warn('[Consents] ‚ö†Ô∏è SMS –≤—ã–∫–ª—é—á–µ–Ω, –Ω–æ step=verify_code ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å');
        setStep('consents');
      }
    }, [step]);

    const handleToggle = useCallback((type) => {
      setConsents(prev => ({ ...prev, [type]: !prev[type] }));
    }, []);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ SMS –∫–æ–¥–∞
    const sendVerificationCode = useCallback(async () => {
      if (!phone) {
        setError('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
        return false;
      }

      setLoading(true);
      setError(null);

      try {
        const result = await HEYS.sms?.sendCode(phone);

        if (result?.success) {
          setCodeSent(true);
          setResendTimer(60);
          return true;
        } else {
          setError(result?.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS');
          return false;
        }
      } catch (err) {
        setError(err.message);
        return false;
      } finally {
        setLoading(false);
      }
    }, [phone]);

    // –¢–∞–π–º–µ—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    useEffect(() => {
      if (resendTimer > 0) {
        const timer = setTimeout(() => setResendTimer(r => r - 1), 1000);
        return () => clearTimeout(timer);
      }
    }, [resendTimer]);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    const verifyCodeAndSubmit = useCallback(async () => {
      if (code.length < 4) {
        setError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS');
        return;
      }

      setLoading(true);
      setError(null);

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
        const verifyResult = HEYS.sms?.verifyCode(phone, code);

        if (!verifyResult?.valid) {
          setError(verifyResult?.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
          setLoading(false);
          return;
        }

        // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–≥–ª–∞—Å–∏—è —Å –º–µ—Ç–æ–¥–æ–º –ø–æ–¥–ø–∏—Å–∏
        const consentList = Object.entries(consents).map(([type, granted]) => ({
          type,
          granted,
          signature_method: type === 'health_data' ? 'sms_code' : 'checkbox'
        }));

        // –õ–æ–≥–∏—Ä—É–µ–º –≤ Supabase
        const result = await consentsAPI.logConsents(clientId, consentList);

        if (!result.success) {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏–π');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        consentsAPI.saveLocal(clientId, consentList);

        // –£—Å–ø–µ—Ö!
        onComplete?.(consentList);
      } catch (err) {
        setError(err.message);
        onError?.(err);
      } finally {
        setLoading(false);
      }
    }, [clientId, phone, code, consents, onComplete, onError]);

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    const handleProceedToVerify = useCallback(async () => {
      if (!allRequiredAccepted) return;

      // SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —á–µ–∫–±–æ–∫—Å—ã + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      // –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫–æ–Ω–Ω–æ –ø–æ 152-–§–ó —Å—Ç.9
      if (!SMS_VERIFICATION_ENABLED || !HEYS.sms || !phone) {
        console.log('[Consents] ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–≥–ª–∞—Å–∏—è (—á–µ–∫–±–æ–∫—Å + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑ SMS)');
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        setLoading(true);
        try {
          const consentList = Object.entries(consents).map(([type, granted]) => ({
            type,
            granted,
            signature_method: 'checkbox'
          }));

          const result = await consentsAPI.logConsents(clientId, consentList);
          if (!result.success) throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏–π');

          consentsAPI.saveLocal(clientId, consentList);
          onComplete?.(consentList);
        } catch (err) {
          setError(err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
          onError?.(err);
        } finally {
          setLoading(false);
        }
        return;
      }

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      setStep('verify_code');
      // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥
      await sendVerificationCode();
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setTimeout(() => codeInputRef.current?.focus(), 100);
    }, [allRequiredAccepted, consents, clientId, phone, onComplete, onError, sendVerificationCode]);

    // –°—Ç–∞—Ä—ã–π handleSubmit –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)
    const handleSubmit = useCallback(async () => {
      if (!allRequiredAccepted) return;

      setLoading(true);
      setError(null);

      try {
        // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å–æ–≥–ª–∞—Å–∏–π
        const consentList = Object.entries(consents).map(([type, granted]) => ({
          type,
          granted,
          signature_method: 'checkbox'
        }));

        // –õ–æ–≥–∏—Ä—É–µ–º –≤ Supabase
        const result = await consentsAPI.logConsents(clientId, consentList);

        if (!result.success) {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏–π');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        consentsAPI.saveLocal(clientId, consentList);

        // –£—Å–ø–µ—Ö!
        onComplete?.(consentList);
      } catch (err) {
        setError(err.message);
        onError?.(err);
      } finally {
        setLoading(false);
      }
    }, [clientId, consents, allRequiredAccepted, onComplete, onError]);

    return React.createElement('div', {
      className: 'fixed inset-0 z-50 flex flex-col',
      style: { backgroundColor: '#ffffff' }
    },
      // Header
      React.createElement('div', {
        className: 'p-4 border-b',
        style: { borderColor: '#e5e7eb' }
      },
        React.createElement('h1', {
          className: 'text-xl font-semibold',
          style: { color: '#18181b' }
        }, step === 'verify_code' ? 'üì± –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ' : 'üìã –°–æ–≥–ª–∞—Å–∏—è –∏ —É—Å–ª–æ–≤–∏—è'),
        React.createElement('p', {
          className: 'text-sm mt-1',
          style: { color: '#71717a' }
        }, step === 'verify_code'
          ? '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ'
          : '–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è')
      ),

      // Content - —Ä–∞–∑–Ω—ã–µ —à–∞–≥–∏
      step === 'consents' ? (
        // –®–∞–≥ 1: –ß–µ–∫–±–æ–∫—Å—ã —Å–æ–≥–ª–∞—Å–∏–π
        React.createElement('div', {
          className: 'flex-1 overflow-auto p-4 space-y-4'
        },
          // –î–∏—Å–∫–ª–µ–π–º–µ—Ä
          React.createElement('div', {
            className: 'rounded-xl p-4',
            style: { backgroundColor: '#fffbeb', border: '1px solid #fde68a' }
          },
            React.createElement('div', {
              className: 'flex items-start gap-3'
            },
              React.createElement('span', { className: 'text-xl' }, '‚ö†Ô∏è'),
              React.createElement('div', null,
                React.createElement('p', {
                  className: 'font-medium',
                  style: { color: '#92400e' }
                }, '–í–∞–∂–Ω–æ'),
                React.createElement('p', {
                  className: 'text-sm mt-1',
                  style: { color: '#b45309' }
                }, CONSENT_TEXTS.disclaimer.full)
              )
            )
          ),

          // –ß–µ–∫–±–æ–∫—Å—ã
          React.createElement('div', {
            className: 'space-y-3'
          },
            // User Agreement
            React.createElement(ConsentCheckbox, {
              type: 'user_agreement',
              checked: consents.user_agreement,
              onChange: () => handleToggle('user_agreement'),
              config: CONSENT_TEXTS.checkboxes.user_agreement,
              onShowFull: () => setShowFullText('user_agreement')
            }),

            // Personal Data
            React.createElement(ConsentCheckbox, {
              type: 'personal_data',
              checked: consents.personal_data,
              onChange: () => handleToggle('personal_data'),
              config: CONSENT_TEXTS.checkboxes.personal_data,
              onShowFull: () => setShowFullText('personal_data')
            }),

            // Health Data
            React.createElement(ConsentCheckbox, {
              type: 'health_data',
              checked: consents.health_data,
              onChange: () => handleToggle('health_data'),
              config: CONSENT_TEXTS.checkboxes.health_data,
              onShowFull: () => setShowFullText('health_data')
            }),

            // Divider
            React.createElement('hr', {
              className: 'my-4',
              style: { borderColor: '#e5e7eb' }
            }),

            // Marketing (optional)
            React.createElement(ConsentCheckbox, {
              type: 'marketing',
              checked: consents.marketing,
              onChange: () => handleToggle('marketing'),
              config: CONSENT_TEXTS.checkboxes.marketing
            })
          ),

          // Error
          error && React.createElement('div', {
            className: 'rounded-xl p-4',
            style: { backgroundColor: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626' }
          }, '‚ùå ', error)
        )
      ) : (
        // –®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ SMS
        React.createElement('div', {
          className: 'flex-1 overflow-auto p-4 space-y-4'
        },
          // –ò–Ω—Ñ–æ –æ –∫–æ–¥–µ
          React.createElement('div', {
            className: 'rounded-xl p-4',
            style: { backgroundColor: '#eff6ff', border: '1px solid #bfdbfe' }
          },
            React.createElement('div', {
              className: 'flex items-start gap-3'
            },
              React.createElement('span', { className: 'text-xl' }, 'üì±'),
              React.createElement('div', null,
                React.createElement('p', {
                  className: 'font-medium',
                  style: { color: '#1e40af' }
                }, codeSent ? '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' : '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥...'),
                React.createElement('p', {
                  className: 'text-sm mt-1',
                  style: { color: '#3b82f6' }
                }, codeSent
                  ? `SMS —Å –∫–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –Ω–æ–º–µ—Ä ${phone?.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/, '+$1 ($2) ***-**-$5')}`
                  : '–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥—ë—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞...')
              )
            )
          ),

          // –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
          React.createElement('div', {
            className: 'space-y-2'
          },
            React.createElement('label', {
              className: 'block text-sm font-medium',
              style: { color: '#3f3f46' }
            }, '–ö–æ–¥ –∏–∑ SMS'),
            React.createElement('input', {
              ref: codeInputRef,
              type: 'text',
              inputMode: 'numeric',
              pattern: '[0-9]*',
              maxLength: 4,
              placeholder: '‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢',
              value: code,
              onChange: (e) => setCode(e.target.value.replace(/\D/g, '').slice(0, 4)),
              className: 'w-full px-4 py-4 text-center text-2xl font-bold tracking-widest rounded-xl',
              style: {
                border: '2px solid #e5e7eb',
                outline: 'none',
                letterSpacing: '0.5em'
              },
              disabled: loading
            })
          ),

          // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
          React.createElement('div', {
            className: 'text-center'
          },
            resendTimer > 0
              ? React.createElement('p', {
                className: 'text-sm',
                style: { color: '#71717a' }
              }, `–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${resendTimer} —Å–µ–∫`)
              : React.createElement('button', {
                type: 'button',
                onClick: sendVerificationCode,
                disabled: loading,
                className: 'text-sm font-medium',
                style: { color: '#3b82f6' }
              }, 'üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ')
          ),

          // –ü–æ—è—Å–Ω–µ–Ω–∏–µ
          React.createElement('div', {
            className: 'rounded-xl p-4',
            style: { backgroundColor: '#f4f4f5' }
          },
            React.createElement('p', {
              className: 'text-sm',
              style: { color: '#71717a' }
            }, 'üîí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–æ–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å 152-–§–ó —Å—Ç.10')
          ),

          // Error
          error && React.createElement('div', {
            className: 'rounded-xl p-4',
            style: { backgroundColor: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626' }
          }, '‚ùå ', error)
        )
      ),

      // Footer
      React.createElement('div', {
        className: 'p-4 safe-area-bottom space-y-3',
        style: { borderTop: '1px solid #e5e7eb' }
      },
        step === 'consents' ? (
          // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
          React.createElement('button', {
            onClick: handleProceedToVerify,
            disabled: !allRequiredAccepted || loading,
            className: 'w-full py-4 rounded-xl font-semibold text-white transition-all',
            style: {
              backgroundColor: allRequiredAccepted && !loading ? '#22c55e' : '#d4d4d8',
              cursor: allRequiredAccepted && !loading ? 'pointer' : 'not-allowed'
            }
          }, loading ? '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...' : '‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å')
        ) : (
          // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" –∫–æ–¥
          React.createElement('button', {
            onClick: verifyCodeAndSubmit,
            disabled: code.length < 4 || loading,
            className: 'w-full py-4 rounded-xl font-semibold text-white transition-all',
            style: {
              backgroundColor: code.length >= 4 && !loading ? '#22c55e' : '#d4d4d8',
              cursor: code.length >= 4 && !loading ? 'pointer' : 'not-allowed'
            }
          }, loading ? '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...' : '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å')
        ),

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–ª–∏ "–í—ã–π—Ç–∏"
        step === 'verify_code' ? (
          React.createElement('button', {
            onClick: () => { setStep('consents'); setError(null); setCode(''); },
            disabled: loading,
            className: 'w-full py-3 rounded-xl font-medium transition-all',
            style: { color: '#71717a' }
          }, '‚Üê –ù–∞–∑–∞–¥ –∫ —Å–æ–≥–ª–∞—Å–∏—è–º')
        ) : (
          onCancel && React.createElement('button', {
            onClick: onCancel,
            disabled: loading,
            className: 'w-full py-3 rounded-xl font-medium transition-all',
            style: { color: '#71717a' }
          }, '‚Üê –í—ã–π—Ç–∏ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')
        )
      ),

      // Full text modal
      showFullText && React.createElement(FullTextModal, {
        type: showFullText,
        onClose: () => setShowFullText(null),
        onAccept: () => {
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ–º —á–µ–∫–±–æ–∫—Å –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
          setConsents(prev => ({ ...prev, [showFullText]: true }));
          setShowFullText(null);
        }
      })
    );
  }

  /**
   * –ß–µ–∫–±–æ–∫—Å —Å–æ–≥–ª–∞—Å–∏—è
   */
  function ConsentCheckbox({ type, checked, onChange, config, onShowFull }) {
    const checkedStyle = {
      border: '1px solid #22c55e',
      backgroundColor: '#f0fdf4'
    };
    const uncheckedStyle = {
      border: '1px solid #e5e7eb',
      backgroundColor: '#ffffff'
    };

    return React.createElement('label', {
      className: 'flex items-start gap-3 p-4 rounded-xl cursor-pointer transition-all',
      style: checked ? checkedStyle : uncheckedStyle
    },
      // Checkbox
      React.createElement('div', {
        className: 'w-6 h-6 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5',
        style: checked
          ? { border: '2px solid #22c55e', backgroundColor: '#22c55e' }
          : { border: '2px solid #d4d4d8', backgroundColor: 'transparent' }
      },
        checked && React.createElement('span', { className: 'text-white text-sm' }, '‚úì')
      ),

      // Label
      React.createElement('div', {
        className: 'flex-1'
      },
        React.createElement('span', {
          className: 'text-sm',
          style: { color: '#3f3f46' }
        }, config.label),

        // Required badge
        config.required && React.createElement('span', {
          className: 'ml-2 text-xs',
          style: { color: '#ef4444' }
        }, '*'),

        // Link to full text
        config.link && React.createElement('button', {
          type: 'button',
          onClick: (e) => {
            e.preventDefault();
            e.stopPropagation();
            onShowFull?.();
          },
          className: 'block mt-1 text-xs hover:underline',
          style: { color: '#3b82f6' }
        }, '–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí')
      ),

      // Hidden input for form
      React.createElement('input', {
        type: 'checkbox',
        checked: checked,
        onChange: onChange,
        className: 'sr-only'
      })
    );
  }

  // === –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ —Å–æ–≥–ª–∞—Å–∏–π –Ω–∞ markdown —Ñ–∞–π–ª—ã ===
  // –§–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ public/docs/ (—Å–∏–º–ª–∏–Ω–∫ –Ω–∞ docs/legal/)
  // ‚ö†Ô∏è –í–ê–ñ–ù–û (—Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ –ø—Ä–æ—Ç–∏–≤ CDN-–∫—ç—à–∞):
  // - –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–¥–Ω—É –∏ —Ç—É –∂–µ –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ URL.
  // - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º CURRENT_VERSIONS.
  // - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥—Ä—É–∑–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –£–ù–ò–ö–ê–õ–¨–ù–û–ú–£ –ø—É—Ç–∏: /docs/v<version>/...
  // - /docs/... –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ "latest" (–¥–ª—è –ø—Ä—è–º—ã—Ö —Å—Å—ã–ª–æ–∫/–∏–Ω—Å–ø–µ–∫—Ü–∏–∏), –Ω–æ –º–æ–∂–µ—Ç –∑–∞–ª–∏–ø–∞—Ç—å –Ω–∞ edge.
  function buildVersionedDocPath(fileName, version) {
    return `/docs/v${version}/${fileName}`;
  }

  function buildLatestDocPath(fileName, version) {
    // Query ‚Äî –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π cache-busting –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞/Service Worker.
    // –í–∞–∂–Ω–æ: CDN –º–æ–∂–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å query, –ø–æ—ç—Ç–æ–º—É —ç—Ç–æ –ù–ï –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞—â–∏—Ç–∞.
    return `/docs/${fileName}?v=${version}`;
  }

  function escapeRegExp(str) {
    return String(str || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function isExpectedDocVersion(markdown, expectedVersion) {
    // –ù–µ –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, chat rules) ‚Äî —Ç–æ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞.
    if (!expectedVersion) return true;
    if (!markdown) return false;

    // –ò—â–µ–º –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∞: **–í–µ—Ä—Å–∏—è:** 1.2
    const re = new RegExp(`\\*\\*–í–µ—Ä—Å–∏—è:\\*\\*\\s*${escapeRegExp(expectedVersion)}(\\b|\\s|$)`);
    return re.test(markdown);
  }

  const DOC_PATHS = {
    user_agreement: {
      versioned: buildVersionedDocPath('user-agreement.md', CURRENT_VERSIONS.user_agreement),
      latest: buildLatestDocPath('user-agreement.md', CURRENT_VERSIONS.user_agreement)
    },
    personal_data: {
      versioned: buildVersionedDocPath('privacy-policy.md', CURRENT_VERSIONS.personal_data),
      latest: buildLatestDocPath('privacy-policy.md', CURRENT_VERSIONS.personal_data)
    },
    health_data: {
      // –û—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –æ –∑–¥–æ—Ä–æ–≤—å–µ (152-–§–ó —Å—Ç.10)
      versioned: buildVersionedDocPath('health-data-consent.md', CURRENT_VERSIONS.health_data),
      latest: buildLatestDocPath('health-data-consent.md', CURRENT_VERSIONS.health_data)
    }
  };

  // –ö–µ—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Å –≤–µ—Ä—Å–∏–µ–π)
  const docCache = {};
  const docCacheVersion = `${CURRENT_VERSIONS.user_agreement}-${CURRENT_VERSIONS.personal_data}-${CURRENT_VERSIONS.health_data}`;

  // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏ ‚Äî –æ—á–∏—â–∞–µ–º localStorage –∫—ç—à
  (() => {
    const cacheKey = 'heys_docs_cache_version';
    const storedVersion = localStorage.getItem(cacheKey);
    if (storedVersion !== docCacheVersion) {
      // üîá v4.7.1: –õ–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω
      localStorage.setItem(cacheKey, docCacheVersion);
      // –û—á–∏—â–∞–µ–º in-memory –∫—ç—à (—É–∂–µ –ø—É—Å—Ç–æ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –Ω–æ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
      Object.keys(docCache).forEach(key => delete docCache[key]);
    }
  })();

  /**
   * –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä Markdown ‚Üí HTML
   * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∂–∏—Ä–Ω—ã–π/–∫—É—Ä—Å–∏–≤, —Ç–∞–±–ª–∏—Ü—ã, –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
   */
  function parseMarkdown(md) {
    if (!md) return '';

    let html = md
      // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
      .replace(/^---+$/gm, '<hr class="my-4 border-zinc-300 dark:border-zinc-600">')
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      .replace(/^#### (.+)$/gm, '<h4 class="text-base font-semibold mt-4 mb-2">$1</h4>')
      .replace(/^### (.+)$/gm, '<h3 class="text-lg font-semibold mt-6 mb-3">$1</h3>')
      .replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold mt-8 mb-4">$1</h2>')
      .replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold mb-4">$1</h1>')
      // Blockquotes
      .replace(/^&gt; (.+)$/gm, '<blockquote class="border-l-4 border-zinc-300 dark:border-zinc-600 pl-4 italic text-zinc-600 dark:text-zinc-400 my-2">$1</blockquote>')
      // –ñ–∏—Ä–Ω—ã–π –∏ –∫—É—Ä—Å–∏–≤
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      // –ò–Ω–ª–∞–π–Ω-–∫–æ–¥
      .replace(/`(.+?)`/g, '<code class="bg-zinc-100 dark:bg-zinc-800 px-1 rounded text-sm">$1</code>')
      // –°—Å—ã–ª–∫–∏
      .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" class="text-blue-500 underline" target="_blank">$1</a>')
      // –°–ø–∏—Å–∫–∏ (–ø—Ä–æ—Å—Ç—ã–µ)
      .replace(/^- (.+)$/gm, '<li class="ml-4 list-disc">$1</li>')
      .replace(/^‚Ä¢ (.+)$/gm, '<li class="ml-4 list-disc">$1</li>')
      .replace(/^\d+\. (.+)$/gm, '<li class="ml-4 list-decimal">$1</li>')
      // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã (–ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏)
      .replace(/\n\n/g, '</p><p class="my-2">')
      // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
      .replace(/\n/g, '<br>');

    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ
    html = '<p class="my-2">' + html + '</p>';

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏
    html = html.replace(/(<li[^>]*>.*?<\/li>)(\s*<br>)?/g, '$1');

    return html;
  }

  /**
   * –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞
   * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –ø–∞—Ä—Å–∏—Ç markdown —Ñ–∞–π–ª—ã –∏–∑ /docs/legal/
   * –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–æ –∫–æ–Ω—Ü–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   */
  function FullTextModal({ type, onClose, onAccept }) {
    const [content, setContent] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [retryCount, setRetryCount] = useState(0);
    const [hasScrolledToEnd, setHasScrolledToEnd] = useState(false);
    const contentRef = useRef(null);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏ –∫–æ–Ω—Ü–∞
    const handleScroll = useCallback(() => {
      if (!contentRef.current || hasScrolledToEnd) return;

      const { scrollTop, scrollHeight, clientHeight } = contentRef.current;
      // –°—á–∏—Ç–∞–µ–º "–¥–æ –∫–æ–Ω—Ü–∞" –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å < 50px
      const isAtBottom = scrollTop + clientHeight >= scrollHeight - 50;

      if (isAtBottom) {
        setHasScrolledToEnd(true);
      }
    }, [hasScrolledToEnd]);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –∫–æ—Ä–æ—Ç–∫–∏–π)
    useEffect(() => {
      if (content && contentRef.current) {
        const { scrollHeight, clientHeight } = contentRef.current;
        // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ ‚Äî —Å—Ä–∞–∑—É —Ä–∞–∑—Ä–µ—à–∞–µ–º
        if (scrollHeight <= clientHeight + 10) {
          setHasScrolledToEnd(true);
        }
      }
    }, [content]);

    useEffect(() => {
      async function loadDocument() {
        setLoading(true);
        setError(null);
        setHasScrolledToEnd(false);

        const docInfo = DOC_PATHS[type];

        if (!docInfo) {
          setError('–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
          setLoading(false);
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ retry)
        if (retryCount === 0 && docCache[type]) {
          setContent(docCache[type]);
          setLoading(false);
          return;
        }

        async function fetchMarkdown(url) {
          const response = await fetch(url, { cache: 'no-store' });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          return response.text();
        }

        try {
          // 1) –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º "–Ω–µ—É–±–∏–≤–∞–µ–º—ã–π" –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å.
          // 2) –ï—Å–ª–∏ /docs/vX –µ—â—ë –Ω–µ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã ‚Äî –ø—Ä–æ–±—É–µ–º /docs/latest, –ù–û —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.
          //    –≠—Ç–æ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ: –Ω–µ–ª—å–∑—è –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ CDN-–∫—ç—à–∞.
          let markdown;
          const expectedVersion = CURRENT_VERSIONS[type];

          try {
            markdown = await fetchMarkdown(docInfo.versioned);
            if (!isExpectedDocVersion(markdown, expectedVersion)) {
              throw new Error('DOC_VERSION_MISMATCH');
            }
          } catch (e) {
            markdown = await fetchMarkdown(docInfo.latest);
            if (!isExpectedDocVersion(markdown, expectedVersion)) {
              const exp = expectedVersion ? `v${expectedVersion}` : '–∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è';
              setError(
                `–°–µ–π—á–∞—Å CDN –æ—Ç–¥–∞—ë—Ç —É—Å—Ç–∞—Ä–µ–≤—à—É—é –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–æ–∂–∏–¥–∞–µ—Ç—Å—è ${exp}).\n\n` +
                `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`
              );
              setLoading(false);
              return;
            }
          }

          // –¢–µ–ø–µ—Ä—å health_data –∏–º–µ–µ—Ç —Å–≤–æ–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –ø–∞—Ä—Å–∏–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
          const html = parseMarkdown(markdown);

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
          docCache[type] = html;

          setContent(html);
          setError(null);
        } catch (err) {
          console.error('[Consents] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', err);
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        } finally {
          setLoading(false);
        }
      }

      loadDocument();
    }, [type, retryCount]);

    // Retry handler
    const handleRetry = () => {
      delete docCache[type];
      setRetryCount(c => c + 1);
    };

    return React.createElement('div', {
      className: 'fixed inset-0 z-[60] flex items-end',
      style: { backgroundColor: 'rgba(0, 0, 0, 0.5)' }
    },
      React.createElement('div', {
        className: 'rounded-t-2xl w-full max-h-[80vh] flex flex-col',
        style: { backgroundColor: '#ffffff' }
      },
        // Header
        React.createElement('div', {
          className: 'flex items-center justify-between p-4',
          style: { borderBottom: '1px solid #e5e7eb' }
        },
          React.createElement('h2', {
            className: 'font-semibold',
            style: { color: '#18181b' }
          }, CONSENT_TEXTS.checkboxes[type]?.label || type),
          React.createElement('button', {
            onClick: onClose,
            className: 'p-2 rounded-full',
            style: { color: '#71717a' }
          }, '‚úï')
        ),

        // Content —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        React.createElement('div', {
          ref: contentRef,
          onScroll: handleScroll,
          className: 'flex-1 overflow-auto p-4'
        },
          loading
            ? React.createElement('div', {
              className: 'text-center py-8',
              style: { color: '#71717a' }
            }, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...')
            : error
              ? React.createElement('div', {
                className: 'text-center py-8',
                style: { color: '#ef4444' }
              },
                React.createElement('p', null, '‚ùå ', error),
                React.createElement('button', {
                  onClick: handleRetry,
                  className: 'mt-4 text-sm underline',
                  style: { color: '#3b82f6' }
                }, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞')
              )
              : React.createElement('div', null,
                // –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –±–ª–æ–∫-—Ä–µ–∑—é–º–µ
                CONSENT_TEXTS.friendlySummaries[type] && React.createElement('div', {
                  className: 'mb-4 p-4 rounded-xl',
                  style: {
                    backgroundColor: CONSENT_TEXTS.friendlySummaries[type].color,
                    borderLeft: `4px solid ${CONSENT_TEXTS.friendlySummaries[type].borderColor}`
                  }
                },
                  React.createElement('div', {
                    className: 'flex items-center gap-2 mb-3'
                  },
                    React.createElement('span', { className: 'text-2xl' }, CONSENT_TEXTS.friendlySummaries[type].emoji),
                    React.createElement('span', {
                      className: 'font-semibold',
                      style: { color: CONSENT_TEXTS.friendlySummaries[type].textColor }
                    }, CONSENT_TEXTS.friendlySummaries[type].title)
                  ),
                  React.createElement('ul', {
                    className: 'space-y-2 text-sm',
                    style: { color: CONSENT_TEXTS.friendlySummaries[type].textColor }
                  },
                    CONSENT_TEXTS.friendlySummaries[type].points.map((point, i) =>
                      React.createElement('li', { key: i }, point)
                    )
                  )
                ),
                // –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
                React.createElement('div', {
                  className: 'prose max-w-none text-sm leading-relaxed',
                  style: { color: '#3f3f46' },
                  dangerouslySetInnerHTML: { __html: content }
                })
              )
        ),

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ–ª–∏—Å—Ç–∞–ª–∏)
        !loading && !error && !hasScrolledToEnd && React.createElement('div', {
          className: 'px-4 py-2 text-center',
          style: { backgroundColor: '#fef3c7', color: '#92400e' }
        },
          React.createElement('p', { className: 'text-xs' }, 'üëá –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–æ –∫–æ–Ω—Ü–∞, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å')
        ),

        // Footer —Å –∫–Ω–æ–ø–∫–∞–º–∏
        React.createElement('div', {
          className: 'p-4 space-y-2',
          style: { borderTop: '1px solid #e5e7eb' }
        },
          // –ö–Ω–æ–ø–∫–∞ "–û–∑–Ω–∞–∫–æ–º–ª–µ–Ω" ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
          hasScrolledToEnd && !loading && !error && React.createElement('button', {
            onClick: onAccept,
            className: 'w-full py-3 rounded-xl font-semibold text-white transition-all',
            style: { backgroundColor: '#22c55e' }
          }, '‚úÖ –û–∑–Ω–∞–∫–æ–º–ª–µ–Ω, –ø—Ä–∏–Ω–∏–º–∞—é'),

          // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å" ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞
          React.createElement('button', {
            onClick: onClose,
            className: 'w-full py-3 rounded-xl font-medium',
            style: { backgroundColor: '#f4f4f5', color: '#3f3f46' }
          }, hasScrolledToEnd ? '–ó–∞–∫—Ä—ã—Ç—å –±–µ–∑ –ø—Ä–∏–Ω—è—Ç–∏—è' : '–ó–∞–∫—Ä—ã—Ç—å')
        )
      )
    );
  }

  /**
   * –ë–∞–Ω–Ω–µ—Ä –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞ (–¥–ª—è —Ñ—É—Ç–µ—Ä–∞)
   */
  function DisclaimerBanner({ variant = 'short' }) {
    const text = variant === 'full'
      ? CONSENT_TEXTS.disclaimer.full
      : CONSENT_TEXTS.disclaimer.short;

    return React.createElement('div', {
      className: 'px-4 py-2 text-center',
      style: { backgroundColor: '#f4f4f5' }
    },
      React.createElement('p', {
        className: 'text-xs',
        style: { color: '#71717a' }
      }, '‚ö†Ô∏è ', text)
    );
  }

  /**
   * –ú–∏–Ω–∏-–±–µ–π–¥–∂ "–ù–µ –º–µ–¥–∏—Ü–∏–Ω–∞"
   */
  function NotMedicineBadge() {
    return React.createElement('span', {
      className: 'inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full',
      style: { backgroundColor: '#fef3c7', color: '#b45309' }
    }, '‚ö†Ô∏è –ù–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —É—Å–ª—É–≥–æ–π');
  }

  // =====================================================
  // Hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≥–ª–∞—Å–∏–π
  // =====================================================

  function useConsentsRequired(clientId) {
    const [needsConsent, setNeedsConsent] = useState(false);
    const [checking, setChecking] = useState(true);

    useEffect(() => {
      if (!clientId) {
        setChecking(false);
        return;
      }

      // –ë—ã—Å—Ç—Ä–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      if (consentsAPI.hasLocalConsent(clientId)) {
        setNeedsConsent(false);
        setChecking(false);
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      consentsAPI.checkRequired(clientId).then(result => {
        setNeedsConsent(!result.valid);
        setChecking(false);
      });
    }, [clientId]);

    return { needsConsent, checking };
  }

  // =====================================================
  // –≠–∫—Å–ø–æ—Ä—Ç
  // =====================================================

  HEYS.Consents = {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    TYPES: CONSENT_TYPES,
    REQUIRED: REQUIRED_CONSENTS,
    VERSIONS: CURRENT_VERSIONS,
    TEXTS: CONSENT_TEXTS,

    // API
    api: consentsAPI,

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    ConsentScreen,
    ConsentCheckbox,
    DisclaimerBanner,
    NotMedicineBadge,
    FullTextModal,

    // Hook
    useConsentsRequired
  };

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_subscriptions_v1.js ===== */
// heys_subscriptions_v1.js ‚Äî –ú–æ–¥—É–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ø–ª–∞—Ç–µ–∂–µ–π
// –í–µ—Ä—Å–∏—è: 1.1.0 | –î–∞—Ç–∞: 2025-12-22
// 
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ–¥–ø–∏—Å–∫–∏, —Ç—Ä–∏–∞–ª–æ–º, –æ–ø–ª–∞—Ç–æ–π —á–µ—Ä–µ–∑ –ÆKassa
// –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å YandexAPI.createPayment / getPaymentStatus

(function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};
  const DEV = global.DEV || {};
  const devLog = typeof DEV.log === 'function' ? DEV.log.bind(DEV) : function () { };
  const devWarn = typeof DEV.warn === 'function' ? DEV.warn.bind(DEV) : function () { };
  const trackError = (error, context) => {
    if (!HEYS?.analytics?.trackError) return;
    try {
      const err = error instanceof Error ? error : new Error(String(error || 'Subscriptions error'));
      HEYS.analytics.trackError(err, context);
    } catch (_) { }
  };

  // =====================================================
  // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
  // =====================================================

  const CONFIG = {
    TRIAL_DAYS: 7,
    PAYMENT_CHECK_INTERVAL: 3000, // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    PAYMENT_CHECK_MAX_ATTEMPTS: 60, // –ú–∞–∫—Å–∏–º—É–º 3 –º–∏–Ω—É—Ç—ã –æ–∂–∏–¥–∞–Ω–∏—è

    PLANS: {
      base: {
        id: 'base',
        name: 'Base',
        price: 1990,
        currency: 'RUB',
        features: [
          '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + —É–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏',
          '1 —á–µ–∫-–∏–Ω –≤ –Ω–µ–¥–µ–ª—é (async)'
        ]
      },
      pro: {
        id: 'pro',
        name: 'Pro',
        price: 12990,
        currency: 'RUB',
        recommended: true,
        features: [
          '–í—Å—ë –∏–∑ Base',
          '–í–µ–¥–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ –∫—É—Ä–∞—Ç–æ—Ä–æ–º',
          '–ß–∞—Ç —Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º',
          '–°–æ–∑–≤–æ–Ω —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é'
        ]
      },
      proplus: {
        id: 'proplus',
        name: 'Pro+',
        price: 19990,
        currency: 'RUB',
        features: [
          '–í—Å—ë –∏–∑ Pro',
          '7/7 –±–µ–∑ –¥–µ–∂—É—Ä–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞',
          '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π SLA',
          'Mid-week —á–µ–∫-–∏–Ω'
        ]
      }
    },

    STATUSES: {
      trial: { id: 'trial', name: '–¢—Ä–∏–∞–ª', color: '#3b82f6', canEdit: true },
      active: { id: 'active', name: '–ê–∫—Ç–∏–≤–Ω–∞', color: '#22c55e', canEdit: true },
      read_only: { id: 'read_only', name: '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä', color: '#f59e0b', canEdit: false },
      canceled: { id: 'canceled', name: '–û—Ç–º–µ–Ω–µ–Ω–∞', color: '#6b7280', canEdit: false }
    }
  };

  // =====================================================
  // –£–¢–ò–õ–ò–¢–´
  // =====================================================

  function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU').format(price) + ' ‚ÇΩ';
  }

  function formatDate(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
  }

  function daysUntil(date) {
    if (!date) return 0;
    const now = new Date();
    const target = new Date(date);
    const diff = target - now;
    return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
  }

  // =====================================================
  // –ü–†–û–í–ï–†–ö–ê PENDING –ü–õ–ê–¢–ï–ñ–ê
  // =====================================================

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pending –ø–ª–∞—Ç—ë–∂ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —Å –ÆKassa
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   * @returns {Promise<{success: boolean, plan?: string}>}
   */
  async function checkPendingPayment() {
    try {
      // –ß–∏—Ç–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π pending payment
      const pendingRaw = localStorage.getItem('heys_pending_payment');
      if (!pendingRaw) return { success: false };

      const pending = JSON.parse(pendingRaw);
      const { paymentId, clientId, plan, createdAt } = pending;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Å—Ç–∞—Ä—ã–π –ª–∏ —ç—Ç–æ –ø–ª–∞—Ç—ë–∂ (>1 —á–∞—Å)
      if (Date.now() - createdAt > 60 * 60 * 1000) {
        devLog('[Subscriptions] Pending payment expired');
        localStorage.removeItem('heys_pending_payment');
        return { success: false };
      }

      devLog('[Subscriptions] Checking pending payment:', paymentId);

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
      const YandexAPI = window.HEYS?.YandexAPI;
      if (!YandexAPI?.getPaymentStatus) {
        devWarn('[Subscriptions] YandexAPI.getPaymentStatus –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        return { success: false };
      }

      const { data, error } = await YandexAPI.getPaymentStatus(paymentId, clientId);

      if (error) {
        devWarn('[Subscriptions] getPaymentStatus error:', error);
        trackError(error, { scope: 'Subscriptions', action: 'getPaymentStatus' });
        return { success: false, error: error.message };
      }

      devLog('[Subscriptions] Payment status:', data);

      // –ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω?
      if (data.paid && data.status === 'succeeded') {
        // –û—á–∏—â–∞–µ–º pending –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
        localStorage.removeItem('heys_pending_payment');
        return { success: true, plan, paymentId };
      }

      // –ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞?
      if (data.status === 'canceled' || data.status === 'failed') {
        localStorage.removeItem('heys_pending_payment');
        return { success: false, status: data.status };
      }

      // –ü–ª–∞—Ç—ë–∂ –µ—â—ë –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (pending/waiting_for_capture)
      return { success: false, pending: true, status: data.status };

    } catch (err) {
      devWarn('[Subscriptions] checkPendingPayment error:', err);
      trackError(err, { scope: 'Subscriptions', action: 'checkPendingPayment' });
      return { success: false, error: err.message };
    }
  }

  /**
   * –û–∂–∏–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (polling)
   * @param {Function} onSuccess - Callback –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
   * @param {Function} onError - Callback –ø—Ä–∏ –æ—à–∏–±–∫–µ
   */
  async function waitForPayment(onSuccess, onError) {
    let attempts = 0;

    const check = async () => {
      attempts++;

      if (attempts > CONFIG.PAYMENT_CHECK_MAX_ATTEMPTS) {
        devLog('[Subscriptions] Payment check timeout');
        onError?.({ message: '–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã' });
        return;
      }

      const result = await checkPendingPayment();

      if (result.success) {
        devLog('[Subscriptions] Payment succeeded!', result);
        onSuccess?.(result);
        return;
      }

      if (result.pending) {
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å
        setTimeout(check, CONFIG.PAYMENT_CHECK_INTERVAL);
        return;
      }

      // –ü–ª–∞—Ç—ë–∂ –Ω–µ —É–¥–∞–ª—Å—è –∏–ª–∏ –Ω–µ—Ç pending
      if (result.error || result.status === 'canceled' || result.status === 'failed') {
        onError?.(result);
        return;
      }

      // –ù–µ—Ç pending payment ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    };

    check();
  }

  // =====================================================
  // API –ú–ï–¢–û–î–´
  // =====================================================

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
   */
  async function getStatus(clientId) {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI (session-based)
      if (HEYS.YandexAPI) {
        const sessionToken = HEYS.auth?.getSessionToken?.();
        if (!sessionToken) {
          throw new Error('No session token available');
        }

        const result = await HEYS.YandexAPI.rpc('get_subscription_status_by_session', {
          p_session_token: sessionToken
        });

        if (result.error) throw new Error(result.error.message || result.error);
        // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ: { data: { get_subscription_status_by_session: {...} } }
        const statusData = result.data?.get_subscription_status_by_session || result.data || result;
        devLog('[Subscriptions] getStatus result:', statusData);
        return statusData;
      }

      // Fallback: —á–∏—Ç–∞–µ–º –∏–∑ localStorage
      const profile = HEYS.utils?.lsGet?.('heys_profile') || {};
      return {
        success: true,
        status: profile.subscription_status || 'trial',
        plan: profile.subscription_plan || null,
        is_trial: true,
        days_left: 7,
        can_edit: true
      };
    } catch (err) {
      devWarn('[Subscriptions] getStatus error:', err);
      trackError(err, { scope: 'Subscriptions', action: 'getStatus' });
      return { success: false, error: err.message, can_edit: true };
    }
  }

  /**
   * –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∏–∞–ª (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø—Ä–∏—ë–º–µ –ø–∏—â–∏)
   */
  async function startTrial(clientId) {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI
      if (HEYS.YandexAPI) {
        const result = await HEYS.YandexAPI.startTrial(clientId);
        if (result.error) throw new Error(result.error);
        devLog('[Subscriptions] Trial started:', result);
        return result;
      }

      // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
      const now = new Date();
      const trialEnd = new Date(now.getTime() + CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000);

      const profile = HEYS.utils?.lsGet?.('heys_profile') || {};
      profile.subscription_status = 'trial';
      profile.trial_started_at = now.toISOString();
      profile.trial_ends_at = trialEnd.toISOString();
      HEYS.utils?.lsSet?.('heys_profile', profile);

      return {
        success: true,
        trial_started_at: now.toISOString(),
        trial_ends_at: trialEnd.toISOString()
      };
    } catch (err) {
      devWarn('[Subscriptions] startTrial error:', err);
      trackError(err, { scope: 'Subscriptions', action: 'startTrial' });
      return { success: false, error: err.message };
    }
  }

  /**
   * –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (mock-–æ–ø–ª–∞—Ç–∞)
   */
  async function activateSubscription(clientId, plan, months = 1) {
    try {
      if (!CONFIG.PLANS[plan]) {
        throw new Error('Invalid plan: ' + plan);
      }

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI
      if (HEYS.YandexAPI) {
        const result = await HEYS.YandexAPI.activateSubscription(clientId, plan, months);
        if (result.error) throw new Error(result.error);
        devLog('[Subscriptions] Subscription activated:', result);
        return result;
      }

      // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
      const now = new Date();
      const expiresAt = new Date(now.getTime() + months * 30 * 24 * 60 * 60 * 1000);

      const profile = HEYS.utils?.lsGet?.('heys_profile') || {};
      profile.subscription_status = 'active';
      profile.subscription_plan = plan;
      profile.subscription_started_at = now.toISOString();
      profile.subscription_expires_at = expiresAt.toISOString();
      HEYS.utils?.lsSet?.('heys_profile', profile);

      return {
        success: true,
        plan: plan,
        expires_at: expiresAt.toISOString()
      };
    } catch (err) {
      devWarn('[Subscriptions] activateSubscription error:', err);
      trackError(err, { scope: 'Subscriptions', action: 'activateSubscription' });
      return { success: false, error: err.message };
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
   */
  async function canEdit(clientId) {
    const status = await getStatus(clientId);
    return status.can_edit === true;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–∞—Ä–∏—Ñ–æ–≤
   */
  function getPlans() {
    return Object.values(CONFIG.PLANS);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–∏—Ñ–µ
   */
  function getPlan(planId) {
    return CONFIG.PLANS[planId] || null;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ
   */
  function getStatusInfo(statusId) {
    return CONFIG.STATUSES[statusId] || CONFIG.STATUSES.trial;
  }

  // =====================================================
  // REACT –ö–û–ú–ü–û–ù–ï–ù–¢–´
  // =====================================================

  const { createElement: h, useState, useEffect } = window.React || {};

  /**
   * –ë–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   */
  function SubscriptionBadge({ status, plan, daysLeft, onClick }) {
    const statusInfo = getStatusInfo(status);
    const planInfo = plan ? getPlan(plan) : null;

    const badgeStyle = {
      display: 'inline-flex',
      alignItems: 'center',
      gap: '6px',
      padding: '4px 10px',
      borderRadius: '12px',
      fontSize: '13px',
      fontWeight: '500',
      backgroundColor: statusInfo.color + '20',
      color: statusInfo.color,
      cursor: onClick ? 'pointer' : 'default'
    };

    let label = statusInfo.name;
    if (status === 'trial' && daysLeft > 0) {
      label = `–¢—Ä–∏–∞–ª: ${daysLeft} –¥–Ω.`;
    } else if (status === 'active' && planInfo) {
      label = planInfo.name;
    }

    return h('span', { style: badgeStyle, onClick }, label);
  }

  /**
   * –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–∞—Ä–∏—Ñ–∞
   */
  function PlanCard({ plan, isSelected, onSelect }) {
    const planInfo = getPlan(plan);
    if (!planInfo) return null;

    const cardStyle = {
      border: isSelected ? '2px solid #22c55e' : '1px solid #e5e7eb',
      borderRadius: '12px',
      padding: '16px',
      marginBottom: '12px',
      backgroundColor: isSelected ? '#f0fdf4' : '#fff',
      cursor: 'pointer',
      transition: 'all 0.2s'
    };

    const headerStyle = {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '8px'
    };

    const nameStyle = {
      fontSize: '18px',
      fontWeight: '600',
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    };

    const priceStyle = {
      fontSize: '20px',
      fontWeight: '700',
      color: '#22c55e'
    };

    const featureStyle = {
      fontSize: '14px',
      color: '#6b7280',
      marginLeft: '16px',
      marginBottom: '4px'
    };

    return h('div', { style: cardStyle, onClick: () => onSelect(plan) },
      h('div', { style: headerStyle },
        h('div', { style: nameStyle },
          planInfo.name,
          planInfo.recommended && h('span', {
            style: {
              fontSize: '11px',
              backgroundColor: '#fef3c7',
              color: '#d97706',
              padding: '2px 8px',
              borderRadius: '10px'
            }
          }, '‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º')
        ),
        h('div', { style: priceStyle }, formatPrice(planInfo.price) + '/–º–µ—Å')
      ),
      h('div', null,
        planInfo.features.map((f, i) =>
          h('div', { key: i, style: featureStyle }, '‚Ä¢ ' + f)
        )
      )
    );
  }

  /**
   * –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
   */
  function PaymentScreen({ clientId, onSuccess, onCancel }) {
    const [selectedPlan, setSelectedPlan] = useState('pro');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const handlePayment = async () => {
      setLoading(true);
      setError(null);

      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º YandexAPI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ÆKassa
        const YandexAPI = window.HEYS?.YandexAPI;

        if (!YandexAPI?.createPayment) {
          // Fallback –Ω–∞ –ø—Ä—è–º—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ –ø–ª–∞—Ç—ë–∂–∫–∏)
          devWarn('[Subscriptions] YandexAPI.createPayment –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é');
          const result = await activateSubscription(clientId, selectedPlan, 1);

          if (result.success) {
            onSuccess?.(result);
          } else {
            setError(result.error || '–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã');
          }
          return;
        }

        // –°–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ –ÆKassa
        const returnUrl = window.location.origin + '/payment-result?clientId=' + clientId;
        const { data, error: apiError } = await YandexAPI.createPayment(clientId, selectedPlan, returnUrl);

        if (apiError || !data) {
          setError(apiError?.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º paymentId –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
        try {
          localStorage.setItem('heys_pending_payment', JSON.stringify({
            paymentId: data.paymentId,
            clientId,
            plan: selectedPlan,
            createdAt: Date.now()
          }));
        } catch (e) {
          devWarn('[Subscriptions] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å pending payment:', e);
          trackError(e, { scope: 'Subscriptions', action: 'savePendingPayment' });
        }

        // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa
        if (data.confirmationUrl) {
          window.location.href = data.confirmationUrl;
        } else {
          // –ï—Å–ª–∏ confirmationUrl –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç –ø–ª–∞—Ç—ë–∂ —É–∂–µ —É—Å–ø–µ—à–µ–Ω (—Ä–µ–¥–∫–∏–π –∫–µ–π—Å)
          onSuccess?.({ plan: selectedPlan });
        }

      } catch (err) {
        devWarn('[Subscriptions] handlePayment error:', err);
        trackError(err, { scope: 'Subscriptions', action: 'handlePayment' });
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    const containerStyle = {
      padding: '20px',
      maxWidth: '500px',
      margin: '0 auto'
    };

    const titleStyle = {
      fontSize: '24px',
      fontWeight: '700',
      textAlign: 'center',
      marginBottom: '24px'
    };

    const buttonStyle = {
      width: '100%',
      padding: '14px',
      fontSize: '16px',
      fontWeight: '600',
      color: '#fff',
      backgroundColor: loading ? '#9ca3af' : '#22c55e',
      border: 'none',
      borderRadius: '12px',
      cursor: loading ? 'not-allowed' : 'pointer',
      marginTop: '16px'
    };

    const cancelStyle = {
      width: '100%',
      padding: '12px',
      fontSize: '14px',
      color: '#6b7280',
      backgroundColor: 'transparent',
      border: 'none',
      cursor: 'pointer',
      marginTop: '8px'
    };

    const plans = getPlans();
    const selectedInfo = getPlan(selectedPlan);

    return h('div', { style: containerStyle },
      h('h1', { style: titleStyle }, 'üí≥ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ'),

      plans.map(p =>
        h(PlanCard, {
          key: p.id,
          plan: p.id,
          isSelected: selectedPlan === p.id,
          onSelect: setSelectedPlan
        })
      ),

      error && h('div', {
        style: {
          color: '#ef4444',
          textAlign: 'center',
          marginTop: '12px',
          padding: '8px',
          backgroundColor: '#fef2f2',
          borderRadius: '8px'
        }
      }, error),

      h('button', {
        style: buttonStyle,
        onClick: handlePayment,
        disabled: loading
      },
        loading ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : `–û–ø–ª–∞—Ç–∏—Ç—å ${formatPrice(selectedInfo?.price || 0)}`
      ),

      onCancel && h('button', { style: cancelStyle, onClick: onCancel }, '–û—Ç–º–µ–Ω–∞')
    );
  }

  /**
   * –≠–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
   */
  function PaymentSuccessScreen({ plan, expiresAt, onContinue }) {
    const planInfo = getPlan(plan);

    const containerStyle = {
      padding: '40px 20px',
      textAlign: 'center',
      maxWidth: '400px',
      margin: '0 auto'
    };

    const iconStyle = {
      fontSize: '64px',
      marginBottom: '16px'
    };

    const titleStyle = {
      fontSize: '24px',
      fontWeight: '700',
      marginBottom: '8px'
    };

    const subtitleStyle = {
      fontSize: '16px',
      color: '#6b7280',
      marginBottom: '24px'
    };

    const infoStyle = {
      backgroundColor: '#f0fdf4',
      borderRadius: '12px',
      padding: '16px',
      marginBottom: '24px'
    };

    const buttonStyle = {
      width: '100%',
      padding: '14px',
      fontSize: '16px',
      fontWeight: '600',
      color: '#fff',
      backgroundColor: '#22c55e',
      border: 'none',
      borderRadius: '12px',
      cursor: 'pointer'
    };

    return h('div', { style: containerStyle },
      h('div', { style: iconStyle }, '‚úÖ'),
      h('h1', { style: titleStyle }, '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!'),
      h('p', { style: subtitleStyle }, `–¢–∞—Ä–∏—Ñ ${planInfo?.name || plan}`),

      h('div', { style: infoStyle },
        h('div', { style: { marginBottom: '8px' } },
          'üìÖ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: ', h('strong', null, formatDate(expiresAt))
        ),
        h('div', null,
          'üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ', h('strong', null, formatPrice(planInfo?.price || 0) + '/–º–µ—Å')
        )
      ),

      h('button', { style: buttonStyle, onClick: onContinue }, '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å')
    );
  }

  /**
   * –ë–∞–Ω–Ω–µ—Ä "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞" –¥–ª—è read_only —Ä–µ–∂–∏–º–∞
   */
  function PaywallBanner({ onUpgrade }) {
    const bannerStyle = {
      backgroundColor: '#fef3c7',
      borderRadius: '12px',
      padding: '16px',
      margin: '16px',
      textAlign: 'center'
    };

    const titleStyle = {
      fontSize: '16px',
      fontWeight: '600',
      color: '#d97706',
      marginBottom: '8px'
    };

    const textStyle = {
      fontSize: '14px',
      color: '#92400e',
      marginBottom: '12px'
    };

    const buttonStyle = {
      padding: '10px 20px',
      fontSize: '14px',
      fontWeight: '600',
      color: '#fff',
      backgroundColor: '#d97706',
      border: 'none',
      borderRadius: '8px',
      cursor: 'pointer'
    };

    return h('div', { style: bannerStyle },
      h('div', { style: titleStyle }, '‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞'),
      h('p', { style: textStyle },
        '–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'
      ),
      h('button', { style: buttonStyle, onClick: onUpgrade }, '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É')
    );
  }

  /**
   * –°–µ–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
   */
  function SubscriptionSection({ clientId }) {
    const [status, setStatus] = useState(null);
    const [loading, setLoading] = useState(true);
    const [showPayment, setShowPayment] = useState(false);

    useEffect(() => {
      loadStatus();
    }, [clientId]);

    const loadStatus = async () => {
      setLoading(true);
      const result = await getStatus(clientId);
      setStatus(result);
      setLoading(false);
    };

    const handleSuccess = (result) => {
      setShowPayment(false);
      loadStatus();
    };

    if (loading) {
      return h('div', { style: { padding: '16px', textAlign: 'center' } }, '–ó–∞–≥—Ä—É–∑–∫–∞...');
    }

    if (showPayment) {
      return h(PaymentScreen, {
        clientId,
        onSuccess: handleSuccess,
        onCancel: () => setShowPayment(false)
      });
    }

    const sectionStyle = {
      backgroundColor: '#f9fafb',
      borderRadius: '12px',
      padding: '16px',
      margin: '16px 0'
    };

    const headerStyle = {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '12px'
    };

    const titleStyle = {
      fontSize: '16px',
      fontWeight: '600'
    };

    const infoStyle = {
      fontSize: '14px',
      color: '#6b7280'
    };

    const buttonStyle = {
      padding: '8px 16px',
      fontSize: '14px',
      fontWeight: '500',
      color: '#22c55e',
      backgroundColor: '#f0fdf4',
      border: '1px solid #22c55e',
      borderRadius: '8px',
      cursor: 'pointer',
      marginTop: '12px'
    };

    const statusInfo = getStatusInfo(status?.status);
    const planInfo = status?.plan ? getPlan(status.plan) : null;

    return h('div', { style: sectionStyle },
      h('div', { style: headerStyle },
        h('div', { style: titleStyle }, 'üìã –ü–æ–¥–ø–∏—Å–∫–∞'),
        h(SubscriptionBadge, {
          status: status?.status,
          plan: status?.plan,
          daysLeft: status?.days_left
        })
      ),

      status?.is_trial && h('div', { style: infoStyle },
        `–¢—Ä–∏–∞–ª –¥–æ ${formatDate(status.trial_ends_at)}`,
        status.days_left > 0 && ` (–æ—Å—Ç–∞–ª–æ—Å—å ${status.days_left} –¥–Ω.)`
      ),

      status?.status === 'active' && h('div', { style: infoStyle },
        planInfo && `–¢–∞—Ä–∏—Ñ: ${planInfo.name}`,
        h('br'),
        `–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${formatDate(status.subscription_expires_at)}`
      ),

      (status?.status === 'trial' || status?.status === 'read_only') &&
      h('button', { style: buttonStyle, onClick: () => setShowPayment(true) },
        status?.status === 'trial' ? '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É' : '–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
      )
    );
  }

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–ø–ª–∞—Ç—ã
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ read-only —Ä–µ–∂–∏–º–µ
   */
  function showPaymentRequired() {
    // –ï—Å–ª–∏ –µ—Å—Ç—å StepModal ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é –º–æ–¥–∞–ª–∫—É
    if (HEYS.StepModal && HEYS.StepModal.show) {
      HEYS.StepModal.show({
        steps: ['payment_required'],
        showProgress: false,
        showGreeting: false
      });
      return;
    }

    // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º PaywallBanner –≤ –∫–æ—Ä–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π event –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç App
    window.dispatchEvent(new CustomEvent('heys:show-paywall', {
      detail: { source: 'edit-blocked', message: '–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞' }
    }));
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º—ã–π label —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è subtitle –≤ –ø—Ä–æ—Ñ–∏–ª–µ
   * –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  function getStatusLabel() {
    try {
      const clientId = HEYS.currentClientId || localStorage.getItem('heys_client_current');
      if (!clientId) return '–¢–∞—Ä–∏—Ñ –∏ –æ–ø–ª–∞—Ç–∞';

      const profile = HEYS.utils?.lsGet?.('heys_profile') || {};
      const status = profile.subscription_status || 'trial';
      const plan = profile.subscription_plan;
      const trialEnds = profile.trial_ends_at;
      const subExpires = profile.subscription_expires_at;

      const statusInfo = getStatusInfo(status);

      if (status === 'trial' && trialEnds) {
        const days = daysUntil(trialEnds);
        return `–¢—Ä–∏–∞–ª: ${days} –¥–Ω. –æ—Å—Ç–∞–ª–æ—Å—å`;
      }

      if (status === 'active' && plan) {
        const planInfo = getPlan(plan);
        if (planInfo) {
          const days = subExpires ? daysUntil(subExpires) : 0;
          return `${planInfo.name} ‚Ä¢ ${days} –¥–Ω.`;
        }
      }

      return statusInfo.name;
    } catch (e) {
      return '–¢–∞—Ä–∏—Ñ –∏ –æ–ø–ª–∞—Ç–∞';
    }
  }

  // =====================================================
  // –≠–ö–°–ü–û–†–¢
  // =====================================================

  HEYS.Subscriptions = {
    // Config
    CONFIG,
    getPlans,
    getPlan,
    getStatusInfo,

    // Utils
    formatPrice,
    formatDate,
    daysUntil,
    getStatusLabel,

    // API
    getStatus,
    startTrial,
    activateSubscription,
    canEdit,
    showPaymentRequired,

    // Payment (–ÆKassa)
    checkPendingPayment,
    waitForPayment,

    // Components
    SubscriptionBadge,
    PlanCard,
    PaymentScreen,
    PaymentSuccessScreen,
    PaywallBanner,
    SubscriptionSection
  };

  // =====================================================
  // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –®–ê–ì–ê –¥–ª—è StepModal
  // =====================================================

  // –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (StepModal –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ–∑–∂–µ)
  function registerPaymentRequiredStep() {
    if (!HEYS.StepModal || !HEYS.StepModal.registerStep) return false;

    const h = React.createElement;

    HEYS.StepModal.registerStep('payment_required', {
      title: 'üîí –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞',
      icon: 'üí≥',
      canSkip: false,
      hideBackButton: true,

      render: ({ onComplete }) => {
        const [selectedPlan, setSelectedPlan] = React.useState('pro');
        const [showPayment, setShowPayment] = React.useState(false);

        if (showPayment) {
          return h(PaymentScreen, {
            plan: selectedPlan,
            onSuccess: onComplete,
            onCancel: () => setShowPayment(false)
          });
        }

        const containerStyle = {
          padding: '20px',
          textAlign: 'center'
        };

        const messageStyle = {
          fontSize: '16px',
          color: '#6b7280',
          marginBottom: '24px',
          lineHeight: '1.5'
        };

        const plansStyle = {
          marginBottom: '24px'
        };

        const buttonStyle = {
          width: '100%',
          padding: '14px 24px',
          backgroundColor: '#22c55e',
          color: '#fff',
          border: 'none',
          borderRadius: '12px',
          fontSize: '16px',
          fontWeight: '600',
          cursor: 'pointer'
        };

        return h('div', { style: containerStyle },
          h('div', { style: messageStyle },
            '–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ',
            '–Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.'
          ),
          h('div', { style: plansStyle },
            h(PlanCard, { plan: 'base', isSelected: selectedPlan === 'base', onSelect: setSelectedPlan }),
            h(PlanCard, { plan: 'pro', isSelected: selectedPlan === 'pro', onSelect: setSelectedPlan }),
            h(PlanCard, { plan: 'pro_plus', isSelected: selectedPlan === 'pro_plus', onSelect: setSelectedPlan })
          ),
          h('button', { style: buttonStyle, onClick: () => setShowPayment(true) },
            '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
          )
        );
      },

      validate: () => true, // –í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å

      onSave: () => {
        // –ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —ç—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —à–∞–≥
      }
    });

    return true;
  }

  // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
  if (!registerPaymentRequiredStep()) {
    // –ï—Å–ª–∏ StepModal –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
    window.addEventListener('heys:step-modal-ready', registerPaymentRequiredStep, { once: true });
  }

  devLog('[HEYS] Subscriptions module loaded v1.0.0');

})(typeof window !== 'undefined' ? window : global);


/* ===== heys_status_v1.js ===== */
/**
 * heys_status_v1.js ‚Äî –°—Ç–∞—Ç—É—Å 0-100
 * 
 * –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∑–¥–æ—Ä–æ–≤—å—è –¥–Ω—è.
 * 
 * –§–∏–ª–æ—Å–æ—Ñ–∏—è:
 * - –ù–ï —Ç–æ–∫—Å–∏—á–Ω—ã–π ‚Äî –Ω–µ —Ä—É–≥–∞–µ–º, –∞ –æ–±—ä—è—Å–Ω—è–µ–º
 * - –ù–ï —Å–ª–æ–∂–Ω—ã–π ‚Äî —Ç–æ–ø-2 –ø—Ä–∏—á–∏–Ω—ã + 1-2 —à–∞–≥–∞
 * - –ù–ï —Å–∫–∞—á–µ—Ç ‚Äî —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
 * 
 * –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
 * - InsightsTab ‚Äî –≥–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–≤–µ—Ä—Ö—É
 * - Widgets ‚Äî –≤–∏–¥–∂–µ—Ç 'status'
 * 
 * Version: 1.0.0
 * Created: 2025-12-19
 */
(function(global) {
  'use strict';
  
  const HEYS = global.HEYS = global.HEYS || {};
  const h = React.createElement;
  
  // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
  
  /**
   * –§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å (–≤–µ—Å–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–æ 100)
   * –ü—Ä–æ—Å—Ç–∞—è Rule-based –º–æ–¥–µ–ª—å
   */
  const FACTORS = {
    // –ü–∏—Ç–∞–Ω–∏–µ ‚Äî 35%
    kcal: { weight: 15, category: 'nutrition', label: '–ö–∞–ª–æ—Ä–∏–∏', icon: 'üî•' },
    protein: { weight: 10, category: 'nutrition', label: '–ë–µ–ª–æ–∫', icon: 'ü•©' },
    timing: { weight: 10, category: 'nutrition', label: '–¢–∞–π–º–∏–Ω–≥ –µ–¥—ã', icon: '‚è∞' },
    
    // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî 25%
    steps: { weight: 10, category: 'activity', label: '–®–∞–≥–∏', icon: 'üëü' },
    training: { weight: 10, category: 'activity', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', icon: 'üí™' },
    household: { weight: 5, category: 'activity', label: '–ë—ã—Ç–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', icon: 'üè†' },
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî 25%
    sleep: { weight: 15, category: 'recovery', label: '–°–æ–Ω', icon: 'üò¥' },
    stress: { weight: 10, category: 'recovery', label: '–°—Ç—Ä–µ—Å—Å', icon: 'üò∞' },
    
    // –í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å ‚Äî 15%
    water: { weight: 15, category: 'hydration', label: '–í–æ–¥–∞', icon: 'üíß' }
  };
  
  /**
   * –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
   */
  const CATEGORIES = {
    nutrition: { label: '–ü–∏—Ç–∞–Ω–∏–µ', icon: 'üçé', color: '#f97316' },
    activity: { label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', icon: '‚ö°', color: '#3b82f6' },
    recovery: { label: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', icon: 'üåô', color: '#8b5cf6' },
    hydration: { label: '–ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è', icon: 'üíß', color: '#06b6d4' }
  };
  
  /**
   * –°—Ç–∞—Ç—É—Å—ã –ø–æ –±–∞–ª–ª–∞–º
   */
  const STATUS_LEVELS = {
    excellent: { min: 85, label: '–û—Ç–ª–∏—á–Ω–æ!', emoji: 'üåü', color: '#10b981', message: '–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!' },
    good: { min: 70, label: '–•–æ—Ä–æ—à–æ', emoji: '‚úÖ', color: '#22c55e', message: '–ù–µ–ø–ª–æ—Ö–æ!' },
    okay: { min: 50, label: '–ù–æ—Ä–º–∞–ª—å–Ω–æ', emoji: 'üëå', color: '#eab308', message: '–ï—Å—Ç—å –Ω–∞–¥ —á–µ–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å' },
    low: { min: 30, label: '–°–ª–∞–±–æ–≤–∞—Ç–æ', emoji: 'üòï', color: '#f97316', message: '–î–∞–≤–∞–π –∏—Å–ø—Ä–∞–≤–∏–º' },
    critical: { min: 0, label: '–í–Ω–∏–º–∞–Ω–∏–µ', emoji: '‚ö†Ô∏è', color: '#ef4444', message: '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å' }
  };
  
  /**
   * –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ñ–∞–∫—Ç–æ—Ä–∞–º
   */
  const RECOMMENDATIONS = {
    kcal_low: { text: '–î–æ–±–∞–≤—å –ø—Ä–∏—ë–º –ø–∏—â–∏', icon: 'üçΩÔ∏è', priority: 1 },
    kcal_high: { text: '–°–ª–µ–¥–∏ –∑–∞ –ø–æ—Ä—Ü–∏—è–º–∏', icon: 'üìè', priority: 2 },
    protein_low: { text: '–î–æ–±–∞–≤—å –±–µ–ª–æ–∫', icon: 'ü•©', priority: 1 },
    timing_bad: { text: '–ù–µ –µ—à—å –ø–æ—Å–ª–µ 21:00', icon: '‚è∞', priority: 2 },
    steps_low: { text: '–ü—Ä–æ–≥—É–ª—è–π—Å—è 15 –º–∏–Ω', icon: 'üö∂', priority: 1 },
    training_none: { text: '–î–æ–±–∞–≤—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', icon: 'üèÉ', priority: 3 },
    sleep_low: { text: '–õ—è–≥ –ø–æ—Ä–∞–Ω—å—à–µ', icon: 'üõèÔ∏è', priority: 1 },
    stress_high: { text: '–°–¥–µ–ª–∞–π –ø–∞—É–∑—É', icon: 'üßò', priority: 1 },
    water_low: { text: '–í—ã–ø–µ–π –≤–æ–¥—ã', icon: 'üíß', priority: 1 }
  };
  
  // === –†–ê–°–ß–Å–¢ –°–¢–ê–¢–£–°–ê ===
  
  /**
   * –í—ã—á–∏—Å–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É —Ñ–∞–∫—Ç–æ—Ä–∞ (0-100)
   */
  function scoreFactor(factorId, dayData, profile, dayTot, normAbs, waveData, waterGoal) {
    switch (factorId) {
      case 'kcal': {
        const target = normAbs?.kcal || 2000;
        const eaten = dayTot?.kcal || 0;
        const ratio = eaten / target;
        // –ò–¥–µ–∞–ª—å–Ω–æ: 0.85-1.10
        if (ratio >= 0.85 && ratio <= 1.10) return 100;
        if (ratio >= 0.75 && ratio <= 1.20) return 80;
        if (ratio >= 0.60 && ratio <= 1.30) return 60;
        if (ratio >= 0.50 && ratio <= 1.40) return 40;
        return 20;
      }
      
      case 'protein': {
        const target = normAbs?.prot || 80;
        const eaten = dayTot?.prot || 0;
        const ratio = eaten / target;
        if (ratio >= 0.90) return 100;
        if (ratio >= 0.75) return 80;
        if (ratio >= 0.50) return 50;
        return 20;
      }
      
      case 'timing': {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏
        const meals = dayData?.meals || [];
        if (meals.length === 0) return 50; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
        
        const lastMeal = meals[meals.length - 1];
        if (!lastMeal?.time) return 50;
        
        const [h] = lastMeal.time.split(':').map(Number);
        if (h <= 20) return 100; // –î–æ 20:00 ‚Äî –æ—Ç–ª–∏—á–Ω–æ
        if (h <= 21) return 80;  // –î–æ 21:00 ‚Äî —Ö–æ—Ä–æ—à–æ
        if (h <= 22) return 50;  // –î–æ 22:00 ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        return 20; // –ü–æ—Å–ª–µ 22:00 ‚Äî –ø–ª–æ—Ö–æ
      }
      
      case 'steps': {
        const steps = dayData?.steps || 0;
        const goal = profile?.stepsGoal || 10000;
        const ratio = steps / goal;
        if (ratio >= 1.0) return 100;
        if (ratio >= 0.8) return 85;
        if (ratio >= 0.5) return 60;
        if (ratio >= 0.3) return 40;
        return 20;
      }
      
      case 'training': {
        const trainings = dayData?.trainings || [];
        if (trainings.length === 0) return 60; // –ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ (–Ω–µ —à—Ç—Ä–∞—Ñ—É–µ–º —Å–∏–ª—å–Ω–æ)
        
        // –°—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–µ –º–∏–Ω—É—Ç—ã
        const totalMinutes = trainings.reduce((sum, t) => {
          const zones = t.z || [0, 0, 0, 0];
          return sum + zones.reduce((a, b) => a + b, 0);
        }, 0);
        
        if (totalMinutes >= 45) return 100;
        if (totalMinutes >= 30) return 85;
        if (totalMinutes >= 15) return 70;
        return 60;
      }
      
      case 'household': {
        const min = dayData?.householdMin || 0;
        if (min >= 60) return 100;
        if (min >= 30) return 80;
        if (min >= 15) return 60;
        return 40;
      }
      
      case 'sleep': {
        const hours = dayData?.sleepHours || 0;
        const norm = profile?.sleepHours || 8;
        if (hours === 0) return 50; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
        
        const ratio = hours / norm;
        if (ratio >= 0.95 && ratio <= 1.15) return 100;
        if (ratio >= 0.85) return 80;
        if (ratio >= 0.70) return 50;
        return 20;
      }
      
      case 'stress': {
        const stress = dayData?.stressAvg || 0;
        if (stress === 0) return 70; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        if (stress <= 3) return 100;
        if (stress <= 5) return 70;
        if (stress <= 7) return 40;
        return 20;
      }
      
      case 'water': {
        const drunk = dayData?.waterMl || 0;
        const goal = waterGoal || 2000;
        const ratio = drunk / goal;
        if (ratio >= 0.95) return 100;
        if (ratio >= 0.80) return 85;
        if (ratio >= 0.60) return 60;
        if (ratio >= 0.40) return 40;
        return 20;
      }
      
      default:
        return 50;
    }
  }
  
  /**
   * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –¥–ª—è —Ñ–∞–∫—Ç–æ—Ä–∞
   */
  function detectIssue(factorId, score, dayData, profile, dayTot, normAbs, waterGoal) {
    if (score >= 70) return null; // –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã
    
    switch (factorId) {
      case 'kcal': {
        const target = normAbs?.kcal || 2000;
        const eaten = dayTot?.kcal || 0;
        return eaten < target * 0.85 ? 'kcal_low' : 'kcal_high';
      }
      case 'protein':
        return 'protein_low';
      case 'timing':
        return 'timing_bad';
      case 'steps':
        return 'steps_low';
      case 'training':
        return 'training_none';
      case 'sleep':
        return 'sleep_low';
      case 'stress':
        return 'stress_high';
      case 'water':
        return 'water_low';
      default:
        return null;
    }
  }
  
  /**
   * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
   */
  function calculateStatus(opts = {}) {
    const {
      dayData = {},
      profile = {},
      dayTot = {},
      normAbs = {},
      waveData = null,
      waterGoal = 2000,
      previousStatus = null // –î–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
    } = opts;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –æ—Ü–µ–Ω–∫–∏ –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
    const factorScores = {};
    const issues = [];
    
    for (const [factorId, factor] of Object.entries(FACTORS)) {
      const score = scoreFactor(factorId, dayData, profile, dayTot, normAbs, waveData, waterGoal);
      factorScores[factorId] = score;
      
      // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–ª–µ–º—ã
      const issue = detectIssue(factorId, score, dayData, profile, dayTot, normAbs, waterGoal);
      if (issue && RECOMMENDATIONS[issue]) {
        issues.push({
          factorId,
          factor,
          score,
          issue,
          recommendation: RECOMMENDATIONS[issue]
        });
      }
    }
    
    // –°—á–∏—Ç–∞–µ–º –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π –±–∞–ª–ª
    let totalWeight = 0;
    let weightedSum = 0;
    
    for (const [factorId, factor] of Object.entries(FACTORS)) {
      const score = factorScores[factorId];
      weightedSum += score * factor.weight;
      totalWeight += factor.weight;
    }
    
    let rawScore = Math.round(weightedSum / totalWeight);
    
    // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å)
    let finalScore = rawScore;
    if (previousStatus !== null && typeof previousStatus === 'number') {
      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑: ¬±15 –±–∞–ª–ª–æ–≤
      const maxChange = 15;
      const diff = rawScore - previousStatus;
      if (Math.abs(diff) > maxChange) {
        finalScore = previousStatus + Math.sign(diff) * maxChange;
      }
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Å—Ç–∞—Ç—É—Å–∞
    let level = STATUS_LEVELS.critical;
    for (const [key, lvl] of Object.entries(STATUS_LEVELS)) {
      if (finalScore >= lvl.min) {
        level = { ...lvl, id: key };
        break;
      }
    }
    
    // –¢–æ–ø-2 –ø—Ä–æ–±–ª–µ–º—ã (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
    const topIssues = issues
      .sort((a, b) => a.recommendation.priority - b.recommendation.priority)
      .slice(0, 2);
    
    // –¢–æ–ø-2 —à–∞–≥–∞
    const topActions = topIssues.map(i => ({
      text: i.recommendation.text,
      icon: i.recommendation.icon,
      factor: i.factor.label
    }));
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –±–∞–ª–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categoryScores = {};
    for (const [catId, cat] of Object.entries(CATEGORIES)) {
      const catFactors = Object.entries(FACTORS).filter(([, f]) => f.category === catId);
      if (catFactors.length === 0) continue;
      
      let catSum = 0;
      let catWeight = 0;
      for (const [factorId, factor] of catFactors) {
        catSum += factorScores[factorId] * factor.weight;
        catWeight += factor.weight;
      }
      
      categoryScores[catId] = {
        score: Math.round(catSum / catWeight),
        ...cat
      };
    }
    
    return {
      score: finalScore,
      rawScore,
      level,
      factorScores,
      categoryScores,
      topIssues,
      topActions,
      timestamp: Date.now()
    };
  }
  
  // === UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ ===
  
  /**
   * StatusCard ‚Äî –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è InsightsTab
   */
  function StatusCard({ status, onDetailClick }) {
    if (!status) return null;
    
    const { score, level, topIssues = [], topActions = [], categoryScores = {} } = status;
    
    return h('div', { className: 'status-card' },
      // –ì–ª–∞–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
      h('div', { className: 'status-card__main' },
        h('div', { 
          className: 'status-card__score',
          style: { '--status-color': level.color }
        },
          h('span', { className: 'status-card__number' }, score),
          h('span', { className: 'status-card__max' }, '/100')
        ),
        h('div', { className: 'status-card__level' },
          h('span', { className: 'status-card__emoji' }, level.emoji),
          h('span', { className: 'status-card__label' }, level.label)
        )
      ),
      
      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–º–∏–Ω–∏-–±–∞—Ä—ã)
      h('div', { className: 'status-card__categories' },
        Object.entries(categoryScores).map(([catId, cat]) =>
          h('div', { 
            key: catId, 
            className: 'status-card__cat',
            title: `${cat.label}: ${cat.score}%`
          },
            h('span', { className: 'status-card__cat-icon' }, cat.icon),
            h('div', { className: 'status-card__cat-bar' },
              h('div', { 
                className: 'status-card__cat-fill',
                style: { 
                  width: `${cat.score}%`,
                  backgroundColor: cat.color
                }
              })
            )
          )
        )
      ),
      
      // –¢–æ–ø –ø—Ä–æ–±–ª–µ–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
      topIssues.length > 0 && h('div', { className: 'status-card__issues' },
        h('div', { className: 'status-card__issues-title' }, '–ù–∞–¥ —á–µ–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å:'),
        topIssues.map((issue, i) =>
          h('div', { key: i, className: 'status-card__issue' },
            h('span', { className: 'status-card__issue-icon' }, issue.factor.icon),
            h('span', { className: 'status-card__issue-text' }, issue.factor.label),
            h('span', { className: 'status-card__issue-score' }, `${issue.score}%`)
          )
        )
      ),
      
      // –®–∞–≥–∏ (–¥–µ–π—Å—Ç–≤–∏—è)
      topActions.length > 0 && h('div', { className: 'status-card__actions' },
        topActions.map((action, i) =>
          h('div', { key: i, className: 'status-card__action' },
            h('span', { className: 'status-card__action-icon' }, action.icon),
            h('span', { className: 'status-card__action-text' }, action.text)
          )
        )
      ),
      
      // –°–æ–æ–±—â–µ–Ω–∏–µ
      h('div', { 
        className: 'status-card__message',
        style: { color: level.color }
      }, level.message)
    );
  }
  
  /**
   * StatusWidget ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è Widgets Dashboard
   */
  function StatusWidget({ status, size = '2x2', onClick }) {
    if (!status) return null;
    
    const { score, level, topActions } = status;
    const isCompact = size === '1x1' || size === '2x1';
    
    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ)
    if (isCompact) {
      return h('div', { 
        className: 'status-widget status-widget--compact',
        onClick,
        style: { '--status-color': level.color }
      },
        h('span', { className: 'status-widget__score' }, score),
        h('span', { className: 'status-widget__emoji' }, level.emoji)
      );
    }
    
    // –ü–æ–ª–Ω—ã–π –≤–∏–¥
    return h('div', { 
      className: 'status-widget',
      onClick,
      style: { '--status-color': level.color }
    },
      // –ß–∏—Å–ª–æ + emoji (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ ‚Äî –æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ WidgetCard)
      h('div', { className: 'status-widget__main' },
        h('span', { className: 'status-widget__score' }, score),
        h('span', { className: 'status-widget__label' }, level.label)
      ),
      
      // Emoji —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É
      h('span', { className: 'status-widget__emoji' }, level.emoji),
      
      // –û–¥–∏–Ω —à–∞–≥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      topActions.length > 0 && h('div', { className: 'status-widget__action' },
        h('span', null, topActions[0].icon),
        h('span', null, topActions[0].text)
      )
    );
  }
  
  /**
   * StatusMini ‚Äî –º–∏–∫—Ä–æ-–≤–µ—Ä—Å–∏—è (–ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ)
   */
  function StatusMini({ status }) {
    if (!status) return h('span', { className: 'status-mini' }, '‚Äî');
    
    return h('span', { 
      className: 'status-mini',
      style: { color: status.level.color }
    }, status.score);
  }
  
  // === –≠–ö–°–ü–û–†–¢ ===
  
  HEYS.Status = {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    FACTORS,
    CATEGORIES,
    STATUS_LEVELS,
    RECOMMENDATIONS,
    
    // –§—É–Ω–∫—Ü–∏–∏
    calculateStatus,
    scoreFactor,
    detectIssue,
    
    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    StatusCard,
    StatusWidget,
    StatusMini,
    
    // –í–µ—Ä—Å–∏—è
    VERSION: '1.0.0'
  };
  
  // Verbose init log removed
  
})(typeof window !== 'undefined' ? window : global);
