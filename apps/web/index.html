<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <!-- Prevent FOUC: Apply theme before CSS loads -->
    <script>
      (function() {
        var t = localStorage.getItem('heys_theme');
        var isDark = t === 'dark' || (t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.setAttribute('data-theme', 'dark');
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>HEYS Nutrition Tracker - Production</title>

    <!-- Critical CSS for instant rendering -->
    <link rel="stylesheet" href="styles/critical.css" />

    <!-- HTTP/2 + Resource hints for optimal performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin />
    <link rel="dns-prefetch" href="https://unpkg.com" />

    <!-- HTTP/2 Server Push hints -->
    <link
      rel="preload"
      href="https://unpkg.com/react@18/umd/react.production.min.js"
      as="script"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
      as="script"
      crossorigin="anonymous"
    />

    <!-- Resource hints for better caching (prefetch, not preload to avoid warnings) -->
    <link rel="prefetch" href="heys_core_v12.js" />
    <link rel="prefetch" href="heys_simple_analytics.js" />
    <link rel="prefetch" href="heys_storage_supabase_v1.js" />
    <link rel="prefetch" href="heys_models_v1.js" />

    <!-- Load non-critical CSS asynchronously -->
    <link
      rel="preload"
      href="styles/main.css?v=1010"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript><link rel="stylesheet" href="styles/main.css?v=1010" /></noscript>

    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    
    <!-- PWA Support (iOS + Android) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="HEYS" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
  </head>
  <body class="emoji-system">
    <div id="root"></div>

    <!-- Emoji style initialization - runs BEFORE twemoji loads -->
    <script>
      (function() {
        // Detect platform - Twemoji only needed on Windows/Linux
        var ua = navigator.userAgent || '';
        var isWindows = /Windows/i.test(ua);
        var isLinux = /Linux/i.test(ua) && !/Android/i.test(ua);
        var needsTwemoji = isWindows || isLinux;
        
        window.heysPlatformNeedsTwemoji = needsTwemoji;
        
        // Get stored preference or auto-detect
        var stored = localStorage.getItem('heys_emoji_style');
        if (stored) {
          stored = stored.replace(/"/g, '');
        }
        
        // Auto mode: use twemoji on Windows/Linux, system on Mac/iOS/Android
        if (!stored || stored === 'auto' || stored === 'android' || stored === 'apple' || stored === 'null') {
          stored = needsTwemoji ? 'twemoji' : 'system';
          localStorage.setItem('heys_emoji_style', stored);
        }
        
        // Apply class
        document.body.classList.remove('emoji-system', 'emoji-twemoji');
        document.body.classList.add('emoji-' + stored);
        
        // Global state
        window.twemojiReady = false;
        window.heysEmojiStyle = stored;
        window.applyTwemoji = function() {};
        window.scheduleTwemojiParse = function() {};
      })();
    </script>
    
    <!-- Twemoji library - load only if needed (async to avoid parser-blocking) -->
    <script>
      if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
        (function() {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js';
          s.async = false; // сохраняем порядок выполнения
          s.onload = function() { window.twemojiLoaded = true; };
          document.head.appendChild(s);
        })();
      }
    </script>
    
    <!-- Twemoji initialization - runs AFTER twemoji loads (only if loaded) -->
    <script>
      (function() {
        // Setup function to initialize Twemoji
        function initTwemoji() {
          if (!window.twemoji) return;
          
          window.twemojiReady = true;
          
          // Apply Twemoji parsing
          window.applyTwemoji = function(el) {
            if (window.heysEmojiStyle !== 'twemoji') return;
            if (!window.twemoji) return;
            // Не парсить эмодзи когда нет сети — иначе бесконечные ошибки загрузки SVG
            if (!navigator.onLine) return;
            
            // Ensure class is set
            if (!document.body.classList.contains('emoji-twemoji')) {
              document.body.classList.add('emoji-twemoji');
            }
            
            var target = el || document.body;
            twemoji.parse(target, {
              folder: 'svg',
              ext: '.svg',
              base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/'
            });
          };
          
          // Debounced parse
          var parseTimeout = null;
          window.scheduleTwemojiParse = function() {
            // Не ставить таймер если нет сети
            if (!navigator.onLine) return;
            if (parseTimeout) clearTimeout(parseTimeout);
            parseTimeout = setTimeout(window.applyTwemoji, 30);
          };
          
          // Parse immediately
          window.applyTwemoji();
          
          // MutationObserver for dynamic content
          var observer = new MutationObserver(function() {
            window.scheduleTwemojiParse();
          });
          
          // Wait for root to exist
          var startObserver = function() {
            var root = document.getElementById('root');
            if (root) {
              observer.observe(root, { childList: true, subtree: true });
            } else {
              setTimeout(startObserver, 10);
            }
          };
          startObserver();
          
          // Reparse when back online
          window.addEventListener('online', function() {
            window.applyTwemoji();
          });
          
          // Aggressive reparsing during page load
          setTimeout(window.applyTwemoji, 100);
          setTimeout(window.applyTwemoji, 300);
          setTimeout(window.applyTwemoji, 600);
          setTimeout(window.applyTwemoji, 1000);
          setTimeout(window.applyTwemoji, 2000);
          setTimeout(window.applyTwemoji, 4000);
        }
        
        // If Twemoji already loaded, init now. Otherwise wait for it.
        if (window.twemoji) {
          initTwemoji();
        } else if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
          // Wait for async script to load
          var checkInterval = setInterval(function() {
            if (window.twemoji) {
              clearInterval(checkInterval);
              initTwemoji();
            }
          }, 20);
          // Timeout after 5s
          setTimeout(function() { clearInterval(checkInterval); }, 5000);
        }
        // Else: not needed, stubs already set
      })();
    </script>

    <!-- libs with defer and priority for optimal loading -->
    <script
      defer
      src="https://unpkg.com/react@18/umd/react.production.min.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"
      fetchpriority="low"
      crossorigin="anonymous"
    ></script>

    <!-- app modules with defer and optimized priority -->
    <script defer src="heys_dev_utils.js" fetchpriority="high"></script>
    <script defer src="heys_simple_analytics.js" fetchpriority="high"></script>
    <script defer src="heys_core_v12.js" fetchpriority="high"></script>
    <script defer src="heys_storage_supabase_v1.js?v=15" fetchpriority="low"></script>
    <script defer src="heys_models_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_storage_layer_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_wheel_picker.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_swipeable.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_pull_refresh.js?v=1" fetchpriority="low"></script>
    <!-- Centralized ratio zones logic -->
    <script defer src="heys_ratio_zones_v1.js?v=1" fetchpriority="low"></script>
    <!-- Gamification system (XP, levels, achievements) -->
    <script defer src="heys_gamification_v1.js?v=1" fetchpriority="low"></script>
    <!-- Day module split (Phase 2-4) -->
    <script defer src="heys_day_utils.js?v=7" fetchpriority="low"></script>
    <script defer src="heys_day_hooks.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_day_pickers.js?v=10" fetchpriority="low"></script>
    <script defer src="heys_advice_v1.js?v=1" fetchpriority="low"></script>
    <!-- End Day module split -->
    <script defer src="heys_day_v12.js?v=11" fetchpriority="low"></script>
    <script defer src="heys_user_v12.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_reports_v12.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_data_overview_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_app_v12.js?v=13" fetchpriority="high"></script>
    
    <!-- Service Worker Registration (PWA offline support) -->
    <!-- Только в production (не localhost) чтобы избежать конфликтов с Vite HMR -->
    <script>
      if ('serviceWorker' in navigator && location.hostname !== 'localhost') {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
              console.log('[App] SW registered, scope:', registration.scope);
              
              // Сохраняем регистрацию для Background Sync
              window.swRegistration = registration;
              
              // Проверка обновлений каждые 60 минут
              setInterval(function() {
                registration.update();
              }, 60 * 60 * 1000);
              
              // Уведомление о новой версии
              registration.addEventListener('updatefound', function() {
                var newWorker = registration.installing;
                newWorker.addEventListener('statechange', function() {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // Новая версия готова
                    console.log('[App] New version available!');
                    // Можно показать toast "Доступно обновление"
                    if (window.HEYS && window.HEYS.showUpdateToast) {
                      window.HEYS.showUpdateToast();
                    }
                  }
                });
              });
              
              // Background Sync — регистрируем при изменениях данных
              window.requestBackgroundSync = function() {
                if ('sync' in registration) {
                  registration.sync.register('heys-sync')
                    .then(function() { console.log('[App] Background sync scheduled'); })
                    .catch(function() { console.log('[App] Background sync not available'); });
                }
              };
            })
            .catch(function(error) {
              console.warn('[App] SW registration failed:', error);
            });
            
          // Обработка сообщений от Service Worker
          navigator.serviceWorker.addEventListener('message', function(event) {
            if (event.data.type === 'SYNC_START') {
              console.log('[App] Background sync starting...');
              // Триггерим синхронизацию через HEYS.cloud
              if (window.HEYS && window.HEYS.cloud && window.HEYS.cloud.sync) {
                window.HEYS.cloud.sync();
              }
            }
            
            if (event.data.type === 'SYNC_COMPLETE') {
              console.log('[App] Background sync complete');
              window.dispatchEvent(new CustomEvent('heys:sync-complete'));
            }
          });
        });
      }
    </script>
  </body>
</html>
