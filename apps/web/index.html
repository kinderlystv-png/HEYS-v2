<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HEYS Nutrition Tracker - Production</title>
    
    <!-- Critical CSS inline for instant rendering -->
    <style>
      :root {
        --bg: #ffffff;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --acc: #2563eb;
        --acc-contrast: #ffffff;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--text);
        font-size: 13px;
        line-height: 1.35;
      }
      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .app-header {
        background: var(--acc);
        color: var(--acc-contrast);
        padding: 1rem;
        text-align: center;
      }
      .app-main {
        flex: 1;
        padding: 1rem;
      }
    </style>
    
    <!-- HTTP/2 + Resource hints for optimal performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- HTTP/2 Server Push hints -->
    <link rel="preload" href="https://unpkg.com/react@18/umd/react.development.js" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.development.js" as="script" crossorigin="anonymous">
    
    <!-- Critical resource preloading with priority hints -->
    <link rel="preload" href="heys_core_v12.js" as="script" fetchpriority="high">
    <link rel="preload" href="heys_simple_analytics.js" as="script" fetchpriority="high">
    
    <!-- Resource hints for better caching -->
    <link rel="prefetch" href="heys_storage_supabase_v1.js">
    <link rel="prefetch" href="heys_models_v1.js">
    
    <!-- Load non-critical CSS asynchronously -->
    <link rel="preload" href="styles/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="styles/main.css"></noscript>
  </head>
  <body>
    <div id="root"></div>

    <!-- libs with defer and priority for optimal loading -->
    <script defer src="https://unpkg.com/react@18/umd/react.development.js" fetchpriority="high" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" fetchpriority="high" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js" fetchpriority="low" crossorigin="anonymous"></script>
    
    <!-- app modules with defer and optimized priority -->
    <script defer src="heys_simple_analytics.js" fetchpriority="high"></script>
    <script defer src="heys_core_v12.js" fetchpriority="high"></script>
    <script defer src="heys_storage_supabase_v1.js?v=15" fetchpriority="low"></script>
    <script defer src="heys_models_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_storage_layer_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_day_v12.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_user_v12.js" fetchpriority="low"></script>
    <script defer src="heys_reports_v12.js" fetchpriority="low"></script>

    <script>
      // Service Worker –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è dev —Ä–µ–∂–∏–º–∞
      // if ('serviceWorker' in navigator) {
      //   window.addEventListener('load', () => {
      //     navigator.serviceWorker.register('/sw.js')
      //       .then((registration) => {
      //         console.log('‚úÖ SW: Registered successfully', registration.scope);
      //       })
      //       .catch((error) => {
      //         console.log('‚ùå SW: Registration failed', error);
      //       });
      //   });
      // }

      (function () {
        window.HEYS = window.HEYS || {};
        // Wait for React to load
        let reactCheckCount = 0;
        function initializeApp() {
          if (!window.React || !window.ReactDOM) {
            reactCheckCount++;
            if (reactCheckCount === 1 || reactCheckCount % 10 === 0) {
              console.log('‚è≥ Waiting for React to load...');
            }
            setTimeout(initializeApp, 100);
            return;
          }
          
          console.log('‚úÖ React loaded, initializing app...');
          const React = window.React,
            ReactDOM = window.ReactDOM;
          const { useState, useEffect } = React;

        // init cloud (safe if no cloud module)
        if (window.HEYS.cloud && typeof HEYS.cloud.init === 'function') {
          HEYS.cloud.init({
            url: 'https://ukqolcziqcuplqfgrmsh.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcW9sY3ppcWN1cGxxZmdybXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTE1NDUsImV4cCI6MjA3MDgyNzU0NX0.Nzd8--PyGMJvIHqFoCQKNUOwpxnrAZuslQHtAjcE1Ds'
          });
        }

        // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è DayTab: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ day ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
        function DayTabWithCloudSync(props) {
          const { clientId, products } = props;
          const [loading, setLoading] = React.useState(true);
          React.useEffect(() => {
            let cancelled = false;
            const cloud = window.HEYS && window.HEYS.cloud;
            const finish = () => {
              if (!cancelled) setLoading(false);
            };
            if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
              const need =
                typeof cloud.shouldSyncClient === 'function'
                  ? cloud.shouldSyncClient(clientId, 4000)
                  : true;
              if (need) {
                setLoading(true);
                cloud.bootstrapClientSync(clientId).then(finish);
              } else finish();
            } else {
              finish();
            }
            return () => {
              cancelled = true;
            };
          }, [clientId]);
          if (loading)
            return React.createElement(
              'div',
              { className: 'muted', style: { padding: 24 } },
              '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞...',
            );
          return React.createElement(window.HEYS.DayTab, { products });
        }

        // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è Ration: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ —Ä–∞—Ü–∏–æ–Ω ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –æ–±–ª–∞–∫–∞
        function RationTabWithCloudSync(props) {
          const { clientId, setProducts, products } = props;
          const [loading, setLoading] = React.useState(true);
          React.useEffect(() => {
            let cancelled = false;
            if (
              clientId &&
              window.HEYS.cloud &&
              typeof window.HEYS.cloud.bootstrapClientSync === 'function'
            ) {
              setLoading(true);
              window.HEYS.cloud.bootstrapClientSync(clientId).then(() => {
                if (!cancelled) {
                  const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                    ? window.HEYS.utils.lsGet('heys_products', [])
                    : [];
                  setProducts(loadedProducts);
                  setLoading(false);
                }
              });
            } else {
              setLoading(false);
            }
            return () => {
              cancelled = true;
            };
          }, [clientId]);
          if (loading)
            return React.createElement(
              'div',
              { className: 'muted', style: { padding: 24 } },
              '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞...',
            );
          return React.createElement(window.HEYS.Ration, { products, setProducts });
        }

        // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è User: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∏ –∑–æ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞
        function UserTabWithCloudSync(props) {
          const { clientId } = props;
          const [loading, setLoading] = React.useState(true);
          React.useEffect(() => {
            let cancelled = false;
            if (
              clientId &&
              window.HEYS.cloud &&
              typeof window.HEYS.cloud.bootstrapClientSync === 'function'
            ) {
              setLoading(true);
              window.HEYS.cloud.bootstrapClientSync(clientId).then(() => {
                if (!cancelled) setLoading(false);
              });
            } else {
              setLoading(false);
            }
            return () => {
              cancelled = true;
            };
          }, [clientId]);
          if (loading)
            return React.createElement(
              'div',
              { className: 'muted', style: { padding: 24 } },
              '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞...',
            );
          return React.createElement(window.HEYS.UserTab, {});
        }

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        function AnalyticsTab() {
          const [stats, setStats] = useState(null);
          const [autoRefresh, setAutoRefresh] = useState(true);
          
          const loadStats = () => {
            if (window.HEYS && window.HEYS.analytics) {
              const data = window.HEYS.analytics.getStats();
              setStats(data);
            }
          };
          
          useEffect(() => {
            loadStats();
            if (autoRefresh) {
              const interval = setInterval(loadStats, 5000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
              return () => clearInterval(interval);
            }
          }, [autoRefresh]);
          
          if (!stats) {
            return React.createElement('div', { style: { padding: 24 } }, '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
          }
          
          return React.createElement(
            'div',
            { style: { padding: 24, maxWidth: 900 } },
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            React.createElement(
              'div',
              { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 } },
              React.createElement('h2', { style: { margin: 0 } }, 'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏'),
              React.createElement(
                'div',
                { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                React.createElement('label', null,
                  React.createElement('input', {
                    type: 'checkbox',
                    checked: autoRefresh,
                    onChange: (e) => setAutoRefresh(e.target.checked),
                    style: { marginRight: 4 }
                  }),
                  '–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
                ),
                React.createElement('button', { className: 'btn', onClick: loadStats }, 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å')
              )
            ),
            
            // –í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
            React.createElement(
              'div',
              { style: { marginBottom: 24, padding: 16, background: '#f8f9fa', borderRadius: 8 } },
              React.createElement('div', { style: { fontSize: 14, color: '#666', marginBottom: 4 } }, '–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏'),
              React.createElement('div', { style: { fontSize: 24, fontWeight: 600 } }, stats.session.duration)
            ),
            
            // –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            React.createElement(
              'div',
              { style: { marginBottom: 24 } },
              React.createElement('h3', null, 'üîç –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã'),
              React.createElement(
                'div',
                { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#e3f2fd', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–í—Å–µ–≥–æ'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.searches.total)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#fff3e0', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–ú–µ–¥–ª–µ–Ω–Ω—ã—Ö (>1s)'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.searches.slow)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: stats.searches.slowRate === '0%' ? '#e8f5e9' : '#ffebee', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Slow Rate'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.searches.slowRate)
                )
              )
            ),
            
            // API –≤—ã–∑–æ–≤—ã
            React.createElement(
              'div',
              { style: { marginBottom: 24 } },
              React.createElement('h3', null, 'üåê API –≤—ã–∑–æ–≤—ã'),
              React.createElement(
                'div',
                { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 } },
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#e3f2fd', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–í—Å–µ–≥–æ'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.apiCalls.total)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#fff3e0', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–ú–µ–¥–ª–µ–Ω–Ω—ã—Ö (>2s)'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.apiCalls.slow)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: stats.apiCalls.failed > 0 ? '#ffebee' : '#e8f5e9', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–û—à–∏–±–æ–∫'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.apiCalls.failed)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#f3e5f5', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Slow Rate'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.apiCalls.slowRate)
                )
              )
            ),
            
            // Cache —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            React.createElement(
              'div',
              { style: { marginBottom: 24 } },
              React.createElement('h3', null, 'üíæ Cache —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'),
              React.createElement(
                'div',
                { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#e8f5e9', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Hits'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.cache.hits)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#ffebee', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Misses'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.cache.misses)
                ),
                React.createElement(
                  'div',
                  { style: { padding: 16, background: '#e1f5fe', borderRadius: 8 } },
                  React.createElement('div', { style: { fontSize: 12, color: '#666' } }, 'Hit Rate'),
                  React.createElement('div', { style: { fontSize: 20, fontWeight: 600 } }, stats.cache.hitRate)
                )
              )
            ),
            
            // –û—à–∏–±–∫–∏
            React.createElement(
              'div',
              { style: { marginBottom: 24 } },
              React.createElement('h3', null, 'üêõ –û—à–∏–±–∫–∏'),
              React.createElement(
                'div',
                { style: { padding: 16, background: stats.errors.total > 0 ? '#ffebee' : '#e8f5e9', borderRadius: 8 } },
                React.createElement('div', { style: { fontSize: 12, color: '#666' } }, '–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫ –≤ —Å–µ—Å—Å–∏–∏'),
                React.createElement('div', { style: { fontSize: 24, fontWeight: 600 } }, stats.errors.total)
              )
            ),
            
            // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
            React.createElement(
              'div',
              { style: { marginTop: 32, paddingTop: 24, borderTop: '1px solid #eee' } },
              React.createElement(
                'button',
                {
                  className: 'btn secondary',
                  onClick: () => {
                    if (window.HEYS && window.HEYS.analytics && window.HEYS.analytics.reset) {
                      if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Å—Å–∏–∏?')) {
                        window.HEYS.analytics.reset();
                        loadStats();
                      }
                    }
                  }
                },
                'üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É'
              )
            )
          );
        }

        function App() {
          const ONE_CURATOR_MODE = true; // –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–≤—Ö–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase
          const [tab, setTab] = useState('day');
          // ...–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ useState...
          // useEffect –∞–≤—Ç–æ—Å–º–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –Ω–∏–∂–µ –≤—Å–µ—Ö useState!
          const U = window.HEYS.utils || { lsGet: (k, d) => d, lsSet: () => {} };
          const [products, setProducts] = useState([]);
          const [reportsRefresh, setReportsRefresh] = useState(0);

          const cloud = window.HEYS.cloud || {};
          const [status, setStatus] = useState(
            typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline',
          );
          const [syncVer, setSyncVer] = useState(0);
          // === Clients (selector + persistence) ===
          const [clients, setClients] = useState([]);
          const [clientId, setClientId] = useState('');
          const [newName, setNewName] = useState('');
          const [cloudUser, setCloudUser] = useState(null);

          // –ü–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–∑ Supabase
          async function fetchClientsFromCloud(curatorId) {
            if (!cloud.client || !curatorId) return [];
            const { data, error } = await cloud.client
              .from('clients')
              .select('id, name')
              .eq('curator_id', curatorId)
              .order('updated_at', { ascending: true });
            if (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
              return [];
            }
            return data || [];
          }

          // –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ Supabase –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
          async function addClientToCloud(name) {
            const clientName = (name || '').trim() || `–ö–ª–∏–µ–Ω—Ç ${clients.length + 1}`;
            
            // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            if (!cloud.client || !cloudUser || !cloudUser.id) {
              console.log('addClientToCloud: —Å–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞');
              const newClient = {
                id: `local-user-${Date.now()}`,
                name: clientName
              };
              const updatedClients = [...clients, newClient];
              setClients(updatedClients);
              U.lsSet('heys_clients', updatedClients);
              setClientId(newClient.id);
              U.lsSet('heys_client_current', newClient.id);
              return;
            }

            // –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º
            const userId = cloudUser.id;
            const { data, error } = await cloud.client
              .from('clients')
              .insert([
                { name: clientName, curator_id: userId },
              ])
              .select('id, name')
              .single();
            if (error) {
              console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:', error);
              alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + error.message);
              return;
            }
            // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
            setClientId(data.id);
            U.lsSet('heys_client_current', data.id);
          }

          // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ Supabase)
          async function renameClient(id, name) {
            // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            if (!cloud.client || !cloudUser || !cloudUser.id) {
              const updatedClients = clients.map(c => 
                c.id === id ? { ...c, name } : c
              );
              setClients(updatedClients);
              U.lsSet('heys_clients', updatedClients);
              return;
            }
            
            // –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º
            const userId = cloudUser.id;
            await cloud.client.from('clients').update({ name }).eq('id', id);
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
          }

          // –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ Supabase)
          async function removeClient(id) {
            // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            if (!cloud.client || !cloudUser || !cloudUser.id) {
              const updatedClients = clients.filter(c => c.id !== id);
              setClients(updatedClients);
              U.lsSet('heys_clients', updatedClients);
              if (clientId === id) {
                setClientId('');
                U.lsSet('heys_client_current', '');
              }
              return;
            }
            
            // –û–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º
            const userId = cloudUser.id;
            await cloud.client.from('clients').delete().eq('id', id);
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
            if (clientId === id) {
              setClientId('');
              U.lsSet('heys_client_current', '');
            }
          }

          // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–Ω—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞
          useEffect(() => {
            if (clientId) setTab('day');
          }, [clientId]);

          // Fallback: –µ—Å–ª–∏ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –ø—É—Å—Ç—ã–µ, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ localStorage —á–µ—Ä–µ–∑ utils
          useEffect(() => {
            if (products.length === 0) {
              try {
                const stored =
                  (window.HEYS &&
                    window.HEYS.utils &&
                    window.HEYS.utils.lsGet &&
                    window.HEYS.utils.lsGet('heys_products', [])) ||
                  [];
                if (Array.isArray(stored) && stored.length) setProducts(stored);
              } catch (e) {}
            }
          }, [products.length]);

          // –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
          useEffect(() => {
            if (clientId) {
              U.lsSet('heys_client_current', clientId);
              window.HEYS = window.HEYS || {};
              window.HEYS.currentClientId = clientId;
              // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ Supabase –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
              if (cloud && typeof cloud.bootstrapClientSync === 'function') {
                cloud.bootstrapClientSync(clientId).then(() => {
                  // –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º HEYS.utils.lsGet –¥–ª—è clientId-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
                  const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                    ? window.HEYS.utils.lsGet('heys_products', [])
                    : [];
                  setProducts(loadedProducts);
                  setSyncVer((v) => v + 1);
                });
              } else {
                setSyncVer((v) => v + 1);
              }
            }
          }, [clientId]);

          // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ–±–ª–∞–∫–∞
          useEffect(() => {
            const handleProductsUpdate = (event) => {
              const { products } = event.detail;
              setProducts(products);
              setSyncVer((v) => v + 1);
            };

            window.addEventListener('heysProductsUpdated', handleProductsUpdate);
            return () => window.removeEventListener('heysProductsUpdated', handleProductsUpdate);
          }, []);

          // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ–±–ª–∞–∫–æ
          window.HEYS = window.HEYS || {};
          window.HEYS.saveClientKey = function (k, v) {
            if (clientId && cloud && typeof cloud.saveClientKey === 'function') {
              cloud.saveClientKey(clientId, k, v);
            }
          };
          // overlay (no early return, to keep hooks order stable)
          // One-time migration of old, namespaced client lists -> global
          // –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫—É—Ä–∞—Ç–æ—Ä–∞
          useEffect(() => {
            if (cloudUser && cloudUser.id) {
              fetchClientsFromCloud(cloudUser.id).then(setClients);
            }
          }, [cloudUser]);

          // –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
          async function createTestClients() {
            if (!cloud.client || !cloudUser || !cloudUser.id) return;
            const userId = cloudUser.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            const testClients = [{ name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤' }, { name: '–ê–Ω–Ω–∞ –°–∏–¥–æ—Ä–æ–≤–∞' }];

            for (const testClient of testClients) {
              try {
                await cloud.client
                  .from('clients')
                  .insert([{ name: testClient.name, curator_id: userId }]);
              } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:', error);
              }
            }

            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
          }

          const gate = !clientId
            ? React.createElement(
                'div',
                { className: 'modal-backdrop' },
                React.createElement(
                  'div',
                  { className: 'modal' },
                  React.createElement(
                    'div',
                    {
                      className: 'row',
                      style: { justifyContent: 'space-between', marginBottom: '6px' },
                    },
                    React.createElement('div', { style: { fontWeight: 600 } }, '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞'),
                    React.createElement('span', { className: 'muted' }, `–í—Å–µ–≥–æ: ${clients.length}`),
                  ),
                  React.createElement(
                    'div',
                    { style: { maxHeight: 260, overflow: 'auto', marginBottom: 8 } },
                    clients.length
                      ? clients.map((c) =>
                          React.createElement(
                            'div',
                            {
                              key: c.id,
                              className: 'row',
                              style: { justifyContent: 'space-between' },
                            },
                            React.createElement(
                              'div',
                              null,
                              React.createElement('div', { style: { fontWeight: 600 } }, c.name),
                              React.createElement('div', { className: 'muted' }, c.id),
                            ),
                            React.createElement(
                              'div',
                              { className: 'row' },
                              React.createElement(
                                'button',
                                { 
                                  className: 'btn', 
                                  onClick: () => {
                                    setClientId(c.id);
                                    U.lsSet('heys_client_current', c.id); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
                                  }
                                },
                                '–í—ã–±—Ä–∞—Ç—å',
                              ),
                              React.createElement(
                                'button',
                                {
                                  className: 'btn',
                                  onClick: () => {
                                    const nm = prompt('–ù–æ–≤–æ–µ –∏–º—è', c.name) || c.name;
                                    renameClient(c.id, nm);
                                  },
                                },
                                '–ü–µ—Ä–µ–∏–º–µ–Ω.',
                              ),
                              React.createElement(
                                'button',
                                {
                                  className: 'btn',
                                  onClick: () => {
                                    if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) removeClient(c.id);
                                  },
                                },
                                '–£–¥–∞–ª–∏—Ç—å',
                              ),
                            ),
                          ),
                        )
                      : React.createElement(
                          'div',
                          { className: 'muted' },
                          '–ï—â—ë –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞',
                        ),
                  ),
                  React.createElement(
                    'div',
                    { className: 'row' },
                    React.createElement('input', {
                      placeholder: '–ò–º—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞',
                      value: newName,
                      onChange: (e) => setNewName(e.target.value),
                    }),
                    React.createElement(
                      'button',
                      { className: 'btn acc', onClick: () => addClientToCloud(newName) },
                      '–°–æ–∑–¥–∞—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å',
                    ),
                  ),
                  React.createElement(
                    'div',
                    { className: 'row', style: { marginTop: 8 } },
                    React.createElement(
                      'button',
                      { className: 'btn secondary', onClick: createTestClients },
                      '–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤',
                    ),
                  ),
                ),
              )
            : null;

          const [email, setEmail] = useState('poplanton@mail.ru');
          const [pwd, setPwd] = useState('007670');

          useEffect(() => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const initLocalData = () => {
              // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ localStorage –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
              const storedProducts = U.lsGet('heys_products', []);
              if (Array.isArray(storedProducts)) {
                setProducts(storedProducts);
              }
              
              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
              const storedClients = U.lsGet('heys_clients', []);
              if (Array.isArray(storedClients) && storedClients.length > 0) {
                setClients(storedClients);
              } else {
                // –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –Ω–∞—á–∞–ª–∞
                const defaultClients = [
                  { id: 'local-user-001', name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤' },
                  { id: 'local-user-002', name: '–ê–Ω–Ω–∞ –°–∏–¥–æ—Ä–æ–≤–∞' }
                ];
                setClients(defaultClients);
                U.lsSet('heys_clients', defaultClients);
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
              const currentClient = U.lsGet('heys_client_current');
              const storedClientsArray = U.lsGet('heys_clients', []);
              if (currentClient && storedClientsArray.some(c => c.id === currentClient)) {
                setClientId(currentClient);
              }
              // –ï—Å–ª–∏ –Ω–µ—Ç currentClient - –ø–æ–∫–∞–∂–µ—Ç—Å—è modal –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
              
              setStatus('offline');
              setSyncVer((v) => v + 1);
            };
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –æ–±–ª–∞–∫—É –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            if (cloud && typeof cloud.bootstrapSync === 'function') {
              cloud
                .bootstrapSync()
                .then(() => {
                  setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'online');
                  setProducts(
                    Array.isArray(U.lsGet('heys_products', [])) ? U.lsGet('heys_products', []) : [],
                  );
                  setSyncVer((v) => v + 1);
                })
                .catch(() => {
                  initLocalData();
                });
            } else {
              initLocalData();
            }
          }, []);

          // –ü—Ä–∏ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–µ–ª–∏ ‚Äî bootstrap –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –æ–±–ª–∞–∫–∞, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç
          useEffect(() => {
            if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
              cloud.bootstrapClientSync(clientId).then(() => {
                const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                  ? window.HEYS.utils.lsGet('heys_products', [])
                  : [];
                setProducts(loadedProducts);
                setSyncVer((v) => v + 1);
              });
            }
          }, [clientId]);

          // debounced save products
          const saveTimerRef = React.useRef(null);
          useEffect(() => {
            if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
            saveTimerRef.current = setTimeout(() => {
              try {
                window.HEYS.saveClientKey('heys_products', products);
              } catch (e) {}
            }, 300);
            return () => {
              if (saveTimerRef.current) {
                clearTimeout(saveTimerRef.current);
                saveTimerRef.current = null;
              }
            };
          }, [products]);

          // auto sign-in in single-curator mode
          useEffect(() => {
            if (ONE_CURATOR_MODE && status !== 'online') {
              doSignIn();
            }
          }, [ONE_CURATOR_MODE, status]);

          async function doSignIn() {
            try {
              if (!email || !pwd) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
              }
              setStatus('signin');
              if (cloud && typeof cloud.signIn === 'function') {
                const result = await cloud.signIn(email, pwd);
                if (result.error) {
                  alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (result.error.message || result.error));
                  setStatus('offline');
                  return;
                }
                setCloudUser(result.user);
              }
              setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'online');
              // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ—Å–ª–µ sign-in
              const loadedProducts = Array.isArray(U.lsGet('heys_products', []))
                ? U.lsGet('heys_products', [])
                : [];
              setProducts(loadedProducts);
              setSyncVer((v) => v + 1);
            } catch (e) {
              setStatus('offline');
              alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e && e.message ? e.message : e));
            }
          }
          async function doSignOut() {
            try {
              if (cloud && typeof cloud.signOut === 'function') await cloud.signOut();
            } catch (e) {}
            setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline');
            setProducts([]);
            setSyncVer((v) => v + 1);
          }

          return React.createElement(
            React.Fragment,
            null,
            gate,
            React.createElement(
              'div',
              { className: 'wrap' },
              React.createElement(
                'div',
                { className: 'hdr' },
                React.createElement('div', null, 'HEYS ‚Äî –ø–∞–Ω–µ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–∞'),
                ONE_CURATOR_MODE
                  ? React.createElement(
                      'div',
                      { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                      React.createElement(
                        'span',
                        { className: 'status ' + (status === 'online' ? 'ok' : 'err') },
                        'cloud: ' + String(status || ''),
                      ),
                      window.HEYS.analyticsUI
                        ? React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                        : null,
                    )
                  : React.createElement(
                      'div',
                      { className: 'login' },
                      React.createElement('input', {
                        placeholder: 'email',
                        value: email,
                        onChange: (e) => setEmail(e.target.value),
                      }),
                      React.createElement('input', {
                        placeholder: '–ø–∞—Ä–æ–ª—å',
                        type: 'password',
                        value: pwd,
                        onChange: (e) => setPwd(e.target.value),
                      }),
                      React.createElement(
                        'button',
                        { className: 'btn', onClick: doSignIn },
                        '–í–æ–π—Ç–∏',
                      ),
                      React.createElement(
                        'button',
                        { className: 'btn secondary', onClick: doSignOut },
                        '–í—ã–π—Ç–∏',
                      ),
                      React.createElement(
                        'span',
                        { className: 'status ' + (status === 'online' ? 'ok' : 'err') },
                        String(status || ''),
                      ),
                      window.HEYS.analyticsUI
                        ? React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                        : null,
                    ),
                React.createElement(
                  'div',
                  { className: 'row' },
                  clientId
                    ? React.createElement(
                        React.Fragment,
                        null,
                        React.createElement(
                          'span',
                          { className: 'muted', style: { marginRight: 8 } },
                          '–ö–ª–∏–µ–Ω—Ç:',
                        ),
                        React.createElement(
                          'span',
                          { style: { fontWeight: 600, marginRight: 8 } },
                          clients.find((c) => c.id === clientId)?.name || clientId,
                        ),
                        React.createElement(
                          'button',
                          { className: 'btn', onClick: () => setClientId('') },
                          '–°–º–µ–Ω–∏—Ç—å',
                        ),
                      )
                    : null,
                ),
              ),
              React.createElement(
                'div',
                { className: 'tabs' },
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'ration' ? 'active' : ''),
                    onClick: () => setTab('ration'),
                  },
                  '–†–∞—Ü–∏–æ–Ω',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'day' ? 'active' : ''),
                    onClick: () => setTab('day'),
                  },
                  '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–Ω—è',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'reports' ? 'active' : ''),
                    onClick: () => {
                      setTab('reports');
                      setReportsRefresh(Date.now());
                    },
                  },
                  '–û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'user' ? 'active' : ''),
                    onClick: () => setTab('user'),
                  },
                  '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'analytics' ? 'active' : ''),
                    onClick: () => setTab('analytics'),
                  },
                  'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                ),
              ),
              tab === 'ration'
                ? React.createElement(RationTabWithCloudSync, {
                    key: 'ration' + syncVer + '_' + String(clientId || ''),
                    products,
                    setProducts,
                    clientId,
                  })
                : tab === 'day'
                  ? React.createElement(DayTabWithCloudSync, {
                      key: 'day' + syncVer + '_' + String(clientId || ''),
                      products,
                      clientId,
                    })
                  : tab === 'user'
                    ? React.createElement(UserTabWithCloudSync, {
                        key: 'user' + syncVer + '_' + String(clientId || ''),
                        clientId,
                      })
                    : tab === 'analytics'
                      ? React.createElement(AnalyticsTab, {
                          key: 'analytics' + syncVer,
                        })
                      : React.createElement(window.HEYS.ReportsTab, {
                        key:
                          'reports' + syncVer + '_' + String(clientId || '') + '_' + reportsRefresh,
                        products,
                      }),
            ),
          );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        }
        
        // Start initialization
        initializeApp();
      })();
    </script>
  </body>
</html>
