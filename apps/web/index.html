<!doctype html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <!-- ÔøΩ Preconnect: DNS+TCP+TLS ahead of time -->
    <link rel="preconnect" href="https://api.heyslab.ru" crossorigin />
    <!-- ÔøΩüîç PWA Debug: Boot timing logger (saved to localStorage for mobile diagnosis) -->
    <script>
        (function () {
            window.__heysBootLog = [];
            window.__heysBootStart = Date.now();
            window.__heysLog = function (msg) {
                var entry = { t: Date.now() - window.__heysBootStart, m: msg };
                window.__heysBootLog.push(entry);
                try {
                    localStorage.setItem('heys_boot_log', JSON.stringify(window.__heysBootLog.slice(-50)));
                } catch (e) { }
                // üîá v4.7.0: BOOT –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã (—Å–º. localStorage.heys_boot_log)
            };
            window.__heysLog('HTML parsing started');

            // ‚è±Ô∏è Boot performance marker ‚Äî logs elapsed time since page load
            window.__heysPerfMark = function (label) {
                if (!window.__heysBootStart) return;
                var elapsed = ((Date.now() - window.__heysBootStart) / 1000).toFixed(1);
                console.info('[PERF] ‚è±Ô∏è +' + elapsed + 's ‚Äî ' + label);
            };
            window.__heysPerfMark('HTML parsing started');

            // üöÄ SPECULATIVE PREFETCH: –∑–∞–ø—É—Å–∫–∞–µ–º –ù–ê–°–¢–û–Ø–©–ò–ô delta fetch –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ HTML
            // –ù–µ –∂–¥—ë–º React (+0.9—Å) ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Å—Ä–∞–∑—É ‚Üí —ç–∫–æ–Ω–æ–º–∏–º ~1—Å
            // –ï—Å–ª–∏ clientId/lastSyncTs –Ω–µ—Ç ‚Äî fallback –Ω–∞ —Ç—ë–ø–ª—ã–π /health
            try {
                var rawCid = localStorage.getItem('heys_client_current');
                var cid = rawCid ? JSON.parse(rawCid) : null;
                if (cid) {
                    var syncTs = localStorage.getItem('heys_' + cid + '_last_sync_ts');
                    if (syncTs) {
                        var pfUrl = 'https://api.heyslab.ru/rest/v1/client_kv_store'
                            + '?select=k%2Cv%2Cupdated_at'
                            + '&client_id=eq.' + encodeURIComponent(cid)
                            + '&updated_at=gt.' + encodeURIComponent(syncTs)
                            + '&limit=400&offset=0';
                        window.__heysPrefetch = {
                            clientId: cid, since: syncTs,
                            promise: fetch(pfUrl, { mode: 'cors', cache: 'no-store' })
                                .then(function (r) {
                                    if (!r.ok) throw new Error('HTTP ' + r.status);
                                    return r.json();
                                })
                                .then(function (d) {
                                    window.__heysPerfMark && window.__heysPerfMark('Prefetch data ready: ' + (Array.isArray(d) ? d.length : 0) + ' keys');
                                    return { data: d, ok: true };
                                })
                                .catch(function (e) {
                                    return { data: null, ok: false, error: e.message };
                                })
                        };
                    } else {
                        fetch('https://api.heyslab.ru/health', { mode: 'cors', cache: 'no-store' })
                            .then(function () { window.__heysPerfMark && window.__heysPerfMark('CF warm-up done'); })
                            .catch(function () { });
                    }
                } else {
                    fetch('https://api.heyslab.ru/health', { mode: 'cors', cache: 'no-store' })
                        .then(function () { window.__heysPerfMark && window.__heysPerfMark('CF warm-up done'); })
                        .catch(function () { });
                }
            } catch (e) {
                try { fetch('https://api.heyslab.ru/health', { mode: 'cors', cache: 'no-store' }).catch(function () { }); } catch (e2) { }
            }

            // Check if PWA standalone mode
            var isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            window.__heysLog('PWA standalone: ' + isStandalone);
        })();
    </script>

    <!-- üÜï PWA Recovery: Global pre-React error handler -->
    <script>
        (function () {
            var errorCount = 0;
            var MAX_ERRORS = 3;
            var recoveryShown = false;
            window.__heysRecoveryBusy = false;

            function notifySwBootFailure() {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'BOOT_FAILURE' });
                }
            }

            function setRecoveryStatus(text) {
                var statusEl = document.getElementById('heys-recovery-status');
                if (statusEl) statusEl.textContent = text || '';
            }

            function setRecoveryButtonsDisabled(disabled) {
                var reloadBtn = document.getElementById('heys-recovery-reload');
                var clearBtn = document.getElementById('heys-recovery-clear');
                if (reloadBtn) reloadBtn.disabled = !!disabled;
                if (clearBtn) clearBtn.disabled = !!disabled;
            }

            function showRecoveryUI(errorMsg) {
                if (recoveryShown) return;
                recoveryShown = true;
                notifySwBootFailure();
                window.__heysLog && window.__heysLog('[CRITICAL] Recovery UI: ' + errorMsg);

                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;padding:20px;background:#f3f4f6">' +
                    '<div style="background:white;padding:32px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1);max-width:400px;text-align:center">' +
                    '<div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>' +
                    '<h2 style="margin:0 0 8px;font-size:20px">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>' +
                    '<p style="margin:0 0 24px;color:#6b7280;font-size:14px">' + (errorMsg || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞') + '</p>' +
                    '<div id="heys-recovery-status" style="margin:0 0 16px;color:#6b7280;font-size:12px"></div>' +
                    '<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">' +
                    '<button id="heys-recovery-reload" onclick="window.__heysReloadApp && window.__heysReloadApp()" style="padding:12px 24px;border-radius:8px;border:none;background:#10b981;color:white;font-weight:500;cursor:pointer">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>' +
                    '<button id="heys-recovery-clear" onclick="clearCacheAndReload()" style="padding:12px 24px;border-radius:8px;border:1px solid #d1d5db;background:white;color:#374151;font-weight:500;cursor:pointer">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à</button>' +
                    '</div></div></div>';
            }

            window.__heysShowRecoveryUI = showRecoveryUI;

            window.__heysReloadApp = function () {
                if (window.__heysRecoveryBusy) return;
                window.__heysRecoveryBusy = true;
                setRecoveryStatus('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è‚Ä¶');
                setRecoveryButtonsDisabled(true);
                setTimeout(function () {
                    location.reload();
                }, 250);
            };

            window.clearCacheAndReload = async function () {
                if (window.__heysRecoveryBusy) return;
                window.__heysRecoveryBusy = true;
                setRecoveryStatus('–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Ä¶');
                setRecoveryButtonsDisabled(true);
                try {
                    if ('caches' in window) {
                        var names = await caches.keys();
                        await Promise.all(names.map(function (n) { return caches.delete(n); }));
                    }
                    if ('serviceWorker' in navigator) {
                        var regs = await navigator.serviceWorker.getRegistrations();
                        await Promise.all(regs.map(function (r) { return r.unregister(); }));
                    }
                    sessionStorage.clear();
                } catch (e) {
                    window.__heysLog && window.__heysLog('[RECOVERY] cache clear failed: ' + (e && e.message ? e.message : String(e)));
                }
                setTimeout(function () {
                    location.reload();
                }, 350);
            };

            // Global error handler
            window.onerror = function (msg, url, line, col, error) {
                errorCount++;
                window.__heysLog && window.__heysLog('[ERROR] ' + msg + ' at ' + url + ':' + line);

                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ recovery
                var isCritical = /React|ReactDOM|HEYS|createRoot|createElement/.test(msg + (error ? error.stack : ''));

                if (isCritical || errorCount >= MAX_ERRORS) {
                    showRecoveryUI(msg);
                    return true; // Suppress error
                }
                return false;
            };

            // Unhandled promise rejections
            window.onunhandledrejection = function (event) {
                errorCount++;
                var reason = event.reason ? (event.reason.message || String(event.reason)) : 'Unknown error';
                window.__heysLog && window.__heysLog('[REJECT] ' + reason);

                if (errorCount >= MAX_ERRORS) {
                    showRecoveryUI(reason);
                }
            };

            // Watchdog: –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä —Å heartbeat
            // –í–º–µ—Å—Ç–æ –∂—ë—Å—Ç–∫–æ–≥–æ 15s cutoff ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5s,
            // –∏ –∂–¥—ë–º –¥–æ 120s –ø–æ–∫–∞ –µ—Å—Ç—å heartbeat (—Å–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è)
            // üîÑ v5: —É–≤–µ–ª–∏—á–µ–Ω–æ —Å 60s –¥–æ 120s –¥–ª—è throttled-—Å–µ—Ç–µ–π
            window.__heysLoadingHeartbeat = Date.now();
            // üÜï v9.1: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ heartbeat –∏–∑ HTML (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–¥–ª–æ–≤).
            // –° –±–∞–Ω–¥–ª–∞–º–∏ boot-init —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è ~30s –Ω–∞ throttled-—Å–µ—Ç–∏,
            // –ø–æ—ç—Ç–æ–º—É heartbeat –∏–∑ waitForDependencies –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –¥–æ watchdog.
            (function autoHeartbeat() {
                if (window.__heysAppReady) return;
                window.__heysLoadingHeartbeat = Date.now();
                setTimeout(autoHeartbeat, 2000);
            })();
            var watchdogChecks = 0;
            var WATCHDOG_INTERVAL = 5000;
            var WATCHDOG_MAX_CHECKS = 24; // 120s –º–∞–∫—Å–∏–º—É–º (was 12/60s ‚Äî —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –¥–ª—è slow 3G)
            var WATCHDOG_STALE_MS = 10000; // 10s –±–µ–∑ heartbeat = –∑–∞–≤–∏—Å–ª–æ

            function watchdogCheck() {
                watchdogChecks++;
                if (window.__heysAppReady) {
                    window.__heysPerfMark && window.__heysPerfMark('Watchdog: appReady confirmed');
                    return; // App –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –æ—Ç–ª–∏—á–Ω–æ
                }

                var now = Date.now();
                var heartbeatAge = now - (window.__heysLoadingHeartbeat || 0);
                var totalElapsed = watchdogChecks * WATCHDOG_INTERVAL;

                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–µ–∂–∏–π heartbeat ‚Äî —Å–∫—Ä–∏–ø—Ç—ã –µ—â—ë –≥—Ä—É–∑—è—Ç—Å—è, –∂–¥—ë–º
                if (heartbeatAge < WATCHDOG_STALE_MS && watchdogChecks < WATCHDOG_MAX_CHECKS) {
                    window.__heysLog && window.__heysLog('[WATCHDOG] Still loading... (' + (totalElapsed / 1000) + 's, heartbeat ' + (heartbeatAge / 1000).toFixed(1) + 's ago)');
                    setTimeout(watchdogCheck, WATCHDOG_INTERVAL);
                    return;
                }

                // Heartbeat —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –º–∞–∫—Å–∏–º—É–º ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º recovery
                window.__heysLog && window.__heysLog('[WATCHDOG] App not ready after ' + (totalElapsed / 1000) + 's (heartbeat age: ' + (heartbeatAge / 1000).toFixed(1) + 's)');
                if (window.__heysShowRecoveryUI) {
                    window.__heysShowRecoveryUI('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∑–∞ ' + (totalElapsed / 1000) + ' —Å–µ–∫—É–Ω–¥');
                }
            }
            setTimeout(watchdogCheck, WATCHDOG_INTERVAL);
        })();
    </script>
    <!-- Global deps loader (used to wait for React safely) -->
    <script>
        (function () {
            window.HEYS = window.HEYS || {};
            window.HEYS.waitForDeps = function (deps, onReady, options) {
                var opts = options || {};
                var timeoutMs = typeof opts.timeoutMs === 'number' ? opts.timeoutMs : 5000;
                var intervalMs = typeof opts.intervalMs === 'number' ? opts.intervalMs : 20;
                var startedAt = Date.now();

                function check() {
                    var missing = (deps || []).filter(function (d) {
                        try {
                            return !(d && typeof d.check === 'function' && d.check());
                        } catch (e) {
                            return true;
                        }
                    });

                    if (missing.length === 0) {
                        if (typeof onReady === 'function') onReady();
                        return;
                    }

                    if (Date.now() - startedAt >= timeoutMs) {
                        var names = missing.map(function (d) { return d && d.name ? d.name : 'unknown'; }).join(', ');
                        window.__heysLog && window.__heysLog('[DEPS] Timeout waiting for: ' + names);
                        if (typeof opts.onTimeout === 'function') {
                            opts.onTimeout(missing);
                        }
                        return;
                    }

                    setTimeout(check, intervalMs);
                }

                check();
            };
        })();
    </script>
    <!-- Prevent FOUC: Apply theme before CSS loads -->
    <script>
        (function () {
            var t = localStorage.getItem('heys_theme');
            var isDark = t === 'dark' || (t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) document.documentElement.setAttribute('data-theme', 'dark');
            window.__heysLog && window.__heysLog('Theme applied: ' + (isDark ? 'dark' : 'light'));
        })();
    </script>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>HEYS Nutrition Tracker - Production</title>

    <!-- Tailwind CSS (production-friendly —á–µ—Ä–µ–∑ Vite/PostCSS) -->
    <link rel="stylesheet" href="/styles/tailwind.css" />

    <!-- Critical CSS for instant rendering -->
    <link rel="stylesheet" href="styles/critical.css" />

    <!-- Pattern Debugger CSS (–æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º async, –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è FCP) -->
    <link rel="preload" href="insights/pi_pattern_debugger.css?v=2" as="style"
        onload="this.onload=null;this.rel='stylesheet'" />
    <noscript>
        <link rel="stylesheet" href="insights/pi_pattern_debugger.css?v=2" />
    </noscript>

    <!-- HTTP/2 + Resource hints for optimal performance -->
    <!-- cdn.jsdelivr.net –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è Twemoji (emoji SVG) -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <!-- Preload –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö boot-–±–∞–Ω–¥–ª–æ–≤ (2026-02-25 bundle migration) -->
    <link rel="preload" href="boot-core.bundle.e0cfd58e1796.js" as="script" />
    <link rel="preload" href="boot-calc.bundle.bb8a3a4c781b.js" as="script" />
    <link rel="preload" href="boot-day.bundle.7320c50778ec.js" as="script" />
    <link rel="preload" href="boot-app.bundle.bc6fb633ba7c.js" as="script" />
    <link rel="preload" href="boot-init.bundle.01e94cb6ddd3.js" as="script" />

    <!-- React —Ç–µ–ø–µ—Ä—å –±–∞–Ω–¥–ª–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Vite (–º–∏–≥—Ä–∞—Ü–∏—è —Å CDN 2026-01-21) -->

    <!-- Resource hints for better caching (prefetch, not preload to avoid warnings) -->
    <link rel="prefetch" href="heys_core_v12.js?v=2" />
    <link rel="prefetch" href="heys_simple_analytics.js" />
    <!-- heys_storage_supabase_v1.js ‚Äî prefetch —É–¥–∞–ª—ë–Ω, —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω—ã–π, SDK —É–¥–∞–ª—ë–Ω -->
    <link rel="prefetch" href="heys_models_v1.js" />

    <!-- Load non-critical CSS asynchronously -->
    <link rel="preload" href="styles/main.css?v=38" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript>
        <link rel="stylesheet" href="styles/main.css?v=38" />
    </noscript>

    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2563eb" />

    <!-- PWA Support (iOS + Android) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="HEYS" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />

    <!-- IW config: loaded externally from /heys-iw-config.json (async fetch + localStorage cache) -->
    <!-- 37KB inline JSON removed ‚Üí improves HTML parse time by ~1-2s on slow 3G -->
    <!-- Fallback: localStorage cache (heys_iw_config_cache_v1) with 24h TTL -->
</head>

<body class="emoji-system">
    <!-- üîç vConsole –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ (–≤–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ?debug=1 –∏–ª–∏ localStorage heys_debug=1) -->
    <script>
        (function () {
            window.__heysLog && window.__heysLog('Body parsing started');
            var debug = new URLSearchParams(window.location.search).get('debug') === '1' || localStorage.getItem('heys_debug') === '1';
            if (debug) {
                var s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/vconsole@latest/dist/vconsole.min.js';
                s.onload = function () {
                    new window.VConsole({ theme: 'dark' });
                    window.__heysLog && window.__heysLog('vConsole loaded');
                };
                document.head.appendChild(s);
            }
        })();
    </script>
    <div id="root"></div>

    <!-- Emoji style initialization - runs BEFORE twemoji loads -->
    <script>
        (function () {
            // Detect platform - Twemoji only needed on Windows/Linux
            var ua = navigator.userAgent || '';
            var isWindows = /Windows/i.test(ua);
            var isLinux = /Linux/i.test(ua) && !/Android/i.test(ua);
            var needsTwemoji = isWindows || isLinux;

            window.heysPlatformNeedsTwemoji = needsTwemoji;

            // Get stored preference or auto-detect
            var stored = localStorage.getItem('heys_emoji_style');
            if (stored) {
                stored = stored.replace(/"/g, '');
            }

            // Auto mode: use twemoji on Windows/Linux, system on Mac/iOS/Android
            if (!stored || stored === 'auto' || stored === 'android' || stored === 'apple' || stored === 'null') {
                stored = needsTwemoji ? 'twemoji' : 'system';
                localStorage.setItem('heys_emoji_style', stored);
            }

            // Apply class
            document.body.classList.remove('emoji-system', 'emoji-twemoji');
            document.body.classList.add('emoji-' + stored);

            // Global state
            window.twemojiReady = false;
            window.heysEmojiStyle = stored;
            window.applyTwemoji = function () { };
            window.scheduleTwemojiParse = function () { };
        })();
    </script>

    <!-- Twemoji library - load only if needed (async to avoid parser-blocking) -->
    <script>
        if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
            (function () {
                var s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js';
                s.async = false; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                s.onload = function () { window.twemojiLoaded = true; };
                document.head.appendChild(s);
            })();
        }
    </script>

    <!-- Twemoji initialization - runs AFTER twemoji loads (only if loaded) -->
    <script>
        (function () {
            // Setup function to initialize Twemoji
            function initTwemoji() {
                if (!window.twemoji) return;

                window.twemojiReady = true;

                var parseTimeout = null;
                var isParsing = false;
                var pendingTarget = null;
                var lastParsedAt = 0;
                var MIN_PARSE_INTERVAL_MS = 120;

                function resolveTwemojiTarget(el) {
                    return el || document.getElementById('root') || document.body;
                }

                function runTwemojiParse(el) {
                    if (window.heysEmojiStyle !== 'twemoji') return;
                    if (!window.twemoji) return;
                    // –ù–µ –ø–∞—Ä—Å–∏—Ç—å —ç–º–æ–¥–∑–∏ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–µ—Ç–∏ ‚Äî –∏–Ω–∞—á–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ SVG
                    if (!navigator.onLine) return;

                    // Ensure class is set
                    if (!document.body.classList.contains('emoji-twemoji')) {
                        document.body.classList.add('emoji-twemoji');
                    }

                    var target = resolveTwemojiTarget(el);

                    if (isParsing) {
                        pendingTarget = pendingTarget || target;
                        return;
                    }

                    var now = Date.now();
                    var elapsed = now - lastParsedAt;
                    if (elapsed < MIN_PARSE_INTERVAL_MS) {
                        if (parseTimeout) clearTimeout(parseTimeout);
                        parseTimeout = setTimeout(function () {
                            runTwemojiParse(target);
                        }, MIN_PARSE_INTERVAL_MS - elapsed);
                        return;
                    }

                    isParsing = true;
                    try {
                        twemoji.parse(target, {
                            folder: 'svg',
                            ext: '.svg',
                            base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/'
                        });
                        lastParsedAt = Date.now();
                    } finally {
                        isParsing = false;
                    }

                    if (pendingTarget) {
                        var nextTarget = pendingTarget;
                        pendingTarget = null;
                        if (parseTimeout) clearTimeout(parseTimeout);
                        parseTimeout = setTimeout(function () {
                            runTwemojiParse(nextTarget);
                        }, MIN_PARSE_INTERVAL_MS);
                    }
                }

                // Apply Twemoji parsing
                window.applyTwemoji = function (el) {
                    runTwemojiParse(el);
                };

                // Debounced parse
                window.scheduleTwemojiParse = function (el) {
                    // –ù–µ —Å—Ç–∞–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏
                    if (!navigator.onLine) return;
                    if (parseTimeout) clearTimeout(parseTimeout);
                    parseTimeout = setTimeout(function () {
                        runTwemojiParse(el);
                    }, 80);
                };

                // Parse immediately
                window.applyTwemoji(document.getElementById('root') || document.body);

                // MutationObserver for dynamic content
                var observer = new MutationObserver(function (mutations) {
                    var parseTarget = null;

                    for (var i = 0; i < mutations.length; i++) {
                        var m = mutations[i];

                        if (m.type === 'childList' && m.addedNodes && m.addedNodes.length) {
                            for (var j = 0; j < m.addedNodes.length; j++) {
                                var node = m.addedNodes[j];
                                if (node && node.nodeType === 1) {
                                    parseTarget = node;
                                    break;
                                }
                                if (node && node.nodeType === 3 && m.target && m.target.nodeType === 1) {
                                    parseTarget = m.target;
                                    break;
                                }
                            }
                        } else if (m.type === 'characterData' && m.target && m.target.parentElement) {
                            parseTarget = m.target.parentElement;
                        }

                        if (parseTarget) break;
                    }

                    if (parseTarget) {
                        window.scheduleTwemojiParse(parseTarget);
                    }
                });

                // Wait for root to exist
                var startObserver = function () {
                    var root = document.getElementById('root');
                    if (root) {
                        observer.observe(root, { childList: true, subtree: true, characterData: true });
                    } else {
                        setTimeout(startObserver, 10);
                    }
                };
                startObserver();

                // Reparse when back online
                window.addEventListener('online', function () {
                    window.scheduleTwemojiParse(document.getElementById('root') || document.body);
                });

                // One delayed pass after initial React mount
                setTimeout(function () {
                    window.scheduleTwemojiParse(document.getElementById('root') || document.body);
                }, 250);
            }

            // If Twemoji already loaded, init now. Otherwise wait for it.
            if (window.twemoji) {
                initTwemoji();
            } else if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
                // Wait for async script to load
                var checkInterval = setInterval(function () {
                    if (window.twemoji) {
                        clearInterval(checkInterval);
                        initTwemoji();
                    }
                }, 20);
                // Timeout after 5s
                setTimeout(function () { clearInterval(checkInterval); }, 5000);
            }
            // Else: not needed, stubs already set
        })();
    </script>

    <!-- libs with defer and priority for optimal loading -->
    <!-- React (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–Ω–¥–ª) - 152-–§–ó compliant, –±–µ–∑ CDN -->
    <!-- –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –°–ò–ù–•–†–û–ù–ù–û –ø–µ—Ä–µ–¥ defer-—Å–∫—Ä–∏–ø—Ç–∞–º–∏ (blocking script) -->
    <!-- –°–æ–±–∏—Ä–∞–µ—Ç—Å—è: npx esbuild src/react-globals-sync.ts --bundle --format=iife --minify -->
    <script src="react-bundle.js"></script>
    <!-- Dark theme interceptor ‚Äî patches React.createElement for CSS var colors -->
    <script src="heys_dark_theme_interceptor.js"></script>
    <!-- Supabase CDN ‚Äî –£–î–ê–õ–Å–ù 2025-12-24 (152-–§–ó compliance)
         –ü—Ä–∏—á–∏–Ω–∞: SDK –¥–µ–ª–∞–ª –∑–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–µ—Ä–∞–º Supabase (–ì–µ—Ä–º–∞–Ω–∏—è), 
         –Ω–∞—Ä—É—à–∞—è —Å—Ç.18 —á.5 152-–§–ó –æ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –ü–î–Ω.
         –ó–∞–º–µ–Ω–∞: YandexAPI (heys_yandex_api_v1.js) ‚Üí api.heyslab.ru
    -->

    <!-- üöÄ BOOT BUNDLES v9.0 (2026-02-25): 151 defer-—Ñ–∞–π–ª ‚Üí 5 bundle-—Ç–µ–≥–æ–≤
         –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: node scripts/bundle-legacy.mjs  (pnpm bundle:legacy)
         –°–æ—Å—Ç–∞–≤ –∏ —Ö–µ—à–∏: bundle-manifest.json
         –•–µ—à –≤ –∏–º–µ–Ω–∏ = –≤–µ—á–Ω—ã–π –∫—ç—à (cache-first SW). -->
    <script defer src="boot-core.bundle.e0cfd58e1796.js" fetchpriority="high"></script>
    <script defer src="boot-calc.bundle.bb8a3a4c781b.js"></script>
    <script defer src="boot-day.bundle.7320c50778ec.js"></script>
    <script defer src="boot-app.bundle.bc6fb633ba7c.js"></script>
    <script defer src="boot-init.bundle.01e94cb6ddd3.js"
        onerror="window.__heysShowRecoveryUI && window.__heysShowRecoveryUI('CRITICAL_SCRIPT_LOAD: boot-init.bundle')"></script>

    <!-- PERF: Detect returning user (localStorage has profile) ‚Üí skip card unfold animations -->
    <script>
        (function () {
            try {
                var found = false;
                for (var i = 0; i < localStorage.length; i++) {
                    var k = localStorage.key(i);
                    if (k && k.indexOf('heys_') === 0 && k.indexOf('profile') !== -1) {
                        var v = localStorage.getItem(k);
                        if (v && v.length > 10) { found = true; break; }
                    }
                }
                if (found) window.__heysHasLocalData = true;
            } catch (e) { /* private browsing / quota */ }
        })();
    </script>

    <!-- üöÄ PERF v9.0 (2026-02-25): Post-boot ‚Üí 3 –±–∞–Ω–¥–ª–∞ –≤–º–µ—Å—Ç–æ 93 —Ñ–∞–π–ª–æ–≤.
         93 —Ñ–∞–π–ª–∞ ‚Üí postboot-1-game + postboot-2-insights + postboot-3-ui
         –ó–∞–≥—Ä—É–∑–∫–∞: sequential onload-chain –ø–æ—Å–ª–µ window.__heysAppReady
         –•–µ—à –≤ –∏–º–µ–Ω–∏ = –≤–µ—á–Ω—ã–π –∫—ç—à (cache-first SW). -->
    <script>
        (function () {
            var POST_BOOT_BUNDLES = [
                'postboot-1-game.bundle.3981d9991b03.js',
                'postboot-2-insights.bundle.15ce93090754.js',
                'postboot-3-ui.bundle.d0c9bf9edcdc.js'
            ];
            var idx = 0;
            var total = POST_BOOT_BUNDLES.length;

            function loadNext() {
                if (idx >= total) {
                    console.info('[HEYS.postboot] ‚úÖ All ' + total + ' post-boot bundles loaded');
                    window.__heysPerfMark && window.__heysPerfMark('PostBoot: all bundles loaded');
                    window.__heysPostbootDone = true;
                    return;
                }
                var src = POST_BOOT_BUNDLES[idx++];
                var s = document.createElement('script');
                s.src = src;
                s.onload = s.onerror = function () {
                    setTimeout(loadNext, 0);
                };
                document.head.appendChild(s);
            }

            var waitChecks = 0;
            function waitForAppReady() {
                waitChecks++;
                if (window.__heysAppReady) {
                    console.info('[HEYS.postboot] üöÄ appReady detected, loading ' + total + ' post-boot bundles');
                    window.__heysPerfMark && window.__heysPerfMark('PostBoot: bundle load started');
                    setTimeout(loadNext, window.__heysHasLocalData ? 0 : 50);
                    return;
                }
                if (waitChecks > 600) {
                    console.warn('[HEYS.postboot] ‚ö†Ô∏è appReady timeout, loading post-boot bundles anyway');
                    setTimeout(loadNext, 0);
                    return;
                }
                setTimeout(waitForAppReady, 100);
            }
            setTimeout(waitForAppReady, 200);
        })();
    </script>

    <!-- Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ heys_platform_apis_v1.js ‚Üí registerServiceWorker() -->
</body>

</html>