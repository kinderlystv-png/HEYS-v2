<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HEYS Nutrition Tracker - Production</title>
    
    <!-- Critical CSS inline for instant rendering -->
    <style>
      :root {
        --bg: #ffffff;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --acc: #2563eb;
        --acc-contrast: #ffffff;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--text);
        font-size: 13px;
        line-height: 1.35;
      }
      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .app-header {
        background: var(--acc);
        color: var(--acc-contrast);
        padding: 1rem;
        text-align: center;
      }
      .app-main {
        flex: 1;
        padding: 1rem;
      }
    </style>
    
    <!-- HTTP/2 + Resource hints for optimal performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- HTTP/2 Server Push hints -->
    <link rel="preload" href="https://unpkg.com/react@18/umd/react.development.js" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.development.js" as="script" crossorigin="anonymous">
    
    <!-- Critical resource preloading with priority hints -->
    <link rel="preload" href="heys_core_v12.js" as="script" fetchpriority="high">
    <link rel="preload" href="heys_performance_monitor.js" as="script" fetchpriority="high">
    <link rel="preload" href="heys_analytics_ui.js" as="script" fetchpriority="low">
    
    <!-- Resource hints for better caching -->
    <link rel="prefetch" href="heys_storage_supabase_v1.js">
    <link rel="prefetch" href="heys_models_v1.js">
    
    <!-- Load non-critical CSS asynchronously -->
    <link rel="preload" href="styles/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="styles/main.css"></noscript>
  </head>
  <body>
    <div id="root"></div>

    <!-- libs with defer and priority for optimal loading -->
    <script defer src="https://unpkg.com/react@18/umd/react.development.js" fetchpriority="high" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" fetchpriority="high" crossorigin="anonymous"></script>
    <script defer src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js" fetchpriority="low" crossorigin="anonymous"></script>

    <!-- app modules with defer and optimized priority -->
    <script defer src="heys_performance_monitor.js" fetchpriority="high"></script>
    <script defer src="heys_core_v12.js" fetchpriority="high"></script>
    <script defer src="heys_analytics_ui.js" fetchpriority="low"></script>
    <script defer src="heys_storage_supabase_v1.js?v=15" fetchpriority="low"></script>
    <script defer src="heys_models_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_storage_layer_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_day_v12.js?v=2" fetchpriority="low"></script>
    <script defer src="heys_user_v12.js" fetchpriority="low"></script>
    <script defer src="heys_reports_v12.js" fetchpriority="low"></script>

    <script>
      // Service Worker Registration для Performance Optimization
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('✅ SW: Registered successfully', registration.scope);
            })
            .catch((error) => {
              console.log('❌ SW: Registration failed', error);
            });
        });
      }

      (function () {
        window.HEYS = window.HEYS || {};
        // Wait for React to load
        let reactCheckCount = 0;
        function initializeApp() {
          if (!window.React || !window.ReactDOM) {
            reactCheckCount++;
            if (reactCheckCount === 1 || reactCheckCount % 10 === 0) {
              console.log('⏳ Waiting for React to load...');
            }
            setTimeout(initializeApp, 100);
            return;
          }
          
          console.log('✅ React loaded, initializing app...');
          const React = window.React,
            ReactDOM = window.ReactDOM;
          const { useState, useEffect } = React;

        // init cloud (safe if no cloud module)
        if (window.HEYS.cloud && typeof HEYS.cloud.init === 'function') {
          HEYS.cloud.init({
            url: 'https://ukqolcziqcuplqfgrmsh.supabase.co',
            anonKey:
              'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcW9sY3ppcWN1cGxxZmdybXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTE1NDUsImV4cCI6MjA3MDgyNzU0NX0.Nzd8--PyGMJvIHqFoCQKNUOwpxnrAZuslQHtAjcE1Ds',
          });
        }

        // Обёртка для DayTab: при каждом открытии вкладки day — подгружает актуальные данные из облака
        function DayTabWithCloudSync(props) {
          const { clientId, products } = props;
          const [loading, setLoading] = React.useState(true);
          React.useEffect(() => {
            let cancelled = false;
            const cloud = window.HEYS && window.HEYS.cloud;
            const finish = () => {
              if (!cancelled) setLoading(false);
            };
            if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
              const need =
                typeof cloud.shouldSyncClient === 'function'
                  ? cloud.shouldSyncClient(clientId, 4000)
                  : true;
              if (need) {
                setLoading(true);
                cloud.bootstrapClientSync(clientId).then(finish);
              } else finish();
            } else {
              finish();
            }
            return () => {
              cancelled = true;
            };
          }, [clientId]);
          if (loading)
            return React.createElement(
              'div',
              { className: 'muted', style: { padding: 24 } },
              'Загрузка данных клиента...',
            );
          return React.createElement(window.HEYS.DayTab, { products });
        }

        // Обёртка для Ration: при каждом открытии вкладки рацион — подгружает продукты из облака
        function RationTabWithCloudSync(props) {
          const { clientId, setProducts, products } = props;
          const [loading, setLoading] = React.useState(true);
          React.useEffect(() => {
            let cancelled = false;
            if (
              clientId &&
              window.HEYS.cloud &&
              typeof window.HEYS.cloud.bootstrapClientSync === 'function'
            ) {
              setLoading(true);
              window.HEYS.cloud.bootstrapClientSync(clientId).then(() => {
                if (!cancelled) {
                  const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                    ? window.HEYS.utils.lsGet('heys_products', [])
                    : [];
                  setProducts(loadedProducts);
                  setLoading(false);
                }
              });
            } else {
              setLoading(false);
            }
            return () => {
              cancelled = true;
            };
          }, [clientId]);
          if (loading)
            return React.createElement(
              'div',
              { className: 'muted', style: { padding: 24 } },
              'Загрузка продуктов клиента...',
            );
          return React.createElement(window.HEYS.Ration, { products, setProducts });
        }

        // Обёртка для User: при каждом открытии вкладки данные пользователя — подгружает профиль и зоны из облака
        function UserTabWithCloudSync(props) {
          const { clientId } = props;
          const [loading, setLoading] = React.useState(true);
          React.useEffect(() => {
            let cancelled = false;
            if (
              clientId &&
              window.HEYS.cloud &&
              typeof window.HEYS.cloud.bootstrapClientSync === 'function'
            ) {
              setLoading(true);
              window.HEYS.cloud.bootstrapClientSync(clientId).then(() => {
                if (!cancelled) setLoading(false);
              });
            } else {
              setLoading(false);
            }
            return () => {
              cancelled = true;
            };
          }, [clientId]);
          if (loading)
            return React.createElement(
              'div',
              { className: 'muted', style: { padding: 24 } },
              'Загрузка профиля клиента...',
            );
          return React.createElement(window.HEYS.UserTab, {});
        }

        function App() {
          const ONE_CURATOR_MODE = true;
          const [tab, setTab] = useState('ration');
          // ...все остальные useState...
          // useEffect автосмены клиента — ниже всех useState!
          const U = window.HEYS.utils || { lsGet: (k, d) => d, lsSet: () => {} };
          const [products, setProducts] = useState([]);
          const [reportsRefresh, setReportsRefresh] = useState(0);

          const cloud = window.HEYS.cloud || {};
          const [status, setStatus] = useState(
            typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline',
          );
          const [syncVer, setSyncVer] = useState(0);
          // === Clients (selector + persistence) ===
          const [clients, setClients] = useState([]);
          const [clientId, setClientId] = useState('');
          const [newName, setNewName] = useState('');
          const [cloudUser, setCloudUser] = useState(null);

          // Получить клиентов куратора из Supabase
          async function fetchClientsFromCloud(curatorId) {
            if (!cloud.client || !curatorId) return [];
            const { data, error } = await cloud.client
              .from('clients')
              .select('id, name')
              .eq('curator_id', curatorId)
              .order('updated_at', { ascending: true });
            if (error) {
              console.error('Ошибка загрузки клиентов:', error);
              return [];
            }
            return data || [];
          }

          // Добавить клиента в Supabase
          async function addClientToCloud(name) {
            if (!cloud.client || !cloudUser || !cloudUser.id) {
              console.warn('addClientToCloud: отсутствует client или cloudUser', {
                hasClient: !!cloud.client,
                hasCloudUser: !!cloudUser,
                cloudUserId: cloudUser?.id,
              });
              return;
            }

            const userId = cloudUser.id; // Сохраняем локально для безопасности
            const { data, error } = await cloud.client
              .from('clients')
              .insert([
                { name: (name || '').trim() || `Клиент ${clients.length + 1}`, curator_id: userId },
              ])
              .select('id, name')
              .single();
            if (error) {
              console.error('Ошибка создания клиента:', error);
              alert('Ошибка создания клиента: ' + error.message);
              return;
            }
            // После создания — обновить список
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
            setClientId(data.id);
          }

          // Переименовать клиента (Supabase)
          async function renameClient(id, name) {
            if (!cloud.client || !cloudUser || !cloudUser.id) return;
            const userId = cloudUser.id; // Сохраняем локально
            await cloud.client.from('clients').update({ name }).eq('id', id);
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
          }

          // Удалить клиента (Supabase)
          async function removeClient(id) {
            if (!cloud.client || !cloudUser || !cloudUser.id) return;
            const userId = cloudUser.id; // Сохраняем локально
            await cloud.client.from('clients').delete().eq('id', id);
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
            if (clientId === id) setClientId('');
          }

          // Автопереключение на вкладку статистики дня при выборе клиента
          useEffect(() => {
            if (clientId) setTab('day');
          }, [clientId]);

          // Fallback: если после входа продукты пустые, пробуем взять из localStorage через utils
          useEffect(() => {
            if (products.length === 0) {
              try {
                const stored =
                  (window.HEYS &&
                    window.HEYS.utils &&
                    window.HEYS.utils.lsGet &&
                    window.HEYS.utils.lsGet('heys_products', [])) ||
                  [];
                if (Array.isArray(stored) && stored.length) setProducts(stored);
              } catch (e) {}
            }
          }, [products.length]);

          // При смене клиента сохраняем в localStorage (для совместимости)
          useEffect(() => {
            if (clientId) {
              U.lsSet('heys_client_current', clientId);
              window.HEYS = window.HEYS || {};
              window.HEYS.currentClientId = clientId;
              // Подгружаем данные клиента из Supabase и обновляем продукты
              if (cloud && typeof cloud.bootstrapClientSync === 'function') {
                cloud.bootstrapClientSync(clientId).then(() => {
                  // всегда используем HEYS.utils.lsGet для clientId-специфичного ключа
                  const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                    ? window.HEYS.utils.lsGet('heys_products', [])
                    : [];
                  setProducts(loadedProducts);
                  setSyncVer((v) => v + 1);
                });
              } else {
                setSyncVer((v) => v + 1);
              }
            }
          }, [clientId]);

          // Слушаем событие обновления продуктов из облака
          useEffect(() => {
            const handleProductsUpdate = (event) => {
              const { products } = event.detail;
              setProducts(products);
              setSyncVer((v) => v + 1);
            };

            window.addEventListener('heysProductsUpdated', handleProductsUpdate);
            return () => window.removeEventListener('heysProductsUpdated', handleProductsUpdate);
          }, []);

          // Обертка для сохранения данных клиента в облако
          window.HEYS = window.HEYS || {};
          window.HEYS.saveClientKey = function (k, v) {
            if (clientId && cloud && typeof cloud.saveClientKey === 'function') {
              cloud.saveClientKey(clientId, k, v);
            }
          };
          // overlay (no early return, to keep hooks order stable)
          // One-time migration of old, namespaced client lists -> global
          // После входа — загрузить клиентов куратора
          useEffect(() => {
            if (cloudUser && cloudUser.id) {
              fetchClientsFromCloud(cloudUser.id).then(setClients);
            }
          }, [cloudUser]);

          // Создать тестовых клиентов
          async function createTestClients() {
            if (!cloud.client || !cloudUser || !cloudUser.id) return;
            const userId = cloudUser.id; // Сохраняем локально
            const testClients = [{ name: 'Иван Петров' }, { name: 'Анна Сидорова' }];

            for (const testClient of testClients) {
              try {
                await cloud.client
                  .from('clients')
                  .insert([{ name: testClient.name, curator_id: userId }]);
              } catch (error) {
                console.error('Ошибка создания тестового клиента:', error);
              }
            }

            // Обновить список клиентов
            const updated = await fetchClientsFromCloud(userId);
            setClients(updated);
          }

          const gate = !clientId
            ? React.createElement(
                'div',
                { className: 'modal-backdrop' },
                React.createElement(
                  'div',
                  { className: 'modal' },
                  React.createElement(
                    'div',
                    {
                      className: 'row',
                      style: { justifyContent: 'space-between', marginBottom: '6px' },
                    },
                    React.createElement('div', { style: { fontWeight: 600 } }, 'Выберите клиента'),
                    React.createElement('span', { className: 'muted' }, `Всего: ${clients.length}`),
                  ),
                  React.createElement(
                    'div',
                    { style: { maxHeight: 260, overflow: 'auto', marginBottom: 8 } },
                    clients.length
                      ? clients.map((c) =>
                          React.createElement(
                            'div',
                            {
                              key: c.id,
                              className: 'row',
                              style: { justifyContent: 'space-between' },
                            },
                            React.createElement(
                              'div',
                              null,
                              React.createElement('div', { style: { fontWeight: 600 } }, c.name),
                              React.createElement('div', { className: 'muted' }, c.id),
                            ),
                            React.createElement(
                              'div',
                              { className: 'row' },
                              React.createElement(
                                'button',
                                { className: 'btn', onClick: () => setClientId(c.id) },
                                'Выбрать',
                              ),
                              React.createElement(
                                'button',
                                {
                                  className: 'btn',
                                  onClick: () => {
                                    const nm = prompt('Новое имя', c.name) || c.name;
                                    renameClient(c.id, nm);
                                  },
                                },
                                'Переимен.',
                              ),
                              React.createElement(
                                'button',
                                {
                                  className: 'btn',
                                  onClick: () => {
                                    if (confirm('Удалить клиента?')) removeClient(c.id);
                                  },
                                },
                                'Удалить',
                              ),
                            ),
                          ),
                        )
                      : React.createElement(
                          'div',
                          { className: 'muted' },
                          'Ещё нет ни одного клиента',
                        ),
                  ),
                  React.createElement(
                    'div',
                    { className: 'row' },
                    React.createElement('input', {
                      placeholder: 'Имя нового клиента',
                      value: newName,
                      onChange: (e) => setNewName(e.target.value),
                    }),
                    React.createElement(
                      'button',
                      { className: 'btn acc', onClick: () => addClientToCloud(newName) },
                      'Создать и выбрать',
                    ),
                  ),
                  React.createElement(
                    'div',
                    { className: 'row', style: { marginTop: 8 } },
                    React.createElement(
                      'button',
                      { className: 'btn secondary', onClick: createTestClients },
                      'Создать тестовых клиентов',
                    ),
                  ),
                ),
              )
            : null;

          const [email, setEmail] = useState('poplanton@mail.ru');
          const [pwd, setPwd] = useState('007670');

          useEffect(() => {
            if (cloud && typeof cloud.bootstrapSync === 'function') {
              cloud
                .bootstrapSync()
                .then(() => {
                  setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'online');
                  setProducts(
                    Array.isArray(U.lsGet('heys_products', [])) ? U.lsGet('heys_products', []) : [],
                  );
                  setSyncVer((v) => v + 1);
                })
                .catch(() => {
                  setStatus('offline');
                });
            }
          }, []);

          // При полной перезагрузке панели — bootstrap продуктов из облака, если выбран клиент
          useEffect(() => {
            if (clientId && cloud && typeof cloud.bootstrapClientSync === 'function') {
              cloud.bootstrapClientSync(clientId).then(() => {
                const loadedProducts = Array.isArray(window.HEYS.utils.lsGet('heys_products', []))
                  ? window.HEYS.utils.lsGet('heys_products', [])
                  : [];
                setProducts(loadedProducts);
                setSyncVer((v) => v + 1);
              });
            }
          }, [clientId]);

          // debounced save products
          const saveTimerRef = React.useRef(null);
          useEffect(() => {
            if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
            saveTimerRef.current = setTimeout(() => {
              try {
                window.HEYS.saveClientKey('heys_products', products);
              } catch (e) {}
            }, 300);
            return () => {
              if (saveTimerRef.current) {
                clearTimeout(saveTimerRef.current);
                saveTimerRef.current = null;
              }
            };
          }, [products]);

          // auto sign-in in single-curator mode
          useEffect(() => {
            if (ONE_CURATOR_MODE && status !== 'online') {
              doSignIn();
            }
          }, [ONE_CURATOR_MODE, status]);

          async function doSignIn() {
            try {
              if (!email || !pwd) {
                alert('Введите email и пароль');
                return;
              }
              setStatus('signin');
              if (cloud && typeof cloud.signIn === 'function') {
                const result = await cloud.signIn(email, pwd);
                if (result.error) {
                  alert('Ошибка входа: ' + (result.error.message || result.error));
                  setStatus('offline');
                  return;
                }
                setCloudUser(result.user);
              }
              setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'online');
              // Загружаем продукты после sign-in
              const loadedProducts = Array.isArray(U.lsGet('heys_products', []))
                ? U.lsGet('heys_products', [])
                : [];
              setProducts(loadedProducts);
              setSyncVer((v) => v + 1);
            } catch (e) {
              setStatus('offline');
              alert('Ошибка входа: ' + (e && e.message ? e.message : e));
            }
          }
          async function doSignOut() {
            try {
              if (cloud && typeof cloud.signOut === 'function') await cloud.signOut();
            } catch (e) {}
            setStatus(typeof cloud.getStatus === 'function' ? cloud.getStatus() : 'offline');
            setProducts([]);
            setSyncVer((v) => v + 1);
          }

          return React.createElement(
            React.Fragment,
            null,
            gate,
            React.createElement(
              'div',
              { className: 'wrap' },
              React.createElement(
                'div',
                { className: 'hdr' },
                React.createElement('div', null, 'HEYS — панель куратора'),
                ONE_CURATOR_MODE
                  ? React.createElement(
                      'div',
                      { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                      React.createElement(
                        'span',
                        { className: 'status ' + (status === 'online' ? 'ok' : 'err') },
                        'cloud: ' + String(status || ''),
                      ),
                      window.HEYS.analyticsUI
                        ? React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                        : null,
                    )
                  : React.createElement(
                      'div',
                      { className: 'login' },
                      React.createElement('input', {
                        placeholder: 'email',
                        value: email,
                        onChange: (e) => setEmail(e.target.value),
                      }),
                      React.createElement('input', {
                        placeholder: 'пароль',
                        type: 'password',
                        value: pwd,
                        onChange: (e) => setPwd(e.target.value),
                      }),
                      React.createElement(
                        'button',
                        { className: 'btn', onClick: doSignIn },
                        'Войти',
                      ),
                      React.createElement(
                        'button',
                        { className: 'btn secondary', onClick: doSignOut },
                        'Выйти',
                      ),
                      React.createElement(
                        'span',
                        { className: 'status ' + (status === 'online' ? 'ok' : 'err') },
                        String(status || ''),
                      ),
                      window.HEYS.analyticsUI
                        ? React.createElement(window.HEYS.analyticsUI.AnalyticsButton)
                        : null,
                    ),
                React.createElement(
                  'div',
                  { className: 'row' },
                  clientId
                    ? React.createElement(
                        React.Fragment,
                        null,
                        React.createElement(
                          'span',
                          { className: 'muted', style: { marginRight: 8 } },
                          'Клиент:',
                        ),
                        React.createElement(
                          'span',
                          { style: { fontWeight: 600, marginRight: 8 } },
                          clients.find((c) => c.id === clientId)?.name || clientId,
                        ),
                        React.createElement(
                          'button',
                          { className: 'btn', onClick: () => setClientId('') },
                          'Сменить',
                        ),
                      )
                    : null,
                ),
              ),
              React.createElement(
                'div',
                { className: 'tabs' },
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'ration' ? 'active' : ''),
                    onClick: () => setTab('ration'),
                  },
                  'Рацион',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'day' ? 'active' : ''),
                    onClick: () => setTab('day'),
                  },
                  'Статистика дня',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'reports' ? 'active' : ''),
                    onClick: () => {
                      setTab('reports');
                      setReportsRefresh(Date.now());
                    },
                  },
                  'Отчётность',
                ),
                React.createElement(
                  'div',
                  {
                    className: 'tab ' + (tab === 'user' ? 'active' : ''),
                    onClick: () => setTab('user'),
                  },
                  'Данные пользователя',
                ),
              ),
              tab === 'ration'
                ? React.createElement(RationTabWithCloudSync, {
                    key: 'ration' + syncVer + '_' + String(clientId || ''),
                    products,
                    setProducts,
                    clientId,
                  })
                : tab === 'day'
                  ? React.createElement(DayTabWithCloudSync, {
                      key: 'day' + syncVer + '_' + String(clientId || ''),
                      products,
                      clientId,
                    })
                  : tab === 'user'
                    ? React.createElement(UserTabWithCloudSync, {
                        key: 'user' + syncVer + '_' + String(clientId || ''),
                        clientId,
                      })
                    : React.createElement(window.HEYS.ReportsTab, {
                        key:
                          'reports' + syncVer + '_' + String(clientId || '') + '_' + reportsRefresh,
                        products,
                      }),
            ),
          );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        }
        
        // Start initialization
        initializeApp();
      })();
    </script>
  </body>
</html>
