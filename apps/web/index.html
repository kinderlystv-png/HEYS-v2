<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <!-- üîç PWA Debug: Boot timing logger (saved to localStorage for mobile diagnosis) -->
    <script>
      (function() {
        window.__heysBootLog = [];
        window.__heysBootStart = Date.now();
        window.__heysLog = function(msg) {
          var entry = { t: Date.now() - window.__heysBootStart, m: msg };
          window.__heysBootLog.push(entry);
          try {
            localStorage.setItem('heys_boot_log', JSON.stringify(window.__heysBootLog.slice(-50)));
          } catch(e) {}
          console.log('[BOOT +' + entry.t + 'ms]', msg);
        };
        window.__heysLog('HTML parsing started');
        
        // Check if PWA standalone mode
        var isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        window.__heysLog('PWA standalone: ' + isStandalone);
      })();
    </script>
    <!-- Prevent FOUC: Apply theme before CSS loads -->
    <script>
      (function() {
        var t = localStorage.getItem('heys_theme');
        var isDark = t === 'dark' || (t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.setAttribute('data-theme', 'dark');
        window.__heysLog && window.__heysLog('Theme applied: ' + (isDark ? 'dark' : 'light'));
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>HEYS Nutrition Tracker - Production</title>

    <!-- Tailwind CSS (production-friendly —á–µ—Ä–µ–∑ Vite/PostCSS) -->
    <link rel="stylesheet" href="/src/tailwind.css" />

    <!-- Critical CSS for instant rendering -->
    <link rel="stylesheet" href="styles/critical.css" />

    <!-- HTTP/2 + Resource hints for optimal performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

    <!-- HTTP/2 Server Push hints -->
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
      as="script"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"
      as="script"
      crossorigin="anonymous"
    />

    <!-- Resource hints for better caching (prefetch, not preload to avoid warnings) -->
    <link rel="prefetch" href="heys_core_v12.js" />
    <link rel="prefetch" href="heys_simple_analytics.js" />
    <link rel="prefetch" href="heys_storage_supabase_v1.js" />
    <link rel="prefetch" href="heys_models_v1.js" />

    <!-- Load non-critical CSS asynchronously -->
    <link
      rel="preload"
      href="styles/main.css?v=20"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript><link rel="stylesheet" href="styles/main.css?v=20" /></noscript>

    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    
    <!-- PWA Support (iOS + Android) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="HEYS" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
  </head>
  <body class="emoji-system">
    <!-- üîç vConsole –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ (–≤–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ?debug=1 –∏–ª–∏ localStorage heys_debug=1) -->
    <script>
      (function() {
        window.__heysLog && window.__heysLog('Body parsing started');
        var debug = new URLSearchParams(window.location.search).get('debug') === '1' || localStorage.getItem('heys_debug') === '1';
        if (debug) {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/vconsole@latest/dist/vconsole.min.js';
          s.onload = function() {
            new window.VConsole({ theme: 'dark' });
            window.__heysLog && window.__heysLog('vConsole loaded');
          };
          document.head.appendChild(s);
        }
      })();
    </script>
    <div id="root"></div>

    <!-- Emoji style initialization - runs BEFORE twemoji loads -->
    <script>
      (function() {
        // Detect platform - Twemoji only needed on Windows/Linux
        var ua = navigator.userAgent || '';
        var isWindows = /Windows/i.test(ua);
        var isLinux = /Linux/i.test(ua) && !/Android/i.test(ua);
        var needsTwemoji = isWindows || isLinux;
        
        window.heysPlatformNeedsTwemoji = needsTwemoji;
        
        // Get stored preference or auto-detect
        var stored = localStorage.getItem('heys_emoji_style');
        if (stored) {
          stored = stored.replace(/"/g, '');
        }
        
        // Auto mode: use twemoji on Windows/Linux, system on Mac/iOS/Android
        if (!stored || stored === 'auto' || stored === 'android' || stored === 'apple' || stored === 'null') {
          stored = needsTwemoji ? 'twemoji' : 'system';
          localStorage.setItem('heys_emoji_style', stored);
        }
        
        // Apply class
        document.body.classList.remove('emoji-system', 'emoji-twemoji');
        document.body.classList.add('emoji-' + stored);
        
        // Global state
        window.twemojiReady = false;
        window.heysEmojiStyle = stored;
        window.applyTwemoji = function() {};
        window.scheduleTwemojiParse = function() {};
      })();
    </script>
    
    <!-- Twemoji library - load only if needed (async to avoid parser-blocking) -->
    <script>
      if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
        (function() {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js';
          s.async = false; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          s.onload = function() { window.twemojiLoaded = true; };
          document.head.appendChild(s);
        })();
      }
    </script>
    
    <!-- Twemoji initialization - runs AFTER twemoji loads (only if loaded) -->
    <script>
      (function() {
        // Setup function to initialize Twemoji
        function initTwemoji() {
          if (!window.twemoji) return;
          
          window.twemojiReady = true;
          
          // Apply Twemoji parsing
          window.applyTwemoji = function(el) {
            if (window.heysEmojiStyle !== 'twemoji') return;
            if (!window.twemoji) return;
            // –ù–µ –ø–∞—Ä—Å–∏—Ç—å —ç–º–æ–¥–∑–∏ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–µ—Ç–∏ ‚Äî –∏–Ω–∞—á–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ SVG
            if (!navigator.onLine) return;
            
            // Ensure class is set
            if (!document.body.classList.contains('emoji-twemoji')) {
              document.body.classList.add('emoji-twemoji');
            }
            
            var target = el || document.body;
            twemoji.parse(target, {
              folder: 'svg',
              ext: '.svg',
              base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/'
            });
          };
          
          // Debounced parse
          var parseTimeout = null;
          window.scheduleTwemojiParse = function() {
            // –ù–µ —Å—Ç–∞–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏
            if (!navigator.onLine) return;
            if (parseTimeout) clearTimeout(parseTimeout);
            parseTimeout = setTimeout(window.applyTwemoji, 30);
          };
          
          // Parse immediately
          window.applyTwemoji();
          
          // MutationObserver for dynamic content
          var observer = new MutationObserver(function() {
            window.scheduleTwemojiParse();
          });
          
          // Wait for root to exist
          var startObserver = function() {
            var root = document.getElementById('root');
            if (root) {
              observer.observe(root, { childList: true, subtree: true });
            } else {
              setTimeout(startObserver, 10);
            }
          };
          startObserver();
          
          // Reparse when back online
          window.addEventListener('online', function() {
            window.applyTwemoji();
          });
          
          // Aggressive reparsing during page load
          setTimeout(window.applyTwemoji, 100);
          setTimeout(window.applyTwemoji, 300);
          setTimeout(window.applyTwemoji, 600);
          setTimeout(window.applyTwemoji, 1000);
          setTimeout(window.applyTwemoji, 2000);
          setTimeout(window.applyTwemoji, 4000);
        }
        
        // If Twemoji already loaded, init now. Otherwise wait for it.
        if (window.twemoji) {
          initTwemoji();
        } else if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
          // Wait for async script to load
          var checkInterval = setInterval(function() {
            if (window.twemoji) {
              clearInterval(checkInterval);
              initTwemoji();
            }
          }, 20);
          // Timeout after 5s
          setTimeout(function() { clearInterval(checkInterval); }, 5000);
        }
        // Else: not needed, stubs already set
      })();
    </script>

    <!-- libs with defer and priority for optimal loading -->
    <!-- React CDN (jsDelivr - more reliable in RU) -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <!-- Supabase CDN -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"
      fetchpriority="low"
      crossorigin="anonymous"
    ></script>

    <!-- app modules with defer and optimized priority -->
    <script defer src="heys_dev_utils.js" fetchpriority="high"></script>
    <script defer src="heys_simple_analytics.js" fetchpriority="high"></script>
    <!-- Smart search with typo correction, synonyms, phonetic (—ë‚Üí–µ) -->
    <script defer src="heys_smart_search_v2.js?v=1" fetchpriority="high"></script>
    <script defer src="heys_core_v12.js" fetchpriority="high"></script>
    <script defer src="heys_storage_supabase_v1.js?v=29" fetchpriority="low"></script>
    <script defer src="heys_models_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_storage_layer_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_wheel_picker.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_swipeable.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_pull_refresh.js?v=20" fetchpriority="low"></script>
    <!-- Centralized ratio zones logic -->
    <script defer src="heys_ratio_zones_v1.js?v=20" fetchpriority="low"></script>
    <!-- TDEE calculation module -->
    <script defer src="heys_tdee_v1.js?v=1" fetchpriority="low"></script>
    <!-- Sparkline utilities (curves, regression, caching) -->
    <script defer src="heys_sparkline_utils_v1.js?v=20" fetchpriority="low"></script>
    <!-- Gamification system (XP, levels, achievements) -->
    <script defer src="heys_gamification_v1.js?v=20" fetchpriority="low"></script>
    <!-- Day module split (Phase 2-4) -->
    <script defer src="heys_day_utils.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_day_hooks.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_day_pickers.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_advice_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_meal_optimizer_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_sounds_v1.js?v=20" fetchpriority="low"></script>
    <!-- Modular components -->
    <script defer src="heys_expandable_card_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_insulin_wave_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_cycle_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_refeed_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_predictive_insights_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_metabolic_intelligence_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_supplements_v1.js?v=1" fetchpriority="low"></script>
    <script defer src="heys_supplements_science_v1.js?v=1" fetchpriority="low"></script>
    <!-- StepModal system (modular step-based modals) -->
    <script defer src="heys_step_modal_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_steps_v1.js?v=21" fetchpriority="low"></script>
    <script defer src="heys_profile_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_meal_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_add_product_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_training_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_morning_checkin_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_confirm_modal_v1.js?v=20" fetchpriority="low"></script>
    <!-- End Day module split -->
    <script defer src="heys_day_v12.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_user_v12.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_reports_v12.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_data_overview_v1.js?v=20" fetchpriority="low"></script>
    <!-- Auth + Login (client phone+PIN, curator email+password) -->
    <script defer src="heys_auth_v1.js?v=1" fetchpriority="high"></script>
    <script defer src="heys_login_screen_v1.js?v=2" fetchpriority="high"></script>
    <script defer src="heys_app_v12.js?v=25" fetchpriority="high"></script>
    
    <!-- Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ heys_app_v12.js ‚Üí registerServiceWorker() -->
  </body>
</html>
