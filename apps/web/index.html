<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <!-- Prevent FOUC: Apply theme before CSS loads -->
    <script>
      (function() {
        var t = localStorage.getItem('heys_theme');
        var isDark = t === 'dark' || (t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.setAttribute('data-theme', 'dark');
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>HEYS Nutrition Tracker - Production</title>

    <!-- Tailwind CSS (production-friendly —á–µ—Ä–µ–∑ Vite/PostCSS) -->
    <link rel="stylesheet" href="/src/tailwind.css" />

    <!-- Critical CSS for instant rendering -->
    <link rel="stylesheet" href="styles/critical.css" />

    <!-- HTTP/2 + Resource hints for optimal performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

    <!-- HTTP/2 Server Push hints -->
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
      as="script"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"
      as="script"
      crossorigin="anonymous"
    />

    <!-- Resource hints for better caching (prefetch, not preload to avoid warnings) -->
    <link rel="prefetch" href="heys_core_v12.js" />
    <link rel="prefetch" href="heys_simple_analytics.js" />
    <link rel="prefetch" href="heys_storage_supabase_v1.js" />
    <link rel="prefetch" href="heys_models_v1.js" />

    <!-- Load non-critical CSS asynchronously -->
    <link
      rel="preload"
      href="styles/main.css?v=20"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript><link rel="stylesheet" href="styles/main.css?v=20" /></noscript>

    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    
    <!-- PWA Support (iOS + Android) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="HEYS" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
  </head>
  <body class="emoji-system">
    <!-- üöÄ PWA Splash Screen ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ React -->
    <div id="pwa-splash" style="
      position: fixed;
      inset: 0;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #434587 0%, #52A0D8 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: opacity 0.3s ease-out;
    ">
      <!-- Logo -->
      <div style="
        font-size: 56px;
        font-weight: 800;
        letter-spacing: 8px;
        margin-bottom: 12px;
        animation: logo-breathe 2s ease-in-out infinite;
      ">HEYS</div>
      <div id="splash-status" style="
        font-size: 14px;
        opacity: 0.8;
        margin-top: 8px;
        height: 20px;
      ">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      
      <!-- Progress bar -->
      <div style="
        width: 200px;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
        margin-top: 20px;
        overflow: hidden;
      ">
        <div id="splash-progress" style="
          height: 100%;
          width: 0%;
          background: linear-gradient(90deg, #10b981, #34d399);
          border-radius: 4px;
          animation: progress-fill 3s ease-out forwards;
        "></div>
      </div>
      
      <style>
        @keyframes logo-breathe {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.06); }
        }
        @keyframes progress-fill {
          0% { width: 0%; }
          20% { width: 25%; }
          50% { width: 60%; }
          80% { width: 85%; }
          100% { width: 95%; }
        }
      </style>
    </div>
    <script>
      // –°–∫—Ä—ã–≤–∞–µ–º splash –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ React –≥–æ—Ç–æ–≤
      window._pwaSplashHidden = false;
      window.hidePwaSplash = function() {
        if (window._pwaSplashHidden) return;
        window._pwaSplashHidden = true;
        
        var splash = document.getElementById('pwa-splash');
        var progress = document.getElementById('splash-progress');
        var status = document.getElementById('splash-status');
        
        if (splash) {
          // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ 100%
          if (progress) {
            progress.style.animation = 'none';
            progress.style.width = '100%';
            progress.style.transition = 'width 0.2s ease-out';
          }
          if (status) {
            status.textContent = '–ì–æ—Ç–æ–≤–æ!';
          }
          
          // –°–∫—Ä—ã–≤–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
          setTimeout(function() {
            splash.style.opacity = '0';
            setTimeout(function() { splash.remove(); }, 300);
          }, 200);
        }
      };
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
      window.updateSplashStatus = function(text) {
        var status = document.getElementById('splash-status');
        if (status && !window._pwaSplashHidden) {
          status.textContent = text;
        }
      };
      
      // Fallback: –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥ React –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
      setTimeout(function() {
        if (!window._pwaSplashHidden && !window.React) {
          window.updateSplashStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
          var progress = document.getElementById('splash-progress');
          if (progress) {
            progress.style.background = '#ef4444';
            progress.style.width = '100%';
          }
        }
      }, 15000);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ –º–µ—Ä–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
      var loadedModules = 0;
      window.moduleLoaded = function(name) {
        loadedModules++;
        if (loadedModules % 5 === 0) {
          window.updateSplashStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π... ' + loadedModules);
        }
      };
    </script>
    
    <div id="root"></div>

    <!-- Emoji style initialization - runs BEFORE twemoji loads -->
    <script>
      (function() {
        // Detect platform - Twemoji only needed on Windows/Linux
        var ua = navigator.userAgent || '';
        var isWindows = /Windows/i.test(ua);
        var isLinux = /Linux/i.test(ua) && !/Android/i.test(ua);
        var needsTwemoji = isWindows || isLinux;
        
        window.heysPlatformNeedsTwemoji = needsTwemoji;
        
        // Get stored preference or auto-detect
        var stored = localStorage.getItem('heys_emoji_style');
        if (stored) {
          stored = stored.replace(/"/g, '');
        }
        
        // Auto mode: use twemoji on Windows/Linux, system on Mac/iOS/Android
        if (!stored || stored === 'auto' || stored === 'android' || stored === 'apple' || stored === 'null') {
          stored = needsTwemoji ? 'twemoji' : 'system';
          localStorage.setItem('heys_emoji_style', stored);
        }
        
        // Apply class
        document.body.classList.remove('emoji-system', 'emoji-twemoji');
        document.body.classList.add('emoji-' + stored);
        
        // Global state
        window.twemojiReady = false;
        window.heysEmojiStyle = stored;
        window.applyTwemoji = function() {};
        window.scheduleTwemojiParse = function() {};
      })();
    </script>
    
    <!-- Twemoji library - load only if needed (async to avoid parser-blocking) -->
    <script>
      if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
        (function() {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js';
          s.async = false; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          s.onload = function() { window.twemojiLoaded = true; };
          document.head.appendChild(s);
        })();
      }
    </script>
    
    <!-- Twemoji initialization - runs AFTER twemoji loads (only if loaded) -->
    <script>
      (function() {
        // Setup function to initialize Twemoji
        function initTwemoji() {
          if (!window.twemoji) return;
          
          window.twemojiReady = true;
          
          // Apply Twemoji parsing
          window.applyTwemoji = function(el) {
            if (window.heysEmojiStyle !== 'twemoji') return;
            if (!window.twemoji) return;
            // –ù–µ –ø–∞—Ä—Å–∏—Ç—å —ç–º–æ–¥–∑–∏ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–µ—Ç–∏ ‚Äî –∏–Ω–∞—á–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ SVG
            if (!navigator.onLine) return;
            
            // Ensure class is set
            if (!document.body.classList.contains('emoji-twemoji')) {
              document.body.classList.add('emoji-twemoji');
            }
            
            var target = el || document.body;
            twemoji.parse(target, {
              folder: 'svg',
              ext: '.svg',
              base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/'
            });
          };
          
          // Debounced parse
          var parseTimeout = null;
          window.scheduleTwemojiParse = function() {
            // –ù–µ —Å—Ç–∞–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏
            if (!navigator.onLine) return;
            if (parseTimeout) clearTimeout(parseTimeout);
            parseTimeout = setTimeout(window.applyTwemoji, 30);
          };
          
          // Parse immediately
          window.applyTwemoji();
          
          // MutationObserver for dynamic content
          var observer = new MutationObserver(function() {
            window.scheduleTwemojiParse();
          });
          
          // Wait for root to exist
          var startObserver = function() {
            var root = document.getElementById('root');
            if (root) {
              observer.observe(root, { childList: true, subtree: true });
            } else {
              setTimeout(startObserver, 10);
            }
          };
          startObserver();
          
          // Reparse when back online
          window.addEventListener('online', function() {
            window.applyTwemoji();
          });
          
          // Aggressive reparsing during page load
          setTimeout(window.applyTwemoji, 100);
          setTimeout(window.applyTwemoji, 300);
          setTimeout(window.applyTwemoji, 600);
          setTimeout(window.applyTwemoji, 1000);
          setTimeout(window.applyTwemoji, 2000);
          setTimeout(window.applyTwemoji, 4000);
        }
        
        // If Twemoji already loaded, init now. Otherwise wait for it.
        if (window.twemoji) {
          initTwemoji();
        } else if (window.heysPlatformNeedsTwemoji || window.heysEmojiStyle === 'twemoji') {
          // Wait for async script to load
          var checkInterval = setInterval(function() {
            if (window.twemoji) {
              clearInterval(checkInterval);
              initTwemoji();
            }
          }, 20);
          // Timeout after 5s
          setTimeout(function() { clearInterval(checkInterval); }, 5000);
        }
        // Else: not needed, stubs already set
      })();
    </script>

    <!-- libs with defer and priority for optimal loading -->
    <!-- React CDN (jsDelivr - more reliable in RU) -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"
      fetchpriority="high"
      crossorigin="anonymous"
    ></script>
    <!-- Supabase CDN -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"
      fetchpriority="low"
      crossorigin="anonymous"
    ></script>

    <!-- app modules with defer and optimized priority -->
    <script defer src="heys_dev_utils.js" fetchpriority="high"></script>
    <script defer src="heys_simple_analytics.js" fetchpriority="high"></script>
    <script defer src="heys_core_v12.js" fetchpriority="high"></script>
    <script defer src="heys_storage_supabase_v1.js?v=29" fetchpriority="low"></script>
    <script defer src="heys_models_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_storage_layer_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_wheel_picker.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_swipeable.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_pull_refresh.js?v=20" fetchpriority="low"></script>
    <!-- Centralized ratio zones logic -->
    <script defer src="heys_ratio_zones_v1.js?v=20" fetchpriority="low"></script>
    <!-- TDEE calculation module -->
    <script defer src="heys_tdee_v1.js?v=1" fetchpriority="low"></script>
    <!-- Sparkline utilities (curves, regression, caching) -->
    <script defer src="heys_sparkline_utils_v1.js?v=20" fetchpriority="low"></script>
    <!-- Gamification system (XP, levels, achievements) -->
    <script defer src="heys_gamification_v1.js?v=20" fetchpriority="low"></script>
    <!-- Day module split (Phase 2-4) -->
    <script defer src="heys_day_utils.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_day_hooks.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_day_pickers.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_advice_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_meal_optimizer_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_sounds_v1.js?v=20" fetchpriority="low"></script>
    <!-- Modular components -->
    <script defer src="heys_expandable_card_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_insulin_wave_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_cycle_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_refeed_v1.js?v=20" fetchpriority="low"></script>
    <!-- StepModal system (modular step-based modals) -->
    <script defer src="heys_step_modal_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_steps_v1.js?v=21" fetchpriority="low"></script>
    <script defer src="heys_profile_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_meal_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_add_product_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_training_step_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_morning_checkin_v1.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_confirm_modal_v1.js?v=20" fetchpriority="low"></script>
    <!-- End Day module split -->
    <script defer src="heys_day_v12.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_user_v12.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_reports_v12.js?v=20" fetchpriority="low"></script>
    <script defer src="heys_data_overview_v1.js?v=20" fetchpriority="low"></script>
    <!-- Auth + Login (client phone+PIN, curator email+password) -->
    <script defer src="heys_auth_v1.js?v=1" fetchpriority="high"></script>
    <script defer src="heys_login_screen_v1.js?v=2" fetchpriority="high"></script>
    <script defer src="heys_app_v12.js?v=25" fetchpriority="high"></script>
    
    <!-- Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ heys_app_v12.js ‚Üí registerServiceWorker() -->
  </body>
</html>
