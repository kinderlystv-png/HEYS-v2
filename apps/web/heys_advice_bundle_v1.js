// heys_advice_bundle_v1.js â€” bundled advice modules (core + categories)
// âš ï¸ Auto-generated by scripts/bundle-advice.cjs. Do not edit manually.

// ===== Begin advice/_core.js =====
;/**
 * HEYS Advice Module v1 (Core)
 * ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¼Ğ½Ñ‹Ñ… ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² (core)
 * 
 * @file advice/_core.js
 * @version 1.2.0
 * @description Core-ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ¸ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² (Ğ±ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹)
 */

(function () {
    'use strict';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPER: Get product for item (by name first, then by id)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getProductForItem(item, pIndex) {
        if (!item || !pIndex) return null;
        // Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ñ‰ĞµĞ¼ Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ
        const nameKey = (item.name || '').trim().toLowerCase();
        if (nameKey && pIndex.byName) {
            const found = pIndex.byName.get(nameKey);
            if (found) return found;
        }
        // Fallback Ğ½Ğ° product_id Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        if (item.product_id != null && pIndex.byId) {
            const found = pIndex.byId.get(String(item.product_id).toLowerCase());
            if (found) return found;
        }
        // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ inline Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ°Ğ¼ item
        if (item.kcal100 !== undefined || item.protein100 !== undefined) {
            return item;
        }
        return null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const AdviceRules = window.HEYS && window.HEYS.adviceRules;
    if (!AdviceRules) {
        throw new Error('HEYS.adviceRules required');
    }

    const {
        MAX_ADVICES_PER_SESSION,
        ADVICE_COOLDOWN_MS,
        SESSION_KEY,
        TRACKING_KEY,
        PRIORITY,
        ADVICE_CACHE_TTL,
        MAX_ADVICES_PER_CATEGORY,
        THRESHOLDS,
        PRODUCT_CATEGORIES,
        DEDUPLICATION_RULES,
        TIME_RESTRICTIONS,
        ADVICE_CHAINS,
        STREAK_MILESTONES,
        QUICK_DISMISS_THRESHOLD_MS,
        DISMISS_PENALTY_FACTOR,
        TTL_CONFIG,
        RATING_KEY,
        TIME_BASED_TEXTS,
        COMBO_ACHIEVEMENTS,
        RECOMMENDATION_PATTERNS_KEY,
        MOOD_TONES,
        ADVICE_SETTINGS_KEY,
        DEFAULT_ADVICE_SETTINGS,
        CATEGORY_LABELS,
        PERSONAL_BESTS_KEY,
        TRACKABLE_METRICS,
        GOAL_MODES,
        SCHEDULED_KEY,
        SNOOZE_OPTIONS,
        ADVICE_ANIMATIONS,
        CTR_WEIGHT,
        RECENCY_WEIGHT,
        RELEVANCE_WEIGHT,
        SEASONAL_TIPS,
        CHAIN_STORAGE_KEY,
        MEAL_ADVICE_THROTTLE_MS
    } = AdviceRules;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸš€ ADVICE CACHE â€” ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² generateAdvices
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let adviceCache = {
        key: null,
        result: null,
        timestamp: 0
    };

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ ĞºÑÑˆĞ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
     * @param {Object} ctx
     * @returns {string}
     */
    function generateCacheKey(ctx) {
        const day = ctx?.day || {};
        const dayTot = ctx?.dayTot || {};
        const normAbs = ctx?.normAbs || {};
        const goalMode = ctx?.goal?.mode || '';

        return [
            day.date || '',
            ctx?.hour ?? '',
            ctx?.mealCount ?? '',
            ctx?.kcalPct ?? '',
            goalMode,
            day.isRefeedDay ? '1' : '0',
            dayTot.kcal || 0,
            dayTot.prot || 0,
            dayTot.carbs || 0,
            dayTot.fat || 0,
            dayTot.simple || 0,
            dayTot.fiber || 0,
            dayTot.harm || 0,
            normAbs.kcal || 0,
            normAbs.prot || 0,
            normAbs.carbs || 0,
            normAbs.fat || 0,
            normAbs.simple || 0,
            normAbs.fiber || 0,
            normAbs.harm || 0
        ].join('|');
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ ĞºÑÑˆĞ° Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
     * @param {Object} ctx
     * @returns {boolean}
     */
    function isCacheValid(ctx) {
        if (!adviceCache.result) return false;
        if (Date.now() - adviceCache.timestamp > ADVICE_CACHE_TTL) return false;
        return adviceCache.key === generateCacheKey(ctx);
    }

    /**
     * Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºÑÑˆĞ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ°)
     */
    function invalidateAdviceCache() {
        adviceCache = { key: null, result: null, timestamp: 0 };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERSONALIZED TEXT TEMPLATES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ñ‹ Ğ² Ñ‚ĞµĞºÑÑ‚Ğµ
     * @param {string} text - Ğ¢ĞµĞºÑÑ‚ Ñ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸
     * @param {Object} ctx - ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
     * @returns {string}
     */
    function personalizeText(text, ctx) {
        const firstName = ctx.prof?.firstName || '';
        const result = text
            .replace(/\$\{firstName\}/g, firstName)
            .replace(/\$\{firstName\}, /g, firstName ? firstName + ', ' : '')
            .replace(/\$\{firstName\}!/g, firstName ? firstName + '!' : '')
            .replace(/\, \$\{firstName\}/g, firstName ? ', ' + firstName : '');
        return result.trim();
    }

    /**
     * Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ (ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ² Ñ€Ğ°Ğ¼ĞºĞ°Ñ… ÑĞµÑÑĞ¸Ğ¸)
     * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ + id Ğ´Ğ»Ñ seed, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ±Ñ‹Ğ» ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ½Ğ¾ Ğ¼ĞµĞ½ÑĞ»ÑÑ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾
     * @param {string|string[]} textOrArray
     * @param {string} [seed] - Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ seed Ğ´Ğ»Ñ Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° (id ÑĞ¾Ğ²ĞµÑ‚Ğ°)
     * @returns {string}
     */
    // ĞšÑÑˆ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ² Ñ€Ğ°Ğ¼ĞºĞ°Ñ… ÑĞµÑÑĞ¸Ğ¸
    const _textChoiceCache = new Map();

    function pickRandomText(textOrArray, seed = '') {
        if (!Array.isArray(textOrArray)) {
            return textOrArray;
        }
        if (textOrArray.length === 1) {
            return textOrArray[0];
        }

        // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ĞºĞ»ÑÑ‡ ĞºÑÑˆĞ° Ğ¸Ğ· seed + Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²
        const cacheKey = seed + '|' + textOrArray.join('|');

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºÑÑˆ
        if (_textChoiceCache.has(cacheKey)) {
            return _textChoiceCache.get(cacheKey);
        }

        // Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´Ğ°Ñ‚Ñ‹ + seed
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        const seedStr = today + seed;

        // Simple hash function
        let hash = 0;
        for (let i = 0; i < seedStr.length; i++) {
            const char = seedStr.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }

        const index = Math.abs(hash) % textOrArray.length;
        const result = textOrArray[index];

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² ĞºÑÑˆ
        _textChoiceCache.set(cacheKey, result);

        return result;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVICE RATING â€” Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ñ†ĞµĞ½ĞºĞ¸ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ¾Ñ†ĞµĞ½ĞºÑƒ ÑĞ¾Ğ²ĞµÑ‚Ğ° (ğŸ‘/ğŸ‘)
     * @param {string} adviceId
     * @param {boolean} isPositive - true = ğŸ‘, false = ğŸ‘
     */
    function rateAdvice(adviceId, isPositive) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RATING_KEY, null)
                : (U.lsGet ? U.lsGet(RATING_KEY, null) : JSON.parse(localStorage.getItem(RATING_KEY) || 'null'));
            const ratings = stored || {};
            if (!ratings[adviceId]) {
                ratings[adviceId] = { positive: 0, negative: 0 };
            }
            if (isPositive) {
                ratings[adviceId].positive++;
            } else {
                ratings[adviceId].negative++;
            }
            ratings[adviceId].lastRated = Date.now();
            if (HEYS.store?.set) {
                HEYS.store.set(RATING_KEY, ratings);
            } else if (U.lsSet) {
                U.lsSet(RATING_KEY, ratings);
            } else {
                localStorage.setItem(RATING_KEY, JSON.stringify(ratings));
            }
        } catch (e) { }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ ÑĞ¾Ğ²ĞµÑ‚Ğ°
     * @param {string} adviceId
     * @returns {Object} { positive, negative, score }
     */
    function getAdviceRating(adviceId) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RATING_KEY, null)
                : (U.lsGet ? U.lsGet(RATING_KEY, null) : JSON.parse(localStorage.getItem(RATING_KEY) || 'null'));
            const ratings = stored || {};
            const r = ratings[adviceId] || { positive: 0, negative: 0 };
            const total = r.positive + r.negative;
            const score = total > 0 ? (r.positive - r.negative) / total : 0;
            return { ...r, score, total };
        } catch (e) {
            return { positive: 0, negative: 0, score: 0, total: 0 };
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸ (Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¾Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… >60 Ğ´Ğ½ĞµĞ¹)
     * @returns {Object}
     */
    function getAllRatings() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const parsed = HEYS.store?.get
                ? (HEYS.store.get(RATING_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(RATING_KEY, null) || {}) : JSON.parse(localStorage.getItem(RATING_KEY) || 'null') || {});

            // ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°: ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ÑÑ‚Ğ°Ñ€ÑˆĞµ 60 Ğ´Ğ½ĞµĞ¹
            const now = Date.now();
            const SIXTY_DAYS = 60 * 24 * 60 * 60 * 1000;
            let needsSave = false;
            Object.keys(parsed).forEach(key => {
                if (parsed[key].lastRated && (now - parsed[key].lastRated) > SIXTY_DAYS) {
                    delete parsed[key];
                    needsSave = true;
                }
            });
            if (needsSave) {
                if (HEYS.store?.set) {
                    HEYS.store.set(RATING_KEY, parsed);
                } else if (U.lsSet) {
                    U.lsSet(RATING_KEY, parsed);
                } else {
                    localStorage.setItem(RATING_KEY, JSON.stringify(parsed));
                }
            }
            return parsed;
        } catch (e) {
            return {};
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIME-BASED TEXT SELECTION â€” Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ ÑÑƒÑ‚Ğ¾Ğº
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ´Ğ½Ñ
     * @param {number} hour
     * @returns {'morning'|'afternoon'|'evening'}
     */
    function getTimePeriod(hour) {
        if (hour >= 5 && hour < 12) return 'morning';
        if (hour >= 12 && hour < 18) return 'afternoon';
        return 'evening';
    }

    /**
     * Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ğ° Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ ÑÑƒÑ‚Ğ¾Ğº
     * @param {string} adviceId
     * @param {number} hour
     * @param {string} defaultText
     * @returns {string}
     */
    function getTimeBasedText(adviceId, hour, defaultText) {
        const variants = TIME_BASED_TEXTS[adviceId];
        if (!variants) return defaultText;

        const period = getTimePeriod(hour);
        const texts = variants[period];

        if (texts && texts.length > 0) {
            return pickRandomText(texts);
        }
        return defaultText;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMBO ACHIEVEMENTS â€” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ¼Ğ±Ğ¾ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğ¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ combo Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
     * @param {Object} ctx - ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ñ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
     * @returns {Object|null} Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚Ğ¾Ğµ ĞºĞ¾Ğ¼Ğ±Ğ¾ Ğ¸Ğ»Ğ¸ null
     */
    function checkComboAchievements(ctx) {
        try {
            const lsGet = (window.HEYS?.utils?.lsGet) || ((k, d) => {
                try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
            });

            const today = new Date();

            for (const combo of COMBO_ACHIEVEMENTS) {
                // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ»Ğ¸ Ğ»Ğ¸ ÑƒĞ¶Ğµ ÑÑ‚Ğ¾ ĞºĞ¾Ğ¼Ğ±Ğ¾
                const shownKey = 'heys_combo_' + combo.id;
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                const lastShown = HEYS.store?.get
                    ? HEYS.store.get(shownKey, null)
                    : (U.lsGet ? U.lsGet(shownKey, null) : localStorage.getItem(shownKey));
                if (lastShown) {
                    const daysSince = (Date.now() - parseInt(lastShown, 10)) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) continue; // ĞĞµ Ñ‡Ğ°Ñ‰Ğµ Ñ€Ğ°Ğ·Ğ° Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ
                }

                // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹
                let successDays = 0;

                for (let i = 0; i < combo.daysRequired + 2; i++) { // +2 Ğ´Ğ»Ñ Ğ±ÑƒÑ„ĞµÑ€Ğ°
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const iso = d.toISOString().slice(0, 10);
                    const dayData = lsGet('heys_dayv2_' + iso, null);

                    if (!dayData?.meals?.length) continue;

                    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ
                    let meetsConditions = true;
                    const cond = combo.conditions;

                    if (cond.proteinPct !== undefined) {
                        const pct = (dayData.dayTot?.prot || 0) / (ctx.normAbs?.prot || 100);
                        if (pct < cond.proteinPct) meetsConditions = false;
                    }
                    if (cond.fiberPct !== undefined) {
                        const pct = (dayData.dayTot?.fiber || 0) / (ctx.normAbs?.fiber || 25);
                        if (pct < cond.fiberPct) meetsConditions = false;
                    }
                    if (cond.waterPct !== undefined) {
                        const pct = (dayData.waterMl || 0) / (ctx.waterGoal || 2000);
                        if (pct < cond.waterPct) meetsConditions = false;
                    }
                    if (cond.harmPct !== undefined) {
                        const pct = (dayData.dayTot?.harm || 0) / 100;
                        if (pct > cond.harmPct) meetsConditions = false;
                    }
                    if (cond.breakfastBefore !== undefined) {
                        const firstMeal = (dayData.meals || []).find(m => m.items?.length > 0);
                        if (firstMeal?.time) {
                            const [h] = firstMeal.time.split(':').map(Number);
                            if (h >= cond.breakfastBefore) meetsConditions = false;
                        } else {
                            meetsConditions = false;
                        }
                    }

                    if (meetsConditions) successDays++;
                    if (successDays >= combo.daysRequired) {
                        return combo;
                    }
                }
            }

            return null;
        } catch (e) {
            return null;
        }
    }

    /**
     * ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ· ĞºĞ¾Ğ¼Ğ±Ğ¾
     * @param {string} comboId
     */
    function markComboShown(comboId) {
        try {
            const key = 'heys_combo_' + comboId;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(key, String(Date.now()));
            } else if (U.lsSet) {
                U.lsSet(key, String(Date.now()));
            } else {
                localStorage.setItem(key, String(Date.now()));
            }
        } catch (e) { }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART RECOMMENDATIONS â€” ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ°
     * @param {string} productName
     * @param {number} hour
     */
    function trackProductPattern(productName, hour) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RECOMMENDATION_PATTERNS_KEY, null)
                : (U.lsGet ? U.lsGet(RECOMMENDATION_PATTERNS_KEY, null) : JSON.parse(localStorage.getItem(RECOMMENDATION_PATTERNS_KEY) || 'null'));
            const patterns = stored || {};
            const key = productName.toLowerCase().slice(0, 20); // ĞŸĞµÑ€Ğ²Ñ‹Ğµ 20 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²

            if (!patterns[key]) {
                patterns[key] = { hours: [], count: 0 };
            }

            patterns[key].hours.push(hour);
            patterns[key].count++;
            patterns[key].lastAdded = Date.now();

            // Ğ”ĞµÑ€Ğ¶Ğ¸Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
            if (patterns[key].hours.length > 10) {
                patterns[key].hours = patterns[key].hours.slice(-10);
            }

            if (HEYS.store?.set) {
                HEYS.store.set(RECOMMENDATION_PATTERNS_KEY, patterns);
            } else if (U.lsSet) {
                U.lsSet(RECOMMENDATION_PATTERNS_KEY, patterns);
            } else {
                localStorage.setItem(RECOMMENDATION_PATTERNS_KEY, JSON.stringify(patterns));
            }
        } catch (e) { }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²
     * @param {number} currentHour
     * @returns {Object|null} { productName, avgHour, message }
     */
    function getSmartRecommendation(currentHour) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(RECOMMENDATION_PATTERNS_KEY, null)
                : (U.lsGet ? U.lsGet(RECOMMENDATION_PATTERNS_KEY, null) : JSON.parse(localStorage.getItem(RECOMMENDATION_PATTERNS_KEY) || 'null'));
            const patterns = stored || {};

            let bestMatch = null;
            let bestScore = 0;

            for (const [product, data] of Object.entries(patterns)) {
                if (data.count < 3) continue; // ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 Ñ€Ğ°Ğ·Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ»

                // Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡Ğ°Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
                const avgHour = Math.round(data.hours.reduce((a, b) => a + b, 0) / data.hours.length);

                // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğº Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ¼Ñƒ
                const hourDiff = Math.abs(currentHour - avgHour);
                if (hourDiff <= 1) { // Ğ’ Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ñ… Ñ‡Ğ°ÑĞ°
                    const score = data.count / (hourDiff + 1);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = {
                            productName: product,
                            avgHour,
                            count: data.count,
                            message: `ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ² ÑÑ‚Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ñ‚Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑˆÑŒ ${product}`
                        };
                    }
                }
            }

            return bestMatch;
        } catch (e) {
            return null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOOD-ADAPTIVE MESSAGES â€” ĞĞ´Ğ°Ğ¿Ñ‚Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ´ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ğ° Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ
     * @param {string} text - ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚
     * @param {number} mood - ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ (1-5)
     * @param {string} adviceType - Ğ¢Ğ¸Ğ¿ ÑĞ¾Ğ²ĞµÑ‚Ğ°
     * @returns {string}
     */
    function adaptTextToMood(text, mood, adviceType) {
        if (!mood || mood === 0) return text;

        let toneKey = 'neutral';
        if (mood <= 2) toneKey = 'low';
        else if (mood >= 4) toneKey = 'high';

        const tone = MOOD_TONES[toneKey];
        if (!tone) return text;

        // ĞŸÑ€Ğ¸ Ğ½Ğ¸Ğ·ĞºĞ¾Ğ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ±ĞµĞ³Ğ°ĞµĞ¼ Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ñ… ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
        if (tone.avoid.includes(adviceType)) {
            return null; // Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ
        }

        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ prefix/suffix ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾
        const prefix = pickRandomText(tone.prefix);
        const suffix = pickRandomText(tone.suffix);

        return prefix + text + suffix;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
     * @param {Object} day
     * @returns {number} 0-5
     */
    function getAverageMoodToday(day) {
        const meals = (day?.meals || []).filter(m => m.mood > 0);
        if (meals.length === 0) return 0;
        return meals.reduce((sum, m) => sum + m.mood, 0) / meals.length;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART PRIORITIZATION â€” ML-like scoring Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ CTR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ smart score Ğ´Ğ»Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ° (Ğ±ĞµĞ· ĞºÑÑˆĞ° - Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²)
     * @param {Object} advice
     * @param {Object} ctx
     * @returns {number} Score (Ğ²Ñ‹ÑˆĞµ = Ğ»ÑƒÑ‡ÑˆĞµ)
     */
    function calculateSmartScore(advice, ctx) {
        return calculateSmartScoreCached(advice, ctx, getTrackingStats(), getAllRatings());
    }

    /**
     * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ğ¾ smart score
     * @param {Array} advices
     * @param {Object} ctx
     * @returns {Array}
     */
    function sortBySmartScore(advices, ctx) {
        // ğŸš€ ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: ĞºÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ stats Ğ¸ ratings Ğ´Ğ»Ñ Ğ²ÑĞµĞ¹ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
        const cachedStats = getTrackingStats();
        const cachedRatings = getAllRatings();

        return advices
            .map(a => ({ ...a, smartScore: calculateSmartScoreCached(a, ctx, cachedStats, cachedRatings) }))
            .sort((a, b) => b.smartScore - a.smartScore);
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ smart score Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
     * @param {Object} advice
     * @param {Object} ctx
     * @param {Object} stats - ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ stats
     * @param {Object} ratings - ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ratings
     * @returns {number}
     */
    function calculateSmartScoreCached(advice, ctx, stats, ratings) {
        let score = 100 - advice.priority;

        // 1. CTR factor
        const adviceStats = stats[advice.id];
        if (adviceStats && adviceStats.shown >= 3) {
            const ctr = adviceStats.clicked / adviceStats.shown;
            score += ctr * 50 * CTR_WEIGHT;
        }

        // 2. Rating factor
        const r = ratings[advice.id] || { positive: 0, negative: 0 };
        const total = r.positive + r.negative;
        if (total >= 2) {
            const ratingScore = (r.positive - r.negative) / total;
            score += ratingScore * 30 * CTR_WEIGHT;
        }

        // 3. Recency factor
        if (adviceStats?.lastShown) {
            const hoursSince = (Date.now() - adviceStats.lastShown) / (1000 * 60 * 60);
            if (hoursSince > 24) {
                score += Math.min(hoursSince / 24, 5) * 10 * RECENCY_WEIGHT;
            }
        } else {
            score += 10 * RECENCY_WEIGHT;
        }

        // 4. Relevance
        if (advice.category === 'nutrition' && advice.nutrient) {
            const pct = (ctx.dayTot?.[advice.nutrient] || 0) / (ctx.normAbs?.[advice.nutrient] || 100);
            if (pct < 0.5) score += 20 * RELEVANCE_WEIGHT;
        }

        // 5. ğŸ†• Crash Risk boost â€” Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ Ñ€Ğ¸ÑĞºĞµ ÑÑ€Ñ‹Ğ²Ğ°
        if (ctx.crashRisk && ctx.crashRisk.level === 'high') {
            // Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸ĞµĞ¼ ÑÑ€Ñ‹Ğ²Ğ°, Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ Ğ±Ğ¾Ğ½ÑƒÑ
            const crashPreventionCategories = ['emotional', 'nutrition', 'recovery'];
            const crashPreventionIds = [
                'crash_support', 'stress_support', 'sleep_hunger_correlation',
                'undereating_warning', 'evening_undereating', 'chronic_undereating_pattern'
            ];

            if (crashPreventionCategories.includes(advice.category) ||
                crashPreventionIds.includes(advice.id)) {
                score += 30; // Ğ—Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ Ñ€Ğ¸ÑĞºĞµ
            }
        } else if (ctx.crashRisk && ctx.crashRisk.level === 'medium') {
            // Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ Ğ¿Ñ€Ğ¸ ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ Ñ€Ğ¸ÑĞºĞµ
            if (advice.category === 'emotional' || advice.id?.includes('stress')) {
                score += 15;
            }
        }

        return score;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVICE SETTINGS â€” Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * ğŸ”§ FIX: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ U.lsGet Ğ´Ğ»Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾Ğ¼
     * @returns {Object}
     */
    function getAdviceSettings() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(ADVICE_SETTINGS_KEY, null)
                : (U.lsGet ? U.lsGet(ADVICE_SETTINGS_KEY, null) : JSON.parse(localStorage.getItem(ADVICE_SETTINGS_KEY) || 'null'));
            if (stored) {
                return { ...DEFAULT_ADVICE_SETTINGS, ...stored };
            }
        } catch (e) { }
        return { ...DEFAULT_ADVICE_SETTINGS };
    }

    /**
     * Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * ğŸ”§ FIX: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ U.lsSet Ğ´Ğ»Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾Ğ¼
     * @param {Object} settings
     */
    function setAdviceSettings(settings) {
        try {
            const current = getAdviceSettings();
            const merged = { ...current, ...settings };
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(ADVICE_SETTINGS_KEY, merged);
            } else if (U.lsSet) {
                U.lsSet(ADVICE_SETTINGS_KEY, merged);
            } else {
                localStorage.setItem(ADVICE_SETTINGS_KEY, JSON.stringify(merged));
            }
            // Emit event Ğ´Ğ»Ñ UI
            window.dispatchEvent(new CustomEvent('heysAdviceSettingsChanged', { detail: merged }));
        } catch (e) { }
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° Ğ»Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @param {string} category
     * @returns {boolean}
     */
    function isCategoryEnabled(category) {
        const settings = getAdviceSettings();
        return settings.categories?.[category] !== false;
    }

    /**
     * ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ
     * @param {string} category
     * @param {boolean} enabled
     */
    function toggleCategory(category, enabled) {
        const settings = getAdviceSettings();
        settings.categories = settings.categories || {};
        settings.categories[category] = enabled;
        setAdviceSettings(settings);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERSONAL BEST TRACKING â€” ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¾Ğ²
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñ‹
     * @returns {Object}
     */
    function getPersonalBests() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(PERSONAL_BESTS_KEY, null)
                : (U.lsGet ? U.lsGet(PERSONAL_BESTS_KEY, null) : JSON.parse(localStorage.getItem(PERSONAL_BESTS_KEY) || 'null'));
            return stored || {};
        } catch (e) {
            return {};
        }
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´
     * @param {string} metric - ĞšĞ»ÑÑ‡ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
     * @param {number} value - Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
     * @param {string} date - Ğ”Ğ°Ñ‚Ğ° Ğ² ISO Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ
     * @returns {Object|null} { isNewRecord, previousValue, improvement }
     */
    function checkAndUpdatePersonalBest(metric, value, date) {
        const config = TRACKABLE_METRICS[metric];
        if (!config) return null;

        const bests = getPersonalBests();
        const current = bests[metric];

        let isNewRecord = false;
        let previousValue = null;

        if (!current) {
            isNewRecord = true;
        } else {
            previousValue = current.value;
            if (config.higher) {
                isNewRecord = value > current.value;
            } else {
                isNewRecord = value < current.value;
            }
        }

        if (isNewRecord && value > 0) {
            bests[metric] = { value, date, previous: previousValue };
            try {
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                if (HEYS.store?.set) {
                    HEYS.store.set(PERSONAL_BESTS_KEY, bests);
                } else if (U.lsSet) {
                    U.lsSet(PERSONAL_BESTS_KEY, bests);
                } else {
                    localStorage.setItem(PERSONAL_BESTS_KEY, JSON.stringify(bests));
                }
            } catch (e) { }

            return {
                isNewRecord: true,
                previousValue,
                improvement: previousValue ? Math.abs(value - previousValue) : null,
                metric: config
            };
        }

        return { isNewRecord: false, currentBest: current?.value };
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ°
     * @param {string} metric
     * @param {Object} recordInfo
     * @returns {Object|null} Advice object
     */
    function createPersonalBestAdvice(metric, recordInfo) {
        if (!recordInfo?.isNewRecord) return null;

        const config = TRACKABLE_METRICS[metric];
        if (!config) return null;

        const value = recordInfo.improvement
            ? `+${recordInfo.improvement.toFixed(1)}${config.unit} Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ³Ğ¾!`
            : `${config.unit}`;

        return {
            id: 'personal_best_' + metric,
            icon: 'ğŸ†',
            text: `ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´: ${config.name}! ${value}`,
            type: 'achievement',
            priority: 3,
            category: 'achievement',
            triggers: ['tab_open'],
            ttl: 6000,
            showConfetti: true,
            animation: 'bounce'
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVICE CHAINS â€” Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @param {string} chainId - ID Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ²ĞµÑ‚Ğ°
     */
    function markChainStart(chainId) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const chains = HEYS.store?.get
                ? (HEYS.store.get(CHAIN_STORAGE_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(CHAIN_STORAGE_KEY, null) || {}) : JSON.parse(localStorage.getItem(CHAIN_STORAGE_KEY) || 'null') || {});
            chains[chainId] = Date.now();
            if (HEYS.store?.set) {
                HEYS.store.set(CHAIN_STORAGE_KEY, chains);
            } else if (U.lsSet) {
                U.lsSet(CHAIN_STORAGE_KEY, chains);
            } else {
                localStorage.setItem(CHAIN_STORAGE_KEY, JSON.stringify(chains));
            }
        } catch (e) { }
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¿Ğ¾Ñ€Ğ° Ğ»Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑĞ¾Ğ²ĞµÑ‚ Ğ² Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞµ
     * @param {string} chainId
     * @returns {Object|null} Next advice in chain Ğ¸Ğ»Ğ¸ null
     */
    function checkChainContinuation(chainId) {
        const chainConfig = ADVICE_CHAINS[chainId];
        if (!chainConfig) return null;

        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const chains = HEYS.store?.get
                ? (HEYS.store.get(CHAIN_STORAGE_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(CHAIN_STORAGE_KEY, null) || {}) : JSON.parse(localStorage.getItem(CHAIN_STORAGE_KEY) || 'null') || {});
            const startTime = chains[chainId];
            if (!startTime) return null;

            const minutesPassed = (Date.now() - startTime) / (1000 * 60);
            if (minutesPassed >= chainConfig.delayMinutes) {
                // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· chains, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°
                delete chains[chainId];
                if (HEYS.store?.set) {
                    HEYS.store.set(CHAIN_STORAGE_KEY, chains);
                } else if (U.lsSet) {
                    U.lsSet(CHAIN_STORAGE_KEY, chains);
                } else {
                    localStorage.setItem(CHAIN_STORAGE_KEY, JSON.stringify(chains));
                }

                return chainConfig.next;
            }
        } catch (e) { }

        return null;
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ follow-up ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞµĞº
     * @returns {Array} ĞœĞ°ÑÑĞ¸Ğ² follow-up ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     */
    function generateChainAdvices() {
        const advices = [];

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²ÑĞµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸
        for (const chainId of Object.keys(ADVICE_CHAINS)) {
            const nextId = checkChainContinuation(chainId);
            if (nextId) {
                // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ follow-up ÑĞ¾Ğ²ĞµÑ‚
                if (nextId === 'water_benefits') {
                    advices.push({
                        id: 'water_benefits',
                        icon: 'ğŸ’§',
                        text: 'Ğ’Ğ¾Ğ´Ğ° ÑƒÑĞºĞ¾Ñ€ÑĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ½Ğ° 30% Ğ½Ğ° Ñ‡Ğ°Ñ Ğ¿Ğ¾ÑĞ»Ğµ ÑÑ‚Ğ°ĞºĞ°Ğ½Ğ°',
                        type: 'tip',
                        priority: 45,
                        category: 'hydration',
                        triggers: ['tab_open'],
                        ttl: 5000
                    });
                }
            }
        }

        return advices;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVICE SCHEDULING â€” ĞÑ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞÑ‚ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚ Ğ½Ğ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ
     * @param {Object} advice - Ğ¡Ğ¾Ğ²ĞµÑ‚
     * @param {number} minutes - Ğ§ĞµÑ€ĞµĞ· ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ
     */
    function scheduleAdvice(advice, minutes) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const scheduled = HEYS.store?.get
                ? (HEYS.store.get(SCHEDULED_KEY, null) || [])
                : (U.lsGet ? (U.lsGet(SCHEDULED_KEY, null) || []) : JSON.parse(localStorage.getItem(SCHEDULED_KEY) || 'null') || []);
            scheduled.push({
                advice,
                showAt: Date.now() + minutes * 60 * 1000
            });
            if (HEYS.store?.set) {
                HEYS.store.set(SCHEDULED_KEY, scheduled);
            } else if (U.lsSet) {
                U.lsSet(SCHEDULED_KEY, scheduled);
            } else {
                localStorage.setItem(SCHEDULED_KEY, JSON.stringify(scheduled));
            }

            // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾Ñ‚Ğ»Ğ¾Ğ¶ĞºĞµ
            window.dispatchEvent(new CustomEvent('heysAdviceScheduled', {
                detail: { advice, minutes }
            }));
        } catch (e) { }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ¾Ñ€Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ
     * @returns {Array}
     */
    function getScheduledAdvices() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const scheduled = HEYS.store?.get
                ? (HEYS.store.get(SCHEDULED_KEY, null) || [])
                : (U.lsGet ? (U.lsGet(SCHEDULED_KEY, null) || []) : JSON.parse(localStorage.getItem(SCHEDULED_KEY) || 'null') || []);
            if (scheduled.length === 0) return []; // ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½ĞµÑ‚ â€” Ğ½Ğµ Ñ‚Ñ€Ğ¾Ğ³Ğ°ĞµĞ¼ storage

            const now = Date.now();

            const ready = scheduled.filter(s => s.showAt <= now);
            const remaining = scheduled.filter(s => s.showAt > now);

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ storage Ğ¢ĞĞ›Ğ¬ĞšĞ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑĞ¿Ğ°Ğ¼Ğ¸Ñ‚ÑŒ)
            if (ready.length > 0) {
                if (HEYS.store?.set) {
                    HEYS.store.set(SCHEDULED_KEY, remaining);
                } else if (U.lsSet) {
                    U.lsSet(SCHEDULED_KEY, remaining);
                } else {
                    localStorage.setItem(SCHEDULED_KEY, JSON.stringify(remaining));
                }
            }

            return ready.map(s => ({
                ...s.advice,
                id: s.advice.id + '_scheduled',
                isScheduled: true,
                text: 'â° ' + s.advice.text,
                triggers: ['scheduled', 'tab_open', 'product_added'], // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¼ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğµ
                priority: 100 // Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ â€” Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ°Ğ¼ Ğ¾Ñ‚Ğ»Ğ¾Ğ¶Ğ¸Ğ»
            }));
        } catch (e) {
            return [];
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @returns {number}
     */
    function getScheduledCount() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const scheduled = HEYS.store?.get
                ? (HEYS.store.get(SCHEDULED_KEY, null) || [])
                : (U.lsGet ? (U.lsGet(SCHEDULED_KEY, null) || []) : JSON.parse(localStorage.getItem(SCHEDULED_KEY) || 'null') || []);
            return scheduled.length;
        } catch (e) {
            return 0;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOAL-SPECIFIC ADVICE â€” Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ğ¾ Ñ†ĞµĞ»ÑĞ¼
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ñ†ĞµĞ»Ğ¸
     * @param {string} goalMode
     * @returns {Array}
     */
    function getGoalSpecificAdvices(goalMode) {
        const config = GOAL_MODES[goalMode];
        if (!config || !config.bonusAdvices) return [];

        return config.bonusAdvices.map(a => ({
            ...a,
            type: 'tip',
            category: 'lifestyle',
            triggers: ['tab_open'],
            ttl: 5000,
            goalSpecific: true
        }));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MICRO-ANIMATIONS â€” ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ° ÑĞ¾Ğ²ĞµÑ‚Ğ°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ»Ğ°ÑÑ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ°
     * @param {Object} advice
     * @returns {string} CSS class name
     */
    function getAdviceAnimation(advice) {
        // Ğ¯Ğ²Ğ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ°Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ
        if (advice.animation) return advice.animation;

        // ĞŸĞ¾ Ñ‚Ğ¸Ğ¿Ñƒ
        return ADVICE_ANIMATIONS[advice.type] || 'fadeSlide';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART PRODUCT CATEGORIES â€” ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ²
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹ Ğ´Ğ½Ñ Ğ¸ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ ĞºĞ°ĞºĞ¸Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ñ‹
     * @param {Object} day - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ñ
     * @param {Object} pIndex - Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ²
     * @returns {Object} { present: Set<string>, missing: string[], counts: Map }
     */
    function analyzeProductCategories(day, pIndex) {
        const present = new Set();
        const counts = new Map();

        const allItems = (day?.meals || []).flatMap(m => m.items || []);

        for (const item of allItems) {
            let productName = item.name || '';
            if (!productName) {
                const product = getProductForItem(item, pIndex);
                if (product) productName = product.name || '';
            }

            const nameLower = productName.toLowerCase();

            for (const [category, config] of Object.entries(PRODUCT_CATEGORIES)) {
                if (config.keywords.some(kw => nameLower.includes(kw))) {
                    present.add(category);
                    counts.set(category, (counts.get(category) || 0) + 1);
                }
            }
        }

        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğµ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
        const importantCategories = ['vegetables', 'fruits', 'dairy', 'fish'];
        const missing = importantCategories.filter(c => !present.has(c));

        return { present, missing, counts };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DAY FORECAST â€” ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹ Ğº ĞºĞ¾Ğ½Ñ†Ñƒ Ğ´Ğ½Ñ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ % ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹ Ğº ĞºĞ¾Ğ½Ñ†Ñƒ Ğ´Ğ½Ñ
     * @param {number} currentKcalPct - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ % Ğ¾Ñ‚ Ğ½Ğ¾Ñ€Ğ¼Ñ‹
     * @param {number} hour - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ
     * @param {number} mealCount - ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ² Ğ¿Ğ¸Ñ‰Ğ¸
     * @returns {Object} { forecastPct, trend: 'under'|'on_track'|'over', message }
     */
    function getDayForecast(currentKcalPct, hour, mealCount) {
        if (hour < 10 || mealCount === 0) return null;

        // Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ: Ğº 12:00 ~25%, Ğº 15:00 ~50%, Ğº 18:00 ~75%, Ğº 21:00 ~95%
        const expectedByHour = {
            10: 0.15, 11: 0.20, 12: 0.30, 13: 0.40, 14: 0.50,
            15: 0.55, 16: 0.60, 17: 0.65, 18: 0.75, 19: 0.80,
            20: 0.85, 21: 0.92, 22: 0.97, 23: 1.0
        };

        const expectedNow = expectedByHour[hour] || (hour < 10 ? 0.1 : 1.0);
        const pace = currentKcalPct / expectedNow;

        // ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° ĞºĞ¾Ğ½ĞµÑ† Ğ´Ğ½Ñ
        const forecastPct = Math.round(pace * 100);

        let trend = 'on_track';
        let message = '';

        if (pace < 0.85) {
            trend = 'under';
            message = `ĞŸÑ€Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ñ‚ĞµĞ¼Ğ¿Ğµ Ğ±ÑƒĞ´ĞµÑ‚ ~${forecastPct}% Ğº Ğ²ĞµÑ‡ĞµÑ€Ñƒ`;
        } else if (pace > 1.15) {
            trend = 'over';
            message = `ĞŸÑ€Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ñ‚ĞµĞ¼Ğ¿Ğµ Ğ±ÑƒĞ´ĞµÑ‚ ~${forecastPct}% Ğº Ğ²ĞµÑ‡ĞµÑ€Ñƒ`;
        } else {
            trend = 'on_track';
            message = `Ğ¢ĞµĞ¼Ğ¿ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ â€” Ğ±ÑƒĞ´ĞµÑ‚ ~${forecastPct}% Ğº Ğ²ĞµÑ‡ĞµÑ€Ñƒ`;
        }

        return { forecastPct, trend, message, pace };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WEEKLY COMPARISON â€” Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»ĞµĞ¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹
     * @returns {Object|null} { kcalDiff, simpleDiff, protDiff, message }
     */
    function getWeeklyComparison() {
        try {
            const lsGet = (window.HEYS?.utils?.lsGet) || ((k, d) => {
                try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
            });

            const today = new Date();
            const dayOfWeek = today.getDay() || 7; // 1-7 (Ğ¿Ğ½-Ğ²Ñ)

            // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº Ğ¸Ğ»Ğ¸ Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº â€” Ğ¼Ğ°Ğ»Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            if (dayOfWeek <= 2) return null;

            let thisWeek = { kcal: 0, simple: 0, prot: 0, days: 0 };
            let lastWeek = { kcal: 0, simple: 0, prot: 0, days: 0 };

            // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸
            for (let i = 0; i < dayOfWeek; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().slice(0, 10);
                const dayData = lsGet('heys_dayv2_' + iso, null);
                if (dayData?.meals?.length > 0) {
                    thisWeek.kcal += dayData.dayTot?.kcal || 0;
                    thisWeek.simple += dayData.dayTot?.simple || 0;
                    thisWeek.prot += dayData.dayTot?.prot || 0;
                    thisWeek.days++;
                }
            }

            // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (Ñ‚Ğµ Ğ¶Ğµ Ğ´Ğ½Ğ¸)
            for (let i = 7; i < 7 + dayOfWeek; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().slice(0, 10);
                const dayData = lsGet('heys_dayv2_' + iso, null);
                if (dayData?.meals?.length > 0) {
                    lastWeek.kcal += dayData.dayTot?.kcal || 0;
                    lastWeek.simple += dayData.dayTot?.simple || 0;
                    lastWeek.prot += dayData.dayTot?.prot || 0;
                    lastWeek.days++;
                }
            }

            if (thisWeek.days < 2 || lastWeek.days < 2) return null;

            // Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
            const avgThis = {
                kcal: thisWeek.kcal / thisWeek.days,
                simple: thisWeek.simple / thisWeek.days,
                prot: thisWeek.prot / thisWeek.days
            };
            const avgLast = {
                kcal: lastWeek.kcal / lastWeek.days,
                simple: lastWeek.simple / lastWeek.days,
                prot: lastWeek.prot / lastWeek.days
            };

            // ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            const kcalDiff = avgLast.kcal > 0 ? Math.round((avgThis.kcal - avgLast.kcal) / avgLast.kcal * 100) : 0;
            const simpleDiff = avgLast.simple > 0 ? Math.round((avgThis.simple - avgLast.simple) / avgLast.simple * 100) : 0;
            const protDiff = avgLast.prot > 0 ? Math.round((avgThis.prot - avgLast.prot) / avgLast.prot * 100) : 0;

            // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            let message = null;
            const absDiffs = [
                { type: 'simple', diff: simpleDiff, positive: simpleDiff < 0 },
                { type: 'prot', diff: protDiff, positive: protDiff > 0 },
                { type: 'kcal', diff: kcalDiff, positive: Math.abs(kcalDiff) < 10 }
            ];

            // Ğ˜Ñ‰ĞµĞ¼ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸
            const goodNews = absDiffs.filter(d => d.positive && Math.abs(d.diff) >= 10);
            if (goodNews.length > 0) {
                const best = goodNews.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff))[0];
                if (best.type === 'simple' && best.diff < -10) {
                    message = `ĞĞ° ${Math.abs(best.diff)}% Ğ¼ĞµĞ½ÑŒÑˆĞµ ÑĞ°Ñ…Ğ°Ñ€Ğ° Ñ‡ĞµĞ¼ Ğ½Ğ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğµ! ğŸ‰`;
                } else if (best.type === 'prot' && best.diff > 10) {
                    message = `ĞĞ° ${best.diff}% Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±ĞµĞ»ĞºĞ° Ñ‡ĞµĞ¼ Ğ½Ğ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğµ! ğŸ’ª`;
                }
            }

            return { kcalDiff, simpleDiff, protDiff, message, thisWeek, lastWeek };
        } catch (e) {
            return null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART DISMISS â€” Ğ£Ğ¼Ğ½Ğ¾Ğµ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ÑĞ¾Ğ²ĞµÑ‚Ğ°
     * @param {string} adviceId
     * @param {number} visibleMs - Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ñ Ğ±Ñ‹Ğ» Ğ²Ğ¸Ğ´ĞµĞ½
     */
    function trackDismiss(adviceId, visibleMs) {
        try {
            if (visibleMs < QUICK_DISMISS_THRESHOLD_MS) {
                const key = 'heys_dismiss_' + adviceId;
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                const stored = HEYS.store?.get
                    ? HEYS.store.get(key, null)
                    : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
                const count = parseInt(stored || '0', 10);
                const nextValue = String(count + 1);
                if (HEYS.store?.set) {
                    HEYS.store.set(key, nextValue);
                } else if (U.lsSet) {
                    U.lsSet(key, nextValue);
                } else {
                    localStorage.setItem(key, nextValue);
                }
            }
        } catch (e) { }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¼Ğ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¹
     * @param {string} adviceId
     * @returns {number} 1.0 = Ğ½Ğ¾Ñ€Ğ¼Ğ°, <1 = ÑĞ½Ğ¸Ğ¶ĞµĞ½
     */
    function getDismissPenalty(adviceId) {
        try {
            const key = 'heys_dismiss_' + adviceId;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            const count = parseInt(stored || '0', 10);
            if (count >= 3) return 0.3;  // 3+ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¹ = ÑĞ¸Ğ»ÑŒĞ½Ğ¾ ÑĞ½Ğ¸Ğ¶Ğ°ĞµĞ¼
            if (count >= 2) return 0.5;  // 2 = ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ğ¾
            if (count >= 1) return 0.7;  // 1 = ÑĞ»ĞµĞ³ĞºĞ°
            return 1.0;
        } catch (e) {
            return 1.0;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DYNAMIC TTL â€” ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ TTL Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´Ğ»Ğ¸Ğ½Ñ‹ Ñ‚ĞµĞºÑÑ‚Ğ°
     * @param {string} text
     * @param {boolean} isCritical
     * @returns {number} TTL Ğ² Ğ¼Ñ
     */
    function calculateDynamicTTL(text, isCritical = false) {
        const baseTime = text.length * TTL_CONFIG.msPerChar;
        let ttl = Math.max(TTL_CONFIG.minTTL, Math.min(TTL_CONFIG.maxTTL, baseTime));
        if (isCritical) ttl += TTL_CONFIG.criticalBonus;
        return ttl;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVICE CHAINS â€” Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ follow-up ÑĞ¾Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°
     * @param {string} prevAdviceId
     * @returns {Object|null} { nextAdviceId, ready: boolean }
     */
    function checkAdviceChain(prevAdviceId) {
        const chain = ADVICE_CHAINS[prevAdviceId];
        if (!chain) return null;

        try {
            const key = 'heys_chain_' + prevAdviceId;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const shownAt = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            if (!shownAt) return null;

            const elapsed = Date.now() - parseInt(shownAt, 10);
            const ready = elapsed >= chain.delayMinutes * 60 * 1000;

            return { nextAdviceId: chain.next, ready };
        } catch (e) {
            return null;
        }
    }

    /**
     * Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ· ÑĞ¾Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ chain
     * @param {string} adviceId
     */
    function markChainStartForAdvice(adviceId) {
        if (ADVICE_CHAINS[adviceId]) {
            try {
                const key = 'heys_chain_' + adviceId;
                const HEYS = window.HEYS || {};
                const U = HEYS.utils || {};
                const value = String(Date.now());
                if (HEYS.store?.set) {
                    HEYS.store.set(key, value);
                } else if (U.lsSet) {
                    U.lsSet(key, value);
                } else {
                    localStorage.setItem(key, value);
                }
            } catch (e) { }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STREAK GAMIFICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ milestone streak Ğ¸ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ
     * @param {number} currentStreak
     * @returns {Object|null} { milestone, remain, icon, text }
     */
    function getNextStreakMilestone(currentStreak) {
        for (const m of STREAK_MILESTONES) {
            if (currentStreak < m.days) {
                const remain = m.days - currentStreak;
                const text = m.text.replace('${remain}', String(remain));
                return { milestone: m.days, remain, icon: m.icon, text };
            }
        }
        return null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WEEKLY SUMMARY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (Ğ´Ğ»Ñ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒÑ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼)
     * @returns {Object|null} { avgKcal, avgProt, avgSimple, bestDay, worstDay, message }
     */
    function getWeeklySummary() {
        try {
            const lsGet = (window.HEYS?.utils?.lsGet) || ((k, d) => {
                try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
            });

            const today = new Date();
            if (today.getDay() !== 0) return null; // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ

            const weekDays = [];

            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const iso = d.toISOString().slice(0, 10);
                const dayData = lsGet('heys_dayv2_' + iso, null);
                if (dayData?.meals?.length > 0) {
                    weekDays.push({
                        date: iso,
                        kcal: dayData.dayTot?.kcal || 0,
                        prot: dayData.dayTot?.prot || 0,
                        simple: dayData.dayTot?.simple || 0,
                        score: dayData.dayScore || 0
                    });
                }
            }

            if (weekDays.length < 3) return null;

            const avgKcal = Math.round(weekDays.reduce((s, d) => s + d.kcal, 0) / weekDays.length);
            const avgProt = Math.round(weekDays.reduce((s, d) => s + d.prot, 0) / weekDays.length);
            const avgSimple = Math.round(weekDays.reduce((s, d) => s + d.simple, 0) / weekDays.length);

            const bestDay = weekDays.reduce((best, d) => d.score > best.score ? d : best, weekDays[0]);
            const worstDay = weekDays.reduce((worst, d) => d.score < worst.score && d.score > 0 ? d : worst, weekDays[0]);

            const message = `ĞĞµĞ´ĞµĞ»Ñ: ${weekDays.length} Ğ´Ğ½ĞµĞ¹, ~${avgKcal} ĞºĞºĞ°Ğ»/Ğ´ĞµĞ½ÑŒ, ~${avgProt}Ğ³ Ğ±ĞµĞ»ĞºĞ°`;

            return { avgKcal, avgProt, avgSimple, bestDay, worstDay, message, daysTracked: weekDays.length };
        } catch (e) {
            return null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ½ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ ÑÑƒÑ‚Ğ¾Ğº
     * @param {number} hour - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ (0-23)
     * @returns {'gentle'|'active'|'calm'}
     */
    function getToneForHour(hour) {
        // Ğ£Ğ±Ñ€Ğ°Ğ½ silent Ñ€ĞµĞ¶Ğ¸Ğ¼ â€” ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ 24/7
        if (hour >= 6 && hour < 10) return 'gentle';   // Ğ£Ñ‚Ñ€Ğ¾ â€” Ğ¼ÑĞ³ĞºĞ¾
        if (hour >= 10 && hour < 18) return 'active';  // Ğ”ĞµĞ½ÑŒ â€” Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾
        return 'calm'; // Ğ’ĞµÑ‡ĞµÑ€/Ğ½Ğ¾Ñ‡ÑŒ â€” ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ğ¾
    }

    /**
     * ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ HEYS.ratioZones Ğ´Ğ»Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ²
     * @param {Object} params
     * @returns {'normal'|'stressed'|'crashed'|'success'|'returning'}
     */
    function getEmotionalState(params) {
        const { day, currentStreak, mealCount, kcalPct, totalDaysTracked, goal } = params;
        const hour = new Date().getHours();
        const HEYS = window.HEYS || {};
        const U = HEYS.utils || {};

        // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ goal â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ goal-aware Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
        if (goal) {
            // Ğ’ĞµÑ€Ğ½ÑƒĞ»ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµÑ€Ñ‹Ğ²Ğ°
            let lastVisitDaysAgo = 0;
            try {
                const lastVisit = HEYS.store?.get
                    ? HEYS.store.get('heys_last_visit', null)
                    : (U.lsGet ? U.lsGet('heys_last_visit', null) : localStorage.getItem('heys_last_visit'));
                if (lastVisit) {
                    const last = new Date(lastVisit);
                    const now = new Date();
                    lastVisitDaysAgo = Math.floor((now - last) / (1000 * 60 * 60 * 24));
                }
            } catch (e) { }
            if (lastVisitDaysAgo > 3) return 'returning';

            // ğŸ”’ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ»Ğ¾Ğ¶Ğ½Ğ¾Ğ³Ğ¾ "ÑÑ€Ñ‹Ğ²Ğ°":
            // - ĞĞµ ÑÑƒĞ´Ğ¸Ğ¼ Ğ¾ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€Ğµ ÑƒÑ‚Ñ€Ğ¾Ğ¼ (Ğ´Ğ¾ 12:00) Ğ¸Ğ»Ğ¸ ĞµÑĞ»Ğ¸ Ğ¼Ğ°Ğ»Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ²
            // - ĞĞµ ÑÑƒĞ´Ğ¸Ğ¼ Ğ¾ ÑÑ€Ñ‹Ğ²Ğµ ĞµÑĞ»Ğ¸ kcalPct Ğ±Ğ»Ğ¸Ğ·Ğ¾Ğº Ğº Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¼Ñƒ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ñƒ
            const isEarlyForUnder = hour < 12 || mealCount < 2;
            const isEarlyForOver = hour < 10 || mealCount < 1;

            // Ğ¡Ñ€Ñ‹Ğ² â€” ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ±Ğ¸Ğ»ÑÑ Ğ¸Ğ· Ñ†ĞµĞ»Ğ¸ (Ğ½Ğ¾ Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¾Ğ¹ Ğ¾Ñ‚ Ñ€Ğ°Ğ½Ğ½ĞµĞ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)
            const criticallyOver = isCriticallyOver(kcalPct, goal);
            const criticallyUnder = isCriticallyUnder(kcalPct, goal);

            // ĞŸĞµÑ€ĞµĞ±Ğ¾Ñ€ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ€Ğ°Ğ·Ñƒ (ĞµÑĞ»Ğ¸ ÑÑŠĞµĞ» >115%)
            if (criticallyOver && !isEarlyForOver) return 'crashed';

            // ĞĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ (Ğ¿Ğ¾ÑĞ»Ğµ 18:00) Ğ¸ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ñ‹
            if (criticallyUnder && hour >= 18 && mealCount >= 1) return 'crashed';

            // Ğ¡Ñ‚Ñ€ĞµÑÑ â€” Ğ½Ğ¸Ğ·ĞºĞ¾Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ
            const avgMood = calculateAverageMood(day);
            if (avgMood > 0 && avgMood < 3) return 'stressed';

            // Ğ£ÑĞ¿ĞµÑ… â€” Ğ² Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ¸Ğ»Ğ¸ streak
            if (currentStreak >= 3 || isInTargetRange(kcalPct, goal)) return 'success';

            return 'normal';
        }

        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ratioZones (legacy fallback)
        const rz = HEYS.ratioZones;
        if (rz) {
            return rz.getEmotionalCategory(kcalPct, currentStreak);
        }

        // Fallback ĞµÑĞ»Ğ¸ ratioZones Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½
        // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ lastVisitDaysAgo Ğ¸Ğ· localStorage
        let lastVisitDaysAgo = 0;
        try {
            const lastVisit = HEYS.store?.get
                ? HEYS.store.get('heys_last_visit', null)
                : (U.lsGet ? U.lsGet('heys_last_visit', null) : localStorage.getItem('heys_last_visit'));
            if (lastVisit) {
                const last = new Date(lastVisit);
                const now = new Date();
                lastVisitDaysAgo = Math.floor((now - last) / (1000 * 60 * 60 * 24));
            }
        } catch (e) { }

        // Ğ’ĞµÑ€Ğ½ÑƒĞ»ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµÑ€Ñ‹Ğ²Ğ°
        if (lastVisitDaysAgo > 3) return 'returning';

        // Ğ¡Ñ€Ñ‹Ğ² â€” ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ¿ĞµÑ€ĞµĞµĞ» Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ĞµĞ»
        // âš ï¸ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°: Ğ½Ğµ ÑÑƒĞ´Ğ¸Ğ¼ Ğ¾ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€Ğµ ÑƒÑ‚Ñ€Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ ĞµÑĞ»Ğ¸ Ğ¼Ğ°Ğ»Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ²
        const isEarlyForUnder = hour < 12 || mealCount < 2;
        if (kcalPct > 1.3) return 'crashed';
        if (kcalPct < 0.5 && hour >= 18 && mealCount >= 1) return 'crashed';

        // Ğ¡Ñ‚Ñ€ĞµÑÑ â€” Ğ½Ğ¸Ğ·ĞºĞ¾Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ
        const avgMood = calculateAverageMood(day);
        if (avgMood > 0 && avgMood < 3) return 'stressed';

        // Ğ£ÑĞ¿ĞµÑ… â€” streak Ğ¸Ğ»Ğ¸ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ (0.75-1.1)
        if (currentStreak >= 3 || (kcalPct >= 0.75 && kcalPct <= 1.1)) return 'success';

        return 'normal';
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
     * @param {Object} day
     * @returns {number} 0 ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¸Ğ½Ğ°Ñ‡Ğµ 1-5
     */
    function calculateAverageMood(day) {
        const meals = day?.meals || [];
        const moods = meals.map(m => m.mood).filter(m => m > 0);
        if (moods.length === 0) return 0;
        return moods.reduce((a, b) => a + b, 0) / moods.length;
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ ÑÑ‚Ñ€ĞµÑÑ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
     * @param {Object} day
     * @returns {number} 0 ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¸Ğ½Ğ°Ñ‡Ğµ 1-5
     */
    function calculateAverageStress(day) {
        const meals = day?.meals || [];
        const stresses = meals.map(m => m.stress).filter(s => s > 0);
        if (stresses.length === 0) return 0;
        return stresses.reduce((a, b) => a + b, 0) / stresses.length;
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ ÑĞ°Ğ¼Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ğµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
     * @param {Object} day
     * @returns {number} 0 ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¸Ğ½Ğ°Ñ‡Ğµ 1-5
     */
    function calculateAverageWellbeing(day) {
        const meals = day?.meals || [];
        const values = meals.map(m => m.wellbeing).filter(w => w > 0);
        if (values.length === 0) return 0;
        return values.reduce((a, b) => a + b, 0) / values.length;
    }

    /**
     * ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¾ÑĞ¾Ğ±Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ (Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº, Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ° Ğ¸ Ñ‚.Ğ´.)
     * @param {Date} date
     * @returns {string|null}
     */
    function getSpecialDay(date) {
        const day = date.getDay();
        const month = date.getMonth();
        const dateNum = date.getDate();
        const hour = date.getHours();

        // ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´
        if (month === 0 && dateNum === 1) return 'new_year';

        // ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº ÑƒÑ‚Ñ€Ğ¾
        if (day === 1 && hour < 12) return 'monday_morning';

        // ĞŸÑÑ‚Ğ½Ğ¸Ñ†Ğ° Ğ²ĞµÑ‡ĞµÑ€
        if (day === 5 && hour >= 17) return 'friday_evening';

        // Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ²ĞµÑ‡ĞµÑ€
        if (day === 0 && hour >= 18) return 'sunday_evening';

        // ĞšĞ¾Ğ½ĞµÑ† Ğ¼ĞµÑÑÑ†Ğ°
        if (dateNum >= 28) return 'month_end';

        return null;
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ğ¾ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
     * @param {Array} advices
     * @param {string} emotionalState
     * @returns {Array}
     */
    function filterByEmotionalState(advices, emotionalState) {
        // ĞŸÑ€Ğ¸ ÑÑ‚Ñ€ĞµÑÑĞµ Ğ¸Ğ»Ğ¸ ÑÑ€Ñ‹Ğ²Ğµ â€” ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ warnings
        if (emotionalState === 'stressed' || emotionalState === 'crashed') {
            return advices.filter(a => a.type !== 'warning');
        }
        return advices;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ·Ğ°Ğ½ÑÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ° Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ° Ğ¸ Ñ‚.Ğ´.)
     * @param {Object} uiState
     * @returns {boolean}
     */
    function isUserBusy(uiState) {
        if (!uiState) return false;
        return !!(
            uiState.modalOpen ||
            uiState.searchOpen ||
            uiState.showTimePicker ||
            uiState.showGramsPicker ||
            uiState.showWeightPicker ||
            uiState.showDeficitPicker ||
            uiState.showZonePicker ||
            uiState.showSleepQualityPicker ||
            uiState.showDayScorePicker ||
            uiState.showHouseholdPicker ||
            uiState.showTrainingPicker
        );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SESSION MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞµÑÑĞ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
     * @returns {Object}
     */
    function getSessionData() {
        try {
            const data = sessionStorage.getItem(SESSION_KEY);
            return data ? JSON.parse(data) : { shown: [], count: 0, lastShown: 0 };
        } catch (e) {
            return { shown: [], count: 0, lastShown: 0 };
        }
    }

    /**
     * Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ ÑĞµÑÑĞ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
     * @param {Object} data
     */
    function saveSessionData(data) {
        try {
            sessionStorage.setItem(SESSION_KEY, JSON.stringify(data));
        } catch (e) {
            // Ignore storage errors
        }
    }

    /**
     * ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚ ĞºĞ°Ğº Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹
     * @param {string} adviceId
     */
    function markAdviceShown(adviceId) {
        const data = getSessionData();
        if (!data.shown.includes(adviceId)) {
            data.shown.push(adviceId);
        }
        data.count++;
        data.lastShown = Date.now();
        saveSessionData(data);
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ²ĞµÑ‚
     * @param {string} adviceId
     * @param {Object} options - { canSkipCooldown?: boolean }
     * @returns {boolean}
     */
    function canShowAdvice(adviceId, options = {}) {
        const data = getSessionData();

        // Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² Ğ·Ğ° ÑĞµÑÑĞ¸Ñ
        if (data.count >= MAX_ADVICES_PER_SESSION) return false;

        // Cooldown Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾Ğ²ĞµÑ‚Ğ°Ğ¼Ğ¸ (ĞµÑĞ»Ğ¸ Ğ½Ğµ canSkipCooldown)
        if (!options.canSkipCooldown && Date.now() - data.lastShown < ADVICE_COOLDOWN_MS) return false;

        // Ğ£Ğ¶Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ ÑĞ¾Ğ²ĞµÑ‚
        if (data.shown.includes(adviceId)) return false;

        return true;
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ excludes
     * Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ²ĞµÑ‚ A.excludes ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ B.id, Ğ¸ Ğ¾Ğ±Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ A (Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ)
     * @param {Array} advices - ĞÑ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ ÑĞ¾Ğ²ĞµÑ‚Ñ‹
     * @returns {Array}
     */
    function filterByExcludes(advices) {
        const excludedIds = new Set();
        const result = [];

        for (const advice of advices) {
            // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ ÑĞ¾Ğ²ĞµÑ‚ ÑƒĞ¶Ğµ Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
            if (excludedIds.has(advice.id)) continue;

            result.push(advice);

            // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ excludes Ğ² Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ñ‹Ğµ
            if (advice.excludes && Array.isArray(advice.excludes)) {
                for (const exId of advice.excludes) {
                    excludedIds.add(exId);
                }
            }
        }

        return result;
    }

    /**
     * Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ â€” Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ñ… ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½
     * @param {Array} advices - Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹ (ÑƒĞ¶Ğµ Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ)
     * @returns {Array}
     */
    function deduplicateAdvices(advices) {
        const shownGroups = new Set();
        const result = [];

        for (const advice of advices) {
            // ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ, Ğº ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ ÑĞ¾Ğ²ĞµÑ‚
            let adviceGroup = null;
            for (const [group, ids] of Object.entries(DEDUPLICATION_RULES)) {
                if (ids.includes(advice.id)) {
                    adviceGroup = group;
                    break;
                }
            }

            // Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ²ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ¸Ñ‚ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° ÑƒĞ¶Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ° â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
            if (adviceGroup && shownGroups.has(adviceGroup)) {
                continue;
            }

            result.push(advice);
            if (adviceGroup) {
                shownGroups.add(adviceGroup);
            }
        }

        return result;
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸ÑĞ¼
     * @param {Array} advices
     * @returns {Array}
     */
    function filterByTimeRestrictions(advices) {
        const hour = new Date().getHours();

        return advices.filter(advice => {
            const restriction = TIME_RESTRICTIONS[advice.id];
            if (!restriction) return true; // ĞĞµÑ‚ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹

            // notAfterHour: Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ N Ñ‡Ğ°ÑĞ¾Ğ²
            if (restriction.notAfterHour !== undefined && hour >= restriction.notAfterHour) {
                return false;
            }

            // notBeforeHour: Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾ N Ñ‡Ğ°ÑĞ¾Ğ²
            if (restriction.notBeforeHour !== undefined && hour < restriction.notBeforeHour) {
                return false;
            }

            // onlyBetweenHours: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ [from, to]
            if (restriction.onlyBetweenHours) {
                const [from, to] = restriction.onlyBetweenHours;
                if (hour < from || hour >= to) {
                    return false;
                }
            }

            return true;
        });
    }

    /**
     * ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼ (Ğ°Ğ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼)
     * ĞĞµ Ğ±Ğ¾Ğ»ĞµĞµ MAX_ADVICES_PER_CATEGORY ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
     * @param {Array} advices
     * @returns {Array}
     */
    function limitByCategory(advices) {
        const categoryCount = {};
        const result = [];

        for (const advice of advices) {
            const cat = advice.category || 'other';
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;

            if (categoryCount[cat] <= MAX_ADVICES_PER_CATEGORY) {
                result.push(advice);
            }
        }

        return result;
    }

    /**
     * ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ boost Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ° Ğ´Ğ»Ñ goal-specific ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @param {Array} advices
     * @param {Object} goal - Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ goal Ñ€ĞµĞ¶Ğ¸Ğ¼
     * @returns {Array}
     */
    function applyGoalBoost(advices, goal) {
        if (!goal) return advices;

        const goalPrefix = goal.mode + '_'; // 'bulk_', 'deficit_', 'maintenance_'

        return advices.map(advice => {
            // Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸ĞµÑÑ Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ goal Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ boost
            if (advice.id.startsWith(goalPrefix)) {
                return { ...advice, priority: advice.priority - 10 }; // ĞœĞµĞ½ÑŒÑˆĞµ = Ğ²Ñ‹ÑˆĞµ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚
            }
            return advice;
        });
    }

    /**
     * Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº ÑĞµÑÑĞ¸Ğ¸ (Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ğ´Ğ½Ñ)
     */
    function resetSessionAdvices() {
        saveSessionData({ shown: [], count: 0, lastShown: 0 });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRACKING â€” Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @returns {Object} { [adviceId]: { shown: number, clicked: number, lastShown: timestamp } }
     */
    function getTrackingStats() {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const parsed = HEYS.store?.get
                ? (HEYS.store.get(TRACKING_KEY, null) || {})
                : (U.lsGet ? (U.lsGet(TRACKING_KEY, null) || {}) : JSON.parse(localStorage.getItem(TRACKING_KEY) || 'null') || {});

            let stats = parsed;
            if (typeof stats === 'string') {
                try {
                    stats = JSON.parse(stats);
                } catch (e) {
                    stats = {};
                }
            }
            if (!stats || typeof stats !== 'object' || Array.isArray(stats)) {
                stats = {};
            }

            // ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°: ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ÑÑ‚Ğ°Ñ€ÑˆĞµ 30 Ğ´Ğ½ĞµĞ¹
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
            let needsSave = false;
            Object.keys(stats).forEach(key => {
                if (stats[key].lastShown && (now - stats[key].lastShown) > THIRTY_DAYS) {
                    delete stats[key];
                    needsSave = true;
                }
            });
            if (needsSave) {
                if (HEYS.store?.set) {
                    HEYS.store.set(TRACKING_KEY, stats);
                } else if (U.lsSet) {
                    U.lsSet(TRACKING_KEY, stats);
                } else {
                    localStorage.setItem(TRACKING_KEY, JSON.stringify(stats));
                }
            }
            return stats;
        } catch (e) {
            return {};
        }
    }

    /**
     * Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
     * @param {Object} stats
     */
    function saveTrackingStats(stats) {
        try {
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(TRACKING_KEY, stats);
            } else if (U.lsSet) {
                U.lsSet(TRACKING_KEY, stats);
            } else {
                localStorage.setItem(TRACKING_KEY, JSON.stringify(stats));
            }
        } catch (e) {
            // Ignore storage errors
        }
    }

    /**
     * Ğ¢Ñ€ĞµĞºĞ°ĞµÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ· ÑĞ¾Ğ²ĞµÑ‚Ğ°
     * @param {string} adviceId
     */
    function trackAdviceShown(adviceId) {
        const stats = getTrackingStats();
        if (!stats[adviceId]) {
            stats[adviceId] = { shown: 0, clicked: 0, lastShown: 0 };
        }
        stats[adviceId].shown++;
        stats[adviceId].lastShown = Date.now();
        saveTrackingStats(stats);
    }

    /**
     * Ğ¢Ñ€ĞµĞºĞ°ĞµÑ‚ ĞºĞ»Ğ¸Ğº/Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ğ¾ ÑĞ¾Ğ²ĞµÑ‚Ñƒ
     * @param {string} adviceId
     */
    function trackAdviceClicked(adviceId) {
        const stats = getTrackingStats();
        if (!stats[adviceId]) {
            stats[adviceId] = { shown: 0, clicked: 0, lastShown: 0 };
        }
        stats[adviceId].clicked++;
        saveTrackingStats(stats);
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ CTR (click-through rate) ÑĞ¾Ğ²ĞµÑ‚Ğ°
     * @param {string} adviceId
     * @returns {number} 0-1
     */
    function getAdviceCTR(adviceId) {
        const stats = getTrackingStats();
        const s = stats[adviceId];
        if (!s || s.shown === 0) return 0;
        return s.clicked / s.shown;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ¿ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¿Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ¼
     * @param {number} n - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
     * @returns {Array<{id: string, shown: number, clicked: number, ctr: number}>}
     */
    function getTopAdvices(n = 10) {
        const stats = getTrackingStats();
        return Object.entries(stats)
            .map(([id, s]) => ({ id, ...s, ctr: s.shown > 0 ? s.clicked / s.shown : 0 }))
            .sort((a, b) => b.shown - a.shown)
            .slice(0, n);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOAL-AWARE HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     * @param {number} deficitPct - ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚Ğ°/Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚Ğ° (Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ = Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚, Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ = Ğ½Ğ°Ğ±Ğ¾Ñ€)
     * @returns {{mode: 'deficit'|'maintenance'|'bulk', label: string, emoji: string, targetRange: {min: number, max: number}}}
     */
    function getGoalMode(deficitPct) {
        const pct = deficitPct || 0;

        if (pct <= -10) {
            // ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ (-10% Ğ¸ Ğ½Ğ¸Ğ¶Ğµ)
            return {
                mode: 'deficit',
                label: 'ĞŸĞ¾Ñ…ÑƒĞ´ĞµĞ½Ğ¸Ğµ',
                emoji: 'ğŸ”¥',
                // Ğ£ÑĞ¿ĞµÑ…: 90-105% Ğ¾Ñ‚ optimum (Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ°Ñ Ğ½Ğ° Ğ¿Ğ¾Ğ³Ñ€ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ)
                targetRange: { min: 0.90, max: 1.05 },
                // ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€: >115% (ÑƒĞ¶Ğµ ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ²Ñ‹Ğ±Ğ¸Ğ»ÑÑ Ğ¸Ğ· Ğ¿Ğ»Ğ°Ğ½Ğ°)
                criticalOver: 1.15,
                // ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€: <80%
                criticalUnder: 0.80
            };
        } else if (pct <= -5) {
            // Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ (-5% Ğ´Ğ¾ -9%)
            return {
                mode: 'deficit',
                label: 'Ğ›Ñ‘Ğ³ĞºĞ¾Ğµ Ğ¿Ğ¾Ñ…ÑƒĞ´ĞµĞ½Ğ¸Ğµ',
                emoji: 'ğŸ¯',
                targetRange: { min: 0.92, max: 1.08 },
                criticalOver: 1.20,
                criticalUnder: 0.75
            };
        } else if (pct >= 10) {
            // ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ (+10% Ğ¸ Ğ²Ñ‹ÑˆĞµ)
            return {
                mode: 'bulk',
                label: 'ĞĞ°Ğ±Ğ¾Ñ€ Ğ¼Ğ°ÑÑÑ‹',
                emoji: 'ğŸ’ª',
                // Ğ£ÑĞ¿ĞµÑ…: 95-110% Ğ¾Ñ‚ optimum
                targetRange: { min: 0.95, max: 1.10 },
                // ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€: >125% (ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾)
                criticalOver: 1.25,
                // ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€: <85% (Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑˆÑŒ Ğ´Ğ»Ñ Ñ€Ğ¾ÑÑ‚Ğ°)
                criticalUnder: 0.85
            };
        } else if (pct >= 5) {
            // Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ (+5% Ğ´Ğ¾ +9%)
            return {
                mode: 'bulk',
                label: 'Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€',
                emoji: 'ğŸ’ª',
                targetRange: { min: 0.93, max: 1.12 },
                criticalOver: 1.20,
                criticalUnder: 0.80
            };
        } else {
            // ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ (-4% Ğ´Ğ¾ +4%)
            return {
                mode: 'maintenance',
                label: 'ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ',
                emoji: 'âš–ï¸',
                targetRange: { min: 0.90, max: 1.10 },
                criticalOver: 1.25,
                criticalUnder: 0.70
            };
        }
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ² Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¼ Ğ»Ğ¸ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸
     * @param {number} kcalPct - ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¾Ñ‚ optimum
     * @param {Object} goal - ĞĞ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚ getGoalMode()
     * @returns {boolean}
     */
    function isInTargetRange(kcalPct, goal) {
        return kcalPct >= goal.targetRange.min && kcalPct <= goal.targetRange.max;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€ (Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ñ†ĞµĞ»Ğ¸)
     * @param {number} kcalPct
     * @param {Object} goal
     * @returns {boolean}
     */
    function isCriticallyOver(kcalPct, goal) {
        return kcalPct > goal.criticalOver;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ (Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ñ†ĞµĞ»Ğ¸)
     * @param {number} kcalPct
     * @param {Object} goal
     * @returns {boolean}
     */
    function isCriticallyUnder(kcalPct, goal) {
        return kcalPct < goal.criticalUnder;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVICE GENERATION (Core)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function buildDerivedContext(ctx) {
        const dayTot = ctx?.dayTot || {};
        const normAbs = ctx?.normAbs || {};
        const day = ctx?.day || {};

        const proteinPct = (dayTot?.prot || 0) / (normAbs?.prot || 1);
        const fatPct = (dayTot?.fat || 0) / (normAbs?.fat || 1);
        const carbsPct = (dayTot?.carbs || 0) / (normAbs?.carbs || 1);
        const fiberPct = (dayTot?.fiber || 0) / (normAbs?.fiber || 1);
        const simplePct = (dayTot?.simple || 0) / (normAbs?.simple || 1);
        const transPct = (dayTot?.trans || 0) / (normAbs?.trans || 1);
        const harmPct = (dayTot?.harm || 0) / (normAbs?.harm || 1);
        const goodFatPct = (dayTot?.good || 0) / (normAbs?.good || 1);

        const isRefeedDay = day?.isRefeedDay || false;
        const kcalPct = ctx?.kcalPct || (dayTot?.kcal || 0) / (ctx?.optimum || 2000);
        const isRefeedExcessOk = isRefeedDay && kcalPct > 1.0 && kcalPct <= 1.35;
        const isDayEmpty = (dayTot?.kcal || 0) < 10 && (ctx?.mealCount || 0) === 0;
        const waterPct = (day?.waterMl || 0) / (ctx?.waterGoal || 2000);

        return {
            proteinPct,
            fatPct,
            carbsPct,
            fiberPct,
            simplePct,
            transPct,
            harmPct,
            goodFatPct,
            isRefeedDay,
            kcalPct,
            isRefeedExcessOk,
            isDayEmpty,
            waterPct
        };
    }

    function evaluateRules(rules, ctx, helpers) {
        const advices = [];
        for (const rule of rules) {
            if (typeof rule.condition === 'function' && !rule.condition(ctx, helpers)) continue;
            const advice = typeof rule.build === 'function' ? rule.build(ctx, helpers) : { ...rule };
            if (!advice) continue;
            advices.push(advice);
        }
        return advices;
    }

    function collectModuleAdvices(ctx) {
        const advices = [];
        const modules = window.HEYS?.adviceModules || {};
        const helpers = window.HEYS?.adviceCoreHelpers || {};
        const order = ['nutrition', 'timing', 'training', 'emotional', 'hydration', 'other'];

        for (const key of order) {
            const mod = modules[key];
            if (!mod) continue;
            try {
                if (typeof mod === 'function') {
                    const list = mod(ctx, helpers) || [];
                    if (Array.isArray(list)) advices.push(...list);
                    continue;
                }
                if (Array.isArray(mod)) {
                    advices.push(...evaluateRules(mod, ctx, helpers));
                }
            } catch (e) {
                console.error('[HEYS.advice] âŒ Module "' + key + '" error:', e?.message, e?.stack?.split('\n')[1]);
            }
        }

        return advices;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑĞ¾Ğ²ĞµÑ‚ ÑĞ¾ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ (Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ¸Ğ· Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²)
     * @param {Object} advice - ĞĞ±ÑŠĞµĞºÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ğ° Ñ id, text (string|array), Ğ¸ Ğ´Ñ€.
     * @param {Object} ctx - ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ personalizeText
     * @returns {Object} Ğ¡Ğ¾Ğ²ĞµÑ‚ ÑĞ¾ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
     */
    function createAdvice(advice, ctx) {
        // Ğ•ÑĞ»Ğ¸ text â€” Ğ¼Ğ°ÑÑĞ¸Ğ², Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾ id
        const rawText = Array.isArray(advice.text)
            ? pickRandomText(advice.text, advice.id)
            : advice.text;

        // ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚
        const text = ctx ? personalizeText(rawText, ctx) : rawText;

        return { ...advice, text };
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑĞµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
     * @param {Object} ctx - ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ½Ñ
     * @returns {Array} ĞœĞ°ÑÑĞ¸Ğ² ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     */
    function generateAdvices(ctx) {
        // ğŸš€ Early exit: ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ½ĞµĞ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²
        if (!ctx || !ctx.normAbs) {
            return [];
        }

        // ğŸš€ CACHE CHECK: Ğ•ÑĞ»Ğ¸ ĞºÑÑˆ Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¸Ğ· ĞºÑÑˆĞ°
        if (isCacheValid(ctx)) {
            return adviceCache.result;
        }

        const derived = buildDerivedContext(ctx);
        const fullCtx = { ...ctx, ...derived };

        const advices = collectModuleAdvices(fullCtx);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¯ APPLY DISMISS PENALTY & DYNAMIC TTL (NEW!)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ penalty Ğº Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¹
        for (const advice of advices) {
            const penalty = getDismissPenalty(advice.id);
            if (penalty < 1) {
                advice.priority = Math.round(advice.priority / penalty); // Ğ’Ñ‹ÑˆĞµ priority = Ğ½Ğ¸Ğ¶Ğµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ
            }

            // ĞŸĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ TTL Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´Ğ»Ğ¸Ğ½Ñ‹ Ñ‚ĞµĞºÑÑ‚Ğ°
            if (!advice.ttl || advice.ttl === 5000) { // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ³Ğ¾ TTL
                const isCritical = advice.type === 'critical' || advice.canSkipCooldown;
                advice.ttl = calculateDynamicTTL(advice.text, isCritical);
            }
        }

        // ğŸš€ CACHE RESULT: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² ĞºÑÑˆ Ğ¿ĞµÑ€ĞµĞ´ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ¾Ğ¼
        adviceCache = {
            key: generateCacheKey(fullCtx),
            result: advices,
            timestamp: Date.now()
        };

        return advices;
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ñ‡Ğ°ÑÑ‹ ÑĞ½Ğ°
     * @param {Object} day
     * @returns {number}
     */
    function calculateSleepHours(day) {
        if (!day?.sleepStart || !day?.sleepEnd) return 0;

        const [startH, startM] = day.sleepStart.split(':').map(Number);
        const [endH, endM] = day.sleepEnd.split(':').map(Number);

        let hours = endH - startH;
        let mins = endM - startM;

        // Ğ•ÑĞ»Ğ¸ Ğ»ĞµĞ³Ğ»Ğ¸ Ğ²Ñ‡ĞµÑ€Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 23:00 â†’ 07:00)
        if (hours < 0) hours += 24;

        return hours + mins / 60;
    }

    /**
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‡Ğ°ÑÑ‹ Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ° Ğ²Ğ¾Ğ´Ñ‹
     * @param {Object} day
     * @returns {number}
     */
    function getHoursSinceWater(day) {
        const lastWater = day?.lastWaterTime ? new Date(day.lastWaterTime) : null;
        if (!lastWater || Number.isNaN(lastWater.getTime())) return 99;
        return (Date.now() - lastWater.getTime()) / (1000 * 60 * 60);
    }

    /**
     * Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ N Ğ´Ğ½ĞµĞ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸Ğ· localStorage
     * @param {number} n - ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ½Ğ°Ğ·Ğ°Ğ´
     * @returns {Array<{date: string, [key: string]: any}>} ĞœĞ°ÑÑĞ¸Ğ² Ğ´Ğ½ĞµĞ¹ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
     */
    function getRecentDays(n) {
        // ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: HEYS.utils (Ñ namespace) â†’ HEYS.dayUtils â†’ fallback
        const lsGet = (window.HEYS?.utils?.lsGet) || (window.HEYS?.dayUtils?.lsGet) || ((k, d) => {
            try {
                const v = localStorage.getItem(k);
                return v ? JSON.parse(v) : d;
            } catch { return d; }
        });

        const days = [];
        const today = new Date();

        for (let i = 1; i <= n; i++) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const iso = d.toISOString().slice(0, 10);
            const dayData = lsGet('heys_dayv2_' + iso, null);

            if (dayData && dayData.date) {
                days.push({ date: iso, ...dayData });
            }
        }

        return days;
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ (sleepStart Ğ¸Ğ· Ñ‡ĞµĞº-Ğ¸Ğ½Ğ°)
     * @param {number} [daysBack=14] - ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
     * @returns {{hour: number, minute: number, formatted: string, count: number}|null}
     */
    function getAverageBedtime(daysBack = 14) {
        const recentDays = getRecentDays(daysBack);

        // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ sleepStart (Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°Ğ½Ğ¸Ñ)
        const bedtimes = recentDays
            .map(d => d.sleepStart)
            .filter(t => t && typeof t === 'string' && t.includes(':'));

        if (bedtimes.length < 3) return null; // ĞÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 Ğ´Ğ½Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

        // ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑƒĞ½Ğ¾Ñ‡Ğ¸ (Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ñ‡Ñ‚Ğ¾ 23:00 > 00:30)
        const minutesFromMidnight = bedtimes.map(t => {
            const [h, m] = t.split(':').map(Number);
            // Ğ•ÑĞ»Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ Ñ€Ğ°Ğ½ÑŒÑˆĞµ 12:00 â€” ÑÑ‚Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»ÑƒĞ½Ğ¾Ñ‡Ğ¸ (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 24Ñ‡)
            // ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 01:00 â†’ 25*60=1500 Ğ¼Ğ¸Ğ½, 23:00 â†’ 23*60=1380 Ğ¼Ğ¸Ğ½
            return h < 12 ? (h + 24) * 60 + m : h * 60 + m;
        });

        // Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ
        const avgMinutes = Math.round(minutesFromMidnight.reduce((a, b) => a + b, 0) / minutesFromMidnight.length);

        // ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ² Ñ‡Ğ°ÑÑ‹:Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
        let hour = Math.floor(avgMinutes / 60);
        const minute = avgMinutes % 60;

        // Ğ•ÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 24 â€” Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ (00:30 â†’ 0.5)
        if (hour >= 24) hour -= 24;

        const formatted = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

        return { hour, minute, formatted, count: bedtimes.length };
    }

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ğ°ÑĞ¾Ğ² Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ´Ğ¾ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ ÑĞ½Ğ°
     * @param {number} currentHour - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ
     * @param {Object} [prof] - ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (fallback Ğ½Ğ° sleepHours)
     * @returns {{hoursUntilBed: number, bedtimeFormatted: string, source: 'history'|'calculated'}}
     */
    function getHoursUntilBedtime(currentHour, prof) {
        // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        const avgBedtime = getAverageBedtime(14);

        if (avgBedtime) {
            // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ğ¸Ñ†Ñƒ
            let bedHour = avgBedtime.hour;
            // Ğ•ÑĞ»Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ ÑĞ½Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»ÑƒĞ½Ğ¾Ñ‡Ğ¸, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 24 Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°
            if (bedHour < 12) bedHour += 24;

            let hoursUntilBed = bedHour - currentHour;
            if (hoursUntilBed < 0) hoursUntilBed += 24;
            if (hoursUntilBed > 12) hoursUntilBed = 0; // Ğ£Ğ¶Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¿Ğ°Ñ‚ÑŒ

            return {
                hoursUntilBed,
                bedtimeFormatted: avgBedtime.formatted,
                source: 'history'
            };
        }

        // Fallback: Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ (ĞµÑĞ»Ğ¸ Ğ²ÑÑ‚Ğ°Ñ‘Ñ‚ Ğ² 7)
        const sleepNormHours = prof?.sleepHours || 8;
        const expectedBedtime = 24 - sleepNormHours + 7; // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ ĞºĞ¾Ğ³Ğ´Ğ° Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑÑ
        const hoursUntilBed = expectedBedtime - currentHour;

        return {
            hoursUntilBed: hoursUntilBed > 0 ? hoursUntilBed : 0,
            bedtimeFormatted: `~${expectedBedtime}:00`,
            source: 'calculated'
        };
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ĞºĞ¾Ñ„Ğµ-ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°ÑĞ°
     * @param {Array} meals - ĞœĞ°ÑÑĞ¸Ğ² Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ² Ğ¿Ğ¸Ñ‰Ğ¸ (day.meals)
     * @param {number} afterHour - ĞŸĞ¾ÑĞ»Ğµ ĞºĞ°ĞºĞ¾Ğ³Ğ¾ Ñ‡Ğ°ÑĞ° Ğ¸ÑĞºĞ°Ñ‚ÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 16)
     * @param {Object} pIndex - Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² { byId: Map, byName: Map }
     * @returns {boolean} true ĞµÑĞ»Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ ĞºĞ¾Ñ„Ğµ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°ÑĞ°
     */
    function hasCoffeeAfterHour(meals, afterHour, pIndex) {
        if (!meals || !Array.isArray(meals)) return false;

        const coffeeKeywords = ['ĞºĞ¾Ñ„Ğµ', 'coffee', 'ĞºĞ°Ğ¿ÑƒÑ‡Ğ¸Ğ½Ğ¾', 'Ğ»Ğ°Ñ‚Ñ‚Ğµ', 'Ğ»Ğ°Ñ‚Ğµ', 'Ñ€Ğ°Ñ„', 'Ğ°Ğ¼ĞµÑ€Ğ¸ĞºĞ°Ğ½Ğ¾', 'ÑÑĞ¿Ñ€ĞµÑÑĞ¾', 'Ñ„Ğ»ÑÑ‚', 'Ğ¼Ğ¾ĞºĞºĞ¾', 'Ğ¼Ğ°ĞºĞ¸Ğ°Ñ‚Ğ¾'];

        for (const meal of meals) {
            // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ°
            if (!meal.time) continue;
            const [h] = meal.time.split(':').map(Number);
            if (h < afterHour) continue;

            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹ Ğ² Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğµ
            for (const item of (meal.items || [])) {
                // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ°
                let name = item.name || '';
                if (!name) {
                    const product = getProductForItem(item, pIndex);
                    if (product) name = product.name || '';
                }

                // Ğ˜Ñ‰ĞµĞ¼ ĞºĞ¾Ñ„Ğµ-ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°
                const nameLower = name.toLowerCase();
                if (coffeeKeywords.some(kw => nameLower.includes(kw))) {
                    return true;
                }
            }
        }

        return false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 0: MEAL & MILESTONE HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑƒĞ¼Ğ¼Ñ‹ Ğ½ÑƒÑ‚Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ° Ğ¿Ğ¸Ñ‰Ğ¸
     * @param {Object} meal - ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ğ¿Ğ¸Ñ‰Ğ¸ (meal object)
     * @param {Object} pIndex - Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² { byId: Map, byName: Map }
     * @returns {Object|null} { kcal, prot, carbs, simple, complex, fat, good, bad, trans, fiber } Ğ¸Ğ»Ğ¸ null
     */
    function getMealTotals(meal, pIndex) {
        if (!meal || !meal.items || meal.items.length === 0) return null;

        // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ HEYS.models.mealTotals ĞµÑĞ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        if (window.HEYS?.models?.mealTotals) {
            return window.HEYS.models.mealTotals(meal, pIndex);
        }

        // Fallback: Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ÑĞ°Ğ¼Ğ¸
        const tot = { kcal: 0, prot: 0, carbs: 0, simple: 0, complex: 0, fat: 0, good: 0, bad: 0, trans: 0, fiber: 0 };

        for (const item of meal.items) {
            const grams = item.grams || 0;
            if (grams <= 0) continue;

            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚ Ğ¸Ğ· Ğ¸Ğ½Ğ´ĞµĞºÑĞ° (Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, fallback Ğ½Ğ° id)
            const product = getProductForItem(item, pIndex);
            if (!product) continue;

            const ratio = grams / 100;
            tot.kcal += (product.kcal100 || 0) * ratio;
            tot.prot += (product.protein100 || 0) * ratio;
            tot.simple += (product.simple100 || 0) * ratio;
            tot.complex += (product.complex100 || 0) * ratio;
            tot.carbs += ((product.simple100 || 0) + (product.complex100 || 0)) * ratio;
            tot.good += (product.goodFat100 || 0) * ratio;
            tot.bad += (product.badFat100 || 0) * ratio;
            tot.trans += (product.trans100 || 0) * ratio;
            tot.fat += ((product.goodFat100 || 0) + (product.badFat100 || 0) + (product.trans100 || 0)) * ratio;
            tot.fiber += (product.fiber100 || 0) * ratio;
        }

        return tot;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ¿Ğ¸Ñ‰Ğ¸ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ°Ğ¼Ğ¸
     * @param {Object} day - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ñ
     * @returns {Object|null} meal Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ»Ğ¸ null
     */
    function getLastMealWithItems(day) {
        const meals = (day?.meals || []).filter(m => m.items?.length > 0);
        return meals.length > 0 ? meals[meals.length - 1] : null;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ¿Ğ¸Ñ‰Ğ¸ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ°Ğ¼Ğ¸
     * @param {Object} day - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ñ
     * @returns {Object|null} meal Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ»Ğ¸ null
     */
    function getFirstMealWithItems(day) {
        const meals = (day?.meals || []).filter(m => m.items?.length > 0);
        return meals.length > 0 ? meals[0] : null;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ±Ñ‹Ğ» Ğ»Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½ milestone (Ğ¿ĞµÑ€ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾)
     * @param {string} id - ID milestone (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ '30_days')
     * @returns {boolean}
     */
    function isMilestoneShown(id) {
        try {
            const key = 'heys_milestone_' + id;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            return stored === '1' || stored === 1 || stored === true;
        } catch (e) {
            return false;
        }
    }

    /**
     * ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ milestone ĞºĞ°Ğº Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹
     * @param {string} id - ID milestone
     */
    function markMilestoneShown(id) {
        try {
            const key = 'heys_milestone_' + id;
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            if (HEYS.store?.set) {
                HEYS.store.set(key, '1');
            } else if (U.lsSet) {
                U.lsSet(key, '1');
            } else {
                localStorage.setItem(key, '1');
            }
        } catch (e) {
            // Ignore storage errors
        }
    }

    /**
     * ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
     * @param {Object} day - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ñ
     * @returns {number}
     */
    function countUniqueProducts(day) {
        const names = new Set();
        (day?.meals || []).forEach(meal => {
            (meal.items || []).forEach(item => {
                // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğº ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
                const name = String(item.name || '').trim().toLowerCase();
                if (name) names.add(name);
            });
        });
        return names.size;
    }

    /**
     * ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ² localStorage
     * Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ clientId Ğ´Ğ»Ñ multi-client Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°
     * @returns {number}
     */
    function getTotalDaysTracked() {
        try {
            const U = HEYS.utils || {};
            const clientId = U.getCurrentClientId ? U.getCurrentClientId() : '';
            let count = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('heys_dayv2_')) {
                    // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ clientId, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ»ÑÑ‡ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ Ğ½ĞµĞ³Ğ¾
                    // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: {clientId}_heys_dayv2_{date} Ğ¸Ğ»Ğ¸ heys_dayv2_{date}
                    if (!clientId || key.startsWith(clientId + '_') || !key.includes('_heys_dayv2_')) {
                        count++;
                    }
                }
            }
            return count;
        } catch (e) {
            return 0;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ streak Ğ¸Ğ· localStorage
     * @returns {number}
     */
    function getPersonalBestStreak() {
        try {
            const key = 'heys_best_streak';
            const HEYS = window.HEYS || {};
            const U = HEYS.utils || {};
            const stored = HEYS.store?.get
                ? HEYS.store.get(key, null)
                : (U.lsGet ? U.lsGet(key, null) : localStorage.getItem(key));
            return parseInt(stored || '0', 10);
        } catch (e) {
            return 0;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ streak ĞµÑĞ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ
     * @param {number} currentStreak - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ streak
     * @returns {boolean} true ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´
     */
    function updatePersonalBestStreak(currentStreak) {
        const best = getPersonalBestStreak();
        if (currentStreak > best) {
            // ğŸ”§ v4.7.1 FIX: ĞÑ‚ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² localStorage Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ¸Ñ‚ÑŒ
            // setState Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ render Ñ„Ğ°Ğ·Ñ‹ React (Cannot update component while rendering)
            setTimeout(() => {
                try {
                    const key = 'heys_best_streak';
                    const HEYS = window.HEYS || {};
                    const U = HEYS.utils || {};
                    if (HEYS.store?.set) {
                        HEYS.store.set(key, String(currentStreak));
                    } else if (U.lsSet) {
                        U.lsSet(key, String(currentStreak));
                    } else {
                        localStorage.setItem(key, String(currentStreak));
                    }
                } catch (e) {
                    // Ignore storage errors
                }
            }, 0);
            return true; // ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!
        }
        return false;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ meal-level ÑĞ¾Ğ²ĞµÑ‚
     * @returns {boolean}
     */
    function canShowMealAdvice() {
        try {
            const last = sessionStorage.getItem('heys_last_meal_advice');
            return !last || (Date.now() - parseInt(last, 10)) > MEAL_ADVICE_THROTTLE_MS;
        } catch (e) {
            return true;
        }
    }

    /**
     * ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° meal-level ÑĞ¾Ğ²ĞµÑ‚Ğ°
     */
    function markMealAdviceShown() {
        try {
            sessionStorage.setItem('heys_last_meal_advice', String(Date.now()));
        } catch (e) {
            // Ignore storage errors
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REACT HOOK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * React hook Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @param {Object} params
     * @param {Object} params.dayTot - Ğ¡ÑƒĞ¼Ğ¼Ñ‹ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
     * @param {Object} params.normAbs - ĞĞ¾Ñ€Ğ¼Ñ‹ Ğ² Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°Ñ…
     * @param {number} params.optimum - Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğ¹ ĞºĞ°Ğ»Ğ¾Ñ€Ğ°Ğ¶
     * @param {Object} params.day - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ñ
     * @param {Map} params.pIndex - Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ²
     * @param {number} params.currentStreak - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ streak (Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¸Ğ· DayTab, ĞĞ• Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾!)
     * @param {string} params.trigger - Ğ§Ñ‚Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ»Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ· ('tab_open'|'product_added')
     * @param {Object} params.uiState - Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ UI Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾ÑÑ‚Ğ¸
     * @param {Object} params.prof - ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (sex, age, weight, sleepHours, insulinWaveHours, deficitPctTarget Ğ¸ Ğ´Ñ€.)
     * @param {number} params.waterGoal - Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ° Ğ²Ğ¾Ğ´Ñ‹ (Ğ¸Ğ· waterGoalBreakdown)
     * @param {Object} params.caloricDebt - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹Ğ½Ğ¾Ğ¼ Ğ´Ğ¾Ğ»Ğ³Ğµ (totalDebt, dailyBoost, hasDebt Ğ¸ Ğ´Ñ€.)
     * @param {number} params.displayOptimum - Ğ¡ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ° Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ´Ğ¾Ğ»Ğ³Ğ°
     * @returns {Object} ĞĞ±ÑŠĞµĞºÑ‚ Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸
     */
    function useAdviceEngine(params) {
        // âš ï¸ Ğ’ĞĞ–ĞĞ: currentStreak Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ÑÑ ĞºĞ°Ğº Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€, ĞĞ• Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ!
        const { dayTot, normAbs, optimum, displayOptimum, caloricDebt, day, pIndex, currentStreak, trigger, uiState, prof, waterGoal } = params;
        const React = window.React;

        // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
        const ctx = React.useMemo(() => {
            try {
            const now = new Date();
            const hour = now.getHours();
            const meals = Array.isArray(day?.meals) ? day.meals : [];
            const mealCount = meals.filter(m => m?.items?.length > 0).length;
            const trainings = Array.isArray(day?.trainings) ? day.trainings : [];
            const hasTraining = trainings.some(t => t?.z && Array.isArray(t.z) && t.z.some(m => m > 0));

            // ğŸ§  Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
            const kcalPct = (dayTot?.kcal || 0) / (optimum || 2000);
            const tone = getToneForHour(hour);
            const specialDay = getSpecialDay(now);

            // ğŸ¯ Goal-aware: Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¾ Ñ†ĞµĞ»Ğ¸ (Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚/Ğ½Ğ°Ğ±Ğ¾Ñ€/Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ)
            const dayDeficit = day?.deficitPct;
            const profileDeficit = prof?.deficitPctTarget;
            const effectiveDeficit = dayDeficit ?? profileDeficit ?? 0;
            const goal = getGoalMode(effectiveDeficit);

            const emotionalState = getEmotionalState({
                day,
                currentStreak: currentStreak || 0,
                mealCount,
                kcalPct,
                goal, // ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ goal Ğ´Ğ»Ñ goal-aware Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ
                totalDaysTracked: 30 // ĞŸÑ€Ğ¸Ğ±Ğ»Ğ¸Ğ·Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾
            });

            // ğŸ†• ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ crashRisk Ğ¸Ğ· Metabolic Intelligence
            let crashRisk = null;
            if (window.HEYS?.Metabolic?.calculateCrashRisk24h) {
                try {
                    crashRisk = window.HEYS.Metabolic.calculateCrashRisk24h();
                } catch (e) {
                    // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ crashRisk
                }
            }

            return {
                dayTot: dayTot || {},
                normAbs: normAbs || {},
                optimum: optimum || 2000,
                displayOptimum: displayOptimum || optimum || 2000, // Ğ¡ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ´Ğ¾Ğ»Ğ³Ğ° (fallback Ğ½Ğ° optimum)
                caloricDebt: caloricDebt || null,                   // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ´Ğ¾Ğ»Ğ³Ğµ
                day: day || {},
                pIndex: pIndex || { byId: new Map(), byName: new Map() },
                currentStreak: currentStreak || 0,
                hour,
                mealCount,
                hasTraining,
                kcalPct,
                tone,
                specialDay,
                emotionalState,
                prof: prof || {},           // ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                waterGoal: waterGoal || 2000, // ĞĞ¾Ñ€Ğ¼Ğ° Ğ²Ğ¾Ğ´Ñ‹
                goal,                        // ğŸ¯ Goal Ñ€ĞµĞ¶Ğ¸Ğ¼ (deficit/bulk/maintenance)
                crashRisk                    // ğŸ†• Ğ Ğ¸ÑĞº ÑÑ€Ñ‹Ğ²Ğ° Ğ¸Ğ· Metabolic Intelligence
            };
            } catch (e) {
                console.error('[HEYS.advice] âŒ ctx useMemo crash:', e?.message);
                return {
                    dayTot: {}, normAbs: {}, optimum: 2000, displayOptimum: 2000,
                    caloricDebt: null, day: {}, pIndex: { byId: new Map(), byName: new Map() },
                    currentStreak: 0, hour: new Date().getHours(), mealCount: 0,
                    hasTraining: false, kcalPct: 0, tone: 'neutral', specialDay: null,
                    emotionalState: 'normal', prof: {}, waterGoal: 2000,
                    goal: 'maintenance', crashRisk: null
                };
            }
        }, [dayTot, normAbs, optimum, displayOptimum, caloricDebt, day, pIndex, currentStreak, prof, waterGoal]);

        // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹
        const allAdvices = React.useMemo(() => {
            try {
                if (!ctx) return [];
                const baseAdvices = generateAdvices(ctx);

                // ğŸ”— Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ chain follow-ups
                const chainAdvices = generateChainAdvices();

                // â° Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹
                const scheduledAdvices = getScheduledAdvices();

                // ğŸ¯ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ goal-specific ÑĞ¾Ğ²ĞµÑ‚Ñ‹
                const goalAdvices = getGoalSpecificAdvices(ctx.goal);

                // ğŸ† ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ personal bests
                const personalBestAdvices = [];
                const todayISO = new Date().toISOString().slice(0, 10);

                // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñ‹ Ğ¿Ğ¾ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ°Ğ¼
                const proteinPct = (ctx.dayTot?.prot || 0) / (ctx.normAbs?.prot || 100);
                const proteinRecord = checkAndUpdatePersonalBest('proteinPct', proteinPct * 100, todayISO);
                if (proteinRecord?.isNewRecord) {
                    const advice = createPersonalBestAdvice('proteinPct', proteinRecord);
                    if (advice) personalBestAdvices.push(advice);
                }

                const fiberPct = (ctx.dayTot?.fiber || 0) / (ctx.normAbs?.fiber || 25);
                const fiberRecord = checkAndUpdatePersonalBest('fiberPct', fiberPct * 100, todayISO);
                if (fiberRecord?.isNewRecord) {
                    const advice = createPersonalBestAdvice('fiberPct', fiberRecord);
                    if (advice) personalBestAdvices.push(advice);
                }

                // Streak record
                if (ctx.currentStreak > 0) {
                    const streakRecord = checkAndUpdatePersonalBest('streak', ctx.currentStreak, todayISO);
                    if (streakRecord?.isNewRecord) {
                        const advice = createPersonalBestAdvice('streak', streakRecord);
                        if (advice) personalBestAdvices.push(advice);
                    }
                }

                return [
                    ...(Array.isArray(baseAdvices) ? baseAdvices : []),
                    ...(Array.isArray(chainAdvices) ? chainAdvices : []),
                    ...(Array.isArray(scheduledAdvices) ? scheduledAdvices : []),
                    ...(Array.isArray(goalAdvices) ? goalAdvices : []),
                    ...personalBestAdvices
                ];
            } catch (e) {
                console.error('[HEYS.advice] âŒ allAdvices useMemo crash:', e?.message);
                return [];
            }
        }, [ctx]);

        // ğŸ”§ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ñ‹Ğ¼ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼
        // ğŸ’Š Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹ Ñ isReminder: true (Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ) Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ
        const categoryFilteredAdvices = React.useMemo(() => {
            return allAdvices.filter(a => {
                // ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ (Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ¸ Ñ‚.Ğ´.) Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ²ÑĞµĞ³Ğ´Ğ°
                if (a.isReminder === true) return true;
                // ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ health â€” ÑÑ‚Ğ¾ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ, Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼
                if (a.category === 'health') return true;
                if (!a.category) return true;
                return isCategoryEnabled(a.category);
            });
        }, [allAdvices]);

        // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ boost Ğ´Ğ»Ñ goal-specific ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
        const boostedAdvices = React.useMemo(() => {
            return applyGoalBoost(categoryFilteredAdvices, ctx.goal);
        }, [categoryFilteredAdvices, ctx.goal]);

        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        const filteredAdvices = React.useMemo(() => {
            return filterByEmotionalState(boostedAdvices, ctx.emotionalState);
        }, [boostedAdvices, ctx.emotionalState]);

        // ğŸ­ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ¿Ğ¾Ğ´ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ
        const moodAdaptedAdvices = React.useMemo(() => {
            const avgMood = getAverageMoodToday(ctx.day);
            if (!avgMood || avgMood === 0) return filteredAdvices;

            return filteredAdvices.map(advice => {
                const adaptedText = adaptTextToMood(advice.text, avgMood, advice.type);
                if (adaptedText === null) return null; // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¿Ğ»Ğ¾Ñ…Ğ¾Ğ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğ¸
                return { ...advice, text: adaptedText };
            }).filter(Boolean);
        }, [filteredAdvices, ctx.day]);

        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñƒ (Ğ´Ğ»Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Ğ² Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ğ½ÑƒÑ‚Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğµ â€” Ğ±ĞµĞ· canShowAdvice)
        // Ğ¡Ğ¿ĞµÑ†Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ 'manual' â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ’Ğ¡Ğ• ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ±ĞµĞ· Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñƒ
        const allForTrigger = React.useMemo(() => {
            if (!trigger) return [];
            if (isUserBusy(uiState)) return [];

            let advices = moodAdaptedAdvices;

            // Manual trigger â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹
            if (trigger !== 'manual') {
                advices = advices.filter(a => a.triggers.includes(trigger));
            }

            // ğŸ§  Smart Prioritization â€” ML-like scoring
            advices = sortBySmartScore(advices, ctx);

            // â° ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
            advices = filterByTimeRestrictions(advices);

            // ğŸ”„ Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ â€” Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ñ… Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½
            advices = deduplicateAdvices(advices);

            // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ excludes
            advices = filterByExcludes(advices);

            // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼ (Ğ°Ğ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼)
            advices = limitByCategory(advices);

            return advices;
        }, [moodAdaptedAdvices, trigger, uiState, ctx]);

        // Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ (Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ cooldown)
        const relevantAdvices = React.useMemo(() => {
            return allForTrigger.filter(a => canShowAdvice(a.id, { canSkipCooldown: a.canSkipCooldown }));
        }, [allForTrigger]);

        // ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²ĞµÑ‚ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¹)
        const primary = relevantAdvices[0] || null;

        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ animation ĞºĞ»Ğ°ÑÑ
        const primaryWithAnimation = primary ? {
            ...primary,
            animationClass: getAdviceAnimation(primary)
        } : null;

        // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ»Ñ badge â€” Ğ’Ğ¡Ğ• ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ° (Ğ±ĞµĞ· canShowAdvice)
        const adviceCount = allForTrigger.length;

        // ğŸ”¢ Badge advices â€” ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ FAB badge (ĞºĞ°Ğº trigger='manual', Ğ½Ğ¾ Ğ±ĞµĞ· Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ trigger)
        // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ’Ğ¡Ğ• Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
        const badgeAdvices = React.useMemo(() => {
            if (isUserBusy(uiState)) return [];

            let advices = moodAdaptedAdvices;

            // ğŸ§  Smart Prioritization
            advices = sortBySmartScore(advices, ctx);

            // â° Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
            advices = filterByTimeRestrictions(advices);

            // ğŸ”„ Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
            advices = deduplicateAdvices(advices);

            // Excludes
            advices = filterByExcludes(advices);

            // Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼
            advices = limitByCategory(advices);

            return advices;
        }, [moodAdaptedAdvices, uiState, ctx]);

        // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ñ…
        const scheduledCount = getScheduledCount();

        return {
            primary: primaryWithAnimation,
            relevant: allForTrigger, // Ğ’ÑĞµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
            adviceCount,
            badgeAdvices, // Ğ”Ğ»Ñ FAB badge â€” Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ² Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹
            scheduledCount,
            allAdvices,
            ctx,
            crashRisk: ctx?.crashRisk, // ğŸ†• Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ crashRisk Ğ´Ğ»Ñ UI
            // ĞœĞµÑ‚Ğ¾Ğ´Ñ‹
            markShown: (id) => {
                markAdviceShown(id);
                trackAdviceShown(id); // ğŸ“Š Tracking
            },
            trackClick: trackAdviceClicked, // ğŸ“Š Tracking ĞºĞ»Ğ¸ĞºĞ°
            rateAdvice, // ğŸ‘/ğŸ‘ Rating
            scheduleAdvice, // â° ĞÑ‚Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ²ĞµÑ‚
            canShow: canShowAdvice,
            resetSession: resetSessionAdvices
        };
    }

    /**
     * ğŸ†• ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ crashRisk Ğ¸Ğ· Metabolic Intelligence
     * Helper Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
     * @returns {Object|null} { risk: 0-100, level: 'low'|'medium'|'high', factors: [] }
     */
    function getCrashRiskForContext() {
        if (!window.HEYS?.Metabolic?.calculateCrashRisk24h) {
            return null;
        }

        try {
            return window.HEYS.Metabolic.calculateCrashRisk24h();
        } catch (e) {
            return null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Helpers registry (shared for category modules)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceCoreHelpers = {
        rules: AdviceRules,
        getProductForItem,
        personalizeText,
        pickRandomText,
        getTimeBasedText,
        getTimePeriod,
        adaptTextToMood,
        getAverageMoodToday,
        calculateAverageMood,
        calculateAverageStress,
        calculateAverageWellbeing,
        getToneForHour,
        getEmotionalState,
        getSpecialDay,
        filterByEmotionalState,
        isUserBusy,
        analyzeProductCategories,
        getDayForecast,
        getWeeklyComparison,
        getWeeklySummary,
        getNextStreakMilestone,
        trackDismiss,
        getDismissPenalty,
        calculateDynamicTTL,
        checkAdviceChain,
        markChainStart: markChainStartForAdvice,
        checkComboAchievements,
        markComboShown,
        trackProductPattern,
        getSmartRecommendation,
        calculateSleepHours,
        getMealTotals,
        getLastMealWithItems,
        getFirstMealWithItems,
        isMilestoneShown,
        markMilestoneShown,
        countUniqueProducts,
        getTotalDaysTracked,
        getPersonalBestStreak,
        updatePersonalBestStreak,
        canShowMealAdvice,
        markMealAdviceShown,
        getRecentDays,
        getAverageBedtime,
        getHoursUntilBedtime,
        getHoursSinceWater,
        hasCoffeeAfterHour,
        getGoalMode,
        isInTargetRange,
        isCriticallyOver,
        isCriticallyUnder
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPORTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const adviceRules = AdviceRules;

    const adviceEngine = {
        generateAdvices,
        useAdviceEngine,
        invalidateAdviceCache
    };

    window.HEYS.adviceRules = adviceRules;
    window.HEYS.adviceEngine = adviceEngine;
    window.HEYS.advice = {
        rules: adviceRules,
        engine: adviceEngine,
        useAdviceEngine,
        generateAdvices,
        markShown: markAdviceShown,
        canShow: canShowAdvice,
        resetSessionAdvices,
        // ğŸ¯ Goal-aware helpers
        getGoalMode,
        isInTargetRange,
        isCriticallyOver,
        isCriticallyUnder,
        // ğŸ”§ Filtering & processing
        filterByExcludes,
        limitByCategory,
        applyGoalBoost,
        sortBySmartScore,
        // ğŸ“Š Tracking & Analytics
        trackAdviceShown,
        trackAdviceClicked,
        getAdviceCTR,
        getTopAdvices,
        getTrackingStats,
        // ğŸ‘ğŸ‘ Rating system
        rateAdvice,
        getAdviceRating,
        getAllRatings,
        // ğŸ¨ Text helpers
        personalizeText,
        pickRandomText,
        getTimeBasedText,
        getTimePeriod,
        adaptTextToMood,
        getAverageMoodToday,
        // ğŸ“‹ Config â€” Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ
        THRESHOLDS,
        SEASONAL_TIPS,
        MAX_ADVICES_PER_CATEGORY,
        PRODUCT_CATEGORIES,
        ADVICE_CHAINS,
        DEDUPLICATION_RULES,    // ğŸ†• Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ñ… ÑĞ¾Ğ²ĞµÑ‚Ğ¾Ğ²
        TIME_RESTRICTIONS,      // ğŸ†• Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
        STREAK_MILESTONES,
        TTL_CONFIG,
        TIME_BASED_TEXTS,
        COMBO_ACHIEVEMENTS,
        MOOD_TONES,
        // ğŸ”§ Filtering functions
        deduplicateAdvices,       // ğŸ†• Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
        filterByTimeRestrictions, // ğŸ†• Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
        // Helper functions Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        getToneForHour,
        getEmotionalState,
        getSpecialDay,
        filterByEmotionalState,
        isUserBusy,
        calculateAverageMood,
        calculateAverageStress,
        calculateAverageWellbeing,
        // Phase 0 helpers (Phase 2 ÑĞ¾Ğ²ĞµÑ‚Ñ‹)
        getMealTotals,
        getLastMealWithItems,
        getFirstMealWithItems,
        isMilestoneShown,
        markMilestoneShown,
        countUniqueProducts,
        getTotalDaysTracked,
        getPersonalBestStreak,
        updatePersonalBestStreak,
        canShowMealAdvice,
        markMealAdviceShown,
        getRecentDays,
        getAverageBedtime,      // ğŸ†• Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ ÑĞ½Ğ° Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        getHoursUntilBedtime,   // ğŸ†• Ğ§Ğ°ÑĞ¾Ğ² Ğ´Ğ¾ ÑĞ½Ğ° (Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°)
        // ğŸ†• Phase 3 helpers
        analyzeProductCategories,
        getDayForecast,
        getWeeklyComparison,
        getWeeklySummary,
        getNextStreakMilestone,
        trackDismiss,
        getDismissPenalty,
        calculateDynamicTTL,
        checkAdviceChain,
        markChainStart: markChainStartForAdvice,
        // ğŸ†• Phase 4 helpers
        checkComboAchievements,
        markComboShown,
        trackProductPattern,
        getSmartRecommendation,
        calculateSmartScore,
        // ğŸ†• Phase 5 helpers
        // Settings
        getAdviceSettings,
        setAdviceSettings,
        isCategoryEnabled,
        toggleCategory,
        CATEGORY_LABELS,
        DEFAULT_ADVICE_SETTINGS,
        // Personal Bests
        getPersonalBests,
        checkAndUpdatePersonalBest,
        createPersonalBestAdvice,
        TRACKABLE_METRICS,
        // Chains
        checkChainContinuation,
        generateChainAdvices,
        // Scheduling
        scheduleAdvice,
        getScheduledAdvices,
        getScheduledCount,
        SNOOZE_OPTIONS,
        // Goal-specific
        getGoalSpecificAdvices,
        GOAL_MODES,
        // Animations
        getAdviceAnimation,
        ADVICE_ANIMATIONS,
        // ğŸš€ Cache management
        invalidateAdviceCache,      // ğŸ†• Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºÑÑˆĞ° (Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ product_added)
        // ğŸ¯ Priority constants
        PRIORITY                    // ğŸ†• Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñ‹
    };

})();
// ===== End advice/_core.js =====

// ===== Begin advice/_nutrition.js =====
;/**
 * HEYS Advice Module v1 â€” Nutrition
 * @file advice/_nutrition.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.nutrition = function buildNutritionAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const {
            THRESHOLDS,
            PRIORITY,
            PRODUCT_CATEGORIES
        } = rules;

        const {
            dayTot,
            normAbs,
            optimum,
            displayOptimum,
            caloricDebt,
            day,
            pIndex,
            hour,
            mealCount,
            kcalPct,
            prof,
            waterGoal,
            goal,
            proteinPct,
            fatPct,
            carbsPct,
            fiberPct,
            simplePct,
            transPct,
            harmPct,
            goodFatPct,
            isRefeedDay,
            isRefeedExcessOk
        } = ctx;

        const {
            getTimeBasedText,
            pickRandomText,
            personalizeText,
            markChainStart,
            getMealTotals,
            getLastMealWithItems,
            getFirstMealWithItems,
            canShowMealAdvice,
            markMealAdviceShown,
            analyzeProductCategories,
            getDayForecast,
            getWeeklyComparison,
            getRecentDays,
            getProductForItem,
            getHoursUntilBedtime,
            hasCoffeeAfterHour
        } = helpers;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // âš ï¸ WARNINGS (priority: 11-30) â€” Goal-aware + Refeed-aware
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (goal && helpers.isCriticallyOver(kcalPct, goal) && !isRefeedExcessOk) {
            const overPct = Math.round((kcalPct - 1) * 100);
            const goalText = goal.mode === 'bulk'
                ? 'Ğ”Ğ°Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ° ÑÑ‚Ğ¾ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ‚Ğ¾'
                : goal.mode === 'deficit'
                    ? 'ĞŸĞ»Ğ°Ğ½ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚Ğ° Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½'
                    : 'Ğ¡Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ¾Ñ€Ğ¼Ñ‹';
            advices.push({
                id: 'kcal_excess_critical',
                icon: 'ğŸ”´',
                text: `+${overPct}% Ğ¾Ñ‚ Ğ¿Ğ»Ğ°Ğ½Ğ°. ${goalText}`,
                details: goal.mode === 'bulk'
                    ? 'ĞĞ°Ğ±Ğ¾Ñ€ Ğ¼Ğ°ÑÑÑ‹ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚Ğ°, Ğ½Ğ¾ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¸Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ğº ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ¶Ğ¸Ñ€. Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ Ğ² Ğ¿Ğ»Ğ°Ğ½ +10-15%.'
                    : 'ĞĞµ ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¿ĞµÑ€ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ! ĞĞ´Ğ¸Ğ½ Ğ´ĞµĞ½ÑŒ Ğ¿ĞµÑ€ĞµĞµĞ´Ğ°Ğ½Ğ¸Ñ â€” ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾. Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° ÑĞ´ĞµĞ»Ğ°Ğ¹ Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ¸ Ğ²ÑÑ‘ Ğ²Ñ‹Ñ€Ğ¾Ğ²Ğ½ÑĞµÑ‚ÑÑ.',
                type: 'warning',
                priority: 11,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 6000
            });
        } else if (goal && kcalPct > goal.targetRange.max && !helpers.isCriticallyOver(kcalPct, goal) && !isRefeedExcessOk) {
            const overPct = Math.round((kcalPct - 1) * 100);
            advices.push({
                id: 'kcal_excess_mild',
                icon: 'âš ï¸',
                text: goal.mode === 'bulk'
                    ? `+${overPct}% â€” Ñ‡ÑƒÑ‚ÑŒ Ğ²Ñ‹ÑˆĞµ Ğ¿Ğ»Ğ°Ğ½Ğ° Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ°`
                    : `+${overPct}% Ğ¾Ñ‚ Ğ¿Ğ»Ğ°Ğ½Ğ° â€” Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ ÑÑ‚Ñ€Ğ°ÑˆĞ½Ğ¾Ğ³Ğ¾`,
                details: 'ğŸ“Š ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€ Ğ½Ğµ ÑÑ‚Ñ€Ğ°ÑˆĞµĞ½. Ğ’Ğ°Ğ¶ĞµĞ½ Ñ‚Ñ€ĞµĞ½Ğ´ Ğ·Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ, Ğ° Ğ½Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾.',
                type: 'tip',
                priority: 15,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        if (goal && helpers.isCriticallyUnder(kcalPct, goal) && hour >= 14) {
            advices.push({
                id: 'kcal_under_critical',
                icon: goal.mode === 'bulk' ? 'âš ï¸' : 'ğŸŒ™',
                text: goal.mode === 'bulk'
                    ? `Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ${Math.round(kcalPct * 100)}% â€” Ğ´Ğ»Ñ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ° Ğ¼Ğ°Ğ»Ğ¾!`
                    : goal.mode === 'deficit'
                        ? `${Math.round(kcalPct * 100)}% â€” ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚`
                        : 'Ğ¡ÑŠĞµĞ´ĞµĞ½Ğ¾ Ğ¼Ğ°Ğ»Ğ¾ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼',
                details: goal.mode === 'bulk'
                    ? 'Ğ”Ğ»Ñ Ñ€Ğ¾ÑÑ‚Ğ° Ğ¼Ñ‹ÑˆÑ† Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ¸ Ğ±ĞµĞ»Ğ¾Ğº.'
                    : 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ñ€ĞµĞ·ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ¸ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğº ÑÑ€Ñ‹Ğ²Ğ°Ğ¼. Ğ›ÑƒÑ‡ÑˆĞµ ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ 10-15%.',
                type: goal.mode === 'bulk' ? 'warning' : 'tip',
                priority: 16,
                category: 'nutrition',
                triggers: ['tab_open', 'product_added'],
                ttl: 5000
            });
        }

        if (transPct > 1.0) {
            advices.push({
                id: 'trans_fat_warning',
                icon: 'âš ï¸',
                text: 'Ğ¢Ñ€Ğ°Ğ½Ñ-Ğ¶Ğ¸Ñ€Ñ‹ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ñ‹ â€” Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ¹ Ñ„Ğ°ÑÑ‚Ñ„ÑƒĞ´Ğ°',
                details: 'Ğ¢Ñ€Ğ°Ğ½Ñ-Ğ¶Ğ¸Ñ€Ñ‹ â€” ÑĞ°Ğ¼Ñ‹Ğµ Ğ²Ñ€ĞµĞ´Ğ½Ñ‹Ğµ. ĞĞ½Ğ¸ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ÑÑ‚ "Ğ¿Ğ»Ğ¾Ñ…Ğ¾Ğ¹" Ñ…Ğ¾Ğ»ĞµÑÑ‚ĞµÑ€Ğ¸Ğ½ Ğ¸ ÑĞ½Ğ¸Ğ¶Ğ°ÑÑ‚ "Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹". Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ğ¹: Ğ¼Ğ°Ñ€Ğ³Ğ°Ñ€Ğ¸Ğ½, Ñ„Ğ°ÑÑ‚-Ñ„ÑƒĞ´, Ñ‡Ğ¸Ğ¿ÑÑ‹, Ğ²Ñ‹Ğ¿ĞµÑ‡ĞºĞ° Ñ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ ÑÑ€Ğ¾ĞºĞ¾Ğ¼ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.',
                type: 'warning',
                priority: 12,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        if (simplePct > 1.3) {
            const carbsText = getTimeBasedText('simple_carbs_warning', hour, 'ĞœĞ½Ğ¾Ğ³Ğ¾ ÑĞ°Ñ…Ğ°Ñ€Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ â€” Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ÑŒ ÑĞ»Ğ°Ğ´ĞºĞ¾Ğµ');
            advices.push({
                id: 'simple_carbs_warning',
                icon: 'ğŸ¬',
                text: carbsText,
                details: 'ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ÑÑ‚ ÑĞ°Ñ…Ğ°Ñ€ Ğ² ĞºÑ€Ğ¾Ğ²Ğ¸, Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ Ğ²ÑĞ¿Ğ»ĞµÑĞº Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ° Ğ¸ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ ÑƒĞ¿Ğ°Ğ´Ğ¾Ğº ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸. ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñ‹: Ñ„Ñ€ÑƒĞºÑ‚Ñ‹, Ñ‚Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´ 70%+, Ğ¾Ñ€ĞµÑ…Ğ¸.',
                type: 'warning',
                priority: 14,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        if (harmPct > 1.0) {
            advices.push({
                id: 'harm_warning',
                icon: 'ğŸ’”',
                text: 'ĞœĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ´Ğ½Ğ¾Ğ³Ğ¾ â€” Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ½Ğ°Ñ‡Ğ½Ñ‘Ğ¼ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ°',
                details: 'Ğ’Ñ€ĞµĞ´Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹ â€” ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸Ğ½Ğ¾Ğ³Ğ´Ğ°. Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ â€” Ğ½Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ. Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° ÑĞ´ĞµĞ»Ğ°Ğ¹ Ğ°ĞºÑ†ĞµĞ½Ñ‚ Ğ½Ğ° Ğ¾Ğ²Ğ¾Ñ‰Ğ°Ñ…, Ğ±ĞµĞ»ĞºĞµ Ğ¸ Ğ²Ğ¾Ğ´Ğµ.',
                type: 'warning',
                priority: 13,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ’¡ TIPS (priority: 31-50) â€” Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (proteinPct < THRESHOLDS.protein.low && hour >= 12) {
            const proteinText = getTimeBasedText('protein_low', hour,
                personalizeText(pickRandomText([
                    'Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ±ĞµĞ»ĞºĞ° â€” Ğ¼ÑÑĞ¾, Ñ€Ñ‹Ğ±Ğ°, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³',
                    '${firstName}, Ğ±ĞµĞ»ĞºĞ° Ğ¼Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚Ğ¾ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ!',
                    'Ğ‘ĞµĞ»Ğ¾Ğº Ğ½ÑƒĞ¶ĞµĞ½ Ğ¼Ñ‹ÑˆÑ†Ğ°Ğ¼ â€” ĞºÑƒÑ€Ğ¸Ñ†Ğ°, ÑĞ¹Ñ†Ğ°, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³'
                ]), ctx)
            );
            advices.push({
                id: 'protein_low',
                icon: 'ğŸ¥©',
                text: proteinText,
                details: 'Ğ‘ĞµĞ»Ğ¾Ğº Ğ²Ğ°Ğ¶ĞµĞ½ Ğ´Ğ»Ñ Ğ¼Ñ‹ÑˆÑ†, Ğ¸Ğ¼Ğ¼ÑƒĞ½Ğ¸Ñ‚ĞµÑ‚Ğ° Ğ¸ ÑÑ‹Ñ‚Ğ¾ÑÑ‚Ğ¸. ĞĞ¾Ñ€Ğ¼Ğ°: 1.5-2Ğ³ Ğ½Ğ° ĞºĞ³ Ğ²ĞµÑĞ°. Ğ›ÑƒÑ‡ÑˆĞ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸: ĞºÑƒÑ€Ğ¸Ñ†Ğ°, Ğ¸Ğ½Ğ´ĞµĞ¹ĞºĞ°, Ñ€Ñ‹Ğ±Ğ°, ÑĞ¹Ñ†Ğ°, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³, Ğ³Ñ€ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚, Ğ±Ğ¾Ğ±Ğ¾Ğ²Ñ‹Ğµ.',
                type: 'tip',
                priority: 31,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                excludes: ['post_training_protein', 'deficit_protein_save_muscle', 'bulk_protein_critical'],
                ttl: 5000,
                onShow: () => { markChainStart('protein_low'); }
            });
        }

        if (fiberPct < THRESHOLDS.fiber.low && mealCount >= 2) {
            const fiberDefault = personalizeText(pickRandomText([
                'ĞœĞ°Ğ»Ğ¾ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ¸ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¾Ğ²Ğ¾Ñ‰ĞµĞ¹ Ğ¸Ğ»Ğ¸ Ğ·Ğ»Ğ°ĞºĞ¾Ğ²',
                'ĞšĞ¸ÑˆĞµÑ‡Ğ½Ğ¸ĞºÑƒ Ğ½ÑƒĞ¶Ğ½Ğ° ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° â€” Ğ¾Ğ²Ğ¾Ñ‰Ğ¸, Ğ·ĞµĞ»ĞµĞ½ÑŒ',
                '${firstName}, Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¾Ğ²Ğ¾Ñ‰ĞµĞ¹ Ğ´Ğ»Ñ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ¸'
            ]), ctx);
            const fiberText = getTimeBasedText('fiber_low', hour, fiberDefault);
            advices.push({
                id: 'fiber_low',
                icon: 'ğŸ¥¬',
                text: fiberText,
                details: 'ĞšĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° Ğ²Ğ°Ğ¶Ğ½Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¸Ñ‰ĞµĞ²Ğ°Ñ€ĞµĞ½Ğ¸Ñ Ğ¸ ÑÑ‹Ñ‚Ğ¾ÑÑ‚Ğ¸. ĞĞ¾Ñ€Ğ¼Ğ°: 25-35Ğ³ Ğ² Ğ´ĞµĞ½ÑŒ. Ğ›Ğ¸Ğ´ĞµÑ€Ñ‹: Ğ°Ğ²Ğ¾ĞºĞ°Ğ´Ğ¾, Ğ±Ñ€Ğ¾ĞºĞºĞ¾Ğ»Ğ¸, Ğ¾Ğ²ÑÑĞ½ĞºĞ°, Ñ‡ĞµÑ‡ĞµĞ²Ğ¸Ñ†Ğ°, Ğ³Ñ€ÑƒÑˆĞ¸, Ğ¼Ğ°Ğ»Ğ¸Ğ½Ğ°, ÑĞµĞ¼ĞµĞ½Ğ° Ñ‡Ğ¸Ğ°.',
                type: 'tip',
                priority: 32,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                excludes: ['deficit_fiber_satiety'],
                ttl: 5000,
                onShow: () => { markChainStart('fiber_low'); }
            });
        }

        if (fiberPct >= THRESHOLDS.fiber.good) {
            advices.push({
                id: 'fiber_good',
                icon: 'ğŸ¥—',
                text: personalizeText(pickRandomText([
                    'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾ Ñ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ¹! ĞšĞ¸ÑˆĞµÑ‡Ğ½Ğ¸Ğº ÑĞºĞ°Ğ¶ĞµÑ‚ ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾',
                    '${firstName}, ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ! ğŸ‘',
                    'ĞšĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ â€” Ğ¿Ğ¸Ñ‰ĞµĞ²Ğ°Ñ€ĞµĞ½Ğ¸Ğµ ÑĞºĞ°Ğ¶ĞµÑ‚ ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾'
                ]), ctx),
                details: 'ğŸŒ± ĞšĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° ĞºĞ¾Ñ€Ğ¼Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ Ğ±Ğ°ĞºÑ‚ĞµÑ€Ğ¸Ğ¸ ĞºĞ¸ÑˆĞµÑ‡Ğ½Ğ¸ĞºĞ°, ÑƒĞ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ Ğ¸Ğ¼Ğ¼ÑƒĞ½Ğ¸Ñ‚ĞµÑ‚ Ğ¸ Ğ´Ğ°Ñ‘Ñ‚ Ğ´Ğ¾Ğ»Ğ³ÑƒÑ ÑÑ‹Ñ‚Ğ¾ÑÑ‚ÑŒ.',
                type: 'achievement',
                priority: 35,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000
            });
        }

        if (goodFatPct < THRESHOLDS.fat.goodRatioLow && hour >= 14) {
            advices.push({
                id: 'good_fat_low',
                icon: 'ğŸ¥‘',
                text: personalizeText(pickRandomText([
                    'Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ñ… Ğ¶Ğ¸Ñ€Ğ¾Ğ² â€” Ğ°Ğ²Ğ¾ĞºĞ°Ğ´Ğ¾, Ğ¾Ñ€ĞµÑ…Ğ¸, Ğ¾Ğ»Ğ¸Ğ²ĞºĞ¾Ğ²Ğ¾Ğµ Ğ¼Ğ°ÑĞ»Ğ¾',
                    'ĞĞ¼ĞµĞ³Ğ°-3 Ğ²Ğ°Ğ¶Ğ½Ñ‹ â€” Ñ€Ñ‹Ğ±Ğ°, Ğ¾Ñ€ĞµÑ…Ğ¸, Ğ»ÑŒĞ½ÑĞ½Ğ¾Ğµ Ğ¼Ğ°ÑĞ»Ğ¾',
                    '${firstName}, Ğ½Ğµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ Ğ¶Ğ¸Ñ€Ñ‹!'
                ]), ctx),
                details: 'ĞĞ¼ĞµĞ³Ğ°-3 Ğ¸ Ğ¼Ğ¾Ğ½Ğ¾Ğ½ĞµĞ½Ğ°ÑÑ‹Ñ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ¶Ğ¸Ñ€Ñ‹ Ğ²Ğ°Ğ¶Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ·Ğ³Ğ°, ÑĞµÑ€Ğ´Ñ†Ğ° Ğ¸ Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ğ¾Ğ². Ğ›ÑƒÑ‡ÑˆĞ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸: Ğ¶Ğ¸Ñ€Ğ½Ğ°Ñ Ñ€Ñ‹Ğ±Ğ° (ÑÑ‘Ğ¼Ğ³Ğ°, ÑĞºÑƒĞ¼Ğ±Ñ€Ğ¸Ñ), Ğ°Ğ²Ğ¾ĞºĞ°Ğ´Ğ¾, Ğ¾Ğ»Ğ¸Ğ²ĞºĞ¾Ğ²Ğ¾Ğµ Ğ¼Ğ°ÑĞ»Ğ¾, Ğ¾Ñ€ĞµÑ…Ğ¸ (Ğ³Ñ€ĞµÑ†ĞºĞ¸Ğµ, Ğ¼Ğ¸Ğ½Ğ´Ğ°Ğ»ÑŒ), ÑĞµĞ¼ĞµĞ½Ğ° Ğ»ÑŒĞ½Ğ° Ğ¸ Ñ‡Ğ¸Ğ°.',
                type: 'tip',
                priority: 33,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                excludes: ['fat_quality_low'],
                ttl: 5000
            });
        }

        if (hour >= 20 && goal && helpers.isCriticallyUnder(kcalPct, goal)) {
            advices.push({
                id: 'evening_undereating',
                icon: goal.mode === 'bulk' ? 'âš ï¸' : 'ğŸŒ™',
                text: goal.mode === 'bulk'
                    ? `Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ${Math.round(kcalPct * 100)}% â€” Ğ´Ğ»Ñ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ° Ğ¼Ğ°Ğ»Ğ¾! Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ²ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼`
                    : goal.mode === 'deficit'
                        ? 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ â€” Ğ»ÑƒÑ‡ÑˆĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ ÑƒĞ¶Ğ¸Ğ½'
                        : 'Ğ•Ñ‰Ñ‘ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞµÑÑ‚ÑŒ â€” Ğ½Ğµ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ¹ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ½Ğ¾Ğ¼',
                details: goal.mode === 'bulk'
                    ? 'Ğ”Ğ»Ñ Ñ€Ğ¾ÑÑ‚Ğ° Ğ¼Ñ‹ÑˆÑ† Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚. Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼: Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³ + Ğ¾Ñ€ĞµÑ…Ğ¸, Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚ĞµĞ¸Ğ½ + Ğ±Ğ°Ğ½Ğ°Ğ½.'
                    : `ğŸ”¬ Ğ”ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ >500 ĞºĞºĞ°Ğ» Ñ…ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ·Ğ´Ğ½ĞµĞ³Ğ¾ ÑƒĞ¶Ğ¸Ğ½Ğ°!\n\n` +
                    `â€¢ ĞœĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ÑÑ\n` +
                    `â€¢ Ğ Ğ¸ÑĞº Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸ Ğ¼Ñ‹ÑˆÑ† Ğ¸ Ğ²Ñ‹Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ Ğ²Ğ¾Ğ»Ğ¾Ñ\n` +
                    `â€¢ ĞŸĞ»Ğ¾Ñ…Ğ¾Ğ¹ ÑĞ¾Ğ½ Ğ¾Ñ‚ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ° = ĞµÑ‰Ñ‘ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°\n\n` +
                    `ğŸ’¡ Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³, ÑĞ¹Ñ†Ğ°, Ğ¾Ñ€ĞµÑ…Ğ¸ â€” Ğ½Ğ°ÑÑ‹Ñ‚ÑÑ‚ Ğ±ĞµĞ· ÑĞºĞ°Ñ‡ĞºĞ° Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ°`,
                type: goal.mode === 'bulk' ? 'warning' : 'tip',
                priority: 36,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (mealCount >= 2 &&
            proteinPct >= THRESHOLDS.macros.balanceMin && fatPct >= THRESHOLDS.macros.balanceMin && carbsPct >= THRESHOLDS.macros.balanceMin &&
            proteinPct <= THRESHOLDS.macros.balanceMax && fatPct <= THRESHOLDS.macros.balanceMax && carbsPct <= THRESHOLDS.macros.balanceMax) {
            advices.push({
                id: 'balanced_macros',
                icon: 'âš–ï¸',
                text: 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ‘Ğ–Ğ£!',
                details: 'ğŸ¯ Ğ‘ĞµĞ»ĞºĞ¸, Ğ¶Ğ¸Ñ€Ñ‹ Ğ¸ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ² Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞµ â€” ÑÑ‚Ğ¾ Ñ€ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ! Ğ¢Ğ°ĞºĞ¾Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ´Ğ°Ñ‘Ñ‚ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½ÑƒÑ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ¸ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞµĞµ ÑĞ°Ğ¼Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ğµ.',
                type: 'achievement',
                priority: 38,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¯ GOAL-SPECIFIC
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (goal?.mode === 'bulk') {
            if (proteinPct < 0.8 && mealCount >= 1) {
                advices.push({
                    id: 'bulk_protein_critical',
                    icon: 'ğŸ¥©',
                    text: 'Ğ”Ğ»Ñ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ° Ğ½ÑƒĞ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº! Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¼ÑÑĞ¾, Ñ€Ñ‹Ğ±Ñƒ Ğ¸Ğ»Ğ¸ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³',
                    details: 'ĞŸÑ€Ğ¸ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğµ Ğ¼Ğ°ÑÑÑ‹ Ğ±ĞµĞ»Ğ¾Ğº â€” Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ». ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 1.8-2.2Ğ³ Ğ½Ğ° ĞºĞ³ Ğ²ĞµÑĞ°. Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ°Ğ¼ Ğ¿Ğ¸Ñ‰Ğ¸.',
                    type: 'tip',
                    priority: 39,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000
                });
            }

            if (carbsPct < 0.7 && mealCount >= 2) {
                advices.push({
                    id: 'bulk_carbs_low',
                    icon: 'ğŸš',
                    text: 'Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ² â€” Ğ¾Ğ½Ğ¸ Ğ´Ğ°ÑÑ‚ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ¾ÑÑ‚Ğ°',
                    details: 'Ğ£Ğ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ â€” Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ¾ Ğ´Ğ»Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ. Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸: Ñ€Ğ¸Ñ, Ğ³Ñ€ĞµÑ‡ĞºĞ°, Ğ¾Ğ²ÑÑĞ½ĞºĞ°, ĞºĞ°Ñ€Ñ‚Ğ¾Ñ„ĞµĞ»ÑŒ, Ğ¼Ğ°ĞºĞ°Ñ€Ğ¾Ğ½Ñ‹.',
                    type: 'tip',
                    priority: 41,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            if (hour >= 16 && kcalPct < 0.6) {
                advices.push({
                    id: 'bulk_kcal_behind',
                    icon: 'âš ï¸',
                    text: `Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ${Math.round(kcalPct * 100)}% Ğ¾Ñ‚ Ğ¿Ğ»Ğ°Ğ½Ğ° Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ° â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹!`,
                    details: 'ğŸš Ğ”Ğ»Ñ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ° Ğ¼Ğ°ÑÑÑ‹ Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚ 10-15%. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ (Ñ€Ğ¸Ñ, Ğ³Ñ€ĞµÑ‡ĞºĞ°) Ğ¸ Ğ±ĞµĞ»Ğ¾Ğº (Ğ¼ÑÑĞ¾, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³). Ğ‘ĞµĞ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚Ğ° Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ğ½Ğµ Ñ€Ğ°ÑÑ‚ÑƒÑ‚!',
                    type: 'warning',
                    priority: 40,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        if (goal?.mode === 'deficit') {
            if (proteinPct < 0.9 && mealCount >= 2) {
                advices.push({
                    id: 'deficit_protein_save_muscle',
                    icon: 'ğŸ’ª',
                    text: 'ĞĞ° Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚Ğµ Ğ±ĞµĞ»Ğ¾Ğº ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµĞ½ â€” Ğ¾Ğ½ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ¼Ñ‹ÑˆÑ†Ñ‹',
                    details: 'ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ñ…ÑƒĞ´ĞµĞ½Ğ¸Ğ¸ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ€Ğ°Ğ·Ñ€ÑƒÑˆĞ°Ñ‚ÑŒ Ğ¼Ñ‹ÑˆÑ†Ñ‹. Ğ‘ĞµĞ»Ğ¾Ğº 1.6-2Ğ³ Ğ½Ğ° ĞºĞ³ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¼Ñ‹ÑˆĞµÑ‡Ğ½ÑƒÑ Ğ¼Ğ°ÑÑÑƒ. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ½ĞµĞ¶Ğ¸Ñ€Ğ½Ğ¾Ğµ Ğ¼ÑÑĞ¾, Ñ€Ñ‹Ğ±Ğ°, ÑĞ¹Ñ†Ğ°.',
                    type: 'tip',
                    priority: 42,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000
                });
            }

            if (fiberPct < 0.5 && mealCount >= 2) {
                advices.push({
                    id: 'deficit_fiber_satiety',
                    icon: 'ğŸ¥—',
                    text: 'Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¾Ğ²Ğ¾Ñ‰ĞµĞ¹ â€” ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° Ğ´Ğ°Ñ‘Ñ‚ ÑÑ‹Ñ‚Ğ¾ÑÑ‚ÑŒ Ğ±ĞµĞ· ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹',
                    details: 'ĞĞ° Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚Ğµ Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‹Ñ‚Ğ¾ÑÑ‚ÑŒ. ĞĞ²Ğ¾Ñ‰Ğ¸ Ğ¸ Ğ·ĞµĞ»ĞµĞ½ÑŒ â€” Ğ¾Ğ±ÑŠÑ‘Ğ¼ Ğ±ĞµĞ· ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹. ĞĞ³ÑƒÑ€Ñ†Ñ‹, Ğ¿Ğ¾Ğ¼Ğ¸Ğ´Ğ¾Ñ€Ñ‹, ĞºĞ°Ğ¿ÑƒÑÑ‚Ğ°, ÑĞ°Ğ»Ğ°Ñ‚ â€” ĞµÑˆÑŒ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ.',
                    type: 'tip',
                    priority: 43,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            if (hour >= 18 && kcalPct < 0.7 && kcalPct > 0) {
                advices.push({
                    id: 'deficit_too_harsh',
                    icon: 'âš ï¸',
                    text: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼',
                    details: 'Ğ ĞµĞ·ĞºĞ¾Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğº ÑÑ€Ñ‹Ğ²Ğ°Ğ¼ Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ° Ğ²ĞµÑ‰ĞµÑÑ‚Ğ². Ğ›ÑƒÑ‡ÑˆĞµ ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ 10-15% Ğ½Ğ° Ğ´Ğ¾Ğ»Ğ³Ğ¾Ğ¹ Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸.',
                    type: 'warning',
                    priority: 44,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            const waterPctForCombo = (day?.waterMl || 0) / (waterGoal || 2000);
            if (hour >= 16 && kcalPct < 0.6 && waterPctForCombo < 0.5 && mealCount >= 1) {
                advices.push({
                    id: 'undereating_dehydration_combo',
                    icon: 'ğŸš¨',
                    text: 'ĞœĞ°Ğ»Ğ¾ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹ Ğ˜ Ğ¼Ğ°Ğ»Ğ¾ Ğ²Ğ¾Ğ´Ñ‹ â€” Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€ĞµÑÑ Ğ´Ğ»Ñ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼Ğ°!',
                    details: `ğŸ”¬ ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚Ğ° Ğ¸ Ğ¾Ğ±ĞµĞ·Ğ²Ğ¾Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ¾Ğ¿Ğ°ÑĞ½Ğ°:\n\n` +
                        `â€¢ ĞœĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ÑÑ ĞµÑ‰Ñ‘ ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ\n` +
                        `â€¢ Ğ“Ğ¾Ğ»Ğ¾Ğ´ ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ (Ğ¶Ğ°Ğ¶Ğ´Ñƒ Ğ¿ÑƒÑ‚Ğ°ÑÑ‚ Ñ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ¾Ğ¼)\n` +
                        `â€¢ Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ°Ñ Ğ±Ğ¾Ğ»ÑŒ, ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ, Ñ€Ğ°Ğ·Ğ´Ñ€Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ\n` +
                        `â€¢ ĞŸĞ¾Ñ‡ĞºĞ¸ Ğ¸ Ğ¿ĞµÑ‡ĞµĞ½ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ½Ğ° Ğ¸Ğ·Ğ½Ğ¾Ñ\n\n` +
                        `ğŸ’¡ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ¿ĞµĞ¹ Ğ²Ğ¾Ğ´Ñ‹! Ğ§Ğ°ÑÑ‚Ğ¾ "Ğ³Ğ¾Ğ»Ğ¾Ğ´" = Ğ¶Ğ°Ğ¶Ğ´Ğ°. ĞŸĞ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ğ¾ĞµÑˆÑŒ.`,
                    type: 'warning',
                    priority: 6,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 7000
                });
            }

            if (helpers.isInTargetRange(kcalPct, goal) && mealCount >= 2) {
                advices.push({
                    id: 'deficit_on_track_motivation',
                    icon: 'ğŸ”¥',
                    text: 'Ğ”ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ²Ñ‹Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ â€” Ñ‚Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!',
                    details: 'ğŸ¯ ĞŸÑ€Ğ¸ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚Ğµ 10-15% Ñ‚Ñ‹ Ñ‚ĞµÑ€ÑĞµÑˆÑŒ ~0.5-1 ĞºĞ³ Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ Ğ±ĞµĞ· Ğ²Ñ€ĞµĞ´Ğ° Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼Ğ°. Ğ­Ñ‚Ğ¾ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµĞ¼Ğ¿!',
                    type: 'achievement',
                    priority: 45,
                    category: 'motivation',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        if (goal?.mode === 'maintenance') {
            if (helpers.isInTargetRange(kcalPct, goal) && mealCount >= 2) {
                advices.push({
                    id: 'maintenance_stable',
                    icon: 'âš–ï¸',
                    text: 'ĞšĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸ Ğ² Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞµ â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ!',
                    details: 'âš–ï¸ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ Ğ²ĞµÑĞ° â€” ÑÑ‚Ğ¾ Ñ‚Ğ¾Ğ¶Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚! Ğ¢Ñ‹ Ğ½Ğ°ÑˆÑ‘Ğ» ÑĞ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ â€” Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ´ÑƒÑ…Ğµ.',
                    type: 'achievement',
                    priority: 46,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ’° CALORIC DEBT TIPS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (caloricDebt && caloricDebt.hasDebt) {
            const debtKcal = Math.abs(caloricDebt.totalDebt);
            const dailyBoost = caloricDebt.dailyBoost || 0;
            const daysWithDeficit = caloricDebt.daysWithDeficit || 0;

            if (dailyBoost > 0 && hour >= 10 && !sessionStorage.getItem('heys_debt_info')) {
                advices.push({
                    id: 'caloric_debt_info',
                    icon: 'ğŸ’°',
                    text: `+${dailyBoost} ĞºĞºĞ°Ğ» Ğ±Ğ¾Ğ½ÑƒÑ Ğ·Ğ° Ğ²Ñ‡ĞµÑ€Ğ°ÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚!`,
                    details: `ğŸ“Š Ğ—Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 3 Ğ´Ğ½Ñ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ¸Ğ»ÑÑ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ ${debtKcal} ĞºĞºĞ°Ğ». ĞĞ¾Ñ€Ğ¼Ğ° ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ° Ğ´Ğ¾ ${displayOptimum || optimum} ĞºĞºĞ°Ğ» â€” Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ² Ğ²Ğ¾ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸.`,
                    type: 'tip',
                    priority: 30,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_debt_info', '1'); } catch (e) { } }
                });
            }

            if (debtKcal >= 500 && daysWithDeficit >= 2) {
                advices.push({
                    id: 'caloric_debt_high',
                    icon: 'âš ï¸',
                    text: 'ĞĞ°ĞºĞ¾Ğ¿Ğ¸Ğ»ÑÑ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ â€” Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»Ğ¸Ñ‚ÑŒÑÑ',
                    details: `ğŸ”¬ ${daysWithDeficit} Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ Ğ½ĞµĞ´Ğ¾ĞµĞ´Ğ°Ğ½Ğ¸Ğµ (âˆ’${debtKcal} ĞºĞºĞ°Ğ»). ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ»ĞµĞ¿Ñ‚Ğ¸Ğ½ Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ğ¼ĞµĞ½ Ğ²ĞµÑ‰ĞµÑÑ‚Ğ². Ğ Ğ°ÑÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ñ€ĞµÑ„Ğ¸Ğ´ Ğ¸Ğ»Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ÑŒ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.`,
                    type: 'warning',
                    priority: 25,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 7000
                });
            }

            const eatenPctOfBoost = dailyBoost > 0 ? (dayTot?.kcal || 0) / displayOptimum : 0;
            if (dailyBoost > 0 && eatenPctOfBoost >= 0.9 && eatenPctOfBoost <= 1.1 && hour >= 18) {
                advices.push({
                    id: 'caloric_debt_repaid',
                    icon: 'âœ…',
                    text: 'Ğ”Ğ¾Ğ»Ğ³ Ğ¿Ğ¾Ğ³Ğ°ÑˆĞ°ĞµÑ‚ÑÑ â€” Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ!',
                    details: 'ğŸ¯ Ğ¢Ñ‹ ÑÑŠĞµĞ» Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ñ‹, Ğ½Ğ¾ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞµĞ». Ğ­Ñ‚Ğ¾ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ²Ğ¾ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ±ĞµĞ· ÑĞºĞ°Ñ‡ĞºĞ° Ğ²ĞµÑĞ°.',
                    type: 'achievement',
                    priority: 10,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            const hasExcess = caloricDebt?.hasExcess;
            const dailyReduction = caloricDebt?.dailyReduction || 0;

            if (dailyReduction > 50 && !hasExcess && hour < 14) {
                advices.push({
                    id: 'excess_soft_correction',
                    icon: 'ğŸ¯',
                    text: `ĞĞ¾Ñ€Ğ¼Ğ° Ñ‡ÑƒÑ‚ÑŒ ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ° (âˆ’${dailyReduction} ĞºĞºĞ°Ğ») â€” Ğ¼ÑĞ³ĞºĞ¸Ğ¹ Ğ°ĞºÑ†ĞµĞ½Ñ‚`,
                    details: 'ğŸ“Š Ğ­Ñ‚Ğ¾ Ğ½Ğµ Ğ½Ğ°ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ! ĞšĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ñ 5-10% Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ±ĞµĞ· ÑÑ‚Ñ€ĞµÑÑĞ°. Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ â€” Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹.',
                    type: 'tip',
                    priority: 35,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }

            const proteinDebt = caloricDebt?.proteinDebt;
            if (proteinDebt?.hasDebt && proteinDebt.severity !== 'none') {
                const protSeverity = proteinDebt.severity;

                if (protSeverity === 'critical') {
                    advices.push({
                        id: 'protein_debt_critical',
                        icon: 'ğŸš¨',
                        text: 'ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ Ğ±ĞµĞ»ĞºĞ° Ğ·Ğ° 3 Ğ´Ğ½Ñ!',
                        details: `ğŸ’ª Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ»ĞºĞ° ${Math.round(proteinDebt.avgProteinPct * 100)}% Ğ¾Ñ‚ Ğ½Ğ¾Ñ€Ğ¼Ñ‹. ĞŸÑ€Ğ¸ <18% Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ñ‚ĞµÑ€ÑÑ‚ÑŒ Ğ¼Ñ‹ÑˆÑ†Ñ‹! Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ±ĞµĞ»ĞºĞ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ².`,
                        type: 'warning',
                        priority: 12,
                        category: 'nutrition',
                        triggers: ['tab_open'],
                        ttl: 8000
                    });
                } else if (protSeverity === 'moderate') {
                    advices.push({
                        id: 'protein_debt_moderate',
                        icon: 'ğŸ¥©',
                        text: 'ĞœĞ°Ğ»Ğ¾Ğ²Ğ°Ñ‚Ğ¾ Ğ±ĞµĞ»ĞºĞ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ´Ğ½Ğ¸',
                        details: `ğŸ— Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ ${Math.round(proteinDebt.avgProteinPct * 100)}% Ğ¾Ñ‚ Ğ½Ğ¾Ñ€Ğ¼Ñ‹. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³, ÑĞ¹Ñ†Ğ°, ĞºÑƒÑ€Ğ¸Ñ†Ñƒ Ğ¸Ğ»Ğ¸ Ñ€Ñ‹Ğ±Ñƒ â€” ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸ÑˆÑŒ Ğ¼Ñ‹ÑˆÑ†Ñ‹!`,
                        type: 'tip',
                        priority: 28,
                        category: 'nutrition',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                } else if (protSeverity === 'mild' && hour >= 14) {
                    advices.push({
                        id: 'protein_debt_mild',
                        icon: 'ğŸ’ª',
                        text: 'Ğ‘ĞµĞ»Ğ¾Ğº Ğ² Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ',
                        details: 'ğŸ¥š ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ Ğ±ĞµĞ»ĞºĞ° Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ´Ğ½Ğ¸. Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¾ÑÑ‚Ğ°Ñ€Ğ°Ğ¹ÑÑ Ğ´Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ñ€Ğ¼Ñƒ â€” ÑÑ‚Ğ¾ Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼Ğ° Ğ¸ Ğ¼Ñ‹ÑˆÑ†.',
                        type: 'tip',
                        priority: 45,
                        category: 'nutrition',
                        triggers: ['tab_open'],
                        ttl: 5000
                    });
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸŒˆ VARIETY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const allItems = (day?.meals || []).flatMap(m => m.items || []);
        const productNames = allItems.map(it => {
            const product = getProductForItem(it, pIndex);
            return (product?.name || it.name || '').toLowerCase().trim();
        }).filter(Boolean);
        const uniqueProducts = new Set(productNames).size;

        if (productNames.length >= 5 && uniqueProducts < 3) {
            advices.push({
                id: 'variety_low',
                icon: 'ğŸŒˆ',
                text: 'Ğ Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·ÑŒ Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',
                details: 'ğŸ¥— Ğ Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ = Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿ĞµĞºÑ‚Ñ€ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ¸ Ğ¼Ğ¸Ğ½ĞµÑ€Ğ°Ğ»Ğ¾Ğ². Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ†Ğ²ĞµÑ‚Ğ° ĞµĞ´Ñ‹ = Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ½ÑƒÑ‚Ñ€Ğ¸ĞµĞ½Ñ‚Ñ‹. Ğ¡Ñ‚Ğ°Ñ€Ğ°Ğ¹ÑÑ 10+ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² Ğ² Ğ´ĞµĞ½ÑŒ.',
                type: 'tip',
                priority: 45,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ½ï¸ MEAL-LEVEL
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const lastMealWithItems = getLastMealWithItems(day);
        const firstMealWithItems = getFirstMealWithItems(day);
        const lastMealTotals = lastMealWithItems ? getMealTotals(lastMealWithItems, pIndex) : null;

        if (lastMealTotals && lastMealTotals.kcal > THRESHOLDS.meal.tooLarge && canShowMealAdvice()) {
            advices.push({
                id: 'meal_too_large',
                icon: 'ğŸ½ï¸',
                text: personalizeText(`Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ (${Math.round(lastMealTotals.kcal)} ĞºĞºĞ°Ğ»)! Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑĞ´ĞµĞ»Ğ°Ğ¹ Ğ¿Ğ¾Ğ»ĞµĞ³Ñ‡Ğµ`, ctx),
                details: 'ğŸ½ï¸ Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ñ‹ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ñ€ĞµĞ·ĞºĞ¸Ğ¹ ÑĞºĞ°Ñ‡Ğ¾Ğº Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ° Ğ¸ ÑĞ¾Ğ½Ğ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ. Ğ›ÑƒÑ‡ÑˆĞµ 4-5 ÑÑ€ĞµĞ´Ğ½Ğ¸Ñ… Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ² Ğ¿Ğ¾ 300-500 ĞºĞºĞ°Ğ».',
                type: 'tip',
                priority: 71,
                category: 'nutrition',
                triggers: ['product_added'],
                excludes: ['meal_too_small'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealTotals && lastMealTotals.kcal < THRESHOLDS.meal.tooSmall && lastMealTotals.kcal > 0 && mealCount >= 2 && canShowMealAdvice()) {
            advices.push({
                id: 'meal_too_small',
                icon: 'ğŸ¥„',
                text: personalizeText(pickRandomText(['ĞœĞ°Ğ»Ğ¾Ğ²Ğ°Ñ‚Ğ¾ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞµÑ‰Ñ‘ Ñ‡Ñ‚Ğ¾-Ğ½Ğ¸Ğ±ÑƒĞ´ÑŒ', '${firstName}, Ğ¼Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚Ğ¾ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞµÑ‰Ñ‘']), ctx),
                details: 'ğŸ¥„ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ñ‹ Ğ½Ğµ Ğ½Ğ°ÑÑ‹Ñ‰Ğ°ÑÑ‚ Ğ¸ Ğ²ĞµĞ´ÑƒÑ‚ Ğº Ğ¿ĞµÑ€ĞµĞºÑƒÑĞ°Ğ¼. ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 150-200 ĞºĞºĞ°Ğ» Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ´Ğ»Ñ ÑÑ‹Ñ‚Ğ¾ÑÑ‚Ğ¸.',
                type: 'tip',
                priority: 72,
                category: 'nutrition',
                triggers: ['product_added'],
                excludes: ['meal_too_large'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealTotals && lastMealTotals.prot < THRESHOLDS.meal.proteinMin && lastMealTotals.kcal > 200 && canShowMealAdvice()) {
            advices.push({
                id: 'protein_per_meal_low',
                icon: 'ğŸ¥š',
                text: 'ĞœĞ°Ğ»Ğ¾ Ğ±ĞµĞ»ĞºĞ° Ğ² Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğµ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑĞ¹Ñ†Ğ¾ Ğ¸Ğ»Ğ¸ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³',
                details: 'ğŸ’ª 20-30Ğ³ Ğ±ĞµĞ»ĞºĞ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ â€” Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞ¸Ğ½Ñ‚ĞµĞ·Ğ° Ğ¼Ñ‹ÑˆÑ†. Ğ¯Ğ¹Ñ†Ğ¾ = 6Ğ³, 100Ğ³ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³Ğ° = 18Ğ³, ĞºÑƒÑ€Ğ¸Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ´ĞºĞ° = 31Ğ³.',
                type: 'tip',
                priority: 73,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (hour >= 20 && lastMealTotals && lastMealTotals.carbs > 50 && canShowMealAdvice()) {
            advices.push({
                id: 'evening_carbs_high',
                icon: 'ğŸŒ™',
                text: `${Math.round(lastMealTotals.carbs)}Ğ³ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ² Ğ½Ğ° Ğ½Ğ¾Ñ‡ÑŒ â€” ÑƒÑ‚Ñ€Ğ¾Ğ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾`,
                details: 'ğŸŒœ Ğ£Ğ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ²ÑĞ¿Ğ»ĞµÑĞº Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ ÑĞ°Ñ…Ğ°Ñ€Ğ° Ğ½Ğ¾Ñ‡ÑŒÑ. Ğ›ÑƒÑ‡ÑˆĞµ Ğ±ĞµĞ»Ğ¾Ğº + Ğ¾Ğ²Ğ¾Ñ‰Ğ¸ Ğ½Ğ° ÑƒĞ¶Ğ¸Ğ½.',
                type: 'tip',
                priority: 74,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealTotals && lastMealTotals.fiber > 8 && canShowMealAdvice()) {
            advices.push({
                id: 'fiber_per_meal_good',
                icon: 'ğŸ¥—',
                text: 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾ Ñ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ¹! ĞĞ°Ğ´Ğ¾Ğ»Ğ³Ğ¾ Ğ½Ğ°ÑÑ‹Ñ‚Ğ¸Ñ‚',
                details: 'ğŸ¥¦ 8+ Ğ³Ñ€Ğ°Ğ¼Ğ¼ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ¸ Ğ² Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğµ â€” ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ĞšĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ² Ğ¸ Ğ´Ğ¾Ğ»ÑŒÑˆĞµ Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑÑ‹Ñ‚Ñ‹Ğ¼.',
                type: 'achievement',
                priority: 75,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000,
                onShow: () => markMealAdviceShown()
            });
        }

        if (lastMealWithItems && lastMealWithItems.items?.length >= 4 && canShowMealAdvice()) {
            advices.push({
                id: 'variety_meal_good',
                icon: 'ğŸŒˆ',
                text: 'Ğ Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ â€” Ñ‚Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!',
                details: 'ğŸŒŸ Ğ Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ = Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¼Ğ¸ĞºÑ€Ğ¾Ğ½ÑƒÑ‚Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ². Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ†Ğ²ĞµÑ‚Ğ° ĞµĞ´Ñ‹ = Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ¸ Ğ°Ğ½Ñ‚Ğ¸Ğ¾ĞºÑĞ¸Ğ´Ğ°Ğ½Ñ‚Ñ‹.',
                type: 'achievement',
                priority: 76,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 4000,
                onShow: () => markMealAdviceShown()
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¯ MEAL QUALITY SCORE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (lastMealWithItems && window.HEYS?.getMealQualityScore && canShowMealAdvice()) {
            const mealTypeInfo = window.HEYS.getMealType?.(lastMealWithItems) || { type: 'snack' };
            const quality = window.HEYS.getMealQualityScore(lastMealWithItems, mealTypeInfo.type, optimum || 2000, pIndex);

            if (quality?.score !== undefined) {
                if (quality.score >= 85) {
                    advices.push({
                        id: 'meal_quality_excellent',
                        icon: 'â­',
                        text: `ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼! ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ${quality.score}/100`,
                        details: 'ğŸ† Score 85+ Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¼Ğ°ĞºÑ€Ğ¾ÑĞ¾Ğ², Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ Ğ“Ğ˜ Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±ĞµĞ»ĞºĞ°. Ğ¢Ğ°Ğº Ğ¸ Ğ½Ğ°Ğ´Ğ¾!',
                        type: 'achievement',
                        priority: PRIORITY.ACHIEVEMENT,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 4000,
                        onShow: () => markMealAdviceShown()
                    });
                } else if (quality.score >= 70) {
                    advices.push({
                        id: 'meal_quality_good',
                        icon: 'âœ“',
                        text: `ĞĞµĞ¿Ğ»Ğ¾Ñ…Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ (${quality.score}/100)`,
                        details: 'ğŸ‘ Score 70-84 â€” ÑÑ‚Ğ¾ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾! ĞœĞµĞ»ĞºĞ¸Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ: Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±ĞµĞ»ĞºĞ° Ğ¸Ğ»Ğ¸ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ².',
                        type: 'tip',
                        priority: PRIORITY.NORMAL + 8,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 4000,
                        onShow: () => markMealAdviceShown()
                    });
                } else if (quality.score < 50) {
                    const issues = [];
                    if (quality.badges?.some(b => b.type === 'Ğ‘')) issues.push('Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ±ĞµĞ»ĞºĞ°');
                    if (quality.badges?.some(b => b.type === 'Ğ¢Ğ–')) issues.push('Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ñ€Ğ°Ğ½Ñ-Ğ¶Ğ¸Ñ€Ğ¾Ğ²');
                    if (quality.badges?.some(b => b.type === 'Ğ“Ğ˜')) issues.push('Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ğ“Ğ˜');
                    if (quality.badges?.some(b => b.type === 'ğŸŒ™')) issues.push('Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¾Ğ²Ğ°Ñ‚Ğ¾');

                    const issueText = issues.length > 0 ? ` â€” ${issues.slice(0, 2).join(', ')}` : '';

                    advices.push({
                        id: 'meal_quality_poor',
                        icon: 'âš ï¸',
                        text: `ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ (${quality.score}/100)${issueText}`,
                        details: 'ğŸ’¡ Score < 50 â€” ĞµÑÑ‚ÑŒ Ğ½Ğ°Ğ´ Ñ‡ĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ. Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ±ĞµĞ»ĞºĞ° (ÑĞ¹Ñ†Ğ¾, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³) Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ½Ğ° ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ.',
                        type: 'warning',
                        priority: PRIORITY.NUTRITION,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 5000,
                        onShow: () => markMealAdviceShown()
                    });
                }

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yKey = `heys_dayv2_${yesterday.toISOString().slice(0, 10)}`;
                const yesterdayDay = window.HEYS?.utils?.lsGet?.(yKey);

                if (yesterdayDay?.meals?.length > 0) {
                    let yScoreSum = 0, yCount = 0;
                    let tScoreSum = 0, tCount = 0;

                    for (const m of yesterdayDay.meals) {
                        if (m.items?.length > 0) {
                            const mt = window.HEYS.getMealType?.(m) || { type: 'snack' };
                            const qs = window.HEYS.getMealQualityScore(m, mt.type, optimum || 2000, pIndex);
                            if (qs?.score) { yScoreSum += qs.score; yCount++; }
                        }
                    }

                    for (const m of (day?.meals || [])) {
                        if (m.items?.length > 0) {
                            const mt = window.HEYS.getMealType?.(m) || { type: 'snack' };
                            const qs = window.HEYS.getMealQualityScore(m, mt.type, optimum || 2000, pIndex);
                            if (qs?.score) { tScoreSum += qs.score; tCount++; }
                        }
                    }

                    if (yCount >= 2 && tCount >= 2) {
                        const yAvg = yScoreSum / yCount;
                        const tAvg = tScoreSum / tCount;
                        const diff = tAvg - yAvg;

                        if (diff >= 10) {
                            advices.push({
                                id: 'meal_quality_improving',
                                icon: 'ğŸ“ˆ',
                                text: `ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞµĞ´Ñ‹ ÑƒĞ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ÑÑ! +${Math.round(diff)} Ğ·Ğ° Ğ´ĞµĞ½ÑŒ`,
                                details: 'ğŸš€ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ score Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ² ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ²Ñ‹ÑˆĞµ Ñ‡ĞµĞ¼ Ğ²Ñ‡ĞµÑ€Ğ°. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ´ÑƒÑ…Ğµ!',
                                type: 'achievement',
                                priority: PRIORITY.ACHIEVEMENT,
                                category: 'nutrition',
                                triggers: ['tab_open'],
                                ttl: 5000
                            });
                        }
                    }
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š DAY-QUALITY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if ((dayTot?.trans || 0) === 0 && mealCount >= 2) {
            advices.push({
                id: 'trans_free_day',
                icon: 'ğŸ‰',
                text: 'Ğ”ĞµĞ½ÑŒ Ğ±ĞµĞ· Ñ‚Ñ€Ğ°Ğ½Ñ-Ğ¶Ğ¸Ñ€Ğ¾Ğ²!',
                details: 'ğŸ’š Ğ¢Ñ€Ğ°Ğ½Ñ-Ğ¶Ğ¸Ñ€Ñ‹ â€” ÑĞ°Ğ¼Ñ‹Ğµ Ğ²Ñ€ĞµĞ´Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ÑĞµÑ€Ğ´Ñ†Ğ°. ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾, Ñ‡Ñ‚Ğ¾ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ±ĞµĞ· Ğ½Ğ¸Ñ…!',
                type: 'achievement',
                priority: 81,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if ((dayTot?.simple || 0) < 25 && (dayTot?.simple || 0) > 0 && mealCount >= 2) {
            advices.push({
                id: 'sugar_low_day',
                icon: 'ğŸ¬',
                text: 'ĞŸĞ¾Ñ‡Ñ‚Ğ¸ Ğ±ĞµĞ· ÑĞ°Ñ…Ğ°Ñ€Ğ° â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ğŸš«',
                details: 'ğŸ† ĞœĞµĞ½ĞµĞµ 25Ğ³ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ² â€” ÑÑ‚Ğ¾ ĞºÑ€ÑƒÑ‚Ğ¾! ĞĞ¾Ñ€Ğ¼Ğ° Ğ’ĞĞ—: Ğ¼Ğ°ĞºÑ 50Ğ³ ÑĞ°Ñ…Ğ°Ñ€Ğ° Ğ² Ğ´ĞµĞ½ÑŒ, Ğ¸Ğ´ĞµĞ°Ğ» â€” Ğ´Ğ¾ 25Ğ³.',
                type: 'achievement',
                priority: 82,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const uniqueProductCount = helpers.countUniqueProducts(day);
        if (uniqueProductCount >= 10) {
            advices.push({
                id: 'variety_day_good',
                icon: 'ğŸŒˆ',
                text: `${uniqueProductCount} Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ!`,
                details: 'ğŸ¥— 10+ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² = Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿ĞµĞºÑ‚Ñ€ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ğ¾Ğ², Ğ¼Ğ¸Ğ½ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ¸ Ğ°Ğ½Ñ‚Ğ¸Ğ¾ĞºÑĞ¸Ğ´Ğ°Ğ½Ñ‚Ğ¾Ğ². Ğ¢Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!',
                type: 'achievement',
                priority: 84,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (helpers.isInTargetRange(kcalPct, goal) && hour >= 12 && mealCount >= 2) {
            advices.push({
                id: 'goal_on_track',
                icon: goal.emoji,
                text: goal.mode === 'bulk'
                    ? 'ĞĞ°Ğ±Ğ¾Ñ€ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¿Ğ¾ Ğ¿Ğ»Ğ°Ğ½Ñƒ! ğŸ’ª'
                    : goal.mode === 'deficit'
                        ? 'Ğ”ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ²Ñ‹Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ! ğŸ”¥'
                        : 'ĞšĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ! âš–ï¸',
                details: 'ğŸ† ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ â€” ĞºĞ»ÑÑ‡ Ğº Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ. ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² Ğ¿Ğ»Ğ°Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ¶Ğ°ĞµÑ‚ Ñ‚ĞµĞ±Ñ Ğº Ñ†ĞµĞ»Ğ¸!',
                type: 'achievement',
                priority: 85,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¥œ AFTER SWEET
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const lastMeal = (day?.meals || []).slice(-1)[0];
        if (lastMeal && lastMeal.items?.length > 0) {
            let lastMealSimple = 0, lastMealCarbs = 0, lastMealKcal = 0;
            for (const item of lastMeal.items) {
                const product = getProductForItem(item, pIndex);
                if (!product) continue;
                const grams = item.grams || 100;
                lastMealSimple += (product.simple100 || 0) * grams / 100;
                lastMealCarbs += ((product.simple100 || 0) + (product.complex100 || 0)) * grams / 100;
                lastMealKcal += (product.kcal100 || 0) * grams / 100;
            }
            const lastMealSimplePct = lastMealCarbs > 0 ? (lastMealSimple / lastMealCarbs) : 0;

            if (lastMealSimplePct > 0.6 && lastMealKcal > 100) {
                advices.push({
                    id: 'after_sweet_protein',
                    icon: 'ğŸ¥œ',
                    text: 'ĞŸĞ¾ÑĞ»Ğµ ÑĞ»Ğ°Ğ´ĞºĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ±ĞµĞ»Ğ¾Ğº â€” Ğ¾Ñ€ĞµÑ…Ğ¸ Ğ¸Ğ»Ğ¸ Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³',
                    details: 'âš–ï¸ Ğ‘ĞµĞ»Ğ¾Ğº Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ ÑĞ°Ñ…Ğ°Ñ€Ğ° Ğ¸ ÑĞ¼ÑĞ³Ñ‡Ğ°ĞµÑ‚ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞºĞ°Ñ‡Ğ¾Ğº. Ğ“Ğ¾Ñ€ÑÑ‚ÑŒ Ğ¾Ñ€ĞµÑ…Ğ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ»Ğ¾Ğ¶ĞºĞ° Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³Ğ° ÑĞ¿Ğ°ÑÑƒÑ‚ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ.',
                    type: 'tip',
                    priority: 55,
                    category: 'nutrition',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š NUTRITION QUALITY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const avgGI = dayTot?.gi || 0;

        if (window.HEYS?.InsulinWave) {
            try {
                const iwData = window.HEYS.InsulinWave.calculate({
                    meals: day?.meals || [],
                    pIndex: window.HEYS?.day?.productIndex,
                    getProductFromItem: (item, idx) => {
                        if (!idx?.byId) return null;
                        return idx.byId.get(item.product_id) || idx.byId.get(String(item.product_id));
                    },
                    baseWaveHours: prof?.insulinWaveHours || 3
                });

                if (iwData && iwData.status !== 'ready' && iwData.avgGI > 65) {
                    const remainingText = iwData.remaining > 60
                        ? Math.round(iwData.remaining / 60) + 'Ñ‡'
                        : Math.round(iwData.remaining) + ' Ğ¼Ğ¸Ğ½';

                    advices.push({
                        id: 'high_gi_during_wave',
                        icon: 'âš¡',
                        text: `Ğ“Ğ˜ ${iwData.avgGI} Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ğ¾Ğ»Ğ½Ñ‹ (${remainingText}) â€” ÑĞ°Ñ…Ğ°Ñ€ Ğ² ĞºÑ€Ğ¾Ğ²Ğ¸ Ğ¿Ğ¾Ğ´ÑĞºĞ¾Ñ‡Ğ¸Ñ‚`,
                        type: 'warning',
                        priority: 8,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 6000
                    });
                }

                if (iwData && iwData.status !== 'ready' && iwData.avgGI <= 40) {
                    advices.push({
                        id: 'low_gi_during_wave',
                        icon: 'ğŸ‘',
                        text: `Ğ“Ğ˜ ${iwData.avgGI} â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ²Ğ¾Ğ»Ğ½Ñ‹!`,
                        type: 'achievement',
                        priority: 35,
                        category: 'nutrition',
                        triggers: ['product_added'],
                        ttl: 4000
                    });
                }
            } catch (e) {
                // ignore
            }
        }

        if (avgGI > 70 && mealCount >= 2) {
            advices.push({
                id: 'high_gi_warning',
                icon: 'ğŸ“ˆ',
                text: `Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ“Ğ˜ ${Math.round(avgGI)} â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ±ĞµĞ»Ğ¾Ğº Ğ¸ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºÑƒ`,
                details: 'ğŸ“‰ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ğ“Ğ˜ = ÑĞºĞ°Ñ‡ĞºĞ¸ ÑĞ°Ñ…Ğ°Ñ€Ğ° Ğ¸ Ğ³Ğ¾Ğ»Ğ¾Ğ´. Ğ‘ĞµĞ»Ğ¾Ğº Ğ¸ ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑÑÑ‚ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ².',
                type: 'tip',
                priority: 33,
                category: 'nutrition',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        if (avgGI > 0 && avgGI <= 55 && mealCount >= 2) {
            advices.push({
                id: 'low_gi_great',
                icon: 'ğŸ’š',
                text: `Ğ“Ğ˜ ${Math.round(avgGI)} â€” ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ²ĞµÑÑŒ Ğ´ĞµĞ½ÑŒ`,
                details: 'ğŸŒ¿ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ğ“Ğ˜ = ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ±ĞµĞ· ÑĞºĞ°Ñ‡ĞºĞ¾Ğ². Ğ¢Ñ‹ Ğ½Ğµ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ° Ğ¸ ÑƒĞ¿Ğ°Ğ´ĞºĞ° ÑĞ¸Ğ».',
                type: 'achievement',
                priority: 36,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        const simpleCarbs = dayTot?.simple || 0;
        const complexCarbs = dayTot?.complex || 0;
        const totalCarbs = simpleCarbs + complexCarbs;

        if (totalCarbs > 50) {
            const simpleRatio = simpleCarbs / totalCarbs;

            if (simpleRatio > 0.5) {
                advices.push({
                    id: 'simple_complex_ratio',
                    icon: 'âš–ï¸',
                    text: `${Math.round(simpleRatio * 100)}% Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ² â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞºĞ°ÑˆĞ¸, Ñ…Ğ»ĞµĞ±`,
                    details: 'ğŸŒ¾ Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ: 70% ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… (ĞºĞ°ÑˆĞ¸, Ñ…Ğ»ĞµĞ±, Ğ¼Ğ°ĞºĞ°Ñ€Ğ¾Ğ½Ñ‹) / 30% Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… (Ñ„Ñ€ÑƒĞºÑ‚Ñ‹, Ğ¼Ñ‘Ğ´). Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ´Ğ°ÑÑ‚ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½ÑƒÑ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ Ğ½Ğ° 3-4 Ñ‡Ğ°ÑĞ° Ğ±ĞµĞ· ÑĞºĞ°Ñ‡ĞºĞ¾Ğ² ÑĞ°Ñ…Ğ°Ñ€Ğ°.',
                    type: 'tip',
                    priority: 34,
                    category: 'nutrition',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }

            if (simpleRatio <= 0.3 && mealCount >= 2) {
                advices.push({
                    id: 'carbs_balance_perfect',
                    icon: 'ğŸŒ¾',
                    text: 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ¾Ğ²!',
                    details: 'ğŸŒ¾ 70% ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… / 30% Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… â€” Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸.',
                    type: 'achievement',
                    priority: 37,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        const goodFat = dayTot?.good || 0;
        const badFat = dayTot?.bad || 0;
        const transFat = dayTot?.trans || 0;
        const totalFat = goodFat + badFat + transFat;

        if (totalFat > 20) {
            const goodRatio = goodFat / totalFat;

            if (goodRatio < 0.4) {
                advices.push({
                    id: 'fat_quality_low',
                    icon: 'ğŸŸ',
                    text: 'Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ñ… Ğ¶Ğ¸Ñ€Ğ¾Ğ² â€” Ñ€Ñ‹Ğ±Ğ°, Ğ¾Ñ€ĞµÑ…Ğ¸, Ğ°Ğ²Ğ¾ĞºĞ°Ğ´Ğ¾',
                    details: 'ğŸ§  ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ Ğ¶Ğ¸Ñ€Ñ‹ (Ğ¾Ğ¼ĞµĞ³Ğ°-3) Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ·Ğ³Ğ°, ÑĞµÑ€Ğ´Ñ†Ğ° Ğ¸ Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ğ¾Ğ². Ğ¡Ñ‘Ğ¼Ğ³Ğ°, Ğ³Ñ€ĞµÑ†ĞºĞ¸Ğµ Ğ¾Ñ€ĞµÑ…Ğ¸, Ğ°Ğ²Ğ¾ĞºĞ°Ğ´Ğ¾.',
                    type: 'tip',
                    priority: 32,
                    category: 'nutrition',
                    triggers: ['product_added', 'tab_open'],
                    ttl: 5000
                });
            }

            if (goodRatio >= 0.6) {
                advices.push({
                    id: 'fat_quality_great',
                    icon: 'ğŸ’š',
                    text: `${Math.round(goodRatio * 100)}% Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ñ… Ğ¶Ğ¸Ñ€Ğ¾Ğ² â€” ÑÑƒĞ¿ĞµÑ€!`,
                    details: 'â¤ï¸ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ğ¶Ğ¸Ñ€Ğ¾Ğ²! Ğ¢Ğ²Ğ¾Ñ‘ ÑĞµÑ€Ğ´Ñ†Ğµ Ğ¸ Ğ¼Ğ¾Ğ·Ğ³ ÑĞºĞ°Ğ¶ÑƒÑ‚ ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾.',
                    type: 'achievement',
                    priority: 38,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // â˜• Caffeine timing (nutrition category)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const coffeeCheck = (() => {
            const bedInfo = getHoursUntilBedtime(hour, prof);
            const hoursToSleep = bedInfo.hoursUntilBed;

            const caffeineUnsafeHour = bedInfo.source === 'history'
                ? Math.max(12, 24 - 6 + parseInt(bedInfo.bedtimeFormatted.split(':')[0]) - 24)
                : 16;

            return {
                hasCoffee: hasCoffeeAfterHour(day?.meals, Math.min(caffeineUnsafeHour, 16), pIndex),
                bedtime: bedInfo.bedtimeFormatted,
                hoursToSleep,
                source: bedInfo.source
            };
        })();

        if (coffeeCheck.hasCoffee && !sessionStorage.getItem('heys_caffeine_tip')) {
            const coffeeDetail = coffeeCheck.source === 'history'
                ? `â° Ğ¢Ñ‹ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°ĞµÑˆÑŒ Ğ² ${coffeeCheck.bedtime}. ĞšĞ¾Ñ„ĞµĞ¸Ğ½ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ 6-8 Ñ‡Ğ°ÑĞ¾Ğ² â€” Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ¼ĞµÑˆĞ°Ñ‚ÑŒ Ğ·Ğ°ÑĞ½ÑƒÑ‚ÑŒ!`
                : 'â° ĞšĞ¾Ñ„ĞµĞ¸Ğ½ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ 6-8 Ñ‡Ğ°ÑĞ¾Ğ². ĞšĞ¾Ñ„Ğµ Ğ² 16:00 = ĞºĞ¾Ñ„ĞµĞ¸Ğ½ Ğ² ĞºÑ€Ğ¾Ğ²Ğ¸ Ğ´Ğ¾ Ğ¿Ğ¾Ğ»ÑƒĞ½Ğ¾Ñ‡Ğ¸.';

            advices.push({
                id: 'caffeine_evening',
                icon: 'â˜•',
                text: coffeeCheck.hoursToSleep <= 6
                    ? `Ğ”Ğ¾ ÑĞ½Ğ° ${Math.round(coffeeCheck.hoursToSleep)}Ñ‡ â€” ĞºĞ¾Ñ„ĞµĞ¸Ğ½ ĞµÑ‰Ñ‘ Ğ² ĞºÑ€Ğ¾Ğ²Ğ¸!`
                    : 'ĞšĞ¾Ñ„Ğµ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒÑ…ÑƒĞ´ÑˆĞ¸Ñ‚ÑŒ ÑĞ¾Ğ½',
                details: coffeeDetail + '\n\nğŸ’¡ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°: Ğ´ĞµĞºĞ°Ñ„, Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ğ¹, Ñ†Ğ¸ĞºĞ¾Ñ€Ğ¸Ğ¹.',
                type: coffeeCheck.hoursToSleep <= 4 ? 'warning' : 'tip',
                priority: coffeeCheck.hoursToSleep <= 4 ? 25 : 42,
                category: 'nutrition',
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_caffeine_tip', '1'); } catch (e) { } }
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¥— SMART PRODUCT CATEGORIES
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (mealCount >= 2) {
            const categories = analyzeProductCategories(day, pIndex);

            if (categories.missing.includes('vegetables') && !sessionStorage.getItem('heys_veggies_tip')) {
                const config = PRODUCT_CATEGORIES.vegetables;
                advices.push({
                    id: 'missing_vegetables',
                    icon: config.icon,
                    text: config.advice,
                    details: 'ğŸ¥— ĞĞ²Ğ¾Ñ‰Ğ¸ = ĞºĞ»ĞµÑ‚Ñ‡Ğ°Ñ‚ĞºĞ° + Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹ + ÑÑ‹Ñ‚Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼Ğµ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑĞ°Ğ»Ğ°Ñ‚ Ğ¸Ğ»Ğ¸ Ğ¾Ğ²Ğ¾Ñ‰Ğ¸ Ğ² Ğ±Ğ»ÑĞ´Ğ¾.',
                    type: 'tip',
                    priority: 52,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_veggies_tip', '1'); } catch (e) { } }
                });
            }

            if (categories.missing.includes('dairy') && !sessionStorage.getItem('heys_dairy_tip')) {
                const config = PRODUCT_CATEGORIES.dairy;
                advices.push({
                    id: 'missing_dairy',
                    icon: config.icon,
                    text: config.advice,
                    details: 'ğŸ§€ ĞœĞ¾Ğ»Ğ¾Ñ‡ĞºĞ° = ĞºĞ°Ğ»ÑŒÑ†Ğ¸Ğ¹ + Ğ±ĞµĞ»Ğ¾Ğº + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ¾Ñ‚Ğ¸ĞºĞ¸ (Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚). Ğ”Ğ»Ñ ĞºĞ¾ÑÑ‚ĞµĞ¹ Ğ¸ Ğ¼Ñ‹ÑˆÑ†.',
                    type: 'tip',
                    priority: 53,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_dairy_tip', '1'); } catch (e) { } }
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š DAY FORECAST
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (hour >= 11 && hour <= 18 && mealCount >= 1 && !sessionStorage.getItem('heys_forecast_shown')) {
            const forecast = getDayForecast(kcalPct, hour, mealCount);

            if (forecast && forecast.trend !== 'on_track') {
                advices.push({
                    id: 'day_forecast',
                    icon: forecast.trend === 'under' ? 'ğŸ“‰' : 'ğŸ“ˆ',
                    text: forecast.message,
                    details: 'ğŸ”® ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ñ‚ĞµĞ¼Ğ¿Ğ°. ĞœĞ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° Ğ´Ğ½Ñ.',
                    type: 'insight',
                    priority: 42,
                    category: 'nutrition',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_forecast_shown', '1'); } catch (e) { } }
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_nutrition.js =====

// ===== Begin advice/_timing.js =====
;/**
 * HEYS Advice Module v1 â€” Timing
 * @file advice/_timing.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.timing = function buildTimingAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { PRIORITY, THRESHOLDS } = rules;

        const { day, hour, mealCount, prof, kcalPct, optimum } = ctx;

        const toMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + (m || 0);
        };

        const mealsWithItems = (day?.meals || []).filter(m => m.items?.length > 0 && m.time);
        const mealTimes = mealsWithItems.map(m => toMinutes(m.time)).sort((a, b) => a - b);

        const lastMealWithItems = helpers.getLastMealWithItems(day);
        const firstMealWithItems = helpers.getFirstMealWithItems(day);

        // late_first_meal â€” Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¸Ğ¹ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼
        if (firstMealWithItems && hour >= 13) {
            const fmHour = toMinutes(firstMealWithItems.time) / 60;
            if (fmHour >= 12) {
                advices.push({
                    id: 'late_first_meal',
                    icon: 'â°',
                    text: 'ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¾Ğ²Ğ°Ñ‚Ğ¾ â€” Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ñ€Ğ°Ğ½ÑŒÑˆĞµ',
                    details: 'â˜• ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ´Ğ¾ 12:00 Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ¸ Ğ´Ğ°Ñ‘Ñ‚ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ. ĞŸĞ¾Ğ·Ğ´Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº = Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¸Ğ¹ ÑƒĞ¶Ğ¸Ğ½.',
                    type: 'tip',
                    priority: 77,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // fasting_window_good â€” 14+ Ñ‡Ğ°ÑĞ¾Ğ² Ğ±ĞµĞ· ĞµĞ´Ñ‹ (ÑƒĞ¶Ğ¸Ğ½â†’Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº)
        if (firstMealWithItems && hour >= 10) {
            const yesterdayDays = helpers.getRecentDays(1);
            const yesterdayDay = yesterdayDays[0];
            const yesterdayLastMeal = helpers.getLastMealWithItems(yesterdayDay);

            if (yesterdayLastMeal) {
                const lastH = Math.floor(toMinutes(yesterdayLastMeal.time) / 60);
                const firstH = Math.floor(toMinutes(firstMealWithItems.time) / 60);
                const fastingWindow = (24 - lastH) + firstH;

                if (fastingWindow >= 14 && !sessionStorage.getItem('heys_fasting_good')) {
                    advices.push({
                        id: 'fasting_window_good',
                        icon: 'ğŸ•',
                        text: `${fastingWindow}+ Ñ‡Ğ°ÑĞ¾Ğ² Ğ±ĞµĞ· ĞµĞ´Ñ‹ â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾!`,
                        details: 'â° 14+ Ñ‡Ğ°ÑĞ¾Ğ² Ğ½Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ñ = Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ. Ğ­Ñ‚Ğ¾ ÑƒÑĞºĞ¾Ñ€ÑĞµÑ‚ Ğ°ÑƒÑ‚Ğ¾Ñ„Ğ°Ğ³Ğ¸Ñ Ğ¸ Ğ¶Ğ¸Ñ€Ğ¾ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ.',
                        type: 'achievement',
                        priority: 91,
                        category: 'timing',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_fasting_good', '1'); } catch (e) { } }
                    });
                }
            }
        }

        // lipolysis_going_strong / long_fast_warning
        if (mealTimes.length >= 1 && hour >= 10 && hour <= 18) {
            const lastMealMinutes = mealTimes[mealTimes.length - 1];
            const nowMinutes = hour * 60 + new Date().getMinutes();
            const gapHours = (nowMinutes - lastMealMinutes) / 60;

            if (gapHours > 5 && gapHours <= 7) {
                advices.push({
                    id: 'lipolysis_going_strong',
                    icon: 'ğŸ”¥',
                    text: `${Math.round(gapHours)}Ñ‡ Ğ±ĞµĞ· ĞµĞ´Ñ‹ â€” Ğ»Ğ¸Ğ¿Ğ¾Ğ»Ğ¸Ğ· Ğ² Ñ€Ğ°Ğ·Ğ³Ğ°Ñ€Ğµ! Ğ”ĞµÑ€Ğ¶Ğ¸ÑÑŒ!`,
                    details: 'ğŸ”¥ ĞŸĞ¾ÑĞ»Ğµ 4-5 Ñ‡Ğ°ÑĞ¾Ğ² Ğ±ĞµĞ· ĞµĞ´Ñ‹ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½ Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ¸ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¶Ğ¸Ñ€Ğ¾ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ. Ğ¢Ñ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ»Ğ¸Ğ¿Ğ¾Ğ»Ğ¸Ğ·Ğ°!',
                    type: 'achievement',
                    priority: 92,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            } else if (gapHours > 7) {
                advices.push({
                    id: 'long_fast_warning',
                    icon: 'âš ï¸',
                    text: `${Math.round(gapHours)}Ñ‡ Ğ±ĞµĞ· ĞµĞ´Ñ‹ â€” ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾ĞµÑˆÑŒ, Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹ Ğ“Ğ˜!`,
                    details: 'ğŸ¥— ĞŸĞ¾ÑĞ»Ğµ Ğ´Ğ¾Ğ»Ğ³Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ€Ñ‹Ğ²Ğ° Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½ Ğº ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ°Ğ¼. ĞĞ°Ñ‡Ğ½Ğ¸ Ñ Ğ±ĞµĞ»ĞºĞ° + Ğ¾Ğ²Ğ¾Ñ‰Ğ¸, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹.',
                    type: 'tip',
                    priority: 92,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // meal_spacing_perfect / frequent_eating_no_lipolysis
        if (mealTimes.length >= 3) {
            const gaps = [];
            for (let i = 1; i < mealTimes.length; i++) {
                gaps.push((mealTimes[i] - mealTimes[i - 1]) / 60);
            }
            const allGapsGood = gaps.every(g => g >= 3 && g <= 5);

            if (allGapsGood && !sessionStorage.getItem('heys_spacing_perfect')) {
                advices.push({
                    id: 'meal_spacing_perfect',
                    icon: 'ğŸ”¥',
                    text: 'Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹! ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ² Ğ»Ğ¸Ğ¿Ğ¾Ğ»Ğ¸Ğ·Ğµ',
                    details: 'â±ï¸ Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹ 3-5 Ñ‡Ğ°ÑĞ¾Ğ² = Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¶Ğ¸Ñ€Ğ¾ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ°Ğ¼Ğ¸. Ğ˜Ğ½ÑÑƒĞ»Ğ¸Ğ½ ÑƒÑĞ¿ĞµĞ²Ğ°ĞµÑ‚ ÑĞ½Ğ¸Ğ·Ğ¸Ñ‚ÑŒÑÑ, Ğ¸ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ Ğ¶Ğ¸Ñ€Ğ°.',
                    type: 'achievement',
                    priority: 93,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_spacing_perfect', '1'); } catch (e) { } }
                });
            }

            const shortGaps = gaps.filter(g => g < 2);
            if (shortGaps.length >= 2) {
                advices.push({
                    id: 'frequent_eating_no_lipolysis',
                    icon: 'ğŸ“ˆ',
                    text: 'Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ñ‹ â€” Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹, Ğ»Ğ¸Ğ¿Ğ¾Ğ»Ğ¸Ğ·Ğ° Ğ½ĞµÑ‚',
                    details: 'ğŸ“Š ĞŸĞµÑ€ĞµÑ€Ñ‹Ğ²Ñ‹ < 2 Ñ‡Ğ°ÑĞ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ ĞµĞ´Ğ¾Ğ¹ = Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½. Ğ–Ğ¸Ñ€Ğ¾ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ. Ğ”ĞµĞ»Ğ°Ğ¹ Ğ¿Ğ°ÑƒĞ·Ñ‹ 3-5 Ñ‡Ğ°ÑĞ¾Ğ².',
                    type: 'warning',
                    priority: 45,
                    category: 'timing',
                    triggers: ['meal_added'],
                    ttl: 6000
                });
            }
        }

        // insulin_too_fast / insulin_perfect / insulin_countdown
        if (mealsWithItems.length >= 2) {
            const insulinWave = prof?.insulinWaveHours || 4;

            for (let i = 1; i < mealTimes.length; i++) {
                const gap = mealTimes[i] - mealTimes[i - 1];
                if (gap < insulinWave * 60 * 0.5) {
                    const gapHours = (gap / 60).toFixed(1).replace('.0', '');
                    advices.push({
                        id: 'insulin_too_fast',
                        icon: 'â±ï¸',
                        text: `ĞœĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ°Ğ¼Ğ¸ ${gapHours}Ñ‡ â€” Ğ´Ğ°Ğ¹ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ñƒ Ğ¾Ñ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ`,
                        details: 'ğŸ”– Ğ˜Ğ½ÑÑƒĞ»Ğ¸Ğ½ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ = Ğ¶Ğ¸Ñ€ Ğ½Ğµ Ğ³Ğ¾Ñ€Ğ¸Ñ‚. Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµÑ€Ñ‹Ğ² 3-4 Ñ‡Ğ°ÑĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ°Ğ¼Ğ¸.',
                        type: 'tip',
                        priority: 38,
                        category: 'timing',
                        triggers: ['product_added'],
                        ttl: 5000
                    });
                    break;
                }
            }

            const avgGap = (mealTimes[mealTimes.length - 1] - mealTimes[0]) / (mealTimes.length - 1);
            if (avgGap >= insulinWave * 60 * 0.9 && mealsWithItems.length >= 3) {
                advices.push({
                    id: 'insulin_perfect',
                    icon: 'â°',
                    text: 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ°Ğ¼Ğ¸!',
                    details: 'ğŸ¯ Ğ˜Ğ½ÑÑƒĞ»Ğ¸Ğ½ ÑƒÑĞ¿ĞµĞ²Ğ°ĞµÑ‚ ÑĞ½Ğ¸Ğ·Ğ¸Ñ‚ÑŒÑÑ â†’ Ğ»Ğ¸Ğ¿Ğ¾Ğ»Ğ¸Ğ· Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ. Ğ¢Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!',
                    type: 'achievement',
                    priority: 39,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }

            const lastMealTimeMinutes = mealTimes[mealTimes.length - 1];
            const nowMinutes = hour * 60 + new Date().getMinutes();
            const insulinEndMinutes = lastMealTimeMinutes + insulinWave * 60;
            const minutesUntilEnd = insulinEndMinutes - nowMinutes;

            if (minutesUntilEnd > 0 && minutesUntilEnd < 60 && !sessionStorage.getItem('heys_insulin_countdown')) {
                advices.push({
                    id: 'insulin_countdown',
                    icon: 'â±ï¸',
                    text: `Ğ§ĞµÑ€ĞµĞ· ${minutesUntilEnd} Ğ¼Ğ¸Ğ½ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ¾Ğ²Ğ°Ñ Ğ²Ğ¾Ğ»Ğ½Ğ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑÑ â€” Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞºÑƒÑĞ¸Ñ‚ÑŒ`,
                    details: 'ğŸ”¥ ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½ ÑĞ½Ğ¸Ğ·Ğ¸Ñ‚ÑÑ, Ğ½Ğ°Ñ‡Ğ½Ñ‘Ñ‚ÑÑ Ğ¶Ğ¸Ñ€Ğ¾ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸ ĞµÑ‰Ñ‘ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾!',
                    type: 'info',
                    priority: 40,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_insulin_countdown', '1'); } catch (e) { } }
                });
            }
        }

        // bedtime_protein / bedtime_undereating
        const bedtimeInfo = helpers.getHoursUntilBedtime(hour, prof);
        const hoursUntilBed = bedtimeInfo.hoursUntilBed;
        const bedtimeText = bedtimeInfo.source === 'history'
            ? `(Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ² ${bedtimeInfo.bedtimeFormatted})`
            : '';

        if (hour >= 20 && hour <= 23 && ctx.proteinPct < 0.8 && hoursUntilBed > 0 && hoursUntilBed <= 4) {
            advices.push({
                id: 'bedtime_protein',
                icon: 'ğŸ¥›',
                text: `Ğ”Ğ¾ ÑĞ½Ğ° ~${Math.round(hoursUntilBed)}Ñ‡ ${bedtimeText} â€” Ğ´Ğ¾Ğ±ĞµÑ€Ğ¸ Ğ±ĞµĞ»Ğ¾Ğº!`,
                details: 'ğŸŒ™ ĞšĞ°Ğ·ĞµĞ¸Ğ½ (Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³, Ğ³Ñ€ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚) â€” Ğ¸Ğ´ĞµĞ°Ğ»ĞµĞ½ Ğ½Ğ° Ğ½Ğ¾Ñ‡ÑŒ. ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ ÑƒÑĞ²Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¸ Ğ¿Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ğ²Ğ¾ ÑĞ½Ğµ.',
                type: 'tip',
                priority: 35,
                category: 'timing',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hoursUntilBed > 0 && hoursUntilBed <= 2 && kcalPct < 0.7) {
            const kcalMissing = Math.round((1 - kcalPct) * (optimum || 2000));
            advices.push({
                id: 'bedtime_undereating',
                icon: 'â°',
                text: `Ğ”Ğ¾ ÑĞ½Ğ° ~${Math.round(hoursUntilBed)}Ñ‡, Ğ° Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ ${kcalMissing} ĞºĞºĞ°Ğ»!`,
                details: `ğŸ”¬ Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¼Ğ°Ğ»Ğ¾, Ğ½Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ğ¾ĞµÑÑ‚ÑŒ:\n\n` +
                    `â€¢ Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³ 200Ğ³ = 220 ĞºĞºĞ°Ğ», 36Ğ³ Ğ±ĞµĞ»ĞºĞ° â€” Ğ¿ĞµÑ€ĞµĞ²Ğ°Ñ€Ğ¸Ñ‚ÑÑ Ğ·Ğ° 1.5-2Ñ‡\n` +
                    `â€¢ ĞŸÑ€Ğ¾Ñ‚ĞµĞ¸Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾ĞºÑ‚ĞµĞ¹Ğ»ÑŒ = 120-200 ĞºĞºĞ°Ğ» Ğ·Ğ° 30 Ğ¼Ğ¸Ğ½\n` +
                    `â€¢ ĞÑ€ĞµÑ…Ğ¸ 50Ğ³ = 300 ĞºĞºĞ°Ğ» â€” Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¸ ÑÑ‹Ñ‚Ğ½Ğ¾\n\n` +
                    `ğŸ’¡ Ğ“Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ÑĞ¾Ğ½ = Ğ¿Ğ»Ğ¾Ñ…Ğ¾Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ + Ğ¿ĞµÑ€ĞµĞµĞ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°`,
                type: 'warning',
                priority: 8,
                category: 'timing',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        // late_dinner_warning / late_heavy_meal / good_dinner_time
        const lastMealTime = (() => {
            const mealsList = (day?.meals || []).filter(m => m.items?.length > 0);
            if (mealsList.length === 0) return null;
            const timesList = mealsList.map(m => m.time || '12:00').sort();
            return timesList[timesList.length - 1];
        })();

        if (lastMealTime) {
            const lastH = Math.floor(toMinutes(lastMealTime) / 60);

            if (lastH >= 22) {
                advices.push({
                    id: 'late_dinner_warning',
                    icon: 'ğŸŒ™',
                    text: 'ĞŸĞ¾Ğ·Ğ´Ğ½Ğ¸Ğ¹ ÑƒĞ¶Ğ¸Ğ½ â€” ÑĞ¾Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ñ…ÑƒĞ¶Ğµ',
                    details: 'ğŸ’¤ Ğ•Ğ´Ğ° Ğ·Ğ° 2-3 Ñ‡Ğ°ÑĞ° Ğ´Ğ¾ ÑĞ½Ğ° ÑƒÑĞ¿ĞµĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ°Ñ€Ğ¸Ñ‚ÑŒÑÑ. ĞŸĞ¾Ğ·Ğ´Ğ½Ñ‹Ğ¹ ÑƒĞ¶Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¶Ğ¾Ğ³Ñƒ Ğ¸ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚Ğ½Ñ‹Ğ¹ ÑĞ¾Ğ½.',
                    type: 'tip',
                    priority: 41,
                    category: 'timing',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }

            if (lastH >= 21 && lastH < 22 && !sessionStorage.getItem('heys_late_heavy_shown')) {
                const lastMealByTime = (day?.meals || []).find(m => m.time === lastMealTime);
                if (lastMealByTime) {
                    let lateMealKcal = 0;
                    for (const item of (lastMealByTime.items || [])) {
                        const product = helpers.getProductForItem(item, ctx.pIndex);
                        if (product) lateMealKcal += (product.kcal100 || 0) * (item.grams || 100) / 100;
                    }

                    if (lateMealKcal > 500) {
                        advices.push({
                            id: 'late_heavy_meal',
                            icon: 'ğŸŒ™',
                            text: `ĞŸĞ»Ğ¾Ñ‚Ğ½Ñ‹Ğ¹ ÑƒĞ¶Ğ¸Ğ½ (${Math.round(lateMealKcal)} ĞºĞºĞ°Ğ») Ğ¿Ğ¾ÑĞ»Ğµ 21:00 â€” ÑĞ¾Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ñ…ÑƒĞ¶Ğµ`,
                            details: 'ğŸ’¤ ĞŸĞ¸Ñ‰ĞµĞ²Ğ°Ñ€ĞµĞ½Ğ¸Ğµ Ğ¼ĞµÑˆĞ°ĞµÑ‚ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾Ğ¼Ñƒ ÑĞ½Ñƒ. Ğ’ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ· Ğ¿Ğ¾ÑƒĞ¶Ğ¸Ğ½Ğ°Ğ¹ Ğ»ĞµĞ³Ñ‡Ğµ Ğ¸Ğ»Ğ¸ Ñ€Ğ°Ğ½ÑŒÑˆĞµ.',
                            type: 'tip',
                            priority: 40,
                            category: 'timing',
                            triggers: ['product_added'],
                            ttl: 5000,
                            onShow: () => { try { sessionStorage.setItem('heys_late_heavy_shown', '1'); } catch (e) { } }
                        });
                    }
                }
            }

            if (lastH >= 18 && lastH <= 20 && hour >= 21) {
                advices.push({
                    id: 'good_dinner_time',
                    icon: 'ğŸŒ™',
                    text: 'Ğ£Ğ¶Ğ¸Ğ½ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ â€” ÑĞ¾Ğ½ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞµ!',
                    details: 'ğŸŒ™ ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑƒĞ¶Ğ¸Ğ½ â€” Ğ·Ğ° 2-3 Ñ‡Ğ°ÑĞ° Ğ´Ğ¾ ÑĞ½Ğ°. Ğ¢Ñ‹ Ğ²ÑÑ‘ ÑĞ´ĞµĞ»Ğ°Ğ» Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾!',
                    type: 'achievement',
                    priority: 42,
                    category: 'timing',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_timing.js =====

// ===== Begin advice/_training.js =====
;/**
 * HEYS Advice Module v1 â€” Training
 * @file advice/_training.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.training = function buildTrainingAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { THRESHOLDS } = rules;

        const {
            day,
            dayTot,
            normAbs,
            hour,
            mealCount,
            hasTraining,
            kcalPct,
            optimum,
            pIndex,
            proteinPct,
            carbsPct,
            caloricDebt
        } = ctx;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ‹ï¸ Post-training nutrition
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (hasTraining && proteinPct < THRESHOLDS.protein.adequate) {
            advices.push({
                id: 'post_training_protein',
                icon: 'ğŸ’ª',
                text: helpers.personalizeText(helpers.pickRandomText([
                    'ĞŸĞ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ²Ğ°Ğ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ 20-30Ğ³',
                    '${firstName}, Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ½ÑƒĞ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº!',
                    'ĞœÑ‹ÑˆÑ†Ñ‹ Ğ¶Ğ´ÑƒÑ‚ Ğ±ĞµĞ»Ğ¾Ğº â€” Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³, ĞºÑƒÑ€Ğ¸Ñ†Ğ°, ÑĞ¹Ñ†Ğ°'
                ]), ctx),
                details: 'Ğ‘ĞµĞ»Ğ¾Ğº Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 2 Ñ‡Ğ°ÑĞ¾Ğ² Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ÑƒÑĞºĞ¾Ñ€ÑĞµÑ‚ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ñ‹ÑˆÑ†. Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾: Ğ¿Ñ€Ğ¾Ñ‚ĞµĞ¸Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾ĞºÑ‚ĞµĞ¹Ğ»ÑŒ, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³ Ñ Ğ±Ğ°Ğ½Ğ°Ğ½Ğ¾Ğ¼, ĞºÑƒÑ€Ğ¸Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ´ĞºĞ° Ñ Ñ€Ğ¸ÑĞ¾Ğ¼, Ğ¸Ğ»Ğ¸ Ğ³Ñ€ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚ Ñ Ğ¾Ñ€ĞµÑ…Ğ°Ğ¼Ğ¸.',
                type: 'tip',
                priority: 34,
                category: 'training',
                triggers: ['product_added', 'tab_open'],
                excludes: ['protein_low', 'hard_workout_recovery', 'training_recovery_window'],
                canSkipCooldown: true,
                ttl: 5000
            });
        }

        if (hasTraining && kcalPct < 0.7 && hour >= 18) {
            const kcalMissing = Math.round((1 - kcalPct) * (optimum || 2000));
            advices.push({
                id: 'post_training_undereating_critical',
                icon: 'ğŸš¨',
                text: `ĞŸĞ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ ${kcalMissing} ĞºĞºĞ°Ğ» â€” Ğ¼Ñ‹ÑˆÑ†Ğ°Ğ¼ Ğ½ÑƒĞ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº!`,
                details: `ğŸ”¬ ĞĞ°ÑƒÑ‡Ğ½Ñ‹Ğ¹ Ñ„Ğ°ĞºÑ‚: Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 2-3 Ñ‡Ğ°ÑĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ â€” "Ğ°Ğ½Ğ°Ğ±Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾ĞºĞ½Ğ¾".\n\n` +
                    `â€¢ Ğ‘ĞµĞ· ĞµĞ´Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ = ĞºĞ°Ñ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ (Ñ€Ğ°Ğ·Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ¼Ñ‹ÑˆÑ†)\n` +
                    `â€¢ ĞŸĞ¾Ğ·Ğ´Ğ½Ğ¸Ğ¹ ÑƒĞ¶Ğ¸Ğ½ Ğ»ÑƒÑ‡ÑˆĞµ Ñ‡ĞµĞ¼ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸\n` +
                    `â€¢ Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾: 25-40Ğ³ Ğ±ĞµĞ»ĞºĞ° + ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹\n\n` +
                    `ğŸ’¡ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹: Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³ 200Ğ³, ÑĞ¹Ñ†Ğ° 3ÑˆÑ‚ + Ñ…Ğ»ĞµĞ±, ĞºÑƒÑ€Ğ¸Ñ†Ğ° + Ñ€Ğ¸Ñ, Ğ¿Ñ€Ğ¾Ñ‚ĞµĞ¸Ğ½ + Ğ±Ğ°Ğ½Ğ°Ğ½`,
                type: 'warning',
                priority: 5,
                category: 'training',
                triggers: ['tab_open'],
                ttl: 8000,
                canSkipCooldown: true
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ‹ï¸ Training day context (caloric debt)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const trainingCtx = caloricDebt?.trainingDayContext;
        if (trainingCtx?.isTrainingDay && trainingCtx.nutritionPriority === 'high') {
            const trainType = trainingCtx.trainingType;

            if (caloricDebt?.hasDebt && trainType === 'strength') {
                advices.push({
                    id: 'training_strength_undereating',
                    icon: 'ğŸ‹ï¸',
                    text: 'Ğ¡Ğ¸Ğ»Ğ¾Ğ²Ğ°Ñ + Ğ½ĞµĞ´Ğ¾ĞµĞ´Ğ°Ğ½Ğ¸Ğµ = Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ Ğ¼Ñ‹ÑˆÑ†!',
                    details: 'ğŸ’ª ĞŸĞ¾ÑĞ»Ğµ ÑĞ¸Ğ»Ğ¾Ğ²Ğ¾Ğ¹ Ğ¼Ñ‹ÑˆÑ†Ğ°Ğ¼ Ğ½ÑƒĞ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº Ğ¸ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ. ĞĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ ÑĞµĞ¹Ñ‡Ğ°Ñ = Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ° Ğ² Ğ·Ğ°Ğ»Ğµ!',
                    type: 'warning',
                    priority: 14,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 7000
                });
            } else if (caloricDebt?.hasDebt && trainType === 'cardio') {
                advices.push({
                    id: 'training_cardio_undereating',
                    icon: 'ğŸƒ',
                    text: 'ĞšĞ°Ñ€Ğ´Ğ¸Ğ¾ + Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ â€” Ğ²Ğ¾ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ³Ğ»Ğ¸ĞºĞ¾Ğ³ĞµĞ½',
                    details: 'âš¡ ĞŸĞ¾ÑĞ»Ğµ ĞºĞ°Ñ€Ğ´Ğ¸Ğ¾ Ğ³Ğ»Ğ¸ĞºĞ¾Ğ³ĞµĞ½ Ğ¸ÑÑ‚Ğ¾Ñ‰Ñ‘Ğ½. Ğ£Ğ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ¿Ğ¾Ğ¹Ğ´ÑƒÑ‚ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Ğ¼Ñ‹ÑˆÑ†Ñ‹, Ğ° Ğ½Ğµ Ğ² Ğ¶Ğ¸Ñ€! ĞĞµ Ğ±Ğ¾Ğ¹ÑÑ Ğ¿Ğ¾ĞµÑÑ‚ÑŒ.',
                    type: 'tip',
                    priority: 23,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 6000
                });
            }

            if (trainingCtx.trainingIntensity === 'high' || trainingCtx.trainingIntensity === 'extreme') {
                advices.push({
                    id: 'training_high_intensity_nutrition',
                    icon: 'ğŸ”¥',
                    text: 'Ğ˜Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ°Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° â€” Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾!',
                    details: 'ğŸ’¥ Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ = Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´. Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ. ĞĞ¾Ñ€Ğ¼Ğ° ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ°!',
                    type: 'info',
                    priority: 26,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // â±ï¸ Recovery window (30-60 Ğ¼Ğ¸Ğ½ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const trainingsP3 = day?.trainings || [];
        const todayTrainingP3 = trainingsP3.find(t => t.z && t.z.some(m => m > 0));
        if (todayTrainingP3 && todayTrainingP3.time) {
            const [trainH, trainM] = todayTrainingP3.time.split(':').map(Number);
            const trainMinutes = trainH * 60 + trainM;
            const nowMinutes = hour * 60 + new Date().getMinutes();
            const minutesSince = nowMinutes - trainMinutes;

            if (minutesSince >= 30 && minutesSince <= 60 && proteinPct < 0.8) {
                advices.push({
                    id: 'training_recovery_window',
                    icon: 'ğŸ‹ï¸',
                    text: 'ĞĞºĞ½Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ â€” Ğ±ĞµĞ»Ğ¾Ğº ÑĞµĞ¹Ñ‡Ğ°Ñ ÑƒÑĞ²Ğ¾Ğ¸Ñ‚ÑÑ Ğ»ÑƒÑ‡ÑˆĞµ!',
                    details: 'ğŸ’ª 30-60 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ â€” Ğ°Ğ½Ğ°Ğ±Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾ĞºĞ½Ğ¾. Ğ‘ĞµĞ»Ğ¾Ğº ÑƒÑĞ²Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° 25% ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½ĞµĞµ. Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾: 20-30Ğ³ Ğ±ĞµĞ»ĞºĞ°.',
                    type: 'tip',
                    priority: 94,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ‹ï¸ Training tips (Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ, Ñ‚Ğ¸Ğ¿)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const trainings = day?.trainings || [];
        const todayTraining = trainings.find(t => t.z && t.z.some(m => m > 0));

        if (todayTraining) {
            const totalMinutes = todayTraining.z.reduce((a, b) => a + b, 0);
            const highIntensityMinutes = (todayTraining.z[2] || 0) + (todayTraining.z[3] || 0);
            const isHardWorkout = highIntensityMinutes > 20;
            const proteinPctLocal = (dayTot?.prot || 0) / ((normAbs?.prot || 100) || 1);

            if (isHardWorkout && proteinPctLocal < 1.0) {
                advices.push({
                    id: 'hard_workout_recovery',
                    icon: 'ğŸ”¥',
                    text: `${highIntensityMinutes} Ğ¼Ğ¸Ğ½ Ğ² Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ñ… Ğ·Ğ¾Ğ½Ğ°Ñ… â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ±ĞµĞ»ĞºĞ° Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ`,
                    details: 'ğŸ‹ï¸ Ğ˜Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ°Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¼Ğ¸ĞºÑ€Ğ¾Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¼Ñ‹ÑˆÑ†. Ğ‘ĞµĞ»Ğ¾Ğº Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 2Ñ‡ ÑƒÑĞºĞ¾Ñ€ÑĞµÑ‚ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ.',
                    type: 'tip',
                    priority: 30,
                    category: 'training',
                    triggers: ['product_added', 'tab_open'],
                    ttl: 5000
                });
            }

            const fatBurnMinutes = todayTraining.z[1] || 0;
            const carbsPctLocal = (dayTot?.carbs || 0) / ((normAbs?.carbs || 200) || 1);
            if (fatBurnMinutes > 30 && carbsPctLocal > 1.2) {
                advices.push({
                    id: 'cardio_carbs_balance',
                    icon: 'ğŸƒ',
                    text: 'ĞŸĞ¾ÑĞ»Ğµ ĞºĞ°Ñ€Ğ´Ğ¸Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµ Ğ±ĞµĞ»Ğ¾Ğº Ğ¸ Ğ¾Ğ²Ğ¾Ñ‰Ğ¸, Ñ‡ĞµĞ¼ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹',
                    details: 'ğŸ”¥ ĞŸĞ¾ÑĞ»Ğµ ĞºĞ°Ñ€Ğ´Ğ¸Ğ¾ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¶Ğ¸Ñ€Ğ¾ÑĞ¶Ğ¸Ğ³Ğ°Ğ½Ğ¸Ñ. Ğ£Ğ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ²Ñ‹ĞºĞ»ÑÑ‡Ğ°Ñ‚ ÑÑ‚Ğ¾Ñ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼.',
                    type: 'tip',
                    priority: 35,
                    category: 'training',
                    triggers: ['product_added'],
                    ttl: 5000
                });
            }

            if (totalMinutes >= 45) {
                advices.push({
                    id: 'great_workout',
                    icon: 'ğŸ’ª',
                    text: `${totalMinutes} Ğ¼Ğ¸Ğ½ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ â€” ÑÑƒĞ¿ĞµÑ€!`,
                    details: 'ğŸ¯ 45+ Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ = ÑĞµÑ€ÑŒÑ‘Ğ·Ğ½Ğ°Ñ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°! ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒ Ğ¿Ñ€Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ ÑĞ¾Ğ½.',
                    type: 'achievement',
                    priority: 7,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 4000
                });
            }

            if (todayTraining.type === 'strength' && proteinPctLocal < 1.0) {
                advices.push({
                    id: 'training_type_strength',
                    icon: 'ğŸ‹ï¸',
                    text: 'ĞŸĞ¾ÑĞ»Ğµ ÑĞ¸Ğ»Ğ¾Ğ²Ğ¾Ğ¹ Ğ²Ğ°Ğ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº â€” 20-30Ğ³ Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 2 Ñ‡Ğ°ÑĞ¾Ğ²',
                    details: 'ğŸ’ª Ğ¡Ğ¸Ğ»Ğ¾Ğ²Ğ°Ñ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¼Ğ¸ĞºÑ€Ğ¾Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¼Ñ‹ÑˆÑ†, Ğ±ĞµĞ»Ğ¾Ğº Ğ¸Ñ… Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚. Ğ‘ĞµĞ· Ğ±ĞµĞ»ĞºĞ° â€” Ñ€Ğ¾ÑÑ‚Ğ° Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚.',
                    type: 'tip',
                    priority: 31,
                    category: 'training',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 5000
                });
            }

            if (todayTraining.type === 'hobby' && !sessionStorage.getItem('heys_hobby_tip')) {
                advices.push({
                    id: 'training_type_hobby',
                    icon: 'ğŸ§˜',
                    text: 'ĞŸĞ¾ÑĞ»Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ…Ğ¾Ğ±Ğ±Ğ¸ Ğ¸Ğ´ĞµĞ°Ğ»ĞµĞ½ Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ â€” Ğ¾Ğ²Ğ¾Ñ‰Ğ¸, Ñ„Ñ€ÑƒĞºÑ‚Ñ‹',
                    details: 'ğŸŒ¿ Ğ™Ğ¾Ğ³Ğ°, Ğ¿Ñ€Ğ¾Ğ³ÑƒĞ»ĞºĞ¸, ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ñ€Ğ°ÑÑĞ»Ğ°Ğ±Ğ»ÑÑÑ‚ Ğ¸ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ°Ğ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ.',
                    type: 'tip',
                    priority: 49,
                    category: 'training',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_hobby_tip', '1'); } catch (e) { } }
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_training.js =====

// ===== Begin advice/_emotional.js =====
;/**
 * HEYS Advice Module v1 â€” Emotional & Correlation
 * @file advice/_emotional.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.emotional = function buildEmotionalAdvices(ctx, helpers) {
        const advices = [];

        const {
            day,
            dayTot,
            normAbs,
            optimum,
            hour,
            mealCount,
            kcalPct,
            emotionalState,
            goal,
            proteinPct,
            waterGoal,
            caloricDebt
        } = ctx;

        const {
            calculateAverageStress,
            calculateAverageWellbeing,
            calculateSleepHours,
            getProductForItem
        } = helpers;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ˜Š EMOTIONAL STATE TIPS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (emotionalState === 'crashed') {
            const isUnderEating = kcalPct < 0.7;
            const kcalDeficit = Math.round((1 - kcalPct) * (optimum || 2000));
            const currentPct = Math.round(kcalPct * 100);

            if (isUnderEating && hour >= 18) {
                advices.push({
                    id: 'undereating_warning',
                    icon: 'âš ï¸',
                    text: `Ğ¡ÑŠĞµĞ´ĞµĞ½Ğ¾ ${currentPct}% â€” Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ ~${kcalDeficit} ĞºĞºĞ°Ğ»`,
                    details: `ğŸ”¬ ĞĞ°ÑƒÑ‡Ğ½Ñ‹Ğ¹ Ñ„Ğ°ĞºÑ‚: Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ (>500 ĞºĞºĞ°Ğ») Ñ…ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ·Ğ´Ğ½ĞµĞ³Ğ¾ ÑƒĞ¶Ğ¸Ğ½Ğ°!\n\n` +
                        `â€¢ ĞœĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ÑÑ Ğ½Ğ° 10-15%\n` +
                        `â€¢ ĞŸĞ¾ÑĞ»Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶ĞµĞ½ Ğ±ĞµĞ»Ğ¾Ğº\n` +
                        `â€¢ Ğ Ğ¸ÑĞº: Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ Ğ¼Ñ‹ÑˆÑ†, Ğ²Ñ‹Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ»Ğ¾Ñ, Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ±Ğ¾Ğ¹\n\n` +
                        `ğŸ’¡ Ğ›ÑƒÑ‡ÑˆĞµ Ğ¿Ğ¾ĞµÑÑ‚ÑŒ Ğ´Ğ°Ğ¶Ğµ Ğ² 23:00: Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³ 200Ğ³ (~220 ĞºĞºĞ°Ğ», 36Ğ³ Ğ±ĞµĞ»ĞºĞ°), ÑĞ¹Ñ†Ğ° 3ÑˆÑ‚ (~240 ĞºĞºĞ°Ğ»), Ğ¾Ñ€ĞµÑ…Ğ¸ 50Ğ³ (~300 ĞºĞºĞ°Ğ»)`,
                    type: 'warning',
                    priority: 1,
                    category: 'nutrition',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 8000
                });
            } else {
                advices.push({
                    id: 'crash_support',
                    icon: 'ğŸ’™',
                    text: 'Ğ‘Ñ‹Ğ²Ğ°ĞµÑ‚! Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ. Ğ¢Ñ‹ ÑĞ¿Ñ€Ğ°Ğ²Ğ¸ÑˆÑŒÑÑ!',
                    details: 'ğŸ§¡ ĞĞ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾Ñ…Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ½Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°. Ğ”Ğ°Ğ¶Ğµ Ñƒ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ±Ñ‹Ğ²Ğ°ÑÑ‚ ÑÑ€Ñ‹Ğ²Ñ‹. Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ â€” Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ğ¿Ğ»Ğ°Ğ½Ñƒ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°.',
                    type: 'achievement',
                    priority: 1,
                    category: 'emotional',
                    triggers: ['tab_open', 'product_added'],
                    ttl: 6000
                });
            }
        }

        if (emotionalState === 'stressed') {
            advices.push({
                id: 'stress_support',
                icon: 'ğŸ¤—',
                text: 'Ğ¢Ñ‹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†, Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑˆÑŒ. Ğ­Ñ‚Ğ¾ ÑƒĞ¶Ğµ ÑƒÑĞ¿ĞµÑ…!',
                details: 'ğŸ’ª Ğ¡Ğ°Ğ¼ Ñ„Ğ°ĞºÑ‚ Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ´Ğ½ĞµĞ²Ğ½Ğ¸ĞºĞ° ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑˆĞ°Ğ½ÑÑ‹ Ğ½Ğ° ÑƒÑĞ¿ĞµÑ… Ğ² 2 Ñ€Ğ°Ğ·Ğ°. Ğ”Ğ°Ğ¶Ğµ Ğ² ÑÑ‚Ñ€ĞµÑÑĞµ Ñ‚Ñ‹ Ğ´ĞµĞ»Ğ°ĞµÑˆÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑˆĞ°Ğ³Ğ¸.',
                type: 'achievement',
                priority: 2,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ˜° EMOTIONAL RISK â€” ÑÑ‚Ñ€ĞµÑÑ + Ğ´Ğ¾Ğ»Ğ³
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const avgStress = day?.stressAvg || 0;
        const isHighStress = avgStress >= 6;
        const hasDebt = caloricDebt?.hasDebt;
        const emotionalRiskLevel = (isHighStress && hasDebt) ? 'high'
            : (isHighStress || hasDebt) ? 'medium'
                : 'low';

        if (emotionalRiskLevel === 'high' && hour >= 16) {
            advices.push({
                id: 'emotional_risk_high',
                icon: 'ğŸ§˜',
                text: 'Ğ¡Ñ‚Ñ€ĞµÑÑ + Ğ½ĞµĞ´Ğ¾ĞµĞ´Ğ°Ğ½Ğ¸Ğµ â€” Ñ€Ğ¸ÑĞº ÑÑ€Ñ‹Ğ²Ğ°! ĞœÑĞ³Ñ‡Ğµ Ğº ÑĞµĞ±Ğµ',
                details: 'ğŸ”¬ ĞŸÑ€Ğ¸ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ»Ğµ Ğ¼Ğ¾Ğ·Ğ³ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸. Ğ­Ñ‚Ğ¾ Ğ½Ğµ ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ â€” Ğ±Ğ¸Ğ¾Ñ…Ğ¸Ğ¼Ğ¸Ñ! Ğ›ÑƒÑ‡ÑˆĞµ ÑÑŠĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ, Ñ‡ĞµĞ¼ ÑĞ¾Ñ€Ğ²Ñ‘ÑˆÑŒÑÑ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼.',
                type: 'warning',
                priority: 18,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 7000
            });
        } else if (isHighStress && hour >= 18 && kcalPct < 0.8) {
            advices.push({
                id: 'stress_undereating_warning',
                icon: 'âš ï¸',
                text: 'Ğ¡Ñ‚Ñ€ĞµÑÑ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ â€” Ğ½Ğµ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ¹',
                details: 'ğŸ˜° ĞŸÑ€Ğ¸ ÑÑ‚Ñ€ĞµÑÑĞµ Ğ»ĞµĞ¿Ñ‚Ğ¸Ğ½ Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚, Ğ³Ñ€ĞµĞ»Ğ¸Ğ½ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚. ĞĞµĞ´Ğ¾ĞµĞ´Ğ°Ğ½Ğ¸Ğµ + ÑÑ‚Ñ€ĞµÑÑ = 90% ÑˆĞ°Ğ½Ñ ÑÑ€Ñ‹Ğ²Ğ° Ğ½Ğ¾Ñ‡ÑŒÑ. Ğ›ÑƒÑ‡ÑˆĞµ Ğ¿Ğ¾ĞµÑÑ‚ÑŒ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ.',
                type: 'warning',
                priority: 22,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ§  CORRELATION INSIGHTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const sleepHours = calculateSleepHours(day);
        const sleepNorm = ctx.prof?.sleepHours || 8;
        const sleepDeficit = sleepNorm - sleepHours;

        if (sleepDeficit > 2 && kcalPct > 1.15) {
            advices.push({
                id: 'sleep_hunger_correlation',
                icon: 'ğŸ§ ',
                text: `ĞĞµĞ´Ğ¾ÑÑ‹Ğ¿ ${sleepDeficit.toFixed(1)}Ñ‡ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚ â€” ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾`,
                details: 'ğŸ“Š ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‹Ğ¿Ğ° = +45 ĞºĞºĞ°Ğ» Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚Ğ°. Ğ­Ñ‚Ğ¾ Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ñ‹, Ğ½Ğµ ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ Ğ²Ğ¾Ğ»Ğ¸.',
                type: 'insight',
                priority: 20,
                category: 'correlation',
                triggers: ['product_added', 'tab_open'],
                ttl: 6000
            });
        }

        if (sleepDeficit > 1.5 && hour < 12 && kcalPct < 0.3) {
            advices.push({
                id: 'sleep_hunger_warning',
                icon: 'âš¡',
                text: 'ĞŸĞ¾ÑĞ»Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‹Ğ¿Ğ° Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚ Ğ²Ñ‹ÑˆĞµ â€” Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞ¹ ÑÑ‹Ñ‚Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ĞµĞ´',
                details: 'â˜• ĞŸĞ¾ÑĞ»Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‹Ğ¿Ğ° Ñ‚ÑĞ½ĞµÑ‚ Ğ½Ğ° ÑĞ»Ğ°Ğ´ĞºĞ¾Ğµ. Ğ—Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞ¹ Ğ±ĞµĞ»ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ĞµĞ´ Ğ·Ğ°Ñ€Ğ°Ğ½ĞµĞµ.',
                type: 'tip',
                priority: 25,
                category: 'correlation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const avgStressForPattern = calculateAverageStress(day);
        const simplePctCorr = (dayTot?.simple || 0) / ((normAbs?.simple || 50) || 1);

        if (avgStressForPattern >= 4 && simplePctCorr > 1.2) {
            advices.push({
                id: 'stress_sweet_pattern',
                icon: 'ğŸ’¡',
                text: 'Ğ¡Ñ‚Ñ€ĞµÑÑ â†’ ÑĞ»Ğ°Ğ´ĞºĞ¾Ğµ â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¾Ñ€ĞµÑ…Ğ¸ Ğ¸Ğ»Ğ¸ Ñ‚Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´',
                details: 'ğŸ« Ğ¡Ñ‚Ñ€ĞµÑÑ â†’ ĞºĞ¾Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ» â†’ Ñ‚ÑĞ³Ğ° Ğº ÑĞ»Ğ°Ğ´ĞºĞ¾Ğ¼Ñƒ. ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°: Ñ‚Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´ 70%+, Ğ¾Ñ€ĞµÑ…Ğ¸, Ğ±Ğ°Ğ½Ğ°Ğ½.',
                type: 'insight',
                priority: 22,
                category: 'correlation',
                triggers: ['product_added'],
                ttl: 6000
            });
        }

        if (avgStressForPattern > 0 && avgStressForPattern <= 2 && kcalPct >= 0.9 && kcalPct <= 1.1) {
            advices.push({
                id: 'low_stress_balance',
                icon: 'â˜®ï¸',
                text: 'Ğ¡Ğ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ = Ğ»ĞµĞ³Ñ‡Ğµ Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ. Ğ—Ğ°Ğ¼ĞµÑ‡Ğ°ĞµÑˆÑŒ?',
                details: 'ğŸ§˜ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ ÑÑ‚Ñ€ĞµÑÑ = Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹ ĞºĞ¾Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ» = Ğ¼ĞµĞ½ÑŒÑˆĞµ Ñ‚ÑĞ³Ğ¸ Ğº ĞµĞ´Ğµ. Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ ÑÑ‚Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ!',
                type: 'insight',
                priority: 40,
                category: 'correlation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (avgStressForPattern >= 4 && kcalPct > 1.15) {
            advices.push({
                id: 'stress_eating_detected',
                icon: 'ğŸš¶',
                text: 'Ğ¡Ñ‚Ñ€ĞµÑÑ â†’ Ğ¿ĞµÑ€ĞµĞºÑƒÑ? ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ñ€Ğ¾Ğ³ÑƒĞ»ĞºÑƒ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ ĞµĞ´Ñ‹',
                details: 'ğŸ§  Ğ¡Ñ‚Ñ€ĞµÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¿ĞµÑ€ĞµĞµĞ´Ğ°Ğ½Ğ¸Ğµ â€” ÑÑ‚Ğ¾ ĞºĞ¾Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ». 10-Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³ÑƒĞ»ĞºĞ° ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ ĞµĞ³Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµ, Ñ‡ĞµĞ¼ ĞµĞ´Ğ°.',
                type: 'tip',
                priority: 96,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ­ EMOTIONAL INTELLIGENCE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const mealsWithMood = (day?.meals || []).filter(m => m.mood > 0 && m.items?.length > 0);
        if (mealsWithMood.length >= 2) {
            const moodDropMeal = mealsWithMood.find((m, i) => {
                if (i === 0) return false;
                return m.mood < mealsWithMood[i - 1].mood - 1;
            });

            if (moodDropMeal) {
                const prevMealIdx = mealsWithMood.indexOf(moodDropMeal) - 1;
                const prevMeal = mealsWithMood[prevMealIdx];

                let prevSimple = 0;
                for (const item of prevMeal.items || []) {
                    const product = getProductForItem(item, ctx.pIndex);
                    if (product) prevSimple += (product.simple100 || 0) * (item.grams || 100) / 100;
                }

                if (prevSimple > 30) {
                    advices.push({
                        id: 'sugar_mood_crash',
                        icon: 'ğŸ¢',
                        text: 'Ğ—Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ»? ĞŸĞ¾ÑĞ»Ğµ ÑĞ»Ğ°Ğ´ĞºĞ¾Ğ³Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ',
                        details: 'ğŸ“‰ Ğ­Ñ‚Ğ¾ "ÑĞ°Ñ…Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ³Ğ¾Ñ€ĞºĞ¸": Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑĞºĞ°Ñ‡Ğ¾Ğº Ğ³Ğ»ÑĞºĞ¾Ğ·Ñ‹ â†’ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½ â†’ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸. Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ´Ğ°ÑÑ‚ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½ÑƒÑ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ.',
                        type: 'insight',
                        priority: 24,
                        category: 'emotional',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                }
            }
        }

        const avgWellbeing = calculateAverageWellbeing(day);

        if (avgWellbeing > 0 && avgWellbeing < 3 && kcalPct < 0.4 && hour >= 12) {
            advices.push({
                id: 'wellbeing_low_food',
                icon: 'ğŸ½ï¸',
                text: 'Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ°Ğ¼Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ ĞµĞ´Ñ‹',
                details: 'ğŸ§  ĞœĞ¾Ğ·Ğ³Ñƒ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ³Ğ»ÑĞºĞ¾Ğ·Ğ°! ĞĞ¸Ğ·ĞºĞ¸Ğ¹ ÑĞ°Ñ…Ğ°Ñ€ Ğ² ĞºÑ€Ğ¾Ğ²Ğ¸ = ÑƒÑÑ‚Ğ°Ğ»Ğ¾ÑÑ‚ÑŒ, Ñ€Ğ°Ğ·Ğ´Ñ€Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ, ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ. ĞŸĞ¾ĞµÑˆÑŒ â€” ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ»ĞµĞ³Ñ‡Ğµ.',
                type: 'tip',
                priority: 29,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (avgWellbeing >= 4 && kcalPct >= 0.8 && kcalPct <= 1.1) {
            advices.push({
                id: 'wellbeing_nutrition_link',
                icon: 'âœ¨',
                text: 'Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ ÑĞ°Ğ¼Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ğµ + Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ â€” Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ!',
                details: 'ğŸ“ Ğ—Ğ°Ğ¿Ğ¸ÑˆĞ¸, Ñ‡Ñ‚Ğ¾ ĞµĞ» ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ! ĞšĞ¾Ğ³Ğ´Ğ° Ğ½Ğ°Ğ¹Ğ´Ñ‘ÑˆÑŒ ÑĞ²Ğ¾Ğ¹ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½ â€” Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞ¹ ĞµĞ³Ğ¾.',
                type: 'insight',
                priority: 45,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const dayScore = day?.dayScore ? +day.dayScore : 0;
        if (dayScore > 0 && dayScore < 5 && hour >= 20) {
            advices.push({
                id: 'day_score_low',
                icon: 'ğŸ’™',
                text: 'ĞĞµ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ? Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞµ!',
                details: 'ğŸ§¡ ĞŸĞ»Ğ¾Ñ…Ğ¸Ğµ Ğ´Ğ½Ğ¸ Ğ±Ñ‹Ğ²Ğ°ÑÑ‚ Ñƒ Ğ²ÑĞµÑ…. Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ½Ğµ ÑĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒÑÑ. Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ ÑĞ¾Ğ½ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ â€” Ğ¸ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞµ.',
                type: 'tip',
                priority: 27,
                category: 'emotional',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (dayScore >= 8 && hour >= 20) {
            advices.push({
                id: 'day_score_high',
                icon: 'â­',
                text: 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ° Ğ´Ğ½Ñ! Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ğµ',
                details: 'ğŸ† Ğ”Ğ½Ğ¸ Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¹ Ğ¾Ñ†ĞµĞ½ĞºĞ¾Ğ¹ â€” ÑÑ‚Ğ°Ğ»Ğ¾Ğ½ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ°Ğ¶Ğ°Ğ½Ğ¸Ñ. Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°Ğ» ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ? ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°!',
                type: 'achievement',
                priority: 8,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const mealsWithMoodData = (day?.meals || []).filter(m => m.mood > 0 && m.items?.length > 0);
        if (mealsWithMoodData.length >= 2 && !sessionStorage.getItem('heys_mood_improving')) {
            const prevMealMood = mealsWithMoodData[mealsWithMoodData.length - 2]?.mood || 0;
            const currentMealMood = mealsWithMoodData[mealsWithMoodData.length - 1]?.mood || 0;

            if (prevMealMood > 0 && currentMealMood > prevMealMood) {
                advices.push({
                    id: 'mood_improving',
                    icon: 'ğŸ“ˆ',
                    text: 'ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾ÑĞ»Ğµ ĞµĞ´Ñ‹ â€” Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½!',
                    details: 'ğŸ§  Ğ•Ğ´Ğ° Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ¾Ñ‚Ğ¾Ğ½Ğ¸Ğ½ Ğ¸ Ğ´Ğ¾Ñ„Ğ°Ğ¼Ğ¸Ğ½. Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ¹ ÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ñ‡ĞµÑ‚Ğ°Ğ½Ğ¸Ñ!',
                    type: 'insight',
                    priority: 45,
                    category: 'correlation',
                    triggers: ['product_added'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_mood_improving', '1'); } catch (e) { } }
                });
            }
        }

        return advices;
    };

})();
// ===== End advice/_emotional.js =====

// ===== Begin advice/_hydration.js =====
;/**
 * HEYS Advice Module v1 â€” Hydration
 * @file advice/_hydration.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.hydration = function buildHydrationAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { THRESHOLDS } = rules;

        const { day, waterGoal, hour } = ctx;
        const waterMl = day?.waterMl || 0;
        const waterPct = waterGoal > 0 ? waterMl / waterGoal : 0;

        const hoursSinceWater = helpers.getHoursSinceWater(day);

        if (hour >= 18 && waterPct < 0.5 && waterGoal > 0) {
            advices.push({
                id: 'water_evening_low',
                icon: 'ğŸ’§',
                text: 'Ğ’Ğ¾Ğ´Ğ° Ğ¾Ñ‚ÑÑ‚Ğ°Ñ‘Ñ‚ â€” Ğ²Ñ‹Ğ¿ĞµĞ¹ ÑÑ‚Ğ°ĞºĞ°Ğ½ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ',
                details: 'ğŸ’§ Ğ’ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ Ğ½ĞµÑ…Ğ²Ğ°Ñ‚ĞºĞ° Ğ²Ğ¾Ğ´Ñ‹ Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ¼Ğ°ÑĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´ Ğ³Ğ¾Ğ»Ğ¾Ğ´. 1-2 ÑÑ‚Ğ°ĞºĞ°Ğ½Ğ° Ğ²Ğ¾Ğ´Ñ‹ ÑƒĞ»ÑƒÑ‡ÑˆĞ°Ñ‚ ÑĞ°Ğ¼Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸ ÑĞ¾Ğ½.',
                type: 'tip',
                priority: 36,
                category: 'hydration',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hoursSinceWater >= 2 && hour >= 10 && hour <= 21) {
            advices.push({
                id: 'water_reminder',
                icon: 'ğŸš°',
                text: 'ĞŸĞ¾Ñ€Ğ° Ğ¿Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ´Ñƒ â€” Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 2 Ñ‡Ğ°ÑĞ¾Ğ²',
                details: 'ğŸ’§ Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ°Ñ Ğ²Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ½Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ñ†Ğ¸Ñ, ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚ Ğ¸ ÑƒĞ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ Ğ¿Ğ¸Ñ‰ĞµĞ²Ğ°Ñ€ĞµĞ½Ğ¸Ğµ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ²Ñ‹Ğ¿Ğ¸Ñ‚ÑŒ 1 ÑÑ‚Ğ°ĞºĞ°Ğ½.',
                type: 'tip',
                priority: 34,
                category: 'hydration',
                triggers: ['tab_open', 'product_added'],
                ttl: 4000
            });
        }

        if (waterPct >= 1.0 && waterGoal > 0) {
            advices.push({
                id: 'water_goal_reached',
                icon: 'ğŸ’§',
                text: 'ĞĞ¾Ñ€Ğ¼Ğ° Ğ²Ğ¾Ğ´Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°! ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾ ğŸ’™',
                details: 'âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ³Ğ¸Ğ´Ñ€Ğ°Ñ‚Ğ°Ñ†Ğ¸Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞ°ĞµÑ‚ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ, ĞºĞ¾Ğ¶Ñƒ Ğ¸ Ğ¿Ğ¸Ñ‰ĞµĞ²Ğ°Ñ€ĞµĞ½Ğ¸Ğµ.',
                type: 'achievement',
                priority: 36,
                category: 'hydration',
                triggers: ['tab_open', 'product_added'],
                ttl: 4000
            });
        }

        if (waterMl >= 2500) {
            advices.push({
                id: 'super_hydration',
                icon: 'ğŸŒŠ',
                text: 'Ğ¡ÑƒĞ¿ĞµÑ€-Ğ³Ğ¸Ğ´Ñ€Ğ°Ñ‚Ğ°Ñ†Ğ¸Ñ â€” Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 2.5Ğ»!',
                details: 'ğŸŒŠ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹. ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ½Ğ° Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼!',
                type: 'achievement',
                priority: 39,
                category: 'hydration',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        return advices;
    };

})();
// ===== End advice/_hydration.js =====

// ===== Begin advice/_other.js =====
;/**
 * HEYS Advice Module v1 â€” Other (motivation, lifestyle, achievements, supplements, patterns)
 * @file advice/_other.js
 */

(function () {
    'use strict';

    window.HEYS = window.HEYS || {};
    window.HEYS.adviceModules = window.HEYS.adviceModules || {};

    window.HEYS.adviceModules.other = function buildOtherAdvices(ctx, helpers) {
        const advices = [];
        const { rules } = helpers;
        const { SEASONAL_TIPS } = rules;

        const {
            dayTot,
            normAbs,
            optimum,
            displayOptimum,
            caloricDebt,
            day,
            pIndex,
            currentStreak,
            hour,
            mealCount,
            hasTraining,
            kcalPct,
            specialDay,
            prof,
            waterGoal,
            goal,
            proteinPct
        } = ctx;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ’Š Morning supplements reminder
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const supplementsAdviceShown = sessionStorage.getItem('heys_morning_supplements_advice_shown');
        const plannedSupplements = day?.supplementsPlanned || prof?.plannedSupplements || [];
        const takenSupplements = day?.supplementsTaken || [];
        const hasPendingSupplements = plannedSupplements.length > 0 &&
            plannedSupplements.some(id => !takenSupplements.includes(id));

        if (hour >= 6 && hour <= 12 && hasPendingSupplements && !supplementsAdviceShown) {
            if (window.HEYS?.Supplements?.generateMorningSupplementAdvice) {
                const supplementAdvice = window.HEYS.Supplements.generateMorningSupplementAdvice(
                    plannedSupplements.filter(id => !takenSupplements.includes(id)),
                    { mealCount, hasEaten: mealCount > 0, profile: prof }
                );

                if (supplementAdvice) {
                    advices.push({
                        ...supplementAdvice,
                        priority: 0,
                        category: 'health',
                        isReminder: true,
                        onShow: () => {
                            try { sessionStorage.setItem('heys_morning_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            } else {
                const pendingSupps = plannedSupplements.filter(id => !takenSupplements.includes(id));
                const suppNames = pendingSupps
                    .map(id => window.HEYS?.Supplements?.CATALOG?.[id]?.name || id)
                    .slice(0, 3)
                    .join(', ');

                advices.push({
                    id: 'morning_supplements_reminder',
                    icon: 'ğŸ’Š',
                    text: `Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ğ¾Ğ²: ${suppNames}${pendingSupps.length > 3 ? ` Ğ¸ ĞµÑ‰Ñ‘ ${pendingSupps.length - 3}` : ''}`,
                    details: 'Ğ£Ñ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ñ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ¾Ğ¼ Ğ´Ğ»Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ñ. ĞÑ‚Ğ¼ĞµÑ‚ÑŒ Ğ¸Ñ… Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ğ¾Ğ²!',
                    type: 'health',
                    priority: 0,
                    category: 'health',
                    isReminder: true,
                    triggers: ['tab_open', 'checkin_complete'],
                    ttl: 8000,
                    onShow: () => {
                        try { sessionStorage.setItem('heys_morning_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                    }
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸŒ™ Evening supplements reminder
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const eveningSupplementsAdviceShown = sessionStorage.getItem('heys_evening_supplements_advice_shown');
        const eveningTimings = ['evening', 'beforeBed'];
        const eveningSupps = plannedSupplements.filter(id => {
            if (takenSupplements.includes(id)) return false;
            const info = window.HEYS?.Supplements?.SCIENCE?.MORNING_SUPPLEMENT_SCIENCE?.[id];
            return info && eveningTimings.includes(info.timing);
        });

        if (hour >= 18 && hour <= 23 && eveningSupps.length > 0 && !eveningSupplementsAdviceShown) {
            if (window.HEYS?.Supplements?.generateEveningSupplementAdvice) {
                const eveningAdvice = window.HEYS.Supplements.generateEveningSupplementAdvice(
                    plannedSupplements.filter(id => !takenSupplements.includes(id)),
                    { mealCount, hasEaten: mealCount > 0, profile: prof }
                );

                if (eveningAdvice) {
                    advices.push({
                        ...eveningAdvice,
                        priority: 0,
                        category: 'health',
                        isReminder: true,
                        onShow: () => {
                            try { sessionStorage.setItem('heys_evening_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            } else {
                const suppNames = eveningSupps
                    .map(id => window.HEYS?.Supplements?.CATALOG?.[id]?.name || id)
                    .slice(0, 3)
                    .join(', ');

                advices.push({
                    id: 'evening_supplements_reminder',
                    icon: 'ğŸŒ™',
                    text: `Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹: ${suppNames}${eveningSupps.length > 3 ? ` Ğ¸ ĞµÑ‰Ñ‘ ${eveningSupps.length - 3}` : ''}`,
                    details: 'ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ²ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹! ĞœĞ°Ğ³Ğ½Ğ¸Ğ¹ Ğ¸ Ğ¼ĞµĞ»Ğ°Ñ‚Ğ¾Ğ½Ğ¸Ğ½ Ğ»ÑƒÑ‡ÑˆĞµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ½Ğ¾Ğ¼. ĞÑ‚Ğ¼ĞµÑ‚ÑŒ Ğ¸Ñ… Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ğ¾Ğ²!',
                    type: 'health',
                    priority: 0,
                    category: 'health',
                    isReminder: true,
                    triggers: ['product_added'],
                    ttl: 8000,
                    onShow: () => {
                        try { sessionStorage.setItem('heys_evening_supplements_advice_shown', Date.now().toString()); } catch (e) { }
                    }
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¯ Special day tips
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (specialDay === 'monday_morning') {
            advices.push({
                id: 'monday_motivation',
                icon: 'ğŸ’ª',
                text: helpers.personalizeText(helpers.pickRandomText([
                    'ĞĞ¾Ğ²Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ â€” Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸!',
                    '${firstName}, Ğ½Ğ¾Ğ²Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ â€” Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚!',
                    'ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº â€” Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚ Ğ´Ğ»Ñ Ñ†ĞµĞ»ĞµĞ¹!'
                ]), ctx),
                details: 'Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚: Ğ»ÑĞ´Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€ÑƒÑÑ‚ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº, Ğ½Ğ° 30% ÑƒÑĞ¿ĞµÑˆĞ½ĞµĞµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ°ÑÑ‚ Ñ†ĞµĞ»ĞµĞ¹. Ğ—Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ!',
                type: 'tip',
                priority: 5,
                category: 'motivation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (specialDay === 'friday_evening') {
            advices.push({
                id: 'friday_reminder',
                icon: 'ğŸ¯',
                text: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ â€” Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ Ğ¾ ÑĞ²Ğ¾Ğ¸Ñ… Ñ†ĞµĞ»ÑÑ…!',
                details: 'Ğ’ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ»ĞµĞ³ĞºĞ¾ Ğ¿ĞµÑ€ĞµĞµÑÑ‚ÑŒ Ğ½Ğ° 500-1000 ĞºĞºĞ°Ğ». Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑŒ ÑĞµĞ±Ğµ 1 "ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğ¹" Ğ¿Ñ€Ğ¸Ñ‘Ğ¼, Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ.',
                type: 'tip',
                priority: 10,
                category: 'motivation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (specialDay === 'sunday_evening') {
            advices.push({
                id: 'sunday_planning',
                icon: 'ğŸ“‹',
                text: 'Ğ¡Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞ¹ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ',
                details: 'Meal prep Ğ² Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ 3-5 Ñ‡Ğ°ÑĞ¾Ğ² Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ. ĞŸÑ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²ÑŒ Ğ±Ğ°Ğ·Ñƒ: ĞºÑ€ÑƒĞ¿Ñ‹, Ğ¼ÑÑĞ¾, Ğ¾Ğ²Ğ¾Ñ‰Ğ¸ â€” ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€ÑƒĞ¹ Ğ² Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ±Ğ»ÑĞ´Ğ°.',
                type: 'tip',
                priority: 10,
                category: 'motivation',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const today = new Date();
        const dayOfMonth = today.getDate();
        const monthOfYear = today.getMonth();
        const postHolidayDates = [
            [1, 0], [2, 0],
            [24, 1],
            [9, 2],
            [10, 4],
            [13, 5]
        ];
        const isPostHoliday = postHolidayDates.some(([d, m]) => d === dayOfMonth && m === monthOfYear);

        if (isPostHoliday && !sessionStorage.getItem('heys_post_holiday')) {
            advices.push({
                id: 'post_holiday_detox',
                icon: 'ğŸŒ¿',
                text: 'ĞŸĞ¾ÑĞ»Ğµ Ğ²Ñ‡ĞµÑ€Ğ°ÑˆĞ½ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ° â€” Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ: Ğ¾Ğ²Ğ¾Ñ‰Ğ¸, Ğ²Ğ¾Ğ´Ğ°, Ğ±ĞµĞ»Ğ¾Ğº',
                details: 'ĞĞµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ñ‚ÑŒ! ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ»Ñ‘Ğ³ĞºÑƒÑ ĞµĞ´Ñƒ: ÑĞ°Ğ»Ğ°Ñ‚Ñ‹, Ñ€Ñ‹Ğ±Ğ° Ğ½Ğ° Ğ¿Ğ°Ñ€Ñƒ, Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ğ´Ñ‹. ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ ÑĞ°Ğ¼ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ·Ğ° 1-2 Ğ´Ğ½Ñ.',
                type: 'tip',
                priority: 15,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 6000,
                onShow: () => { try { sessionStorage.setItem('heys_post_holiday', '1'); } catch (e) { } }
            });
        }

        // Best day recall
        const lastBestDayCheck = localStorage.getItem('heys_best_day_last_check');
        const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

        if (!lastBestDayCheck || +lastBestDayCheck < weekAgo) {
            const recentDays = helpers.getRecentDays(7);

            if (recentDays.length >= 3) {
                let bestDay = null;
                let bestDiff = Infinity;

                for (const d of recentDays) {
                    const dayMeals = d.meals || [];
                    let dayKcal = 0;
                    for (const meal of dayMeals) {
                        for (const item of (meal.items || [])) {
                            const product = helpers.getProductForItem(item, pIndex);
                            if (product) dayKcal += (product.kcal100 || 0) * (item.grams || 100) / 100;
                        }
                    }

                    const ratio = dayKcal / (optimum || 2000);
                    const diff = Math.abs(ratio - 1.0);

                    if (diff < bestDiff && ratio > 0.5) {
                        bestDiff = diff;
                        bestDay = { ...d, ratio };
                    }
                }

                if (bestDay && bestDiff < 0.15) {
                    const dayDate = new Date(bestDay.date);
                    const dayNames = ['Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ', 'Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº', 'Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº', 'ÑÑ€ĞµĞ´Ğ°', 'Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³', 'Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°', 'ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°'];
                    const dayName = dayNames[dayDate.getDay()];
                    const pct = Math.round(bestDay.ratio * 100);

                    advices.push({
                        id: 'best_day_recall',
                        icon: 'â­',
                        text: `Ğ¢Ğ²Ğ¾Ğ¹ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ±Ñ‹Ğ» ${dayName} â€” ${pct}% Ğ½Ğ¾Ñ€Ğ¼Ñ‹. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸!`,
                        details: 'ğŸ’¡ Ğ’ÑĞ¿Ğ¾Ğ¼Ğ½Ğ¸, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ĞµĞ» Ğ² Ñ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ. Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑ‚ÑŒ!',
                        type: 'motivation',
                        priority: 44,
                        category: 'motivation',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => {
                            try { localStorage.setItem('heys_best_day_last_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ† Achievements & streaks
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (currentStreak >= 7 && !sessionStorage.getItem('heys_streak7')) {
            advices.push({
                id: 'streak_7',
                icon: 'ğŸ†',
                text: helpers.personalizeText(helpers.pickRandomText([
                    `ĞĞµĞ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾! ${currentStreak} Ğ´Ğ½ĞµĞ¹ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ!`,
                    '${firstName}, Ñ‚Ñ‹ Ğ»ĞµĞ³ĞµĞ½Ğ´Ğ°! ' + currentStreak + ' Ğ´Ğ½ĞµĞ¹ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´!',
                    `ğŸ”¥ ${currentStreak} Ğ´Ğ½ĞµĞ¹ streak! Ğ¢Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!`
                ]), ctx),
                details: 'ğŸŒŸ Ğ­Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ÑƒĞ¶Ğµ ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºÑƒ! Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚: 21 Ğ´ĞµĞ½ÑŒ â€” Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼.',
                type: 'achievement',
                priority: 1,
                category: 'achievement',
                score: 1.0,
                triggers: ['tab_open'],
                ttl: 7000,
                showConfetti: true,
                canSkipCooldown: true,
                excludes: ['streak_3'],
                onShow: () => { try { sessionStorage.setItem('heys_streak7', '1'); } catch (e) { } }
            });
        }

        if (currentStreak >= 3 && currentStreak < 7 && !sessionStorage.getItem('heys_streak3')) {
            advices.push({
                id: 'streak_3',
                icon: 'ğŸ”¥',
                text: `${currentStreak} Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ! Ğ¢Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!`,
                details: 'ğŸ’ª Ğ¢Ñ‹ Ğ½Ğ° Ğ¿ÑƒÑ‚Ğ¸ Ğº Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºĞµ! Ğ•Ñ‰Ñ‘ 4 Ğ´Ğ½Ñ â€” Ğ¸ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ streak. ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ â€” ÑÑ‚Ğ¾ Ğ¸Ğ½Ğ²ĞµÑÑ‚Ğ¸Ñ†Ğ¸Ñ Ğ² Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ.',
                type: 'achievement',
                priority: 2,
                category: 'achievement',
                score: 0.9,
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_streak3', '1'); } catch (e) { } }
            });
        }

        if (hour >= 18 && helpers.isInTargetRange(kcalPct, goal) &&
            proteinPct >= 0.9 && ctx.fatPct >= 0.9 && ctx.carbsPct >= 0.9) {
            advices.push({
                id: 'perfect_day',
                icon: 'â­',
                text: goal.mode === 'bulk'
                    ? 'Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ°! ğŸ’ªğŸ‰'
                    : goal.mode === 'deficit'
                        ? 'Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ¼ Ğ‘Ğ–Ğ£! ğŸ”¥ğŸ‰'
                        : 'Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ! ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° ğŸ‰',
                details: 'ğŸŒŸ ĞšĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸, Ğ±ĞµĞ»ĞºĞ¸, Ğ¶Ğ¸Ñ€Ñ‹ Ğ¸ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ â€” Ğ²ÑÑ‘ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ. Ğ¢Ğ°ĞºĞ¸Ğµ Ğ´Ğ½Ğ¸ Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ¶Ğ°ÑÑ‚ Ñ‚ĞµĞ±Ñ Ğº Ñ†ĞµĞ»Ğ¸. Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸, Ñ‡Ñ‚Ğ¾ ĞµĞ» ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ!',
                type: 'achievement',
                priority: 5,
                category: 'achievement',
                score: 1.0,
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (mealCount === 1 && !localStorage.getItem('heys_first_meal_tip')) {
            advices.push({
                id: 'first_day',
                icon: 'ğŸ‘‹',
                text: 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾! Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ğ¹ Ğ²ÑÑ‘ â€” ÑÑ‚Ğ¾ ĞºĞ»ÑÑ‡ Ğº ÑƒÑĞ¿ĞµÑ…Ñƒ',
                details: 'ğŸ“Š Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: Ğ»ÑĞ´Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‚ ĞµĞ´Ñƒ, Ñ…ÑƒĞ´ĞµÑÑ‚ Ğ² 2 Ñ€Ğ°Ğ·Ğ° ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½ĞµĞµ. Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ğ¹ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ ĞµĞ´Ñ‹ â€” Ñ‚Ğ°Ğº Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ.',
                type: 'achievement',
                priority: 3,
                category: 'achievement',
                score: 1.0,
                triggers: ['product_added'],
                ttl: 5000,
                onShow: () => { try { localStorage.setItem('heys_first_meal_tip', '1'); } catch (e) { } }
            });
        }

        if (proteinPct >= rules.THRESHOLDS.protein.champion && !sessionStorage.getItem('heys_protein_champion')) {
            advices.push({
                id: 'protein_champion',
                icon: 'ğŸ†',
                text: helpers.personalizeText(helpers.pickRandomText([
                    'Ğ‘ĞµĞ»ĞºĞ¾Ğ²Ñ‹Ğ¹ Ñ‡ĞµĞ¼Ğ¿Ğ¸Ğ¾Ğ½! ĞœÑ‹ÑˆÑ†Ñ‹ Ñ‚ĞµĞ±Ñ Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€ÑÑ‚',
                    '${firstName}, Ñ‚Ñ‹ Ğ±ĞµĞ»ĞºĞ¾Ğ²Ñ‹Ğ¹ Ñ‡ĞµĞ¼Ğ¿Ğ¸Ğ¾Ğ½! ğŸ†',
                    'Ğ‘ĞµĞ»ĞºĞ° Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ¾Ñ€Ğ¼Ñ‹ â€” Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ñ€Ğ°Ğ´Ñ‹!'
                ]), ctx),
                details: 'ğŸ’ª Ğ‘ĞµĞ»Ğ¾Ğº 1.5-2Ğ³/ĞºĞ³ â€” Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ€Ğ¾ÑÑ‚Ğ° Ğ¼Ñ‹ÑˆÑ† Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ. ĞŸĞµÑ€ĞµĞ¸Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ğº Ğ±ĞµĞ»ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞµĞ½ Ğ´Ğ»Ñ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²Ñ‹Ñ… Ğ»ÑĞ´ĞµĞ¹.',
                type: 'achievement',
                priority: 10,
                category: 'achievement',
                triggers: ['tab_open', 'product_added'],
                ttl: 5000,
                excludes: ['protein_low', 'post_training_protein'],
                onShow: () => { try { sessionStorage.setItem('heys_protein_champion', '1'); } catch (e) { } }
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸŒ Lifestyle tips
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const sleepHours = helpers.calculateSleepHours(day);
        if (sleepHours > 0 && sleepHours < 6) {
            advices.push({
                id: 'sleep_low',
                icon: 'ğŸ˜´',
                text: 'ĞœĞ°Ğ»Ğ¾ ÑĞ½Ğ° â€” Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½',
                details: 'ğŸ’¤ ĞĞµĞ´Ğ¾ÑÑ‹Ğ¿ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ³Ñ€ĞµĞ»Ğ¸Ğ½ (Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°) Ğ¸ ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ»ĞµĞ¿Ñ‚Ğ¸Ğ½ (ÑÑ‹Ñ‚Ğ¾ÑÑ‚ÑŒ). Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ñ…Ğ¾Ñ‚ĞµÑ‚ÑŒÑÑ ĞµÑÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ â€” ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾.',
                type: 'tip',
                priority: 51,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hour >= 7 && hour < 10 && mealCount === 0) {
            advices.push({
                id: 'morning_breakfast',
                icon: 'â˜€ï¸',
                text: 'Ğ”Ğ¾Ğ±Ñ€Ğ¾Ğµ ÑƒÑ‚Ñ€Ğ¾! ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒ Ğ¿Ğ¾Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ°Ñ‚ÑŒ',
                details: 'ğŸ³ Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ¸ Ğ´Ğ°Ñ‘Ñ‚ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ. Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾: Ğ±ĞµĞ»Ğ¾Ğº + ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ (ÑĞ¹Ñ†Ğ° + Ğ¾Ğ²ÑÑĞ½ĞºĞ°, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³ + Ñ„Ñ€ÑƒĞºÑ‚Ñ‹).',
                type: 'tip',
                priority: 52,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hour >= 10 && hour < 12 && mealCount === 0 && !sessionStorage.getItem('heys_morning_breakfast_shown')) {
            advices.push({
                id: 'empty_stomach_late',
                icon: 'ğŸ³',
                text: `Ğ£Ğ¶Ğµ ${hour}:00, Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ° Ğ½ĞµÑ‚ â€” Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼ Ğ¶Ğ´Ñ‘Ñ‚ Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ°`,
                details: 'âš ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞº Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº Ğ¿ĞµÑ€ĞµĞµĞ´Ğ°Ğ½Ğ¸Ñ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ³Ğ¾Ğ»Ğ¾Ğ´ĞµĞ½ â€” Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞºÑƒÑ.',
                type: 'tip',
                priority: 53,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_morning_breakfast_shown', '1'); } catch (e) { } }
            });
        }

        if (hour === 13 && mealCount === 1) {
            advices.push({
                id: 'lunch_time',
                icon: 'ğŸ½ï¸',
                text: 'Ğ§Ğ°Ñ Ğ´Ğ½Ñ â€” Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ¾Ğ±ĞµĞ´Ğ°!',
                details: 'ğŸŒ ĞĞ±ĞµĞ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ°Ğ¼Ñ‹Ğ¼ Ğ¿Ğ»Ğ¾Ñ‚Ğ½Ñ‹Ğ¼ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼Ğ¾Ğ¼ Ğ´Ğ½Ñ (35-40% ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹). Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾: Ğ±ĞµĞ»Ğ¾Ğº + ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ + Ğ¾Ğ²Ğ¾Ñ‰Ğ¸.',
                type: 'tip',
                priority: 52,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (hour === 16 && kcalPct < 0.6) {
            const remaining = Math.round((optimum || 2000) * (1 - kcalPct));
            advices.push({
                id: 'snack_window',
                icon: 'ğŸ¥ª',
                text: `16:00 â€” Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾Ğ»Ğ´Ğ½Ğ¸ĞºĞ°. ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ~${remaining} ĞºĞºĞ°Ğ»`,
                details: 'ğŸ ĞŸĞ¾Ğ»Ğ´Ğ½Ğ¸Ğº Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞµÑÑ‚ÑŒ Ğ·Ğ° ÑƒĞ¶Ğ¸Ğ½Ğ¾Ğ¼. Ğ˜Ğ´ĞµĞ¸: Ğ¾Ñ€ĞµÑ…Ğ¸, ÑĞ±Ğ»Ğ¾ĞºĞ¾, Ğ³Ñ€ĞµÑ‡ĞµÑĞºĞ¸Ğ¹ Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚, Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³.',
                type: 'tip',
                priority: 51,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const steps = day?.steps || 0;
        if (steps >= 10000) {
            advices.push({
                id: 'steps_goal',
                icon: 'ğŸš¶',
                text: `${steps.toLocaleString()} ÑˆĞ°Ğ³Ğ¾Ğ²! ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ`,
                details: 'ğŸ¯ 10 000 ÑˆĞ°Ğ³Ğ¾Ğ² ÑĞ¶Ğ¸Ğ³Ğ°ÑÑ‚ ~400-500 ĞºĞºĞ°Ğ» Ğ¸ ÑƒĞ»ÑƒÑ‡ÑˆĞ°ÑÑ‚ ÑĞµÑ€Ğ´ĞµÑ‡Ğ½Ğ¾-ÑĞ¾ÑÑƒĞ´Ğ¸ÑÑ‚ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ. Ğ­Ñ‚Ğ¾ Ñ‚Ğ²Ğ¾Ğ¹ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ!',
                type: 'achievement',
                priority: 53,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const isWeekend = [0, 6].includes(new Date().getDay());
        if (isWeekend && kcalPct > goal.targetRange.max && !helpers.isCriticallyOver(kcalPct, goal) && goal.mode !== 'bulk') {
            advices.push({
                id: 'weekend_relax',
                icon: 'ğŸ›‹ï¸',
                text: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ€Ğ°ÑÑĞ»Ğ°Ğ±Ğ»ÑĞµÑˆÑŒÑÑ â€” ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾',
                details: 'ğŸ‰ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€ Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ â€” ÑÑ‚Ğ¾ ĞĞš! Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ â€” ÑÑ€ĞµĞ´Ğ½ÑÑ Ğ·Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ. ĞĞ°ÑĞ»Ğ°Ğ¶Ğ´Ğ°Ğ¹ÑÑ Ğ±ĞµĞ· Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ° Ğ²Ğ¸Ğ½Ñ‹.',
                type: 'tip',
                priority: 86,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // â„ï¸ Seasonal tips
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const month = new Date().getMonth();
        for (const seasonal of SEASONAL_TIPS) {
            if (seasonal.months.includes(month) && !sessionStorage.getItem('heys_seasonal_' + seasonal.id)) {
                advices.push({
                    id: seasonal.id,
                    icon: seasonal.icon,
                    text: helpers.personalizeText(helpers.pickRandomText(seasonal.texts), ctx),
                    type: 'tip',
                    priority: seasonal.priority,
                    category: seasonal.category,
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_seasonal_' + seasonal.id, '1'); } catch (e) { } }
                });
                break;
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“ˆ Caloric excess & circadian context
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const hasExcess = caloricDebt?.hasExcess;
        const cardioRec = caloricDebt?.cardioRecommendation;
        const activityCompensation = caloricDebt?.activityCompensation || 0;
        const dailyReduction = caloricDebt?.dailyReduction || 0;

        if (hasExcess && cardioRec && !cardioRec.compensatedBySteps && hour >= 14) {
            advices.push({
                id: 'excess_activity_recommended',
                icon: 'âœ¨',
                text: `Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ±: ${cardioRec.text}`,
                details: `ğŸƒ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½ĞµĞµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹! ${cardioRec.minutes} Ğ¼Ğ¸Ğ½ ${cardioRec.activityIcon} ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ¸Ñ€ÑƒĞµÑ‚ ~${activityCompensation} ĞºĞºĞ°Ğ» (70% Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚Ğ°). Ğ­Ñ‚Ğ¾ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ Ğ±ĞµĞ· ÑÑ‚Ñ€ĞµÑÑĞ°.`,
                type: 'tip',
                priority: 26,
                category: 'activity',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        if (hasExcess && cardioRec?.compensatedBySteps) {
            advices.push({
                id: 'excess_compensated_by_steps',
                icon: 'ğŸ‘Ÿ',
                text: `Ğ¨Ğ°Ğ³Ğ¸ ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ¸Ñ€ÑƒÑÑ‚ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€ Ğ½Ğ° ${cardioRec.stepsCompensation}%!`,
                details: `ğŸ‰ Ğ¢Ğ²Ğ¾Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒĞ¶Ğµ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ! ${day?.steps || 0} ÑˆĞ°Ğ³Ğ¾Ğ² Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ñ‚. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ´ÑƒÑ…Ğµ.`,
                type: 'achievement',
                priority: 12,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (dailyReduction > 50 && !caloricDebt?.hasDebt && hour < 14) {
            advices.push({
                id: 'excess_soft_correction',
                icon: 'ğŸ¯',
                text: `ĞĞ¾Ñ€Ğ¼Ğ° Ñ‡ÑƒÑ‚ÑŒ ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ° (âˆ’${dailyReduction} ĞºĞºĞ°Ğ») â€” Ğ¼ÑĞ³ĞºĞ¸Ğ¹ Ğ°ĞºÑ†ĞµĞ½Ñ‚`,
                details: 'ğŸ“Š Ğ­Ñ‚Ğ¾ Ğ½Ğµ Ğ½Ğ°ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ! ĞšĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ñ 5-10% Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ±ĞµĞ· ÑÑ‚Ñ€ĞµÑÑĞ°. Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ â€” Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹.',
                type: 'tip',
                priority: 35,
                category: 'nutrition',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const rawDebt = caloricDebt?.rawDebt || caloricDebt?.debt || 0;
        if (caloricDebt?.hasDebt && hour < 12 && rawDebt < 600) {
            advices.push({
                id: 'circadian_morning_calm',
                icon: 'ğŸŒ…',
                text: 'Ğ£Ñ‚Ñ€Ğ¾ â€” ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¸Ñ‚Ğ¾Ğ³Ğ¸',
                details: 'â° ĞĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ ÑĞµĞ¹Ñ‡Ğ°Ñ â€” Ğ½Ğ¾Ñ€Ğ¼Ğ°. Ğ”ĞµĞ½ÑŒ Ğ²Ğ¿ĞµÑ€ĞµĞ´Ğ¸! Ğ¤Ğ¾ĞºÑƒÑĞ¸Ñ€ÑƒĞ¹ÑÑ Ğ½Ğ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞµ Ñ Ğ±ĞµĞ»ĞºĞ¾Ğ¼, Ğ° Ğ½Ğµ Ğ½Ğ° Ñ†Ğ¸Ñ„Ñ€Ğ°Ñ….',
                type: 'tip',
                priority: 50,
                category: 'lifestyle',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        if (caloricDebt?.hasDebt && hour >= 20 && rawDebt > 500) {
            advices.push({
                id: 'circadian_evening_urgent',
                icon: 'ğŸŒ™',
                text: 'Ğ’ĞµÑ‡ĞµÑ€ â€” Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞµÑÑ‚ÑŒ Ğ´Ğ¾ ÑĞ½Ğ°',
                details: 'âš ï¸ Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ½Ğ¾Ğ¼ ÑƒÑ…ÑƒĞ´ÑˆĞ¸Ñ‚ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ½Ğ° Ğ¸ Ğ¿Ğ¾Ğ²Ñ‹ÑĞ¸Ñ‚ Ğ³Ñ€ĞµĞ»Ğ¸Ğ½ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°. Ğ¡ÑŠĞµÑˆÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ 200-300 ĞºĞºĞ°Ğ» Ğ±ĞµĞ»ĞºĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµĞºÑƒÑĞ°.',
                type: 'warning',
                priority: 19,
                category: 'timing',
                triggers: ['tab_open'],
                ttl: 6000
            });
        }

        const bmiCtx = caloricDebt?.bmiContext;
        if (bmiCtx && caloricDebt?.hasDebt && bmiCtx.category === 'underweight') {
            advices.push({
                id: 'bmi_underweight_warning',
                icon: 'âš ï¸',
                text: 'Ğ’ĞµÑ Ğ½Ğ¸Ğ¶Ğµ Ğ½Ğ¾Ñ€Ğ¼Ñ‹ â€” Ğ½ĞµĞ´Ğ¾ĞµĞ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾!',
                details: 'ğŸ©º ĞŸÑ€Ğ¸ BMI < 18.5 Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¹ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµĞ½. Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¾ Ğ½Ğ° 30%. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ½Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ñ€Ğ¼Ñƒ!',
                type: 'warning',
                priority: 13,
                category: 'health',
                triggers: ['tab_open'],
                ttl: 8000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”„ Refeed day tips
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (window.HEYS?.Refeed?.getRefeedAdvices) {
            const refeedAdvices = window.HEYS.Refeed.getRefeedAdvices({
                isRefeedDay: day?.isRefeedDay,
                refeedReason: day?.refeedReason,
                caloricDebt: caloricDebt,
                eatenKcal: dayTot?.kcal || 0,
                optimum: optimum,
                hour: hour
            });
            advices.push(...refeedAdvices);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š Weight trends & forecast
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const recentDaysForWeight = helpers.getRecentDays(7);
        const weightsForTrend = recentDaysForWeight.map(d => d.weightMorning).filter(w => w > 0);

        if (weightsForTrend.length >= 3) {
            const firstAvg = weightsForTrend.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
            const lastAvg = weightsForTrend.slice(-3).reduce((a, b) => a + b, 0) / 3;
            const trendPerWeek = ((lastAvg - firstAvg) / weightsForTrend.length) * 7;

            if (trendPerWeek < -0.3 && !sessionStorage.getItem('heys_weight_trend_down')) {
                advices.push({
                    id: 'weight_trend_down',
                    icon: 'ğŸ“‰',
                    text: 'Ğ’ĞµÑ ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚! Ğ¢Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ',
                    details: 'ğŸ† Ğ¢Ñ€ĞµĞ½Ğ´ Ğ²Ğ½Ğ¸Ğ· = Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚! 0.5-1 ĞºĞ³/Ğ½ĞµĞ´ĞµĞ»Ñ â€” Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞ¼Ğ¿ Ğ¿Ğ¾Ñ…ÑƒĞ´ĞµĞ½Ğ¸Ñ.',
                    type: 'achievement',
                    priority: 6,
                    category: 'weight',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_weight_trend_down', '1'); } catch (e) { } }
                });
            }

            if (trendPerWeek > 0.5 && !sessionStorage.getItem('heys_weight_trend_up')) {
                advices.push({
                    id: 'weight_trend_up',
                    icon: 'ğŸ“ˆ',
                    text: 'Ğ’ĞµÑ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸',
                    details: 'âš ï¸ >0.5 ĞºĞ³/Ğ½ĞµĞ´ĞµĞ»Ñ = ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ ĞºĞ°Ğ»Ğ¾Ñ€Ğ°Ğ¶ Ğ¸ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞºÑƒÑÑ‹.',
                    type: 'warning',
                    priority: 7,
                    category: 'weight',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_weight_trend_up', '1'); } catch (e) { } }
                });
            }

            const weightGoal = prof?.weightGoal;
            const currentWeight = day?.weightMorning || weightsForTrend[weightsForTrend.length - 1];

            if (weightGoal && currentWeight && Math.abs(currentWeight - weightGoal) > 0.5) {
                const deficitPct = Math.abs(prof?.deficitPctTarget || day?.deficitPct || 10);
                const rateKgPerWeek = (deficitPct / 100) * currentWeight * 0.8;
                const weightDiff = currentWeight - weightGoal;
                const actualRatePerWeek = (trendPerWeek !== 0) ? Math.abs(trendPerWeek) : rateKgPerWeek;
                const isGoingRight = (weightDiff > 0 && trendPerWeek < 0) || (weightDiff < 0 && trendPerWeek > 0);

                if (isGoingRight && actualRatePerWeek > 0.1) {
                    const weeksToGoal = Math.ceil(Math.abs(weightDiff) / actualRatePerWeek);

                    if (weeksToGoal <= 52) {
                        const goalDate = new Date();
                        goalDate.setDate(goalDate.getDate() + weeksToGoal * 7);
                        const goalDateStr = goalDate.toLocaleDateString('ru-RU', { month: 'long', day: 'numeric' });

                        advices.push({
                            id: 'weight_forecast_on_track',
                            icon: 'ğŸ¯',
                            text: `ĞŸĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ñƒ ${weightGoal}ĞºĞ³ â€” Ğº ${goalDateStr}`,
                            details: `ğŸ“Š ĞŸÑ€Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ñ‚ĞµĞ¼Ğ¿Ğµ (${actualRatePerWeek.toFixed(1)} ĞºĞ³/Ğ½ĞµĞ´) Ñ†ĞµĞ»ÑŒ Ğ² ${weightGoal}ĞºĞ³ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· ~${weeksToGoal} Ğ½ĞµĞ´. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹!`,
                            type: 'achievement',
                            priority: rules.PRIORITY.ACHIEVEMENT,
                            category: 'weight',
                            triggers: ['tab_open'],
                            ttl: 6000
                        });
                    } else {
                        advices.push({
                            id: 'weight_forecast_slow',
                            icon: 'ğŸ¢',
                            text: `Ğ¢ĞµĞ¼Ğ¿ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ â€” Ñ†ĞµĞ»ÑŒ Ğ´Ğ°Ğ»ĞµĞºĞ¾ (>${Math.round(weeksToGoal / 4)} Ğ¼ĞµÑ)`,
                            details: `â° ĞŸÑ€Ğ¸ ${actualRatePerWeek.toFixed(1)} ĞºĞ³/Ğ½ĞµĞ´ Ğ´Ğ¾ ${weightGoal}ĞºĞ³ â€” Ğ±Ğ¾Ğ»ĞµĞµ ${Math.round(weeksToGoal / 4)} Ğ¼ĞµÑÑÑ†ĞµĞ². ĞœĞ¾Ğ¶Ğ½Ğ¾ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸.`,
                            type: 'tip',
                            priority: rules.PRIORITY.LOW,
                            category: 'weight',
                            triggers: ['tab_open'],
                            ttl: 6000
                        });
                    }
                }

                if (!isGoingRight && Math.abs(trendPerWeek) > 0.2) {
                    advices.push({
                        id: 'weight_forecast_wrong_direction',
                        icon: 'âš ï¸',
                        text: 'Ğ’ĞµÑ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¾Ñ‚ Ñ†ĞµĞ»Ğ¸ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¿Ğ»Ğ°Ğ½',
                        details: `ğŸ”„ Ğ¦ĞµĞ»ÑŒ ${weightGoal}ĞºĞ³, Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ½Ğ´ ${trendPerWeek > 0 ? '+' : ''}${trendPerWeek.toFixed(1)} ĞºĞ³/Ğ½ĞµĞ´. ĞŸĞµÑ€ĞµÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ ĞºĞ°Ğ»Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸.`,
                        type: 'warning',
                        priority: rules.PRIORITY.IMPORTANT,
                        category: 'weight',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                }

                if (Math.abs(weightDiff) < 2) {
                    advices.push({
                        id: 'weight_almost_there',
                        icon: 'ğŸ',
                        text: `Ğ”Ğ¾ Ñ†ĞµĞ»Ğ¸ ${Math.abs(weightDiff).toFixed(1)}ĞºĞ³ â€” Ñ„Ğ¸Ğ½Ğ¸ÑˆĞ½Ğ°Ñ Ğ¿Ñ€ÑĞ¼Ğ°Ñ!`,
                        details: `ğŸ¯ ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼ĞµĞ½ÑŒÑˆĞµ 2ĞºĞ³ Ğ´Ğ¾ ${weightGoal}ĞºĞ³! Ğ¤Ğ¸Ğ½Ğ¸Ñˆ Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ â€” Ğ½Ğµ ÑĞ±Ğ°Ğ²Ğ»ÑĞ¹ Ñ‚ĞµĞ¼Ğ¿!`,
                        type: 'achievement',
                        priority: rules.PRIORITY.ACHIEVEMENT - 1,
                        category: 'weight',
                        triggers: ['tab_open'],
                        ttl: 6000
                    });
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“ Measurements insights
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const getMeasurementsHistory = window.HEYS?.Steps?.getMeasurementsHistory;
        if (typeof getMeasurementsHistory === 'function') {
            const measurementsHistory = getMeasurementsHistory(30);

            if (measurementsHistory && measurementsHistory.length >= 2) {
                const latest = measurementsHistory[0];
                const oldest = measurementsHistory[measurementsHistory.length - 1];

                const waistChange = (latest.waist && oldest.waist) ? latest.waist - oldest.waist : null;
                const bicepsChange = (latest.biceps && oldest.biceps) ? latest.biceps - oldest.biceps : null;

                if (waistChange !== null && waistChange < -1 && !sessionStorage.getItem('heys_waist_down')) {
                    advices.push({
                        id: 'waist_down_progress',
                        icon: 'ğŸ“',
                        text: `Ğ¢Ğ°Ğ»Ğ¸Ñ -${Math.abs(waistChange).toFixed(1)} ÑĞ¼ Ğ·Ğ° Ğ¼ĞµÑÑÑ†! ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ`,
                        details: 'ğŸ† Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ğ»Ğ¸Ğ¸ = ÑƒÑ…Ğ¾Ğ´ Ğ²Ğ¸ÑÑ†ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¶Ğ¸Ñ€Ğ°. Ğ­Ñ‚Ğ¾ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ½Ğ° Ğ²ĞµÑĞ°Ñ…!',
                        type: 'achievement',
                        priority: 5,
                        category: 'measurements',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        showConfetti: true,
                        onShow: () => { try { sessionStorage.setItem('heys_waist_down', '1'); } catch (e) { } }
                    });
                }

                if (bicepsChange !== null && bicepsChange > 0.5 && !sessionStorage.getItem('heys_biceps_up')) {
                    advices.push({
                        id: 'biceps_growing',
                        icon: 'ğŸ’ª',
                        text: `Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ +${bicepsChange.toFixed(1)} ÑĞ¼! ĞœÑ‹ÑˆÑ†Ñ‹ Ñ€Ğ°ÑÑ‚ÑƒÑ‚`,
                        details: 'ğŸ’ª Ğ Ğ¾ÑÑ‚ Ğ¼Ñ‹ÑˆÑ† = Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ + Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±ĞµĞ»ĞºĞ°. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹!',
                        type: 'achievement',
                        priority: 6,
                        category: 'measurements',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_biceps_up', '1'); } catch (e) { } }
                    });
                }

                const weightGoal = prof?.weightGoal || 0;
                const currentWeight = day?.weightMorning || prof?.weight || 0;

                if (weightGoal > 0 && currentWeight > 0 && waistChange !== null) {
                    const weightDiff = currentWeight - weightGoal;
                    if (weightDiff > 0 && waistChange < -0.5 && !sessionStorage.getItem('heys_weight_waist_corr')) {
                        advices.push({
                            id: 'weight_waist_correlation',
                            icon: 'ğŸ“Š',
                            text: `Ğ¢Ğ°Ğ»Ğ¸Ñ -${Math.abs(waistChange).toFixed(1)} ÑĞ¼ = Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğº Ñ†ĞµĞ»Ğ¸`,
                            details: `ğŸ¯ Ğ”Ğ¾ Ñ†ĞµĞ»Ğ¸ ${weightDiff.toFixed(1)} ĞºĞ³. Ğ¢Ğ°Ğ»Ğ¸Ñ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ°ĞµÑ‚ÑÑ â€” Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ¶Ğ¸Ñ€ ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚!`,
                            type: 'insight',
                            priority: 8,
                            category: 'correlation',
                            triggers: ['tab_open'],
                            ttl: 6000,
                            onShow: () => { try { sessionStorage.setItem('heys_weight_waist_corr', '1'); } catch (e) { } }
                        });
                    }

                    if (weightDiff < -2 && bicepsChange !== null && bicepsChange > 0.3 && !sessionStorage.getItem('heys_bulk_corr')) {
                        advices.push({
                            id: 'bulk_muscle_correlation',
                            icon: 'ğŸ‹ï¸',
                            text: 'Ğ’ĞµÑ Ğ²Ñ‹ÑˆĞµ Ñ†ĞµĞ»Ğ¸, Ğ½Ğ¾ Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ñ€Ğ°ÑÑ‚ÑƒÑ‚ â€” ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾',
                            details: 'ğŸ’¡ ĞĞ°Ğ±Ğ¾Ñ€ Ğ¼Ñ‹ÑˆÑ† = Ğ½Ğ°Ğ±Ğ¾Ñ€ Ğ²ĞµÑĞ°. ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ¹ Ğ·Ğ°Ğ¼ĞµÑ€Ñ‹, Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ĞµÑÑ‹.',
                            type: 'insight',
                            priority: 9,
                            category: 'correlation',
                            triggers: ['tab_open'],
                            ttl: 5000,
                            onShow: () => { try { sessionStorage.setItem('heys_bulk_corr', '1'); } catch (e) { } }
                        });
                    }
                }

                const lastMeasuredDate = latest?.measuredAt;
                if (lastMeasuredDate) {
                    const daysSinceMeasured = Math.floor((Date.now() - new Date(lastMeasuredDate).getTime()) / (1000 * 60 * 60 * 24));
                    if (daysSinceMeasured >= 14 && !sessionStorage.getItem('heys_measure_reminder')) {
                        advices.push({
                            id: 'measure_reminder',
                            icon: 'ğŸ“',
                            text: `${daysSinceMeasured} Ğ´Ğ½ĞµĞ¹ Ğ±ĞµĞ· Ğ·Ğ°Ğ¼ĞµÑ€Ğ¾Ğ² â€” Ğ¿Ğ¾Ñ€Ğ° Ğ¸Ğ·Ğ¼ĞµÑ€Ğ¸Ñ‚ÑŒÑÑ`,
                            details: 'ğŸ“ Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¼ĞµÑ€Ñ‹ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ÑÑ‚ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ, Ğ° Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ĞµÑ.',
                            type: 'tip',
                            priority: 15,
                            category: 'measurements',
                            triggers: ['tab_open'],
                            ttl: 5000,
                            onShow: () => { try { sessionStorage.setItem('heys_measure_reminder', '1'); } catch (e) { } }
                        });
                    }
                }
            }

            if (measurementsHistory && measurementsHistory.length === 1 && !helpers.isMilestoneShown('first_measurement')) {
                advices.push({
                    id: 'first_measurement',
                    icon: 'ğŸ“',
                    text: 'ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¼ĞµÑ€ ÑĞ´ĞµĞ»Ğ°Ğ½! ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ',
                    details: 'ğŸ¯ Ğ—Ğ°Ğ¼ĞµÑ€Ñ‹ Ñ‚ĞµĞ»Ğ° Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ, Ñ‡ĞµĞ¼ Ğ²ĞµÑÑ‹. Ğ˜Ğ·Ğ¼ĞµÑ€ÑĞ¹ÑÑ Ñ€Ğ°Ğ· Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ.',
                    type: 'achievement',
                    priority: 4,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    showConfetti: true,
                    onShow: () => helpers.markMilestoneShown('first_measurement')
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š Behavioral patterns
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const recentForTraining = helpers.getRecentDays(3); // 3 Ğ´Ğ½Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
        const todayHasTraining = (day?.trainings || []).some(t => t.z?.some(m => m > 0));
        if (todayHasTraining && recentForTraining.length >= 3 && !sessionStorage.getItem('heys_workout_consistent')) {
            const allThreeHaveTraining = recentForTraining.every(d =>
                (d.trainings || []).some(t => t.z?.some(m => m > 0))
            );

            if (allThreeHaveTraining) {
                advices.push({
                    id: 'workout_consistent',
                    icon: 'ğŸ”¥',
                    text: '3 Ğ´Ğ½Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ¿Ğ¾Ğ´Ñ€ÑĞ´! Ğ¢Ñ‹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ° ğŸ’ª',
                    details: 'ğŸ¯ Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸. 3 Ğ´Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ = Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ!',
                    type: 'achievement',
                    priority: 7,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_workout_consistent', '1'); } catch (e) { } }
                });
            }
        }

        const lastEvensCheck = localStorage.getItem('heys_evening_snacker_check');
        const weekAgoPattern = Date.now() - 7 * 24 * 60 * 60 * 1000;

        if (!lastEvensCheck || +lastEvensCheck < weekAgoPattern) {
            const recentForPattern = helpers.getRecentDays(3);

            if (recentForPattern.length >= 3) {
                const allLateEaters = recentForPattern.every(d => {
                    const dayMeals = (d.meals || []).filter(m => m.items?.length > 0);
                    if (dayMeals.length === 0) return false;
                    const times = dayMeals.map(m => m.time || '12:00').sort();
                    const lastTime = times[times.length - 1];
                    const [h] = lastTime.split(':').map(Number);
                    return h >= 22;
                });

                if (allLateEaters) {
                    advices.push({
                        id: 'evening_snacker',
                        icon: 'ğŸŒ™',
                        text: 'Ğ—Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ» Ñ‚Ñ€ĞµĞ½Ğ´ â€” Ñ‚Ñ‹ Ñ‡Ğ°ÑÑ‚Ğ¾ ÑƒĞ¶Ğ¸Ğ½Ğ°ĞµÑˆÑŒ Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¾. ĞœĞ¾Ğ¶ĞµÑ‚, Ğ¿ĞµÑ€ĞµĞºÑƒÑ Ñ€Ğ°Ğ½ÑŒÑˆĞµ?',
                        details: 'ğŸ’¡ ĞŸĞ¾Ğ·Ğ´Ğ½Ğ¸Ğµ ÑƒĞ¶Ğ¸Ğ½Ñ‹ ÑƒÑ…ÑƒĞ´ÑˆĞ°ÑÑ‚ ÑĞ¾Ğ½ Ğ¸ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ÑƒĞ¶Ğ¸Ğ½Ğ°Ñ‚ÑŒ Ğ´Ğ¾ 20:00.',
                        type: 'insight',
                        priority: 38,
                        category: 'correlation',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => {
                            try { localStorage.setItem('heys_evening_snacker_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        const lastSkipCheck = localStorage.getItem('heys_morning_skipper_check');
        if (!lastSkipCheck || +lastSkipCheck < weekAgoPattern) {
            const recentForSkip = helpers.getRecentDays(3);

            if (recentForSkip.length >= 3) {
                const allSkipBreakfast = recentForSkip.every(d => {
                    const dayMeals = (d.meals || []).filter(m => m.items?.length > 0);
                    if (dayMeals.length === 0) return true;
                    const times = dayMeals.map(m => m.time || '12:00').sort();
                    const firstTime = times[0];
                    const [h] = firstTime.split(':').map(Number);
                    return h >= 11;
                });

                if (allSkipBreakfast) {
                    advices.push({
                        id: 'morning_skipper',
                        icon: 'ğŸ¤”',
                        text: 'Ğ£Ğ¶Ğµ 3 Ğ´Ğ½Ñ Ğ±ĞµĞ· Ñ€Ğ°Ğ½Ğ½ĞµĞ³Ğ¾ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ° â€” ÑĞºÑĞ¿ĞµÑ€Ğ¸Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞµÑˆÑŒ Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼?',
                        details: 'ğŸ¥ Ğ•ÑĞ»Ğ¸ 16/8 â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ â€” Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¼ĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ğ·Ğ¼.',
                        type: 'insight',
                        priority: 39,
                        category: 'correlation',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => {
                            try { localStorage.setItem('heys_morning_skipper_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        const lastUnderCheck = localStorage.getItem('heys_chronic_undereating_check');
        if (!lastUnderCheck || +lastUnderCheck < weekAgoPattern) {
            const recentForUnder = helpers.getRecentDays(3);

            if (recentForUnder.length >= 3) {
                const underEatingDays = recentForUnder.filter(d => {
                    const dayMeals = (d.meals || []).filter(m => m.items?.length > 0);
                    if (dayMeals.length === 0) return false;

                    let dayKcal = 0;
                    for (const meal of dayMeals) {
                        for (const item of meal.items || []) {
                            const product = helpers.getProductForItem(item, pIndex);
                            if (product) {
                                const grams = item.grams || 100;
                                dayKcal += (product.kcal100 || 0) * grams / 100;
                            }
                        }
                    }

                    const dayRatio = dayKcal / (optimum || 2000);
                    return dayRatio < 0.75;
                });

                if (underEatingDays.length >= 3) {
                    advices.push({
                        id: 'chronic_undereating_pattern',
                        icon: 'ğŸš¨',
                        text: 'Ğ£Ğ¶Ğµ 3+ Ğ´Ğ½ĞµĞ¹ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ±Ğ¾Ñ€ â€” ÑÑ‚Ğ¾ Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ´Ğ»Ñ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ',
                        details: `ğŸ”¬ Ğ¥Ñ€Ğ¾Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚ (>25% Ğ¾Ñ‚ Ğ½Ğ¾Ñ€Ğ¼Ñ‹) Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚:\n\n` +
                            `â€¢ ĞœĞµÑ‚Ğ°Ğ±Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ°Ñ†Ğ¸Ñ â€” Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ğ¼ĞµĞ½ Ğ²ĞµÑ‰ĞµÑÑ‚Ğ²\n` +
                            `â€¢ ĞŸĞ¾Ñ‚ĞµÑ€Ñ Ğ¼Ñ‹ÑˆĞµÑ‡Ğ½Ğ¾Ğ¹ Ğ¼Ğ°ÑÑÑ‹ (Ñ‚ĞµĞ»Ğ¾ Ñ€Ğ°ÑÑ‰ĞµĞ¿Ğ»ÑĞµÑ‚ Ğ¼Ñ‹ÑˆÑ†Ñ‹ Ğ´Ğ»Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸)\n` +
                            `â€¢ Ğ“Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ (Ñ‰Ğ¸Ñ‚Ğ¾Ğ²Ğ¸Ğ´ĞºĞ°, ĞºĞ¾Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ», Ğ¿Ğ¾Ğ»Ğ¾Ğ²Ñ‹Ğµ Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ñ‹)\n` +
                            `â€¢ Ğ’Ñ‹Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ»Ğ¾Ñ (Ñ‚ĞµĞ»Ğ¾Ğ³ĞµĞ½Ğ¾Ğ²Ğ°Ñ Ğ°Ğ»Ğ¾Ğ¿ĞµÑ†Ğ¸Ñ)\n\n` +
                            `ğŸ’¡ Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ»Ğ¸Ğ±Ğ¾ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ÑŒ Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¸, Ğ»Ğ¸Ğ±Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ° Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ.`,
                        type: 'warning',
                        priority: 3,
                        category: 'correlation',
                        triggers: ['tab_open'],
                        ttl: 10000,
                        onShow: () => {
                            try { localStorage.setItem('heys_chronic_undereating_check', Date.now().toString()); } catch (e) { }
                        }
                    });
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ‘¤ Personalized tips (gender/age/cycle)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const isFemale = prof?.gender === 'Ğ–ĞµĞ½ÑĞºĞ¸Ğ¹';
        if (isFemale && mealCount >= 2) {
            const ironRichKeywords = ['Ğ¼ÑÑĞ¾', 'Ğ¿ĞµÑ‡ĞµĞ½ÑŒ', 'Ğ³Ğ¾Ğ²ÑĞ´Ğ¸Ğ½Ğ°', 'Ğ³Ñ€ĞµÑ‡ĞºĞ°', 'ÑˆĞ¿Ğ¸Ğ½Ğ°Ñ‚', 'Ñ‡ĞµÑ‡ĞµĞ²Ğ¸Ñ†Ğ°'];
            const allItemsP = (day?.meals || []).flatMap(m => m.items || []);
            const hasIronRichFood = allItemsP.some(item => {
                const product = helpers.getProductForItem(item, pIndex);
                const name = (product?.name || item.name || '').toLowerCase();
                return ironRichKeywords.some(kw => name.includes(kw));
            });

            if (!hasIronRichFood && !sessionStorage.getItem('heys_iron_tip_today')) {
                advices.push({
                    id: 'iron_reminder',
                    icon: 'ğŸ©¸',
                    text: 'ĞĞµ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ¹ Ğ¾ Ğ¶ĞµĞ»ĞµĞ·Ğµ â€” Ğ¼ÑÑĞ¾, Ğ¿ĞµÑ‡ĞµĞ½ÑŒ, Ğ³Ñ€ĞµÑ‡ĞºĞ°',
                    details: 'ğŸ¦¸â€â™€ï¸ Ğ–ĞµĞ½Ñ‰Ğ¸Ğ½Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ 18Ğ¼Ğ³ Ğ¶ĞµĞ»ĞµĞ·Ğ°/Ğ´ĞµĞ½ÑŒ (Ğ¼ÑƒĞ¶Ñ‡Ğ¸Ğ½Ğ°Ğ¼ 8Ğ¼Ğ³). Ğ›Ğ¸Ğ´ĞµÑ€Ñ‹: Ğ¿ĞµÑ‡ĞµĞ½ÑŒ, ĞºÑ€Ğ°ÑĞ½Ğ¾Ğµ Ğ¼ÑÑĞ¾, Ñ‡ĞµÑ‡ĞµĞ²Ğ¸Ñ†Ğ°, ÑˆĞ¿Ğ¸Ğ½Ğ°Ñ‚.',
                    type: 'tip',
                    priority: 55,
                    category: 'personalized',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_iron_tip_today', '1'); } catch (e) { } }
                });
            }
        }

        const cycleDay = day?.cycleDay || null;
        const cyclePhase = window.HEYS?.Cycle?.getCyclePhase?.(cycleDay);
        const allItemsCycle = (day?.meals || []).flatMap(m => m.items || []);

        if (cyclePhase?.id === 'menstrual' && ctx.simplePct > 1.0) {
            advices.push({
                id: 'cycle_sweet_craving',
                icon: 'ğŸŒ¸',
                text: 'Ğ¢ÑĞ³Ğ° Ğº ÑĞ»Ğ°Ğ´ĞºĞ¾Ğ¼Ñƒ â€” Ğ½Ğ¾Ñ€Ğ¼Ğ° Ğ² ÑÑ‚Ğ¾Ñ‚ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´',
                details: 'ğŸ§¬ Ğ“Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ñ‚ÑĞ³Ñƒ Ğº ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ğ°Ğ¼. Ğ›ÑƒÑ‡ÑˆĞµ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ‚Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´ Ğ¸Ğ»Ğ¸ Ñ„Ñ€ÑƒĞºÑ‚Ñ‹.',
                type: 'tip',
                priority: 58,
                category: 'personalized',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        if (cyclePhase?.id === 'menstrual') {
            const ironKeywords = ['Ğ¿ĞµÑ‡ĞµĞ½ÑŒ', 'Ğ³Ğ¾Ğ²ÑĞ´Ğ¸Ğ½', 'Ğ³Ñ€Ğ°Ğ½Ğ°Ñ‚', 'Ğ³Ñ€ĞµÑ‡Ğº', 'Ñ‡ĞµÑ‡ĞµĞ²Ğ¸Ñ†', 'ÑˆĞ¿Ğ¸Ğ½Ğ°Ñ‚', 'Ğ¸Ğ½Ğ´ĞµĞ¹Ğº'];
            const hasIron = allItemsCycle.some(item => {
                const product = helpers.getProductForItem(item, pIndex);
                const name = (product?.name || item.name || '').toLowerCase();
                return ironKeywords.some(kw => name.includes(kw));
            });

            if (!hasIron && mealCount >= 2) {
                advices.push({
                    id: 'cycle_iron_important',
                    icon: 'ğŸ©¸',
                    text: 'Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ¶ĞµĞ»ĞµĞ·Ğ¾ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ²Ğ°Ğ¶Ğ½Ğ¾',
                    details: 'ğŸ’ª Ğ’ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ¼ĞµĞ½ÑÑ‚Ñ€ÑƒĞ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸ Ğ¶ĞµĞ»ĞµĞ·Ğ° ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿ĞµÑ‡ĞµĞ½ÑŒ, Ğ³Ñ€ĞµÑ‡ĞºÑƒ Ğ¸Ğ»Ğ¸ Ğ³Ñ€Ğ°Ğ½Ğ°Ñ‚.',
                    type: 'tip',
                    priority: 57,
                    category: 'personalized',
                    triggers: ['tab_open'],
                    ttl: 5000
                });
            }
        }

        if (cyclePhase?.id === 'menstrual' && cycleDay <= 2 && !day.trainings?.length) {
            advices.push({
                id: 'cycle_rest_ok',
                icon: 'ğŸ§˜',
                text: 'ĞÑ‚Ğ´Ñ‹Ñ… ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ â€” Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€',
                details: 'âœ¨ Ğ’ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ñ†Ğ¸ĞºĞ»Ğ° ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ°. Ğ›Ñ‘Ğ³ĞºĞ°Ñ Ğ¹Ğ¾Ğ³Ğ° Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ³ÑƒĞ»ĞºĞ° Ğ»ÑƒÑ‡ÑˆĞµ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾Ğ¹ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸.',
                type: 'support',
                priority: 56,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (cyclePhase?.id === 'menstrual' && ctx.waterPct < 0.7) {
            advices.push({
                id: 'cycle_hydration',
                icon: 'ğŸ’§',
                text: 'Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ´Ğ° Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ°',
                details: 'ğŸŒŠ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ñ‚ĞµÑ€ÑĞµÑ‚ Ğ¶Ğ¸Ğ´ĞºĞ¾ÑÑ‚ÑŒ. Ğ’Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ñ ÑĞ°Ğ¼Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸ĞµĞ¼ Ğ¸ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ°ĞµÑ‚ Ğ¾Ñ‚Ñ‘ĞºĞ¸.',
                type: 'tip',
                priority: 56,
                category: 'hydration',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        if (cyclePhase?.id === 'follicular' && !sessionStorage.getItem('heys_cycle_energy_today')) {
            advices.push({
                id: 'cycle_energy_up',
                icon: 'ğŸŒ±',
                text: 'Ğ­Ğ½ĞµÑ€Ğ³Ğ¸Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ â€” Ñ…Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº',
                details: 'ğŸ¯ Ğ¤Ğ¾Ğ»Ğ»Ğ¸ĞºÑƒĞ»ÑÑ€Ğ½Ğ°Ñ Ñ„Ğ°Ğ·Ğ° â€” Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ñ‹Ñ… Ğ½Ğ°Ğ³Ñ€ÑƒĞ·Ğ¾Ğº Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ†ĞµĞ»ĞµĞ¹.',
                type: 'motivation',
                priority: 55,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_cycle_energy_today', '1'); } catch (e) { } }
            });
        }

        if (cyclePhase?.id === 'ovulation' && !sessionStorage.getItem('heys_cycle_peak_today')) {
            advices.push({
                id: 'cycle_peak_performance',
                icon: 'â­',
                text: 'ĞŸĞ¸Ğº ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸! Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¾Ğ²',
                details: 'ğŸ† Ğ”Ğ½Ğ¸ Ğ¾Ğ²ÑƒĞ»ÑÑ†Ğ¸Ğ¸ â€” Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ¸Ğ»Ğ° Ğ¸ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑÑ‚Ğ¾!',
                type: 'motivation',
                priority: 58,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 5000,
                onShow: () => { try { sessionStorage.setItem('heys_cycle_peak_today', '1'); } catch (e) { } }
            });
        }

        if (cyclePhase && !sessionStorage.getItem('heys_cycle_thanks_shown')) {
            advices.push({
                id: 'cycle_tracking_thanks',
                icon: 'ğŸŒ¸',
                text: 'Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑĞ¾Ğ±Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ² Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°Ñ…',
                details: 'ğŸ’œ ĞĞ¾Ñ€Ğ¼Ñ‹ Ğ²Ğ¾Ğ´Ñ‹ Ğ¸ Ğ¸Ğ½ÑÑƒĞ»Ğ¸Ğ½Ğ¾Ğ²Ğ°Ñ Ğ²Ğ¾Ğ»Ğ½Ğ° Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¿Ğ¾Ğ´ Ñ‚Ğ²Ğ¾Ğ¹ Ñ†Ğ¸ĞºĞ».',
                type: 'info',
                priority: 50,
                category: 'personalized',
                triggers: ['tab_open'],
                ttl: 4000,
                onShow: () => { try { sessionStorage.setItem('heys_cycle_thanks_shown', '1'); } catch (e) { } }
            });
        }

        const age = prof?.age || 30;
        const proteinPctAge = (dayTot?.prot || 0) / ((normAbs?.prot || 100) || 1);
        if (age >= 40 && proteinPctAge < 0.9) {
            advices.push({
                id: 'age_protein',
                icon: 'ğŸ’ª',
                text: 'ĞŸĞ¾ÑĞ»Ğµ 40 Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±ĞµĞ»ĞºĞ° â€” ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¼Ñ‹ÑˆÑ†Ñ‹',
                details: 'ğŸ“Š ĞŸĞ¾ÑĞ»Ğµ 40 Ğ¼Ñ‹ÑˆĞµÑ‡Ğ½Ğ°Ñ Ğ¼Ğ°ÑÑĞ° Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ Ğ½Ğ° 3-5% Ğ·Ğ° Ğ´ĞµÑÑÑ‚Ğ¸Ğ»ĞµÑ‚Ğ¸Ğµ. Ğ‘ĞµĞ»Ğ¾Ğº 1.5-2Ğ³/ĞºĞ³ + ÑĞ¸Ğ»Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ = ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹.',
                type: 'tip',
                priority: 54,
                category: 'personalized',
                triggers: ['product_added', 'tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ  Activity tips
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const household = day?.householdMin || 0;
        if (household >= 60) {
            const extraKcal = Math.round(household * 3);
            advices.push({
                id: 'household_bonus',
                icon: 'ğŸ ',
                text: `${household} Ğ¼Ğ¸Ğ½ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ â‰ˆ +${extraKcal} ĞºĞºĞ°Ğ» ÑĞ¾Ğ¶Ğ¶ĞµĞ½Ğ¾`,
                details: 'ğŸ§¹ Ğ”Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ Ğ´ĞµĞ»Ğ° â€” ÑÑ‚Ğ¾ Ñ‚Ğ¾Ğ¶Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ! Ğ£Ğ±Ğ¾Ñ€ĞºĞ° 60 Ğ¼Ğ¸Ğ½ = ~180 ĞºĞºĞ°Ğ».',
                type: 'info',
                priority: 50,
                category: 'activity',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const stepsDay = day?.steps || 0;
        if (household === 0 && stepsDay < 3000 && !hasTraining && hour >= 18) {
            advices.push({
                id: 'sedentary_day',
                icon: 'ğŸš¶',
                text: 'ĞœĞ°Ğ»Ğ¾Ğ¿Ğ¾Ğ´Ğ²Ğ¸Ğ¶Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ â€” Ğ¿Ñ€Ğ¾Ğ³ÑƒĞ»ÑĞ¹ÑÑ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚',
                details: 'ğŸ¯ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ñ…Ğ¾Ğ´ÑŒĞ±Ñ‹ = ~50-70 ĞºĞºĞ°Ğ» + ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ¸ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° ÑĞ½Ğ°. Ğ”Ğ°Ğ¶Ğµ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ³ÑƒĞ»ĞºĞ° Ğ»ÑƒÑ‡ÑˆĞµ, Ñ‡ĞµĞ¼ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾!',
                type: 'tip',
                priority: 48,
                category: 'activity',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ’¤ Sleep quality
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const sleepQuality = day?.sleepQuality || 0;
        if (sleepQuality > 0 && sleepQuality <= 2 && hour < 12) {
            advices.push({
                id: 'bad_sleep_advice',
                icon: 'ğŸ˜´',
                text: 'ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ğ»Ğ¾Ñ…Ğ¾Ğ³Ğ¾ ÑĞ½Ğ° â€” Ğ¼ĞµĞ½ÑŒÑˆĞµ ĞºĞ¾Ñ„Ğµ, Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±ĞµĞ»ĞºĞ°',
                details: 'ğŸ’¡ ĞŸĞ¾ÑĞ»Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‹Ğ¿Ğ° Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€ÑƒÑ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ (ÑĞ°Ñ…Ğ°Ñ€, ĞºĞ¾Ñ„Ğµ). Ğ›ÑƒÑ‡ÑˆĞµ: Ğ±ĞµĞ»Ğ¾Ğº + ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ³Ğ»ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸.',
                type: 'tip',
                priority: 26,
                category: 'sleep',
                triggers: ['tab_open'],
                ttl: 5000
            });
        }

        const sleepHoursQ = helpers.calculateSleepHours(day);
        if (sleepQuality >= 4 && sleepHoursQ >= 7) {
            advices.push({
                id: 'great_sleep',
                icon: 'ğŸ˜Š',
                text: 'Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ Ğ²Ñ‹ÑĞ¿Ğ°Ğ»ÑÑ â€” Ğ´ĞµĞ½ÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼!',
                details: 'ğŸŒŸ ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¾Ğ½ = Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹ ĞºĞ¾Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ» Ğ¸ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ¿Ğ¿ĞµÑ‚Ğ¸Ñ‚. Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»ĞµĞ³Ñ‡Ğµ Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½!',
                type: 'achievement',
                priority: 46,
                category: 'sleep',
                triggers: ['tab_open'],
                ttl: 4000
            });
        }

        const recentDaysForSleep = helpers.getRecentDays(3);
        const sleepHoursRecent = recentDaysForSleep.map(d => helpers.calculateSleepHours(d)).filter(h => h > 0);
        if (sleepHoursRecent.length >= 3) {
            const allUnder6 = sleepHoursRecent.every(h => h < 6);
            if (allUnder6 && !sessionStorage.getItem('heys_sleep_debt')) {
                advices.push({
                    id: 'sleep_debt_accumulating',
                    icon: 'ğŸ˜´',
                    text: 'ĞĞ°ĞºĞ¾Ğ¿Ğ¸Ğ»ÑÑ Ğ½ĞµĞ´Ğ¾ÑÑ‹Ğ¿ â€” ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ»ÑĞ³ Ğ¿Ğ¾Ñ€Ğ°Ğ½ÑŒÑˆĞµ!',
                    details: 'âš ï¸ 3+ Ğ´Ğ½Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‹Ğ¿Ğ° = Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¼Ğ¾Ğ½Ğ¾Ğ². Ğ“Ñ€ĞµĞ»Ğ¸Ğ½ (Ğ³Ğ¾Ğ»Ğ¾Ğ´) Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚, Ğ»ĞµĞ¿Ñ‚Ğ¸Ğ½ (ÑÑ‹Ñ‚Ğ¾ÑÑ‚ÑŒ) Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚.',
                    type: 'warning',
                    priority: 95,
                    category: 'lifestyle',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_sleep_debt', '1'); } catch (e) { } }
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¥‡ Milestones
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const totalDays = helpers.getTotalDaysTracked();
        if (totalDays === 7 && !helpers.isMilestoneShown('7_days')) {
            advices.push({
                id: 'milestone_7_days',
                icon: 'ğŸ“…',
                text: 'ĞĞµĞ´ĞµĞ»Ñ Ñ HEYS! ĞŸÑ€Ğ¸Ğ²Ñ‹Ñ‡ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ',
                details: 'ğŸ’¡ 7 Ğ´Ğ½ĞµĞ¹ â€” Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ÑƒĞ±ĞµĞ¶! Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚: 21 Ğ´ĞµĞ½ÑŒ â€” Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºĞ°, 66 Ğ´Ğ½ĞµĞ¹ â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¼.',
                type: 'achievement',
                priority: 2,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 8000,
                showConfetti: true,
                onShow: () => helpers.markMilestoneShown('7_days')
            });
        }

        if (totalDays === 30 && !helpers.isMilestoneShown('30_days')) {
            const firstName = prof?.firstName || '';
            advices.push({
                id: 'milestone_30_days',
                icon: 'ğŸ‰',
                text: firstName ? `ĞœĞµÑÑÑ† Ñ HEYS, ${firstName}! Ğ¢Ñ‹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†` : 'ĞœĞµÑÑÑ† Ñ HEYS! Ğ¢Ñ‹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†',
                details: 'ğŸ† 30 Ğ´Ğ½ĞµĞ¹ = Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºĞ° ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°! Ğ¢Ñ€ĞµĞºĞ¸Ğ½Ğ³ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ°Ğ» Ñ‡Ğ°ÑÑ‚ÑŒÑ Ñ‚Ğ²Ğ¾ĞµĞ¹ Ğ¶Ğ¸Ğ·Ğ½Ğ¸.',
                type: 'achievement',
                priority: 1,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 10000,
                showConfetti: true,
                onShow: () => helpers.markMilestoneShown('30_days')
            });
        }

        if (totalDays === 100 && !helpers.isMilestoneShown('100_days')) {
            advices.push({
                id: 'milestone_100_days',
                icon: 'ğŸ†',
                text: '100 Ğ´Ğ½ĞµĞ¹! Ğ¢Ñ‹ Ğ»ĞµĞ³ĞµĞ½Ğ´Ğ°',
                details: 'ğŸŒŸ 100 Ğ´Ğ½ĞµĞ¹ Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³Ğ° â€” ÑÑ‚Ğ¾ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¼Ğ°ÑÑ‚ĞµÑ€Ğ°! Ğ¢Ñ‹ Ğ² Ñ‚Ğ¾Ğ¿-1% Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹.',
                type: 'achievement',
                priority: 1,
                category: 'achievement',
                triggers: ['tab_open'],
                ttl: 12000,
                showConfetti: true,
                onShow: () => helpers.markMilestoneShown('100_days')
            });
        }

        if (currentStreak > 0) {
            const isNewRecord = helpers.updatePersonalBestStreak(currentStreak);
            if (isNewRecord && currentStreak >= 3 && !sessionStorage.getItem('heys_new_record')) {
                advices.push({
                    id: 'new_record_streak',
                    icon: 'ğŸ”¥',
                    text: `Ğ ĞµĞºĞ¾Ñ€Ğ´Ğ½Ñ‹Ğ¹ streak â€” ${currentStreak} Ğ´Ğ½ĞµĞ¹! ğŸ”¥ğŸ”¥ğŸ”¥`,
                    details: 'ğŸ… ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´! ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ streak ÑƒĞºÑ€ĞµĞ¿Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºÑƒ. ĞĞµ ÑĞ»Ğ¾Ğ¼Ğ°Ğ¹ ÑĞµÑ€Ğ¸Ñ!',
                    type: 'achievement',
                    priority: 2,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    showConfetti: true,
                    onShow: () => { try { sessionStorage.setItem('heys_new_record', '1'); } catch (e) { } }
                });
            }
        }

        if (hasTraining && !helpers.isMilestoneShown('first_training')) {
            const historyDays = helpers.getRecentDays(30);
            const hasHistoryTraining = historyDays.some(d =>
                d.trainings?.some(t => t.z && t.z.some(m => m > 0))
            );

            if (!hasHistoryTraining) {
                advices.push({
                    id: 'first_training_ever',
                    icon: 'ğŸƒ',
                    text: 'ĞŸĞµÑ€Ğ²Ğ°Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ² HEYS! ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¾',
                    details: 'ğŸ¯ ĞŸĞµÑ€Ğ²Ğ°Ñ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° â€” ÑĞ°Ğ¼Ğ°Ñ Ñ‚ÑĞ¶Ñ‘Ğ»Ğ°Ñ! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ HEYS Ğ±ÑƒĞ´ĞµÑ‚ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ² Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°Ñ….',
                    type: 'achievement',
                    priority: 3,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    showConfetti: true,
                    onShow: () => helpers.markMilestoneShown('first_training')
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“… Weekly comparison / summary / streak hint / combo
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (!sessionStorage.getItem('heys_weekly_comparison')) {
            const weekComp = helpers.getWeeklyComparison();
            if (weekComp?.message) {
                advices.push({
                    id: 'weekly_comparison',
                    icon: 'ğŸ“Š',
                    text: weekComp.message,
                    details: 'ğŸ“… Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ´Ñ‹.',
                    type: 'achievement',
                    priority: 15,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 6000,
                    onShow: () => { try { sessionStorage.setItem('heys_weekly_comparison', '1'); } catch (e) { } }
                });
            }
        }

        if (hour >= 18 && !sessionStorage.getItem('heys_weekly_summary')) {
            const summary = helpers.getWeeklySummary();
            if (summary) {
                advices.push({
                    id: 'weekly_summary',
                    icon: 'ğŸ“‹',
                    text: summary.message,
                    details: 'ğŸ“ˆ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¸ ÑĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½.',
                    type: 'insight',
                    priority: 10,
                    category: 'lifestyle',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    onShow: () => { try { sessionStorage.setItem('heys_weekly_summary', '1'); } catch (e) { } }
                });
            }
        }

        if (currentStreak > 0 && currentStreak < 30 && !sessionStorage.getItem('heys_streak_hint')) {
            const milestone = helpers.getNextStreakMilestone(currentStreak);
            if (milestone && milestone.remain <= 3) {
                advices.push({
                    id: 'streak_hint',
                    icon: milestone.icon,
                    text: milestone.text,
                    details: 'ğŸ”¥ ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğµ ÑƒĞºÑ€ĞµĞ¿Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºÑƒ. ĞĞµ ÑĞ´Ğ°Ğ²Ğ°Ğ¹ÑÑ!',
                    type: 'motivation',
                    priority: 20,
                    category: 'gamification',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_streak_hint', '1'); } catch (e) { } }
                });
            }
        }

        if (!sessionStorage.getItem('heys_combo_checked')) {
            const combo = helpers.checkComboAchievements(ctx);
            if (combo) {
                advices.push({
                    id: 'combo_' + combo.id,
                    icon: combo.icon,
                    text: combo.text,
                    type: 'achievement',
                    priority: 5,
                    category: 'achievement',
                    triggers: ['tab_open'],
                    ttl: 8000,
                    onShow: () => {
                        helpers.markComboShown(combo.id);
                        try { sessionStorage.setItem('heys_combo_checked', '1'); } catch (e) { }
                    }
                });
            }
            try { sessionStorage.setItem('heys_combo_checked', '1'); } catch (e) { }
        }

        if (!sessionStorage.getItem('heys_smart_rec_shown')) {
            const recommendation = helpers.getSmartRecommendation(hour);
            if (recommendation) {
                advices.push({
                    id: 'smart_recommendation',
                    icon: 'ğŸ’¡',
                    text: recommendation.message,
                    details: 'ğŸ¯ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ².',
                    type: 'tip',
                    priority: 35,
                    category: 'personalized',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_smart_rec_shown', '1'); } catch (e) { } }
                });
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ’Š Supplements advices (catalog-based)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        if (window.HEYS?.Supplements) {
            const Supps = window.HEYS.Supplements;
            const dateKey = day?.date || new Date().toISOString().slice(0, 10);
            const planned = Supps.getPlanned?.() || [];
            const taken = Supps.getTaken?.(dateKey) || [];
            const notTaken = planned.filter(id => !taken.includes(id));

            if (hour >= 7 && hour <= 10 && !sessionStorage.getItem('heys_supp_morning')) {
                const morningSupps = notTaken.filter(id => {
                    const s = Supps.CATALOG?.[id];
                    return s && (s.timing === 'morning' || s.timing === 'empty');
                });

                if (morningSupps.length > 0) {
                    const names = morningSupps.slice(0, 3).map(id => Supps.CATALOG[id]?.name).join(', ');
                    advices.push({
                        id: 'supplements_morning_reminder',
                        icon: 'ğŸ’Š',
                        text: `Ğ£Ñ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹: ${names}`,
                        details: 'ğŸŒ… ĞĞ°Ñ‚Ğ¾Ñ‰Ğ°Ğº Ğ»ÑƒÑ‡ÑˆĞµ ÑƒÑĞ²Ğ°Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ: B12, Ğ¶ĞµĞ»ĞµĞ·Ğ¾. D3 Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ¾Ğ¼.',
                        type: 'tip',
                        priority: 22,
                        category: 'supplements',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_morning', '1'); } catch (e) { } }
                    });
                }
            }

            if (hour >= 21 && hour <= 23 && !sessionStorage.getItem('heys_supp_evening')) {
                const eveningSupps = notTaken.filter(id => {
                    const s = Supps.CATALOG?.[id];
                    return s && (s.timing === 'evening' || s.timing === 'beforeBed');
                });

                if (eveningSupps.length > 0) {
                    const names = eveningSupps.slice(0, 3).map(id => Supps.CATALOG[id]?.name).join(', ');
                    advices.push({
                        id: 'supplements_evening_reminder',
                        icon: 'ğŸŒ™',
                        text: `Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğµ: ${names}`,
                        details: 'ğŸ˜´ ĞœĞ°Ğ³Ğ½Ğ¸Ğ¹ Ğ¸ Ğ¼ĞµĞ»Ğ°Ñ‚Ğ¾Ğ½Ğ¸Ğ½ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ÑÑ‚ Ñ€Ğ°ÑÑĞ»Ğ°Ğ±Ğ¸Ñ‚ÑŒÑÑ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ½Ğ¾Ğ¼.',
                        type: 'tip',
                        priority: 25,
                        category: 'supplements',
                        triggers: ['tab_open'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_evening', '1'); } catch (e) { } }
                    });
                }
            }

            const lastMeal = (day?.meals || []).slice(-1)[0];
            if (lastMeal && lastMeal.items?.length > 0 && !sessionStorage.getItem('heys_supp_fat_synergy')) {
                let mealFat = 0;
                for (const item of lastMeal.items) {
                    const p = helpers.getProductForItem(item, pIndex);
                    if (p) mealFat += (p.fat100 || 0) * (item.grams || 100) / 100;
                }

                if (mealFat >= 10) {
                    const fatSoluble = notTaken.filter(id =>
                        Supps.CATALOG?.[id]?.timing === 'withFat'
                    );

                    if (fatSoluble.length > 0) {
                        const names = fatSoluble.map(id => Supps.CATALOG[id]?.name).join(', ');
                        advices.push({
                            id: 'supplements_fat_meal_synergy',
                            icon: 'ğŸ¥‘',
                            text: `Ğ–Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼! Ğ˜Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ: ${names}`,
                            details: 'ğŸ§¬ Ğ–Ğ¸Ñ€Ğ¾Ñ€Ğ°ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ğ¼Ñ‹Ğµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹ (D, E, K, A) ÑƒÑĞ²Ğ°Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ² 3-4 Ñ€Ğ°Ğ·Ğ° Ğ»ÑƒÑ‡ÑˆĞµ Ñ Ğ¶Ğ¸Ñ€Ğ°Ğ¼Ğ¸.',
                            type: 'tip',
                            priority: 18,
                            category: 'supplements',
                            triggers: ['product_added'],
                            ttl: 6000,
                            onShow: () => { try { sessionStorage.setItem('heys_supp_fat_synergy', '1'); } catch (e) { } }
                        });
                    }
                }
            }

            if (lastMeal && lastMeal.items?.length > 0 && !sessionStorage.getItem('heys_supp_dairy_iron')) {
                const dairyFoods = ['Ñ‚Ğ²Ğ¾Ñ€Ğ¾Ğ³', 'Ğ¼Ğ¾Ğ»Ğ¾ĞºĞ¾', 'ÑÑ‹Ñ€', 'Ğ¹Ğ¾Ğ³ÑƒÑ€Ñ‚', 'ĞºĞµÑ„Ğ¸Ñ€', 'ÑĞ¼ĞµÑ‚Ğ°Ğ½Ğ°'];
                const hasDairy = lastMeal.items.some(item =>
                    dairyFoods.some(f => (item.name || '').toLowerCase().includes(f))
                );

                if (hasDairy && notTaken.includes('iron')) {
                    advices.push({
                        id: 'supplements_dairy_iron_conflict',
                        icon: 'âš ï¸',
                        text: 'ĞœĞ¾Ğ»Ğ¾Ñ‡ĞºĞ° + Ğ¶ĞµĞ»ĞµĞ·Ğ¾ = Ğ¿Ğ»Ğ¾Ñ…Ğ¾ ÑƒÑĞ²Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ',
                        details: 'ğŸ§€ ĞšĞ°Ğ»ÑŒÑ†Ğ¸Ğ¹ Ğ¸Ğ· Ğ¼Ğ¾Ğ»Ğ¾Ñ‡ĞºĞ¸ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¶ĞµĞ»ĞµĞ·Ğ°. Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ½Ğ° 2-3 Ñ‡Ğ°ÑĞ°.',
                        type: 'warning',
                        priority: 20,
                        category: 'supplements',
                        triggers: ['product_added'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_dairy_iron', '1'); } catch (e) { } }
                    });
                }
            }

            if (lastMeal && !sessionStorage.getItem('heys_supp_coffee_minerals')) {
                const hasCoffee = (lastMeal.items || []).some(item =>
                    (item.name || '').toLowerCase().includes('ĞºĞ¾Ñ„Ğµ')
                );
                const mineralSupps = notTaken.filter(id =>
                    ['iron', 'calcium', 'zinc', 'magnesium'].includes(id)
                );

                if (hasCoffee && mineralSupps.length > 0) {
                    const names = mineralSupps.map(id => Supps.CATALOG[id]?.name).join(', ');
                    advices.push({
                        id: 'supplements_coffee_minerals',
                        icon: 'â˜•',
                        text: `ĞšĞ¾Ñ„Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚: ${names}`,
                        details: 'â˜• Ğ¢Ğ°Ğ½Ğ¸Ğ½Ñ‹ Ğ¸ ĞºĞ¾Ñ„ĞµĞ¸Ğ½ ÑĞ½Ğ¸Ğ¶Ğ°ÑÑ‚ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ½ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ½Ğ° 40-60%. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸ 1-2 Ñ‡Ğ°ÑĞ°.',
                        type: 'warning',
                        priority: 23,
                        category: 'supplements',
                        triggers: ['product_added'],
                        ttl: 5000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_coffee_minerals', '1'); } catch (e) { } }
                    });
                }
            }

            if (lastMeal && !sessionStorage.getItem('heys_supp_iron_vitc')) {
                const ironRichFoods = ['Ğ¿ĞµÑ‡ĞµĞ½ÑŒ', 'Ğ³Ğ¾Ğ²ÑĞ´Ğ¸Ğ½Ğ°', 'Ğ³Ñ€ĞµÑ‡ĞºĞ°', 'Ñ‡ĞµÑ‡ĞµĞ²Ğ¸Ñ†Ğ°', 'ÑˆĞ¿Ğ¸Ğ½Ğ°Ñ‚', 'Ñ„Ğ°ÑĞ¾Ğ»ÑŒ'];
                const hasIronFood = (lastMeal.items || []).some(item =>
                    ironRichFoods.some(f => (item.name || '').toLowerCase().includes(f))
                );

                if (hasIronFood && notTaken.includes('vitC')) {
                    advices.push({
                        id: 'supplements_iron_vitc_synergy',
                        icon: 'ğŸŠ',
                        text: 'Ğ•Ğ´Ğ° Ñ Ğ¶ĞµĞ»ĞµĞ·Ğ¾Ğ¼! Ğ’Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½ C ÑƒÑĞ¸Ğ»Ğ¸Ñ‚ ÑƒÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ Ã—3',
                        details: 'ğŸ§¬ Ğ’Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½ C Ğ¿Ñ€ĞµĞ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½ĞµĞ³ĞµĞ¼Ğ¾Ğ²Ğ¾Ğµ Ğ¶ĞµĞ»ĞµĞ·Ğ¾ Ğ² Ğ»ĞµĞ³ĞºĞ¾ÑƒÑĞ²Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ÑƒÑ Ñ„Ğ¾Ñ€Ğ¼Ñƒ.',
                        type: 'tip',
                        priority: 17,
                        category: 'supplements',
                        triggers: ['product_added'],
                        ttl: 6000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_iron_vitc', '1'); } catch (e) { } }
                    });
                }
            }

            const compliance = Supps.getComplianceStats?.();
            if (compliance?.currentStreak >= 5 && !sessionStorage.getItem('heys_supp_streak')) {
                advices.push({
                    id: 'supplements_streak',
                    icon: 'ğŸ”¥',
                    text: `${compliance.currentStreak} Ğ´Ğ½ĞµĞ¹ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ Ğ²ÑĞµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹!`,
                    details: 'ğŸ’ª Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ Ğ´Ğ¾Ğ·Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹!',
                    type: 'achievement',
                    priority: 45,
                    category: 'supplements',
                    triggers: ['tab_open'],
                    ttl: 5000,
                    onShow: () => { try { sessionStorage.setItem('heys_supp_streak', '1'); } catch (e) { } }
                });
            }

            if (planned.length > 0 && notTaken.length === 0 && !sessionStorage.getItem('heys_supp_all_done')) {
                advices.push({
                    id: 'supplements_all_taken',
                    icon: 'âœ…',
                    text: 'Ğ’ÑĞµ Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ñ‹! ĞœĞ¾Ğ»Ğ¾Ğ´ĞµÑ†!',
                    details: 'ğŸ’Š ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ â€” ĞºĞ»ÑÑ‡ Ğº Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ.',
                    type: 'achievement',
                    priority: 55,
                    category: 'supplements',
                    triggers: ['tab_open'],
                    ttl: 4000,
                    onShow: () => { try { sessionStorage.setItem('heys_supp_all_done', '1'); } catch (e) { } }
                });
            }

            if (!sessionStorage.getItem('heys_supp_personal_rec')) {
                const recs = Supps.getSmartRecommendations?.(prof, day) || [];
                if (recs.length > 0) {
                    const rec = recs[0];
                    advices.push({
                        id: 'supplements_personal_rec',
                        icon: 'ğŸ’¡',
                        text: rec.reason,
                        details: `Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ${Supps.CATALOG?.[rec.id]?.name || rec.id} Ğ² Ğ¿Ğ»Ğ°Ğ½.`,
                        type: 'tip',
                        priority: 50,
                        category: 'supplements',
                        triggers: ['tab_open'],
                        ttl: 6000,
                        onShow: () => { try { sessionStorage.setItem('heys_supp_personal_rec', '1'); } catch (e) { } }
                    });
                }
            }
        }

        return advices;
    };

})();
// ===== End advice/_other.js =====
