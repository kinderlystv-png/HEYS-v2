// heys_smart_search_v2.js ‚Äî –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ–ø–µ—á–∞—Ç–æ–∫, —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
// –í–µ—Ä—Å–∏—è 2.7.0 | 2025-12-17
// ‚úÖ Nutrient Search (high protein, keto, etc.)
// ‚úÖ Context Search (breakfast, gym)
// ‚úÖ Improved Fuzzy Search (translit + typos)
// ‚úÖ üÜï Visual Feedback ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–ª–∏/—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–ª–∏
// ‚úÖ üÜï Brand Matching ‚Äî fuzzy –ø–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥–∞–º (Danone, –ü—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ)
// ‚úÖ üÜï ML-lite Similarity ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –±–ª–∏–∑–æ—Å—Ç—å –±–µ–∑ ML
// ‚úÖ üÜï Smart Suggestions ‚Äî —É–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
// ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —ë ‚Üí –µ
// ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫ (–õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω)
// ‚úÖ –°–∏–Ω–æ–Ω–∏–º—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (100+ –≥—Ä—É–ø–ø)
// ‚úÖ –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
// ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
// ‚úÖ –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
// ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (highlightMatches)
// ‚úÖ "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" (getDidYouMean)
// ‚úÖ –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è (ru ‚Üî en): protein ‚Üí –ø—Ä–æ—Ç–µ–∏–Ω, —Ç–æ–ø–ø–∏–Ω–≥ ‚Üí topping
// ‚úÖ Fuzzy-—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è: fines ‚Üí fitness/—Ñ–∏—Ç–Ω–µ—Å, —Ñ–∏–Ω—Ç–µ—Å ‚Üí —Ñ–∏—Ç–Ω–µ—Å
// ‚úÖ üÜï QWERTY‚Üî–ô–¶–£–ö–ï–ù: vfkjrj ‚Üí –º–æ–ª–æ–∫–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞)
// ‚úÖ üÜï –°–æ–∫—Ä–∞—â–µ–Ω–∏—è: –±/–∂, 0%, –∫–∫–∞–ª ‚Üí –±–µ–∑ –∂–∏—Ä–∞, –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π, –∫–∞–ª–æ—Ä–∏–∏
// ‚úÖ üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤: "—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π" = "–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π —Ç–≤–æ—Ä–æ–≥"
// ‚úÖ üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã—à–µ
// ‚úÖ üÜï N-gram –ø–æ–∏—Å–∫: –ø–æ–∏—Å–∫ –ø–æ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —Å–ª–æ–≤–∞
// ‚úÖ üÜï –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: –ø–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É –ø—Ä–æ–¥—É–∫—Ç–∞
// ‚úÖ üÜï Token-aware scoring: —É–º–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–ª–æ–≤–∞–º –∑–∞–ø—Ä–æ—Å–∞
// ‚úÖ üÜï Numeric-aware –ø–æ–∏—Å–∫: 2.5% / 0% / 250–≥ / 1–ª ‚Äî —Ç–æ—á–Ω–µ–µ –ø–æ —Ü–∏—Ñ—Ä–∞–º
// ‚úÖ üÜï –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤: –±—ã—Å—Ç—Ä–µ–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤

; (function (global) {
  'use strict';

  const HEYS = global.HEYS = global.HEYS || {};

  // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
  const CONFIG = {
    minQueryLength: 2,        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞
    maxResults: 50,           // –ú–∞–∫—Å–∏–º—É–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    maxSuggestions: 5,        // –ú–∞–∫—Å–∏–º—É–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    cacheEnabled: true,       // –í–∫–ª—é—á–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    cacheTimeout: 300000,     // 5 –º–∏–Ω—É—Ç –∫–µ—à–∞
    enablePhonetic: true,     // –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
    enableSynonyms: true,     // –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
    enableTypoCorrection: true, // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
    enableTranslit: true,     // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è ru ‚Üî en
    enableKeyboardFix: true,  // üÜï –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ QWERTY‚Üî–ô–¶–£–ö–ï–ù
    enableAbbreviations: true, // üÜï –°–æ–∫—Ä–∞—â–µ–Ω–∏—è (–±/–∂, 0%, –∫–∫–∞–ª)
    enableWordPermutations: true, // üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
    enableNgram: true,        // üÜï N-gram –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç—è–º —Å–ª–æ–≤–∞
    enablePersonalization: true, // üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    debugMode: false,         // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏

    // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
    getMaxTypoDistance(queryLength) {
      if (queryLength <= 3) return 1;
      if (queryLength <= 5) return 2;
      return 3;
    }
  };

  // === –ö–ï–®–ò –ò –ò–ù–î–ï–ö–°–´ ===
  let searchCache = new Map();
  let productIndex = null;      // –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  let lastProductsHash = null;  // –•–µ—à –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–Ω–¥–µ–∫—Å–∞

  // === –°–õ–û–í–ê–†–ò ===

  // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–∏)
  const commonWords = new Set([
    '—Ö–ª–µ–±', '–º–æ–ª–æ–∫–æ', '–º—è—Å–æ', '—Ä—ã–±–∞', '–æ–≤–æ—â–∏', '—Ñ—Ä—É–∫—Ç—ã', '–∫—Ä—É–ø–∞', '–º–∞–∫–∞—Ä–æ–Ω—ã',
    '—Å—ã—Ä', '–º–∞—Å–ª–æ', '—è–π—Ü–∞', '–∫—É—Ä–∏—Ü–∞', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å',
    '–º–æ—Ä–∫–æ–≤—å', '–ª—É–∫', '–ø–æ–º–∏–¥–æ—Ä', '–æ–≥—É—Ä–µ—Ü', '—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω',
    '—Ç–≤–æ—Ä–æ–≥', '–∫–µ—Ñ–∏—Ä', '–π–æ–≥—É—Ä—Ç', '—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–æ–≤—Å—è–Ω–∫–∞', '–∫–∞—à–∞',
    '—Å–∞–ª–∞—Ç', '–∫–∞–ø—É—Å—Ç–∞', '–ø–µ—Ä–µ—Ü', '—á–µ—Å–Ω–æ–∫', '–∑–µ–ª–µ–Ω—å', '—É–∫—Ä–æ–ø', '–ø–µ—Ç—Ä—É—à–∫–∞',
    '–º–µ–¥', '—Å–∞—Ö–∞—Ä', '—Å–æ–ª—å', '–∫–æ—Ñ–µ', '—á–∞–π', '—Å–æ–∫', '–≤–æ–¥–∞', '–∫–æ–º–ø–æ—Ç',
    '–∫–æ–ª–±–∞—Å–∞', '—Å–æ—Å–∏—Å–∫–∏', '–≤–µ—Ç—á–∏–Ω–∞', '–±–µ–∫–æ–Ω', '—Ñ–∞—Ä—à', '–∫–æ—Ç–ª–µ—Ç–∞', '—Å—Ç–µ–π–∫',
    '—Ä—ã–±–∞', '—Å–µ–º–≥–∞', '–ª–æ—Å–æ—Å—å', '—Ç—Ä–µ—Å–∫–∞', '—Ç—É–Ω–µ—Ü', '–∫—Ä–µ–≤–µ—Ç–∫–∏', '–∫–∞–ª—å–º–∞—Ä',
    '—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–ø–µ—á–µ–Ω—å–µ', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–≥', '–±—É–ª–æ—á–∫–∞', '–∫—Ä—É–∞—Å—Å–∞–Ω',
    '–æ—Ä–µ—Ö–∏', '–º–∏–Ω–¥–∞–ª—å', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '–∞—Ä–∞—Ö–∏—Å', '—Å–µ–º–µ—á–∫–∏',
    '–∞–≤–æ–∫–∞–¥–æ', '–º–∞–Ω–≥–æ', '–∫–∏–≤–∏', '–∞–Ω–∞–Ω–∞—Å', '–≤–∏–Ω–æ–≥—Ä–∞–¥', '–∫–ª—É–±–Ω–∏–∫–∞', '–º–∞–ª–∏–Ω–∞'
  ]);

  // –°–∏–Ω–æ–Ω–∏–º—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å)
  const synonyms = {
    // –ú–æ–ª–æ—á–Ω—ã–µ
    '–º–æ–ª–æ–∫–æ': ['–º–æ–ª–æ—á–∫–æ', '–º–æ–ª–æ—á–Ω—ã–π', '–º–æ–ª–æ—á–∫–∞'],
    '—Ç–≤–æ—Ä–æ–≥': ['—Ç–≤–æ—Ä–æ–∂–æ–∫', '—Ç–≤–æ—Ä–æ–∂–Ω—ã–π', '—Ç–≤–æ—Ä–æ–∂–Ω–∞—è'],
    '—Å—ã—Ä': ['—Å—ã—Ä–æ–∫', '—Å—ã—Ä–Ω—ã–π'],
    '–∫–µ—Ñ–∏—Ä': ['–∫–µ—Ñ–∏—Ä–Ω—ã–π', '–∫–µ—Ñ–∏—Ä—á–∏–∫'],
    '–π–æ–≥—É—Ä—Ç': ['–π–æ–≥—É—Ä—Ç–æ–≤—ã–π', '–π–æ–≥—É—Ä—Ç–∏–∫'],
    '—Å–º–µ—Ç–∞–Ω–∞': ['—Å–º–µ—Ç–∞–Ω–∫–∞', '—Å–º–µ—Ç–∞–Ω–Ω—ã–π'],
    '—Å–ª–∏–≤–∫–∏': ['—Å–ª–∏–≤–æ—á–Ω—ã–π', '—Å–ª–∏–≤–æ—á–∫–∏'],

    // –ú—è—Å–æ
    '–∫—É—Ä–∏—Ü–∞': ['–∫—É—Ä–∏–Ω—ã–π', '–∫—É—Ä–∏–Ω–∞—è', '–∫—É—Ä—è—Ç–∏–Ω–∞', '—Ü—ã–ø–ª–µ–Ω–æ–∫', '–ø—Ç–∏—Ü–∞', '–∫—É—Ä–∞'],
    '–≥–æ–≤—è–¥–∏–Ω–∞': ['–≥–æ–≤—è–∂–∏–π', '–≥–æ–≤—è–∂—å—è', '—Ç–µ–ª—è—Ç–∏–Ω–∞', '—Ç–µ–ª–µ–Ω–æ–∫'],
    '—Å–≤–∏–Ω–∏–Ω–∞': ['—Å–≤–∏–Ω–æ–π', '—Å–≤–∏–Ω–∞—è', '–ø–æ—Ä–æ—Å–µ–Ω–æ–∫'],
    '–∏–Ω–¥–µ–π–∫–∞': ['–∏–Ω–¥—é—à–∫–∞', '–∏–Ω–¥—é—à–∞—Ç–∏–Ω–∞', '–∏–Ω–¥—é—à–∏–Ω—ã–π'],
    '–±–∞—Ä–∞–Ω–∏–Ω–∞': ['–±–∞—Ä–∞–Ω–∏–π', '–±–∞—Ä–∞–Ω—å—è', '—è–≥–Ω–µ–Ω–æ–∫'],
    '–º—è—Å–æ': ['–º—è—Å–Ω–æ–π', '–º—è—Å–Ω–∞—è', '–º—è—Å–Ω—ã–µ'],
    '—Ñ–∞—Ä—à': ['—Ñ–∞—Ä—à–µ–≤—ã–π'],

    // –†—ã–±–∞
    '—Ä—ã–±–∞': ['—Ä—ã–±–Ω—ã–π', '—Ä—ã–±–Ω–∞—è', '—Ä—ã–±–∫–∞'],
    '—Å–µ–º–≥–∞': ['—Å–µ–º—É–∂–∫–∞', '–ª–æ—Å–æ—Å—å', '–∫—Ä–∞—Å–Ω–∞—è —Ä—ã–±–∞'],
    '–ª–æ—Å–æ—Å—å': ['—Å–µ–º–≥–∞', '–∫—Ä–∞—Å–Ω–∞—è —Ä—ã–±–∞'],
    '—Ç—Ä–µ—Å–∫–∞': ['—Ç—Ä–µ—Å–∫–æ–≤—ã–π'],
    '—Ç—É–Ω–µ—Ü': ['—Ç—É–Ω—Ü–æ–≤—ã–π'],

    // –û–≤–æ—â–∏
    '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å': ['–∫–∞—Ä—Ç–æ—à–∫–∞', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π', '–∫–∞—Ä—Ç–æ—à–µ—á–∫–∞', '–∫–∞—Ä—Ç–æ—Ö–∞'],
    '–ø–æ–º–∏–¥–æ—Ä': ['—Ç–æ–º–∞—Ç', '—Ç–æ–º–∞—Ç–Ω—ã–π', '–ø–æ–º–∏–¥–æ—Ä–∫–∞', '–ø–æ–º–∏–¥–æ—Ä—á–∏–∫'],
    '–æ–≥—É—Ä–µ—Ü': ['–æ–≥—É—Ä—á–∏–∫', '–æ–≥—É—Ä–µ—á–Ω—ã–π', '–∫–æ—Ä–Ω–∏—à–æ–Ω'],
    '–∫–∞–ø—É—Å—Ç–∞': ['–∫–∞–ø—É—Å—Ç–Ω—ã–π', '–∫–∞–ø—É—Å—Ç–∫–∞'],
    '–º–æ—Ä–∫–æ–≤—å': ['–º–æ—Ä–∫–æ–≤–∫–∞', '–º–æ—Ä–∫–æ–≤–Ω—ã–π', '–º–æ—Ä–∫–æ–≤–æ—á–∫–∞'],
    '–ª—É–∫': ['–ª—É–∫–æ–≤—ã–π', '–ª—É—á–æ–∫', '—Ä–µ–ø—á–∞—Ç—ã–π'],
    '—á–µ—Å–Ω–æ–∫': ['—á–µ—Å–Ω–æ—á–Ω—ã–π', '—á–µ—Å–Ω–æ—á–æ–∫'],
    '–ø–µ—Ä–µ—Ü': ['–ø–µ—Ä—á–∏–∫', '–ø–µ—Ä—Ü–æ–≤—ã–π', '–±–æ–ª–≥–∞—Ä—Å–∫–∏–π'],
    '–±–∞–∫–ª–∞–∂–∞–Ω': ['–±–∞–∫–ª–∞–∂–∞–Ω–Ω—ã–π', '—Å–∏–Ω–µ–Ω—å–∫–∏–π'],
    '–∫–∞–±–∞—á–æ–∫': ['–∫–∞–±–∞—á–∫–æ–≤—ã–π', '—Ü—É–∫–∫–∏–Ω–∏'],
    '—Å–≤–µ–∫–ª–∞': ['—Å–≤–µ–∫–æ–ª—å–Ω—ã–π', '–±—É—Ä—è–∫'],
    '—Ä–µ–¥–∏—Å': ['—Ä–µ–¥–∏—Å–∫–∞', '—Ä–µ–¥–∏—Å–æ—á–∫–∞'],

    // –§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã
    '—è–±–ª–æ–∫–æ': ['—è–±–ª–æ—á–∫–æ', '—è–±–ª–æ—á–Ω—ã–π'],
    '–±–∞–Ω–∞–Ω': ['–±–∞–Ω–∞–Ω—á–∏–∫', '–±–∞–Ω–∞–Ω–æ–≤—ã–π'],
    '–∞–ø–µ–ª—å—Å–∏–Ω': ['–∞–ø–µ–ª—å—Å–∏–Ω—á–∏–∫', '–∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π', '—Ü–∏—Ç—Ä—É—Å'],
    '–ª–∏–º–æ–Ω': ['–ª–∏–º–æ–Ω—á–∏–∫', '–ª–∏–º–æ–Ω–Ω—ã–π'],
    '–≥—Ä—É—à–∞': ['–≥—Ä—É—à–∫–∞', '–≥—Ä—É—à–µ–≤—ã–π'],
    '–≤–∏–Ω–æ–≥—Ä–∞–¥': ['–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π', '–≤–∏–Ω–æ–≥—Ä–∞–¥–∏–∫'],
    '–∫–ª—É–±–Ω–∏–∫–∞': ['–∫–ª—É–±–Ω–∏—á–∫–∞', '–∫–ª—É–±–Ω–∏—á–Ω—ã–π', '–∑–µ–º–ª—è–Ω–∏–∫–∞'],
    '–º–∞–ª–∏–Ω–∞': ['–º–∞–ª–∏–Ω–∫–∞', '–º–∞–ª–∏–Ω–æ–≤—ã–π'],
    '—á–µ—Ä–Ω–∏–∫–∞': ['—á–µ—Ä–Ω–∏—á–∫–∞', '—á–µ—Ä–Ω–∏—á–Ω—ã–π'],
    '–∞—Ä–±—É–∑': ['–∞—Ä–±—É–∑–∏–∫', '–∞—Ä–±—É–∑–Ω—ã–π'],
    '–¥—ã–Ω—è': ['–¥—ã–Ω—å–∫–∞', '–¥—ã–Ω–Ω—ã–π'],

    // –ö—Ä—É–ø—ã –∏ –≥–∞—Ä–Ω–∏—Ä—ã
    '—Ä–∏—Å': ['—Ä–∏—Å–æ–≤—ã–π', '—Ä–∏—Å–æ–≤–∞—è'],
    '–≥—Ä–µ—á–∫–∞': ['–≥—Ä–µ—á–Ω–µ–≤—ã–π', '–≥—Ä–µ—á–Ω–µ–≤–∞—è', '–≥—Ä–µ—á–∞'],
    '–æ–≤—Å—è–Ω–∫–∞': ['–æ–≤—Å—è–Ω—ã–π', '–æ–≤—Å—è–Ω–∞—è', '–æ–≤–µ—Å', '–≥–µ—Ä–∫—É–ª–µ—Å'],
    '–º–∞–∫–∞—Ä–æ–Ω—ã': ['–º–∞–∫–∞—Ä–æ–Ω–Ω—ã–π', '–ø–∞—Å—Ç–∞', '—Å–ø–∞–≥–µ—Ç—Ç–∏', '–ª–∞–ø—à–∞'],
    '–∫–∞—à–∞': ['–∫–∞—à–∫–∞', '–∫–∞—à–Ω—ã–π'],
    '–ø—à–µ–Ω–æ': ['–ø—à–µ–Ω–Ω—ã–π', '–ø—à–µ–Ω–Ω–∞—è', '–ø—à–µ–Ω–∫–∞'],
    '–ø–µ—Ä–ª–æ–≤–∫–∞': ['–ø–µ—Ä–ª–æ–≤—ã–π', '–ø–µ—Ä–ª–æ–≤–∞—è'],
    '–±—É–ª–≥—É—Ä': ['–±—É–ª–≥—É—Ä–æ–≤—ã–π'],
    '–∫—É—Å–∫—É—Å': ['–∫—É—Å–∫—É—Å–æ–≤—ã–π'],
    '–∫–∏–Ω–æ–∞': ['–∫–∏–Ω–æ–∞'],

    // –•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞
    '—Ö–ª–µ–±': ['—Ö–ª–µ–±—É—à–µ–∫', '—Ö–ª–µ–±–Ω—ã–π', '–±–∞—Ç–æ–Ω', '–±—É—Ö–∞–Ω–∫–∞', '–±—É–ª–∫–∞', '–±–∞–≥–µ—Ç'],
    '–±—É–ª–æ—á–∫–∞': ['–±—É–ª–∫–∞', '—Å–¥–æ–±–∞', '–ø–ª—é—à–∫–∞'],
    '–∫—Ä—É–∞—Å—Å–∞–Ω': ['—Ä–æ–≥–∞–ª–∏–∫'],
    '–ø–µ—á–µ–Ω—å–µ': ['–ø–µ—á–µ–Ω—å–∫–∞', '–ø–µ—á–µ–Ω—å–∫–∏'],
    '—Ç–æ—Ä—Ç': ['—Ç–æ—Ä—Ç–∏–∫', '—Ç–æ—Ä—Ç—ã'],
    '–ø–∏—Ä–æ–≥': ['–ø–∏—Ä–æ–∂–æ–∫', '–ø–∏—Ä–æ–∂–∫–∏'],

    // –°–ª–∞–¥–∫–æ–µ
    '—Å–∞—Ö–∞—Ä': ['—Å–∞—Ö–∞—Ä–Ω—ã–π', '—Å–∞—Ö–∞—Ä–æ–∫'],
    '–º–µ–¥': ['–º–µ–¥–æ–∫', '–º–µ–¥–æ–≤—ã–π'],
    '—à–æ–∫–æ–ª–∞–¥': ['—à–æ–∫–æ–ª–∞–¥–∫–∞', '—à–æ–∫–æ–ª–∞–¥–Ω—ã–π'],
    '–∫–æ–Ω—Ñ–µ—Ç—ã': ['–∫–æ–Ω—Ñ–µ—Ç–∞', '–∫–æ–Ω—Ñ–µ—Ç–∫–∞'],
    '–≤–∞—Ä–µ–Ω—å–µ': ['–¥–∂–µ–º', '–ø–æ–≤–∏–¥–ª–æ'],

    // –ù–∞–ø–∏—Ç–∫–∏
    '–∫–æ—Ñ–µ': ['–∫–æ—Ñ–µ–µ–∫', '–∫–æ—Ñ–µ–π–Ω—ã–π', '—ç—Å–ø—Ä–µ—Å—Å–æ', '–∞–º–µ—Ä–∏–∫–∞–Ω–æ', '–∫–∞–ø—É—á–∏–Ω–æ', '–ª–∞—Ç—Ç–µ'],
    '—á–∞–π': ['—á–∞–µ–∫', '—á–∞–π–Ω—ã–π'],
    '—Å–æ–∫': ['—Å–æ—á–æ–∫', '—Å–æ–∫–æ–≤—ã–π', '—Ñ—Ä–µ—à'],
    '–≤–æ–¥–∞': ['–≤–æ–¥–∏—á–∫–∞', '–º–∏–Ω–µ—Ä–∞–ª–∫–∞'],
    '–∫–æ–º–ø–æ—Ç': ['–∫–æ–º–ø–æ—Ç–∏–∫'],
    '–º–æ—Ä—Å': ['–º–æ—Ä—Å–∏–∫'],

    // –û—Ä–µ—Ö–∏
    '–æ—Ä–µ—Ö–∏': ['–æ—Ä–µ—à–∫–∏', '–æ—Ä–µ—Ö–æ–≤—ã–π'],
    '–º–∏–Ω–¥–∞–ª—å': ['–º–∏–Ω–¥–∞–ª—å–Ω—ã–π'],
    '—Ñ—É–Ω–¥—É–∫': ['–ª–µ—Å–Ω–æ–π –æ—Ä–µ—Ö'],
    '–≥—Ä–µ—Ü–∫–∏–π': ['–≥—Ä–µ—Ü–∫–∏–µ –æ—Ä–µ—Ö–∏'],
    '–∫–µ—à—å—é': ['–∫–µ—à—å—é–≤—ã–π'],
    '–∞—Ä–∞—Ö–∏—Å': ['–∞—Ä–∞—Ö–∏—Å–æ–≤—ã–π', '–∑–µ–º–ª—è–Ω–æ–π –æ—Ä–µ—Ö'],

    // –î—Ä—É–≥–æ–µ
    '—è–π—Ü–æ': ['—è–π—Ü–∞', '—è–∏—á–∫–æ', '—è–∏—á–Ω—ã–π', '–æ–º–ª–µ—Ç', '—è–∏—á–Ω–∏—Ü–∞'],
    '–º–∞—Å–ª–æ': ['–º–∞—Å–ª–∏—Ü–µ', '–º–∞—Å–ª—è–Ω—ã–π'],
    '—Å–æ—É—Å': ['—Å–æ—É—Å–∏–∫', '—Å–æ—É—Å–Ω—ã–π', '–∑–∞–ø—Ä–∞–≤–∫–∞'],
    '–º–∞–π–æ–Ω–µ–∑': ['–º–∞–π–æ–Ω–µ–∑–∏–∫', '–º–∞–π–æ–Ω–µ–∑–Ω—ã–π'],
    '–∫–µ—Ç—á—É–ø': ['–∫–µ—Ç—á—É–ø–∏–∫'],
    '–≥–æ—Ä—á–∏—Ü–∞': ['–≥–æ—Ä—á–∏—á–Ω—ã–π']
  };

  // –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
  const phoneticRules = [
    { from: /[—ë–µ]/g, to: '–µ' },       // —ë = –µ (–≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ!)
    { from: /[—å—ä]/g, to: '' },        // –º—è–≥–∫–∏–π/—Ç–≤–µ—Ä–¥—ã–π –∑–Ω–∞–∫
    { from: /—Ç—Å|—Ç—Ü/g, to: '—Ü' },      // —Ç—Å ‚Üí —Ü
    { from: /—Å—á|—â/g, to: '—â' },       // —Å—á = —â
    { from: /–∂—à|—à–∂/g, to: '—à' },      // –æ–≥–ª—É—à–µ–Ω–∏–µ
    // –û–≥–ª—É—à–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
    // { from: /[–±–ø]/g, to: '–ø' },
    // { from: /[–¥—Ç]/g, to: '—Ç' },
    // { from: /[–≥–∫]/g, to: '–∫' },
    // { from: /[–≤—Ñ]/g, to: '—Ñ' },
    // { from: /[–∑—Å]/g, to: '—Å' }
  ];

  // === üÜï –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø (ru ‚Üî en) ===

  // –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏: —Ä—É—Å—Å–∫–∏–π ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞ (–ì–û–°–¢ + –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
  const TRANSLIT_RU_TO_EN = {
    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd',
    '–µ': 'e', '—ë': 'yo', '–∂': 'zh', '–∑': 'z', '–∏': 'i',
    '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n',
    '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't',
    '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch',
    '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '',
    '—ç': 'e', '—é': 'yu', '—è': 'ya'
  };

  // –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏: –ª–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí —Ä—É—Å—Å–∫–∏–π (–æ–±—Ä–∞—Ç–Ω–∞—è + –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã)
  // –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω! –î–ª–∏–Ω–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏
  const TRANSLIT_EN_TO_RU = [
    // –°–ª–æ–∂–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
    ['sch', '—â'], ['sh', '—à'], ['ch', '—á'], ['zh', '–∂'],
    ['ts', '—Ü'], ['yu', '—é'], ['ya', '—è'], ['yo', '—ë'],
    ['ye', '–µ'], ['yi', '–∏'], ['ph', '—Ñ'], ['th', '—Ç'],
    ['ck', '–∫'], ['qu', '–∫–≤'], ['x', '–∫—Å'], ['w', '–≤'],
    // –ü—Ä–æ—Å—Ç—ã–µ –±—É–∫–≤—ã
    ['a', '–∞'], ['b', '–±'], ['c', '–∫'], ['d', '–¥'], ['e', '–µ'],
    ['f', '—Ñ'], ['g', '–≥'], ['h', '—Ö'], ['i', '–∏'], ['j', '–¥–∂'],
    ['k', '–∫'], ['l', '–ª'], ['m', '–º'], ['n', '–Ω'], ['o', '–æ'],
    ['p', '–ø'], ['r', '—Ä'], ['s', '—Å'], ['t', '—Ç'], ['u', '—É'],
    ['v', '–≤'], ['y', '–π'], ['z', '–∑']
  ];

  // –ß–∞—Å—Ç—ã–µ –ø–∞—Ä—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ (—Ç–æ—á–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
  // –≠—Ç–æ –¥–ª—è 100% —Ç–æ—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤, –≥–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –æ—à–∏–±–∏—Ç—å—Å—è
  const TRANSLIT_PAIRS = {
    // –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
    'protein': '–ø—Ä–æ—Ç–µ–∏–Ω',
    '–ø—Ä–æ—Ç–µ–∏–Ω': 'protein',
    'whey': '–≤–µ–π',
    '–≤–µ–π': 'whey',
    'casein': '–∫–∞–∑–µ–∏–Ω',
    '–∫–∞–∑–µ–∏–Ω': 'casein',
    'bcaa': '–±—Ü–∞–∞',
    '–±—Ü–∞–∞': 'bcaa',
    'creatine': '–∫—Ä–µ–∞—Ç–∏–Ω',
    '–∫—Ä–µ–∞—Ç–∏–Ω': 'creatine',
    'gainer': '–≥–µ–π–Ω–µ—Ä',
    '–≥–µ–π–Ω–µ—Ä': 'gainer',
    'isolate': '–∏–∑–æ–ª—è—Ç',
    '–∏–∑–æ–ª—è—Ç': 'isolate',
    'fitness': '—Ñ–∏—Ç–Ω–µ—Å',
    '—Ñ–∏—Ç–Ω–µ—Å': 'fitness',
    'sport': '—Å–ø–æ—Ä—Ç',
    '—Å–ø–æ—Ä—Ç': 'sport',

    // –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
    'topping': '—Ç–æ–ø–ø–∏–Ω–≥',
    '—Ç–æ–ø–ø–∏–Ω–≥': 'topping',
    'smoothie': '—Å–º—É–∑–∏',
    '—Å–º—É–∑–∏': 'smoothie',
    'granola': '–≥—Ä–∞–Ω–æ–ª–∞',
    '–≥—Ä–∞–Ω–æ–ª–∞': 'granola',
    'muesli': '–º—é—Å–ª–∏',
    '–º—é—Å–ª–∏': 'muesli',
    'yogurt': '–π–æ–≥—É—Ä—Ç',
    '–π–æ–≥—É—Ä—Ç': 'yogurt',
    'milk': '–º–∏–ª–∫',
    '–º–∏–ª–∫': 'milk',
    'shake': '—à–µ–π–∫',
    '—à–µ–π–∫': 'shake',
    'bar': '–±–∞—Ä',
    '–±–∞—Ä': 'bar',
    'snack': '—Å–Ω—ç–∫',
    '—Å–Ω—ç–∫': 'snack',
    'chips': '—á–∏–ø—Å—ã',
    '—á–∏–ø—Å—ã': 'chips',
    'cookie': '–∫—É–∫–∏',
    '–∫—É–∫–∏': 'cookie',
    'cookies': '–∫—É–∫–∏—Å',
    '–∫—É–∫–∏—Å': 'cookies',
    'oatmeal': '–æ–≤—Å—è–Ω–∫–∞',
    'oat': '–æ–≤—Å—è–Ω—ã–π',
    '–æ–≤—Å—è–Ω—ã–π': 'oat',
    'quinoa': '–∫–∏–Ω–æ–∞',
    '–∫–∏–Ω–æ–∞': 'quinoa',
    'hummus': '—Ö—É–º—É—Å',
    '—Ö—É–º—É—Å': 'hummus',
    'falafel': '—Ñ–∞–ª–∞—Ñ–µ–ª—å',
    '—Ñ–∞–ª–∞—Ñ–µ–ª—å': 'falafel',
    'avocado': '–∞–≤–æ–∫–∞–¥–æ',
    '–∞–≤–æ–∫–∞–¥–æ': 'avocado',
    'salmon': '—Å—ç–ª–º–æ–Ω',
    'tuna': '—Ç—É–Ω–µ—Ü',
    '—Ç—É–Ω–µ—Ü': 'tuna',
    'chicken': '—á–∏–∫–µ–Ω',
    '—á–∏–∫–µ–Ω': 'chicken',
    'beef': '–±–∏—Ñ',
    '–±–∏—Ñ': 'beef',
    'turkey': '–∏–Ω–¥–µ–π–∫–∞',
    '–∏–Ω–¥–µ–π–∫–∞': 'turkey',
    'steak': '—Å—Ç–µ–π–∫',
    '—Å—Ç–µ–π–∫': 'steak',

    // –î–æ–±–∞–≤–∫–∏
    'omega': '–æ–º–µ–≥–∞',
    '–æ–º–µ–≥–∞': 'omega',
    'vitamin': '–≤–∏—Ç–∞–º–∏–Ω',
    '–≤–∏—Ç–∞–º–∏–Ω': 'vitamin',
    'fiber': '—Ñ–∞–π–±–µ—Ä',
    '—Ñ–∞–π–±–µ—Ä': 'fiber',
    'collagen': '–∫–æ–ª–ª–∞–≥–µ–Ω',
    '–∫–æ–ª–ª–∞–≥–µ–Ω': 'collagen',
    'magnesium': '–º–∞–≥–Ω–∏–π',
    '–º–∞–≥–Ω–∏–π': 'magnesium',
    'zinc': '—Ü–∏–Ω–∫',
    '—Ü–∏–Ω–∫': 'zinc',
    'iron': '–∂–µ–ª–µ–∑–æ',
    'calcium': '–∫–∞–ª—å—Ü–∏–π',
    '–∫–∞–ª—å—Ü–∏–π': 'calcium',

    // –î–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
    'low': '–ª–æ—É',
    '–ª–æ—É': 'low',
    'high': '—Ö–∞–π',
    '—Ö–∞–π': 'high',
    'sugar': '—à—É–≥–∞—Ä',
    '—à—É–≥–∞—Ä': 'sugar',
    'free': '—Ñ—Ä–∏',
    '—Ñ—Ä–∏': 'free',
    'zero': '–∑–µ—Ä–æ',
    '–∑–µ—Ä–æ': 'zero',
    'light': '–ª–∞–π—Ç',
    '–ª–∞–π—Ç': 'light',
    'diet': '–¥–∏–µ—Ç',
    '–¥–∏–µ—Ç': 'diet',
    'organic': '–æ—Ä–≥–∞–Ω–∏–∫',
    '–æ—Ä–≥–∞–Ω–∏–∫': 'organic',
    'bio': '–±–∏–æ',
    '–±–∏–æ': 'bio',
    'eco': '—ç–∫–æ',
    '—ç–∫–æ': 'eco',
    'vegan': '–≤–µ–≥–∞–Ω',
    '–≤–µ–≥–∞–Ω': 'vegan',
    'keto': '–∫–µ—Ç–æ',
    '–∫–µ—Ç–æ': 'keto',
    'detox': '–¥–µ—Ç–æ–∫—Å',
    '–¥–µ—Ç–æ–∫—Å': 'detox',
    'slim': '—Å–ª–∏–º',
    '—Å–ª–∏–º': 'slim',
    'energy': '—ç–Ω–µ—Ä–¥–∂–∏',
    '—ç–Ω–µ—Ä–¥–∂–∏': 'energy',
    'power': '–ø–∞—É—ç—Ä',
    '–ø–∞—É—ç—Ä': 'power',
    'super': '—Å—É–ø–µ—Ä',
    '—Å—É–ø–µ—Ä': 'super',

    // –ë—Ä–µ–Ω–¥—ã –∏ —Ç–∏–ø–∏—á–Ω—ã–µ —Å–ª–æ–≤–∞
    'pro': '–ø—Ä–æ',
    '–ø—Ä–æ': 'pro',
    'plus': '–ø–ª—é—Å',
    '–ø–ª—é—Å': 'plus',
    'max': '–º–∞–∫—Å',
    '–º–∞–∫—Å': 'max',
    'ultra': '—É–ª—å—Ç—Ä–∞',
    '—É–ª—å—Ç—Ä–∞': 'ultra',
    'premium': '–ø—Ä–µ–º–∏—É–º',
    '–ø—Ä–µ–º–∏—É–º': 'premium',
    'gold': '–≥–æ–ª–¥',
    '–≥–æ–ª–¥': 'gold',
    'classic': '–∫–ª–∞—Å—Å–∏–∫',
    '–∫–ª–∞—Å—Å–∏–∫': 'classic',
    'original': '–æ—Ä–∏–¥–∂–∏–Ω–∞–ª',
    '–æ—Ä–∏–¥–∂–∏–Ω–∞–ª': 'original',
    'natural': '–Ω–∞—Ç—É—Ä–∞–ª',
    '–Ω–∞—Ç—É—Ä–∞–ª': 'natural',
    'fresh': '—Ñ—Ä–µ—à',
    '—Ñ—Ä–µ—à': 'fresh'
  };

  // –í–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è/–Ω–∞–ø–∏—Å–∞–Ω–∏—è (–¥–ª—è –Ω–µ—á—ë—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  // –ö–ª—é—á - –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞, –∑–Ω–∞—á–µ–Ω–∏—è - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
  const SPELLING_VARIANTS = {
    '—Ñ–∏—Ç–Ω–µ—Å': ['—Ñ–∏–Ω—Ç–µ—Å', '—Ñ–∏—Ç–Ω–µ—Å—Å', '—Ñ–∏—Ç–Ω–µ—Åc', 'fitness', 'fintess', 'fitnes'],
    '–ø—Ä–æ—Ç–µ–∏–Ω': ['–ø—Ä–æ—Ç—ç–∏–Ω', 'protein', 'protien', 'proteen', '–ø—Ä—É—Ç–µ–∏–Ω'],
    '—Ç–æ–ø–ø–∏–Ω–≥': ['—Ç–æ–ø–∏–Ω–≥', 'topping', 'toping', '—Ç–æ–ø–ø–∏–Ω–∫'],
    '–≥—Ä–∞–Ω–æ–ª–∞': ['–≥—Ä–æ–Ω–æ–ª–∞', 'granola', 'granolla', '–≥—Ä–∞–Ω–Ω–æ–ª–∞'],
    '—Å–º—É–∑–∏': ['—Å–º—É–∑–∑–∏', 'smoothie', 'smoothi', '—Å–º—É—Å–∏'],
    '–π–æ–≥—É—Ä—Ç': ['–π–æ–≥—É—Ä—Ç', '–π–æ–≥—É—Ç', 'yogurt', 'yoghurt', '–π–æ–≥—Ä—É—Ç'],
    '–º—é—Å–ª–∏': ['–º—é—Å–ª–∏', '–º—É—Å–ª–∏', 'muesli', 'musli', 'myusli'],
    '–∫—Ä–µ–∞—Ç–∏–Ω': ['–∫—Ä–µ–æ—Ç–∏–Ω', 'creatine', 'creatin', 'kreatine'],
    '–∫–æ–ª–ª–∞–≥–µ–Ω': ['–∫–æ–ª–∞–≥–µ–Ω', 'collagen', 'colagen', '–∫–∞–ª–∞–≥–µ–Ω'],
    '–∫–∞–∑–µ–∏–Ω': ['–∫–æ–∑–µ–∏–Ω', 'casein', 'casien', '–∫–∞–∑–∏–µ–Ω'],
    '–∫–∞–ª—å—Ü–∏–π': ['–∫–∞–ª—Ü–∏–π', 'calcium', 'kalsiy', '–∫–∞–ª—å—Ü—ã–π'],
    '–º–∞–≥–Ω–∏–π': ['–º–∞–≥–Ω–∏', 'magnesium', 'magniy', '–º–∞–≥–Ω–µ–∑–∏–π'],
    '–æ–º–µ–≥–∞': ['–æ–º–µ–≥–æ', 'omega', '–æmega', '–∞–º–µ–≥–∞'],
    '–≤–∏—Ç–∞–º–∏–Ω': ['–≤–∏—Ç–æ–º–∏–Ω', 'vitamin', 'vitamen', '–≤–∏—Ç–æ–º–µ–Ω'],
    '—ç–Ω–µ—Ä–≥–∏—è': ['—ç–Ω–µ—Ä–¥–∂–∏', 'energy', 'energi', '—ç–Ω–µ—Ä–≥–∏—è'],
    '—à–æ–∫–æ–ª–∞–¥': ['—á–æ–∫–æ–ª–∞–¥', 'chocolate', 'chocolat', '—à–∞–∫–æ–ª–∞–¥'],
    '–∫–∞—Ä–∞–º–µ–ª—å': ['–∫–∞—Ä–∞–º–µ–ª', 'caramel', 'karamel', '–∫–∞—Ä–æ–º–µ–ª—å'],
    '–≤–∞–Ω–∏–ª—å': ['–≤–∞–Ω–∏–ª', 'vanilla', 'vanila', '–≤–∞–Ω–∏–ª–∞'],
    '–∫–ª—É–±–Ω–∏–∫–∞': ['–∫–ª—É–±–Ω–∫–∞', 'strawberry', '–∫–ª—é–±–Ω–∏–∫–∞'],
    '–±–∞–Ω–∞–Ω': ['banan', 'banana', '–±–∞–Ω–Ω–∞'],
    '–∫–æ–∫–æ—Å': ['–∫–æ–∫–∞—Å', 'coconut', 'cocnut', '–∫–æ–∫–æ—Å—Å'],
    '–∞—Ä–∞—Ö–∏—Å': ['–∞—Ä–æ—Ö–∏—Å', 'peanut', 'arachis', '–∞—Ä–∞—Ö–∏–∑'],
    '–º–∏–Ω–¥–∞–ª—å': ['–º–∏–Ω–¥–∞–ª', 'almond', 'mindal', '–º–∏–Ω—Ç–∞–ª—å']
  };

  // === üÜï QWERTY ‚Üî –ô–¶–£–ö–ï–ù (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã) ===
  const QWERTY_TO_CYRILLIC = {
    'q': '–π', 'w': '—Ü', 'e': '—É', 'r': '–∫', 't': '–µ', 'y': '–Ω', 'u': '–≥',
    'i': '—à', 'o': '—â', 'p': '–∑', '[': '—Ö', ']': '—ä', 'a': '—Ñ', 's': '—ã',
    'd': '–≤', 'f': '–∞', 'g': '–ø', 'h': '—Ä', 'j': '–æ', 'k': '–ª', 'l': '–¥',
    ';': '–∂', "'": '—ç', 'z': '—è', 'x': '—á', 'c': '—Å', 'v': '–º', 'b': '–∏',
    'n': '—Ç', 'm': '—å', ',': '–±', '.': '—é', '/': '.'
  };

  const CYRILLIC_TO_QWERTY = Object.fromEntries(
    Object.entries(QWERTY_TO_CYRILLIC).map(([k, v]) => [v, k])
  );

  // === üÜï –°–û–ö–†–ê–©–ï–ù–ò–Ø –ò –ê–ë–ë–†–ï–í–ò–ê–¢–£–†–´ ===
  const ABBREVIATIONS = {
    // –ñ–∏—Ä–Ω–æ—Å—Ç—å
    '–±/–∂': ['–±–µ–∑ –∂–∏—Ä–∞', '–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–Ω–µ–∂–∏—Ä–Ω—ã–π', '0% –∂–∏—Ä–Ω–æ—Å—Ç–∏'],
    '–± –∂': ['–±–µ–∑ –∂–∏—Ä–∞', '–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π'],
    '–±–∂': ['–±–µ–∑ –∂–∏—Ä–∞', '–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π'],
    '0%': ['–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–Ω—É–ª–µ–≤–æ–π –∂–∏—Ä–Ω–æ—Å—Ç–∏', '–±–µ–∑ –∂–∏—Ä–∞'],
    '0.5%': ['–ø–æ–ª—É–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π', '–º–∞–ª–æ–∂–∏—Ä–Ω—ã–π'],
    '1%': ['–æ–¥–Ω–æ–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π', '–º–∞–ª–æ–∂–∏—Ä–Ω—ã–π'],
    '2%': ['–¥–≤—É—Ö–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π'],
    '5%': ['–ø—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π'],
    '9%': ['–¥–µ–≤—è—Ç–∏–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π'],

    // –ü–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    '–∫–∫–∞–ª': ['–∫–∞–ª–æ—Ä–∏–∏', '–∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å', '—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å'],
    '–∫–∫': ['–∫–∞–ª–æ—Ä–∏–∏', '–∫–∫–∞–ª'],
    '–±–∂—É': ['–±–µ–ª–∫–∏ –∂–∏—Ä—ã —É–≥–ª–µ–≤–æ–¥—ã', '–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã', '–º–∞–∫—Ä–æ—Å—ã'],
    '–ø–ø': ['–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ', '–∑–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ', '–ø–æ–ª–µ–∑–Ω—ã–π'],
    '–∑–æ–∂': ['–∑–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏', '–∑–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ'],

    // –†–∞–∑–º–µ—Ä—ã
    '–º–ª': ['–º–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤', '–º–∏–ª–ª–∏–ª–∏—Ç—Ä'],
    '–≥—Ä': ['–≥—Ä–∞–º–º', '–≥—Ä–∞–º–º–æ–≤'],
    '–∫–≥': ['–∫–∏–ª–æ–≥—Ä–∞–º–º', '–∫–∏–ª–æ–≥—Ä–∞–º–º–æ–≤'],
    '–ª': ['–ª–∏—Ç—Ä', '–ª–∏—Ç—Ä–æ–≤'],
    '—à—Ç': ['—à—Ç—É–∫', '—à—Ç—É–∫–∞'],

    // –¢–∏–ø—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    '–æ–±': ['–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π'],
    '–Ω–∂': ['–Ω–µ–∂–∏—Ä–Ω—ã–π', '–º–∞–ª–æ–∂–∏—Ä–Ω—ã–π'],
    '–¥–æ–º': ['–¥–æ–º–∞—à–Ω–∏–π', '–¥–æ–º–∞—à–Ω–µ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è'],
    '—Å–≤': ['—Å–≤–µ–∂–∏–π'],
    '–∑–∞–º': ['–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π', '–∑–∞–º–æ—Ä–æ–∑–∫–∞'],
    '–∫–æ–Ω—Å': ['–∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', '–∫–æ–Ω—Å–µ—Ä–≤—ã'],
    '–∫–æ–ø': ['–∫–æ–ø—á–µ–Ω—ã–π', '–∫–æ–ø—á—ë–Ω—ã–π'],
    '–≤–∞—Ä': ['–≤–∞—Ä–µ–Ω—ã–π', '–≤–∞—Ä—ë–Ω—ã–π', '–æ—Ç–≤–∞—Ä–Ω–æ–π'],
    '–∂–∞—Ä': ['–∂–∞—Ä–µ–Ω—ã–π', '–∂–∞—Ä–µ–Ω–Ω—ã–π'],
    '–∑–∞–ø': ['–∑–∞–ø–µ—á–µ–Ω–Ω—ã–π', '–∑–∞–ø–µ—á—ë–Ω–Ω—ã–π'],
    '—Å—ã—Ä': ['—Å—ã—Ä–æ–π'],
    '—Å—É—à': ['—Å—É—à–µ–Ω—ã–π', '—Å—É—à—ë–Ω—ã–π'],
    '–º–∞—Ä': ['–º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–π'],
    '—Å–æ–ª': ['—Å–æ–ª–µ–Ω—ã–π', '—Å–æ–ª—ë–Ω—ã–π', '–º–∞–ª–æ—Å–æ–ª—å–Ω—ã–π'],

    // –°–ø–æ—Ä—Ç–ø–∏—Ç
    '–∏–∑–æ': ['–∏–∑–æ–ª—è—Ç', '–∏–∑–æ–ª—è—Ç –ø—Ä–æ—Ç–µ–∏–Ω–∞'],
    '–∫–æ–Ω—Ü': ['–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç'],
    '–≥–∏–¥—Ä–æ': ['–≥–∏–¥—Ä–æ–ª–∏–∑–∞—Ç'],

    // –ú–∞—Ä–∫–∏/—Ç–∏–ø—ã
    '–±/–ª': ['–±–µ–∑ –ª–∞–∫—Ç–æ–∑—ã', '–±–µ–∑–ª–∞–∫—Ç–æ–∑–Ω—ã–π'],
    '–±/–≥': ['–±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞', '–±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤—ã–π'],
    '–±/—Å': ['–±–µ–∑ —Å–∞—Ö–∞—Ä–∞', '–Ω–µ—Å–ª–∞–¥–∫–∏–π'],
    '–Ω–∏–∑–∫–æ–∫–∞–ª': ['–Ω–∏–∑–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π', '–¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–π'],
    '–≤—ã—Å–∫–æ–∫–æ–±–µ–ª': ['–≤—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤—ã–π', '–ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π']
  };

  // === üÜï –ï–î–ò–ù–ò–¶–´ –ò–ó–ú–ï–†–ï–ù–ò–Ø (v2.5.0) ===
  const UNIT_CONVERSION = {
    '–∫–≥': { base: '–≥', factor: 1000 },
    'kg': { base: '–≥', factor: 1000 },
    '–≥': { base: '–≥', factor: 1 },
    '–≥—Ä': { base: '–≥', factor: 1 },
    'g': { base: '–≥', factor: 1 },
    '–ª': { base: '–º–ª', factor: 1000 },
    'l': { base: '–º–ª', factor: 1000 },
    '–º–ª': { base: '–º–ª', factor: 1 },
    'ml': { base: '–º–ª', factor: 1 },
    '—à—Ç': { base: '—à—Ç', factor: 1 },
    'pcs': { base: '—à—Ç', factor: 1 }
  };

  // === üÜï –ö–ê–¢–ï–ì–û–†–ò–ò –ü–†–û–î–£–ö–¢–û–í (–¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É) ===
  const CATEGORY_KEYWORDS = {
    '–º–æ–ª–æ—á–Ω—ã–µ': ['–º–æ–ª–æ–∫–æ', '—Ç–≤–æ—Ä–æ–≥', '—Å—ã—Ä', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '—Å–º–µ—Ç–∞–Ω–∞', '—Å–ª–∏–≤–∫–∏', '—Ä—è–∂–µ–Ω–∫–∞', '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∞', '–º–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ'],
    '–º—è—Å–æ': ['–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '–∫—É—Ä–∏—Ü–∞', '–∏–Ω–¥–µ–π–∫–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '—Ç–µ–ª—è—Ç–∏–Ω–∞', '–∫—Ä–æ–ª–∏–∫', '—É—Ç–∫–∞', '–≥—É—Å—å', '—Ñ–∞—Ä—à', '–∫–æ—Ç–ª–µ—Ç–∞', '—Å—Ç–µ–π–∫', '—Ñ–∏–ª–µ', '–≥—Ä—É–¥–∫–∞', '–±–µ–¥—Ä–æ', '–æ–∫–æ—Ä–æ–∫', '–≤–µ—Ç—á–∏–Ω–∞', '–±–µ–∫–æ–Ω', '–∫–æ–ª–±–∞—Å–∞', '—Å–æ—Å–∏—Å–∫–∏'],
    '—Ä—ã–±–∞': ['—Ä—ã–±–∞', '–ª–æ—Å–æ—Å—å', '—Å–µ–º–≥–∞', '—Ñ–æ—Ä–µ–ª—å', '—Ç—É–Ω–µ—Ü', '—Ç—Ä–µ—Å–∫–∞', '–º–∏–Ω—Ç–∞–π', '—Å–∫—É–º–±—Ä–∏—è', '—Å–µ–ª—å–¥—å', '–≥–æ—Ä–±—É—à–∞', '–∫–µ—Ç–∞', '—Å—É–¥–∞–∫', '–æ–∫—É–Ω—å', '–∫–∞—Ä–ø', '—â—É–∫–∞'],
    '–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã': ['–∫—Ä–µ–≤–µ—Ç–∫–∏', '–∫–∞–ª—å–º–∞—Ä', '–º–∏–¥–∏–∏', '—É—Å—Ç—Ä–∏—Ü—ã', '–∫—Ä–∞–±—ã', '–∏–∫—Ä–∞', '–º–æ—Ä—Å–∫–æ–π –∫–æ–∫—Ç–µ–π–ª—å', '–æ—Å—å–º–∏–Ω–æ–≥'],
    '–æ–≤–æ—â–∏': ['–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–º–æ—Ä–∫–æ–≤—å', '–ª—É–∫', '—á–µ—Å–Ω–æ–∫', '–∫–∞–ø—É—Å—Ç–∞', '–±—Ä–æ–∫–∫–æ–ª–∏', '—Ü–≤–µ—Ç–Ω–∞—è –∫–∞–ø—É—Å—Ç–∞', '–ø–æ–º–∏–¥–æ—Ä', '–æ–≥—É—Ä–µ—Ü', '–ø–µ—Ä–µ—Ü', '–±–∞–∫–ª–∞–∂–∞–Ω', '–∫–∞–±–∞—á–æ–∫', '—Ç—ã–∫–≤–∞', '—Å–≤–µ–∫–ª–∞', '—Ä–µ–¥–∏—Å', '—Å–µ–ª—å–¥–µ—Ä–µ–π', '—à–ø–∏–Ω–∞—Ç', '—Å–∞–ª–∞—Ç'],
    '—Ñ—Ä—É–∫—Ç—ã': ['—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–≥—Ä—É—à–∞', '–ø–µ—Ä—Å–∏–∫', '–∞–±—Ä–∏–∫–æ—Å', '—Å–ª–∏–≤–∞', '–≤–∏–Ω–æ–≥—Ä–∞–¥', '–∫–∏–≤–∏', '–º–∞–Ω–≥–æ', '–∞–Ω–∞–Ω–∞—Å', '–∞—Ä–±—É–∑', '–¥—ã–Ω—è', '–≥—Ä–∞–Ω–∞—Ç', '—Ö—É—Ä–º–∞'],
    '—è–≥–æ–¥—ã': ['–∫–ª—É–±–Ω–∏–∫–∞', '–º–∞–ª–∏–Ω–∞', '—á–µ—Ä–Ω–∏–∫–∞', '–≥–æ–ª—É–±–∏–∫–∞', '–µ–∂–µ–≤–∏–∫–∞', '—Å–º–æ—Ä–æ–¥–∏–Ω–∞', '–∫—Ä—ã–∂–æ–≤–Ω–∏–∫', '–≤–∏—à–Ω—è', '—á–µ—Ä–µ—à–Ω—è', '–∫–ª—é–∫–≤–∞', '–±—Ä—É—Å–Ω–∏–∫–∞'],
    '–∫—Ä—É–ø—ã': ['—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–æ–≤—Å—è–Ω–∫–∞', '–ø—à–µ–Ω–æ', '–ø–µ—Ä–ª–æ–≤–∫–∞', '–±—É–ª–≥—É—Ä', '–∫—É—Å–∫—É—Å', '–∫–∏–Ω–æ–∞', '–º–∞–Ω–∫–∞', '–∫—É–∫—É—Ä—É–∑–Ω–∞—è –∫—Ä—É–ø–∞', '—è—á–Ω–µ–≤–∞—è'],
    '–º–∞–∫–∞—Ä–æ–Ω—ã': ['–º–∞–∫–∞—Ä–æ–Ω—ã', '—Å–ø–∞–≥–µ—Ç—Ç–∏', '–ø–∞—Å—Ç–∞', '–ª–∞–ø—à–∞', '–≤–µ—Ä–º–∏—à–µ–ª—å', '–ø–µ–Ω–Ω–µ', '—Ñ—É–∑–∏–ª–ª–∏', '—Ñ–∞—Ä—Ñ–∞–ª–ª–µ'],
    '—Ö–ª–µ–±': ['—Ö–ª–µ–±', '–±–∞—Ç–æ–Ω', '–±—É–ª–∫–∞', '–ª–∞–≤–∞—à', '–ø–∏—Ç–∞', '–±–∞–≥–µ—Ç', '—á–∏–∞–±–∞—Ç—Ç–∞', '—Ö–ª–µ–±—Ü—ã', '—Ç–æ—Å—Ç', '—Å—É—Ö–∞—Ä–∏'],
    '–≤—ã–ø–µ—á–∫–∞': ['–ø–µ—á–µ–Ω—å–µ', '–ø–∏—Ä–æ–≥', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–∂–Ω–æ–µ', '–∫—Ä—É–∞—Å—Å–∞–Ω', '–±—É–ª–æ—á–∫–∞', '–∫–µ–∫—Å', '–º–∞—Ñ—Ñ–∏–Ω', '—Ä—É–ª–µ—Ç', '—ç–∫–ª–µ—Ä'],
    '—Å–ª–∞–¥–æ—Å—Ç–∏': ['—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–º–∞—Ä–º–µ–ª–∞–¥', '–∑–µ—Ñ–∏—Ä', '–ø–∞—Å—Ç–∏–ª–∞', '—Ö–∞–ª–≤–∞', '–º–µ–¥', '–≤–∞—Ä–µ–Ω—å–µ', '–¥–∂–µ–º'],
    '–æ—Ä–µ—Ö–∏': ['–º–∏–Ω–¥–∞–ª—å', '–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '–∞—Ä–∞—Ö–∏—Å', '—Ñ–∏—Å—Ç–∞—à–∫–∏', '–∫–µ–¥—Ä–æ–≤—ã–µ –æ—Ä–µ—Ö–∏', '–º–∞–∫–∞–¥–∞–º–∏—è', '–ø–µ–∫–∞–Ω'],
    '–Ω–∞–ø–∏—Ç–∫–∏': ['–≤–æ–¥–∞', '—Å–æ–∫', '—á–∞–π', '–∫–æ—Ñ–µ', '–∫–æ–º–ø–æ—Ç', '–º–æ—Ä—Å', '–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—Å–º—É–∑–∏', '–∫–æ–∫—Ç–µ–π–ª—å'],
    '—Å–ø–æ—Ä—Ç–ø–∏—Ç': ['–ø—Ä–æ—Ç–µ–∏–Ω', '–≥–µ–π–Ω–µ—Ä', 'bcaa', '–∫—Ä–µ–∞—Ç–∏–Ω', '–∏–∑–æ–ª—è—Ç', '–∫–∞–∑–µ–∏–Ω', '–∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã', 'l-–∫–∞—Ä–Ω–∏—Ç–∏–Ω', '–ø—Ä–µ–¥—Ç—Ä–µ–Ω–∏–∫', '–∫–æ–ª–ª–∞–≥–µ–Ω']
  };

  // üÜï v2.6.0 –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º
  const NUTRIENT_RULES = {
    'high_protein': {
      keywords: ['–≤—ã—Å–æ–∫–æ–±–µ–ª–∫–æ–≤—ã–π', '–º–Ω–æ–≥–æ –±–µ–ª–∫–∞', '–ø—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π', 'high protein'],
      check: (p) => (p.protein100 || 0) >= 15
    },
    'low_carb': {
      keywords: ['–Ω–∏–∑–∫–æ—É–≥–ª–µ–≤–æ–¥–Ω—ã–π', '–º–∞–ª–æ —É–≥–ª–µ–π', 'low carb', '–±–µ–∑ —É–≥–ª–µ–π'],
      check: (p) => (p.carbs100 || 0) <= 10
    },
    'sugar_free': {
      keywords: ['–±–µ–∑ —Å–∞—Ö–∞—Ä–∞', 'sugar free', '0 —Å–∞—Ö–∞—Ä–∞', 'zero sugar'],
      check: (p) => (p.simple100 || 0) <= 2
    },
    'keto': {
      keywords: ['–∫–µ—Ç–æ', 'keto', 'lchf'],
      check: (p) => (p.carbs100 || 0) <= 10 && (p.fat100 || 0) >= 10
    },
    'low_fat': {
      keywords: ['–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–±–µ–∑ –∂–∏—Ä–∞', 'low fat', '0%'],
      check: (p) => (p.fat100 || 0) <= 2
    }
  };

  // üÜï v2.6.0 –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–≤—Ä–µ–º—è –¥–Ω—è, —Å–∏—Ç—É–∞—Ü–∏—è)
  const CONTEXT_RULES = {
    'breakfast': {
      keywords: ['–∑–∞–≤—Ç—Ä–∞–∫', 'breakfast', '—É—Ç—Ä–æ'],
      boostCategories: ['–∫—Ä—É–ø—ã', '–º–æ–ª–æ—á–Ω—ã–µ', '—Ñ—Ä—É–∫—Ç—ã', '—Ö–ª–µ–±', '–≤—ã–ø–µ—á–∫–∞'],
      boostProducts: ['–æ–≤—Å—è–Ω–∫–∞', '—è–π—Ü–æ', '—Ç–≤–æ—Ä–æ–≥', '–∫–æ—Ñ–µ', '–æ–º–ª–µ—Ç']
    },
    'gym': {
      keywords: ['–∑–∞–ª', 'gym', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '–ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏'],
      boostCategories: ['—Å–ø–æ—Ä—Ç–ø–∏—Ç', '–º—è—Å–æ'],
      check: (p) => (p.protein100 || 0) >= 20
    }
  };

  // === üÜï v2.7.0 –°–õ–û–í–ê–†–¨ –ë–†–ï–ù–î–û–í ===
  const BRAND_DICTIONARY = {
    // –ú–æ–ª–æ—á–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
    'danone': ['–¥–∞–Ω–æ–Ω', 'danone', '–¥—ç–Ω–æ–Ω', '–¥–µ–Ω–æ–Ω'],
    '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ': ['–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ', 'prostokvashino', '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à'],
    '–∞–∫—Ç–∏–≤–∏–∞': ['–∞–∫—Ç–∏–≤–∏–∞', 'activia', '–∞–∫—Ç–∏–≤–∞'],
    '—á—É–¥–æ': ['—á—É–¥–æ', 'chudo'],
    '–¥–æ–º–∏–∫ –≤ –¥–µ—Ä–µ–≤–Ω–µ': ['–¥–æ–º–∏–∫ –≤ –¥–µ—Ä–µ–≤–Ω–µ', '–¥–æ–º–∏–∫', '–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏–π'],
    'parmalat': ['–ø–∞—Ä–º–∞–ª–∞—Ç', 'parmalat'],
    'president': ['–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç', 'president', 'prezident'],
    'valio': ['–≤–∞–ª–∏–æ', 'valio'],
    'viola': ['–≤–∏–æ–ª–∞', 'viola'],
    'hochland': ['—Ö–æ—Ö–ª–∞–Ω–¥', 'hochland', 'hohland'],
    'svalia': ['—Å–≤–∞–ª–∏—è', 'svalia'],
    '–∞–≥—É—à–∞': ['–∞–≥—É—à–∞', 'agusha'],
    'epica': ['—ç–ø–∏–∫–∞', 'epica', 'epika'],

    // –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
    'optimum nutrition': ['–æ–ø—Ç–∏–º—É–º', 'optimum', 'on'],
    'myprotein': ['–º–∞–π–ø—Ä–æ—Ç–µ–∏–Ω', 'myprotein', 'my protein'],
    'bsn': ['–±—Å–Ω', 'bsn'],
    'dymatize': ['–¥–∏–º–∞—Ç–∞–π–∑', 'dymatize', 'dimatize'],
    'muscletech': ['–º–∞—Å–ª—Ç–µ–∫', 'muscletech', 'muscle tech'],

    // –ù–∞–ø–∏—Ç–∫–∏
    'coca-cola': ['–∫–æ–∫–∞-–∫–æ–ª–∞', '–∫–æ–ª–∞', 'coca cola', 'cocacola'],
    'pepsi': ['–ø–µ–ø—Å–∏', 'pepsi'],
    'sprite': ['—Å–ø—Ä–∞–π—Ç', 'sprite'],
    'fanta': ['—Ñ–∞–Ω—Ç–∞', 'fanta'],
    'lipton': ['–ª–∏–ø—Ç–æ–Ω', 'lipton'],
    'nescafe': ['–Ω–µ—Å–∫–∞—Ñ–µ', 'nescafe', '–Ω–µ—Å–∫–∞—Ñ—ç'],

    // –ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∏–µ
    'nestle': ['–Ω–µ—Å—Ç–ª–µ', 'nestle', 'nestl√©'],
    'milka': ['–º–∏–ª–∫–∞', 'milka'],
    'oreo': ['–æ—Ä–µ–æ', 'oreo'],
    'snickers': ['—Å–Ω–∏–∫–µ—Ä—Å', 'snickers'],
    'mars': ['–º–∞—Ä—Å', 'mars'],
    'twix': ['—Ç–≤–∏–∫—Å', 'twix'],
    'bounty': ['–±–∞—É–Ω—Ç–∏', 'bounty'],
    'kinder': ['–∫–∏–Ω–¥–µ—Ä', 'kinder'],
    'raffaello': ['—Ä–∞—Ñ—Ñ–∞—ç–ª–ª–æ', 'raffaello', '—Ä–∞—Ñ–∞—ç–ª–ª–æ'],
    'ferrero': ['—Ñ–µ—Ä—Ä–µ—Ä–æ', 'ferrero', 'ferrero rocher'],

    // –ö—Ä—É–ø—ã/–ö–∞—à–∏
    'makfa': ['–º–∞–∫—Ñ–∞', 'makfa'],
    '–º–∏—Å—Ç—Ä–∞–ª—å': ['–º–∏—Å—Ç—Ä–∞–ª—å', 'mistral'],
    '—É–≤–µ–ª–∫–∞': ['—É–≤–µ–ª–∫–∞', 'uvelka'],
    'heinz': ['—Ö–∞–π–Ω—Ü', 'heinz'],
    'nesquik': ['–Ω–µ—Å–∫–≤–∏–∫', 'nesquik']
  };

  // === üÜï v2.7.0 –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–ò–ï –ö–õ–ê–°–¢–ï–†–´ (ML-lite) ===
  const SEMANTIC_CLUSTERS = {
    // –ü–æ—Ö–æ–∂–∏–µ –ø–æ —Å–º—ã—Å–ª—É –ø—Ä–æ–¥—É–∫—Ç—ã
    '–∫–∞—à–∞': ['–æ–≤—Å—è–Ω–∫–∞', '–≥—Ä–µ—á–∫–∞', '—Ä–∏—Å', '–ø—à–µ–Ω–æ', '–º–∞–Ω–∫–∞', '–±—É–ª–≥—É—Ä', '–∫–∏–Ω–æ–∞', '–ø–µ—Ä–ª–æ–≤–∫–∞'],
    '—É—Ç—Ä–µ–Ω–Ω—è—è –µ–¥–∞': ['–æ–≤—Å—è–Ω–∫–∞', '—Ç–≤–æ—Ä–æ–≥', '—è–π—Ü–∞', '–æ–º–ª–µ—Ç', '–π–æ–≥—É—Ä—Ç', '–º—é—Å–ª–∏', '–≥—Ä–∞–Ω–æ–ª–∞', '–∫–∞—à–∞'],
    '–±–µ–ª–∫–æ–≤–∞—è –µ–¥–∞': ['–∫—É—Ä–∏—Ü–∞', '–≥–æ–≤—è–¥–∏–Ω–∞', '—Ä—ã–±–∞', '—è–π—Ü–∞', '—Ç–≤–æ—Ä–æ–≥', '–ø—Ä–æ—Ç–µ–∏–Ω', '–∏–Ω–¥–µ–π–∫–∞'],
    '–ª–µ–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å': ['—è–±–ª–æ–∫–æ', '–±–∞–Ω–∞–Ω', '–π–æ–≥—É—Ä—Ç', '–æ—Ä–µ—Ö–∏', '—Ö–ª–µ–±—Ü—ã', '—Ç–≤–æ—Ä–æ–∂–æ–∫'],
    '–¥–∏–µ—Ç–∏—á–µ—Å–∫–æ–µ': ['—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π', '–∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', '–æ–≤–æ—â–∏', '—Ä—ã–±–∞', '–≥—Ä–µ—á–∫–∞'],
    '—Å–ª–∞–¥–∫–æ–µ': ['—à–æ–∫–æ–ª–∞–¥', '–∫–æ–Ω—Ñ–µ—Ç—ã', '–ø–µ—á–µ–Ω—å–µ', '—Ç–æ—Ä—Ç', '–ø–∏—Ä–æ–∂–Ω–æ–µ', '–º–æ—Ä–æ–∂–µ–Ω–æ–µ', '–∑–µ—Ñ–∏—Ä'],
    '–Ω–∞–ø–∏—Ç–∫–∏': ['–≤–æ–¥–∞', '—á–∞–π', '–∫–æ—Ñ–µ', '—Å–æ–∫', '–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '–∫–æ–º–ø–æ—Ç', '—Å–º—É–∑–∏', '–∫–æ–ª–∞'],
    '—á—Ç–æ –ø–æ–ø–∏—Ç—å': ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—á–∞–π', '–∫–æ—Ñ–µ', '—Å–æ–∫', '–≤–æ–¥–∞', '–∫–æ–ª–∞', '–∫–æ–º–ø–æ—Ç', '–∫–∞–∫–∞–æ'],
    '—á—Ç–æ –≤—ã–ø–∏—Ç—å': ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—á–∞–π', '–∫–æ—Ñ–µ', '—Å–æ–∫', '–≤–æ–¥–∞', '–∫–æ–ª–∞', '–∫–æ–º–ø–æ—Ç'],
    '–∑–¥–æ—Ä–æ–≤–∞—è –µ–¥–∞': ['–∞–≤–æ–∫–∞–¥–æ', '–±—Ä–æ–∫–∫–æ–ª–∏', '—à–ø–∏–Ω–∞—Ç', '–ª–æ—Å–æ—Å—å', '–∫–∏–Ω–æ–∞', '–æ—Ä–µ—Ö–∏', '—è–≥–æ–¥—ã'],
    '–±—ã—Å—Ç—Ä–∞—è –µ–¥–∞': ['—è–π—Ü–∞', '—Ö–ª–µ–±', '—Å—ã—Ä', '–∫–æ–ª–±–∞—Å–∞', '–π–æ–≥—É—Ä—Ç', '–±–∞–Ω–∞–Ω', '–æ—Ä–µ—Ö–∏'],
    '—É–∂–∏–Ω': ['—Ä—ã–±–∞', '–æ–≤–æ—â–∏', '—Å–∞–ª–∞—Ç', '–∫—É—Ä–∏—Ü–∞', '–æ–º–ª–µ—Ç', '—Ç–≤–æ—Ä–æ–≥'],
    '–≥–∞—Ä–Ω–∏—Ä': ['—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '–º–∞–∫–∞—Ä–æ–Ω—ã', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–±—É–ª–≥—É—Ä', '–∫—É—Å–∫—É—Å'],
    '–º–æ–ª–æ—á–∫–∞': ['–º–æ–ª–æ–∫–æ', '–∫–µ—Ñ–∏—Ä', '—Ç–≤–æ—Ä–æ–≥', '–π–æ–≥—É—Ä—Ç', '—Å–º–µ—Ç–∞–Ω–∞', '—Å—ã—Ä', '—Ä—è–∂–µ–Ω–∫–∞']
  };

  // === üÜï v2.7.0 –£–ú–ù–´–ï –ü–û–î–°–ö–ê–ó–ö–ò ===
  const SMART_SUGGESTIONS_CONFIG = {
    emptyResultTips: [
      { condition: 'keyboard_layout', message: 'üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—Ä—É—Å/eng)' },
      { condition: 'too_specific', message: 'üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ—Ä–æ—á–µ: ¬´—Ç–≤–æ—Ä–æ–≥¬ª –≤–º–µ—Å—Ç–æ ¬´—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π 0% –¥–æ–º–∏–∫¬ª' },
      { condition: 'typo', message: 'üí° –í–æ–∑–º–æ–∂–Ω–æ, –≤ —Å–ª–æ–≤–µ –æ–ø–µ—á–∞—Ç–∫–∞' },
      { condition: 'category', message: 'üí° –ü–æ–∏—â–∏—Ç–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –º–æ–ª–æ—á–Ω—ã–µ, –º—è—Å–æ, –∫—Ä—É–ø—ã' }
    ],
    popularSearches: ['—Ç–≤–æ—Ä–æ–≥', '–∫—É—Ä–∏—Ü–∞', '—è–π—Ü–∞', '–º–æ–ª–æ–∫–æ', '–æ–≤—Å—è–Ω–∫–∞', '–≥—Ä–µ—á–∫–∞', '—Ä–∏—Å', '–±–∞–Ω–∞–Ω', '—è–±–ª–æ–∫–æ', '—Å—ã—Ä']
  };

  // === üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ===
  let userProductStats = new Map(); // product_id ‚Üí { count, lastUsed }
  let _statsSaveTimer = null;
  const USER_STATS_KEY = 'heys_product_usage_stats';
  const USER_STATS_MIGRATED_KEY = 'heys_product_usage_stats_migrated';
  const USER_STATS_SYNC_KEY = 'heys_product_usage_stats_last_sync';
  const USER_STATS_MAX_AGE_DAYS = 60;

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
   */
  function trackProductUsage(productId) {
    if (!CONFIG.enablePersonalization || !productId) return;
    const idKey = String(productId);
    const stats = userProductStats.get(idKey) || { count: 0, lastUsed: 0 };
    stats.count++;
    stats.lastUsed = Date.now();
    userProductStats.set(idKey, stats);

    try {
      if (HEYS.store?.isHiddenProduct?.(idKey)) {
        HEYS.store.unhideProduct?.(idKey);
      }
    } catch (e) { /* ignore */ }

    // –ù–µ –ø–∏—à–µ–º –≤ storage –Ω–∞ –∫–∞–∂–¥—ã–π –∫–ª–∏–∫ ‚Äî –¥–µ–±–∞—É–Ω—Å
    if (_statsSaveTimer) clearTimeout(_statsSaveTimer);
    _statsSaveTimer = setTimeout(() => {
      saveUserStats();
      _statsSaveTimer = null;
    }, 500);
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±—É—Å—Ç –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ (0-20 –±–∞–ª–ª–æ–≤)
   */
  function getPersonalBoost(productId) {
    if (!CONFIG.enablePersonalization || !productId) return 0;
    const stats = userProductStats.get(String(productId));
    if (!stats) return 0;

    // –§–æ—Ä–º—É–ª–∞: —á–∞—Å—Ç–æ—Ç–∞ √ó —Å–≤–µ–∂–µ—Å—Ç—å
    const frequencyBoost = Math.min(stats.count * 2, 10); // max 10
    const daysSinceUse = (Date.now() - stats.lastUsed) / (1000 * 60 * 60 * 24);
    const recencyBoost = Math.max(0, 10 - daysSinceUse); // max 10, —É–±—ã–≤–∞–µ—Ç —Å –∫–∞–∂–¥—ã–º –¥–Ω—ë–º

    return Math.round(frequencyBoost + recencyBoost * 0.5);
  }

  /**
   * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ localStorage
   */
  function loadUserStats() {
    try {
      // Prefer HEYS.store (cloud sync), then HEYS.utils.lsGet, fallback to localStorage
      const storedObj = (HEYS.store && HEYS.store.get)
        ? HEYS.store.get(USER_STATS_KEY, null)
        : (HEYS.utils && HEYS.utils.lsGet)
          ? HEYS.utils.lsGet(USER_STATS_KEY, null)
          : (localStorage.getItem(USER_STATS_KEY) ? JSON.parse(localStorage.getItem(USER_STATS_KEY)) : null);

      if (storedObj && typeof storedObj === 'object') {
        // –ö–ª—é—á–∏ —Ö—Ä–∞–Ω–∏–º —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (productId –º–æ–∂–µ—Ç –±—ã—Ç—å number/string)
        userProductStats = new Map(Object.entries(storedObj));
      }
    } catch (e) { /* ignore */ }
  }

  function normalizeClientId(raw) {
    if (!raw) return '';
    if (typeof raw === 'string') {
      const trimmed = raw.trim();
      if (!trimmed || trimmed === 'null' || trimmed === 'undefined') return '';
      try {
        const parsed = JSON.parse(trimmed);
        if (typeof parsed === 'string') return parsed;
        if (parsed && typeof parsed === 'object' && typeof parsed.id === 'string') return parsed.id;
      } catch (e) {
        return trimmed.replace(/^"|"$/g, '');
      }
      return trimmed.replace(/^"|"$/g, '');
    }
    if (typeof raw === 'object' && typeof raw.id === 'string') return raw.id;
    return '';
  }

  function inferClientIdFromDayKeys() {
    try {
      const keys = Object.keys(localStorage);
      let best = { cid: '', ts: 0 };
      keys.forEach((key) => {
        const match = key.match(/^heys_(.+?)_dayv2_(\d{4}-\d{2}-\d{2})$/i);
        if (!match) return;
        const cid = match[1];
        if (!cid || cid === 'dayv2') return;
        const dateStr = match[2];
        const ts = Date.parse(dateStr);
        if (!Number.isFinite(ts)) return;
        if (ts >= best.ts) best = { cid, ts };
      });
      return best.cid || '';
    } catch (e) {
      return '';
    }
  }

  function getClientIdSafe() {
    let cid = HEYS?.currentClientId || '';
    if (!cid) cid = HEYS?.cloud?._pinAuthClientId || '';
    if (!cid) {
      cid = normalizeClientId(localStorage.getItem('heys_pin_auth_client'));
    }
    if (!cid) {
      cid = normalizeClientId(localStorage.getItem('heys_client_current'));
    }
    if (!cid) {
      cid = inferClientIdFromDayKeys();
    }
    return typeof cid === 'string' ? cid : '';
  }

  function hasDayHistory(clientId = getClientIdSafe()) {
    try {
      const keys = Object.keys(localStorage);
      const scopedPrefix = clientId ? `heys_${clientId}_dayv2_` : '';
      return keys.some((key) =>
        key.startsWith('heys_dayv2_')
        || (scopedPrefix && key.startsWith(scopedPrefix))
        || /^heys_(.+?)_dayv2_\d{4}-\d{2}-\d{2}$/i.test(key)
      );
    } catch (e) {
      return false;
    }
  }

  function pruneOldUsageStats(maxAgeDays = USER_STATS_MAX_AGE_DAYS) {
    if (!userProductStats || userProductStats.size === 0) return false;
    const now = Date.now();
    const maxAgeMs = Math.max(1, Number(maxAgeDays) || USER_STATS_MAX_AGE_DAYS) * 24 * 60 * 60 * 1000;
    let changed = false;

    userProductStats.forEach((stats, key) => {
      const lastUsed = Number(stats?.lastUsed || 0) || 0;
      if (!lastUsed || now - lastUsed > maxAgeMs) {
        userProductStats.delete(key);
        changed = true;
      }
    });

    if (changed) saveUserStats();
    return changed;
  }

  function markUsageStatsMigrated() {
    try {
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(USER_STATS_MIGRATED_KEY, true);
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet(USER_STATS_MIGRATED_KEY, true);
      } else {
        localStorage.setItem(USER_STATS_MIGRATED_KEY, JSON.stringify(true));
      }
    } catch (e) { /* ignore */ }
  }

  function isUsageStatsMigrated() {
    try {
      if (HEYS.store && HEYS.store.get) {
        return !!HEYS.store.get(USER_STATS_MIGRATED_KEY, false);
      }
      if (HEYS.utils && HEYS.utils.lsGet) {
        return !!HEYS.utils.lsGet(USER_STATS_MIGRATED_KEY, false);
      }
      const raw = localStorage.getItem(USER_STATS_MIGRATED_KEY);
      return raw ? JSON.parse(raw) === true : false;
    } catch (e) {
      return false;
    }
  }

  function ensureUsageStatsMigrated() {
    if (isUsageStatsMigrated()) return true;

    if (userProductStats && userProductStats.size > 0) {
      markUsageStatsMigrated();
      return true;
    }

    if (!hasDayHistory()) {
      markUsageStatsMigrated();
      return true;
    }

    if (typeof syncUsageStatsFromDays === 'function') {
      syncUsageStatsFromDays({
        daysWindow: 21,
        dateKey: new Date().toISOString().slice(0, 10),
        lsGet: (HEYS.utils && HEYS.utils.lsGet) ? HEYS.utils.lsGet : undefined
      });
    }

    markUsageStatsMigrated();
    return true;
  }

  function scheduleUsageStatsMigration() {
    const migrated = ensureUsageStatsMigrated();
    if (migrated) return;

    if (typeof document !== 'undefined' && document.addEventListener) {
      document.addEventListener('heysClientReady', () => {
        ensureUsageStatsMigrated();
      }, { once: true });
    }

    setTimeout(() => {
      ensureUsageStatsMigrated();
    }, 2000);
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   */
  function saveUserStats() {
    try {
      const data = Object.fromEntries(userProductStats);
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(USER_STATS_KEY, data);
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet(USER_STATS_KEY, data);
      } else {
        localStorage.setItem(USER_STATS_KEY, JSON.stringify(data));
      }
    } catch (e) { /* ignore */ }
  }

  function getUsageStatsLastSync() {
    try {
      if (HEYS.store && HEYS.store.get) {
        return Number(HEYS.store.get(USER_STATS_SYNC_KEY, 0)) || 0;
      }
      if (HEYS.utils && HEYS.utils.lsGet) {
        return Number(HEYS.utils.lsGet(USER_STATS_SYNC_KEY, 0)) || 0;
      }
      const raw = localStorage.getItem(USER_STATS_SYNC_KEY);
      return raw ? Number(JSON.parse(raw)) || 0 : 0;
    } catch (e) {
      return 0;
    }
  }

  function setUsageStatsLastSync(ts) {
    try {
      if (HEYS.store && HEYS.store.set) {
        HEYS.store.set(USER_STATS_SYNC_KEY, ts);
      } else if (HEYS.utils && HEYS.utils.lsSet) {
        HEYS.utils.lsSet(USER_STATS_SYNC_KEY, ts);
      } else {
        localStorage.setItem(USER_STATS_SYNC_KEY, JSON.stringify(ts));
      }
    } catch (e) { /* ignore */ }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å snapshot —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   * @returns {Map<string, {count:number, lastUsed:number}>}
   */
  function getUsageStats() {
    return new Map(userProductStats);
  }

  /**
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å usage stats –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–Ω–µ–π (–¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)
   * @param {Object} options
   * @param {number} options.daysWindow
   * @param {Function} options.lsGet
   * @param {string} options.dateKey
   * @returns {Map<string, {count:number, lastUsed:number}>}
   */
  function syncUsageStatsFromDays(options = {}) {
    const daysWindow = Math.max(1, Math.min(60, Number(options.daysWindow) || 21));
    const bumpStat = (statsMap, key, ts) => {
      const k = String(key || '').trim();
      if (!k) return;
      const s = statsMap.get(k) || { count: 0, lastUsed: 0 };
      s.count += 1;
      if (!s.lastUsed || ts > s.lastUsed) s.lastUsed = ts;
      statsMap.set(k, s);
    };
    const resolveScopedKey = (rawKey) => {
      const cid = getClientIdSafe();
      if (!cid) return rawKey;
      if (/^heys_(clients|client_current)$/i.test(rawKey)) return rawKey;
      if (rawKey.includes(cid)) return rawKey;
      if (rawKey.startsWith('heys_')) {
        return `heys_${cid}_${rawKey.substring('heys_'.length)}`;
      }
      return `heys_${cid}_${rawKey}`;
    };
    const lsGetFn = options.lsGet
      || (HEYS.store && HEYS.store.get)
      || (HEYS.utils && HEYS.utils.lsGet)
      || ((k, d) => {
        try {
          const scopedKey = resolveScopedKey(k);
          const raw = localStorage.getItem(scopedKey) ?? localStorage.getItem(k);
          if (!raw) return d;
          if (HEYS.store?.decompress) return HEYS.store.decompress(raw);
          return JSON.parse(raw);
        } catch (_) { return d; }
      });
    const readDayRaw = (rawKey) => {
      try {
        const scopedKey = resolveScopedKey(rawKey);
        const raw = localStorage.getItem(scopedKey) ?? localStorage.getItem(rawKey);
        if (!raw) return null;
        if (HEYS.store?.decompress) return HEYS.store.decompress(raw);
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    };
    const today = new Date(options.dateKey || new Date().toISOString().slice(0, 10));
    const nextStats = new Map();

    const scanFromDayKeys = () => {
      try {
        const keys = Object.keys(localStorage);
        const cutoff = new Date(today);
        cutoff.setDate(cutoff.getDate() - (daysWindow - 1));
        const stats = new Map();

        keys.forEach((key) => {
          if (!key.includes('_dayv2_')) return;
          const m = key.match(/_dayv2_(\d{4}-\d{2}-\d{2})/);
          if (!m) return;
          const dateStr = m[1];
          const ts = Date.parse(dateStr);
          if (!Number.isFinite(ts)) return;
          if (ts < cutoff.getTime()) return;

          const raw = localStorage.getItem(key);
          if (!raw) return;
          let dayData = null;
          try {
            if (HEYS.store?.decompress) {
              dayData = HEYS.store.decompress(raw);
            } else if (raw.startsWith('¬§Z¬§')) {
              dayData = JSON.parse(raw.substring(3));
            } else {
              dayData = JSON.parse(raw);
            }
          } catch (e) {
            dayData = null;
          }
          if (!dayData?.meals) return;

          dayData.meals.forEach((meal) => {
            if (!meal?.items) return;
            meal.items.forEach((item) => {
              const pid = String(item.product_id || item.productId || '');
              const rawName = String(item.name || '').trim();
              const normName = normalizeText(rawName);
              if (pid) bumpStat(stats, pid, ts);
              if (rawName) bumpStat(stats, rawName, ts);
              if (normName) bumpStat(stats, normName, ts);
            });
          });
        });

        return stats;
      } catch (e) {
        return new Map();
      }
    };

    let scannedDays = 0;
    let foundMeals = 0;
    let foundItems = 0;
    for (let i = 0; i < daysWindow; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const dayKey = `heys_dayv2_${key}`;
      if (HEYS.store?.invalidate) {
        HEYS.store.invalidate(dayKey);
      }
      const dayData = lsGetFn(dayKey, null) || readDayRaw(dayKey);
      const dayTs = d.getTime();

      if (dayData && dayData.meals) {
        scannedDays++;
        dayData.meals.forEach(meal => {
          if (!meal.items) return;
          foundMeals++;
          meal.items.forEach(item => {
            const pid = String(item.product_id || item.productId || '');
            const rawName = String(item.name || '').trim();
            const normName = normalizeText(rawName);
            if (!pid && !rawName && !normName) return;
            foundItems++;
            if (pid) bumpStat(nextStats, pid, dayTs);
            if (rawName) bumpStat(nextStats, rawName, dayTs);
            if (normName) bumpStat(nextStats, normName, dayTs);
          });
        });
      }
    }

    let finalStats = nextStats;
    if (finalStats.size === 0) {
      finalStats = scanFromDayKeys();
    }

    if (finalStats.size > 0) {
      userProductStats = new Map(finalStats);
      saveUserStats();
      setUsageStatsLastSync(Date.now());
    }

    try {
      HEYS._usageStatsDebug = {
        ...(HEYS._usageStatsDebug || {}),
        sync: {
          daysWindow,
          scannedDays,
          foundMeals,
          foundItems,
          statsSize: nextStats.size,
          clientId: getClientIdSafe(),
          sample: Array.from(nextStats.entries()).slice(0, 5)
        }
      };
    } catch (e) { }

    if (HEYS.DEBUG_MODE) {
      const payload = HEYS._usageStatsDebug?.sync || {
        daysWindow,
        scannedDays,
        foundMeals,
        foundItems,
        statsSize: finalStats.size,
        clientId: getClientIdSafe()
      };
      console.log('üîé [UsageStats] syncUsageStatsFromDays', payload);
      if (finalStats.size === 0) {
        console.log('‚ö†Ô∏è [UsageStats] no stats found from day keys');
      }
      if (global.DEV?.log) {
        global.DEV.log('üîé [UsageStats] syncUsageStatsFromDays', payload);
      }
    }

    return new Map(userProductStats);
  }

  function ensureUsageStatsFresh(options = {}) {
    const maxHours = Math.max(1, Number(options.maxHours) || 12);
    const lastSync = getUsageStatsLastSync();
    const maxAgeMs = maxHours * 60 * 60 * 1000;
    const shouldSync = !lastSync || (Date.now() - lastSync) > maxAgeMs;
    if (!shouldSync) return false;

    syncUsageStatsFromDays({
      daysWindow: Math.max(1, Math.min(60, Number(options.daysWindow) || 21)),
      dateKey: options.dateKey,
      lsGet: options.lsGet
    });
    return true;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  loadUserStats();
  scheduleUsageStatsMigration();
  pruneOldUsageStats();

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ (ru/en/mixed)
   */
  function detectLanguage(text) {
    if (!text) return 'unknown';
    const hasRu = /[–∞-—è—ë]/i.test(text);
    const hasEn = /[a-z]/i.test(text);
    if (hasRu && hasEn) return 'mixed';
    if (hasRu) return 'ru';
    if (hasEn) return 'en';
    return 'unknown';
  }

  /**
   * üÜï –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
   * vfkjrj ‚Üí –º–æ–ª–æ–∫–æ, –º–æ–ª–æ–∫–æ ‚Üí vjkjrj
   */
  function convertKeyboardLayout(text) {
    if (!CONFIG.enableKeyboardFix || !text) return null;

    const lang = detectLanguage(text);
    const lower = text.toLowerCase();
    let converted = '';

    if (lang === 'en') {
      // QWERTY ‚Üí –ô–¶–£–ö–ï–ù
      for (const char of lower) {
        converted += QWERTY_TO_CYRILLIC[char] || char;
      }
    } else if (lang === 'ru') {
      // –ô–¶–£–ö–ï–ù ‚Üí QWERTY
      for (const char of lower) {
        converted += CYRILLIC_TO_QWERTY[char] || char;
      }
    } else {
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–ª–∞ –¥—Ä—É–≥–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return converted !== lower ? converted : null;
  }

  /**
   * üÜï –†–∞—Å–∫—Ä—ã—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
   */
  function expandAbbreviations(query) {
    if (!CONFIG.enableAbbreviations || !query) return [];

    const normalized = normalizeText(query);
    const expansions = new Set();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ
    for (const [abbr, meanings] of Object.entries(ABBREVIATIONS)) {
      if (normalized.includes(abbr) || normalized === abbr) {
        meanings.forEach(m => {
          // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª–Ω—É—é —Ñ–æ—Ä–º—É
          expansions.add(normalized.replace(abbr, m));
          expansions.add(m);
        });
      }
    }

    return [...expansions];
  }

  /**
   * üÜï –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
   * "—Ç–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π" ‚Üí ["–æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π —Ç–≤–æ—Ä–æ–≥"]
   */
  function generateWordPermutations(query) {
    if (!CONFIG.enableWordPermutations || !query) return [];

    const words = normalizeText(query).split(/\s+/).filter(w => w.length >= 2);
    if (words.length < 2 || words.length > 4) return []; // –¢–æ–ª—å–∫–æ 2-4 —Å–ª–æ–≤–∞

    const permutations = new Set();

    // –î–ª—è 2 —Å–ª–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º
    if (words.length === 2) {
      permutations.add(`${words[1]} ${words[0]}`);
    }

    // –î–ª—è 3-4 —Å–ª–æ–≤ ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏
    if (words.length >= 3) {
      // –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ –≤ –Ω–∞—á–∞–ª–æ
      permutations.add([words[words.length - 1], ...words.slice(0, -1)].join(' '));
      // –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –≤ –∫–æ–Ω–µ—Ü
      permutations.add([...words.slice(1), words[0]].join(' '));
    }

    return [...permutations];
  }

  /**
   * üÜï –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * "–º–æ–ª–æ—á–Ω—ã–µ" ‚Üí –≤—Å–µ –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
   */
  function findCategoryProducts(query, dataSource) {
    const normalized = normalizeText(query);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏?
    for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
      if (normalized === category || normalized === category.slice(0, -2)) { // –º–æ–ª–æ—á–Ω—ã–µ/–º–æ–ª–æ—á–Ω
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        return dataSource.filter(item => {
          const itemName = normalizeText(item.name || '');
          return keywords.some(kw => itemName.includes(kw));
        }).map(item => ({
          ...item,
          matchType: 'category',
          matchedCategory: category
        }));
      }
    }

    return [];
  }

  /**
   * üÜï N-gram –ø–æ–∏—Å–∫ (–ø–æ–∏—Å–∫ –ø–æ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —Å–ª–æ–≤–∞)
   */
  function ngramSearch(query, dataSource, minGramSize = 3) {
    if (!CONFIG.enableNgram || !query || query.length < minGramSize) return [];

    const normalized = normalizeText(query);
    const results = [];

    dataSource.forEach(item => {
      const itemName = normalizeText(item.name || '');

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º n-–≥—Ä–∞–º–º—ã –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
      for (let i = 0; i <= itemName.length - normalized.length; i++) {
        const gram = itemName.substring(i, i + normalized.length);

        // Fuzzy —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ n-–≥—Ä–∞–º–º—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º
        const distance = levenshteinDistance(normalized, gram, 1);
        if (distance <= 1) {
          results.push({
            ...item,
            matchType: 'ngram',
            matchPosition: i,
            ngramDistance: distance
          });
          break; // –û–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç –æ–¥–∏–Ω —Ä–∞–∑
        }
      }
    });

    return results;
  }

  /**
   * –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
   * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
   * @param {string} direction - 'ru-to-en' | 'en-to-ru' | 'auto' (–æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   * @returns {string} —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
   */
  function transliterate(text, direction = 'auto') {
    if (!text) return '';
    const lower = text.toLowerCase();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω—ã–µ –ø–∞—Ä—ã
    if (TRANSLIT_PAIRS[lower]) {
      return TRANSLIT_PAIRS[lower];
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (direction === 'auto') {
      const lang = detectLanguage(lower);
      direction = lang === 'ru' ? 'ru-to-en' : 'en-to-ru';
    }

    if (direction === 'ru-to-en') {
      // –†—É—Å—Å–∫–∏–π ‚Üí –õ–∞—Ç–∏–Ω–∏—Ü–∞
      let result = '';
      for (const char of lower) {
        result += TRANSLIT_RU_TO_EN[char] || char;
      }
      return result;
    } else {
      // –õ–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí –†—É—Å—Å–∫–∏–π (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
      let result = lower;
      for (const [from, to] of TRANSLIT_EN_TO_RU) {
        result = result.split(from).join(to);
      }
      return result;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @returns {string[]} –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –∏—Å—Ö–æ–¥–Ω—ã–π)
   */
  function getTranslitVariants(query) {
    if (!CONFIG.enableTranslit || !query) return [query];

    const normalized = normalizeText(query);
    const variants = new Set([normalized]);

    // –¢–æ—á–Ω–∞—è –ø–∞—Ä–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
    if (TRANSLIT_PAIRS[normalized]) {
      variants.add(normalizeText(TRANSLIT_PAIRS[normalized]));
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    const lang = detectLanguage(normalized);
    if (lang === 'ru') {
      // –†—É—Å—Å–∫–∏–π ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞
      variants.add(transliterate(normalized, 'ru-to-en'));
    } else if (lang === 'en') {
      // –õ–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí —Ä—É—Å—Å–∫–∏–π
      variants.add(transliterate(normalized, 'en-to-ru'));
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    for (const [canonical, spellings] of Object.entries(SPELLING_VARIANTS)) {
      if (spellings.some(s => normalizeText(s) === normalized)) {
        // –ù–∞—à–ª–∏ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É
        variants.add(normalizeText(canonical));
      }
      if (normalizeText(canonical) === normalized) {
        // –≠—Ç–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        spellings.forEach(s => variants.add(normalizeText(s)));
      }
    }

    return [...variants].filter(v => v && v.length >= 2);
  }

  /**
   * –ù–∞–π—Ç–∏ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   */
  function getCanonicalForm(query) {
    const normalized = normalizeText(query);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ SPELLING_VARIANTS
    for (const [canonical, spellings] of Object.entries(SPELLING_VARIANTS)) {
      if (normalizeText(canonical) === normalized) {
        return canonical;
      }
      if (spellings.some(s => normalizeText(s) === normalized)) {
        return canonical;
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ TRANSLIT_PAIRS (–±–µ—Ä—ë–º —Ä—É—Å—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∫ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)
    if (TRANSLIT_PAIRS[normalized]) {
      const pair = TRANSLIT_PAIRS[normalized];
      // –ï—Å–ª–∏ –ø–∞—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º - —ç—Ç–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞
      if (detectLanguage(pair) === 'ru') {
        return pair;
      }
    }

    return null;
  }

  // === –£–¢–ò–õ–ò–¢–´ ===

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
   * –ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: —ë ‚Üí –µ, lowercase, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ
   */
  function normalizeText(text) {
    if (!text) return '';
    return String(text)
      .toLowerCase()
      .replace(/—ë/g, '–µ')              // —ë ‚Üí –µ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
      .replace(/[^\w–∞-—è—ë\s-]/gi, ' ')  // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å
      .replace(/\s+/g, ' ')            // –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã ‚Üí –æ–¥–∏–Ω
      .trim();
  }

  // –ß–∞—Å—Ç—ã–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞ ‚Äî –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Å–º—ã—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
  const STOPWORDS = new Set([
    '–∏', '–∞', '–Ω–æ', '–∏–ª–∏', '–≤', '–≤–æ', '–Ω–∞', '–ø–æ', '–∫', '–∫–æ', '—Å', '—Å–æ', '—É', '–∏–∑', '–æ—Ç',
    '–∑–∞', '–¥–ª—è', '–ø—Ä–∏', '–±–µ–∑', '–Ω–∞–¥', '–ø–æ–¥', '–ø—Ä–æ', '–¥–æ', '–ø–æ—Å–ª–µ', '—ç—Ç–æ', '—Ç–æ—Ç', '—Ç–∞',
    'the', 'a', 'an', 'and', 'or', 'to', 'of', 'in', 'on', 'for', 'with', 'without'
  ]);

  /**
   * üÜï –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏–π (stemming-lite)
   * –£–±–∏—Ä–∞–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
   */
  function normalizeRussianWord(word) {
    if (!word || word.length < 4) return word;

    // –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: -–∞—è, -—è—è, -–æ–µ, -–µ–µ, -—ã–π, -–∏–π, -—ã–µ, -–∏–µ
    if (/(–∞—è|—è—è|–æ–µ|–µ–µ|—ã–π|–∏–π|—ã–µ|–∏–µ)$/.test(word)) {
      return word.replace(/(–∞—è|—è—è|–æ–µ|–µ–µ|—ã–π|–∏–π|—ã–µ|–∏–µ)$/, '');
    }

    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ: -—ã, -–∏ (–µ—Å–ª–∏ –Ω–µ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–ª–æ–≤–æ)
    if (word.length > 4 && /(—ã|–∏)$/.test(word)) {
      return word.slice(0, -1);
    }

    return word;
  }

  /**
   * üÜï v2.5.0 –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–ª–æ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏
   * "–º–æ–ª–æ–∫–æ 1.5%" -> [{ value: 1.5, unit: '%', raw: '1.5%' }]
   * "—Ç–≤–æ—Ä–æ–≥ 5%" -> [{ value: 5, unit: '%', raw: '5%' }]
   * "–∫–µ—Ñ–∏—Ä 1–ª" -> [{ value: 1000, unit: 'ml', raw: '1–ª' }]
   */
  function parseNumericConstraints(text) {
    if (!text) return [];

    // –ü–∞—Ç—Ç–µ—Ä–Ω: —á–∏—Å–ª–æ (—Å —Ç–æ—á–∫–æ–π/–∑–∞–ø—è—Ç–æ–π) + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–æ–±–µ–ª + –µ–¥–∏–Ω–∏—Ü–∞
    // –ì—Ä—É–ø–ø—ã: 1=—á–∏—Å–ª–æ, 3=–µ–¥–∏–Ω–∏—Ü–∞
    const regex = /(\d+(?:[.,]\d+)?)\s*([%a-zA-Z–∞-—è–ê-–Ø—ë–Å]+)?/g;
    const constraints = [];
    let match;

    while ((match = regex.exec(text)) !== null) {
      const valStr = match[1].replace(',', '.');
      const unitStr = (match[2] || '').toLowerCase();

      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ—Ö–æ–∂–∏ –Ω–∞ –≥–æ–¥ –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª (4 —Ü–∏—Ñ—Ä—ã)
      // –ù–æ –±–µ—Ä–µ–º –º–∞–ª–µ–Ω—å–∫–∏–µ —á–∏—Å–ª–∞ (–∂–∏—Ä–Ω–æ—Å—Ç—å, –≤–µ—Å)
      const value = parseFloat(valStr);

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü—ã
      let normalizedUnit = null;
      let normalizedValue = value;

      if (unitStr) {
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        if (UNIT_CONVERSION[unitStr]) {
          const conv = UNIT_CONVERSION[unitStr];
          normalizedUnit = conv.base;
          normalizedValue = value * conv.factor;
        } else {
          // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
          normalizedUnit = unitStr;
        }
      } else {
        // –ß–∏—Å–ª–æ –±–µ–∑ –µ–¥–∏–Ω–∏—Ü—ã.
        // –ï—Å–ª–∏ —ç—Ç–æ 0-100, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º (–∂–∏—Ä–Ω–æ—Å—Ç—å)
        // –ï—Å–ª–∏ >100, –º–æ–∂–µ—Ç –±—ã—Ç—å –≥—Ä–∞–º–º–∞–º–∏
        // –ü–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º 'generic'
        normalizedUnit = 'generic';
      }

      constraints.push({
        value: normalizedValue,
        unit: normalizedUnit,
        rawUnit: unitStr,
        rawValue: value,
        original: match[0]
      });
    }

    return constraints;
  }

  /**
   * üÜï v2.5.0 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å–ª–æ–≤–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
   * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —á–∏—Å–ª–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —Å —á–∏—Å–ª–∞–º–∏ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ
   */
  function checkNumericMatch(queryConstraints, productConstraintsOrText) {
    if (!queryConstraints || queryConstraints.length === 0) return 1.0;

    // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–∞ –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞
    const productNumbers = Array.isArray(productConstraintsOrText)
      ? productConstraintsOrText
      : parseNumericConstraints(productConstraintsOrText);

    if (productNumbers.length === 0) return 0.9; // –ù–µ—Ç —á–∏—Å–µ–ª –≤ –ø—Ä–æ–¥—É–∫—Ç–µ - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ

    let matchScore = 0;
    let matchedCount = 0;

    for (const qNum of queryConstraints) {
      // –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —á–∏—Å–ª–æ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ
      const bestMatch = productNumbers.find(pNum => {
        // 1. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü (–∏–ª–∏ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö generic)
        const unitMatch = (qNum.unit === pNum.unit) ||
          (qNum.unit === 'generic' && pNum.unit !== '%') || // generic –Ω–µ –º–∞—Ç—á–∏—Ç %
          (pNum.unit === 'generic' && qNum.unit !== '%');

        if (!unitMatch) return false;

        // 2. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π (—Å –¥–æ–ø—É—Å–∫–æ–º)
        // –î–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ–ø—É—Å–∫ –º–∞–ª–µ–Ω—å–∫–∏–π (0.1), –¥–ª—è –≥—Ä–∞–º–º–æ–≤ –±–æ–ª—å—à–æ–π (10%)
        const tolerance = qNum.unit === '%' ? 0.1 : Math.max(0.1, qNum.value * 0.1);
        return Math.abs(qNum.value - pNum.value) <= tolerance;
      });

      if (bestMatch) {
        matchedCount++;
        matchScore += 1.0;
      } else {
        // –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –±—ã–ª–æ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 5%), –∞ –≤ –ø—Ä–æ–¥—É–∫—Ç–µ –µ–≥–æ –Ω–µ—Ç –∏–ª–∏ –¥—Ä—É–≥–æ–µ - —à—Ç—Ä–∞—Ñ
        // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ (%, –∫–≥, –ª)
        if (qNum.unit !== 'generic') {
          matchScore -= 0.5;
        }
      }
    }

    if (matchedCount === 0 && queryConstraints.length > 0) return 0.8; // –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏

    return Math.max(0.5, Math.min(1.5, 1.0 + (matchScore * 0.2)));
  }

  /**
   * üÜï –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞/–Ω–∞–∑–≤–∞–Ω–∏—è (—Å–ª–æ–≤–∞)
   */
  function tokenize(text) {
    const norm = normalizeText(text);
    if (!norm) return [];
    return norm
      .split(/\s+/)
      .map(t => t.trim())
      .filter(t => t.length >= 2)
      .filter(t => !STOPWORDS.has(t))
      .map(t => normalizeRussianWord(t)); // üÜï v2.5.0 Stemming
  }

  /**
   * üÜï –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ —Å—ã—Ä–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
   * –ü—Ä–∏–º–µ—Ä—ã:
   *  - "2.5%" ‚Üí ["2.5%", "2.5"]
   *  - "0%"   ‚Üí ["0%", "0"]
   *  - "250–≥" ‚Üí ["250"]
   */
  function extractNumericTokens(rawText) {
    if (!rawText) return [];
    const s = String(rawText).toLowerCase();
    const out = new Set();

    // 1) –î–µ—Å—è—Ç–∏—á–Ω—ã–µ/—Ü–µ–ª—ã–µ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º %
    const re = /\b(\d+(?:[\.,]\d+)?)(\s*%?)\b/g;
    let m;
    while ((m = re.exec(s))) {
      const num = (m[1] || '').replace(',', '.');
      const hasPct = (m[2] || '').includes('%');
      if (!num) continue;
      out.add(num);
      if (hasPct) out.add(num + '%');
    }

    // 2) –ß–∏—Å–ª–æ + –µ–¥–∏–Ω–∏—Ü—ã (–≥/–≥—Ä/ml/–º–ª/–ª/–∫–≥) ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ (–µ–¥–∏–Ω–∏—Ü—ã –Ω–µ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ —Ç–æ–∫–µ–Ω)
    const reUnits = /\b(\d+(?:[\.,]\d+)?)(?:\s*)(–≥|–≥—Ä|kg|–∫–≥|ml|–º–ª|–ª|—à—Ç)\b/g;
    while ((m = reUnits.exec(s))) {
      const num = (m[1] || '').replace(',', '.');
      if (num) out.add(num);
    }

    return [...out];
  }

  /**
   * üÜï –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø—Ä–æ–¥—É–∫—Ç–µ.
   * –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å "2.5" ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ–º –∏ "2.5%".
   */
  function numbersMatchAll(queryNums, itemNums) {
    if (!queryNums || queryNums.length === 0) return true;
    if (!itemNums || itemNums.length === 0) return false;
    const set = new Set(itemNums);
    return queryNums.every(q => {
      if (set.has(q)) return true;
      // 2.5 –º–æ–∂–µ—Ç –º–∞—Ç—á–∏—Ç—å—Å—è —Å 2.5%
      if (!q.endsWith('%') && set.has(q + '%')) return true;
      // 0% –º–æ–∂–µ—Ç –º–∞—Ç—á–∏—Ç—å—Å—è —Å 0
      if (q.endsWith('%') && set.has(q.replace('%', ''))) return true;
      return false;
    });
  }

  /**
   * üÜï –û—Ü–µ–Ω–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Ç–æ–∫–µ–Ω–∞–º –∑–∞–ø—Ä–æ—Å–∞.
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { coverage, bonus }
   */
  function computeTokenMatchScore(queryTokens, itemNameNorm, itemTokens) {
    if (!queryTokens || queryTokens.length === 0) return { coverage: 0, bonus: 0 };
    const name = itemNameNorm || '';
    const tokens = itemTokens || [];
    const isMultiTokenQuery = queryTokens.length >= 2;
    let hit = 0;

    for (const qt of queryTokens) {
      if (!qt) continue;

      // 1) —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
      if (tokens.includes(qt)) {
        hit++;
        continue;
      }
      // 2) –ø—Ä–µ—Ñ–∏–∫—Å ("—Ç–≤–æ—Ä" ‚Üí "—Ç–≤–æ—Ä–æ–≥"). –î–ª—è multi-token –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã ("–≥—Ä" ‚Üí "–≥—Ä–µ—á–µ—Å–∫–∏–π").
      if (tokens.some(t => t.startsWith(qt) && (qt.length >= 3 || (isMultiTokenQuery && qt.length >= 2)))) {
        hit++;
        continue;
      }
      // 3) fallback: –ø–æ–¥—Å—Ç—Ä–æ–∫–∞
      if (name.includes(qt) && (qt.length >= 3 || (isMultiTokenQuery && qt.length >= 2))) {
        hit++;
        continue;
      }
    }

    const coverage = hit / Math.max(1, queryTokens.length);

    // –ë–æ–Ω—É—Å: —á–µ–º –≤—ã—à–µ coverage, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ. –ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –≤—Å–µ–º —Å–ª–æ–≤–∞–º ‚Äî –∂–∏—Ä–Ω—ã–π –±—É—Å—Ç.
    let bonus = 0;
    if (coverage >= 1) bonus = 18;
    else if (coverage >= 0.75) bonus = 10;
    else if (coverage >= 0.5) bonus = 5;

    return { coverage, bonus };
  }

  /**
   * –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–¥–ª—è fuzzy-–ø–æ–∏—Å–∫–∞)
   */
  function phoneticNormalize(text) {
    if (!CONFIG.enablePhonetic) return normalizeText(text);

    let result = normalizeText(text);
    phoneticRules.forEach(rule => {
      result = result.replace(rule.from, rule.to);
    });
    return result;
  }

  /**
   * –†–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞ (–¥–ª—è –æ–ø–µ—á–∞—Ç–æ–∫)
   * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —Ä–∞–Ω–Ω–∏–º –≤—ã—Ö–æ–¥–æ–º
   */
  function levenshteinDistance(str1, str2, maxDistance = Infinity) {
    const len1 = str1.length;
    const len2 = str2.length;

    // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (len1 === 0) return len2;
    if (len2 === 0) return len1;
    if (Math.abs(len1 - len2) > maxDistance) return maxDistance + 1;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
    const prev = new Array(len2 + 1);
    const curr = new Array(len2 + 1);

    for (let j = 0; j <= len2; j++) prev[j] = j;

    for (let i = 1; i <= len1; i++) {
      curr[0] = i;
      let minInRow = i;

      for (let j = 1; j <= len2; j++) {
        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
        curr[j] = Math.min(
          prev[j] + 1,      // —É–¥–∞–ª–µ–Ω–∏–µ
          curr[j - 1] + 1,  // –≤—Å—Ç–∞–≤–∫–∞
          prev[j - 1] + cost // –∑–∞–º–µ–Ω–∞
        );
        minInRow = Math.min(minInRow, curr[j]);
      }

      // –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –µ—Å–ª–∏ –º–∏–Ω–∏–º—É–º –≤ —Å—Ç—Ä–æ–∫–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç maxDistance
      if (minInRow > maxDistance) return maxDistance + 1;

      // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –≤ prev (swap —Ç—É—Ç –Ω–µ –Ω—É–∂–µ–Ω)
      for (let j = 0; j <= len2; j++) prev[j] = curr[j];
    }

    return prev[len2];
  }

  /**
   * üÜï –ë—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è) ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –ø–æ–∏—Å–∫–∞.
   */
  function computeDataSourceHash(dataSource) {
    try {
      const len = dataSource.length;
      const first = dataSource[0];
      const last = dataSource[len - 1];
      const fKey = (first && (first.id || first.name)) ? String(first.id || first.name) : '';
      const lKey = (last && (last.id || last.name)) ? String(last.id || last.name) : '';
      return `${len}|${fKey}|${lKey}`;
    } catch (e) {
      return String(dataSource.length || 0);
    }
  }

  function getIndexedProducts(dataSource, opts) {
    if (!dataSource || !Array.isArray(dataSource)) return [];
    const hash = computeDataSourceHash(dataSource);
    if (productIndex && lastProductsHash === hash) {
      return productIndex;
    }

    const indexed = dataSource.map(item => {
      const nameRaw = item?.name || '';
      const nameNorm = normalizeText(nameRaw);
      const namePhon = (opts && opts.enablePhonetic) ? phoneticNormalize(nameRaw) : nameNorm;
      const tokens = tokenize(nameRaw);
      const numbers = parseNumericConstraints(nameRaw); // üÜï v2.5.0
      const key = item?.id || item?.name;
      return { key, item, nameRaw, nameNorm, namePhon, tokens, numbers };
    });

    productIndex = indexed;
    lastProductsHash = hash;
    return indexed;
  }

  /**
   * –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –¥–ª—è —Å–ª–æ–≤–∞
   */
  function findSynonyms(query) {
    if (!CONFIG.enableSynonyms) return [];

    const normalized = normalizeText(query);
    const result = new Set();

    // –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫
    if (synonyms[normalized]) {
      synonyms[normalized].forEach(s => result.add(s));
    }

    // –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–ª–æ–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º–æ–º)
    for (const [key, values] of Object.entries(synonyms)) {
      if (values.some(v => normalizeText(v) === normalized)) {
        result.add(key);
        values.forEach(v => {
          if (normalizeText(v) !== normalized) result.add(v);
        });
      }
    }

    return [...result];
  }

  /**
   * –ü–æ–∏—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–ø–µ—á–∞—Ç–æ–∫
   */
  function findTypoCorrections(query, wordList) {
    if (!CONFIG.enableTypoCorrection) return [];

    const normalized = normalizeText(query);
    if (normalized.length < CONFIG.minQueryLength) return [];

    const maxDistance = CONFIG.getMaxTypoDistance(normalized.length);
    const corrections = [];
    const seen = new Set();

    // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    const uniqueWords = new Set();
    wordList.forEach(item => {
      const name = normalizeText(item.name || item);
      uniqueWords.add(name);
      // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
      name.split(/\s+/).forEach(w => {
        if (w.length >= 3) uniqueWords.add(w);
      });
    });

    // –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞
    for (const word of uniqueWords) {
      if (seen.has(word)) continue;

      const distance = levenshteinDistance(normalized, word, maxDistance);
      if (distance > 0 && distance <= maxDistance) {
        seen.add(word);
        corrections.push({
          original: query,
          corrected: word,
          distance,
          confidence: 1 - (distance / Math.max(normalized.length, word.length))
        });
      }
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    return corrections.sort((a, b) => b.confidence - a.confidence).slice(0, 5);
  }

  /**
   * üÜï v2.7.0 –ü–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥–∞–º (fuzzy matching)
   * –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞
   */
  function findBrandVariants(query) {
    const normalized = normalizeText(query);
    const variants = new Set();

    for (const [canonical, spellings] of Object.entries(BRAND_DICTIONARY)) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ª—é–±—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º
      if (spellings.some(s => normalizeText(s) === normalized)) {
        // –ù–∞—à–ª–∏ –±—Ä–µ–Ω–¥ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        variants.add(normalizeText(canonical));
        spellings.forEach(s => variants.add(normalizeText(s)));
      }

      // Fuzzy match –¥–ª—è –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –±—Ä–µ–Ω–¥–∞
      for (const spelling of spellings) {
        const normSpelling = normalizeText(spelling);
        const distance = levenshteinDistance(normalized, normSpelling, 2);
        if (distance > 0 && distance <= 2 && normalized.length >= 4) {
          variants.add(normSpelling);
          variants.add(normalizeText(canonical));
          spellings.forEach(s => variants.add(normalizeText(s)));
        }
      }
    }

    return [...variants];
  }

  /**
   * üÜï v2.7.0 –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (ML-lite)
   * –ò—â–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ —Å–º—ã—Å–ª–æ–≤–æ–π –±–ª–∏–∑–æ—Å—Ç–∏
   */
  function findSemanticMatches(query, dataSource, limit = 10) {
    const normalized = normalizeText(query);
    const matches = [];

    // –ò—â–µ–º –≤ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö
    for (const [cluster, products] of Object.entries(SEMANTIC_CLUSTERS)) {
      const clusterNorm = normalizeText(cluster);

      // –ó–∞–ø—Ä–æ—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞?
      if (clusterNorm.includes(normalized) || normalized.includes(clusterNorm)) {
        // –ò—â–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ dataSource
        dataSource.forEach(item => {
          const itemName = normalizeText(item.name || '');
          for (const clusterProduct of products) {
            if (itemName.includes(normalizeText(clusterProduct))) {
              matches.push({
                ...item,
                matchType: 'semantic',
                semanticCluster: cluster,
                relevance: 55
              });
              break;
            }
          }
        });
      }

      // –ó–∞–ø—Ä–æ—Å ‚Äî –æ–¥–∏–Ω –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞?
      if (products.some(p => normalizeText(p) === normalized)) {
        // –ù–∞—Ö–æ–¥–∏–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ –∂–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–ø–æ—Ö–æ–∂–∏–µ)
        dataSource.forEach(item => {
          const itemName = normalizeText(item.name || '');
          for (const clusterProduct of products) {
            const cpNorm = normalizeText(clusterProduct);
            if (cpNorm !== normalized && itemName.includes(cpNorm)) {
              matches.push({
                ...item,
                matchType: 'semantic',
                semanticCluster: cluster,
                relatedTo: query,
                relevance: 45
              });
              break;
            }
          }
        });
      }
    }

    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ª–∏–º–∏—Ç–∏—Ä—É–µ–º
    const seen = new Set();
    return matches.filter(m => {
      const key = m.id || m.name;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    }).slice(0, limit);
  }

  /**
   * üÜï v2.7.0 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
   */
  function generateSmartSuggestions(query, dataSource) {
    const normalized = normalizeText(query);
    const suggestions = {
      tips: [],
      alternatives: [],
      popular: [],
      didYouMean: []
    };

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ
    const lang = detectLanguage(query);
    if (lang === 'en') {
      const keyboardFixed = convertKeyboardLayout(query);
      if (keyboardFixed && keyboardFixed !== normalized && keyboardFixed !== query.toLowerCase()) {
        suggestions.tips.push({
          type: 'keyboard_layout',
          message: `üí° –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É: "${keyboardFixed}"`,
          action: keyboardFixed
        });
      }
    }

    // 2. –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π/—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    const words = normalized.split(/\s+/).filter(w => w.length > 1);
    if (words.length >= 3) {
      suggestions.tips.push({
        type: 'too_specific',
        message: `üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ—Ä–æ—á–µ: "${words[0]}"`,
        action: words[0]
      });
    }

    // 3. –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ (typo correction)
    if (dataSource && dataSource.length > 0) {
      const typoCorrections = findTypoCorrections(query, dataSource);
      if (typoCorrections.length > 0) {
        suggestions.didYouMean = typoCorrections.slice(0, 3).map(c => ({
          type: 'typo',
          message: `üîß –í–æ–∑–º–æ–∂–Ω–æ: "${c.corrected}"`,
          action: c.corrected,
          confidence: c.confidence
        }));
      }
    }

    // 4. –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    const translitVariants = getTranslitVariants(query);
    translitVariants.forEach(v => {
      if (v !== normalized) {
        suggestions.alternatives.push({
          type: 'translit',
          message: `üåê –ù–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ: "${v}"`,
          action: v
        });
      }
    });

    // 5. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
    const matchingCategories = [];
    for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
      if (keywords.some(kw => normalizeText(kw).includes(normalized) || normalized.includes(normalizeText(kw)))) {
        matchingCategories.push(category);
      }
    }
    if (matchingCategories.length > 0) {
      suggestions.tips.push({
        type: 'category',
        message: `üìÇ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: ${matchingCategories.slice(0, 2).join(', ')}`,
        action: matchingCategories[0]
      });
    }

    // 6. –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    suggestions.popular = SMART_SUGGESTIONS_CONFIG.popularSearches.slice(0, 5);

    return suggestions;
  }

  /**
   * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   * üÜï v2.8.1: –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ > startsWith –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Å–ª–æ–≤–∞
   */
  function calculateRelevance(item, query, matchType = 'exact') {
    const itemName = normalizeText(item.name || '');
    const normalizedQuery = normalizeText(query);
    let relevance = 0;

    // –ë–∞–∑–æ–≤—ã–µ –±–∞–ª–ª—ã –ø–æ —Ç–∏–ø—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    switch (matchType) {
      case 'exact':
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Å–ª–æ–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        const words = itemName.split(/\s+/);
        const isExactWord = words.includes(normalizedQuery); // "—Å—ã—Ä" –∫–∞–∫ –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ
        const firstWordMatch = words[0] === normalizedQuery; // "—Å—ã—Ä" = –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
        const startsWithQuery = itemName.startsWith(normalizedQuery); // "—Å—ã—Ä–Ω–∏–∫–∏" –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "—Å—ã—Ä"
        const startsWithQueryIsOwnWord = startsWithQuery && words[0] === normalizedQuery; // –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ = –∑–∞–ø—Ä–æ—Å

        if (itemName === normalizedQuery) {
          relevance = 100; // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        } else if (firstWordMatch) {
          relevance = 95; // üÜï –ó–∞–ø—Ä–æ—Å = –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ: "—Å—ã—Ä —Ç–≤—ë—Ä–¥—ã–π" –¥–ª—è "—Å—ã—Ä"
        } else if (isExactWord) {
          relevance = 92; // üÜï –ó–∞–ø—Ä–æ—Å = –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏: "—Å—ã—Ä –ø–ª–∞–≤–ª–µ–Ω—ã–π –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π"
        } else if (startsWithQuery) {
          // startsWith –Ω–æ –ù–ï –ø–æ–ª–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî "—Å—ã—Ä–Ω–∏–∫–∏" –¥–ª—è "—Å—ã—Ä"
          relevance = 82; // üÜï –ü–æ–Ω–∏–∂–µ–Ω–æ —Å 90 –¥–æ 82
        } else if (itemName.includes(' ' + normalizedQuery)) {
          relevance = 85; // —Å–ª–æ–≤–æ —Ü–µ–ª–∏–∫–æ–º –ø–æ—Å–ª–µ –ø—Ä–æ–±–µ–ª–∞
        } else if (itemName.includes(normalizedQuery + ' ')) {
          relevance = 85; // —Å–ª–æ–≤–æ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Å—Ç–∏  
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ query –Ω–∞—á–∞–ª–æ–º –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Å–ª–æ–≤–∞ (–Ω–µ –ø–µ—Ä–≤–æ–≥–æ)
          const startsWord = words.slice(1).some(w => w.startsWith(normalizedQuery));
          if (startsWord) {
            relevance = 78; // —á–µ—Ä–∫ ‚Üí –ß–µ—Ä–∫–∏–∑–æ–≤–æ (–Ω–∞—á–∞–ª–æ —Å–ª–æ–≤–∞, –Ω–µ –ø–µ—Ä–≤–æ–≥–æ)
          } else {
            relevance = 60; // –ü—Ä–æ—Å—Ç–æ contains –≤–Ω—É—Ç—Ä–∏ —Å–ª–æ–≤–∞
          }
        }
        break;
      case 'keyboard':   // üÜï –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
        relevance = 82;
        break;
      case 'translit':  // üÜï –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
        relevance = 78; // –ú–µ–∂–¥—É exact –∏ synonym
        break;
      case 'abbreviation': // üÜï –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
        relevance = 75;
        break;
      case 'permutation':  // üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–≤
        relevance = 72;
        break;
      case 'category':     // üÜï –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        relevance = 70;
        break;
      case 'synonym':
        relevance = 68;
        break;
      case 'typo':
        relevance = 45;
        break;
      case 'ngram':        // üÜï N-gram –ø–æ–∏—Å–∫
        relevance = 40;
        break;
      case 'phonetic':
        relevance = 35;
        break;
    }

    // üÜï v2.8.1: –ë–æ–Ω—É—Å—ã ‚Äî –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    // –¶–µ–ª—å: –∏–∑–±—Ä–∞–Ω–Ω—ã–π "–°—ã—Ä —Ç–≤—ë—Ä–¥—ã–π" (95+15=110) –≤—ã—à–µ —á–µ–º "–°—ã—Ä–Ω–∏–∫–∏" (82)
    if (item.isFavorite) relevance += 15; // üÜï –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≤ –¢–û–ü (–±—ã–ª–æ +5, —Ç–µ–ø–µ—Ä—å +15)
    if (item.usageCount) relevance += Math.min(item.usageCount, 8); // —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ (max +8)

    // –ë–æ–Ω—É—Å –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Ç–æ—á–Ω–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
    const lengthRatio = normalizedQuery.length / itemName.length;
    if (lengthRatio > 0.7) relevance += 4;      // –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    else if (lengthRatio > 0.5) relevance += 2; // –°—Ä–µ–¥–Ω–µ–µ

    return Math.max(0, relevance);
  }

  /**
   * üÜï v2.6.0 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ (–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç)
   */
  function detectSearchIntent(query) {
    const normalized = normalizeText(query);
    const activeRules = {
      nutrient: [],
      context: []
    };

    // Check nutrient rules
    Object.entries(NUTRIENT_RULES).forEach(([key, rule]) => {
      if (rule.keywords.some(kw => normalized.includes(normalizeText(kw)))) {
        activeRules.nutrient.push(rule);
      }
    });

    // Check context rules
    Object.entries(CONTEXT_RULES).forEach(([key, rule]) => {
      if (rule.keywords.some(kw => normalized.includes(normalizeText(kw)))) {
        activeRules.context.push(rule);
      }
    });

    return activeRules;
  }

  // === –û–°–ù–û–í–ù–û–ô –ü–û–ò–°–ö ===

  /**
   * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @param {Array} dataSource - –º–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
   * @param {Object} options - –æ–ø—Ü–∏–∏ –ø–æ–∏—Å–∫–∞
   * @returns {Object} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
   */
  function smartSearch(query, dataSource, options = {}) {
    const startTime = performance.now();
    const opts = { ...CONFIG, ...options };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!query || !dataSource || !Array.isArray(dataSource)) {
      return { results: [], suggestions: [], corrections: [], searchTime: 0, query };
    }

    const trimmedQuery = query.trim();
    if (trimmedQuery.length < opts.minQueryLength) {
      return { results: [], suggestions: [], corrections: [], searchTime: 0, query: trimmedQuery };
    }

    // üÜï v2.6.0 Detect Intent
    const intent = detectSearchIntent(trimmedQuery);
    const hasIntent = intent.nutrient.length > 0 || intent.context.length > 0;

    // Calculate core query (remove intent keywords)
    let coreQuery = normalizeText(trimmedQuery);
    if (hasIntent) {
      [...intent.nutrient, ...intent.context].forEach(rule => {
        rule.keywords.forEach(kw => {
          const normKw = normalizeText(kw);
          coreQuery = coreQuery.replace(normKw, '').trim();
        });
      });
    }

    // If core query is empty (e.g. just "high protein"), we search ALL products but filter by intent
    const isPureIntentSearch = hasIntent && coreQuery.length < 2;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
    const cacheKey = `${trimmedQuery}_${dataSource.length}`;
    if (opts.cacheEnabled && searchCache.has(cacheKey)) {
      const cached = searchCache.get(cacheKey);
      if (Date.now() - cached.timestamp < opts.cacheTimeout) {
        return { ...cached.result, fromCache: true };
      }
    }

    const normalizedQuery = isPureIntentSearch ? '' : coreQuery;
    const phoneticQuery = isPureIntentSearch ? '' : phoneticNormalize(coreQuery);
    const queryConstraints = parseNumericConstraints(trimmedQuery); // üÜï v2.5.0
    const results = new Map();
    const corrections = [];
    const suggestions = [];

    // –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –æ–¥–∏–Ω —Ä–∞–∑
    const indexedProducts = getIndexedProducts(dataSource, opts);

    // üÜï –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
    const translitVariants = opts.enableTranslit ? getTranslitVariants(trimmedQuery) : [normalizedQuery];

    // üÜï –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (vjkjrj ‚Üí –º–æ–ª–æ–∫–æ)
    const keyboardFixedQuery = opts.enableKeyboardFix ? convertKeyboardLayout(trimmedQuery) : null;
    // üÜï v2.7.0 –ú–∞—Å—Å–∏–≤ –¥–ª—è visual feedback
    const keyboardVariants = keyboardFixedQuery && keyboardFixedQuery !== trimmedQuery
      ? [keyboardFixedQuery] : [];
    if (keyboardFixedQuery) {
      translitVariants.push(keyboardFixedQuery);
    }

    // üÜï –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è (–±/–∂ ‚Üí –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π)
    const abbreviationExpansions = opts.enableAbbreviations ? expandAbbreviations(trimmedQuery) : [];

    // üÜï –í—ã–±–∏—Ä–∞–µ–º ¬´–ª—É—á—à–∏–µ¬ª —Ç–æ–∫–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞: —É—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–∫—Å —Ä–∞—Å–∫–ª–∞–¥–∫–∏ –∏ —Ä–∞—Å–∫—Ä—ã—Ç—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
    const tokenCandidates = [trimmedQuery];
    if (keyboardFixedQuery) tokenCandidates.push(keyboardFixedQuery);
    if (abbreviationExpansions && abbreviationExpansions.length) {
      abbreviationExpansions.forEach(x => tokenCandidates.push(x));
    }
    let queryTokens = [];
    let bestTokenScore = -1;
    for (const candidate of tokenCandidates) {
      const t = tokenize(candidate);
      const score = t.length * 10 + t.reduce((sum, w) => sum + Math.min(w.length, 10), 0);
      if (score > bestTokenScore) {
        bestTokenScore = score;
        queryTokens = t;
      }
    }

    // üÜï –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
    const wordPermutations = opts.enableWordPermutations ? generateWordPermutations(trimmedQuery) : [];

    // === üÜï v2.6.0 PURE INTENT SEARCH ===
    if (isPureIntentSearch) {
      indexedProducts.forEach(entry => {
        const item = entry.item;
        let matchesIntent = true;
        let intentScore = 0;

        // Check nutrient rules
        for (const rule of intent.nutrient) {
          if (rule.check && !rule.check(item)) {
            matchesIntent = false;
            break;
          }
          intentScore += 20;
        }

        if (matchesIntent) {
          // Check context rules
          for (const rule of intent.context) {
            if (rule.check && !rule.check(item)) {
              matchesIntent = false;
              break;
            }

            let isBoosted = false;
            const nameNorm = entry.nameNorm;

            // Check boosted products
            if (rule.boostProducts && rule.boostProducts.some(bp => nameNorm.includes(normalizeText(bp)))) {
              isBoosted = true;
            }

            // Check boosted categories
            if (!isBoosted && rule.boostCategories) {
              rule.boostCategories.forEach(cat => {
                const catKeywords = CATEGORY_KEYWORDS[cat.toLowerCase()];
                if (catKeywords && catKeywords.some(kw => nameNorm.includes(normalizeText(kw)))) {
                  isBoosted = true;
                }
              });
            }

            if (isBoosted) {
              intentScore += 30;
            } else if (rule.boostCategories || rule.boostProducts) {
              // If rule has boost lists and item doesn't match, it's not a context match
              matchesIntent = false;
            }
          }
        }

        if (matchesIntent) {
          const key = item.id || item.name;
          results.set(key, { ...item, relevance: 50 + intentScore, matchType: 'intent' });
        }
      });

      const sorted = Array.from(results.values())
        .sort((a, b) => b.relevance - a.relevance)
        .slice(0, opts.maxResults);

      return {
        results: sorted,
        suggestions: [],
        corrections: [],
        searchTime: performance.now() - startTime,
        query: trimmedQuery
      };
    }

    // === 0. üÜï –ü–û–ò–°–ö –ü–û –ö–ê–¢–ï–ì–û–†–ò–ò ===
    const categoryResults = findCategoryProducts(trimmedQuery, dataSource);
    categoryResults.forEach(item => {
      const relevance = 80;
      const key = item.id || item.name;
      results.set(key, { ...item, relevance, matchType: 'category' });
    });

    // === 1. –¢–û–ß–ù–´–ô –ü–û–ò–°–ö (+ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è + keyboard fix) ===
    indexedProducts.forEach(entry => {
      const item = entry.item;
      const itemName = entry.nameNorm;

      // üÜï v2.5.0 Numeric-aware —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏
      const numericScore = checkNumericMatch(queryConstraints, entry.numbers);
      if (numericScore < 0.6) return; // –°–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ–µ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ

      // üÜï v2.6.0 Intent Check (Mixed Search)
      let intentBoost = 0;
      if (hasIntent) {
        let matchesIntent = true;
        for (const rule of intent.nutrient) {
          if (rule.check && !rule.check(item)) {
            matchesIntent = false;
            break;
          }
        }
        if (!matchesIntent) return; // Skip

        for (const rule of intent.context) {
          if (rule.check && !rule.check(item)) return;

          let isBoosted = false;
          if (rule.boostProducts && rule.boostProducts.some(bp => itemName.includes(normalizeText(bp)))) isBoosted = true;
          if (!isBoosted && rule.boostCategories) {
            rule.boostCategories.forEach(cat => {
              const catKeywords = CATEGORY_KEYWORDS[cat.toLowerCase()];
              if (catKeywords && catKeywords.some(kw => itemName.includes(normalizeText(kw)))) isBoosted = true;
            });
          }
          if (isBoosted) intentBoost += 20;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –≤—Å–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
      for (const variant of translitVariants) {
        if (itemName.includes(variant)) {
          const matchType = variant === normalizedQuery ? 'exact' :
            variant === keyboardFixedQuery ? 'keyboard' : 'translit';
          let relevance = calculateRelevance(item, trimmedQuery, matchType);

          // üÜï v2.5.0 Numeric adjustment
          relevance *= numericScore;

          // üÜï v2.6.0 Intent Boost
          relevance += intentBoost;

          // Token-aware –±–æ–Ω—É—Å
          const tokenScore = computeTokenMatchScore(queryTokens, itemName, entry.tokens);
          relevance += tokenScore.bonus;

          // üÜï –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±—É—Å—Ç
          if (opts.enablePersonalization) {
            relevance += getPersonalBoost(item.id);
          }

          const key = item.id || item.name;
          if (!results.has(key) || results.get(key).relevance < relevance) {
            results.set(key, {
              ...item,
              relevance,
              matchType,
              matchedVariant: variant !== normalizedQuery ? variant : undefined
            });
          }
          break; // –ù–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî –≤—ã—Ö–æ–¥–∏–º
        }
      }
    });

    // === 1.5. üÜï –ü–û–ò–°–ö –ü–û –†–ê–°–ö–†–´–¢–´–ú –°–û–ö–†–ê–©–ï–ù–ò–Ø–ú ===
    if (abbreviationExpansions.length > 0) {
      abbreviationExpansions.forEach(expanded => {
        const normalizedExpanded = normalizeText(expanded);
        indexedProducts.forEach(entry => {
          const item = entry.item;
          const itemName = entry.nameNorm;

          const numericScore = checkNumericMatch(queryConstraints, entry.numbers);
          if (numericScore < 0.6) return;
          if (itemName.includes(normalizedExpanded)) {
            let relevance = calculateRelevance(item, expanded, 'exact') - 5;
            relevance *= numericScore; // üÜï v2.5.0

            const tokenScore = computeTokenMatchScore(queryTokens, itemName, entry.tokens);
            relevance += tokenScore.bonus;
            if (opts.enablePersonalization) {
              relevance += getPersonalBoost(item.id);
            }
            const key = item.id || item.name;
            if (!results.has(key) || results.get(key).relevance < relevance) {
              results.set(key, {
                ...item,
                relevance,
                matchType: 'abbreviation',
                expandedFrom: trimmedQuery,
                expandedTo: expanded
              });
            }
          }
        });
      });
    }

    // === 1.6. üÜï –ü–û–ò–°–ö –ü–û –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê–ú –°–õ–û–í ===
    if (wordPermutations.length > 0) {
      wordPermutations.forEach(permuted => {
        const normalizedPermuted = normalizeText(permuted);
        indexedProducts.forEach(entry => {
          const item = entry.item;
          const itemName = entry.nameNorm;

          const numericScore = checkNumericMatch(queryConstraints, entry.numbers);
          if (numericScore < 0.6) return;
          if (itemName.includes(normalizedPermuted)) {
            let relevance = calculateRelevance(item, permuted, 'exact') - 3;
            relevance *= numericScore; // üÜï v2.5.0

            const tokenScore = computeTokenMatchScore(queryTokens, itemName, entry.tokens);
            relevance += tokenScore.bonus;
            if (opts.enablePersonalization) {
              relevance += getPersonalBoost(item.id);
            }
            const key = item.id || item.name;
            if (!results.has(key) || results.get(key).relevance < relevance) {
              results.set(key, {
                ...item,
                relevance,
                matchType: 'permutation',
                permutedQuery: permuted
              });
            }
          }
        });
      });
    }

    // === 1.7. üÜï TOKEN-AWARE AND-SEARCH (—Å–ª–æ–≤–∞ –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ, –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ä—è–¥) ===
    // –ü—Ä–∏–º–µ—Ä: "–≥—Ä–µ—á–∫–∞ 800" –º–∞—Ç—á–∏—Ç—Å—è —Å "–≥—Ä–µ—á–∫–∞ —è–¥—Ä–∏—Ü–∞ 800–≥"
    if (queryTokens.length > 0 && results.size < 5) {
      indexedProducts.forEach(entry => {
        const item = entry.item;

        if (checkNumericMatch(queryConstraints, entry.numbers) < 0.6) return;

        const tokenScore = computeTokenMatchScore(queryTokens, entry.nameNorm, entry.tokens);
        // –î–ª—è 1 —Ç–æ–∫–µ–Ω–∞ —Ç—Ä–µ–±—É–µ–º –≤—ã—Å–æ–∫–∏–π —Å–∏–≥–Ω–∞–ª; –¥–ª—è 2+ –¥–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ø–æ–∫—Ä—ã—Ç–∏—è.
        const threshold = queryTokens.length >= 2 ? 0.5 : 1;
        if (tokenScore.coverage < threshold) return;

        let relevance = 55 + Math.round(tokenScore.coverage * 25) + tokenScore.bonus;
        if (opts.enablePersonalization) {
          relevance += getPersonalBoost(item.id);
        }

        const key = item.id || item.name;
        if (!results.has(key) || results.get(key).relevance < relevance) {
          results.set(key, {
            ...item,
            relevance,
            matchType: 'tokens'
          });
        }
      });
    }

    // === 2. –ü–û–ò–°–ö –ü–û –°–ò–ù–û–ù–ò–ú–ê–ú ===
    if (opts.enableSynonyms) {
      const synonymList = findSynonyms(trimmedQuery);
      synonymList.forEach(synonym => {
        const normalizedSynonym = normalizeText(synonym);
        indexedProducts.forEach(entry => {
          const item = entry.item;
          const itemName = entry.nameNorm;

          if (checkNumericMatch(queryConstraints, entry.numbers) < 0.6) return;
          if (itemName.includes(normalizedSynonym)) {
            const relevance = calculateRelevance(item, synonym, 'synonym');
            const key = item.id || item.name;
            if (!results.has(key) || results.get(key).relevance < relevance) {
              results.set(key, { ...item, relevance, matchType: 'synonym', matchedSynonym: synonym });
            }
          }
        });
      });
    }

    // === 2.5. üÜï v2.7.0 –ü–û–ò–°–ö –ü–û –ë–†–ï–ù–î–ê–ú ===
    // –ò—â–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞ (Danone = –î–∞–Ω–æ–Ω = –î—ç–Ω–æ–Ω)
    let matchedBrand = null;
    if (opts.enableBrands !== false) {
      const brandVariants = findBrandVariants(trimmedQuery);
      if (brandVariants.length > 0) {
        matchedBrand = brandVariants[0]; // –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        brandVariants.forEach(variant => {
          const normalizedVariant = normalizeText(variant);
          indexedProducts.forEach(entry => {
            const item = entry.item;
            const itemName = entry.nameNorm;

            if (itemName.includes(normalizedVariant)) {
              let relevance = calculateRelevance(item, variant, 'exact') + 5; // –ë—Ä–µ–Ω–¥-–±–æ–Ω—É—Å
              if (opts.enablePersonalization) {
                relevance += getPersonalBoost(item.id);
              }
              const key = item.id || item.name;
              if (!results.has(key) || results.get(key).relevance < relevance) {
                results.set(key, {
                  ...item,
                  relevance,
                  matchType: 'brand',
                  matchedBrand: matchedBrand
                });
              }
            }
          });
        });
      }
    }

    // === 3. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–ü–ï–ß–ê–¢–û–ö (–µ—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤) ===
    if (opts.enableTypoCorrection && results.size < 3) {
      // üÜï v2.6.0: Check translit variants for typos too (e.g. "mloko" -> "–º–ª–æ–∫–æ" -> "–º–æ–ª–æ–∫–æ")
      const candidates = new Set([trimmedQuery]);
      if (opts.enableTranslit) {
        translitVariants.forEach(v => candidates.add(v));
      }

      candidates.forEach(candidate => {
        const typoCorrections = findTypoCorrections(candidate, dataSource);

        typoCorrections.slice(0, 3).forEach(correction => {
          // Avoid duplicates in corrections list
          if (!corrections.some(c => c.corrected === correction.corrected)) {
            corrections.push(correction);
          }

          const normalizedCorrected = normalizeText(correction.corrected);

          indexedProducts.forEach(entry => {
            const item = entry.item;
            const itemName = entry.nameNorm;

            if (checkNumericMatch(queryConstraints, entry.numbers) < 0.6) return;
            if (itemName.includes(normalizedCorrected)) {
              const baseRelevance = calculateRelevance(item, correction.corrected, 'typo');
              const relevance = baseRelevance * correction.confidence;
              const key = item.id || item.name;
              if (!results.has(key) || results.get(key).relevance < relevance) {
                results.set(key, {
                  ...item,
                  relevance,
                  matchType: 'typo',
                  originalQuery: trimmedQuery,
                  correctedQuery: correction.corrected,
                  confidence: correction.confidence
                });
              }
            }
          });
        });
      });
    }

    // === 4. –§–û–ù–ï–¢–ò–ß–ï–°–ö–ò–ô –ü–û–ò–°–ö (–µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –º–∞–ª–æ) ===
    if (opts.enablePhonetic && results.size < 3 && phoneticQuery !== normalizedQuery) {
      indexedProducts.forEach(entry => {
        const item = entry.item;
        const itemPhonetic = entry.namePhon;

        if (!numbersMatchAll(queryConstraints, entry.numbers)) return;
        if (itemPhonetic.includes(phoneticQuery)) {
          let relevance = calculateRelevance(item, trimmedQuery, 'phonetic');

          const tokenScore = computeTokenMatchScore(queryTokens, entry.nameNorm, entry.tokens);
          relevance += tokenScore.bonus;
          if (opts.enablePersonalization) {
            relevance += getPersonalBoost(item.id);
          }
          const key = item.id || item.name;
          if (!results.has(key) || results.get(key).relevance < relevance) {
            results.set(key, { ...item, relevance, matchType: 'phonetic' });
          }
        }
      });
    }

    // === 5. üÜï N-GRAM –ü–û–ò–°–ö (–≥–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç—è–º —Å–ª–æ–≤) ===
    if (opts.enableNgram && results.size < 5 && normalizedQuery.length >= 4) {
      const ngramResults = ngramSearch(trimmedQuery, dataSource);
      ngramResults.forEach(item => {
        let relevance = 30 + (5 - (item.ngramDistance || 0)) * 5;
        if (opts.enablePersonalization) {
          relevance += getPersonalBoost(item.id);
        }
        const key = item.id || item.name;
        if (!results.has(key)) {
          results.set(key, { ...item, relevance, matchType: 'ngram' });
        }
      });
    }

    // === 6. üÜï v2.7.0 –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–ò–ô –ü–û–ò–°–ö (ML-lite –∫–ª–∞—Å—Ç–µ—Ä—ã) ===
    // –ï—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏—â–µ–º –ø–æ —Å–º—ã—Å–ª–æ–≤—ã–º –∫–ª–∞—Å—Ç–µ—Ä–∞–º
    if (opts.enableSemantic !== false && results.size < 3) {
      const semanticResults = findSemanticMatches(trimmedQuery, dataSource, 10);
      semanticResults.forEach(item => {
        let relevance = 25; // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —ç—Ç–æ "–ø–æ—Ö–æ–∂–∏–µ" —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if (opts.enablePersonalization) {
          relevance += getPersonalBoost(item.id);
        }
        const key = item.id || item.name;
        if (!results.has(key)) {
          results.set(key, {
            ...item,
            relevance,
            matchType: 'semantic',
            semanticCluster: item.semanticCluster
          });
        }
      });
    }

    // === 7. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô ===
    if (normalizedQuery.length >= 2) {
      const suggestionSet = new Set();

      // –ò–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤
      commonWords.forEach(word => {
        if (word.startsWith(normalizedQuery) && word !== normalizedQuery) {
          suggestionSet.add(word);
        }
      });

      // –ò–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      Array.from(results.values()).slice(0, 10).forEach(result => {
        const words = normalizeText(result.name).split(/\s+/);
        words.forEach(word => {
          if (word.length > 2 && word.startsWith(normalizedQuery) && word !== normalizedQuery) {
            suggestionSet.add(word);
          }
        });
      });

      suggestions.push(...Array.from(suggestionSet).slice(0, opts.maxSuggestions));
    }

    // === –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê ===
    const finalResults = Array.from(results.values())
      .sort((a, b) => b.relevance - a.relevance)
      .slice(0, opts.maxResults || opts.limit || 50);

    const searchTime = performance.now() - startTime;

    // === üÜï v2.7.0 VISUAL FEEDBACK ‚Äî —á—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ/—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ===
    const visualFeedback = {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ–ø–µ—á–∞—Ç–∫–∏
      correctedFrom: corrections.length > 0 ? trimmedQuery : null,
      correctedTo: corrections.length > 0 ? corrections[0].corrected : null,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª —Ç—Ä–∞–Ω—Å–ª–∏—Ç (–ª–∞—Ç–∏–Ω–∏—Ü–∞ ‚Üí –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
      transliteratedFrom: finalResults.some(r => r.matchType === 'translit') ? trimmedQuery : null,
      transliteratedTo: finalResults.some(r => r.matchType === 'translit') && translitVariants.length > 0
        ? translitVariants[0] : null,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∞
      keyboardFixed: finalResults.some(r => r.matchType === 'keyboard'),
      keyboardFrom: finalResults.some(r => r.matchType === 'keyboard') ? trimmedQuery : null,
      keyboardTo: finalResults.some(r => r.matchType === 'keyboard') && keyboardVariants.length > 0
        ? keyboardVariants[0] : null,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –±—Ä–µ–Ω–¥
      matchedBrand: matchedBrand,
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –µ—Å–ª–∏ –∏—Å–∫–∞–ª–∏ –ø–æ –Ω–µ–π
      matchedCategory: finalResults.some(r => r.matchType === 'category')
        ? finalResults.find(r => r.matchType === 'category')?.matchedCategory : null,
      // Semantic cluster
      semanticCluster: finalResults.some(r => r.matchType === 'semantic')
        ? finalResults.find(r => r.matchType === 'semantic')?.semanticCluster : null
    };

    // === üÜï v2.7.0 SMART SUGGESTIONS ‚Äî –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç ===
    let smartSuggestions = null;
    if (finalResults.length === 0) {
      smartSuggestions = generateSmartSuggestions(trimmedQuery, dataSource);
    }

    const result = {
      results: finalResults,
      suggestions,
      corrections,
      searchTime: Math.round(searchTime * 100) / 100,
      query: trimmedQuery,
      totalFound: finalResults.length,
      hasTypoCorrections: corrections.length > 0,
      hasSynonyms: finalResults.some(r => r.matchType === 'synonym'),
      hasTranslit: finalResults.some(r => r.matchType === 'translit'), // üÜï
      hasKeyboardFix: finalResults.some(r => r.matchType === 'keyboard'), // üÜï
      hasAbbreviation: finalResults.some(r => r.matchType === 'abbreviation'), // üÜï
      hasPermutation: finalResults.some(r => r.matchType === 'permutation'), // üÜï
      hasCategory: finalResults.some(r => r.matchType === 'category'), // üÜï
      hasBrand: finalResults.some(r => r.matchType === 'brand'), // üÜï v2.7.0
      hasSemantic: finalResults.some(r => r.matchType === 'semantic'), // üÜï v2.7.0
      // üÜï v2.7.0 Visual Feedback
      visualFeedback,
      // üÜï v2.7.0 Smart Suggestions (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
      smartSuggestions,
      searchStats: {
        exactMatches: finalResults.filter(r => r.matchType === 'exact').length,
        translitMatches: finalResults.filter(r => r.matchType === 'translit').length, // üÜï
        keyboardMatches: finalResults.filter(r => r.matchType === 'keyboard').length, // üÜï
        abbreviationMatches: finalResults.filter(r => r.matchType === 'abbreviation').length, // üÜï
        permutationMatches: finalResults.filter(r => r.matchType === 'permutation').length, // üÜï
        categoryMatches: finalResults.filter(r => r.matchType === 'category').length, // üÜï
        ngramMatches: finalResults.filter(r => r.matchType === 'ngram').length, // üÜï
        brandMatches: finalResults.filter(r => r.matchType === 'brand').length, // üÜï v2.7.0
        semanticMatches: finalResults.filter(r => r.matchType === 'semantic').length, // üÜï v2.7.0
        typoMatches: finalResults.filter(r => r.matchType === 'typo').length,
        synonymMatches: finalResults.filter(r => r.matchType === 'synonym').length,
        phoneticMatches: finalResults.filter(r => r.matchType === 'phonetic').length
      }
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
    if (opts.cacheEnabled) {
      searchCache.set(cacheKey, { result, timestamp: Date.now() });

      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
      if (searchCache.size > 200) {
        const oldestKey = searchCache.keys().next().value;
        searchCache.delete(oldestKey);
      }
    }

    // –û—Ç–ª–∞–¥–∫–∞
    if (opts.debugMode) {
      console.group(`üîç SmartSearch: "${trimmedQuery}"`);
      console.log('‚è±Ô∏è –í—Ä–µ–º—è:', searchTime.toFixed(2), '–º—Å');
      console.log('üìä –ù–∞–π–¥–µ–Ω–æ:', finalResults.length);
      console.log('üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:', suggestions);
      console.log('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', corrections);
      console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', result.searchStats);
      console.groupEnd();
    }

    return result;
  }

  /**
   * –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
   */
  function suggest(partialQuery, dataSource, maxSuggestions = 5) {
    if (!partialQuery || partialQuery.length < 2) return [];

    const normalized = normalizeText(partialQuery);
    const suggestions = new Set();

    // –ò–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤
    commonWords.forEach(word => {
      if (word.startsWith(normalized)) {
        suggestions.add(word);
      }
    });

    // –ò–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (dataSource && Array.isArray(dataSource)) {
      dataSource.forEach(item => {
        const name = normalizeText(item.name || '');
        if (name.startsWith(normalized)) {
          suggestions.add(item.name);
        }
        // –°–ª–æ–≤–∞ –≤–Ω—É—Ç—Ä–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
        name.split(/\s+/).forEach(word => {
          if (word.length > 2 && word.startsWith(normalized)) {
            suggestions.add(word);
          }
        });
      });
    }

    return Array.from(suggestions).slice(0, maxSuggestions);
  }

  /**
   * "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∏ –ø—Ä–∏—á–∏–Ω–æ–π
   */
  function getDidYouMean(query, dataSource, maxSuggestions = 3) {
    if (!query || query.length < 2) return [];

    const normalized = normalizeText(query);
    const suggestions = [];
    const seen = new Set();

    // üÜï 0. –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ
    if (CONFIG.enableTranslit) {
      const canonical = getCanonicalForm(query);
      if (canonical && !seen.has(canonical)) {
        suggestions.push({
          text: canonical,
          reason: 'translit',
          label: 'üåê —Ç—Ä–∞–Ω—Å–ª–∏—Ç'
        });
        seen.add(canonical);
      }

      // –¢–∞–∫–∂–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
      const transliterated = transliterate(query);
      if (transliterated !== normalized && !seen.has(transliterated)) {
        suggestions.push({
          text: transliterated,
          reason: 'translit',
          label: 'üåê —Ç—Ä–∞–Ω—Å–ª–∏—Ç'
        });
        seen.add(transliterated);
      }
    }

    // 1. –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å = —Å–∏–Ω–æ–Ω–∏–º, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–ª–æ–≤–æ)
    for (const [mainWord, syns] of Object.entries(synonyms)) {
      if (syns.some(s => normalizeText(s) === normalized || s.includes(normalized))) {
        if (!seen.has(mainWord)) {
          suggestions.push({
            text: mainWord,
            reason: 'synonym',
            label: '‚âà —Å–∏–Ω–æ–Ω–∏–º'
          });
          seen.add(mainWord);
        }
      }
    }

    // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫ ‚Äî –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ —Å–ª–æ–≤–∞ –∏–∑ dataSource
    if (dataSource && Array.isArray(dataSource)) {
      const maxDist = CONFIG.getMaxTypoDistance(normalized.length);
      const candidates = [];

      dataSource.forEach(item => {
        const name = normalizeText(item.name || '');
        const words = name.split(/\s+/);

        words.forEach(word => {
          if (word.length < 2 || seen.has(word)) return;

          const dist = levenshteinDistance(normalized, word, maxDist + 1);
          if (dist > 0 && dist <= maxDist) {
            candidates.push({
              text: word,
              distance: dist,
              reason: 'typo',
              label: 'üîß –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'
            });
            seen.add(word);
          }
        });
      });

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –∏ –±–µ—Ä—ë–º –ª—É—á—à–∏–µ
      candidates.sort((a, b) => a.distance - b.distance);
      suggestions.push(...candidates.slice(0, maxSuggestions - suggestions.length));
    }

    // 3. –ü–æ—Ö–æ–∂–∏–µ –ø–æ –Ω–∞—á–∞–ª—É —Å–ª–æ–≤–∞ (–∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
    if (suggestions.length < maxSuggestions && dataSource) {
      const completions = [];

      dataSource.forEach(item => {
        const name = item.name || '';
        const normalizedName = normalizeText(name);

        if (normalizedName.startsWith(normalized) && !seen.has(normalizedName)) {
          completions.push({
            text: name,
            reason: 'completion',
            label: '‚Üí –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ'
          });
          seen.add(normalizedName);
        }
      });

      suggestions.push(...completions.slice(0, maxSuggestions - suggestions.length));
    }

    return suggestions.slice(0, maxSuggestions);
  }

  /**
   * –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç–µ
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —á–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞ —Å —Ñ–ª–∞–≥–æ–º isMatch
   * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   * @returns {Array<{text: string, isMatch: boolean}>}
   */
  function highlightMatches(text, query) {
    if (!text || !query) {
      return [{ text: text || '', isMatch: false }];
    }

    const normalizedText = normalizeText(text);
    const normalizedQuery = normalizeText(query);
    const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length >= 2);

    if (queryWords.length === 0) {
      return [{ text, isMatch: false }];
    }

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    const matches = [];

    // üÜï –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ (–≤–∫–ª—é—á–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é)
    const allVariants = new Set();
    queryWords.forEach(queryWord => {
      allVariants.add(queryWord);

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã
      const synonymList = findSynonyms(queryWord);
      synonymList.forEach(syn => allVariants.add(syn));

      // üÜï –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
      if (CONFIG.enableTranslit) {
        const translitVariants = getTranslitVariants(queryWord);
        translitVariants.forEach(v => allVariants.add(v));
      }
    });

    // –ò—â–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ
    allVariants.forEach(variant => {
      let searchIndex = 0;
      while (true) {
        const pos = normalizedText.indexOf(variant, searchIndex);
        if (pos === -1) break;

        matches.push({
          start: pos,
          end: pos + variant.length
        });
        searchIndex = pos + 1;
      }
    });

    if (matches.length === 0) {
      return [{ text, isMatch: false }];
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
    matches.sort((a, b) => a.start - b.start);
    const merged = [matches[0]];

    for (let i = 1; i < matches.length; i++) {
      const last = merged[merged.length - 1];
      const current = matches[i];

      if (current.start <= last.end) {
        last.end = Math.max(last.end, current.end);
      } else {
        merged.push(current);
      }
    }

    // –°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ —á–∞—Å—Ç–µ–π
    // –í–∞–∂–Ω–æ: –ø–æ–∑–∏—Ü–∏–∏ –≤ normalizedText –º–æ–≥—É—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å text –∏–∑-–∑–∞ —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã —Å–∏–º–≤–æ–ª–æ–≤
    // –ü–æ—ç—Ç–æ–º—É —Ä–∞–±–æ—Ç–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ lowercase
    const lowerText = text.toLowerCase().replace(/—ë/g, '–µ');
    const parts = [];
    let lastEnd = 0;

    merged.forEach(match => {
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
      if (match.start > lastEnd) {
        parts.push({
          text: text.substring(lastEnd, match.start),
          isMatch: false
        });
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä –∏–∑ text)
      parts.push({
        text: text.substring(match.start, match.end),
        isMatch: true
      });

      lastEnd = match.end;
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Ç–µ–∫—Å—Ç–∞
    if (lastEnd < text.length) {
      parts.push({
        text: text.substring(lastEnd),
        isMatch: false
      });
    }

    return parts;
  }

  /**
   * –†–µ–Ω–¥–µ—Ä –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (React —ç–ª–µ–º–µ–Ω—Ç—ã)
   * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
   * @param {string} query - –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å  
   * @param {Object} React - React –æ–±—ä–µ–∫—Ç
   * @returns {Array} –º–∞—Å—Å–∏–≤ React —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   */
  function renderHighlightedText(text, query, React) {
    if (!React) {
      console.warn('renderHighlightedText: React –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω');
      return text;
    }

    const parts = highlightMatches(text, query);

    return parts.map((part, i) => {
      if (part.isMatch) {
        return React.createElement('mark', {
          key: i,
          className: 'search-highlight',
          style: {
            backgroundColor: 'rgba(255, 213, 0, 0.35)', // –ü—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π –∂—ë–ª—Ç—ã–π
            borderRadius: '2px',
            padding: '0 1px'
          }
        }, part.text);
      }
      return part.text;
    });
  }

  /**
   * –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
   */
  function clearCache() {
    searchCache.clear();
    productIndex = null;
    lastProductsHash = null;
    if (CONFIG.debugMode) console.log('üßπ SmartSearch: –∫–µ—à –æ—á–∏—â–µ–Ω');
  }

  /**
   * –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞
   */
  function getStats() {
    return {
      cacheSize: searchCache.size,
      commonWordsCount: commonWords.size,
      synonymsCount: Object.keys(synonyms).length,
      phoneticRulesCount: phoneticRules.length,
      translitPairsCount: Object.keys(TRANSLIT_PAIRS).length,
      spellingVariantsCount: Object.keys(SPELLING_VARIANTS).length,
      abbreviationsCount: Object.keys(ABBREVIATIONS).length,
      categoriesCount: Object.keys(CATEGORY_KEYWORDS).length,
      userStatsCount: userProductStats.size,
      config: { ...CONFIG }
    };
  }

  // === API ===
  const SmartSearchWithTypos = {
    // –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–∏—Å–∫
    search: smartSearch,

    // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    suggest,

    // "–í–æ–∑–º–æ–∂–Ω–æ –≤—ã –∏—Å–∫–∞–ª–∏" ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    getDidYouMean,

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    highlightMatches,

    // –†–µ–Ω–¥–µ—Ä –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (React)
    renderHighlightedText,

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
    correctTypos: findTypoCorrections,

    // –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
    findSynonyms,

    // üÜï –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    transliterate,

    // üÜï –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ (–≤–∫–ª. —Ç—Ä–∞–Ω—Å–ª–∏—Ç)
    getTranslitVariants,

    // üÜï –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞
    detectLanguage,

    // üÜï –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ —Å–ª–æ–≤–∞
    getCanonicalForm,

    // üÜï –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞—Å–∫–ª–∞–¥–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    convertKeyboardLayout,

    // üÜï –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π  
    expandAbbreviations,

    // üÜï –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤
    generateWordPermutations,

    // üÜï N-gram –ø–æ–∏—Å–∫
    ngramSearch,

    // üÜï –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    findCategoryProducts,

    // üÜï v2.7.0 –ü–æ–∏—Å–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –±—Ä–µ–Ω–¥–∞
    findBrandVariants,

    // üÜï v2.7.0 –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (ML-lite)
    findSemanticMatches,

    // üÜï v2.7.0 –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    generateSmartSuggestions,

    // üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —Ç—Ä–µ–∫–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
    trackProductUsage,

    // üÜï –î–æ—Å—Ç—É–ø –∫ usage stats
    getUsageStats,
    syncUsageStatsFromDays,
    ensureUsageStatsFresh,

    // üÜï –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    saveUserStats,

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞
    configure(newConfig) {
      Object.assign(CONFIG, newConfig);
    },

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
    addSynonyms(word, synonymList) {
      const key = normalizeText(word);
      if (!synonyms[key]) synonyms[key] = [];
      synonymList.forEach(s => {
        const normalized = normalizeText(s);
        if (!synonyms[key].includes(normalized)) {
          synonyms[key].push(normalized);
        }
      });
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
    addTranslitPairs(pairs) {
      Object.entries(pairs).forEach(([key, value]) => {
        const normalizedKey = normalizeText(key);
        const normalizedValue = normalizeText(value);
        TRANSLIT_PAIRS[normalizedKey] = normalizedValue;
        TRANSLIT_PAIRS[normalizedValue] = normalizedKey;
      });
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
    addSpellingVariants(canonical, variants) {
      const normalizedCanonical = normalizeText(canonical);
      if (!SPELLING_VARIANTS[normalizedCanonical]) {
        SPELLING_VARIANTS[normalizedCanonical] = [];
      }
      variants.forEach(v => {
        const normalized = normalizeText(v);
        if (!SPELLING_VARIANTS[normalizedCanonical].includes(normalized)) {
          SPELLING_VARIANTS[normalizedCanonical].push(normalized);
        }
      });
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
    addAbbreviations(abbr, meanings) {
      const key = normalizeText(abbr);
      ABBREVIATIONS[key] = meanings.map(m => normalizeText(m));
    },

    // üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    addCategoryKeywords(category, keywords) {
      CATEGORY_KEYWORDS[category] = keywords;
    },

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤
    addCommonWords(words) {
      words.forEach(word => commonWords.add(normalizeText(word)));
    },

    // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
    clearCache,

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    getStats,

    // –£—Ç–∏–ª–∏—Ç—ã (–¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
    utils: {
      normalizeText,
      phoneticNormalize,
      levenshteinDistance,
      calculateRelevance,
      highlightMatches,
      renderHighlightedText,
      transliterate,
      getTranslitVariants,
      detectLanguage,
      getCanonicalForm,
      convertKeyboardLayout,
      expandAbbreviations,
      generateWordPermutations,
      getPersonalBoost,
      // üÜï v2.7.0
      findBrandVariants,
      findSemanticMatches,
      generateSmartSuggestions
    },

    // üÜï v2.7.0 –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è UI
    BRAND_DICTIONARY,
    SEMANTIC_CLUSTERS,
    SMART_SUGGESTIONS_CONFIG
  };

  // –≠–∫—Å–ø–æ—Ä—Ç
  HEYS.SmartSearchWithTypos = SmartSearchWithTypos;
  HEYS.SmartSearch = SmartSearchWithTypos; // alias

  // Verbose init log removed

})(typeof window !== 'undefined' ? window : globalThis);
