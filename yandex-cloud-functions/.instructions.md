---
applyTo: '**/*.js'
description: Правила для Yandex Cloud Functions (serverless API)
---

# Yandex Cloud Functions — правила разработки

## Формат функций

- Entry point: `index.js` →
  `module.exports.handler = async (event, context) => { ... }`
- Каждая функция — отдельная директория со своим `package.json`
- Node.js runtime, CommonJS (`require`/`module.exports`)
- SSL: сертификаты в `certs/`, подключение через `pg` с `ssl: { ca }`

## Безопасность (критично!)

- **Всегда `*_by_session`** — никогда не принимать `client_id` напрямую
- `require_client_id(session_token)` — для извлечения client_id из сессии
- CORS: только `app.heyslab.ru`, `heyslab.ru`
- Env-переменные: редактировать ТОЛЬКО через YC Console (CLI выводит PG_PASSWORD
  в stdout)

## Паттерны

```javascript
// ✅ RPC вызов
const result = await pool.query(
  'SELECT * FROM public.my_function_by_session($1)',
  [sessionToken],
);

// ✅ CORS headers
const corsHeaders = {
  'Access-Control-Allow-Origin': allowedOrigins.includes(origin) ? origin : '',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type',
};

// ❌ Никогда
pool.query('SELECT * FROM clients WHERE id = $1', [clientId]); // IDOR!
```

## DB Pool

- Использовать `shared/db-pool.js` или локальный `db-pool.js`
- Хост: `rc1b-obkgs83tnrd6a2m3.mdb.yandexcloud.net:6432`
- SSL: `verify-full`
- `max: 3` (serverless = короткоживущие соединения)

## Деплой

- Через YC Console или CI (`yc serverless function create-version`)
- Миграции: `heys-api-rpc/apply_migrations.js`
- Health check: `heys-api-health/index.js`
