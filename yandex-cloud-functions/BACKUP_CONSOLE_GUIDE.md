# Yandex Cloud Console Configuration Guide

## Task 1.7: Enable Auto-Backup in Yandex Cloud

Эта задача выполняется вручную через Yandex Cloud Console.

### Шаги для включения автоматического бэкапа:

#### 1. Открыть Managed Service for PostgreSQL

1. Перейдите на [console.cloud.yandex.ru](https://console.cloud.yandex.ru/)
2. Выберите нужный каталог (folder)
3. В меню слева выберите **"Managed Service for PostgreSQL"**
4. В списке кластеров найдите **`heys_production`** (или ваше название кластера)
5. Нажмите на название кластера для открытия деталей

#### 2. Настроить параметры резервного копирования

1. В левом меню кластера выберите раздел **"Резервные копии"** (Backup)
2. Нажмите кнопку **"Настроить"** или **"Изменить настройки"**
3. Установите следующие параметры:

   **Автоматическое резервное копирование:**
   - ✅ Включить автоматическое резервное копирование
   
   **Время начала резервного копирования:**
   - Установите: `03:00` UTC
   - Примечание: это время начала окна резервного копирования
   
   **Срок хранения резервных копий:**
   - Установите: `7 дней`
   - Для продакшн систем рекомендуется: 7-30 дней
   
   **Тип резервной копии:**
   - Рекомендуется: `Incremental` (инкрементальная)
   - Первая копия будет полной, последующие — инкрементальными

4. Нажмите **"Сохранить изменения"**

#### 3. Проверить настройки

После сохранения настроек:

1. В разделе **"Резервные копии"** должна отображаться информация:
   - Время следующего резервного копирования
   - Список существующих резервных копий
   - Размер резервных копий

2. Дождитесь первого автоматического бэкапа (в 03:00 UTC следующего дня)

3. После создания первого бэкапа проверьте:
   - Появилась ли новая резервная копия в списке
   - Размер резервной копии
   - Статус: `Available` (Доступна)

#### 4. Настройка уведомлений (опционально)

Для получения уведомлений о проблемах с бэкапами:

1. Перейдите в **"Monitoring"** → **"Alerting"**
2. Создайте новое правило алертинга:
   - **Metric**: `postgres.backup.status`
   - **Condition**: `status != success`
   - **Notification channel**: Email или Telegram
3. Сохраните правило

### Проверка автоматического бэкапа

#### Через консоль:

1. Перейдите в раздел **"Резервные копии"** вашего кластера
2. Проверьте список резервных копий
3. Убедитесь, что автоматические копии создаются ежедневно

#### Через CLI:

```bash
# Список всех резервных копий кластера
yc managed-postgresql backup list --folder-id=<FOLDER_ID>

# Детальная информация о резервной копии
yc managed-postgresql backup get <BACKUP_ID>
```

### Восстановление из резервной копии

Если потребуется восстановить данные:

#### Через консоль:

1. Перейдите в раздел **"Резервные копии"**
2. Найдите нужную резервную копию
3. Нажмите **"Восстановить"**
4. Выберите:
   - Восстановить в новый кластер (безопаснее)
   - Или восстановить в существующий кластер
5. Следуйте указаниям мастера восстановления

#### Через CLI:

```bash
# Восстановление в новый кластер
yc managed-postgresql cluster restore \
  --backup-id=<BACKUP_ID> \
  --name=heys-production-restored \
  --environment=production \
  --network-name=default \
  --folder-id=<FOLDER_ID>

# Point-in-Time Recovery (восстановление на конкретный момент времени)
yc managed-postgresql cluster restore \
  --backup-id=<BACKUP_ID> \
  --time="2026-01-23T12:00:00Z" \
  --name=heys-production-restored \
  --environment=production \
  --network-name=default \
  --folder-id=<FOLDER_ID>
```

### Стоимость

**Хранение резервных копий:**
- Первые 7 дней: **Бесплатно**
- После 7 дней: ~0.03₽ за ГБ в день
- Инкрементальные копии занимают меньше места

**Пример расчёта:**
- Размер БД: 5 ГБ
- Срок хранения: 7 дней
- Стоимость: **0₽** (в пределах бесплатного лимита)

Если увеличить срок хранения до 30 дней:
- 5 ГБ × 23 дня × 0.03₽ = ~**3.45₽ в день** = ~**100₽ в месяц**

### Мониторинг

Следите за следующими метриками:

1. **Размер резервных копий** (должен расти постепенно)
2. **Время создания** (должно укладываться в окно обслуживания)
3. **Статус** (все копии должны быть `Available`)
4. **Возраст старейшей копии** (не должен превышать retention period)

### Тестирование восстановления

**Рекомендуется** периодически тестировать восстановление:

1. Раз в месяц создавайте тестовое восстановление
2. Проверяйте целостность данных
3. Измеряйте время восстановления (RTO - Recovery Time Objective)
4. Документируйте процесс

### Troubleshooting

#### Проблема: Резервная копия не создаётся

**Решения:**
1. Проверьте, включено ли автоматическое резервное копирование
2. Проверьте логи кластера: `yc managed-postgresql cluster list-logs`
3. Проверьте, достаточно ли места в storage quota
4. Обратитесь в поддержку Yandex Cloud

#### Проблема: Резервная копия слишком большая

**Решения:**
1. Используйте инкрементальное резервное копирование
2. Очистите временные таблицы перед бэкапом
3. Архивируйте старые данные отдельно

#### Проблема: Восстановление занимает слишком много времени

**Решения:**
1. Используйте более мощный кластер для восстановления
2. Рассмотрите использование Point-in-Time Recovery только для критичных данных
3. Создайте read-replica для быстрого переключения

### Альтернативы и дополнения

Помимо встроенных бэкапов Yandex Cloud, рекомендуется использовать:

1. **Custom Backup Function** (heys-backup) — см. `heys-backup/README.md`
   - Загрузка в Object Storage (S3)
   - Долгосрочное хранение
   - Независимость от платформы

2. **Репликация в другой регион** (для катастрофоустойчивости)
   - Настройка cross-region replica
   - Автоматическое failover

3. **Экспорт критичных таблиц в JSON** (для быстрого доступа)
   - Периодический экспорт в Object Storage
   - Версионирование данных

---

## Чек-лист выполнения Task 1.7

- [ ] Открыл Yandex Cloud Console
- [ ] Перешёл в Managed Service for PostgreSQL
- [ ] Нашёл кластер `heys_production`
- [ ] Открыл раздел "Резервные копии"
- [ ] Включил автоматическое резервное копирование
- [ ] Установил время начала: `03:00 UTC`
- [ ] Установил срок хранения: `7 дней`
- [ ] Сохранил изменения
- [ ] Проверил настройки в консоли
- [ ] Дождался первого автоматического бэкапа (на следующий день)
- [ ] Проверил, что бэкап создался успешно
- [ ] Настроил уведомления (опционально)
- [ ] Протестировал восстановление (рекомендуется)

---

**Дата выполнения**: _____________  
**Выполнил**: _____________  
**Проверено**: _____________

**Статус**: ⬜ Не выполнено | ⬜ В процессе | ⬜ Выполнено

---

**Примечание**: Эта задача выполняется вручную через веб-интерфейс и не может быть автоматизирована в коде.
