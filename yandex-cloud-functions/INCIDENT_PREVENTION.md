# üõ°Ô∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ —Å production API

## üìã –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ (11 —Ñ–µ–≤—Ä–∞–ª—è 2026)

**–ü—Ä–æ–±–ª–µ–º–∞**: REST API –Ω–∞—á–∞–ª –æ—Ç–¥–∞–≤–∞—Ç—å 502 Bad Gateway –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ `aee255cc`

**Root Cause**:

- GitHub Actions workflow `cloud-functions-deploy.yml` –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è (26s elapsed)
- Production —Ñ—É–Ω–∫—Ü–∏—è `heys-api-rest` –Ω–µ –±—ã–ª–∞ –ø–µ—Ä–µ—Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  `.ycignore` —Ñ–∞–π–ª–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø—Ä–æ–±–ª–µ–º—É —Å—Ä–∞–∑—É (—Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ 09:00-23:00 MSK)
- –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ `./deploy-all.sh heys-api-rest` –∏—Å–ø—Ä–∞–≤–∏–ª —Å–∏—Ç—É–∞—Ü–∏—é

**Impact**: –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –º–æ–≥–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ (–∑–∞–ø–∏—Å—å –≤ `client_kv_store`) ~1
—á–∞—Å

---

## ‚úÖ –í–Ω–µ–¥—Ä—ë–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã (11 —Ñ–µ–≤—Ä–∞–ª—è 2026)

### 1. **24/7 –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (–±—ã–ª–æ: —Ç–æ–ª—å–∫–æ –¥–Ω—ë–º)

```yaml
# –ë–´–õ–û: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω, 09:00-23:00 MSK
- cron: '*/5 6-20 * * *'

# –°–¢–ê–õ–û: –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω, –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ
- cron: '*/15 * * * *'
```

**–ü–æ—á–µ–º—É 15 –º–∏–Ω –≤–º–µ—Å—Ç–æ 5?** –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –±—ã—Å—Ç—Ä—ã–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ–º –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ–º
–Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API (96 vs 288 –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –¥–µ–Ω—å).

### 2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π re-deploy** –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º

```yaml
- name: Auto-redeploy on API failure
  if:
    failure() && (steps.rest.outcome == 'failure' || steps.rpc.outcome ==
    'failure')
  uses: actions/github-script@v7
  with:
    script: |
      await github.rest.actions.createWorkflowDispatch({
        workflow_id: 'cloud-functions-deploy.yml',
        ref: 'main',
        inputs: { function_name: 'all' }
      });
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç 502 –Ω–∞ REST/RPC
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –ø–æ–ª–Ω—ã–π re-deploy –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram alert —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ –∑–∞–ø—É—Å–∫–µ re-deploy

### 3. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π deployment verification**

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:

- ‚úÖ Health endpoint (–±—ã–ª–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ)
- ‚úÖ RPC endpoint
- ‚úÖ REST endpoint (–∫—Ä–∏—Ç–∏—á–Ω—ã–π ‚Äî –∏–º–µ–Ω–Ω–æ –æ–Ω –ø–∞–¥–∞–ª)
- ‚è±Ô∏è –£–≤–µ–ª–∏—á–µ–Ω warmup timeout: 10s ‚Üí 15s

### 4. **–£–ª—É—á—à–µ–Ω–Ω—ã–µ Telegram alerts**

- üìä HTTP –∫–æ–¥—ã –≤—Å–µ—Ö endpoints
- üîÑ –°—Ç–∞—Ç—É—Å auto-redeploy (TRIGGERED / –Ω–µ –Ω—É–∂–µ–Ω)
- üìù –ß—ë—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞

---

## üöÄ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π API

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

```bash
cd yandex-cloud-functions

# 1. –í–∞–ª–∏–¥–∞—Ü–∏—è .env (—Å–µ–∫—Ä–µ—Ç—ã, –ø–∞—Ä–æ–ª–∏)
./validate-env.sh

# 2. Health check BEFORE deploy
./health-check.sh

# 3. Deploy changed function
./deploy-all.sh heys-api-rest  # –∏–ª–∏ ./deploy-all.sh –¥–ª—è –≤—Å–µ—Ö

# 4. –ü–æ–¥–æ–∂–¥–∞—Ç—å 15 —Å–µ–∫—É–Ω–¥ (warmup)
sleep 15

# 5. Verify deployment
./health-check.sh
```

**–ï—Å–ª–∏ `health-check.sh` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ‚ùå –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è ‚Äî –ù–ï –ö–û–ú–ú–ò–¢–ò–¢–¨!**

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ push –≤ main

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ GitHub Actions
gh run watch  # –∏–ª–∏ –æ—Ç–∫—Ä–æ–π https://github.com/kinderlystv-png/HEYS-v2/actions

# –ï—Å–ª–∏ workflow –ø—Ä–æ–≤–∞–ª–µ–Ω:
1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: gh run view <run_id> --log
2. –ï—Å–ª–∏ CI/CD —É–ø–∞–ª ‚Äî –ø—É—à–Ω–∏ —Ñ–∏–∫—Å –∏ —Å–Ω–æ–≤–∞ –∑–∞–¥–µ–ø–ª–æ–π
3. –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–∞–ª–∞ ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏ ./deploy-all.sh
```

---

## üîß –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ auto-deploy –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: REST endpoint 502

```bash
cd yandex-cloud-functions
./deploy-all.sh heys-api-rest
sleep 15
./health-check.sh
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í—Å–µ endpoints 502

```bash
cd yandex-cloud-functions
./deploy-all.sh  # –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
sleep 30
./health-check.sh --watch  # Continuous monitoring
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Rollback (–æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É)

```bash
git log --oneline -5  # –ù–∞–π–¥–∏ last working commit
git reset --hard <commit_hash>
cd yandex-cloud-functions
./deploy-all.sh
git push --force
```

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï**: `--force` –∑–∞—Ç—Ä—ë—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤!

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### 1. GitHub Actions Dashboard

https://github.com/kinderlystv-png/HEYS-v2/actions

**–û—Ç—Å–ª–µ–∂–∏–≤–∞–π**:

- ‚úÖ `API Health Monitor` ‚Äî –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω
- üöÄ `Auto-deploy Cloud Functions` ‚Äî –ø—Ä–∏ push –≤ main

### 2. –õ–æ–∫–∞–ª—å–Ω—ã–π watch mode

```bash
cd yandex-cloud-functions
./health-check.sh --watch  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
```

### 3. Telegram –±–æ—Ç (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

–ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç:

```
üö® HEYS API Health Check Failed

‚ùå One or more endpoints down
üïê Time: 2026-02-11 10:00:00 UTC

*Health*: 200
*RPC*: 200
*REST*: 502 ‚Üê –ü–†–û–ë–õ–ï–ú–ê
*Auth*: 401

üîÑ Auto-redeploy: TRIGGERED
üìù Action: Monitor workflow or run `./deploy-all.sh` manually
```

---

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã 502 Bad Gateway

### 1. **Timeout/Memory issues** (–Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–∞—è)

- Function –Ω–µ —É—Å–ø–µ–ª–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –∑–∞ 30s (execution_timeout)
- –ò—Å—á–µ—Ä–ø–∞–Ω–∞ –ø–∞–º—è—Ç—å (128-256 MB)

**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–∏—Ç—å `--memory` –∏ `--execution-timeout` –≤ `deploy-all.sh`

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ environment variables**

- –ü—É—Å—Ç–æ–π/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `PG_PASSWORD`
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `JWT_SECRET`

**–†–µ—à–µ–Ω–∏–µ**: `./validate-env.sh` –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

### 3. **Database connection issues**

- –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (Yandex Cloud maintenance)
- Connection pool exhausted

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ë–î –≤ Yandex Cloud Console

### 4. **Cold start timeout**

- –§—É–Ω–∫—Ü–∏—è –Ω–µ –ø—Ä–æ–≥—Ä–µ–ª–∞—Å—å –∑–∞ 10s (–±—ã–ª–æ)
- –†–µ—à–µ–Ω–æ: —É–≤–µ–ª–∏—á–µ–Ω warmup –¥–æ 15s

### 5. **Broken dependencies** (—Ä–µ–¥–∫–æ)

- –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è Node.js API —Å–ª–æ–º–∞–ª–∞ –∫–æ–¥
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç package –≤ `package.json`

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ Yandex Cloud Console

---

## üìù –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —É—Ä–æ–∫–∏

### ‚úÖ –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ

1. –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ `./deploy-all.sh` –±—ã—Å—Ç—Ä–æ –∏—Å–ø—Ä–∞–≤–∏–ª –ø—Ä–æ–±–ª–µ–º—É
2. `health-check.sh` —á—ë—Ç–∫–æ –ø–æ–∫–∞–∑–∞–ª, –∫–∞–∫–æ–π endpoint —Å–ª–æ–º–∞–Ω
3. –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ–º–æ–≥–ª–∏ –±—ã—Å—Ç—Ä–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å 502

### ‚ùå –ß—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ

1. CI/CD –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–∏ –¥–µ–ø–ª–æ–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π)
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ –¥–Ω—ë–º ‚Äî –Ω–æ—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –º–æ–≥–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è –Ω–µ–∑–∞–º–µ—á–µ–Ω–Ω—ã–º–∏
3. –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ rollback –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ –¥–µ–ø–ª–æ—è

### üîÑ –ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ

1. ‚úÖ 24/7 –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–º–µ—Å—Ç–æ 09:00-23:00
2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π re-deploy –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ 502
3. ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ CI/CD (Health + RPC + REST)
4. ‚úÖ Warmup —É–≤–µ–ª–∏—á–µ–Ω 10s ‚Üí 15s
5. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–µ Telegram alerts —Å HTTP –∫–æ–¥–∞–º–∏

---

## üéØ –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏

**–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏**:

- üéØ Uptime: 99.9% (–¥–æ–ø—É—Å—Ç–∏–º–æ 43 –º–∏–Ω downtime –≤ –º–µ—Å—è—Ü)
- ‚ö° MTTR (Mean Time To Recovery): < 15 –º–∏–Ω
- üîî MTTD (Mean Time To Detection): < 30 –º–∏–Ω

**–¢–µ–∫—É—â–∏–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç**:

- ‚è±Ô∏è Downtime: ~1 —á–∞—Å (REST endpoint)
- üîî Detection: –º–∞–Ω—É–∞–ª—å–Ω–∞—è (–∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞)
- ‚ö° Recovery: ~2 –º–∏–Ω (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `./deploy-all.sh`)

**–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π (–ø—Ä–æ–≥–Ω–æ–∑)**:

- üîî Detection: < 15 –º–∏–Ω (–∞–≤—Ç–æ–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω)
- ‚ö° Recovery: < 10 –º–∏–Ω (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π re-deploy + 15s warmup)
- üéØ Uptime: 99.95%+ (–±–ª–∞–≥–æ–¥–∞—Ä—è auto-healing)

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [MONITORING_QUICK_REF.md](./MONITORING_QUICK_REF.md) ‚Äî –±—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è
  –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [DEPLOYMENT_GUIDE.md](../docs/DEPLOYMENT_GUIDE.md) ‚Äî –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è
- [GitHub Actions](https://github.com/kinderlystv-png/HEYS-v2/actions) ‚Äî —Å—Ç–∞—Ç—É—Å
  CI/CD
- [Yandex Cloud Functions Console](https://console.yandex.cloud/folders/b1gnv1a4q8i6de6atl6n/serverless/functions)
  ‚Äî –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–π
