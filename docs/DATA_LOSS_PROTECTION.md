# üõ°Ô∏è HEYS Data Loss Protection

> **v2.1** | 2026-01-25 (upd. 2026-02-26) | –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–≤–Ω–∏–∫–∞ –ø–∏—Ç–∞–Ω–∏—è. –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –¥–Ω–µ–π —Å
meals –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ **–≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö**:

| –£—Ä–æ–≤–µ–Ω—å                                   | –ó–∞—â–∏—Ç–∞                          | –°—Ç–∞—Ç—É—Å |
| ----------------------------------------- | ------------------------------- | ------ |
| SQL ‚Äî `write_client_kv_value`             | `check_day_overwrite_allowed()` | ‚úÖ     |
| SQL ‚Äî `upsert_client_kv_by_session`       | –ß–µ—Ä–µ–∑ `write_client_kv_value`   | ‚úÖ     |
| SQL ‚Äî `batch_upsert_client_kv_by_session` | –ß–µ—Ä–µ–∑ `write_client_kv_value`   | ‚úÖ     |
| REST API ‚Äî POST `client_kv_store`         | `safe_upsert_client_kv()`       | ‚úÖ     |
| Client JS                                 | `saveClientKey()` –ø—Ä–æ–≤–µ—Ä–∫–∞      | ‚úÖ     |
| Sync Phase A                              | –í–æ–æ–±—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `dayv2`    | ‚úÖ     |
| Cascade Guard v6.2                        | –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π guard UI-—Å–ª–æ–π        | ‚úÖ     |

---

## üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞—â–∏—Ç–∞

### 1. –§—É–Ω–∫—Ü–∏—è `check_day_overwrite_allowed()`

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –¥–µ–Ω—å?
-- Returns FALSE –µ—Å–ª–∏:
--   1. –ö–ª—é—á ‚Äî —ç—Ç–æ –¥–µ–Ω—å (heys_dayv2_*)
--   2. –í –ë–î –µ—Å—Ç—å meals –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
--   3. –í –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö meals = 0 –∏–ª–∏ –ø—É—Å—Ç–æ–π
```

### 2. –ê—É–¥–∏—Ç —Ç–∞–±–ª–∏—Ü–∞ `data_loss_audit`

–õ–æ–≥–∏—Ä—É–µ—Ç –í–°–ï –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –¥–Ω–µ–π:

| –ö–æ–ª–æ–Ω–∫–∞          | –û–ø–∏—Å–∞–Ω–∏–µ                                |
| ---------------- | --------------------------------------- |
| `client_id`      | ID –∫–ª–∏–µ–Ω—Ç–∞                              |
| `key`            | –ö–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä `heys_dayv2_2026-01-25`) |
| `action`         | `allow` –∏–ª–∏ `block`                     |
| `reason`         | –ü—Ä–∏—á–∏–Ω–∞ (empty_meals_blocked, etc)      |
| `existing_meals` | –ö–æ–ª-–≤–æ meals –≤ –ë–î                       |
| `new_meals`      | –ö–æ–ª-–≤–æ meals –≤ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö             |

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
-- –ü–æ–ª—É—á–∏—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞ 24—á
SELECT * FROM get_recent_data_loss_alerts(24);

-- –ù–∞–π—Ç–∏ "–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ" –¥–Ω–∏ (–±—ã–ª–∏ meals, —Å—Ç–∞–ª–∏ 0)
SELECT * FROM check_suspicious_days(7);
```

---

## ÔøΩ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–º Sync

–° –≤–≤–µ–¥–µ–Ω–∏–µ–º Cascade Guard v6.2 –∏ –¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–≥–æ `heysSyncCompleted` (—Å–º.
[SYNC_REFERENCE.md ¬ß2](SYNC_REFERENCE.md)) —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º
–æ–±—Ä–∞–∑–æ–º:

| –§–∞–∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏                                | `heys_dayv2_*` –≤–∫–ª—é—á–µ–Ω—ã? | –†–∏—Å–∫ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏          | –°—Ç–∞—Ç—É—Å       |
| ------------------------------------------------- | ------------------------ | ------------------------ | ------------ |
| **Phase A** (`phaseA: true`) ‚Äî 5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π | ‚ùå –ù–µ—Ç                   | –ù–µ—Ç —Ä–∏—Å–∫–∞                | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Phase B** (`phase: 'full'`) ‚Äî 530+ –∫–ª—é—á–µ–π       | ‚úÖ –î–∞                    | –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è SQL guard | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ  |

**–í—ã–≤–æ–¥:** Phase A –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –¥–Ω–µ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–æ–±—â–µ, –ø–æ—ç—Ç–æ–º—É SQL guard
–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ Phase B. `check_day_overwrite_allowed()` –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª—é–±—É—é
–ø–æ–ø—ã—Ç–∫—É –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –¥–µ–Ω—å —Å meals –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ñ–∞–∑—ã –∏
–∏—Å—Ç–æ—á–Ω–∏–∫–∞ (cloud sync, REST, RPC).

> **Cascade Guard v6.2** (`heys_cascade_card_v1.js`) ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π
> **–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π** —Å–ª–æ–π –∑–∞—â–∏—Ç—ã (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç BROKEN flash –≤ UI –ø–æ–∫–∞ –∏–¥—ë—Ç Phase
> B). –û–Ω –Ω–µ —Å–≤—è–∑–∞–Ω —Å –∑–∞—â–∏—Ç–æ–π –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –¥–æ–ø–æ–ª–Ω—è–µ—Ç –æ–±—â—É—é –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã. –°–º.
> [SYNC_REFERENCE.md ¬ß12](SYNC_REFERENCE.md).

---

## ÔøΩüîç –ê—É–¥–∏—Ç –∑–∞—â–∏—Ç—ã

–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç:

```bash
cd /Users/poplavskijanton/HEYS-v2
source .venv/bin/activate
python3 scripts/data_protection_audit.py
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
1Ô∏è‚É£ write_client_kv_value protection:
   ‚úÖ Has check_day_overwrite_allowed call

2Ô∏è‚É£ upsert_client_kv_by_session:
   ‚úÖ Uses write_client_kv_value (protected)

3Ô∏è‚É£ batch_upsert_client_kv_by_session:
   ‚úÖ Uses write_client_kv_value (protected)

4Ô∏è‚É£ safe_upsert_client_kv (REST):
   ‚úÖ Has check_day_overwrite_allowed call

5Ô∏è‚É£ data_loss_audit table:
   ‚úÖ Audit table exists

6Ô∏è‚É£ Live protection test:
   ‚úÖ Protection WORKS!
```

---

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É–¥–∏—Ç –ª–æ–≥

```sql
SELECT * FROM data_loss_audit
WHERE client_id = 'UUID'
ORDER BY created_at DESC;
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ç–∫–∞–ø—ã Yandex Cloud

- –ö–æ–Ω—Å–æ–ª—å ‚Üí Managed PostgreSQL ‚Üí Backups
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–æ—á–∫—É –≤—Ä–µ–º–µ–Ω–∏ (PITR)

### 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ localStorage –∫–ª–∏–µ–Ω—Ç–∞

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—á–∏—â–∞–ª –±—Ä–∞—É–∑–µ—Ä ‚Äî –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–∞–º:

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
JSON.parse(localStorage.getItem('heys_dayv2_2026-01-25'));
```

---

## üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –°–¥–µ–ª–∞–Ω–æ:

- –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL —Ñ—É–Ω–∫—Ü–∏–π
- –ê—É–¥–∏—Ç –ª–æ–≥ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
- –°–∫—Ä–∏–ø—Ç –∞—É–¥–∏—Ç–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–∏

### ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –≤ Yandex Cloud (daily, 7 day retention)
- [ ] –î–æ–±–∞–≤–∏—Ç—å Telegram –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (>5 –∑–∞ —á–∞—Å)
- [ ] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç `check_suspicious_days()`

---

## ÔøΩ Change Log

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ò–∑–º–µ–Ω–µ–Ω–∏—è                                                       |
| ------ | ---------- | --------------------------------------------------------------- |
| v2.1   | 2026-02-26 | –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è –¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–≥–æ sync, Cascade Guard v6.2 cross-ref |
| v2.0   | 2026-01-25 | Initial release                                                 |

---

## ÔøΩüîó –§–∞–π–ª—ã

| –§–∞–π–ª                                              | –û–ø–∏—Å–∞–Ω–∏–µ       |
| ------------------------------------------------- | -------------- |
| `database/2026-01-25_data_loss_protection_v2.sql` | SQL –º–∏–≥—Ä–∞—Ü–∏—è   |
| `scripts/data_protection_audit.py`                | –°–∫—Ä–∏–ø—Ç –∞—É–¥–∏—Ç–∞  |
| `yandex-cloud-functions/heys-api-rest/index.js`   | REST —Å –∑–∞—â–∏—Ç–æ–π |
