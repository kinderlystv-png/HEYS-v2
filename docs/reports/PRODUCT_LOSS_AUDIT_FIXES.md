# –ê—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **clearNamespace() ‚Äî –ì–õ–ê–í–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–û–¢–ï–†–ò –î–ê–ù–ù–´–•** ‚ùå

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `apps/web/heys_storage_supabase_v1.js:397`

**–ü—Ä–æ–±–ª–µ–º–∞:**

```javascript
clearNamespace(client_id); // ‚Üê –°—Ç–∏—Ä–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ localStorage
```

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ `bootstrapClientSync()` —Ñ—É–Ω–∫—Ü–∏—è `clearNamespace()` **–ø–æ–ª–Ω–æ—Å—Ç—å—é
–æ—á–∏—â–∞–ª–∞** –≤—Å–µ –∫–ª—é—á–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–¥—É–∫—Ç—ã. –ó–∞—Ç–µ–º –ø—ã—Ç–∞–ª–∞—Å—å
–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö –∏–∑ Supabase, –Ω–æ –µ—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ –±—ã–ª–∏ –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –∏–ª–∏
—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —à–ª–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ‚Äî –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è–ª–∏—Å—å –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**

- ‚úÖ **–£–¥–∞–ª–µ–Ω–∞** —Å—Ç—Ä–æ–∫–∞ `clearNamespace(client_id)`
- ‚úÖ –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ —Ç–µ –∫–ª—é—á–∏**, —á—Ç–æ –ø—Ä–∏—à–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –ø—Ä–∏—à—ë–ª ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏

---

### 2. **–°–ª–∞–±–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤** ‚ö†Ô∏è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞—â–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `local`, –∫–æ—Ç–æ—Ä–∞—è —á–∏—Ç–∞–ª–∞—Å—å **–¥–æ**
clearNamespace, —Ç–æ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä—è–ª–∞ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∞ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**

```javascript
// –ß–∏—Ç–∞–µ–º –ê–ö–¢–£–ê–õ–¨–ù–û–ï –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ scoped –∫–ª—é—á—É
let currentLocal = null;
try {
  const rawLocal = ls.getItem(key);
  if (rawLocal) currentLocal = JSON.parse(rawLocal);
} catch (e) {}

// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ù–ï –ó–ê–¢–ò–†–ê–ï–ú –Ω–µ–ø—É—Å—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
if (Array.isArray(row.v) && row.v.length === 0) {
  if (Array.isArray(currentLocal) && currentLocal.length > 0) {
    console.warn(
      `‚ö†Ô∏è [PRODUCTS PROTECTION] BLOCKED: Refusing to overwrite ${currentLocal.length} local products with empty cloud array`,
    );
    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  }
}
```

---

### 3. **–ù–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ —Å–º–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞** üõ°Ô∏è

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `apps/web/index.html` (2 useEffect'–∞)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ reload –ø–∞–Ω–µ–ª–∏ `bootstrapClientSync()` –º–æ–≥
–≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ React –±–µ–∑
–ø—Ä–æ–≤–µ—Ä–æ–∫.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**

```javascript
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ü–ï–†–ï–î —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
const productsBeforeSync =
  products.length > 0 ? products : window.HEYS.utils.lsGet('heys_products', []);

cloud.bootstrapClientSync(clientId).then(() => {
  const loadedProducts = window.HEYS.utils.lsGet('heys_products', []);

  // –ó–ê–©–ò–¢–ê: –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, –∞ —É –Ω–∞—Å –±—ã–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã - –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º
  if (
    loadedProducts.length === 0 &&
    Array.isArray(productsBeforeSync) &&
    productsBeforeSync.length > 0
  ) {
    console.warn(
      `‚ö†Ô∏è [CLIENT CHANGE] PROTECTION: Sync returned empty, keeping ${productsBeforeSync.length} products`,
    );
    setProducts(productsBeforeSync);
    window.HEYS.utils.lsSet('heys_products', productsBeforeSync);
  } else {
    setProducts(loadedProducts);
  }
});
```

---

## üìä –¢–æ—á–∫–∏ –≤—ã–∑–æ–≤–∞ setProducts() (–≤—Å–µ–≥–æ 21)

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ:

1. **importAppend** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
2. **importReplace** ‚Äî —Å –∞–≤—Ç–æ-–±—ç–∫–∞–ø–æ–º –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π
3. **addProduct** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
4. **updateRow** ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
5. **deleteRow** ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
6. **restoreFromBackup** ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–∞

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ (—Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω—ã):

7. **[CLIENT CHANGE] useEffect** ‚Äî –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞)
8. **[RELOAD] useEffect** ‚Äî –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞)
9. **doSignOut** ‚Äî —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ—Ç (`setProducts([])`)
10. **Fallback useEffect** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–±–µ–∑–æ–ø–∞—Å–µ–Ω,
    —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `products.length === 0`)

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –£—Å–∏–ª–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `console.log/warn`
- ‚úÖ –í–∏–¥–Ω—ã —Ä–∞–∑–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–ª—é—á–∏
- ‚úÖ –ß—ë—Ç–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã `‚ö†Ô∏è PROTECTION`, `‚úÖ Loading`, `üîç CHECK`

### –ó–∞—â–∏—Ç–∞ –æ—Ç Race Conditions

- ‚úÖ Throttling `bootstrapClientSync` —É–≤–µ–ª–∏—á–µ–Ω —Å 4 –¥–æ 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π (—Å–Ω–∞—á–∞–ª–∞ metadata)
- ‚úÖ Debounce —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (300ms) –≤ `index.html`

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –∫–æ–Ω—Å–æ–ª–∏:

```javascript
// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã
HEYS.utils.lsGet('heys_products', []);

// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±—ç–∫–∞–ø –ø—Ä–æ–¥—É–∫—Ç–æ–≤
HEYS.utils.lsGet('heys_products_backup', null);

// –í—Å–µ –∫–ª—é—á–∏ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
Object.keys(localStorage).filter((k) => k.includes(HEYS.currentClientId));
```

### –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö:

1. –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `‚ö†Ô∏è PROTECTION`, `‚ùå BLOCKED`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å `HEYS.backupManager.restore('heys_products')`
4. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ SQL

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- **clearNamespace —É–¥–∞–ª—ë–Ω** ‚Äî –±–æ–ª—å—à–µ –Ω–µ —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
- **–¢—Ä–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞** –æ—Ç –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ (Supabase sync + CLIENT CHANGE + RELOAD)
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø** –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∏–º–ø–æ—Ä—Ç–∞-–∑–∞–º–µ–Ω—ã

**–ü—Ä–æ–¥—É–∫—Ç—ã —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω—ã –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö:**

1. –í `bootstrapClientSync` ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
2. –í `index.html` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ–ø–∏—è –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. –í –±—ç–∫–∞–ø-—Å–∏—Å—Ç–µ–º–µ ‚Äî –ø—É—Å—Ç–æ–π –±—ç–∫–∞–ø –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç

---

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É** ‚Äî –¥–µ–ª–∞—Ç—å backup, —É–¥–∞–ª—è—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å** ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ `[PRODUCTS CHECK]` –∏
   `[PRODUCTS PROTECTION]`
3. **–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–ø–∞–ª–∏** ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤—ã—à–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏

–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: 2025-11-14
