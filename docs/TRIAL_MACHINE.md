# üé´ HEYS Trial Machine

> **v1.0** | 2025-01-10 | –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–∏–∞–ª-—Å–∏—Å—Ç–µ–º—ã

---

## üìä Quick Reference

### –°—Ç–∞—Ç—É—Å—ã –ø–æ–¥–ø–∏—Å–∫–∏ (`subscription_status`)

| –°—Ç–∞—Ç—É—Å      | –û–ø–∏—Å–∞–Ω–∏–µ                    | –î–æ—Å—Ç—É–ø –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é |
| ----------- | --------------------------- | ----------------------- |
| `null`      | –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å          | ‚ùå Read-only            |
| `trial`     | –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (7 –¥–Ω–µ–π)     | ‚úÖ –ü–æ–ª–Ω—ã–π               |
| `active`    | –û–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞         | ‚úÖ –ü–æ–ª–Ω—ã–π               |
| `read_only` | –ò—Å—Ç—ë–∫ —Ç—Ä–∏–∞–ª / –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ   | ‚ùå Read-only            |
| `canceled`  | –û—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º      | ‚ùå Read-only            |

### –¢–∞—Ä–∏—Ñ—ã (`PLANS`)

| –¢–∞—Ä–∏—Ñ    | –¶–µ–Ω–∞/–º–µ—Å   | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| -------- | ---------- | ------------------------------------- |
| **Base** | 1 990 ‚ÇΩ    | –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + 1 —á–µ–∫-–∏–Ω/–Ω–µ–¥–µ–ª—é (async)  |
| **Pro**  | 12 990 ‚ÇΩ   | + –í–µ–¥–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ + —á–∞—Ç + —Å–æ–∑–≤–æ–Ω     |
| **Pro+** | 19 990 ‚ÇΩ   | + 7/7 —Ä–µ–∂–∏–º + mid-week —á–µ–∫-–∏–Ω         |

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

```javascript
TRIAL_DAYS = 7              // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∏–∞–ª–∞
OFFER_EXPIRY_HOURS = 24     // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –æ—Ñ—Ñ–µ—Ä–∞ (legacy)
offer_window_minutes = 120  // –í—Ä–µ–º—è –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ –æ—Ñ—Ñ–µ—Ä–∞ (legacy)
```

---

## üîÑ Lifecycle Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        TRIAL LIFECYCLE                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                      ‚îÇ
‚îÇ   [–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]                                               ‚îÇ
‚îÇ          ‚îÇ                                                           ‚îÇ
‚îÇ          ‚ñº                                                           ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                   ‚îÇ
‚îÇ   ‚îÇ  Landing /   ‚îÇ                                                   ‚îÇ
‚îÇ   ‚îÇ  Paywall     ‚îÇ                                                   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                   ‚îÇ
‚îÇ          ‚îÇ                                                           ‚îÇ
‚îÇ          ‚ñº                                                           ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     request_trial()                               ‚îÇ
‚îÇ   ‚îÇ  Trial Queue ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  "pending"                  ‚îÇ
‚îÇ   ‚îÇ   (pending)  ‚îÇ                                                   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                   ‚îÇ
‚îÇ          ‚îÇ                                                           ‚îÇ
‚îÇ          ‚ñº  admin_activate_trial() / claim_trial_offer()             ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                   ‚îÇ
‚îÇ   ‚îÇ   assigned   ‚îÇ  ‚îÄ‚îÄ trial_ends_at = NOW() + 7 days                ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                   ‚îÇ
‚îÇ          ‚îÇ                                                           ‚îÇ
‚îÇ          ‚ñº  subscription_status = 'trial'                            ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                   ‚îÇ
‚îÇ   ‚îÇ    TRIAL     ‚îÇ  ‚óÑ‚îÄ‚îÄ‚îÄ canEdit() = true                            ‚îÇ
‚îÇ   ‚îÇ   (7 –¥–Ω–µ–π)   ‚îÇ                                                   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                   ‚îÇ
‚îÇ          ‚îÇ                                                           ‚îÇ
‚îÇ          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ          ‚ñº               ‚ñº                ‚ñº                          ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ   ‚îÇ  –û–ü–õ–ê–¢–ê  ‚îÇ    ‚îÇ  –ò–°–¢–Å–ö   ‚îÇ    ‚îÇ –û–¢–ú–ï–ù–Å–ù   ‚îÇ                      ‚îÇ
‚îÇ   ‚îÇ  active  ‚îÇ    ‚îÇread_only ‚îÇ    ‚îÇ canceled  ‚îÇ                      ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –î–≤–µ –≤–µ—Ä—Å–∏–∏ –æ—á–µ—Ä–µ–¥–∏

| –í–µ—Ä—Å–∏—è         | –§–∞–π–ª SQL                              | –°—Ç–∞—Ç—É—Å—ã –æ—á–µ—Ä–µ–¥–∏                              | –ú–µ—Ö–∞–Ω–∏–∑–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏    |
| -------------- | ------------------------------------- | -------------------------------------------- | --------------------- |
| **Simplified** | `2025-01-09_simplified_trial_queue.sql` | `pending` ‚Üí `assigned` \| `rejected`        | –†—É—á–Ω–∞—è (–∫—É—Ä–∞—Ç–æ—Ä)      |
| Legacy         | `2025-12-25_trial_queue.sql`           | `queued` ‚Üí `offer` ‚Üí `assigned` \| `expired` | –ê–≤—Ç–æ-CRON + claim     |

> ‚ö†Ô∏è **Production –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Simplified –≤–µ—Ä—Å–∏—é** ‚Äî –∫—É—Ä–∞—Ç–æ—Ä –≤—Ä—É—á–Ω—É—é –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–∞–ª –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FRONTEND                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys_subscription_v1.js     ‚îÇ  Core: STATUS, startTrial(),     ‚îÇ
‚îÇ                              ‚îÇ  canEdit(), getTrialDaysLeft()   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys_subscriptions_v1.js    ‚îÇ  UI: PLANS, PlanCard,            ‚îÇ
‚îÇ                              ‚îÇ  SubscriptionSection             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys_trial_queue_v1.js      ‚îÇ  Queue: requestTrial(),          ‚îÇ
‚îÇ                              ‚îÇ  claimOffer(), useTrialQueue()   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys_paywall_v1.js          ‚îÇ  Paywall: TrialQueueSection,     ‚îÇ
‚îÇ                              ‚îÇ  PaywallModal                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys_morning_checkin_v1.js  ‚îÇ  Auto-start: —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏         ‚îÇ
‚îÇ                              ‚îÇ  –ø–µ—Ä–≤–æ–º —É—Ç—Ä–µ–Ω–Ω–µ–º —á–µ–∫-–∏–Ω–µ         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          BACKEND                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys-api-rpc (Cloud Function)                                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ request_trial                                               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ get_trial_queue_status                                      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ claim_trial_offer (legacy)                                  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ cancel_trial_queue                                          ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ start_trial_by_session                                      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ get_subscription_status_by_session                          ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ get_public_trial_capacity                                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ assign_trials_from_queue (legacy CRON)                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ admin_activate_trial                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  heys-maintenance (Cloud Function CRON)                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ processTrialQueue() ‚Äî –∏—Å—Ç–µ—á–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–æ–≤, –∞–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         DATABASE                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  clients                                                         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ subscription_status    ‚îÇ trial | active | read_only | ...  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ subscription_plan      ‚îÇ Base | Pro | Pro+                 ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ trial_ends_at          ‚îÇ TIMESTAMP                         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ trial_started_at       ‚îÇ TIMESTAMP                         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ subscription_ends_at   ‚îÇ TIMESTAMP                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  trial_queue                                                     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ id, phone, name, email ‚îÇ –î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏                     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ messenger              ‚îÇ telegram | whatsapp | max         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ status                 ‚îÇ pending | assigned | rejected     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ offer_sent_at          ‚îÇ –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ñ—Ñ–µ—Ä             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ offer_expires_at       ‚îÇ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ñ—Ñ–µ—Ä–∞              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ client_id              ‚îÇ FK ‚Üí clients (–ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîå API Reference

### JS API (Frontend)

#### `HEYS.Subscription`

```javascript
// –°—Ç–∞—Ç—É—Å—ã
HEYS.Subscription.STATUS = { TRIAL: 'trial', ACTIVE: 'active', READ_ONLY: 'read_only', ... }

// –ü—Ä–æ–≤–µ—Ä–∫–∏
HEYS.Subscription.canEdit()           // Boolean: –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
HEYS.Subscription.isTrialExpired()    // Boolean: –∏—Å—Ç—ë–∫ –ª–∏ —Ç—Ä–∏–∞–ª
HEYS.Subscription.getTrialDaysLeft()  // Number: –¥–Ω–µ–π –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∏–∞–ª–∞

// –î–µ–π—Å—Ç–≤–∏—è
await HEYS.Subscription.startTrial()  // –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç—Ä–∏–∞–ª (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç trial_ends_at)
await HEYS.Subscription.getStatus()   // –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ –ë–î
```

#### `HEYS.TrialQueue`

```javascript
// –ó–∞–ø—Ä–æ—Å –≤ –æ—á–µ—Ä–µ–¥—å
await HEYS.TrialQueue.requestTrial({ phone, name, messenger })  // ‚Üí { status: 'pending' }

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
await HEYS.TrialQueue.getQueueStatus(phone)  // ‚Üí { status, position, offer_expires_at }

// –ü—Ä–∏–Ω—è—Ç–∏–µ –æ—Ñ—Ñ–µ—Ä–∞ (legacy)
await HEYS.TrialQueue.claimOffer(phone)  // ‚Üí { success, client_id }

// –û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏
await HEYS.TrialQueue.cancelQueue(phone)  // ‚Üí { success }

// React hook
const { status, position, isLoading, requestTrial, claimOffer } = useTrialQueue()
```

### RPC API (Backend)

| –§—É–Ω–∫—Ü–∏—è                          | –î–æ—Å—Ç—É–ø     | –û–ø–∏—Å–∞–Ω–∏–µ                                |
| -------------------------------- | ---------- | --------------------------------------- |
| `request_trial`                  | Public     | –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –≤ –æ—á–µ—Ä–µ–¥—å                |
| `get_trial_queue_status`         | Public     | –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É      |
| `claim_trial_offer`              | Public     | –ü—Ä–∏–Ω—è—Ç—å –æ—Ñ—Ñ–µ—Ä (legacy)                  |
| `cancel_trial_queue`             | Public     | –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É                         |
| `get_public_trial_capacity`      | Public     | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤             |
| `start_trial_by_session`         | Session    | –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∏–∞–ª (–ø–æ —Å–µ—Å—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞)     |
| `get_subscription_status_by_session` | Session | –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏               |
| `assign_trials_from_queue`       | Internal   | CRON: –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ñ—Ñ–µ—Ä—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏       |
| `admin_activate_trial`           | Admin      | –í—Ä—É—á–Ω—É—é –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª              |
| `admin_reject_trial`             | Admin      | –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É                        |

### SQL Functions (Admin)

```sql
-- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–∞–ª –≤—Ä—É—á–Ω—É—é (Simplified –≤–µ—Ä—Å–∏—è)
SELECT admin_activate_trial(
  p_queue_id := 123,           -- ID –∑–∞—è–≤–∫–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
  p_curator_id := 'uuid...',   -- ID –∫—É—Ä–∞—Ç–æ—Ä–∞
  p_trial_days := 7            -- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∏–∞–ª–∞
);

-- –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
SELECT admin_reject_trial(
  p_queue_id := 123,
  p_reason := '–î—É–±–ª–∏–∫–∞—Ç –∑–∞—è–≤–∫–∏'
);

-- –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ñ—Ñ–µ—Ä—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏ (Legacy CRON)
SELECT assign_trials_from_queue(
  p_curator_id := 'uuid...',
  p_max_to_assign := 5
);
```

---

## üé® UI Components

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç            | –§–∞–π–ª                       | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                          |
| -------------------- | -------------------------- | ----------------------------------- |
| `TrialBanner`        | `heys_subscription_v1.js`  | –ë–∞–Ω–Ω–µ—Ä "–¢—Ä–∏–∞–ª: X –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å"     |
| `PaywallBanner`      | `heys_subscriptions_v1.js` | –ë–∞–Ω–Ω–µ—Ä "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"        |
| `PlanCard`           | `heys_subscriptions_v1.js` | –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–∞—Ä–∏—Ñ–∞ (Base/Pro/Pro+)     |
| `SubscriptionSection`| `heys_subscriptions_v1.js` | –°–µ–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ           |
| `TrialQueueSection`  | `heys_paywall_v1.js`       | –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ + —Å—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏       |
| `PaywallModal`       | `heys_paywall_v1.js`       | –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ paywall              |

---

## üìÅ File Structure

```
apps/web/
‚îú‚îÄ‚îÄ heys_subscription_v1.js      # Core: STATUS, canEdit(), startTrial()
‚îú‚îÄ‚îÄ heys_subscriptions_v1.js     # UI: PLANS, PlanCard, SubscriptionSection
‚îú‚îÄ‚îÄ heys_trial_queue_v1.js       # Queue: requestTrial(), useTrialQueue()
‚îú‚îÄ‚îÄ heys_paywall_v1.js           # Paywall: TrialQueueSection, PaywallModal
‚îî‚îÄ‚îÄ heys_morning_checkin_v1.js   # Auto-start —Ç—Ä–∏–∞–ª–∞ –ø—Ä–∏ —á–µ–∫-–∏–Ω–µ

database/
‚îú‚îÄ‚îÄ 2025-01-09_simplified_trial_queue.sql   # PRODUCTION: pending ‚Üí assigned
‚îú‚îÄ‚îÄ 2025-12-25_trial_queue.sql              # Legacy: queued ‚Üí offer ‚Üí assigned
‚îî‚îÄ‚îÄ 2025-12-20_subscriptions.sql            # –°—Ö–µ–º–∞ clients + payments

yandex-cloud-functions/
‚îú‚îÄ‚îÄ heys-api-rpc/index.js        # RPC endpoints
‚îî‚îÄ‚îÄ heys-maintenance/index.js    # CRON: processTrialQueue()
```

---

## üîß Troubleshooting

| –ü—Ä–æ–±–ª–µ–º–∞                          | –ü—Ä–∏—á–∏–Ω–∞                              | –†–µ—à–µ–Ω–∏–µ                                      |
| --------------------------------- | ------------------------------------ | -------------------------------------------- |
| `canEdit() = false` –ø—Ä–∏ —Ç—Ä–∏–∞–ª–µ    | `trial_ends_at` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω        | –í—ã–∑–≤–∞—Ç—å `startTrial()` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î      |
| –¢—Ä–∏–∞–ª –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏   | –ù–µ –±—ã–ª–æ –ø–µ—Ä–≤–æ–≥–æ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞    | –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–∫-–∏–Ω –∏–ª–∏ –≤—ã–∑–≤–∞—Ç—å `startTrial()`  |
| –°—Ç–∞—Ç—É—Å `null` –≤–º–µ—Å—Ç–æ `trial`      | –¢—Ä–∏–∞–ª –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω             | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `trial_queue` –∏ `clients`          |
| "–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤"            | `get_public_trial_capacity()` = 0    | –û—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–ª–æ—Ç—ã –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç         |
| –û—Ñ—Ñ–µ—Ä –∏—Å—Ç—ë–∫                       | –ü—Ä–æ—à–ª–æ > 24—á —Å `offer_sent_at`       | –ó–∞–Ω–æ–≤–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ñ—Ñ–µ—Ä (legacy) –∏–ª–∏ activate |

---

## üö® Known Issues

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü—Ä–æ–±–ª–µ–º–∞                                           | –°—Ç–∞—Ç—É—Å  |
| --------- | -------------------------------------------------- | ------- |
| üî¥ High   | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ `subscription_v1` vs `subscriptions_v1` | Open    |
| üü° Medium | –ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–≥–µ–π—Ç–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –Ω–∞ UI)     | v2      |
| üü° Medium | –ù–µ—Ç –∞–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ `read_only` –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏      | v2      |
| üü¢ Low    | –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ 1 –¥–µ–Ω—å –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∏–∞–ª–∞          | v2      |

---

## üìö Related Docs

- [HEYS_BRIEF.md](./HEYS_BRIEF.md) ‚Äî –ë–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Ç–∞—Ä–∏—Ñ—ã
- [SECURITY_RUNBOOK.md](./SECURITY_RUNBOOK.md) ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ RPC allowlist
- [DATA_MODEL_REFERENCE.md](./DATA_MODEL_REFERENCE.md) ‚Äî –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

---

## Changelog

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ò–∑–º–µ–Ω–µ–Ω–∏—è                                   |
| ------ | ---------- | ------------------------------------------- |
| v1.0   | 2025-01-10 | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏          |
