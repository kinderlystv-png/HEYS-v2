# SMS Gateway Setup (SMS.ru)

> **Дата создания**: 2025-12-20  
> **Статус**: ⚙️ Требует настройки  
> **Назначение**: ПЭП (Простая электронная подпись) для 152-ФЗ

---

## 1. Текущий статус

### Аккаунт SMS.ru

| Параметр          | Значение                               |
| ----------------- | -------------------------------------- |
| **API ключ**      | `78608003-ED53-BC7C-0C47-788283EBCC3F` |
| **Баланс**        | 548.96 ₽                               |
| **Телефон**       | (962) 455-6111                         |
| **Дневной лимит** | 0 из 10 (⚠️ нужно увеличить)           |

### Чеклист регистрации

| Шаг | Статус                | Действие                    |
| --- | --------------------- | --------------------------- |
| ✅  | Регистрация           | Аккаунт создан              |
| ⚠️  | Реквизиты ИП          | Заполнить в личном кабинете |
| ⚠️  | Буквенный отправитель | Создать "HEYS"              |
| ⚠️  | Согласование          | Подождать 1-3 дня           |
| ⚠️  | Лимит SMS             | Увеличить до 1000/день      |

---

## 2. Необходимые действия

### 2.1 Заполнить реквизиты ИП

1. Войти в [личный кабинет SMS.ru](https://sms.ru/personal/info/)
2. Заполнить:
   - ИНН
   - ОГРНИП
   - Юридический адрес
   - Банковские реквизиты

### 2.2 Создать буквенный отправитель

1. Перейти в [Отправители](https://sms.ru/personal/sender/)
2. Нажать "Добавить отправителя"
3. Указать:
   - **Имя**: `HEYS`
   - **Тип**: Сервисные (авторизация/пароли)
   - **Описание**: Коды подтверждения для приложения учёта питания
4. Загрузить документы:
   - Свидетельство ИП
   - Скриншот сайта/приложения

### 2.3 Увеличить дневной лимит

1. После согласования отправителя
2. Написать в поддержку с просьбой увеличить лимит
3. Обычно дают 100-1000 SMS/день для ИП

---

## 3. Интеграция в код

### 3.1 Архитектура

```
apps/web/
├── heys_sms_v1.js        # SMS модуль (клиент)
├── heys_consents_v1.js   # UI согласий с SMS-верификацией
└── heys_app_v12.js       # Передача телефона в ConsentScreen
```

### 3.2 Dev mode (localhost)

На localhost автоматически включается **dev mode**:

- SMS НЕ отправляются
- Коды выводятся в консоль браузера
- Можно тестировать без реальных SMS

```javascript
// В консоли браузера:
// [SMS DEV] Code for 79624556111: 1234
```

### 3.3 Production mode

Для продакшена нужно инициализировать модуль с API ключом:

```javascript
// Вариант 1: В коде (НЕ рекомендуется)
HEYS.sms.init({ apiKey: '78608003-ED53-BC7C-0C47-788283EBCC3F' });

// Вариант 2: Через Supabase Secrets (рекомендуется)
// В Supabase Dashboard → Settings → Vault:
// SMSRU_API_KEY = 78608003-ED53-BC7C-0C47-788283EBCC3F

// Затем в Edge Function или при инициализации:
const { data } = await supabase.rpc('get_secret', { name: 'SMSRU_API_KEY' });
HEYS.sms.init({ apiKey: data });

// Вариант 3: Через Vercel env
// В Vercel Dashboard → Settings → Environment Variables:
// VITE_SMSRU_API_KEY = 78608003-ED53-BC7C-0C47-788283EBCC3F
```

---

## 4. API модуля SMS

### 4.1 Инициализация

```javascript
HEYS.sms.init({
  apiKey: 'YOUR_API_KEY', // Обязательно
  sender: 'HEYS', // Опционально (после согласования)
});
```

### 4.2 Отправка кода

```javascript
const result = await HEYS.sms.sendCode('79624556111');

// Успех:
{ success: true }

// Ошибка:
{ success: false, error: 'Сообщение об ошибке', resendAfter: 45 }
```

### 4.3 Проверка кода

```javascript
const result = HEYS.sms.verifyCode('79624556111', '1234');

// Успех:
{ valid: true }

// Ошибка:
{ valid: false, error: 'Неверный код' }
```

### 4.4 Утилиты

```javascript
// Нормализация номера
HEYS.sms.normalizePhone('8 (962) 455-61-11'); // '79624556111'

// Включение dev mode вручную
HEYS.sms.enableDevMode();

// Проверка режима
HEYS.sms._devMode(); // true/false
```

---

## 5. Конфигурация

Файл: `apps/web/heys_sms_v1.js`

```javascript
const SMS_CONFIG = {
  apiUrl: 'https://sms.ru/sms/send',
  apiKey: null, // Устанавливается через init()
  sender: 'HEYS', // После согласования
  codeLength: 4, // 4 цифры
  codeExpireMinutes: 10, // Срок действия кода
  maxAttemptsPerHour: 3, // Лимит попыток
  resendDelaySeconds: 60, // Задержка между отправками
};
```

---

## 6. Безопасность

### 6.1 Защита от перебора

- ✅ Лимит 3 попытки/час на номер
- ✅ Cooldown 60 секунд между отправками
- ✅ Коды истекают через 10 минут

### 6.2 Хранение API ключа

| Способ         | Безопасность | Рекомендация   |
| -------------- | ------------ | -------------- |
| В коде         | ❌ Плохо     | Только для dev |
| Env переменная | ⚠️ Средне    | Для стейджинга |
| Supabase Vault | ✅ Хорошо    | Для продакшена |

### 6.3 Логирование

В таблице `consents` сохраняется:

- `signature_method: 'sms_code'` — для health_data согласия
- `signature_method: 'checkbox'` — для остальных согласий

---

## 7. Ценообразование SMS.ru

| Тип              | Цена за SMS |
| ---------------- | ----------- |
| Сервисные (коды) | ~2.00 ₽     |
| Рекламные        | ~2.50 ₽     |
| Viber fallback   | ~1.50 ₽     |

**Расчёт**: 548 ₽ ≈ 270 SMS = хватит на ~100-200 клиентов (первичная
верификация).

---

## 8. Альтернативы

| Сервис        | Плюсы               | Минусы                    |
| ------------- | ------------------- | ------------------------- |
| SMS.ru        | Простой API, дёшево | Нужно согласование        |
| SMSC.ru       | Больше операторов   | Дороже                    |
| Twilio        | Глобальный          | Дорого, блокировки РФ     |
| Telegram Code | Бесплатно           | Только для Telegram users |

---

## 9. Troubleshooting

### Код 204: "Имя отправителя не согласовано"

**Причина**: Отправитель "HEYS" не одобрен операторами.

**Решение**:

1. Дождаться согласования (1-3 дня)
2. Или временно убрать sender из конфига

### Код 206: "Дневной лимит исчерпан"

**Причина**: Превышен лимит SMS/день.

**Решение**:

1. Написать в поддержку SMS.ru
2. Запросить увеличение лимита

### Код 201: "Не хватает средств"

**Причина**: Баланс меньше стоимости SMS.

**Решение**: Пополнить баланс SMS.ru

---

## Changelog

| Дата       | Изменения                                |
| ---------- | ---------------------------------------- |
| 2025-12-20 | Создание документации, интеграция модуля |
