# ğŸ” HEYS Data Sync â€” Deep Audit Report

> **Ğ”Ğ°Ñ‚Ğ°:** 2026-01-05  
> **Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… ĞĞ£Ğ”Ğ˜Ğ¢ Ğ—ĞĞ’Ğ•Ğ Ğ¨ĞĞ â€” Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ“ĞĞ ĞĞĞ¢Ğ˜Ğ Ğ£Ğ•Ğ¢ Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞ˜Ğ—ĞĞ¦Ğ˜Ğ®

---

## ğŸ“Œ TL;DR

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞŸĞ¾ÑĞ»Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ·Ğ° 2026-01-05 Ğ½Ğµ
ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾.

**ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** `cloud.signOut()` Ğ½Ğµ Ğ´Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ»ÑÑ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¹
ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°Ğ»ÑÑ Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ `syncAllData()`.

**Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:**

1. âœ… **Pre-logout sync** (commit 7aab482): Ğ—Ğ°Ğ¼ĞµĞ½Ñ‘Ğ½ `syncAllData()` Ğ½Ğ°
   Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ `flushPendingQueue(5000)`
2. âœ… **Instant UI feedback** (ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚): Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ "Syncing..." Ğ·Ğ°Ğ³Ğ¾Ñ€Ğ°ĞµÑ‚ÑÑ
   ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ, Ğ½Ğµ Ñ‡ĞµÑ€ĞµĞ· 500Ğ¼Ñ
3. âœ… **Persistent errors**: ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚
   Toast-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
4. âœ… **Auth errors**: ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞ²Ğ½Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

---

## ğŸ”„ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Storage â†’ Cloud)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER ACTION (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµĞ´Ñƒ, Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²ĞµÑ Ğ¸ Ñ‚.Ğ´.)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  U.lsSet(key, value)                                                                â”‚
â”‚  â†“                                                                                  â”‚
â”‚  nsKey = heys_<clientId>_<key>                                                      â”‚
â”‚  â†“                                                                                  â”‚
â”‚  HEYS.store.set(nsKey, value)  â†’ Store.set()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store.set() [heys_storage_layer_v1.js]                                             â”‚
â”‚  â”œâ”€â”€ 1. rawSet() â†’ localStorage.setItem() â† ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾                      â”‚
â”‚  â”œâ”€â”€ 2. notifyWatchers() â†’ UI Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ                                           â”‚
â”‚  â””â”€â”€ 3. saveClientKey() â†’ Cloud sync                                                â”‚
â”‚                                                                                     â”‚
â”‚  ğŸ†• TRY/CATCH: ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ â†’ heys:sync-error { persistent: true }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  saveClientKey() [heys_storage_supabase_v1.js:4600-4780]                            â”‚
â”‚  â”œâ”€â”€ 1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ (Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ, Ğ½Ğµ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹)                       â”‚
â”‚  â”œâ”€â”€ 2. clientUpsertQueue.push({ k, v, u: Date.now() })                             â”‚
â”‚  â”œâ”€â”€ 3. ğŸ†• savePendingQueue() â†’ localStorage (Ğ¿ĞµÑ€ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸ ĞºÑ€Ğ°ÑˆĞµ)            â”‚
â”‚  â”œâ”€â”€ 4. ğŸ†• notifyPendingChange() â† ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ! UI Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "Syncing..."            â”‚
â”‚  â””â”€â”€ 5. scheduleClientPush() â†’ debounce 500ms â†’ doClientUpload()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  doClientUpload() [heys_storage_supabase_v1.js:4350-4460]                           â”‚
â”‚  â”œâ”€â”€ Deduplicate queue (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ°)                       â”‚
â”‚  â”œâ”€â”€ batch_upsert_client_kv_by_session RPC â†’ PostgreSQL                             â”‚
â”‚  â”œâ”€â”€ SUCCESS: notifyQueueDrained() â†’ UI "âœ… Saved"                                  â”‚
â”‚  â””â”€â”€ ERROR: notifySyncError() â†’ UI "ğŸ”´ Error" + ğŸ†• Toast Ğ´Ğ»Ñ persistent             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. ĞœĞ“ĞĞĞ’Ğ•ĞĞĞĞ¯ Ğ˜ĞĞ”Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ (âœ… Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾)

| Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ                    | Ğ”Ğ¾ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ | ĞŸĞ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ       |
| -------------------------- | -------------- | ----------------------- |
| Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ | 500Ğ¼Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° | **0Ğ¼Ñ â€” Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾**     |
| UI Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "Syncing..." | ĞŸĞ¾ÑĞ»Ğµ debounce | **Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸** |

**ĞšĞ¾Ğ´:**

```javascript
// saveClientKey() â€” ĞĞĞ’ĞĞ•!
clientUpsertQueue.push(upsertObj);
savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
notifyPendingChange(); // â† UI ÑƒĞ·Ğ½Ğ°Ñ‘Ñ‚ ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ
scheduleClientPush(); // â† upload Ñ‡ĞµÑ€ĞµĞ· 500Ğ¼Ñ
```

### 2. Ğ“ĞĞ ĞĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞĞĞ• Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ• ĞĞ‘ ĞĞ¨Ğ˜Ğ‘ĞšĞĞ¥ (âœ… Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾)

| Ğ¢Ğ¸Ğ¿ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸      | Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ                                                   |
| --------------- | ----------------------------------------------------------- |
| Ğ¡ĞµÑ‚ÑŒ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° | ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ + "ĞĞµÑ‚ ÑĞµÑ‚Ğ¸"                           |
| RPC failed      | ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ + ğŸ†• **Toast "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸"**  |
| Auth failed     | ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ + ğŸ†• **Toast "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ"** |
| Storage error   | ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ + ğŸ†• **Toast**                         |

**ĞšĞ¾Ğ´:**

```javascript
// handleSyncError() â€” ĞĞĞ’ĞĞ•!
if (e.detail?.persistent) {
  HEYS.Toast?.error(`ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸: ${code}`);
}
```

### 3. ĞŸĞ•Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞĞ¢ĞĞĞ¡Ğ¢Ğ¬ ĞĞ§Ğ•Ğ Ğ•Ğ”Ğ˜ (âœ… Ğ£Ğ¶Ğµ Ğ±Ñ‹Ğ»Ğ¾)

Ğ”Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ğ»Ğ¾ÑÑŒ:

- ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² `localStorage` (`heys_pending_client_queue`)
- ĞŸÑ€Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ `restorePendingQueue()` Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚

### 4. PRE-LOGOUT SYNC (âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² commit 7aab482)

```javascript
// signOut() â€” Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ!
await cloud.flushPendingQueue(5000); // Ğ–Ğ´Ñ‘Ğ¼ Ğ´Ğ¾ 5 ÑĞµĞºÑƒĞ½Ğ´
// Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ logout
```

---

## ğŸ“Š Event Flow (ĞºĞ°ĞºĞ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ĞºĞ¾Ğ³Ğ´Ğ°)

```
[DATA CHANGED]
    â”‚
    â”œâ”€â”€â–º heys:pending-change     â† ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ (0Ğ¼Ñ)
    â”‚        â†“
    â”‚    UI: cloud.color = "yellow", status = "pending", tooltip = "Syncing..."
    â”‚
    â”œâ”€â”€â–º [500ms debounce]
    â”‚
    â”œâ”€â”€â–º [UPLOAD TO CLOUD]
    â”‚        â”‚
    â”‚        â”œâ”€â”€ SUCCESS â”€â”€â–º heys:queue-drained
    â”‚        â”‚                    â†“
    â”‚        â”‚               UI: cloud.color = "green", status = "synced"
    â”‚        â”‚
    â”‚        â””â”€â”€ ERROR â”€â”€â”€â”€â–º heys:sync-error { persistent: true }
    â”‚                            â†“
    â”‚                       UI: cloud.color = "red" + Toast.error()
```

---

## ğŸ”¬ Ğ’ÑĞµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ñ‹ Ğ’Ğ¡Ğ• Ğ¼ĞµÑÑ‚Ğ°, Ğ³Ğ´Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÑÑ:

| Ğ¤Ğ°Ğ¹Ğ»                       | ĞœĞµÑ‚Ğ¾Ğ´                             | Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ?          |
| -------------------------- | --------------------------------- | -------------------------- |
| heys_day_v12.js            | useDayAutosave â†’ saveDayToStorage | âœ… Ğ§ĞµÑ€ĞµĞ· U.lsSet           |
| heys_day_v12.js            | setMeals â†’ setDay                 | âœ… Ğ§ĞµÑ€ĞµĞ· autosave          |
| heys_core_v12.js           | ProductsManager.setAll            | âœ… Ğ§ĞµÑ€ĞµĞ· U.lsSet           |
| heys_user_v12.js           | saveProfile                       | âœ… Ğ§ĞµÑ€ĞµĞ· U.lsSet           |
| heys_storage_layer_v1.js   | Store.set                         | âœ… â†’ saveClientKey         |
| heys_morning_checkin_v1.js | saveCheckin                       | âœ… Ğ§ĞµÑ€ĞµĞ· U.lsSet           |
| heys_steps_aps_v1.js       | saveSteps                         | âœ… Ğ§ĞµÑ€ĞµĞ· U.lsSet           |
| water tracker              | setWaterMl                        | âœ… Ğ§ĞµÑ€ĞµĞ· setDay â†’ autosave |

**Ğ’Ñ‹Ğ²Ğ¾Ğ´:** Ğ’ÑĞµ Ğ¿ÑƒÑ‚Ğ¸ Ğ²ĞµĞ´ÑƒÑ‚ Ñ‡ĞµÑ€ĞµĞ· `U.lsSet` â†’ `Store.set` â†’ `saveClientKey` â†’
Cloud

---

## ğŸ“‹ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ğ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğµ

### 1. heys_storage_layer_v1.js

```diff
+ try {
    rawSet(k, v);
    notifyWatchers(k, v);
    saveClientKey(k, v);
+ } catch(e) {
+   console.error('[Store.set] Error:', e);
+   if (global.dispatchEvent) {
+     global.dispatchEvent(new CustomEvent('heys:sync-error', {
+       detail: { error: `Storage error: ${e.message}`, persistent: true }
+     }));
+   }
+ }
```

### 2. heys_storage_supabase_v1.js

```diff
  // saveClientKey() â€” ĞŸĞ•Ğ Ğ•Ğ” scheduleClientPush
+ savePendingQueue(PENDING_CLIENT_QUEUE_KEY, clientUpsertQueue);
+ notifyPendingChange();  // â† ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ!
  scheduleClientPush();

  // notifySyncError() â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ persistent flag
+ detail: { error: msg, code: errorCode, persistent: true }

  // handleAuthFailure() â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ persistent flag
+ detail: { error: 'auth_failed', code: 'auth_failed', persistent: true }
```

### 3. heys_app_v12.js

```diff
  // handleSyncError() â€” Toast Ğ´Ğ»Ñ persistent errors
+ const isPersistent = e.detail?.persistent || false;
+ if (isPersistent) {
+   try { HEYS.Toast?.error(`ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸: ${code}`); } catch (_) {}
+ }
```

---

## âœ… Ğ§ĞµĞºĞ»Ğ¸ÑÑ‚ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ğ¹

- [x] Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ² localStorage ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ
- [x] Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ "Syncing..." Ğ¿Ğ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ĞœĞ“ĞĞĞ’Ğ•ĞĞĞ (Ğ½Ğµ Ñ‡ĞµÑ€ĞµĞ· 500Ğ¼Ñ)
- [x] ĞÑˆĞ¸Ğ±ĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Toast-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
- [x] ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Toast-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
- [x] ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¿ĞµÑ€ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ° (localStorage + Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)
- [x] Pre-logout Ğ¶Ğ´Ñ‘Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ sync (Ğ´Ğ¾ 5 ÑĞµĞº)
- [x] Ğ’ÑĞµ Ğ¿ÑƒÑ‚Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ²ĞµĞ´ÑƒÑ‚ Ñ‡ĞµÑ€ĞµĞ· ĞµĞ´Ğ¸Ğ½ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ (Store.set)

---

## ğŸš€ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ° Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ

1. **Retry with exponential backoff** â€” ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ (`getRetryDelay()`)
2. **Offline queue** â€” ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ (Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ offline)
3. **Conflict resolution** â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ last-write-wins (Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ HEYS)
4. **Background sync** â€” Service Worker ÑƒĞ¶Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ sync events

---

**ĞĞ²Ñ‚Ğ¾Ñ€ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ°:** GitHub Copilot  
**ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹:** [pending]
