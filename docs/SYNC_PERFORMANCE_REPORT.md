# HEYS Sync & Performance ‚Äî –°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç

> üìö **–°–µ—Ä–∏—è:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å HEYS v2 **–í–µ—Ä—Å–∏—è:** v6.3 |
> **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 27.02.2026 **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π ‚Äî –≤—Å–µ 6 —Ñ–∞–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
> –∑–∞–≤–µ—Ä—à–µ–Ω—ã, Skeleton Loader 0.2s –∏ Auth Handover –≤–Ω–µ–¥—Ä–µ–Ω—ã

---

## üìã –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ä–∏–∏

| –î–æ–∫—É–º–µ–Ω—Ç                                                           | –û–ø–∏—Å–∞–Ω–∏–µ                                                    |
| ------------------------------------------------------------------ | ----------------------------------------------------------- |
| **[–≠—Ç–æ—Ç —Ñ–∞–π–ª](SYNC_PERFORMANCE_REPORT.md)**                        | –†–µ–∑—é–º–µ –≤—Å–µ—Ö —Ñ–∞–∑, –º–µ—Ç—Ä–∏–∫–∏, –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã, —á–µ–∫–ª–∏—Å—Ç                |
| [–ñ—É—Ä–Ω–∞–ª —Å–µ—Å—Å–∏–π –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](SYNC_PERFORMANCE_SESSIONS_LOG.md)     | –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –±–∞–Ω–¥–ª–∏–Ω–≥–∞, –º–∞–ø–ø–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤, –∂—É—Ä–Ω–∞–ª 7 —Å–µ—Å—Å–∏–π   |
| [–ë–∞–∑–ª–∞–π–Ω —Å–µ–Ω—Ç—è–±—Ä—å 2025](archive/performance-baseline-2025-09.md)   | ‚ö†Ô∏è –ê—Ä—Ö–∏–≤: –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ä—ã (Supabase era)                   |
| [–ë–∞–Ω–¥–ª-—Å–ø–ª–∏—Ç—Ç–∏–Ω–≥ 2025](archive/bundle-splitting-report-2025-09.md) | ‚ö†Ô∏è –ê—Ä—Ö–∏–≤: Vite manualChunks (Supabase era)                  |
| [Sync Reference](SYNC_REFERENCE.md)                                | –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ sync-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (data flow, auth modes, events) |

---

## üéØ –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –∏—Ç–æ–≥–∏

| –ú–µ—Ç—Ä–∏–∫–∞                              | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –¶–µ–ª—å      | –§–∞–∫—Ç (27.02.2026) |
| :----------------------------------- | :------------- | :-------- | :---------------- |
| **FCP (First Contentful Paint)**     | ~10‚Äì15 —Å–µ–∫     | < 5 —Å–µ–∫   | **~0.2 —Å–µ–∫ ‚úÖ**   |
| **TTI (Time to Interactive)**        | ~65.4 —Å–µ–∫      | 15‚Äì20 —Å–µ–∫ | **~2.6 —Å–µ–∫**      |
| **Full App Ready (mid-tier mobile)** | 65.4 —Å–µ–∫       | ~20 —Å–µ–∫   | **~2.6 —Å–µ–∫**      |
| **Desktop / Wi-Fi**                  | ~5‚Äì8 —Å–µ–∫       | < 2 —Å–µ–∫   | **0.4‚Äì0.6 —Å–µ–∫ ‚úÖ**|
| **HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ JS –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**      | 246            | < 10      | **9 ‚úÖ**          |
| **JS –∑–∞–≥—Ä—É–∑–∫–∞ (3G mid-tier)**        | ~63 —Å–µ–∫        | ~5 —Å–µ–∫    | **~1.5 —Å–µ–∫ ‚úÖ**   |
| **Skeleton Loader**                  | 6‚Äì7 —Å–µ–∫        | < 1 —Å–µ–∫   | **0.2 —Å–µ–∫ ‚úÖ**    |

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞ (–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç)

| #   | –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ                                | –°—Ç–∞—Ç—É—Å                 | –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞                                                               |
| --- | ------------------------------------------ | ---------------------- | --------------------------------------------------------------------------- |
| 1   | 130+ JS-—Ñ–∞–π–ª–æ–≤ –±–µ–∑ –±–∞–Ω–¥–ª–∏–Ω–≥–∞               | ‚úÖ –í–µ—Ä–Ω–æ               | 246 `<script src>`, 243 —Å `defer`                                           |
| 2   | SW: `networkFirstNoStore` –¥–ª—è JS           | ‚úÖ –í–µ—Ä–Ω–æ               | `sw.js:286` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ                                                    |
| 3   | 3 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö RPC –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏           | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ            | 2 RPC + `ensureAuditConsistency` ‚Äî –∏—Ç–æ–≥–æ 3 –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø—É—Ç–µ–π          |
| 4   | `doImmediateClientUpload` –æ–±—Ö–æ–¥–∏—Ç debounce | ‚úÖ –í–µ—Ä–Ω–æ               | –¶–µ–ø–æ—á–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞                                                        |
| 5   | 543 KV-—Å—Ç—Ä–æ–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç UI                 | ‚úÖ –í–µ—Ä–Ω–æ               | `bootstrapClientSync` —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π                                            |
| 6   | Cascade –∂–¥—ë—Ç `heysSyncCompleted`           | ‚ùå –ù–µ–≤–µ—Ä–Ω–æ ‚Üí **—É–±—Ä–∞–Ω** | –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ ‚Äî —ç—Ç–æ –Ω–µ –±–∞–≥                                                |
| 7   | `cascadeState` –ø—Ä–∏ 30/30 days missing      | ‚úÖ –í–µ—Ä–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ      | –†–∞—Å—á—ë—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `useMemo` –¥–æ —Å–æ–±—ã—Ç–∏—è                               |
| 8   | `ensureAuditConsistency` –ø—Ä–∏ tab-visible   | üÜï –ù–æ–≤–∞—è –Ω–∞—Ö–æ–¥–∫–∞       | –ü—Ä–∏ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `fetchGamificationHistory` –±–µ–∑ throttle |

---

## –§–∞–∑–∞ 1: –°–µ—Ç–µ–≤—ã–µ –∑–∞—Ç–æ—Ä—ã (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û)

> –ù–∞ 3G —Å RTT 200–º—Å, 246 –∑–∞–ø—Ä–æ—Å–æ–≤ = **–º–∏–Ω–∏–º—É–º 50 —Å–µ–∫—É–Ω–¥** —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

### –®–∞–≥ 1. –ë–∞–Ω–¥–ª–∏–Ω–≥ JS (‚úÖ)

- **–§–∞–π–ª—ã:** `scripts/bundle-legacy.mjs`, `apps/web/index.html`
- **–ü—Ä–æ–±–ª–µ–º–∞:** 246 `<script src>` —Ç–µ–≥–æ–≤ ‚Üí –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç 100 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫
  –æ–¥–Ω–æ–º—É –¥–æ–º–µ–Ω—É.
- **–†–µ—à–µ–Ω–∏–µ:** 9 –±–∞–Ω–¥–ª–æ–≤ —á–µ—Ä–µ–∑ `bundle-legacy.mjs`. GZIP —É—Ä–æ–≤–µ–Ω—å 9 –Ω–∞ Yandex
  Object Storage.
  - `boot-core/calc/day/app/init` ‚Äî 5 boot –±–∞–Ω–¥–ª–æ–≤ (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å
    `defer`)
  - `postboot-1-game`, `postboot-2-insights`, `postboot-3-ui` ‚Äî –ø–æ—Å—Ç–∑–∞–≥—Ä—É–∑–∫–∞
  - `react-bundle.js` ‚Äî React/ReactDOM
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 246 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 9, –∑–∞–≥—Ä—É–∑–∫–∞ 63—Å ‚Üí 1.5—Å.
- **–ú–∞–ø–ø–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤:** —Å–º.
  [–∂—É—Ä–Ω–∞–ª —Å–µ—Å—Å–∏–π](SYNC_PERFORMANCE_SESSIONS_LOG.md#implementation-ready-mapping-—Ç–æ—á–Ω—ã–π-–ø–æ—Ä—è–¥–æ–∫-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏)

### –®–∞–≥ 2. Service Worker ‚Äî staleWhileRevalidate –¥–ª—è –±–∞–Ω–¥–ª–æ–≤ (‚úÖ)

- **–§–∞–π–ª—ã:** `apps/web/public/sw.js`
- **–†–µ—à–µ–Ω–∏–µ:** –ë–∞–Ω–¥–ª—ã —Å —Ö–µ—à–µ–º (`*.bundle.{hash}.js`) ‚Üí `cacheFirst`. SW
  proactive precache 5 boot –±–∞–Ω–¥–ª–æ–≤ –ø—Ä–∏ `install` event.
- **–£–±—Ä–∞–Ω—ã –º—ë—Ä—Ç–≤—ã–µ CDN:** React unpkg √ó2, Supabase ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ twemoji.

### –®–∞–≥ 3. –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_storage_supabase_v1.js:3787`
- **–†–µ—à–µ–Ω–∏–µ:** –§–∞–∑–∞ A (–±–ª–æ–∫–∏—Ä—É—é—â–∞—è) ‚Äî 5 –∫–ª—é—á–µ–π: `heys_profile`, `heys_norms`,
  `heys_products`, `heys_hr_zones`, `heys_dayv2_{today}`. –§–∞–∑–∞ B (—Ñ–æ–Ω–æ–≤–∞—è) ‚Äî
  –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 530+ –∫–ª—é—á–µ–π.

### –®–∞–≥ 4. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–∑–∏—Ç–Ω–æ–≥–æ Upload (404 KB) (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_storage_supabase_v1.js:6094`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è `heys_products` —Ç–µ –∂–µ 404KB –ª–µ—Ç–µ–ª–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤
  –æ–±–ª–∞–∫–æ.
- **–†–µ—à–µ–Ω–∏–µ:** Grace period `_syncCompletedAt = Date.now()`. –ï—Å–ª–∏
  `Date.now() - _syncCompletedAt < 10_000` –∏ –∫–ª—é—á `heys_products` ‚Äî upload
  –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

---

## –§–∞–∑–∞ 2: –¢—è–∂—ë–ª—ã–µ –∑–∞–ø—Ä–æ—Å—ã (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û)

### –®–∞–≥ 5. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è RPC –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_gamification_v1.js:1421`
- **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `_ensureAuditLastRun` ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π throttle 30 —Å–µ–∫.
  `ensureAuditConsistency` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç RPC —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 30—Å.

### –®–∞–≥ 6. Exponential Backoff –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_yandex_api_v1.js:30`
- **–†–µ—à–µ–Ω–∏–µ:** `TIMEOUT_ESCALATION_MS: [15000, 20000, 30000]`,
  `RETRY_DELAY_ESCALATION_MS: [1000, 3000, 7000]`.

### –®–∞–≥ 7. Delta-sync heys_products (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_storage_supabase_v1.js:6028`
- **–†–µ—à–µ–Ω–∏–µ:** djb2-fingerprint `length:hash(name+updatedAt)`. –ï—Å–ª–∏ fingerprint
  —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `cloud._productsFingerprint` ‚Äî upload –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

---

## –§–∞–∑–∞ 3: Perceived Performance (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û)

### –®–∞–≥ 8. Stale-While-Revalidate –¥–ª—è InsightsPI (‚úÖ)

- **–§–∞–π–ª—ã:** `insights/pi_thresholds.js:~215`
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ –∫—ç—à–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ (stale),
  –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç —á–µ—Ä–µ–∑ `setTimeout(0)`.

### –®–∞–≥ 9. Optimistic UI + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏ (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_app_shell_v1.js`
- **–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ –º—É—Ç–∞—Ü–∏–∏ —É–∂–µ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã. –ú–∏–∫—Ä–æ-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: `‚óè –û—Ñ–ª–∞–π–Ω` /
  `‚óè –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è` / `‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ` —Å CSS-–∞–Ω–∏–º–∞—Ü–∏–µ–π –ø—É–ª—å—Å–∞.

---

## –§–∞–∑–∞ 4: Runtime-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û)

### –®–∞–≥ 10. Render-blocking CSS ‚Üí async (‚úÖ)

- `pi_pattern_debugger.css` (20 KB) ‚Üí async —á–µ—Ä–µ–∑
  `<link rel="preload" as="style" onload>`.

### –®–∞–≥ 11. useEffect –±–µ–∑ deps (‚úÖ)

- `heys_day_core_bundle_v1.js`: Twemoji `scheduleTwemojiParse()` –¥–æ–±–∞–≤–ª–µ–Ω
  `[day.meals]`.
- `heys_app_shell_v1.js`: EWS Badge fetch –¥–æ–±–∞–≤–ª–µ–Ω `[clientId, date]`.

### –®–∞–≥ 12. Inline JSON –∫–æ–Ω—Ñ–∏–≥ ‚Üí external file (‚úÖ)

- 43 KB Insulin Wave –∫–æ–Ω—Ñ–∏–≥–∞ –≤—ã–Ω–µ—Å–µ–Ω –∏–∑ `index.html` –≤
  `public/heys-iw-config.json`.

### –®–∞–≥ 13. React.memo (‚úÖ)

- `AppShell` –∏ `AppOverlays` –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `React.memo`. –°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–æ–ª–ª–±—ç–∫–∏
  —á–µ—Ä–µ–∑ `useCallback`.

### –®–∞–≥ 14. fetchpriority cleanup (‚úÖ –£—Å—Ç–∞—Ä–µ–≤—à–µ–µ ‚Äî —Ä–µ—à–µ–Ω–æ –±–∞–Ω–¥–ª–∏–Ω–≥–æ–º)

> ‚ö†Ô∏è **OBSOLETE** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ 243 —Ç–µ–≥–æ–≤ —Å `fetchpriority="high"` –ø–æ–ª–Ω–æ—Å—Ç—å—é
> —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ 9 –±–∞–Ω–¥–ª–æ–≤.

### –®–∞–≥ 15. Speculative Prefetch (‚úÖ)

- **–§–∞–π–ª—ã:** `apps/web/index.html` ‚Äî inline `<script>` –≤ `<head>`
- –ü—Ä–∏ HTML-–ø–∞—Ä—Å–∏–Ω–≥–µ (+0.0—Å) —á–∏—Ç–∞–µ—Ç `heys_client_current` + `last_sync_ts` –∏–∑
  localStorage, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç delta REST-–∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–º–∏—Å –≤
  `window.__heysPrefetch`.
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Sync-–¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ +0.5‚Äì0.9—Å –≤–º–µ—Å—Ç–æ +1.5‚Äì2.0—Å.

### –®–∞–≥ 16. Delta Fast-Path & Light Path (‚úÖ)

- **Fast-Path:** –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç (0 –∫–ª—é—á–µ–π) ‚Äî sync –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
- **Light Path:** ‚â§10 –∫–ª—é—á–µ–π ‚Üí –ø–∏—à—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ localStorage, —Ç—è–∂–µ–ª–∞—è –æ—á–∏—Å—Ç–∫–∞
  –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 3‚Äì5 —Å–µ–∫.

### –®–∞–≥ 17. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–º–∞—É–Ω—Ç–∞ DayTab (‚úÖ)

- **–ü—Ä–æ–±–ª–µ–º–∞:** `fetchDays` ‚Üí 7√ó `heys:day-updated` ‚Üí 7√ó `setSyncVer++` ‚Üí DayTab
  —Ä–µ–º–∞—É–Ω—Ç ‚Üí –º–µ—Ä—Ü–∞–Ω–∏–µ.
- **–†–µ—à–µ–Ω–∏–µ:** `'fetchDays'` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `IGNORED_SOURCES` –≤ `handleDayUpdate`
  (`heys_app_sync_effects_v1.js`).
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 0 —Ä–µ–º–∞—É–Ω—Ç–æ–≤.

---

## –§–∞–∑–∞ 5: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –º–æ—Ä–≥–∞–Ω–∏–π UI (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û)

### –®–∞–≥ 18. Non-blocking DayTabWithCloudSync (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_app_tabs_v1.js`
- **–†–µ—à–µ–Ω–∏–µ:** Fallback-—Ç–∞–π–º–µ—Ä 5000–º—Å. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `clientId`. –ï—Å–ª–∏
  `heysSyncCompleted` –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∑–∞ 5—Å ‚Äî UI —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.

### –®–∞–≥ 19. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–º–∞—É–Ω—Ç–∞ DayTab (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_app_shell_v1.js:1177`
- **–ü—Ä–æ–±–ª–µ–º–∞:** `syncVer` –≤ `key` ‚Üí sync complete ‚Üí `syncVer++` ‚Üí React
  unmount/remount ‚Üí –±–µ–ª–∞—è –≤—Å–ø—ã—à–∫–∞.
- **–†–µ—à–µ–Ω–∏–µ:** `syncVer` —É–¥–∞–ª—ë–Ω –∏–∑ `key`. –î–æ: `key='day'+syncVer+clientId+date`.
  –ü–æ—Å–ª–µ: `key='day_'+clientId+'_'+date`.

### –®–∞–≥ 20. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ double-fill –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_day_animations.js`, `boot-day.bundle.*.js`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Phase B) –∏–ª–∏ `forceReload` –ø–µ—Ä–µ—Å—á—ë—Ç
  `normAbs` –º–µ–Ω—è–ª `optimum`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–±—Ä–æ—Å—É –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤ 0 –∏
  –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é, –¥–∞–∂–µ –µ—Å–ª–∏ `eatenKcal` –Ω–µ –º–µ–Ω—è–ª—Å—è.
- **–†–µ—à–µ–Ω–∏–µ:** –í `useDayAnimations` –¥–æ–±–∞–≤–ª–µ–Ω—ã `prevKcalRef` –∏ `prevDateTabRef`
  –¥–ª—è –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–∏ "—Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç "—Ñ–æ–Ω–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π".
  –ü—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞—Ä –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –±–µ–∑
  —Å–±—Ä–æ—Å–∞ –≤ 0.
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–∞–±–∏–ª—å–Ω—ã–π UI –Ω–∞ throttled-—Å–µ—Ç–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –≥–ª–∏—Ç—á–µ–π
  –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `heys:day-updated` (batch).

### –®–∞–≥ 21. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ –∏ CRS (‚úÖ)

- –ü—Ä–æ–ø—É—Å–∫ `flush` –¥–ª—è —Å–≤–µ–∂–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ `getCrsNumber` –¥–ª—è –ø—É—Å—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`).

### –®–∞–≥ 22. Cascade Guard v6.2 ‚Äî —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ BROKEN flash (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_cascade_card_v1.js`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ `computeCascadeState()` –≤—ã–∑—ã–≤–∞–ª—Å—è —Å
  `historicalDays=[]` (–¥–æ –ø—Ä–∏—Ö–æ–¥–∞ Phase B —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏), —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è
  `window.HEYS._lastCrs` —Å –ø—É—Å—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π ‚Üí CRS=0/BROKEN ‚Üí flash –∫–∞—Ä—Ç–æ—á–∫–∏
  ¬´–°–ª–æ–º–∞–Ω¬ª, –∑–∞—Ç–µ–º STRONG.
- **–†–µ—à–µ–Ω–∏–µ:** –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π guard:
  1. **Pre-compute guard** (`__heysCascadeBatchSyncReceived`): –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å
     `renderCard()` –ø–æ–∫–∞ —Ñ–ª–∞–≥ –Ω–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω. –í—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑
     `heys:day-updated{batch:true}`, `heysSyncCompleted{phase:'full'}`, –∏–ª–∏
     5-—Å–µ–∫—É–Ω–¥–Ω—ã–π fallback.
  2. **History guard** (`__heysCascadeAllowEmptyHistory`): safety-net –ø–æ—Å–ª–µ
     Layer 1 ‚Äî –ø–æ–¥–∞–≤–ª—è–µ—Ç —Ä–µ–Ω–¥–µ—Ä –ø–æ–∫–∞ `historicalDays.length === 0`. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
     batch-—Å–æ–±—ã—Ç–∏–µ–º –∏–ª–∏ 8-—Å–µ–∫—É–Ω–¥–Ω—ã–º fallback (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).
- **Critical:** `heysSyncCompleted` —Å `phaseA:true` **–æ—Ç–≤–µ—Ä–≥–∞–µ—Ç—Å—è** guard-–æ–º
  (Phase A —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ 5 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π, –±–µ–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–Ω–µ–π).
- **–†–µ–∑—É–ª—å—Ç–∞—Ç (–±—ã—Å—Ç—Ä—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç):** hidden ‚Üí STRONG 90% –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ flash ‚úÖ
- **Throttled 3G (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å):** 5s timeout ‚Üí BROKEN 1% ‚Üí Phase B ‚Üí STRONG 90%
  ‚ö†Ô∏è (–ø—Ä–∏–Ω—è—Ç—ã–π —Ç—Ä–µ–π–¥–æ—Ñ, –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö flash –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω—ë–Ω)
- **–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ:** –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ Gate v6.2 –Ω–∞ fast-internet.

---

## –§–∞–∑–∞ 6: Skeleton & Auth Handover (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û)

### –®–∞–≥ 23. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Skeleton Loader (‚úÖ)

- **–ü—Ä–æ–±–ª–µ–º–∞:** –°–∫–µ–ª–µ—Ç–æ–Ω –∑–∞–≥—Ä—É–∂–∞–ª—Å—è 6‚Äì7 —Å–µ–∫—É–Ω–¥ –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.
- **–†–µ—à–µ–Ω–∏–µ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ Service Worker (0KB transfer –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏). CSS (`main.css`) –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–µ–ª–µ—Ç–æ–Ω–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–æ —Å 6‚Äì7—Å –¥–æ **0.2—Å** (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 30 —Ä–∞–∑). –û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ (Total Load) –Ω–∞ Wi-Fi —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 0.4‚Äì0.6—Å.

### –®–∞–≥ 24. –ë–µ—Å—à–æ–≤–Ω—ã–π Auth Handover (HTML ‚Üí React) (‚úÖ)

- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –≤—Ö–æ–¥–µ –∫—É—Ä–∞—Ç–æ—Ä–∞ —Ñ–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∞—Å—å –Ω–∞ –≤–≤–æ–¥ PIN-–∫–æ–¥–∞ –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –º–µ–∂–¥—É HTML login gate –∏ React `LoginScreen`.
- **–†–µ—à–µ–Ω–∏–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ HTML login gate (`‚úÖ HTML login gate removed ‚Äî React LoginScreen takes over`) –≤ –º–æ–º–µ–Ω—Ç –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ React.
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω—ë–Ω –±–∞–≥ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ—Ä–º—ã. –°–µ—Å—Å–∏—è –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏ `clientId` –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ refresh –±–µ–∑ –º–æ—Ä–≥–∞–Ω–∏–π UI –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–≤–Ω–µ —Ñ–∞–∑)

### Gamification: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π clientId —Å –ø–µ—Ä–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_gamification_v1.js`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `_getXPCacheKey`: –¥–æ–±–∞–≤–ª–µ–Ω `HEYS.currentClientId` –∫–∞–∫ –ø–µ—Ä–≤—ã–π
  –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —É—Å—Ç—Ä–∞–Ω—ë–Ω XP DRIFT –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

### Gamification: —É–¥–∞–ª—ë–Ω boot-time loadFromCloud (‚úÖ)

- –£–±—Ä–∞–Ω `loadFromCloud()` –∏–∑ `setTimeout(2000)` –∏ –∏–∑ `heys:client-changed`.
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä ‚Äî —Å–æ–±—ã—Ç–∏–µ `heysSyncCompleted`.

### MEALREC: useMemo ‚Üí useEffect + useState (‚úÖ)

- **–§–∞–π–ª—ã:** `insights/pi_ui_meal_rec_card.js`
- 154 –≤—ã–∑–æ–≤–∞ `calculateProductScore()` –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ `useEffect + setTimeout(0)`
  ‚Äî React —Å–Ω–∞—á–∞–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å–∫–µ–ª–µ—Ç–æ–Ω.

### Cascade Card: Pre-sync guard (‚úÖ)

- **–§–∞–π–ª—ã:** `heys_cascade_card_v1.js`
- –ï—Å–ª–∏ sync –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω, –Ω–æ –∫—ç—à –µ—Å—Ç—å ‚Äî –¥–µ—Ä–∂–∞—Ç—å –∫—ç—à (`_cascadeSyncDone` —Ñ–ª–∞–≥).

### Race conditions: registerRefeedStep + InsulinWave (‚úÖ)

- Event-driven —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `heys-stepmodal-ready` –∏
  `heys-insulinwave-ready`.
- InsulinWave: –¥–æ–±–∞–≤–ª–µ–Ω `useState(iwVersion)` + `useEffect` listener –¥–ª—è
  –ø–µ—Ä–µ—Å—á—ë—Ç–∞ useMemo.

### localStorage overflow fix (‚úÖ)

- `pi_feedback_loop.js`: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ
  `{scenario, productIds, score, mealType}`, max 50 –∑–∞–ø–∏—Å–µ–π, size guard 200KB.
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** feedback key 693KB ‚Üí <10KB.

### Feedback groups extraction fix (‚úÖ)

- `extractProductIds(rec)` ‚Äî universal extractor –¥–ª—è flat/grouped/multi-meal
  —Ä–µ–∂–∏–º–æ–≤.

### Skeleton UI (‚úÖ)

- HTML/CSS skeleton –≤ `<div id="root">` ‚Äî header, date, metrics, meals, tabs.
  Dark mode. FCP ~0ms.

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–±—É—Ç-–±–∞–Ω–¥–ª–æ–≤ (‚úÖ)

- Sequential `loadNext()` ‚Üí `loadAllParallel()` —Å `s.async = true`. –û–∂–∏–¥–∞–µ–º—ã–π
  —ç—Ñ—Ñ–µ–∫—Ç: 30.6—Å ‚Üí ~4—Å.

---

## ‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–æ–Ω—ã (–Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

| #   | –ü—Ä–æ–±–ª–µ–º–∞                                      | –†–µ—à–µ–Ω–∏–µ (–±—É–¥—É—â–µ–µ)                                                       |
| --- | --------------------------------------------- | ----------------------------------------------------------------------- |
| 1   | EWS v4.2 ‚Äî —Å—Ç–∞—Ä—Ç –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å –¥–æ `appReady` | `requestIdleCallback` –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞                            |
| 2   | Network Waterfall ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ RPC           | –ê—É–¥–∏—Ç –ø–æ—Ä—è–¥–∫–∞ –≤—ã–∑–æ–≤–æ–≤ –Ω–∞ init, `Promise.all()`                          |
| 3   | IndexedDB –º–∏–≥—Ä–∞—Ü–∏—è                            | –ü–µ—Ä–µ–Ω–æ—Å `heys_products` –∏ —Å—Ç–∞—Ä—ã—Ö –¥–Ω–µ–π ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ (230+ –º–µ—Å—Ç —á—Ç–µ–Ω–∏—è) |
| 4   | ESM –º–∏–≥—Ä–∞—Ü–∏—è (~200 —Ñ–∞–π–ª–æ–≤)                    | –°–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç                                                        |
| 5   | Backend –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è                           | –ê—É–¥–∏—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –ë–î, Cloud Function –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ                           |

---

## üîç –ò–Ω—Ü–∏–¥–µ–Ω—Ç: –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ logout (2026-01-05)

> **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –í—Å–µ 4 —Ñ–∏–∫—Å–∞ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞ 2026-01-05 –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
–≤ –æ–±–ª–∞–∫–æ.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** `cloud.signOut()` –Ω–µ –¥–æ–∂–∏–¥–∞–ª—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
–í—ã–∑—ã–≤–∞–ª—Å—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `syncAllData()`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

1. ‚úÖ **Pre-logout sync** ‚Äî –∑–∞–º–µ–Ω—ë–Ω `syncAllData()` –Ω–∞ `flushPendingQueue(5000)`
2. ‚úÖ **Instant UI feedback** ‚Äî –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "Syncing..." –ø—Ä–∏ 0–º—Å, –Ω–µ 500–º—Å
3. ‚úÖ **Persistent errors** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ sync ‚Üí Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. ‚úÖ **Auth errors** ‚Äî –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —è–≤–Ω–æ —É–≤–µ–¥–æ–º–ª—è—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¶–µ–ø–æ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Storage ‚Üí Cloud):**

```
U.lsSet(key, value)
  ‚Üí nsKey = heys_<clientId>_<key>
  ‚Üí HEYS.store.set(nsKey, value) ‚Üí Store.set()
    ‚Üí rawSet() ‚Üí localStorage.setItem()  ‚Üê –ú–ì–ù–û–í–ï–ù–ù–û
    ‚Üí notifyWatchers() ‚Üí UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
    ‚Üí saveClientKey() ‚Üí Cloud sync
      ‚Üí clientUpsertQueue.push()
      ‚Üí savePendingQueue() ‚Üí localStorage (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ –∫—Ä–∞—à–µ)
      ‚Üí notifyPendingChange() ‚Üê –ú–ì–ù–û–í–ï–ù–ù–û, UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Syncing..."
      ‚Üí scheduleClientPush() ‚Üí debounce 500ms ‚Üí doClientUpload()
        ‚Üí batch_upsert_client_kv_by_session RPC ‚Üí PostgreSQL
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏ —Å–∏—Å—Ç–µ–º—ã:**

| –ì–∞—Ä–∞–Ω—Ç–∏—è                      | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è                                        |
| ----------------------------- | ------ | ------------------------------------------------- |
| –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è (0–º—Å)    | ‚úÖ     | `notifyPendingChange()` –¥–æ `debounce`             |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–∞—Ö        | ‚úÖ     | `HEYS.Toast?.error()` –ø—Ä–∏ `persistent: true`      |
| –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ—á–µ—Ä–µ–¥–∏       | ‚úÖ     | `heys_pending_client_queue` –≤ localStorage        |
| Pre-logout sync (–¥–æ 5—Å)       | ‚úÖ     | `await cloud.flushPendingQueue(5000)`             |
| –í—Å–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É | ‚úÖ     | `U.lsSet` ‚Üí `Store.set` ‚Üí `saveClientKey` ‚Üí Cloud |

---

## –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ 26.02.2026)

| –ú–µ—Ç—Ä–∏–∫–∞                                  | –î–æ          | –§–∞–∫—Ç (–∑–∞–º–µ—Ä–µ–Ω–æ) | –¶–µ–ª—å       |
| ---------------------------------------- | ----------- | --------------- | ---------- |
| –í—Ä–µ–º—è –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (WiFi warm)    | 7.2—Å        | **1.0‚Äì1.2—Å ‚úÖ** | < 1—Å       |
| Boot –¥–æ sync done (WiFi)                 | 3.0‚Äì3.4—Å    | **0.9‚Äì1.0—Å ‚úÖ** | < 0.5—Å     |
| –†–µ–º–∞—É–Ω—Ç DayTab per load                  | 1√ó (+2.6—Å)  | **0 ‚úÖ**        | 0          |
| –ú–æ—Ä–≥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ sync             | –í—Å–ø—ã—à–∫–∞     | **0 ‚úÖ**        | 0          |
| BROKEN flash Cascade (fast internet)     | –ï—Å—Ç—å        | **0 ‚úÖ**        | 0          |
| fetchDays ‚Üí setSyncVer calls             | 7√ó          | **0 ‚úÖ**        | 0          |
| –ü–∞—Ä–∞–∑–∏—Ç–Ω—ã–π upload –ø–æ—Å–ª–µ sync             | 404 KB      | **0 ‚úÖ**        | 0          |
| –í—ã–∑–æ–≤–æ–≤ gamification RPC –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ      | 3           | **1 ‚úÖ**        | 1          |
| Retry –ø—Ä–∏ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ Cloud Fn       | Fail        | **–£—Å–ø–µ—Ö ‚úÖ**    | –£—Å–ø–µ—Ö      |
| JS –∑–∞–≥—Ä—É–∑–∫–∞ (mid-tier mobile)            | ~63—Å        | **~1.5—Å ‚úÖ**    | ~5—Å        |
| FCP mid-tier mobile (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) | ~65—Å        | **~2.6—Å ‚úÖ**    | < 5—Å       |
| HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ JS                         | 246         | **9 ‚úÖ**        | < 10       |
| JS-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ PRECACHE SW                | 73 –∏–∑ 246   | **9 –∏–∑ 9 ‚úÖ**   | –í—Å–µ –±–∞–Ω–¥–ª—ã |
| Offline-—Ä–µ–∂–∏–º                            | –ë–µ–ª—ã–π —ç–∫—Ä–∞–Ω | **–†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ** | SW-–∫—ç—à     |

---

## üìã Checklist –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### v6.0 Performance Sprint (23.02.2026)

- [x] –ë–∞–Ω–¥–ª–∏–Ω–≥ 246 —Ñ–∞–π–ª–æ–≤ –≤ 9 –±–∞–Ω–¥–ª–æ–≤ (`scripts/bundle-legacy.mjs`)
- [x] GZIP –Ω–∞ Yandex Object Storage ‚Äî 81% —Å–∂–∞—Ç–∏–µ, 63—Å ‚Üí 1.5—Å
- [x] `_getXPCacheKey` ‚Äî `HEYS.currentClientId` –∫–∞–∫ –ø–µ—Ä–≤—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- [x] boot `setTimeout(2000)` ‚Äî `loadFromCloud()` —É–¥–∞–ª—ë–Ω
- [x] `heys:client-changed` ‚Äî `loadFromCloud()` —É–¥–∞–ª—ë–Ω
- [x] MEALREC ‚Äî `useMemo` ‚Üí `useEffect` + `useState`
- [x] MEALREC ‚Äî Skeleton UI + CSS shimmer animation
- [x] Cascade ‚Äî Pre-sync guard –≤ `renderCard()`

### v9.5‚Äìv9.6 Sync Stability (25‚Äì26.02.2026)

- [x] `DayTabWithCloudSync` ‚Äî non-blocking + 5000ms fallback timer
- [x] clientId-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ `heysSyncCompleted`
- [x] –ü—Ä–æ–ø—É—Å–∫ `flush` –¥–ª—è —Å–≤–µ–∂–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- [x] `getCrsNumber` ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ (return null)
- [x] –£–¥–∞–ª—ë–Ω `syncVer` –∏–∑ `key` `DayTabWithCloudSync` ‚Äî —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ –º–æ—Ä–≥–∞–Ω–∏–µ
- [x] –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ mount/unmount –≤ `DayTabWithCloudSync`

### v9.7 Animation Stability (26.02.2026)

- [x] `useDayAnimations` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã `prevKcalRef` + `prevDateTabRef` –¥–ª—è
      –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç —Ñ–æ–Ω–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [x] double-fill animation —É—Å—Ç—Ä–∞–Ω—ë–Ω: —Ñ–æ–Ω–æ–≤—ã–π sync/forceReload –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç
      –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤ 0
- [x] `boot-day.bundle.7320c50778ec.js` ‚Äî –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–∞ —Å —Ñ–∏–∫—Å–æ–º (—Ö–µ—à –±–∞–Ω–¥–ª–∞
      –ø—Ä–µ–∂–Ω–∏–π)
- [x] –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏: –±–∞—Ä —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ re-animate –ø—Ä–∏
      `heys:day-updated` (batch)
- [x] –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ throttled-—Å–µ—Ç–∏ (Mid-tier mobile): History Guard +
      CascadeCard STRONG ‚Äî –±–µ–∑ –≥–ª–∏—Ç—á–µ–π

### v9.8 Cascade Guard v6.2 (26.02.2026)

- [x] Pre-compute guard (`__heysCascadeBatchSyncReceived`): –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
      `renderCard()` –¥–æ –ø—Ä–∏—Ö–æ–¥–∞ batch-–¥–∞–Ω–Ω—ã—Ö
- [x] History guard (`__heysCascadeAllowEmptyHistory`): safety-net –ø—Ä–æ—Ç–∏–≤
      `historicalDays=[]` –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è Layer 1
- [x] `heysSyncCompleted{phaseA:true}` ‚Äî guard –æ—Ç–≤–µ—Ä–≥–∞–µ—Ç Phase A —Å–æ–±—ã—Ç–∏—è
- [x] Phase B (`heysSyncCompleted{phase:'full', clientId}`) ‚Äî guard –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- [x] `heys:day-updated{batch:true}` ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–±–∞ —Å–ª–æ—è
- [x] 5s fallback (page-boot + client-switch) ‚Äî Layer 1 –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
- [x] 8s fallback ‚Äî Layer 2 (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –æ–±–ª–∞—á–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏)
- [x] Client switch: –æ–±–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è, —Ç–∞–π–º–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è
- [x] CrsProgressBar `getCrsNumber()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` –ø—Ä–∏ `historicalDays<1` ‚Üí
      –º–∞—è—Ç–Ω–∏–∫ –≤–º–µ—Å—Ç–æ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ settle
- [x] –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ fast internet: hidden ‚Üí STRONG 90% –±–µ–∑ flash ‚úÖ

### –ë—É–¥—É—â–∏–µ —Å–ø—Ä–∏–Ω—Ç—ã

- [ ] EWS ‚Äî `requestIdleCallback` (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- [ ] Network Waterfall ‚Äî –∞—É–¥–∏—Ç `Promise.all` –ø—Ä–∏ init
- [ ] ESM –º–∏–≥—Ä–∞—Ü–∏—è (~200 —Ñ–∞–π–ª–æ–≤)
