# –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Ç—Ä–∏–∞–ª–∞ –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–¢—Ä–∏–∞–ª **–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è** –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (0 –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è). –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç ¬´–ø—Ä–æ—Å–ø–∞–Ω–Ω—ã—Ö¬ª —Ç—Ä–∏–∞–ª–æ–≤ –∏ –ø–æ–≤—ã—à–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—é.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–ê–†–ò–ê–ù–¢ 1: Server-side (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è v2)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ Cron-–∑–∞–¥–∞—á–∞: —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å        ‚îÇ
‚îÇ  ‚Ä¢ SQL —Ñ—É–Ω–∫—Ü–∏—è: get_inactive_trials()                   ‚îÇ
‚îÇ  ‚Ä¢ –û–±–Ω–æ–≤–ª—è–µ—Ç: trial_ends_at += –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–Ω–∏           ‚îÇ
‚îÇ  ‚Ä¢ –õ–æ–≥: —Ç–∞–±–ª–∏—Ü–∞ trial_freeze_log                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–ê–†–ò–ê–ù–¢ 2: Client-side (–¥–ª—è MVP)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ app: –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage            ‚îÇ
‚îÇ  ‚Ä¢ –°—á–∏—Ç–∞–µ–º –¥–Ω–∏ –±–µ–∑ meals: findGaps(meals, 3)           ‚îÇ
‚îÇ  ‚Ä¢ –í—ã–∑—ã–≤–∞–µ–º RPC: freeze_trial_days(client_id, days)    ‚îÇ
‚îÇ  ‚Ä¢ –û–±–Ω–æ–≤–ª—è–µ–º UI: badge –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–Ω–∏        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è MVP (Client-side)

### SQL —Ñ—É–Ω–∫—Ü–∏—è

```sql
CREATE OR REPLACE FUNCTION freeze_trial_days(
  p_client_id UUID,
  p_days_to_add INTEGER
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_client RECORD;
  v_new_end TIMESTAMPTZ;
BEGIN
  SELECT * INTO v_client FROM clients WHERE id = p_client_id;
  
  IF NOT FOUND THEN
    RETURN jsonb_build_object('success', false, 'error', 'Client not found');
  END IF;
  
  -- –¢–æ–ª—å–∫–æ –¥–ª—è —Ç—Ä–∏–∞–ª–æ–≤
  IF v_client.subscription_status != 'trial' THEN
    RETURN jsonb_build_object('success', false, 'error', 'Not in trial');
  END IF;
  
  -- –ú–∞–∫—Å–∏–º—É–º +14 –¥–Ω–µ–π –∑–∞–º–æ—Ä–æ–∑–∫–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–∞)
  IF p_days_to_add > 14 THEN
    p_days_to_add := 14;
  END IF;
  
  v_new_end := v_client.trial_ends_at + (p_days_to_add || ' days')::INTERVAL;
  
  UPDATE clients SET
    trial_ends_at = v_new_end,
    updated_at = NOW()
  WHERE id = p_client_id;
  
  -- –õ–æ–≥–∏—Ä—É–µ–º
  INSERT INTO trial_freeze_log (client_id, days_added, reason)
  VALUES (p_client_id, p_days_to_add, 'inactivity');
  
  RETURN jsonb_build_object(
    'success', true,
    'days_added', p_days_to_add,
    'new_trial_ends_at', v_new_end
  );
END;
$$;

-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–æ—Ä–æ–∑–æ–∫
CREATE TABLE IF NOT EXISTS trial_freeze_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  days_added INTEGER NOT NULL,
  reason TEXT, -- 'inactivity', 'force_majeure', 'manual'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_trial_freeze_log_client ON trial_freeze_log(client_id);
```

### JS-–∫–æ–¥ (heys_subscriptions_v1.js)

```javascript
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç—Ä–∏–∞–ª–∞ –∏ –∞–≤—Ç–æ–∑–∞–º–æ—Ä–æ–∑–∫–∞
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç—Ä–∏–∞–ª-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
async function checkTrialActivity(clientId) {
  // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–Ω–µ–π
  const days = [];
  for (let i = 0; i < 10; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    const dayKey = `heys_${clientId}_day_${dateStr}`;
    const dayData = U.lsGet(dayKey);
    if (dayData && dayData.meals && dayData.meals.length > 0) {
      days.push({ date: dateStr, meals: dayData.meals.length });
    }
  }
  
  // 2. –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å
  if (days.length === 0) {
    console.log('[Trial Freeze] No meals found in last 10 days');
    return;
  }
  
  days.sort((a, b) => b.date.localeCompare(a.date)); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
  const lastActiveDate = new Date(days[0].date);
  const today = new Date();
  const daysSinceActive = Math.floor((today - lastActiveDate) / (1000 * 60 * 60 * 24));
  
  console.log('[Trial Freeze] Last active:', lastActiveDate, '| Days since:', daysSinceActive);
  
  // 3. –ï—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω 3+ –¥–Ω—è ‚Äî –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º
  if (daysSinceActive >= 3) {
    const daysToFreeze = Math.min(daysSinceActive - 2, 14); // Max 14 –¥–Ω–µ–π
    console.log(`[Trial Freeze] Freezing trial for ${daysToFreeze} days`);
    
    const { data, error } = await HEYS.cloud.client
      .rpc('freeze_trial_days', {
        p_client_id: clientId,
        p_days_to_add: daysToFreeze
      });
    
    if (data?.success) {
      console.log('[Trial Freeze] Success:', data);
      // –û–±–Ω–æ–≤–ª—è–µ–º badge
      HEYS.Subscriptions.refreshStatus();
    } else {
      console.error('[Trial Freeze] Error:', error || data?.error);
    }
  }
}

// –í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç—Ä–∏–∞–ª-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
HEYS.Subscriptions.checkTrialActivity = checkTrialActivity;
```

### –í—ã–∑–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–í `heys_app_v12.js`:

```javascript
React.useEffect(() => {
  const status = HEYS.Subscriptions.getStatus();
  if (status.is_trial && currentClient) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º —Ç—Ä–∏–∞–ª –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    HEYS.Subscriptions.checkTrialActivity(currentClient).catch(console.error);
  }
}, [currentClient]);
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è v2 (Server-side)

### SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è cron

```sql
CREATE OR REPLACE FUNCTION check_inactive_trials()
RETURNS TABLE (
  client_id UUID,
  client_name TEXT,
  last_active_date DATE,
  days_inactive INTEGER,
  trial_ends_at TIMESTAMPTZ
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- TODO: –¢—Ä–µ–±—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É meals –∏–ª–∏ day_records
  -- –ü–æ–∫–∞ —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
  RAISE NOTICE 'This function requires meals table implementation';
  RETURN;
END;
$$;
```

### Node.js cron-—Å–∫—Ä–∏–ø—Ç

```javascript
// scripts/cron-freeze-inactive-trials.js

async function freezeInactiveTrials() {
  const { data: inactiveTrials } = await supabase.rpc('check_inactive_trials');
  
  for (const trial of inactiveTrials) {
    if (trial.days_inactive >= 3) {
      const daysToFreeze = Math.min(trial.days_inactive - 2, 14);
      
      await supabase.rpc('freeze_trial_days', {
        p_client_id: trial.client_id,
        p_days_to_add: daysToFreeze
      });
      
      console.log(`Frozen trial for ${trial.client_name}: +${daysToFreeze} days`);
    }
  }
}

// Cron: 0 3 * * * (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00)
```

## UI/UX

### Badge –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–Ω–∏

```javascript
// –î–æ –∑–∞–º–æ—Ä–æ–∑–∫–∏:
"–¢—Ä–∏–∞–ª: 2 –¥–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å"

// –ü–æ—Å–ª–µ –∑–∞–º–æ—Ä–æ–∑–∫–∏ (+3 –¥–Ω—è):
"–¢—Ä–∏–∞–ª: 5 –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å"
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```
üí§ –í–∞—à —Ç—Ä–∏–∞–ª –±—ã–ª –Ω–∞ –ø–∞—É–∑–µ {N} –¥–Ω–µ–π –∏–∑-–∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
   –¢–µ–ø–µ—Ä—å —É –≤–∞—Å {X} –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å HEYS!
```

## –ú–µ—Ç—Ä–∏–∫–∏

- –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–∏–∞–ª–æ–≤
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ—Å–ª–µ —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏ vs –æ–±—ã—á–Ω—ã–π —Ç—Ä–∏–∞–ª
- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–º–æ—Ä–æ–∑–∫–∏

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ú–∞–∫—Å–∏–º—É–º 14 –¥–Ω–µ–π –∑–∞–º–æ—Ä–æ–∑–∫–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–∞)
- –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ 0 –ø—Ä–∏—ë–º–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è
- –ù–µ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –ø—Ä–æ—à–ª–æ >7 –¥–Ω–µ–π —Å –Ω–∞—á–∞–ª–∞ —Ç—Ä–∏–∞–ª–∞ (–ø–æ–∑–¥–Ω–æ)

## –ö–æ–≥–¥–∞ –≤–∫–ª—é—á–∞—Ç—å

**MVP:** –û—Ç–ª–æ–∂–∏—Ç—å –¥–æ v2 (—Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ + —Ä–∏—Å–∫ –±–∞–≥–æ–≤)

**v2:** –í–∫–ª—é—á–∏—Ç—å –ø–æ—Å–ª–µ 100+ —Ç—Ä–∏–∞–ª–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏—á–∏–Ω –Ω–µ–∫–æ–Ω–≤–µ—Ä—Å–∏–∏

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏—Å–∫—É—Å—Å–∏–∏

1. **–ü–æ—Ä–æ–≥ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:** 3 –¥–Ω—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ? –ò–ª–∏ 2/5?
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** SMS/push –ø—Ä–∏ –∑–∞–º–æ—Ä–æ–∑–∫–µ –∏–ª–∏ —Ç–∏—Ö–æ?
3. **–ú–∞–∫—Å–∏–º—É–º –∑–∞–º–æ—Ä–æ–∑–∫–∏:** 14 –¥–Ω–µ–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–ª–∏ –º–µ–Ω—å—à–µ?
4. **–¢—Ä–∏–≥–≥–µ—Ä:** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ app –∏–ª–∏ cron server-side?
