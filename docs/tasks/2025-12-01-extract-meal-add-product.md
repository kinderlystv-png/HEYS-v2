# Рефакторинг `apps/web/heys_day_v12.js` (полный)

**Дата**: 2025-12-01 (обновлено)  
**Размер файла**: ~10k строк  
**Цель**: стабилизировать UI/стейт, уменьшить монолит, вернуть читабельность и предотвратить remount-компонентов.

---

## Контекст и главная боль
- `DayTab` содержит всё: стейт дня, UI, модалки, аналитика, побочные эффекты.
- Вложенные компоненты (например, `MealAddProduct` ~800 строк) объявлены внутри `DayTab` → на каждый ререндер создаются новые функции → React размонтирует и монтирует заново (мигание/сброс стейта).
- Глобальные зависимости через `window.HEYS` смешаны с локальными утилитами; фолбеки разбросаны.

**Итоговая цель**: вынести крупные компоненты и побочные эффекты из `DayTab`, обеспечить стабильную идентичность компонентов, сократить размер файла до управляемых модулей без регресса поведения.

---

## Готовность к старту (Phase 0)
1) **Бейзлайн**: Profiler React DevTools → количество ререндеров для:
   - Открытие поиска продукта.
   - Ввод текста в поиск.
   - Добавление продукта.
   Зафиксировать числа «до» (ожидаемо 10+ для проблемных мест).
2) **Бэкап**: `cp apps/web/heys_day_v12.js apps/web/heys_day_v12.backup.js`.
3) **Список зависимостей**: перечислить, что берётся из замыкания `DayTab` и что из `window.HEYS` (см. Phase 2.2).
4) **Локальные незакоммиченные изменения**: зафиксировать текущие diff `apps/web/heys_day_v12.js` и `apps/web/styles/main.css`, чтобы не пересечься с чужими правками.
5) **Порядок загрузки скриптов**: убедиться, что `window.HEYS`/`dayUtils`/`dayHooks` и `SmartSearchWithTypos` загружаются до рендера DayTab. При выносе компонентов нельзя требовать модулей раньше их инициализации.
6) **Среда сборки**: подтвердить, что файл остаётся UMD/скриптом, без ESM/TS. Нельзя добавлять `import/export`. Проверить, что бабель/минсер не ломает `React.memo` с кастомным компаратором.
7) **Мобильный UX**: проверить, есть ли сторонние листенеры (haptic, gestures). Убедиться, что вынос не ломает глобальные обработчики (например, `window.HEYS.debugPanel`).
8) **Сторедж/сеть**: уточнить, может ли autosave/analytics записывать вне sandbox (privacy). Если да — оставить как есть, не добавлять новые побочные эффекты.
9) **Типы/линт**: код JS, без TS. Любые JSDoc/типы должны быть совместимы с текущим билдом (нет генерации d.ts).
10) **Тестовый чеклист UI**: договориться, что проверяем (список в «Тесты и проверки») — иначе рискуем пропустить регресс.

---

## План рефакторинга (рекомендованный порядок)

### Phase 1 — Технический каркас
- Подготовить экспортируемые «глобальные» утилиты:
  - `getDayUtils()` для haptic/uid/pad2/... из `window.HEYS.dayUtils`.
  - `getLs()` для `lsGet/lsSet` из `window.HEYS.utils`.
  - Общий логгер `warn = window.DEV?.warn || console.warn`.
- Оставить DayTab как контейнер, но убрать из него объявления функций-компонентов.

### Phase 2 — Декомпозиция компонентов
**2.1 Вынести компоненты за пределы `DayTab` (в том же файле, над ним) и обернуть в `React.memo`:**
- `MealAddProduct` ( ~800 строк ) — ключевой источник remount; требует пропсов:
  `mi, gramsModal, setGramsModal, day, setDay, products, pIndex, date, prodSig`.
  - prodSig мемоизировать внутри: `useMemo(() => productsSignature(products), [products])`.
  - Компаратор `React.memo`: ререндер если меняется `mi`, gramsModal для этого `mi`, items этого приёма, ссылка на products.
- По возможности выделить ещё 1-2 крупных блока (например, статистика дня / шапка), если они внутри `DayTab` как вложенные функции.

**2.2 Заменить closure-зависимости на пропсы/глобалы для вынесенных компонентов:**
- Из `DayTab`: `gramsModal, setGramsModal, day, setDay, products, pIndex, date, prodSig`.
- Из глобальных: `haptic, uid, lsGet/lsSet, computePopularProducts, buildProductIndex, productsSignature, getProductFromItem, per100, DEV.warn`.

### Phase 3 — Локальные хуки и эффекты
- Вынести побочные эффекты DayTab (autosave, prefetch, mobile detect и т.п.) в отдельные хуки в этом же файле или в `heys_day_hooks.js`:
  - `useDayAutosave`, `useMobileDetection`, `useSmartPrefetch` уже есть в `HEYS.dayHooks` — проверить, что DayTab только вызывает их, без лишней логики вокруг.
  - Остальные эффекты (twemoji parse, analytics track) — обернуть в мелкие функции или отдельный хук для читаемости.

### Phase 4 — Чистка и структура
- Убрать дублирующиеся фолбеки (есть в DayTab и в `dayUtils`), оставить единую точку.
- Сгруппировать константы (типы приёмов, лимиты, тексты) в верхнюю секцию.
- Сократить внутренние инлайновые функции в render-части: вынести обработчики, мапперы в `useMemo/useCallback` где нужно для стабильных ссылок.
- Проверить, что `window.HEYS.debug`/`debugPanel` наполняется в одном месте, без побочного мутирования в глубине компонентов.

---

## Дефиниция Done
- `MealAddProduct` и другие крупные вложенные компоненты определены вне `DayTab` и обёрнуты в `React.memo`.
- Количество ререндеров проблемных мест (Profiler) снижено до 1-3 на действие; нет remount/сброса стейта поиска.
- `DayTab` читается как контейнер (данные/маршрутизация/композиция), а не как мешанина UI-функций.
- Файл уменьшен логически: крупные блоки вынесены в отдельные секции; фолбеки и утилиты централизованы.
- `pnpm type-check && pnpm lint && pnpm build` — PASS.

---

## Тесты и проверки
- UI: открыть поиск, ввести текст, выбрать продукт, открыть модалку граммов, изменить слайдер, добавить продукт, добавить несколько приёмов подряд — без мигания и сброса фокуса.
- Избранное/порции/хиты — работают как раньше.
- Продукты из `HEYS.products.getAll()` подтягиваются, локальный LS fallback жив.
- Dev: twemoji пересборка после рендера остаётся рабочей.
- Perf: Profiler результаты зафиксировать «после».

---

## Если времени мало (fallback)
- Минимальный фикс: обернуть объявление `MealAddProduct` внутри `DayTab` в `React.useMemo(() => function MealAddProduct(){...}, [])` или `useRef` для стабильной идентичности. Это допустимо как временный шаг, но не финальное решение.

---

## Дополнительные рекомендации (смотрим шире)
- **Lazy/Lite загрузка**: грузить тяжёлый поиск/типо-матчинг лениво при открытии модалки, если порядок загрузки скриптов позволяет.
- **UX для мобильного ввода**: удерживать фокус в поле поиска, мягко скроллить к инпуту на iOS (`scrollIntoView`) — проверить после выноса.
- **Виртуализация списка**: если продуктов >200, рассмотреть лёгкую виртуализацию (react-window или собственный windowing).
- **Accessibility/ARIA**: добавить `aria-*` и хоткей `Ctrl/Cmd+K` для поиска, если не ломает мобильные жесты.
- **Метрики локально**: простые замеры времени действий в консоль до/после (без внешних сервисов).
- **WOW-эффект (опционально)**: плавные переходы модалки, skeleton при загрузке поиска, подсказки по избранному — без усложнения логики.

---

## Открытые вопросы (уточнить до начала)
- Можно ли добавлять виртуализацию/ленивую загрузку поиска или строго сохраняем текущую модель загрузки?
- Есть ли жёсткие требования к DOM (классы/id) для автотестов/аналитики?
- Допустимы ли мелкие UX-добавки (skeleton, автофокус, aria), если бизнес-логика не меняется?

---

## Риски и митигация
| Риск | Влияние | Митигация |
|------|---------|-----------|
| Упущены closure-зависимости | Сброс стейта/баги | Чеклист Phase 2.2 + линтер/ts подсказки (хотя файл JS). |
| Сломанные глобальные ссылки (`window.HEYS...`) | Функциональный регресс | Единая точка получения утилит (`getDayUtils`, `getLs`). |
| Большой diff | Сложнее ревью | Делить на коммиты: 1) вынос компонентов, 2) хуки/эффекты, 3) чистка. |
| Перф в рендере списка продуктов | Лаги при поиске | (Опционально) виртуализация/оптимизированный comparator в memo. |
| Порядок загрузки скриптов | Runtime-ошибки в рантайме | Проверить Phase 0.5, не добавлять ESM/динамические импорты. |
| Глобальные обработчики/дебаг-панель | Потеря мобильного UX/gestures | Не трогать `window.HEYS.debugPanel` и глобальные listeners; проверка после рефакторинга. |
| Overkill (слишком большой рефакторинг) | Срыв сроков, риск регресса | Если Profiler < 10 ререндеров и нет явных симптомов — остановиться на минимальном фиксe (стабильная идентичность) и не трогать остальной файл. |

---

## Полезные файлы
- `apps/web/heys_day_v12.js` — основной рефакторинг.
- `apps/web/heys_day_utils.js` — утилиты (haptic, lsGet/lsSet, per100, productsSignature, computePopularProducts).
- `apps/web/heys_day_hooks.js` — уже существующие хуки (`useDayAutosave`, `useMobileDetection`, `useSmartPrefetch`).
- `apps/web/heys_dev_utils.js` — `DEV.warn` и dev-helpers.

---

## Рекомендуемая структура после рефакторинга (минимум)
```
// утилиты/константы
const warn = ...
const { haptic, uid, ... } = getDayUtils();

// вынесенные компоненты
const MealAddProduct = React.memo(function MealAddProduct(props) { ... }, comparator);
// (другие крупные компоненты по возможности)

// основной контейнер
HEYS.DayTab = function DayTab(props) {
  // стейт/эффекты/мемо
  // composition из вынесенных компонентов
};
```
