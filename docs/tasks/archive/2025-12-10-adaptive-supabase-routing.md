# üîÑ Adaptive Supabase Routing ‚Äî VPN + –†–æ—Å—Å–∏—è

**–í–µ—Ä—Å–∏—è –ø—Ä–æ–º–ø—Ç–∞**: 3.0 (–ê–£–î–ò–¢: –∑–∞–¥–∞—á–∞ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê)  
**–î–∞—Ç–∞**: 2025-12-10  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –í–°–Ø –õ–û–ì–ò–ö–ê –£–ñ–ï –í –ö–û–î–ï!

–ü—Ä–∏ –≥–ª—É–±–æ–∫–æ–º –∞—É–¥–∏—Ç–µ –≤—ã—è–≤–ª–µ–Ω–æ —á—Ç–æ **–≤—Å–µ –ø—É–Ω–∫—Ç—ã –ø—Ä–æ–º–ø—Ç–∞ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã** –≤ `heys_storage_supabase_v1.js`:

| –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å | –°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ |
|--------|--------|-------------|
| `switchToProxyConnection()` | ‚úÖ –ï—Å—Ç—å | ~993-1027 |
| `switchToDirectConnection()` | ‚úÖ –ï—Å—Ç—å | ~958-990 |
| `canSwitch()` ‚Äî debounce 30—Å + 2 –æ—à–∏–±–∫–∏ | ‚úÖ –ï—Å—Ç—å | ~1031-1045 |
| `registerSuccess()` / `registerError()` | ‚úÖ –ï—Å—Ç—å | ~1048-1068 |
| Smart –≤—ã–±–æ—Ä –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–∑ localStorage | ‚úÖ –ï—Å—Ç—å | ~1265-1278 |
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–æ—Å–ª–µ 3+ —É—Å–ø–µ—Ö–æ–≤ | ‚úÖ –ï—Å—Ç—å | ~1053-1060 |
| –î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π fallback –≤ `fetchWithRetry()` | ‚úÖ –ï—Å—Ç—å | ~931-950 |
| `cloud.getRoutingStatus()` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ | ‚úÖ –ï—Å—Ç—å | ~1071-1081 |

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**
```javascript
const SWITCH_DEBOUNCE_MS = 30000;     // 30 —Å–µ–∫ –º–µ–∂–¥—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏
const MIN_ERRORS_FOR_SWITCH = 2;      // 2+ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
const MIN_SUCCESS_FOR_SAVE = 3;       // 3+ —É—Å–ø–µ—Ö–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
```

---

## –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

### –§–∞–∑–∞ 0: Cleanup

- [ ] **–£–±—Ä–∞—Ç—å debug alert** –∏–∑ `addProductToMeal` –≤ `heys_day_v12.js` (—Å—Ç—Ä–æ–∫–∞ ~5637)

### –§–∞–∑–∞ 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|---------------|----------|
| –ë–µ–∑ VPN (–†–§) | –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | `cloud.getRoutingStatus().mode === 'proxy'` |
| –° VPN | –í–∫–ª—é—á–∏—Ç—å VPN, –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç | –ü–æ—Å–ª–µ 2 –æ—à–∏–±–æ–∫ ‚Üí `mode === 'direct'` |
| –í—ã–∫–ª—é—á–∏—Ç—å VPN | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç | –ü–æ—Å–ª–µ 2 –æ—à–∏–±–æ–∫ ‚Üí `mode === 'proxy'` |
| –†–µ—Å—Ç–∞—Ä—Ç | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É | –ü–æ–º–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∂–∏–º |
| –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π VPN | 1 –æ—à–∏–±–∫–∞ | –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è (–Ω—É–∂–Ω–æ 2+) |

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:**
```javascript
HEYS.cloud.getRoutingStatus()
// ‚Üí { mode: 'proxy', consecutiveErrors: 0, successCount: 5, canSwitch: false }
```

---

## –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- [ ] –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —á—Ç–æ adaptive routing —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –£–¥–∞–ª–∏—Ç—å debug alert
- [ ] **–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ `docs/tasks/archive/`**
