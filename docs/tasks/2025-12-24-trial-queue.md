# –û—á–µ—Ä–µ–¥—å –Ω–∞ —Ç—Ä–∏–∞–ª + –ø–æ–∫—É–ø–∫–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è (Base/Pro/Pro+)

> **–°—Ç–∞—Ç—É—Å:** üü° –í —Ä–∞–±–æ—Ç–µ  
> **–î–∞—Ç–∞:** 2025-12-24  
> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** HIGH  
> **MVP –æ—Ü–µ–Ω–∫–∞:** 12‚Äì16 —á–∞—Å–æ–≤ + –ª–µ–Ω–¥–∏–Ω–≥ 4‚Äì6 —á–∞—Å–æ–≤

---

## üéØ –ß—Ç–æ —ç—Ç–æ –∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º)

### –ü—Ä–æ–±–ª–µ–º–∞
–ö—É—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ç–æ–ª—å–∫–æ 3‚Äì5 –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —Ç—Ä–∏–∞–ª–µ. –ï—Å–ª–∏ –ø—Ä–∏–¥—ë—Ç 20 —á–µ–ª–æ–≤–µ–∫ —Å—Ä–∞–∑—É ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ —É–ø–∞–¥—ë—Ç, –ª—é–¥–∏ —Ä–∞–∑–æ—á–∞—Ä—É—é—Ç—Å—è, –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ–ø–ª–∞—Ç—É –±—É–¥–µ—Ç –Ω—É–ª–µ–≤–æ–π.

### –†–µ—à–µ–Ω–∏–µ
–î–µ–ª–∞–µ–º **—É–º–Ω—É—é –æ—á–µ—Ä–µ–¥—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç—Ä–∏–∞–ª** + **–ø–æ–∫—É–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏**.

### –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ï—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ**
1. –ß–µ–ª–æ–≤–µ–∫ –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥ ‚Üí –≤–∏–¥–∏—Ç "üü¢ –°–≤–æ–±–æ–¥–Ω–æ 2 –º–µ—Å—Ç–∞ –∏–∑ 3"
2. –ù–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª" ‚Üí –ø–æ–ª—É—á–∞–µ—Ç **–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (offer)** –Ω–∞ 2 —á–∞—Å–∞
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí —Ç—Ä–∏–∞–ª —Å—Ç–∞—Ä—Ç—É–µ—Ç
4. –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞ 2 —á–∞—Å–∞ ‚Üí –º–µ—Å—Ç–æ —É—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–º—É

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–µ—Å—Ç –Ω–µ—Ç**
1. –ß–µ–ª–æ–≤–µ–∫ –≤–∏–¥–∏—Ç "üî¥ –ú–µ—Å—Ç –Ω–µ—Ç ‚Ä¢ –í –æ—á–µ—Ä–µ–¥–∏: 5 —á–µ–ª–æ–≤–µ–∫"
2. –ù–∞–∂–∏–º–∞–µ—Ç "–í—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å" ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é (#6)
3. –ö–æ–≥–¥–∞ –º–µ—Å—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è ‚Äî –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
4. 2 —á–∞—Å–∞ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –µ—Å–ª–∏ –Ω–µ —É—Å–ø–µ–ª, –º–µ—Å—Ç–æ —É—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ —Ö–æ—á—É –∂–¥–∞—Ç—å**
- –†—è–¥–æ–º –≤—Å–µ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ **"–ö—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è"**
- –ü–æ–∫—É–ø–∫–∞ –ª—é–±–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ (Base/Pro/Pro+) ‚Äî **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ**, –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏
- –ï—Å–ª–∏ –±—ã–ª –≤ –æ—á–µ—Ä–µ–¥–∏ –∏ –∫—É–ø–∏–ª ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏

### –ü–æ—á–µ–º—É —ç—Ç–æ —á–µ—Å—Ç–Ω–æ
- –û—á–µ—Ä–µ–¥—å —Ç–æ–ª—å–∫–æ –Ω–∞ **–±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ** ‚Äî –ø–ª–∞—Ç—è—â–∏–µ –Ω–µ –∂–¥—É—Ç
- –ü–æ–∑–∏—Ü–∏—é –Ω–µ–ª—å–∑—è "–ø–µ—Ä–µ–ø—Ä—ã–≥–Ω—É—Ç—å" –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- Offer –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è ‚Äî –≤—Å–µ –≤ —Ä–∞–≤–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
- –ö—É—Ä–∞—Ç–æ—Ä –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω ‚Üí –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –≤—Å–µ—Ö

### –ß—Ç–æ –¥–µ–ª–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏
1. **–¢–∞–±–ª–∏—Ü–∞ `trial_queue`** ‚Äî —Ö—Ä–∞–Ω–∏—Ç –æ—á–µ—Ä–µ–¥—å –∏ —Å—Ç–∞—Ç—É—Å—ã (queued ‚Üí offer ‚Üí assigned)
2. **Assigner** ‚Äî –∫–∞–∂–¥—ã–µ 5‚Äì10 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–æ—Ç—ã –∏ —Ä–∞–∑–¥–∞—ë—Ç offers
3. **–í–∏–¥–∂–µ—Ç –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ** ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ—Å—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** ‚Äî Telegram –∫–æ–≥–¥–∞ –ø—Ä–∏—à–ª–∞ –æ—á–µ—Ä–µ–¥—å

---

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∫–∏ (–∏–Ω–∞—á–µ –±—É–¥—É—Ç –¥—ã—Ä—ã/–±–∞–≥–∏)

### 1) `session_token` ‚Äî opaque token + pgcrypto

UUID —É–≥–∞–¥—ã–≤–∞—Ç—å —Å–ª–æ–∂–Ω–µ–µ —á–∏—Å–ª–∞, –Ω–æ **—ç—Ç–æ –Ω–µ —Å–µ–∫—Ä–µ—Ç**. –î–ª—è PIN-auth –Ω—É–∂–µ–Ω **opaque token**:
- `session_token TEXT` (—Ä–∞–Ω–¥–æ–º 32 –±–∞–π—Ç–∞ hex/base64)
- –≤ –ë–î —Ö—Ä–∞–Ω–∏—Ç—å `token_hash BYTEA` —á–µ—Ä–µ–∑ `pgcrypto`:
  ```sql
  CREATE EXTENSION IF NOT EXISTS pgcrypto;
  token_hash BYTEA = digest(p_session_token, 'sha256')
  ```
- –ø–æ–∏—Å–∫: `WHERE token_hash = digest(p_session_token, 'sha256')`

‚ö†Ô∏è **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** `encode(sha256(...), 'hex')` ‚Äî –≤ Postgres —Ç–∞–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

### 2) –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫

–í —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ –ø–æ–ª—è –≤ `clients` (subscription_status/trial_ends_at/trial_started_at). –î–ª—è MVP:
- **trial/status –ø–æ–ª—è –≤ `clients`** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
- –æ—á–µ—Ä–µ–¥—å –æ—Ç–¥–µ–ª—å–Ω–æ –≤ `trial_queue`

### 3) `current_active_trials` –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å

–£–±—Ä–∞—Ç—å –ø–æ–ª–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–º–∏—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî —Å—á–∏—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å–æ–º.

### 4) –ü–æ–∑–∏—Ü–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–∏—Å–∏

–ü–æ–∑–∏—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (`queued_at + priority`), –∞ –Ω–µ "COUNT(*) –ø–æ now()".

### 5) Offer ‚Üí Claim ‚Üí Trial

–ê—Å—Å–∞–π–Ω–µ—Ä **–≤—ã–¥–∞–µ—Ç offer**, –∞ trial —Å—Ç–∞—Ä—Ç—É–µ—Ç **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ claim**. –ò–Ω–∞—á–µ –±—É–¥—É—Ç "assigned –±–µ–∑ —Å—Ç–∞—Ä—Ç–∞" –∏ –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã.

### 6) –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫ (oversubscribe)

–ü—Ä–∏ –Ω–∞–ø–ª—ã–≤–µ 20 —á–µ–ª–æ–≤–µ–∫ –≤—Å–µ –º–æ–≥—É—Ç —É–≤–∏–¥–µ—Ç—å "—Å–ª–æ—Ç –µ—Å—Ç—å" –∏ –ø–æ–ª—É—á–∏—Ç—å offer. –†–µ—à–µ–Ω–∏–µ:
```sql
SELECT pg_advisory_xact_lock(hashtext('trial_capacity'));
```
–í –Ω–∞—á–∞–ª–µ `request_trial()` –∏ `assign_trials_from_queue()`.

### 7) trial_queue: –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (MVP)

`client_id UNIQUE` –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Äî **–∑–∞–ø—Ä–µ—â–∞–µ—Ç** —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ø—ã—Ç–æ–∫.
**MVP —Ä–µ—à–µ–Ω–∏–µ:** –æ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å + –∏—Å—Ç–æ—Ä–∏—è –≤ `trial_queue_events`.

### 8) Offer expiry: –∂—ë—Å—Ç–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç

`offer_expired` ‚Üí –∑–∞–ø–∏—Å—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `expired`, —Å–ª–æ—Ç —É—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–º—É.
–ß—Ç–æ–±—ã —Å–Ω–æ–≤–∞ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–Ω–æ–≤–æ –≤—ã–∑—ã–≤–∞–µ—Ç `request_trial()`.
–ú—è–≥–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç (–≤–æ–∑–≤—Ä–∞—Ç –≤ –æ—á–µ—Ä–µ–¥—å) ‚Äî —Ç–æ–ª—å–∫–æ –≤ v2 —Å –ª–∏–º–∏—Ç–æ–º –ø–æ–ø—ã—Ç–æ–∫.

### 9) –ü–æ–∑–∏—Ü–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî —Ñ–æ—Ä–º—É–ª–∞ (—É—á–∏—Ç—ã–≤–∞–µ—Ç priority)

–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ (1-based): "—Å–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π **–≤–ø–µ—Ä–µ–¥–∏** –º–µ–Ω—è –ø–æ `(priority DESC, queued_at ASC)` + 1":

```sql
-- –ø–æ–∑–∏—Ü–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–≤–æ–µ–π –∑–∞–ø–∏—Å–∏ (1-based)
SELECT COUNT(*) + 1
INTO v_position
FROM trial_queue
WHERE status = 'queued'
  AND (
    priority > v_my_priority
    OR (priority = v_my_priority AND queued_at < v_my_queued_at)
  );
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –∏—Å–ø–æ–ª—å–∑—É–µ–º `<`, –Ω–µ `<=`, —Ç.–∫. –ø–æ–∑–∏—Ü–∏—è = "—Å–∫–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥–∏ + 1". –ü—Ä–∏ `<=` –ø–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç –Ω–∞ 1 –±–æ–ª—å—à–µ.

### 10) –ó–∞–ø—Ä–µ—Ç "–ø–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏" –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

–ü—Ä–∏ `ON CONFLICT` **–Ω–µ–ª—å–∑—è –æ–±–Ω–æ–≤–ª—è—Ç—å `queued_at`** ‚Äî –∏–Ω–∞—á–µ –∞–±—å—é–∑.

**–ü—Ä–∞–≤–∏–ª–æ MVP:**
- –ï—Å–ª–∏ `status IN ('queued', 'offer')` ‚Üí **–Ω–µ –º–µ–Ω—è—Ç—å `queued_at`**, –≤–µ—Ä–Ω—É—Ç—å `get_trial_queue_status()`
- –ï—Å–ª–∏ `status IN ('expired', 'canceled', 'canceled_by_purchase')` ‚Üí —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–Ω–æ–≤–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å —Å –Ω–æ–≤—ã–º `queued_at`

### 11) claim_trial_offer: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –ø–æ–∫—É–ø–∫–∞ –≤–æ –≤—Ä–µ–º—è offer

–î–æ–±–∞–≤–∏—Ç—å guards:
- –ï—Å–ª–∏ `clients.subscription_status = 'active'` ‚Üí –∑–∞–∫—Ä—ã—Ç—å –æ—á–µ—Ä–µ–¥—å –∫–∞–∫ `canceled_by_purchase`, –≤–µ—Ä–Ω—É—Ç—å `already_active`
- –ï—Å–ª–∏ `clients.trial_started_at IS NOT NULL` ‚Üí –≤–µ—Ä–Ω—É—Ç—å `already_started` (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)

–≠—Ç–æ –∑–∞—â–∏—Ç–∏—Ç –æ—Ç –≥–æ–Ω–æ–∫ "–æ–ø–ª–∞—Ç–∞ vs claim".

### 12) assign_trials_from_queue: –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –∫—É–ø–∏–≤—à–∏—Ö/—É–∂–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–≤—à–∏—Ö

–í SELECT –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä:
```sql
SELECT tq.*
FROM trial_queue tq
JOIN clients c ON c.id = tq.client_id
WHERE tq.status = 'queued'
  AND c.subscription_status != 'active'
  AND c.trial_started_at IS NULL
ORDER BY tq.priority DESC, tq.queued_at ASC
LIMIT ...
```

---

## üìå TL;DR

**–¶–µ–ª—å:** –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –Ω–∞–ø–ª—ã–≤–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ç—Ä–∏–∞–ª–æ–≤ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏.

**–ü—Ä–∞–≤–∏–ª–æ –ø—Ä–æ–¥—É–∫—Ç–∞:**
- –û—á–µ—Ä–µ–¥—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É —Ç—Ä–∏–∞–ª—É**
- –ü–æ–∫—É–ø–∫–∞ **–ª—é–±–æ–π** –ø–æ–¥–ø–∏—Å–∫–∏ (Base/Pro/Pro+) ‚Äî **–≤—Å–µ–≥–¥–∞ —Å—Ä–∞–∑—É**, –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏
- –°–ª–æ—Ç —Ç—Ä–∏–∞–ª–∞ = –µ–¥–∏–Ω–∏—Ü–∞ —Ä–µ–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞ (–Ω–µ –ø—Ä–æ—Å—Ç–æ "trial —Å—Ç–∞—Ç—É—Å")
- Claim window: —Å–ª–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ 2‚Äì6 —á–∞—Å–æ–≤; –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª ‚Äî —É—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–º—É

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. Admission control (–ø—É—Å–∫–∞—Ç—å –≤ —Ç—Ä–∏–∞–ª –∏–ª–∏ –≤ –æ—á–µ—Ä–µ–¥—å)
2. Waitlist storage + Assigner worker
3. Offer + Claim –º–µ—Ö–∞–Ω–∏–∫–∞
4. Notifications (Telegram/SMS)
5. –õ–µ–Ω–¥–∏–Ω–≥: –¥–≤–∞ –ø—É—Ç–∏ + –≤–∏–¥–∂–µ—Ç –º–µ—Å—Ç
6. Admin controls (–ª–∏–º–∏—Ç—ã, –ø–∞—É–∑–∞)

---

## ‚ú® UX-–∞–ø–≥—Ä–µ–π–¥ "—Å—É–ø–µ—Ä–∫—Ä—É—Ç–æ" (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

- –ù–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å **–≤–∏–¥–∂–µ—Ç –º–µ—Å—Ç** (—Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã + —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏).
- –°—Ä–∞–∑—É –≤ —ç—Ç–æ–º –∂–µ —ç–∫—Ä–∞–Ω–µ –¥–∞–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É **"–ö—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è"** (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤).
- –≠—Ñ—Ñ–µ–∫—Ç: —Ä–µ–∑–∫–æ —Å–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–Ω–∏–µ –∏ –Ω–µ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ "–ø—Ä–æ–¥–∞–≤–ª–∏–≤–∞–µ–º –æ–ø–ª–∞—Ç—É", –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –∏ —á–µ—Å—Ç–Ω–æ.

---

## 1) –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å

### 1.1 –ß—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å

1. **–ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç—Ä–∏–∞–ª** (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ—Ç —Å–ª–æ—Ç–æ–≤)
2. **–ö—É–ø–∏—Ç—å —Ç–∞—Ä–∏—Ñ —Å—Ä–∞–∑—É** (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ, –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏)

### 1.2 –ü–æ—á–µ–º—É –æ—á–µ—Ä–µ–¥—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç—Ä–∏–∞–ª

- –¢—Ä–∏–∞–ª ‚Äî –∑–æ–Ω–∞ –∞–±—å—é–∑–∞ –∏ –≤—Å–ø–ª–µ—Å–∫–æ–≤ (10‚Äì20 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ).
- –ü–ª–∞—Ç–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ ‚Äî –Ω–∞–º–µ—Ä–µ–Ω–∏–µ —Å–∏–ª—å–Ω–µ–µ; –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ—ë –æ—á–µ—Ä–µ–¥—å—é –Ω–µ–ª—å–∑—è.

### 1.3 SLA –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö (—á–µ—Å—Ç–Ω–æ, –±–µ–∑ –æ–±–µ—â–∞–Ω–∏–π —Å–≤–µ—Ä—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π)

- Pro: "–æ—Ç–≤–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤"
- Pro+: "–æ—Ç–≤–µ—Ç –∫—É—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 4 —á–∞—Å–æ–≤"

–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî "–≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –≤ —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏".

---

## 2) –ß—Ç–æ —Ç–∞–∫–æ–µ "—Å–ª–æ—Ç —Ç—Ä–∏–∞–ª–∞"

### MVP (—Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

–°–ª–æ—Ç –∑–∞–Ω—è—Ç = `clients.subscription_status = 'trial' AND clients.trial_ends_at > NOW()`

–ü—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Å—á—ë—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

**MVP capacity ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∞—è** (–≤—Å–µ —Å–ª–æ—Ç—ã —Å—É–º–º–∞—Ä–Ω–æ, –ø–æ–¥ –æ–¥–Ω–æ–≥–æ –∫—É—Ä–∞—Ç–æ—Ä–∞).

### v2 (–∫–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Ç–æ—á–Ω–µ–µ)

–°–ª–æ—Ç –∑–∞–Ω—è—Ç, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ —Ç—Ä–∏–∞–ª–µ **–∏**:
- –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ `N` –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä `3`)
  **–∏–ª–∏**
- –µ—Å—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–µ "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∫—É—Ä–∞—Ç–æ—Ä–∞" (—á–µ–∫-–∏–Ω/–≤–æ–ø—Ä–æ—Å/–∑–∞–¥–∞—á–∞)

**v2 capacity ‚Äî per curator** (—à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –ø–æ `curator_id`, –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä–æ–≤).

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –≤ MVP –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å. v2 —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞—Å–∫–∏.

---

## 3) –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `trial_not_started`
- `trial_queued`
- `trial_offer` (**2 —á–∞—Å–∞** –Ω–∞ claim ‚Äî MVP)
- `trial_active`
- `trial_expired` ‚Üí read_only

**–ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
- `request_trial()` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `trial_offer` **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `available_slots > 0`**, –∏–Ω–∞—á–µ `trial_queued`
- `assign_trials_from_queue()` ‚Üí **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π** –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã–¥–∞—á–∏ offer –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ —Å–ª–æ—Ç–∞ (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ `queued`)
- `claim_trial_offer()` ‚Üí —Å—Ç–∞—Ä—Ç —Ç—Ä–∏–∞–ª–∞
- **offer_expired** ‚Üí –≤—ã–ª–µ—Ç–µ–ª, –Ω–∞–¥–æ –∑–∞–Ω–æ–≤–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å (–∂—ë—Å—Ç–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è MVP)
- –ø–æ–∫—É–ø–∫–∞ ‚Üí –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ä–∞–∑—É, –æ—á–µ—Ä–µ–¥—å –æ—Ç–º–µ–Ω—è–µ–º

---

## 4) UX –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ heyslab.ru

### 4.1 Hero: –¥–≤–∞ –º–∞—Ä—à—Ä—É—Ç–∞ + –≤–∏–¥–∂–µ—Ç –º–µ—Å—Ç

CTA —Ä—è–¥–æ–º:
- **"–ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç—Ä–∏–∞–ª"** / **"–í—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å"** (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
- **"–ö—É–ø–∏—Ç—å —Ç–∞—Ä–∏—Ñ —Å—Ä–∞–∑—É"**

**–í–∏–¥–∂–µ—Ç –º–µ—Å—Ç ‚Äî —Ç—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**

1. `available_slots > 0`:
   - üü¢ **–°–≤–æ–±–æ–¥–Ω–æ –º–µ—Å—Ç: X –∏–∑ Y**
   - CTA: "–ù–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª"

2. `available_slots = 0`:
   - üî¥ **–ú–µ—Å—Ç –Ω–µ—Ç ‚Ä¢ –í –æ—á–µ—Ä–µ–¥–∏: N**
   - CTA: "–í—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å"

3. `offer –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`:
   - üü° **–ú–µ—Å—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞ HH:MM**
   - CTA: "–ù–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª" (—Ç–∞–π–º–µ—Ä 2—á)

**–í—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π CTA:**
- "–ö—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è" (–≤ Hero –∏ –≤ –º–æ–¥–∞–ª–∫–µ —Ç—Ä–∏–∞–ª–∞)

–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –ø–æ–¥ CTA (–∞–Ω—Ç–∏—Å–∫–µ–ø—Å–∏—Å):

> "–¢—Ä–∏–∞–ª –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–æ –º–µ—Å—Ç–∞–º, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ.  
> –õ—é–±–æ–π —Ç–∞—Ä–∏—Ñ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å —Å—Ä–∞–∑—É ‚Äî –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è."

### 4.2 –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤

- Base: "—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ" ‚Üí **–ö—É–ø–∏—Ç—å**
- Pro: "—Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º" + SLA ‚Üí **–ö—É–ø–∏—Ç—å**
- Pro+: "—Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º + –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç" + SLA ‚Üí **–ö—É–ø–∏—Ç—å**

---

## 5) –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (MVP)

### 5.0 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ pgcrypto

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

### 5.1 `trial_queue`

```sql
CREATE TABLE trial_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES clients(id) UNIQUE, -- –æ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
  curator_id UUID, -- –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –∫—É—Ä–∞—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  
  status TEXT NOT NULL DEFAULT 'queued' 
    CHECK (status IN ('queued', 'offer', 'assigned', 'canceled', 'canceled_by_purchase', 'expired')),
  
  -- Timestamps
  queued_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  offer_sent_at TIMESTAMPTZ,
  offer_expires_at TIMESTAMPTZ,
  assigned_at TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ,
  
  -- Meta
  source TEXT, -- landing / app / referral / utm_*
  priority INT DEFAULT 0, -- –¥–ª—è priority boost (referral, –¥–µ–ø–æ–∑–∏—Ç)
  notification_channel TEXT DEFAULT 'telegram',
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_trial_queue_status_queued ON trial_queue(status, queued_at) WHERE status = 'queued';
CREATE INDEX idx_trial_queue_status_offer ON trial_queue(status, offer_expires_at) WHERE status = 'offer';
```

**–í–∞–∂–Ω–æ:**
- `client_id UNIQUE` ‚Äî –æ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å, –∏—Å—Ç–æ—Ä–∏—è –≤ `trial_queue_events`
- `position` –ù–ï —Ö—Ä–∞–Ω–∏—Ç—å ‚Äî –≤—ã—á–∏—Å–ª—è—Ç—å
- `current_active_trials` –ù–ï —Ö—Ä–∞–Ω–∏—Ç—å ‚Äî —Å—á–∏—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å–æ–º

### 5.2 `curator_trial_limits`

```sql
CREATE TABLE curator_trial_limits (
  curator_id UUID PRIMARY KEY, -- —Å—Å—ã–ª–∫–∞ –Ω–∞ auth.users
  max_active_trials INT NOT NULL DEFAULT 3,
  is_accepting_trials BOOLEAN DEFAULT TRUE, -- –ø–∞—É–∑–∞
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 5.3 `trial_queue_events` (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

```sql
CREATE TABLE trial_queue_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL,
  event_type TEXT NOT NULL, -- queued, offer_sent, claimed, offer_expired, canceled, purchased
  meta JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_trial_queue_events_client ON trial_queue_events(client_id);
```

---

## 6) RPC / API –∫–æ–Ω—Ç—Ä–∞–∫—Ç (MVP, –ø–æ–¥ PIN-auth)

### 6.0 –í–∞–∂–Ω–æ –ø—Ä–æ —Å–µ—Å—Å–∏—é (PIN-auth)

- `session_token` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ **TEXT** (opaque token)
- –í –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è **—Ç–æ–ª—å–∫–æ hash**: `token_hash BYTEA = digest(token, 'sha256')`
- –õ—é–±—ã–µ RPC –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏–Ω–∏–º–∞—é—Ç `p_session_token TEXT` –∏ –ø–æ–ª—É—á–∞—é—Ç `client_id` —á–µ—Ä–µ–∑ `client_sessions`
- –ü–æ–∏—Å–∫ —Å–µ—Å—Å–∏–∏: `WHERE token_hash = digest(p_session_token, 'sha256')`

### 6.1 –ü—É–±–ª–∏—á–Ω—ã–π –≤–∏–¥–∂–µ—Ç –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞

```sql
-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥—ë—Ä–≥–∞—Ç—å —Å –ª–µ–Ω–¥–∏–Ω–≥–∞ (–±–µ–∑ auth)
CREATE FUNCTION get_public_trial_capacity()
RETURNS JSONB AS $$
DECLARE
  v_total_slots INT;
  v_used_slots INT;
  v_queue_size INT;
BEGIN
  -- –°—á–∏—Ç–∞–µ–º —Å–ª–æ—Ç—ã (–Ω–µ —Ö—Ä–∞–Ω–∏–º!)
  SELECT COALESCE(SUM(max_active_trials), 0) INTO v_total_slots 
  FROM curator_trial_limits WHERE is_accepting_trials = TRUE;
  
  -- –°—á–∏—Ç–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ (–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∏–∞–ª—ã –∏–∑ clients) ‚Äî MVP –º–æ–¥–µ–ª—å
  SELECT COUNT(*) INTO v_used_slots 
  FROM clients 
  WHERE subscription_status = 'trial' 
    AND trial_ends_at > NOW();
  
  SELECT COUNT(*) INTO v_queue_size FROM trial_queue WHERE status = 'queued';
  
  RETURN jsonb_build_object(
    'available_slots', GREATEST(0, v_total_slots - v_used_slots),
    'total_slots', v_total_slots,
    'queue_size', v_queue_size,
    'is_accepting', (v_total_slots > 0) AND (v_total_slots > v_used_slots),
    'offer_window_minutes', 120,  -- 2 —á–∞—Å–∞ –Ω–∞ claim
    'trial_days', 7               -- –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∏–∞–ª–∞
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 6.2 request_trial(session_token TEXT, source TEXT)

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ ON CONFLICT:**
- –ï—Å–ª–∏ —É–∂–µ `queued/offer` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `get_trial_queue_status()`, **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º queued_at**
- –ï—Å–ª–∏ `expired/canceled` ‚Üí –º–æ–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å —Å –Ω–æ–≤—ã–º `queued_at`

```sql
CREATE FUNCTION request_trial(p_session_token TEXT, p_source TEXT DEFAULT 'app')
RETURNS JSONB AS $$
DECLARE
  v_client_id UUID;
  v_free_slots INT;
  v_position INT;
  v_existing RECORD;
  v_my_queued_at TIMESTAMPTZ;
  v_my_priority INT;
BEGIN
  -- ‚ö†Ô∏è –õ–æ–∫ –æ—Ç –≥–æ–Ω–æ–∫
  PERFORM pg_advisory_xact_lock(hashtext('trial_capacity'));
  
  -- –ü–æ–ª—É—á–∏—Ç—å client_id –∏–∑ —Å–µ—Å—Å–∏–∏ (pgcrypto digest)
  SELECT client_id INTO v_client_id FROM client_sessions 
  WHERE token_hash = digest(p_session_token, 'sha256') 
    AND expires_at > NOW() 
    AND revoked_at IS NULL;
  
  IF v_client_id IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'invalid_session');
  END IF;
  
  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —É–∂–µ –±—ã–ª/–µ—Å—Ç—å —Ç—Ä–∏–∞–ª? (trial_started_at ‚Äî —è–≤–Ω—ã–π —Ñ–ª–∞–≥)
  IF EXISTS (SELECT 1 FROM clients WHERE id = v_client_id AND trial_started_at IS NOT NULL) THEN
    RETURN jsonb_build_object('success', false, 'error', 'trial_already_used');
  END IF;
  
  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥–∏
  SELECT * INTO v_existing FROM trial_queue WHERE client_id = v_client_id;
  
  -- ‚ö†Ô∏è –ï—Å–ª–∏ –µ—Å—Ç—å offer –∏ –æ–Ω –∏—Å—Ç—ë–∫ ‚Äî –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ expired –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –Ω–æ–≤—É—é –ø–æ–ø—ã—Ç–∫—É
  -- NB: —Å–æ–±—ã—Ç–∏–µ offer_expired –ª–æ–≥–∏—Ä—É–µ–º –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî UPDATE –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –Ω–µ –ø–æ–ø–∞–¥—ë—Ç —Å—é–¥–∞
  IF v_existing IS NOT NULL
     AND v_existing.status = 'offer'
     AND v_existing.offer_expires_at IS NOT NULL
     AND v_existing.offer_expires_at < NOW()
  THEN
    UPDATE trial_queue
    SET status = 'expired', updated_at = NOW()
    WHERE client_id = v_client_id;

    INSERT INTO trial_queue_events (client_id, event_type)
    VALUES (v_client_id, 'offer_expired');
    
    -- –û–±–Ω—É–ª—è–µ–º v_existing, —á—Ç–æ–±—ã –ª–æ–≥–∏–∫–∞ –Ω–∏–∂–µ —Ä–∞–±–æ—Ç–∞–ª–∞ –∫–∞–∫ "expired"
    v_existing := NULL;
  END IF;
  
  -- ‚ö†Ô∏è –ï—Å–ª–∏ queued/offer (–Ω–µ –∏—Å—Ç—ë–∫) ‚Äî –ù–ï –û–ë–ù–û–í–õ–Ø–ï–ú queued_at, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
  IF v_existing IS NOT NULL AND v_existing.status IN ('queued', 'offer') THEN
    RETURN get_trial_queue_status(p_session_token);
  END IF;
  
  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã
  SELECT (get_public_trial_capacity()->>'available_slots')::INT INTO v_free_slots;
  
  IF v_free_slots > 0 THEN
    -- –í—ã–¥–∞—ë–º offer —Å—Ä–∞–∑—É (–µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ ‚Äî –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ claim)
    INSERT INTO trial_queue (client_id, source, status, offer_sent_at, offer_expires_at)
    VALUES (v_client_id, p_source, 'offer', NOW(), NOW() + INTERVAL '2 hours')
    ON CONFLICT (client_id) DO UPDATE SET
      status = 'offer',
      offer_sent_at = NOW(),
      offer_expires_at = NOW() + INTERVAL '2 hours',
      updated_at = NOW();
    
    INSERT INTO trial_queue_events (client_id, event_type, meta)
    VALUES (v_client_id, 'offer_sent', jsonb_build_object('source', p_source, 'immediate', true));
    
    RETURN jsonb_build_object(
      'success', true,
      'result', 'offer',
      'offer_expires_at', NOW() + INTERVAL '2 hours',
      'message', '–ú–µ—Å—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤.'
    );
  ELSE
    -- –°—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å (queued_at –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö/expired/canceled)
    INSERT INTO trial_queue (client_id, source, status, queued_at)
    VALUES (v_client_id, p_source, 'queued', NOW())
    ON CONFLICT (client_id) DO UPDATE SET
      status = 'queued',
      queued_at = NOW(),  -- –û–∫, —Ç.–∫. –º—ã —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ —á—Ç–æ status –ù–ï queued/offer
      updated_at = NOW();
    
    INSERT INTO trial_queue_events (client_id, event_type, meta)
    VALUES (v_client_id, 'queued', jsonb_build_object('source', p_source));
    
    -- –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–∑–∏—Ü–∏–∏
    SELECT queued_at, priority INTO v_my_queued_at, v_my_priority
    FROM trial_queue WHERE client_id = v_client_id;
    
    -- ‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è: —Å–∫–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥–∏ –º–µ–Ω—è –ø–æ (priority DESC, queued_at ASC) + 1
    SELECT COUNT(*) + 1 INTO v_position
    FROM trial_queue
    WHERE status = 'queued'
      AND (
        priority > v_my_priority
        OR (priority = v_my_priority AND queued_at < v_my_queued_at)
      );
    
    RETURN jsonb_build_object(
      'success', true,
      'result', 'queued',
      'position', v_position,
      'queue_size', (SELECT COUNT(*) FROM trial_queue WHERE status = 'queued'),
      'message', '–í—ã –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ —Ç—Ä–∏–∞–ª'
    );
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 6.3 get_trial_queue_status(session_token TEXT)

```sql
CREATE FUNCTION get_trial_queue_status(p_session_token TEXT)
RETURNS JSONB AS $$
DECLARE
  v_client_id UUID;
  v_queue RECORD;
  v_position INT;
BEGIN
  -- –ü–æ–ª—É—á–∏—Ç—å client_id –∏–∑ —Å–µ—Å—Å–∏–∏ (pgcrypto digest)
  SELECT client_id INTO v_client_id FROM client_sessions 
  WHERE token_hash = digest(p_session_token, 'sha256') 
    AND expires_at > NOW() 
    AND revoked_at IS NULL;
  
  IF v_client_id IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'invalid_session');
  END IF;
  
  SELECT * INTO v_queue FROM trial_queue WHERE client_id = v_client_id;
  
  IF v_queue IS NULL THEN
    RETURN jsonb_build_object('success', true, 'status', 'not_in_queue');
  END IF;
  
  -- –í—ã—á–∏—Å–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–∏—Å–∏ (1-based)
  IF v_queue.status = 'queued' THEN
    SELECT COUNT(*) + 1 INTO v_position FROM trial_queue 
    WHERE status = 'queued' 
      AND (priority > v_queue.priority 
           OR (priority = v_queue.priority AND queued_at < v_queue.queued_at));
  END IF;
  
  RETURN jsonb_build_object(
    'success', true,
    'status', v_queue.status,
    'position', v_position,
    'queued_at', v_queue.queued_at,
    'offer_expires_at', v_queue.offer_expires_at,
    'queue_size', (SELECT COUNT(*) FROM trial_queue WHERE status = 'queued')
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 6.4 claim_trial_offer(session_token TEXT)

**Guards –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ + –ø–æ–∫—É–ø–∫–∞ –≤–æ –≤—Ä–µ–º—è offer:**
- –ï—Å–ª–∏ `clients.subscription_status = 'active'` ‚Üí `canceled_by_purchase`, return `already_active`
- –ï—Å–ª–∏ `clients.trial_started_at IS NOT NULL` ‚Üí return `already_started`

```sql
CREATE FUNCTION claim_trial_offer(p_session_token TEXT)
RETURNS JSONB AS $$
DECLARE
  v_client_id UUID;
  v_client RECORD;
  v_queue RECORD;
BEGIN
  -- –ü–æ–ª—É—á–∏—Ç—å client_id –∏–∑ —Å–µ—Å—Å–∏–∏ (pgcrypto digest)
  SELECT client_id INTO v_client_id FROM client_sessions 
  WHERE token_hash = digest(p_session_token, 'sha256') 
    AND expires_at > NOW() 
    AND revoked_at IS NULL;
  
  IF v_client_id IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'invalid_session');
  END IF;
  
  -- ‚ö†Ô∏è Guard: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
  SELECT * INTO v_client FROM clients WHERE id = v_client_id;
  
  -- Guard 1: –£–∂–µ –∫—É–ø–∏–ª –ø–æ–¥–ø–∏—Å–∫—É –≤–æ –≤—Ä–µ–º—è offer
  IF v_client.subscription_status = 'active' THEN
    UPDATE trial_queue SET status = 'canceled_by_purchase', updated_at = NOW()
    WHERE client_id = v_client_id AND status = 'offer';
    INSERT INTO trial_queue_events (client_id, event_type) VALUES (v_client_id, 'canceled_by_purchase');
    RETURN jsonb_build_object('success', false, 'error', 'already_active', 'message', '–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.');
  END IF;
  
  -- Guard 2: –¢—Ä–∏–∞–ª —É–∂–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
  IF v_client.trial_started_at IS NOT NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'already_started', 'message', '–¢—Ä–∏–∞–ª —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω.');
  END IF;
  
  SELECT * INTO v_queue FROM trial_queue 
  WHERE client_id = v_client_id AND status = 'offer';
  
  IF v_queue IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'no_offer_available');
  END IF;
  
  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ offer (–∂—ë—Å—Ç–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç: expired = –≤—ã–ª–µ—Ç–µ–ª)
  IF v_queue.offer_expires_at < NOW() THEN
    UPDATE trial_queue SET status = 'expired', updated_at = NOW() WHERE id = v_queue.id;
    INSERT INTO trial_queue_events (client_id, event_type) VALUES (v_client_id, 'offer_expired');
    RETURN jsonb_build_object('success', false, 'error', 'offer_expired', 'message', '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ —Ç—Ä–∏–∞–ª —Å–Ω–æ–≤–∞.');
  END IF;
  
  -- –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ assigned
  UPDATE trial_queue SET status = 'assigned', assigned_at = NOW(), updated_at = NOW() WHERE id = v_queue.id;
  
  -- –°—Ç–∞—Ä—Ç—É–µ–º —Ç—Ä–∏–∞–ª (–æ–±–Ω–æ–≤–ª—è–µ–º clients)
  UPDATE clients SET 
    subscription_status = 'trial',
    trial_started_at = NOW(),
    trial_ends_at = NOW() + INTERVAL '7 days',
    updated_at = NOW()
  WHERE id = v_client_id;
  
  INSERT INTO trial_queue_events (client_id, event_type) VALUES (v_client_id, 'claimed');
  
  RETURN jsonb_build_object('success', true, 'message', '–¢—Ä–∏–∞–ª –Ω–∞—á–∞—Ç!', 'trial_ends_at', NOW() + INTERVAL '7 days');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 6.5 assign_trials_from_queue(limit INT)

**Guard:** –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –∫—É–ø–∏–ª –∏–ª–∏ —É–∂–µ –ø–æ–ª—É—á–∏–ª trial.

```sql
-- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ—Ä–∫–µ—Ä–æ–º/cron –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç
CREATE FUNCTION assign_trials_from_queue(p_limit INT DEFAULT 10)
RETURNS JSONB AS $$
DECLARE
  v_assigned INT := 0;
  v_queue_row RECORD;
  v_available INT;
  v_offer_window INTERVAL := INTERVAL '2 hours';
BEGIN
  -- ‚ö†Ô∏è –õ–æ–∫ –æ—Ç –≥–æ–Ω–æ–∫
  PERFORM pg_advisory_xact_lock(hashtext('trial_capacity'));
  
  -- –°–Ω–∞—á–∞–ª–∞: expired offers ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å expired
  UPDATE trial_queue SET status = 'expired', updated_at = NOW()
  WHERE status = 'offer' AND offer_expires_at < NOW();
  
  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã
  SELECT (get_public_trial_capacity()->>'available_slots')::INT INTO v_available;
  
  IF v_available <= 0 THEN
    RETURN jsonb_build_object('assigned', 0, 'reason', 'no_slots_available');
  END IF;
  
  -- ‚ö†Ô∏è –†–∞–∑–¥–∞—Ç—å offers –ø–µ—Ä–≤—ã–º –≤ –æ—á–µ—Ä–µ–¥–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º!)
  FOR v_queue_row IN 
    SELECT tq.*
    FROM trial_queue tq
    JOIN clients c ON c.id = tq.client_id
    WHERE tq.status = 'queued'
      AND c.subscription_status != 'active'      -- –Ω–µ –∫—É–ø–∏–ª
      AND c.trial_started_at IS NULL             -- –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª trial
    ORDER BY tq.priority DESC, tq.queued_at ASC 
    LIMIT LEAST(p_limit, v_available)
  LOOP
    UPDATE trial_queue SET 
      status = 'offer',
      offer_sent_at = NOW(),
      offer_expires_at = NOW() + v_offer_window,
      updated_at = NOW()
    WHERE id = v_queue_row.id;
    
    INSERT INTO trial_queue_events (client_id, event_type, meta)
    VALUES (v_queue_row.client_id, 'offer_sent', jsonb_build_object('expires_at', NOW() + v_offer_window));
    
    -- TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Telegram/SMS)
    -- PERFORM send_trial_offer_notification(v_queue_row.client_id);
    
    v_assigned := v_assigned + 1;
  END LOOP;
  
  RETURN jsonb_build_object('assigned', v_assigned);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## 7) –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–∫—É–ø–∫–æ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –ª—é–±–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞:

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫—É–ø–∫–∏
UPDATE trial_queue 
SET status = 'canceled_by_purchase', canceled_at = NOW(), updated_at = NOW()
WHERE client_id = p_client_id AND status IN ('queued', 'offer');

INSERT INTO trial_queue_events (client_id, event_type, meta)
VALUES (p_client_id, 'purchased', jsonb_build_object('tariff', p_tariff));
```

–ß—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞–ª –º–µ—Å—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏.

---

## 8) –ê–Ω—Ç–∏–∞–±—å—é–∑ (MVP)

1. **1 —Ç—Ä–∏–∞–ª –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `request_trial()`
2. **Cooldown –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ç—Ä–∏–∞–ª–∞** ‚Äî 30 –¥–Ω–µ–π –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã/–∏—Å—Ç–µ—á–µ–Ω–∏—è
3. **Rate limit –Ω–∞ request_trial** ‚Äî max 3 –∑–∞—è–≤–∫–∏ –≤ —á–∞—Å —Å –æ–¥–Ω–æ–≥–æ IP
4. **Claim window** ‚Äî 2‚Äì6 —á–∞—Å–æ–≤

---

## 9) –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `waitlist_size` | –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ |
| `wait_time_p50` | –ú–µ–¥–∏–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è |
| `wait_time_p90` | 90-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –æ–∂–∏–¥–∞–Ω–∏—è |
| `offer_claim_rate` | % –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–≤—à–∏—Ö offer |
| `trial_to_paid` | –ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ç—Ä–∏–∞–ª ‚Üí –ø–æ–∫—É–ø–∫–∞ |
| `paid_direct` | –°–∫–æ–ª—å–∫–æ –∫—É–ø–∏–ª–∏ –±–µ–∑ —Ç—Ä–∏–∞–ª–∞ |
| `curator_load` | –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∏–∞–ª–æ–≤ –Ω–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞ |

---

## üìÖ –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (–ø–æ—à–∞–≥–æ–≤–æ)

### Phase 1: Backend (4‚Äì6—á)
- [ ] –¢–∞–±–ª–∏—Ü—ã –æ—á–µ—Ä–µ–¥–∏ –∏ –ª–∏–º–∏—Ç–æ–≤
- [ ] RPC: capacity/status/request/claim/cancel
- [ ] Assigner RPC + cron
- [ ] –°–Ω—è—Ç–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ

### Phase 2: App (4‚Äì6—á)
- [ ] TrialCapacityWidget
- [ ] QueueStatusCard
- [ ] OfferClaimCard (—Ç–∞–π–º–µ—Ä)
- [ ] –í–µ–∑–¥–µ –∫–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è"

### Phase 3: Landing (4‚Äì6—á)
- [ ] Hero —Å –¥–≤—É–º—è –ø—É—Ç—è–º–∏ + –≤–∏–¥–∂–µ—Ç –º–µ—Å—Ç
- [ ] –ú–æ–¥–∞–ª–∫–∞ —Ç—Ä–∏–∞–ª–∞ (slot/queue/offer)
- [ ] –¢–∞—Ä–∏—Ñ—ã —Å "–ö—É–ø–∏—Ç—å —Å—Ä–∞–∑—É"

### Phase 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (2‚Äì4—á)
- [ ] Telegram + SMS fallback
- [ ] –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `database/2025-12-24_subscriptions_and_sessions_yc.sql` | –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ |
| `apps/web/heys_subscription_v1.js` | –ú–æ–¥—É–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ |
| `apps/web/heys_paywall_v1.js` | Paywall UI |
| `apps/landing/` | Landing page |
| `yandex-cloud-functions/heys-api-rpc/index.js` | RPC gateway |

---

## ‚úÖ Definition of Done

1. ‚úÖ –ù–µ—Ç —Å–ª–æ—Ç–æ–≤ ‚Üí –æ—á–µ—Ä–µ–¥—å + –ø–æ–∑–∏—Ü–∏—è (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–∏—Å–∏)
2. ‚úÖ –°–ª–æ—Ç –ø–æ—è–≤–∏–ª—Å—è ‚Üí offer + —Ç–∞–π–º–µ—Ä
3. ‚úÖ Claim ‚Üí trial —Å—Ç–∞—Ä—Ç—É–µ—Ç
4. ‚úÖ –¢–∞–π–º–∞—É—Ç offer ‚Üí —Å–ª–µ–¥—É—é—â–∏–π
5. ‚úÖ –õ—é–±–æ–π —Ç–∞—Ä–∏—Ñ –ø–æ–∫—É–ø–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É
6. ‚úÖ –ü–æ–∫—É–ø–∫–∞ —Å–Ω–∏–º–∞–µ—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏ (`canceled_by_purchase`)
7. ‚úÖ –õ–µ–Ω–¥–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ—Å—Ç–∞ –∏ "–∫—É–ø–∏—Ç—å –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è" –Ω–∞ –æ–¥–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
8. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ `request_trial` –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏
9. ‚úÖ `assign_trials` –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∫—É–ø–∏–ª–∏/—Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∏ —Ç—Ä–∏–∞–ª
10. ‚úÖ `request_trial()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π offer: –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ `expired` –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–Ω–æ–≤–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ç—Ä–∏–∞–ª
11. ‚úÖ –ù–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ `offer` (UNIQUE constraint –Ω–∞ `client_id`)
12. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π `request_trial()` –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º `offer` **–Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç** `offer_expires_at` (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
13. ‚úÖ `get_public_trial_capacity()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `offer_window_minutes` –∏ `trial_days` ‚Äî –ª–µ–Ω–¥–∏–Ω–≥/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞
