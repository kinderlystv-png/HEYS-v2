# üéØ Meal Quality Score ‚Äî –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏

**–î–∞—Ç–∞**: 2025-12-03  
**–í—Ä–µ–º—è**: ~2.5-3 —á–∞—Å–∞  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî• –í—ã—Å–æ–∫–∏–π  
**–ê—É–¥–∏—Ç**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω 2025-12-03

---

## ‚ö†Ô∏è Phase 0 ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π)

### –î–æ –Ω–∞—á–∞–ª–∞:
- [ ] `git add . && git commit -m "WIP: before meal quality score"` ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- [ ] –ë—ç–∫–∞–ø: `cp apps/web/heys_day_v12.js apps/web/heys_day_v12.backup3.js`
- [ ] –°–∫—Ä–∏–Ω—à–æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ª–æ—Ä–∏–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ baseline: –≥—Ä–∞—Ñ–∏–∫ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞):
```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 10 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ gi –∏ harm:
const products = JSON.parse(localStorage.getItem('heys_products') || '[]');
products.slice(0, 10).forEach(p => console.log(p.name, 'gi:', p.gi, 'harm:', p.harm));
```

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–µ—Ä—ã:
1. **`M.mealTotals()` –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç gi –∏ harm!** ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ MealCard (—Å—Ç—Ä–æ–∫–∞ 292)
2. **–ü—Ä–æ–¥—É–∫—Ç—ã –±–µ–∑ gi/harm** ‚Üí Fallback: gi=50 (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π), harm=0
3. **mealsChartData –Ω–µ –∏–º–µ–µ—Ç `type`** ‚Üí –î–æ–±–∞–≤–∏—Ç—å `type: mealTypeInfo.type`
4. **`getProductFromItem` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω** ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å scope

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –≤ –≥—Ä–∞—Ñ–∏–∫ "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π". –¶–≤–µ—Ç –ø–æ–ª–æ—Å–∫–∏ –∏ –±–µ–π–¥–∂–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏—ë–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.

---

## üé® –í–∏–∑—É–∞–ª

```
üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π                    2261 / 1800 –∫–∫–∞–ª

üç≥ –ó–∞–≤—Ç—Ä–∞–∫  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë] 387 –∫–∫–∞–ª  ‚≠ê 92           08:30
üçé –ü–µ—Ä–µ–∫—É—Å  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 120 –∫–∫–∞–ª  ‚≠ê 78           11:00  
üç≤ –û–±–µ–¥     [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë] 450 –∫–∫–∞–ª  ‚≠ê 85           13:30
ü•ú –ü–µ—Ä–µ–∫—É—Å  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 280 –∫–∫–∞–ª  ‚≠ê 45  !–ö !–ì–ò   16:00
üçΩÔ∏è –£–∂–∏–Ω     [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë] 520 –∫–∫–∞–ª  ‚≠ê 65  !–ö       20:00

–¶–≤–µ—Ç–∞ –ø–æ–ª–æ—Å–æ–∫:
- üü¢ –ó–µ–ª—ë–Ω—ã–π (score 80-100): –æ—Ç–ª–∏—á–Ω—ã–π –ø—Ä–∏—ë–º (–±–µ–∑ –±–µ–π–¥–∂–µ–π)
- üü° –ñ—ë–ª—Ç—ã–π (score 50-79): –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, –µ—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è
- üî¥ –ö—Ä–∞—Å–Ω—ã–π (score 0-49): –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –ø—Ä–∏—ë–º
```

**–ë–µ–π–¥–∂–∏ (–¢–û–õ–¨–ö–û –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ, max 3):**
- `!–ë` ‚Äî –º–∞–ª–æ –±–µ–ª–∫–∞ (< 20–≥ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞)
- `!–ö` ‚Äî –ø–µ—Ä–µ–±–æ—Ä –∫–∞–ª–æ—Ä–∏–π –¥–ª—è —Ç–∏–ø–∞ –ø—Ä–∏—ë–º–∞
- `!–ì–ò` ‚Äî –≤—ã—Å–æ–∫–∏–π –ì–ò (> 70)
- `!–í—Ä` ‚Äî –º–Ω–æ–≥–æ –≤—Ä–µ–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (harm > 10)
- `!–¢–ñ` ‚Äî –µ—Å—Ç—å —Ç—Ä–∞–Ω—Å-–∂–∏—Ä—ã (> 0.5–≥)

---

## üßÆ –ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ü–µ–Ω–∫–∏ (100 –±–∞–ª–ª–æ–≤)

### 1. –ö–∞–ª–æ—Ä–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç–∏–ø–∞ (30 –±–∞–ª–ª–æ–≤)

**–û–∂–∏–¥–∞–µ–º–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏:**
```javascript
const MEAL_KCAL_DISTRIBUTION = {
  breakfast: { minPct: 0.20, maxPct: 0.30 },  // 20-30% –¥–Ω–µ–≤–Ω—ã—Ö
  snack1:    { minPct: 0.05, maxPct: 0.10 },  // 5-10%
  lunch:     { minPct: 0.30, maxPct: 0.40 },  // 30-40%
  snack2:    { minPct: 0.05, maxPct: 0.10 },  // 5-10%
  dinner:    { minPct: 0.20, maxPct: 0.30 },  // 20-30%
  snack3:    { minPct: 0.02, maxPct: 0.05 },  // 2-5%
  night:     { minPct: 0.00, maxPct: 0.05 }   // 0-5% (–ª—É—á—à–µ 0)
};
```

**–®—Ç—Ä–∞—Ñ—ã:**
- –ü—Ä–∏—ë–º –ø–æ—Å–ª–µ 21:00 ‚Äî —à—Ç—Ä–∞—Ñ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–∞–ª–æ—Ä–∏—è–º
- –ö–∞–ª–æ—Ä–∏–∏ > maxPct ‚Äî —à—Ç—Ä–∞—Ñ
- –ö–∞–ª–æ—Ä–∏–∏ < minPct (–¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö) ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π —à—Ç—Ä–∞—Ñ

### 2. –ë–∞–ª–∞–Ω—Å –ë–ñ–£ (25 –±–∞–ª–ª–æ–≤)

```javascript
// –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏—ë–º–∞
const IDEAL_MACROS = {
  breakfast: { protPct: 0.20, carbPct: 0.50, fatPct: 0.30 },
  lunch:     { protPct: 0.30, carbPct: 0.40, fatPct: 0.30 },
  dinner:    { protPct: 0.35, carbPct: 0.35, fatPct: 0.30 },
  snack:     { protPct: 0.15, carbPct: 0.55, fatPct: 0.30 }
};
```

- –ë–µ–ª–æ–∫ >= 20–≥ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏—ë–º–µ: +5 –±–∞–ª–ª–æ–≤
- –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –∏–¥–µ–∞–ª–∞: -–±–∞–ª–ª—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

### 3. –ö–∞—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤ (15 –±–∞–ª–ª–æ–≤)

```javascript
const simpleRatio = simple / (simple + complex);
// –ò–¥–µ–∞–ª: simpleRatio <= 0.30 (30% –ø—Ä–æ—Å—Ç—ã—Ö)
```

- simpleRatio <= 0.30: –ø–æ–ª–Ω—ã–µ 15 –±–∞–ª–ª–æ–≤
- simpleRatio 0.30-0.50: 10 –±–∞–ª–ª–æ–≤
- simpleRatio 0.50-0.70: 5 –±–∞–ª–ª–æ–≤
- simpleRatio > 0.70: 0 –±–∞–ª–ª–æ–≤

### 4. –ö–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤ (15 –±–∞–ª–ª–æ–≤)

```javascript
const goodRatio = good / (bad + good + trans);
const hasTrans = trans > 0;
```

- goodRatio >= 0.60: –ø–æ–ª–Ω—ã–µ 15 –±–∞–ª–ª–æ–≤
- hasTrans: -5 –±–∞–ª–ª–æ–≤
- badRatio > 0.50: -5 –±–∞–ª–ª–æ–≤

### 5. –ì–ò –∏ –≤—Ä–µ–¥–Ω–æ—Å—Ç—å (15 –±–∞–ª–ª–æ–≤)

```javascript
// –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–π –ì–ò –ø—Ä–∏—ë–º–∞
const avgGI = weightedAvgGI(items);
// –°—Ä–µ–¥–Ω—è—è –≤—Ä–µ–¥–Ω–æ—Å—Ç—å
const avgHarm = weightedAvgHarm(items);
```

- avgGI <= 55: –ø–æ–ª–Ω—ã–µ –±–∞–ª–ª—ã
- avgGI 55-70: —á–∞—Å—Ç–∏—á–Ω—ã–µ –±–∞–ª–ª—ã
- avgGI > 70: —à—Ç—Ä–∞—Ñ
- avgHarm > 5: —à—Ç—Ä–∞—Ñ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

---

## üìÅ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `apps/web/heys_day_v12.js` | `getMealQualityScore()`, –æ–±–Ω–æ–≤–∏—Ç—å `mealsChartData`, —Ä–µ–Ω–¥–µ—Ä –±–µ–π–¥–∂–µ–π |
| `apps/web/styles/modules/600-steps-and-aps.css` | –°—Ç–∏–ª–∏ –±–µ–π–¥–∂–µ–π –∫–∞—á–µ—Å—Ç–≤–∞ |
| `docs/DATA_MODEL_REFERENCE.md` | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ |

---

## ‚úÖ –ó–∞–¥–∞—á–∏

### –§–∞–∑–∞ 1: –§—É–Ω–∫—Ü–∏—è –æ—Ü–µ–Ω–∫–∏ (45 –º–∏–Ω)

- [ ] 1.1. –°–æ–∑–¥–∞—Ç—å `getMealQualityScore(meal, mealType, optimum, pIndex)` 
- [ ] 1.2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç –ø–æ 5 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–∫–∫–∞–ª, –ë–ñ–£, —É–≥–ª–µ–≤–æ–¥—ã, –∂–∏—Ä—ã, –ì–ò/–≤—Ä–µ–¥)
- [ ] 1.3. –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `{ score, color, badges: [{type, ok}] }`
- [ ] 1.4. **–í–ê–ñ–ù–û**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω mTotals –¥–ª—è gi/harm (–Ω–µ M.mealTotals!)

### –§–∞–∑–∞ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≥—Ä–∞—Ñ–∏–∫ (30 –º–∏–Ω)

- [ ] 2.1. –û–±–Ω–æ–≤–∏—Ç—å `mealsChartData` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `quality` –∏ `type` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
- [ ] 2.2. –¶–≤–µ—Ç –ø–æ–ª–æ—Å–∫–∏ –ø–æ `quality.color`
- [ ] 2.3. –ü–æ–∫–∞–∑–∞—Ç—å `quality.score` —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–æ–ª–æ—Å–∫–∏

### –§–∞–∑–∞ 3: –ë–µ–π–¥–∂–∏ (20 –º–∏–Ω)

- [ ] 3.1. –†–µ–Ω–¥–µ—Ä –¢–û–õ–¨–ö–û –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–µ–π–¥–∂–µ–π `!–ö !–ì–ò !–¢–ñ` (max 3)
- [ ] 3.2. –°—Ç–∏–ª–∏: –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ø—Ä–æ–±–ª–µ–º
- [ ] 3.3. –ü–æ –∫–ª–∏–∫—É –Ω–∞ –ø–æ–ª–æ—Å–∫—É ‚Üí **StepModal** —Å –¥–µ—Ç–∞–ª—è–º–∏ (‚úì/‚ö†Ô∏è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)

### –§–∞–∑–∞ 4: Streak –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ (15 –º–∏–Ω)

- [ ] 4.1. –ü–æ–¥—Å—á—ë—Ç –ø–æ–¥—Ä—è–¥ –∏–¥—É—â–∏—Ö –ø—Ä–∏—ë–º–æ–≤ —Å–æ score ‚â• 80
- [ ] 4.2. –ü—Ä–∏ streak ‚â• 3 –ø–æ–∫–∞–∑–∞—Ç—å "üî• 3 –æ—Ç–ª–∏—á–Ω—ã—Ö –ø—Ä–∏—ë–º–∞ –ø–æ–¥—Ä—è–¥!"
- [ ] 4.3. Haptic `success` –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ streak

### –§–∞–∑–∞ 5: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ (15 –º–∏–Ω)

- [ ] 5.1. –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è score (counter –æ—Ç 0)
- [ ] 5.2. Haptic feedback –ø—Ä–∏ score < 50
- [ ] 5.3. –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
- [ ] 5.4. –¢–µ—Å—Ç—ã edge cases (–ø—É—Å—Ç–æ–π –ø—Ä–∏—ë–º ‚Üí –±–µ–∑ score, —Ç–æ–ª—å–∫–æ —Å–ª–∞–¥–∫–æ–µ, –∏ —Ç.–¥.)

---

## üîß –ö–æ–¥-—Å–Ω–∏–ø–ø–µ—Ç—ã

### getMealQualityScore (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)

```javascript
/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (0-100)
 * @param {Object} meal - –ü—Ä–∏—ë–º –ø–∏—â–∏ —Å items
 * @param {string} mealType - –¢–∏–ø –ø—Ä–∏—ë–º–∞ ('breakfast', 'lunch', etc.)
 * @param {number} optimum - –î–Ω–µ–≤–Ω–∞—è –Ω–æ—Ä–º–∞ –∫–∞–ª–æ—Ä–∏–π
 * @param {Object} pIndex - –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤
 * @returns {{ score: number, color: string, badges: Array }}
 */
function getMealQualityScore(meal, mealType, optimum, pIndex) {
  // –ü—É—Å—Ç–æ–π –ø—Ä–∏—ë–º ‚Äî –±–µ–∑ –æ—Ü–µ–Ω–∫–∏
  if (!meal.items || meal.items.length === 0) return null;
  
  // === –í—ã—á–∏—Å–ª—è–µ–º totals —Å gi –∏ harm (–ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ MealCard —Å—Ç—Ä–æ–∫–∞ 292) ===
  const totals = M.mealTotals ? M.mealTotals(meal, pIndex) : 
    { kcal:0, carbs:0, simple:0, complex:0, prot:0, fat:0, bad:0, good:0, trans:0, fiber:0 };
  
  // gi –∏ harm –≤—ã—á–∏—Å–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ (–≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ)
  let gSum = 0, giSum = 0, harmSum = 0;
  (meal.items || []).forEach(it => {
    const p = getProductFromItem(it, pIndex);
    if (!p) return;
    const g = +it.grams || 0;
    if (!g) return;
    const gi = p.gi ?? p.gi100 ?? p.GI ?? p.giIndex ?? 50; // fallback 50
    const harm = p.harm ?? p.harmScore ?? p.harm100 ?? p.harmPct ?? 0; // fallback 0
    gSum += g;
    giSum += gi * g;
    harmSum += harm * g;
  });
  const avgGI = gSum ? giSum / gSum : 50;
  const avgHarm = gSum ? harmSum / gSum : 0;
  
  const { kcal, prot, carbs, simple, complex, fat, bad, good, trans } = totals;
  
  let score = 0;
  const badges = [];
  
  // 1. –ö–∞–ª–æ—Ä–∏–∏ (30 –±–∞–ª–ª–æ–≤)
  const kcalScore = calcKcalScore(kcal, mealType, optimum, meal.time);
  score += kcalScore.points;
  if (!kcalScore.ok) badges.push({ type: '–ö', ok: false });
  
  // 2. –ë–ñ–£ –±–∞–ª–∞–Ω—Å (25 –±–∞–ª–ª–æ–≤)
  const macroScore = calcMacroScore(prot, carbs, fat, kcal, mealType);
  score += macroScore.points;
  if (!macroScore.proteinOk) badges.push({ type: '–ë', ok: false });
  
  // 3. –ö–∞—á–µ—Å—Ç–≤–æ —É–≥–ª–µ–≤–æ–¥–æ–≤ (15 –±–∞–ª–ª–æ–≤)
  const carbScore = calcCarbQuality(simple, complex);
  score += carbScore.points;
  // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂ ‚Äî —Å–ª–æ–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –∫—Ä–∞—Ç–∫–æ
  
  // 4. –ö–∞—á–µ—Å—Ç–≤–æ –∂–∏—Ä–æ–≤ (15 –±–∞–ª–ª–æ–≤)
  const fatScore = calcFatQuality(bad, good, trans);
  score += fatScore.points;
  if (trans > 0.5) badges.push({ type: '–¢–ñ', ok: false }); // > 0.5g —Ç—Ä–∞–Ω—Å-–∂–∏—Ä–æ–≤
  
  // 5. –ì–ò –∏ –≤—Ä–µ–¥–Ω–æ—Å—Ç—å (15 –±–∞–ª–ª–æ–≤)
  const giHarmScore = calcGiHarmScore(avgGI, avgHarm);
  score += giHarmScore.points;
  if (avgGI > 70) badges.push({ type: '–ì–ò', ok: false });
  if (avgHarm > 10) badges.push({ type: '–í—Ä', ok: false });
  
  // –¶–≤–µ—Ç (–∫–∞–∫ –≤ ratioZones)
  const color = score >= 80 ? '#22c55e' : score >= 50 ? '#eab308' : '#ef4444';
  
  // –î–µ—Ç–∞–ª–∏ –¥–ª—è popup
  const details = [
    { label: '–ö–∞–ª–æ—Ä–∏–∏', value: Math.round(kcal) + ' –∫–∫–∞–ª', ok: kcalScore.ok },
    { label: '–ë–µ–ª–æ–∫', value: Math.round(prot) + '–≥', ok: macroScore.proteinOk },
    { label: '–£–≥–ª–µ–≤–æ–¥—ã', value: carbScore.simpleRatio <= 0.3 ? '—Å–ª–æ–∂–Ω—ã–µ ‚úì' : Math.round(carbScore.simpleRatio * 100) + '% –ø—Ä–æ—Å—Ç—ã—Ö', ok: carbScore.ok },
    { label: '–ñ–∏—Ä—ã', value: fatScore.goodRatio >= 0.6 ? '–ø–æ–ª–µ–∑–Ω—ã–µ ‚úì' : Math.round(fatScore.goodRatio * 100) + '% –ø–æ–ª–µ–∑–Ω—ã—Ö', ok: fatScore.ok },
    { label: '–ì–ò', value: Math.round(avgGI), ok: avgGI <= 70 }
  ];
  
  // Haptic –ø—Ä–∏ –Ω–∏–∑–∫–æ–º score
  if (score < 50 && window.HEYS?.haptic) HEYS.haptic('warning');
  
  return { 
    score: Math.round(score), 
    color, 
    badges: badges.slice(0, 3), // max 3 –±–µ–π–¥–∂–∞
    details // –¥–ª—è popup
  };
}
```

### –†–µ–Ω–¥–µ—Ä –±–µ–π–¥–∂–µ–π (–¢–û–õ–¨–ö–û –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ)

```javascript
// –ë–µ–π–¥–∂–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ (ok: false)
quality && quality.badges.length > 0 && React.createElement('div', { 
  style: { display: 'flex', gap: '2px', marginLeft: '4px' }
},
  quality.badges
    .filter(b => !b.ok) // —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ!
    .slice(0, 3)
    .map((b, i) => 
      React.createElement('span', {
        key: i,
        style: {
          fontSize: '9px',
          padding: '1px 3px',
          borderRadius: '3px',
          background: '#fee2e2',
          color: '#991b1b',
          fontWeight: '600'
        }
      }, '!' + b.type)
    )
)
```

### StepModal —Å –¥–µ—Ç–∞–ª—è–º–∏ –∫–∞—á–µ—Å—Ç–≤–∞

```javascript
// –í—ã–∑–æ–≤: –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ø–æ–ª–æ—Å–∫—É –ø—Ä–∏—ë–º–∞
function showMealQualityDetails(meal, quality, mealTypeInfo) {
  const { score, badges, details } = quality;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —à–∞–≥–∏ –¥–ª—è StepModal
  const steps = [
    {
      title: `${mealTypeInfo.icon} ${mealTypeInfo.name} ‚Äî ${score} –±–∞–ª–ª–æ–≤`,
      content: React.createElement('div', { style: { padding: '16px' } },
        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä score
        React.createElement('div', { 
          style: { 
            height: '8px', 
            background: '#e5e7eb', 
            borderRadius: '4px', 
            overflow: 'hidden',
            marginBottom: '16px'
          }
        },
          React.createElement('div', { 
            style: { 
              width: score + '%', 
              height: '100%', 
              background: quality.color,
              transition: 'width 0.5s ease'
            }
          })
        ),
        // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
          details.map((d, i) => 
            React.createElement('div', { 
              key: i,
              style: { 
                display: 'flex', 
                alignItems: 'center', 
                gap: '8px',
                padding: '8px 12px',
                background: d.ok ? '#dcfce7' : '#fee2e2',
                borderRadius: '8px'
              }
            },
              React.createElement('span', null, d.ok ? '‚úì' : '‚ö†Ô∏è'),
              React.createElement('span', { style: { flex: 1 } }, d.label),
              React.createElement('span', { 
                style: { fontWeight: '600', color: d.ok ? '#166534' : '#991b1b' }
              }, d.value)
            )
          )
        )
      )
    }
  ];
  
  HEYS.StepModal.show({
    steps,
    onClose: () => {},
    showDots: false // –û–¥–∏–Ω —à–∞–≥ ‚Äî —Ç–æ—á–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã
  });
}

// –ü—Ä–∏–º–µ—Ä details –≤ quality:
// details: [
//   { label: '–ö–∞–ª–æ—Ä–∏–∏', value: '387 –∫–∫–∞–ª', ok: true },
//   { label: '–ë–µ–ª–æ–∫', value: '25–≥', ok: true },
//   { label: '–£–≥–ª–µ–≤–æ–¥—ã', value: '80% —Å–ª–æ–∂–Ω—ã–µ', ok: true },
//   { label: '–ñ–∏—Ä—ã', value: '60% –ø–æ–ª–µ–∑–Ω—ã–µ', ok: true },
//   { label: '–ì–ò', value: '72', ok: false }
// ]
```

### Streak –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤

```javascript
// –í mealsChartData useMemo –¥–æ–±–∞–≤–∏—Ç—å:
const qualityStreak = (() => {
  let streak = 0;
  for (const m of data) {
    if (m.quality && m.quality.score >= 80) {
      streak++;
    } else {
      break; // Streak –ø—Ä–µ—Ä–≤–∞–Ω
    }
  }
  return streak;
})();

// –†–µ–Ω–¥–µ—Ä (–µ—Å–ª–∏ streak >= 3):
qualityStreak >= 3 && React.createElement('div', {
  style: {
    display: 'flex',
    alignItems: 'center',
    gap: '6px',
    padding: '8px 12px',
    background: 'linear-gradient(90deg, #fef3c7 0%, #fde68a 100%)',
    borderRadius: '8px',
    marginTop: '8px'
  }
},
  React.createElement('span', null, 'üî•'),
  React.createElement('span', { style: { fontWeight: '600', color: '#92400e' } },
    qualityStreak + ' –æ—Ç–ª–∏—á–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–æ–¥—Ä—è–¥!'
  )
)
```

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –æ—Ü–µ–Ω–æ–∫

| –ü—Ä–∏—ë–º | –°–æ—Å—Ç–∞–≤ | Score | –ü–æ—á–µ–º—É |
|-------|--------|-------|--------|
| –ó–∞–≤—Ç—Ä–∞–∫ 08:00: –û–≤—Å—è–Ω–∫–∞ + —è–π—Ü–∞ + –±–∞–Ω–∞–Ω | 400 –∫–∫–∞–ª, –ë:25, –£:50 (—Å–ª–æ–∂–Ω—ã–µ), –ñ:15 | 92 | –ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è |
| –ü–µ—Ä–µ–∫—É—Å 16:00: 3 —à–æ–∫–æ–ª–∞–¥–∫–∏ | 450 –∫–∫–∞–ª, –ë:5, –£:60 (–ø—Ä–æ—Å—Ç—ã–µ), –ñ:20 | 25 | –ü–µ—Ä–µ–±–æ—Ä –∫–∫–∞–ª –¥–ª—è –ø–µ—Ä–µ–∫—É—Å–∞, —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–µ —É–≥–ª–µ–≤–æ–¥—ã, –≤—ã—Å–æ–∫–∏–π –ì–ò |
| –£–∂–∏–Ω 21:30: –°—Ç–µ–π–∫ + —Å–∞–ª–∞—Ç | 500 –∫–∫–∞–ª, –ë:45, –£:10, –ñ:30 | 70 | –•–æ—Ä–æ—à–∏–π –±–µ–ª–æ–∫, –Ω–æ –ø–æ–∑–¥–Ω–æ |

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ö–∞–∂–¥—ã–π –ø—Ä–∏—ë–º –∏–º–µ–µ—Ç score 0-100
- [ ] –¶–≤–µ—Ç –ø–æ–ª–æ—Å–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç score
- [ ] –ë–µ–π–¥–∂–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¢–û–õ–¨–ö–û –ø—Ä–æ–±–ª–µ–º—ã (max 3)
- [ ] –ü—É—Å—Ç–æ–π –ø—Ä–∏—ë–º ‚Äî –±–µ–∑ score
- [ ] –ü–æ –∫–ª–∏–∫—É –Ω–∞ –ø–æ–ª–æ—Å–∫—É ‚Üí StepModal —Å –¥–µ—Ç–∞–ª—è–º–∏
- [ ] Streak ‚â• 3 ‚Üí –ø–æ–∫–∞–∑ "üî• N –æ—Ç–ª–∏—á–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤ –ø–æ–¥—Ä—è–¥!"
- [ ] –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Ç–∏–ø–∞—Ö –ø—Ä–∏—ë–º–æ–≤
- [ ] –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
- [ ] Haptic –ø—Ä–∏ score < 50 –∏ –ø—Ä–∏ streak

---

## ‚ö†Ô∏è –†–∏—Å–∫-–º–∞—Ç—Ä–∏—Ü–∞

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ò–º–ø–∞–∫—Ç | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|--------|-----------|
| gi/harm undefined | –í—ã—Å–æ–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | Fallback: gi=50, harm=0 |
| mealsChartData –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∏–π | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ useMemo |
| Performance –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–∏–π | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ mealTotals |
| –ë–µ–π–¥–∂–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—é—Ç UI | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–∏–π | –¢–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ, max 3 |

---

## üü¢ WOW-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **Counter animation**: Score –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –æ—Ç 0 ‚Üí N
   ```css
   .score-value { transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
   ```

2. **–ú–∏–Ω–∏-–ø—Ä–æ–≥—Ä–µ—Å—Å –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞**: 5 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ 20 –±–∞–ª–ª–æ–≤
   ```
   [‚óè‚óè‚óè‚óè‚óã] 80+ | [‚óè‚óè‚óè‚óã‚óã] 60-79 | [‚óè‚óè‚óã‚óã‚óã] 40-59
   ```

3. **Confetti –¥–ª—è –∏–¥–µ–∞–ª–∞**: Score ‚â• 95 ‚Üí –º–∏–∫—Ä–æ-–∫–æ–Ω—Ñ–µ—Ç—Ç–∏ üéâ

4. **Streak milestone**: –ü—Ä–∏ streak = 5 ‚Üí –æ—Å–æ–±—ã–π –±–µ–π–¥–∂ "–ú–∞—Å—Ç–µ—Ä –ø–∏—Ç–∞–Ω–∏—è üèÜ"

---

## üîô Rollback –ø–ª–∞–Ω

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫:
1. `cp apps/web/heys_day_v12.backup3.js apps/web/heys_day_v12.js`
2. `pnpm dev` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å localhost:3001
3. –ï—Å–ª–∏ backup –Ω–µ —Å–æ–∑–¥–∞–Ω: `git checkout apps/web/heys_day_v12.js`

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ê–ª–≥–æ—Ä–∏—Ç–º –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ `heys_norms` –≤ –±—É–¥—É—â–µ–º
- Score –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤ `mealsChartData`, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
- –ü–æ –∫–ª–∏–∫—É –Ω–∞ –ø—Ä–∏—ë–º ‚Äî –º–æ–¥–∞–ª–∫–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–ü–∞—Ç—Ç–µ—Ä–Ω gi/harm –≤–∑—è—Ç –∏–∑ MealCard (—Å—Ç—Ä–æ–∫–∞ 292)**
