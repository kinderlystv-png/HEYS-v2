# üçû Toast Improvements v2 ‚Äî –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

> **–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —É–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º —Å–æ–≤–µ—Ç–æ–≤.

**‚è≥ –°—Ç–∞—Ç—É—Å**: –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è —Å–æ–≤–µ—Ç–æ–≤  
**‚¨ÖÔ∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç**: [2025-11-29-advice-module.md](./2025-11-29-advice-module.md)

---

## üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∞—É–¥–∏—Ç–∞ advice-module.md

> –≠—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—ã—è–≤–ª–µ–Ω—ã –ø—Ä–∏ –≥–ª—É–±–æ–∫–æ–º –∞—É–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç–∞ –º–æ–¥—É–ª—è —Å–æ–≤–µ—Ç–æ–≤ (2025-11-29)

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—É—á—Ç–µ–Ω—ã –≤ advice-module.md)

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ currentStreak** ‚Äî –ú–æ–¥—É–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å streak, –∞ –ø–æ–ª—É—á–∞—Ç—å –µ–≥–æ –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ DayTab (—Å—Ç—Ä–æ–∫–∞ 1636)

2. **Swipe handlers –Ω–∞ toast** ‚Äî –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã toast –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:
   - `onTouchStart: handleToastTouchStart`
   - `onTouchMove: handleToastTouchMove`
   - `onTouchEnd: handleToastTouchEnd`
   - `style: { transform: translateX(calc(-50% + ${toastSwipeX}px)), opacity: 1 - Math.abs(toastSwipeX) / 150 }`

3. **CSS –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî `.macro-toast-fiber`, `.macro-toast-tip`, `.macro-toast-achievement` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–µ—Ä–≤–æ–º –ø—Ä–æ–º–ø—Ç–µ (—Å—Ç—Ä–æ–∫–∏ 4931-4948). –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ!

4. **–ú–µ—Å—Ç–æ dispatch event** ‚Äî `heysProductAdded` –Ω—É–∂–Ω–æ dispatch –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `addProductToMeal` (—Å—Ç—Ä–æ–∫–∞ 1587), –ù–ï –≤ MealAddProduct

### üü° –í–∞–∂–Ω—ã–µ

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ DayTab**:
   - ‚úÖ `date` (—Å—Ç—Ä–æ–∫–∞ 142) ‚Äî –ù–ï `curDate`
   - ‚úÖ `toastTimeoutRef` (—Å—Ç—Ä–æ–∫–∞ 707) ‚Äî –ù–ï `toastTimerRef`
   - ‚úÖ `showConfetti` (—Å—Ç—Ä–æ–∫–∞ 770)
   - ‚úÖ `haptic` (—Å—Ç—Ä–æ–∫–∞ 17)

2. **–í—Å–µ picker states** (–¥–ª—è uiState –≤ advice module):
   - showTimePicker (681), showGramsPicker (778), showWeightPicker (803)
   - showDeficitPicker (904), showZonePicker (786), showSleepQualityPicker (793)
   - showDayScorePicker (798), showHouseholdPicker (1081), showTrainingPicker (687)

### üü¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **`returning` emotional state** ‚Äî –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å localStorage –∫–ª—é—á `heys_last_visit` –∏ –≤—ã—á–∏—Å–ª—è—Ç—å `lastVisitDaysAgo`

2. **–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã (specialDay)** ‚Äî –ü–æ–∫–∞ –æ–≤–µ—Ä–∫–∏–ª–ª –¥–ª—è MVP, –Ω–æ –∫–æ–¥ —É–∂–µ –≥–æ—Ç–æ–≤ –≤ –º–æ–¥—É–ª–µ

---

## üìã –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `apps/web/heys_day_v12.js` | `macroTip` useMemo (—Å—Ç—Ä–æ–∫–∏ ~2708-2880) |
| `apps/web/styles/main.css` | Toast —Å—Ç–∏–ª–∏ |

---

## üéØ –ó–∞–¥–∞—á–∏

### –ó–∞–¥–∞—á–∞ 1: –°–µ–∑–æ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–£—Å–ª–æ–≤–∏–µ**: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é –≤ –∑–∏–º–Ω–∏–µ –º–µ—Å—è—Ü—ã

```javascript
// –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ hasTraining, –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–æ–¥—ã
const month = new Date().getMonth();
// –ó–∏–º–∞: –Ω–æ—è–±—Ä—å (10), –¥–µ–∫–∞–±—Ä—å (11), —è–Ω–≤–∞—Ä—å (0), —Ñ–µ–≤—Ä–∞–ª—å (1), –º–∞—Ä—Ç (2)
if ((month >= 10 || month <= 2) && !sessionStorage.getItem('heys_winter_tip')) {
  sessionStorage.setItem('heys_winter_tip', '1');
  return { icon: '‚ùÑÔ∏è', text: '–ó–∏–º–æ–π –≤–∞–∂–µ–Ω –≤–∏—Ç–∞–º–∏–Ω D ‚Äî —Ä—ã–±–∞, —è–π—Ü–∞, –≥—Ä–∏–±—ã', type: 'tip' };
}
```

**–ú–µ—Å—Ç–æ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ**: –ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –ø–µ—Ä–µ–¥ –≤–æ–¥–æ–π (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é)

---

### –ó–∞–¥–∞—á–∞ 2: –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ä–∞—Ü–∏–æ–Ω–∞

**–£—Å–ª–æ–≤–∏–µ**: –ï—Å–ª–∏ –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è >3 —Ä–∞–∑, –∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ <3

```javascript
// –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–≤–æ—â–µ–π/—Ñ—Ä—É–∫—Ç–æ–≤
const allItems = (day.meals || []).flatMap(m => m.items || []);
const productNames = allItems.map(it => {
  const product = M.getProductFromItem ? M.getProductFromItem(it, pIndex) : pIndex.get(it.product_id);
  return (product?.name || it.name || '').toLowerCase().trim();
}).filter(Boolean);

const uniqueProducts = new Set(productNames).size;
if (productNames.length >= 5 && uniqueProducts < 3) {
  return { icon: 'üåà', text: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Ä–∞—Ü–∏–æ–Ω ‚Äî –¥–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã', type: 'tip' };
}
```

**–ú–µ—Å—Ç–æ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ**: –ü–æ—Å–ª–µ –æ–≤–æ—â–µ–π/—Ñ—Ä—É–∫—Ç–æ–≤, –ø–µ—Ä–µ–¥ –±–∞–ª–∞–Ω—Å–æ–º –º–∞–∫—Ä–æ—Å–æ–≤

---

### –ó–∞–¥–∞—á–∞ 3: –ü–æ—Å–ª–µ —Å–ª–∞–¥–∫–æ–≥–æ ‚Üí –±–µ–ª–æ–∫

**–£—Å–ª–æ–≤–∏–µ**: –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –ø–∏—â–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç >60% –ø—Ä–æ—Å—Ç—ã—Ö —É–≥–ª–µ–≤–æ–¥–æ–≤

```javascript
// –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –º–∞–∫—Ä–æ—Å–æ–≤, –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≤—Ç—Ä–∞–∫–∞
const lastMeal = (day.meals || []).slice(-1)[0];
if (lastMeal && lastMeal.items?.length > 0) {
  const lastMealTotals = M.mealTotals ? M.mealTotals(lastMeal, pIndex) : {};
  const lastMealSimplePct = (lastMealTotals.simple || 0) / ((lastMealTotals.carbs || 1));
  if (lastMealSimplePct > 0.6 && (lastMealTotals.kcal || 0) > 100) {
    return { icon: 'ü•ú', text: '–ü–æ—Å–ª–µ —Å–ª–∞–¥–∫–æ–≥–æ –¥–æ–±–∞–≤—å –±–µ–ª–æ–∫ ‚Äî –æ—Ä–µ—Ö–∏ –∏–ª–∏ —Ç–≤–æ—Ä–æ–≥', type: 'tip' };
  }
}
```

**–ú–µ—Å—Ç–æ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ**: –ü–æ—Å–ª–µ –±–∞–ª–∞–Ω—Å–∞ –º–∞–∫—Ä–æ—Å–æ–≤, –ø–µ—Ä–µ–¥ –∑–∞–≤—Ç—Ä–∞–∫–æ–º

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º —Å–æ–≤–µ—Ç–æ–≤

> –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `2025-11-29-advice-module.md` –¥–æ–±–∞–≤–∏—Ç—å —Å—é–¥–∞ –∑–∞–¥–∞—á–∏ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

### –ó–∞–¥–∞—á–∞ 4: TODO ‚Äî –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AdviceEngine

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥—É–ª—è —Å–æ–≤–µ—Ç–æ–≤, –∑–∞–º–µ–Ω–∏—Ç—å inline –ª–æ–≥–∏–∫—É –≤ `macroTip` –Ω–∞ –≤—ã–∑–æ–≤:

```javascript
// –í–º–µ—Å—Ç–æ 170 —Å—Ç—Ä–æ–∫ —É—Å–ª–æ–≤–∏–π:
const macroTip = React.useMemo(() => {
  return HEYS.advice.getTopAdvice(dayContext);
}, [dayContext]);
```

### –ó–∞–¥–∞—á–∞ 5: TODO ‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–≤–µ—Ç–æ–≤

–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
- nutrition (–ë–ñ–£, –∫–∞–ª–æ—Ä–∏–∏)
- lifestyle (—Å–æ–Ω, –≤–æ–¥–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
- achievement (streak, milestones)

### –ó–∞–¥–∞—á–∞ 6: TODO ‚Äî –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤

–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–æ–≤–µ—Ç –¥–≤–∞–∂–¥—ã –∑–∞ –¥–µ–Ω—å (–∫—Ä–æ–º–µ critical warnings).

---

## ‚úÖ Definition of Done

- [ ] –°–µ–∑–æ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∑–∏–º–∞ ‚Üí –≤–∏—Ç–∞–º–∏–Ω D)
- [ ] –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ä–∞—Ü–∏–æ–Ω–∞
- [ ] –ü–æ—Å–ª–µ —Å–ª–∞–¥–∫–æ–≥–æ ‚Üí –±–µ–ª–æ–∫
- [ ] (–ü–æ—Å–ª–µ advice-module) –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AdviceEngine
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö toast'–∞—Ö
- [ ] `pnpm type-check && pnpm build` –ø—Ä–æ—Ö–æ–¥—è—Ç

---

**–í—Ä–µ–º—è**: ~20 –º–∏–Ω—É—Ç (–ø—Ä–æ—Å—Ç—ã–µ —É—Å–ª–æ–≤–∏—è) + –≤—Ä–µ–º—è –Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è advice-module.md
