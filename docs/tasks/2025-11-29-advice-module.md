# ๐ง HEYS Advice Module โ ะกะธััะตะผะฐ ัะผะฝัั ัะพะฒะตัะพะฒ

> **ะฆะตะปั**: ะกะพะทะดะฐัั ะผะพะดัะปัะฝัั ัะธััะตะผั ัะพะฒะตัะพะฒ, ะบะพัะพัะฐั ััะธััะฒะฐะตั ะะกะ ะฐะฝะฐะปะธัะธัะตัะบะธะต ะดะฐะฝะฝัะต ะธ ะผะพะถะตั ะฟะพะบะฐะทัะฒะฐัั ะฝะตัะบะพะปัะบะพ ัะตะบะพะผะตะฝะดะฐัะธะน.

## โ๏ธ ะะะะขะะงะะกะะะ ะะะะะฃะกะะะะะ

**ะกะะะงะะะ** ะฒัะฟะพะปะฝะธัั [2025-11-28-smart-toast-recommendations.md](./2025-11-28-smart-toast-recommendations.md):
- ะัะฟัะฐะฒะธัั ะฑะฐะณ `dayTot.protein` โ `dayTot.prot` (ัััะพะบะฐ 2654 ะฒ heys_day_v12.js)
- ะัะฟัะฐะฒะธัั ะฑะฐะณ `normAbs.protein` โ `normAbs.prot`
- ะะพะฑะฐะฒะธัั CSS ะดะปั ะฝะพะฒัั ัะธะฟะพะฒ toast

**ะัะพะฒะตัะบะฐ**: ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะฟะตัะฒะพะณะพ ะฟัะพะผะฟัะฐ ัะฑะตะดะธัั ััะพ ะฒ `heys_day_v12.js`:
```javascript
const proteinPct = (dayTot.prot || 0) / (normAbs.prot || 1);  // ะะ protein!
```

### ๐ด ะะกะะ ะฟะตัะฒัะน ะฟัะพะผะฟั ะะ ะฒัะฟะพะปะฝะตะฝ:
ะะตัะตะด ะฝะฐัะฐะปะพะผ ัะฐะฑะพัั ะธัะฟัะฐะฒั ะฑะฐะณ ะฒัััะฝัั:
```javascript
// ะกััะพะบะฐ 2654 โ ะะซะะ:
const proteinPct = (dayTot.protein || 0) / (normAbs.protein || 1);

// ะกะขะะะ:
const proteinPct = (dayTot.prot || 0) / (normAbs.prot || 1);

// ะกััะพะบะฐ 2698 โ ะะซะะ (ะฒ dependencies):
}, [dayTot.protein, dayTot.fat, ... normAbs.protein, normAbs.fat, ...]);

// ะกะขะะะ:
}, [dayTot.prot, dayTot.fat, ... normAbs.prot, normAbs.fat, ...]);
```

---

## ๐ ะะะะฃะะฌะขะะขะซ ะะฃะะะขะ (2025-11-29)

### ๐ด ะัะธัะธัะตัะบะธะต ะธัะฟัะฐะฒะปะตะฝะธั (ัะถะต ะฒะฝะตัะตะฝั ะฒ ะฟัะพะผะฟั)

| ะัะพะฑะปะตะผะฐ | ะัะปะพ | ะกัะฐะปะพ |
|----------|------|-------|
| ะะตะฒะตัะฝะพะต ะธะผั ref | `toastTimerRef` | `toastTimeoutRef` (ัััะพะบะฐ 707) |
| ะะตะฒะตัะฝะพะต ะธะผั ะฟะตัะตะผะตะฝะฝะพะน ะดะฐัั | `curDate` | `date` (ัััะพะบะฐ 131) |
| ะะตั ะฟัะพะฒะตัะบะธ ัะธะฟะฐ haptic | `haptic && haptic()` | `typeof haptic === 'function' && haptic()` |
| ะะตั `handleProductAdded` | ะัะป ะบะฐะบ ััะฝะบัะธั | ะัะฟะพะปัะทะพะฒะฐัั CustomEvent |

### ๐ก ะะฐะถะฝัะต ะพะณัะฐะฝะธัะตะฝะธั

1. **`activeDays` ัะพะดะตัะถะธั ะดะฐะฝะฝัะต ัะพะปัะบะพ ะทะฐ ัะตะบััะธะน ะผะตััั** โ streak ะผะพะถะตั ะฑััั ะฝะตัะพัะฝัะผ ะฝะฐ ะณัะฐะฝะธัะต ะผะตัััะตะฒ. ะะปั ัะพัะฝะพะณะพ streak ะฝัะถะฝะพ ัะธัะฐัั localStorage ะฝะฐะฟััะผัั ั ะบะปััะพะผ `heys_dayv2_` + dateStr

2. **ะัะพะดัะบัั ะดะพะฑะฐะฒะปััััั ัะตัะตะท MealAddProduct ะบะพะผะฟะพะฝะตะฝั** โ ะฝัะถะฝะพ ะดะพะฑะฐะฒะธัั dispatch CustomEvent `heysProductAdded` ะฟัะธ ััะฟะตัะฝะพะผ ะดะพะฑะฐะฒะปะตะฝะธะธ

3. **ะกััะตััะฒัััะธะต pickers (ะฒัะต ะฝะฐะนะดะตะฝั ะธ ะฟัะพะฒะตัะตะฝั)**:
   - `showTimePicker` โ (ัััะพะบะฐ 681)
   - `showGramsPicker` โ (ัััะพะบะฐ 761)
   - `showWeightPicker` โ (ัััะพะบะฐ 786)
   - `showDeficitPicker` โ (ัััะพะบะฐ 887)
   - `showZonePicker` โ (ัััะพะบะฐ 769)
   - `showSleepQualityPicker` โ (ัััะพะบะฐ 776)
   - `showDayScorePicker` โ (ัััะพะบะฐ 781)
   - `showHouseholdPicker` โ (ัััะพะบะฐ 1064)
   - `showTrainingPicker` โ (ัััะพะบะฐ 687)

### ๐ข ะัะพะฒะตัะตะฝะพ ะธ ะะ

- โ `dayTot.prot` โ ะฟัะฐะฒะธะปัะฝัะน ะบะปัั (M.mealTotals ะฒะพะทะฒัะฐัะฐะตั `prot`)
- โ `normAbs.prot` โ ะฟัะฐะฒะธะปัะฝัะน ะบะปัั
- โ `activeDays` Map ะดะพัััะฟะตะฝ (ัััะพะบะฐ 1612)
- โ `pIndex` ะดะพัััะฟะตะฝ
- โ `optimum` ะดะพัััะฟะตะฝ
- โ Toast ัะตะฝะดะตัะธััั (ัััะพะบะฐ 3744)
- โ `toastTimeoutRef` ัััะตััะฒัะตั (ัััะพะบะฐ 707)
- โ `showConfetti` ัััะตััะฒัะตั (ัััะพะบะฐ 753) โ ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะดะปั achievements

---

๐ **[DATA_MODEL_REFERENCE.md](../DATA_MODEL_REFERENCE.md)** โ ัะฟัะฐะฒะพัะฝะธะบ ะฒัะตั ะฐะฝะฐะปะธัะธัะตัะบะธั ะฟะฐัะฐะผะตััะพะฒ (dayTot, normAbs, Product, Meal, Training ะธ ะดั.)

---

## ๐ ะะะะฃะะฌะขะะขะซ ะะฃะะะขะ (2025-11-29)

### ๐ด ะัะธัะธัะตัะบะธะต ะธัะฟัะฐะฒะปะตะฝะธั (ัะถะต ะฒะฝะตัะตะฝั ะฒ ะฟัะพะผะฟั)

1. **`toastTimerRef` โ `toastTimeoutRef`** โ ะฒ ัะตะฐะปัะฝะพะผ ะบะพะดะต ref ะฝะฐะทัะฒะฐะตััั `toastTimeoutRef` (ัััะพะบะฐ 707)
2. **`curDate` โ `date`** โ ะฒ DayTab ะฟะตัะตะผะตะฝะฝะฐั ะฝะฐะทัะฒะฐะตััั `date` (ัััะพะบะฐ 144)
3. **Confetti** โ `showConfetti` ัััะตััะฒัะตั (ัััะพะบะฐ 753), ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะดะปั achievements
5. **ะะพะฑะฐะฒะปะตะฝ fallback** ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะฑะฐะณะฐ prot/protein ะตัะปะธ ะฟะตัะฒัะน ะฟัะพะผะฟั ะฝะต ะฒัะฟะพะปะฝะตะฝ

### ๐ก ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั (ััะตััั ะฟัะธ ัะตะฐะปะธะทะฐัะธะธ)

1. **`activeDays` ัะพะดะตัะถะธั ัะพะปัะบะพ ัะตะบััะธะน ะผะตััั!** โ streak ะผะพะถะตั ัะปะพะผะฐัััั ะฝะฐ ะณัะฐะฝะธัะต ะผะตัััะฐ. ะ ะผะพะดัะปะต ะธัะฟะพะปัะทัะตััั inline `formatDate` + ะฟััะผะพะน ะพะฑัะพะด ั ะปะธะผะธัะพะผ 30 ะดะฝะตะน โ ััะพ ะะ ะดะปั ะฟัะฐะบัะธัะตัะบะธั ัะตะปะตะน.

2. **`returning` ัะผะพัะธะพะฝะฐะปัะฝะพะต ัะพััะพัะฝะธะต** โ `lastVisitDaysAgo` ะฟะตัะตะดะฐัััั ะบะฐะบ `0` ะธ ะฝะต ะฒััะธัะปัะตััั. TODO: ะดะพะฑะฐะฒะธัั ะฒ ะฑัะดััะตะผ ัะตัะตะท `localStorage` ะบะปัั `heys_last_visit`.

3. **CSS ัะธะฟั `emotional` ะธ `motivation`** โ ะบะฐัะตะณะพัะธะธ ะตััั, ะฝะพ CSS ะดะปั ะฝะธั ะฝะต ัะบะฐะทะฐะฝ. ะกะพะฒะตัั ััะธั ะบะฐัะตะณะพัะธะน ะธัะฟะพะปัะทััั `type: 'achievement'` ะธะปะธ `type: 'tip'`, ัะฐะบ ััะพ CSS ะธะผ ะฝะต ะฝัะถะตะฝ ะพัะดะตะปัะฝัะน.

4. **`success` vs `achievement`** โ ะฒ ัััะตััะฒัััะตะผ CSS ะตััั `.macro-toast-success` (ัััะพะบะฐ 4925). ะ ะผะพะดัะปะต `type: 'success'` ะธัะฟะพะปัะทัะตััั ะดะปั "ะัะต ะผะฐะบัะพัั ะฒ ะฑะฐะปะฐะฝัะต", `type: 'achievement'` ะดะปั streak. ะะฑะฐ ัะฐะฑะพัะฐัั.

5. **Guard ะดะปั ะฟัััะพะณะพ ะดะฝั** โ ะดะพะฑะฐะฒะธัั ะฒ `evaluateRules`:
   ```javascript
   if (dayTot.kcal < 10 && mealCount === 0) return []; // ะัััะพะน ะดะตะฝั โ ะฝะต ะฟะพะบะฐะทัะฒะฐัั
   ```

### โ ะัะพะฒะตัะตะฝะพ ะธ ะะ

- โ `haptic` ะดะพัััะฟะตะฝ ะฒ ัะบะพัะฟะต DayTab (ัััะพะบะฐ 15)
- โ `prot` ะฒะผะตััะพ `protein` ะฒ ะผะพะดัะปะต ัะพะฒะตัะพะฒ โ ะะะะะะะฌะะ
- โ `toastVisible`, `toastDismissed`, `toastTimeoutRef` ัััะตััะฒััั (ัััะพะบะธ 705-707)
- โ CSS ะฐะฝะธะผะฐัะธะธ ะฐะดะตะบะฒะฐัะฝัะต
- โ `activeDays` Map ะดะพัััะฟะตะฝ ะฒ DayTab (ัััะพะบะฐ 1612)

---

## โ๏ธ ะะะะขะะงะะกะะะ ะะะะะงะะะะฏ ะะะฏ ะะะะะะะะฆะะ

### Z-index ะธ ะฟะพะทะธัะธะพะฝะธัะพะฒะฐะฝะธะต
- **ะขะตะบััะธะน toast**: `z-index: 1000`, `bottom: 80px`
- **ะะพะดะฐะปะบะธ** (time-picker, deficit-picker): ะฟะตัะตะบััะฒะฐัั ะฒัั
- **ะะตัะตะฝะธะต**: ะะ ะดะตะปะฐัั ะฟะฐะฝะตะปั fixed. ะกะดะตะปะฐัั expandable toast โ ะบะปะธะบ ะฝะฐ toast ัะฐัะบััะฒะฐะตั ะพััะฐะปัะฝัะต ัะพะฒะตัั ะะะฃะขะะ ัะพะณะพ ะถะต ะบะพะฝัะตะนะฝะตัะฐ

### Side effects ะฒ useMemo โ ะะะะะะฉะะะ!
```javascript
// โ ะะะะฌะะฏ (ะฒ ะฟัะพะผะฟัะต ะฑัะปะพ ะฝะตะฟัะฐะฒะธะปัะฝะพ):
onShow: () => sessionStorage.setItem('heys_streak7', '1')

// โ ะะะะะะะฌะะ โ ะฒัะทัะฒะฐัั onShow ะฒ useEffect ะฟัะธ ะฟะพะบะฐะทะต:
useEffect(() => {
  if (primary?.onShow) primary.onShow();
}, [primary?.id]);
```

### ะะพััะดะพะบ ะทะฐะณััะทะบะธ ัะบัะธะฟัะพะฒ
ะ `index.html` ะดะพะฑะฐะฒะธัั ะะะะะ `heys_day_v12.js` (ะฝะฐะนัะธ ัััะพะบั ั `heys_day_v12.js` ะธ ะดะพะฑะฐะฒะธัั ะะะะะ ะฝะตะน):
```html
<script defer src="heys_advice_v1.js?v=1" fetchpriority="low"></script>
```

### Defensive programming
```javascript
// ะัะตะณะดะฐ ะฟัะพะฒะตััะน ะฝะฐ undefined:
const advices = allAdvices || [];
const meals = day?.meals || [];
```

### fmtDate fallback
```javascript
// Inline ััะฝะบัะธั ะฒะผะตััะพ ะทะฐะฒะธัะธะผะพััะธ ะพั window.fmtDate:
const formatDate = (d) => {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
};
```

### ๐ง Smart Timing โ ะฃะผะฝะพะต ะฒัะตะผั ะฟะพะบะฐะทะฐ (Deep Psychology Edition)

**ะะปััะตะฒะฐั ะธะดะตั**: ะกะพะฒะตัั ะฟะพะบะฐะทัะฒะฐัััั ัะพะปัะบะพ ะบะพะณะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั **ะณะพัะพะฒ ะธั ะฒะพัะฟัะธะฝััั** ะธ ะบะพะณะดะฐ ะพะฝะธ **ะผะฐะบัะธะผะฐะปัะฝะพ ัะตะปะตะฒะฐะฝัะฝั**.

---

#### ๐ ะฆะธัะบะฐะดะฝัะต ัะธัะผั โ ะฐะดะฐะฟัะฐัะธั ะฟะพะด ะฒัะตะผั ัััะพะบ

| ะัะตะผั | ะกะพััะพัะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั | ะะฐะบะธะต ัะพะฒะตัั | ะขะพะฝ |
|-------|------------------------|--------------|-----|
| 6:00-9:00 | ะัะพััะฟะฐะตััั, ะฝะธะทะบะฐั ัะฝะตัะณะธั | ะัะณะบะฐั ะผะพัะธะฒะฐัะธั | "ะะพะฑัะพะต ัััะพ! ะะฐัะฝะธ ะดะตะฝั ั..." |
| 9:00-12:00 | ะะบัะธะฒะตะฝ, ะฟัะธะฝะธะผะฐะตั ัะตัะตะฝะธั | ะะพะฝะบัะตัะฝัะต ัะตะบะพะผะตะฝะดะฐัะธะธ | ะะตะปะพะฒะพะน, ัััะบะธะน |
| 12:00-14:00 | ะะฑะตะด, ัะฟะตัะธั | ะะฐะบัะธะผัะผ 2-3 ัะปะพะฒะฐ | "ะะพะฑะฐะฒั ะฑะตะปะบะฐ ๐ช" |
| 14:00-17:00 | "ะกะฐัะฐัะฝะฐั ัะผะฐ", ัะฟะฐะด | ะัะตะดัะฟัะตะถะดะตะฝะธั ะพ ัะปะฐะดะบะพะผ | ะะฐะฑะพัะปะธะฒัะน |
| 17:00-20:00 | ะฃััะฐะปะพััั, ะดะพะผะพะน | ะัะพะณะธ ะดะฝั, ััะพ ะดะพะตััั | ะะพะดะดะตัะถะธะฒะฐััะธะน |
| 20:00-23:00 | ะะฐััะปะฐะฑะปะตะฝ, ัะตัะปะตะบัะธั | ะะพัะฒะฐะปะฐ, ะดะพััะธะถะตะฝะธั | ะขัะฟะปัะน, ัะฒะฐะปััะธะน |
| 23:00-6:00 | **ะะ ะะะกะะะะะะขะฌ!** | ะะะะะะะฅ ัะพะฒะตัะพะฒ | โ |

**ะะตะฐะปะธะทะฐัะธั:**
```javascript
function getToneForHour(hour) {
  if (hour >= 23 || hour < 6) return 'silent';
  if (hour < 9) return 'gentle';
  if (hour < 12) return 'business';
  if (hour < 14) return 'brief';
  if (hour < 17) return 'caring';
  if (hour < 20) return 'supportive';
  return 'warm';
}
```

---

#### ๐ ะญะผะพัะธะพะฝะฐะปัะฝัะน ะธะฝัะตะปะปะตะบั โ ะฐะดะฐะฟัะฐัะธั ะฟะพะด ัะพััะพัะฝะธะต

| ะกะพััะพัะฝะธะต | ะะฐะบ ะพะฟัะตะดะตะปะธัั | ะะตะฐะบัะธั ัะธััะตะผั |
|-----------|----------------|-----------------|
| **ะกััะตัั** | mood < 3 ะฒ ะฟะพัะปะตะดะฝะธั ะฟัะธัะผะฐั | ะขะพะปัะบะพ ะฟะพะดะดะตัะถะบะฐ, ะฑะตะท ะบัะธัะธะบะธ |
| **ะกััะฒ** | kcalPct > 1.5 ัะตะทะบะพ | "ะัะฒะฐะตั! ะะฐะฒััะฐ ะฝะพะฒัะน ะดะตะฝั ๐" |
| **ะฃัะฟะตั** | streak >= 3 | ะัะฐะทะดะฝะพะฒะฐัั! Confetti! |
| **ะะพะทะฒัะฐัะตะฝะธะต** | lastVisit > 2 ะดะฝะตะน | "ะะฐะดั ะฒะธะดะตัั! ะัะพะดะพะปะถะธะผ?" |
| **ะะพะฒะธัะพะบ** | totalDays < 3 | Onboarding ัะพะฒะตัั |
| **ะฃะดะฐะปะธะป ะฟัะพะดัะบั** | action === 'delete' | ะะพะปัะธะผ (ะฝะต ะบะพะผะผะตะฝัะธััะตะผ) |

**ะัะฐะฒะธะปะพ**: ะัะปะธ `mood < 3` ะธะปะธ ัะพะปัะบะพ ััะพ ะฑัะป ัััะฒ โ **ะะ ะฟะพะบะฐะทัะฒะฐัั warning**, ัะพะปัะบะพ `achievement` ะธ `tip`.

---

#### ๐ ะะพะฒะตะดะตะฝัะตัะบะธะต ะฟะฐััะตัะฝั โ ะฟะตััะพะฝะฐะปะธะทะฐัะธั

ะกะธััะตะผะฐ ะทะฐะฟะพะผะธะฝะฐะตั ะฟัะธะฒััะบะธ ะธ ะฐะดะฐะฟัะธััะตััั:

| ะะฐััะตัะฝ | ะะฐะบ ัะฐัะฟะพะทะฝะฐัั | ะะตััะพะฝะฐะปะธะทะธัะพะฒะฐะฝะฝัะน ัะพะฒะตั |
|---------|----------------|---------------------------|
| **"ะะฐะฑัะฒะฐะตั ะทะฐะฒััะฐะบ"** | 5+ ะดะฝะตะน ะฟะตัะฒัะน ะฟัะธัะผ ะฟะพัะปะต 11:00 | "ะะฐะผะตัะฐั, ะทะฐะฒััะฐะบ ัะฐััะพ ะฟัะพะฟััะบะฐะตััั..." |
| **"ะะตัะตัะฝะธะน ะตะดะพะบ"** | >60% ะบะบะฐะป ะฟะพัะปะต 18:00 ัะตะณัะปััะฝะพ | "ะะพะฟัะพะฑัะน ัะผะตััะธัั ะบะฐะปะพัะธะธ ะฝะฐ ะดะตะฝั" |
| **"ะกะปะฐะดะบะพะตะถะบะฐ"** | simplePct > 40% ะฝะตะดะตะปั | "ะะฐะฒะฐะน ะฝะฐะนะดัะผ ะฐะปััะตัะฝะฐัะธะฒั ัะปะฐะดะบะพะผั?" |
| **"ะะตะปะบะพะฒัะน ะดะตัะธัะธั"** | proteinPct < 50% ะฝะตะดะตะปั | "ะะตะปะพะบ โ ัะฒะพั ะทะพะฝะฐ ัะพััะฐ ๐ช" |
| **"ะะตััะตะบัะธะพะฝะธัั"** | ะัะตะณะดะฐ 95-105% | "ะะดะตะฐะปัะฝะพ! ะะพะถะตัั ะธะฝะพะณะดะฐ ัะฐััะปะฐะฑะธัััั" |
| **"ะััะพะดะฝัะต = ัััะฒ"** | ะกะฑ-ะั ะฟะตัะตะฑะพั, ะะฝ-ะั ะฝะพัะผะฐ | ะ ะฟััะฝะธัั: "ะััะพะดะฝัะต ะฑะปะธะทะบะพ โ ะฟะพะผะฝะธ ะพ ัะตะปัั!" |

---

#### ๐ซ ะะพะณะดะฐ ะะ ะฟะพะบะฐะทัะฒะฐัั โ ะบะพะฝัะตะบัั ะทะฐะฝััะพััะธ

| ะกะพััะพัะฝะธะต UI | ะะพะบะฐะทัะฒะฐัั? | ะัะธัะธะฝะฐ |
|--------------|-------------|---------|
| ะัะบััั ะฟะพะธัะบ ะฟัะพะดัะบัะพะฒ | โ | ะะพะปัะทะพะฒะฐัะตะปั ะทะฐะฝัั |
| ะะตะดะฐะบัะธััะตั ะณัะฐะผะผั | โ | ะคะพะบัั ะฝะฐ ะฒะฒะพะดะต |
| ะัะฑะฐั ะผะพะดะฐะปะบะฐ ะพัะบัััะฐ | โ | ะะปะพะบะธััะตั ะฒะฝะธะผะฐะฝะธะต |
| ะกะบัะพะปะปะธั ัะฟะธัะพะบ | โ | ะะทััะฐะตั ะดะฐะฝะฝัะต |
| Idle 3+ ัะตะบัะฝะด | โ | ะะพัะพะฒ ะบ ะธะฝัะพัะผะฐัะธะธ |
| ะขะพะปัะบะพ ะดะพะฑะฐะฒะธะป ะฟัะพะดัะบั | โ | ะะพะผะตะฝั ะพะฑััะตะฝะธั |
| ะฃะดะฐะปะธะป ะฟัะพะดัะบั | โ | ะะต ะบะพะผะผะตะฝัะธัะพะฒะฐัั |

**ะะตะฐะปะธะทะฐัะธั:**
```javascript
const isUserBusy = modalOpen || searchOpen || isEditing || isScrolling;
if (isUserBusy) return { primary: null, ... };
```

---

#### ๐ ะัะตะผะตะฝะฝัะต/ัะพัะธะฐะปัะฝัะต ัะฐะบัะพัั

| ะคะฐะบัะพั | ะฃัะปะพะฒะธะต | ะัะพะฑัะน ัะพะฒะตั |
|--------|---------|--------------|
| **ะะพะฝะตะดะตะปัะฝะธะบ** | day === 1 | "ะะพะฒะฐั ะฝะตะดะตะปั โ ะฝะพะฒัะน ััะฐัั!" |
| **ะััะฝะธัะฐ ะฒะตัะตั** | day === 5 && hour >= 17 | "ะััะพะดะฝัะต ะฑะปะธะทะบะพ โ ะฝะต ะทะฐะฑัะฒะฐะน ะพ ัะตะปัั" |
| **ะะพัะบัะตัะตะฝัะต ะฒะตัะตั** | day === 0 && hour >= 18 | "ะกะฟะปะฐะฝะธััะน ะฟะธัะฐะฝะธะต ะฝะฐ ะฝะตะดะตะปั" |
| **ะะพะฝะตั ะผะตัััะฐ** | date >= 28 | "ะคะธะฝะฐะปัะฝัะน ััะฒะพะบ ะผะตัััะฐ!" |
| **1 ัะฝะฒะฐัั** | month === 0 && date === 1 | "ะะพะฒัะน ะณะพะด โ ะธะดะตะฐะปัะฝัะน ััะฐัั! ๐" |
| **ะะตะฝั ัะพะถะดะตะฝะธั** | (ะตัะปะธ ะทะฝะฐะตะผ) | "ะก ะดะฝัะผ ัะพะถะดะตะฝะธั! ะกะตะณะพะดะฝั ะผะพะถะฝะพ ะฒัั ๐" |

---

#### ๐ฏ ะขัะธะณะณะตัั ะฟะพะบะฐะทะฐ (ะธัะพะณะพะฒะฐั ัะฐะฑะปะธัะฐ)

| ะขัะธะณะณะตั | ะะพะฝัะตะบัั | ะกะพะฒะตัั | TTL | ะัะธะพัะธัะตั |
|---------|----------|--------|-----|-----------|
| `tab_open` | ะะตัะฒะพะต ะพัะบัััะธะต ะทะฐ ัะตััะธั | Streak, ะฑะฐะปะฐะฝั, ะฟัะพะณัะตัั | 5 ัะตะบ | 1 |
| `product_added` | ะะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั | ะะะฃ, ะบะปะตััะฐัะบะฐ, ะะ | 4 ัะตะบ | 2 |
| `meal_opened` | ะะปะธะบ ะฝะฐ ะฟัะธัะผ | ะกะฟะตัะธัะธัะฝัะต ะดะปั ะฟัะธัะผะฐ | 3 ัะตะบ | 3 |
| `day_changed` | ะกะผะตะฝะฐ ะดะฐัั | ะัะพะณะธ / ะฟะปะฐะฝ | 5 ัะตะบ | 1 |
| `idle_5s` | ะะตะทะดะตะนััะฒะธะต 5 ัะตะบ | ะะฑัะธะต ัะพะฒะตัั | 4 ัะตะบ | 4 |
| `time_evening` | 18:00+ ะฟะตัะฒัะน ัะฐะท | ะะตัะตัะฝะธะต | 5 ัะตะบ | 2 |
| `time_night` | 23:00+ | **ะะะงะะะ** | โ | โ |

---

#### ๐ Cooldown ะธ ะดะตะดัะฟะปะธะบะฐัะธั

```javascript
const COOLDOWN_MS = 30000;      // ะะธะฝะธะผัะผ 30 ัะตะบ ะผะตะถะดั ัะพะฒะตัะฐะผะธ
const ADVICE_MEMORY_MS = 300000; // ะะต ะฟะพะฒัะพัััั ัะพะฒะตั 5 ะผะธะฝัั
const MAX_ADVICES_PER_SESSION = 10; // ะะต ะฝะฐะดะพะตะดะฐัั

// ะัะบะปััะตะฝะธั (ะผะพะถะฝะพ ะฟะพะบะฐะทัะฒะฐัั ะฒัะตะณะดะฐ):
const ALWAYS_SHOW = ['streak_7', 'perfect_day', 'first_day'];
```

---

## ๐ฏ ะัะพะฑะปะตะผั ัะตะบััะตะน ัะตะฐะปะธะทะฐัะธะธ

| ะัะพะฑะปะตะผะฐ | ะะฟะธัะฐะฝะธะต |
|----------|----------|
| **ะะดะธะฝ toast** | ะะพะบะฐะทัะฒะฐะตั ัะพะปัะบะพ ะพะดะฝั ัะตะบะพะผะตะฝะดะฐัะธั (ะฟะตัะฒัั ะฟะพ ะฟัะธะพัะธัะตัั) |
| **ะะพัะตัั ะบะพะฝัะตะบััะฐ** | ะััะฐะปัะฝัะต ะฟะพะปะตะทะฝัะต ัะพะฒะตัั ัะบัััั |
| **ะัััะบะฐั ะปะพะณะธะบะฐ** | ะฃัะปะพะฒะธั ะทะฐัะฐัะดะบะพะถะตะฝั ะฒ useMemo |
| **ะะตั ะบะฐัะตะณะพัะธะทะฐัะธะธ** | ะัะต ัะพะฒะตัั ะฒ ะพะดะฝะพะน ะบััะต |

---

## ๐๏ธ ะััะธัะตะบัััะฐ Advice Module

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ADVICE ENGINE                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Context Collector          โ  ะกะพะฑะธัะฐะตั ะะกะ ะดะฐะฝะฝัะต          โ
โ  โโโ DayContext             (dayTot, normAbs, meals, etc.)  โ
โ  โโโ TimeContext            (hour, isEvening, isWeekend)    โ
โ  โโโ TrendContext           (streak, weight trend)          โ
โ  โโโ ProfileContext         (goals, preferences)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Rule Engine                โ  ะัะตะฝะธะฒะฐะตั ะฒัะต ะฟัะฐะฒะธะปะฐ        โ
โ  โโโ Warning Rules          (ะบัะธัะธัะตัะบะธะต, priority: 1)      โ
โ  โโโ Achievement Rules      (ะฟะพัะฒะฐะปะฐ, priority: 2)          โ
โ  โโโ Nutrition Rules        (ะะะฃ, ะบะปะตััะฐัะบะฐ, ะะ)            โ
โ  โโโ Timing Rules           (ะฒัะตะผั ัััะพะบ, ะฟะตัะตััะฒั)         โ
โ  โโโ Training Rules         (ะบะพะฝัะตะบัั ััะตะฝะธัะพะฒะบะธ)           โ
โ  โโโ Lifestyle Rules        (ัะพะฝ, ัะฐะณะธ, ะฒะพะดะฐ)               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Advice Prioritizer         โ  ะกะพััะธััะตั ะธ ัะธะปััััะตั        โ
โ  โโโ ะะพ severity            (warning > achievement > tip)   โ
โ  โโโ ะะพ ะฐะบััะฐะปัะฝะพััะธ        (ะฒัะตะผั ัััะพะบ, ะบะพะฝัะตะบัั)         โ
โ  โโโ ะะพ ะฝะพะฒะธะทะฝะต             (ะฝะต ะฟะพะฒัะพัััั ัะฐััะพ)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Delivery Layer             โ  ะะฐะบ ะฟะพะบะฐะทัะฒะฐัั               โ
โ  โโโ Toast (1 ะณะปะฐะฒะฝัะน)      - ัะตะบััะธะน ััะฝะบัะธะพะฝะฐะป            โ
โ  โโโ Advice Panel           - ัะฐัะบััะฒะฐััะธะนัั ัะฟะธัะพะบ         โ
โ  โโโ Daily Summary          - ะธัะพะณะธ ะดะฝั (ะฒะตัะตัะพะผ)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะะปััะตะฒัะต ัะฐะนะปั

| ะคะฐะนะป | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `apps/web/heys_advice_v1.js` | **ะะะะซะ** โ ะะพะดัะปั ัะพะฒะตัะพะฒ |
| `apps/web/heys_day_v12.js` | ะะฝัะตะณัะฐัะธั ะผะพะดัะปั, ะทะฐะผะตะฝะฐ macroTip |
| `apps/web/styles/main.css` | ะกัะธะปะธ ะดะปั Advice Panel |

### ๐ ะะบััะฐะปัะฝัะต ะฝะพะผะตัะฐ ัััะพะบ (ะฝะฐ 2025-11-29)

| ะงัะพ | ะกััะพะบะฐ | ะะฟะธัะฐะฝะธะต |
|-----|--------|----------|
| `date` ะฟะตัะตะผะตะฝะฝะฐั | 144 | `const date = selectedDate \|\| todayISO();` |
| `toastTimeoutRef` | 707 | `const toastTimeoutRef = React.useRef(null);` |
| `toastVisible` | 705 | `const [toastVisible, setToastVisible] = useState(false);` |
| `macroTip` useMemo | 2653 | ะกัะฐััะน ะบะพะด ัะพะฒะตัะพะฒ โ ะฃะะะะะขะฌ |
| `activeDays` | 1612 | Map ั ratio ะดะปั ะดะฝะตะน ะผะตัััะฐ |
| `.macro-toast` CSS | 4850 | ะกััะตััะฒัััะธะต ััะธะปะธ toast |

โ๏ธ **ะะพัะปะต ะฟัะฐะฒะพะบ ะฝะพะผะตัะฐ ัััะพะบ ะผะพะณัั ัะผะตััะธัััั!** ะัะฟะพะปัะทัะน ะฟะพะธัะบ ะฟะพ ัะตะบััั.

---

## ๐ ะกัััะบัััะฐ Advice

```javascript
/**
 * @typedef {Object} Advice
 * @property {string} id - ะฃะฝะธะบะฐะปัะฝัะน ID ะฟัะฐะฒะธะปะฐ (e.g., 'low_protein', 'streak_7')
 * @property {string} icon - Emoji ะธะบะพะฝะบะฐ
 * @property {string} text - ะขะตะบัั ัะพะฒะตัะฐ
 * @property {'warning'|'achievement'|'tip'|'info'} type - ะขะธะฟ
 * @property {number} priority - ะัะธะพัะธัะตั (1-100, ะผะตะฝััะต = ะฒะฐะถะฝะตะต)
 * @property {string} category - ะะฐัะตะณะพัะธั (nutrition, timing, training, lifestyle)
 * @property {number} score - ะะตะปะตะฒะฐะฝัะฝะพััั (0-1)
 * @property {string[]} triggers - ะะพะณะดะฐ ะฟะพะบะฐะทัะฒะฐัั: ['tab_open', 'product_added', 'meal_opened', 'day_changed']
 * @property {number} [ttl] - ะัะตะผั ะฟะพะบะฐะทะฐ ะฒ ะผั (default: 5000)
 * @property {boolean} [dismissable] - ะะพะถะฝะพ ะปะธ ัะบัััั
 * @property {Function} [onShow] - Callback ะฟัะธ ะฟะพะบะฐะทะต (ะดะปั sessionStorage)
 */

/**
 * @typedef {'tab_open'|'product_added'|'meal_opened'|'day_changed'|'time_check'|null} ShowTrigger
 */
```

---

## ๐ฏ ะะฐะดะฐัะธ

### ะะฐะดะฐัะฐ 1: ะกะพะทะดะฐัั ัะฐะนะป heys_advice_v1.js

**ะะฐัะฟะพะปะพะถะตะฝะธะต**: `apps/web/heys_advice_v1.js`

```javascript
// heys_advice_v1.js โ ะะพะดัะปั ัะผะฝัั ัะพะฒะตัะพะฒ HEYS
// ะกะฟัะฐะฒะพัะฝะธะบ ะดะฐะฝะฝัั: docs/DATA_MODEL_REFERENCE.md

(function() {
  'use strict';

  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // CONSTANTS
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  
  const SHOWN_KEY = 'heys_shown_advices';
  const COOLDOWN_MS = 30000;        // ะะธะฝะธะผัะผ 30 ัะตะบ ะผะตะถะดั ัะพะฒะตัะฐะผะธ
  const ADVICE_MEMORY_MS = 300000;  // ะะต ะฟะพะฒัะพัััั ัะพะฒะตั 5 ะผะธะฝัั
  const MAX_ADVICES_PER_SESSION = 10;
  const ALWAYS_SHOW = ['streak_7', 'perfect_day', 'first_day']; // ะัะบะปััะตะฝะธั
  
  let lastShowTime = 0;
  let sessionAdviceCount = 0;
  
  // Cleanup ะฟัะธ ัะผะตะฝะต ะดะฐัั (ะฒัะทัะฒะฐะตััั ะธะทะฒะฝะต ะฟัะธ date change)
  function resetSessionAdvices() {
    sessionAdviceCount = 0;
    lastShowTime = 0;
    try {
      // ะัะธัะฐะตะผ ัะพะปัะบะพ advice-related ะบะปััะธ, ะฝะต streak
      sessionStorage.removeItem(SHOWN_KEY);
    } catch(e) {}
  }

  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // ๐ง CONTEXT ANALYZERS โ ะะฝะฐะปะธะท ัะพััะพัะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  /**
   * ะะฟัะตะดะตะปัะตั ัะพะฝ ัะพะพะฑัะตะฝะธะน ะฟะพ ะฒัะตะผะตะฝะธ ัััะพะบ
   * @param {number} hour - ะขะตะบััะธะน ัะฐั (0-23)
   * @returns {'silent'|'gentle'|'business'|'brief'|'caring'|'supportive'|'warm'}
   */
  function getToneForHour(hour) {
    if (hour >= 23 || hour < 6) return 'silent';   // ะะต ะฑะตัะฟะพะบะพะธัั!
    if (hour < 9) return 'gentle';                  // ะัะณะบะพ, ัััะพ
    if (hour < 12) return 'business';               // ะะตะปะพะฒะพะน
    if (hour < 14) return 'brief';                  // ะะพัะพัะบะพ (ะพะฑะตะด)
    if (hour < 17) return 'caring';                 // ะะฐะฑะพัะปะธะฒะพ (ัะฟะฐะด ัะฝะตัะณะธะธ)
    if (hour < 20) return 'supportive';             // ะะพะดะดะตัะถะบะฐ (ะฒะตัะตั)
    return 'warm';                                  // ะขัะฟะปัะน (ัะตัะปะตะบัะธั)
  }

  /**
   * ะะฟัะตะดะตะปัะตั ัะผะพัะธะพะฝะฐะปัะฝะพะต ัะพััะพัะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
   * @param {Object} ctx - ะะพะฝัะตะบัั
   * @returns {'stressed'|'crashed'|'success'|'returning'|'newbie'|'normal'}
   */
  function getEmotionalState(ctx) {
    const { day, currentStreak, mealCount, kcalPct, totalDaysTracked } = ctx;
    
    // ะะพะฒะธัะพะบ (ะผะตะฝะตะต 3 ะดะฝะตะน ั ะดะฐะฝะฝัะผะธ)
    if (totalDaysTracked < 3) return 'newbie';
    
    // ะฃัะฟะตั (streak 3+ ะดะฝะตะน)
    if (currentStreak >= 3) return 'success';
    
    // ะกััะฒ (ัะตะทะบะธะน ะฟะตัะตะฑะพั >150% ะบะฐะปะพัะธะน)
    if (kcalPct > 1.5) return 'crashed';
    
    // ะกััะตัั (ะฝะธะทะบะธะน mood ะฒ ะฟะพัะปะตะดะฝะธั ะฟัะธัะผะฐั)
    const meals = day?.meals || [];
    const moodsWithValues = meals.filter(m => m.mood && !isNaN(+m.mood));
    if (moodsWithValues.length > 0) {
      const avgMood = moodsWithValues.reduce((sum, m) => sum + (+m.mood), 0) / moodsWithValues.length;
      if (avgMood < 3) return 'stressed';
    }
    
    return 'normal';
  }

  /**
   * ะัะพะฒะตััะตั, ะทะฐะฝัั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั
   * @param {Object} uiState - ะกะพััะพัะฝะธะต UI
   * @returns {boolean}
   */
  function isUserBusy(uiState) {
    const { modalOpen, searchOpen, isEditing, isScrolling } = uiState || {};
    return modalOpen || searchOpen || isEditing || isScrolling;
  }

  /**
   * ะะฟัะตะดะตะปัะตั ะพัะพะฑัะน ะดะตะฝั (ะฟะพะฝะตะดะตะปัะฝะธะบ, ะฟัะฐะทะดะฝะธะบ ะธ ั.ะด.)
   * @param {Date} date
   * @returns {string|null}
   */
  function getSpecialDay(date) {
    const day = date.getDay();
    const month = date.getMonth();
    const dateNum = date.getDate();
    const hour = date.getHours();
    
    // ะะพะฒัะน ะณะพะด
    if (month === 0 && dateNum === 1) return 'new_year';
    
    // ะะพะฝะตะดะตะปัะฝะธะบ ัััะพ
    if (day === 1 && hour < 12) return 'monday_morning';
    
    // ะััะฝะธัะฐ ะฒะตัะตั
    if (day === 5 && hour >= 17) return 'friday_evening';
    
    // ะะพัะบัะตัะตะฝัะต ะฒะตัะตั
    if (day === 0 && hour >= 18) return 'sunday_evening';
    
    // ะะพะฝะตั ะผะตัััะฐ
    if (dateNum >= 28) return 'month_end';
    
    return null;
  }

  /**
   * ะคะธะปััััะตั ัะพะฒะตัั ะฟะพ ัะผะพัะธะพะฝะฐะปัะฝะพะผั ัะพััะพัะฝะธั
   * @param {Array} advices
   * @param {string} emotionalState
   * @returns {Array}
   */
  function filterByEmotionalState(advices, emotionalState) {
    // ะัะธ ัััะตััะต ะธะปะธ ัััะฒะต โ ัะฑะธัะฐะตะผ warnings
    if (emotionalState === 'stressed' || emotionalState === 'crashed') {
      return advices.filter(a => a.type !== 'warning');
    }
    return advices;
  }

  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // SHOWN ADVICES TRACKER โ ะะฐะบะธะต ัะพะฒะตัั ัะถะต ะฟะพะบะฐะทะฐะฝั ะฒ ัะตััะธะธ
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  
  function getShownAdvices() {
    try {
      return JSON.parse(sessionStorage.getItem(SHOWN_KEY) || '{}');
    } catch { return {}; }
  }
  
  function markAdviceShown(id) {
    try {
      const shown = getShownAdvices();
      shown[id] = Date.now();
      sessionStorage.setItem(SHOWN_KEY, JSON.stringify(shown));
      sessionAdviceCount++;
    } catch {}
  }
  
  function wasShownRecently(id, withinMs = ADVICE_MEMORY_MS) {
    if (ALWAYS_SHOW.includes(id)) return false; // ะญัะธ ะฟะพะบะฐะทัะฒะฐะตะผ ะฒัะตะณะดะฐ
    const shown = getShownAdvices();
    return shown[id] && (Date.now() - shown[id] < withinMs);
  }
  
  function canShowNow() {
    if (sessionAdviceCount >= MAX_ADVICES_PER_SESSION) return false;
    return Date.now() - lastShowTime > COOLDOWN_MS;
  }

  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // ADVICE RULES โ ะัะต ะฟัะฐะฒะธะปะฐ ัะพะฒะตัะพะฒ
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  /**
   * ะกะพะทะดะฐัั ะฟัะฐะฒะธะปะฐ ัะพะฒะตัะพะฒ
   * @param {Object} ctx - ะะพะฝัะตะบัั ะดะฐะฝะฝัั
   * @returns {Array<Advice>} ะะฐััะธะฒ ะฐะบัะธะฒะฝัั ัะพะฒะตัะพะฒ
   */
  function evaluateRules(ctx) {
    const {
      dayTot, normAbs, optimum, day, pIndex,
      currentStreak, hour, mealCount, hasTraining,
      emotionalState, tone, specialDay
    } = ctx;

    const advices = [];
    
    // ะะพััั โ ะฝะต ะฑะตัะฟะพะบะพะธะผ!
    if (tone === 'silent') return [];
    
    // ะัััะพะน ะดะตะฝั โ ะฝะต ะฟะพะบะฐะทัะฒะฐัั ัะพะฒะตัั (ะฝะตั ัะผััะปะฐ)
    if ((dayTot.kcal || 0) < 10 && mealCount === 0) return [];

    // ะััะธัะปัะตะผ ะฟัะพัะตะฝัั
    const kcalPct = (dayTot.kcal || 0) / (optimum || 1);
    const proteinPct = (dayTot.prot || 0) / (normAbs.prot || 1);
    const fatPct = (dayTot.fat || 0) / (normAbs.fat || 1);
    const carbsPct = (dayTot.carbs || 0) / (normAbs.carbs || 1);
    const fiberPct = (dayTot.fiber || 0) / (normAbs.fiber || 25);
    
    const simpleCarbs = dayTot.simple || 0;
    const complexCarbs = dayTot.complex || 0;
    const totalCarbs = simpleCarbs + complexCarbs;
    const simplePct = totalCarbs > 0 ? (simpleCarbs / totalCarbs) : 0;
    
    const badFat = dayTot.bad || 0;
    const totalFat = dayTot.fat || 0;
    const badFatPct = totalFat > 0 ? (badFat / totalFat) : 0;
    
    const avgGI = dayTot.gi || 0;

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐ SPECIAL DAY TIPS โ ะัะพะฑัะต ะดะฝะธ
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    if (specialDay === 'new_year') {
      advices.push({
        id: 'new_year',
        icon: '๐',
        text: 'ะก ะะพะฒัะผ ะณะพะดะพะผ! ะะดะตะฐะปัะฝัะน ะดะตะฝั ะดะปั ััะฐััะฐ!',
        type: 'achievement',
        priority: 0,
        category: 'special',
        triggers: ['tab_open'],
        ttl: 7000
      });
    }
    
    if (specialDay === 'monday_morning') {
      advices.push({
        id: 'monday_motivation',
        icon: '๐ช',
        text: 'ะะพะฒะฐั ะฝะตะดะตะปั โ ะฝะพะฒัะต ะฒะพะทะผะพะถะฝะพััะธ!',
        type: 'tip',
        priority: 5,
        category: 'motivation',
        triggers: ['tab_open'],
        ttl: 5000
      });
    }
    
    if (specialDay === 'friday_evening') {
      advices.push({
        id: 'friday_reminder',
        icon: '๐ฏ',
        text: 'ะััะพะดะฝัะต ะฑะปะธะทะบะพ โ ะฟะพะผะฝะธ ะพ ัะฒะพะธั ัะตะปัั!',
        type: 'tip',
        priority: 10,
        category: 'motivation',
        triggers: ['tab_open'],
        ttl: 5000
      });
    }
    
    if (specialDay === 'sunday_evening') {
      advices.push({
        id: 'sunday_planning',
        icon: '๐',
        text: 'ะกะฟะปะฐะฝะธััะน ะฟะธัะฐะฝะธะต ะฝะฐ ะฝะตะดะตะปั',
        type: 'tip',
        priority: 10,
        category: 'motivation',
        triggers: ['tab_open'],
        ttl: 5000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐ EMOTIONAL STATE TIPS โ ะะพ ัะพััะพัะฝะธั
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    if (emotionalState === 'returning') {
      // โ๏ธ TODO: lastVisitDaysAgo ะฝะต ะฒััะธัะปัะตััั, ััะพั ัะพะฒะตั ะฟะพะบะฐ ะฝะต ััะฐะฑะพัะฐะตั
      // ะะปั ะฐะบัะธะฒะฐัะธะธ: ะดะพะฑะฐะฒะธัั localStorage ะบะปัั heys_last_visit ะธ ะฒััะธัะปััั ัะฐะทะฝะธัั
      advices.push({
        id: 'welcome_back',
        icon: '๐',
        text: 'ะะฐะดั ะฒะธะดะตัั! ะัะพะดะพะปะถะธะผ ั ัะพะณะพ ะผะตััะฐ?',
        type: 'achievement',
        priority: 1,
        category: 'emotional',
        triggers: ['tab_open'],
        ttl: 5000
      });
    }
    
    if (emotionalState === 'crashed') {
      advices.push({
        id: 'crash_support',
        icon: '๐',
        text: 'ะัะฒะฐะตั! ะะฐะฒััะฐ ะฝะพะฒัะน ะดะตะฝั. ะขั ัะฟัะฐะฒะธัััั!',
        type: 'achievement',
        priority: 1,
        category: 'emotional',
        triggers: ['tab_open', 'product_added'],
        ttl: 6000
      });
    }
    
    if (emotionalState === 'stressed') {
      advices.push({
        id: 'stress_support',
        icon: '๐ค',
        text: 'ะขั ะผะพะปะพะดะตั, ััะพ ะทะฐะฟะธััะฒะฐะตัั. ะญัะพ ัะถะต ััะฟะตั!',
        type: 'achievement',
        priority: 2,
        category: 'emotional',
        triggers: ['tab_open'],
        ttl: 5000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐ ACHIEVEMENTS (priority: 1-10) โ ะฟะพะบะฐะทัะฒะฐัััั ะฟัะธ tab_open
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    if (currentStreak >= 7 && !sessionStorage.getItem('heys_streak7')) {
      advices.push({
        id: 'streak_7',
        icon: '๐',
        text: `ะะตะฒะตัะพััะฝะพ! ${currentStreak} ะดะฝะตะน ะฒ ะฝะพัะผะต!`,
        type: 'achievement',
        priority: 1,
        category: 'achievement',
        score: 1.0,
        triggers: ['tab_open'],
        ttl: 7000,
        showConfetti: true,
        onShow: () => { try { sessionStorage.setItem('heys_streak7', '1'); } catch(e) {} }
      });
    }
    
    if (currentStreak >= 3 && currentStreak < 7 && !sessionStorage.getItem('heys_streak3')) {
      advices.push({
        id: 'streak_3',
        icon: '๐ฅ',
        text: `${currentStreak} ะดะฝั ะฟะพะดััะด ะฒ ะฝะพัะผะต! ะขะฐะบ ะดะตัะถะฐัั!`,
        type: 'achievement',
        priority: 2,
        category: 'achievement',
        score: 0.9,
        triggers: ['tab_open'],
        ttl: 5000,
        onShow: () => { try { sessionStorage.setItem('heys_streak3', '1'); } catch(e) {} }
      });
    }
    
    // ะะดะตะฐะปัะฝัะน ะดะตะฝั โ ะฟะพะบะฐะทัะฒะฐะตะผ ะฟัะธ tab_open ะฒะตัะตัะพะผ
    if (hour >= 18 && kcalPct >= 0.95 && kcalPct <= 1.05 && 
        proteinPct >= 0.9 && fatPct >= 0.9 && carbsPct >= 0.9) {
      advices.push({
        id: 'perfect_day',
        icon: 'โญ',
        text: 'ะะดะตะฐะปัะฝัะน ะฑะฐะปะฐะฝั! ะัะปะธัะฝะฐั ัะฐะฑะพัะฐ ๐',
        type: 'achievement',
        priority: 5,
        category: 'achievement',
        score: 1.0,
        triggers: ['tab_open'],
        ttl: 5000
      });
    }
    
    // ะะตัะฒัะน ะฟัะธัะผ โ ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั ะฟัะพะดัะบัะฐ
    if (mealCount === 1 && !localStorage.getItem('heys_first_meal_tip')) {
      advices.push({
        id: 'first_day',
        icon: '๐',
        text: 'ะัะปะธัะฝะพะต ะฝะฐัะฐะปะพ! ะะฐะฟะธััะฒะฐะน ะฒัั โ ััะพ ะบะปัั ะบ ััะฟะตัั',
        type: 'achievement',
        priority: 3,
        category: 'achievement',
        score: 1.0,
        triggers: ['product_added'],
        ttl: 5000,
        onShow: () => { try { localStorage.setItem('heys_first_meal_tip', '1'); } catch(e) {} }
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // โ๏ธ WARNINGS (priority: 11-30) โ ะฟะพะบะฐะทัะฒะฐัััั ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั ะฟัะพะดัะบัะฐ
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    if (kcalPct >= 1.25) {
      advices.push({
        id: 'kcal_excess_critical',
        icon: 'โ๏ธ',
        text: 'ะะตัะตะฑะพั ะบะฐะปะพัะธะน! ะะฐะฒััะฐ ัะดะตะปะฐะน ัะฐะทะณััะทะพัะฝัะน ะดะตะฝั',
        type: 'warning',
        priority: 11,
        category: 'nutrition',
        score: 1.0,
        triggers: ['product_added', 'tab_open'],
        ttl: 6000
      });
    }
    
    if (simplePct > 0.5 && simpleCarbs > 30) {
      advices.push({
        id: 'simple_carbs_high',
        icon: 'โ๏ธ',
        text: 'ะะฝะพะณะพ ะฟัะพัััั ัะณะปะตะฒะพะดะพะฒ! ะะฐะผะตะฝะธ ัะปะฐะดะบะพะต ะฝะฐ ะบะฐัั/ะพะฒะพัะธ',
        type: 'warning',
        priority: 12,
        category: 'nutrition',
        score: simplePct,
        triggers: ['product_added'],
        ttl: 5000
      });
    }
    
    if (badFatPct > 0.4 && badFat > 20) {
      advices.push({
        id: 'bad_fat_high',
        icon: 'โ๏ธ',
        text: 'ะะฝะพะณะพ ะฒัะตะดะฝัั ะถะธัะพะฒ! ะะฐะผะตะฝะธ ะฝะฐ ััะฑั/ะพัะตัะธ/ะฐะฒะพะบะฐะดะพ',
        type: 'warning',
        priority: 13,
        category: 'nutrition',
        score: badFatPct,
        triggers: ['product_added'],
        ttl: 5000
      });
    }
    
    if (avgGI > 70 && dayTot.kcal > 500) {
      advices.push({
        id: 'high_gi',
        icon: '๐',
        text: 'ะััะพะบะธะน ะะ โ ะทะฐะผะตะฝะธ ะฑัััััะต ัะณะปะตะฒะพะดั ะฝะฐ ัะปะพะถะฝัะต',
        type: 'warning',
        priority: 14,
        category: 'nutrition',
        score: avgGI / 100,
        triggers: ['product_added'],
        ttl: 5000
      });
    }
    
    // ะะฐะปะพ ะบะฐะปะพัะธะน ะฒะตัะตัะพะผ โ ะฟะพะบะฐะทัะฒะฐะตะผ ะฟัะธ tab_open
    if (hour >= 18 && dayTot.kcal < 500 && dayTot.kcal > 0) {
      advices.push({
        id: 'too_few_kcal',
        icon: 'โ๏ธ',
        text: 'ะกะปะธัะบะพะผ ะผะฐะปะพ ะบะฐะปะพัะธะน โ ััะพ ะฒัะตะดะธั ะผะตัะฐะฑะพะปะธะทะผั',
        type: 'warning',
        priority: 15,
        category: 'nutrition',
        score: 0.9,
        triggers: ['tab_open', 'time_check'],
        ttl: 5000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐ฅฌ NUTRITION TIPS (priority: 31-50) โ ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั ะฟัะพะดัะบัะฐ
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    if (fiberPct < 0.5 && dayTot.kcal > 500) {
      advices.push({
        id: 'low_fiber',
        icon: '๐ฅฌ',
        text: 'ะะพะฑะฐะฒั ะบะปะตััะฐัะบะธ: ะพะฒะพัะธ, ัััะบัั, ะบะฐัะฐ',
        type: 'fiber',
        priority: 31,
        category: 'nutrition',
        score: 1 - fiberPct,
        triggers: ['product_added', 'meal_opened'],
        ttl: 4000
      });
    }
    
    if (carbsPct > 0.7 && proteinPct < 0.4) {
      advices.push({
        id: 'carbs_no_protein',
        icon: '๐ฝ๏ธ',
        text: 'ะฃะณะปะตะฒะพะดั ะฑะตะท ะฑะตะปะบะฐ = ะฑัััััะน ะณะพะปะพะด. ะะพะฑะฐะฒั ะฑะตะปะพะบ!',
        type: 'tip',
        priority: 32,
        category: 'nutrition',
        score: 0.8,
        triggers: ['product_added'],
        ttl: 4000
      });
    }
    
    if (fatPct > 0.7 && carbsPct < 0.4) {
      advices.push({
        id: 'fat_no_carbs',
        icon: 'โก',
        text: 'ะะปั ัะฝะตัะณะธะธ ะฝัะถะฝั ัะณะปะตะฒะพะดั โ ะฟะพะฟัะพะฑัะน ะบะฐัั',
        type: 'tip',
        priority: 33,
        category: 'nutrition',
        score: 0.8,
        triggers: ['product_added'],
        ttl: 4000
      });
    }
    
    // ะะตัะธัะธัั ะผะฐะบัะพัะพะฒ โ ะฟัะธ ะฟัะพัะผะพััะต ะฟัะธัะผะฐ ะธะปะธ ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั
    if (proteinPct < 0.5 && fatPct >= 0.5 && carbsPct >= 0.5) {
      advices.push({
        id: 'low_protein',
        icon: '๐ฅฉ',
        text: 'ะะพะฑะฐะฒั ะฑะตะปะบะฐ: ัะฒะพัะพะณ, ัะนัะฐ, ะบััะธัะฐ',
        type: 'protein',
        priority: 41,
        category: 'nutrition',
        score: 1 - proteinPct,
        triggers: ['product_added', 'meal_opened'],
        ttl: 4000
      });
    }
    
    if (fatPct < 0.5 && proteinPct >= 0.5 && carbsPct >= 0.5) {
      advices.push({
        id: 'low_fat',
        icon: '๐ฅ',
        text: 'ะะฐะปะพ ะถะธัะพะฒ: ะพัะตัะธ, ะฐะฒะพะบะฐะดะพ, ะผะฐัะปะพ',
        type: 'fat',
        priority: 42,
        category: 'nutrition',
        score: 1 - fatPct,
        triggers: ['product_added', 'meal_opened'],
        ttl: 4000
      });
    }
    
    if (carbsPct < 0.5 && proteinPct >= 0.5 && fatPct >= 0.5) {
      advices.push({
        id: 'low_carbs',
        icon: '๐',
        text: 'ะะพะฑะฐะฒั ัะณะปะตะฒะพะดะพะฒ: ะบะฐัะฐ, ัะปะตะฑ, ัััะบัั',
        type: 'carbs',
        priority: 43,
        category: 'nutrition',
        score: 1 - carbsPct,
        triggers: ['product_added', 'meal_opened'],
        ttl: 4000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // โฐ TIMING TIPS (priority: 51-70) โ ะบะพะฝัะตะบััะฝัะต ะฟะพ ะฒัะตะผะตะฝะธ
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    // ะะตัะตัะฝะธะต ะฟัะพัััะต ัะณะปะตะฒะพะดั โ ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั ะฒะตัะตัะพะผ
    if (hour >= 18 && simplePct > 0.4 && simpleCarbs > 50) {
      advices.push({
        id: 'evening_sugar',
        icon: '๐',
        text: 'ะกะปะฐะดะบะพะต ะฒะตัะตัะพะผ โ ะฟะปะพัะพะน ัะพะฝ. ะัััะต ะฑะตะปะพะบ!',
        type: 'tip',
        priority: 51,
        category: 'timing',
        score: 0.7,
        triggers: ['product_added'],
        ttl: 4000
      });
    }
    
    // ะัะพะฟััะตะฝะฝัะน ะทะฐะฒััะฐะบ โ ะฟัะธ ะพัะบัััะธะธ ะฒะบะปะฐะดะบะธ ะดะฝัะผ
    if (hour >= 12 && mealCount === 0) {
      advices.push({
        id: 'no_breakfast',
        icon: '๐',
        text: 'ะะฐะฒััะฐะบ ะทะฐะฟััะบะฐะตั ะผะตัะฐะฑะพะปะธะทะผ โ ะฝะต ะฟัะพะฟััะบะฐะน!',
        type: 'tip',
        priority: 52,
        category: 'timing',
        score: 0.8,
        triggers: ['tab_open'],
        ttl: 5000
      });
    }
    
    if (hour >= 14 && mealCount === 1 && dayTot.kcal > 300) {
      advices.push({
        id: 'long_gap',
        icon: 'โฐ',
        text: 'ะะพะปััะธะต ะฟะตัะตััะฒั ะทะฐะผะตะดะปััั ะผะตัะฐะฑะพะปะธะทะผ โ ะฟะตัะตะบััะธ!',
        type: 'tip',
        priority: 53,
        category: 'timing',
        score: 0.6,
        triggers: ['tab_open'],
        ttl: 4000
      });
    }
    
    if (mealCount === 1 && dayTot.kcal > 800) {
      advices.push({
        id: 'one_big_meal',
        icon: '๐ฝ๏ธ',
        text: 'ะัััะต 3-4 ะฝะตะฑะพะปััะธั ะฟัะธัะผะฐ ัะตะผ 1 ะฑะพะปััะพะน',
        type: 'tip',
        priority: 54,
        category: 'timing',
        score: 0.5,
        triggers: ['product_added'],
        ttl: 4000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐ช TRAINING TIPS (priority: 71-80)
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    if (hasTraining && proteinPct < 0.6) {
      advices.push({
        id: 'training_protein',
        icon: '๐ช',
        text: 'ะะพัะปะต ััะตะฝะธัะพะฒะบะธ ะฒะฐะถะตะฝ ะฑะตะปะพะบ ะดะปั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั',
        type: 'tip',
        priority: 71,
        category: 'training',
        score: 0.8,
        triggers: ['tab_open', 'product_added'],
        ttl: 5000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐ฏ GOAL TIPS (priority: 81-90)
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    if (kcalPct >= 1.1 && kcalPct < 1.25) {
      advices.push({
        id: 'kcal_slight_excess',
        icon: '๐',
        text: 'ะะตะผะฝะพะณะพ ะฟะตัะตะฑะพั โ ะทะฐะฒััะฐ ัััั ะผะตะฝััะต, ะธ ะฒัั ะพะบ ๐',
        type: 'tip',
        priority: 81,
        category: 'nutrition',
        score: 0.6,
        triggers: ['product_added', 'tab_open'],
        ttl: 4000
      });
    }
    
    if (kcalPct >= 0.8 && kcalPct < 0.95) {
      const remaining = Math.round(optimum - dayTot.kcal);
      advices.push({
        id: 'kcal_remaining',
        icon: '๐ฏ',
        text: `ะััะฐะปะพัั ${remaining} ะบะบะฐะป โ ะธะดะตะฐะปัะฝะพ ะดะปั ะฟะตัะตะบััะฐ`,
        type: 'tip',
        priority: 82,
        category: 'nutrition',
        score: 0.5,
        triggers: ['tab_open', 'meal_opened'],
        ttl: 4000
      });
    }

    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    // โ SUCCESS (priority: 91-100)
    // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    if (proteinPct >= 0.8 && fatPct >= 0.8 && carbsPct >= 0.8) {
      advices.push({
        id: 'all_balanced',
        icon: 'โ',
        text: 'ะัะปะธัะฝะพ! ะัะต ะผะฐะบัะพัั ะฒ ะฑะฐะปะฐะฝัะต',
        type: 'success',
        priority: 91,
        category: 'nutrition',
        score: 0.9,
        triggers: ['tab_open', 'product_added'],
        ttl: 4000
      });
    }

    // ะกะพััะธััะตะผ ะฟะพ ะฟัะธะพัะธัะตัั
    return advices.sort((a, b) => a.priority - b.priority);
  }

  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // ADVICE ENGINE โ ะัะฝะพะฒะฝะพะน ััะบ
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  /**
   * React hook ะดะปั ัะฐะฑะพัั ั ัะพะฒะตัะฐะผะธ
   * @param {Object} params - ะะฐัะฐะผะตััั
   * @param {ShowTrigger} params.trigger - ะงัะพ ะฒัะทะฒะฐะปะพ ะฟะพะบะฐะท
   * @param {Object} params.uiState - ะกะพััะพัะฝะธะต UI ะดะปั ะฟัะพะฒะตัะบะธ ะทะฐะฝััะพััะธ
   * @returns {Object} ะะฑัะตะบั ั ัะพะฒะตัะฐะผะธ ะธ ะผะตัะพะดะฐะผะธ
   */
  function useAdviceEngine(params) {
    const { dayTot, normAbs, optimum, day, pIndex, activeDays, trigger, uiState } = params;
    const React = window.React;

    // ะััะธัะปัะตะผ ะบะพะฝัะตะบัั
    const ctx = React.useMemo(() => {
      const now = new Date();
      const hour = now.getHours();
      const meals = day?.meals || [];
      const mealCount = meals.filter(m => m.items?.length > 0).length;
      const trainings = day?.trainings || [];
      const hasTraining = trainings.some(t => t.z && t.z.some(m => m > 0));
      
      // Streak โ inline formatDate ะดะปั ะฝะตะทะฐะฒะธัะธะผะพััะธ ะพั window.fmtDate
      // โ๏ธ ะะะะะะะงะะะะ: activeDays ัะพะดะตัะถะธั ะดะฐะฝะฝัะต ัะพะปัะบะพ ะทะฐ ัะตะบััะธะน ะผะตััั!
      // ะัะปะธ streak ะฟะตัะตัะตะบะฐะตั ะณัะฐะฝะธัั ะผะตัััะฐ โ ัะตะทัะปััะฐั ะผะพะถะตั ะฑััั ะฝะตัะพัะฝัะผ.
      // ะะปั ัะพัะฝะพะณะพ streak ะฝัะถะฝะพ ัะธัะฐัั localStorage ะฝะฐะฟััะผัั ั ะบะปััะพะผ `heys_dayv2_` + dateStr
      const formatDate = (d) => {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      };
      
      let currentStreak = 0;
      if (activeDays && activeDays.size > 0) {
        let checkDate = new Date();
        checkDate.setHours(12);
        for (let i = 0; i < 30; i++) {
          const dateStr = formatDate(checkDate);
          const dayData = activeDays.get(dateStr);
          if (dayData && dayData.ratio >= 0.75 && dayData.ratio <= 1.15) {
            currentStreak++;
          } else if (i > 0) {
            break;
          }
          checkDate.setDate(checkDate.getDate() - 1);
        }
      }
      
      // ๐ง ะะฐััะธัะตะฝะฝัะน ะบะพะฝัะตะบัั
      const kcalPct = (dayTot?.kcal || 0) / (optimum || 2000);
      const tone = getToneForHour(hour);
      const specialDay = getSpecialDay(now);
      const emotionalState = getEmotionalState({
        day,
        currentStreak,
        mealCount,
        kcalPct,
        lastVisitDaysAgo: 0, // TODO: ะฒััะธัะปะธัั ะธะท localStorage
        totalDaysTracked: activeDays?.size || 0
      });

      return {
        dayTot: dayTot || {},
        normAbs: normAbs || {},
        optimum: optimum || 2000,
        day: day || {},
        pIndex: pIndex || new Map(),
        currentStreak,
        hour,
        mealCount,
        hasTraining,
        // ะะพะฒัะต ะฟะพะปั
        kcalPct,
        tone,
        specialDay,
        emotionalState
      };
    }, [dayTot, normAbs, optimum, day, pIndex, activeDays]);

    // ะะพะปััะฐะตะผ ะะกะ ัะพะฒะตัั (ะฑะตะท ัะธะปัััะฐัะธะธ ะฟะพ trigger)
    const allAdvices = React.useMemo(() => {
      try {
        const advices = evaluateRules(ctx);
        // ะคะธะปััััะตะผ ะฟะพ ัะผะพัะธะพะฝะฐะปัะฝะพะผั ัะพััะพัะฝะธั
        return filterByEmotionalState(advices, ctx.emotionalState);
      } catch (e) {
        console.error('[Advice] Error evaluating rules:', e);
        return [];
      }
    }, [ctx]);

    // ะคะธะปััััะตะผ ะฟะพ trigger + ะฟัะพะฒะตััะตะผ cooldown + ะทะฐะฝััะพััั
    const relevantAdvices = React.useMemo(() => {
      // ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะทะฐะฝัั โ ะฝะต ะฟะพะบะฐะทัะฒะฐะตะผ
      if (isUserBusy(uiState)) return [];
      
      // ะะพััั โ ะฝะต ะฑะตัะฟะพะบะพะธะผ
      if (ctx.tone === 'silent') return [];
      
      if (!trigger || !canShowNow()) return [];
      
      return (allAdvices || []).filter(advice => {
        // ะัะพะฒะตััะตะผ, ะฟะพะดัะพะดะธั ะปะธ ััะธะณะณะตั
        if (!advice.triggers?.includes(trigger)) return false;
        // ะัะพะฒะตััะตะผ, ะฝะต ะฟะพะบะฐะทัะฒะฐะปะธ ะปะธ ะฝะตะดะฐะฒะฝะพ
        if (wasShownRecently(advice.id)) return false;
        return true;
      });
    }, [allAdvices, trigger, uiState, ctx.tone]);

    // ะััะฟะฟะธััะตะผ ะฟะพ ะบะฐัะตะณะพัะธัะผ
    const byCategory = React.useMemo(() => {
      const grouped = {
        achievement: [],
        nutrition: [],
        timing: [],
        training: [],
        lifestyle: [],
        emotional: [],
        motivation: [],
        special: []
      };
      (allAdvices || []).forEach(a => {
        if (grouped[a.category]) {
          grouped[a.category].push(a);
        }
      });
      return grouped;
    }, [allAdvices]);

    // ะะปะฐะฒะฝัะน ัะพะฒะตั ะดะปั ะฟะพะบะฐะทะฐ (ะฟะตัะฒัะน ะธะท relevantAdvices)
    const primary = relevantAdvices[0] || null;
    
    // ะคัะฝะบัะธั ะพัะผะตัะบะธ ะฟะพะบะฐะทะฐ
    const markShown = React.useCallback((id) => {
      markAdviceShown(id);
      lastShowTime = Date.now();
    }, []);

    return {
      primary,             // ะะปะฐะฒะฝัะน ัะพะฒะตั ะดะปั toast (ะธะปะธ null ะตัะปะธ ะฝะตั ะฐะบััะฐะปัะฝัั)
      relevant: relevantAdvices, // ะัะต ะฐะบััะฐะปัะฝัะต ะดะปั ัะตะบััะตะณะพ trigger
      all: allAdvices,     // ะะกะ ะฐะบัะธะฒะฝัะต ัะพะฒะตัั (ะดะปั ะดะตะฑะฐะณะฐ)
      byCategory,          // ะกะณััะฟะฟะธัะพะฒะฐะฝะฝัะต ะฟะพ ะบะฐัะตะณะพัะธัะผ
      count: relevantAdvices.length,
      streak: ctx.currentStreak,
      markShown            // ะคัะฝะบัะธั ะดะปั ะพัะผะตัะบะธ ะฟะพะบะฐะทะฐ
    };
  }

  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // EXPORTS
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  window.HEYS = window.HEYS || {};
  window.HEYS.advice = {
    useAdviceEngine,
    evaluateRules,
    // ะฃัะธะปะธัั ะดะปั ะฒะฝะตัะฝะตะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
    canShowNow,
    wasShownRecently,
    markAdviceShown,
    resetSessionAdvices, // ะะปั ัะฑัะพัะฐ ะฟัะธ ัะผะตะฝะต ะดะฐัั
    // ะะพะฝัะตะบััะฝัะต ััะฝะบัะธะธ (ะดะปั ะฒะฝะตัะฝะตะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั)
    getToneForHour,
    getEmotionalState,
    getSpecialDay,
    isUserBusy
  };

})();
```

### ะะฐะดะฐัะฐ 2: Expandable Toast UI ั Smart Timing

**ะะพะฝัะตะฟัะธั**: Toast ะฟะพะบะฐะทัะฒะฐะตััั ัะพะปัะบะพ ะฟัะธ ะพะฟัะตะดะตะปัะฝะฝัั ััะธะณะณะตัะฐั, ััะธััะฒะฐะตั ะทะฐะฝััะพััั ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะธััะตะทะฐะตั.

**ะะดะต**: ะ DayTab `heys_day_v12.js`

**โ๏ธ ะะะะะะะะ**: ะะตัะตะด ััะพะน ะทะฐะดะฐัะตะน ะะะฏะะะขะะะฌะะ ะฒัะฟะพะปะฝะธัั ะฟะตัะฒัะน ะฟัะพะผะฟั `2025-11-28-smart-toast-recommendations.md` โ ะธัะฟัะฐะฒะปะตะฝะธะต ะฑะฐะณะฐ `prot/protein`!

```javascript
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// SMART TIMING โ ะขัะธะณะณะตัั ะฟะพะบะฐะทะฐ ัะพะฒะตัะพะฒ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// ะกะพััะพัะฝะธั (ะดะพะฑะฐะฒะธัั ััะดะพะผ ั ัััะตััะฒัััะธะผะธ useState ะฒ DayTab, ะฟะพัะปะต ัััะพะบะธ ~707)
const [adviceTrigger, setAdviceTrigger] = React.useState(null);
const [adviceExpanded, setAdviceExpanded] = React.useState(false);
// โ๏ธ ะะะะะ: toastVisible, toastDismissed ะธ toastTimeoutRef ะฃะะ ัััะตััะฒััั (ัััะพะบะธ 705-707)
// ะัะฟะพะปัะทะพะฒะฐัั ะะฅ, ะฝะต ัะพะทะดะฐะฒะฐัั ะฝะพะฒัะต!

// UI State ะดะปั ะฟัะพะฒะตัะบะธ ะทะฐะฝััะพััะธ
// โ๏ธ ะะะะะ: ะัะฟะพะปัะทะพะฒะฐัั ะะะะะฌะะซะ ะธะผะตะฝะฐ ะฟะตัะตะผะตะฝะฝัั ะธะท DayTab!
const uiState = React.useMemo(() => ({
  modalOpen: showTimePicker || showGramsPicker || showWeightPicker || showDeficitPicker || showZonePicker || showSleepQualityPicker || showDayScorePicker || showHouseholdPicker || showTrainingPicker,
  searchOpen: false, // ะะตั ะณะปะพะฑะฐะปัะฝะพะณะพ searchOpen ะฒ DayTab โ ะฟะพะธัะบ ะฒะฝัััะธ MealAddProduct
  isEditing: false, // ะัะฐะผะผั ัะตะดะฐะบัะธัััััั inline ะฑะตะท ะพัะดะตะปัะฝะพะณะพ ัะพััะพัะฝะธั
  isScrolling: false // ะะฟัะธะพะฝะฐะปัะฝะพ: ะดะพะฑะฐะฒะธัั scroll listener
}), [showTimePicker, showGramsPicker, showWeightPicker, showDeficitPicker, showZonePicker, showSleepQualityPicker, showDayScorePicker, showHouseholdPicker, showTrainingPicker]);

// ะขัะธะณะณะตั ะฟัะธ ะฟะตัะฒะพะผ ะพัะบัััะธะธ ะฒะบะปะฐะดะบะธ (ะพะดะธะฝ ัะฐะท ะทะฐ ัะตััะธั)
// โ๏ธ ะะะะะ: ะะตัะตะผะตะฝะฝะฐั ะฝะฐะทัะฒะฐะตััั `date`, ะะ `curDate`!
React.useEffect(() => {
  const sessionKey = 'heys_tab_opened_' + date;
  if (!sessionStorage.getItem(sessionKey)) {
    sessionStorage.setItem(sessionKey, '1');
    // ะะตะฑะพะปััะฐั ะทะฐะดะตัะถะบะฐ, ััะพะฑั ะฟะพะปัะทะพะฒะฐัะตะปั "ะพัะฒะพะธะปัั"
    setTimeout(() => setAdviceTrigger('tab_open'), 1500);
  }
}, [date]);

// ะขัะธะณะณะตั ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั ะฟัะพะดัะบัะฐ โ ัะตัะตะท CustomEvent
// โ๏ธ ะ MealAddProduct ะดะพะฑะฐะฒะธัั: window.dispatchEvent(new CustomEvent('heysProductAdded'));
React.useEffect(() => {
  const handleProductAdded = () => {
    // ะะฐะดะตัะถะบะฐ 500ms ััะพะฑั ะฟะพะปัะทะพะฒะฐัะตะปั ัะฒะธะดะตะป ัะตะทัะปััะฐั
    setTimeout(() => setAdviceTrigger('product_added'), 500);
  };
  window.addEventListener('heysProductAdded', handleProductAdded);
  return () => window.removeEventListener('heysProductAdded', handleProductAdded);
}, []);

// ะะพะปััะฐะตะผ ัะพะฒะตัั ัะตัะตะท ะผะพะดัะปั ั ััะธะณะณะตัะพะผ ะ uiState
const { primary, relevant, count: adviceCount, markShown } = 
  window.HEYS?.advice?.useAdviceEngine?.({
    dayTot, normAbs, optimum, day, pIndex, activeDays,
    trigger: adviceTrigger,
    uiState // <-- ะฟะตัะตะดะฐัะผ ัะพััะพัะฝะธะต UI
  }) || { primary: null, relevant: [], count: 0, markShown: () => {} };

// ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะพะบะฐะท/ัะบัััะธะต toast
React.useEffect(() => {
  if (primary && adviceTrigger) {
    // ะะพะบะฐะทัะฒะฐะตะผ toast
    setToastVisible(true);
    
    // Haptic feedback ะดะปั ะฒะฐะถะฝัั ัะพะฒะตัะพะฒ
    // โ๏ธ ะะะะะ: ะฟัะพะฒะตััะตะผ typeof, ะฝะต ะฟัะพััะพ truthy!
    if ((primary.type === 'achievement' || primary.type === 'warning') && typeof haptic === 'function') {
      haptic('light');
    }
    
    // ะัะทัะฒะฐะตะผ onShow
    if (primary.onShow) primary.onShow();
    
    // Confetti ะดะปั ะดะพััะธะถะตะฝะธะน (โ showConfetti ัััะตััะฒัะตั ะฝะฐ ัััะพะบะต 753!)
    if (primary.showConfetti) {
      setShowConfetti(true);
      if (typeof haptic === 'function') haptic('success');
      setTimeout(() => setShowConfetti(false), 2000);
    }
    
    // ะัะผะตัะฐะตะผ ะบะฐะบ ะฟะพะบะฐะทะฐะฝะฝัะน
    markShown(primary.id);
    
    // ะะฐะฟััะบะฐะตะผ ัะฐะนะผะตั ัะบัััะธั
    // โ๏ธ ะะะะะ: ะัะฟะพะปัะทัะตะผ toastTimeoutRef, ะะ toastTimerRef!
    if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
    toastTimeoutRef.current = setTimeout(() => {
      setToastVisible(false);
      setAdviceExpanded(false);
      setAdviceTrigger(null);
    }, primary.ttl || 5000);
  }
  
  return () => {
    if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
  };
}, [primary?.id, adviceTrigger]);

// ะกะฑัะพั advice state ะฟัะธ ัะผะตะฝะต ะดะฐัั
// โ๏ธ ะะะะะ: ะะตัะตะผะตะฝะฝะฐั ะฝะฐะทัะฒะฐะตััั `date`, ะะ `curDate`!
React.useEffect(() => {
  setAdviceTrigger(null);
  setAdviceExpanded(false);
  setToastVisible(false);
  // ะกะฑัะพั session ัััััะธะบะพะฒ
  if (window.HEYS?.advice?.resetSessionAdvices) {
    window.HEYS.advice.resetSessionAdvices();
  }
}, [date]);

// ะกะฑัะพั ะฟัะธ ะพัะบัััะธะธ ะผะพะดะฐะปะบะธ
React.useEffect(() => {
  if (uiState.modalOpen || uiState.searchOpen) {
    setAdviceTrigger(null);
    setAdviceExpanded(false);
    setToastVisible(false);
  }
}, [uiState.modalOpen, uiState.searchOpen]);

// ะะตะฝะดะตัะธะฝะณ toast (ัะพะปัะบะพ ะตัะปะธ visible)
// โ๏ธ ะะพะฑะฐะฒะปัะตะผ role="alert" ะดะปั accessibility ะธ haptic ะดะปั feedback
toastVisible && primary && React.createElement('div', { 
  className: `macro-toast macro-toast-${primary.type} ${adviceExpanded ? 'expanded' : ''} ${toastVisible ? 'visible' : ''}`,
  role: 'alert',
  'aria-live': 'polite',
  onClick: () => adviceCount > 1 && setAdviceExpanded(!adviceExpanded)
},
  // ะัะฝะพะฒะฝะพะน ัะพะฒะตั
  React.createElement('div', { className: 'macro-toast-main' },
    React.createElement('span', { className: 'macro-toast-icon' }, primary.icon),
    React.createElement('span', { className: 'macro-toast-text' }, primary.text),
    adviceCount > 1 && React.createElement('span', { 
      className: 'macro-toast-badge' 
    }, `+${adviceCount - 1}`)
  ),
  
  // ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะพะฒะตัั (ะฟัะธ ัะฐัะบัััะธะธ)
  adviceExpanded && React.createElement('div', { className: 'macro-toast-extras' },
    (relevant || []).slice(1, 4).map(advice => 
      React.createElement('div', { 
        key: advice.id,
        className: `macro-toast-extra macro-toast-extra-${advice.type}`
      },
        React.createElement('span', null, advice.icon),
        React.createElement('span', null, advice.text)
      )
    )
  )
)
```

### ะะฐะดะฐัะฐ 3: CSS ะดะปั Expandable Toast ั ะฐะฒัะพัะบัััะธะตะผ

**ะะดะต**: `apps/web/styles/main.css`

**โ๏ธ ะะะะะ**: ะะพะฑะฐะฒะธัั ะะะกะะ ัััะตััะฒัััะธั `.macro-toast-*` ััะธะปะตะน (ะฟะพัะปะต ัััะพะบะธ ~4935)

```css
/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   EXPANDABLE ADVICE TOAST WITH AUTO-HIDE
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */

/* ะะพะฒัะต ัะธะฟั toast */
.macro-toast-fiber {
  border-left: 4px solid #22c55e;
  background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
}

.macro-toast-tip {
  border-left: 4px solid #3b82f6;
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
}

.macro-toast-achievement {
  border-left: 4px solid #f59e0b;
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  animation: achievementPulse 0.5s ease-out;
}

@keyframes achievementPulse {
  0% { transform: translateX(-50%) scale(0.9); }
  50% { transform: translateX(-50%) scale(1.05); }
  100% { transform: translateX(-50%) scale(1); }
}

/* Dark theme ะดะปั ะฝะพะฒัั ัะธะฟะพะฒ */
[data-theme="dark"] .macro-toast-fiber {
  background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
  border-left-color: #10b981;
}

[data-theme="dark"] .macro-toast-tip {
  background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
  border-left-color: #3b82f6;
}

[data-theme="dark"] .macro-toast-achievement {
  background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
  border-left-color: #f59e0b;
}

/* ะะฐะทะพะฒัะต ะผะพะดะธัะธะบะฐัะธะธ ะดะปั ัะฐััะธััะตะผะพะณะพ toast */
.macro-toast {
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
}

.macro-toast.expanded {
  bottom: 90px;
  max-height: 300px;
  border-radius: 16px;
}

.macro-toast-main {
  display: flex;
  align-items: center;
  gap: 10px;
}

.macro-toast-badge {
  background: rgba(255, 255, 255, 0.3);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  margin-left: auto;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.macro-toast-extras {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
  animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.macro-toast-extra {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  font-size: 13px;
}

.macro-toast-extra-warning { background: rgba(239, 68, 68, 0.2); }
.macro-toast-extra-achievement { background: rgba(234, 179, 8, 0.2); }
.macro-toast-extra-tip { background: rgba(59, 130, 246, 0.2); }
.macro-toast-extra-fiber { background: rgba(34, 197, 94, 0.2); }

/* Mobile: ะพะณัะฐะฝะธัะธะฒะฐะตะผ ัะธัะธะฝั ะธ ะฒััะพัั */
@media (max-width: 480px) {
  .macro-toast {
    max-width: calc(100vw - 24px);
    font-size: 13px;
  }
  
  .macro-toast.expanded {
    max-height: 250px;
    overflow-y: auto;
  }
  
  .macro-toast-extras {
    max-height: 150px;
    overflow-y: auto;
  }
  
  .macro-toast-extra {
    font-size: 12px;
    padding: 6px 10px;
  }
}

/* Accessibility: ัะพะปั alert ะดะปั screen readers */
.macro-toast[role="alert"] {
  /* ะกัะธะปะธ ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ */
}
```

### ะะฐะดะฐัะฐ 4: ะะฝัะตะณัะฐัะธั ะฒ DayTab

**ะะดะต**: `apps/web/heys_day_v12.js` ะธ `apps/web/index.html`

#### 4.1 ะะพะฑะฐะฒะธัั ัะบัะธะฟั ะฒ index.html

**ะะะะะ** `heys_day_v12.js` (ะฝะฐะนัะธ ัััะพะบั ั `heys_day_v12.js` ะธ ะดะพะฑะฐะฒะธัั ะะะะะ ะฝะตะน):
```html
<script defer src="heys_advice_v1.js?v=1" fetchpriority="low"></script>
```

#### 4.2 ะะพะฑะฐะฒะธัั dispatch event ะฟัะธ ะดะพะฑะฐะฒะปะตะฝะธะธ ะฟัะพะดัะบัะฐ

**ะะดะต**: ะะฐะนัะธ ะผะตััะพ ะฒ MealAddProduct ะณะดะต ะฟัะพะดัะบั ะดะพะฑะฐะฒะปัะตััั ะฒ meal.items

**ะะพะธัะบ**: `setDay(prev =>` ะฒะฝัััะธ ััะฝะบัะธะธ ะดะพะฑะฐะฒะปะตะฝะธั ะฟัะพะดัะบัะฐ

**ะะพะฑะฐะฒะธัั ะะะกะะ ััะฟะตัะฝะพะณะพ setDay**:
```javascript
// Dispatch event ะดะปั advice ัะธััะตะผั
window.dispatchEvent(new CustomEvent('heysProductAdded'));
```

#### 4.3 ะ DayTab:
1. ะะพะฑะฐะฒะธัั ัะพััะพัะฝะธะต `const [adviceExpanded, setAdviceExpanded] = React.useState(false);` (~ัััะพะบะฐ 708)
2. ะะพะฑะฐะฒะธัั ัะพััะพัะฝะธะต `const [adviceTrigger, setAdviceTrigger] = React.useState(null);`
3. ะะพะฑะฐะฒะธัั listener ะดะปั `heysProductAdded` event (ัะผ. ะะฐะดะฐัะฐ 2)
4. ะัะทะฒะฐัั `useAdviceEngine` ั ะฝัะถะฝัะผะธ ะฟะฐัะฐะผะตััะฐะผะธ
5. ะะพะฑะฐะฒะธัั useEffect ะดะปั ะฟะพะบะฐะทะฐ toast (ัะผ. ะะฐะดะฐัะฐ 2)
6. ะะฐะผะตะฝะธัั ัะตะฝะดะตัะธะฝะณ toast ะฝะฐ expandable ะฒะตััะธั
7. **ะฃะดะฐะปะธัั ััะฐััะน macroTip useMemo** (~ัััะพะบะธ 2653-2698) โ ะปะพะณะธะบะฐ ัะตะฟะตัั ะฒ ะผะพะดัะปะต
8. **ะฃะดะฐะปะธัั ััะฐััะน useEffect ะดะปั macroTip** (~ัััะพะบะธ 2700-2724)

#### 4.4 ะะฐะบัััะธะต ะฟัะธ ะพัะบัััะธะธ ะผะพะดะฐะปะพะบ

```javascript
// ะ ะพะฑัะฐะฑะพััะธะบะฐั ะพัะบัััะธั ะผะพะดะฐะปะพะบ ะดะพะฑะฐะฒะธัั:
setAdviceExpanded(false);
```

---

## โ Definition of Done

### Pre-flight (ะะะะะ ะฝะฐัะฐะปะพะผ)
- [ ] ะัะพะฒะตัะธัั ััะพ ะฑะฐะณ `prot/protein` ะธัะฟัะฐะฒะปะตะฝ (ัััะพะบะฐ 2654 ะฒ heys_day_v12.js)
- [ ] ะัะปะธ ะฝะต ะธัะฟัะฐะฒะปะตะฝ โ ะธัะฟัะฐะฒะธัั ะฒัััะฝัั (ัะผ. ัะตะบัะธั "ะะะะขะะงะะกะะะ ะะะะะฃะกะะะะะ")

### Core Engine
- [ ] ะกะพะทะดะฐะฝ `apps/web/heys_advice_v1.js` ั ะดะฒะธะถะบะพะผ ัะพะฒะตัะพะฒ
- [ ] ะัะต ะฟัะฐะฒะธะปะฐ ะธะผะตัั `triggers[]` ะธ `ttl`
- [ ] ะะพะฑะฐะฒะปะตะฝ ััะตะบะตั ะฟะพะบะฐะทะฐะฝะฝัั ัะพะฒะตัะพะฒ (sessionStorage)
- [ ] Cooldown 30 ัะตะบ ะผะตะถะดั ะฟะพะบะฐะทะฐะผะธ
- [ ] MAX_ADVICES_PER_SESSION = 10
- [ ] Guard ะดะปั ะฟัััะพะณะพ ะดะฝั (kcal < 10 && mealCount === 0)

### ๐ง Smart Timing (Deep Psychology)
- [ ] `getToneForHour()` โ ะฐะดะฐะฟัะฐัะธั ัะพะฝะฐ ะฟะพ ะฒัะตะผะตะฝะธ
- [ ] `getEmotionalState()` โ ะพะฟัะตะดะตะปะตะฝะธะต ัะพััะพัะฝะธั (stressed, crashed, success)
- [ ] `getSpecialDay()` โ ะพัะพะฑัะต ะดะฝะธ (ะฟะพะฝะตะดะตะปัะฝะธะบ, ะฟััะฝะธัะฐ, ะะพะฒัะน ะณะพะด)
- [ ] `isUserBusy()` โ ะฟัะพะฒะตัะบะฐ ะทะฐะฝััะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปั
- [ ] `filterByEmotionalState()` โ ัะฑะธัะฐัั warnings ะฟัะธ ัััะตััะต/ัััะฒะต
- [ ] ะะพััั (23:00-6:00) โ ะะะะะะะฅ ัะพะฒะตัะพะฒ (tone === 'silent')

### UI Integration (ะฒ heys_day_v12.js)
- [ ] ะกะบัะธะฟั ะดะพะฑะฐะฒะปะตะฝ ะฒ `index.html` ะะะะะ `heys_day_v12.js`
- [ ] ะะพะฑะฐะฒะปะตะฝ `heysProductAdded` CustomEvent dispatch ะฒ MealAddProduct
- [ ] ะะพะฑะฐะฒะปะตะฝ event listener ะดะปั `heysProductAdded` ะฒ DayTab
- [ ] ะะพะฑะฐะฒะปะตะฝั ัะพััะพัะฝะธั: `adviceTrigger`, `adviceExpanded`
- [ ] ะัะฟะพะปัะทัะตััั `date` (ะะ curDate!)
- [ ] ะัะฟะพะปัะทัะตััั `toastTimeoutRef` (ะะ toastTimerRef!)
- [ ] `uiState` ัะพะฑะธัะฐะตั ะะกะ picker'ั (ะฒะบะปััะฐั showTrainingPicker)
- [ ] ะะตัะตะดะฐัะฐ `uiState` ะฒ useAdviceEngine
- [ ] ะะฐะดะตัะถะบะฐ ะฟะพะบะฐะทะฐ ะฟะพัะปะต ะดะตะนััะฒะธั (500ms product_added, 1500ms tab_open)
- [ ] ะกะฑัะพั ะฟัะธ ะพัะบัััะธะธ ะผะพะดะฐะปะบะธ/ะฟะพะธัะบะฐ
- [ ] Expandable Toast UI + ะฐะฒัะพัะบัััะธะต ะฟะพ TTL
- [ ] CSS ะฐะฝะธะผะฐัะธะธ ะฟะพัะฒะปะตะฝะธั/ะธััะตะทะฝะพะฒะตะฝะธั

### ะกะพะฒะตัั ะฟะพ ัะพััะพัะฝะธัะผ
- [ ] `crash_support` โ ะฟะพะดะดะตัะถะบะฐ ะฟัะธ ัััะฒะต (>150% ะบะบะฐะป)
- [ ] `stress_support` โ ะฟะพะดะดะตัะถะบะฐ ะฟัะธ ะฝะธะทะบะพะผ mood
- [ ] `monday_motivation` โ ะฟะพะฝะตะดะตะปัะฝะธะบ ัััะพ
- [ ] `friday_reminder` โ ะฟััะฝะธัะฐ ะฒะตัะตั
- [ ] `sunday_planning` โ ะฒะพัะบัะตัะตะฝัะต ะฒะตัะตั

### Cleanup
- [ ] macroTip useMemo ะฃะะะะะ (ะฒัั ะปะพะณะธะบะฐ ะฒ ะผะพะดัะปะต)
- [ ] ะกัะฐััะต useEffect ะดะปั toast ะฃะะะะะะซ (ัััะพะบะธ 2700-2730)
- [ ] `pnpm type-check && pnpm build` ะฟัะพัะพะดะธั

---

## ๐ซ ะะ ะะะะะขะฌ

- โ ะัะดะตะปัะฝัั fixed ะฟะฐะฝะตะปั (ะบะพะฝัะปะธะบั z-index ั ะผะพะดะฐะปะบะฐะผะธ)
- โ Side effects ะฒ useMemo (React Strict Mode)
- โ ะะฐะฒะธัะธะผะพััั ะพั window.fmtDate (ะธัะฟะพะปัะทะพะฒะฐัั inline formatDate)
- โ ะะตัะตััะปะพะถะฝััั โ ััะพ ะฝะต AI engine
- โ ะะพะฑะฐะฒะปััั ะฟะตััะธััะตะฝัะฝะพััั ัะพะฒะตัะพะฒ ะฒ localStorage
- โ ะะตะปะฐัั ัะพะฒะตัั ะบะปะธะบะฐะฑะตะปัะฝัะผะธ ั ะดะตะนััะฒะธัะผะธ (ะฟะพะบะฐ)
- โ ะะพะฑะฐะฒะปััั ะทะฒัะบะธ/ะฒะธะฑัะฐัะธั
- โ ะกะพะทะดะฐะฒะฐัั ะพัะดะตะปัะฝัั ะฒะบะปะฐะดะบั ัะพะฒะตัะพะฒ
- โ ะัะฟะพะปัะทะพะฒะฐัั `curDate` โ ะฟัะฐะฒะธะปัะฝะพ `date`
- โ ะัะฟะพะปัะทะพะฒะฐัั `toastTimerRef` โ ะฟัะฐะฒะธะปัะฝะพ `toastTimeoutRef`

---

## ๐ฎ ะัะดััะธะต ัะปัััะตะฝะธั (ะฝะต ะฒ ััะพะผ ะฟัะพะผะฟัะต)

1. **Daily Summary** โ ะธัะพะณะธ ะดะฝั ะฒะตัะตัะพะผ (ะฟะพัะปะต 21:00)
2. **ะะตััะพะฝะฐะปะธะทะฐัะธั** โ ัััั ะฟัะตะดะฟะพััะตะฝะธะน ะฟะพะปัะทะพะฒะฐัะตะปั
3. **ะขัะตะฝะดั** โ ัะพะฒะตัั ะฝะฐ ะพัะฝะพะฒะต ะดะธะฝะฐะผะธะบะธ ะฒะตัะฐ/ะบะฐะปะพัะธะน
4. **ะะธะบัะพะฝัััะธะตะฝัั** โ ะบะพะณะดะฐ ะดะพะฑะฐะฒะธะผ ะดะฐะฝะฝัะต ะฟะพ ะฒะธัะฐะผะธะฝะฐะผ
5. **Inline ัะพะฒะตัั** โ ะฟะพะบะฐะท ััะดะพะผ ั ัะพะพัะฒะตัััะฒัััะธะผะธ ะดะฐะฝะฝัะผะธ (ัะพะฒะตั ะพ ะฑะตะปะบะต โ ััะดะพะผ ั ะบะฐััะพัะบะพะน ะฑะตะปะบะฐ)

---

## ๐ ะกะฒัะทั ั ะฟะตัะฒัะผ ะฟัะพะผะฟัะพะผ

**ะะฐะฒะธัะธะผะพััั**: ะญัะพั ะฟัะพะผะฟั ััะตะฑัะตั ะฒัะฟะพะปะฝะตะฝะธั [2025-11-28-smart-toast-recommendations.md](./2025-11-28-smart-toast-recommendations.md) ัะฝะฐัะฐะปะฐ:
- ะะตัะฒัะน ะฟัะพะผะฟั: ะฑะฐะณัะธะบั `prot/protein` + ัะฐััะธัะตะฝะธะต CSS ัะธะฟะพะฒ toast
- ะญัะพั ะฟัะพะผะฟั: ะผะพะดัะปั ัะพะฒะตัะพะฒ + expandable UI

**ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะพะฑะพะธั**: macroTip useMemo ะฟะพะปะฝะพัััั ัะดะฐะปัะตััั, ะฒัั ะปะพะณะธะบะฐ ะฒ `heys_advice_v1.js`

---

**ะัะตะผั**: ~2-3 ัะฐัะฐ
**ะกะปะพะถะฝะพััั**: ะกัะตะดะฝัั
**ะะฐะฒะธัะธะผะพััะธ**: ะัะฟะพะปะฝะธัั ัะฝะฐัะฐะปะฐ 2025-11-28-smart-toast-recommendations.md
