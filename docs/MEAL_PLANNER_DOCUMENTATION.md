# HEYS Meal Planner โ ะขะตัะฝะธัะตัะบะฐั ะดะพะบัะผะตะฝัะฐัะธั

> **ะะตััะธั**: v4.0.4 | **ะะฐัะฐ**: 2026-02-19 | **ะกัะฐััั**: Production

## ะะณะปะฐะฒะปะตะฝะธะต

1. [ะะฑะทะพั ัะธััะตะผั](#1-ะพะฑะทะพั-ัะธััะตะผั)
2. [ะััะธัะตะบัััะฐ ะธ ะผะพะดัะปะธ](#2-ะฐััะธัะตะบัััะฐ-ะธ-ะผะพะดัะปะธ)
3. [ะะพะดัะปั 1: Meal Recommender (ะัะบะตัััะฐัะพั)](#3-ะผะพะดัะปั-1-meal-recommender-ะพัะบะตัััะฐัะพั)
4. [ะะพะดัะปั 2: Meal Planner (ะะปะฐะฝะธัะพะฒัะธะบ ัะฐะนะผะปะฐะนะฝะฐ)](#4-ะผะพะดัะปั-2-meal-planner-ะฟะปะฐะฝะธัะพะฒัะธะบ-ัะฐะนะผะปะฐะนะฝะฐ)
5. [ะะพะดัะปั 3: Product Picker (ะกะบะพัะธะฝะณ ะฟัะพะดัะบัะพะฒ)](#5-ะผะพะดัะปั-3-product-picker-ัะบะพัะธะฝะณ-ะฟัะพะดัะบัะพะฒ)
6. [ะะพะดัะปั 4: Pattern Integration (ะะฐััะตัะฝั)](#6-ะผะพะดัะปั-4-pattern-integration-ะฟะฐััะตัะฝั)
7. [ะะพะดัะปั 5: Feedback Loop (ML-ะพะฑััะตะฝะธะต)](#7-ะผะพะดัะปั-5-feedback-loop-ml-ะพะฑััะตะฝะธะต)
8. [ะะพะดัะปั 6: Meal Rec Feedback (ะกะฑะพั ะพัะตะฝะพะบ)](#8-ะผะพะดัะปั-6-meal-rec-feedback-ัะฑะพั-ะพัะตะฝะพะบ)
9. [ะะฐััะฝะฐั ะฑะฐะทะฐ](#9-ะฝะฐััะฝะฐั-ะฑะฐะทะฐ)
10. [Pipeline: ะพั ะทะฐะฟัะพัะฐ ะดะพ ะบะฐััะพัะบะธ](#10-pipeline-ะพั-ะทะฐะฟัะพัะฐ-ะดะพ-ะบะฐััะพัะบะธ)
11. [ะคะพัะผะฐั ะดะฐะฝะฝัั ะธ ะผะพะดะตะปั](#11-ัะพัะผะฐั-ะดะฐะฝะฝัั-ะธ-ะผะพะดะตะปั)
12. [UX-ะธะฝัะตะณัะฐัะธั](#12-ux-ะธะฝัะตะณัะฐัะธั)
13. [FAQ ะธ edge-cases](#13-faq-ะธ-edge-cases)

---

## 1. ะะฑะทะพั ัะธััะตะผั

**HEYS Meal Planner** โ ะธะฝัะตะปะปะตะบััะฐะปัะฝะฐั ัะธััะตะผะฐ ัะตะบะพะผะตะฝะดะฐัะธะน ะธ ะฟะปะฐะฝะธัะพะฒะฐะฝะธั
ะฟัะธัะผะพะฒ ะฟะธัะธ, ัะฐะฑะพัะฐััะฐั ัะตะปะธะบะพะผ ะฝะฐ ะบะปะธะตะฝัะต (browser). ะกะธััะตะผะฐ ะฐะฝะฐะปะธะทะธััะตั
ัะตะบััะธะน ะบะพะฝัะตะบัั ะฟะพะปัะทะพะฒะฐัะตะปั (ััะตะดะตะฝะฝะพะต, ะพััะฐะฒัะธะนัั ะฑัะดะถะตั ะบะฐะปะพัะธะน, ะฒัะตะผั
ัััะพะบ, ะฟะฐััะตัะฝั ะฟะพะฒะตะดะตะฝะธั) ะธ ะณะตะฝะตัะธััะตั ะฟะตััะพะฝะฐะปัะฝัะต ัะตะบะพะผะตะฝะดะฐัะธะธ ยซััะพ ััะตััั
ัะปะตะดัััะธะผยป.

### ะะปััะตะฒัะต ะฒะพะทะผะพะถะฝะพััะธ

- **9 ะบะพะฝัะตะบััะฝัั ััะตะฝะฐัะธะตะฒ** โ ะพั ยซัะตะปั ะดะพััะธะณะฝััะฐยป ะดะพ ยซัััะตััะพะฒะฐั ะตะดะฐยป
- **14-ัะฐะบัะพัะฝัะน ัะบะพัะธะฝะณ ะฟัะพะดัะบัะพะฒ** โ ะผะฐะบัะพ-ะฒััะฐะฒะฝะธะฒะฐะฝะธะต (49%), ะบะพะฝัะตะบััะฝัะต
  ัะฐะบัะพัั, ML-ะบะพััะตะบัะธั
- **ะะฐััะฝะพ-ะพะฑะพัะฝะพะฒะฐะฝะฝะพะต ะฟะปะฐะฝะธัะพะฒะฐะฝะธะต** โ 8 ะฝะฐััะฝัั ัะฟัะธะฝัะพะฒ (S1โS8) ั ัะธัะฐัะธัะผะธ
- **ะะฝััะปะธะฝะพะฒะฐั ะฒะพะปะฝะฐ** โ ัััั ัะตะบััะตะน ะฒะพะปะฝั ะธ ะพะบะฝะฐ ะถะธัะพัะถะธะณะฐะฝะธั
- **15 ะฟะพะฒะตะดะตะฝัะตัะบะธั ะฟะฐััะตัะฝะพะฒ** โ 3 ัะฐะทั ะณะปัะฑะพะบะพะณะพ ะฐะฝะฐะปะธะทะฐ (Phase A/B/C)
- **ML Feedback Loop** โ EMA-ะพะฑััะตะฝะธะต ะฝะฐ ะพัะฝะพะฒะต ๐/๐ ะพั ะฟะพะปัะทะพะฒะฐัะตะปั
- **ะคะตะฝะพัะธะฟะธัะตัะบะฐั ะฐะดะฐะฟัะฐัะธั** โ ะบะพััะตะบัะธั ะผะฐะบัะพัะพะฒ ะฟะพ ะผะตัะฐะฑะพะปะธัะตัะบะพะผั ัะตะฝะพัะธะฟั

### ะะฐัััะฐะฑ ะบะพะดะพะฒะพะน ะฑะฐะทั

| ะะพะดัะปั             | ะคะฐะนะป                      | LOC       | ะะตััะธั |
| ------------------ | ------------------------- | --------- | ------ |
| ะัะบะตัััะฐัะพั        | `pi_meal_recommender.js`  | 1874      | v3.5.0 |
| ะะปะฐะฝะธัะพะฒัะธะบ        | `pi_meal_planner.js`      | 942       | v2.1.0 |
| ะกะบะพัะธะฝะณ            | `pi_product_picker.js`    | 1325      | v4.0.4 |
| ะะฐััะตัะฝั           | `pi_meal_rec_patterns.js` | 686       | v3.0   |
| Feedback Loop (ML) | `pi_feedback_loop.js`     | 481       | v1.1   |
| Feedback (ะพัะตะฝะบะธ)  | `pi_meal_rec_feedback.js` | 535       | v1.1.0 |
| UI-ะบะฐััะพัะบะฐ        | `pi_ui_meal_rec_card.js`  | 1645      | v27.8  |
| **ะัะพะณะพ**          |                           | **~7500** |        |

---

## 2. ะััะธัะตะบัััะฐ ะธ ะผะพะดัะปะธ

### ะะธะฐะณัะฐะผะผะฐ ะฟะพัะพะบะฐ ะดะฐะฝะฝัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        UI: Meal Rec Card                        โ
โ                    (pi_ui_meal_rec_card.js)                      โ
โ  ะะฐัััะธัะฐัั โ ะะพะบะฐะทะฐัั โ ๐/๐ โ ะกะปะตะดัััะธะน ะฟัะธัะผ                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ trigger
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               ะะะะะกะขะะะขะะ: Meal Recommender                      โ
โ                  (pi_meal_recommender.js)                         โ
โ                                                                   โ
โ  1. analyzeCurrentContext() โ ะกัะตะฝะฐัะธะน                           โ
โ  2. loadPatternHints() โ 12 ะฟะฐััะตัะฝะพะฒ (Phase A/B/C)             โ
โ  3. calculateOptimalTiming() โ ะะพะณะดะฐ ะตััั                        โ
โ  4. calculateOptimalMacros() โ ะฆะตะปะตะฒัะต ะผะฐะบัะพัั                   โ
โ  5. generateSmartMealSuggestions() โ ะัะพะดัะบัั                    โ
โ  6. Confidence + Reasoning                                       โ
โโโโฌโโโโโโโโโโโโโฌโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ            โ            โ
   โผ            โผ            โผ
โโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โPlannerโ  โ Patterns โ  โProduct Pickerโ
โ(ะฟะปะฐะฝ) โ  โ(ะฟะฐััะตัะฝั)โ  โ  (ัะบะพัะธะฝะณ)   โ
โโโโฌโโโโ  โโโโโโฌโโโโโโ  โโโโโโโโฌโโโโโโโโ
   โ           โ               โ
   โ           โ               โผ
   โ           โ        โโโโโโโโโโโโโโโโ
   โ           โ        โFeedback Loop โ
   โ           โ        โ  (ML ะฒะตัะฐ)   โ
   โ           โ        โโโโโโโโโโโโโโโโ
   โ           โ
   โผ           โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ   Insulin Wave       โ
โ   (ะฒะฝะตัะฝะธะน ะผะพะดัะปั)   โ
โโโโโโโโโโโโโโโโโโโโโโโโ
```

### Namespace ะธ ัะตะณะธัััะฐัะธั

ะัะต ะผะพะดัะปะธ ัะตะณะธัััะธัััััั ะบะฐะบ IIFE ะฝะฐ ะณะปะพะฑะฐะปัะฝะพะผ ะพะฑัะตะบัะต
`window.HEYS.InsightsPI`:

```javascript
HEYS.InsightsPI.mealRecommender; // ะัะบะตัััะฐัะพั
HEYS.InsightsPI.mealPlanner; // ะะปะฐะฝะธัะพะฒัะธะบ ัะฐะนะผะปะฐะนะฝะฐ
HEYS.InsightsPI.productPicker; // ะกะบะพัะธะฝะณ ะฟัะพะดัะบัะพะฒ
HEYS.InsightsPI.mealRecPatterns; // ะะฐััะตัะฝั
HEYS.InsightsPI.feedbackLoop; // ML ะฒะตัะฐ (EMA)
HEYS.InsightsPI.mealRecFeedback; // ะกะฑะพั ะพัะตะฝะพะบ + cloud sync
```

---

## 3. ะะพะดัะปั 1: Meal Recommender (ะัะบะตัััะฐัะพั)

**ะคะฐะนะป**: `apps/web/insights/pi_meal_recommender.js` **ะะตััะธั**: v3.5.0 |
**LOC**: 1874

### 3.1 ะขะพัะบะฐ ะฒัะพะดะฐ: `recommendNextMeal()`

```javascript
recommendNextMeal(context, profile, pIndex, days);
```

**ะะฐัะฐะผะตััั:** | ะะฐัะฐะผะตัั | ะขะธะฟ | ะะฟะธัะฐะฝะธะต | |----------|-----|----------| |
`context` | Object | `{ dayTot, meals, normAbs, currentTime, remainingKcal }` |
| `profile` | Object | ะัะพัะธะปั ะฟะพะปัะทะพะฒะฐัะตะปั (`heys_profile`) | | `pIndex` |
Object | ะะฝะดะตะบั ะฟัะพะดัะบัะพะฒ (sharedProducts) | | `days` | Array | ะะฐััะธะฒ ะดะฝะตะฒะฝัั
ะดะฐะฝะฝัั ะทะฐ 30 ะดะฝะตะน |

**ะะพะทะฒัะฐัะฐะตั:**

```javascript
{
  scenario: 'PROTEIN_DEFICIT',     // ะะฟัะตะดะตะปัะฝะฝัะน ััะตะฝะฐัะธะน
  timing: { suggestedTime, ... },  // ะะพะณะดะฐ ะตััั
  macros: { protein, carbs, fat, kcal }, // ะฆะตะปะตะฒัะต ะผะฐะบัะพัั
  suggestions: { groups: [...] },  // ะะตะบะพะผะตะฝะดะพะฒะฐะฝะฝัะต ะฟัะพะดัะบัั
  confidence: 0.82,                // ะฃะฒะตัะตะฝะฝะพััั (0.0โ1.0)
  reasoning: ['...'],              // ะะฑัััะฝะตะฝะธั ะดะปั UI
  patternHints: { ... }            // ะัะฟะพะปัะทะพะฒะฐะฝะฝัะต ะฟะฐััะตัะฝั
}
```

### 3.2 ะะตัะตะฒะพ ััะตะฝะฐัะธะตะฒ `analyzeCurrentContext()`

9 ััะตะฝะฐัะธะตะฒ ั ะถัััะบะธะผ ะฟัะธะพัะธัะตัะพะผ (ะฟะพะฑะตะถะดะฐะตั ะฟะตัะฒัะน ััะฐะฑะพัะฐะฒัะธะน):

| #   | ะกัะตะฝะฐัะธะน          | ะฃัะปะพะฒะธะต                                        | ะะฟะธัะฐะฝะธะต                                       |
| --- | ----------------- | ---------------------------------------------- | ---------------------------------------------- |
| 1   | `GOAL_REACHED`    | `remainingKcal โค 50`                           | ะะฝะตะฒะฝะฐั ะฝะพัะผะฐ ะดะพััะธะณะฝััะฐ                       |
| 2   | `LIGHT_SNACK`     | `remainingKcal < 200`                          | ะััะฐัะพะบ ัะปะธัะบะพะผ ะผะฐะป ะดะปั ะฟะพะปะฝะพัะตะฝะฝะพะณะพ ะฟัะธัะผะฐ    |
| 3   | `PRE_WORKOUT`     | `workoutPlanned && hoursUntilWorkout โค 2`      | ะขัะตะฝะธัะพะฒะบะฐ ัะตัะตะท โค2 ัะฐัะฐ                       |
| 4   | `POST_WORKOUT`    | `recentWorkout && hoursSinceWorkout โค 2`       | ะะฝะฐะฑะพะปะธัะตัะบะพะต ะพะบะฝะพ (โค2ั ะฟะพัะปะต ััะตะฝะธัะพะฒะบะธ)      |
| 5   | `LATE_EVENING`    | `currentHour โฅ 21 && remainingKcal > 200`      | ะะพะทะดะฝะธะน ะฒะตัะตั ั ะฑะพะปััะธะผ ะพััะฐัะบะพะผ               |
| 6   | `STRESS_EATING`   | `stressLevel โฅ 7` (ะธะท check-in)                | ะะพะฒััะตะฝะฝัะน ัััะตัั โ ะฐะฝัะธะบะพััะธะทะพะปัะฝะฐั ัััะฐัะตะณะธั |
| 7   | `PROTEIN_DEFICIT` | `proteinRemaining / proteinTarget > 0.4`       | >40% ะฝะพัะผั ะฑะตะปะบะฐ ะพััะฐะปะพัั                      |
| 8   | `BALANCED`        | ะัะต ะพััะฐะปัะฝัะต ัะปััะฐะธ                           | ะกะฑะฐะปะฐะฝัะธัะพะฒะฐะฝะฝัะน ะฟัะธัะผ                         |
| โ   | `PRE_SLEEP`       | ะะฟัะตะดะตะปัะตััั Planner'ะพะผ ะฟัะธ `hoursToSleep โค 3` | ะะต ะดะตัะตะบัะธััะตััั Recommender'ะพะผ ะฝะฐะฟััะผัั       |

**ะัะธะพัะธัะตัะฝัะน ะฟะพััะดะพะบ ะบัะธัะธัะตัะบะธ ะฒะฐะถะตะฝ**: ะตัะปะธ ั ะฟะพะปัะทะพะฒะฐัะตะปั ะพะดะฝะพะฒัะตะผะตะฝะฝะพ
ัััะตัั (6) ะธ ะดะตัะธัะธั ะฑะตะปะบะฐ (7), ััะฐะฑะพัะฐะตั STRESS_EATING, ัะฐะบ ะบะฐะบ ั ะฝะตะณะพ
ะฟัะธะพัะธัะตั ะฒััะต.

### 3.3 ะะฐัััั ะพะฟัะธะผะฐะปัะฝะพะณะพ ะฒัะตะผะตะฝะธ `calculateOptimalTiming()`

```javascript
calculateOptimalTiming(context, scenario, patternHints);
```

**ะะฐะทะพะฒะฐั ะปะพะณะธะบะฐ:**

1. **ะะฝััะปะธะฝะพะฒะฐั ะฒะพะปะฝะฐ**: ะฑะตััััั ะธะท `HEYS.InsightsPI.insulinWave` โ ะฒัะตะผั
   ะพะบะพะฝัะฐะฝะธั ัะตะบััะตะน ะฒะพะปะฝั
2. **ะะบะฝะพ ะถะธัะพัะถะธะณะฐะฝะธั**: +30 ะผะธะฝ ะฟะพัะปะต ะฒะพะปะฝั (ะผะธะฝะธะผัะผ)
3. **ะะฐััะตัะฝ C01 (mealTiming)**: ะตัะปะธ score < 0.5 โ ัะดะฒะธะณ +20 ะผะธะฝ (ะฟะพะปัะทะพะฒะฐัะตะปั
   ัะบะปะพะฝะตะฝ ะบ ะฝะตัะตะณัะปััะฝะพะผั ะฟะธัะฐะฝะธั)
4. **ะะฐััะตัะฝ C02 (waveOverlap)**: ะตัะปะธ score < 0.5 โ ะตัั +20 ะผะธะฝ (ะฟะพะปัะทะพะฒะฐัะตะปั
   ัะฐััะพ ะตัั ะฝะฐ ะฟะธะบะต ะฒะพะปะฝั)

**ะะตะทัะปััะฐั**: `suggestedTime` ะฒ ัะพัะผะฐัะต `HH:MM` โ ัะตะบะพะผะตะฝะดัะตะผะพะต ะฒัะตะผั
ัะปะตะดัััะตะณะพ ะฟัะธัะผะฐ.

### 3.4 ะะฐัััั ัะตะปะตะฒัั ะผะฐะบัะพัะพะฒ `calculateOptimalMacros()`

ะขัะธ ััะพะฒะฝั ัะฐััััะฐ (ะบะฐะถะดัะน ัะปะตะดัััะธะน ััะพัะฝัะตั ะฟัะตะดัะดััะธะน):

#### ะฃัะพะฒะตะฝั 1: ะะฐะทะพะฒัะต ะผะฐะบัะพัั ะฟะพ ััะตะฝะฐัะธั

| ะกัะตะฝะฐัะธะน          | Kcal cap        | P / C / F       | ะะพะณะธะบะฐ                 |
| ----------------- | --------------- | --------------- | ---------------------- |
| `GOAL_REACHED`    | 0               | โ               | ะะตั ะฟัะธัะผะฐ ะฟะธัะธ        |
| `LIGHT_SNACK`     | โค150            | 30/40/30        | ะัะณะบะธะน ะฟะตัะตะบัั         |
| `LATE_EVENING`    | โค200            | 60/20/20        | ะะฐะทะตะธะฝ-ะพัะธะตะฝัะธัะพะฒะฐะฝะฝัะน |
| `PRE_WORKOUT`     | โค300            | 25/60/15        | ะัััััะต ัะณะปะตะฒะพะดั       |
| `POST_WORKOUT`    | โค400            | 40/45/15        | ะะฝะฐะฑะพะปะธัะตัะบะพะต ะพะบะฝะพ     |
| `PROTEIN_DEFICIT` | โค300            | 50/30/20        | ะะฐะบัะธะผัะผ ะฑะตะปะบะฐ         |
| `STRESS_EATING`   | โค250            | 30/40/30        | ะกะตัะพัะพะฝะธะฝ + omega-3    |
| `BALANCED`        | ะััะฐัะพะบ ะฑัะดะถะตัะฐ | ะัะพะฟะพััะธะพะฝะฐะปัะฝะพ | ะะฐะฒะฝะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต   |

#### ะฃัะพะฒะตะฝั 2: Last-Meal Override

ะะพะณะดะฐ `mealsRemaining === 1` (ะฟะพัะปะตะดะฝะธะน ะฟัะธัะผ ะทะฐ ะดะตะฝั):

```javascript
macros = {
  protein: remainingProtein * 0.9,
  carbs: remainingCarbs * 0.9,
  fat: remainingFat * 0.9,
  kcal: remainingKcal * 0.9,
};
```

ะะพัััะธัะธะตะฝั **0.9** (ะฐ ะฝะต 1.0) ะพััะฐะฒะปัะตั 10% ะฑััะตั ะฝะฐ ะฝะตัะพัะฝะพััั ะฟะพะดััััะฐ.

#### ะฃัะพะฒะตะฝั 3: Phase A/B ะผะพะดะธัะธะบะฐัะพัั

ะะฐััะตัะฝั ะบะพััะตะบัะธัััั ะฑะฐะทะพะฒัะต ะผะฐะบัะพัั:

| ะะฐััะตัะฝ                   | ะฃัะปะพะฒะธะต      | ะญััะตะบั                     |
| ------------------------- | ------------ | -------------------------- |
| C15 (insulinSensitivity)  | score < 0.45 | carbs ร 0.90, prot ร 1.08  |
| C35 (proteinDistribution) | score < 0.35 | prot ร 1.20                |
| C06 (sleepHunger)         | score < 0.50 | prot ร 1.12, carbs ร 0.92  |
| C14 (nutrientTiming)      | score < 0.50 | ะะพััะตะบัะธั ะฟะพ ะฒัะตะผะตะฝะธ ัััะพะบ |
| C12 (moodFood)            | score < 0.50 | carbs ร 1.05 (ัะตัะพัะพะฝะธะฝ)   |

#### Safety guard: R1/R3 Last-Meal Protection + P5 Protein Cap

ะะปั `isLastMeal` (ะฟะพัะปะตะดะฝะธะน ะฟัะธัะผ ะทะฐ ะดะตะฝั) ะผะฐะบัะพัั ัะฐัััะธััะฒะฐัััั ะบะฐะบ
`remainingProtein` (ัะตะฐะปัะฝัะน ะพััะฐัะพะบ), ะฐ **ะฝะต** `50% ร kcal`. ะญัะพ ะฟัะตะดะพัะฒัะฐัะฐะตั
ะฐะฑัััะดะฝัะต ะทะฝะฐัะตะฝะธั (359 ะณ ะฑะตะปะบะฐ).

**R3**: Phase A ะผะพะดะธัะธะบะฐัะพัั (C15 insulinSensitivity, C35 proteinDistribution)
**ะฝะต ะฟัะธะผะตะฝััััั** ะฟัะธ `isLastMeal`, ััะพะฑั ะฝะต ัััะณัะฑะปััั overflow:

```javascript
if (isLastMeal) {
  // R1: ะัะฟะพะปัะทัะตะผ remainingProtein ะฝะฐะฟััะผัั
  protein = remainingProtein * 0.9;
  // R3: C15/C35 boost ะะะะะฃะกะะะะขะกะฏ โ ะธะฝะฐัะต ัะตะฟะพัะบะฐ R1โC35โP5 cap
} else {
  // Phase A modifiers (C15, C35) ะฟัะธะผะตะฝััััั ัะพะปัะบะพ ะดะปั non-last meals
}

// P5: Safety cap ะฝะฐ 100ะณ ะฑะตะปะบะฐ ะฒ ะพะดะฝะพะผ ะฟัะธัะผะต (Areta 2013)
protein = Math.min(protein, 100);
```

### 3.5 ะะฐะณััะทะบะฐ ะฟะฐััะตัะฝะพะฒ `loadPatternHints()`

12 ะฟะฐััะตัะฝะพะฒ ะทะฐะณััะถะฐัััั ะฟะพ 3 ัะฐะทะฐะผ:

| ะคะฐะทะฐ  | ID  | ะะฐััะตัะฝ             | ะัะฟะพะปัะทัะตััั ะดะปั                     |
| ----- | --- | ------------------- | ------------------------------------ |
| **A** | C01 | mealTiming          | ะขะฐะนะผะธะฝะณ (+20 ะผะธะฝ ะฟัะธ ะฝะตัะตะณัะปััะฝะพััะธ) |
| **A** | C02 | waveOverlap         | ะขะฐะนะผะธะฝะณ (+20 ะผะธะฝ ะฟัะธ ะฝะฐะปะพะถะตะฝะธะธ)      |
| **A** | C15 | insulinSensitivity  | ะกะฝะธะถะตะฝะธะต ัะณะปะตะฒะพะดะพะฒ                   |
| **A** | C34 | glycemicLoad        | GL-ัะฐัะณะตั                            |
| **A** | C35 | proteinDistribution | ะะพะฒััะตะฝะธะต ะฑะตะปะบะฐ                      |
| **A** | C37 | addedSugar          | ะคะธะปัััะฐัะธั ัะฐัะฐัะฐ                    |
| **B** | C06 | sleepHunger         | ะะตะปะพะบ ะฟะตัะตะด ัะฝะพะผ                     |
| **B** | C14 | nutrientTiming      | ะฅัะพะฝะพะฟะธัะฐะฝะธะต                         |
| **B** | C10 | fiberRegularity     | ะะปะตััะฐัะบะฐ                            |
| **B** | C12 | moodFood            | ะฃะณะปะตะฒะพะดั ะดะปั ะฝะฐัััะพะตะฝะธั              |
| **C** | C26 | micronutrients      | ะะธะฝะตัะฐะปั                             |
| **C** | C29 | novaQuality         | NOVA-ัะธะปััั                          |

### 3.6 ะะตะฝะตัะฐัะธั ะฟัะพะดัะบัะพะฒ `generateSmartMealSuggestions()`

ะะตัะตะดะฐัั ะฒ Product Picker ะฟะพะปะฝัะน ะบะพะฝัะตะบัั:

```javascript
productPicker.generateProductSuggestions({
  scenario,
  remainingKcal,
  targetProteinG,
  targetCarbsG,
  targetFatG,
  idealGI,
  targetGL, // Ludwig 2002: 20 (ะดะตะฝั), 10 (ะฟัะต-ัะพะฝ)
  currentTime, // ะะปั ัะธะปัััะฐ ะบะพัะตะธะฝะฐ
  sugarDependencyRisk, // C37 ะฟะฐััะตัะฝ
  fiberRegularityScore, // C10 ะฟะฐััะตัะฝ
  micronutrientDeficits, // C26 ะฟะฐััะตัะฝ
  novaQualityScore, // C29 ะฟะฐััะตัะฝ
  sharedProducts,
  excludeProductIds, // ะะตะดัะฟะปะธะบะฐัะธั ะผะตะถะดั ะฟัะธัะผะฐะผะธ
  profile, // ะะปั ML feedback loop
});
```

ะัะธ **ะผัะปััะธ-ะฟัะธัะผะต** (ะธะท Planner'ะฐ) โ ะบะฐะถะดัะน ะฟัะธัะผ ะณะตะฝะตัะธััะตััั ะพัะดะตะปัะฝะพ ั
`excludeProductIds` ะพั ะฟัะตะดัะดััะธั, ััะพะฑั ะฝะต ะฟะพะฒัะพัััั ะฟัะพะดัะบัั.

### 3.7 S9: Auto-Detect Phenotype

ะัะธ ะฒัะทะพะฒะต `recommendNextMeal()`, ะตัะปะธ
`!profile.phenotype && days.length >= 30`, ัะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะทัะฒะฐะตั
`autoDetect()` ะธะท ะผะพะดัะปั ัะตะฝะพัะธะฟะพะฒ:

```javascript
if (!profile.phenotype && days.length >= 30) {
  const detected = HEYS.InsightsPI.phenotype.autoDetect(days, profile);
  if (detected) {
    profile.phenotype = detected;
    // โ enhanceRecommendation() ัะตะฟะตัั ะฟัะธะผะตะฝัะตั getPhenotypeAdjustedMacros()
  }
}
// ะะพะณ: phenotypeApplied: true/false
```

**ะขัะตะฑะพะฒะฐะฝะธั**: ะผะธะฝะธะผัะผ 30 ะดะฝะตะน ะดะฐะฝะฝัั ะดะปั ััะฐัะธััะธัะตัะบะพะน ะทะฝะฐัะธะผะพััะธ. ะะตะทัะปััะฐั
ะบะปะฐะดัััั ะฒ `profile.phenotype` ะธ ะธัะฟะพะปัะทัะตััั ะผะพะดัะปะตะผ Pattern Integration ะดะปั
ะบะพััะตะบัะธะธ ะผะฐะบัะพัะพะฒ.

---

## 4. ะะพะดัะปั 2: Meal Planner (ะะปะฐะฝะธัะพะฒัะธะบ ัะฐะนะผะปะฐะนะฝะฐ)

**ะคะฐะนะป**: `apps/web/insights/pi_meal_planner.js` **ะะตััะธั**: v2.1.0 | **LOC**:
942

### 4.1 ะะฐะทะฝะฐัะตะฝะธะต

ะะปะฐะฝะธััะตั **ะฒัะต ะพััะฐะฒัะธะตัั ะฟัะธัะผั ะดะพ ัะฝะฐ**: ัะบะพะปัะบะพ, ะบะพะณะดะฐ ะธ ั ะบะฐะบะธะผ ะฑัะดะถะตัะพะผ.
ะฃัะธััะฒะฐะตั ะธะฝััะปะธะฝะพะฒัั ะฒะพะปะฝั, ะพะบะฝะพ ะถะธัะพัะถะธะณะฐะฝะธั, ััะพะฝะพะฟะธัะฐะฝะธะต ะธ ะพะณัะฐะฝะธัะตะฝะธะต 900
kcal ะฝะฐ ะฟัะธัะผ.

### 4.2 ะขะพัะบะฐ ะฒัะพะดะฐ: `planRemainingMeals()`

```javascript
planRemainingMeals(context, profile, pIndex, days);
```

### 4.3 ะกะตะผะธัะฐะณะพะฒัะน ะฐะปะณะพัะธัะผ

```
ะจะฐะณ 1: ะะฝััะปะธะฝะพะฒะฐั ะฒะพะปะฝะฐ    โ waveEndTime
ะจะฐะณ 2: ะะบะฝะพ ะถะธัะพัะถะธะณะฐะฝะธั   โ fatBurnEnd = waveEnd + 30 ะผะธะฝ
ะจะฐะณ 3: ะะตะดะปะฐะนะฝ ัะฝะฐ          โ sleepTarget (ั hunger trade-off)
ะจะฐะณ 4: ะัะดะถะตั ะบะฐะปะพัะธะน       โ remainingBudget (ั ะผะธะฝะธะผัะผะฐะผะธ carbs/fat)
ะจะฐะณ 5: ะฆะธะบะป ัะฐะทะผะตัะตะฝะธั      โ meals[] (ั forceMultiMeal ะฟัะธ >900kcal)
ะจะฐะณ 6: ะะตัะตัะฐัะฟัะตะดะตะปะตะฝะธะต     โ S1 chrono + S2 MPS + S3 GL + S4 workout + S5 ัะพะฝ
ะจะฐะณ 7: ะัะพะณะพะฒัะน summary     โ { meals, mealCount, totalKcal, ... }
```

#### ะจะฐะณ 1: ะะฝััะปะธะฝะพะฒะฐั ะฒะพะปะฝะฐ

```javascript
// ะัะธะพัะธัะตั ะธััะพัะฝะธะบะพะฒ:
// 1. HEYS.InsightsPI.insulinWave.getWaveState() โ waveEndTime
// 2. Fallback: estimateWaveDuration(lastMeal) โ baseWave = 3.5ั
const waveEnd = insulinWave?.waveEndTime || lastMealTime + baseWave;
```

**`estimateWaveDuration()`**: ะพัะตะฝะบะฐ ะดะปะธัะตะปัะฝะพััะธ ะฒะพะปะฝั ะฟะพ ัะพััะฐะฒั ะฟะพัะปะตะดะฝะตะณะพ
ะฟัะธัะผะฐ:

- ะะพะปััะต ะถะธัะฐ โ +0.5ั (fat ร 0.02)
- ะะพะปััะต ะฑะตะปะบะฐ โ +0.3ั (prot ร 0.01)
- ะะพะปััะต kcal โ ร1.1
- Clamp: [2.0, 5.0] ัะฐัะพะฒ

#### ะจะฐะณ 2: ะะบะฝะพ ะถะธัะพัะถะธะณะฐะฝะธั

```javascript
const FAT_BURN_WINDOW_MIN = 30; // ะกัะฐะฝะดะฐัั
const FAT_BURN_REDUCED_MIN = 20; // ะัะธ forceMultiMeal (>900 kcal)
const fatBurnEnd = waveEnd + fatBurnWindow;
```

#### ะจะฐะณ 3: ะัะตะฝะบะฐ ะฒัะตะผะตะฝะธ ัะฝะฐ

**ะัะธะพัะธัะตั ะธััะพัะฝะธะบะพะฒ (ะพั ะปัััะตะณะพ ะบ ััะดัะตะผั):**

1. **Check-in `sleepStart`** โ ะดะฐะฝะฝัะต ะธะท ะฒะตัะตัะฝะตะณะพ ัะตะบ-ะธะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
2. **ะกัะตะดะฝะธะน ัะฐั ะฟะพัะปะตะดะฝะตะณะพ ะฟัะธัะผะฐ + 3ั** โ ัะฒัะธััะธะบะฐ ะธะท ะธััะพัะธะธ
3. **`profile.sleepTarget`** โ ะฝะฐัััะพะนะบะฐ ะฒ ะฟัะพัะธะปะต
4. **Fallback: 23:00**

**Sleep Target Clamp (Sprint 4 P4):**

ะัะตะผั ัะฝะฐ ะพะณัะฐะฝะธัะธะฒะฐะตััั ัะฐะทัะผะฝัะผ ะดะธะฐะฟะฐะทะพะฝะพะผ (22:00โ00:30), ััะพะฑั ะฟะพะทะดะฝะธะน ัะถะธะฝ
ะฝะต ะดะฐะฒะฐะป ะฐะฑัััะดะฝัะน `sleepTarget: "24:59"`:

```javascript
const sleepTargetClamped = Math.max(22.0, Math.min(24.5, sleepTarget));
// 22:00 โ 00:30 โ ัะฐะทัะผะฝัะน ะดะธะฐะฟะฐะทะพะฝ
```

**Hunger Trade-off (Kinsey & Ormsbee 2015):**

ะัะธ ะฑะพะปััะพะผ ะดะตัะธัะธัะต ะบะฐะปะพัะธะน ัะธััะตะผะฐ ัะพะบัะฐัะฐะตั ะฑััะตั ะดะพ ัะฝะฐ, ััะพะฑั ะฟะพะปัะทะพะฒะฐัะตะปั
ะผะพะณ ะตัั ะฟะพะตััั:

```javascript
const PRE_SLEEP_BUFFER_HOURS = 3;     // ะกัะฐะฝะดะฐัั

if (deficit โฅ 800 kcal) buffer = 1.5ั  // ะกะธะปัะฝัะน ะณะพะปะพะด โ ัะฐะทัะตัะฐะตะผ ะตััั ะฟะพะทะถะต
if (deficit โฅ 400 kcal) buffer = 2.0ั  // ะฃะผะตัะตะฝะฝัะน ะณะพะปะพะด
else                    buffer = 3.0ั  // ะกัะฐะฝะดะฐัั
```

#### ะจะฐะณ 4: ะะฐัััั ะฑัะดะถะตัะฐ

```javascript
const remainingBudget = normAbs.kcal - dayTot.kcal;

// ะะธะฝะธะผะฐะปัะฝัะต ะฟะพะปั (ััะพะฑั ะฝะต ะฑัะปะพ 0g ัะณะปะตะฒะพะดะพะฒ ะธะปะธ ะถะธัะพะฒ):
const carbFloor = remainingBudget * 0.2; // ะะธะฝ 20% ะบะฐะปะพัะธะน ะธะท ัะณะปะตะฒะพะดะพะฒ
const fatFloor = remainingBudget * 0.15; // ะะธะฝ 15% ะบะฐะปะพัะธะน ะธะท ะถะธัะพะฒ
```

#### ะจะฐะณ 5: ะฆะธะบะป ัะฐะทะผะตัะตะฝะธั ะฟัะธัะผะพะฒ

```javascript
const MAX_MEAL_KCAL = 900; // ะะพัะพะณ ะฟัะธะฝัะดะธัะตะปัะฝะพะณะพ ัะฐะทะดะตะปะตะฝะธั
const MAX_MEALS_LIMIT = 4; // ะะฐะบัะธะผัะผ ะฟัะธัะผะพะฒ ะทะฐ ะพััะฐะฒัะตะตัั ะฒัะตะผั

while (fitsAnotherMeal(currentTime, sleepTarget, waveEstimate)) {
  // ะัะพะฒะตัะบะฐ forceMultiMeal: ะตัะปะธ ะฑัะดะถะตั > 900 kcal โ ัะฐะทะฑะธะฒะฐะตะผ
  if (remainingBudget > MAX_MEAL_KCAL && meals.length === 0) {
    forceMultiMeal = true;
    fatBurnWindow = FAT_BURN_REDUCED_MIN; // 20 ะผะธะฝ ะฒะผะตััะพ 30
  }

  meals.push({
    time: currentTime,
    scenario: detectMealScenario(currentTime, sleepTarget, remainingBudget),
    budget: allocatedBudget,
  });

  currentTime += waveEstimateForMeal + fatBurnWindow;
}
```

**S8 Volume-Scaled Wave**: ะดะปะธัะตะปัะฝะพััั ะฒะพะปะฝั ะผะฐัััะฐะฑะธััะตััั ะฟะพ ะพะฑััะผั ะฟัะธัะผะฐ:

```javascript
// estimateWaveDuration ะฟะพะปััะฐะตั totalBudgetKcal ะดะปั sqrt-scaling
scaledWave = personalWave ร โ(mealKcal / totalBudgetKcal)
// Clamp: [0.7, 1.0] ะพั ะฑะฐะทะพะฒะพะน ะฒะพะปะฝั
```

ะะฐะปะตะฝัะบะธะน ะฟัะธัะผ โ ะบะพัะพัะต ะฒะพะปะฝะฐ โ ะฑััััะตะต ัะปะตะดัััะธะน ะฟัะธัะผ.

**forceMultiMeal gap fix (Sprint 7):** ะฟัะธ `forceMultiMeal` ะธัะฟะพะปัะทัะตััั
`min(wave, 2h)` gap ะฒะผะตััะพ `wave + fatBurn` (Louis-Sylvestre & Le Magnen, 1980).
Cursor ัะดะฒะธะณะฐะตััั ะฝะฐ `nextPossibleStart`, ะฐ ะฝะต ะฝะฐ `fatBurnEnd`. ะญัะพ ะพะฑะตัะฟะตัะธะฒะฐะตั
ัะตะฐะปัะฝะพะต ัะฐะทะฑะธะตะฝะธะต ะฝะฐ 2 ะฟัะธัะผะฐ ะฒะผะตััะพ ัะตะพัะตัะธัะตัะบะพะณะพ.

**S6 Adaptive Wave (ะธะท 14-ะดะฝะตะฒะฝะพะน ะธััะพัะธะธ):**

```javascript
estimatPersonalWaveHours(days);
// ะะตะดะธะฐะฝะฐ gap-ะพะฒ 2โ6ั ะธะท ะฟะพัะปะตะดะฝะธั 14 ะดะฝะตะน
// ะขัะตะฑัะตััั minimum 5 samples
// Fallback: DEFAULT_WAVE_ESTIMATE_HOURS = 3.5
```

#### ะจะฐะณ 6: ะะตัะตัะฐัะฟัะตะดะตะปะตะฝะธะต ะฑัะดะถะตัะพะฒ

**6a. ะะดะฐะฟัะธะฒะฝะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต ะฟะพ hoursToSleep:**

| ะัะธัะผะพะฒ | ะงะฐัะพะฒ ะดะพ ัะฝะฐ | ะะตัะฒัะน          | ะะพัะปะตะดะฝะธะน               |
| ------- | ------------ | --------------- | ----------------------- |
| 2       | > 4ั         | 60%             | 40%                     |
| 2       | 2โ4ั         | 70%             | 30%                     |
| 2       | < 2ั         | 75%             | 25%                     |
| 3+      | โ            | ะัะพะฟะพััะธะพะฝะฐะปัะฝะพ | ะะฐะถะดัะน ัะปะตะดัััะธะน ะผะตะฝััะต |

**6b. S1 Chrono-Nutrition Blend (Garaulet 2014):**

ะฅัะพะฝะพะฟะธัะฐะฝะธะต ะทะฐะดะฐัั ะธะดะตะฐะปัะฝัะต ะฟัะพะฟะพััะธะธ ะฟะพ ะฒัะตะผะตะฝะธ ัััะพะบ:

```javascript
const CHRONO_RATIOS = {
  MORNING: 0.33, // 33% ะดะฝะตะฒะฝัั ะบะฐะปะพัะธะน ัััะพะผ
  LUNCH: 0.38, // 38% ะฒ ะพะฑะตะด
  SNACK: 0.2, // 20% ะฟะตัะตะบัั
  EVENING: 0.28, // 28% ะฒะตัะตัะพะผ
};

// Blend: 30% chrono + 70% adaptive (ั monotonicity guard)
finalBudget = adaptiveBudget * 0.7 + chronoBudget * 0.3;
```

**Monotonicity guard**: ะณะฐัะฐะฝัะธััะตั ััะพ ะบะฐะถะดัะน ัะปะตะดัััะธะน ะฟัะธัะผ ะะ ะฑะพะปััะต
ะฟัะตะดัะดััะตะณะพ (ะธัะบะปััะตะฝะธะต: POST_WORKOUT).

**6c. S2 MPS Protein Boost (Areta 2013):**

```javascript
const MPS_PROTEIN_PER_KG = 0.4; // ะณ/ะบะณ ะฝะฐ ะฟัะธัะผ ะดะปั MPS
const MPS_CAP = 40; // cap ะฝะฐ ~40ะณ ะฑะตะปะบะฐ ะทะฐ ะฟัะธัะผ
meal.minProtein = Math.min(profile.weight * MPS_PROTEIN_PER_KG, MPS_CAP);
```

**6d. S3 GL Targets (Ludwig 2002):**

```javascript
meal.targetGL = isPreSleep ? 10 : 20;
// GL = GI ร carbs_portion / 100
```

**6e. S4 POST_WORKOUT Override (Ivy 2004):**

ะัะปะธ ะฟัะธัะผ ะฟะพะฟะฐะดะฐะตั ะฒ ะพะบะฝะพ ะฟะพัะปะต ััะตะฝะธัะพะฒะบะธ:

- ะะตัะตะฝะฐะทะฝะฐัะตะฝะธะต ััะตะฝะฐัะธั โ `POST_WORKOUT`
- Budget increase ะดะพ 400 kcal
- Carb ratio: 60%+

**6f. S5 Sleep-Friendly Categories (Halson 2014):**

ะะพัะปะตะดะฝะธะน ะฟัะธัะผ (ะฟัะธ `hoursToSleep โค 3`):

- ะกัะตะฝะฐัะธะน โ `PRE_SLEEP`
- ะะฐัะตะณะพัะธะธ โ DAIRY-first (ะบะฐะทะตะธะฝ)
- GL target โ 10

### 4.4 `detectMealScenario()` โ ะพะฟัะตะดะตะปะตะฝะธะต ััะตะฝะฐัะธั ะดะปั ะบะฐะถะดะพะณะพ ะฟัะธัะผะฐ

```javascript
function detectMealScenario(mealTime, sleepTarget, remainingBudget) {
  const hoursToSleep = (sleepTarget - mealTime) / 3600000;

  if (hoursToSleep <= 3) return 'PRE_SLEEP';
  if (remainingBudget < 200) return 'LIGHT_SNACK';
  if (isPostWorkout(mealTime)) return 'POST_WORKOUT'; // S4
  return 'BALANCED';
}
```

### 4.5 ะะพะฝััะฐะฝัั ะผะพะดัะปั

```javascript
const FAT_BURN_WINDOW_MIN = 30;
const FAT_BURN_REDUCED_MIN = 20; // ะัะธ forceMultiMeal
const PRE_SLEEP_BUFFER_HOURS = 3;
const DEFAULT_WAVE_ESTIMATE_HOURS = 3.5;
const MAX_MEAL_KCAL = 900;
const MAX_MEALS_LIMIT = 4;
const CHRONO_RATIOS = { MORNING: 0.33, LUNCH: 0.38, SNACK: 0.2, EVENING: 0.28 };
const MPS_PROTEIN_PER_KG = 0.4; // Areta 2013
const MPS_CAP = 40; // g
const GL_TARGET_DAY = 20; // Ludwig 2002
const GL_TARGET_PRESLEEP = 10;
```

---

## 5. ะะพะดัะปั 3: Product Picker (ะกะบะพัะธะฝะณ ะฟัะพะดัะบัะพะฒ)

**ะคะฐะนะป**: `apps/web/insights/pi_product_picker.js` **ะะตััะธั**: v4.0.4 | **LOC**:
1325

### 5.1 14-ัะฐะบัะพัะฝัะน ัะบะพัะธะฝะณ

ะะฐะถะดัะน ะฟัะพะดัะบั ะพัะตะฝะธะฒะฐะตััั ะฟะพ 14 ัะฐะบัะพัะฐะผ (0โ100 ะฑะฐะปะปะพะฒ ะบะฐะถะดัะน), ะบะพัะพััะต
ััะผะผะธัััััั ั ะฒะตัะฐะผะธ `SCORING_WEIGHTS` (ััะผะผะฐ = 1.00):

#### ะััะฟะฟะฐ 1: ะะฐะบัะพ-ะฒััะฐะฒะฝะธะฒะฐะฝะธะต (49%)

| #   | ะคะฐะบัะพั             | ะะตั      | ะคะพัะผัะปะฐ                                             |
| --- | ------------------ | -------- | --------------------------------------------------- | -------------------------- | ------ |
| 1   | `proteinAlignment` | **0.25** | `100 -                                              | prodProtEn% - idealProtEn% | ร 2.0` |
| 2   | `carbAlignment`    | **0.14** | `100 -                                              | prodCarbEn% - idealCarbEn% | ร 2.0` |
| 3   | `fatAlignment`     | **0.10** | `100 -                                              | prodFatEn% - idealFatEn%   | ร 1.5` |
| 4   | `kcalFit`          | **0.10** | Soft linear: โค0.8 ratio โ 100; 0.8โ1.2 โ linear โ 0 |

**Atwater TEF-adjusted**:

- ะะตะปะพะบ: **3 kcal/g** (TEF ~25%, Livesey 2001)
- ะฃะณะปะตะฒะพะดั: **4 kcal/g**
- ะะธัั: **9 kcal/g**

**ะะดะตะฐะปัะฝัะต ะฟัะพัะธะปะธ ะฟะพ ััะตะฝะฐัะธั (SCENARIO_IDEAL_MACRO_PROFILES, Energy%):**

| ะกัะตะฝะฐัะธะน             | ะะตะปะพะบ% | ะฃะณะปะตะฒะพะดั% | ะะธัั% |
| -------------------- | ------ | --------- | ----- |
| `PROTEIN_DEFICIT`    | 45     | 15        | 40    |
| `STRESS_EATING`      | 40     | 20        | 40    |
| `POST_WORKOUT`       | 25     | 55        | 20    |
| `PRE_SLEEP`          | 35     | 15        | 50    |
| `LATE_EVENING`       | 35     | 20        | 45    |
| `LIGHT_SNACK`        | 25     | 40        | 35    |
| `BALANCED` / Default | 30     | 40        | 30    |

**ะัะธะผะตั ัะฐััััะฐ:**

- ะััะธะฝะฐั ะณััะดะบะฐ: ~58% protein Energy, ~0% carb, ~42% fat
- ะกัะตะฝะฐัะธะน PROTEIN_DEFICIT (ideal: P45/C15/F40)
- proteinAlignment: 100 - |58-45| ร 2 = 74
- carbAlignment: 100 - |0-15| ร 2 = 70
- fatAlignment: 100 - |42-40| ร 1.5 = 97
- **Score**: ะฒััะพะบะธะน โ ะฟัะฐะฒะธะปัะฝะพ ัะตะบะพะผะตะฝะดัะตััั

#### ะััะฟะฟะฐ 2: ะะธะฝะฐัะฝัะต ัะฐะน-ะฑัะตะนะบะตัั (6%)

| #   | ะคะฐะบัะพั              | ะะตั  | ะะพะณะธะบะฐ                                           |
| --- | ------------------- | ---- | ------------------------------------------------ |
| 5   | `caffeineAwareness` | 0.03 | 0 ะฟะพัะปะต 20:00, 80 ะดะฝัะผ, 100 ะฑะตะท ะบะพัะตะธะฝะฐ          |
| 6   | `sugarAwareness`    | 0.03 | 0 ะฟัะธ ะทะฐะฒะธัะธะผะพััะธ + ัะฐัะฐั, 60 ั ัะฐัะฐัะพะผ, 100 ะฑะตะท |

#### ะััะฟะฟะฐ 3: ะะพะฝัะตะบััะฝัะต ัะฐะบัะพัั (22%)

| #   | ะคะฐะบัะพั               | ะะตั  | ะะพะณะธะบะฐ                                                     |
| --- | -------------------- | ---- | ---------------------------------------------------------- |
| 7   | `fiberBoost`         | 0.06 | Phase B C10: 100 ะฟัะธ fiberโฅ10g/100g ะธ ะดะตัะธัะธัะต ะบะปะตััะฐัะบะธ   |
| 8   | `micronutrientBoost` | 0.06 | Phase C C26: 100 ะฟัะธ iron/mg/zn/ca ะฒััะต ะฟะพัะพะณะพะฒ ะธ ะดะตัะธัะธัะต |
| 9   | `novaQuality`        | 0.05 | Phase C C29: 0 ะดะปั NOVA-4 ะฟัะธ ะฝะธะทะบะพะผ ะบะฐัะตััะฒะต ัะฐัะธะพะฝะฐ      |
| 10  | `harmMinimization`   | 0.03 | `100 - harm ร 10` (harm 0โ10)                              |
| 11  | `familiarityBoost`   | 0.02 | ะะฝะฐะบะพะผะพััั: frequency/days โ 1โ10 โ ร10                    |

#### ะััะฟะฟะฐ 4: ะกัะตะฝะฐัะฝัะต ัะฐะบัะพัั (13%)

| #   | ะคะฐะบัะพั             | ะะตั  | ะะพะณะธะบะฐ                                               |
| --- | ------------------ | ---- | ---------------------------------------------------- |
| 12  | `sleepGIPenalty`   | 0.05 | PRE_SLEEP: GRAINSโ0, DAIRYโ100, PROTEINโ90           |
| 13  | `glPenalty`        | 0.04 | GL = GIรcarbs/100 vs targetGL: โคtargetโ100, >2.5รโ10 |
| 14  | `workoutCarbBoost` | 0.04 | POST_WORKOUT: GRAINSโ100, FRUITSโ90, PROTEINโ85      |

#### ะัะพะณะพะฒัะน ัะบะพั

```javascript
totalScore = ฮฃ(score_i ร weight_i)    // ะะฐะทะพะฒัะน ัะบะพั (0โ100)
mlAdjustedScore = totalScore ร mlWeightMultiplier  // ML ะบะพััะตะบัะธั [0.5, 2.0]
finalScore = Math.round(mlAdjustedScore)
```

### 5.2 ะะฑะพะณะฐัะตะฝะธะต ะผะฐะบัะพัะพะฒ (`enrichMacros`)

**ะัะพะฑะปะตะผะฐ**: `MealItem` ะฒ `heys_dayv2_*` ััะฐะฝะธั ัะพะปัะบะพ `product_id` ะธ `grams`,
ะฑะตะท ะดะตัะฐะปัะฝัั ะผะฐะบัะพัะพะฒ.

**ะะตัะตะฝะธะต**: lookup ะฟะพ `product_id` โ `sharedProducts` (ะพะฑัะฐั ะฑะฐะทะฐ HEYS):

```javascript
function enrichMacros(product) {
  if (product.macros.kcal > 0) return product; // ะฃะถะต ะตััั

  const sp =
    sharedIndex.get(product.product_id) || sharedIndex.get(product.name);
  if (!sp) return product;

  // ะะพะปั sharedProducts (per 100g):
  const prot = sp.protein100;
  const carb = (sp.simple100 || 0) + (sp.complex100 || 0);
  const fat = (sp.badfat100 || 0) + (sp.goodfat100 || 0) + (sp.trans100 || 0);
  const kcal = sp.kcal100 || Math.round(prot * 3 + carb * 4 + fat * 9);

  return { ...product, macros: { protein: prot, carbs: carb, fat, kcal } };
}
```

### 5.3 ะะฟัะตะดะตะปะตะฝะธะต ะบะฐัะตะณะพัะธะน (`determineCategoryMix`)

ะะฐัะฟัะตะดะตะปัะตั N ัะปะพัะพะฒ ะฟะพ ะบะฐัะตะณะพัะธัะผ ะฟัะพะดัะบัะพะฒ ะฟัะพะฟะพััะธะพะฝะฐะปัะฝะพ ัะตะปะตะฒัะผ ะผะฐะบัะพัะฐะผ.

**ะกะฟะตัะธะฐะปัะฝัะต override-ัะตะถะธะผั:**

| ะกัะตะฝะฐัะธะน       | ะะพะณะธะบะฐ                           | ะะฑะพัะฝะพะฒะฐะฝะธะต                                 |
| -------------- | -------------------------------- | ------------------------------------------- |
| `POST_WORKOUT` | 2/3 ัะปะพัะพะฒ โ GRAINS              | Ivy 2004: ะณะปะธะบะพะณะตะฝ โ ะฑัััััะต ัะณะปะตะฒะพะดั       |
| `PRE_SLEEP`    | 1 ัะปะพั DAIRY + ะพััะฐะปัะฝัะต PROTEIN | Halson 2014: ะบะฐะทะตะธะฝ + ะฑะตะท ะฒัะฟะปะตัะบะฐ ะธะฝััะปะธะฝะฐ |
| ะััะฐะปัะฝัะต      | ะะพ ะฟัะพะฟะพััะธัะผ P/C/F              | ะกัะฐะฝะดะฐััะฝะฐั ะฑะฐะปะฐะฝัะธัะพะฒะบะฐ                    |

### 5.4 ะััะพัะฝะธะบะธ ะบะฐะฝะดะธะดะฐัะพะฒ

ะขัะธ ัััะฐัะตะณะธะธ ะฟะพะดะฑะพัะฐ (ะฟะพ ะฟัะธะพัะธัะตัั):

1. **HISTORY** (โฅ3 ะฟัะพะดัะบัะพะฒ ะฒ ะบะฐัะตะณะพัะธะธ) โ ะฟัะพะดัะบัั ะธะท 30-ะดะฝะตะฒะฝะพะน ะธััะพัะธะธ,
   enriched ะธะท sharedProducts
2. **FALLBACK** โ ะธะท ะพะฑัะตะน ะฑะฐะทั `sharedProducts`, ะตัะปะธ ะธััะพัะธะธ ะผะฐะปะพ
3. **LIMITED_HISTORY** (<3 ะฟัะพะดัะบัะพะฒ) โ ะธัะฟะพะปัะทัะตััั ััะพ ะตััั

### 5.5 ะะฐัะตะณะพัะธะธ ะฟัะพะดัะบัะพะฒ

```javascript
const PRODUCT_CATEGORIES = {
  DAIRY: 'dairy', // ะะพะปะพัะบะฐ: ะผะพะปะพะบะพ, ะบะตัะธั, ัะฒะพัะพะณ, ััั, ะนะพะณััั
  PROTEIN: 'protein', // ะะตะปะพะบ: ะบััะธัะฐ, ะณะพะฒัะดะธะฝะฐ, ััะฑะฐ, ัะนัะฐ
  VEGETABLES: 'vegetables', // ะะฒะพัะธ: ะพะณััะตั, ะฟะพะผะธะดะพั, ะบะฐะฟัััะฐ, ะผะพัะบะพะฒั
  FRUITS: 'fruits', // ะคััะบัั: ัะฑะปะพะบะพ, ะฑะฐะฝะฐะฝ, ะฐะฟะตะปััะธะฝ
  GRAINS: 'grains', // ะััะฟั: ัะปะตะฑ, ัะธั, ะพะฒััะฝะบะฐ, ะผะฐะบะฐัะพะฝั, ะณัะตัะบะฐ
  SNACKS: 'snacks', // ะกะฝะตะบะธ: ัะพะบะพะปะฐะด, ะฟะตัะตะฝัะต, ัะธะฟัั
  OTHER: 'other', // ะััะฐะปัะฝะพะต
};
```

ะะฟัะตะดะตะปัะตััั ะฟะพ ะบะปััะตะฒัะผ ัะปะพะฒะฐะผ ะฒ ะฝะฐะทะฒะฐะฝะธะธ (`detectCategory()`).

---

## 6. ะะพะดัะปั 4: Pattern Integration (ะะฐััะตัะฝั)

**ะคะฐะนะป**: `apps/web/insights/pi_meal_rec_patterns.js` **ะะตััะธั**: v3.0 |
**LOC**: 686

### 6.1 ะะฐะทะฝะฐัะตะฝะธะต

ะะฝัะตะณัะฐัะธั **15 ะฟะพะฒะตะดะตะฝัะตัะบะธั ะฟะฐััะตัะฝะพะฒ** HEYS Insights ะฒ ัะตะบะพะผะตะฝะดะฐัะพั. ะขัะธ
ััะฝะบัะธะธ:

1. **Dynamic Confidence** โ ัะฒะตัะตะฝะฝะพััั ัะตะบะพะผะตะฝะดะฐัะธะธ ะฝะฐ ะพัะฝะพะฒะต ะฟะฐััะตัะฝะพะฒ
2. **Priority Multiplier** โ ััะธะปะตะฝะธะต/ะพัะปะฐะฑะปะตะฝะธะต ััะตะฝะฐัะธั
3. **Phenotype Macro Adjustment** โ ะบะพััะตะบัะธั ะผะฐะบัะพัะพะฒ ะฟะพ ะผะตัะฐะฑะพะปะธัะตัะบะพะผั
   ัะตะฝะพัะธะฟั

### 6.2 ะะฐะณััะทะบะฐ ะฟะฐััะตัะฝะพะฒ `getCurrentPatternScores()`

15 ะฟะฐััะตัะฝะพะฒ ะธะท 3 ัะฐะท:

| ะคะฐะทะฐ             | ะะพะป-ะฒะพ | ะะฐััะตัะฝั                                                                                                                                                        |
| ---------------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **A** (Core)     | 10     | proteinSatiety, stressEating, circadian, trainingRecovery, mealTiming, waveOverlap, insulinSensitivity, glycemicLoad, proteinDistribution, addedSugarDependency |
| **B** (Context)  | 4      | sleepHunger, nutrientTiming, fiberRegularity, moodFood                                                                                                          |
| **C** (Advanced) | 2      | micronutrients, novaQuality                                                                                                                                     |

ะะฐะถะดัะน ะฟะฐััะตัะฝ โ ัะธัะปะพ **0.0โ1.0** (score), ะณะดะต:

- 0.0 = ะฟะฐััะตัะฝ ัะธะปัะฝะพ ะฒััะฐะถะตะฝ (ะฟัะพะฑะปะตะผะฐ)
- 1.0 = ะฟะฐััะตัะฝ ะฒ ะฝะพัะผะต

### 6.3 Dynamic Confidence

```javascript
calculateDynamicConfidence(scenario, patternScores, dataQuality);
```

**ะคะพัะผัะปะฐ**: ะฒะทะฒะตัะตะฝะฝะพะต ััะตะดะฝะตะต ัััั ะบะพะผะฟะพะฝะตะฝัะพะฒ:

```
confidence = scenario_conf ร 0.40 + pattern_avg ร 0.30 + data_quality ร 0.30
```

| ะะพะผะฟะพะฝะตะฝั       | ะะตั | ะะฟะธัะฐะฝะธะต                                 |
| --------------- | --- | ---------------------------------------- |
| `scenario_conf` | 40% | ะะฐะทะพะฒะฐั + boost ะพั ัะตะปะตะฒะฐะฝัะฝะพะณะพ ะฟะฐััะตัะฝะฐ |
| `pattern_avg`   | 30% | ะกัะตะดะฝะธะน score ะฒัะตั ะฟะฐััะตัะฝะพะฒ             |
| `data_quality`  | 30% | ะะพะปะฝะพัะฐ ะดะฐะฝะฝัั (ะดะฝะธ ั ะปะพะณะฐะผะธ / 30)       |

**Clamp**: [0.5, 1.0]

### 6.4 Priority Multiplier

```javascript
getScenarioPriorityMultiplier(scenario, patternScores);
// โ 0.7 โ 1.3
```

| ะกะฒัะทะบะฐ                               | ะฃัะปะพะฒะธะต      | ะะฝะพะถะธัะตะปั                        |
| ------------------------------------ | ------------ | -------------------------------- |
| PROTEIN_DEFICIT + low proteinSatiety | score < 0.3  | **1.3** (ะผะฐะบัะธะผะฐะปัะฝัะน ะฟัะธะพัะธัะตั) |
| STRESS_EATING + high stressEating    | score < 0.4  | **1.25**                         |
| PRE_SLEEP + high sleepHunger         | score < 0.45 | **1.2**                          |
| POST_WORKOUT + high trainingRecovery | score < 0.4  | **1.15**                         |
| ะััะฐะปัะฝัะต                            | โ            | **1.0**                          |

### 6.5 Phenotype Macro Adjustment

```javascript
getPhenotypeAdjustedMacros(baseMacros, phenotype, scenario);
```

| ะคะตะฝะพัะธะฟ                            | ะะพััะตะบัะธั                           |
| ---------------------------------- | ----------------------------------- |
| `insulin_resistant`                | carbs ร 0.75โ0.85, prot ร 1.15      |
| `low_satiety`                      | prot ร 1.15                         |
| `insulin_sensitive` + POST_WORKOUT | carbs ร 1.15                        |
| `evening_type`                     | ะะตะท ะธะทะผะตะฝะตะฝะธะน (ัะฐะนะผะธะฝะณ, ะฝะต ะผะฐะบัะพัั) |
| `stress_eater`                     | carbs ร 1.05 (ัะตัะพัะพะฝะธะฝ)            |

**ะะฐะถะฝะพ**: ัะตะฝะพัะธะฟั EWS (4 ัะธะฟะฐ: insulin_resistant, evening_type, low_satiety,
stress_eater) ะธ ัะตะฝะพัะธะฟั Profile (sprinter, marathoner ะธ ั.ะด.) โ ััะพ **ัะฐะทะฝัะต
ัะธััะตะผั**, ะฝะต ะฟััะฐัั!

### 6.6 `enhanceRecommendation()`

ะะปะฐะฒะฝะฐั ััะฝะบัะธั ะผะพะดัะปั โ ะพะฑะพัะฐัะธะฒะฐะตั ัะตะบะพะผะตะฝะดะฐัะธั:

```javascript
enhanceRecommendation(baseRecommendation, context, profile) โ {
  ...baseRecommendation,
  confidence: dynamicConfidence,      // ััะพัะฝัะฝะฝะฐั
  macros: phenotypeAdjustedMacros,    // ัะบะพััะตะบัะธัะพะฒะฐะฝะฝัะต
  priorityMultiplier: 1.2,            // ััะธะปะตะฝะฝัะน ััะตะฝะฐัะธะน
  patternInsights: [...]              // ะพะฑัััะฝะตะฝะธั
}
```

---

## 7. ะะพะดัะปั 5: Feedback Loop (ML-ะพะฑััะตะฝะธะต)

**ะคะฐะนะป**: `apps/web/insights/pi_feedback_loop.js` **ะะตััะธั**: v1.1 | **LOC**:
481

### 7.1 ะะฐะทะฝะฐัะตะฝะธะต

ML-ะพะฑััะตะฝะธะต ะฝะฐ ะพัะฝะพะฒะต ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะณะพ ัะธะดะฑะตะบะฐ. ะฃะฟัะฐะฒะปัะตั **ะฒะตัะพะฒัะผะธ
ะบะพัััะธัะธะตะฝัะฐะผะธ ะฟัะพะดัะบัะพะฒ** (`productWeight`), ะบะพัะพััะต ัะธัะฐะตั Product Picker ะฟัะธ
ัะบะพัะธะฝะณะต.

### 7.2 Flow

```
1. ะะตะบะพะผะตะฝะดะฐัะธั โ storeRecommendation() โ ะทะฐะฟะธัั ะฒ localStorage
2. ะะพะปัะทะพะฒะฐัะตะปั ัะปะตะดัะตั/ะฝะตั โ markRecommendationFollowed()
3. ๐/๐ ะธะปะธ (satiety/energy/mood) โ submitOutcomeFeedback()
4. ะััะธัะปะตะฝะธะต ะฝะพะฒะพะณะพ ะฒะตัะฐ โ updateRecommendationWeights()
5. Product Picker โ getProductWeight(profile, productId, scenario) โ ะผะฝะพะถะธัะตะปั
```

### 7.3 EMA-ะพะฑััะตะฝะธะต

```javascript
const ALPHA = 0.1;           // Learning rate
const BOOST_FACTOR = 1.05;   // +5% ะทะฐ ๐
const PENALTY_FACTOR = 0.95; // -5% ะทะฐ ๐

// EMA: new = old ร (1 - ฮฑ) + target ร ฮฑ
targetWeight = currentWeight ร adjustmentFactor;
newWeight = currentWeight ร 0.9 + targetWeight ร 0.1;

// Clamp: [0.5, 2.0]
```

### 7.4 ะฅัะฐะฝะตะฝะธะต ะฒะตัะพะฒ

- **ะะปัั**: `heys_meal_rec_weights_{clientId}`
- **ะคะพัะผะฐั**: `{ "SCENARIO_productId": weight }`
- **ะัะธะผะตั**: `{ "PROTEIN_DEFICIT_abc123": 1.15, "BALANCED_def456": 0.87 }`

### 7.5 ะะฝัะตะณัะฐัะธั ั Product Picker

```javascript
// ะ calculateProductScore():
const mlWeightMultiplier = feedbackLoop.getProductWeight(profile, productId, scenario);
const mlAdjustedScore = totalScore ร mlWeightMultiplier;
// ะะตะทัะปััะฐั: ะฟัะพะดัะบั ั ๐ ะฟะพััะตะฟะตะฝะฝะพ ะฝะฐะฑะธัะฐะตั ะฒะตั,
// ะฟัะพะดัะบั ั ๐ ัะตััะตั ะฒะตั ะฒ ะบะพะฝะบัะตัะฝะพะผ ััะตะฝะฐัะธะธ
```

---

## 8. ะะพะดัะปั 6: Meal Rec Feedback (ะกะฑะพั ะพัะตะฝะพะบ)

**ะคะฐะนะป**: `apps/web/insights/pi_meal_rec_feedback.js` **ะะตััะธั**: v1.1.0 |
**LOC**: 535

### 8.1 ะะฐะทะฝะฐัะตะฝะธะต

ะกะฑะพั ะธ ััะฐะฝะตะฝะธะต ๐/๐ ะพั ะฟะพะปัะทะพะฒะฐัะตะปั ั cloud sync. ะัะดะตะปัะฝัะน ะพั Feedback Loop
ะผะพะดัะปั, ะพัะฒะตัะฐััะธะน ะทะฐ **persistence ะธ ัะธะฝััะพะฝะธะทะฐัะธั**.

### 8.2 ะะปััะตะฒัะต ะฟะฐัะฐะผะตััั

```javascript
const STORAGE_KEY = 'heys_meal_feedback';
const CLOUD_KV_KEY = 'meal_rec_feedback_v1';
const RETENTION_DAYS = 90; // ะฅัะฐะฝะตะฝะธะต ะทะฐะฟะธัะตะน
const HALF_LIFE_DAYS = 14; // ะะตัะธะพะด ะฟะพะปััะฐัะฟะฐะดะฐ ะดะปั EMA
```

### 8.3 Adjustment Factor ะฟะพ ััะตะฝะฐัะธั

```javascript
calculateAdjustmentFactor(scenario);
// โ 0.5 โ 1.5

// ะคะพัะผัะปะฐ:
// 1. ะคะธะปัััะฐัะธั feedback ะฟะพ ััะตะฝะฐัะธั
// 2. Weighted success rate ั exponential decay
// 3. decay = exp(-age / halfLifeMs)  // ะกะฒะตะถะธะน feedback ะฒะตัะธั ะฑะพะปััะต
// 4. adjustmentFactor = 0.5 + (successRate ร 1.0)
```

| successRate | ะะฝะฐัะตะฝะธะต | adjustmentFactor               |
| ----------- | -------- | ------------------------------ |
| 1.0         | ะัะต ๐   | **1.5** (ะผะฐะบัะธะผะฐะปัะฝัะน boost)   |
| 0.5         | ะะพัะพะฒะฝั  | **1.0** (ะฝะตะนััะฐะปัะฝัะน)          |
| 0.0         | ะัะต ๐   | **0.5** (ะผะฐะบัะธะผะฐะปัะฝัะน penalty) |

### 8.4 Cloud Sync

```javascript
syncWithCloud({ reason: 'add_feedback' });
// Flow:
// 1. loadFeedbackHistory(clientId) โ ะผะตััะฝะฐั ะธััะพัะธั
// 2. loadCloudHistory(clientId)    โ HEYS.YandexAPI.getKV(clientId, key)
// 3. mergeHistories(local, cloud)  โ ะฟะพ fingerprint (timestamp+scenario+rating+products)
// 4. saveFeedbackHistory(merged)   โ localStorage
// 5. saveCloudHistory(merged)      โ HEYS.YandexAPI.saveKV(clientId, key, payload)
```

**Bootstrap sync**: ะฝะฐ ะทะฐะณััะทะบะต ะผะพะดัะปั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะดััะณะธะฒะฐะตั ะพะฑะปะฐัะฝัะต ะดะฐะฝะฝัะต
(non-blocking).

---

## 9. ะะฐััะฝะฐั ะฑะฐะทะฐ

ะกะธััะตะผะฐ ะพัะฝะพะฒะฐะฝะฐ ะฝะฐ **8 ะฝะฐััะฝัั ัะฟัะธะฝัะฐั (S1โS8)** ั ัะตัะตะฝะทะธัะพะฒะฐะฝะฝัะผะธ
ะฟัะฑะปะธะบะฐัะธัะผะธ:

| Sprint  | ะขะตะผะฐ                         | ะัะฑะปะธะบะฐัะธั (PMID)                               | ะัะธะผะตะฝะตะฝะธะต                                            |
| ------- | ---------------------------- | ----------------------------------------------- | ----------------------------------------------------- |
| **S1**  | ะฅัะพะฝะพะฟะธัะฐะฝะธะต                 | Garaulet & Gรณmez-Abellรกn, 2014 (PMID: 23877420) | Chrono-ratios: 33/38/20/28% (ัััะพ/ะพะฑะตะด/ะฟะตัะตะบัั/ะฒะตัะตั) |
| **S2**  | MPS (ัะธะฝัะตะท ะผััะตัะฝะพะณะพ ะฑะตะปะบะฐ) | Areta et al., 2013 (PMID: 23459753)             | 0.4 g/kg ะฝะฐ ะฟัะธัะผ, cap 40g                            |
| **S3**  | ะะปะธะบะตะผะธัะตัะบะฐั ะฝะฐะณััะทะบะฐ       | Ludwig, 2002 (PMID: 12002800)                   | GL < 20 (ะดะตะฝั), GL < 10 (ะฟัะต-ัะพะฝ)                     |
| **S4**  | ะะฝะฐะฑะพะปะธัะตัะบะพะต ะพะบะฝะพ           | Ivy, 2004 (PMID: 15212750)                      | POST_WORKOUT: 60% carbs, 2ั ะพะบะฝะพ                      |
| **S5**  | ะกะพะฝ ะธ ะฟะธัะฐะฝะธะต                | Halson, 2014 (PMID: 24435400)                   | ะะฐะทะตะธะฝ ะฟัะต-ัะพะฝ, ะฑะตะท GRAINS                            |
| **S6**  | ะะฝััะปะธะฝะพะฒะฐั ะฒะพะปะฝะฐ            | HEYS internal                                   | ะะตััะพะฝะฐะปัะฝะฐั ะฒะพะปะฝะฐ ะธะท gaps (ะผะตะดะธะฐะฝะฐ 14d)              |
| **S7**  | TEF (ัะตัะผะธัะตัะบะธะน ัััะตะบั)     | Livesey, 2001                                   | ะะตะปะพะบ = 3 kcal/g (ะฝะต 4)                               |
| **S8**  | ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฒะพะปะฝั        | Louis-Sylvestre & Le Magnen, 1980 + HEYS        | Volume-scaled wave โ(meal/total), min(wave, 2h) gap   |
| **S9**  | ะคะตะฝะพัะธะฟ-ะดะตัะตะบั               | HEYS internal                                   | Auto-detect ะฟัะธ 30+ ะดะฝัั ะดะฐะฝะฝัั                       |
| **S10** | ะกะบะพัะธะฝะณ ะฟัะพะดัะบัะพะฒ            | โ                                               | 14-ัะฐะบัะพัะฝัะน ัะบะพัะธะฝะณ, macro alignment 49%             |

**ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัััะปะบะธ**:

- **Kinsey & Ormsbee, 2015** โ Hunger trade-off (ัะพะบัะฐัะตะฝะธะต ะฑััะตัะฐ ะดะพ ัะฝะฐ ะฟัะธ
  ะดะตัะธัะธัะต)
- **Louis-Sylvestre & Le Magnen, 1980** โ forceMultiMeal gap: min(wave, 2h)
- **Halton & Hu, 2004** โ TEF ะดะปั ะฑะตะปะบะฐ (S7 effectiveKcal)

---

## 10. Pipeline: ะพั ะทะฐะฟัะพัะฐ ะดะพ ะบะฐััะพัะบะธ

### ะะพะปะฝัะน Flow ะพะดะฝะพะน ัะตะบะพะผะตะฝะดะฐัะธะธ

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "ะะฐัััะธัะฐัั" ะฒ UI
    โ
    โผ
[1] Meal Recommender: recommendNextMeal()
    โโโ analyzeCurrentContext() โ PROTEIN_DEFICIT
    โโโ loadPatternHints() โ {C15: 0.38, C35: 0.30, ...}
    โ
    โโโ ะัะทะพะฒ Meal Planner: planRemainingMeals()
    โ   โโโ [Step 1] Insulin wave โ waveEnd = 15:42
    โ   โโโ [Step 2] Fat burn โ earliest = 16:12
    โ   โโโ [Step 3] Sleep target โ 23:00 (buffer: 3h โ deadline 20:00)
    โ   โโโ [Step 4] Budget โ 1200 kcal remaining
    โ   โโโ [Step 5] Loop โ 2 meals (16:15, 18:30)
    โ   โโโ [Step 6] Redistribute โ meal1: 720kcal, meal2: 480kcal
    โ
    โโโ calculateOptimalTiming() โ "16:15"
    โโโ calculateOptimalMacros()
    โ   โโโ Base: P50%, C30%, F20% ร 720kcal = P90g, C54g, F16g
    โ   โโโ C15 (insulin: 0.38): carbs ร 0.90 โ 49g
    โ   โโโ C35 (protein: 0.30): prot ร 1.20 โ 108g โ P5 cap โ 100g
    โ   โโโ Final: P100g, C49g, F16g = ~720kcal
    โ
    โโโ generateSmartMealSuggestions()
        โ
        โผ
[2] Product Picker: generateProductSuggestions()
    โโโ analyzeProductHistory(30 days)
    โโโ determineCategoryMix(100, 49, 16) โ [PROTEIN, PROTEIN, GRAINS]
    โโโ pickProductsMix()
        โโโ PROTEIN: score each โ top 5
        โ   โโโ ะััะธะฝะฐั ะณััะดะบะฐ: score=79 (protAlign=74, carbAlign=70, fatAlign=97)
        โ   โโโ ะขะฒะพัะพะณ 5%: score=72 (protAlign=68, fatAlign=85)
        โ   โโโ ...
        โโโ GRAINS: score each โ top 5
            โโโ ะัะตัะบะฐ: score=65 (carbAlign=72, glPenalty=100)
            โโโ ...
        โ
        โ Apply ML weights: feedbackLoop.getProductWeight()
        โ   โโโ "ะััะธะฝะฐั ะณััะดะบะฐ" ร 1.05 (2 ะฟัะตะดัะดััะธั ๐)
        โ
        โผ
[3] Pattern Integration: enhanceRecommendation()
    โโโ dynamicConfidence = 0.82
    โโโ priorityMultiplier = 1.3 (PROTEIN_DEFICIT + low proteinSatiety)
    โโโ phenotypeMacros: insulin_resistant โ carbs ร 0.85
        โ
        โผ
[4] UI Card: renderMealRecCard()
    โโโ ะะพะบะฐะทะฐัั: ััะตะฝะฐัะธะน + ะฒัะตะผั + ะฟัะพะดัะบัั ั ัะตะบะฑะพะบัะฐะผะธ
    โโโ ะััะฟะฟะธัะพะฒะบะฐ ะฟะพ ะบะฐัะตะณะพัะธัะผ (๐ฅฉ ะะตะปะบะธ, ๐พ ะฃะณะปะตะฒะพะดั)
    โโโ ะะฝะพะฟะบะธ: ๐ / ๐ โ feedbackLoop
```

### ะะธะทัะฐะปัะฝัะน Flow ะดะปั ะผัะปััะธ-ะฟัะธัะผะฐ

```
Budget: 1200 kcal remaining โ forceMultiMeal (>900 kcal)
    โ
    โโโ Meal 1 (16:15, 720 kcal, PROTEIN_DEFICIT)
    โ   โโโ Products: [ะััะธัะฐ, ะขะฒะพัะพะณ, ะัะตัะบะฐ] (excludeIds = โ)
    โ   โโโ excludeIds += [chicken_id, tvorog_id, grechka_id]
    โ
    โโโ Wave: 16:15 + 2.5h (scaled) + 0.33h fatBurn = 19:05
    โ
    โโโ Meal 2 (19:05, 480 kcal, PRE_SLEEP)
        โโโ Products: [ะะตัะธั, ะฏะนัะฐ, ะะฝะดะตะนะบะฐ] (excludeIds = {chicken, tvorog, grechka})
        โโโ ะะตะดัะฟะปะธะบะฐัะธั: ะบััะธัะฐ ัะถะต ะฒ Meal 1 โ ะฝะต ะฟะพะฒัะพััะตััั
```

---

## 11. ะคะพัะผะฐั ะดะฐะฝะฝัั ะธ ะผะพะดะตะปั

### 11.1 ะัะพะดะฝัะต ะดะฐะฝะฝัะต

**`context` (ะพั DayTab):**

```javascript
{
  dayTot: {
    kcal: 1280,       // ะกัะตะดะตะฝะพ kcal ะทะฐ ะดะตะฝั
    prot: 58,         // ะะตะปะพะบ (ะณ) โ ะะกะะะะ .prot, ะฝะต .protein!
    carb: 140,        // ะฃะณะปะตะฒะพะดั
    fat: 48           // ะะธัั
  },
  meals: [
    {
      time: '09:00',
      items: [
        { product_id: 'abc', title: 'ะะฒััะฝะบะฐ', grams: 80, kcal: 280, prot: 10, carb: 45, fat: 6 }
      ]
    }
  ],
  normAbs: {
    kcal: 2200,       // ะะฝะตะฒะฝะฐั ะฝะพัะผะฐ
    prot: 132,
    carb: 250,
    fat: 73
  },
  currentTime: 15.5,  // 15:30 ะฒ ะดะตัััะธัะฝะพะผ ัะพัะผะฐัะต
  remainingKcal: 920
}
```

**`profile` (heys_profile):**

```javascript
{
  weight: 75,           // ะบะณ
  height: 178,          // ัะผ
  age: 32,
  sex: 'male',
  activity: 1.55,       // PAL
  goal: 'maintain',     // lose / maintain / gain
  sleepTarget: '23:00', // ะฆะตะปะตะฒะพะต ะฒัะตะผั ัะฝะฐ
  // ะะะข: created_at, id (ะธัะฟะพะปัะทัะตััั currentClientId)
}
```

**`pIndex` (sharedProducts):**

```javascript
[
  {
    id: 'prod_abc',
    title: 'ะััะธะฝะฐั ะณััะดะบะฐ',
    protein100: 23.6, // ะณ ะฑะตะปะบะฐ ะฝะฐ 100ะณ
    simple100: 0, // ะฟัะพัััะต ัะณะปะตะฒะพะดั ะฝะฐ 100ะณ
    complex100: 0, // ัะปะพะถะฝัะต ัะณะปะตะฒะพะดั ะฝะฐ 100ะณ
    badfat100: 0.9, // ะฝะฐัััะตะฝะฝัะต ะถะธัั ะฝะฐ 100ะณ
    goodfat100: 1.2, // ะฝะตะฝะฐัััะตะฝะฝัะต ะถะธัั
    trans100: 0, // ััะฐะฝัะถะธัั
    kcal100: 113, // kcal ะฝะฐ 100ะณ (ะธะปะธ ัะฐัััั: Pร3 + Cร4 + Fร9)
    gi: 0, // ะะปะธะบะตะผะธัะตัะบะธะน ะธะฝะดะตะบั
    harm: 0, // ะะฝะดะตะบั ะฒัะตะดะฝะพััะธ (0โ10)
    nova_group: 1, // ะััะฟะฟะฐ NOVA (1โ4)
  },
];
```

### 11.2 ะััะพะดะฝัะต ะดะฐะฝะฝัะต (ัะตะบะพะผะตะฝะดะฐัะธั)

```javascript
{
  scenario: 'PROTEIN_DEFICIT',
  timing: {
    suggestedTime: '16:15',
    earliestTime: '16:00',
    reason: 'ะะพัะปะต ะพะบะฝะฐ ะถะธัะพัะถะธะณะฐะฝะธั'
  },
  macros: {
    protein: 100,    // ะณ
    carbs: 49,
    fat: 16,
    kcal: 720
  },
  suggestions: {
    mode: 'grouped',
    groups: [
      {
        category: 'protein',
        categoryName: 'ะะตะปะบะธ',
        emoji: '๐ฅฉ',
        importance: 2,
        products: [
          {
            product: 'ะััะธะฝะฐั ะณััะดะบะฐ',
            productId: 'prod_abc',
            grams: 150,
            score: 79,
            source: 'history',
            reason: 'ะััะพะบะพะต ัะพะดะตัะถะฐะฝะธะต ะฑะตะปะบะฐ',
            macros: { protein: 35, carbs: 0, fat: 3, kcal: 170 }
          }
        ]
      },
      {
        category: 'grains',
        categoryName: 'ะฃะณะปะตะฒะพะดั',
        emoji: '๐พ',
        products: [...]
      }
    ],
    totalProducts: 10
  },
  confidence: 0.82,
  reasoning: [
    'ะกัะตะฝะฐัะธะน: ะดะตัะธัะธั ะฑะตะปะบะฐ (ะพััะฐะปะพัั 56% ะฝะพัะผั)',
    'ะะฐััะตัะฝ C15: ัะฝะธะถะตะฝะฐ ััะฒััะฒะธัะตะปัะฝะพััั ะบ ะธะฝััะปะธะฝั โ ะผะตะฝััะต ัะณะปะตะฒะพะดะพะฒ',
    'ะกะปะตะดัััะธะน ะฟัะธัะผ: 16:15 (ะฟะพัะปะต ะพะบะฝะฐ ะถะธัะพัะถะธะณะฐะฝะธั)'
  ],
  meals: [
    { time: '16:15', scenario: 'PROTEIN_DEFICIT', budget: 720 },
    { time: '19:05', scenario: 'PRE_SLEEP', budget: 480 }
  ]
}
```

### 11.3 ะัะธัะธัะฝัะต gotchas

| ะัะธะฑะบะฐ               | ะัะฐะฒะธะปัะฝะพ                                      | ะะพะผะผะตะฝัะฐัะธะน                   |
| -------------------- | ---------------------------------------------- | ----------------------------- |
| `dayTot.protein`     | `dayTot.prot`                                  | ะะพัะพัะบะฐั ัะพัะผะฐ ะฒะตะทะดะต          |
| `item.category`      | `getProductFromItem(item).category`            | MealItem ะฝะต ะธะผะตะตั category    |
| `heys_day_{date}`    | `heys_dayv2_{date}`                            | v2 prefix ะพะฑัะทะฐัะตะปะตะฝ          |
| `protein = 4 kcal/g` | `protein = 3 kcal/g`                           | TEF-adjusted (Livesey 2001)   |
| `product.harmScore`  | `product.harm`                                 | `harm` โ ะบะฐะฝะพะฝะธัะตัะบะพะต ะฟะพะปะต    |
| `sp.prot`            | `sp.protein100`                                | ะ sharedProducts ะฟะพะปั per100g |
| `sp.carb`            | `(sp.simple100 + sp.complex100)`               | ะ sharedProducts โ ัะฐะทะดะตะปัะฝะพ  |
| `sp.fat`             | `(sp.badfat100 + sp.goodfat100 + sp.trans100)` | 3 ะบะพะผะฟะพะฝะตะฝัะฐ ะถะธัะพะฒ            |

---

## 12. UX-ะธะฝัะตะณัะฐัะธั

### 12.1 ะะฐััะพัะบะฐ ัะตะบะพะผะตะฝะดะฐัะธะธ (`pi_ui_meal_rec_card.js` v27.8)

- **ะะตะนะดะถ ยซะฃะผะฝัะน ะฟะปะฐะฝะธัะพะฒัะธะบยป** ะฒ header ะบะฐััะพัะบะธ + InfoButton (โ)
- **ะัะพะผะฟั** ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั: _ยซะะต ะทะฝะฐะตัะต, ััะพ ะฟัะฐะฒะธะปัะฝะพ ะฟะพะตััั ัะตะณะพะดะฝั? ะฃะผะฝัะน
  ะฟะปะฐะฝะธัะพะฒัะธะบ ะฟะพะดัะบะฐะถะตั ะฒะฐะผ. ะั ะผะพะถะตัะต ะฟัะพััะพ ัะปะตะดะพะฒะฐัั ะตะณะพ ัะตะบะพะผะตะฝะดะฐัะธัะผ, ะธ ะฒะฐั
  ะดะตะฝั ะฑัะดะตั ะธะดะตะฐะปัะฝัะผ ะฟะพ ะฟะธัะฐะฝะธั!ยป_
- **Smart meal naming**: ะฟัะธัะผั ะฟะพะปััะฐัั ะฝะฐะทะฒะฐะฝะธั ะฟะพ ะฒัะตะผะตะฝะธ (ะะฐะฒััะฐะบ/ะะฑะตะด/ะฃะถะธะฝ)
- **Premium sub-card redesign**: ะฑะตะปัะน ัะพะฝ, ัะฒะตัะฝัะต ะฑะตะนะดะถะธ ััะตะฝะฐัะธะตะฒ
- **ะะฝะพะฟะบะฐ ยซ+ยป**: ะดะพะฑะฐะฒะปะตะฝะธะต ะฟัะพะดัะบัะฐ ะธะท ัะตะบะพะผะตะฝะดะฐัะธะธ โ ConfirmModal

### 12.2 ConfirmModal ะธะฝัะตะณัะฐัะธั

- **Smart Grams Pre-fill**: `suggestion.grams` โ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะตะดะทะฐะฟะพะปะฝัะตั
  ะณัะฐะผะผะพะฒะบั ะฒ ะผะพะดะฐะปะบะต ะดะพะฑะฐะฒะปะตะฝะธั
- **Smart meal auto-select**: ะฟะพ ะฒัะตะผะตะฝะธ ัะตะบะพะผะตะฝะดะฐัะธะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฑะธัะฐะตััั
  ัะตะปะตะฒะพะน ะฟัะธัะผ ะฟะธัะธ
- **Toast ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั**: ะฒะธะทัะฐะปัะฝะพะต ะฟะพะดัะฒะตัะถะดะตะฝะธะต + verification logging

### 12.3 Sprint 2 UX-ัะธะบัั

| ะคะธะบั                     | ะะฟะธัะฐะฝะธะต                                                  | ะะตััะธั |
| ------------------------ | --------------------------------------------------------- | ------ |
| **normalizeSearch ัโะต**  | ะะพัะผะฐะปะธะทะฐัะธั ะฟะพะธัะบะพะฒัั ะทะฐะฟัะพัะพะฒ (ัโะต, ะฟัะพะฑะตะปั, ัะตะณะธััั)   | v27.7  |
| **Empty products guard** | Retry 1000ms + graceful alert ะฟัะธ `products.length === 0` | v27.7  |
| **isProcessing guard**   | `useRef` ะฟัะตะดะพัะฒัะฐัะฐะตั ะดะฒะพะนะฝะพะน ะบะปะธะบ ะฝะฐ ยซ+ยป                | v27.7  |

### 12.4 Performance ะพะฟัะธะผะธะทะฐัะธะธ (Sprint 4)

| ะะฟัะธะผะธะทะฐัะธั                   | ะัะพะฑะปะตะผะฐ                        | ะะตัะตะฝะธะต                                                    |
| ----------------------------- | ------------------------------- | ---------------------------------------------------------- |
| **P1: Diary re-renders**      | 40+ ัะตะฝะดะตัะพะฒ ะทะฐ ะทะฐะณััะทะบั        | `useRef` debounce โ โค3 ะปะพะณะฐ                                |
| **P2: Double recommendation** | ะะพะปะฝัะน ัะธะบะป ะดะฒะฐะถะดั (StrictMode) | ะฃัะธะปะตะฝะฝัะน `React.memo` comparator (`day.date + updatedAt`) |

### 12.5 InfoButton: ะฝะฐััะฝะพะต ะพะฑะพัะฝะพะฒะฐะฝะธะต

ะัะธ ะบะปะธะบะต ะฝะฐ โ ััะดะพะผ ั ะฑะตะนะดะถะตะผ ยซะฃะผะฝัะน ะฟะปะฐะฝะธัะพะฒัะธะบยป ะพัะบััะฒะฐะตััั ะผะพะดะฐะปะบะฐ
(`SCIENCE_INFO.SMART_PLANNER` ะฒ `pi_constants.js`):

- ๐ง 6 ะฟัะธะฝัะธะฟะพะฒ ะดะพะบะฐะทะฐัะตะปัะฝะพะน ะฝัััะธัะธะพะปะพะณะธะธ (S1โS6)
- ะคะพัะผัะปั ั ะฟะฐัะฐะผะตััะฐะผะธ ะดะปั ะบะฐะถะดะพะณะพ ัะฟัะธะฝัะฐ
- **5 ะธััะพัะฝะธะบะพะฒ** ั PubMed PMID:
  - Garaulet & Gรณmez-Abellรกn, 2014 (PMID: 23877420) โ ััะพะฝะพะฟะธัะฐะฝะธะต
  - Areta et al., 2013 (PMID: 23459753) โ MPS ะฑะตะปะพะบ
  - Ludwig, 2002 (PMID: 12002800) โ ะณะปะธะบะตะผะธัะตัะบะฐั ะฝะฐะณััะทะบะฐ
  - Ivy, 2004 (PMID: 15212750) โ ะฐะฝะฐะฑะพะปะธัะตัะบะพะต ะพะบะฝะพ
  - Halson, 2014 (PMID: 24435400) โ ัะพะฝ ะธ ะฟะธัะฐะฝะธะต
- Evidence Level A, Confidence 0.88

---

## 13. FAQ ะธ edge-cases

### Q: ะงัะพ ะตัะปะธ ะฝะตั ะธะฝััะปะธะฝะพะฒะพะน ะฒะพะปะฝั?

**A**: Fallback ะฝะฐ `estimateWaveDuration()` โ ะธัะฟะพะปัะทัะตั
`DEFAULT_WAVE_ESTIMATE_HOURS = 3.5ั`, ะบะพััะตะบัะธััััั ะฟะพ ะผะฐะบัะพัะฐะผ ะฟะพัะปะตะดะฝะตะณะพ
ะฟัะธัะผะฐ.

### Q: ะงัะพ ะตัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฑะตะท ะฟัะพัะธะปั?

**A**: ะกะธััะตะผะฐ ัะฐะฑะพัะฐะตั ะฑะตะท `profile` โ ะธัะฟะพะปัะทัะตั fallback-ะทะฝะฐัะตะฝะธั ะดะปั ะฒะตัะฐ
(70 ะบะณ), ัะฝะฐ (23:00), MPS (28 ะณ ะฑะตะปะบะฐ). ะคะตะฝะพัะธะฟะธัะตัะบะฐั ะฐะดะฐะฟัะฐัะธั ะฟัะพะฟััะบะฐะตััั.

### Q: ะะฐะบ ัะธััะตะผะฐ ะพะฑัะฐะฑะฐััะฒะฐะตั >900 kcal?

**A**: `forceMultiMeal` โ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฐะทะฑะธะฒะฐะตั ะฝะฐ 2-4 ะฟัะธัะผะฐ. ะะบะฝะพ
ะถะธัะพัะถะธะณะฐะฝะธั ัะพะบัะฐัะฐะตััั ั 30 ะดะพ 20 ะผะธะฝัั ะดะปั ะฑะพะปะตะต ะฟะปะพัะฝะพะณะพ ะณัะฐัะธะบะฐ.

### Q: ะงัะพ ะตัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะตัั ะฝะธัะตะณะพ ะฝะต ะตะป?

**A**: `remainingKcal = normAbs.kcal` (ะฒัั ะดะฝะตะฒะฝะฐั ะฝะพัะผะฐ). ะะตะท ะธะฝััะปะธะฝะพะฒะพะน ะฒะพะปะฝั
โ ัะตะบะพะผะตะฝะดะฐัะธั ะฝะฐัะธะฝะฐะตััั ยซัะตะนัะฐัยป. ะกัะตะฝะฐัะธะน โ BALANCED.

### Q: ะะฐะบ ัะฐะฑะพัะฐะตั ะดะตะดัะฟะปะธะบะฐัะธั ะผะตะถะดั ะฟัะธัะผะฐะผะธ?

**A**: `excludeProductIds` โ Set, ะบะพัะพััะน ะฝะฐะบะฐะฟะปะธะฒะฐะตั `product_id` ะธะท ะฟัะตะดัะดััะธั
ะฟัะธัะผะพะฒ. Product Picker ะทะฐะฟัะฐัะธะฒะฐะตั +N ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะบะฐะฝะดะธะดะฐัะพะฒ (ะบะพะผะฟะตะฝัะฐัะธั) ะธ
ัะธะปััััะตั ัะถะต ะธัะฟะพะปัะทะพะฒะฐะฝะฝัะต.

### Q: ะะฐะบ ML-ะฒะตั ะฒะปะธัะตั ะฝะฐ ัะบะพั?

**A**: Product Picker ัะผะฝะพะถะฐะตั `totalScore ร mlWeightMultiplier` (default=1.0).
ะะพัะปะต 10ร ๐ ะฒ ััะตะฝะฐัะธะธ BALANCED ะผะฝะพะถะธัะตะปั ~1.05. ะะพัะปะต 10ร ๐ ะผะฝะพะถะธัะตะปั ~0.95.
**ะญะบัััะตะผัะผ: [0.5, 2.0]** โ ะดะพััะธะณะฐะตััั ะทะฐ ~50+ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝัั ะพัะตะฝะพะบ.

### Q: ะะตะนััะฐะปัะฝัะต ะฑะฐะทะพะฒัะต ัะบะพัั (50) โ ะทะฐัะตะผ?

**A**: ะคะฐะบัะพัั `sleepGIPenalty`, `glPenalty`, `workoutCarbBoost` ะธะผะตัั
baseline=50 ะฒะฝะต ัะฒะพะตะณะพ ััะตะฝะฐัะธั. ะญัะพ ะดะฐัั **ัะธะผะผะตััะธัะฝัะน ะดะธะฝะฐะผะธัะตัะบะธะน ะดะธะฐะฟะฐะทะพะฝ**
โ ะธ boost (ะดะพ 100), ะธ penalty (ะดะพ 0) ะพะดะธะฝะฐะบะพะฒะพ ะฒะปะธััั ะฝะฐ ัะบะพั. ะะฐะฝััะต baseline
ะฑัะป 70, ััะพ ะดะฐะฒะฐะป ัะบััััะน ะฑะพะฝัั ะฝะตะบะพัะพััะผ ะฟัะพะดัะบัะฐะผ.

### Q: ะััั ะปะธ sleep target clamp?

**A**: ะะฐ. ะะพัะปะต ะพัะตะฝะบะธ ะฒัะตะผะตะฝะธ ัะฝะฐ ะทะฝะฐัะตะฝะธะต ะพะณัะฐะฝะธัะธะฒะฐะตััั ะดะธะฐะฟะฐะทะพะฝะพะผ
22:00โ00:30, ััะพะฑั ะฟะพะทะดะฝะธะน ัะถะธะฝ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฟัะธะฒะพะดะธะป ะบ ะฐะฑัััะดะฝะพะผั
`sleepTarget: "24:59"`.

### Q: ะะพัะตะผั Phase A ะผะพะดะธัะธะบะฐัะพัั (C15/C35) ะฝะต ะฟัะธะผะตะฝััััั ะดะปั ะฟะพัะปะตะดะฝะตะณะพ ะฟัะธัะผะฐ?

**A**: Sprint 6 R3 fix. ะัะธ `isLastMeal` ะผะฐะบัะพัั ัะถะต ัะฐัััะธัะฐะฝั ะบะฐะบ
`remainingProtein ร 0.9`. ะัะปะธ ัะฒะตััั ะฟัะธะผะตะฝะธัั C35 (prot ร 1.20), ะฑะตะปะพะบ
ะฒััะฐััะฐะตั ะดะพ 117 ะณ โ P5 cap ะพะฑัะตะทะฐะตั ะดะพ 100 ะณ. ะะพะปัะทะพะฒะฐัะตะปั ัะตััะตั ะธะฝัะพัะผะฐัะธั ะพ
ัะตะฐะปัะฝะพะผ ะพััะฐัะบะต. ะะพััะพะผั ะดะปั last meal ะฟะฐััะตัะฝ-ะผะพะดะธัะธะบะฐัะพัั ะพัะบะปััะตะฝั.

### Q: ะงัะพ ะปะพะณะธััะตััั ะฒ production?

ะะพ ะฟัะฐะฒะธะปะฐะผ HEYS, ะฒัะต ะบะปััะตะฒัะต ัะพัะบะธ ะปะพะณะธัััััั ั `console.info`:

```
[MEALREC][ProductPicker] ๐งช [macro] ะััะธัะฐ: ideal=P45/C15/F40, prod=P58/C0/F42, scores=prot=74,carb=70,fat=97
[MEALREC][ProductPicker] ๐ฏ High-score product: ะััะธัะฐ score=79 topFactors=proteinAlignment=74, fatAlignment=97, carbAlignment=70, kcalFit=100
[MEALREC][ProductPicker] ๐ฅ Products picked: [PROTEIN_DEFICIT] PROTEIN | Strategy: HISTORY | Evaluated: 12
[MEALREC][MealPlanner]   โ Plan: 2 meals (16:15 + 19:05), budget: 720 + 480 = 1200 kcal
```

---

## Changelog

| ะะตััะธั               | ะะฐัะฐ       | ะะทะผะตะฝะตะฝะธั                                                               |
| -------------------- | ---------- | ----------------------------------------------------------------------- |
| v3.5.0 (recommender) | 2026-02-19 | S9 phenotype auto-detect, R1/R3 protein fix                             |
| v2.1.0 (planner)     | 2026-02-19 | S8 volume-scaled wave + forceMultiMeal gap fix                          |
| v4.0.4               | 2026-02-19 | topFactors ะพััะพััะธัะพะฒะฐะฝั ะฟะพ weighted contribution                       |
| v4.0.3               | 2026-02-19 | ะัะฟัะฐะฒะปะตะฝั field names ะฒ enrichMacros (protein100/simple100/complex100) |
| v4.0.2               | 2026-02-19 | ะะพะฑะฐะฒะปะตะฝั enrichMacros + sharedIndex ะดะปั lookup ะผะฐะบัะพัะพะฒ                |
| v4.0.1               | 2026-02-19 | SCENARIO_IDEAL_MACRO_PROFILES โ fix ะฟะปะพัะบะพะณะพ ัะบะพัะธะฝะณะฐ                   |
| v4.0.0               | 2026-02-18 | 14-ัะฐะบัะพัะฝัะน ัะบะพัะธะฝะณ, ัะตะฑะฐะปะฐะฝัะธัะพะฒะบะฐ ะฒะตัะพะฒ, fatAlignment, soft kcalFit  |
| v3.5.0               | 2026-02-17 | Feedback ML + phenotype + S9 auto-detect                                |
| v3.0                 | 2026-02-16 | Phase B/C integration, POST_WORKOUT/PRE_SLEEP overrides                 |
| v2.1.0               | 2026-02-15 | Sprint 3 science (S1โS8), hunger trade-off, chrono-blend                |
| v1.0                 | 2026-02-14 | Initial meal recommendation system                                      |
