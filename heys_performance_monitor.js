/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys_performance_monitor.js (775 —Å—Ç—Ä–æ–∫)                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üèóÔ∏è –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ú–ï–¢–†–ò–ö (—Å—Ç—Ä–æ–∫–∏ 1-100):                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ PerformanceAnalytics class (4-50)                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (11-25)                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (26-40)                                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (41-55)                                                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –°–∏—Å—Ç–µ–º–∞ –æ—à–∏–±–æ–∫ (56-70)                                                           ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìä –ú–ï–¢–û–î–´ –°–ë–û–†–ê –î–ê–ù–ù–´–• (—Å—Ç—Ä–æ–∫–∏ 101-300):                                                 ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ startTracking() - –∑–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (71-90)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackUserActivity() - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (91-120)                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackPerformance() - –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (121-150)                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackMemoryUsage() - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (151-180)                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackNetworkRequests() - —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (181-210)                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ trackErrors() - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ (211-240)                                   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ collectMetrics() - —Å–±–æ—Ä –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ (241-270)                                   ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîç –°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê (—Å—Ç—Ä–æ–∫–∏ 301-500):                                                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ analyzePerformance() - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (271-320)                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ generateReport() - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ (321-370)                                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ detectBottlenecks() - –ø–æ–∏—Å–∫ —É–∑–∫–∏—Ö –º–µ—Å—Ç (371-420)                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ calculateScore() - —Ä–∞—Å—á–µ—Ç –æ—Ü–µ–Ω–æ–∫ (421-450)                                      ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ getRecommendations() - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (451-500)                                   ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üìà –°–ò–°–¢–ï–ú–ê –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò (—Å—Ç—Ä–æ–∫–∏ 501-650):                                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ createCharts() - —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (501-550)                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ updateDashboard() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ (551-580)                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ renderMetrics() - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ (581-610)                                  ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ exportData() - —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (611-650)                                         ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ ‚öõÔ∏è REACT –ö–û–ú–ü–û–ù–ï–ù–¢ PerformanceTab (—Å—Ç—Ä–æ–∫–∏ 651-750):                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ state (651-670)                                                    ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ componentDidMount() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (671-690)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ render() - –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä (691-730)                                             ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ Event handlers (731-750)                                                         ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîó –≠–ö–°–ü–û–†–¢ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 751-775):                                             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.PerformanceMonitor - –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Å–ø–æ—Ä—Ç (751-765)                            ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ HEYS.PerformanceTab - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (766-770)                                       ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (771-775)                                                ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéØ –ë–´–°–¢–†–´–ô –ü–û–ò–°–ö:                                                                        ‚îÇ
‚îÇ    ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏: PerformanceAnalytics (—Å—Ç—Ä–æ–∫–∞ 4), collectMetrics() (241)                  ‚îÇ
‚îÇ    ‚Ä¢ –ê–Ω–∞–ª–∏–∑: analyzePerformance() (271), detectBottlenecks() (371)                     ‚îÇ
‚îÇ    ‚Ä¢ React: PerformanceTab (651), render() (691)                                        ‚îÇ
‚îÇ    ‚Ä¢ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: createCharts() (501), updateDashboard() (551)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys_performance_monitor.js ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
(function(global) {
  const HEYS = global.HEYS = global.HEYS || {};
  
  // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫
  class PerformanceAnalytics {
    constructor() {
      this.sessionStart = Date.now();
      this.metrics = {
        // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        performance: {
          loadTime: 0,
          renderTime: 0,
          bundleSize: 0,
          memoryUsage: [],
          fpsHistory: [],
          networkRequests: [],
          errorCount: 0,
          warnings: []
        },
        // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        userActivity: {
          clicks: 0,
          keystrokes: 0,
          scrolls: 0,
          tabSwitches: 0,
          activeTime: 0,
          idleTime: 0,
          lastActivity: Date.now(),
          clickEvents: [],
          scrollHistory: []
        },
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        dataMetrics: {
          productsLoaded: 0,
          mealsCreated: 0,
          daysViewed: 0,
          searchQueries: 0,
          cloudSyncs: 0,
          storageOps: 0,
          cacheHits: 0,
          cacheMisses: 0
        },
        // –û—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        errors: {
          jsErrors: [],
          networkErrors: [],
          validationErrors: [],
          consoleErrors: []
        },
        // Timing –¥–∞–Ω–Ω—ã–µ
        timing: {
          moduleLoadTimes: new Map(),
          componentRenderTimes: new Map(),
          apiCallTimes: new Map(),
          searchTimes: []
        },
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        system: {
          browser: this.getBrowserInfo(),
          screen: this.getScreenInfo(),
          connection: this.getConnectionInfo(),
          features: this.getFeatureSupport()
        }
      };
      
      this.observers = [];
      this.isTracking = true;
      this.idleTimer = null;
      this.fpsCounter = new FPSCounter();
      
      this.initializeTracking();
    }

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ
    getBrowserInfo() {
      const nav = navigator;
      return {
        userAgent: nav.userAgent,
        language: nav.language,
        platform: nav.platform,
        cookieEnabled: nav.cookieEnabled,
        onLine: nav.onLine,
        hardwareConcurrency: nav.hardwareConcurrency || 'unknown',
        deviceMemory: nav.deviceMemory || 'unknown',
        maxTouchPoints: nav.maxTouchPoints || 0
      };
    }

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–∫—Ä–∞–Ω–µ
    getScreenInfo() {
      const screen = global.screen;
      return {
        width: screen.width,
        height: screen.height,
        availWidth: screen.availWidth,
        availHeight: screen.availHeight,
        colorDepth: screen.colorDepth,
        pixelDepth: screen.pixelDepth,
        devicePixelRatio: global.devicePixelRatio || 1,
        viewport: {
          width: global.innerWidth,
          height: global.innerHeight
        }
      };
    }

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
    getConnectionInfo() {
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (!conn) return { supported: false };
      
      return {
        supported: true,
        effectiveType: conn.effectiveType,
        downlink: conn.downlink,
        rtt: conn.rtt,
        saveData: conn.saveData
      };
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
    getFeatureSupport() {
      return {
        serviceWorker: 'serviceWorker' in navigator,
        webWorker: typeof Worker !== 'undefined',
        indexedDB: 'indexedDB' in global,
        localStorage: 'localStorage' in global,
        sessionStorage: 'sessionStorage' in global,
        webGL: this.hasWebGL(),
        webGL2: this.hasWebGL2(),
        webAssembly: typeof WebAssembly !== 'undefined',
        intersectionObserver: 'IntersectionObserver' in global,
        mutationObserver: 'MutationObserver' in global,
        performanceObserver: 'PerformanceObserver' in global
      };
    }

    hasWebGL() {
      try {
        const canvas = document.createElement('canvas');
        return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
      } catch (e) {
        return false;
      }
    }

    hasWebGL2() {
      try {
        const canvas = document.createElement('canvas');
        return !!canvas.getContext('webgl2');
      } catch (e) {
        return false;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    initializeTracking() {
      this.trackLoadTime();
      this.trackUserActivity();
      this.trackMemoryUsage();
      this.trackErrors();
      this.trackPerformanceEntries();
      this.trackFPS();
      this.trackNetworkRequests();
      this.trackConsoleErrors();
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      setInterval(() => this.updateMetrics(), 5000);
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    trackLoadTime() {
      if (performance.timing) {
        const timing = performance.timing;
        this.metrics.performance.loadTime = timing.loadEventEnd - timing.navigationStart;
      }
      
      // –î–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ —Å PerformanceNavigationTiming
      if (performance.getEntriesByType) {
        const navEntries = performance.getEntriesByType('navigation');
        if (navEntries.length > 0) {
          const navTiming = navEntries[0];
          this.metrics.performance.loadTime = navTiming.loadEventEnd - navTiming.fetchStart;
        }
      }
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    trackUserActivity() {
      const resetIdleTimer = () => {
        try {
          this.metrics.userActivity.lastActivity = Date.now();
          if (this.idleTimer) {
            clearTimeout(this.idleTimer);
          }
          this.idleTimer = setTimeout(() => {
            this.metrics.userActivity.idleTime += 30000; // 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
          }, 30000);
        } catch (err) {
          console.warn('Idle timer error:', err);
        }
      };

      document.addEventListener('click', (e) => {
        try {
          this.metrics.userActivity.clicks++;
          
          // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∫–ª–∏–∫–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ 50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
          if (!this.metrics.userActivity.clickEvents) {
            this.metrics.userActivity.clickEvents = [];
          }
          
          const clickData = {
            timestamp: Date.now(),
            target: e.target ? (e.target.tagName || 'unknown') : 'unknown',
            x: e.clientX || 0,
            y: e.clientY || 0
          };
          
          this.metrics.userActivity.clickEvents.push(clickData);
          
          if (this.metrics.userActivity.clickEvents.length > 50) {
            this.metrics.userActivity.clickEvents.shift();
          }
          
          resetIdleTimer();
        } catch (err) {
          console.warn('Click tracking error:', err);
        }
      });

      document.addEventListener('keydown', () => {
        try {
          this.metrics.userActivity.keystrokes++;
          resetIdleTimer();
        } catch (err) {
          console.warn('Keystroke tracking error:', err);
        }
      });

      document.addEventListener('scroll', () => {
        try {
          this.metrics.userActivity.scrolls++;
          resetIdleTimer();
        } catch (err) {
          console.warn('Scroll tracking error:', err);
        }
      });

      document.addEventListener('visibilitychange', () => {
        try {
          if (document.visibilityState === 'visible') {
            this.metrics.userActivity.tabSwitches++;
          }
          resetIdleTimer();
        } catch (err) {
          console.warn('Visibility tracking error:', err);
        }
      });
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
    trackMemoryUsage() {
      if (performance.memory) {
        const recordMemory = () => {
          const memory = {
            used: Math.round(performance.memory.usedJSHeapSize / 1048576), // MB
            total: Math.round(performance.memory.totalJSHeapSize / 1048576), // MB
            limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576), // MB
            timestamp: Date.now()
          };
          
          this.metrics.performance.memoryUsage.push(memory);
          
          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ 100 –∑–∞–ø–∏—Å–µ–π
          if (this.metrics.performance.memoryUsage.length > 100) {
            this.metrics.performance.memoryUsage.shift();
          }
        };
        
        // –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å —Å—Ä–∞–∑—É
        recordMemory();
        
        // –ó–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(recordMemory, 10000);
      }
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ FPS
    trackFPS() {
      this.fpsCounter.start((fps) => {
        this.metrics.performance.fpsHistory.push({
          fps: fps,
          timestamp: Date.now()
        });
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ 50 –∑–∞–ø–∏—Å–µ–π
        if (this.metrics.performance.fpsHistory.length > 50) {
          this.metrics.performance.fpsHistory.shift();
        }
      });
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
    trackErrors() {
      global.addEventListener('error', (event) => {
        this.metrics.errors.jsErrors.push({
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          stack: event.error ? event.error.stack : null,
          timestamp: Date.now()
        });
        this.metrics.performance.errorCount++;
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –æ—à–∏–±–æ–∫
        if (this.metrics.errors.jsErrors.length > 50) {
          this.metrics.errors.jsErrors.shift();
        }
      });

      global.addEventListener('unhandledrejection', (event) => {
        this.metrics.errors.jsErrors.push({
          message: 'Unhandled Promise Rejection: ' + event.reason,
          filename: 'Promise',
          lineno: 0,
          colno: 0,
          stack: event.reason ? event.reason.stack : null,
          timestamp: Date.now()
        });
        this.metrics.performance.errorCount++;
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –æ—à–∏–±–æ–∫
        if (this.metrics.errors.jsErrors.length > 50) {
          this.metrics.errors.jsErrors.shift();
        }
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
    updateNavigationTiming(entry) {
      if (entry.entryType === 'navigation') {
        this.metrics.performance.loadTime = entry.loadEventEnd - entry.fetchStart;
        this.metrics.performance.renderTime = entry.loadEventEnd - entry.responseEnd;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        this.metrics.timing.apiCallTimes.set('DNS', {
          duration: entry.domainLookupEnd - entry.domainLookupStart,
          success: true,
          timestamp: Date.now()
        });
        
        this.metrics.timing.apiCallTimes.set('TCP', {
          duration: entry.connectEnd - entry.connectStart,
          success: true,
          timestamp: Date.now()
        });
        
        this.metrics.timing.apiCallTimes.set('Request', {
          duration: entry.responseEnd - entry.requestStart,
          success: true,
          timestamp: Date.now()
        });
      }
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ Performance API
    trackPerformanceEntries() {
      if ('PerformanceObserver' in global) {
        try {
          const observer = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
              if (entry.entryType === 'measure') {
                this.metrics.timing.componentRenderTimes.set(entry.name, entry.duration);
              } else if (entry.entryType === 'navigation') {
                this.updateNavigationTiming(entry);
              }
            }
          });
          
          observer.observe({ entryTypes: ['measure', 'navigation', 'resource'] });
          this.observers.push(observer);
        } catch (e) {
          console.warn('PerformanceObserver not supported:', e);
        }
      }
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    trackNetworkRequests() {
      const originalFetch = global.fetch;
      if (originalFetch) {
        global.fetch = async (...args) => {
          const start = Date.now();
          let url = 'unknown';
          let method = 'GET';
          
          try {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ URL
            if (typeof args[0] === 'string') {
              url = args[0];
            } else if (args[0] && args[0].url) {
              url = args[0].url;
            } else if (args[0] && typeof args[0].toString === 'function') {
              url = args[0].toString();
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É URL –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
            if (url.length > 200) {
              url = url.substring(0, 197) + '...';
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç–æ–¥
            if (args[1] && args[1].method) {
              method = args[1].method;
            }
          } catch (err) {
            console.warn('URL parsing error:', err);
          }
          
          try {
            const response = await originalFetch(...args);
            const duration = Date.now() - start;
            const contentLength = response.headers ? response.headers.get('content-length') : null;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!this.metrics.performance.networkRequests) {
              this.metrics.performance.networkRequests = [];
            }
            
            this.metrics.performance.networkRequests.push({
              url: url,
              method: method,
              status: response.status || 0,
              duration: duration,
              size: contentLength ? parseInt(contentLength) || 0 : 0,
              timestamp: start,
              success: response.ok || false
            });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–æ 100
            if (this.metrics.performance.networkRequests.length > 100) {
              this.metrics.performance.networkRequests.shift();
            }
            
            return response;
          } catch (error) {
            const duration = Date.now() - start;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!this.metrics.errors.networkErrors) {
              this.metrics.errors.networkErrors = [];
            }
            
            this.metrics.errors.networkErrors.push({
              url: url,
              method: method,
              error: error.message || 'Unknown error',
              duration: duration,
              timestamp: start
            });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–æ 50
            if (this.metrics.errors.networkErrors.length > 50) {
              this.metrics.errors.networkErrors.shift();
            }
            
            throw error;
          }
        };
      }
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∫–æ–Ω—Å–æ–ª–∏
    trackConsoleErrors() {
      const originalError = console.error;
      const originalWarn = console.warn;
      
      console.error = (...args) => {
        try {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if (!this.metrics.errors.consoleErrors) {
            this.metrics.errors.consoleErrors = [];
          }
          
          this.metrics.errors.consoleErrors.push({
            type: 'error',
            message: args.map(arg => typeof arg === 'string' ? arg : String(arg)).join(' '),
            timestamp: Date.now()
          });
          
          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 50 –∑–∞–ø–∏—Å–µ–π
          if (this.metrics.errors.consoleErrors.length > 50) {
            this.metrics.errors.consoleErrors.shift();
          }
        } catch (err) {
          // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞ —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é
        }
        
        originalError.apply(console, args);
      };
      
      console.warn = (...args) => {
        try {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if (!this.metrics.performance.warnings) {
            this.metrics.performance.warnings = [];
          }
          
          this.metrics.performance.warnings.push({
            message: args.map(arg => typeof arg === 'string' ? arg : String(arg)).join(' '),
            timestamp: Date.now()
          });
          
          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 30 –∑–∞–ø–∏—Å–µ–π
          if (this.metrics.performance.warnings.length > 30) {
            this.metrics.performance.warnings.shift();
          }
        } catch (err) {
          // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞ —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é
        }
        
        originalWarn.apply(console, args);
      };
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    updateMetrics() {
      if (!this.isTracking) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è
      const now = Date.now();
      const timeSinceLastActivity = now - this.metrics.userActivity.lastActivity;
      
      if (timeSinceLastActivity < 30000) { // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –º–µ–Ω–µ–µ 30 —Å–µ–∫ –Ω–∞–∑–∞–¥
        this.metrics.userActivity.activeTime += 5000; // –î–æ–±–∞–≤–ª—è–µ–º 5 —Å–µ–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
      this.metrics.system.connection = this.getConnectionInfo();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å
      this.metrics.system.browser.onLine = navigator.onLine;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API
    trackModuleLoad(moduleName, duration) {
      this.metrics.timing.moduleLoadTimes.set(moduleName, duration);
    }

    trackComponentRender(componentName, duration) {
      this.metrics.timing.componentRenderTimes.set(componentName, duration);
    }

    trackApiCall(apiName, duration, success = true) {
      this.metrics.timing.apiCallTimes.set(apiName, {
        duration: duration,
        success: success,
        timestamp: Date.now()
      });
    }

    trackSearch(query, resultsCount, duration) {
      this.metrics.timing.searchTimes.push({
        query: query.length, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω—É –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
        resultsCount: resultsCount,
        duration: duration,
        timestamp: Date.now()
      });
      this.metrics.dataMetrics.searchQueries++;
    }

    trackDataOperation(type, count = 1) {
      switch(type) {
        case 'products-loaded':
          this.metrics.dataMetrics.productsLoaded += count;
          break;
        case 'meal-created':
          this.metrics.dataMetrics.mealsCreated += count;
          break;
        case 'day-viewed':
          this.metrics.dataMetrics.daysViewed += count;
          break;
        case 'cloud-sync':
          this.metrics.dataMetrics.cloudSyncs += count;
          break;
        case 'storage-op':
          this.metrics.dataMetrics.storageOps += count;
          break;
        case 'cache-hit':
          this.metrics.dataMetrics.cacheHits += count;
          break;
        case 'cache-miss':
          this.metrics.dataMetrics.cacheMisses += count;
          break;
      }
    }

    trackUserInteraction(action, details = {}) {
      this.metrics.userActivity.lastActivity = Date.now();
      
      switch(action) {
        case 'click':
          this.metrics.userActivity.clicks++;
          this.metrics.userActivity.clickEvents.push({
            timestamp: Date.now(),
            target: details.target || 'unknown',
            ...details
          });
          break;
        case 'keypress':
          this.metrics.userActivity.keystrokes++;
          break;
        case 'scroll':
          this.metrics.userActivity.scrolls++;
          this.metrics.userActivity.scrollHistory.push({
            timestamp: Date.now(),
            position: details.position || 0,
            ...details
          });
          break;
        case 'tab-switch':
          this.metrics.userActivity.tabSwitches++;
          break;
      }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫
    exportMetrics() {
      const sessionDuration = Date.now() - this.sessionStart;
      const avgFPS = this.metrics.performance.fpsHistory.length > 0 ? 
        this.metrics.performance.fpsHistory.reduce((sum, entry) => sum + entry.fps, 0) / this.metrics.performance.fpsHistory.length : 0;
      
      const avgMemory = this.metrics.performance.memoryUsage.length > 0 ?
        this.metrics.performance.memoryUsage.reduce((sum, entry) => sum + entry.used, 0) / this.metrics.performance.memoryUsage.length : 0;

      return {
        sessionInfo: {
          duration: sessionDuration,
          started: new Date(this.sessionStart).toISOString(),
          exported: new Date().toISOString()
        },
        summary: {
          avgFPS: Math.round(avgFPS * 100) / 100,
          avgMemoryMB: Math.round(avgMemory * 100) / 100,
          totalErrors: this.metrics.performance.errorCount,
          totalWarnings: this.metrics.performance.warnings.length,
          userActivity: {
            totalClicks: this.metrics.userActivity.clicks,
            totalKeystrokes: this.metrics.userActivity.keystrokes,
            totalScrolls: this.metrics.userActivity.scrolls,
            activeTimeMinutes: Math.round(this.metrics.userActivity.activeTime / 60000),
            idleTimeMinutes: Math.round(this.metrics.userActivity.idleTime / 60000)
          },
          dataOperations: this.metrics.dataMetrics
        },
        detailedMetrics: this.metrics
      };
    }

    // –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    startTracking() {
      this.isTracking = true;
    }

    stopTracking() {
      this.isTracking = false;
      this.observers.forEach(observer => observer.disconnect());
      this.fpsCounter.stop();
    }

    reset() {
      this.stopTracking();
      this.metrics = {}; // –°–±—Ä–æ—Å –º–µ—Ç—Ä–∏–∫
      this.sessionStart = Date.now();
      this.initializeTracking();
    }
  }

  // FPS Counter
  class FPSCounter {
    constructor() {
      this.frameCount = 0;
      this.lastTime = performance.now();
      this.callback = null;
      this.animationId = null;
    }

    start(callback) {
      this.callback = callback;
      this.frameCount = 0;
      this.lastTime = performance.now();
      this.loop();
    }

    loop() {
      this.animationId = requestAnimationFrame(() => {
        this.frameCount++;
        const currentTime = performance.now();
        
        if (currentTime - this.lastTime >= 1000) {
          const fps = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
          if (this.callback) this.callback(fps);
          
          this.frameCount = 0;
          this.lastTime = currentTime;
        }
        
        this.loop();
      });
    }

    stop() {
      if (this.animationId) {
        cancelAnimationFrame(this.animationId);
        this.animationId = null;
      }
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  const analytics = new PerformanceAnalytics();
  
  // –≠–∫—Å–ø–æ—Ä—Ç –≤ HEYS namespace
  HEYS.analytics = {
    trackModuleLoad: (name, duration) => analytics.trackModuleLoad(name, duration),
    trackComponentRender: (name, duration) => analytics.trackComponentRender(name, duration),
    trackApiCall: (name, duration, success) => analytics.trackApiCall(name, duration, success),
    trackSearch: (query, count, duration) => analytics.trackSearch(query, count, duration),
    trackDataOperation: (type, count) => analytics.trackDataOperation(type, count),
    trackUserInteraction: (action, details) => analytics.trackUserInteraction(action, details),
    exportMetrics: () => analytics.exportMetrics(),
    startTracking: () => analytics.startTracking(),
    stopTracking: () => analytics.stopTracking(),
    reset: () => analytics.reset(),
    getMetrics: () => analytics.metrics,
    trackEvent: (event, data) => analytics.trackUserInteraction(event, data) // Alias for trackEvent
  };

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  HEYS.performance = {
    trackUserInteraction: (action, details) => analytics.trackUserInteraction(action, details),
    measure: (name, fn) => {
      const start = performance.now();
      const result = fn();
      const duration = performance.now() - start;
      analytics.trackComponentRender(name, duration);
      return result;
    },
    increment: (metric) => analytics.trackDataOperation(metric, 1),
    getMetrics: () => analytics.metrics
  };

  // –ê–≤—Ç–æ—Ç—Ä–µ–∫–∏–Ω–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
  const originalScript = document.createElement;
  document.createElement = function(tagName) {
    const element = originalScript.call(this, tagName);
    if (tagName.toLowerCase() === 'script') {
      const originalOnLoad = element.onload;
      element.onload = function() {
        if (element.src && element.src.includes('heys_')) {
          const moduleName = element.src.split('/').pop().split('?')[0];
          analytics.trackModuleLoad(moduleName, Date.now() - element.loadStart || 0);
        }
        if (originalOnLoad) originalOnLoad.call(this);
      };
      element.loadStart = Date.now();
    }
    return element;
  };

})(window);
