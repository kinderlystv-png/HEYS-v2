## HEYS Telegram mini‑app — бриф для AI

Краткое описание логики и экранов мини‑приложения HEYS внутри Telegram. Документ предназначен для людей и AI (можно безопасно использовать как контекст при доработках).

---

## 1. Назначение mini‑app

**Mini‑app = рабочий инструмент куратора внутри Telegram.**

На первом этапе:

- Клиент **не** заходит в мини‑апп.
- Мини‑апп используется только кураторами для ввода и просмотра данных клиентов.
- Мини‑апп логически заменяет «зайти в веб‑версию HEYS», но находится прямо в Telegram (WebApp).

Главный сценарий:

> Куратор получает данные от клиента (в голосе/тексте/фото в Telegram), открывает mini‑app, выбирает клиента, заносит данные и сразу видит базовую аналитику по дню/неделе.

---

## 2. Пользовательский поток куратора

1. **Получение информации от клиента**
   - Канал связи: личный чат / групповой чат / бот.
   - Формат: текст, голос, фото, любые сообщения.
   - На первом этапе бот не обязателен (можем использовать только живой диалог).

2. **Открытие mini‑app**
   - У куратора есть бот с кнопкой «Открыть панель куратора» (Telegram WebApp).
   - Нажатие на кнопку открывает наш mini‑app внутри Telegram.

3. **Выбор клиента в mini‑app**
   - Куратор видит список своих клиентов.
   - Есть поиск и базовые фильтры (например, активные клиенты).
   - Клик по клиенту → переход на экран «День клиента» (с возможностью переключения диапазона: день/неделя).

4. **Ввод/редактирование данных за клиента**
   - На экране клиента куратор:
     - добавляет приёмы пищи (на основании переписки с клиентом);
     - редактирует существующие записи, если были ошибки;
     - сохраняет изменения.
   - Все данные попадают в ту же базу HEYS, что и текущая веб‑версия.

5. **Просмотр аналитики**
   - На этом же экране куратор видит:
     - суммарные калории/БЖУ за день/неделю;
     - базовые индикаторы (например, попадание/непопадание в коридор);
     - ключевые графики (вес/динамика, если уже реализованы в HEYS).
   - Задача: **быстрая оценка дня клиента без выхода из Telegram.**

---

## 3. Роли и безопасность

Мини‑апп доступен только кураторам.

- Для каждого куратора в базе HEYS храним `telegram_user_id`.
- При входе в mini‑app сервер:
  - получает `initData` из `Telegram.WebApp`;
  - проверяет подпись (Telegram WebApp auth);
  - извлекает `user_id` и ищет соответствующего куратора.
- Если куратор найден → даём доступ к его панели.
- Если пользователь не найден → возвращаем 403 / экран «доступ только для кураторов».

На первом этапе:

- Клиенты **не** авторизуются в мини‑аппе.
- Взаимодействие клиента с HEYS идёт через переписку (чат/бот), без входа в WebApp.

---

## 4. Минимальный набор экранов v1

Версия v1 должна быть максимально компактной, чтобы можно было быстро обкатать сценарий для кураторов и постепенно наращивать функциональность.

### 4.1. Экран 1 — «Список клиентов»

Цель: дать куратору быстрый доступ к нужному клиенту.

Функции:

- Список клиентов, привязанных к куратору.
- Поиск по имени / никнейму / ID.
- Базовый фильтр (например, «активные» / «на паузе» — опционально).
- Клик по клиенту → переход к экрану «День клиента».

### 4.2. Экран 2 — «День клиента»

Цель: рабочий экран куратора по конкретному клиенту.

Функции:

- Отображение приёмов пищи за выбранный день.
- Кнопка «Добавить приём пищи».
- Возможность отредактировать/удалить уже внесённый приём.
- Переключатель даты (стрелки «вчера/сегодня/завтра» или выбор даты).

Логика хранения:

- Все изменения сохраняются в ту же модель данных HEYS.
- Mini‑app не вводит новую схему данных, а использует существующие сущности (приёмы пищи, дневники, и т.п.).

### 4.3. Экран 3 — «Краткая сводка по дню»

Можно реализовать как часть экрана «День клиента» (блок вверху/внизу).

Минимальный набор показателей:

- Суммарные калории за день.
- БЖУ (в сумме + попадание/непопадание в коридоры).
- 1–2 ключевых индикатора (например, «выполнен план по калориям / нет», «красная/зелёная зона»).

Задача: куратор одним взглядом понимает, насколько день «в норме».

---

## 5. Принципы интеграции с текущим проектом

Для минимизации сложности и дублирования кода:

- Mini‑app использует **тот же backend и модели**, что и основное приложение HEYS.
- Бизнес‑логика по расчёту калорий, БЖУ и индикаторов берётся из `packages/core` / `packages/shared` (где это реализовано сейчас).
- Mini‑app — это **отдельная оболочка/entry‑point под Telegram**, а не новый продукт:
  - отдельный фронтенд‑entry (например, `apps/tg-mini` или отдельный HTML/JS бандл);
  - адаптированный UI под небольшой экран и Telegram WebApp API.

В будущем можно добавить:

- режим для клиента (отдельная роль);
- быстрый переход из сообщений бота к конкретному дню/клиенту в mini‑app;
- дополнительные отчёты и графики.

Настоящий документ можно расширять по мере эволюции mini‑аппа (v2, v3 и т.д.), сохраняя структуру: назначение → поток → роли → экраны → интеграция.

---

## 6. Roadmap v1 — итерации разработки

Разработка ведётся маленькими шагами с постоянным обновлением этого брифа. Для каждого шага: реализация → тестирование → обновление брифа (отмечаем сделанное, формулируем следующий шаг).

### Текущий статус: Итерация 4 завершена ✅ → Итерация 5 в процессе

### Итерации

#### Итерация 1 — Базовая оболочка mini‑app ✅
- [x] Определить место в репо: `apps/tg-mini/`.
- [x] Создать entry‑point: минимальная HTML‑страница с текстом «HEYS mini‑app работает».
- [x] Настроить сборку (Vite) для этого entry‑point.
- [x] Проверить локально: открывается в браузере, показывает текст.

**Реализовано:**
- Структура: `apps/tg-mini/` с package.json, vite.config.ts, tsconfig.json
- Entry: `index.html` + `src/main.tsx` + `src/App.tsx`
- Dev-сервер: работает на `http://localhost:3002`
- Базовый UI: адаптирован под Telegram WebApp цвета (CSS-переменные `--tg-theme-*`)

#### Итерация 2 — Интеграция с Telegram WebApp ✅
- [x] Подключить `Telegram.WebApp` (скрипт из CDN).
- [x] Инициализация: `Telegram.WebApp.ready()`.
- [x] Вывести в консоль `initData` и `user` из Telegram.
- [ ] Проверить в Telegram (создать тестового бота, прописать URL mini‑app).

**Реализовано:**
- SDK подключен через CDN в `index.html`
- Создан хук `useTelegramWebApp` в `src/hooks/useTelegramWebApp.ts`
- TypeScript типы для Telegram WebApp в `src/telegram.d.ts`
- App.tsx теперь отображает данные пользователя, версию WebApp, initData
- Работает в двух режимах: Telegram WebApp (если открыто в Telegram) и браузерный (для локальной разработки)
- HMR работает, изменения применяются автоматически

**Примечание:** 
Проверка в реальном Telegram — опционально на этом этапе. Для локальной разработки достаточно браузерного режима. Интеграцию с ботом можно сделать позже, когда будет готов UI с клиентами.

#### Итерация 3 — Контракт API «Список клиентов» ✅
- [x] Описать API endpoint: `GET /api/curator/clients`.
- [x] Определить структуру ответа (массив клиентов: `id`, `name`, `status`, и т.п.).
- [x] Документировать в отдельном файле или в коде (JSDoc / комментарии).
- [x] **Не реализовывать backend**, только зафиксировать контракт.

**Реализовано:**
- TypeScript типы в `apps/tg-mini/src/types/api.ts`:
  - `CuratorClient` — минимальный DTO клиента для списка
  - `ClientDetails` — детальная информация о клиенте
  - `ClientDayData` — данные дня с приёмами пищи
  - `GetClientsResponse`, `GetClientsParams` — запрос/ответ списка
- Документация API контракта в `apps/tg-mini/API_CONTRACT.md`:
  - 6 эндпоинтов: список клиентов, детали клиента, данные дня, CRUD приёмов пищи
  - Полное описание структуры запросов/ответов с примерами JSON
  - Описание аутентификации (Telegram initData + JWT)
  - Коды ошибок и edge cases
- Контракт покрывает все потребности mini-app v1 без избыточности

#### Итерация 4 — Экран «Список клиентов» ✅
- [x] Создать компонент/экран со списком клиентов (пока на моках / dev-endpoint).
- [x] Добавить поиск по имени/email (фильтрация + серверные query‑параметры).
- [x] Клик по клиенту → переход на роут «День клиента» (заглушка + Telegram BackButton).
- [x] Подключить API‑слой (fetch + моковые данные через `VITE_USE_CLIENT_MOCKS`).

**Реализовано:**
- `apps/tg-mini/src/screens/ClientListScreen.tsx` — полноценный UI: поиск, фильтр статуса, пагинация, карточки (`ClientListItem`).
- `apps/tg-mini/src/components/ClientListItem.tsx` — карточка клиента с БЖУ‑сводкой и датой последней активности.
- `apps/tg-mini/src/hooks/useCuratorClients.ts` + `src/api/clients.ts` — загрузка списка с обработкой ошибок, пагинацией и мок‑режимом.
- Навигация в `App.tsx`: хранит выбранного клиента, переключает `ClientListScreen` ↔ `ClientDayScreen`.
- Заглушка `ClientDayScreen` теперь показывает имя клиента и подключает Telegram `BackButton`.

#### Итерация 5 — Экран «День клиента» (локальная логика готова)
- [x] API-слой: `GET /api/curator/clients/:clientId` + `GET /api/curator/clients/:clientId/day/:date` (моки для dev через `src/api/clientDay.ts`).
- [x] Хук `useClientDay` (стейт даты, загрузка деталей клиента и приёмов, обработка ошибок, refetch).
- [x] UI-структура: шапка с именем клиента + краткая сводка, переключатель дат (◀️ / ▶️ / выбор даты).
- [x] Список приёмов пищи: карточки с типом, временем, продуктами и суммами нутриентов.
- [x] Кнопки действий: «Добавить приём пищи», «Редактировать», «Удалить» — сейчас работают локально (обновляют state без backend).
- [x] Хэндлинг пустого дня / ошибок / состояния загрузки (сообщения + retry).
- [x] Простая локальная форма (React-state) для добавления приёма: выбор типа, время, произвольный продукт, пересчёт totals без обращения к backend.
- [x] Временное редактирование/удаление в `useClientDay`: операции меняют `dayData` локально, чтобы UI был интерактивен до появления API.

**Реализовано:** `ClientDayScreen` теперь показывает реальные данные из `useClientDay`, позволяет добавить локальный приём через форму (тип, время, продукт, нутриенты) и поддерживает редактирование/удаление локальных записей (id `local-*`). Totals пересчитываются на лету в хуке.

#### Итерация 6 — Краткая сводка по дню (готово в UI)
- [x] Добавить блок в экране «День клиента» (новый компонент `DayIndicators`).
- [x] Показать суммарные калории, БЖУ и индикатор попадания в коридор (цветовые статусы + проценты выполнения цели).
- [x] Переиспользовать логику расчёта из `packages/core` (`NutritionService.calculateMacroRatio`).
- [x] Проверить корректность расчётов на моковых данных `useClientDay` (ручное тестирование: добавление/редактирование локальных приёмов пересчитывает статус и проценты).

**Реализовано:** `apps/tg-mini/src/screens/ClientDayScreen.tsx` рендерит блок «Баланс калорий / Баланс БЖУ», использует `NutritionService` для вычисления процентов и подсвечивает состояние относительно целевых калорий клиента. Блок автоматически обновляется при локальном CRUD.

#### Итерация 7 — Авторизация куратора
- [ ] На бэкенде: endpoint для проверки `initData` от Telegram.
- [ ] Проверка подписи (HMAC с токеном бота).
- [ ] Поиск куратора по `telegram_user_id`.
- [ ] Если не найден → возврат 403 / экран «доступ запрещён».
- [ ] Тестирование с реальным Telegram‑аккаунтом куратора.

### Принципы работы с roadmap

- После завершения итерации: отметить `[x]` у выполненных пунктов.
- Добавить краткую заметку о результате (например, «Реализовано в `apps/tg-mini/src/screens/ClientList.jsx`»).
- Сформулировать следующую итерацию, если нужны уточнения или появились новые требования.
- Roadmap живой: можно менять порядок, добавлять/убирать шаги по мере необходимости.