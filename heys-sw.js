/*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üó∫Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ö–ê–†–¢–ê –§–ê–ô–õ–ê heys-sw.js (384 —Å—Ç—Ä–æ–∫–∏) - v2.1.0-timeout-fix             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìã –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê:                                                                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 1-30):                                                           ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è: CACHE_NAME, STATIC_CACHE, DYNAMIC_CACHE (2-4)             ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ú–∞—Å—Å–∏–≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤: STATIC_ASSETS (7-24)                                ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Service Worker (1-30)                                                   ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üì¶ –°–û–ë–´–¢–ò–Ø SERVICE WORKER (—Å—Ç—Ä–æ–∫–∏ 31-150):                                               ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ install - –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (31-50)                                      ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ activate - –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–µ—à–µ–π (51-80)                              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ fetch - –ø–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (81-150)                       ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üöÄ –ö–ï–®–ò–†–û–í–ê–ù–ò–ï (—Å—Ç—Ä–æ–∫–∏ 151-250):                                                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è Cache First –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (151-180)                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è Network First –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (181-210)                              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞ (211-250)                                                ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 251-350):                                                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Background Sync –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (251-280)                                ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (281-310)                                     ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ Push —Å–æ–æ–±—â–µ–Ω–∏—è (311-350)                                           ‚îÇ
‚îÇ                                                                                           ‚îÇ
‚îÇ ‚ö° –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–∫–∏ 351-384):                                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (351-370)                                      ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–µ—à–µ–π (371-384)                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/

// heys-sw.js - Service Worker –¥–ª—è HEYS - v2.1.0-timeout-fix
const CACHE_NAME = 'heys-cache-v2.1.0';
const STATIC_CACHE = 'heys-static-v2.1.0';
const DYNAMIC_CACHE = 'heys-dynamic-v2.1.0';

// –§–∞–π–ª—ã –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
const STATIC_ASSETS = [
  '/',
  '/index.html',
  '/styles/main.css',
  '/styles/common.css',
  '/styles/dark_tokens.css',
  '/heys_core_v12.js',
  '/heys_day_v12.js',
  '/heys_user_v12.js',
  '/heys_models_v1.js',
  '/heys_storage_layer_v1.js',
  '/heys_storage_indexeddb_v1.js',
  '/heys_worker_manager_v1.js',
  '/heys_integration_layer_v1.js',
  '/heys_analytics_ui.js',
  '/heys_performance_monitor.js',
  '/parse_worker.js',
];

// –°–æ–±—ã—Ç–∏—è Service Worker

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞
self.addEventListener('install', (event) => {
  console.log('[SW] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Service Worker');

  event.waitUntil(
    caches
      .open(STATIC_CACHE)
      .then((cache) => {
        console.log('[SW] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤');
        return cache.addAll(STATIC_ASSETS);
      })
      .then(() => {
        console.log('[SW] –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω—ã');
        return self.skipWaiting();
      })
      .catch((error) => {
        console.error('[SW] –û—à–∏–±–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
      }),
  );
});

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è
self.addEventListener('activate', (event) => {
  console.log('[SW] –ê–∫—Ç–∏–≤–∞—Ü–∏—è Service Worker');

  event.waitUntil(
    Promise.all([
      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–µ—à–µ–π
      caches.keys().then((cacheNames) => {
        return Promise.all(
          cacheNames.map((cacheName) => {
            if (cacheName !== STATIC_CACHE && cacheName !== DYNAMIC_CACHE) {
              console.log('[SW] –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–µ—à–∞:', cacheName);
              return caches.delete(cacheName);
            }
          }),
        );
      }),
      // –ü—Ä–∏–Ω—è—Ç–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
      self.clients.claim(),
    ]),
  );
});

// –ü–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
self.addEventListener('fetch', (event) => {
  const request = event.request;
  const url = new URL(request.url);

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º non-GET –∑–∞–ø—Ä–æ—Å—ã –∏ chrome-extension
  if (request.method !== 'GET' || url.protocol === 'chrome-extension:') {
    return;
  }

  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
  if (url.pathname.includes('/api/') || url.pathname.includes('supabase')) {
    event.respondWith(networkFirst(request));
    return;
  }

  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
  if (isStaticAsset(url.pathname)) {
    event.respondWith(cacheFirst(request));
    return;
  }

  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü
  if (request.destination === 'document') {
    event.respondWith(networkFirst(request));
    return;
  }

  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
  event.respondWith(networkFirst(request));
});

// –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

// Cache First - —Å–Ω–∞—á–∞–ª–∞ –∫–µ—à, –ø–æ—Ç–æ–º —Å–µ—Ç—å
async function cacheFirst(request) {
  try {
    const cacheResponse = await caches.match(request);
    if (cacheResponse) {
      console.log('üì¶ SW: Static resource from cache:', request.url);
      return cacheResponse;
    }

    console.log('üåê SW: Fetch from network:', request.url);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000);
    
    const networkResponse = await fetch(request, {
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);

    if (networkResponse.ok) {
      const cache = await caches.open(STATIC_CACHE);
      cache.put(request, networkResponse.clone());
    }

    return networkResponse;
  } catch (error) {
    console.error('üî¥ SW: Fetch error:', error, request.url);
    
    // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ fallback –≤ –∫–µ—à–µ
    const fallbackResponse = await caches.match(request);
    if (fallbackResponse) {
      console.log('üîÑ SW: Fallback from cache:', request.url);
      return fallbackResponse;
    }
    
    // –î–ª—è favicon –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
    if (request.url.includes('favicon.ico')) {
      return new Response('', {
        status: 204,
        statusText: 'No Content'
      });
    }
    
    return new Response(
      JSON.stringify({
        error: '–†–µ—Å—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ñ–ª–∞–π–Ω',
        url: request.url,
        timestamp: Date.now()
      }), 
      { 
        status: 503,
        headers: { 'Content-Type': 'application/json' }
      }
    );
  }
}

// Network First - —Å–Ω–∞—á–∞–ª–∞ —Å–µ—Ç—å, –ø–æ—Ç–æ–º –∫–µ—à
async function networkFirst(request) {
  try {
    console.log('[SW] Network First –∑–∞–ø—Ä–æ—Å:', request.url);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    const networkResponse = await fetch(request, {
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);

    if (networkResponse.ok) {
      const cache = await caches.open(DYNAMIC_CACHE);
      cache.put(request, networkResponse.clone());
    }

    return networkResponse;
  } catch (error) {
    console.log('[SW] –°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç, –∏—â–µ–º –≤ –∫–µ—à–µ:', request.url);

    const cacheResponse = await caches.match(request);
    if (cacheResponse) {
      console.log('[SW] –ù–∞–π–¥–µ–Ω–æ –≤ –∫–µ—à–µ:', request.url);
      return cacheResponse;
    }

    // –ï—Å–ª–∏ —ç—Ç–æ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ñ–ª–∞–π–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—É
    if (request.destination === 'document') {
      const offlineResponse = await caches.match('/index.html');
      if (offlineResponse) {
        console.log('[SW] –í–æ–∑–≤—Ä–∞—â–∞–µ–º index.html –∫–∞–∫ fallback');
        return offlineResponse;
      }
    }

    console.error('[SW] Network First –æ—à–∏–±–∫–∞:', error);
    
    // –î–ª—è localhost –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –æ—Ç–≤–µ—Ç
    if (request.url.includes('localhost')) {
      return new Response(
        `<!DOCTYPE html>
        <html>
        <head><title>–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</title></head>
        <body>
          <h1>–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h1>
          <p>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001</p>
          <button onclick="location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </body>
        </html>`,
        {
          status: 503,
          headers: { 'Content-Type': 'text/html; charset=utf-8' },
        }
      );
    }
    
    return new Response(
      JSON.stringify({
        error: '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É',
        offline: true,
        timestamp: Date.now(),
      }),
      {
        status: 503,
        headers: { 'Content-Type': 'application/json' },
      },
    );
  }
}

// –£—Ç–∏–ª–∏—Ç—ã

function isStaticAsset(pathname) {
  const staticExtensions = [
    '.js',
    '.css',
    '.png',
    '.jpg',
    '.jpeg',
    '.gif',
    '.svg',
    '.ico',
    '.woff',
    '.woff2',
  ];
  return staticExtensions.some((ext) => pathname.endsWith(ext));
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
self.addEventListener('message', (event) => {
  const { type, data } = event.data;

  switch (type) {
    case 'GET_CACHE_STATS':
      getCacheStats().then((stats) => {
        event.ports[0].postMessage({ type: 'CACHE_STATS', data: stats });
      });
      break;

    case 'CLEAR_CACHE':
      clearCaches(data?.cacheNames).then((result) => {
        event.ports[0].postMessage({ type: 'CACHE_CLEARED', data: result });
      });
      break;

    case 'PREFETCH_RESOURCES':
      prefetchResources(data?.urls).then((result) => {
        event.ports[0].postMessage({ type: 'PREFETCH_COMPLETE', data: result });
      });
      break;

    case 'SKIP_WAITING':
      self.skipWaiting();
      break;

    default:
      console.warn('[SW] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', type);
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞
async function getCacheStats() {
  const cacheNames = await caches.keys();
  const stats = {
    totalCaches: cacheNames.length,
    caches: {},
  };

  for (const cacheName of cacheNames) {
    const cache = await caches.open(cacheName);
    const keys = await cache.keys();
    stats.caches[cacheName] = {
      entries: keys.length,
      urls: keys.map((req) => req.url),
    };
  }

  return stats;
}

// –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–µ–π
async function clearCaches(cacheNames = null) {
  const allCacheNames = await caches.keys();
  const namesToClear = cacheNames || allCacheNames;

  const results = await Promise.allSettled(namesToClear.map((name) => caches.delete(name)));

  return {
    cleared: results.filter((r) => r.status === 'fulfilled' && r.value).length,
    failed: results.filter((r) => r.status === 'rejected').length,
    total: namesToClear.length,
  };
}

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
async function prefetchResources(urls = []) {
  if (!urls.length) return { prefetched: 0 };

  const cache = await caches.open(DYNAMIC_CACHE);
  const results = await Promise.allSettled(
    urls.map(async (url) => {
      try {
        const response = await fetch(url);
        if (response.ok) {
          await cache.put(url, response);
          return url;
        }
      } catch (error) {
        console.warn('[SW] –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏:', url, error);
      }
    }),
  );

  return {
    prefetched: results.filter((r) => r.status === 'fulfilled' && r.value).length,
    failed: results.filter((r) => r.status === 'rejected').length,
    total: urls.length,
  };
}

// –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
self.addEventListener('sync', (event) => {
  console.log('[SW] –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:', event.tag);

  switch (event.tag) {
    case 'heys-data-sync':
      event.waitUntil(performDataSync());
      break;

    case 'heys-analytics-sync':
      event.waitUntil(performAnalyticsSync());
      break;

    default:
      console.warn('[SW] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', event.tag);
  }
});

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
async function performDataSync() {
  try {
    console.log('[SW] –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö');

    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞ pending –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ IndexedDB

    const clients = await self.clients.matchAll();
    clients.forEach((client) => {
      client.postMessage({
        type: 'SYNC_COMPLETE',
        data: { success: true, timestamp: Date.now() },
      });
    });

    console.log('[SW] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  } catch (error) {
    console.error('[SW] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
  }
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
async function performAnalyticsSync() {
  try {
    console.log('[SW] –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');

    // –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

    console.log('[SW] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  } catch (error) {
    console.error('[SW] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
  }
}

// Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
self.addEventListener('push', (event) => {
  console.log('[SW] Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ');

  let notificationData = {
    title: 'HEYS',
    body: '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ',
    icon: '/icon-192x192.png',
    badge: '/badge-72x72.png',
    tag: 'heys-notification',
    data: {},
  };

  if (event.data) {
    try {
      const pushData = event.data.json();
      notificationData = { ...notificationData, ...pushData };
    } catch (error) {
      console.warn('[SW] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ push –¥–∞–Ω–Ω—ã—Ö:', error);
    }
  }

  event.waitUntil(self.registration.showNotification(notificationData.title, notificationData));
});

// –ö–ª–∏–∫ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é
self.addEventListener('notificationclick', (event) => {
  console.log('[SW] –ö–ª–∏–∫ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é:', event.notification.tag);

  event.notification.close();

  event.waitUntil(
    clients.matchAll({ type: 'window' }).then((clientList) => {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ, —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω–µ–º
      for (const client of clientList) {
        if (client.url === '/' && 'focus' in client) {
          return client.focus();
        }
      }

      // –ò–Ω–∞—á–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
      if (clients.openWindow) {
        return clients.openWindow('/');
      }
    }),
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
self.addEventListener('error', (event) => {
  console.error('[SW] –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
});

self.addEventListener('unhandledrejection', (event) => {
  console.error('[SW] –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞:', event.reason);
});

console.log('[SW] Service Worker –∑–∞–≥—Ä—É–∂–µ–Ω');
