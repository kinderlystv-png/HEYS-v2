<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ü•ó HEYS Micronutrients Update</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f7;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0 0 8px;
            font-size: 28px;
        }

        h2 {
            margin: 20px 0 12px;
            font-size: 20px;
            color: #333;
        }

        h3 {
            margin: 16px 0 8px;
            font-size: 16px;
            color: #666;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 24px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 12px;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-success {
            background: #34C759;
            color: white;
        }

        .btn-warning {
            background: #FF9500;
            color: white;
        }

        pre {
            background: #f8f8f8;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .status {
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            font-size: 14px;
            margin: 4px 0;
        }

        .status-success {
            background: #D1F2EB;
            color: #006644;
        }

        .status-error {
            background: #FFE5E5;
            color: #CC0000;
        }

        .status-info {
            background: #E3F2FD;
            color: #0D47A1;
        }

        .pattern-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .pattern-item {
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            border: 2px solid #eee;
        }

        .pattern-active {
            background: #D1F2EB;
            border-color: #34C759;
        }

        .pattern-inactive {
            background: #FFE5E5;
            border-color: #FF3B30;
        }

        .emoji {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>ü•ó HEYS Micronutrients Update</h1>
        <div class="subtitle">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ products —Å –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å–∞–π—Ç–æ–≤</div>

        <h2>–®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å products –∏–∑ API</h2>
        <p>–í –±–∞–∑–µ —É–∂–µ –µ—Å—Ç—å 292 –ø—Ä–æ–¥—É–∫—Ç–∞ —Å –∂–µ–ª–µ–∑–æ–º/–≤–∏—Ç–∞–º–∏–Ω–∞–º–∏/–∫–∞–ª—å—Ü–∏–µ–º. –ù—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Ö –≤ PWA.</p>
        <button class="btn-primary" onclick="updateProducts()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å Products</button>
        <button class="btn-warning" onclick="clearCache()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ö—ç—à</button>
        <div id="updateStatus"></div>

        <h2>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ products</h2>
        <button class="btn-success" onclick="checkMicronutrients()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã</button>
        <div id="checkStatus"></div>

        <h2>–®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Å–∞–π—Ç—ã</h2>
        <button class="btn-success" onclick="reanalyzeInsights()">üß† –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ò–Ω—Å–∞–π—Ç—ã</button>
        <div id="insightsStatus"></div>

        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div id="results"></div>
    </div>

    <script>
        async function updateProducts() {
            const status = document.getElementById('updateStatus');
            status.innerHTML = '<div class="status status-info">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º products –∏–∑ API...</div>';

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ API –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                if (!window.HEYS?.YandexAPI?.rest) {
                    throw new Error('HEYS.YandexAPI.rest –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ REST API
                console.log('[UPDATE] –ó–∞–ø—Ä–æ—Å shared_products...');
                const result = await HEYS.YandexAPI.rest('shared_products', {
                    limit: 500,
                    order: 'created_at.desc'
                });

                if (result.error) {
                    throw new Error(result.error.message || result.error);
                }

                const products = result.data || [];
                console.log('[UPDATE] –ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', products.length);

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
                const withIron = products.filter(p => p.iron && parseFloat(p.iron) > 0).length;
                const withVitC = products.filter(p => p.vitamin_c && parseFloat(p.vitamin_c) > 0).length;
                const withCalc = products.filter(p => p.calcium && parseFloat(p.calcium) > 0).length;

                console.log('[UPDATE] –° –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞–º–∏:', { withIron, withVitC, withCalc });

                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage —á–µ—Ä–µ–∑ HEYS.store
                if (HEYS.store?.set) {
                    HEYS.store.set('heys_products', products);
                    console.log('[UPDATE] ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ HEYS.store.set');
                } else if (HEYS.utils?.lsSet) {
                    HEYS.utils.lsSet('heys_products', products);
                    console.log('[UPDATE] ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ HEYS.utils.lsSet');
                } else {
                    throw new Error('–ù–µ—Ç –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è products');
                }

                // –û–±–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å products
                if (HEYS.products?.setAll) {
                    HEYS.products.setAll(products, { source: 'micronutrients-update' });
                    console.log('[UPDATE] ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω HEYS.products.setAll');
                }

                // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à shared products
                if (HEYS.cloud?.invalidateSharedProductsCache) {
                    HEYS.cloud.invalidateSharedProductsCache();
                    console.log('[UPDATE] ‚úÖ –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω');
                }

                status.innerHTML = `
                    <div class="status status-success">
                        ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${products.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤<br>
                        ü•ó –° –∂–µ–ª–µ–∑–æ–º: ${withIron}<br>
                        üçä –° –≤–∏—Ç–∞–º–∏–Ω–æ–º C: ${withVitC}<br>
                        ü•õ –° –∫–∞–ª—å—Ü–∏–µ–º: ${withCalc}
                    </div>`;

            } catch (err) {
                console.error('[UPDATE] –û—à–∏–±–∫–∞:', err);
                status.innerHTML = `<div class="status status-error">‚ùå ${err.message}</div>`;
            }
        }

        async function clearCache() {
            const status = document.getElementById('updateStatus');
            try {
                // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
                if (HEYS.cloud?.invalidateSharedProductsCache) {
                    HEYS.cloud.invalidateSharedProductsCache();
                }

                // –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏–Ω—Å–∞–π—Ç–æ–≤
                if (HEYS.InsightsPI?.clearCache) {
                    HEYS.InsightsPI.clearCache();
                }

                status.innerHTML = '<div class="status status-success">‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω</div>';
            } catch (err) {
                status.innerHTML = `<div class="status status-error">‚ùå ${err.message}</div>`;
            }
        }

        function checkMicronutrients() {
            const status = document.getElementById('checkStatus');
            try {
                // –ü–æ–ª—É—á–∏—Ç—å products
                let products = [];
                if (HEYS.products?.getAll) {
                    products = HEYS.products.getAll();
                } else if (HEYS.store?.get) {
                    products = HEYS.store.get('heys_products', []);
                } else if (HEYS.utils?.lsGet) {
                    products = HEYS.utils.lsGet('heys_products', []);
                }

                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error('Products –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                }

                // –ê–Ω–∞–ª–∏–∑ –º–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
                const withIron = products.filter(p => p.iron && parseFloat(p.iron) > 0);
                const withVitC = products.filter(p => p.vitamin_c && parseFloat(p.vitamin_c) > 0);
                const withCalc = products.filter(p => p.calcium && parseFloat(p.calcium) > 0);
                const withMagnesium = products.filter(p => p.magnesium && parseFloat(p.magnesium) > 0);
                const withZinc = products.filter(p => p.zinc && parseFloat(p.zinc) > 0);

                // –¢–æ–ø-5 –ø—Ä–∏–º–µ—Ä–æ–≤
                const topIron = withIron.sort((a, b) => parseFloat(b.iron) - parseFloat(a.iron)).slice(0, 5);
                const topVitC = withVitC.sort((a, b) => parseFloat(b.vitamin_c) - parseFloat(a.vitamin_c)).slice(0, 5);

                console.log('[CHECK] –¢–æ–ø –∂–µ–ª–µ–∑–æ:', topIron.map(p => `${p.name}: ${p.iron}`));
                console.log('[CHECK] –¢–æ–ø –≤–∏—Ç–∞–º–∏–Ω C:', topVitC.map(p => `${p.name}: ${p.vitamin_c}`));

                status.innerHTML = `
                    <div class="status status-success">
                        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Products (${products.length} —à—Ç)</h3>
                        <pre>
ü•ó –ñ–µ–ª–µ–∑–æ (iron):        ${withIron.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤
üçä –í–∏—Ç–∞–º–∏–Ω C:            ${withVitC.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤  
ü•õ –ö–∞–ª—å—Ü–∏–π:              ${withCalc.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤
üß≤ –ú–∞–≥–Ω–∏–π:               ${withMagnesium.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤
üõ°Ô∏è  –¶–∏–Ω–∫:                ${withZinc.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤

–¢–æ–ø-3 –∂–µ–ª–µ–∑–æ:
${topIron.slice(0, 3).map(p => `  ‚Ä¢ ${p.name}: ${p.iron} –º–≥`).join('\n')}

–¢–æ–ø-3 –≤–∏—Ç–∞–º–∏–Ω C:
${topVitC.slice(0, 3).map(p => `  ‚Ä¢ ${p.name}: ${p.vitamin_c} –º–≥`).join('\n')}
                        </pre>
                    </div>`;

            } catch (err) {
                console.error('[CHECK] –û—à–∏–±–∫–∞:', err);
                status.innerHTML = `<div class="status status-error">‚ùå ${err.message}</div>`;
            }
        }

        async function reanalyzeInsights() {
            const status = document.getElementById('insightsStatus');
            const results = document.getElementById('results');

            status.innerHTML = '<div class="status status-info">‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–Ω—Å–∞–π—Ç–æ–≤...</div>';

            try {
                // –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
                if (HEYS.InsightsPI?.clearCache) {
                    HEYS.InsightsPI.clearCache();
                    console.log('[INSIGHTS] ‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω');
                }

                // –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å analyze
                if (!HEYS.InsightsPI?.analyzeAll) {
                    throw new Error('HEYS.InsightsPI.analyzeAll –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                console.log('[INSIGHTS] –ó–∞–ø—É—Å–∫ analyzeAll...');
                const insights = await HEYS.InsightsPI.analyzeAll();

                console.log('[INSIGHTS] –†–µ–∑—É–ª—å—Ç–∞—Ç:', insights);

                // –ü–æ–¥—Å—á—ë—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
                const patterns = insights?.patterns || [];
                const activePatterns = patterns.filter(p => p.available || p.hasPattern);
                const inactivePatterns = patterns.filter(p => !p.available && !p.hasPattern);

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
                const microPatterns = patterns.filter(p =>
                    p.pattern?.includes('vitamin') ||
                    p.pattern?.includes('iron') ||
                    p.pattern?.includes('bone') ||
                    p.pattern?.includes('magnesium') ||
                    p.pattern?.includes('zinc')
                );
                const activeMicro = microPatterns.filter(p => p.available || p.hasPattern);
                const inactiveMicro = microPatterns.filter(p => !p.available && !p.hasPattern);

                status.innerHTML = `
                    <div class="status status-success">
                        ‚úÖ –ò–Ω—Å–∞–π—Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã<br>
                        –ê–∫—Ç–∏–≤–Ω–æ: ${activePatterns.length}/${patterns.length}<br>
                        –ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã: ${activeMicro.length}/${microPatterns.length}
                    </div>`;

                results.innerHTML = `
                    <h3>üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (${activePatterns.length})</h3>
                    <div class="pattern-list">
                        ${activePatterns.map(p => `
                            <div class="pattern-item pattern-active">
                                ${p.pattern}
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3>‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (${inactivePatterns.length})</h3>
                    <div class="pattern-list">
                        ${inactivePatterns.map(p => `
                            <div class="pattern-item pattern-inactive">
                                ${p.pattern}<br>
                                <small>${p.reason || 'N/A'}</small>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3>ü•ó –ú–∏–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>
                    <pre>${JSON.stringify(microPatterns.map(p => ({
                    pattern: p.pattern,
                    available: p.available,
                    hasPattern: p.hasPattern,
                    reason: p.reason
                })), null, 2)}</pre>
                `;

            } catch (err) {
                console.error('[INSIGHTS] –û—à–∏–±–∫–∞:', err);
                status.innerHTML = `<div class="status status-error">‚ùå ${err.message}</div>`;
                results.innerHTML = `<pre>${err.stack}</pre>`;
            }
        }

        // Auto-check on load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[HEYS] Micronutrients Update Tool Ready');
            console.log('[HEYS] HEYS.YandexAPI:', !!window.HEYS?.YandexAPI);
            console.log('[HEYS] HEYS.InsightsPI:', !!window.HEYS?.InsightsPI);
            console.log('[HEYS] HEYS.products:', !!window.HEYS?.products);
        });
    </script>
</body>

</html>